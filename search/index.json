[{"content":"èƒŒæ™¯ åœ¨ä¼ä¸šé¡¹ç›®å¼€å‘ä¸æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°å¾®ä¿¡æ”¯ä»˜è¿™ç±» å¿…é¡»å…¬ç½‘å¯è®¿é—® çš„ç¬¬ä¸‰æ–¹æœåŠ¡éœ€è¦å›è°ƒæˆ‘ä»¬çš„åº”ç”¨æ¥å£çš„é—®é¢˜ã€‚ä½†è®¸å¤šé¡¹ç›®éƒ¨ç½²åœ¨ å†…ç½‘ç¯å¢ƒï¼Œå…¬ç½‘æœåŠ¡æ— æ³•ç›´æ¥è®¿é—®ï¼Œå°¤å…¶åœ¨å¤šå¥—é¤æµ‹è¯•ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªé™åˆ¶å°¤ä¸ºçªå‡ºã€‚\nåœ¨ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ä¸­ï¼Œæ”¯ä»˜å›è°ƒå¤„ç†æ˜¯ä¸€ä¸ªå…³é”®ä½†å……æ»¡æŒ‘æˆ˜çš„ç¯èŠ‚ã€‚ä»¥æˆ‘ä»¬é‡‘èç§‘æŠ€å¹³å°ä¸ºä¾‹ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä»¥ä¸‹å…¸å‹é—®é¢˜ï¼š\næ··åˆç½‘ç»œç¯å¢ƒï¼šå¼€å‘æµ‹è¯•ç¯å¢ƒä½äºçº¿ä¸‹å†…ç½‘ï¼Œè€Œå¾®ä¿¡æ”¯ä»˜å›è°ƒå¿…é¡»é€šè¿‡å…¬ç½‘è®¿é—® å¤šç§Ÿæˆ·éš”ç¦»ï¼šæ¯ä¸ªå¼€å‘äººå‘˜éœ€è¦ç‹¬ç«‹çš„å›è°ƒåœ°å€è¿›è¡Œè”è°ƒæµ‹è¯• ç½‘ç»œç©¿é€éœ€æ±‚ï¼šéœ€è¦å®‰å…¨åœ°å°†å…¬ç½‘è¯·æ±‚é€ä¼ åˆ°å†…ç½‘ç‰¹å®šå¼€å‘ç¯å¢ƒ åŠ¨æ€è·¯ç”±ï¼šæ ¹æ®URLè·¯å¾„å‚æ•°åŠ¨æ€è·¯ç”±åˆ°ä¸åŒåç«¯æœåŠ¡ ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆå¦‚ç«¯å£æ˜ å°„æˆ–ç›´æ¥æš´éœ²å†…ç½‘æœåŠ¡éƒ½å­˜åœ¨å®‰å…¨é£é™©å’Œç®¡ç†å¤æ‚åº¦é—®é¢˜ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€å¥—åŸºäºNginxçš„æ™ºèƒ½è·¯ç”±æ–¹æ¡ˆã€‚\nå®ç°ç›®æ ‡ ä½¿å¾®ä¿¡æ”¯ä»˜å›è°ƒæ¥å£å¯é€šè¿‡å…¬ç½‘åœ°å€è®¿é—®ã€‚\nå¾®ä¿¡æœåŠ¡å™¨å›è°ƒè¯·æ±‚ç©¿é€å…¬ç½‘åˆ°å†…ç½‘æœåŠ¡ã€‚\næ”¯æŒå¤šä¸ªä¸Šä¸‹æ¸¸é¡¹ç›®é€šè¿‡ç»Ÿä¸€çš„å…¬ç½‘åŸŸåæ¥æ”¶å›è°ƒè¯·æ±‚ã€‚\nåŠ¨æ€æå–è´¦å·IDï¼Œè½¬å‘è¯·æ±‚åˆ°ä¸åŒå­ç³»ç»Ÿã€‚\næŠ€æœ¯æ¶æ„è®¾è®¡ å…¬ç½‘æ¥å…¥å±‚Nginx æä¾›ç»Ÿä¸€çš„å…¬ç½‘æ¥å…¥åŸŸå paycallback.example.com åŸºç¡€å®‰å…¨é˜²æŠ¤ï¼ˆIPç™½åå•ç­‰ï¼‰ è¯·æ±‚é€ä¼ åˆ°çº¿ä¸‹ç¯å¢ƒç½‘å…³ å†…ç½‘è·¯ç”±å±‚Nginx åŠ¨æ€è·¯å¾„è§£æä¸è·¯ç”± ç§Ÿæˆ·éš”ç¦»ä¸è¯·æ±‚è½¬å‘ æœ¬åœ°é™æ€èµ„æºæœåŠ¡ 1 2 3 4 5 6 7 8 9 10 å…¬ç½‘ç¯å¢ƒ [å¾®ä¿¡æ”¯ä»˜] â†’ [å…¬ç½‘Nginx (ä»£ç†æœåŠ¡ç«¯)] â”‚ â–¼ [ä»£ç†éš§é“] â”‚ â–¼ çº¿ä¸‹ç¯å¢ƒ [å†…ç½‘Nginx (ä»£ç†å®¢æˆ·ç«¯)] â†’ [å¼€å‘è€…AæœåŠ¡] â†’ [å¼€å‘è€…BæœåŠ¡] æ ¸å¿ƒå®ç° å…¬ç½‘Nginxé…ç½®ï¼ˆä»£ç† æœåŠ¡ç«¯ï¼‰ å…¬ç½‘æœåŠ¡éƒ¨ç½²åœ¨æ”¯æŒä»£ç†çš„äº‘æœåŠ¡å™¨ä¸Šï¼Œé…ç½®ä¸€ä¸ªç»Ÿä¸€çš„å…¬ç½‘å…¥å£ï¼Œå¦‚ï¼š\n1 http://paycallback.example.com/ å¾®ä¿¡æ”¯ä»˜é…ç½®ç¤ºä¾‹ï¼š\n1 2 3 4 { \u0026#34;payNotifyUrl\u0026#34;: \u0026#34;http://paycallback.example.com/wechatPayNotify/{developerId}\u0026#34; // ç¤ºä¾‹ï¼šhttp://paycallback.example.com/wechatPayNotify/johndoe } å…¬ç½‘Nginxé…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 server { listen 80; server_name paycallback.example.com; # IPç™½åå•ä¿æŠ¤ include /etc/nginx/conf.d/whitelist/paycallback.conf; location / { # é€šè¿‡éš§é“è½¬å‘åˆ°å†…ç½‘ proxy_pass http://10.0.0.10:80; # æŒ‡å‘å†…ç½‘VPNç½‘å…³ include proxy_params.conf; } } ç½‘Nginxé…ç½®ï¼ˆä»£ç†å®¢æˆ·ç«¯ï¼‰ éƒ¨ç½²åœ¨æµ‹è¯•ç¯å¢ƒï¼Œè¿æ¥å…¬ç½‘VPNï¼Œè´Ÿè´£è·¯ç”±è½¬å‘è¯·æ±‚åˆ°å…·ä½“çš„å­ç³»ç»Ÿã€‚ä»¥ /wechatCallback/{accountId} è·¯ç”±ä¸ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 server { listen 80; server_name paycallback.example.com; # å†…ç½‘DNSè§£æ resolver 10.0.0.53 valid=30s; location ^~ /wechatPayNotify/ { # æå–å¼€å‘è€…ID set $developer_id $uri; if ($uri ~* \u0026#34;^/wechatPayNotify/([^/]+)$\u0026#34;) { set $developer_id $1; } # æ„é€ åŠ¨æ€ä¸Šæ¸¸åœ°å€ set $upstream_host \u0026#34;dev-$developer_id.internal.example.com\u0026#34;; # è¯·æ±‚è½¬å‘é…ç½® proxy_pass http://$upstream_host/api/payment/notify; proxy_set_header Host $upstream_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # ä¼˜åŒ–ä»£ç†æ€§èƒ½ proxy_http_version 1.1; proxy_request_buffering off; proxy_buffering off; # æ—¥å¿—è®°å½• access_log /var/log/nginx/payment_notify.log main; } # é™æ€èµ„æºæœåŠ¡ location / { try_files $uri /index.html; } } ä¸šåŠ¡æ¥å…¥æµç¨‹ ä»¥é¡¹ç›® foo-app ä¸ºä¾‹ï¼š\nç»Ÿä¸€é…ç½®å¾®ä¿¡æ”¯ä»˜å›è°ƒåœ°å€ä¸ºï¼š http://paycallback.example.com/wechatCallback/foo å†…ç½‘Nginxæ ¹æ®è·¯å¾„åŠ¨æ€æå– foo ä¸ºè´¦å·IDï¼Œæ‹¼æ¥æˆï¼š http://subsys-foo.internal/api/pay/wechat/notify å†…ç½‘åº”ç”¨æ¥æ”¶åˆ°å¾®ä¿¡æœåŠ¡å™¨å›è°ƒçš„æ•°æ®ï¼Œè¿›è¡Œæ­£å¸¸å¤„ç†ã€‚ æµ‹è¯•æ–¹æ¡ˆ ä½¿ç”¨ curl æ¨¡æ‹Ÿå¾®ä¿¡å›è°ƒè¯·æ±‚ï¼š\n1 2 3 curl -X POST http://paycallback.example.com/wechatCallback/foo \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{\u0026#34;order_id\u0026#34;: \u0026#34;123456\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;PAID\u0026#34;}\u0026#39; æŸ¥çœ‹å†…ç½‘å­ç³»ç»Ÿæ—¥å¿—æ˜¯å¦æ­£å¸¸æ¥æ”¶åˆ°å›è°ƒã€‚\nå…³é”®ä¼˜åŠ¿ åŠ¨æ€è·¯ç”±æœºåˆ¶ URLè·¯å¾„å‚æ•°è‡ªåŠ¨æ˜ å°„åˆ°å¯¹åº”å¼€å‘è€…ç¯å¢ƒï¼š devstream.example.com/wechatPayCallback/alice â†’ dev-alice.internal.example.com å®‰å…¨éš”ç¦» åŠ å¯†éš§é“ä¿éšœä¼ è¾“å®‰å…¨ å…¬ç½‘Nginx IPç™½åå•æ§åˆ¶è®¿é—®æº å†…ç½‘ç¯å¢ƒå®Œå…¨éš”ç¦»äºå…¬ç½‘ é«˜æ•ˆå¼€å‘ æ”¯æŒå¤šå¼€å‘è€…å¹¶è¡Œæµ‹è¯• æ— éœ€é‡å¤é…ç½®å…¬ç½‘æš´éœ²ç‚¹ å›è°ƒè¯·æ±‚å®æ—¶åˆ°è¾¾å†…ç½‘ç¯å¢ƒ å¼¹æ€§æ‰©å±• æ–°å¢å¼€å‘è€…åªéœ€é…ç½®å†…ç½‘æœåŠ¡ æ— éœ€ä¿®æ”¹å…¬ç½‘Nginxé…ç½® è‡ªåŠ¨DNSè§£ææ”¯æŒæœåŠ¡å‘ç° å®æ–½æ•ˆæœ å¾®ä¿¡æ”¯ä»˜å›è°ƒå»¶è¿Ÿä»åˆ†é’Ÿçº§é™è‡³200mså†… å¼€å‘æµ‹è¯•æ•ˆç‡æå‡300%ï¼Œæ”¯æŒ10+å¼€å‘è€…å¹¶è¡Œå·¥ä½œ å®Œå…¨æ¶ˆé™¤å…¬ç½‘æš´éœ²å†…ç½‘ç«¯å£çš„é£é™© é…ç½®å˜æ›´å‡å°‘90%ï¼Œæ–°æˆå‘˜æ¥å…¥æ—¶é—´ä»2å°æ—¶é™è‡³5åˆ†é’Ÿ ","date":"2025-06-13T12:14:58Z","image":"https://www.ownit.top/title_pic/65.jpg","permalink":"https://www.ownit.top/p/202506131214/","title":"åŸºäºNginxçš„å¾®ä¿¡æ”¯ä»˜å›è°ƒè·¨ç½‘ç»œç¯å¢ƒè§£å†³æ–¹æ¡ˆ"},{"content":"èƒŒæ™¯ å…¬å¸è¦æŠŠé‡è¦çš„æ•°æ®åº“çš„æ“ä½œè®°å½•ç•™å­˜ï¼Œæ–¹ä¾¿æŸ¥è¯¢æ“ä½œå¯è§†åŒ–å’Œå‘Šè­¦ç›‘æ§ç­‰å¾…ã€‚æ›´èƒ½å’Œå…¶ä½™ç›¸åŒçš„æ•°æ®åº“ä¿æŒä¸€è‡´ã€‚\næœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•é€šè¿‡MariaDBçš„server_auditæ’ä»¶ä¸ºMySQLç¤¾åŒºç‰ˆå®ç°å®Œæ•´çš„å®¡è®¡åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬å…¼å®¹æ€§å¤„ç†ã€æ’ä»¶é…ç½®ã€æ—¥å¿—è§£æå’Œå­˜å‚¨æ–¹æ¡ˆã€‚\nä¸ºä»€ä¹ˆMySQLç¤¾åŒºç‰ˆéœ€è¦å®¡è®¡åŠŸèƒ½ï¼Ÿ åœ¨å…¬å¸æ•°æ®åº“ç®¡ç†ä¸­ï¼Œå®¡è®¡æ—¥å¿—æ˜¯å®‰å…¨åˆè§„å’Œæ•…éšœæ’æŸ¥çš„é‡è¦å·¥å…·ã€‚ç„¶è€Œï¼Œè®¸å¤šä½¿ç”¨MySQLç¤¾åŒºç‰ˆçš„ä¼ä¸šé¢ä¸´ä¸€ä¸ªå°´å°¬çš„ç°å®ï¼šåŸç”Ÿçš„å®¡è®¡åŠŸèƒ½ä»…åœ¨ä¼ä¸šç‰ˆä¸­æä¾›ã€‚æ ¹æ®MySQLå®˜æ–¹æ–‡æ¡£ï¼Œç¤¾åŒºç‰ˆä»5.7.34ç‰ˆæœ¬åä¸å†æ”¯æŒç¬¬ä¸‰æ–¹å®¡è®¡æ’ä»¶ï¼Œè¿™ç»™éœ€è¦åˆè§„å®¡è®¡çš„ä¼ä¸šå¸¦æ¥äº†æŒ‘æˆ˜ã€‚\næŠ€æœ¯é€‰å‹ä¸ç‰ˆæœ¬å…¼å®¹æ€§åˆ†æ æ–¹æ¡ˆ ä¼˜ç‚¹ ç¼ºç‚¹ é€‚ç”¨åœºæ™¯ MySQLä¼ä¸šç‰ˆå®¡è®¡æ’ä»¶ å®˜æ–¹æ”¯æŒï¼ŒåŠŸèƒ½å®Œå–„ éœ€è¦ä»˜è´¹è®¸å¯ é¢„ç®—å……è¶³çš„ä¼ä¸š MariaDB server_auditæ’ä»¶ å…è´¹å¼€æºï¼ŒåŠŸèƒ½å®Œæ•´ ç‰ˆæœ¬å…¼å®¹æ€§å¤æ‚ MySQL 5.7.34åŠä»¥ä¸‹ç‰ˆæœ¬ Perconaå®¡è®¡æ’ä»¶ å®Œå…¨å…¼å®¹MySQL éœ€è¦è¿ç§»åˆ°Percona Server æ–°å»ºé¡¹ç›®æˆ–å¯è¿ç§»ç¯å¢ƒ è§¦å‘å™¨+é€šç”¨æ—¥å¿— æ— éœ€é¢å¤–ç»„ä»¶ æ€§èƒ½å½±å“å¤§ï¼Œä¿¡æ¯ä¸å®Œæ•´ ç®€å•å®¡è®¡éœ€æ±‚ åœ¨ä¼ä¸šæ•°æ®ç®¡ç†ä¸­ï¼Œæ•°æ®åº“æ“ä½œå®¡è®¡æ˜¯å®‰å…¨åˆè§„çš„æ ¸å¿ƒéœ€æ±‚ã€‚ä½†MySQLç¤¾åŒºç‰ˆå­˜åœ¨æ˜æ˜¾çŸ­æ¿ï¼š\nç¼ºä¹åŸç”Ÿå®¡è®¡åŠŸèƒ½ï¼ˆä»…ä¼ä¸šç‰ˆæ”¯æŒaudit_logæ’ä»¶ï¼‰ ç‰ˆæœ¬å…¼å®¹é™·é˜± MySQL 5.7.34ï¼šæœ€åä¸€ä¸ªå¯åŸç”Ÿä½¿ç”¨MariaDBæ’ä»¶çš„ç‰ˆæœ¬ MySQL â‰¥5.7.34 æ— æ³•ä½¿ç”¨MariaDBçš„server_audit.soæ’ä»¶ MySQL 8.0 å®Œå…¨ç§»é™¤æ’ä»¶å…¼å®¹æ€§ æ›¿ä»£æ–¹æ¡ˆé€‰æ‹© æ–¹æ¡ˆ1ï¼šMySQL 5.7ä½ç‰ˆæœ¬ + MariaDBæ’ä»¶ï¼ˆéœ€ç‰ˆæœ¬åŒ¹é…ï¼‰ æ–¹æ¡ˆ2ï¼šè¿ç§»è‡³Percona Serverï¼ˆå…è´¹å¼€æºï¼Œå…¼å®¹MySQL 5.6/5.7/8.0ä¸”æ”¯æŒå®¡è®¡ï¼‰ æ–¹æ¡ˆ3ï¼šå…¨é¢è¿ç§»åˆ°MariaDB å®è·µå»ºè®®ï¼šåœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯æ’ä»¶å…¼å®¹æ€§ï¼Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¿›è¡Œå®Œæ•´çš„å›å½’æµ‹è¯•ã€‚\nç¯å¢ƒ ç¯å¢ƒå¦‚ä¸‹ï¼š\nMySQL\n1 2 [root@test_db01 ~]# mysql -V mysql Ver 14.14 Distrib 5.7.27, for Linux (x86_64) using EditLine wrapper Cnetos7\n1 2 3 4 [root@test_db01 ~]# cat /etc/redhat-release CentOS Linux release 7.3.1611 (Core) Linux test_db01 3.10.0-514.el7.x86_64 #1 SMP Tue Nov 22 16:42:41 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux å®‰è£…æ’ä»¶ æŸ¥çœ‹æ’ä»¶å®‰è£…ç›®å½• 1 2 3 4 5 6 7 8 mysql\u0026gt; show global variables like \u0026#39;plugin_dir\u0026#39;; +---------------+--------------------------+ | Variable_name | Value | +---------------+--------------------------+ | plugin_dir | /usr/lib64/mysql/plugin/ | +---------------+--------------------------+ 1 row in set (0.00 sec) æå–mariadbå®¡è®¡æ’ä»¶å¹¶æ”¾ç½®æ’ä»¶ç›®å½• æ­¤å¤„éœ€è¦æ³¨æ„ç‰ˆæœ¬ï¼Œç›´æ¥é€‚é…æ ¸å¯¹æµ‹è¯•\n1 2 3 4 wget https://downloads.mariadb.com/MariaDB/mariadb-10.5.16/bintar-linux-x86_64/mariadb-10.5.16-linux-x86_64.tar.gz tar -zxvf mariadb-10.5.3-linux-x86_64.tar.gz cp ./mariadb-10.5.3-linux-x86_64/lib/plugin/server_audit.so /usr/lib64/mysql/plugin/ chmod +x /usr/lib64/mysql/plugin/ mysqlå®‰è£…server_audit.soæ’ä»¶ 1 2 3 4 mysql\u0026gt; install plugin server_audit soname \u0026#39;server_audit.so\u0026#39;; Query OK, 0 rows affected (0.02 sec) ##ä¹Ÿå¯ä»¥åœ¨my.cnf åŠ è½½æ’ä»¶æ–¹å¼å®‰è£… åœ¨my.cnf è®¾ç½® plugin_load = server_audit=server_audit.so æŸ¥çœ‹å½“å‰MySQLæ’ä»¶æƒ…å†µ\n1 2 mysql\u0026gt; show plugins; | SERVER_AUDIT | ACTIVE | AUDIT | server_audit.so | GPL | å¢åŠ å®¡è®¡ç›®å½•æˆæƒ 1 2 mkdir /opt/mysqldata/auditlogs chown -R mysql:mysql /opt/mysqldata/auditlogs å¼€å¯å®¡è®¡ï¼Œå†™å…¥é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #é˜²æ­¢server_audit æ’ä»¶è¢«å¸è½½ è¿›è¡Œé…ç½®æ–‡ä»¶é…ç½® server_audit=FORCE_PLUS_PERMANENT #æŒ‡å®šå“ªäº›æ“ä½œè¢«è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ server_audit_events=\u0026#39;CONNECT,QUERY,TABLE,QUERY_DDL\u0026#39; #å¼€å¯å®¡è®¡åŠŸèƒ½ server_audit_logging=on #é»˜è®¤å­˜æ”¾è·¯å¾„ï¼Œå¯ä»¥ä¸å†™ï¼Œé»˜è®¤åˆ°dataæ–‡ä»¶ä¸‹ server_audit_file_path=/opt/mysqldata/auditlogs #è®¾ç½®æ–‡ä»¶å¤§å° é»˜è®¤1000000ï¼Œ1073741824=1GB server_audit_file_rotate_size=1073741824 #æŒ‡å®šæ—¥å¿—æ–‡ä»¶çš„æ•°é‡ï¼Œå¦‚æœä¸º0æ—¥å¿—å°†ä»ä¸è½®è½¬ server_audit_file_rotations=0 ä¸‹é¢æ˜¯æˆ‘çš„é…ç½®æ–‡ä»¶ ç‰ˆæœ¬å¤ªä½ï¼Œä¸æ”¯æŒJSONï¼Œé«˜ç‰ˆæœ¬æ”¯æŒJSONæ ¼å¼ï¼Œæ–¹ä¾¿Pythonå¤„ç†ï¼Œåç»­åªèƒ½reæ¥å¤„ç† â€‹```bash #######server audit##### server_audit_logging=ON server_audit_file_path=/www/server/data/server_audit.log server_audit=FORCE_PLUS_PERMANENT server_audit_file_rotate_size=500M server_audit_file_rotations=15 max_allowed_packet=32M #audit_log_format=JSON #audit_log_file=server_audit.json #server_audit_logging=ON #server_audit_file_path=/data/mysql/server_audit.json #server_audit=FORCE_PLUS_PERMANENT #server_audit_file_rotate_size=1G #server_audit_file_rotations=10 #max_allowed_packet=32M FORCE_PLUS_PERMANENTï¼šé˜²æ­¢æ’ä»¶è¢«æ„å¤–å¸è½½ æ—¥å¿—è½®è½¬è®¾ç½®ï¼šé¿å…æ—¥å¿—æ–‡ä»¶æ— é™å¢é•¿ max_allowed_packetï¼šç¡®ä¿å¤§SQLè¯­å¥èƒ½è¢«å®Œæ•´è®°å½• é‡å¯mysqlç”Ÿæ•ˆï¼\n1 2 3 /etc/init.d/mysql restart Shutting down MySQL............... SUCCESS! Starting MySQL.. SUCCESS! æ£€æŸ¥æ—¥å¿—çŠ¶æ€ 1 2 3 4 5 -- æ£€æŸ¥æ’ä»¶çŠ¶æ€ SHOW PLUGINS WHERE NAME = \u0026#39;server_audit\u0026#39;; -- æŸ¥çœ‹å®¡è®¡è®¾ç½® SHOW GLOBAL VARIABLES LIKE \u0026#39;server_audit%\u0026#39;; æ—¥å¿—æ ¼å¼ 1 2 3 4 5 6 7 20250610 10:42:49,test_db01,root,192.168.102.207,7972452,438352983,QUERY,xxxx,\u0026#39;SELECT id,ext_id,ext_table_name,target_type,value1,value2,spread_config FROM t_target \\n \\n WHERE (ext_id = \\\u0026#39;12606411819336451111124\\\u0026#39; AND ext_table_name = \\\u0026#39;t_discount_coupon\\\u0026#39;)\u0026#39;,0 20250610 10:42:50,test_db01,root,192.168.83.18,7972073,438352984,QUERY,gazelle_model_assemble,\u0026#39;SELECT id,code,name,handler,status,retry_times,create_time,update_time FROM batch WHERE (status = \\\u0026#39;running\\\u0026#39;)\u0026#39;,0 20250610 10:42:50,test_db01,root,192.168.102.207,7969972,438352986,QUERY,xxxx,\u0026#39;select * from t_event_send where sent = 0 order by created_time asc\u0026#39;,0 20250610 10:42:50,test_db01,root,192.168.83.36,7853786,438352985,QUERY,hxxxdb,\u0026#39;SELECT\\n MAX(IF(status = 1, create_time, null)) nearBankTime\\n FROM user_bank_cards\\n WHERE create_time \u0026gt;= NOW() - INTERVAL 12 HOUR\u0026#39;,0 20250610 10:42:50,test_db01,root,192.168.83.27,7971636,438352987,QUERY,hixxxx_core,\u0026#39;SELECT id, user_id, trade_no, out_trade_no, order_sn, lease_id, period_no, amount, trade_status, alipay_close_status, trade_type, remark, trade_way, business_type, entry_param, coupon_id, coupon_amount, deleted, gmt_create, gmt_modified FROM hire_trade_flows WHERE deleted = 0 AND (trade_status = 3 AND trade_type = 1 AND trade_way IN (1, 3, 4) AND business_type IN (3, 5, 2, 1, 14, 4, 6, 10, 13))\u0026#39;,0 20250610 10:42:50,test_db01,root,192.168.83.25,7972144,438352988,QUERY,historical_customer_data,\u0026#39;SELECT 1\u0026#39;,0 20250610 10:42:50,test_db01,root,192.168.83.25,7972144,438352989,QUERY,historical_customer_data,\u0026#39;SELECT 1\u0026#39;,0 è§£é‡Šè¿™æ¡æ—¥å¿—æ ¼å¼\n1 20250610 10:42:50,test_db01,root,192.168.83.36,7853786,438352985,QUERY,hxxxdb,\u0026#39;SELECT\\n MAX(IF(status = 1, create_time, null)) nearBankTime\\n FROM user_bank_cards\\n WHERE create_time \u0026gt;= NOW() - INTERVAL 12 HOUR\u0026#39;,0 å­—æ®µç¼–å· å­—æ®µå€¼ å«ä¹‰ 1 20250610 10:42:50 æ—¶é—´æˆ³ï¼Œè¡¨ç¤ºå®¡è®¡äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ 2 test_db01 æœåŠ¡å™¨ä¸»æœºåï¼ˆæˆ– MariaDB å®ä¾‹åç§°ï¼‰ 3 root æ•°æ®åº“ç”¨æˆ·åï¼Œæ‰§è¡Œè¯¥è¯­å¥çš„ç”¨æˆ· 4 192.168.83.36 å®¢æˆ·ç«¯ IP åœ°å€ 5 7853786 çº¿ç¨‹ IDï¼ˆMariaDB å†…éƒ¨çº¿ç¨‹å·ï¼‰ 6 438352985 æŸ¥è¯¢ IDï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„ SQL æŸ¥è¯¢ 7 QUERY äº‹ä»¶ç±»å‹ï¼ˆQUERY è¡¨ç¤º SQL æŸ¥è¯¢ï¼‰ 8 hxxxdb å½“å‰æ•°æ®åº“åï¼ˆUSE çš„æ•°æ®åº“ï¼‰ 9 'SELECT\\n MAX(IF(... SQL è¯­å¥å†…å®¹ï¼Œä½¿ç”¨å•å¼•å·åŒ…è£¹ï¼Œ\\n ä¸ºæ¢è¡Œç¬¦ 10 0 è¿”å›å€¼ / é”™è¯¯ç ï¼Œ0 è¡¨ç¤ºæˆåŠŸï¼ˆæ— é”™è¯¯ï¼‰ å®¡è®¡æ—¥å¿—å¤„ç†ç³»ç»Ÿå®ç° ç³»ç»Ÿæ¶æ„è®¾è®¡ 1 2 3 4 5 [MySQL Server] â†“ (ç”Ÿæˆå®¡è®¡æ—¥å¿—) [server_audit.log] â†“ (Pythonç›‘æ§è¿›ç¨‹) [æ—¥å¿—è§£ææ¨¡å—] â†’ [MySQLå®¡è®¡æ•°æ®åº“] Pythonå¤„ç†ç¨‹åºæ ¸å¿ƒé€»è¾‘ 1 20250610 10:42:50,test_db01,root,192.168.83.36,7853786,438352985,QUERY,hxxxdb,\u0026#39;SELECT\\n MAX(IF(status = 1, create_time, null)) nearBankTime\\n FROM user_bank_cards\\n WHERE create_time \u0026gt;= NOW() - INTERVAL 12 HOUR\u0026#39;,0 æˆ‘ä»¬æœ‰ä¸Šé¢çš„æ—¥å¿—æ ¼å¼ï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹æ“ä½œå¤„ç†\næ—¥å¿—ç›‘æ§å…³é”®ç‰¹æ€§ï¼š\næ–­ç‚¹ç»­ä¼ ï¼šé€šè¿‡stateæ–‡ä»¶è®°å½•è¯»å–ä½ç½® æ–‡ä»¶è½®è½¬æ£€æµ‹ï¼šé€šè¿‡inodeå’Œdevè¯†åˆ«æ—¥å¿—åˆ‡æ¢ å¼‚å¸¸å¤„ç†ï¼šå®Œå–„çš„é”™è¯¯æ•è·å’Œæ—¥å¿—è®°å½• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 def process_log_entry(new_content): \u0026#34;\u0026#34;\u0026#34;å¤„ç†å•ä¸ªå®¡è®¡æ—¥å¿—æ¡ç›®\u0026#34;\u0026#34;\u0026#34; # å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ï¼Œç”¨äºè§£æå®¡è®¡æ—¥å¿—æ ¼å¼ # æ¨¡å¼åŒ¹é…å­—æ®µï¼šæ—¶é—´ï¼Œæ•°æ®åº“å(1)ï¼Œç”¨æˆ·åï¼ŒæºIPï¼Œè¿æ¥IDï¼ŒæŸ¥è¯¢IDï¼Œäº‹ä»¶ç±»å‹ï¼Œæ•°æ®åº“å(2)ï¼ŒSQLè¯­å¥ï¼Œæ‰§è¡Œç»“æœ pattern = r\u0026#34;^(\\d{8} \\d{2}:\\d{2}:\\d{2}),([\\w]+),([\\w]+),(\\d+\\.\\d+\\.\\d+\\.\\d+),(\\d+),(\\d+),([\\w]+),([\\w]+),\u0026#39;(.*)\u0026#39;,(\\d+)\u0026#34; # å°è¯•åŒ¹é…æ—¥å¿—è¡Œ match = re.match(pattern, new_content) if match: # æå–åŒ¹é…çš„å„ä¸ªå­—æ®µ sql_time = match.group(1) # æ—¶é—´ (æ ¼å¼: å¹´æœˆæ—¥ æ—¶åˆ†ç§’) database_name = match.group(8) # æ•°æ®åº“åç§° (ä»ç¬¬8ç»„è·å–) sql_content = match.group(9) # SQLè¯­å¥å†…å®¹ (åŒ…å«åŸå§‹è½¬ä¹‰å­—ç¬¦) s_sql_content = match.group(9) # ä¿ç•™åŸå§‹SQLè¯­å¥ç”¨äºæ—¥å¿—è®°å½• sql_result = match.group(10) # SQLæ‰§è¡Œç»“æœ (0è¡¨ç¤ºæˆåŠŸ) # æ¸…æ´—SQLè¯­å¥å†…å®¹ï¼š # 1. å»é™¤SQLæ³¨é‡Šï¼ˆ--ã€#å’Œ/* */ç±»å‹çš„æ³¨é‡Šï¼‰ COMMENT_PATTERN = re.compile(r\u0026#34;(--.*?\\\\r\\\\n|#.*?\\\\r\\\\n|/\\*.*?\\*/)\u0026#34;, re.DOTALL | re.MULTILINE) sql_content = COMMENT_PATTERN.sub(\u0026#34;\u0026#34;, sql_content) # 2. æ›¿æ¢ç‰¹æ®Šè½¬ä¹‰å­—ç¬¦ # - å°†\\næ¢è¡Œç¬¦æ›¿æ¢ä¸ºç©ºæ ¼ # - å°†\\\u0026#39;è½¬ä¹‰å•å¼•å·æ›¿æ¢ä¸ºæ™®é€šå•å¼•å· # - å°†\\tåˆ¶è¡¨ç¬¦æ›¿æ¢ä¸ºç©ºæ ¼ # - å°†\\rå›è½¦ç¬¦æ›¿æ¢ä¸ºç©ºæ ¼ sql_content = sql_content.replace(\u0026#39;\\\\n\u0026#39;, \u0026#39; \u0026#39;).replace(\u0026#39;\\\\\\\u0026#39;\u0026#39;, \u0026#39;\\\u0026#39;\u0026#39;).replace(\u0026#39;\\\\t\u0026#39;, \u0026#39; \u0026#39;).replace(\u0026#39;\\\\r\u0026#39;, \u0026#39; \u0026#39;) # 3. å»é™¤SQLè¯­å¥å‰åçš„å¤šä½™ç©ºæ ¼ sql_content = sql_content.strip() # æ£€æŸ¥æ˜¯å¦ä¸ºéœ€è¦è®°å½•çš„DDLè¯­å¥ï¼š # 1. SQLæ‰§è¡ŒæˆåŠŸ (sql_result == \u0026#34;0\u0026#34;) # 2. æ˜¯DDLæ“ä½œ (CREATE/ALTER/DROP/RENAMEå¼€å¤´) DDL_PATTERN = re.compile(r\u0026#34;^(CREATE|ALTER|DROP|RENAME)\u0026#34;, re.IGNORECASE) if sql_result == \u0026#34;0\u0026#34; and DDL_PATTERN.match(sql_content): # è®°å½•å¤„ç†æ—¥å¿— logging.info(\u0026#34;-\u0026#34; * 50) logging.info(f\u0026#34;åŸå§‹SQLå†…å®¹: {s_sql_content}\u0026#34;) logging.info(f\u0026#34;æ‰§è¡Œæ—¶é—´: {sql_time}\u0026#34;) logging.info(f\u0026#34;æ•°æ®åº“åç§°: {database_name}\u0026#34;) logging.info(f\u0026#34;æ¸…æ´—åSQL: {sql_content}\u0026#34;) logging.info(\u0026#34;-\u0026#34; * 50) # å°†å®¡è®¡è®°å½•ä¿å­˜åˆ°MySQLæ•°æ®åº“ save_to_mysql(sql_time, database_name, sql_content) 1 2 åŸå§‹: \u0026#39;SELECT\\n MAX(...) nearBankTime\\n FROM ...\u0026#39; æ¸…æ´—å: \u0026#39;SELECT MAX(...) nearBankTime FROM ...\u0026#39; å®Œæ•´ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 # -*- coding: utf-8 -*- import os, sys import re import time import json, logging from datetime import datetime import pymysql # æ—¥å¿—é…ç½® logging.basicConfig( filename=\u0026#39;mysql_monitor.log\u0026#39;, level=logging.INFO, format=\u0026#39;[%(asctime)s] %(levelname)s: %(message)s\u0026#39;, datefmt=\u0026#39;%Y-%m-%d %H:%M:%S\u0026#39; ) # è¯»å–ç¼“å­˜æ–‡ä»¶ï¼Œå®šä½æ—¥å¿—è¯»å–ä½ç½® def load_state(state_file): \u0026#34;\u0026#34;\u0026#34;Load saved state.\u0026#34;\u0026#34;\u0026#34; try: with open(state_file, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: state = json.load(f) return state.get(\u0026#39;position\u0026#39;, 0), state.get(\u0026#39;inode\u0026#39;, None), state.get(\u0026#39;dev\u0026#39;, None) except (IOError, ValueError): return 0, None, None except Exception as e: logging.error(f\u0026#34;Failed to load state: {str(e)}\u0026#34;) return 0, None, None # ä¿å­˜ä½ç½®æ•°æ®åˆ°æ–‡ä»¶ä¸­ def save_state(state_file, position, inode, dev): \u0026#34;\u0026#34;\u0026#34;Save current state.\u0026#34;\u0026#34;\u0026#34; try: with open(state_file, \u0026#39;w\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: json.dump({ \u0026#39;position\u0026#39;: position, \u0026#39;inode\u0026#39;: inode, \u0026#39;dev\u0026#39;: dev }, f) except Exception as e: logging.error(f\u0026#34;Failed to save state: {str(e)}\u0026#34;) # ä¿å­˜sqlæ•°æ®åˆ°æ•°æ®ä¸­ï¼Œæ–¹ä¾¿å¯è§†åŒ– æˆ–è€… å‘Šè­¦ def save_to_mysql(sql_time, database_name, sql_content): \u0026#34;\u0026#34;\u0026#34;å°†æ—¥å¿—ä¿¡æ¯å†™å…¥åˆ° MySQL æ•°æ®åº“çš„ audit_log è¡¨ä¸­\u0026#34;\u0026#34;\u0026#34; connection = pymysql.connect( host=\u0026#39;192.168.102.201\u0026#39;, user=\u0026#39;root\u0026#39;, password=\u0026#39;xxxx.88\u0026#39;, database=\u0026#39;audit_db\u0026#39;, charset=\u0026#39;utf8mb4\u0026#39; ) try: with connection.cursor() as cursor: sql = \u0026#34;\u0026#34;\u0026#34; INSERT INTO audit_log (sql_time, database_name, sql_content) VALUES (%s, %s, %s) \u0026#34;\u0026#34;\u0026#34; sql_time = datetime.strptime(sql_time, \u0026#34;%Y%m%d %H:%M:%S\u0026#34;).strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) cursor.execute(sql, (sql_time, database_name, sql_content)) connection.commit() except Exception as e: logging.error(f\u0026#34;Failed to insert data into MySQL: {str(e)}\u0026#34;) finally: connection.close() # è¯»å–æ–‡ä»¶ ï¼Œæ•°æ® åŒ¹é… å’Œ æ¸…æ´— def process_log_entry(new_content): \u0026#34;\u0026#34;\u0026#34;Process a single log entry.\u0026#34;\u0026#34;\u0026#34; pattern = r\u0026#34;^(\\d{8} \\d{2}:\\d{2}:\\d{2}),([\\w]+),([\\w]+),(\\d+\\.\\d+\\.\\d+\\.\\d+),(\\d+),(\\d+),([\\w]+),([\\w]+),\u0026#39;(.*)\u0026#39;,(\\d+)\u0026#34; match = re.match(pattern, new_content) if match: sql_time = match.group(1) database_name = match.group(8) sql_content = match.group(9) s_sql_content = match.group(9) sql_result = match.group(10) # å…ˆåŒ¹é…å­˜åœ¨DDLè¯­å¥çš„sqlå†…å®¹ # å»é™¤-- /* # ç­‰æ³¨é‡Šç¬¦ #logging.info(f\u0026#34;1 {sql_content}\u0026#34;) COMMENT_PATTERN = re.compile(r\u0026#34;(--.*?\\\\r\\\\n|#.*?\\\\r\\\\n|/\\*.*?\\*/)\u0026#34;, re.DOTALL | re.MULTILINE) sql_content = COMMENT_PATTERN.sub(\u0026#34;\u0026#34;, sql_content) # å»é™¤å¤šä½™çš„æ¢è¡Œç¬¦/\u0026#39;ç­‰ #logging.info(f\u0026#34;2 {sql_content}\u0026#34;) sql_content = sql_content.replace(\u0026#39;\\\\n\u0026#39;, \u0026#39; \u0026#39;).replace(\u0026#39;\\\\\\\u0026#39;\u0026#39;, \u0026#39;\\\u0026#39;\u0026#39;).replace(\u0026#39;\\\\t\u0026#39;, \u0026#39; \u0026#39;).replace(\u0026#39;\\\\r\u0026#39;, \u0026#39; \u0026#39;) #logging.info(f\u0026#34;3 {sql_content}\u0026#34;) # å»é™¤å‰åå¤šä½™çš„ç©ºæ ¼ sql_content = sql_content.strip() #logging.info(f\u0026#34;4 {sql_content}\u0026#34;) # æ£€æŸ¥æ˜¯å¦ä¸º DDL è¯­å¥ DDL_PATTERN = re.compile(r\u0026#34;^(CREATE|ALTER|DROP|RENAME)\u0026#34;, re.IGNORECASE) if sql_result == \u0026#34;0\u0026#34; and DDL_PATTERN.match(sql_content): logging.info(\u0026#34;-\u0026#34; * 50) logging.info(f\u0026#34;SQL Content: {s_sql_content}\u0026#34;) logging.info(f\u0026#34;Time: {sql_time}\u0026#34;) logging.info(f\u0026#34;Database Name: {database_name}\u0026#34;) logging.info(f\u0026#34;SQL Content: {sql_content}\u0026#34;) logging.info(\u0026#34;-\u0026#34; * 50) save_to_mysql(sql_time, database_name, sql_content) # å¯åŠ¨ç¨‹åºï¼Œä¼ å…¥ ç¼“å­˜ æ–‡ä»¶ å’Œ å®¡è®¡æ—¥å¿—è®°å½• æ–‡ä»¶ ä½ç½® def monitor_log(state_file, log_file): \u0026#34;\u0026#34;\u0026#34;Monitor MySQL audit logs.\u0026#34;\u0026#34;\u0026#34; last_position, last_inode, last_dev = load_state(state_file) while True: try: current_st = os.stat(log_file) except OSError: logging.warning(\u0026#34;Log file not found, retrying...\u0026#34;) time.sleep(1) continue if (current_st.st_ino != last_inode) or (current_st.st_dev != last_dev): logging.info(\u0026#34;New log file detected\u0026#34;) last_position = 0 last_inode = current_st.st_ino last_dev = current_st.st_dev save_state(state_file, last_position, last_inode, last_dev) if current_st.st_size \u0026lt; last_position: logging.info(\u0026#34;File truncated\u0026#34;) last_position = 0 save_state(state_file, last_position, last_inode, last_dev) if current_st.st_size \u0026gt; last_position: try: with open(log_file, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;, errors=\u0026#39;replace\u0026#39;) as f: f.seek(last_position) for line in f: process_log_entry(line.strip()) last_position = f.tell() save_state(state_file, last_position, last_inode, last_dev) except Exception as e: logging.error(f\u0026#34;Error reading log file: {str(e)}\u0026#34;) time.sleep(0.5) if __name__ == \u0026#34;__main__\u0026#34;: log_file = \u0026#39;/data/mysql/server_audit.log\u0026#39; state_file = \u0026#34;/opt/mysql_audit_monitor/mysqlMonitor.state\u0026#34; logging.info(f\u0026#34;Starting MySQL audit log monitoring: {log_file}\u0026#34;) try: monitor_log(state_file, log_file) except KeyboardInterrupt: logging.info(\u0026#34;Monitoring stopped\u0026#34;) sys.exit(0) åè®° ç”Ÿäº§ç¯å¢ƒå»ºè®® åœºæ™¯ æ¨èæ–¹æ¡ˆ MySQL 5.7.34ä»¥ä¸‹ç‰ˆæœ¬ MariaDBæ’ä»¶æ–¹æ¡ˆ MySQL 8.0+ Percona Serveræˆ–è¿ç§»è‡³MariaDB å®¡è®¡æ—¥å¿—å­˜å‚¨ ç‹¬ç«‹MySQLå®ä¾‹ï¼Œä¸ä¸šåŠ¡åº“ç‰©ç†éš”ç¦» é«˜é¢‘æ“ä½œç¯å¢ƒ å†™å…¥Elasticsearchæ›¿ä»£MySQL é€šè¿‡server_auditæ’ä»¶+Pythonç›‘æ§çš„ç»„åˆï¼Œå¯åœ¨MySQLç¤¾åŒºç‰ˆä½æˆæœ¬å®ç°ä¼ä¸šçº§å®¡è®¡éœ€æ±‚ã€‚ä½†éœ€æ³¨æ„ï¼š\nğŸ“Œ ç‰ˆæœ¬å…¼å®¹æ€§æ˜¯æˆåŠŸå‰æï¼ŒMySQL 8.0ç”¨æˆ·åŠ¡å¿…é€‰æ‹©Percona/MariaDB ğŸ“Œ æ—¥å¿—æ¸…æ´—ç¯èŠ‚ç›´æ¥å½±å“åˆ†æå‡†ç¡®æ€§ï¼ˆå¦‚è½¬ä¹‰ç¬¦å¤„ç†ï¼‰ ğŸ“Œ å®¡è®¡æ—¥å¿—å­˜å‚¨åˆ†ç¦»æ˜¯å®‰å…¨æœ€ä½³å®è·µ\næœ€ç»ˆæ•ˆæœï¼š\næ‰€æœ‰æ•°æ®åº“æ“ä½œå¯è§†åŒ–å±•ç¤º å®æ—¶æ•è·é«˜å±DDLè¯­å¥ æ»¡è¶³ç­‰ä¿2.0/ISO 27001å®¡è®¡è¦æ±‚ ","date":"2025-06-10T11:12:48Z","image":"https://www.ownit.top/title_pic/02.jpg","permalink":"https://www.ownit.top/p/202506101112/","title":"ä¸ºMySQLç¤¾åŒºç‰ˆå®ç°å®¡è®¡åŠŸèƒ½ï¼šä»æ’ä»¶é…ç½®åˆ°æ—¥å¿—ç›‘æ§å…¨è§£æ"},{"content":"èƒŒæ™¯ å…¬å¸æƒ³å¯¹æ¥AIæ™ºèƒ½ä½“ï¼Œç”¨äºå®¢æœç³»ç»Ÿï¼Œç»è¿‡è°ƒç ”å’Œå®æ–½ï¼Œè§‰å¾—DashScope ç¬¦åˆéœ€æ±‚ã€‚ é˜¿é‡Œäº‘æ¨å‡ºçš„DashScopeçµç§¯æ¨¡å‹æœåŠ¡ä¸ºå¼€å‘è€…æä¾›äº†ä¾¿æ·é«˜æ•ˆçš„å¤§æ¨¡å‹æ¥å…¥æ–¹æ¡ˆã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åŸºäºDashScope APIæ„å»ºä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„æ™ºèƒ½å¯¹è¯ç³»ç»Ÿï¼ŒåŒ…å«æµå¼å¯¹è¯ã€å·¥å…·è°ƒç”¨ç­‰é«˜çº§ç‰¹æ€§ã€‚\né¡¹ç›®èƒŒæ™¯ä¸æŠ€æœ¯é€‰å‹ æˆ‘ä»¬çš„é¡¹ç›®ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªä¼ä¸šçº§æ™ºèƒ½å®¢æœç³»ç»Ÿï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ ¸å¿ƒéœ€æ±‚ï¼š\næ”¯æŒå¤šè½®è‡ªç„¶è¯­è¨€å¯¹è¯ å®ç°ä½å»¶è¿Ÿçš„æµå¼å“åº” å¯æ‰©å±•çš„å·¥å…·è°ƒç”¨èƒ½åŠ› ç¨³å®šçš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² ç»è¿‡æŠ€æœ¯è¯„ä¼°ï¼Œæˆ‘ä»¬é€‰æ‹©äº†é˜¿é‡Œäº‘DashScopeæœåŠ¡ï¼Œä¸»è¦åŸºäºä»¥ä¸‹ä¼˜åŠ¿ï¼š\næ¨¡å‹å¤šæ ·æ€§ï¼šæä¾›QWENç³»åˆ—ç­‰å¤šç§å¤§è¯­è¨€æ¨¡å‹ APIå…¼å®¹æ€§ï¼šå…¼å®¹OpenAI APIæ ¼å¼ï¼Œé™ä½è¿ç§»æˆæœ¬ æ€§èƒ½ä¿éšœï¼šé˜¿é‡Œäº‘åŸºç¡€è®¾æ–½ç¡®ä¿æœåŠ¡ç¨³å®šæ€§ æˆæœ¬æ•ˆç›Šï¼šç›¸æ¯”è‡ªå»ºæ¨¡å‹é›†ç¾¤æ›´å…·æ€§ä»·æ¯” æ¨¡å‹åœ°å€ï¼šhttps://help.aliyun.com/zh/model-studio/videos/yi-large-quick-start\næ ¸å¿ƒä»£ç å®ç°ä¸ä¼˜åŒ– åŸºç¡€å¯¹è¯åŠŸèƒ½å®ç° æˆ‘ä»¬é¦–å…ˆå®ç°äº†åŸºç¡€çš„å¯¹è¯åŠŸèƒ½æ¨¡å—ï¼Œè¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 import json from typing import List, Dict, Optional import requests from pydantic import BaseModel from utils.LogHandler import log # é…ç½®ç®¡ç†ä½¿ç”¨Pydanticæ¨¡å‹ï¼Œä¾¿äºéªŒè¯å’Œæ–‡æ¡£åŒ– class DashScopeConfig(BaseModel): base_url: str = \u0026#34;https://dashscope.aliyuncs.com/compatible-mode/v1\u0026#34; api_key: str default_model: str = \u0026#34;qwen-plus\u0026#34; timeout: int = 30 max_retries: int = 3 class GPTChatResponse(BaseModel): content: str tool_calls: Optional[List[Dict]] = None def gpt_chat( messages: List[Dict[str, str]], config: DashScopeConfig, model: Optional[str] = None, temperature: Optional[float] = None, max_tokens: Optional[int] = 512 ) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34; æ ‡å‡†å¯¹è¯APIå®ç° :param messages: å¯¹è¯æ¶ˆæ¯åˆ—è¡¨ :param config: æœåŠ¡é…ç½® :param model: æŒ‡å®šæ¨¡å‹ï¼Œé»˜è®¤ä½¿ç”¨é…ç½®ä¸­çš„default_model :param temperature: ç”Ÿæˆå¤šæ ·æ€§æ§åˆ¶ :param max_tokens: æœ€å¤§è¾“å‡ºtokenæ•° :return: æ¨¡å‹ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹ \u0026#34;\u0026#34;\u0026#34; headers = { \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;, \u0026#39;Authorization\u0026#39;: f\u0026#39;Bearer {config.api_key}\u0026#39; } payload = { \u0026#39;model\u0026#39;: model or config.default_model, \u0026#39;messages\u0026#39;: messages, \u0026#39;max_tokens\u0026#39;: max_tokens, } if temperature is not None: payload[\u0026#39;temperature\u0026#39;] = temperature for attempt in range(config.max_retries): try: resp = requests.post( f\u0026#34;{config.base_url}/chat/completions\u0026#34;, headers=headers, json=payload, timeout=config.timeout ) resp.raise_for_status() json_data = resp.json() if choices := json_data.get(\u0026#39;choices\u0026#39;): if len(choices) \u0026gt; 0: return choices[0][\u0026#39;message\u0026#39;][\u0026#39;content\u0026#39;] raise ValueError(\u0026#34;No valid response from model\u0026#34;) except requests.exceptions.RequestException as e: log.error(f\u0026#34;Attempt {attempt + 1} failed: {str(e)}\u0026#34;) if attempt == config.max_retries - 1: raise if __name__ == \u0026#34;__main__\u0026#34;: config = DashScopeConfig(api_key=\u0026#34;sk-xxxxxx\u0026#34;) messages = [ {\u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;ä½ æ˜¯ä¸€åä¸“ä¸šå®¢æœäººå‘˜\u0026#34;}, {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;æ€ä¹ˆå¤„ç†å®¢æˆ·äº‰åµé—®é¢˜\u0026#34;} ] response = gpt_chat(messages, config) print(response) æµå¼å¯¹è¯é«˜çº§å®ç° ä¸ºæå‡ç”¨æˆ·ä½“éªŒï¼Œæˆ‘ä»¬å®ç°äº†æµå¼å¯¹è¯åŠŸèƒ½ï¼Œå¹¶è¿›è¡Œäº†å¤šé¡¹ä¼˜åŒ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 import json from typing import List, Dict, Optional import requests from pydantic import BaseModel from utils.LogHandler import log # é…ç½®ç®¡ç†ä½¿ç”¨Pydanticæ¨¡å‹ï¼Œä¾¿äºéªŒè¯å’Œæ–‡æ¡£åŒ– class DashScopeConfig(BaseModel): base_url: str = \u0026#34;https://dashscope.aliyuncs.com/compatible-mode/v1\u0026#34; api_key: str default_model: str = \u0026#34;qwen-plus\u0026#34; timeout: int = 30 max_retries: int = 3 class GPTChatResponse(BaseModel): content: str tool_calls: Optional[List[Dict]] = None def gpt_stream_chat( messages: List[Dict[str, str]], config: DashScopeConfig, model: Optional[str] = None, tools: Optional[List[Dict]] = None, on_content: Optional[callable] = None ) -\u0026gt; GPTChatResponse: \u0026#34;\u0026#34;\u0026#34; æµå¼å¯¹è¯å®ç°ï¼Œæ”¯æŒå®æ—¶å†…å®¹å¤„ç†å’Œå·¥å…·è°ƒç”¨ :param messages: å¯¹è¯æ¶ˆæ¯åˆ—è¡¨ :param config: æœåŠ¡é…ç½® :param model: æŒ‡å®šæ¨¡å‹ :param tools: å¯ç”¨å·¥å…·åˆ—è¡¨ :param on_content: å†…å®¹å›è°ƒå‡½æ•° :return: GPTChatResponseå¯¹è±¡ \u0026#34;\u0026#34;\u0026#34; headers = { \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;, \u0026#39;Authorization\u0026#39;: f\u0026#39;Bearer {config.api_key}\u0026#39; } payload = { \u0026#39;model\u0026#39;: model or config.default_model, \u0026#39;messages\u0026#39;: messages, \u0026#39;stream\u0026#39;: True } if tools: payload[\u0026#39;tools\u0026#39;] = tools content_list = [] tool_calls = None try: resp = requests.post( f\u0026#34;{config.base_url}/chat/completions\u0026#34;, headers=headers, json=payload, stream=True, timeout=config.timeout ) resp.raise_for_status() for line in resp.iter_lines(): if not line or line == b\u0026#39;data: [DONE]\u0026#39;: continue try: chunk = json.loads(line.decode(\u0026#39;utf-8\u0026#39;)[6:]) delta = chunk[\u0026#39;choices\u0026#39;][0][\u0026#39;delta\u0026#39;] # å¤„ç†æ¨ç†è¿‡ç¨‹å†…å®¹ if content := delta.get(\u0026#39;reasoning_content\u0026#39;): if on_content: on_content(content, \u0026#39;reasoning\u0026#39;) content_list.append(content) # å¤„ç†æœ€ç»ˆå›å¤å†…å®¹ if content := delta.get(\u0026#39;content\u0026#39;): if on_content: on_content(content, \u0026#39;content\u0026#39;) content_list.append(content) # å¤„ç†å·¥å…·è°ƒç”¨ if \u0026#39;tool_calls\u0026#39; in delta: tool_calls = delta[\u0026#39;tool_calls\u0026#39;] if tool_calls and \u0026#39;name\u0026#39; in str(tool_calls): break except json.JSONDecodeError: log.warning(f\u0026#34;Failed to decode chunk: {line}\u0026#34;) continue except requests.exceptions.RequestException as e: log.error(f\u0026#34;Stream request failed: {str(e)}\u0026#34;) raise return GPTChatResponse(content=\u0026#39;\u0026#39;.join(content_list), tool_calls=tool_calls) def handle_stream_content(content: str, content_type: str): print(content, end=\u0026#39;\u0026#39;, flush=True) # å®æ—¶è¾“å‡ºï¼Œä¸æ¢è¡Œ if __name__ == \u0026#34;__main__\u0026#34;: config = DashScopeConfig(api_key=\u0026#34;sk-xxxxxxxxxxxxxxxxxxxxxx\u0026#34;) messages = [ {\u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;ä½ æ˜¯ä¸€åä¸“ä¸šå®¢æœäººå‘˜\u0026#34;}, {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;ä½ å¥½ï¼Ÿ\u0026#34;} ] response = gpt_stream_chat(messages, config, on_content=handle_stream_content) # print(response.content) ç»“æŸ æˆ‘ä»¬æˆåŠŸæ„å»ºäº†åŸºäºé˜¿é‡Œäº‘DashScopeçš„é«˜æ•ˆæ™ºèƒ½å¯¹è¯ç³»ç»Ÿã€‚è¿™å¥—æ–¹æ¡ˆä¸ä»…é€‚ç”¨äºå®¢æœåœºæ™¯ï¼Œä¹Ÿå¯æ‰©å±•åº”ç”¨äºæ™ºèƒ½åŠ©æ‰‹ã€å†…å®¹ç”Ÿæˆç­‰å¤šç§AIåº”ç”¨åœºæ™¯ã€‚DashScopeæœåŠ¡çš„ç¨³å®šæ€§å’Œæ˜“ç”¨æ€§ä¸ºä¸­å°ä¼ä¸šå¿«é€Ÿéƒ¨ç½²AIèƒ½åŠ›æä¾›äº†å¯é é€‰æ‹©ã€‚\n","date":"2025-05-22T18:40:54Z","image":"https://www.ownit.top/title_pic/35.jpg","permalink":"https://www.ownit.top/p/202505221840/","title":"åŸºäºé˜¿é‡Œäº‘DashScope APIæ„å»ºæ™ºèƒ½å¯¹è¯æŒ‡å—"},{"content":"ä»€ä¹ˆæ˜¯å‘é‡åº“ï¼Ÿ å‘é‡åº“ï¼ˆVector Databaseï¼‰æ˜¯ä¸€ç§ä¸“é—¨è®¾è®¡ç”¨æ¥å­˜å‚¨å’Œæ£€ç´¢å‘é‡æ•°æ®çš„æ•°æ®åº“ç³»ç»Ÿã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨çš„ChromaDBå°±æ˜¯ä¸€ç§å‘é‡æ•°æ®åº“ã€‚\nå‘é‡åº“çš„æ ¸å¿ƒæ¦‚å¿µï¼š\nå‘é‡åµŒå…¥ï¼ˆEmbeddingsï¼‰ ï¼šå°†æ–‡æœ¬ã€å›¾åƒç­‰éç»“æ„åŒ–æ•°æ®è½¬æ¢ä¸ºé«˜ç»´æ•°å­—å‘é‡ ç›¸ä¼¼æ€§æœç´¢ ï¼šåŸºäºå‘é‡é—´çš„è·ç¦»ï¼ˆå¦‚ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰å¿«é€ŸæŸ¥æ‰¾ç›¸ä¼¼å†…å®¹ é«˜æ•ˆç´¢å¼• ï¼šä½¿ç”¨ç‰¹æ®Šçš„ç´¢å¼•ç»“æ„ï¼ˆå¦‚HNSWï¼‰åŠ é€Ÿç›¸ä¼¼æ€§æœç´¢ å‘é‡åº“çš„ç”¨é€” åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œå‘é‡åº“ä¸»è¦ç”¨äºå®¢æœé—®ç­”ç³»ç»Ÿï¼š\nçŸ¥è¯†åº“ç®¡ç† ï¼šå­˜å‚¨é—®é¢˜å’Œç­”æ¡ˆå¯¹ï¼Œå¹¶å°†é—®é¢˜è½¬æ¢ä¸ºå‘é‡å½¢å¼å­˜å‚¨ è¯­ä¹‰æœç´¢ ï¼šå½“ç”¨æˆ·æé—®æ—¶ï¼Œå°†é—®é¢˜è½¬æ¢ä¸ºå‘é‡ï¼Œåœ¨å‘é‡åº“ä¸­æŸ¥æ‰¾æœ€ç›¸ä¼¼çš„å·²å­˜é—®é¢˜ æ™ºèƒ½åŒ¹é… ï¼šæ ¹æ®è¯­ä¹‰ç›¸ä¼¼åº¦è€Œéç®€å•çš„å…³é”®è¯åŒ¹é…ï¼Œæ‰¾åˆ°æœ€ç›¸å…³çš„ç­”æ¡ˆ Chroma å‘é‡åº“å®æˆ˜ Chroma æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºå¸¦æœ‰åµŒå…¥å‘é‡ï¼ˆvector embeddingï¼‰çš„ AI åº”ç”¨ç¨‹åºçš„å‘é‡æ•°æ®åº“ã€‚å®ƒä»¬å¯ä»¥è¡¨ç¤ºæ–‡æœ¬ã€å›¾åƒï¼Œå¾ˆå¿«è¿˜å¯ä»¥è¡¨ç¤ºéŸ³é¢‘å’Œè§†é¢‘ã€‚å®ƒå†…ç½®äº†æ‚¨å¼€å§‹ä½¿ç”¨æ‰€éœ€çš„ä¸€åˆ‡ï¼Œå¹¶åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šè¿è¡Œã€‚ä»–æ˜¯å¼€æºå…è´¹ï¼Œå¯ä»¥æœ¬åœ°éƒ¨ç½²ï¼Œæ”¯æŒpythonå’Œjsã€‚è¿™æ˜¯ä»–çš„ä¼˜ç‚¹ã€‚pineconeåˆ™æ˜¯ä»˜è´¹ï¼Œè€Œä¸”éœ€è¦å­˜å‚¨æ•°æ®åˆ°pineconeæœåŠ¡å™¨ä¸Šé¢ï¼Œè¿™ç‚¹å¯¹äºæ•°æ®æ¯”è¾ƒé‡è¦çš„ä¼ä¸šå°¤å…¶ä¸å¥½ï¼ŒChromaåˆ™æ˜¯å­˜å‚¨åœ¨è‡ªå·±çš„æœåŠ¡å™¨\nChromaDB æ˜¯ä¸€ä¸ªå¼€æºçš„å‘é‡æ•°æ®åº“ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨å’Œæ£€ç´¢å‘é‡æ•°æ®ã€‚å®ƒç‰¹åˆ«é€‚åˆæ„å»ºè¯­ä¹‰æœç´¢ã€é—®ç­”ç³»ç»Ÿç­‰ AI åº”ç”¨ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ ChromaDB å®ç°åŸºæœ¬çš„å‘é‡æ•°æ®åº“æ“ä½œï¼ŒåŒ…æ‹¬æ•°æ®çš„å¢åˆ æ”¹æŸ¥ã€‚\nç¯å¢ƒå‡†å¤‡ æœ¬ç¤ºä¾‹ä½¿ç”¨äº†ä»¥ä¸‹ä¸»è¦ä¾èµ–ï¼š\nchromadbï¼šå‘é‡æ•°æ®åº“ dashscopeï¼šæ–‡æœ¬å‘é‡åŒ–æœåŠ¡ 1 2 pip install chromadb pip install dashscope 1 2 3 4 5 6 7 8 9 10 11 12 import chromadb # chroma_client = chromadb.Client() #å†…å­˜æ¨¡å¼ # æ•°æ®ä¿å­˜åœ¨ç£ç›˜ client = chromadb.PersistentClient(path=\u0026#34;E:\\\\Code\\\\Python\\\\weather\\\\chromadbTest\u0026#34;) collection = client.get_collection(name=\u0026#34;fruit_collection\u0026#34;) # æ’å…¥æ•°æ® collection.add( documents=[\u0026#34;This is a document about apples\u0026#34;, \u0026#34;This is a document about oranges\u0026#34;], metadatas=[{\u0026#34;source\u0026#34;: \u0026#34;web\u0026#34;}, {\u0026#34;source\u0026#34;: \u0026#34;book\u0026#34;}], ids=[\u0026#34;id1\u0026#34;, \u0026#34;id2\u0026#34;] ) å®¢æœå‘é‡åº“å®æˆ˜ EmbeddingClient EmbeddingClient ç±»è´Ÿè´£å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡è¡¨ç¤ºã€‚å®ƒä½¿ç”¨å•ä¾‹æ¨¡å¼ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶é€šè¿‡ dashscope æœåŠ¡è¿›è¡Œæ–‡æœ¬å‘é‡åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 class EmbeddingClient: def get_embedding(self, text: Union[str, List[str]]) -\u0026gt; List[float]: \u0026#34;\u0026#34;\u0026#34;è·å–æ–‡æœ¬çš„å‘é‡è¡¨ç¤º\u0026#34;\u0026#34;\u0026#34; # é€šè¿‡ dashscope æœåŠ¡å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡ resp = dashscope.TextEmbedding.call( model=self.model, input=text ) return resp.output[\u0026#39;embeddings\u0026#39;][0][\u0026#39;embedding\u0026#39;] å®Œæ•´ä»£ç ï¼š DashScopeæ˜¯é˜¿é‡Œäº‘çš„ä¸€æ¬¾æ¨¡å‹æœåŠ¡äº§å“ï¼Œç®€åŒ–äº†AIæ¨¡å‹çš„åº”ç”¨ä¸éƒ¨ç½²ã€‚ å·²å¼€é€šæœåŠ¡å¹¶è·å¾—API-KEYï¼šå¼€é€šDashScopeå¹¶åˆ›å»ºAPI-KEYã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 from http import HTTPStatus import dashscope from typing import List, Union from utils.LogHandler import log # from conf.config import dashscope_api_key dashscope_api_key = \u0026#34;sk-xxxxxxxxxxx\u0026#34; class EmbeddingClient: _instance = None # ç”¨äºä¿å­˜å•ä¾‹å¯¹è±¡ def __new__(cls): \u0026#34;\u0026#34;\u0026#34; ç¡®ä¿ `EmbeddingClient` ç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰ \u0026#34;\u0026#34;\u0026#34; if cls._instance is None: cls._instance = super().__new__(cls) cls._instance._initialize() return cls._instance def _initialize(self): \u0026#34;\u0026#34;\u0026#34; åˆå§‹åŒ–å®¢æˆ·ç«¯è¿æ¥ \u0026#34;\u0026#34;\u0026#34; dashscope.api_key = dashscope_api_key self.model = dashscope.TextEmbedding.Models.text_embedding_v3 def get_embedding(self, text: Union[str, List[str]]) -\u0026gt; List[float]: \u0026#34;\u0026#34;\u0026#34; è·å–æ–‡æœ¬çš„å‘é‡è¡¨ç¤º :param text: è¾“å…¥æ–‡æœ¬ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²åˆ—è¡¨ :return: å‘é‡åˆ—è¡¨ \u0026#34;\u0026#34;\u0026#34; try: resp = dashscope.TextEmbedding.call( model=self.model, input=text ) if resp.status_code == HTTPStatus.OK: embedding = resp.output[\u0026#39;embeddings\u0026#39;][0][\u0026#39;embedding\u0026#39;] return embedding else: log.error(f\u0026#34;Embeddingç”Ÿæˆå¤±è´¥: status_code={resp.status_code}\u0026#34;) raise Exception(f\u0026#34;Embeddingç”Ÿæˆå¤±è´¥: {resp.status_code}\u0026#34;) except Exception as e: log.error(f\u0026#34;Embeddingå¼‚å¸¸: {str(e)}\u0026#34;) raise # è·å– embedding_client çš„æ–¹æ³• def get_embedding_client() -\u0026gt; EmbeddingClient: \u0026#34;\u0026#34;\u0026#34; è·å–EmbeddingClientå®ä¾‹ :return: EmbeddingClientçš„å•ä¾‹å¯¹è±¡ \u0026#34;\u0026#34;\u0026#34; return EmbeddingClient() ChromaClient ChromaClient ç±»å°è£…äº†ä¸ ChromaDB çš„äº¤äº’æ“ä½œï¼Œæä¾›äº†ä»¥ä¸‹ä¸»è¦åŠŸèƒ½ï¼š\nå‘é‡æ•°æ®çš„æ’å…¥å’Œæ›´æ–° ç›¸ä¼¼å‘é‡æŸ¥è¯¢ å‘é‡æ•°æ®åˆ é™¤ é›†åˆç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 import hashlib import os from datetime import datetime from pathlib import Path from typing import Optional, Tuple import chromadb from chromadb.config import Settings from embedding_client import get_embedding_client from utils.LogHandler import log class ChromaClient: def __init__(self, persist_directory: str = None): \u0026#34;\u0026#34;\u0026#34; åˆå§‹åŒ–Chromaå®¢æˆ·ç«¯ :param persist_directory: æŒä¹…åŒ–å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤ä¸ºé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„chroma_db \u0026#34;\u0026#34;\u0026#34; if persist_directory is None: # è·å–é¡¹ç›®æ ¹ç›®å½• root_dir = Path(__file__).parent.parent persist_directory = os.path.join(root_dir, \u0026#34;chroma_db\u0026#34;) # ç¡®ä¿ç›®å½•å­˜åœ¨ os.makedirs(persist_directory, exist_ok=True) # ä¿®æ”¹åˆå§‹åŒ–è®¾ç½® self.client = chromadb.PersistentClient( path=persist_directory, settings=Settings( anonymized_telemetry=False, is_persistent=True # æ˜¾å¼æŒ‡å®šæŒä¹…åŒ– ) ) # åˆ›å»ºæˆ–è·å–é›†åˆ self.collection = self.client.get_or_create_collection( name=\u0026#34;kefu_qa\u0026#34;, metadata={\u0026#34;hnsw:space\u0026#34;: \u0026#34;cosine\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;å®¢æœé—®ç­”å‘é‡åº“\u0026#34;} ) self.embedding_client = get_embedding_client() from utils.LogHandler import log log.info(f\u0026#34;ChromaDB initialized at: {persist_directory}\u0026#34;) def upsert_vectors(self, question: str, answer: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34; æ’å…¥æˆ–æ›´æ–°å‘é‡ :param question: é—®é¢˜æ–‡æœ¬ :param answer: ç­”æ¡ˆæ–‡æœ¬ :return: æ“ä½œç»“æœä¿¡æ¯ \u0026#34;\u0026#34;\u0026#34; qhash = hashlib.md5(question.encode(\u0026#39;utf-8\u0026#39;)).hexdigest() try: embedding = self.embedding_client.get_embedding(question) metadata = { \u0026#34;answer\u0026#34;: answer, \u0026#34;timestamp\u0026#34;: datetime.now().isoformat() } self.collection.upsert( ids=[qhash], embeddings=[embedding], documents=[question], metadatas=[metadata] ) log.info(f\u0026#34;Successfully upserted vector for question: {question}\u0026#34;) return \u0026#34;æ’å…¥æ›´æ–°æˆåŠŸ\u0026#34; except Exception as e: log.error(f\u0026#34;å‘é‡æ›´æ–°å¤±è´¥: {str(e)}\u0026#34;, exc_info=True) return f\u0026#34;å‘é‡æ›´æ–°å¤±è´¥: {str(e)}\u0026#34; def query_similar(self, query_text: str, top_k: int = 1) -\u0026gt; Tuple[str, Optional[str], Optional[str]]: \u0026#34;\u0026#34;\u0026#34; æŸ¥è¯¢ç›¸ä¼¼å‘é‡ :param query_text: æŸ¥è¯¢æ–‡æœ¬ :param top_k: è¿”å›ç»“æœæ•°é‡ :return: (æŸ¥è¯¢æ–‡æœ¬, åŒ¹é…é—®é¢˜, åŒ¹é…ç­”æ¡ˆ) \u0026#34;\u0026#34;\u0026#34; try: query_embedding = self.embedding_client.get_embedding(query_text) results = self.collection.query( query_embeddings=[query_embedding], n_results=top_k, include=[\u0026#34;documents\u0026#34;, \u0026#34;metadatas\u0026#34;, \u0026#34;distances\u0026#34;], where=None, # å¯é€‰çš„è¿‡æ»¤æ¡ä»¶ where_document=None # å¯é€‰çš„æ–‡æ¡£è¿‡æ»¤æ¡ä»¶ ) # æ£€æŸ¥ç»“æœæ˜¯å¦ä¸ºç©º if not results[\u0026#39;ids\u0026#39;] or not results[\u0026#39;ids\u0026#39;][0]: log.info(f\u0026#34;æœªæ‰¾åˆ°åŒ¹é…é—®é¢˜ï¼š{query_text}\u0026#34;) return query_text, None, None # è·å–ç›¸ä¼¼åº¦åˆ†æ•° distance = results[\u0026#39;distances\u0026#39;][0][0] if distance \u0026gt; 0.4: # ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ log.info(f\u0026#34;æ‰¾åˆ°çš„åŒ¹é…ç›¸ä¼¼åº¦è¿‡ä½ï¼š{distance}\u0026#34;) return query_text, None, None question = results[\u0026#39;documents\u0026#39;][0][0] answer = results[\u0026#39;metadatas\u0026#39;][0][0][\u0026#39;answer\u0026#39;] log.info( f\u0026#34;æŸ¥è¯¢æˆåŠŸ: question={query_text},link_query_text={question}, answer={answer}, distance={distance}\u0026#34;) return query_text, question, answer except Exception as e: log.error(f\u0026#34;æŸ¥è¯¢å¤±è´¥: {str(e)}\u0026#34;, exc_info=True) return query_text, None, None def delete_vectors(self, qhash: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34; æ ¹æ®é—®é¢˜åˆ é™¤å‘é‡ :param qhash: :return: åˆ é™¤ç»“æœä¿¡æ¯ \u0026#34;\u0026#34;\u0026#34; try: # å…ˆæ£€æŸ¥é›†åˆä¸­çš„æ•°æ® log.info(f\u0026#34;å½“å‰é›†åˆçŠ¶æ€: {self.get_collection_stats()}\u0026#34;) # å°è¯•è·å–è¦åˆ é™¤çš„è®°å½• existing = self.collection.get( ids=[qhash] ) log.info(f\u0026#34;è¦åˆ é™¤çš„è®°å½•: {existing}\u0026#34;) self.collection.delete( ids=[qhash] ) log.info(f\u0026#34;å·²æ‰§è¡Œåˆ é™¤: {qhash}\u0026#34;) log.info(f\u0026#34;å½“å‰é›†åˆçŠ¶æ€: {self.get_collection_stats()}\u0026#34;) return \u0026#34;é—®é¢˜è®°å½•å·²åˆ é™¤\u0026#34; except Exception as e: log.error(f\u0026#34;åˆ é™¤å¤±è´¥: {str(e)}\u0026#34;, exc_info=True) return f\u0026#34;åˆ é™¤å¤±è´¥: {str(e)}\u0026#34; def get_collection_stats(self) -\u0026gt; dict: \u0026#34;\u0026#34;\u0026#34; è·å–é›†åˆç»Ÿè®¡ä¿¡æ¯ \u0026#34;\u0026#34;\u0026#34; return { \u0026#34;total_count\u0026#34;: self.collection.count(), \u0026#34;name\u0026#34;: self.collection.name, \u0026#34;metadata\u0026#34;: self.collection.metadata } _chroma_client = None def get_chroma_client(): global _chroma_client try: # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œæˆ–è€…éœ€è¦é‡æ–°æ£€æŸ¥çŠ¶æ€ if _chroma_client is None: _chroma_client = ChromaClient() # è·å–é›†åˆç»Ÿè®¡ä¿¡æ¯è¿›è¡Œæ›´è¯¦ç»†çš„çŠ¶æ€æ£€æŸ¥ log.info(f\u0026#39;chroma_client_status={_chroma_client.get_collection_stats()}\u0026#39;) return _chroma_client except Exception as e: # å¦‚æœå‡ºç°ä»»ä½•å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—å¹¶é‡æ–°åˆ›å»º log.error(f\u0026#34;è·å–ChromaClientå¤±è´¥ï¼Œé‡æ–°åˆ›å»ºå¯¹è±¡: {e}\u0026#34;) _chroma_client = ChromaClient() return _chroma_client if __name__ == \u0026#34;__main__\u0026#34;: chroma_client = get_chroma_client() stats = chroma_client.get_collection_stats() print(f\u0026#34;åˆ é™¤å‰çš„é›†åˆç»Ÿè®¡: {stats}\u0026#34;) æ—¥å¿—è®°å½•å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 import os import logging from logging.handlers import TimedRotatingFileHandler # ç¡®å®šæ—¥å¿—å­˜å‚¨è·¯å¾„ï¼Œç¡®ä¿è·¯å¾„å­˜åœ¨ CURRENT_PATH = os.path.dirname(os.path.abspath(__file__)) ROOT_PATH = os.path.abspath(os.path.join(CURRENT_PATH, \u0026#34;..\u0026#34;, \u0026#34;..\u0026#34;, \u0026#34;..\u0026#34;)) # LOG_PATH = \u0026#34;/app/logs/app/\u0026#34; LOG_PATH = os.path.join(ROOT_PATH, \u0026#39;logs\u0026#39;) if not os.path.exists(LOG_PATH): os.makedirs(LOG_PATH) # è‡ªå®šä¹‰ Filterï¼Œç”¨äºç¡®ä¿æ—¥å¿— record ä¸­åŒ…å« traceId å±æ€§ï¼Œä¸å­˜åœ¨æ—¶è®¾ä¸ºé»˜è®¤ \u0026#34;null\u0026#34; class TraceIdFilter(logging.Filter): def filter(self, record): if not hasattr(record, \u0026#34;traceId\u0026#34;): record.traceId = \u0026#34;null\u0026#34; return True # è‡ªå®šä¹‰ Formatterï¼Œç”¨äºå°†å¼‚å¸¸ä¿¡æ¯ä¸­çš„æ¢è¡Œç¬¦æ›¿æ¢ä¸ºåˆ†éš”ç¬¦ï¼Œä½¿å¼‚å¸¸ä¿¡æ¯æ˜¾ç¤ºä¸ºå•è¡Œ class SingleLineExceptionFormatter(logging.Formatter): def formatException(self, exc_info): result = super().formatException(exc_info) # å°†æ¢è¡Œç¬¦æ›¿æ¢ä¸ºç©ºæ ¼æˆ–å…¶ä»–åˆ†éš”ç¬¦ï¼Œä¾‹å¦‚ \u0026#34; | \u0026#34; return result.replace(\u0026#39;\\n\u0026#39;, \u0026#39; | \u0026#39;) # å®šä¹‰æ—¥å¿—æ ¼å¼ä¸æ—¶é—´æ ¼å¼ï¼ˆæ¨¡ä»¿ Java è¾“å‡ºæ ¼å¼ï¼‰ LOG_FORMAT = \u0026#39;%(asctime)s.%(msecs)03d [%(levelname)s] [%(traceId)s] [%(threadName)s] [%(name).36s] [%(lineno)d] [ %(filename)s] [%(funcName)s] - %(message)s\u0026#39; DATE_FORMAT = \u0026#39;%Y-%m-%d %H:%M:%S\u0026#39; class LogHandler(logging.Logger): def __init__(self, name, level=logging.INFO, use_stream=True, use_file=True): super().__init__(name, level) self.name = name self.level = level # æ·»åŠ  filterï¼Œç¡®ä¿ traceId ä¸ä¸ºç©º self.addFilter(TraceIdFilter()) if use_stream: self.__setStreamHandler__() if use_file: self.__setFileHandler__() def __setFileHandler__(self, level=None): # æ—¥å¿—æ–‡ä»¶åï¼šLOG_PATH ä¸‹ï¼Œåç§°ä¸º {logger_name}.log file_name = os.path.join(LOG_PATH, f\u0026#39;{self.name}.log\u0026#39;) # ä½¿ç”¨æŒ‰å¤©æ»šåŠ¨ï¼ˆæ¯æ—¥ä¸€ä¸ªæ–‡ä»¶ï¼‰ï¼Œä¿ç•™7å¤©çš„æ—¥å¿— file_handler = TimedRotatingFileHandler(filename=file_name, when=\u0026#39;D\u0026#39;, interval=1, backupCount=7, encoding=\u0026#34;utf-8\u0026#34;) file_handler.suffix = \u0026#39;%Y%m%d.log\u0026#39; file_handler.setLevel(level if level is not None else self.level) formatter = SingleLineExceptionFormatter(LOG_FORMAT, datefmt=DATE_FORMAT) file_handler.setFormatter(formatter) self.file_handler = file_handler self.addHandler(file_handler) def __setStreamHandler__(self, level=None): stream_handler = logging.StreamHandler() stream_handler.setLevel(level if level is not None else self.level) formatter = SingleLineExceptionFormatter(LOG_FORMAT, datefmt=DATE_FORMAT) stream_handler.setFormatter(formatter) self.addHandler(stream_handler) def resetName(self, name): self.name = name self.removeHandler(self.file_handler) self.__setFileHandler__() project_name = \u0026#39;app\u0026#39; # åˆå§‹åŒ– loggerï¼Œçº§åˆ«è®¾ç½®ä¸º DEBUG log = LogHandler(project_name, level=logging.DEBUG) # ä½¿ç”¨ç¤ºä¾‹ï¼šè®¾ç½®é¡¹ç›®åç§°ä¸º \u0026#34;app\u0026#34; å¹¶åˆå§‹åŒ–æ—¥å¿—å®ä¾‹ if __name__ == \u0026#39;__main__\u0026#39;: # æµ‹è¯•æ—¥å¿—è¾“å‡º log.info(\u0026#39;This is a test message\u0026#39;) # æ¨¡æ‹Ÿå¼‚å¸¸æƒ…å†µï¼Œæµ‹è¯•å¼‚å¸¸æ‰“å°ä¸ºå•è¡Œ try: 1 / 0 except Exception as e: # è¿™é‡Œä½¿ç”¨ extra å‚æ•°ä¼ å…¥ traceIdï¼Œå¦‚æœä¸ä¼ åˆ™é»˜è®¤æ˜¾ç¤º \u0026#34;null\u0026#34; log.exception(\u0026#34;An error occurred\u0026#34;, extra={\u0026#34;traceId\u0026#34;: \u0026#34;trace-123\u0026#34;}) å®Œæ•´ç¤ºä¾‹ chroma_demo.py\næä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹è„šæœ¬ chroma_demo.pyï¼Œå±•ç¤ºäº†å‘é‡æ•°æ®åº“çš„åŸºæœ¬æ“ä½œï¼š\næ·»åŠ ç¤ºä¾‹é—®ç­”å¯¹æ•°æ® è¿›è¡Œç›¸ä¼¼é—®é¢˜æŸ¥è¯¢ åˆ é™¤æŒ‡å®šçš„é—®ç­”å¯¹ æŸ¥çœ‹é›†åˆç»Ÿè®¡ä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 import os from chroma_client import get_chroma_client def demo_chroma_operations(): # è·å–ChromaDBå®¢æˆ·ç«¯å®ä¾‹ chroma_client = get_chroma_client() # 1. æ·»åŠ ç¤ºä¾‹æ•°æ® print(\u0026#34;\\n1. æ·»åŠ ç¤ºä¾‹æ•°æ®\u0026#34;) qa_pairs = [ (\u0026#34;å¦‚ä½•æŸ¥è¯¢è®¢å•ç‰©æµï¼Ÿ\u0026#34;, \u0026#34;ç™»å½•è´¦å·åè¿›å…¥ã€æˆ‘çš„è®¢å•ã€ï¼Œç‚¹å‡»å¯¹åº”è®¢å•çš„ã€ç‰©æµè¯¦æƒ…ã€å³å¯æŸ¥çœ‹å®æ—¶å¿«é€’ä¿¡æ¯ï¼Œè‹¥æœªæ›´æ–°å¯è”ç³»æ‰¿è¿å•†æŸ¥è¯¢ã€‚\u0026#34;), (\u0026#34;ä»Šæ—¥æœ‰ä»€ä¹ˆé™æ—¶ä¼˜æƒ ï¼Ÿ\u0026#34;, \u0026#34;ä»Šå¤©æ˜¯2025å¹´4æœˆ28æ—¥ï¼Œå‘¨ä¸€ä¼šå‘˜æ—¥å¯äº«å…¨åœº9æŠ˜ï¼Œéƒ¨åˆ†å•†å“å‚ä¸ã€äº”ä¸€æå‰è´­ã€æ´»åŠ¨ï¼Œæ»¡300å‡50ã€‚\u0026#34;), (\u0026#34;å•†å“ç­¾æ”¶åå‘ç°æœ‰ç ´æŸæ€ä¹ˆåŠï¼Ÿ\u0026#34;, \u0026#34;è¯·äºç­¾æ”¶å48å°æ—¶å†…æ‹ç…§ç•™å­˜è¯æ®ï¼Œé€šè¿‡è®¢å•é¡µé¢æäº¤ã€å”®åç”³è¯·ã€ï¼Œæˆ‘ä»¬å°†ä¼˜å…ˆå¤„ç†æ‚¨çš„è¡¥å¿æˆ–æ¢è´§éœ€æ±‚ã€‚\u0026#34;), (\u0026#34;å¦‚ä½•ä¿®æ”¹ç»‘å®šçš„æ‰‹æœºå·ï¼Ÿ\u0026#34;, \u0026#34;åœ¨è´¦æˆ·è®¾ç½®çš„ã€å®‰å…¨ä¸­å¿ƒã€ä¸­éªŒè¯åŸæ‰‹æœºå·åï¼Œå¯ç›´æ¥è¾“å…¥æ–°æ‰‹æœºå·å¹¶æ¥æ”¶éªŒè¯ç å®Œæˆæ›´æ¢ã€‚\u0026#34;), (\u0026#34;ç§¯åˆ†ä¼šè¿‡æœŸå—ï¼Ÿ\u0026#34;, \u0026#34;ç§¯åˆ†æœ‰æ•ˆæœŸä¸º1å¹´ï¼Œæ¯å¹´12æœˆ31æ—¥æ¸…é›¶æœªä½¿ç”¨çš„ç§¯åˆ†ï¼Œå½“å‰è´¦æˆ·ç§¯åˆ†å¯åœ¨ã€ä¼šå‘˜ä¸­å¿ƒã€æŸ¥çœ‹åˆ°æœŸæ—¶é—´ã€‚\u0026#34;), (\u0026#34;äº”ä¸€å‡æœŸæœŸé—´å‘è´§å—ï¼Ÿ\u0026#34;, \u0026#34;2025å¹´äº”ä¸€å‡æœŸä¸º5æœˆ1æ—¥è‡³5æ—¥ï¼ŒæœŸé—´ä»“åº“æš‚åœå‘è´§ï¼Œ4æœˆ30æ—¥18:00å‰çš„è®¢å•å°†å°½é‡èŠ‚å‰å‘å‡ºã€‚\u0026#34;), (\u0026#34;å¦‚ä½•å¼€å…·ç”µå­å‘ç¥¨ï¼Ÿ\u0026#34;, \u0026#34;ä¸‹å•æ—¶å‹¾é€‰ã€éœ€è¦å‘ç¥¨ã€å¹¶å¡«å†™æŠ¬å¤´ä¿¡æ¯ï¼Œç”µå­å‘ç¥¨å°†åœ¨è®¢å•å®Œæˆå72å°æ—¶å†…å‘é€è‡³æ‚¨çš„é‚®ç®±ã€‚\u0026#34;), (\u0026#34;æ–°ç”¨æˆ·æœ‰å“ªäº›ç¦åˆ©ï¼Ÿ\u0026#34;, \u0026#34;é¦–æ¬¡æ³¨å†Œå¯é¢†å–100å…ƒä¼˜æƒ åˆ¸åŒ…ï¼ˆå«3å¼ åˆ¸ï¼‰ï¼Œé¦–å•æ»¡199å…ƒè¿˜å¯é¢å¤–è·å¾—åŒå€ç§¯åˆ†ã€‚\u0026#34;), (\u0026#34;å¿˜è®°å¯†ç å¦‚ä½•é‡ç½®ï¼Ÿ\u0026#34;, \u0026#34;åœ¨ç™»å½•é¡µç‚¹å‡»ã€å¿˜è®°å¯†ç ã€ï¼Œé€šè¿‡ç»‘å®šçš„æ‰‹æœºå·æˆ–é‚®ç®±æ¥æ”¶éªŒè¯ç ï¼ŒæŒ‰æŒ‡å¼•è®¾ç½®æ–°å¯†ç å³å¯ã€‚\u0026#34;), (\u0026#34;ä»Šæ—¥ä¸‹å•ä½•æ—¶èƒ½åˆ°è´§ï¼Ÿ\u0026#34;, \u0026#34;å½“å‰æ—¶é—´ä¸º17:27ï¼Œä»Šæ—¥å†…ä¸‹å•ä¸”é€‰æ‹©å¿«é€’é…é€ï¼ŒåŒåŸé¢„è®¡4æœˆ30æ—¥å‰é€è¾¾ï¼Œå¼‚åœ°éœ€3-5ä¸ªå·¥ä½œæ—¥ï¼ˆäº”ä¸€å‡æœŸå¯èƒ½å»¶è¿Ÿï¼‰ã€‚\u0026#34;) ] for question, answer in qa_pairs: result = chroma_client.upsert_vectors(question, answer) print(f\u0026#34;é—®é¢˜ï¼š{question}\\nå›ç­”ï¼š{answer}\\nç»“æœï¼š{result}\\n\u0026#34;) # # 2. æŸ¥è¯¢ç›¸ä¼¼é—®é¢˜ print(\u0026#34;\\n2. æŸ¥è¯¢ç›¸ä¼¼é—®é¢˜ç¤ºä¾‹\u0026#34;) test_queries = [ \u0026#34;æˆ‘è¦é€€æ¬¾æ€ä¹ˆæ“ä½œ\u0026#34;, # \u0026#34;è®¢å•åœ°å€å†™é”™äº†æ€ä¹ˆæ”¹\u0026#34;, # \u0026#34;å‡ ç‚¹å‘è´§\u0026#34; ] # for query in test_queries: query_text, matched_question, matched_answer = chroma_client.query_similar(query) print(f\u0026#34;\\nç”¨æˆ·é—®é¢˜ï¼š{query_text}\u0026#34;) if matched_question and matched_answer: print(f\u0026#34;åŒ¹é…é—®é¢˜ï¼š{matched_question}\u0026#34;) print(f\u0026#34;åŒ¹é…ç­”æ¡ˆï¼š{matched_answer}\u0026#34;) else: print(\u0026#34;æœªæ‰¾åˆ°åŒ¹é…çš„é—®ç­”å¯¹\u0026#34;) # # 3. åˆ é™¤ç¤ºä¾‹ print(\u0026#34;\\n3. åˆ é™¤ç¤ºä¾‹\u0026#34;) # è·å–ç¬¬ä¸€ä¸ªé—®é¢˜çš„hashå€¼ import hashlib question_to_delete = qa_pairs[0][0] qhash = hashlib.md5(question_to_delete.encode(\u0026#39;utf-8\u0026#39;)).hexdigest() # åˆ é™¤å‰æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ print(\u0026#34;åˆ é™¤å‰ç»Ÿè®¡ï¼š\u0026#34;, chroma_client.get_collection_stats()) # æ‰§è¡Œåˆ é™¤ result = chroma_client.delete_vectors(qhash) print(f\u0026#34;åˆ é™¤é—®é¢˜ï¼š{question_to_delete}\u0026#34;) print(f\u0026#34;åˆ é™¤ç»“æœï¼š{result}\u0026#34;) # åˆ é™¤åæŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ print(\u0026#34;åˆ é™¤åç»Ÿè®¡ï¼š\u0026#34;, chroma_client.get_collection_stats()) if __name__ == \u0026#34;__main__\u0026#34;: demo_chroma_operations() åŸºæœ¬æ“ä½œç¤ºä¾‹ 1. æ’å…¥/æ›´æ–°å‘é‡æ•°æ® 1 2 3 4 # æ’å…¥é—®ç­”å¯¹ question = \u0026#34;å¦‚ä½•ç”³è¯·é€€æ¬¾ï¼Ÿ\u0026#34; answer = \u0026#34;æ‚¨å¯ä»¥åœ¨è®¢å•è¯¦æƒ…é¡µé¢ç‚¹å‡»\u0026#39;ç”³è¯·é€€æ¬¾\u0026#39;æŒ‰é’®ï¼Œå¡«å†™é€€æ¬¾åŸå› åæäº¤ç”³è¯·ã€‚\u0026#34; result = chroma_client.upsert_vectors(question, answer) 2. æŸ¥è¯¢ç›¸ä¼¼é—®é¢˜ 1 2 3 4 5 6 7 # æŸ¥è¯¢ç›¸ä¼¼é—®é¢˜ query_text = \u0026#34;æˆ‘è¦é€€æ¬¾æ€ä¹ˆæ“ä½œ\u0026#34; query_text, matched_question, matched_answer = chroma_client.query_similar(query_text) if matched_question and matched_answer: print(f\u0026#34;åŒ¹é…é—®é¢˜ï¼š{matched_question}\u0026#34;) print(f\u0026#34;åŒ¹é…ç­”æ¡ˆï¼š{matched_answer}\u0026#34;) 3. åˆ é™¤å‘é‡æ•°æ® 1 2 3 4 5 6 7 8 9 10 # åˆ é™¤æŒ‡å®šé—®é¢˜çš„å‘é‡æ•°æ® chroma_client = get_chroma_client() status = chroma_client.get_collection_stats() log.info(f\u0026#34;åˆ é™¤å‰ChromaDBçŠ¶æ€: {status}\u0026#34;) question = \u0026#34;å¦‚ä½•ç”³è¯·é€€æ¬¾ï¼Ÿ\u0026#34; qhash = hashlib.md5(question.encode(\u0026#39;utf-8\u0026#39;)).hexdigest() result = chroma_client.delete_vectors(qhash) log.info(f\u0026#34;åˆ é™¤é—®é¢˜ï¼š{question},ç»“æœï¼š{result}\u0026#34;) status = chroma_client.get_collection_stats() log.info(f\u0026#34;åˆ é™¤åChromaDBçŠ¶æ€: {status}\u0026#34;) å®é™…åº”ç”¨åœºæ™¯ åœ¨å®¢æœç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªå‘é‡åº“çš„åº”ç”¨æµç¨‹å¤§è‡´ä¸ºï¼š\nç®¡ç†å‘˜é¢„å…ˆå½•å…¥å¸¸è§é—®é¢˜å’Œæ ‡å‡†ç­”æ¡ˆ ç³»ç»Ÿå°†é—®é¢˜è½¬æ¢ä¸ºå‘é‡å¹¶å­˜å‚¨åœ¨ChromaDBä¸­ ç”¨æˆ·æé—®æ—¶ï¼Œç³»ç»Ÿå°†é—®é¢˜è½¬æ¢ä¸ºå‘é‡ ä½¿ç”¨ query_similar æ–¹æ³•åœ¨å‘é‡åº“ä¸­æŸ¥æ‰¾è¯­ä¹‰æœ€ç›¸ä¼¼çš„é—®é¢˜ å¦‚æœæ‰¾åˆ°ç›¸ä¼¼åº¦è¶³å¤Ÿé«˜çš„åŒ¹é…ï¼ˆè·ç¦»å°äº0.4ï¼‰ï¼Œè¿”å›å¯¹åº”çš„æ ‡å‡†ç­”æ¡ˆ åœ¨æŠŠç­”æ¡ˆ é€šè¿‡çº¦æŸçš„Prompt ç»™ChatGPT å›ç­” ChatGPTè¿”å›æ›´å®Œæ•´çš„ç­”æ¡ˆï¼Œå‘é€ç»™ç”¨æˆ· è¿™ç§åŸºäºå‘é‡çš„åŒ¹é…æ–¹å¼æ¯”ä¼ ç»Ÿçš„å…³é”®è¯åŒ¹é…æ›´æ™ºèƒ½ï¼Œèƒ½å¤Ÿç†è§£é—®é¢˜çš„è¯­ä¹‰è€Œéä»…ä»…æ˜¯å­—é¢è¡¨è¾¾ï¼Œå¤§å¤§æé«˜äº†è‡ªåŠ¨é—®ç­”ç³»ç»Ÿçš„å‡†ç¡®æ€§å’Œç”¨æˆ·ä½“éªŒã€‚ æ³¨æ„äº‹é¡¹ å‘é‡ç›¸ä¼¼åº¦é˜ˆå€¼è®¾ç½®ï¼š\nå½“å‰ç¤ºä¾‹ä¸­ç›¸ä¼¼åº¦é˜ˆå€¼è®¾ç½®ä¸º 0.4ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ é˜ˆå€¼è¶Šå°ï¼ŒåŒ¹é…è¦æ±‚è¶Šä¸¥æ ¼ æŒä¹…åŒ–å­˜å‚¨ï¼š\nChromaDB é»˜è®¤å°†æ•°æ®å­˜å‚¨åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ chroma_db æ–‡ä»¶å¤¹ä¸­ å¯ä»¥é€šè¿‡ persist_directory å‚æ•°è‡ªå®šä¹‰å­˜å‚¨è·¯å¾„ é”™è¯¯å¤„ç†ï¼š\nç¤ºä¾‹ä»£ç ä¸­åŒ…å«äº†åŸºæœ¬çš„é”™è¯¯å¤„ç†æœºåˆ¶ å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ·»åŠ æ›´å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ å‚è€ƒæ–‡æ¡£ï¼š https://zhuanlan.zhihu.com/p/658217843 https://www.cnblogs.com/rude3knife/p/chroma_tutorial.html\n","date":"2025-04-29T09:01:10Z","image":"https://www.ownit.top/title_pic/76.jpg","permalink":"https://www.ownit.top/p/202504290901/","title":"Chromaå‘é‡æ£€ç´¢å®æˆ˜ï¼šæ‰“é€ æ™ºèƒ½å®¢æœçš„â€œæœ€å¼ºå¤§è„‘â€"},{"content":"èƒŒæ™¯ åœ¨æŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²çš„æµç¨‹ä¸­ï¼Œé¢‘ç¹çš„æ„å»ºå’Œéƒ¨ç½²ä¼šç”Ÿæˆå¤§é‡çš„é•œåƒç‰ˆæœ¬ã€‚è¿™äº›å†å²é•œåƒå¦‚æœä¸åŠæ—¶æ¸…ç†ï¼Œä¼šå ç”¨å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œå¯¼è‡´ Harbor ä»“åº“è†¨èƒ€ï¼Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚ ç›®å‰ å…¬å¸çš„Harborå­˜å‚¨å·²ç»å ç”¨1Tï¼Œå¥½å¤šçš„repoçš„é•œåƒtagè¾¾åˆ°ä¸Šç™¾å¤šï¼Œæ²¡æœ‰æ¸…ç†ååˆ†å ç”¨ç©ºé—´ã€‚ ç›®å‰ç ”ç©¶äº†ä¸‹ï¼Œå¯é‡‡å–ä¸¤ç§æ–¹æ¡ˆè¿›è¡Œæ¸…ç†ã€‚ï¼ˆå„è‡ªæœ‰å„çš„ä¼˜åŠ¿ï¼‰ 1ã€é‡‡ç”¨Harborè‡ªå¸¦çš„æ¸…ç†ç­–ç•¥ 2ã€å†™è„šæœ¬ï¼Œå¯ä»¥è‡ªå®šä¹‰æ§åˆ¶æ¸…ç†ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚\nç›®çš„ é‡Šæ”¾å­˜å‚¨ç©ºé—´ï¼šâ€‹æ¸…ç†ä¸å†ä½¿ç”¨çš„é•œåƒï¼Œé‡Šæ”¾è¢«å ç”¨çš„ç£ç›˜ç©ºé—´ã€‚\næé«˜ç³»ç»Ÿæ€§èƒ½ï¼šâ€‹å‡å°‘æ— ç”¨æ•°æ®ï¼Œæé«˜ Harbor çš„å“åº”é€Ÿåº¦å’Œç¨³å®šæ€§ã€‚\nç®€åŒ–ç®¡ç†ï¼šâ€‹é€šè¿‡è‡ªåŠ¨åŒ–ç­–ç•¥ï¼Œå‡å°‘æ‰‹åŠ¨æ¸…ç†çš„å·¥ä½œé‡ï¼Œæé«˜ç®¡ç†æ•ˆç‡ã€‚\næ–¹æ¡ˆä¸€ Harbor é•œåƒè‡ªåŠ¨æ¸…ç†ç­–ç•¥ Harbor æä¾›äº†åŸºäºé¡¹ç›®çš„é•œåƒä¿ç•™ç­–ç•¥ï¼ˆRetention Policyï¼‰ï¼Œå…è®¸ç”¨æˆ·æ ¹æ®ç‰¹å®šçš„è§„åˆ™è‡ªåŠ¨ä¿ç•™æˆ–åˆ é™¤é•œåƒã€‚è¯¥ç­–ç•¥æ”¯æŒä»¥ä¸‹é…ç½®ï¼šï¼ˆéœ€è¦æ¯ä¸ªä»“åº“åˆ†åˆ«é…ç½®ï¼‰\nåŒ¹é…è§„åˆ™ï¼šé€šè¿‡é€šé…ç¬¦åŒ¹é…ç‰¹å®šçš„ä»“åº“æˆ–é•œåƒã€‚ ä¿ç•™ç­–ç•¥ï¼šè®¾ç½®ä¿ç•™æœ€è¿‘æ¨é€æˆ–æ‹‰å–çš„é•œåƒæ•°é‡æˆ–æ—¶é—´èŒƒå›´ã€‚ æ ‡ç­¾è¿‡æ»¤ï¼šæ ¹æ®é•œåƒçš„æ ‡ç­¾ï¼ˆTagï¼‰è¿›è¡Œç­›é€‰ï¼Œå¦‚ä¿ç•™ç‰¹å®šå‰ç¼€çš„æ ‡ç­¾ã€‚ åˆ é™¤æœªæ‰“æ ‡ç­¾çš„é•œåƒï¼šé€‰æ‹©æ˜¯å¦åˆ é™¤æœªæ‰“æ ‡ç­¾çš„é•œåƒï¼ˆUntagged Artifactsï¼‰ã€‚ 1ã€ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½• Harbor çš„ Web æ§åˆ¶å°ã€‚ 2ã€åœ¨å·¦ä¾§å¯¼èˆªæ é€‰æ‹©â€œé¡¹ç›®â€ï¼Œç‚¹å‡»éœ€è¦é…ç½®æ¸…ç†ç­–ç•¥çš„é¡¹ç›®åç§°ã€‚ 3ã€é…ç½®ä¿ç•™ç­–ç•¥\nåœ¨é¡¹ç›®é¡µé¢ï¼Œé€‰æ‹©â€œç­–ç•¥â€é€‰é¡¹å¡ï¼Œç‚¹å‡»â€œæ·»åŠ è§„åˆ™â€æŒ‰é’®ï¼Œè¿›è¡Œä»¥ä¸‹é…ç½®ï¼š\nè§„åˆ™åç§°ï¼šä¸ºç­–ç•¥å‘½åï¼Œä¾¿äºè¯†åˆ«ã€‚ åŒ¹é…ä»“åº“ï¼šä½¿ç”¨é€šé…ç¬¦ï¼ˆå¦‚ **ï¼‰åŒ¹é…éœ€è¦åº”ç”¨ç­–ç•¥çš„ä»“åº“ã€‚ ä¿ç•™ç­–ç•¥ï¼šé€‰æ‹©ä¿ç•™æœ€è¿‘æ¨é€æˆ–æ‹‰å–çš„é•œåƒæ•°é‡æˆ–æ—¶é—´èŒƒå›´ã€‚ æ ‡ç­¾è¿‡æ»¤ï¼šè®¾ç½®æ ‡ç­¾åŒ¹é…è§„åˆ™ï¼Œå¦‚ä¿ç•™ä»¥ release- å¼€å¤´çš„æ ‡ç­¾ã€‚ åˆ é™¤æœªæ‰“æ ‡ç­¾çš„é•œåƒï¼šæ ¹æ®éœ€è¦é€‰æ‹©æ˜¯å¦åˆ é™¤æœªæ‰“æ ‡ç­¾çš„é•œåƒã€‚ 4ã€è®¾ç½®å®šæ—¶ä»»åŠ¡ åœ¨ç­–ç•¥é¡µé¢ï¼Œç‚¹å‡»â€œç¼–è¾‘â€æŒ‰é’®ï¼Œé…ç½®ç­–ç•¥çš„æ‰§è¡Œæ—¶é—´ã€‚Harbor ä½¿ç”¨ UTC æ—¶é—´ï¼Œéœ€æ³¨æ„ä¸æœ¬åœ°æ—¶é—´çš„å·®å¼‚ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®æ¯å‘¨å…­å‡Œæ™¨ 0 ç‚¹æ‰§è¡Œï¼š\n1 0 0 0 ? * SAT è¿™è¡¨ç¤ºæ¯å‘¨å…­ UTC æ—¶é—´ 0 ç‚¹æ‰§è¡Œï¼Œè‹¥åœ¨ä¸­å›½æ—¶åŒºï¼Œå®é™…æ‰§è¡Œæ—¶é—´ä¸ºå‘¨å…­ä¸Šåˆ 8 ç‚¹ã€‚ 5ã€æ‰‹åŠ¨æ‰§è¡Œç­–ç•¥ï¼ˆå¯é€‰ï¼‰ åœ¨ç­–ç•¥é¡µé¢ï¼Œç‚¹å‡»â€œç«‹å³æ‰§è¡Œâ€æŒ‰é’®ï¼Œå¯ä»¥æ‰‹åŠ¨è§¦å‘ç­–ç•¥ï¼Œç«‹å³æ¸…ç†ç¬¦åˆæ¡ä»¶çš„é•œåƒã€‚ æ–¹æ¡ˆäºŒ ä½¿ç”¨Shellè„šæœ¬å¤„ç† harbor_clean.sh\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 #!/bin/bash #/********************************************************** # * Author : å—å®«ä¹˜é£ # * Email : 1794748404@qq.com # * Last modified : 2024-01-17 10:00 # * Filename : harbor_clean.sh # * Description : æ¸…ç†æŒ‡å®šHarboré¡¹ç›®çš„é•œåƒï¼Œåªä¿ç•™æœ€è¿‘5æ¬¡ # * *******************************************************/ set -e # æ—¥å¿—æ–‡ä»¶é…ç½® LOG_FILE=\u0026#34;./harbor_clean.log\u0026#34; user=$(whoami) # Harboré…ç½®(è¯·é…ç½®è´¦å·å’Œå¯†ç ) HARBOR_URL=\u0026#34;bdata-hub.xxxxx.cn\u0026#34; HARBOR_USERNAME=\u0026#34;admin\u0026#34; HARBOR_PASSWORD=\u0026#34;xxxxxxxxx\u0026#34; KEEP_NUM=15 # ä¿ç•™æœ€è¿‘çš„5ä¸ªé•œåƒ # æŒ‡å®šè¦æ¸…ç†çš„é¡¹ç›®åˆ—è¡¨ PROJECTS=(\u0026#34;service\u0026#34; \u0026#34;pre\u0026#34;) # åˆ›å»ºä¸´æ—¶ç›®å½• TMP_DIR=\u0026#34;$PWD/harbor_clean_tmp\u0026#34; # æ—¥å¿—å‡½æ•° function log_info() { content=\u0026#34;[INFO] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $0 $user msg : $@\u0026#34; echo $content \u0026gt;\u0026gt;$LOG_FILE echo -e \u0026#34;\\033[32m${content}\\033[0m\u0026#34; } function log_warn() { content=\u0026#34;[WARN] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $0 $user msg : $@\u0026#34; echo $content \u0026gt;\u0026gt;$LOG_FILE echo -e \u0026#34;\\033[33m${content}\\033[0m\u0026#34; } function log_err() { content=\u0026#34;[ERROR] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $0 $user msg : $@\u0026#34; echo $content \u0026gt;\u0026gt;$LOG_FILE echo -e \u0026#34;\\033[31m${content}\\033[0m\u0026#34; } # è·å–æŒ‡å®šé¡¹ç›®çš„ä»“åº“åˆ—è¡¨ function get_repos_list() { local project=$1 log_info \u0026#34;è·å–é¡¹ç›® ${project} çš„ä»“åº“åˆ—è¡¨\u0026#34; mkdir -p \u0026#34;$TMP_DIR/repos\u0026#34; local repos_list=$(curl -s -k -u \u0026#34;${HARBOR_USERNAME}:${HARBOR_PASSWORD}\u0026#34; \\ \u0026#34;https://${HARBOR_URL}/api/v2.0/projects/${project}/repositories?page=1\u0026amp;page_size=100\u0026#34;) if [ $? -ne 0 ]; then log_err \u0026#34;è·å–é¡¹ç›® ${project} çš„ä»“åº“åˆ—è¡¨å¤±è´¥\u0026#34; return 1 fi echo \u0026#34;${repos_list}\u0026#34; | jq \u0026#39;.[]\u0026#39; | jq -r \u0026#39;.name\u0026#39; | awk -F \u0026#34;/\u0026#34; \u0026#39;{print $2}\u0026#39; \u0026gt;\u0026#34;$TMP_DIR/repos/${project}.txt\u0026#34; log_info \u0026#34;æˆåŠŸè·å–é¡¹ç›® ${project} çš„ä»“åº“åˆ—è¡¨\u0026#34; } # è·å–é•œåƒæ ‡ç­¾åˆ—è¡¨ function get_tag_list() { local project=$1 local repo=$2 log_info \u0026#34;è·å–ä»“åº“ ${project}/${repo} çš„æ ‡ç­¾åˆ—è¡¨\u0026#34; mkdir -p \u0026#34;$TMP_DIR/tags/$project/$repo\u0026#34; local artifacts=$(curl -s -k -u \u0026#34;${HARBOR_USERNAME}:${HARBOR_PASSWORD}\u0026#34; \\ \u0026#34;https://${HARBOR_URL}/api/v2.0/projects/${project}/repositories/${repo}/artifacts?page=1\u0026amp;page_size=100\u0026amp;with_tag=true\u0026amp;with_label=false\u0026amp;with_scan_overview=false\u0026amp;with_signature=false\u0026amp;with_immutable_status=false\u0026#34;) if [ $? -ne 0 ]; then log_err \u0026#34;è·å–ä»“åº“ ${project}/${repo} çš„æ ‡ç­¾åˆ—è¡¨å¤±è´¥\u0026#34; return 1 fi echo \u0026#34;${artifacts}\u0026#34; | jq \u0026#39;.[]\u0026#39; | jq -r \u0026#39;.digest\u0026#39; \u0026gt;\u0026#34;$TMP_DIR/tags/$project/$repo/digests.txt\u0026#34; log_info \u0026#34;æˆåŠŸè·å–ä»“åº“ ${project}/${repo} çš„æ ‡ç­¾åˆ—è¡¨\u0026#34; } # åˆ é™¤æ—§é•œåƒ function delete_images() { local project=$1 local repo=$2 local digest_file=\u0026#34;$TMP_DIR/tags/$project/$repo/digests.txt\u0026#34; if [ ! -f \u0026#34;$digest_file\u0026#34; ]; then log_warn \u0026#34;ä»“åº“ ${project}/${repo} çš„æ ‡ç­¾æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡\u0026#34; return fi local total_num=$(wc -l \u0026lt;\u0026#34;$digest_file\u0026#34;) if [ $total_num -gt $KEEP_NUM ]; then local delete_num=$((total_num - KEEP_NUM)) log_info \u0026#34;ä»“åº“ ${project}/${repo} æœ‰ ${delete_num} ä¸ªé•œåƒéœ€è¦åˆ é™¤\u0026#34; tail -n $delete_num \u0026#34;$digest_file\u0026#34; | while read digest; do log_info \u0026#34;å‡†å¤‡åˆ é™¤é•œåƒ: ${project}/${repo}@${digest}\u0026#34; curl -X DELETE -s -k -u \u0026#34;${HARBOR_USERNAME}:${HARBOR_PASSWORD}\u0026#34; \\ \u0026#34;https://${HARBOR_URL}/api/v2.0/projects/${project}/repositories/${repo}/artifacts/${digest}\u0026#34; if [ $? -eq 0 ]; then log_info \u0026#34;æˆåŠŸåˆ é™¤é•œåƒ: ${project}/${repo}@${digest}\u0026#34; else log_err \u0026#34;åˆ é™¤é•œåƒå¤±è´¥: ${project}/${repo}@${digest}\u0026#34; fi done log_info \u0026#34;ä»“åº“ ${project}/${repo} çš„é•œåƒæ¸…ç†å®Œæˆ\u0026#34; else log_info \u0026#34;ä»“åº“ ${project}/${repo} çš„é•œåƒæ•°é‡æœªè¶…è¿‡ä¿ç•™é™åˆ¶ï¼Œè·³è¿‡æ¸…ç†\u0026#34; fi } # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ function cleanup() { log_info \u0026#34;æ¸…ç†ä¸´æ—¶æ–‡ä»¶\u0026#34; rm -rf \u0026#34;$TMP_DIR\u0026#34; } # ä¸»å‡½æ•° function main() { log_info \u0026#34;å¼€å§‹æ‰§è¡ŒHarboré•œåƒæ¸…ç†è„šæœ¬\u0026#34; mkdir -p \u0026#34;$TMP_DIR\u0026#34; trap cleanup EXIT # éå†æŒ‡å®šçš„é¡¹ç›®åˆ—è¡¨ for project in \u0026#34;${PROJECTS[@]}\u0026#34;; do log_info \u0026#34;å¼€å§‹å¤„ç†é¡¹ç›®: ${project}\u0026#34; get_repos_list \u0026#34;$project\u0026#34; if [ -f \u0026#34;$TMP_DIR/repos/${project}.txt\u0026#34; ]; then while read repo; do get_tag_list \u0026#34;$project\u0026#34; \u0026#34;$repo\u0026#34; delete_images \u0026#34;$project\u0026#34; \u0026#34;$repo\u0026#34; done \u0026lt;\u0026#34;$TMP_DIR/repos/${project}.txt\u0026#34; else log_warn \u0026#34;é¡¹ç›® ${project} çš„ä»“åº“åˆ—è¡¨æ–‡ä»¶ä¸å­˜åœ¨\u0026#34; fi done log_info \u0026#34;Harboré•œåƒæ¸…ç†è„šæœ¬æ‰§è¡Œå®Œæˆ\u0026#34; } # æ‰§è¡Œä¸»å‡½æ•° main 1 2 3 #å®šæ—¶ä»»åŠ¡ crontab -e /bin/bash /root/shell/harbor_clean.sh è¿è¡Œæ—¥å¿—ï¼š åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰ -é…ç½®å¹¶æ‰§è¡Œé•œåƒæ¸…ç†ç­–ç•¥åï¼Œé•œåƒçš„å…ƒæ•°æ®ä¼šè¢«åˆ é™¤ï¼Œä½†å®é™…çš„å­˜å‚¨ç©ºé—´ä¸ä¼šç«‹å³é‡Šæ”¾ã€‚ä¸ºå½»åº•é‡Šæ”¾ç©ºé—´ï¼Œéœ€è¦æ‰§è¡Œåƒåœ¾å›æ”¶æ“ä½œã€‚\næ‰§è¡Œæ­¥éª¤\nåœ¨å·¦ä¾§å¯¼èˆªæ é€‰æ‹©â€œç³»ç»Ÿç®¡ç†â€ \u0026gt; â€œåƒåœ¾æ¸…ç†â€ã€‚ ç‚¹å‡»â€œç«‹å³æ¸…ç†â€æŒ‰é’®ï¼Œæ‰§è¡Œåƒåœ¾å›æ”¶æ“ä½œã€‚ åœ¨â€œå†å²è®°å½•â€ä¸­æŸ¥çœ‹åƒåœ¾å›æ”¶çš„æ‰§è¡Œæƒ…å†µå’Œé‡Šæ”¾çš„ç©ºé—´å¤§å°ã€‚ åƒåœ¾å›æ”¶æ“ä½œå¯ä»¥é…ç½®ä¸ºå®šæ—¶æ‰§è¡Œï¼Œç¡®ä¿ç³»ç»Ÿå®šæœŸé‡Šæ”¾æ— ç”¨çš„å­˜å‚¨ç©ºé—´ã€‚ æ³¨æ„äº‹é¡¹ ç­–ç•¥ä¼˜å…ˆçº§ï¼šå¤šä¸ªç­–ç•¥å¯èƒ½å­˜åœ¨å†²çªï¼ŒHarbor æŒ‰ç…§ç­–ç•¥çš„åˆ›å»ºé¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œå»ºè®®åˆç†è§„åˆ’ç­–ç•¥çš„ä¼˜å…ˆçº§ã€‚\næ ‡ç­¾ç®¡ç†ï¼šåˆç†ä½¿ç”¨æ ‡ç­¾ï¼ˆTagï¼‰å‘½åè§„èŒƒï¼Œæœ‰åŠ©äºç­–ç•¥çš„ç²¾ç¡®åŒ¹é…å’Œç®¡ç†ã€‚\næµ‹è¯•ç­–ç•¥ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒåº”ç”¨ç­–ç•¥å‰ï¼Œå»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ç­–ç•¥çš„æ•ˆæœï¼Œé¿å…è¯¯åˆ é‡è¦é•œåƒã€‚\nå¤‡ä»½æ•°æ®ï¼šæ‰§è¡Œæ¸…ç†æ“ä½œå‰ï¼Œå»ºè®®å¤‡ä»½é‡è¦æ•°æ®ï¼Œä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚\n","date":"2025-04-27T22:48:25Z","image":"https://www.ownit.top/title_pic/46.jpg","permalink":"https://www.ownit.top/p/202504272248/","title":"Harbor2.0ä»“åº“é•œåƒæ¸…ç†ç­–ç•¥"},{"content":"MCPç®€ä»‹ Model Context Protocol (MCP) æ˜¯ä¸€ä¸ªä¸“é—¨ä¸º LLMï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰åº”ç”¨è®¾è®¡çš„åè®®ï¼Œå®ƒå…è®¸ä½ æ„å»ºæœåŠ¡å™¨ä»¥å®‰å…¨ã€æ ‡å‡†åŒ–çš„æ–¹å¼å‘ LLM åº”ç”¨ç¨‹åºå…¬å¼€æ•°æ®å’ŒåŠŸèƒ½ã€‚FastMCP ä½œä¸º Python ç”Ÿæ€ä¸­çš„ä¸€æ¬¾è½»é‡çº§æ¡†æ¶ï¼Œåˆ©ç”¨è£…é¥°å™¨æ¥ç®€åŒ–è·¯ç”±ä¸å·¥å…·å‡½æ•°çš„å¼€å‘ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿæ„å»ºé¢å‘å·¥å…·çš„æœåŠ¡ç«¯åº”ç”¨ã€‚ MCP Server æä¾›äº† 3 ç§æ ¸å¿ƒåŸè¯­ï¼Œæ¯ç§åŸè¯­éƒ½æœ‰å…¶ç‰¹å®šçš„ç”¨é€”å’Œç‰¹ç‚¹ï¼š\n1. Toolï¼ˆå·¥å…·ï¼‰ï¼š\nTool å…è®¸æœåŠ¡å™¨å…¬å¼€å¯æ‰§è¡Œçš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯ç”±å®¢æˆ·ç«¯è°ƒç”¨å¹¶ç”± LLM ä½¿ç”¨æ¥æ‰§è¡Œæ“ä½œã€‚Tool ä¸ä»…äººè®© LLM èƒ½ä»å¤–éƒ¨è·å–ä¿¡æ¯ï¼Œè¿˜èƒ½æ‰§è¡Œå†™å…¥æˆ–æ“ä½œï¼Œä¸º LLM æä¾›çœŸæ­£çš„è¡ŒåŠ¨åŠ›ã€‚ æ¨¡å‹æ§åˆ¶ï¼šTool ç›´æ¥æš´éœ²ç»™ LLM å¯æ‰§è¡Œå‡½æ•°ï¼Œè®©æ¨¡å‹å¯ä»¥ä¸»åŠ¨è°ƒç”¨ã€‚ 2. Resourceï¼ˆèµ„æºï¼‰ï¼š\nResource è¡¨ç¤ºæœåŠ¡å™¨å¸Œæœ›æä¾›ç»™å®¢æˆ·ç«¯çš„ä»»ä½•ç±»å‹çš„åªè¯»æ•°æ®ã€‚è¿™å¯èƒ½åŒ…æ‹¬ï¼šæ–‡ä»¶å†…å®¹ã€æ•°æ®åº“è®°å½•ã€å›¾ç‰‡ã€æ—¥å¿—ç­‰ç­‰ã€‚ åº”ç”¨æ§åˆ¶ï¼šResource ç”±å®¢æˆ·ç«¯æˆ–åº”ç”¨ç®¡ç†ï¼Œç”¨äºä¸º LLM æä¾›ä¸Šä¸‹æ–‡å†…å®¹ã€‚ 3. Promptï¼ˆæç¤ºæ¨¡æ¿ï¼‰ ï¼š\nPrompt æ˜¯ç”±æœåŠ¡å™¨å®šä¹‰çš„å¯é‡ç”¨çš„æ¨¡æ¿ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©è¿™äº›æ¨¡æ¿æ¥å¼•å¯¼æˆ–æ ‡å‡†åŒ–ä¸ LLM çš„äº¤äº’è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼ŒGit MCP Server å¯ä»¥æä¾›ä¸€ä¸ªâ€œç”Ÿæˆæäº¤ä¿¡æ¯â€çš„æç¤ºæ¨¡æ¿ï¼Œç”¨æˆ·å¯ä»¥ç”¨å®ƒæ¥åˆ›å»ºæ ‡å‡†åŒ–çš„æäº¤æ¶ˆæ¯ã€‚ ç”¨æˆ·æ§åˆ¶ï¼šPrompt é€šå¸¸ç”±ç”¨æˆ·è‡ªè¡Œé€‰æ‹©ã€‚ MCPæ¦‚è¿° MCPæœåŠ¡ç«¯å½“å‰æ”¯æŒä¸¤ç§ä¸å®¢æˆ·ç«¯çš„æ•°æ®é€šä¿¡æ–¹å¼ï¼šæ ‡å‡†è¾“å…¥è¾“å‡º(stdio) å’Œ åŸºäºHttpçš„æœåŠ¡å™¨æ¨é€äº‹ä»¶(http sse)\næ ‡å‡†è¾“å…¥è¾“å‡º(stdio) åŸç†ï¼š æ ‡å‡†è¾“å…¥è¾“å‡ºæ˜¯ä¸€ç§ç”¨äºæœ¬åœ°é€šä¿¡çš„ä¼ è¾“æ–¹å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒMCP å®¢æˆ·ç«¯ä¼šå°†æœåŠ¡å™¨ç¨‹åºä½œä¸ºå­è¿›ç¨‹å¯åŠ¨ï¼ŒåŒæ–¹é€šè¿‡çº¦å®šçš„æ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡ºï¼ˆå¯èƒ½æ˜¯é€šè¿‡å…±äº«æ–‡ä»¶ç­‰æ–¹æ³•ï¼‰è¿›è¡Œæ•°æ®äº¤æ¢ã€‚å…·ä½“è€Œè¨€ï¼Œå®¢æˆ·ç«¯é€šè¿‡æ ‡å‡†è¾“å…¥å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨é€šè¿‡æ ‡å‡†è¾“å‡ºè¿”å›å“åº”ã€‚ é€‚ç”¨åœºæ™¯ï¼š æ ‡å‡†è¾“å…¥è¾“å‡ºæ–¹å¼é€‚ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œçš„åœºæ™¯ï¼ˆæœ¬åœ°è‡ªè¡Œç¼–å†™æœåŠ¡ç«¯æˆ–å°†åˆ«äººç¼–å†™çš„æœåŠ¡ç«¯ä»£ç pullåˆ°æœ¬åœ°æ‰§è¡Œï¼‰ï¼Œç¡®ä¿äº†é«˜æ•ˆã€ä½å»¶è¿Ÿçš„é€šä¿¡ã€‚è¿™ç§ç›´æ¥çš„æ•°æ®ä¼ è¾“æ–¹å¼å‡å°‘äº†ç½‘ç»œå»¶è¿Ÿå’Œä¼ è¾“å¼€é”€ï¼Œé€‚åˆéœ€è¦å¿«é€Ÿå“åº”çš„æœ¬åœ°åº”ç”¨ã€‚\nåŸºäºHttpçš„æœåŠ¡å™¨æ¨é€äº‹ä»¶(http sse) åŸç†: å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šè¿‡ HTTP åè®®è¿›è¡Œé€šä¿¡ï¼Œåˆ©ç”¨ SSE å®ç°æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯çš„å®æ—¶æ•°æ®æ¨é€ï¼ŒæœåŠ¡ç«¯å®šä¹‰äº†/seeä¸/messagesæ¥å£ç”¨äºæ¨é€ä¸æ¥æ”¶æ•°æ®ã€‚è¿™é‡Œè¦æ³¨æ„SSEåè®®å’ŒWebSocketåè®®çš„åŒºåˆ«ï¼ŒSSEåè®®æ˜¯å•å‘çš„ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹è¿æ¥åï¼Œåªèƒ½ç”±æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯æ¨é€ã€‚è€ŒWebSocketåè®®å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹è¿æ¥åï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡sendå‘æœåŠ¡ç«¯å‘é€æ•°æ®ï¼Œå¹¶é€šè¿‡onmessageäº‹ä»¶æ¥æ”¶æœåŠ¡ç«¯ä¼ è¿‡æ¥çš„æ•°æ®ã€‚\né€‚ç”¨åœºæ™¯ï¼š é€‚ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½äºä¸åŒç‰©ç†ä½ç½®çš„åœºæ™¯ï¼Œå°¤å…¶æ˜¯å¯¹äºåˆ†å¸ƒå¼æˆ–è¿œç¨‹éƒ¨ç½²çš„åœºæ™¯ï¼ŒåŸºäº HTTP å’Œ SSE çš„ä¼ è¾“æ–¹å¼æ›´åˆé€‚ã€‚å¦‚ï¼šPrometheusï¼ŒMySQLï¼ŒMongoDB æ•°æ®åº“ç­‰ç­‰\nç¯å¢ƒä»‹ç» uvå¿«é€Ÿæ„å»ºPythonç¯å¢ƒ Winæ‰“å¼€ powershell è¿›è¡Œå®‰è£… å‚è€ƒæ–‡æ¡£ï¼šhttps://docs.astral.sh/uv/getting-started/installation/#standalone-installer\n1 2 3 4 5 6 7 8 # On macOS and Linux. curl -LsSf https://astral.sh/uv/install.sh | sh # On Windows. powershell -ExecutionPolicy ByPass -c \u0026#34;irm https://astral.sh/uv/install.ps1 | iex\u0026#34; # With pip. pip install uv å®‰è£…ä¹‹åï¼Œå¯ä»¥é€šè¿‡uv helpå‘½ä»¤æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼š å¸è½½\n1 powershell -c \u0026#34;irm https://astral.sh/uv/install.ps1 | more\u0026#34; åŸºæœ¬ä½¿ç”¨æ–¹æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹ã€åŒæ—¶åˆå§‹åŒ–å¹¶æŒ‡å®špythonç‰ˆæœ¬ uv init py-app -p 3.11.9 # åˆ›å»ºå¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ uv venv source .venv/bin/activate # é€€å‡ºè™šæ‹Ÿç¯å¢ƒ deactivate uv venv --seed # å¼ºåˆ¶å®‰è£…åŸºç¡€åŒ…ï¼ˆå¦‚pip, setuptools, wheelï¼‰ # åŒæ­¥ä¾èµ– uv sync # å®‰è£… requirements.txt uv pip install -r requirements.txt # å®‰è£…åŒ…ï¼ˆä½¿ç”¨æ¸…åæºï¼‰ cd py-app uv add pandas pillow --default-index \u0026#34;https://pypi.tuna.tsinghua.edu.cn/simple\u0026#34; # å®‰è£…CUDAç‰ˆçš„torchï¼ˆä½¿ç”¨å—äº¬å¤§å­¦æºï¼‰ uv pip install torch torchvision torchaudio --index-url https://mirror.nju.edu.cn/pytorch/whl/cu126 # æ‰§è¡Œpython uv run app.py Pythonç‰ˆæœ¬çš„å®‰è£…å’Œç®¡ç†\n1 2 3 4 5 6 7 8 # æ˜¾ç¤ºå½“å‰å·²ç»å®‰è£…çš„å’Œå¯ä¾›å®‰è£…çš„Pythonç‰ˆæœ¬ uv python list # å®‰è£…æŒ‡å®šçš„Pythonç‰ˆæœ¬ï¼ˆæ³¨æ„ï¼šå®‰è£…çš„Pythonå¹¶éå…¨å±€å¯ç”¨ï¼Œåœ¨å‘½ä»¤è¡Œå·¥å…·ä¸­è¾“å…¥Pythonæ— åæ˜ ï¼‰ uv python install 3.10 3.11 3.12 # å¸è½½æŒ‡å®šçš„ç‰ˆæœ¬ uv python uninstall 3.10 https://www.cnblogs.com/wang_yb/p/18635441\nhttps://zhuanlan.zhihu.com/p/1888904532131575259\nç‰ˆæœ¬æ¨è Python ç‰ˆæœ¬ï¼š æ¨èä½¿ç”¨ Python 3.10 åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ”¯æŒå¼‚æ­¥å‡½æ•°ï¼ˆasync/awaitï¼‰ æˆ‘çš„ç‰ˆæœ¬ï¼šPython 3.14\nFastMCP åº“ï¼š è¯¥åº“éœ€è¦é€šè¿‡ pip æˆ–å…¶ä»–æ–¹å¼å®‰è£…ã€‚å®‰è£…æŒ‡ä»¤å¦‚ä¸‹ï¼š\n1 pip install fastmcp è¿è¡Œæ–¹å¼ï¼š æœ¬ç¤ºä¾‹é‡‡ç”¨æ ‡å‡†è¾“å…¥/è¾“å‡ºï¼ˆstdioï¼‰ä½œä¸ºä¼ è¾“å±‚ï¼Œå¯æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©å…¶ä»–ä¼ è¾“æ–¹å¼ï¼Œå¦‚ç½‘ç»œé€šä¿¡ç­‰ã€‚\nå®ç°æ­¥éª¤ ä¸‹é¢æŒ‰ç…§æ­¥éª¤è§£æå¦‚ä½•æ„å»ºä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å®Œå¤‡çš„ MCP æœåŠ¡ç«¯ï¼š\nstdio 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 from mcp.server.fastmcp import FastMCP mcp = FastMCP(\u0026#34;Demo ğŸš€\u0026#34;) @mcp.tool() def add(a: int, b: int) -\u0026gt; int: \u0026#34;\u0026#34;\u0026#34;ä¸¤ä¸ªæ•°å­—ç›¸åŠ \u0026#34;\u0026#34;\u0026#34; return a + b @mcp.tool() async def calculate(expression: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34; è®¡ç®—ä¸€ä¸ªç®€å•çš„æ•°å­¦è¡¨è¾¾å¼ã€‚ Args: expression: è¦è®¡ç®—çš„æ•°å­¦è¡¨è¾¾å¼ï¼ˆå¦‚\u0026#34;1 + 2\u0026#34;ï¼‰ Returns: str: è®¡ç®—ç»“æœ \u0026#34;\u0026#34;\u0026#34; try: result = eval(expression) return f\u0026#34;è®¡ç®—ç»“æœ: {result}\u0026#34; except Exception as e: return f\u0026#34;è®¡ç®—é”™è¯¯: {str(e)}\u0026#34; @mcp.resource(\u0026#34;greeting://{name}\u0026#34;) def get_greeting(name: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34;è·å–ä¸ªæ€§åŒ–é—®å€™è¯­\u0026#34;\u0026#34;\u0026#34; return f\u0026#34;Hello, {name}!\u0026#34; if __name__ == \u0026#34;__main__\u0026#34;: mcp.run(transport=\u0026#39;stdio\u0026#39;) å¯åŠ¨è°ƒè¯•ï¼š\n1 mcp dev main.py é”™è¯¯æŠ¥é”™ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Created web app transport Created web app transport Set up MCP proxy file:///C:/Users/admin/AppData/Local/npm-cache/_npx/5a9d879542beca3a/node_modules/@modelcontextprotocol/sdk/dist/esm/server/sse.js:103 throw new Error(\u0026#34;Not connected\u0026#34;); ^ Error: Not connected at SSEServerTransport.send (file:///C:/Users/admin/AppData/Local/npm-cache/_npx/5a9d879542beca3a/node_modules/@modelcontextprotocol/sdk/dist/esm/server/sse.js:103:19) at Socket.\u0026lt;anonymous\u0026gt; (file:///C:/Users/admin/AppData/Local/npm-cache/_npx/5a9d879542beca3a/node_modules/@modelcontextprotocol/inspector/server/build/index.js:101:33) at Socket.emit (node:events:517:28) at addChunk (node:internal/streams/readable:368:12) at readableAddChunk (node:internal/streams/readable:341:9) at Readable.push (node:internal/streams/readable:278:10) at Pipe.onStreamRead (node:internal/stream_base_commons:190:23) è§£å†³æ–¹æ¡ˆï¼š\n1 2 3 npm install -g @modelcontextprotocol/server-filesystem npm install -g @modelcontextprotocol/server-memory npm install -g @modelcontextprotocol/server-brave-search sseæ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 from mcp.server.fastmcp import FastMCP mcp = FastMCP(\u0026#34;Demo ğŸš€\u0026#34;) @mcp.tool() def add(a: int, b: int) -\u0026gt; int: \u0026#34;\u0026#34;\u0026#34;ä¸¤ä¸ªæ•°å­—ç›¸åŠ \u0026#34;\u0026#34;\u0026#34; return a + b @mcp.tool() async def calculate(expression: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34; è®¡ç®—ä¸€ä¸ªç®€å•çš„æ•°å­¦è¡¨è¾¾å¼ã€‚ Args: expression: è¦è®¡ç®—çš„æ•°å­¦è¡¨è¾¾å¼ï¼ˆå¦‚\u0026#34;1 + 2\u0026#34;ï¼‰ Returns: str: è®¡ç®—ç»“æœ \u0026#34;\u0026#34;\u0026#34; try: result = eval(expression) return f\u0026#34;è®¡ç®—ç»“æœ: {result}\u0026#34; except Exception as e: return f\u0026#34;è®¡ç®—é”™è¯¯: {str(e)}\u0026#34; @mcp.resource(\u0026#34;greeting://{name}\u0026#34;) def get_greeting(name: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34;è·å–ä¸ªæ€§åŒ–é—®å€™è¯­\u0026#34;\u0026#34;\u0026#34; return f\u0026#34;Hello, {name}!\u0026#34; if __name__ == \u0026#34;__main__\u0026#34;: mcp.run(transport=\u0026#39;sse\u0026#39;) åœ¨ FastMCP ä¸­ï¼Œæœ‰å‡ ä¸ªå¯ä»¥è®¾ç½® SSE åè®®ç›¸å…³çš„å‚æ•°ï¼š\nhost: æœåŠ¡åœ°å€ï¼Œé»˜è®¤ä¸º 0.0.0.0 port: æœåŠ¡ç«¯å£ï¼Œé»˜è®¤ä¸º 8000ã€‚ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘è®¾ç½®ä¸º 9000 sse_pathï¼šsse çš„è·¯ç”±ï¼Œé»˜è®¤ä¸º /sse Vscode-Clineè°ƒç”¨ å®‰è£…Vscodeå’ŒCline\nstdioæ¨¡å¼è°ƒç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 { \u0026#34;mcpServers\u0026#34;: { \u0026#34;weather\u0026#34;: { \u0026#34;command\u0026#34;: \u0026#34;uv\u0026#34;, \u0026#34;args\u0026#34;: [ \u0026#34;--directory\u0026#34;, \u0026#34;E:\\\\Code\\\\Python\\\\weather\u0026#34;, \u0026#34;run\u0026#34;, \u0026#34;main.py\u0026#34; ], \u0026#34;timeout\u0026#34;: 30 } } } sseæ¨¡å¼ 1 2 3 4 5 6 7 { \u0026#34;mcpServers\u0026#34;: { \u0026#34;weather\u0026#34;: { \u0026#34;url\u0026#34;: \u0026#34;http://192.168.96.19:8000/sse\u0026#34; } } } å‚è€ƒæ–‡æ¡£ï¼š https://github.com/GobinFan/python-mcp-server-client?tab=readme-ov-file\nhttps://www.cnblogs.com/xiao987334176/p/18821197\nhttps://www.cnblogs.com/ryanzheng/p/18781666\nhttps://www.cnblogs.com/xiao987334176/p/18822444\nhttps://www.modb.pro/db/1878984329888542720\nhttps://blog.moontak.com/id/522381/\nhttps://github.com/liaokongVFX/MCP-Chinese-Getting-Started-Guide\nhttps://zhuanlan.zhihu.com/p/28700850694\n","date":"2025-04-17T09:16:33Z","image":"https://www.ownit.top/title_pic/51.jpg","permalink":"https://www.ownit.top/p/202504170916/","title":"Pythonä½¿ç”¨FastMCPå¼€å‘MCPæœåŠ¡ç«¯"},{"content":"é¡¹ç›®èƒŒæ™¯ åœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼ŒKuberneteså·²æˆä¸ºå®¹å™¨ç¼–æ’çš„äº‹å®æ ‡å‡†ã€‚ä½†éšç€ä¸šåŠ¡è§„æ¨¡çš„æ‰©å¤§ï¼Œä¼ä¸šå¾€å¾€éœ€è¦ç®¡ç†å¤šä¸ªKubernetesé›†ç¾¤ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªå®é™…é¡¹ç›®ï¼Œè¯¦ç»†ä»‹ç»å¦‚ä½•åŸºäºGoè¯­è¨€å’ŒGinæ¡†æ¶å¼€å‘ä¸€ä¸ªæ”¯æŒå¤šé›†ç¾¤ç®¡ç†çš„Kubernetesæ§åˆ¶å¹³å°ï¼Œå®ç°Podèµ„æºçš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆå¢åˆ æ”¹æŸ¥ã€æ—¥å¿—æŸ¥çœ‹ï¼‰ï¼Œå¹¶æ”¯æŒæ•°æ®è¿‡æ»¤ã€æ’åºå’Œåˆ†é¡µåŠŸèƒ½ã€‚\nClient-go ä»‹ç» client-goæ˜¯kuberneteså®˜æ–¹æä¾›çš„goè¯­è¨€çš„å®¢æˆ·ç«¯åº“ï¼Œgoåº”ç”¨ä½¿ç”¨è¯¥åº“å¯ä»¥è®¿é—®kubernetesçš„API Serverï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½é€šè¿‡ç¼–ç¨‹æ¥å¯¹kubernetesèµ„æºè¿›è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œï¼› é™¤äº†æä¾›ä¸°å¯Œçš„APIç”¨äºæ“ä½œkubernetesèµ„æºï¼Œclient-goè¿˜ä¸ºcontrollerå’Œoperatoræä¾›äº†é‡è¦æ”¯æŒclient-goçš„informeræœºåˆ¶å¯ä»¥å°†controllerå…³æ³¨çš„èµ„æºå˜åŒ–åŠæ—¶å¸¦ç»™æ­¤controllerï¼Œä½¿controllerèƒ½å¤ŸåŠæ—¶å“åº”å˜åŒ–ã€‚ é€šè¿‡client-goæä¾›çš„å®¢æˆ·ç«¯å¯¹è±¡ä¸kubernetesçš„API Serverè¿›è¡Œäº¤äº’ï¼Œè€Œclient-goæä¾›äº†ä»¥ä¸‹å››ç§å®¢æˆ·ç«¯å¯¹è±¡ï¼š RESTClientã€ClientSetã€DynamicClientã€DiscoveryClient ä»£ç ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package main import ( \u0026#34;context\u0026#34; metav1 \u0026#34;k8s.io/apimachinery/pkg/apis/meta/v1\u0026#34; \u0026#34;k8s.io/client-go/kubernetes\u0026#34; \u0026#34;k8s.io/client-go/tools/clientcmd\u0026#34; ) func main() { // å®šä¹‰kubeconfigæ–‡ä»¶è·¯å¾„ kubeconfig := \u0026#34;config/k8s.yaml\u0026#34; // ä»kubeconfigæ–‡ä»¶ä¸­æ„å»ºé…ç½® config, err := clientcmd.BuildConfigFromFlags(\u0026#34;\u0026#34;, kubeconfig) if err != nil { // å¦‚æœæ„å»ºé…ç½®å¤±è´¥ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ panic(err.Error()) } // ä½¿ç”¨é…ç½®åˆ›å»ºkuberneteså®¢æˆ·ç«¯ client, err := kubernetes.NewForConfig(config) if err != nil { // å¦‚æœåˆ›å»ºå®¢æˆ·ç«¯å¤±è´¥ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ panic(err.Error()) } // ä½¿ç”¨å®¢æˆ·ç«¯è·å–defaultå‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰Pod pods, err := client.CoreV1().Pods(\u0026#34;default\u0026#34;).List(context.TODO(), metav1.ListOptions{}) if err != nil { // å¦‚æœè·å–Podå¤±è´¥ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ panic(err.Error()) } // éå†æ‰€æœ‰Podï¼Œå¹¶æ‰“å°Podåç§° for _, pod := range pods.Items { println(pod.Name) } } æ‰“å°ç»“æœ å¸¸ç”¨æ–¹æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // è·å–podListç±»å‹çš„podåˆ—è¡¨ podList, err := client.CoreV1().Pods(namespace).List(context.TODO(), metav1.ListOptions{}) // è·å–podçš„è¯¦æƒ… pod, err := client.CoreV1().Pods(namespace).Get(context.TODO(), podName, metav1.GetOptions{}) // åˆ é™¤pod err := client.CoreV1().Pods(namespace).Delete(context.TODO(), podName, metav1.DeleteOptions{}) // æ›´æ–°pod _, err = client.CoreV1().Pods(namespace).Update(context.TODO(), pod, metav1.UpdateOptions{}) // è·å–deploymentå‰¯æœ¬æ•° scale, err := K8s.ClientSet.AppsV1().Deployments(namespace).GetScale(context.TODO(),deploymentName, metav1.GetOptions{}) // åˆ›å»ºdeployment deployment, err =K8s.ClientSet.AppsV1().Deployments(data.Namespace).Create(context.TODO(), deployment,metav1.CreateOptions{}) // æ›´æ–°deploymentï¼ˆéƒ¨åˆ†yamlï¼‰ deployment, err = K8s.ClientSet.AppsV1().Deployments(namespace).Patch(context.TODO(),deploymentName, \u0026#34;application/strategic-merge-patch+json\u0026#34;, patchByte,metav1.PatchOptions{}) é¡¹ç›®æ¶æ„ä¸æ ¸å¿ƒæ¨¡å— é¡¹ç›®é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œæ ¸å¿ƒæ¨¡å—åŒ…æ‹¬ï¼š\nè·¯ç”±å±‚ï¼ˆRouterï¼‰ï¼šåŸºäºGinæ¡†æ¶å®šä¹‰APIç«¯ç‚¹ã€‚ æ§åˆ¶å±‚ï¼ˆControllerï¼‰ï¼šå¤„ç†HTTPè¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒï¼Œè°ƒç”¨æœåŠ¡å±‚é€»è¾‘ã€‚ æœåŠ¡å±‚ï¼ˆServiceï¼‰ï¼šå°è£…ä¸šåŠ¡é€»è¾‘ï¼Œä¸Kubernetes APIäº¤äº’ã€‚ æ•°æ®å±‚ï¼ˆKubernetes Clientï¼‰ï¼šç®¡ç†å¤šé›†ç¾¤è¿æ¥ï¼Œæä¾›å®¢æˆ·ç«¯å®ä¾‹ã€‚ å·¥å…·æ¨¡å—ï¼šæ•°æ®ç­›é€‰ã€åˆ†é¡µã€æ—¥å¿—å¤„ç†ç­‰ã€‚ æŠ€æœ¯æ ˆ Ginæ¡†æ¶ï¼šé«˜æ€§èƒ½HTTPæ¡†æ¶ï¼Œç”¨äºè·¯ç”±å’Œè¯·æ±‚å¤„ç†ã€‚ Kubernetes Client-goï¼šå®˜æ–¹Goè¯­è¨€å®¢æˆ·ç«¯ï¼Œæ“ä½œKubernetesèµ„æºã€‚ å¤šé›†ç¾¤ç®¡ç†ï¼šé€šè¿‡åŠ¨æ€åŠ è½½Kubeconfigæ”¯æŒå¤šé›†ç¾¤ã€‚ æ•°æ®åˆ†é¡µä¸è¿‡æ»¤ï¼šè‡ªå®šä¹‰æ’åºã€è¿‡æ»¤å’Œåˆ†é¡µé€»è¾‘ã€‚ å¤šé›†ç¾¤ç®¡ç†å®ç° åœ¨k8s_client.goä¸­ï¼Œé¡¹ç›®é€šè¿‡K8sç»“æ„ä½“å®ç°äº†å¤šé›†ç¾¤ç®¡ç†ï¼š\n1 2 3 4 type k8s struct { ClientMap map[string]*kubernetes.Clientset // å¤šé›†ç¾¤Client KubeConfMap map[string]string // å¤šé›†ç¾¤é…ç½® } åˆå§‹åŒ–æ—¶ï¼Œä»é…ç½®æ–‡ä»¶è¯»å–å¤šä¸ªé›†ç¾¤çš„kubeconfigï¼Œå¹¶ä¸ºæ¯ä¸ªé›†ç¾¤åˆ›å»ºç‹¬ç«‹çš„ClientSetï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // Init åˆå§‹åŒ–k8s client func (k *k8s) Init() { // åˆ›å»ºä¸€ä¸ªç©ºçš„mapï¼Œç”¨äºå­˜å‚¨Kubeconfigs mp := make(map[string]string, 0) // åˆ›å»ºä¸€ä¸ªç©ºçš„mapï¼Œç”¨äºå­˜å‚¨Kubernetesçš„Clientset k.ClientMap = make(map[string]*kubernetes.Clientset, 0) // ååºåˆ—åŒ– if err := json.Unmarshal([]byte(config.Kubeconfigs), \u0026amp;mp); err != nil { // å¦‚æœååºåˆ—åŒ–å¤±è´¥ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ panic(fmt.Sprintf(\u0026#34;ååºåˆ—åŒ–Kubeconfigså¤±è´¥,%v\\n\u0026#34;, err)) } // å°†ååºåˆ—åŒ–åçš„ç»“æœå­˜å‚¨åˆ°KubeConfMapä¸­ k.KubeConfMap = mp // åˆå§‹åŒ–é›†ç¾¤Client for key, value := range mp { // æ ¹æ®Kubeconfigsä¸­çš„é…ç½®ï¼Œåˆå§‹åŒ–é›†ç¾¤Client client, err := clientcmd.BuildConfigFromFlags(\u0026#34;\u0026#34;, value) if err != nil { // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ panic(fmt.Sprintf(\u0026#34;åˆå§‹åŒ–é›†ç¾¤%så¤±è´¥,%v\\n\u0026#34;, key, err)) } clientSet, err := kubernetes.NewForConfig(client) if err != nil { // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ panic(fmt.Sprintf(\u0026#34;åˆå§‹åŒ–é›†ç¾¤%så¤±è´¥,%v\\n\u0026#34;, key, err)) } // å°†åˆå§‹åŒ–åçš„Clientsetå­˜å‚¨åˆ°ClientMapä¸­ k.ClientMap[key] = clientSet // æ‰“å°åˆå§‹åŒ–æˆåŠŸçš„æ—¥å¿— logger.Info(fmt.Sprintf(\u0026#34;åˆå§‹åŒ–é›†ç¾¤%sæˆåŠŸ\u0026#34;, key)) } } è¿™ç§è®¾è®¡ä½¿å¾—åœ¨APIè°ƒç”¨æ—¶ï¼Œåªéœ€æŒ‡å®šé›†ç¾¤åç§°å³å¯æ“ä½œå¯¹åº”çš„é›†ç¾¤èµ„æºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // GetClient æ ¹æ®é›†ç¾¤åç§°è·å–Client // æ ¹æ®é›†ç¾¤åç§°è·å–kuberneteså®¢æˆ·ç«¯ func (k *k8s) GetClient(clusterName string) (*kubernetes.Clientset, error) { // ä»ClientMapä¸­è·å–æŒ‡å®šé›†ç¾¤åç§°çš„å®¢æˆ·ç«¯ client, ok := k.ClientMap[clusterName] // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å›é”™è¯¯ if !ok { logger.Error(fmt.Sprintf(\u0026#34;é›†ç¾¤%sä¸å­˜åœ¨,æ— æ³•è·å–Client\\n\u0026#34;, clusterName)) return nil, errors.New(fmt.Sprintf(\u0026#34;é›†ç¾¤%sä¸å­˜åœ¨,æ— æ³•è·å–Client\\n\u0026#34;, clusterName)) } // è¿”å›å®¢æˆ·ç«¯ return client, nil } æ ¸å¿ƒåŠŸèƒ½å®ç° Podåˆ—è¡¨æŸ¥è¯¢ Podåˆ—è¡¨æŸ¥è¯¢åŠŸèƒ½å®ç°äº†è¿‡æ»¤ã€åˆ†é¡µå’Œæ’åºç­‰é«˜çº§ç‰¹æ€§ï¼Œä»£ç ä½äºpod.goå’Œdataselect.goä¸­ã€‚\næ•°æ®ç»“æ„å®šä¹‰\né¦–å…ˆå®šä¹‰äº†é€šç”¨çš„æ•°æ®é€‰æ‹©å™¨ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // dataSelect ç”¨äºå°è£…æ’åºã€è¿‡æ»¤ã€åˆ†é¡µçš„æ•°æ®ç±»å‹ type dataSelector struct { GenericDateSelect []DataCell // å¯æ’åºçš„æ•°æ®é›†åˆ dataSelectQuery *DataSelectQuery // æŸ¥è¯¢æ¡ä»¶ } // DataCell ç”¨äºå„ç§èµ„æºlistçš„ç±»å‹è½¬æ¢ï¼Œè½¬æ¢åå¯ä»¥ä½¿ç”¨dataSelectorçš„è‡ªå®šä¹‰æ’åºæ–¹æ³• type DataCell interface { GetCreation() time.Time GetName() string } // DataSelectQuery å®šä¹‰è¿‡æ»¤å’Œåˆ†é¡µçš„å±æ€§ï¼Œè¿‡æ»¤ï¼šNameï¼Œ åˆ†é¡µï¼šLimitå’ŒPage // Limitæ˜¯å•é¡µçš„æ•°æ®æ¡æ•° // Pageæ˜¯ç¬¬å‡ é¡µ type DataSelectQuery struct { FilterQuery *FilterQuery // è¿‡æ»¤æ¡ä»¶ PaginationQuery *PaginationQuery // åˆ†é¡µæ¡ä»¶ } type FilterQuery struct { Name string } type PaginationQuery struct { Limit int Page int } è¿‡æ»¤å®ç°\nè¿‡æ»¤åŠŸèƒ½é€šè¿‡å­—ç¬¦ä¸²åŒ¹é…å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // Filter æ–¹æ³•ç”¨äºè¿‡æ»¤å…ƒç´ ï¼Œæ¯”è¾ƒå…ƒç´ çš„Nameå±æ€§ï¼Œè‹¥åŒ…å«ï¼Œå†è¿”å› func (d *dataSelector) Filter() *dataSelector { //å¦‚Nameçš„ä¼ å‚ä¸ºç©ºï¼Œåˆ™è¿”å›æ‰€æœ‰å…ƒç´  if d.dataSelectQuery.FilterQuery.Name == \u0026#34;\u0026#34; { return d } // è‹¥Nameçš„ä¼ å‚ä¸ä¸ºç©ºï¼Œåˆ™è¿”å›å…ƒç´ ä¸­åŒ…å«Nameçš„å…ƒç´  var filteredList []DataCell for _, item := range d.GenericDateSelect { matched := true objName := item.GetName() if !strings.Contains(objName, d.dataSelectQuery.FilterQuery.Name) { matched = false continue } if matched { filteredList = append(filteredList, item) } } d.GenericDateSelect = filteredList // è¿”å›è¿‡æ»¤åçš„å…ƒç´  return d } åˆ†é¡µå®ç° åˆ†é¡µé€»è¾‘å¤„ç†äº†è¾¹ç•Œæƒ…å†µï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func (d *dataSelector) Paginate() *dataSelector { limit := d.dataSelectQuery.PaginationQuery.Limit page := d.dataSelectQuery.PaginationQuery.Page if limit \u0026lt; 1 || page \u0026lt; 1 { return d } startIndex := (page - 1) * limit endIndex := page * limit if len(d.GenericDateSelect) \u0026lt; endIndex { endIndex = len(d.GenericDateSelect) } d.GenericDateSelect = d.GenericDateSelect[startIndex:endIndex] return d } æ’åºå®ç° é€šè¿‡å®ç°sort.Interfaceæ¥å£å®ç°æ’åºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 func (d *dataSelector) Len() int { return len(d.GenericDateSelect) } func (d *dataSelector) Swap(i, j int) { d.GenericDateSelect[i], d.GenericDateSelect[j] = d.GenericDateSelect[j], d.GenericDateSelect[i] } func (d *dataSelector) Less(i, j int) bool { a := d.GenericDateSelect[i].GetCreation() b := d.GenericDateSelect[j].GetCreation() return b.Before(a) // é™åºæ’åˆ— } dataselect.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 package service import ( \u0026#34;sort\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;time\u0026#34; corev1 \u0026#34;k8s.io/api/core/v1\u0026#34; ) /** * @Author: å—å®«ä¹˜é£ * @Description:å®šä¹‰æ•°æ®ç»“æ„ * @File: dataselect.go * @Email: 1794748404@qq.com * @Date: 2025-03-20 14:38 */ // dataSelect ç”¨äºå°è£…æ’åºã€è¿‡æ»¤ã€åˆ†é¡µçš„æ•°æ®ç±»å‹ type dataSelector struct { GenericDateSelect []DataCell // å¯æ’åºçš„æ•°æ®é›†åˆ dataSelectQuery *DataSelectQuery // æŸ¥è¯¢æ¡ä»¶ } // DataCell ç”¨äºå„ç§èµ„æºlistçš„ç±»å‹è½¬æ¢ï¼Œè½¬æ¢åå¯ä»¥ä½¿ç”¨dataSelectorçš„è‡ªå®šä¹‰æ’åºæ–¹æ³• type DataCell interface { GetCreation() time.Time GetName() string } // DataSelectQuery å®šä¹‰è¿‡æ»¤å’Œåˆ†é¡µçš„å±æ€§ï¼Œè¿‡æ»¤ï¼šNameï¼Œ åˆ†é¡µï¼šLimitå’ŒPage // Limitæ˜¯å•é¡µçš„æ•°æ®æ¡æ•° // Pageæ˜¯ç¬¬å‡ é¡µ type DataSelectQuery struct { FilterQuery *FilterQuery // è¿‡æ»¤æ¡ä»¶ PaginationQuery *PaginationQuery // åˆ†é¡µæ¡ä»¶ } type FilterQuery struct { Name string } type PaginationQuery struct { Limit int Page int } //å®ç°è‡ªå®šä¹‰ç»“æ„çš„æ’åºï¼Œéœ€è¦é‡å†™Lenã€Swapã€Lessæ–¹æ³• // Len æ–¹æ³•ç”¨äºè·å–æ•°æ®é•¿åº¦ func (d *dataSelector) Len() int { return len(d.GenericDateSelect) } // Swap æ–¹æ³•ç”¨äºæ•°ç»„ä¸­çš„å…ƒç´ åœ¨æ¯”è¾ƒå¤§å°åçš„ä½ç½®äº¤æ¢ï¼Œå¯å®šä¹‰å‡åºæˆ–é™åº i j æ˜¯åˆ‡ç‰‡çš„ä¸‹æ ‡ func (d *dataSelector) Swap(i, j int) { // äº¤æ¢GenericDateSelectæ•°ç»„ä¸­çš„ç¬¬iä¸ªå’Œç¬¬jä¸ªå…ƒç´  d.GenericDateSelect[i], d.GenericDateSelect[j] = d.GenericDateSelect[j], d.GenericDateSelect[i] } // Less æ–¹æ³•ç”¨äºå®šä¹‰æ•°ç»„ä¸­å…ƒç´ æ’åºçš„â€œå¤§å°â€çš„æ¯”è¾ƒæ–¹å¼ // Less æ–¹æ³•è¿”å›trueè¡¨ç¤ºç¬¬iä¸ªå…ƒç´ å°äºç¬¬jä¸ªå…ƒç´ ï¼Œè¿”å›falseè¡¨ç¤ºç¬¬iä¸ªå…ƒç´ å¤§äºç¬¬jä¸ªå…ƒç´  func (d *dataSelector) Less(i, j int) bool { a := d.GenericDateSelect[i].GetCreation() b := d.GenericDateSelect[j].GetCreation() return b.Before(a) } // Sort é‡æ–°ä»¥ä¸Š3ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨sort.Sort()æ–¹æ³•è¿›è¡Œæ’åº func (d *dataSelector) Sort() *dataSelector { // ä½¿ç”¨sort.Sort()æ–¹æ³•è¿›è¡Œæ’åº sort.Sort(d) return d } // è¿‡æ»¤ // Filter æ–¹æ³•ç”¨äºè¿‡æ»¤å…ƒç´ ï¼Œæ¯”è¾ƒå…ƒç´ çš„Nameå±æ€§ï¼Œè‹¥åŒ…å«ï¼Œå†è¿”å› func (d *dataSelector) Filter() *dataSelector { //å¦‚Nameçš„ä¼ å‚ä¸ºç©ºï¼Œåˆ™è¿”å›æ‰€æœ‰å…ƒç´  if d.dataSelectQuery.FilterQuery.Name == \u0026#34;\u0026#34; { return d } // è‹¥Nameçš„ä¼ å‚ä¸ä¸ºç©ºï¼Œåˆ™è¿”å›å…ƒç´ ä¸­åŒ…å«Nameçš„å…ƒç´  var filteredList []DataCell for _, item := range d.GenericDateSelect { matched := true objName := item.GetName() if !strings.Contains(objName, d.dataSelectQuery.FilterQuery.Name) { matched = false continue } if matched { filteredList = append(filteredList, item) } } d.GenericDateSelect = filteredList // è¿”å›è¿‡æ»¤åçš„å…ƒç´  return d } // åˆ†é¡µ // Paginate æ–¹æ³•ç”¨äºæ•°ç»„åˆ†é¡µï¼Œæ ¹æ®Limitå’ŒPageçš„ä¼ å‚ï¼Œè¿”å›æ•°æ® func (d *dataSelector) Paginate() *dataSelector { limit := d.dataSelectQuery.PaginationQuery.Limit page := d.dataSelectQuery.PaginationQuery.Page // éªŒè¯å‚æ•°åˆæ³•ï¼Œè‹¥ä¸åˆæ³•ï¼Œåˆ™è¿”å›æ‰€æœ‰å…ƒç´  if limit \u0026lt; 1 || page \u0026lt; 1 { return d } // ä¸¾ä¾‹ï¼š25ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œlimitæ˜¯10ï¼Œpageæ˜¯3ï¼ŒstartIndexæ˜¯20ï¼ŒendIndexæ˜¯30ï¼ˆå®é™…ä¸ŠendIndexæ˜¯25ï¼‰ã€ startIndex := (page - 1) * limit endIndex := page * limit // å¤„ç†æœ€åä¸€é¡µï¼Œè¿™æ—¶å€™å°±æŠŠendIndexç”±30æ”¹ä¸º25äº† if len(d.GenericDateSelect) \u0026lt; endIndex { endIndex = len(d.GenericDateSelect) } d.GenericDateSelect = d.GenericDateSelect[startIndex:endIndex] return d } // å®šä¹‰podCell ç±»å‹ï¼Œå®ç°ä¸¤ä¸ªæ–¹æ³•GetCreationå’ŒGetNameï¼Œå¯è¿›è¡Œç±»å‹è½¬æ¢ type podCell corev1.Pod func (p podCell) GetCreation() time.Time { return p.CreationTimestamp.Time } func (p podCell) GetName() string { return p.Name } Podè¯¦æƒ…æŸ¥è¯¢ é€šè¿‡Kuberneteså®¢æˆ·ç«¯ç›´æ¥è·å–Podè¯¦æƒ…ï¼š\n1 2 3 4 5 6 7 8 func (p *pod) GetPodDetail(client *kubernetes.Clientset, namespace, podName string) (*corev1.Pod, error) { pod, err := client.CoreV1().Pods(namespace).Get(context.TODO(), podName, metav1.GetOptions{}) if err != nil { logger.Error(errors.New(\u0026#34;è·å–Podè¯¦æƒ…å¤±è´¥, \u0026#34; + err.Error())) return nil, errors.New(\u0026#34;è·å–Podè¯¦æƒ…å¤±è´¥, \u0026#34; + err.Error()) } return pod, nil } Podæ—¥å¿—æŸ¥è¯¢ æ—¥å¿—æŸ¥è¯¢åŠŸèƒ½æ”¯æŒæŒ‡å®šå®¹å™¨å’Œè¿”å›è¡Œæ•°é™åˆ¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func (p *pod) GetPodLog(client *kubernetes.Clientset, namespace, podName, containerName string) (log string, err error) { lineLimit := int64(config.PodLogTailLine) options := \u0026amp;corev1.PodLogOptions{ Container: containerName, TailLines: \u0026amp;lineLimit, } req := client.CoreV1().Pods(namespace).GetLogs(podName, options) podLogs, err := req.Stream(context.TODO()) if err != nil { logger.Error(errors.New(\u0026#34;è·å–Podæ—¥å¿—å¤±è´¥, \u0026#34; + err.Error())) return \u0026#34;\u0026#34;, errors.New(\u0026#34;è·å–Podæ—¥å¿—å¤±è´¥, \u0026#34; + err.Error()) } defer podLogs.Close() buf := new(bytes.Buffer) _, err = io.Copy(buf, podLogs) if err != nil { logger.Error(errors.New(\u0026#34;å¤åˆ¶PodLogå¤±è´¥, \u0026#34; + err.Error())) return \u0026#34;\u0026#34;, errors.New(\u0026#34;å¤åˆ¶PodLogå¤±è´¥, \u0026#34; + err.Error()) } return buf.String(), nil } pod.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 package service import ( \u0026#34;bytes\u0026#34; \u0026#34;context\u0026#34; \u0026#34;encoding/json\u0026#34; \u0026#34;errors\u0026#34; \u0026#34;io\u0026#34; \u0026#34;kubea-go/config\u0026#34; \u0026#34;github.com/aryming/logger\u0026#34; corev1 \u0026#34;k8s.io/api/core/v1\u0026#34; metav1 \u0026#34;k8s.io/apimachinery/pkg/apis/meta/v1\u0026#34; \u0026#34;k8s.io/client-go/kubernetes\u0026#34; ) /** * @Author: å—å®«ä¹˜é£ * @Description: * @File: pod.go * @Email: 1794748404@qq.com * @Date: 2025-03-20 15:42 */ var Pod pod type pod struct { } // PodsResp å®šä¹‰åˆ—è¡¨çš„è¿”å›å†…å®¹ï¼ŒItemsæ˜¯podå…ƒç´ åˆ—è¡¨ï¼ŒTotalä¸ºpodå…ƒç´ æ•°é‡ type PodsResp struct { Items []corev1.Pod `json:\u0026#34;items\u0026#34;` Total int `json:\u0026#34;total\u0026#34;` } // GetPods è·å–podåˆ—è¡¨ï¼Œæ”¯æŒè¿‡æ»¤å’Œåˆ†é¡µ,æ’åº func (p *pod) GetPods(client *kubernetes.Clientset, filterName, namespace string, limit, page int) (*PodsResp, error) { // è·å–podListç±»å‹çš„podåˆ—è¡¨ podList, err := client.CoreV1().Pods(namespace).List(context.TODO(), metav1.ListOptions{}) if err != nil { logger.Error(errors.New(\u0026#34;è·å–Podåˆ—è¡¨å¤±è´¥, \u0026#34; + err.Error())) return nil, errors.New(\u0026#34;è·å–Podåˆ—è¡¨å¤±è´¥, \u0026#34; + err.Error()) } // å®ä¾‹åŒ–dataSelectorå¯¹è±¡ selectableData := \u0026amp;dataSelector{ GenericDateSelect: p.toCells(podList.Items), dataSelectQuery: \u0026amp;DataSelectQuery{ FilterQuery: \u0026amp;FilterQuery{Name: filterName}, PaginationQuery: \u0026amp;PaginationQuery{ Limit: limit, Page: page, }, }, } //å…ˆè¿‡æ»¤ filtered := selectableData.Filter() total := len(filtered.GenericDateSelect) data := filtered.Sort().Paginate() //å°†[]DataCellç±»å‹çš„podåˆ—è¡¨è½¬ä¸ºv1.podåˆ—è¡¨ pods := p.fromCells(data.GenericDateSelect) return \u0026amp;PodsResp{Items: pods, Total: total}, nil } // GetPodDetail è·å–podè¯¦æƒ… func (p *pod) GetPodDetail(client *kubernetes.Clientset, namespace, podName string) (*corev1.Pod, error) { pod, err := client.CoreV1().Pods(namespace).Get(context.TODO(), podName, metav1.GetOptions{}) if err != nil { logger.Error(errors.New(\u0026#34;è·å–Podè¯¦æƒ…å¤±è´¥, \u0026#34; + err.Error())) return nil, errors.New(\u0026#34;è·å–Podè¯¦æƒ…å¤±è´¥, \u0026#34; + err.Error()) } return pod, nil } // DeletePod åˆ é™¤POD func (p *pod) DeletePod(client *kubernetes.Clientset, namespace, podName string) error { // åˆ é™¤pod err := client.CoreV1().Pods(namespace).Delete(context.TODO(), podName, metav1.DeleteOptions{}) if err != nil { logger.Error(errors.New(\u0026#34;åˆ é™¤Podå¤±è´¥, \u0026#34; + err.Error())) return errors.New(\u0026#34;åˆ é™¤Podå¤±è´¥, \u0026#34; + err.Error()) } return nil } // UpdatePod æ›´æ–°POD contentå‚æ•°æ˜¯è¯·æ±‚ä¸­ä¼ å…¥çš„podå¯¹è±¡çš„jsonæ•°æ® func (p *pod) UpdatePod(client *kubernetes.Clientset, namespace, podName, content string) error { var pod = \u0026amp;corev1.Pod{} // å°†contentå‚æ•°çš„jsonæ•°æ®è§£æåˆ°podå¯¹è±¡ä¸­ err := json.Unmarshal([]byte(content), pod) if err != nil { logger.Error(errors.New(\u0026#34;ååºåˆ—åŒ–å¤±è´¥, \u0026#34; + err.Error())) return errors.New(\u0026#34;ååºåˆ—åŒ–å¤±è´¥, \u0026#34; + err.Error()) } // æ›´æ–°pod _, err = client.CoreV1().Pods(namespace).Update(context.TODO(), pod, metav1.UpdateOptions{}) if err != nil { logger.Error(errors.New(\u0026#34;æ›´æ–°Podå¤±è´¥, \u0026#34; + err.Error())) return errors.New(\u0026#34;æ›´æ–°Podå¤±è´¥, \u0026#34; + err.Error()) } return nil } // GetPodContainer è·å–podå®¹å™¨ func (p *pod) GetPodContainer(client *kubernetes.Clientset, namespace, podName string) (containers []string, err error) { // è·å–podè¯¦æƒ… pod, err := p.GetPodDetail(client, namespace, podName) if err != nil { logger.Error(errors.New(\u0026#34;è·å–Podè¯¦æƒ…å¤±è´¥, \u0026#34; + err.Error())) return nil, errors.New(\u0026#34;è·å–Podè¯¦æƒ…å¤±è´¥, \u0026#34; + err.Error()) } // ä»podè¯¦æƒ…ä¸­è·å–å®¹å™¨åˆ—è¡¨ for _, container := range pod.Spec.Containers { containers = append(containers, container.Name) } return containers, nil } // GetPodLog è·å–podå†…å®¹å™¨æ—¥å¿— func (p *pod) GetPodLog(client *kubernetes.Clientset, namespace, podName, containerName string) (log string, err error) { //è®¾ç½®æ—¥å¿—çš„é…ç½®ï¼Œå®¹å™¨åã€tailçš„è¡Œæ•° lineLimit := int64(config.PodLogTailLine) options := \u0026amp;corev1.PodLogOptions{ Container: containerName, TailLines: \u0026amp;lineLimit, } // è·å–requestå®ä¾‹ req := client.CoreV1().Pods(namespace).GetLogs(podName, options) // å‘èµ·requestè¯·æ±‚ï¼Œè¿”å›ä¸€ä¸ªio.ReadCloserç±»å‹ï¼ˆç­‰åŒäºresponse.bodyï¼‰ podLogs, err := req.Stream(context.TODO()) if err != nil { logger.Error(errors.New(\u0026#34;è·å–Podæ—¥å¿—å¤±è´¥, \u0026#34; + err.Error())) return \u0026#34;\u0026#34;, errors.New(\u0026#34;è·å–Podæ—¥å¿—å¤±è´¥, \u0026#34; + err.Error()) } defer podLogs.Close() //å°†response bodyå†™å…¥åˆ°ç¼“å†²åŒºï¼Œç›®çš„æ˜¯ä¸ºäº†è½¬æˆstringè¿”å› buf := new(bytes.Buffer) _, err = io.Copy(buf, podLogs) if err != nil { logger.Error(errors.New(\u0026#34;å¤åˆ¶PodLogå¤±è´¥, \u0026#34; + err.Error())) return \u0026#34;\u0026#34;, errors.New(\u0026#34;å¤åˆ¶PodLogå¤±è´¥, \u0026#34; + err.Error()) } return buf.String(), nil } // toCells æ–¹æ³•ç”¨äºå°†podç±»å‹æ•°ç»„ï¼Œè½¬æ¢æˆDataCellç±»å‹æ•°ç»„ func (p *pod) toCells(std []corev1.Pod) []DataCell { cells := make([]DataCell, len(std)) for i := range std { cells[i] = podCell(std[i]) } return cells } // fromCells æ–¹æ³•ç”¨äºå°†DataCellç±»å‹æ•°ç»„ï¼Œè½¬æ¢æˆpodç±»å‹æ•°ç»„ func (p *pod) fromCells(cells []DataCell) []corev1.Pod { pods := make([]corev1.Pod, len(cells)) for i := range cells { //cells[i].(podCell)å°±ä½¿ç”¨åˆ°äº†æ–­è¨€,æ–­è¨€åè½¬æ¢æˆäº†podCellç±»å‹ï¼Œç„¶ååˆè½¬æ¢æˆäº†Podç±»å‹ pods[i] = corev1.Pod(cells[i].(podCell)) } return pods } Controllerå±‚é¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 package controller import ( \u0026#34;kubea-go/service\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;github.com/aryming/logger\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; ) /** * @Author: å—å®«ä¹˜é£ * @Description: * @File: pod.go.go * @Email: 1794748404@qq.com * @Date: 2025-03-25 15:37 */ var Pod pod type pod struct{} //Controllerä¸­çš„æ–¹æ³•å…¥å‚æ˜¯gin.Contextï¼Œç”¨äºä»ä¸Šä¸‹æ–‡ä¸­è·å–è¯·æ±‚å‚æ•°åŠå®šä¹‰å“åº”å†…å®¹ //æµç¨‹ï¼šç»‘å®šå‚æ•°\u0026#34;,è°ƒç”¨serviceä»£ç \u0026#34;,æ ¹æ®è°ƒç”¨ç»“æœå“åº”å…·ä½“å†…å®¹ // GetPods è·å–podåˆ—è¡¨ï¼Œæ”¯æŒè¿‡æ»¤ã€æ’åºã€åˆ†é¡µ func (p *pod) GetPods(c *gin.Context) { //åŒ¿åç»“æ„ä½“ï¼Œç”¨äºå£°æ˜å…¥å‚ï¼Œgetè¯·æ±‚ä¸ºformæ ¼å¼ï¼Œå…¶ä»–è¯·æ±‚ä¸ºjsonæ ¼å¼ params := new( struct { FilterName string `form:\u0026#34;filter_name\u0026#34;` Namespace string `form:\u0026#34;namespace\u0026#34;` Page int `form:\u0026#34;page\u0026#34;` Limit int `form:\u0026#34;limit\u0026#34;` Cluster string `form:\u0026#34;cluster\u0026#34;` }) //ç»‘å®šå‚æ•°ï¼Œç»™åŒ¿åç»“æ„ä½“ä¸­çš„å±æ€§èµ‹å€¼ï¼Œå€¼æ˜¯å…¥å‚ //\tformæ ¼å¼ä½¿ç”¨ctx.Bindæ–¹æ³•ï¼Œjsonæ ¼å¼ä½¿ç”¨ctx.ShouldBindJSONæ–¹æ³• if err := c.ShouldBind(params); err != nil { logger.Error(\u0026#34;Bindè¯·æ±‚å‚æ•°å¤±è´¥,\u0026#34; + err.Error()) // ctx.JSONæ–¹æ³•ç”¨äºè¿”å›å“åº”å†…å®¹ï¼Œå…¥å‚æ˜¯çŠ¶æ€ç å’Œå“åº”å†…å®¹ï¼Œå“åº”å†…å®¹æ”¾å…¥gin.Hçš„mapä¸­ c.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } // è·å–k8sçš„è¿æ¥æ–¹å¼ client, err := service.K8s.GetClient(params.Cluster) if err != nil { logger.Error(\u0026#34;è·å–k8sè¿æ¥å¤±è´¥,\u0026#34; + err.Error()) c.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } //serviceä¸­çš„çš„æ–¹æ³•é€šè¿‡ åŒ…å.ç»“æ„ä½“å˜é‡å.æ–¹æ³•å ä½¿ç”¨ï¼Œserivce.Pod.GetPods() pods, err := service.Pod.GetPods(client, params.FilterName, params.Namespace, params.Limit, params.Page) if err != nil { logger.Error(\u0026#34;è·å–podåˆ—è¡¨å¤±è´¥,\u0026#34; + err.Error()) c.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } c.JSON(http.StatusOK, gin.H{ \u0026#34;msg\u0026#34;: \u0026#34;è·å–podåˆ—è¡¨æˆåŠŸ\u0026#34;, \u0026#34;data\u0026#34;: pods, }) } // GetPodDetail è·å–podè¯¦æƒ… func (p *pod) GetPodDetail(cxt *gin.Context) { params := new(struct { Namespace string `form:\u0026#34;namespace\u0026#34;` PodName string `form:\u0026#34;pod_name\u0026#34;` Cluster string `form:\u0026#34;cluster\u0026#34;` }) if err := cxt.ShouldBind(params); err != nil { logger.Error(\u0026#34;Bindè¯·æ±‚å‚æ•°å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } client, err := service.K8s.GetClient(params.Cluster) if err != nil { logger.Error(\u0026#34;è·å–k8sè¿æ¥å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } data, err := service.Pod.GetPodDetail(client, params.Namespace, params.PodName) if err != nil { logger.Error(\u0026#34;è·å–podè¯¦æƒ…å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } cxt.JSON(http.StatusOK, gin.H{ \u0026#34;msg\u0026#34;: \u0026#34;è·å–podè¯¦æƒ…æˆåŠŸ\u0026#34;, \u0026#34;data\u0026#34;: data, }) } // DeletePod åˆ é™¤pod func (p *pod) DeletePod(cxt *gin.Context) { params := new(struct { Namespace string `form:\u0026#34;namespace\u0026#34;` PodName string `form:\u0026#34;pod_name\u0026#34;` Cluster string `form:\u0026#34;cluster\u0026#34;` }) if err := cxt.ShouldBind(params); err != nil { logger.Error(\u0026#34;Bindè¯·æ±‚å‚æ•°å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } client, err := service.K8s.GetClient(params.Cluster) if err != nil { logger.Error(\u0026#34;è·å–k8sè¿æ¥å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } if err := service.Pod.DeletePod(client, params.Namespace, params.PodName); err != nil { logger.Error(\u0026#34;åˆ é™¤podå¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } cxt.JSON(http.StatusOK, gin.H{ \u0026#34;msg\u0026#34;: \u0026#34;åˆ é™¤podæˆåŠŸ\u0026#34;, \u0026#34;data\u0026#34;: nil, }) } // UpdatePod æ›´æ–°pod func (p *pod) UpdatePod(cxt *gin.Context) { params := new(struct { Namespace string `form:\u0026#34;namespace\u0026#34;` PodName string `form:\u0026#34;pod_name\u0026#34;` Content string `form:\u0026#34;content\u0026#34;` Cluster string `form:\u0026#34;cluster\u0026#34;` }) //PUTè¯·æ±‚ï¼Œç»‘å®šå‚æ•°æ–¹æ³•æ”¹ä¸ºctx.ShouldBindJSON if err := cxt.ShouldBindJSON(params); err != nil { logger.Error(\u0026#34;Bindè¯·æ±‚å‚æ•°å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } client, err := service.K8s.GetClient(params.Cluster) if err != nil { logger.Error(\u0026#34;è·å–k8sè¿æ¥å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } if err := service.Pod.UpdatePod(client, params.Namespace, params.PodName, params.Content); err != nil { logger.Error(\u0026#34;æ›´æ–°podå¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } cxt.JSON(http.StatusOK, gin.H{ \u0026#34;msg\u0026#34;: \u0026#34;æ›´æ–°podæˆåŠŸ\u0026#34;, \u0026#34;data\u0026#34;: nil, }) } // GetPodContainer è·å–podå®¹å™¨ func (p *pod) GetPodContainer(cxt *gin.Context) { params := new(struct { Namespace string `form:\u0026#34;namespace\u0026#34;` PodName string `form:\u0026#34;pod_name\u0026#34;` Cluster string `form:\u0026#34;cluster\u0026#34;` }) // GETè¯·æ±‚ï¼Œç»‘å®šå‚æ•°æ–¹æ³•æ”¹ä¸ºctx.Bind if err := cxt.Bind(params); err != nil { logger.Error(\u0026#34;Bindè¯·æ±‚å‚æ•°å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } client, err := service.K8s.GetClient(params.Cluster) if err != nil { logger.Error(\u0026#34;è·å–k8sè¿æ¥å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } containers, err := service.Pod.GetPodContainer(client, params.Namespace, params.PodName) if err != nil { logger.Error(\u0026#34;è·å–podå®¹å™¨å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } cxt.JSON(http.StatusOK, gin.H{ \u0026#34;msg\u0026#34;: \u0026#34;è·å–podå®¹å™¨æˆåŠŸ\u0026#34;, \u0026#34;data\u0026#34;: containers, }) } // GetPodLog è·å–podä¸­å®¹å™¨æ—¥å¿— func (p *pod) GetPodLog(cxt *gin.Context) { params := new(struct { Namespace string `form:\u0026#34;namespace\u0026#34;` PodName string `form:\u0026#34;pod_name\u0026#34;` ContainerName string `form:\u0026#34;container_name\u0026#34;` Cluster string `form:\u0026#34;cluster\u0026#34;` }) // GETè¯·æ±‚ï¼Œç»‘å®šå‚æ•°æ–¹æ³•æ”¹ä¸ºctx.Bind if err := cxt.Bind(params); err != nil { logger.Error(\u0026#34;Bindè¯·æ±‚å‚æ•°å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } client, err := service.K8s.GetClient(params.Cluster) if err != nil { logger.Error(\u0026#34;è·å–k8sè¿æ¥å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } log, err := service.Pod.GetPodLog(client, params.Namespace, params.PodName, params.ContainerName) if err != nil { logger.Error(\u0026#34;è·å–podæ—¥å¿—å¤±è´¥,\u0026#34; + err.Error()) cxt.JSON(http.StatusInternalServerError, gin.H{ \u0026#34;msg\u0026#34;: err.Error(), \u0026#34;data\u0026#34;: nil, }) return } cxt.JSON(http.StatusOK, gin.H{ \u0026#34;msg\u0026#34;: \u0026#34;è·å–podæ—¥å¿—æˆåŠŸ\u0026#34;, \u0026#34;data\u0026#34;: log, }) } APIè®¾è®¡ä¸è·¯ç”± åœ¨router.goä¸­å®šä¹‰äº†æ¸…æ™°çš„APIè·¯ç”±ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (*router) InitApiRouter(r *gin.Engine) { r.GET(\u0026#34;/api/ping\u0026#34;, func(c *gin.Context) { c.JSON(200, gin.H{\u0026#34;message\u0026#34;: \u0026#34;pong\u0026#34;}) }) // Pod è·¯ç”±æœåŠ¡ podGroup := r.Group(apiBasePath) { podGroup.GET(\u0026#34;/pod\u0026#34;, Pod.GetPods) // è·å–Podåˆ—è¡¨ podGroup.GET(\u0026#34;/pod/detail\u0026#34;, Pod.GetPodDetail) // è·å–Podè¯¦æƒ… podGroup.DELETE(\u0026#34;/pod/del\u0026#34;, Pod.DeletePod) // åˆ é™¤Pod podGroup.PUT(\u0026#34;/pod/update\u0026#34;, Pod.UpdatePod) // æ›´æ–°Pod podGroup.GET(\u0026#34;/pod/container\u0026#34;, Pod.GetPodContainer) // è·å–å®¹å™¨åˆ—è¡¨ podGroup.GET(\u0026#34;/pod/log\u0026#34;, Pod.GetPodLog) // è·å–å®¹å™¨æ—¥å¿— } } APIè®¾è®¡éµå¾ªRESTfulè§„èŒƒï¼Œä½¿ç”¨åˆé€‚çš„HTTPæ–¹æ³•(GET/POST/PUT/DELETE)å¯¹åº”ä¸åŒçš„æ“ä½œç±»å‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package controller import \u0026#34;github.com/gin-gonic/gin\u0026#34; /** * @Author: å—å®«ä¹˜é£ * @Description: * @File: router.go * @Email: 1794748404@qq.com * @Date: 2025-03-17 17:18 */ // Router å®ä¾‹åŒ–å¯¹è±¡ï¼Œå¯ä»¥åœ¨main.goä¸­è°ƒç”¨ var Router router type router struct { } const apiBasePath = \u0026#34;/api/k8s\u0026#34; // InitRouter åˆå§‹åŒ–è·¯ç”± func (*router) InitApiRouter(r *gin.Engine) { r.GET(\u0026#34;/api/ping\u0026#34;, func(c *gin.Context) { c.JSON(200, gin.H{\u0026#34;message\u0026#34;: \u0026#34;pong\u0026#34;}) }) // Pod è·¯ç”±æœåŠ¡ podGroup := r.Group(apiBasePath) { podGroup.GET(\u0026#34;/pod\u0026#34;, Pod.GetPods) podGroup.GET(\u0026#34;/pod/detail\u0026#34;, Pod.GetPodDetail) podGroup.DELETE(\u0026#34;/pod/del\u0026#34;, Pod.DeletePod) podGroup.PUT(\u0026#34;/pod/update\u0026#34;, Pod.UpdatePod) podGroup.GET(\u0026#34;/pod/container\u0026#34;, Pod.GetPodContainer) podGroup.GET(\u0026#34;/pod/log\u0026#34;, Pod.GetPodLog) } } ä¼˜é›…å…³é—­ åœ¨main.goä¸­å®ç°äº†æœåŠ¡çš„ä¼˜é›…å…³é—­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // åˆ›å»ºä¿¡å·é€šé“ quit := make(chan os.Signal) signal.Notify(quit, os.Interrupt) \u0026lt;-quit // é˜»å¡ç­‰å¾…ä¸­æ–­ä¿¡å· // è®¾ç½®5ç§’è¶…æ—¶å…³é—­ ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second) defer cancel() // ä¼˜é›…å…³é—­æœåŠ¡å™¨ if err := srv.Shutdown(ctx); err != nil { logger.Error(\u0026#34;Gin Server Shutdown:\u0026#34;, err) } logger.Info(\u0026#34;Gin Server exiting\u0026#34;) å®Œæ•´ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 package main import ( \u0026#34;context\u0026#34; \u0026#34;kubea-go/config\u0026#34; \u0026#34;kubea-go/controller\u0026#34; \u0026#34;kubea-go/service\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;os\u0026#34; \u0026#34;os/signal\u0026#34; \u0026#34;time\u0026#34; \u0026#34;github.com/aryming/logger\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; ) /** * @Author: å—å®«ä¹˜é£ * @Description: * @File: main.go * @Email: 1794748404@qq.com * @Date: 2025-03-17 14:49 */ func main() { logger.SetLogger(\u0026#34;config/log.json\u0026#34;) // åˆå§‹åŒ–è·¯ç”± r := gin.Default() // åˆå§‹åŒ–K8Så®¢æˆ·ç«¯ service.K8s.Init() controller.Router.InitApiRouter(r) // å¯åŠ¨æœåŠ¡ srv := \u0026amp;http.Server{ Addr: config.ListenAddress, Handler: r, } go func() { // service connections if err := srv.ListenAndServe(); err != nil \u0026amp;\u0026amp; err != http.ErrServerClosed { logger.Error(\u0026#34;listen: %s\\n\u0026#34;, err) } }() //ä¼˜é›…å…³é—­ // å£°æ˜ä¸€ä¸ªç³»ç»Ÿä¿¡å·çš„channelï¼Œå¹¶ç›‘å¬ç³»ç»Ÿä¿¡å·ï¼Œå¦‚æœæ²¡æœ‰ä¿¡å·ï¼Œå°±ä¸€ç›´é˜»å¡ï¼Œå¦‚æœæœ‰ï¼Œå°±ç»§ç»­æ‰§è¡Œã€‚å½“æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ï¼Œæ‰§è¡Œcancel() // åˆ›å»ºä¸€ä¸ªç”¨äºæ¥æ”¶OSä¿¡å·çš„é€šé“ quit := make(chan os.Signal) // é…ç½®ä¿¡å·é€šçŸ¥ï¼Œå°†OSä¸­æ–­ä¿¡å·é€šçŸ¥åˆ°quité€šé“ signal.Notify(quit, os.Interrupt) // é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°ä»quité€šé“æ¥æ”¶åˆ°ä¿¡å· \u0026lt;-quit // è®¾ç½®ä¸Šä¸‹æ–‡å¯¹è±¡ctxï¼Œå¸¦æœ‰5ç§’çš„è¶…æ—¶ ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second) // å½“å‡½æ•°è¿”å›æ—¶ï¼Œè°ƒç”¨cancelä»¥å–æ¶ˆä¸Šä¸‹æ–‡å¹¶é‡Šæ”¾èµ„æº defer cancel() // å°è¯•ä¼˜é›…å…³é—­GINæœåŠ¡å™¨ if err := srv.Shutdown(ctx); err != nil { // å¦‚æœå…³é—­å¤±è´¥ï¼Œè®°å½•è‡´å‘½é”™è¯¯ logger.Error(\u0026#34;Gin Server Shutdown:\u0026#34;, err) } // è®°å½•æœåŠ¡å™¨é€€å‡ºä¿¡æ¯ logger.Info(\u0026#34;Gin Server exiting\u0026#34;) } é…ç½®ç®¡ç† é…ç½®ä¿¡æ¯é›†ä¸­åœ¨config.goä¸­ç®¡ç†ï¼š\n1 2 3 4 5 6 const ( ListenAddress = \u0026#34;0.0.0.0:8081\u0026#34; // æœåŠ¡ç›‘å¬åœ°å€ // å¤šé›†ç¾¤kubeconfigé…ç½® Kubeconfigs = `{\u0026#34;TST-1\u0026#34;:\u0026#34;E:\\\\GitHUB_Code_Check\\\\VUE\\\\kubea-go\\\\config\\\\k8s.yaml\u0026#34;,\u0026#34;TST-2\u0026#34;:\u0026#34;E:\\\\GitHUB_Code_Check\\\\VUE\\\\kubea-go\\\\config\\\\k8s.yaml\u0026#34;}` PodLogTailLine = 500 // æ—¥å¿—é»˜è®¤è¿”å›è¡Œæ•° ) ","date":"2025-03-26T15:11:01Z","image":"https://www.ownit.top/title_pic/52.jpg","permalink":"https://www.ownit.top/p/202503261511/","title":"åŸºäºGoè¯­è¨€å’ŒKubernetesçš„å¤šé›†ç¾¤ç®¡ç†å¹³å°å¼€å‘å®è·µ"},{"content":"ä¸€ç¯‡å…³äº Vue3 é¡¹ç›®æ­å»ºçš„åšå®¢æ–‡ç« ã€‚ä¸‹é¢çš„ç¤ºä¾‹åŒ…å«äº†ä»¥ä¸‹å†…å®¹ï¼š\nä½¿ç”¨ Vue CLI åˆ›å»ºé¡¹ç›® å®‰è£…å¹¶ä½¿ç”¨ axios è¿›è¡Œ API è¯·æ±‚ é…ç½® vue-router å®ç°è·¯ç”±è·³è½¬ å…¨å±€å¼•å…¥ ant-design-vue ç»„ä»¶åº“ Vue Cliè„šæ‰‹æ¶ä½¿ç”¨ Vue CLI æ˜¯ä¸€ä¸ªåŸºäº Vue.js è¿›è¡Œå¿«é€Ÿå¼€å‘çš„å®Œæ•´ç³»ç»Ÿ\né…ç½®npmæ·˜å®æºï¼ˆé»˜è®¤å›½å¤–æºï¼Œä¸‹è½½ä¾èµ–è¾ƒæ…¢ï¼‰\n1 2 3 4 5 #è®¾ç½®æ·˜å®æº npm config set registry https://registry.npm.taobao.org --global #æŸ¥çœ‹æº npm config get registry 1 2 3 4 5 6 å‘½ä»¤å®‰è£…: npm install -g @vue/cli@4.5.12 æ£€æŸ¥ç‰ˆæœ¬: vue -V åˆ›å»ºé¡¹ç›®: vue create \u0026lt;é¡¹ç›®åç§°\u0026gt; é€‰æ‹©Vue3é¡¹ç›® è¿è¡Œé¡¹ç›®: npm run serve è®¿é—® åˆ›å»ºé¡¹ç›® é¦–å…ˆä½¿ç”¨ Vue CLI åˆ›å»ºé¡¹ç›®ï¼ˆé»˜è®¤ç”Ÿæˆ Vue3 ç‰ˆæœ¬ï¼‰ï¼š\n1 vue create vue-demo è¿›å…¥é¡¹ç›®ç›®å½•åï¼Œå®‰è£…æ‰€éœ€çš„ä¾èµ–åŒ…ï¼š\n1 npm install axios vue-router ant-design-vue Axios ä»‹ç»ä½¿ç”¨ å®˜æ–¹æ–‡æ¡£: http://www.axios-js.com/zh-cn/docs/ åœ¨å‰ç«¯é¡µé¢å±•ç¤ºçš„æ•°æ®å¤§å¤šæ•°éƒ½æ˜¯é€šè¿‡è®¿é—®ä¸€ä¸ªAPIè·å–çš„ï¼Œåšè¿™ä»¶äº‹çš„æ–¹æ³•æœ‰å¥½å‡ ç§ï¼Œä¾‹å¦‚ jquery ajaxã€vue-resourceã€axiosï¼Œè€Œvue-resourceæ˜¯vueæ’ä»¶ï¼Œä½†3ç‰ˆæœ¬ä¸å†æ›´æ–°ï¼Œç›®å‰å®˜æ–¹ æ¨èä¸»æµçš„axiosï¼Œaixosæ˜¯ä¸€ä¸ªhttpè¯·æ±‚åº“ã€‚\n1 2 3 4 5 å®‰è£…axios: npm install axios åœ¨ç»„ä»¶ä¸­å¯¼å…¥å¹¶ä½¿ç”¨ import axios from \u0026#39;axios\u0026#39; GETè¯·æ±‚ ä½¿ç”¨ axios.getå‘èµ·GETè¯·æ±‚ã€‚ ä½¿ç”¨ .then è·å–å“åº”æ•°æ®ã€‚ ä½¿ç”¨catch å¼‚å¸¸å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;home\u0026#34;\u0026gt; \u0026lt;img alt=\u0026#34;Vue logo\u0026#34; src=\u0026#34;../assets/logo.png\u0026#34;/\u0026gt; \u0026lt;button type=\u0026#34;button\u0026#34; @click=\u0026#34;getData()\u0026#34;\u0026gt;è·å–åç«¯æ•°æ®\u0026lt;/button\u0026gt; {{ data }} \u0026lt;p v-if=\u0026#34;error\u0026#34; style=\u0026#34;color: red;\u0026#34;\u0026gt;è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼\u0026#34;\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script\u0026gt; // å¯¼å…¥è¯å®ä¾‹åŒ–å¯¹è±¡ // import axios from \u0026#34;axios\u0026#34; import axios from \u0026#34;axios\u0026#34; import {onMounted, ref} from \u0026#34;vue\u0026#34; export default { setup() { const data = ref(\u0026#39;\u0026#39;) const error = ref(false) function getData() { axios.get(\u0026#39;http://httpbin.org/get\u0026#39;) .then(res =\u0026gt; { data.value = res.data console.log(res) }).catch(res =\u0026gt; { error.value = true console.log(res) }) } // ç”Ÿå‘½å‘¨æœŸé’©å­ onMounted(() =\u0026gt; { getData() console.log(\u0026#39;æŒ‚è½½å®Œæˆ\u0026#39;) }) return { error, getData, data } } } \u0026lt;/script\u0026gt; POSTæäº¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;home\u0026#34;\u0026gt; \u0026lt;img alt=\u0026#34;Vue logo\u0026#34; src=\u0026#34;../assets/logo.png\u0026#34;/\u0026gt; \u0026lt;h1\u0026gt;æ¬¢è¿è®¿é—®ç®¡ç†åå°\u0026lt;/h1\u0026gt; \u0026lt;form action=\u0026#34;#\u0026#34;\u0026gt; ç”¨æˆ·åï¼š\u0026lt;input type=\u0026#34;text\u0026#34; v-model=\u0026#34;form.username\u0026#34;/\u0026gt; å¯†ç ï¼š\u0026lt;input type=\u0026#34;password\u0026#34; v-model=\u0026#34;form.password\u0026#34;/\u0026gt; \u0026lt;button @click=\u0026#34;loginBtn\u0026#34;\u0026gt;ç™»å½•\u0026lt;/button\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;p style=\u0026#34;color: red;\u0026#34; v-if=\u0026#34;notice\u0026#34;\u0026gt;ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º\u0026#34;\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script\u0026gt; import axios from \u0026#34;axios\u0026#34; import {ref, reactive} from \u0026#34;vue\u0026#34;; export default { name: \u0026#34;Home\u0026#34;, setup() { const form = reactive({ username: \u0026#39;\u0026#39;, password: \u0026#39;\u0026#39; }) const notice = ref(false) function loginBtn() { if (form.username === \u0026#39;\u0026#39; || form.password === \u0026#39;\u0026#39;) { notice.value = true } else { axios.post(\u0026#39;http://httpbin.org/post\u0026#39;, form).then(res =\u0026gt; { console.log(res) }) } } return { form, notice, loginBtn } } } \u0026lt;/script\u0026gt; è‡ªå®šä¹‰å®ä¾‹ è‡ªå®šä¹‰å®ä¾‹é»˜é»˜è®¤å€¼è®¤å€¼ æœ‰æ—¶å€™æœåŠ¡ç«¯æ¥å£æœ‰å¤šä¸ªåœ°å€ï¼Œå°±ä¼šæ¶‰åŠè¯·æ±‚çš„åŸŸåä¸åŒã€é…ç½®ä¸åŒç­‰ï¼Œè¿™æ—¶è‡ªå®šä¹‰å®ä¾‹å¯ä»¥å¾ˆå¥½è§£å†³ã€‚\nåˆ›å»ºsrc/request/index.jsæ–‡ä»¶ï¼Œå®šä¹‰å®ä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 import axios from \u0026#34;axios\u0026#34;; const instance = axios.create({ baseURL: \u0026#34;https://httpbin.org\u0026#34;, timeout: 1000, // headers: { \u0026#39;X-Custom-Header\u0026#39;: \u0026#39;foobar\u0026#39; } }); // æ‹¦æˆªå™¨ ï¼Œè¯·æ±‚æ‹¦æˆª instance.interceptors.request.use( config =\u0026gt; { // åœ¨å‘é€è¯·æ±‚ä¹‹å‰åšäº›ä»€ä¹ˆ config.headers[\u0026#39;Test-Header\u0026#39;] = \u0026#39;123456\u0026#39; return config; }, error =\u0026gt; { // å¯¹è¯·æ±‚é”™è¯¯åšäº›ä»€ä¹ˆ return Promise.reject(error); } ); // æ‹¦æˆªå™¨ ï¼Œå“åº”æ‹¦æˆª instance.interceptors.response.use( response =\u0026gt; { // å¯¹å“åº”æ•°æ®åšç‚¹ä»€ä¹ˆ return response; }, error =\u0026gt; { // å¯¹å“åº”é”™è¯¯åšç‚¹ä»€ä¹ˆ return Promise.reject(error); } ); export default instance; 1 2 3 4 5 6 æ‹¦æˆªå™¨å¯ä»¥æ‹¦æˆªæ¯ä¸€æ¬¡è¯·æ±‚å’Œå“åº”ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ è¯·æ±‚æ‹¦æˆªåº”ç”¨åœºæ™¯ï¼š å‘èµ·è¯·æ±‚å‰æ·»åŠ header å“åº”æ‹¦æˆªåº”ç”¨åœºæ™¯ï¼š ç»Ÿä¸€å¤„ç†APIå“åº”çŠ¶æ€ç 200æˆ–é200çš„æç¤ºæ¶ˆæ¯ ç»Ÿä¸€å¤„ç†catchå¼‚å¸¸æç¤ºä¿¡æ¯ Vueè·¯ç”±è·¯ç”±ï¼šVue Router Vue Routerä½¿ç”¨ Vue Router æ˜¯ Vue.js (opens new window)å®˜æ–¹çš„è·¯ç”±ç®¡ç†å™¨ã€‚\nå®‰è£…\n1 npm install vue-router åˆ›å»ºsrc/router/index.jsæ–‡ä»¶åŠç›®å½•ï¼Œä¹‹åå‰ç«¯çš„è·¯ç”±éƒ½å°†ç»´æŠ¤åœ¨æ­¤æ–‡ä»¶ä¸­\nä½¿ç”¨æµç¨‹\nå¼€å‘é¡µé¢ï¼ˆç»„ä»¶ï¼‰ å®šä¹‰è·¯ç”±ï¼Œsrc/router/index.js\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 import { createRouter, createWebHistory } from \u0026#34;vue-router\u0026#34;; // å¼•å…¥ç»„ä»¶ï¼Œä¸€å¼€æ˜¯å°±ä¼šå¼•å…¥ï¼Œå³ä½¿ä¸è¿›å…¥é¡µé¢ï¼Œä¹Ÿä¼šåŠ è½½ç»„ä»¶ import Home from \u0026#34;@/views/Home.vue\u0026#34;; const routes = [ { path: \u0026#34;/home\u0026#34;, name: \u0026#34;Home\u0026#34;, component: Home, }, { path: \u0026#34;/about\u0026#34;, name: \u0026#34;About\u0026#34;, // å¼•å…¥ç»„ä»¶ï¼Œæ‡’åŠ è½½ï¼Œåªæœ‰åœ¨æ‰“å¼€é¡µé¢çš„æ—¶å€™æ‰ä¼šåŠ è½½ component: () =\u0026gt; import(\u0026#34;@/views/About.vue\u0026#34;), }, { path: \u0026#34;/login\u0026#34;, name: \u0026#34;Login\u0026#34;, // å¼•å…¥ç»„ä»¶ï¼Œæ‡’åŠ è½½ï¼Œåªæœ‰åœ¨æ‰“å¼€é¡µé¢çš„æ—¶å€™æ‰ä¼šåŠ è½½ component: () =\u0026gt; import(\u0026#34;@/views/Login.vue\u0026#34;), }, ]; // åˆ›å»ºä¸€ä¸ªè·¯ç”±å®ä¾‹ const router = createRouter({ // ä½¿ç”¨åŸºäºhashçš„è·¯ç”±å†å²æ¨¡å¼ history: createWebHistory(), // å®šä¹‰è·¯ç”±é…ç½®æ•°ç»„ routes: routes, // é…ç½®è·¯ç”±æ¨¡å¼ mode: \u0026#34;history\u0026#34;, }); // å¯¼å‡ºè·¯ç”±å®ä¾‹ä»¥ä¾¿åœ¨å…¶ä»–æ¨¡å—ä¸­ä½¿ç”¨ export default router; ç»„ä»¶ä½¿ç”¨è·¯ç”±ï¼Œsrc/App.vue\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;template\u0026gt; \u0026lt;img alt=\u0026#34;Vue logo\u0026#34; src=\u0026#34;./assets/logo.png\u0026#34;\u0026gt; \u0026lt;div\u0026gt; \u0026lt;!-- ä½¿ç”¨router-linkç»„ä»¶æ¥å¯¼èˆª --\u0026gt; \u0026lt;!-- é€šè¿‡ä¼ å…¥ to å±æ€§åˆ¶å®šé“¾æ¥ --\u0026gt; \u0026lt;!-- router-link é»˜è®¤ä¼šè¢«æ¸²æŸ“æˆä¸€ä¸ªaæ ‡ç­¾ --\u0026gt; \u0026lt;router-link to=\u0026#34;/home\u0026#34;\u0026gt;Home\u0026lt;/router-link\u0026gt; \u0026lt;br\u0026gt; \u0026lt;router-link to=\u0026#34;/about\u0026#34;\u0026gt;About\u0026lt;/router-link\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;!-- è·¯ç”±å ä½ç¬¦ï¼Œè·¯ç”±åŒ¹é…åˆ°çš„ç»„ä»¶éƒ½ä¼šåœ¨è¿™é‡Œå±•ç¤º --\u0026gt; \u0026lt;router-view /\u0026gt; \u0026lt;/template\u0026gt; src/main.jsç§å¯¼å…¥router\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // {} å¯¼å…¥çš„æ˜¯ç»„ä»¶çš„æ–¹æ³• import { createApp } from \u0026#39;vue\u0026#39; // å¯¼å…¥ç»„ä»¶çš„åˆ«å import App from \u0026#39;./App.vue\u0026#39; // @ è¡¨ç¤º src ç›®å½• import Test from \u0026#39;@/components/Test.vue\u0026#39; const app = createApp(App) // æ³¨å†Œå…¨å±€ç»„ä»¶ app.component(\u0026#39;Test1\u0026#39;, Test) import router from \u0026#39;./router\u0026#39; app.use(router) app.mount(\u0026#39;#app\u0026#39;) // createApp(App).mount(\u0026#39;#app\u0026#39;) è·¯ç”±ä¼ å‚ URLä¼ å‚ï¼šä¸€èˆ¬ç”¨äºé¡µé¢è·³è½¬ï¼Œå°†å½“å‰æ•°æ®ä¼ é€’åˆ°æ–°é¡µé¢ï¼Œä¾‹å¦‚è¯¦æƒ…é¡µ paramsä¼ å‚ï¼š\n1 2 3 4 é…ç½®è·¯ç”±: {path: \u0026#39;/user/:id\u0026#39;, component: about} ä¼ é€’æ–¹å¼ï¼š\u0026lt;router-link :to=\u0026#34;/user/6\u0026#34;\u0026gt;\u0026lt;/router-link\u0026gt; ä¼ é€’åè·¯å¾„: /user/6 æ¥å—å‚æ•°æ³•ï¼š$route.params.id queryä¼ å‚\n1 2 3 4 é…ç½®è·¯ç”±: {path: \u0026#39;/user/\u0026#39;, component: about} ä¼ é€’æ–¹å¼ï¼š\u0026lt;router-link :to=\u0026#34;{path: \u0026#39;/about\u0026#39;,query:{id:6}}\u0026#34;\u0026gt;\u0026lt;/router-link\u0026gt; ä¼ é€’åè·¯å¾„: /user?id=6 æ¥å—å‚æ•°æ³•ï¼š$route.query.id è·¯ç”±å®ˆå« æ­£å¦‚å…¶åï¼Œvue-router æä¾›çš„å¯¼èˆªå®ˆå«ä¸»è¦ç”¨æ¥é€šè¿‡è·³è½¬æˆ–å–æ¶ˆçš„æ–¹å¼å®ˆå«å¯¼èˆªã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åœ¨è·¯ç”±è·³è½¬æ—¶å€™çš„ä¸€äº›é’©å­ï¼Œå½“ä»ä¸€ä¸ªé¡µé¢è·³è½¬åˆ°å¦ä¸€ä¸ªé¡µé¢æ—¶ï¼Œå¯ä»¥åœ¨è·³è½¬å‰ã€ä¸­ã€ååšä¸€äº›äº‹æƒ…ã€‚\næ¯ä¸ªæ”¶å°¾æ–¹æ³•æ¥æ”¶å‚æ•°ï¼š\ntopï¼š å³å°†è¦è¿›å…¥çš„ç›®æ ‡ï¼Œæ˜¯ä¸€ä¸ªè·¯ç”±å¯¹è±¡ fromï¼šå½“å‰å¯¼èˆªæ­£è¦ç¦»å¼€çš„è·¯ç”±ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè·¯ç”±å¯¹è±¡ nextï¼šå¯é€‰ï¼Œæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ªè·¯ç”± ä½ å¯ä»¥ä½¿ç”¨ router.beforeEach æ³¨å†Œä¸€ä¸ªå…¨å±€å‰ç½®å®ˆå«ï¼Œå½“ä¸€ä¸ªå¯¼èˆªè§¦å‘æ—¶ï¼Œå°±ä¼šå¼‚æ­¥æ‰§è¡Œè¿™ä¸ªå›è°ƒå‡½æ•°ã€‚\n1 2 3 4 5 6 7 const router = createRouter ({ ..... // æ·»åŠ å…¨å±€å‰ç½®è·¯ç”±å®ˆå« router.befoEach((to,from) \u0026#34;) { // è¿™é‡Œæ‰§è¡Œå…·ä½“æ“ä½œ console.log(to) console.log(from) }) åœ¨ç½‘ç«™å¼€å‘ä¸­ï¼Œä½¿ç”¨å¯¼èˆªå®ˆå«ä¸€ä¸ªæ™®ééœ€æ±‚ï¼šç™»å½•éªŒè¯ï¼Œï¼Œå³åœ¨æ²¡æœ‰ç™»å½•çš„æƒ…å†µä¸‹ï¼Œè®¿é—®ä»»ä½•é¡µé¢éƒ½è·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 router.beforeEach((to, from, next) =\u0026gt; { // æ·»åŠ å…¨å±€å‰ç½®å¯¼èˆªå®ˆå« // ... console.log(to); console.log(from); if (to.path === \u0026#34;/login\u0026#34;) { return next(); } const token = \u0026#34;\u0026#34; //æ¨¡æ‹Ÿtokenï¼Œæ­£å¸¸æ˜¯ä»æœ¬åœ°cookieæˆ–localstorageä¸­è·å– if (token) { return next(); // å¦‚æœæœ‰tokenï¼Œåˆ™æ­£å¸¸è·³è½¬è®¿é—® } else { return next(\u0026#34;/login\u0026#34;); // å¦‚æœæ²¡æœ‰tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µ } }); å®Œæ•´ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 import { createRouter, createWebHistory } from \u0026#34;vue-router\u0026#34;; // å¼•å…¥ç»„ä»¶ï¼Œä¸€å¼€æ˜¯å°±ä¼šå¼•å…¥ï¼Œå³ä½¿ä¸è¿›å…¥é¡µé¢ï¼Œä¹Ÿä¼šåŠ è½½ç»„ä»¶ import Home from \u0026#34;@/views/Home.vue\u0026#34;; const routes = [ { path: \u0026#34;/home\u0026#34;, name: \u0026#34;Home\u0026#34;, component: Home, }, { path: \u0026#34;/about\u0026#34;, name: \u0026#34;About\u0026#34;, // å¼•å…¥ç»„ä»¶ï¼Œæ‡’åŠ è½½ï¼Œåªæœ‰åœ¨æ‰“å¼€é¡µé¢çš„æ—¶å€™æ‰ä¼šåŠ è½½ component: () =\u0026gt; import(\u0026#34;@/views/About.vue\u0026#34;), }, { path: \u0026#34;/login\u0026#34;, name: \u0026#34;Login\u0026#34;, // å¼•å…¥ç»„ä»¶ï¼Œæ‡’åŠ è½½ï¼Œåªæœ‰åœ¨æ‰“å¼€é¡µé¢çš„æ—¶å€™æ‰ä¼šåŠ è½½ component: () =\u0026gt; import(\u0026#34;@/views/Login.vue\u0026#34;), }, ]; // åˆ›å»ºä¸€ä¸ªè·¯ç”±å®ä¾‹ const router = createRouter({ // ä½¿ç”¨åŸºäºhashçš„è·¯ç”±å†å²æ¨¡å¼ history: createWebHistory(), // å®šä¹‰è·¯ç”±é…ç½®æ•°ç»„ routes: routes, // é…ç½®è·¯ç”±æ¨¡å¼ mode: \u0026#34;history\u0026#34;, }); router.beforeEach((to, from, next) =\u0026gt; { // æ·»åŠ å…¨å±€å‰ç½®å¯¼èˆªå®ˆå« // ... console.log(to); console.log(from); if (to.path === \u0026#34;/login\u0026#34;) { return next(); } const token = \u0026#34;\u0026#34; if (token) { return next(); } else { return next(\u0026#34;/login\u0026#34;); } }); // å¯¼å‡ºè·¯ç”±å®ä¾‹ä»¥ä¾¿åœ¨å…¶ä»–æ¨¡å—ä¸­ä½¿ç”¨ export default router; Ant Design ä½¿ç”¨ Element UI å®ƒæ˜¯ç”±é¥¿äº†ä¹ˆå‰ç«¯å›¢é˜Ÿæ¨å‡ºçš„åŸºäº Vue å°è£…çš„ UI ç»„ä»¶åº“ï¼Œæä¾›PC ç«¯ç»„ä»¶ï¼Œç®€åŒ–äº†å¸¸ç”¨ç»„ä»¶çš„å°è£…ï¼Œé™ä½å¼€å‘éš¾åº¦ã€‚ Ant Design æ˜¯ä¸€å¥—ä¼ä¸šçº§ UI è®¾è®¡è¯­è¨€å’Œ React ç»„ä»¶åº“ï¼Œæä¾›äº†ä¸€å¥—éå¸¸å®Œæ•´çš„ç»„ä»¶åŒ–è®¾è®¡è§„èŒƒä¸ç»„ä»¶åŒ–ç¼–ç è§„èŒƒï¼Œèƒ½å¤§å¹…æé«˜äº†éƒ¨åˆ†äº§å“çš„è®¾è®¡ç ”å‘æ•ˆç‡åŠè´¨é‡ã€‚ ç»„ä»¶åº“æ–‡æ¡£ï¼šhttps://antdv.com/components/overview-cn å®‰è£…\n1 npm install ant-design-vue å…¨å±€æ³¨å†Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import { createApp } from \u0026#39;vue\u0026#39; import App from \u0026#39;./App.vue\u0026#39; // å¼•å…¥antdå’Œä¸»é¢˜æ ·å¼ import \u0026#39;ant-design-vue/dist/reset.css\u0026#39;; import Antd from \u0026#39;ant-design-vue\u0026#39; // å…¨å±€å¼•å…¥antdå›¾æ ‡ import * as Icons from \u0026#39;@ant-design/icons-vue\u0026#39;; const app = createApp(App) // å…¨å±€å¼•å…¥antdå›¾æ ‡, iæ˜¯ç»„ä»¶åã€‚Icons[i]æ˜¯å…·ä½“çš„ç»„ä»¶ for (const i in Icons) { app.component(i, Icons[i]) } import router from \u0026#39;./router\u0026#39; app.use(router) // å…¨å±€å¼•å…¥antd app.use(Antd) app.mount(\u0026#39;#app\u0026#39;) // createApp(App).mount(\u0026#39;#app\u0026#39;) è·¯ç”±é¡µé¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import {createRouter,createWebHistory} from \u0026#34;vue-router\u0026#34;; const routes = [ { path:\u0026#34;/btn\u0026#34;, component:( ) =\u0026gt; import(\u0026#34;@/view/test/btn.vue\u0026#34;) } ] const router = createRouter({ history:createWebHistory(), routes }) export default router; ä½¿ç”¨\u0026lt; router-view /\u0026gt; ï¼Œå®šä¹‰è·¯ç”±å ä½\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // src/App.vue \u0026lt;template\u0026gt; \u0026lt;!-- è·¯ç”±å ä½ç¬¦ --\u0026gt; \u0026lt;template\u0026gt; \u0026lt;!-- è·¯ç”±å ä½ç¬¦--\u0026gt; \u0026lt;router-view/\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;!--è¿™é‡Œæ˜¯å…¨å±€çš„cssæ•ˆæœ--\u0026gt; \u0026lt;style\u0026gt; #app { /* 100%çš„çª—å£å®½å’Œé«˜ */ width: 100%; height: 100%; } \u0026lt;/style\u0026gt; ä½¿ç”¨ä¸€ä¸ªantdçš„æŒ‰é’®ç»„ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026lt;script setup\u0026gt; \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div style=\u0026#34;margin: 20px;text-align: center;\u0026#34;\u0026gt; \u0026lt;a-space wrap\u0026gt; \u0026lt;a-button type=\u0026#34;primary\u0026#34;\u0026gt;Primary Button\u0026lt;/a-button\u0026gt; \u0026lt;a-button\u0026gt;Default Button\u0026lt;/a-button\u0026gt; \u0026lt;a-button type=\u0026#34;dashed\u0026#34;\u0026gt;Dashed Button\u0026lt;/a-button\u0026gt; \u0026lt;a-button type=\u0026#34;text\u0026#34;\u0026gt;Text Button\u0026lt;/a-button\u0026gt; \u0026lt;a-button type=\u0026#34;link\u0026#34;\u0026gt;Link Button\u0026lt;/a-button\u0026gt; \u0026lt;/a-space\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;style scoped\u0026gt; .ant-btn { margin-right: 8px; margin-bottom: 20px; } \u0026lt;/style\u0026gt; æµè§ˆå™¨æ‰“å¼€localhost:8080/btn\nå¼€å‘ä¸å“åº”æµç¨‹ ","date":"2025-03-10T15:37:46Z","image":"https://www.ownit.top/title_pic/20.jpg","permalink":"https://www.ownit.top/p/202503101537/","title":"ä½¿ç”¨Vue CLIä»é›¶æ­å»ºä¼ä¸šçº§é¡¹ç›®å®æˆ˜ï¼ˆVue3+å…¨å®¶æ¡¶ï¼‰"},{"content":"é—®é¢˜ è¿‘æ—¥å…¬å¸æœ‰æœåŠ¡å†…å­˜æ³„éœ²å¯¼è‡´æœåŠ¡å‡æ­»ï¼Œå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚ç¬¬ä¸€æ—¶é—´æŸ¥çœ‹å¼‚å¸¸æ—¥å¿—ï¼Œå¹¶æœªå‘ç°ä»€ä¹ˆå¼‚å¸¸ï¼Œä½†æ˜¯è¿›å…¥podå‘ç°ç”Ÿæˆjava_pid1.hprofæ–‡ä»¶ã€‚å¹³å°çš„çº¿ä¸Šç¯å¢ƒå‡é…ç½®äº†jvmå‚æ•°ï¼Œåœ¨å‘ç”ŸOOMæ—¶ä¼šè‡ªåŠ¨dumpå‡ºå †è½¬å‚¨æ–‡ä»¶ï¼Œæ¥ä¸‹æ¥å°±è¦ä»dumpæ–‡ä»¶å…¥æ‰‹æ¥å®šä½é—®é¢˜äº†ã€‚\né¡¹ç›®èƒŒæ™¯ åœ¨Javaåº”ç”¨å¼€å‘ä¸­ï¼Œå†…å­˜æº¢å‡ºï¼ˆOut Of Memory, OOMï¼‰æ˜¯å¼€å‘è€…æœ€å¸¸é‡åˆ°çš„ä¸¥é‡é—®é¢˜ä¹‹ä¸€ã€‚OOMé€šå¸¸ç”±ä»¥ä¸‹åŸå› å¼•å‘ï¼š\nå†…å­˜åˆ†é…ä¸è¶³ï¼šJVMå †å†…å­˜è®¾ç½®è¿‡å°ï¼Œæ— æ³•åº”å¯¹é«˜å¹¶å‘æˆ–å¤æ‚ä¸šåŠ¡åœºæ™¯ã€‚ ä»£ç æ¼æ´ï¼šå¦‚å†…å­˜æ³„æ¼ï¼ˆå¯¹è±¡æ— æ³•è¢«GCå›æ”¶ï¼‰ã€å¤§å¯¹è±¡æœªé‡Šæ”¾ã€é›†åˆç±»æ»¥ç”¨ç­‰ã€‚ ç³»ç»Ÿçªç„¶çš„æµé‡å¢å¤§ï¼ŒåŸæœ‰çš„å¯ç”¨å†…å­˜ä¸è¶³ä»¥æ”¯æ’‘ç­‰ã€‚ å½“ç³»ç»Ÿçªå‘OOMæ—¶ï¼Œè‹¥ä»…ä¾èµ–æ—¥å¿—å®šä½é—®é¢˜ï¼Œå¾€å¾€éš¾ä»¥å¿«é€Ÿæ‰¾åˆ°æ ¹æºã€‚æ­¤æ—¶ï¼ŒJProfilerä½œä¸ºä¸€æ¬¾å¼ºå¤§çš„JVMæ€§èƒ½åˆ†æå·¥å…·ï¼Œèƒ½å¤Ÿé€šè¿‡å†…å­˜å¿«ç…§ï¼ˆDumpæ–‡ä»¶ï¼‰ç²¾å‡†å®šä½é—®é¢˜ä»£ç ï¼Œæˆä¸ºè§£å†³é—®é¢˜çš„å…³é”®ã€‚\nç¯å¢ƒ å®˜æ–¹ç½‘å€ï¼šhttps://www.ej-technologies.com/jprofiler/download92\nJDKç‰ˆæœ¬ï¼šJava 8+ï¼ˆæ¨èJDK 11åŠä»¥ä¸Šï¼Œæ”¯æŒæ›´å…¨é¢çš„è¯Šæ–­åŠŸèƒ½ï¼‰ã€‚ JProfilerç‰ˆæœ¬ï¼š12.0+ï¼ˆæ”¯æŒä¸IDEAæ’ä»¶é›†æˆï¼‰ã€‚ IDEï¼šIntelliJ IDEAï¼ˆé›†æˆJProfileræ’ä»¶ï¼‰ã€‚ æœåŠ¡å™¨ç¯å¢ƒï¼šLinuxï¼ˆéœ€é…ç½®OOMè‡ªåŠ¨ç”ŸæˆDumpæ–‡ä»¶ï¼‰ã€‚ å®æˆ˜æ­¥éª¤ï¼šä»OOMåˆ°é—®é¢˜å®šä½ é…ç½®JVMå‚æ•°ç”ŸæˆDumpæ–‡ä»¶ Dumpæ–‡ä»¶ æ˜¯åœ¨OOMå†…å­˜æº¢å‡ºçš„æ—¶å€™ï¼Œè‡ªåŠ¨Dumpæ–‡ä»¶è½¬å­˜å¿«ç…§çš„ï¼Œé…ç½®JVMå‚æ•° ,å°±èƒ½å¤Ÿåœ¨å‘ç”ŸOut of Memoryé”™è¯¯çš„æ—¶å€™ï¼Œå°±æ˜¯æŠŠå½“å‰å †æ ˆä¿¡æ¯è½¬å­˜ä¸ºå¿«ç…§Dumpæ–‡ä»¶\n1 2 3 4 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/dev/test_service_jvmDump.hprof ç”Ÿäº§ java -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/home/app.hprof -jar app.jar HeapDumpOnOutOfMemoryErrorï¼šè§¦å‘OOMæ—¶ç”Ÿæˆå¿«ç…§ã€‚ HeapDumpPathï¼šæŒ‡å®šå¿«ç…§æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼ˆéœ€ç¡®ä¿ç›®å½•å¯å†™ï¼‰ã€‚ è·å–å¹¶è§£æDumpæ–‡ä»¶ å½“OOMå‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨ä¼šç”Ÿæˆ.hprofæ–‡ä»¶ï¼Œä¸‹è½½è‡³æœ¬åœ°ã€‚ ä½¿ç”¨JProfileræ‰“å¼€å¿«ç…§ï¼š å¯åŠ¨JProfilerï¼Œé€‰æ‹© Open Snapshots â†’ Open a Single Snapshotã€‚ åŠ è½½.hprofæ–‡ä»¶åï¼ŒJProfilerä¼šè‡ªåŠ¨è§£æå †å†…å­˜ç»“æ„ã€‚ å¯¼å…¥æˆåŠŸåå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç•Œé¢: Jprofilerä½¿ç”¨ åˆ†æå¤§å¯¹è±¡æ¥æº Jprofile åˆ†æå¯¹è±¡,æœ‰ä¸¤ä¸ªç‰¹åˆ«é‡è¦çš„ä¿¡æ¯å³ å¯¹è±¡çš„å¼•ç”¨ä¿¡æ¯\nincoming references å…¥å¼•ç”¨, æ˜¾ç¤ºè¿™ä¸ªå¯¹è±¡è¢«è°å¼•ç”¨ï¼Œ æ‰¾é—®é¢˜å‡ºç°çš„ä»£ç ä½ç½® outcoming references å‡ºå¼•ç”¨,æ˜¾ç¤ºè¿™ä¸ªå¯¹è±¡å¼•ç”¨çš„å…¶ä»–å¯¹è±¡ï¼Œ æ‰¾å‡ºä»–æœ‰ä»€ä¹ˆï¼Œä»–ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤§å†…å­˜ï¼Œå†…å­˜é‡Œé¢å­˜å‚¨çš„æ˜¯å•¥ ä¸‹é¢æˆ‘ä»¬å…ˆé¢„ä¼°å¯¹è±¡å†…å­˜å¤§å°\næŒ‰ç…§Sizeæ’åºï¼Œè¿™ä¸ªbyte[]ä½¿ç”¨15350æ¬¡ï¼Œå ç”¨å†…å­˜1272MBï¼Œçœ‹ç€å¾ˆå¤§ Incomming References å…¥å¼•ç”¨,æ‰¾å¼•ç”¨å½“å‰å¯¹è±¡çš„å¯¹è±¡\nUse select Objects åˆ†æå¯¹è±¡å¼•ç”¨\né¦–å…ˆ é€‰ä¸­å¯¹è±¡ï¼Œç‚¹å‡»å³é”®ï¼ŒUse select Objects é€‰æ‹© incoming references æ‰¾åˆ°å¯¹è±¡å¼•ç”¨çš„åœ°æ–¹ é€ä¸ªåˆ†æï¼Œ ç‚¹å‡»show more\næŸ¥çœ‹ä»£ç ï¼Œåˆ†æé—®é¢˜\nJprofile å¤§å¯¹è±¡å¯»æ‰¾æ³• ä¸Šé¢æˆ‘ä»¬é€šè¿‡ incomming references ï¼Œæ‰¾å¯¹äº†å¯¹è±¡çš„å¼•ç”¨ï¼Œä¸‹é¢æˆ‘ä»¬æˆ‘ä»¬é‡‡ç”¨æ›´ä¸ºç›´æ¥çš„æ–¹æ³•\næˆ‘ä»¬éƒ½çŸ¥é“å†…å­˜è¿‡é«˜, æ— æ³•å›æ”¶,è‚¯å®šæ˜¯å†…å­˜ä¸­å †ç§¯çš„ä¸œè¥¿å¤šäº†, é‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸‹æœ‰å“ªäº›å¤§å¯¹è±¡å ç”¨äº†å†…å­˜,å¦‚ä½•æ‰¾åˆ°å¤§å¯¹è±¡?\nJprofileæä¾›äº†Biggest Objectsçš„ æŸ¥æ‰¾æ–¹æ³•\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°æŒ‰é’® Biggets OBjects ç›´æ¥ç‚¹å‡»æŒ‰é’®, JProfilerå°±ä¼šæ˜¾ç¤ºå½“å‰å †æ ˆä¸­æœ‰å“ªäº›å¤§å¯¹è±¡ åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šè¿›è¡Œæ“ä½œ ç„¶åç‚¹å¼€å¤§å¯¹è±¡è¿›è¡Œåˆ†æ, åŒæ ·çš„ Used Selected Objects ç‚¹å‡»Incomming References æŸ¥æ‰¾å¯¹è±¡å¼•ç”¨ä¿¡æ¯\n![![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../image/af4eba6408a6405f86d7a60748234e10.png) åŒæ ·çš„ç»“æœ, å¯ä»¥å®šä½åˆ°148è¡Œä»£ç å­˜åœ¨é—®é¢˜ ç”¨Graph æŸ¥æ‰¾å¯¹è±¡æº å…ˆæŸ¥æ‰¾ Incomming References æ‰¾åˆ°å¯¹è±¡è¢«è°å¼•ç”¨ æ‰¾åˆ°æƒ³è¦è¿½æŸ¥çš„å¯¹è±¡åï¼Œ é€‰æ‹©User Selected Objects ç„¶åç‚¹å‡» Show In Graph å®šä½çº¿ç¨‹åŠClassä¿¡æ¯\nç„¶åæ ¹æ® æ•°æ®æºHeap Walker å®šä½åˆ°é—®é¢˜çš„Classç±»ä¿¡æ¯åŠå…·ä½“çš„è¡Œä¿¡æ¯\nShow Path To GC Root æ‰¾åˆ°åˆ›å»ºè¯¥æ–¹æ³•çš„ä½ç½® é€‰æ‹©Use Selected Objects ï¼Œé€‰æ‹©Imcoming Referencesï¼Œ ç„¶åç‚¹å‡» Show Path To GC Root\nä»åˆ›å»ºè¯¥å¯¹è±¡çš„æ–¹æ³•å¼€å§‹æ£€æŸ¥ï¼Œæ£€æŸ¥æ‰€æœ‰ç”¨åˆ°è¯¥å¯¹è±¡çš„åœ°æ–¹ï¼Œç›´åˆ°æ‰¾åˆ°æ³„æ¼ä½ç½®\né€‰æ‹©All rootï¼Œ å±•ç¤ºæ‰€æœ‰çš„æ ¹èŠ‚ç‚¹é“¾è·¯ä¿¡æ¯ å®šä½é—®é¢˜ï¼ŒæŸ¥é˜…ä»£ç  æ€»ç»“ é€šè¿‡JProfileråˆ†æDumpæ–‡ä»¶ï¼Œå¼€å‘è€…å¯ä»¥å¿«é€Ÿå®šä½å†…å­˜æ³„æ¼æˆ–å¤§å¯¹è±¡é—®é¢˜ã€‚å…³é”®åœ¨äºï¼š\nç”Ÿæˆå‡†ç¡®çš„å¿«ç…§ï¼šç¡®ä¿JVMå‚æ•°é…ç½®æ­£ç¡®ã€‚ æŒæ¡åˆ†æå·¥å…·çš„æ ¸å¿ƒåŠŸèƒ½ï¼šå¦‚å¼•ç”¨é“¾è¿½è¸ªã€å¤§å¯¹è±¡ç­›é€‰ã€‚ ç»“åˆä»£ç ä¸ä¸šåŠ¡åœºæ™¯ï¼šé¿å…â€œæ²»æ ‡ä¸æ²»æœ¬â€çš„ä¸´æ—¶ä¿®å¤ã€‚ ","date":"2025-03-09T10:34:57Z","image":"https://www.ownit.top/title_pic/74.jpg","permalink":"https://www.ownit.top/p/202503091034/","title":"å®æˆ˜å¤ç›˜ï¼šå¦‚ä½•ç”¨JProfileråœ¨30åˆ†é’Ÿå†…è§£å†³å†…å­˜æ³„æ¼ï¼Ÿ"},{"content":"ä¸ºä»€ä¹ˆé€‰æ‹©Ginæ¡†æ¶ï¼Ÿ Gin æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€çš„é«˜æ€§èƒ½ Web æ¡†æ¶ï¼Œå…·å¤‡ä»¥ä¸‹ä¼˜åŠ¿ï¼š\nè½»é‡é«˜æ•ˆï¼šåº•å±‚ä¾èµ– net/httpï¼Œæ€§èƒ½æ¥è¿‘åŸç”Ÿã€‚ ç®€æ´ä¼˜é›…ï¼šAPI è®¾è®¡å‹å¥½ï¼Œæ”¯æŒè·¯ç”±åˆ†ç»„ã€ä¸­é—´ä»¶é“¾ã€å‚æ•°ç»‘å®šç­‰ç‰¹æ€§ã€‚ ç”Ÿæ€ä¸°å¯Œï¼šå†…ç½® JSON è§£æã€æ—¥å¿—è®°å½•ã€é”™è¯¯æ¢å¤ç­‰å®ç”¨åŠŸèƒ½ï¼Œç¤¾åŒºæ’ä»¶ç”Ÿæ€å®Œå–„ã€‚ æ— è®ºæ˜¯æ„å»º RESTful API è¿˜æ˜¯å…¨æ ˆåº”ç”¨ï¼ŒGin éƒ½èƒ½æ˜¾è‘—æå‡å¼€å‘æ•ˆç‡ã€‚ å®‰è£… è¦å®‰è£…Ginè½¯ä»¶åŒ…ï¼Œæ‚¨éœ€è¦å®‰è£…Goå¹¶é¦–å…ˆè®¾ç½®Goå·¥ä½œåŒºã€‚\né¦–å…ˆéœ€è¦å®‰è£…Goï¼ˆéœ€è¦1.10+ç‰ˆæœ¬ï¼‰ï¼Œç„¶åå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„Goå‘½ä»¤å®‰è£…Ginã€‚ 1 go get -u github.com/gin-gonic/gin å°†å…¶å¯¼å…¥æ‚¨çš„ä»£ç ä¸­ï¼š 1 import \u0026#34;github.com/gin-gonic/gin\u0026#34; åŸºç¡€ç¤ºä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main import ( \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;net/http\u0026#34; ) func main() { // 1.åˆ›å»º (å®ä¾‹åŒ–gin.Engineç»“æ„ä½“å¯¹è±¡ï¼‰ r := gin.Default() // 2.ç»‘å®šè·¯ç”±è§„åˆ™ï¼Œæ‰§è¡Œçš„å‡½æ•° // gin.Contextï¼Œå°è£…äº†requestå’Œresponse r.GET(\u0026#34;/\u0026#34;, func(c *gin.Context) { c.String(http.StatusOK, \u0026#34;Hello, Gin!\u0026#34;) }) // 3.ç›‘å¬ç«¯å£ï¼Œé»˜è®¤åœ¨8080 // Run(\u0026#34;é‡Œé¢ä¸æŒ‡å®šç«¯å£å·é»˜è®¤ä¸º8080\u0026#34;) r.Run(\u0026#34;:8080\u0026#34;) } è¿è¡Œåè®¿é—® http://localhost:8080ï¼Œå³å¯çœ‹åˆ°è¿”å›çš„å­—ç¬¦ä¸²ã€‚\nGinå·¥å·¥ä½œä½œæµæµç¨‹ æ ¸å¿ƒæ¦‚å¿µ Engine å®¹å™¨å¯¹è±¡ï¼Œæ•´ä¸ªæ¡†æ¶çš„åŸºç¡€ Engine.tree è´Ÿè´£å­˜å‚¨è·¯ç”±å’Œhandleæ–¹æ³•çš„æ˜ å°„ï¼Œé‡‡ç”¨ç±»ä¼¼äºå­—å…¸æ ‘çš„ç»“æ„ Engine.RouterGroup å…¶ä¸­handlerså­˜å‚¨ç€æ‰€æœ‰ä¸­é—´ä»¶ Context ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè´Ÿè´£å¤„ç† è¯·æ±‚å›åº” ï¼Œå…¶ä¸­handlesçš„å­˜å‚¨å¤„ç†è¯·æ±‚æ—¶ä¸­é—´ä»¶å’Œå¤„ç†æ–¹æ³•çš„ è¯·æ±‚å¤„ç† æµç¨‹ GINå¯åŠ¨æµç¨‹ 1 Ginåˆå§‹åŒ–----\u0026gt; Use ä¸­é—´ä»¶ ----\u0026gt; æ³¨å†ŒRoutersè·¯ç”± ----\u0026gt; RUN()å¯åŠ¨ GinåŸåŸç†è§£æ å‚è€ƒèµ„æ–™ï¼šhttp://v5blog.cn/pages/dd7d5a/\ngin.Default()\nDefault()è·ŸNew()å‡ ä¹ä¸€æ¨¡ä¸€æ ·, å°±æ˜¯è°ƒç”¨äº†ginå†…ç½®çš„Logger(), Recovery()ä¸­é—´ä»¶\n1 2 3 4 5 6 7 8 // Defaultè¿”å›ä¸€ä¸ªå·²ç»é™„åŠ äº†Loggerå’ŒRecoveryä¸­é—´ä»¶çš„Engineå®ä¾‹ func Default() *Engine { debugPrintWARNINGDefault() engine := New() \u0026#34;# é»˜è®¤å®ä¾‹ // æ³¨å†Œä¸­é—´å»ºï¼Œä¸­é—´ä»¶çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæœ€ç»ˆåªè¦è¿”å›ä¸€ä¸ª type HandlerFunc func(*Context) å°±å¯ä»¥ engine.Use(Logger(), Recovery()) // é»˜è®¤æ³¨å†Œçš„ä¸¤ä¸ªä¸­é—´ä»¶ return engine } engine := New() åˆåˆå§‹åŒ–å§‹åŒ–\né€šè¿‡è°ƒç”¨ gin.New() æ–¹æ³•æ¥å®ä¾‹åŒ– Engineå®¹å™¨\nengine.Use() æ³¨æ³¨å†Œå†Œä¸­é—´ä»¶ ä¸­é—´ä»¶\nè·¯ç”±ä¸å‚æ•°å¤„ç† æ— å‚è·¯ç”± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func HelloWorldhandler(ctx *gin.Context){ ctx.JSON(200, gin.H{ \u0026#34;message\u0026#34;: \u0026#34;Hello World\u0026#34;, }) } func main() { // åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„è·¯ç”±å™¨ router := gin.Default() // gin.Contextæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«äº†è¯·æ±‚å’Œå“åº”çš„ç»†èŠ‚ï¼Œ å°è£…requestå’Œresponse router.GET(\u0026#34;/\u0026#34;,HelloWorldhandler) // è·¯ç”±é‡å®šå‘ router.GET(\u0026#34;/re\u0026#34;, func(c *gin.Context) { c.Redirect(http.StatusMovedPermanently, \u0026#34;https://www.baidu.com\u0026#34;) }) // å¯åŠ¨æœåŠ¡å™¨ router.Run(\u0026#34;:8081\u0026#34;) } åŠ¨æ€è·¯ç”±å‚æ•° é€šè¿‡ :param æ•è· URL ä¸­çš„å˜é‡ï¼š (å¯ä»¥é€šè¿‡Contextçš„Paramæ–¹æ³•æ¥è·å–APIå‚æ•°)\n1 2 3 4 r.GET(\u0026#34;/book/:id\u0026#34;, func(c *gin.Context) { bookID := c.Param(\u0026#34;id\u0026#34;) c.String(http.StatusOK, \u0026#34;ä¹¦ç±ID: %s\u0026#34;, bookID) }) æŸ¥è¯¢å‚æ•° ä½¿ç”¨ Query æˆ– DefaultQuery è·å– URL å‚æ•°ï¼š http://127.0.0.1:8000/user?name=zhangsan\n1 2 3 4 5 r.GET(\u0026#34;/user\u0026#34;, func(c *gin.Context) { name := c.Query(\u0026#34;name\u0026#34;) role := c.DefaultQuery(\u0026#34;role\u0026#34;, \u0026#34;guest\u0026#34;) c.JSON(200, gin.H{\u0026#34;name\u0026#34;: name, \u0026#34;role\u0026#34;: role}) }) ShouldBindå‚æ•°ç»‘å®š é€šè¿‡ ShouldBind è‡ªåŠ¨è§£æè¯·æ±‚ä½“ï¼ˆæ”¯æŒ JSONã€Form ç­‰ï¼‰ï¼š\næˆ‘ä»¬å¯ä»¥åŸºäºè¯·æ±‚çš„ Content-Type è¯†åˆ«è¯·æ±‚æ•°æ®ç±»å‹å¹¶åˆ©ç”¨åå°„æœºåˆ¶ è‡ªåŠ¨æå–è¯·æ±‚ä¸­ QueryString ã€ formè¡¨å• ã€ JSON ã€ XML ç­‰å‚æ•°åˆ°ç»“æ„ä½“ä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 type LoginForm struct { Username string `form:\u0026#34;username\u0026#34; binding:\u0026#34;required\u0026#34;` Password string `form:\u0026#34;password\u0026#34; binding:\u0026#34;required\u0026#34;` } r.POST(\u0026#34;/login\u0026#34;, func(c *gin.Context) { var form LoginForm if err := c.ShouldBind(\u0026amp;form); err != nil { c.JSON(400, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } c.String(200, \u0026#34;ç™»å½•æˆåŠŸ: %s\u0026#34;, form.Username) }) å®Œæ•´ä»£ç æ¡ˆä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;net/http\u0026#34; ) // HelloWorldhandler æ— å‚æ•°è·¯ç”±å¤„ç†å‡½æ•° func HelloWorldhandler(ctx *gin.Context){ ctx.JSON(200, gin.H{ \u0026#34;message\u0026#34;: \u0026#34;Hello World\u0026#34;, }) } func GetBookDetailHandler(ctx *gin.Context ) { bookId := ctx.Param(\u0026#34;id\u0026#34;) ctx.String(http.StatusOK, fmt.Sprintf(\u0026#34;æˆåŠŸè·å–ä¹¦ç±è¯¦æƒ…ï¼š%s\u0026#34;, bookId)) } func GetUserDetailHandlers(ctx *gin.Context) { username := ctx.Query(\u0026#34;username\u0026#34;) ctx.String(http.StatusOK, fmt.Sprintf(\u0026#34;æˆåŠŸè·å–ç”¨æˆ·è¯¦æƒ…ï¼š%s\u0026#34;, username)) } type Login struct { Username string `form:\u0026#34;username\u0026#34; json:\u0026#34;username\u0026#34; binding:\u0026#34;required\u0026#34;` Password string `form:\u0026#34;password\u0026#34; json:\u0026#34;password\u0026#34; binding:\u0026#34;required\u0026#34;` } func ResponseJsonHandler(c *gin.Context) { type Data struct { Msg string `json:\u0026#34;msg:\u0026#34;` Code int `json:\u0026#34;code\u0026#34;` } d := Data{ Msg: \u0026#34;success\u0026#34;, Code: 200, } c.JSON(http.StatusOK, d) } func Loginhandler(c *gin.Context) { var login Login if err := c.ShouldBind(\u0026amp;login); err == nil { c.JSON(http.StatusOK, gin.H{ \u0026#34;username\u0026#34;: login.Username, \u0026#34;password\u0026#34;: login.Password, }) } else { c.JSON(http.StatusBadRequest, gin.H{\u0026#34;error\u0026#34;: err.Error()}) } } func ResponseStringHandle(c *gin.Context) { c.String(http.StatusOK, \u0026#34;Hello World\u0026#34;) } func main() { // åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„è·¯ç”±å™¨ router := gin.Default() // gin.Contextæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«äº†è¯·æ±‚å’Œå“åº”çš„ç»†èŠ‚ï¼Œ å°è£…requestå’Œresponse // æ— å‚æ•°è·¯ç”± router.GET(\u0026#34;/\u0026#34;,HelloWorldhandler) // è¿”å›å­—ç¬¦ä¸² router.GET(\u0026#34;/string\u0026#34;, ResponseStringHandle) // è¿”å›json router.GET(\u0026#34;/json\u0026#34;, ResponseJsonHandler) // åŠ¨æ€è·¯ç”±å‚æ•° router.GET(\u0026#34;/book/:id\u0026#34;, GetBookDetailHandler) // æŸ¥è¯¢å‚æ•° Query æˆ– DefaultQuery router.GET(\u0026#34;/user/\u0026#34;, GetUserDetailHandlers) // å‚æ•°ç»‘å®š router.POST(\u0026#34;/login\u0026#34;, Loginhandler) // è·¯ç”±é‡å®šå‘ router.GET(\u0026#34;/re\u0026#34;, func(c *gin.Context) { c.Redirect(http.StatusMovedPermanently, \u0026#34;https://www.baidu.com\u0026#34;) }) // å¯åŠ¨æœåŠ¡å™¨ router.Run(\u0026#34;:8081\u0026#34;) } è·¯ç”±åˆ†å‘ ä¸ºä»€ä¹ˆéœ€è¦è·¯ç”±åˆ†å‘ï¼Ÿ\næˆ‘ä»¬ä¸€ä¸ªé¡¹ç›®æœ‰éå¸¸å¤šçš„æ¨¡å—ï¼Œå¦‚æœå…¨éƒ¨å†™åœ¨ä¸€å—å¯¼è‡´ä»£ç ç»“æ„æ··ä¹±ï¼Œä¸åˆ©äºåç»­çš„æ‰©å±• æŒ‰ç…§å¤§çš„æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—æœ‰è‡ªå·±ç‹¬ç«‹çš„è·¯ç”±ï¼Œä¸»è·¯ç”±å¯ä»¥å†main.goä¸­è¿›è¡Œæ³¨å†Œ é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â”œâ”€â”€ main.go â””â”€â”€ routers â”œâ”€â”€ books.go â””â”€â”€ users.go main.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import ( \u0026#34;days/routers\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; ) func main() { router := gin.Default() // å…¨å±€ä¸­é—´ä»¶ router.Use(MiddleWare()) // åŠ è½½è·¯ç”± routers.LoadUsers(router) routers.LoadBooks(router) router.Run(\u0026#34;:8081\u0026#34;) } routers/users.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package routers import ( \u0026#34;fmt\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;time\u0026#34; ) func LoadUsers(e *gin.Engine) { e.GET(\u0026#34;/user\u0026#34;,MiddleWareOne(),UserHandler) } func UserHandler(c *gin.Context) { fmt.Println(\u0026#34;æˆ‘æ˜¯ç”¨æˆ·è·¯ç”±\u0026#34;) time.Sleep(time.Second * 5) c.JSON(http.StatusOK,gin.H{ \u0026#34;message\u0026#34; : \u0026#34;weclome user\u0026#34;, }) } routers/books.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 package routers import ( \u0026#34;net/http\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; ) func LoadBooks(e *gin.Engine) { e.GET(\u0026#34;/book\u0026#34;, GetBookHandler) } func GetBookHandler(c *gin.Context) { c.JSON(http.StatusOK, gin.H{ \u0026#34;message\u0026#34;: \u0026#34;Book Router\u0026#34;, }) } ä¸­é—´ä»¶ Ginæ¡†æ¶å…è®¸å¼€å‘è€…åœ¨å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼ŒåŠ å…¥ç”¨æˆ·è‡ªå·±çš„é’©å­ï¼ˆHookï¼‰å‡½æ•°ã€‚ è¿™ä¸ªé’©å­å‡½æ•°å°±å«ä¸­é—´ä»¶ï¼Œä¸­é—´ä»¶é€‚åˆå¤„ç†ä¸€äº›å…¬å…±çš„ä¸šåŠ¡é€»è¾‘ æ¯”å¦‚ç™»å½•è®¤è¯ã€æƒé™æ ¡éªŒã€æ•°æ®åˆ†é¡µã€è®°å½•æ—¥å¿—ã€è€—æ—¶ç»Ÿè®¡ç­‰ å…¨å±€ä¸­é—´ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func Logger() gin.HandlerFunc { return func(c *gin.Context) { start := time.Now() c.Next() latency := time.Since(start) fmt.Printf(\u0026#34;è¯·æ±‚è€—æ—¶: %v\\n\u0026#34;, latency) } } func main() { r := gin.Default() r.Use(Logger()) // å…¨å±€ç”Ÿæ•ˆ r.GET(\u0026#34;/\u0026#34;, func(c *gin.Context) { /* ... */ }) } å±€éƒ¨ä¸­é—´ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 func AuthMiddleware() gin.HandlerFunc { return func(c *gin.Context) { token := c.GetHeader(\u0026#34;token\u0026#34;) if token != \u0026#34;SECRET_KEY\u0026#34; { c.AbortWithStatusJSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;èº«ä»½éªŒè¯å¤±è´¥\u0026#34;}) } c.Next() } } r.GET(\u0026#34;/profile\u0026#34;, AuthMiddleware(), func(c *gin.Context) { c.JSON(200, gin.H{\u0026#34;data\u0026#34;: \u0026#34;ç”¨æˆ·ä¿¡æ¯\u0026#34;}) }) next()æ–¹æ³• åœ¨ä¸­é—´ä»¶ä¸­è°ƒç”¨next()æ–¹æ³•ï¼Œä¼šä»next()æ–¹æ³•è°ƒç”¨çš„åœ°æ–¹è·³è½¬åˆ°Handlerå‡½æ•° Handlerå‡½æ•°æ‰§è¡Œå®Œæˆï¼Œè‹¥ä¸­é—´ä»¶è¿˜æœ‰éƒ¨åˆ†ä»£ç æœªæ‰§è¡Œï¼ˆä¸­é—´ä»¶ä¸­next()ä¹‹åçš„ä»£ç ï¼‰ï¼Œåˆ™æ‰§è¡Œè¯¥ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;time\u0026#34; ) func main() { r := gin.Default() r.Use(Log(), RequestID()) r.GET(\u0026#34;/\u0026#34;, func(c *gin.Context) { fmt.Println(\u0026#34;app running 1\u0026#34;) time.Sleep(time.Second * 5) c.String(http.StatusOK, \u0026#34;hello World!\u0026#34;) }) r.Run() } func Log() gin.HandlerFunc { return func(c *gin.Context) { fmt.Println(\u0026#34;log start\u0026#34;) c.Next() fmt.Println(\u0026#34;log end\u0026#34;) } } func RequestID() gin.HandlerFunc { return func(c *gin.Context) { fmt.Println(\u0026#34;requestid start\u0026#34;) c.Next() fmt.Println(\u0026#34;requestid end\u0026#34;) } } å®ç°tokenè®¤è¯ http://127.0.0.1:8080/index indexé¦–é¡µæ— éœ€tokenç›´æ¥è®¿é—® http://127.0.0.1:8080/home homeå®¶ç›®å½•éœ€è¦å¯¹tokenè¿›è¡ŒéªŒè¯ï¼ŒéªŒè¯é€šè¿‡æ‰å¯è®¿é—® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; ) func AuthMiddleWare() func(c *gin.Context) { return func(c *gin.Context){ // å®¢æˆ·ç«¯æºå¸¦token æœ‰ä¸‰ç§æ–¹å¼ 1.æ”¾åœ¨è¯·æ±‚å¤´ 2.æ”¾åœ¨è¯·æ±‚ä½“ 3.æ”¾åœ¨url // token éªŒè¯æˆåŠŸï¼Œè¿”å› c.next()æ‰ä¼šç»§ç»­ï¼Œå¦åˆ™ c.Abort() token := c.Request.Header.Get(\u0026#34;token\u0026#34;) fmt.Println(\u0026#34;è·å–token:\u0026#34;,token) if token == \u0026#34;\u0026#34; { c.JSON(200, gin.H{ \u0026#34;code\u0026#34;: 401, \u0026#34;msg\u0026#34;: \u0026#34;èº«ä»½éªŒè¯ä¸é€šè¿‡\u0026#34;, }) c.Abort() } if token != \u0026#34;123456\u0026#34; { c.JSON(200, gin.H{ \u0026#34;code\u0026#34;: 401, \u0026#34;msg\u0026#34;: \u0026#34;tokené”™è¯¯\u0026#34;, }) c.Abort() } } } func main() { router := gin.Default() // é¦–é¡µæ— éœ€éªŒè¯ router.GET(\u0026#34;/\u0026#34;, func(c *gin.Context) { c.JSON(200, gin.H{ \u0026#34;message\u0026#34;: \u0026#34;é¦–é¡µ\u0026#34;, }) }) // Homeé¡µé¢éœ€è¦éªŒè¯ router.GET(\u0026#34;/home\u0026#34;, AuthMiddleWare(), func(c *gin.Context) { c.JSON(200, gin.H{ \u0026#34;message\u0026#34;: \u0026#34;Homeé¡µé¢\u0026#34;, }) }) router.Run(\u0026#34;:8081\u0026#34;) } ","date":"2025-03-04T11:07:28Z","image":"https://www.ownit.top/title_pic/63.jpg","permalink":"https://www.ownit.top/p/202503041107/","title":"Ginæ¡†æ¶ä»å…¥é—¨åˆ°å®æˆ˜ï¼šæ ¸å¿ƒç”¨æ³•ä¸æœ€ä½³å®è·µ"},{"content":"èƒŒæ™¯ ä»é‡å¤åŠ³åŠ¨åˆ°è‡ªåŠ¨åŒ–ææ•ˆ åœ¨æ—¥å¸¸å¼€å‘è¿ç»´å·¥ä½œä¸­ï¼Œæ—¥å¿—åˆ†ææ˜¯æ¯ä¸ªå·¥ç¨‹å¸ˆéƒ½ä¼šé‡åˆ°çš„\u0026quot;å¿…ä¿®è¯¾\u0026quot;ã€‚å½“æˆ‘ä»¬éœ€è¦å®šä½çº¿ä¸Šé—®é¢˜ã€åˆ†æè®¿é—®è¶‹åŠ¿æˆ–éªŒè¯æµ‹è¯•ç»“æœæ—¶ï¼Œå¾€å¾€éœ€è¦é¢å¯¹ä»¥ä¸‹ç—›ç‚¹åœºæ™¯ï¼š\nåœ¨GBçº§çš„æ—¥å¿—æ–‡ä»¶ä¸­æ‰‹åŠ¨grepå…³é”®ä¿¡æ¯ é‡å¤ç¼–å†™awk/sedè„šæœ¬ç»Ÿè®¡è®¿é—®é‡ æ¯æ¬¡åˆ†ææ—¥å¿—éƒ½éœ€è¦è¿›è¡Œç›¸ä¼¼çš„ç­›é€‰ã€ç»Ÿè®¡æ“ä½œï¼Œé‡å¤åŠ³åŠ¨è®©äººç–²æƒ«ä¸å ª äººå·¥åˆ†æéš¾ä»¥å¿«é€Ÿæå–å‡ºæ—¥å¿—ä¸­çš„å…³é”®æŒ‡æ ‡ï¼Œä¾‹å¦‚ IP è®¿é—®é‡ã€é”™è¯¯çŠ¶æ€ç åˆ†å¸ƒç­‰ã€‚ ä¸ºæ­¤ï¼Œæˆ‘åŸºäºGoè¯­è¨€å¼€å‘äº†è¿™æ¬¾å‘½ä»¤è¡Œæ—¥å¿—åˆ†æå·¥å…·ï¼Œå®ƒå…·å¤‡ä»¥ä¸‹æ ¸å¿ƒä»·å€¼ï¼š\næç®€éƒ¨ç½²ï¼ˆå•æ–‡ä»¶äºŒè¿›åˆ¶ï¼‰ å®æ—¶äº¤äº’å¼åˆ†æ å¸¸ç”¨ç»Ÿè®¡åœºæ™¯å…¨è¦†ç›– æ¯«ç§’çº§å“åº”é€Ÿåº¦ æµ‹è¯•å‹å¥½å‹è¾“å‡º å·¥å…·åŠŸèƒ½æ¦‚è§ˆ è¿™æ¬¾æ—¥å¿—åˆ†æå·¥å…· ( log-analyzer ) åŸºäº Go è¯­è¨€å¼€å‘ï¼Œå……åˆ†åˆ©ç”¨äº† Go è¯­è¨€åœ¨å¤„ç†æ–‡æœ¬å’Œå¹¶å‘æ–¹é¢çš„ä¼˜åŠ¿ï¼Œæ—¨åœ¨æä¾›ç®€æ´ã€é«˜æ•ˆçš„æ—¥å¿—åˆ†æèƒ½åŠ›ã€‚å®ƒä¸»è¦å…·å¤‡ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š\nTop N ç»Ÿè®¡åˆ†æ: å¿«é€Ÿç»Ÿè®¡æ—¥å¿—ä¸­å‡ºç°é¢‘ç‡æœ€é«˜çš„ IP åœ°å€ã€HTTP çŠ¶æ€ç å’Œè¯·æ±‚è·¯å¾„ï¼Œå¸®åŠ©ä½ å¿«é€Ÿäº†è§£è®¿é—®æ¦‚å†µå’Œæ½œåœ¨çƒ­ç‚¹ã€‚ å…³é”®è¯è¿‡æ»¤: æ”¯æŒæ ¹æ®å…³é”®è¯å¿«é€Ÿç­›é€‰å‡ºåŒ…å«ç‰¹å®šä¿¡æ¯çš„æ—¥å¿—è¡Œï¼Œä¾‹å¦‚é”™è¯¯æ—¥å¿—ã€ç‰¹å®šç”¨æˆ·çš„è®¿é—®æ—¥å¿—ç­‰ï¼Œæ–¹ä¾¿é—®é¢˜å®šä½ã€‚ æ—¶é—´èŒƒå›´è¿‡æ»¤: å…è®¸ç”¨æˆ·æŒ‡å®šæ—¶é—´èŒƒå›´ï¼Œç­›é€‰å‡ºç‰¹å®šæ—¶é—´æ®µå†…çš„æ—¥å¿—ï¼Œä¾‹å¦‚åˆ†ææŸä¸ªæ—¶é—´æ®µå†…çš„å¼‚å¸¸è¯·æ±‚æˆ–ç”¨æˆ·è¡Œä¸ºã€‚ ç¯å¢ƒå‡†å¤‡ä¸æŠ€æœ¯é€‰å‹ å¼€å‘ç¯å¢ƒè¦æ±‚ Go 1.18+ï¼ˆæ”¯æŒæ³›å‹ç‰¹æ€§ï¼‰ æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼çš„æ—¥å¿—æ ¼å¼ï¼ˆå¦‚Nginx/Apacheé€šç”¨æ ¼å¼ï¼‰ å†…å­˜ï¼š100MB+ï¼ˆå–å†³äºæ—¥å¿—è§„æ¨¡ï¼‰ å…³é”®æŠ€æœ¯æ ˆ ç»„ä»¶ ç”¨é€” ä¼˜åŠ¿ bufio.Scanner å¤§æ–‡ä»¶æµå¼è¯»å– å†…å­˜æ•ˆç‡é«˜ï¼Œæ”¯æŒGBçº§æ–‡ä»¶å¤„ç† regexp ç»“æ„åŒ–æ—¥å¿—è§£æ é«˜æ€§èƒ½æ­£åˆ™åŒ¹é…ï¼ˆRE2å¼•æ“ï¼‰ sort.Slice ç»Ÿè®¡ç»“æœæ’åº çµæ´»çš„è‡ªå®šä¹‰æ’åºå®ç° time.Parse å¤šæ—¶åŒºæ—¶é—´è§£æ ç²¾ç¡®å¤„ç†å…¨çƒåˆ†å¸ƒå¼ç³»ç»Ÿæ—¥å¿— é€‰æ‹©Goè¯­è¨€çš„æ ¸å¿ƒè€ƒé‡ï¼š\nç¼–è¯‘ä¸ºå•æ–‡ä»¶äºŒè¿›åˆ¶ï¼Œæ— ä¾èµ–éƒ¨ç½² åŸç”Ÿå¹¶å‘æ¨¡å‹é€‚åˆæ—¥å¿—å¤„ç†åœºæ™¯ å“è¶Šçš„æ€§èƒ½è¡¨ç°ï¼ˆç›¸æ¯”Python/Node.jsï¼‰ ä¸°å¯Œçš„æ ‡å‡†åº“è¦†ç›–å¸¸è§éœ€æ±‚ æ ¸å¿ƒåŠŸèƒ½å®ç°è§£æ Nginxæ—¥å¿—æ ¼å¼ Nginxé…ç½®\n1 2 3 4 5 6 7 log_format main \u0026#39;$remote_addr $host $document_uri [$time_local] \u0026#39; \u0026#39;\u0026#34;$remote_user\u0026#34; \u0026#34;$scheme\u0026#34; \u0026#34;$request\u0026#34; \u0026#34;$status\u0026#34; \u0026#34;$body_bytes_sent\u0026#34; \u0026#39; \u0026#39;\u0026#34;X-Forwarded-For: $proxy_add_x_forwarded_for\u0026#34; \u0026#39; \u0026#39;\u0026#34;Referer: $http_referer\u0026#34; \u0026#34;User_Agent: $http_user_agent\u0026#34; \u0026#39; \u0026#39;\u0026#34;upstream_addr:$upstream_addr\u0026#34; \u0026#34;upstream_cache_status:$upstream_cache_status\u0026#34; \u0026#39; \u0026#39;\u0026#34;upstream_status:$upstream_status\u0026#34; \u0026#34;upstream_response_time:$upstream_response_time\u0026#34;\u0026#39;; access_log logs/access.log main; æ—¥å¿—æ ¼å¼\n1 2 106.224.56.100 track-backend.xxx.com /trace [28/Jan/2025:23:57:01 +0800] \u0026#34;-\u0026#34; \u0026#34;https\u0026#34; \u0026#34;POST /trace HTTP/1.1\u0026#34; \u0026#34;200\u0026#34; \u0026#34;50\u0026#34; \u0026#34;X-Forwarded-For: 106.224.56.100, 106.224.56.100\u0026#34; \u0026#34;Referer: -\u0026#34; \u0026#34;User_Agent: okhttp/4.2.2\u0026#34; \u0026#34;upstream_addr:172.18.199.211:80\u0026#34; \u0026#34;upstream_cache_status:-\u0026#34; \u0026#34;upstream_status:200\u0026#34; \u0026#34;upstream_response_time:0.008\u0026#34; 8.135.0.81 ykdgate.xxx.com /api/v1/contract/query/WLSK/21070321435307266422910/LOAN_CONTRACT [28/Jan/2025:23:57:01 +0800] \u0026#34;-\u0026#34; \u0026#34;https\u0026#34; \u0026#34;GET /api/v1/contract/query/WLSK/21070321435307266422910/LOAN_CONTRACT HTTP/1.1\u0026#34; \u0026#34;200\u0026#34; \u0026#34;120\u0026#34; \u0026#34;X-Forwarded-For: 8.135.0.81, 8.135.0.81\u0026#34; \u0026#34;Referer: -\u0026#34; \u0026#34;User_Agent: Apache-HttpClient/4.5.2 (Java/1.8.0_402)\u0026#34; \u0026#34;upstream_addr:172.18.199.211:80\u0026#34; \u0026#34;upstream_cache_status:-\u0026#34; \u0026#34;upstream_status:200\u0026#34; \u0026#34;upstream_response_time:0.013\u0026#34; æ­£åˆ™è¡¨è¾¾ https://hiregex.com/\n1 (?P\u0026lt;ip\u0026gt;\\S+) (?P\u0026lt;host\u0026gt;\\S+) (?P\u0026lt;uri\u0026gt;\\S+) \\[(?P\u0026lt;time\u0026gt;.*?)\\] \u0026#34;(?P\u0026lt;user\u0026gt;.*?)\u0026#34; \u0026#34;(?P\u0026lt;scheme\u0026gt;.*?)\u0026#34; \u0026#34;(?P\u0026lt;request\u0026gt;[^\u0026#34;]+)\u0026#34; \u0026#34;(?P\u0026lt;status\u0026gt;\\d+)\u0026#34; æ—¥å¿—è§£æå¼•æ“è®¾è®¡ 1 2 var logPattern = regexp.MustCompile( `(?P\u0026lt;ip\u0026gt;\\S+) (?P\u0026lt;host\u0026gt;\\S+) (?P\u0026lt;uri\u0026gt;\\S+) \\[(?P\u0026lt;time\u0026gt;.*?)\\] \u0026#34;(?P\u0026lt;user\u0026gt;.*?)\u0026#34; \u0026#34;(?P\u0026lt;scheme\u0026gt;.*?)\u0026#34; \u0026#34;(?P\u0026lt;request\u0026gt;[^\u0026#34;]+)\u0026#34; \u0026#34;(?P\u0026lt;status\u0026gt;\\d+)\u0026#34;`) è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼å®šä¹‰äº†æ—¥å¿—è¡Œä¸­å„ä¸ªå­—æ®µçš„æå–è§„åˆ™ï¼Œä¾‹å¦‚ IP åœ°å€ã€ä¸»æœºåã€è¯·æ±‚ URIã€æ—¶é—´æˆ³ã€ç”¨æˆ·ã€è¯·æ±‚åè®®ã€è¯·æ±‚å†…å®¹å’Œ HTTP çŠ¶æ€ç ç­‰ã€‚ (?P...) æ˜¯ Go è¯­è¨€æ­£åˆ™è¡¨è¾¾å¼çš„å‘½åæ•è·ç»„ï¼Œå¯ä»¥å°†åŒ¹é…åˆ°çš„å†…å®¹å­˜å‚¨åˆ°æŒ‡å®šåç§°çš„ç»„ä¸­ï¼Œæ–¹ä¾¿åç»­ä»£ç å¼•ç”¨ã€‚\nç»Ÿè®¡æ•°æ®ç»“æ„ 1 2 3 4 5 6 type LogStats struct { IPs map[string]int // IPè®¿é—®è®¡æ•°å™¨ Status map[string]int // çŠ¶æ€ç åˆ†å¸ƒ Paths map[string]int // URIè®¿é—®æ’è¡Œ Lines []string // åŸå§‹æ—¥å¿—ç¼“å­˜ } IPsã€ Status å’Œ Paths å­—æ®µä½¿ç”¨ map[string]int å­˜å‚¨ç»Ÿè®¡æ•°æ®ï¼Œé”®ä¸ºå­—ç¬¦ä¸²ç±»å‹çš„ IP åœ°å€ã€çŠ¶æ€ç æˆ–è·¯å¾„ï¼Œå€¼ä¸ºå‡ºç°æ¬¡æ•°ã€‚ Lines å­—æ®µä½¿ç”¨å­—ç¬¦ä¸²åˆ‡ç‰‡ []string å­˜å‚¨åŸå§‹æ—¥å¿—è¡Œï¼Œç”¨äºåç»­çš„å…³é”®è¯å’Œæ—¶é—´èŒƒå›´è¿‡æ»¤ã€‚\nProcessLine å‡½æ•°ï¼šæ—¥å¿—è¡Œçš„â€œå¤„ç†å™¨â€ ProcessLine å‡½æ•°è´Ÿè´£é€è¡Œå¤„ç†æ—¥å¿—æ–‡ä»¶ï¼Œè§£ææ¯è¡Œæ—¥å¿—å¹¶æå–å…³é”®ä¿¡æ¯ï¼Œæ›´æ–° LogStats ç»“æ„ä½“ä¸­çš„ç»Ÿè®¡æ•°æ®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // ProcessLine å¤„ç†æ—¥å¿—è¡Œ func (ls *LogStats) ProcessLine(line string) { matches := logPattern.FindStringSubmatch(line) if matches == nil { return // å¦‚æœæ—¥å¿—è¡Œä¸åŒ¹é…æ­£åˆ™ï¼Œåˆ™å¿½ç•¥ } fields := make(map[string]string) for i, name := range logPattern.SubexpNames() { if i != 0 \u0026amp;\u0026amp; name != \u0026#34;\u0026#34; { fields[name] = matches[i] // å°†æ­£åˆ™åŒ¹é…åˆ°çš„å†…å®¹å­˜å‚¨åˆ° fields map ä¸­ } } ls.IPs[fields[\u0026#34;ip\u0026#34;]]++ // ç»Ÿè®¡ IP åœ°å€ ls.Status[fields[\u0026#34;status\u0026#34;]]++ // ç»Ÿè®¡ HTTP çŠ¶æ€ç  ls.Paths[fields[\u0026#34;uri\u0026#34;]]++ // ç»Ÿè®¡è¯·æ±‚è·¯å¾„ ls.Lines = append(ls.Lines, line) // å­˜å‚¨åŸå§‹æ—¥å¿—è¡Œ } è¯¥å‡½æ•°é¦–å…ˆä½¿ç”¨ logPattern.FindStringSubmatch(line) å°è¯•åŒ¹é…æ—¥å¿—è¡Œï¼Œå¦‚æœåŒ¹é…å¤±è´¥åˆ™ç›´æ¥è¿”å›ã€‚åŒ¹é…æˆåŠŸåï¼Œå°†åŒ¹é…åˆ°çš„å†…å®¹å­˜å‚¨åˆ° fields map ä¸­ï¼Œå¹¶æ ¹æ®å­—æ®µåæ›´æ–° LogStats ç»“æ„ä½“ä¸­çš„ IPsã€ Status å’Œ Paths ç»Ÿè®¡æ•°æ®ï¼ŒåŒæ—¶å°†åŸå§‹æ—¥å¿—è¡Œæ·»åŠ åˆ° Lines åˆ‡ç‰‡ä¸­\näº¤äº’å¼è®¾è®¡ 1 2 3 4 5 è¯·é€‰æ‹©æ‚¨çš„æ“ä½œ(è¾“å…¥æ•°å­—: 1. è¾“å‡º Top 10 IPs, Status Codes, and Paths 2. æ ¹æ® keyword è¿‡æ»¤æ—¥å¿—è¡Œ 3. æ ¹æ® æ—¶é—´ è¿‡æ»¤æ—¥å¿—è¡Œ 4. é€€å‡ºç¨‹åº é€šè¿‡ç®€å•çš„èœå•é©±åŠ¨ï¼Œå°†å¸¸ç”¨æ“ä½œå°è£…ä¸ºåŸå­åŠŸèƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚\nå®Œæ•´ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 package main import ( \u0026#34;bufio\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;regexp\u0026#34; \u0026#34;sort\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;time\u0026#34; ) /** * @Author: å—å®«ä¹˜é£ * @Description: * @File: main.go * @Email: 1794748404@qq.com * @Date: 2025-02-17 14:15 */ // æ­£åˆ™åŒ¹é…æ ¼å¼ var logPattern = regexp.MustCompile(`(?P\u0026lt;ip\u0026gt;\\S+) (?P\u0026lt;host\u0026gt;\\S+) (?P\u0026lt;uri\u0026gt;\\S+) \\[(?P\u0026lt;time\u0026gt;.*?)\\] \u0026#34;(?P\u0026lt;user\u0026gt;.*?)\u0026#34; \u0026#34;(?P\u0026lt;scheme\u0026gt;.*?)\u0026#34; \u0026#34;(?P\u0026lt;request\u0026gt;[^\u0026#34;]+)\u0026#34; \u0026#34;(?P\u0026lt;status\u0026gt;\\d+)\u0026#34;`) // æ—¶é—´æ ¼å¼ const timeLayout = \u0026#34;02/Jan/2006:15:04:05 -0700\u0026#34; // åŠ å…¥æ—¶åŒºè§£æ // LogStats æ—¥å¿—ç»Ÿè®¡ç»“æ„ä½“ type LogStats struct { IPs map[string]int Status map[string]int Paths map[string]int Lines []string } // ProcessLine å¤„ç†æ—¥å¿—è¡Œ func (ls *LogStats) ProcessLine(line string) { matches := logPattern.FindStringSubmatch(line) if matches == nil { return } fields := make(map[string]string) for i, name := range logPattern.SubexpNames() { if i != 0 \u0026amp;\u0026amp; name != \u0026#34;\u0026#34; { fields[name] = matches[i] } } ls.IPs[fields[\u0026#34;ip\u0026#34;]]++ ls.Status[fields[\u0026#34;status\u0026#34;]]++ ls.Paths[fields[\u0026#34;uri\u0026#34;]]++ ls.Lines = append(ls.Lines, line) } // printTopN ç»Ÿè®¡æ•°æ® func printTopN(data map[string]int, n int) { type kv struct { Key string Value int } var sortedData []kv for k, v := range data { sortedData = append(sortedData, kv{k, v}) } sort.Slice(sortedData, func(i, j int) bool { return sortedData[i].Value \u0026gt; sortedData[j].Value }) for i, item := range sortedData { if i \u0026gt;= n { break } fmt.Printf(\u0026#34;%s: %d\\n\u0026#34;, item.Key, item.Value) } } // PrintTopN æ‰“å°ç»Ÿè®¡æ•°æ® func (ls *LogStats) PrintTopN(n int) { fmt.Println(\u0026#34;Top IPs:\u0026#34;) printTopN(ls.IPs, n) fmt.Println(\u0026#34;\\nTop Status Codes:\u0026#34;) printTopN(ls.Status, n) fmt.Println(\u0026#34;\\nTop Paths:\u0026#34;) printTopN(ls.Paths, n) } // FilterLines æ ¹æ®å…³é”®å­—è¿‡æ»¤æ—¥å¿— func (ls *LogStats) FilterLines(keyword string) { fmt.Println(\u0026#34;Filtered Lines:\u0026#34;) for _, line := range ls.Lines { if strings.Contains(line, keyword) { fmt.Println(line) } } } // FilterByTime æ ¹æ®æ—¶é—´è¿‡æ»¤æ—¥å¿— func (ls *LogStats) FilterByTime(start, end string) { fmt.Println(\u0026#34;æŒ‰æ—¶é—´ç­›é€‰æ—¥å¿—:\u0026#34;) startTime, err1 := time.Parse(timeLayout, start) endTime, err2 := time.Parse(timeLayout, end) if err1 != nil || err2 != nil { fmt.Println(\u0026#34;Invalid time format. Use: 02/Jan/2006:15:04:05 -0700\u0026#34;) return } for _, line := range ls.Lines { matches := logPattern.FindStringSubmatch(line) if matches == nil { continue } logTime, err := time.Parse(timeLayout, matches[4]) // ç›´æ¥è§£ææ—¥å¿—ä¸­çš„å®Œæ•´æ—¶é—´æˆ³ if err != nil { continue } if (logTime.Equal(startTime) || logTime.After(startTime)) \u0026amp;\u0026amp; logTime.Before(endTime) { fmt.Println(line) } } } // NewLogStats åˆ›å»ºæ–°çš„ LogStats å®ä¾‹ func NewLogStats() *LogStats { return \u0026amp;LogStats{ IPs: make(map[string]int), Status: make(map[string]int), Paths: make(map[string]int), Lines: []string{}, } } // main å‡½æ•° func main() { // æ£€æŸ¥å‚æ•° if len(os.Args) \u0026lt; 2 { fmt.Println(\u0026#34;Usage: log-analyzer \u0026lt;logfile\u0026gt;\u0026#34;) os.Exit(1) } // æ‰“å¼€æ–‡ä»¶ file, err := os.Open(os.Args[1]) if err != nil { fmt.Println(\u0026#34;Error opening file:\u0026#34;, err) os.Exit(1) } defer file.Close() // åˆ›å»º LogStats å®ä¾‹ stats := NewLogStats() // è¯»å–æ–‡ä»¶ scanner := bufio.NewScanner(file) for scanner.Scan() { stats.ProcessLine(scanner.Text()) } if err := scanner.Err(); err != nil { fmt.Println(\u0026#34;Error reading file:\u0026#34;, err) } // ä¸»å¾ªç¯ for { fmt.Println(\u0026#34;\\nè¯·é€‰æ‹©æ‚¨çš„æ“ä½œ(è¾“å…¥æ•°å­—:\u0026#34;) fmt.Println(\u0026#34;1. è¾“å‡º Top 10 IPs, Status Codes, and Paths\u0026#34;) fmt.Println(\u0026#34;2. æ ¹æ® keyword è¿‡æ»¤æ—¥å¿—è¡Œ\u0026#34;) fmt.Println(\u0026#34;3. æ ¹æ® æ—¶é—´ è¿‡æ»¤æ—¥å¿—è¡Œ\u0026#34;) fmt.Println(\u0026#34;4. é€€å‡ºç¨‹åº\u0026#34;) fmt.Print(\u0026#34;è¯·è¾“å…¥æ‚¨çš„é€‰æ‹©: \u0026#34;) // è¯»å–ç”¨æˆ·è¾“å…¥ var choice int fmt.Scanln(\u0026amp;choice) // æ ¹æ®é€‰æ‹©æ‰§è¡Œæ“ä½œ switch choice { case 1: stats.PrintTopN(10) case 2: fmt.Print(\u0026#34;æ‚¨è¾“å…¥çš„ keyword æ˜¯: \u0026#34;) var keyword string fmt.Scanln(\u0026amp;keyword) stats.FilterLines(keyword) case 3: reader := bufio.NewReader(os.Stdin) fmt.Print(\u0026#34;Enter start time (format: 29/Jan/2025:12:58:00 +0800): \u0026#34;) startTime, _ := reader.ReadString(\u0026#39;\\n\u0026#39;) startTime = strings.TrimSpace(startTime) // å»é™¤æ¢è¡Œç¬¦ fmt.Print(\u0026#34;Enter end time (format: 29/Jan/2025:12:59:00 +0800): \u0026#34;) var endTime string endTime, _ = reader.ReadString(\u0026#39;\\n\u0026#39;) endTime = strings.TrimSpace(endTime) // å»é™¤æ¢è¡Œç¬¦ stats.FilterByTime(startTime, endTime) case 4: fmt.Println(\u0026#34;é€€å‡º...\u0026#34;) return default: fmt.Println(\u0026#34;æ— æ•ˆçš„é€‰æ‹©, è¯·é‡æ–°è¾“å…¥\u0026#34;) } } } æµ‹è¯• 1 2 ä½¿ç”¨æ–¹æ³• ./äºŒè¿›åˆ¶æ–‡ä»¶ æ—¥å¿—æ–‡ä»¶ Topæ˜¾ç¤º\nå…³é”®å­— æ—¶é—´è¿‡æ»¤ æ€»ç»“ log-analyzer æ˜¯ä¸€ä¸ªè½»é‡çº§ã€å®ç”¨çš„æ—¥å¿—åˆ†æå·¥å…·ï¼Œå®ƒä»¥ç®€æ´çš„ä»£ç å®ç°äº†æ ¸å¿ƒçš„æ—¥å¿—åˆ†æåŠŸèƒ½ï¼Œèƒ½å¤Ÿæœ‰æ•ˆæå‡å¼€å‘è€…å’Œæµ‹è¯•äººå‘˜çš„æ—¥å¸¸å·¥ä½œæ•ˆç‡ã€‚åç»­æ ¹æ®å…¬å¸éœ€æ±‚æ·»åŠ æ›´å¤šçš„åŠŸèƒ½\n","date":"2025-02-17T17:22:29Z","image":"https://www.ownit.top/title_pic/62.jpg","permalink":"https://www.ownit.top/p/202502171722/","title":"è½»é‡çº§æ—¥å¿—åˆ†æåˆ©å™¨ï¼šGoå®æˆ˜"},{"content":"é—®é¢˜èƒŒæ™¯ åœ¨Kubernetesï¼ˆk8sï¼‰ä¸­ï¼ŒPodçš„è‡ªåŠ¨æ‰©å®¹ï¼ˆHorizontal Pod Autoscaler, HPAï¼‰æ˜¯ä¸€ä¸ªå¸¸è§çš„åŠŸèƒ½ï¼Œç”¨äºæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´Podçš„æ•°é‡ã€‚ç„¶è€Œï¼Œå½“æ–°PodåŠ å…¥æ—¶ï¼Œå¦‚æœæ²¡æœ‰é¢„çƒ­æœºåˆ¶ï¼Œæµé‡ä¼šç«‹å³æ¶Œå…¥æ–°Podï¼Œå¯¼è‡´æ–°Podåœ¨å¯åŠ¨åˆæœŸæ— æ³•å¤„ç†å¤§é‡è¯·æ±‚ï¼Œè¿›è€Œå¼•å‘5xxé”™è¯¯ã€CPUé£™å‡ç­‰é—®é¢˜ã€‚ç‰¹åˆ«æ˜¯åœ¨åŸºäºJVMçš„åº”ç”¨ç¨‹åºä¸­ï¼ŒJVMéœ€è¦ä¸€å®šçš„æ—¶é—´è¿›è¡Œé¢„çƒ­ï¼ˆå¦‚JITç¼–è¯‘ã€ç±»åŠ è½½ç­‰ï¼‰ï¼Œæ‰èƒ½è¾¾åˆ°æœ€ä½³æ€§èƒ½ã€‚\né˜¿é‡Œäº‘ä»‹ç»ï¼š åœ¨æœªå¯ç”¨æ…¢å¯åŠ¨é¢„çƒ­åŠŸèƒ½æ—¶ï¼Œæ¯å½“æ–°ç›®æ ‡PodåŠ å…¥æ—¶ï¼Œè¯·æ±‚æ–¹éƒ½ä¼šå‘è¯¥Podå‘é€ä¸€å®šæ¯”ä¾‹çš„æµé‡ï¼Œä¸æ”¯æŒæ–°Podçš„æ¸è¿›å¼æµé‡å¢åŠ ã€‚è¿™å¯¹äºéœ€è¦ä¸€äº›é¢„çƒ­æ—¶é—´æ¥æä¾›å…¨éƒ¨è´Ÿè½½çš„æœåŠ¡å¯èƒ½æ˜¯ä¸å¯å–çš„ï¼Œå¹¶ä¸”å¯èƒ½ä¼šå¯¼è‡´è¯·æ±‚è¶…æ—¶ã€æ•°æ®ä¸¢å¤±å’Œç”¨æˆ·ä½“éªŒæ¶åŒ–ã€‚ä¾‹å¦‚åœ¨åŸºäºJVMçš„Webåº”ç”¨ç¨‹åºä¸­ï¼Œè¿™äº›åº”ç”¨ç¨‹åºä½¿ç”¨æ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾ã€‚å½“æœåŠ¡åˆšå¯åŠ¨æ—¶ï¼Œå®ƒä¼šè¢«å¤§é‡è¯·æ±‚æ·¹æ²¡ï¼Œè¿™ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºé¢„çƒ­æ—¶æŒç»­è¶…æ—¶ã€‚å› æ­¤ï¼Œæ¯æ¬¡æ‰©å±•æœåŠ¡æ—¶ï¼Œéƒ½ä¼šä¸¢å¤±æ•°æ®æˆ–è€…ä¼šå¯¼è‡´è¿™éƒ¨åˆ†è¯·æ±‚çš„å“åº”æ—¶é—´å¢åŠ ã€‚é¢„çƒ­çš„åŸºæœ¬æ€æƒ³å°±æ˜¯è®©åˆšå¯åŠ¨çš„æœºå™¨é€æ­¥æ¥å…¥æµé‡ã€‚ åœ°å€ï¼šhttps://help.aliyun.com/zh/asm/user-guide/use-the-warm-up-feature\né—®é¢˜åˆ†æ æ˜¯ä»€ä¹ˆï¼š Podæ‰©å®¹æ—¶çš„æµé‡åˆ†é…é—®é¢˜ï¼šå½“æ–°PodåŠ å…¥æ—¶ï¼ŒKubernetesé»˜è®¤ä¼šå°†æµé‡å‡åŒ€åˆ†é…åˆ°æ‰€æœ‰Podï¼ˆåŒ…æ‹¬æ–°Podï¼‰ï¼Œå¯¼è‡´æ–°Podåœ¨å¯åŠ¨åˆæœŸæ— æ³•å¤„ç†å¤§é‡è¯·æ±‚ã€‚ é¢„çƒ­é™·é˜±ï¼šæ–°Podåœ¨å¯åŠ¨åˆæœŸéœ€è¦æ—¶é—´è¿›è¡Œé¢„çƒ­ï¼ˆå¦‚JVMçš„JITç¼–è¯‘ã€ç¼“å­˜é¢„çƒ­ç­‰ï¼‰ï¼Œå¦‚æœæ­¤æ—¶æ¶Œå…¥å¤§é‡è¯·æ±‚ï¼Œä¼šå¯¼è‡´è¯·æ±‚è¶…æ—¶ã€5xxé”™è¯¯ã€CPUé£™å‡ç­‰é—®é¢˜ã€‚ ä¸ºä»€ä¹ˆï¼š æµé‡åˆ†é…æœºåˆ¶ï¼šKubernetesé»˜è®¤çš„æµé‡åˆ†é…æœºåˆ¶æ˜¯å‡åŒ€åˆ†é…ï¼Œä¸æ”¯æŒæ¸è¿›å¼æµé‡å¢åŠ ã€‚ é¢„çƒ­éœ€æ±‚ï¼šæŸäº›åº”ç”¨ç¨‹åºï¼ˆå¦‚åŸºäºJVMçš„åº”ç”¨ï¼‰åœ¨å¯åŠ¨åˆæœŸéœ€è¦æ—¶é—´è¿›è¡Œé¢„çƒ­ï¼Œæ‰èƒ½è¾¾åˆ°æœ€ä½³æ€§èƒ½ã€‚ æ€ä¹ˆåšï¼š è§£å†³æ–¹æ¡ˆï¼šé€šè¿‡å¼•å…¥é¢„çƒ­æœºåˆ¶ï¼Œè®©æ–°Podåœ¨å¯åŠ¨åˆæœŸé€æ­¥æ¥å…¥æµé‡ï¼Œé¿å…ä¸€æ¬¡æ€§æ¶Œå…¥å¤§é‡è¯·æ±‚ è§£å†³æ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨Istioçš„LoadBalancerSettingsè¿›è¡Œæµé‡é¢„çƒ­ æ…¢å¯åŠ¨æ¨¡å¼åˆç§°æ¸è¿›å¼æµé‡å¢åŠ ï¼Œç”¨æˆ·å¯ä»¥ä¸ºæœåŠ¡é…ç½®ä¸€ä¸ªæ—¶é—´æ®µï¼Œæ¯å½“ä¸€ä¸ªæœåŠ¡å®ä¾‹å¯åŠ¨æ—¶ï¼Œè¯·æ±‚æ–¹ä¼šå‘è¯¥å®ä¾‹å‘é€ä¸€éƒ¨åˆ†è¯·æ±‚è´Ÿè½½ï¼Œå¹¶åœ¨é…ç½®çš„æ—¶é—´æ®µå†…é€æ­¥å¢åŠ è¯·æ±‚é‡ã€‚å½“æ…¢å¯åŠ¨çª—å£æŒç»­æ—¶é—´åˆ°è¾¾ï¼Œå°±ä¼šé€€å‡ºæ…¢å¯åŠ¨æ¨¡å¼ã€‚\nåœ¨æ…¢å¯åŠ¨æ¨¡å¼ä¸‹ï¼Œæ·»åŠ æ–°çš„ç›®æ ‡æœåŠ¡Podæ—¶ï¼Œé¿å…æ–°å¢Podè¢«å¤§é‡è¯·æ±‚å‡»å®ï¼Œè¿™äº›æ–°ç›®æ ‡æœåŠ¡å¯ä»¥æ ¹æ®æŒ‡å®šçš„åŠ é€ŸæœŸåœ¨æ¥å—å…¶å‡è¡¡ç­–ç•¥çš„è¯·æ±‚ä¹‹å‰è¿›è¡Œé¢„çƒ­ã€‚\næ…¢å¯åŠ¨å¯¹äºä¾èµ–ç¼“å­˜å¹¶ä¸”éœ€è¦é¢„çƒ­æœŸæ‰èƒ½ä»¥æœ€ä½³æ€§èƒ½å“åº”è¯·æ±‚çš„åº”ç”¨ç¨‹åºéå¸¸æœ‰ç”¨ã€‚åªéœ€åœ¨æœåŠ¡å¯¹åº”çš„DestinationRuleä¸‹çš„é…ç½®trafficPolicy/loadBalancerå³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š\nloadBalancerï¼šè¡¨ç¤ºè´Ÿè½½å‡è¡¡å™¨ä¿¡æ¯ã€‚ç±»å‹é™å®šäºROUND_ROBINå’ŒLEAST_REQUESTè´Ÿè½½å‡è¡¡å™¨ã€‚\nwarmupDurationSecsï¼šè¡¨ç¤ºServiceçš„é¢„çƒ­æŒç»­æ—¶é—´ã€‚å¦‚æœè®¾ç½®ï¼Œåˆ™æ–°åˆ›å»ºçš„æœåŠ¡ç«¯ç‚¹åœ¨æ­¤çª—å£æœŸé—´ä»å…¶åˆ›å»ºæ—¶é—´å¼€å§‹ä¿æŒé¢„çƒ­æ¨¡å¼ï¼Œå¹¶ä¸”Istioé€æ¸å¢åŠ è¯¥ç«¯ç‚¹çš„æµé‡ï¼Œè€Œä¸æ˜¯å‘é€æˆæ¯”ä¾‹çš„æµé‡ã€‚\næ…¢å¯åŠ¨è¦æ±‚åº”ç”¨åœ¨å½“å‰å¯ç”¨åŒºçš„å‰¯æœ¬æ•°ä¸ä¸º0ã€‚ä¾‹å¦‚ï¼š\næ•°æ®é¢é›†ç¾¤åªæœ‰ä¸€ä¸ªå¯ç”¨åŒºAï¼Œå¯ç”¨åŒºAä¸­å½“å‰æœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œå¯åŠ¨ç¬¬äºŒä¸ªæ—¶ï¼Œæ…¢å¯åŠ¨ä¼šç”Ÿæ•ˆã€‚\næ•°æ®é¢é›†ç¾¤æœ‰ä¸¤ä¸ªå¯ç”¨åŒºAã€Bï¼Œå½“å‰åº”ç”¨åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œä¸”ä½äºå¯ç”¨åŒºAï¼Œå¦‚æœå¯åŠ¨çš„ç¬¬äºŒä¸ªå‰¯æœ¬ä½äºå¯ç”¨åŒºBï¼ˆä¸€äº›è°ƒåº¦å™¨ä¼šé»˜è®¤é‡‡ç”¨è·¨å¯ç”¨åŒºåˆ†å¸ƒçš„ç­–ç•¥ï¼‰ï¼Œåˆ™ä¸ä¼šè§¦å‘æ…¢å¯åŠ¨ã€‚æ­¤æ—¶ï¼Œå¦‚æœå†å¯åŠ¨ç¬¬ä¸‰ä¸ªå‰¯æœ¬ï¼Œæ…¢å¯åŠ¨ä¼šç”Ÿæ•ˆã€‚\nIstio æä¾›äº†LoadBalancerSettingsé…ç½®ï¼Œå¯ä»¥é€šè¿‡warmupDurationSecså‚æ•°å®ç°æµé‡é¢„çƒ­ã€‚è¯¥å‚æ•°å…è®¸æ–°Podåœ¨å¯åŠ¨åçš„ä¸€æ®µæ—¶é—´å†…é€æ­¥å¢åŠ æµé‡ã€‚ åœ°å€ï¼šhttps://istio.io/latest/docs/reference/config/networking/destination-rule/#LoadBalancerSettings æ­¥éª¤ï¼š\nåœ¨Istioçš„DestinationRuleä¸­é…ç½®LoadBalancerSettingsã€‚ è®¾ç½®warmupDurationSecså‚æ•°ï¼Œå®šä¹‰é¢„çƒ­æ—¶é—´ã€‚ ä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: mocka spec: host: mocka trafficPolicy: loadBalancer: simple: ROUND_ROBIN warmupDurationSecs: 300 # é¢„çƒ­æ—¶é—´ä¸º300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰ ä¼˜ç‚¹ï¼š\nç®€å•æ˜“ç”¨ï¼Œç›´æ¥é€šè¿‡Istioé…ç½®å®ç°æµé‡é¢„çƒ­ã€‚ æ— éœ€ä¿®æ”¹åº”ç”¨ç¨‹åºä»£ç ã€‚ ç¼ºç‚¹ï¼š\néœ€è¦éƒ¨ç½²Istioï¼Œå¢åŠ äº†ç³»ç»Ÿå¤æ‚æ€§ã€‚ æ–¹æ¡ˆäºŒï¼šä½¿ç”¨é˜¿é‡Œäº‘çš„JVMé¢„çƒ­æ–¹æ¡ˆï¼ˆjwarmupï¼‰ å‚è€ƒæ–‡æ¡£ï¼šhttps://baijiahao.baidu.com/s?id=1752631259548476891\u0026amp;wfr=spider\u0026amp;for=pc\né˜¿é‡Œäº‘æä¾›äº†jwarmupå·¥å…·ï¼Œå¯ä»¥å°†JVMçš„JITç¼–è¯‘ä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œä¸‹æ¬¡å‘å¸ƒæ—¶è‡ªåŠ¨åŠ è½½ï¼Œä»è€ŒåŠ é€ŸJVMé¢„çƒ­è¿‡ç¨‹ã€‚\nJwarmUpçš„åŸºæœ¬åŸç†ï¼šæ ¹æ®å‰ä¸€æ¬¡ç¨‹åºè¿è¡Œçš„æƒ…å†µï¼Œè®°å½•çƒ­ç‚¹ä»£ç ä»¥åŠç±»åŠ è½½é¡ºåºç­‰ä¿¡æ¯ã€‚åœ¨åº”ç”¨ä¸‹ä¸€æ¬¡å¯åŠ¨çš„æ—¶å€™ç§¯æä¸»åŠ¨åœ°å¯¹ç›¸å…³ç±»è¿›è¡ŒåŠ è½½ï¼Œå¹¶ç§¯æç¼–è¯‘ç›¸å…³ä»£ç ï¼Œè¿›è€Œä½¿å¾—åº”ç”¨å°½å¿«ä½¿ç”¨ä¸ŠC2ç¼–è¯‘ä¼˜åŒ–çš„æŒ‡ä»¤ã€‚ä»è€Œåœ¨æµé‡è¿›æ¥ä¹‹å‰ï¼Œæå‰å®Œæˆç±»çš„åŠ è½½ã€åˆå§‹åŒ–å’Œæ–¹æ³•ç¼–è¯‘, è·³è¿‡è§£é‡Šé˜¶æ®µ, ç›´æ¥æ‰§è¡Œç¼–è¯‘å¥½çš„native code, é¿å…ä¸€é¢è§£é‡Šæ‰§è¡Œä¸€é¢åå°ç¼–è¯‘å¸¦æ¥çš„CPUä¸loadé£™é«˜, rtè¶…æ—¶ç­‰é—®é¢˜ã€‚\nä¸Šæ–¹ä¸ºJWarmupçš„æµç¨‹å›¾ï¼Œå®ƒå°†åº”ç”¨ç¨‹åºçš„å‘å¸ƒåˆ†æˆäº†ä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯Recordingå’ŒReplayingã€‚åœ¨Recordingé˜¶æ®µï¼ŒJVMä¼šæ¥å—çº¿ä¸Šçš„è¯·æ±‚ï¼ŒåŒæ—¶è®°å½•JVMå³æ—¶ç¼–è¯‘å™¨å®ƒæ‰€ç¼–è¯‘æ–¹æ³•çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å°†è¿™äº›ä¿¡æ¯éƒ½è¾“å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶ä¹‹ä¸­ã€‚ ç­‰åˆ°ç¬¬äºŒæ¬¡å†å»å¯åŠ¨çš„æ—¶å€™ï¼ŒJVMå°±å¯ä»¥å»è¯»å–åˆšåˆšæ‰€è®°å½•çš„è¿™äº›æ–¹æ³•ç¼–è¯‘çš„ä¿¡æ¯ï¼ŒåŒæ—¶ä¼šä¸»åŠ¨çš„è§¦å‘å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åˆšåˆšè®°å½•çš„çƒ­ç‚¹æ–¹æ³•ï¼Œä½¿å¾—åœ¨ç”¨æˆ·è¯·æ±‚åˆ°æ¥ä¹‹å‰ï¼Œå°±æŠŠçƒ­ç‚¹æ–¹æ³•ç¼–è¯‘æˆä¸ºæ€§èƒ½è¾ƒé«˜çš„Native Codeï¼Œé¿å…äº†åœ¨ç”¨æˆ·è¯·æ±‚å¤§é‡è¿›å…¥çš„æ—¶å€™åšç¼–è¯‘ï¼Œè¿™æ ·å°±èƒ½å¤Ÿè¿›ä¸€æ­¥æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼ŒèŠ‚çº¦CPUä½¿ç”¨ç‡ã€‚\næ­¥éª¤ï¼š\nåœ¨åº”ç”¨ç¨‹åºä¸­é›†æˆjwarmupå·¥å…·ã€‚ åœ¨å‘å¸ƒå‰è¿è¡Œjwarmupï¼Œç”ŸæˆJITç¼–è¯‘ä¿¡æ¯æ–‡ä»¶ã€‚ åœ¨ä¸‹æ¬¡å‘å¸ƒæ—¶ï¼Œè‡ªåŠ¨åŠ è½½JITç¼–è¯‘ä¿¡æ¯æ–‡ä»¶ã€‚ ä»£ç ç¤ºä¾‹ï¼š\nè®°å½•ç¼–è¯‘ä¿¡æ¯é˜¶æ®µ 1 -XX:+CompilationWarmUpRecording -XX:CompilationWarmUpLogfile=jwarmup.log -XX:CompilationWarmUpRecordTime=300 è®°å½•æ¨¡å¼ã€è®°å½•å­˜å‚¨çš„jwarmup.logï¼Œåœ¨5åˆ†é’Ÿåç”Ÿæˆprofiling data\nä½¿ç”¨ç¼–è¯‘ä¿¡æ¯é˜¶æ®µ 1 -XX:+CompilationWarmUp -XX:CompilationWarmUpLogfile=jwarmup.log -XX:CompilationWarmUpDeoptTime=0 JWarmUpä¼šåœ¨æŒ‡å®šæ—¶é—´é€€ä¼˜åŒ–warmupç¼–è¯‘çš„æ–¹æ³•ï¼Œè®¾ç½®CompilationWarmUpDeoptTimeä¸º0å¯ä»¥å–æ¶ˆè¿™ä¸ªå®šæ—¶ã€‚\n1ã€recordingè®°å½•ä¸‹æ¥çš„æ—¥å¿—ï¼Œæ˜¯æ€ä¹ˆåˆ†å‘åˆ°å…¶ä»–çº¿ä¸Šæœºçš„ï¼Ÿ\nç­”ï¼šåœ¨åº”ç”¨å¯åŠ¨çš„è„šæœ¬æ–‡ä»¶è¿›è¡Œæ§åˆ¶ï¼š\né¢„çƒ­èŠ‚ç‚¹ï¼Œä¼šå°†è®°å½•ä¸‹æ¥çš„ç¼–è¯‘ä¿¡æ¯ä¸Šä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨ossä¸Šï¼Œ å‘å¸ƒèŠ‚ç‚¹ï¼Œåœ¨å¯åŠ¨æ—¶ä»è¿œå¤„æœºå™¨ä¸»åŠ¨pullä¸‹æ¥é¢„çƒ­èŠ‚ç‚¹ä¸Šä¼ çš„ç¼–è¯‘ä¿¡æ¯ã€‚ 2ã€æ˜¯æ€ä¹ˆåˆ¶å®šä¸€å°æœºå™¨åšrecordingçš„å‘¢ï¼Ÿæ˜¯è®¿é—®æŸä¸ªurlè¿˜æ˜¯åˆ¤æ–­betaæœºå™¨ï¼Ÿ\nç­”ï¼šæ˜¯é€šè¿‡è®¿é—®ossåšäº†ä¸€ä¸ªç±»ä¼¼äºâ€œæ–‡ä»¶é”â€çš„ä¸œè¥¿ï¼Œå…ˆæ‹¿åˆ°é”çš„betaæœºå™¨åšä¸ºé¢„çƒ­èŠ‚ç‚¹ï¼Œå…¶ä½™æœºå™¨ä¸ºå‘å¸ƒèŠ‚ç‚¹ã€‚æƒ³è¦è¾¾åˆ°é¢„çƒ­çš„æ•ˆæœè¯·ç¡®ä¿ï¼š\nå‘å¸ƒçš„æœºå™¨çš„å‚æ•°ä¸­æœ‰ -XX:+CompilationWarmUp æ¯æ¬¡betaå‘å¸ƒåï¼Œè®°å¾—æ£€æŸ¥ä¸‹ç¼–è¯‘ä¿¡æ¯æ–‡ä»¶æ˜¯å¦å·²ç»ä¸Šä¼  betaå‘å¸ƒçš„é‚£å°æœºå™¨å¿…é¡»æ˜¯æœ‰æµé‡çš„ï¼ŒRecordingæ—¶é—´ä¸è¦å¤ªçŸ­ï¼Œå°½é‡å¤šç¼–è¯‘ä¸€äº›æ–¹æ³•ã€‚ å¦‚æœä¸ä¿è¯ä¸Šè¿°ä¸¤ç‚¹çš„è¯ï¼Œä¾¿æ— æ³•å®Œæˆé¢„çƒ­å‘å¸ƒï¼Œå³æ²¡æœ‰å……åˆ†åˆ©ç”¨betaçš„ç¼–è¯‘ä¿¡æ¯ï¼Œä»ç„¶èµ°æ­£å¸¸å‘å¸ƒçš„æµç¨‹\næ–¹æ¡ˆä¸‰ï¼šæ‰‹åŠ¨é¢„çƒ­æ¥å£ åœ¨Podå¯åŠ¨åï¼Œæ‰‹åŠ¨è°ƒç”¨æ‰€æœ‰æ¥å£è¿›è¡Œé¢„çƒ­ï¼Œç„¶åå†æ¥å…¥æµé‡ã€‚\næ­¥éª¤ï¼š\nåœ¨Podå¯åŠ¨åï¼Œç¼–å†™è„šæœ¬è°ƒç”¨æ‰€æœ‰æ¥å£ã€‚ ç¡®ä¿æ‰€æœ‰æ¥å£éƒ½è¢«è°ƒç”¨åï¼Œå†æ¥å…¥æµé‡ã€‚ ä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 # é¢„çƒ­è„šæœ¬ç¤ºä¾‹ curl http://my-service/api/endpoint1 curl http://my-service/api/endpoint2 curl http://my-service/api/endpoint3 ä¼˜ç‚¹ï¼š\nç®€å•ç›´æ¥ï¼Œé€‚ç”¨äºæ‰€æœ‰ç±»å‹çš„åº”ç”¨ç¨‹åºã€‚ æ— éœ€é¢å¤–å·¥å…·æˆ–é…ç½®ã€‚ ç¼ºç‚¹ï¼š\néœ€è¦æ‰‹åŠ¨ç¼–å†™å’Œç»´æŠ¤é¢„çƒ­è„šæœ¬ã€‚ æ— æ³•åŠ¨æ€è°ƒæ•´é¢„çƒ­æ—¶é—´ã€‚ æ–¹æ¡ˆå››ï¼šä½¿ç”¨Kubernetesçš„Readiness Probe é€šè¿‡é…ç½®Kubernetesçš„Readiness Probeï¼Œç¡®ä¿Podåœ¨å®Œå…¨é¢„çƒ­åå†æ¥å…¥æµé‡ã€‚\næ­¥éª¤ï¼š\nåœ¨Podçš„Readiness Probeä¸­é…ç½®é¢„çƒ­æ£€æŸ¥ã€‚ ç¡®ä¿Podåœ¨é¢„çƒ­å®Œæˆåå†æ ‡è®°ä¸ºReadyã€‚ ä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: Pod metadata: name: my-pod spec: containers: - name: my-container image: my-image readinessProbe: httpGet: path: /healthz port: 8080 initialDelaySeconds: 60 # å»¶è¿Ÿ60ç§’å¼€å§‹æ£€æŸ¥ periodSeconds: 10 # æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡ ä¼˜ç‚¹ï¼š\nç®€å•æ˜“ç”¨ï¼Œç›´æ¥é€šè¿‡Kubernetesé…ç½®å®ç°ã€‚ æ— éœ€ä¿®æ”¹åº”ç”¨ç¨‹åºä»£ç ã€‚ ç¼ºç‚¹ï¼š\næ— æ³•ç²¾ç¡®æ§åˆ¶é¢„çƒ­æ—¶é—´ã€‚ éœ€è¦åº”ç”¨ç¨‹åºæä¾›å¥åº·æ£€æŸ¥æ¥å£ã€‚ ","date":"2025-02-16T19:50:18Z","image":"https://www.ownit.top/title_pic/59.jpg","permalink":"https://www.ownit.top/p/202502161950/","title":"Kubernetes Podæ‰©å®¹é¢„çƒ­é™·é˜±ï¼šå¦‚ä½•é¿å…5xxé”™è¯¯å’ŒCPUé£™å‡ï¼Ÿ"},{"content":"èƒŒæ™¯ è¿‘æœŸï¼Œéšç€æœºæˆ¿è¿ç§»çš„è¿›è¡Œï¼Œä¸ºäº†æå‡ç”µåŠ›ä¿éšœå¹¶ç¡®ä¿è®¾å¤‡çš„æŒç»­è¿è¡Œï¼Œæˆ‘ä»¬åœ¨åŸæœ‰åŸºç¡€ä¸Šæ–°å¢äº†å¤šå°å±±ç‰¹UPSç”µæºä½œä¸ºå¤‡ç”¨ç”µæºã€‚è¿™äº›UPSç”µæºçš„ä¸»è¦ä½œç”¨æ˜¯åœ¨ç”µåŠ›ä¸­æ–­æ—¶ä¸ºæœºæˆ¿è®¾å¤‡æä¾›è¶³å¤Ÿçš„ç”µåŠ›æ”¯æŒï¼Œç¡®ä¿è®¾å¤‡æœ‰å……è¶³çš„æ—¶é—´è¿›è¡Œæ­£å¸¸å…³æœºï¼Œé¿å…ç”±äºçªç„¶æ–­ç”µå¸¦æ¥çš„æ•°æ®ä¸¢å¤±æˆ–ç¡¬ä»¶æŸåã€‚ ç„¶è€Œï¼ŒUPSç”µæºæœ¬èº«å¹¶æœªè¿›è¡Œæœ‰æ•ˆçš„ç›‘æ§ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æ— æ³•å®æ—¶æŒæ¡UPSçš„å·¥ä½œçŠ¶æ€ã€ç”µæ± ç”µé‡ç­‰å…³é”®ä¿¡æ¯ï¼Œä»è€Œé”™å¤±å¯èƒ½å‡ºç°æ•…éšœçš„æ—©æœŸé¢„è­¦ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜æœºæˆ¿ç”µåŠ›ç®¡ç†çš„æ™ºèƒ½åŒ–æ°´å¹³ï¼Œç¡®ä¿UPSç”µæºçš„ç¨³å®šæ€§ä¸å¯é æ€§ï¼Œæˆ‘ä»¬å†³å®šå¯¹è¿™äº›UPSç”µæºè¿›è¡Œå…¨é¢çš„ç›‘æ§ã€‚\nç›®çš„ é€šè¿‡æ„å»ºä¸€ä¸ªå®Œæ•´çš„UPSç›‘æ§æ–¹æ¡ˆï¼Œä¸ä»…èƒ½åŠæ—¶å‘ç°UPSçš„æ•…éšœæˆ–å¼‚å¸¸çŠ¶æ€ï¼Œè¿˜èƒ½å¤Ÿåœ¨ç”µæ± ç”µé‡ä¸è¶³ç­‰ç´§æ€¥æƒ…å†µä¸‹ï¼Œæå‰åšå‡ºé¢„è­¦ï¼Œé¿å…å¯¹æœºæˆ¿è®¾å¤‡é€ æˆä¸å¿…è¦çš„å½±å“ã€‚\nç›‘æ§ç›®æ ‡ ç›‘æ§UPSçŠ¶æ€ï¼šå®æ—¶è·å–UPSçš„è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æ˜¯å¦æ­£å¸¸ã€æ˜¯å¦æœ‰æ•…éšœç­‰ã€‚ ç›‘æ§UPSç”µæ± å®¹é‡ï¼šç¡®ä¿ç”µæ± å®¹é‡å¥åº·ï¼Œé¿å…çªç„¶æ–­ç”µã€‚ ç›‘æ§UPSè¾“å…¥ç”µå‹ï¼šç¡®ä¿UPSæ¥æ”¶åˆ°çš„ç”µå‹ç¬¦åˆæ ‡å‡†ã€‚ æé«˜è¿ç»´æ•ˆç‡ï¼šé€šè¿‡è‡ªåŠ¨åŒ–ç›‘æ§ï¼Œå‡å°‘äººå·¥æ£€æŸ¥å’Œå¹²é¢„ã€‚ æ“ä½œæ­¥éª¤ 1. é…ç½®å±±ç‰¹UPSå®¢æˆ·ç«¯ ä¸ºäº†ä½¿Zabbixèƒ½å¤Ÿç›‘æ§å±±ç‰¹UPSç”µæºï¼Œæˆ‘ä»¬éœ€è¦ä»UPSç³»ç»Ÿä¸­è·å–ç›¸å…³æ•°æ®ã€‚å‡è®¾å±±ç‰¹UPSçš„IPä¸º192.168.81.11ï¼Œå¹¶ä¸”å®ƒæ”¯æŒé€šè¿‡HTTPæ¥å£è¾“å‡ºçŠ¶æ€æ•°æ®ï¼ˆæ¯”å¦‚é€šè¿‡REST APIè·å–JSONæ ¼å¼çš„æ•°æ®ï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªShellè„šæœ¬ï¼Œé€šè¿‡è°ƒç”¨UPSçš„APIæ¥å£ï¼Œæå–æ•°æ®å¹¶äº¤ç»™Zabbixç›‘æ§ã€‚\nå…³äºç›‘æ§è½¯ä»¶çš„å®‰è£…ï¼š\nä¸‹è½½è½¯ä»¶ï¼šhttps://www.santak.com.cn/page/santak-downloads.html è½¯ä»¶åï¼šWinpower_setup_LinuxAMD64.tar.gz\nè¿æ¥COMçº¿å¹¶è½¬ä¸ºUSBæ’å…¥åˆ°è´Ÿè´£ç›‘æ§çš„æœåŠ¡å™¨ï¼Œå½“å‰å¯åŠ¨ç›‘æ§è½¯ä»¶çš„æœåŠ¡å™¨ä¸º192.168.81.11 å®‰è£…ï¼š\n1 2 3 4 5 6 tar zxf Winpower_setup_LinuxAMD64.tar.gz cd Winpower_setup_LinuxAMD64/LinuxAMD64/ ./setup_console.bin # ä¸€è·¯å›è½¦å³å¯ # å¯åŠ¨agent cd /opt/MonitorSoftware/ ./agent start é…ç½®ï¼š\n1 2 # éœ€è¦å®‰è£…å›¾å½¢åŒ–ç•Œé¢ startx 1 2 3 # å¯åŠ¨ç®¡ç†è½¯ä»¶ cd /opt/MonitorSoftware/ ./monitor é…ç½®USBæ¥å£ï¼šç³»ç»Ÿ-\u0026gt;æˆä¸ºç³»ç»Ÿç®¡ç†å‘˜(é»˜è®¤æ²¡æœ‰å¯†ç ï¼Œç›´æ¥ç¡®è®¤å³å¯)-\u0026gt;é€šè®¯å£è®¾å®š-\u0026gt;è¾“å…¥/dev/ttyUSB1å¢åŠ â†’è¾“å…¥/dev/ttyUSB2å¢åŠ â†’ç¡®å®š\næ‰«æè®¾å¤‡ï¼šç³»ç»Ÿâ†’è‡ªåŠ¨æœç´¢è®¾å¤‡ï¼Œå®Œæˆåå³å¯åœ¨é¡µé¢æ˜¾ç¤ºå¯¹åº”çš„UPSçŠ¶æ€ä¿¡æ¯ é…ç½®httpsç«¯å£ï¼šè¿œç¨‹ç›‘æ§-\u0026gt;WebæœåŠ¡å™¨æ§åˆ¶-\u0026gt;åœæ­¢-\u0026gt;è¿œç¨‹ç›‘æ§-\u0026gt;WebæœåŠ¡å™¨æ§åˆ¶â†’ä¿®æ”¹ç«¯å£ä¸º10086-\u0026gt;å¼€å§‹-\u0026gt;ç¡®å®š\næ‰“å¼€ç½‘é¡µ 2. æµ‹è¯•æ•°æ® è®¿é—®\n1 2 0 ä»£è¡¨upsçš„ä½ç½®ï¼Œå‡å¦‚æœ‰ä¸‰å°ï¼Œåˆ™æ˜¯ï¼š0 1 2 åœ°å€ï¼šhttps://192.168.96.200:8888/0/json 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 { \u0026#34;key\u0026#34;: \u0026#34;COM3/C6K\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;\u0026#34;, -\u0026#34;device\u0026#34;: { \u0026#34;key\u0026#34;: \u0026#34;COM3/C6K\u0026#34;, \u0026#34;id\u0026#34;: 0, \u0026#34;protocol\u0026#34;: 18, \u0026#34;portIndex\u0026#34;: 1, \u0026#34;ip\u0026#34;: null, \u0026#34;status\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;upsIndex\u0026#34;: 0, \u0026#34;statusIcon\u0026#34;: \u0026#34;online\u0026#34;, \u0026#34;hasWarn\u0026#34;: false }, \u0026#34;status\u0026#34;: \u0026#34;æ­£å¸¸\u0026#34;, \u0026#34;model\u0026#34;: \u0026#34;C6K\u0026#34;, \u0026#34;loadPercentMax\u0026#34;: 16, \u0026#34;loadSegment2State\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;loadSegment1State\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;redundantNumber\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;inVolt\u0026#34;: \u0026#34;231.6V\u0026#34;, \u0026#34;bypassFreq\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;workMode\u0026#34;: 3, \u0026#34;loadPercent\u0026#34;: \u0026#34;16%\u0026#34;, \u0026#34;lsCounter\u0026#34;: -1, \u0026#34;extStatus\u0026#34;: 0, \u0026#34;oidType\u0026#34;: 0, \u0026#34;outFreq\u0026#34;: \u0026#34;50.0Hz\u0026#34;, \u0026#34;warning\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;noModule\u0026#34;: false, \u0026#34;batCapacity\u0026#34;: \u0026#34;100%\u0026#34;, \u0026#34;batTimeRemain\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;bypassVolt\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;inFreq\u0026#34;: \u0026#34;50.0Hz\u0026#34;, \u0026#34;iStatus\u0026#34;: 0, \u0026#34;outVolt\u0026#34;: \u0026#34;219.5V\u0026#34;, \u0026#34;abmState\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;emdAlarm1\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;cfgBatNumber\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;cfgKVA\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;emdAlarm2\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;batTemp\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;emdHumidity\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;emdTemp\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;lastEvent1\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;statusColor\u0026#34;: 0, \u0026#34;supportTest\u0026#34;: true, \u0026#34;upsTemp\u0026#34;: \u0026#34;27.2C\u0026#34;, \u0026#34;lastEvent2\u0026#34;: \u0026#34;2025/01/15 17:34:54 Agentå¯åŠ¨\u0026#34;, \u0026#34;batV\u0026#34;: \u0026#34;201.9V\u0026#34;, \u0026#34;outVA\u0026#34;: \u0026#34;0.9KVA\u0026#34;, \u0026#34;ls1\u0026#34;: -1, \u0026#34;outW\u0026#34;: \u0026#34;0.6KW\u0026#34;, \u0026#34;ls2\u0026#34;: -1, \u0026#34;outA\u0026#34;: \u0026#34;\u0026#34; } 3. å®‰è£…Zabbix Agentå¹¶é…ç½® åœ¨ç›‘æ§æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å®‰è£…Zabbix Agentï¼ŒZabbix Agentæ˜¯ç”¨æ¥é‡‡é›†æ•°æ®å¹¶å°†å…¶ä¼ é€’ç»™Zabbix Serverçš„å·¥å…·ã€‚å‡è®¾ç›‘æ§æœåŠ¡å™¨IPä¸º192.168.82.12ï¼Œæˆ‘ä»¬å°†åœ¨æ­¤æœåŠ¡å™¨ä¸Šè¿›è¡Œå®‰è£…å¹¶é…ç½®Zabbix Agentã€‚\nå®‰è£…Zabbix Agent å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯åŸºäºDebian/Ubuntuçš„æ“ä½œç³»ç»Ÿï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…Zabbix Agentï¼š\n1 2 sudo apt update sudo apt install zabbix-agent å¯¹äºRedHat/CentOSç³»ç»Ÿï¼š\n1 sudo yum install zabbix-agent å®‰è£…å®Œæˆåï¼Œå¯åŠ¨Zabbix Agentï¼š\n1 2 sudo systemctl start zabbix-agent sudo systemctl enable zabbix-agent ç¼–å†™UPSç›‘æ§è„šæœ¬ åœ¨Zabbix Agentæ‰€åœ¨çš„æœåŠ¡å™¨ä¸Šï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç›‘æ§è„šæœ¬ã€‚æˆ‘ä»¬å°†åœ¨/etc/zabbix/zabbix_agentd.d/script/ups-monitor/ups.shè·¯å¾„ä¸‹åˆ›å»ºè„šæœ¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 #!/bin/bash num=$2 if [ \u0026#34;$num\u0026#34; = \u0026#34;0\u0026#34; ];then data=$(curl --connect-timeout 3 -k -s https://192.168.81.11:10086/1/json -w \u0026#34;|%{http_code}\u0026#34;) elif [ \u0026#34;$num\u0026#34; = \u0026#34;1\u0026#34; ];then data=$(curl --connect-timeout 3 -k -s https://192.168.81.11:10086/0/json -w \u0026#34;|%{http_code}\u0026#34;) elif [ \u0026#34;$num\u0026#34; = \u0026#34;2\u0026#34; ];then data=$(curl --connect-timeout 3 -k -s https://192.168.81.10:10086/0/json -w \u0026#34;|%{http_code}\u0026#34;) fi case $1 in status) echo \u0026#34;$data\u0026#34;|awk -F\u0026#39;|\u0026#39; \u0026#39;{print $1}\u0026#39;|jq \u0026#39;.[\u0026#34;status\u0026#34;]\u0026#39;|sed \u0026#39;s/\u0026#34;//g\u0026#39; ;; batCapacity) echo \u0026#34;$data\u0026#34;|awk -F\u0026#39;|\u0026#39; \u0026#39;{print $1}\u0026#39;|jq \u0026#39;.[\u0026#34;batCapacity\u0026#34;]\u0026#39;|sed \u0026#39;s/\u0026#34;//g;s/%//g\u0026#39; ;; inVolt) echo \u0026#34;$data\u0026#34;|awk -F\u0026#39;|\u0026#39; \u0026#39;{print $1}\u0026#39;|jq \u0026#39;.[\u0026#34;inVolt\u0026#34;]\u0026#39;|sed \u0026#39;s/\u0026#34;//g;s/V//g\u0026#39; ;; apiStatus) echo \u0026#34;$data\u0026#34;|awk -F\u0026#39;|\u0026#39; \u0026#39;{print $2}\u0026#39; ;; *) esac æ­¤è„šæœ¬æ ¹æ®ä¸åŒçš„å‚æ•°(status, batCapacity, inVolt)æ¥è·å–UPSè®¾å¤‡çš„ä¸åŒæ•°æ®é¡¹ã€‚å®ƒé€šè¿‡curlå‘½ä»¤è®¿é—®UPSçš„APIæ¥å£ï¼Œå¹¶ä½¿ç”¨jqè§£æJSONæ ¼å¼çš„æ•°æ®ã€‚\né…ç½®Zabbix Agent åœ¨Zabbix Agentçš„é…ç½®æ–‡ä»¶ä¸­ï¼ˆé€šå¸¸ä½äº/etc/zabbix/zabbix_agentd.confï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ è‡ªå®šä¹‰ç›‘æ§é¡¹ï¼Œä½¿Zabbixèƒ½å¤Ÿè°ƒç”¨ä¸Šé¢åˆ›å»ºçš„è„šæœ¬æ¥è·å–UPSç›¸å…³çš„æ•°æ®ã€‚\nåœ¨zabbix_agentd.confæ–‡ä»¶ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹è¡Œï¼š\nè‡ªå®šä¹‰ç›‘æ§é¡¹ï¼š192.168.82.12:/etc/zabbix/zabbix_agentd.d/userparameter_ups.conf\n1 2 3 4 UserParameter=ups.status[*],/usr/bin/bash /etc/zabbix/zabbix_agentd.d/script/ups-monitor/ups.sh status $1 UserParameter=ups.batCapacity[*],/usr/bin/bash /etc/zabbix/zabbix_agentd.d/script/ups-monitor/ups.sh batCapacity $1 UserParameter=ups.inVolt[*],/usr/bin/bash /etc/zabbix/zabbix_agentd.d/script/ups-monitor/ups.sh inVolt $1 UserParameter=ups.apiStatus[*],/usr/bin/bash /etc/zabbix/zabbix_agentd.d/script/ups-monitor/ups.sh apiStatus $1 ä¿å­˜é…ç½®æ–‡ä»¶å¹¶é‡æ–°å¯åŠ¨Zabbix Agentï¼š\n1 sudo systemctl restart zabbix-agent 3. é…ç½®Zabbix Server æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Zabbix Serverä¸­é…ç½®ç›¸åº”çš„ç›‘æ§é¡¹ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ”¶é›†å’Œæ˜¾ç¤ºUPSçš„ç›¸å…³æ•°æ®ã€‚\n3.1 åˆ›å»ºç›‘æ§é¡¹ åœ¨Zabbixå‰ç«¯ï¼Œè¿›å…¥â€œConfigurationâ€ -\u0026gt; â€œHostsâ€ï¼Œé€‰æ‹©æ‚¨çš„ç›‘æ§ä¸»æœºï¼Œç„¶åç‚¹å‡»â€œItemsâ€é€‰é¡¹å¡ï¼Œåˆ›å»ºä»¥ä¸‹ç›‘æ§é¡¹ï¼š\nç›‘æ§UPSçŠ¶æ€ï¼šç±»å‹é€‰æ‹©â€œZabbix agent (active)â€ï¼Œé”®å€¼è¾“å…¥ups.statusã€‚ ç›‘æ§ç”µæ± å®¹é‡ï¼šç±»å‹é€‰æ‹©â€œZabbix agent (active)â€ï¼Œé”®å€¼è¾“å…¥ups.batCapacityã€‚ ç›‘æ§è¾“å…¥ç”µå‹ï¼šç±»å‹é€‰æ‹©â€œZabbix agent (active)â€ï¼Œé”®å€¼è¾“å…¥ups.inVoltã€‚ è®¾ç½®åˆé€‚çš„æ•°æ®æ”¶é›†å‘¨æœŸï¼Œå¹¶ä¿å­˜ç›‘æ§é¡¹ã€‚ æ¨¡æ¿æ–‡ä»¶ Template UPS.xml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 833 834 835 836 837 838 839 840 841 842 843 844 845 846 847 848 849 850 851 852 853 854 855 856 857 858 859 860 861 862 863 864 865 866 867 868 869 870 871 872 873 874 875 876 877 878 879 880 881 882 883 884 885 886 887 888 889 890 891 892 893 894 895 896 897 898 899 900 901 902 903 904 905 906 907 908 909 910 911 912 913 914 915 916 917 918 919 920 921 922 923 924 925 926 927 928 929 930 931 932 933 934 935 936 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;zabbix_export\u0026gt; \u0026lt;version\u0026gt;4.0\u0026lt;/version\u0026gt; \u0026lt;date\u0026gt;2022-03-31T10:04:22Z\u0026lt;/date\u0026gt; \u0026lt;groups\u0026gt; \u0026lt;group\u0026gt; \u0026lt;name\u0026gt;FJF Dev VM UPS\u0026lt;/name\u0026gt; \u0026lt;/group\u0026gt; \u0026lt;/groups\u0026gt; \u0026lt;templates\u0026gt; \u0026lt;template\u0026gt; \u0026lt;template\u0026gt;Template UPS\u0026lt;/template\u0026gt; \u0026lt;name\u0026gt;Template UPS\u0026lt;/name\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;groups\u0026gt; \u0026lt;group\u0026gt; \u0026lt;name\u0026gt;FJF Dev VM UPS\u0026lt;/name\u0026gt; \u0026lt;/group\u0026gt; \u0026lt;/groups\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;items\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[0]æ¥å£çŠ¶æ€\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.apiStatus[0]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;365d\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;3\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units/\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[1]æ¥å£çŠ¶æ€\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.apiStatus[1]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;365d\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;3\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units/\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[2]æ¥å£çŠ¶æ€\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.apiStatus[2]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;365d\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;3\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units/\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[0]ç”µæ± å‰©ä½™ç”µé‡\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.batCapacity[0]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;365d\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;3\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units\u0026gt;%\u0026lt;/units\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[1]ç”µæ± å‰©ä½™ç”µé‡\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.batCapacity[1]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;365d\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;3\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units\u0026gt;%\u0026lt;/units\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[2]ç”µæ± å‰©ä½™ç”µé‡\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.batCapacity[2]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;365d\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;3\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units\u0026gt;%\u0026lt;/units\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[0]ç”µæºè¾“å…¥ç”µå‹\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.inVolt[0]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;365d\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;0\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units\u0026gt;V\u0026lt;/units\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[1]ç”µæºè¾“å…¥ç”µå‹\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.inVolt[1]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;365d\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;0\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units\u0026gt;V\u0026lt;/units\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[2]ç”µæºè¾“å…¥ç”µå‹\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.inVolt[2]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;365d\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;0\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units\u0026gt;V\u0026lt;/units\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[0]ç”µæºçŠ¶æ€\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.status[0]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;0\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;4\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units/\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[1]ç”µæºçŠ¶æ€\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.status[1]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;0\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;4\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units/\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;name\u0026gt;UPS[2]ç”µæºçŠ¶æ€\u0026lt;/name\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;snmp_community/\u0026gt; \u0026lt;snmp_oid/\u0026gt; \u0026lt;key\u0026gt;ups.status[2]\u0026lt;/key\u0026gt; \u0026lt;delay\u0026gt;30s\u0026lt;/delay\u0026gt; \u0026lt;history\u0026gt;90d\u0026lt;/history\u0026gt; \u0026lt;trends\u0026gt;0\u0026lt;/trends\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;value_type\u0026gt;4\u0026lt;/value_type\u0026gt; \u0026lt;allowed_hosts/\u0026gt; \u0026lt;units/\u0026gt; \u0026lt;snmpv3_contextname/\u0026gt; \u0026lt;snmpv3_securityname/\u0026gt; \u0026lt;snmpv3_securitylevel\u0026gt;0\u0026lt;/snmpv3_securitylevel\u0026gt; \u0026lt;snmpv3_authprotocol\u0026gt;0\u0026lt;/snmpv3_authprotocol\u0026gt; \u0026lt;snmpv3_authpassphrase/\u0026gt; \u0026lt;snmpv3_privprotocol\u0026gt;0\u0026lt;/snmpv3_privprotocol\u0026gt; \u0026lt;snmpv3_privpassphrase/\u0026gt; \u0026lt;params/\u0026gt; \u0026lt;ipmi_sensor/\u0026gt; \u0026lt;authtype\u0026gt;0\u0026lt;/authtype\u0026gt; \u0026lt;username/\u0026gt; \u0026lt;password/\u0026gt; \u0026lt;publickey/\u0026gt; \u0026lt;privatekey/\u0026gt; \u0026lt;port/\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;inventory_link\u0026gt;0\u0026lt;/inventory_link\u0026gt; \u0026lt;applications\u0026gt; \u0026lt;application\u0026gt; \u0026lt;name\u0026gt;UPS\u0026lt;/name\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/applications\u0026gt; \u0026lt;valuemap/\u0026gt; \u0026lt;logtimefmt/\u0026gt; \u0026lt;preprocessing/\u0026gt; \u0026lt;jmx_endpoint/\u0026gt; \u0026lt;timeout\u0026gt;3s\u0026lt;/timeout\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;query_fields/\u0026gt; \u0026lt;posts/\u0026gt; \u0026lt;status_codes\u0026gt;200\u0026lt;/status_codes\u0026gt; \u0026lt;follow_redirects\u0026gt;1\u0026lt;/follow_redirects\u0026gt; \u0026lt;post_type\u0026gt;0\u0026lt;/post_type\u0026gt; \u0026lt;http_proxy/\u0026gt; \u0026lt;headers/\u0026gt; \u0026lt;retrieve_mode\u0026gt;0\u0026lt;/retrieve_mode\u0026gt; \u0026lt;request_method\u0026gt;0\u0026lt;/request_method\u0026gt; \u0026lt;output_format\u0026gt;0\u0026lt;/output_format\u0026gt; \u0026lt;allow_traps\u0026gt;0\u0026lt;/allow_traps\u0026gt; \u0026lt;ssl_cert_file/\u0026gt; \u0026lt;ssl_key_file/\u0026gt; \u0026lt;ssl_key_password/\u0026gt; \u0026lt;verify_peer\u0026gt;0\u0026lt;/verify_peer\u0026gt; \u0026lt;verify_host\u0026gt;0\u0026lt;/verify_host\u0026gt; \u0026lt;master_item/\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;/items\u0026gt; \u0026lt;discovery_rules/\u0026gt; \u0026lt;httptests/\u0026gt; \u0026lt;macros/\u0026gt; \u0026lt;templates/\u0026gt; \u0026lt;screens/\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/templates\u0026gt; \u0026lt;triggers\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.apiStatus[0].last()}\u0026amp;lt;\u0026amp;gt;200\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.apiStatus[0].last()}=200\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS-API[0]æ¥å£å¼‚å¸¸\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.apiStatus[1].last()}\u0026amp;lt;\u0026amp;gt;200\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.apiStatus[1].last()}=200\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS-API[1]æ¥å£å¼‚å¸¸\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.apiStatus[2].last()}\u0026amp;lt;\u0026amp;gt;200\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.apiStatus[2].last()}=200\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS-API[2]æ¥å£å¼‚å¸¸\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.status[0].str(é›¶ç«çº¿æ¥å)}=0 and {Template UPS:ups.status[0].str(æ­£å¸¸)}=0\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.status[0].str(é›¶ç«çº¿æ¥å)}=1 or {Template UPS:ups.status[0].str(æ­£å¸¸)}=1\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS[0]çŠ¶æ€å¼‚å¸¸\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.batCapacity[0].last()}\u0026amp;lt;90\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.batCapacity[0].last()}\u0026amp;gt;90\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS[0]ç”µæ± å‰©ä½™ç”µé‡å°äº90%\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.inVolt[0].avg(#3)}\u0026amp;lt;200\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.inVolt[0].avg(#3)}\u0026amp;gt;200\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS[0]è¾“å…¥ç”µå‹å¼‚å¸¸\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.status[1].str(æ­£å¸¸)}=0\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.status[1].str(æ­£å¸¸)}=1\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS[1]çŠ¶æ€å¼‚å¸¸\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.batCapacity[1].last()}\u0026amp;lt;90\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.batCapacity[1].last()}\u0026amp;gt;90\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS[1]ç”µæ± å‰©ä½™ç”µé‡å°äº90%\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.inVolt[1].avg(#3)}\u0026amp;lt;200\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.inVolt[1].avg(#3)}\u0026amp;gt;200\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS[1]è¾“å…¥ç”µå‹å¼‚å¸¸\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.status[2].str(æ­£å¸¸)}=0\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.status[2].str(æ­£å¸¸)}=1\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS[2]çŠ¶æ€å¼‚å¸¸\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.batCapacity[2].last()}\u0026amp;lt;90\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.batCapacity[2].last()}\u0026amp;gt;90\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS[2]ç”µæ± å‰©ä½™ç”µé‡å°äº90%\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;trigger\u0026gt; \u0026lt;expression\u0026gt;{Template UPS:ups.inVolt[2].avg(#3)}\u0026amp;lt;200\u0026lt;/expression\u0026gt; \u0026lt;recovery_mode\u0026gt;1\u0026lt;/recovery_mode\u0026gt; \u0026lt;recovery_expression\u0026gt;{Template UPS:ups.inVolt[2].avg(#3)}\u0026amp;gt;200\u0026lt;/recovery_expression\u0026gt; \u0026lt;name\u0026gt;UPS[2]è¾“å…¥ç”µå‹å¼‚å¸¸\u0026lt;/name\u0026gt; \u0026lt;correlation_mode\u0026gt;0\u0026lt;/correlation_mode\u0026gt; \u0026lt;correlation_tag/\u0026gt; \u0026lt;url/\u0026gt; \u0026lt;status\u0026gt;0\u0026lt;/status\u0026gt; \u0026lt;priority\u0026gt;4\u0026lt;/priority\u0026gt; \u0026lt;description/\u0026gt; \u0026lt;type\u0026gt;0\u0026lt;/type\u0026gt; \u0026lt;manual_close\u0026gt;0\u0026lt;/manual_close\u0026gt; \u0026lt;dependencies/\u0026gt; \u0026lt;tags/\u0026gt; \u0026lt;/trigger\u0026gt; \u0026lt;/triggers\u0026gt; \u0026lt;/zabbix_export\u0026gt; ç›‘æ§é¡¹ï¼š 3.2 é…ç½®è§¦å‘å™¨ ä¸ºäº†åŠæ—¶å‘ç°UPSæ•…éšœï¼Œæ‚¨å¯ä»¥è®¾ç½®è§¦å‘å™¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœUPSçš„çŠ¶æ€å˜ä¸ºâ€œæ•…éšœâ€æˆ–ç”µæ± å®¹é‡ä½äºæŸä¸ªé˜ˆå€¼æ—¶ï¼Œè§¦å‘å‘Šè­¦ã€‚æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œå¯ä»¥è®¾ç½®ä»¥ä¸‹è§¦å‘å™¨ï¼š\nUPSçŠ¶æ€æ•…éšœè§¦å‘å™¨ï¼šå½“ups.statusçš„å€¼ä¸ºâ€œFaultâ€æ—¶ï¼Œè§¦å‘å‘Šè­¦ã€‚ ç”µæ± å®¹é‡ä½è§¦å‘å™¨ï¼šå½“ups.batCapacityå°äºæŸä¸ªé˜ˆå€¼ï¼ˆä¾‹å¦‚20%ï¼‰æ—¶ï¼Œè§¦å‘å‘Šè­¦ã€‚ è§¦å‘å™¨ï¼š 4. éªŒè¯ä¸æµ‹è¯• å®Œæˆä¸Šè¿°é…ç½®åï¼ŒZabbix Serverå°†å¼€å§‹å®šæœŸä»Zabbix Agentä¸­è·å–UPSçš„çŠ¶æ€æ•°æ®ã€‚æ‚¨å¯ä»¥é€šè¿‡Zabbixå‰ç«¯æŸ¥çœ‹UPSçš„çŠ¶æ€ã€å‰©ä½™ç”µæ± å®¹é‡å’Œè¾“å…¥ç”µå‹ç­‰ä¿¡æ¯ï¼Œå¹¶æ ¹æ®è®¾ç½®çš„è§¦å‘å™¨åœ¨å‡ºç°å¼‚å¸¸æ—¶æ”¶åˆ°å‘Šè­¦ã€‚ ","date":"2025-01-20T16:28:12Z","image":"https://www.ownit.top/title_pic/31.jpg","permalink":"https://www.ownit.top/p/202501201628/","title":"Zabbixç›‘æ§å±±ç‰¹UPSç”µæºï¼šå®ç°é«˜æ•ˆç›‘æ§ä¸å‘Šè­¦"},{"content":"1ã€é—®é¢˜ æˆ‘ä½¿ç”¨Flaskå’ŒFlask-SocketIO æ¥åš Websocket é“¾æ¥ã€‚å‰æœŸæ­£å¸¸ä½¿ç”¨ï¼Œä½†æ˜¯åæœŸå¸ƒç½®ä¿®æ”¹ä»€ä¹ˆå¯¼è‡´Websocketè¿æ¥å¤±è´¥ã€‚æ’æŸ¥éœ€æ±‚ï¼Œæ‰å‘ç°åˆå§‹åŒ–ä¸æ­£å¸¸å¯¼è‡´ã€‚\nSocketIO å’Œ Flask åº”ç”¨çš„åˆå§‹åŒ–é¡ºåºå’Œå¼•ç”¨å¾ªç¯çš„é—®é¢˜\n2ã€ç¯å¢ƒ 1 2 3 python-engineio==4.11.1 python-socketio==5.12.0 Flask-SocketIO==5.3.6 3ã€æ­£å¸¸åˆå§‹åŒ–ã€å•æ–‡ä»¶ã€‘ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 from flask import Flask, render_template from flask_socketio import SocketIO app = Flask(__name__) socketio = SocketIO(app) # åˆå§‹åŒ– SocketIO # é»˜è®¤è·¯ç”±ï¼Œç”¨äºæ¸²æŸ“ HTML é¡µé¢ @app.route(\u0026#39;/\u0026#39;) def index(): return render_template(\u0026#39;index.html\u0026#39;) # å‡ºç°æ¶ˆæ¯å,ç‡å…ˆæ‰§è¡Œæ­¤å¤„ @socketio.on(\u0026#34;message\u0026#34;, namespace=\u0026#34;/ws\u0026#34;) def socket(message): print(f\u0026#34;æ¥æ”¶åˆ°æ¶ˆæ¯: {message}\u0026#34;) for i in range(1, 10): socketio.sleep(1) print(f\u0026#34;å‘é€æ¶ˆæ¯: {i}\u0026#34;) socketio.emit(\u0026#34;response\u0026#34;, # ç»‘å®šé€šä¿¡ {\u0026#34;data\u0026#34;: i}, # è¿”å›socketæ•°æ® namespace=\u0026#34;/ws\u0026#34;) # å½“websocketè¿æ¥æˆåŠŸæ—¶,è‡ªåŠ¨è§¦å‘connecté»˜è®¤æ–¹æ³• @socketio.on(\u0026#34;connect\u0026#34;, namespace=\u0026#34;/ws\u0026#34;) def connect(): print(\u0026#34;é“¾æ¥å»ºç«‹æˆåŠŸ..\u0026#34;) # å½“websocketè¿æ¥å¤±è´¥æ—¶,è‡ªåŠ¨è§¦å‘disconnecté»˜è®¤æ–¹æ³• @socketio.on(\u0026#34;disconnect\u0026#34;, namespace=\u0026#34;/ws\u0026#34;) def disconnect(): print(\u0026#34;é“¾æ¥å»ºç«‹å¤±è´¥..\u0026#34;) if __name__ == \u0026#39;__main__\u0026#39;: socketio.run(app, debug=True, host=\u0026#39;0.0.0.0\u0026#39;, port=5000,allow_unsafe_werkzeug=True) 4ã€å¤šæ–‡ä»¶åˆå§‹åŒ–ã€ä¸¤ä¸ªæ–‡ä»¶ã€‘ ä¸»è¦æ˜¯ manage.py å’Œ init.py ä¸¤ä¸ªæ–‡ä»¶ã€‚ app/init.py\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 from flask import Flask from flask_socketio import SocketIO from flasgger import Swagger from flask_cors import CORS from flask_migrate import Migrate from app.config import config from app.extension import db # åˆ›å»ºä¸€ä¸ªå…¨å±€çš„ socketio å¯¹è±¡ï¼Œä½†ä¸ç«‹å³åˆå§‹åŒ– socketio = SocketIO() # å…¶ä»– swagger é…ç½®ä¿æŒä¸å˜... def create_app(DevelopmentConfig=None): if DevelopmentConfig is None: DevelopmentConfig = \u0026#39;development\u0026#39; app = Flask(__name__) app.config[\u0026#39;SECRET_KEY\u0026#39;] = \u0026#39;123456\u0026#39; # åŠ è½½é…ç½®é¡¹ app.config.from_object(config.get(DevelopmentConfig)) from app.api import config_blueprint # æ³¨å†Œè“å›¾ config_blueprint(app) # æ•°æ®åº“é…ç½®åˆå§‹åŒ– config_extensions(app) # æ•°æ®åº“è¿ç§»ç›¸å…³ä»£ç ... from app.api.models.EsModels import sysEsLogs,sysCretitLogs from app.api.models.NetModels import sysNetLogs from app.api.models.UpsModels import sysUpsLogs migrate = Migrate(app, db) # Swaggeråˆå§‹åŒ– Swagger(app, config=swagger_config, template=swagger_template) # CORSé…ç½® CORS(app, resources={r\u0026#39;/*\u0026#39;: {\u0026#39;origins\u0026#39;: \u0026#39;*\u0026#39;}}, supports_credentials=True) # åˆå§‹åŒ– SocketIO socketio.init_app(app, cors_allowed_origins=\u0026#34;*\u0026#34;) return app socket_events.py\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 from app import socketio # Socket.IO äº‹ä»¶å¤„ç† @socketio.on(\u0026#34;message\u0026#34;, namespace=\u0026#34;/ws\u0026#34;) def socket(message): print(f\u0026#34;æ¥æ”¶åˆ°æ¶ˆæ¯: {message}\u0026#34;) for i in range(1, 10): socketio.sleep(1) print(f\u0026#34;å‘é€æ¶ˆæ¯: {i}\u0026#34;) socketio.emit(\u0026#34;response\u0026#34;, {\u0026#34;data\u0026#34;: i}, namespace=\u0026#34;/ws\u0026#34;) @socketio.on(\u0026#34;connect\u0026#34;, namespace=\u0026#34;/ws\u0026#34;) def connect(): print(\u0026#34;é“¾æ¥å»ºç«‹æˆåŠŸ..\u0026#34;) @socketio.on(\u0026#34;disconnect\u0026#34;, namespace=\u0026#34;/ws\u0026#34;) def disconnect(): print(\u0026#34;é“¾æ¥å»ºç«‹å¤±è´¥..\u0026#34;) manage.py\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 # -*- coding: utf-8 -*- # @Time : 2024/5/2 12:01 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : manage.py # @Software: PyCharm import atexit import os import sys from apscheduler.schedulers.background import BackgroundScheduler from app import create_app, socketio from app.common.util.LogHandler import log from app.crontab.NetCronTab import NetworkMonitor from app.crontab.UpsCronTab import UPSMonitor from app.socket_events import * # é»˜è®¤ä¸ºå¼€å‘ç¯å¢ƒï¼ŒæŒ‰éœ€æ±‚ä¿®æ”¹ production development config_name = \u0026#39;development\u0026#39; app = create_app(config_name) # è§£å†³ä¸­æ–‡ä¹±ç  # app.json.ensure_ascii = False # from skywalking import agent, config # config.init(agent_collector_backend_services=\u0026#39;192.168.82.105:11800\u0026#39;, agent_name=\u0026#39;python-flask@devTenant\u0026#39;,agent_instance_name=\u0026#34;python-flask\u0026#34;) # agent.start() # æ•°æ®åº“è¿ç§» def start_scheduler(): # åˆ›å»ºä¸€ä¸ªåå°è°ƒåº¦å™¨ scheduler = BackgroundScheduler(timezone=\u0026#34;Asia/Shanghai\u0026#34;) from app.crontab.EsCronTab import EsIndexCron scheduler.add_job(func=EsIndexCron, trigger=\u0026#39;interval\u0026#39;, minutes=1) log.info(\u0026#34;EsIndexCron å®šæ—¶ä»»åŠ¡å¯åŠ¨æˆåŠŸ\u0026#34;) # scheduler.add_job(func=send_alert, trigger=\u0026#34;interval\u0026#34;, seconds=20) # å¯åŠ¨è°ƒåº¦å™¨ scheduler.start() atexit.register(lambda: scheduler.shutdown()) if __name__ == \u0026#39;__main__\u0026#39;: # è·å–å½“å‰æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ current_file = os.path.abspath(__file__) base_dir = os.path.dirname(current_file) # å°†é¡¹ç›®ç›®å½•æ·»åŠ åˆ° sys.path if base_dir not in sys.path: sys.path.append(base_dir) if not app.debug or app.testing: start_scheduler() log.info(\u0026#34;å®šæ—¶ä»»åŠ¡å¯åŠ¨æˆåŠŸ\u0026#34;) socketio.run(app, debug=True, use_reloader=True, host=\u0026#39;0.0.0.0\u0026#39;, port=5001) # use_reloader=False, threaded=True, åœ¨postmanè¾“å…¥åœ°å€å’Œç›‘å¬äº‹ä»¶\n","date":"2024-12-30T18:02:10Z","image":"https://www.ownit.top/title_pic/54.jpg","permalink":"https://www.ownit.top/p/202412301802/","title":"Flask ä¸ SocketIO æ­£ç¡®åˆå§‹åŒ–åŠæœ€ä½³å®è·µè°ƒè¯•"},{"content":"é¡¹ç›®ç®€ä»‹ æœ¬æ¬¡åŸºäºç‰ˆæœ¬3 å¼€æº\nç‰ˆæœ¬3å¼€æºåœ°å€ï¼šhttps://github.com/nangongchengfeng/CsdnBlogBoard.git ç‰ˆæœ¬1å¼€æºåœ°å€ï¼šhttps://github.com/nangongchengfeng/CSDash.git\nè¿™æ˜¯ä¸€ä¸ªåŸºäº Python çš„ CSDN åšå®¢æ•°æ®å¯è§†åŒ–çœ‹æ¿é¡¹ç›®ï¼Œé€šè¿‡çˆ¬è™«é‡‡é›† CSDN åšå®¢æ•°æ®ï¼Œå¹¶ä»¥ç°ä»£åŒ–çš„å¯è§†åŒ–ç•Œé¢å±•ç¤ºåšä¸»çš„å„é¡¹æ•°æ®æŒ‡æ ‡ã€‚è¯¥é¡¹ç›®é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œé›†æˆäº†æ•°æ®é‡‡é›†ã€æ•°æ®å­˜å‚¨ã€API æœåŠ¡å’Œæ•°æ®å¯è§†åŒ–ç­‰å¤šä¸ªåŠŸèƒ½æ¨¡å—ã€‚ ç‰ˆæœ¬ä¸€ ç‰ˆæœ¬äºŒ ç‰ˆæœ¬ä¸‰ æŠ€æœ¯æ ˆ åç«¯æŠ€æœ¯ Python Flask: ä½œä¸º Web æ¡†æ¶ï¼Œæä¾› RESTful API æœåŠ¡ SQLAlchemy: ORM æ¡†æ¶ï¼Œç”¨äºæ•°æ®åº“æ“ä½œ BeautifulSoup4: ç½‘é¡µè§£æï¼Œç”¨äºçˆ¬è™«æ•°æ®æå– Requests: HTTP è¯·æ±‚åº“ï¼Œç”¨äºæ•°æ®çˆ¬å– å‰ç«¯æŠ€æœ¯ ECharts: å¼ºå¤§çš„æ•°æ®å¯è§†åŒ–å›¾è¡¨åº“ Axios: HTTP å®¢æˆ·ç«¯ï¼Œç”¨äºå‰åç«¯æ•°æ®äº¤äº’ ç°ä»£ CSS: Flexbox å¸ƒå±€ã€CSS å˜é‡ã€å“åº”å¼è®¾è®¡ æ ¸å¿ƒåŠŸèƒ½æ¨¡å— 1. æ•°æ®é‡‡é›†æ¨¡å— æ•°æ®é‡‡é›†æ¨¡å—é€šè¿‡spider.pyå®ç°ï¼Œæ˜¯é¡¹ç›®çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚è¯¥æ¨¡å—é‡‡ç”¨äº†å¤šç§æŠ€æœ¯å’Œç­–ç•¥æ¥ç¡®ä¿æ•°æ®é‡‡é›†çš„å‡†ç¡®æ€§ã€ç¨³å®šæ€§å’Œå®æ—¶æ€§ã€‚\n1.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ Requests: å¤„ç† HTTP è¯·æ±‚ï¼Œæ”¯æŒè‡ªå®šä¹‰è¯·æ±‚å¤´å’Œè¶…æ—¶è®¾ç½® BeautifulSoup4: ä½¿ç”¨ lxml è§£æå™¨è¿›è¡Œé«˜æ•ˆçš„ HTML è§£æ æ­£åˆ™è¡¨è¾¾å¼(re): ç”¨äºç²¾ç¡®æå–æ•°å­—å’Œç‰¹å®šæ ¼å¼çš„æ•°æ® SQLAlchemy: å®ç°æ•°æ®æŒä¹…åŒ–å’Œ ORM æ˜ å°„ éšæœºå»¶æ—¶ç­–ç•¥: ä½¿ç”¨ random.uniform() é¿å…é¢‘ç¹è¯·æ±‚ 1.2 æ•°æ®é‡‡é›†åŠŸèƒ½ 1.2.1 åšä¸»åŸºç¡€ä¿¡æ¯é‡‡é›† é‡‡é›†å†…å®¹ï¼š\nç”¨æˆ·åå’Œå¤´åƒ æ–‡ç« æ•°é‡ç»Ÿè®¡ ç²‰ä¸æ•°å’Œè®¿é—®é‡ ç‚¹èµå’Œè¯„è®ºæ•° ç­‰çº§å’Œç§¯åˆ†ä¿¡æ¯ åšä¸»æ’åæ•°æ® æŠ€æœ¯å®ç°ï¼š\n1 2 3 # ç¤ºä¾‹ï¼šç”¨æˆ·ä¿¡æ¯æå– user_info = soup.find(\u0026#39;div\u0026#39;, class_=\u0026#39;user-info d-flex flex-column profile-intro-name-box\u0026#39;) author_name = user_info.find(\u0026#39;a\u0026#39;).get_text(strip=True) 1.2.2 æ–‡ç« åˆ†ç±»ä¿¡æ¯é‡‡é›† é‡‡é›†å†…å®¹ï¼š\nä¸“æ åç§°å’Œé“¾æ¥ ä¸“æ æ–‡ç« æ•°é‡ è®¢é˜…äººæ•°ç»Ÿè®¡ é˜…è¯»é‡å’Œæ”¶è—æ•° ä¸“æ å”¯ä¸€æ ‡è¯† æŠ€æœ¯å®ç°ï¼š\n1 2 3 4 5 # ç¤ºä¾‹ï¼šåˆ†ç±»ä¿¡æ¯æå– spans = soup.find_all(\u0026#39;a\u0026#39;, attrs={\u0026#39;class\u0026#39;: \u0026#39;special-column-name\u0026#39;}) for span in spans: href = span.get(\u0026#39;href\u0026#39;) blog_column = span.text.strip() 1.3 é”™è¯¯å¤„ç†æœºåˆ¶ å¤šçº§å¼‚å¸¸å¤„ç†\nè¯·æ±‚å¼‚å¸¸æ•è· æ•°æ®è§£æå¼‚å¸¸å¤„ç† æ•°æ®åº“æ“ä½œå¼‚å¸¸å¤„ç† é‡è¯•æœºåˆ¶\n1 2 3 4 5 6 7 8 max_retries = 3 retry_count = 0 while retry_count \u0026lt; max_retries: try: # è¯·æ±‚é€»è¾‘ except Exception: retry_count += 1 time.sleep(5) # å¤±è´¥åç­‰å¾… 1.4 æ•°æ®æ›´æ–°ç­–ç•¥ å¢é‡æ›´æ–°æœºåˆ¶\næ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨ æ ¹æ®æƒ…å†µæ‰§è¡Œæ›´æ–°æˆ–æ’å…¥ ä¿æŒæ•°æ®æ—¶æ•ˆæ€§ æ•°æ®ä¸€è‡´æ€§ä¿è¯\n1 2 3 4 5 6 with app.app_context(): existing_info = Info.query.filter_by(author_name=author_name).first() if existing_info: # æ›´æ–°ç°æœ‰è®°å½• else: # æ’å…¥æ–°è®°å½• 1.5 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ è¯·æ±‚ä¼˜åŒ–\nè‡ªå®šä¹‰è¯·æ±‚å¤´ è¿æ¥è¶…æ—¶è®¾ç½® éšæœºå»¶æ—¶æ§åˆ¶ è§£æä¼˜åŒ–\nä½¿ç”¨ lxml è§£æå™¨æå‡æ€§èƒ½ ç²¾ç¡®çš„é€‰æ‹©å™¨å®šä½ æ•°æ®é¢„å¤„ç†å’Œæ¸…æ´— å­˜å‚¨ä¼˜åŒ–\næ‰¹é‡æ•°æ®å¤„ç† äº‹åŠ¡ç®¡ç† ä¼šè¯å¤ç”¨ 1.6 åçˆ¬è™«ç­–ç•¥åº”å¯¹ è¯·æ±‚å¤´æ¨¡æ‹Ÿ\n1 2 3 4 headers = { \u0026#39;User-Agent\u0026#39;: \u0026#39;Mozilla/5.0 (MSIE 10.0; Windows NT 6.1; Trident/5.0)\u0026#39;, \u0026#39;referer\u0026#39;: \u0026#39;https://passport.csdn.net/login\u0026#39; } è®¿é—®é¢‘ç‡æ§åˆ¶\néšæœºå»¶æ—¶é—´éš” è¯·æ±‚é™é€Ÿ IP ä»£ç†æ”¯æŒï¼ˆé¢„ç•™ï¼‰ 2. æ•°æ®å­˜å‚¨æ¨¡å— æ•°æ®å­˜å‚¨æ¨¡å—é‡‡ç”¨ SQLAlchemy ORM æ¡†æ¶è¿›è¡Œæ•°æ®å»ºæ¨¡ï¼Œå®ç°äº†é«˜æ•ˆçš„æ•°æ®æŒä¹…åŒ–å’ŒæŸ¥è¯¢æ“ä½œã€‚è¯¥æ¨¡å—è®¾è®¡äº†ä¸‰ä¸ªæ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼Œæ¯ä¸ªæ¨¡å‹éƒ½é’ˆå¯¹ç‰¹å®šçš„æ•°æ®åœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–ã€‚\n2.1 æ•°æ®æ¨¡å‹è®¾è®¡ 2.1.1 åšä¸»ä¿¡æ¯æ¨¡å‹ (Info) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 class Info(db.Model): __tablename__ = \u0026#39;info\u0026#39; id = db.Column(db.Integer, primary_key=True, autoincrement=True) date = db.Column(db.Text) # æ•°æ®æ›´æ–°æ—¶é—´ head_img = db.Column(db.Text) # åšä¸»å¤´åƒURL author_name = db.Column(db.Text) # åšä¸»ç”¨æˆ·å article_num = db.Column(db.Text) # æ–‡ç« æ€»æ•° fans_num = db.Column(db.Text) # ç²‰ä¸æ•°é‡ like_num = db.Column(db.Text) # è·èµæ•°é‡ comment_num = db.Column(db.Text) # è¯„è®ºæ•°é‡ level = db.Column(db.Text) # åšä¸»ç­‰çº§ visit_num = db.Column(db.Text) # è®¿é—®é‡ score = db.Column(db.Text) # ç§¯åˆ† rank = db.Column(db.Text) # æ’å ç‰¹ç‚¹è¯´æ˜ï¼š\nä½¿ç”¨è‡ªå¢ä¸»é”®ç¡®ä¿è®°å½•å”¯ä¸€æ€§ é‡‡ç”¨ Text ç±»å‹å­˜å‚¨å¯å˜é•¿åº¦æ–‡æœ¬ åŒ…å«å®Œæ•´çš„åšä¸»æ•°æ®ç”»åƒ æ”¯æŒæ—¶é—´åºåˆ—åˆ†æï¼ˆé€šè¿‡ date å­—æ®µï¼‰ 2.1.2 æ–‡ç« åˆ†ç±»æ¨¡å‹ (Categorize) 1 2 3 4 5 6 7 8 9 10 11 12 class Categorize(db.Model): __tablename__ = \u0026#39;categorize\u0026#39; id = db.Column(db.Integer, primary_key=True, autoincrement=True) href = db.Column(db.Text) # åˆ†ç±»é“¾æ¥ categorize = db.Column(db.Text) # åˆ†ç±»åç§° categorize_id = db.Column(db.BigInteger) # åˆ†ç±»ID column_num = db.Column(db.BigInteger) # ä¸“æ æ•°é‡ num_span = db.Column(db.BigInteger) # è®¢é˜…æ•°é‡ article_num = db.Column(db.BigInteger) # æ–‡ç« æ•°é‡ read_num = db.Column(db.BigInteger) # é˜…è¯»é‡ collect_num = db.Column(db.BigInteger) # æ”¶è—æ•° ç‰¹ç‚¹è¯´æ˜ï¼š\nä½¿ç”¨ BigInteger ç±»å‹å­˜å‚¨å¤§æ•°å€¼æ•°æ® æ”¯æŒåˆ†ç±»æ•°æ®çš„ç»Ÿè®¡åˆ†æ åŒ…å«å®Œæ•´çš„åˆ†ç±»å…ƒæ•°æ® å¯è¿½è¸ªåˆ†ç±»çš„å—æ¬¢è¿ç¨‹åº¦ 2.1.3 æ–‡ç« è¯¦æƒ…æ¨¡å‹ (Article) 1 2 3 4 5 6 7 8 9 10 class Article(db.Model): __tablename__ = \u0026#39;article\u0026#39; id = db.Column(db.Integer, primary_key=True, autoincrement=True) url = db.Column(db.Text) # æ–‡ç« é“¾æ¥ title = db.Column(db.Text) # æ–‡ç« æ ‡é¢˜ date = db.Column(db.Text) # å‘å¸ƒæ—¥æœŸ read_num = db.Column(db.BigInteger) # é˜…è¯»æ•° comment_num = db.Column(db.BigInteger) # è¯„è®ºæ•° type = db.Column(db.Text) # æ–‡ç« ç±»å‹ ç‰¹ç‚¹è¯´æ˜ï¼š\nè®°å½•æ–‡ç« çš„åŸºæœ¬ä¿¡æ¯å’Œç»Ÿè®¡æ•°æ® æ”¯æŒæ–‡ç« æ—¶é—´åºåˆ—åˆ†æ å¯è¿½è¸ªç« çš„å—æ¬¢è¿ç¨‹åº¦ ä¾¿äºæ–‡ç« åˆ†ç±»ç»Ÿè®¡ 2.2 æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥ å­—æ®µç±»å‹ä¼˜åŒ–\nä½¿ç”¨ BigInteger å­˜å‚¨å¤§æ•°å€¼ï¼Œé¿å…æ•°å€¼æº¢å‡º é‡‡ç”¨ Text ç±»å‹å­˜å‚¨å˜é•¿æ–‡æœ¬ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ ä¸»é”®ä½¿ç”¨è‡ªå¢ Integerï¼Œæé«˜æ’å…¥æ€§èƒ½ æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–\nå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ç´¢å¼• æ”¯æŒå¤æ‚çš„èšåˆæŸ¥è¯¢ ä¼˜åŒ–çš„æ•°æ®ç»“æ„è®¾è®¡ æ•°æ®ä¸€è‡´æ€§ä¿è¯\nä¸»é”®çº¦æŸç¡®ä¿è®°å½•å”¯ä¸€æ€§ é€‚å½“çš„å­—æ®µç±»å‹ç¡®ä¿æ•°æ®å®Œæ•´æ€§ æ”¯æŒäº‹åŠ¡æ“ä½œ 2.3 æ•°æ®æ“ä½œç¤ºä¾‹ æ•°æ®æ’å…¥ 1 2 3 4 5 6 7 new_info = Info( author_name=\u0026#34;åšä¸»åç§°\u0026#34;, article_num=\u0026#34;100\u0026#34;, fans_num=\u0026#34;1000\u0026#34; ) db.session.add(new_info) db.session.commit() æ•°æ®æŸ¥è¯¢ 1 2 3 4 5 6 7 8 # è·å–åšä¸»ä¿¡æ¯ author_info = Info.query.filter_by(author_name=\u0026#34;åšä¸»åç§°\u0026#34;).first() # è·å–åˆ†ç±»ç»Ÿè®¡ categories = Categorize.query.order_by(Categorize.read_num.desc()).all() # è·å–çƒ­é—¨æ–‡ç«  hot_articles = Article.query.order_by(Article.read_num.desc()).limit(10).all() æ•°æ®æ›´æ–° 1 2 3 info = Info.query.filter_by(author_name=\u0026#34;åšä¸»åç§°\u0026#34;).first() info.fans_num = str(int(info.fans_num) + 1) db.session.commit() 3. å¯è§†åŒ–å±•ç¤ºæ¨¡å— å‰ç«¯é‡‡ç”¨ç°ä»£åŒ–çš„å¯è§†åŒ–æ–¹æ¡ˆï¼ŒåŸºäº ECharts å®ç°äº†ä¸°å¯Œçš„æ•°æ®å¯è§†åŒ–åŠŸèƒ½ï¼Œå¹¶é€šè¿‡ Axios å®ç°äº†ä¸åç«¯çš„æ•°æ®äº¤äº’ã€‚\n3.1 æŠ€æœ¯æ¶æ„ æ ¸å¿ƒæŠ€æœ¯\nECharts 5.5.1ï¼šæ•°æ®å¯è§†åŒ–åº“ Axiosï¼šHTTP å®¢æˆ·ç«¯ CSS3ï¼šç°ä»£å¸ƒå±€å’ŒåŠ¨ç”» Flexboxï¼šå“åº”å¼å¸ƒå±€ è®¾è®¡è§„èŒƒ\n1 2 3 4 5 6 7 8 9 :root { --bg-primary: #f7f8fa; --bg-secondary: #ffffff; --text-primary: #333333; --text-secondary: #555555; --accent-color: #0066cc; --border-radius: 12px; --shadow: 0 4px 6px rgba(0, 0, 0, 0.05); } 3.2 å›¾è¡¨ç»„ä»¶å®ç° 3.2.1 æŸ±çŠ¶å›¾ï¼ˆå­£åº¦æ•°æ®åˆ†æï¼‰ æ•°æ®æµç¨‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 async function updateBarChart() { // 1. è·å–æ•°æ® const response = await axios.get(\u0026#34;/api/quarter\u0026#34;); // 2. æ•°æ®è½¬æ¢ const dimensions = [ ...Object.keys(chartData[0]).filter((key) =\u0026gt; key !== \u0026#34;category\u0026#34;), ]; const source = chartData.map((item) =\u0026gt; ({ product: item.category, ...item, })); // 3. å›¾è¡¨é…ç½® const option = { legend: {}, tooltip: {}, dataset: { dimensions: dimensions, source: source, }, xAxis: { type: \u0026#34;category\u0026#34; }, yAxis: {}, series: dimensions.slice(1).map((dim) =\u0026gt; ({ type: \u0026#34;bar\u0026#34;, name: dim, })), }; } äº¤äº’ç‰¹æ€§\nåŠ¨æ€æ•°æ®åŠ è½½ ç‚¹å‡»äº‹ä»¶å“åº” è‡ªé€‚åº”å¸ƒå±€ 3.2.2 é¥¼å›¾ï¼ˆåˆ†ç±»å æ¯”åˆ†æï¼‰ å®ç°ç»†èŠ‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 async function updatePieChart() { // 1. æ•°æ®è·å– const response = await axios.get(\u0026#34;/api/categorize\u0026#34;); // 2. å›¾è¡¨é…ç½® const option = { tooltip: { trigger: \u0026#34;item\u0026#34;, formatter: \u0026#34;{a} \u0026lt;br/\u0026gt;{b}: {c} ({d}%)\u0026#34;, }, series: [ { name: \u0026#34;åˆ†ç±»ç»Ÿè®¡\u0026#34;, type: \u0026#34;pie\u0026#34;, radius: [\u0026#34;30%\u0026#34;, \u0026#34;70%\u0026#34;], data: chartData, label: { show: true, position: \u0026#34;outside\u0026#34;, formatter: \u0026#34;{b}: {d}%\u0026#34;, }, }, ], }; } è§†è§‰ä¼˜åŒ–\nå†…å¤–åŠå¾„è®¾è®¡ æ ‡ç­¾è‡ªåŠ¨å¸ƒå±€ æ‚¬åœåŠ¨ç”»æ•ˆæœ 3.2.3 æ··åˆå›¾è¡¨ï¼ˆé˜…è¯»é‡åˆ†æï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 async function updateMixChart() { const option = { color: [\u0026#34;#3E82F7\u0026#34;, \u0026#34;#F86C6B\u0026#34;], tooltip: { trigger: \u0026#34;axis\u0026#34;, axisPointer: { type: \u0026#34;shadow\u0026#34;, }, }, legend: { data: [\u0026#34;æ–‡ç« æ•°\u0026#34;, \u0026#34;é˜…è¯»é‡\u0026#34;], }, grid: { top: \u0026#34;10%\u0026#34;, bottom: \u0026#34;25%\u0026#34;, right: \u0026#34;10%\u0026#34;, }, }; } 3.3 å“åº”å¼å¸ƒå±€å®ç° å¸ƒå±€ç»“æ„\n1 2 3 4 5 6 7 \u0026lt;div class=\u0026#34;dashboard-container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;top-section\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;mac-header\u0026#34;\u0026gt;...\u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stats-grid\u0026#34;\u0026gt;...\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;!-- å›¾è¡¨å®¹å™¨ --\u0026gt; \u0026lt;/div\u0026gt; æ ·å¼ä¼˜åŒ–\n1 2 3 4 5 6 7 .dashboard-container { display: flex; flex-direction: column; height: 100vh; padding: 15px; gap: 15px; } 3.4 æ•°æ®æ›´æ–°æœºåˆ¶ åˆå§‹åŒ–æµç¨‹\n1 2 3 4 5 6 7 function initCharts() { updateBarChart(); updatePieChart(); updateMixChart(); updateHeatmap(); updateArticleList(); } æ•°æ®åˆ·æ–°ç­–ç•¥\né¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– ç”¨æˆ·äº¤äº’è§¦å‘æ›´æ–° å®šæ—¶è‡ªåŠ¨åˆ·æ–° 3.5 äº¤äº’è®¾è®¡ å›¾è¡¨è”åŠ¨\nç‚¹å‡»é¥¼å›¾æ›´æ–°æ–‡ç« åˆ—è¡¨ æŸ±çŠ¶å›¾åˆ†ç±»ç­›é€‰ æ•°æ®é’»å–åŠŸèƒ½ è§†è§‰åé¦ˆ\n1 2 3 4 5 .stat-card:hover, .chart-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08); } 3.6 æ€§èƒ½ä¼˜åŒ– åŠ è½½ä¼˜åŒ–\nå¼‚æ­¥æ•°æ®åŠ è½½ å›¾è¡¨æŒ‰éœ€æ¸²æŸ“ é˜²æŠ–å’ŒèŠ‚æµå¤„ç† æ¸²æŸ“ä¼˜åŒ–\nåˆç†çš„å›¾è¡¨é…ç½® æ•°æ®é¢„å¤„ç† åŠ¨ç”»æ€§èƒ½è°ƒä¼˜ 4. åç«¯å®ç°é€»è¾‘æµç¨‹ 4.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ Flask: Web æ¡†æ¶ Blueprint: è·¯ç”±æ¨¡å—åŒ– Cache: æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ SQLAlchemy: ORM æ•°æ®åº“æ“ä½œ PyMySQL: MySQL æ•°æ®åº“é©±åŠ¨ 4.2 ç³»ç»Ÿæ¶æ„ 4.3 æ ¸å¿ƒåŠŸèƒ½å®ç° 4.3.1 åº”ç”¨åˆå§‹åŒ– 1 2 3 4 5 6 7 8 9 app = Flask(__name__) # é…ç½®ç¼“å­˜ cache.init_app(app, config={ \u0026#39;CACHE_TYPE\u0026#39;: \u0026#39;filesystem\u0026#39;, \u0026#39;CACHE_DIR\u0026#39;: \u0026#39;cache-directory\u0026#39; }) # æ•°æ®åº“é…ç½® app.config[\u0026#39;SQLALCHEMY_DATABASE_URI\u0026#39;] = \u0026#39;mysql+pymysql://user:pass@host:port/db\u0026#39; db.init_app(app) 4.3.2 è·¯ç”±æ³¨å†Œæœºåˆ¶ 1 2 3 4 5 6 7 8 9 DEFAULT_BLUEPRINT = [ (cs, \u0026#39;/\u0026#39;), # CSDN APIè“å›¾ ] url_path_prefix = \u0026#34;/api\u0026#34; def config_blueprint(app): for blueprint, url_prefix in DEFAULT_BLUEPRINT: url_prefix = url_path_prefix + url_prefix app.register_blueprint(blueprint, url_prefix=url_prefix) 4.4 API æ¥å£è®¾è®¡ 4.4.1 æ•°æ®ç»Ÿè®¡æ¥å£ å­£åº¦æ•°æ®ç»Ÿè®¡ 1 2 3 4 5 6 7 8 9 10 11 @cs.route(\u0026#39;/quarter\u0026#39;) @cache.cached(timeout=60) def GetQuarter(): \u0026#34;\u0026#34;\u0026#34;è·å–æ¯å¹´æ¯å­£åº¦åšå®¢æ•°é‡\u0026#34;\u0026#34;\u0026#34; year_quarter_count = defaultdict(lambda: defaultdict(int)) data = GetArticle() for article in data: year = article[\u0026#34;year\u0026#34;] quarter = article[\u0026#34;quarter\u0026#34;] year_quarter_count[year][quarter] += 1 return Result.success(result) åˆ†ç±»æ•°æ®ç»Ÿè®¡ 1 2 3 4 5 6 7 8 9 10 @cs.route(\u0026#39;/categorize\u0026#39;) @cache.cached(timeout=60) def Pie(): \u0026#34;\u0026#34;\u0026#34;è·å–æ–‡ç« åˆ†ç±»ç»Ÿè®¡\u0026#34;\u0026#34;\u0026#34; categorize_data = Categorize.query.all() pie_data = [ {\u0026#34;value\u0026#34;: item.article_num, \u0026#34;name\u0026#34;: item.categorize} for item in categorize_data ] return Result.success(pie_data) 4.4.2 æ•°æ®å¤„ç†æµç¨‹ 4.5 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ ç¼“å­˜ä¼˜åŒ–\nä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ 60 ç§’ç¼“å­˜è¿‡æœŸæ—¶é—´ é’ˆå¯¹é«˜é¢‘è®¿é—®æ¥å£å¯ç”¨ç¼“å­˜ æ•°æ®å¤„ç†ä¼˜åŒ–\nä½¿ç”¨ defaultdict ä¼˜åŒ–æ•°æ®èšåˆ æ‰¹é‡æ•°æ®æŸ¥è¯¢ æŸ¥è¯¢ æ®é¢„å¤„ç†å’Œè½¬æ¢ æŸ¥è¯¢ä¼˜åŒ–\nORM å»¶è¿ŸåŠ è½½ æŸ¥è¯¢ç»“æœç¼“å­˜ åˆç†çš„æ•°æ®ç´¢å¼• 4.6 æ•°æ®æµè½¬æµç¨‹ 4.7 é”™è¯¯å¤„ç†æœºåˆ¶ å…¨å±€å¼‚å¸¸å¤„ç†\n1 2 3 4 5 try: # ä¸šåŠ¡é€»è¾‘ except Exception as e: print(f\u0026#34;Error: {str(e)}\u0026#34;) return Result.error(str(e)) æ•°æ®éªŒè¯\n1 2 if not data or not data.labels: return Result.error(\u0026#34;Invalid data format\u0026#34;) ç»“æœå°è£…\n1 2 3 4 5 6 7 8 class Result: @staticmethod def success(data): return jsonify({\u0026#34;code\u0026#34;: 200, \u0026#34;data\u0026#34;: data}) @staticmethod def error(msg): return jsonify({\u0026#34;code\u0026#34;: 500, \u0026#34;msg\u0026#34;: msg}) æŠ€æœ¯æ€»ç»“ 1. æŠ€æœ¯æ ˆå…¨æ™¯å›¾ ","date":"2024-12-19T21:38:38Z","image":"https://www.ownit.top/title_pic/04.jpg","permalink":"https://www.ownit.top/p/202412192138/","title":"CSDNæ•°æ®å¤§å±å¯è§†åŒ–ã€å¼€æºã€‘"},{"content":"ç®€ä»‹ éšç€ä¼ä¸šITåŸºç¡€è®¾æ–½çš„ä¸æ–­æ‰©å¤§ï¼ŒLinuxæœåŠ¡å™¨çš„æ•°é‡ä¹Ÿæ—¥ç›Šå¢å¤šï¼Œä¼ ç»Ÿçš„å•æœºæ—¥å¿—ç®¡ç†æ–¹å¼å·²æ— æ³•æ»¡è¶³å¯¹æ—¥å¿—æ•°æ®é›†ä¸­ç®¡ç†ã€å®¡è®¡å’Œåˆ†æçš„éœ€æ±‚ã€‚å°¤å…¶æ˜¯åœ¨å¤§å‹é›†ç¾¤ç¯å¢ƒä¸­ï¼Œå¦‚ä½•é«˜æ•ˆåœ°æ”¶é›†ã€å­˜å‚¨å’Œåˆ†ææ—¥å¿—æˆä¸ºäº†ä¸€é¡¹é‡è¦çš„æŠ€æœ¯æŒ‘æˆ˜ã€‚\nèƒŒæ™¯ åœ¨å®ç°å¯¹å¤§å‹Linuxé›†ç¾¤çš„æ—¥å¿—é›†ä¸­ç®¡ç†ä¸å®¡è®¡ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹rsyslogæ—¥å¿—çš„æ”¶é›†ã€æ“ä½œå‘½ä»¤æ—¥å¿—ä»¥åŠç™»å½•æ—¥å¿—çš„å®¡è®¡ã€‚é€šè¿‡éƒ¨ç½²é›†ä¸­çš„rsyslogæœåŠ¡ç«¯ï¼Œèƒ½å¤Ÿç»Ÿä¸€æ”¶é›†1300å¤šå°LinuxæœåŠ¡å™¨çš„ç³»ç»Ÿæ—¥å¿—ï¼Œç¡®ä¿æ—¥å¿—æ•°æ®çš„é›†ä¸­åŒ–ç®¡ç†ã€‚ä½¿ç”¨Filebeatä½œä¸ºæ—¥å¿—æ”¶é›†å·¥å…·ï¼Œå°†æ—¥å¿—æ•°æ®æ¨é€è‡³Logstashè¿›è¡Œæ¸…æ´—å’Œè½¬æ¢ï¼Œæœ€ç»ˆå­˜å‚¨åˆ°Elasticsearchä¸­ï¼Œå¹¶é€šè¿‡Kibanaå®ç°å®æ—¶æ•°æ®å¯è§†åŒ–å±•ç¤ºã€‚è¿™ç§æ–¹å¼ä¸ä»…ç®€åŒ–äº†æ—¥å¿—ç®¡ç†æµç¨‹ï¼Œè¿˜æé«˜äº†ç³»ç»Ÿçš„ç›‘æ§æ•ˆç‡å’Œå®‰å…¨æ€§ã€‚\néœ€æ±‚ ç»Ÿä¸€ç®¡ç† 1300 å°æœåŠ¡å™¨çš„Linuxç³»ç»Ÿæ—¥å¿—ï¼Œèƒ½å¤ŸåŠæ—¶å‘ç°é—®é¢˜å’Œå‘Šè­¦ã€‚ è§£å†³æ–¹æ¡ˆ é›†ä¸­ç®¡ç†ï¼šé€šè¿‡ç»Ÿä¸€çš„æœåŠ¡ç«¯æ”¶é›†æ‰€æœ‰LinuxæœåŠ¡å™¨çš„æ—¥å¿—æ•°æ®ï¼Œå‡å°‘å•ç‹¬é…ç½®æ¯å°æœåŠ¡å™¨çš„å·¥ä½œé‡ã€‚ æ—¥å¿—å®¡è®¡ï¼šå¯¹æ“ä½œå‘½ä»¤æ—¥å¿—ã€ç™»å½•æ—¥å¿—ç­‰è¿›è¡Œå®¡è®¡ï¼Œç¡®ä¿ç³»ç»Ÿè¡Œä¸ºçš„å¯è¿½æº¯æ€§ã€‚ æ•°æ®æ¸…æ´—ä¸åˆ†æï¼šé€šè¿‡æ—¥å¿—æ¸…æ´—ä¸æ ¼å¼è½¬æ¢ï¼Œç¡®ä¿æ—¥å¿—æ•°æ®çš„æ ‡å‡†åŒ–ï¼Œä¾¿äºåç»­çš„åˆ†æå’Œå¯è§†åŒ–å±•ç¤ºã€‚ å®æ—¶å±•ç¤ºï¼šåˆ©ç”¨Kibanaå°†æ¸…æ´—åçš„æ•°æ®å®æ—¶å¯è§†åŒ–ï¼Œå¸®åŠ©è¿ç»´äººå‘˜å¿«é€Ÿå‘ç°æ½œåœ¨é—®é¢˜ã€‚ æ•´ä½“æ¶æ„ ä¸ºå®ç°è¿™äº›ç›®æ ‡ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä»¥ä¸‹çš„ç³»ç»Ÿæ¶æ„ï¼š\nrsyslogï¼šä½œä¸ºæ—¥å¿—æ”¶é›†çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒè´Ÿè´£å°†æ¥è‡ªLinuxç³»ç»Ÿçš„å„ç§æ—¥å¿—ï¼ˆåŒ…æ‹¬/var/log/messagesç­‰ï¼‰ç»Ÿä¸€æ¨é€åˆ°ä¸­å¿ƒåŒ–çš„æ—¥å¿—æœåŠ¡ç«¯ã€‚ Filebeatï¼šä½œä¸ºè½»é‡çº§çš„æ—¥å¿—æ”¶é›†å™¨ï¼Œéƒ¨ç½²åœ¨å„ä¸ªLinuxèŠ‚ç‚¹ä¸Šï¼Œè´Ÿè´£å°†æ—¥å¿—æ–‡ä»¶ä¼ è¾“åˆ°Logstashã€‚ Logstashï¼šå¯¹æ”¶é›†åˆ°çš„æ—¥å¿—è¿›è¡Œæ¸…æ´—ã€è§£æå’Œè½¬æ¢ï¼Œç¡®ä¿æ•°æ®ç¬¦åˆé¢„å®šæ ¼å¼ï¼Œä¾¿äºå­˜å…¥Elasticsearchã€‚ Elasticsearchï¼šå­˜å‚¨ç»è¿‡æ¸…æ´—å’Œè½¬æ¢çš„æ—¥å¿—æ•°æ®ï¼Œæä¾›å¼ºå¤§çš„å…¨æ–‡æœç´¢å’Œæ•°æ®æŸ¥è¯¢åŠŸèƒ½ã€‚ Kibanaï¼šé€šè¿‡Kibanaä»ªè¡¨ç›˜å®æ—¶å±•ç¤ºå­˜å‚¨åœ¨Elasticsearchä¸­çš„æ—¥å¿—æ•°æ®ï¼Œå¸®åŠ©è¿ç»´äººå‘˜è¿›è¡Œæ•°æ®åˆ†æå’Œå¯è§†åŒ–å±•ç¤ºã€‚ rsyslogæ±‡æ€» rsyslogæœåŠ¡ç«¯ é¦–å…ˆé…ç½®rsyslogæœåŠ¡å™¨ï¼Œå¯ä»¥ç»Ÿä¸€æ”¶é›†é›†ç¾¤å†…éƒ¨çš„æ—¥å¿—ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # åŠ è½½æœ¬åœ°ç³»ç»Ÿæ—¥å¿—æ¨¡å—ï¼ˆä¾‹å¦‚é€šè¿‡ logger å‘½ä»¤å‘é€çš„æ—¥å¿—ï¼‰ $ModLoad imuxsock # åŠ è½½å†…æ ¸æ—¥å¿—æ¨¡å—ï¼ˆä¹‹å‰ç”± rklogd å¤„ç†ï¼‰ $ModLoad imklog # åŠ è½½ UDP æ¨¡å—ï¼Œæ”¯æŒé€šè¿‡ UDP åè®®æ¥æ”¶æ—¥å¿— $ModLoad imudp # é…ç½® UDP æœåŠ¡å™¨åœ¨ 514 ç«¯å£æ¥æ”¶æ—¥å¿— $UDPServerRun 514 # åŠ è½½ TCP æ¨¡å—ï¼Œæ”¯æŒé€šè¿‡ TCP åè®®æ¥æ”¶æ—¥å¿— $ModLoad imtcp # é…ç½® TCP æœåŠ¡å™¨åœ¨ 514 ç«¯å£æ¥æ”¶æ—¥å¿— $InputTCPServerRun 514 # å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰çš„æ—¥å¿—æ ¼å¼æ¨¡æ¿ \u0026#39;myFormat\u0026#39; $template myFormat,\u0026#34;%timestamp:::date-rfc3339% %fromhost-ip% %HOSTNAME% [%programname%] %syslogseverity-text%:%msg%\\n\u0026#34; # è®¾ç½®é»˜è®¤çš„æ–‡ä»¶æ ¼å¼ä¸ºä¼ ç»Ÿçš„ rsyslog æ ¼å¼ $ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat # åŠ è½½ /etc/rsyslog.d/ ç›®å½•ä¸‹çš„æ‰€æœ‰é…ç½®æ–‡ä»¶ $IncludeConfig /etc/rsyslog.d/*.conf # é…ç½®æ”¶é›† info çº§åˆ«çš„æ—¥å¿—ï¼Œæ’é™¤ mailã€authprivã€cron ç±»åˆ«çš„æ—¥å¿—ï¼Œè¾“å‡ºåˆ° /var/log/messages æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ myFormat æ ¼å¼ *.info;mail.none;authpriv.none;cron.none /var/log/messages;myFormat # æ”¶é›†æ‰€æœ‰ authpriv ç±»åˆ«çš„æ—¥å¿—ï¼ˆé€šå¸¸æ˜¯è®¤è¯ç›¸å…³çš„æ—¥å¿—ï¼‰ï¼Œè¾“å‡ºåˆ° /var/log/secure æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ myFormat æ ¼å¼ authpriv.* /var/log/secure;myFormat # æ”¶é›†æ‰€æœ‰ mail ç±»åˆ«çš„æ—¥å¿—ï¼Œè¾“å‡ºåˆ° /var/log/maillog æ–‡ä»¶ï¼Œä½¿ç”¨å¼‚æ­¥å†™å…¥ï¼ˆ- è¡¨ç¤ºå¼‚æ­¥ï¼‰ mail.* -/var/log/maillog # æ”¶é›†æ‰€æœ‰ cron ç±»åˆ«çš„æ—¥å¿—ï¼ˆå®šæ—¶ä»»åŠ¡æ—¥å¿—ï¼‰ï¼Œè¾“å‡ºåˆ° /var/log/cron æ–‡ä»¶ cron.* /var/log/cron # æ”¶é›†æ‰€æœ‰ç´§æ€¥çº§åˆ«ï¼ˆemergï¼‰çš„æ—¥å¿—ï¼Œå°†å…¶é€šè¿‡ç³»ç»Ÿæ¶ˆæ¯å‘é€ *.emerg :omusrmsg:* # æ”¶é›† uucp å’Œ news ç±»åˆ«çš„ä¸¥é‡çº§åˆ«ï¼ˆcritï¼‰æ—¥å¿—ï¼Œè¾“å‡ºåˆ° /var/log/spooler æ–‡ä»¶ uucp,news.crit /var/log/spooler # æ”¶é›†æ‰€æœ‰ local7 ç±»åˆ«çš„æ—¥å¿—ï¼Œè¾“å‡ºåˆ° /var/log/boot.log æ–‡ä»¶ local7.* /var/log/boot.log é‡å¯æœåŠ¡ç«¯\n1 systemctl restart rsyslog ä¿®æ”¹å‰ï¼š ä¿®æ”¹åï¼š rsyslogå®¢æˆ·ç«¯ æ‰€æœ‰é›†ç¾¤çš„å®¢æˆ·ç«¯é…ç½®æœ€åä¸€è¡ŒIPï¼Œå°±å¯ä»¥æŠŠæ•°æ®æ±‡æ€»åœ¨ä¸€åˆ‡\n1 2 3 [root@zabbix ~]# cat /etc/rsyslog.conf |tail -n 2 #authpriv.* @10.10.10.17 *.* @@192.168.102.20 # rsyslog æœåŠ¡ç«¯çš„IP é‡å¯\n1 systemctl restart rsyslog.service æ—¥å¿—å·²ç»æ‰“å°åˆ°rsyslog æœåŠ¡ç«¯çš„ /var/log/messages /var/log/secure ç­‰æ–‡ä»¶\nfilebeaetæ”¶é›† åœ¨rsyslog æœåŠ¡ç«¯çš„å®‰è£…filebeaetï¼Œå¹¶ä¸”ä½¿ç”¨å¦‚ä¸‹é…ç½®å¯åŠ¨\n1 2 3 4 5 6 7 8 9 10 11 12 filebeat.config.modules: path: ${path.config}/modules.d/*.yml reload.enabled: false filebeat.inputs: - type: log enabled: true tail_files: true paths: - /var/log/messages output.logstash: hosts: [\u0026#34;192.168.1.100:5514\u0026#34;] # æŠŠæ—¥å¿—å‘é€åˆ°logstatshä¸­ logstatshé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 [root@game logstash]# cat config/rsyslog.conf input { beats { port =\u0026gt; 5514 type =\u0026gt; syslog } } filter { grok { match =\u0026gt; { \u0026#34;message\u0026#34; =\u0026gt; \u0026#34;%{TIMESTAMP_ISO8601:time} %{IP:client_ip} %{HOSTNAME:host_name} \\[%{DATA:type}\\] %{GREEDYDATA:info}\u0026#34; } overwrite =\u0026gt; [\u0026#34;message\u0026#34;] } mutate { split =\u0026gt; [\u0026#34;type\u0026#34;,\u0026#34;,\u0026#34;] } mutate{ add_field =\u0026gt; { \u0026#34;types\u0026#34; =\u0026gt; \u0026#34;%{[type][1]}\u0026#34; } } mutate{remove_field =\u0026gt; [ \u0026#34;tags\u0026#34;,\u0026#34;agent\u0026#34;,\u0026#34;host\u0026#34;,\u0026#34;log\u0026#34;,\u0026#34;ecs\u0026#34;,\u0026#34;type\u0026#34; ]} date { match =\u0026gt; [\u0026#34;time\u0026#34;, \u0026#34;yyyy-MM-dd HH:mm:ss,SSS\u0026#34;, \u0026#34;UNIX\u0026#34;] target =\u0026gt; \u0026#34;@timestamp\u0026#34; locale =\u0026gt; \u0026#34;cn\u0026#34; } } output { stdout { codec=\u0026gt; rubydebug } elasticsearch { hosts =\u0026gt; [\u0026#34;127.0.0.1:9200\u0026#34;] index =\u0026gt; \u0026#34;message\u0026#34; } } æ•°æ®æ ¼å¼\n1 2024-12-03T18:35:30+08:00 192.168.102.30 master01 [kubelet] info: E1203 18:35:30.827608 1065 summary_sys_containers.go:83] \u0026#34;Failed to get system container stats\u0026#34; err=\u0026#34;failed to get cgroup stats for \\\u0026#34;/system.slice/docker.service\\\u0026#34;: failed to get container info for \\\u0026#34;/system.slice/docker.service\\\u0026#34;: unknown container \\\u0026#34;/system.slice/docker.service\\\u0026#34;\u0026#34; containerName=\u0026#34;/system.slice/docker.service\u0026#34; GROKè§£æ\n1 %{TIMESTAMP_ISO8601:time} %{IP:client_ip} %{HOSTNAME:host_name} \\[%{DATA:type}\\] %{GREEDYDATA:info} è¾“å‡ºæ ¼å¼\n1 2 3 4 5 6 7 { \u0026#34;client_ip\u0026#34;: \u0026#34;192.168.102.30\u0026#34;, \u0026#34;time\u0026#34;: \u0026#34;2024-12-03T18:35:30+08:00\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;kubelet\u0026#34;, \u0026#34;host_name\u0026#34;: \u0026#34;master01\u0026#34;, \u0026#34;info\u0026#34;: \u0026#34;info: E1203 18:35:30.827608 1065 summary_sys_containers.go:83] \\\u0026#34;Failed to get system container stats\\\u0026#34; err=\\\u0026#34;failed to get cgroup stats for \\\\\\\u0026#34;/system.slice/docker.service\\\\\\\u0026#34;: failed to get container info for \\\\\\\u0026#34;/system.slice/docker.service\\\\\\\u0026#34;: unknown container \\\\\\\u0026#34;/system.slice/docker.service\\\\\\\u0026#34;\\\u0026#34; containerName=\\\u0026#34;/system.slice/docker.service\\\u0026#34;\\r\u0026#34; } æ“ä½œç³»ç»Ÿå‘½ä»¤å®¡è®¡ Linuxä¸€èˆ¬éƒ½æ˜¯ç»ˆç«¯æ‰§è¡Œå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥è®©å‘½ä»¤å†™åˆ°messageæ—¥å¿—ä¸Šï¼Œåœ¨é€šè¿‡è¿‡æ»¤ï¼Œè·å–æ“ä½œå‘½ä»¤è®°å½•ã€‚\nLinuxç»ˆç«¯é…ç½® 1 2 3 4 5 6 7 8 [root@zabbix ~]# cat /etc/profile | tail -n 2 unset MAILCHECK export PROMPT_COMMAND=\u0026#39;{ msg=$(history 1 | { read x y; echo $y; });logger -p local2.info \u0026#34;euid=$(whoami)\u0026#34; $(who am i) `pwd` \u0026#34;$msg\u0026#34;; }\u0026#39; æ—¥å¿—æ ¼å¼ Oct 11 17:32:41 zabbix root: euid=root root pts/0 2021-10-11 15:13 (10.10.10.3) /root cat /etc/profile Oct 11 17:32:47 zabbix root: euid=root root pts/0 2021-10-11 15:13 (10.10.10.3) /root cat /etc/profile | tail -n 2 rsyslogæœåŠ¡ç«¯å±•ç¤º filebeaté…ç½® 1 2 3 4 5 6 7 8 [root@logserver01 filebeat]# cat system_messages.yml #=========================== Filebeat inputs ============================= filebeat.inputs: - type: log enabled: true tail_files: true paths: - /var/log/messages logstatshé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 [root@logserver01 config]# cat system_userlog_FromKafkaInES.conf input{ beats { host =\u0026gt; \u0026#39;172.17.9.200\u0026#39; port =\u0026gt; 5046 } #\tkafka{ #\tbootstrap_servers =\u0026gt; [\u0026#34;172.17.8.232:6667\u0026#34;] #\ttopics =\u0026gt; [\u0026#34;sys_os_exe\u0026#34;] #\tcodec =\u0026gt; \u0026#34;json\u0026#34; #\tgroup_id =\u0026gt; \u0026#34;ELK_SYSTEM_EXE_GROUP\u0026#34; #\tconsumer_threads =\u0026gt; 3 #\tclient_id =\u0026gt; \u0026#34;logstash\u0026#34; #\tdecorate_events =\u0026gt; false #\tauto_offset_reset =\u0026gt; \u0026#34;earliest\u0026#34; #\trequest_timeout_ms =\u0026gt; \u0026#34;300000\u0026#34; #\tsession_timeout_ms =\u0026gt; \u0026#34;20000\u0026#34; #\tmax_poll_interval_ms =\u0026gt; \u0026#34;600000\u0026#34; #\t} } filter{ if ([message] =~ \u0026#34;euid\u0026#34;){ grok{ match =\u0026gt; {\u0026#34;message\u0026#34; =\u0026gt; \u0026#39;^(?\u0026lt;exetime\u0026gt;\\d+-\\d+-\\d+)(?:[^\\d]+)(?\u0026lt;hhmmss\u0026gt;\\d+:\\d+:\\d+)(?:[^\\d]+\\d+:\\d+)(?:\\s)(?\u0026lt;deshost\u0026gt;[^ ]+)(?:\\s)(?\u0026lt;name\u0026gt;[^ ]+)(?:\\s\\[)(?\u0026lt;loginuser\u0026gt;[^ |\\]]*)(?:\\]\\s[^ ]+\\seuid=)(?\u0026lt;exeuser\u0026gt;[^ ]+)(?:\\s+)(?\u0026lt;userinfo\u0026gt;[^\\(]+)(?:\\s\\()(?\u0026lt;srchost\u0026gt;[^\\)]+)(?:\\)\\s)(?\u0026lt;exepath\u0026gt;[^ ]+)(\\s+)(?\u0026lt;exeinfo\u0026gt;.*)\u0026#39;} } if \u0026#34;_grokparsefailure\u0026#34; in [tags] { drop { } } mutate{ add_field =\u0026gt; [\u0026#34;tmp_exeinfo\u0026#34;,\u0026#34;%{exeinfo}\u0026#34;] } mutate{ split =\u0026gt; [\u0026#34;exetime\u0026#34;,\u0026#34;-\u0026#34;] split =\u0026gt; [\u0026#34;tmp_exeinfo\u0026#34;,\u0026#34; \u0026#34;] } mutate{ add_field =\u0026gt; [\u0026#34;indextime\u0026#34;,\u0026#34;%{[exetime][0]}%{[exetime][1]}\u0026#34;] add_field =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;%{[exetime][0]}-%{[exetime][1]}-%{[exetime][2]} %{hhmmss}\u0026#34;] add_field =\u0026gt; [\u0026#34;cmd\u0026#34;,\u0026#34;%{[tmp_exeinfo][0]}\u0026#34;] } #Retention log insertion time to ES.............. ruby { code =\u0026gt; \u0026#34;event.set(\u0026#39;inserttime\u0026#39;, event.get(\u0026#39;@timestamp\u0026#39;).time.to_i)\u0026#34; } #replace InsertTime with evtTime \u0026#34;yyyy-MM-dd HH:mm:ss eg:2020-06-29 09:24:29\u0026#34; date{ match =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;] #kibana use this time.................... target =\u0026gt; \u0026#34;@timestamp\u0026#34; } mutate{replace =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;%{evtTime} +0800\u0026#34;]} date{ match =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;yyyy-MM-dd HH:mm:ss +0800\u0026#34;] timezone =\u0026gt;\u0026#34;UTC\u0026#34; #log event time timestamp................ target =\u0026gt; \u0026#34;logtimestamp\u0026#34; } #log event time long string...................... ruby { code =\u0026gt; \u0026#34;event.set(\u0026#39;longtime\u0026#39;, event.get(\u0026#39;logtimestamp\u0026#39;).time.to_i)\u0026#34; } mutate{remove_field =\u0026gt; [ \u0026#34;tmp_exeinfo\u0026#34;,\u0026#34;evtTime\u0026#34;,\u0026#34;host\u0026#34;,\u0026#34;ecs\u0026#34;,\u0026#34;log\u0026#34;,\u0026#34;hhmmss\u0026#34;,\u0026#34;input\u0026#34;,\u0026#34;agent\u0026#34;,\u0026#34;exetime\u0026#34; ]} } else{ drop{} } } output{ stdout{codec =\u0026gt; rubydebug} if [indextime] !~ \u0026#34;index\u0026#34;{ elasticsearch{ hosts =\u0026gt; [\u0026#34;http://172.17.9.176:9200\u0026#34;] #hosts =\u0026gt; \u0026#34;172.17.9.176\u0026#34; index =\u0026gt; \u0026#34;sys_os_userlog_%{[indextime]}\u0026#34; user =\u0026gt; \u0026#34;*********\u0026#34; password =\u0026gt; \u0026#34;*********\u0026#34; } } } æ•°æ®æ ¼å¼\n1 2024-12-03T18:39:05+08:00 192.168.102.30 master01 [root] info: euid=root root pts/0 2024-12-03 18:21 (192.168.96.19) /root [2024-12-03 18:39:05]ip a GROKè§£æ\n1 ^(?\u0026lt;exetime\u0026gt;\\d+-\\d+-\\d+)(?:[^\\d]+)(?\u0026lt;hhmmss\u0026gt;\\d+:\\d+:\\d+)(?:[^\\d]+\\d+:\\d+)(?:\\s)(?\u0026lt;deshost\u0026gt;[^ ]+)(?:\\s)(?\u0026lt;name\u0026gt;[^ ]+)(?:\\s\\[)(?\u0026lt;loginuser\u0026gt;[^ |\\]]*)(?:\\]\\s[^ ]+\\seuid=)(?\u0026lt;exeuser\u0026gt;[^ ]+)(?:\\s+)(?\u0026lt;userinfo\u0026gt;[^\\(]+)(?:\\s\\()(?\u0026lt;srchost\u0026gt;[^\\)]+)(?:\\)\\s)(?\u0026lt;exepath\u0026gt;[^ ]+)(\\s+)(?\u0026lt;exeinfo\u0026gt;.*) è¾“å‡ºæ ¼å¼\n1 2 3 4 5 6 7 8 9 10 11 12 { \u0026#34;loginuser\u0026#34;: \u0026#34;root\u0026#34;, \u0026#34;hhmmss\u0026#34;: \u0026#34;18:39:05\u0026#34;, \u0026#34;exepath\u0026#34;: \u0026#34;/root\u0026#34;, \u0026#34;deshost\u0026#34;: \u0026#34;192.168.102.30\u0026#34;, \u0026#34;srchost\u0026#34;: \u0026#34;192.168.96.19\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;master01\u0026#34;, \u0026#34;exeinfo\u0026#34;: \u0026#34;[2024-12-03 18:39:05]ip a\\r\u0026#34;, \u0026#34;exeuser\u0026#34;: \u0026#34;root\u0026#34;, \u0026#34;userinfo\u0026#34;: \u0026#34;root pts/0 2024-12-03 18:21\u0026#34;, \u0026#34;exetime\u0026#34;: \u0026#34;2024-12-03\u0026#34; } ç³»ç»Ÿç”¨æˆ·ç™»å½•å®¡è®¡ filebeaté…ç½® 1 2 3 4 5 6 7 8 9 10 11 [root@logserver01 filebeat]# cat system_secure.yml #=========================== Filebeat inputs ============================= filebeat.inputs: - type: log enabled: true tail_files: true paths: - /var/log/secure #=========================== Filebeat outppp_id: messuts ============================= output.logstash: hosts: [\u0026#34;172.17.9.200:5045\u0026#34;] logstatshé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 [root@logserver01 config]# cat system_login_FromKafkaInES.conf input{ beats { host =\u0026gt; \u0026#39;172.17.9.200\u0026#39; port =\u0026gt; 5045 } # #\tkafka{ #\tbootstrap_servers =\u0026gt; [\u0026#34;172.17.8.232:6667\u0026#34;] #\ttopics =\u0026gt; [\u0026#34;sys_os_login\u0026#34;] #\tcodec =\u0026gt; \u0026#34;json\u0026#34; #\tgroup_id =\u0026gt; \u0026#34;ELK_SYSTEM_LOGIN_GROUP\u0026#34; #\tconsumer_threads =\u0026gt; 3 #\tclient_id =\u0026gt; \u0026#34;logstash\u0026#34; #\tdecorate_events =\u0026gt; false #\tauto_offset_reset =\u0026gt; \u0026#34;earliest\u0026#34; #\trequest_timeout_ms =\u0026gt; \u0026#34;300000\u0026#34; #\tsession_timeout_ms =\u0026gt; \u0026#34;20000\u0026#34; #\tmax_poll_interval_ms =\u0026gt; \u0026#34;600000\u0026#34; #\t} } filter{ #login successed log if ([message] =~ \u0026#34;Accepted\u0026#34;){ grok{ match =\u0026gt; {\u0026#34;message\u0026#34; =\u0026gt; \u0026#39;^(?\u0026lt;atime\u0026gt;\\d+-\\d+-\\d+)(?:[^\\d]+)(?\u0026lt;hhmmss\u0026gt;\\d+:\\d+:\\d+)(?:[^\\d]+\\d+:\\d+)(?:\\s+)(?\u0026lt;deshost\u0026gt;\\d+\\.\\d+\\.\\d+\\.\\d+)(?:\\s)(?\u0026lt;name\u0026gt;[^ ]+)(?:[\\S\\s]*Failed\\spassword\\sfor[\\sinvalid\\suser]*\\s)(?\u0026lt;loginuser\u0026gt;[^ ]+)(?:\\sfrom\\s)(?\u0026lt;srchost\u0026gt;[\\d.]+)(?:\\s\\w+\\s\\d+\\s)(?\u0026lt;loginmode\u0026gt;\\w*)\u0026#39;} } if \u0026#34;_grokparsefailure\u0026#34; in [tags] { drop { } } mutate{ add_field =\u0026gt; [\u0026#34;type\u0026#34;,\u0026#34;systemlogin\u0026#34;] split =\u0026gt; [\u0026#34;atime\u0026#34;,\u0026#34;-\u0026#34;] } mutate{ add_field =\u0026gt; [\u0026#34;indextime\u0026#34;,\u0026#34;%{[atime][0]}%{[atime][1]}\u0026#34;] add_field =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;%{[atime][0]}-%{[atime][1]}-%{[atime][2]} %{hhmmss}\u0026#34;] } #Retention log insertion time to ES.............. ruby { code =\u0026gt; \u0026#34;event.set(\u0026#39;inserttime\u0026#39;, event.get(\u0026#39;@timestamp\u0026#39;).time.to_i)\u0026#34; } #replace InsertTime with evtTime \u0026#34;yyyy-MM-dd HH:mm:ss eg:2020-06-29 09:24:29\u0026#34; date{ match =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;] #kibana use this time.................... target =\u0026gt; \u0026#34;@timestamp\u0026#34; } mutate{replace =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;%{evtTime} +0800\u0026#34;]} date{ match =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;yyyy-MM-dd HH:mm:ss +0800\u0026#34;] timezone =\u0026gt;\u0026#34;UTC\u0026#34; #log event time timestamp................ target =\u0026gt; \u0026#34;logtimestamp\u0026#34; } #log event time long string...................... ruby { code =\u0026gt; \u0026#34;event.set(\u0026#39;longtime\u0026#39;, event.get(\u0026#39;logtimestamp\u0026#39;).time.to_i)\u0026#34; } mutate{remove_field =\u0026gt; [ \u0026#34;evtTime\u0026#34;,\u0026#34;host\u0026#34;,\u0026#34;ecs\u0026#34;,\u0026#34;log\u0026#34;,\u0026#34;hhmmss\u0026#34;,\u0026#34;input\u0026#34;,\u0026#34;agent\u0026#34;,\u0026#34;atime\u0026#34; ]} } #login failed log else if ([message] =~ \u0026#34;Failed password for\u0026#34;){ grok{ match =\u0026gt; {\u0026#34;message\u0026#34; =\u0026gt; \u0026#39;^(?\u0026lt;atime\u0026gt;\\d+-\\d+-\\d+)(?:[^\\d]+)(?\u0026lt;hhmmss\u0026gt;\\d+:\\d+:\\d+)(?:[^\\d]+\\d+:\\d+)(?:\\s+)(?\u0026lt;deshost\u0026gt;\\d+\\.\\d+\\.\\d+\\.\\d+)(?:[\\S\\s]*Failed\\spassword\\sfor[\\sinvalid\\suser]*\\s)(?\u0026lt;loginuser\u0026gt;[^ ]+)(?:\\sfrom\\s)(?\u0026lt;srchost\u0026gt;[\\d.]+)(?:\\s\\w+\\s\\d+\\s)(?\u0026lt;loginmode\u0026gt;\\w*)\u0026#39;} } if \u0026#34;_grokparsefailure\u0026#34; in [tags] { drop { } } mutate{ add_field =\u0026gt; [\u0026#34;type\u0026#34;,\u0026#34;systemloginfailed\u0026#34;] split =\u0026gt; [\u0026#34;atime\u0026#34;,\u0026#34;-\u0026#34;] } mutate{ add_field =\u0026gt; [\u0026#34;indextime\u0026#34;,\u0026#34;%{[atime][0]}%{[atime][1]}\u0026#34;] add_field =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;%{[atime][0]}-%{[atime][1]}-%{[atime][2]} %{hhmmss}\u0026#34;] } #Retention log insertion time to ES.............. ruby { code =\u0026gt; \u0026#34;event.set(\u0026#39;inserttime\u0026#39;, event.get(\u0026#39;@timestamp\u0026#39;).time.to_i)\u0026#34; } #replace InsertTime with evtTime \u0026#34;yyyy-MM-dd HH:mm:ss eg:2020-06-29 09:24:29\u0026#34; date{ match =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;] #kibana use this time.................... target =\u0026gt; \u0026#34;@timestamp\u0026#34; } mutate{replace =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;%{evtTime} +0800\u0026#34;]} date{ match =\u0026gt; [\u0026#34;evtTime\u0026#34;,\u0026#34;yyyy-MM-dd HH:mm:ss +0800\u0026#34;] timezone =\u0026gt;\u0026#34;UTC\u0026#34; #log event time timestamp................ target =\u0026gt; \u0026#34;logtimestamp\u0026#34; } #log event time long string...................... ruby { code =\u0026gt; \u0026#34;event.set(\u0026#39;longtime\u0026#39;, event.get(\u0026#39;logtimestamp\u0026#39;).time.to_i)\u0026#34; } mutate{remove_field =\u0026gt; [ \u0026#34;evtTime\u0026#34;,\u0026#34;host\u0026#34;,\u0026#34;ecs\u0026#34;,\u0026#34;log\u0026#34;,\u0026#34;hhmmss\u0026#34;,\u0026#34;input\u0026#34;,\u0026#34;agent\u0026#34;,\u0026#34;atime\u0026#34; ]} } #other log else{ drop{} } } output{ if [type] == \u0026#34;systemlogin\u0026#34;{ if [indextime] !~ \u0026#34;index\u0026#34;{ stdout{codec =\u0026gt; rubydebug} elasticsearch{ hosts =\u0026gt; \u0026#34;172.17.9.176\u0026#34; index =\u0026gt; \u0026#34;sys_os_systemlogin_%{[indextime]}\u0026#34; user =\u0026gt; \u0026#34;elastic\u0026#34; password =\u0026gt; \u0026#34;f5OPbv6sqfstmc+\u0026#34; } } } else if [type] == \u0026#34;systemloginfailed\u0026#34;{ if [indextime] !~ \u0026#34;index\u0026#34;{ stdout{codec =\u0026gt; rubydebug} elasticsearch{ hosts =\u0026gt; \u0026#34;172.17.9.176\u0026#34; index =\u0026gt; \u0026#34;sys_os_systemloginfailed_%{[indextime]}\u0026#34; user =\u0026gt; \u0026#34;elastic\u0026#34; password =\u0026gt; \u0026#34;xxxxxxx+\u0026#34; } } } } æˆåŠŸæ—¥å¿—è§£æ\næ—¥å¿—æ ¼å¼\n1 2024-12-03T18:45:09+08:00 192.168.102.42 node03 [sshd] info: Accepted password for root from 192.168.96.19 port 14347 ssh2 GROKè¯­æ³•\n1 %{TIMESTAMP_ISO8601:atime} %{IP:deshost} %{HOSTNAME:name} \\[%{WORD:type}\\] %{DATA:loglevel}: Accepted password for %{WORD:loginuser} from %{IP:srchost} port %{NUMBER:port} %{WORD:loginmode} æ—¥å¿—æ ¼å¼\n1 2 3 4 5 6 7 8 9 10 11 { \u0026#34;loginuser\u0026#34;: \u0026#34;root\u0026#34;, \u0026#34;atime\u0026#34;: \u0026#34;2024-12-03T18:45:09+08:00\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;sshd\u0026#34;, \u0026#34;deshost\u0026#34;: \u0026#34;192.168.102.42\u0026#34;, \u0026#34;srchost\u0026#34;: \u0026#34;192.168.96.19\u0026#34;, \u0026#34;port\u0026#34;: \u0026#34;14347\u0026#34;, \u0026#34;loglevel\u0026#34;: \u0026#34;info\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;node03\u0026#34;, \u0026#34;loginmode\u0026#34;: \u0026#34;ssh2\u0026#34; } å¤±è´¥æ—¥å¿—æ ¼å¼\næ—¥å¿—æ ¼å¼\n1 2024-12-03T19:01:57+08:00 192.168.102.42 node03 [sshd] info: Failed password for invalid user 123 from 192.168.96.19 port 12103 ssh2 GROKè¯­æ³•\n1 ^(?\u0026lt;atime\u0026gt;\\d+-\\d+-\\d+)(?:[^\\d]+)(?\u0026lt;hhmmss\u0026gt;\\d+:\\d+:\\d+)(?:[^\\d]+\\d+:\\d+)(?:\\s+)(?\u0026lt;deshost\u0026gt;\\d+\\.\\d+\\.\\d+\\.\\d+)(?:[\\S\\s]*Failed\\spassword\\sfor[\\sinvalid\\suser]*\\s)(?\u0026lt;loginuser\u0026gt;[^ ]+)(?:\\sfrom\\s)(?\u0026lt;srchost\u0026gt;[\\d.]+)(?:\\s\\w+\\s\\d+\\s)(?\u0026lt;loginmode\u0026gt;\\w*) æ—¥å¿—è¾“å‡º\n1 2 3 4 5 6 7 8 { \u0026#34;loginuser\u0026#34;: \u0026#34;123\u0026#34;, \u0026#34;atime\u0026#34;: \u0026#34;2024-12-03\u0026#34;, \u0026#34;hhmmss\u0026#34;: \u0026#34;19:01:57\u0026#34;, \u0026#34;deshost\u0026#34;: \u0026#34;192.168.102.42\u0026#34;, \u0026#34;srchost\u0026#34;: \u0026#34;192.168.96.19\u0026#34;, \u0026#34;loginmode\u0026#34;: \u0026#34;ssh2\u0026#34; } ","date":"2024-12-19T15:27:19Z","image":"https://www.ownit.top/title_pic/47.jpg","permalink":"https://www.ownit.top/p/202412191527/","title":"é›†ä¸­ç®¡ç†ä¸å®æ—¶å®¡è®¡ï¼šæ„å»ºLinuxé›†ç¾¤ï¼ˆ1300å°æœåŠ¡å™¨ï¼‰æ—¥å¿—å¹³å°çš„æœ€ä½³å®è·µ"},{"content":"åœ¨ç°ä»£ IT ç³»ç»Ÿä¸­ï¼Œç›‘æ§ä½“ç³»æ˜¯ç¡®ä¿é«˜å¯ç”¨æ€§ã€é«˜æ€§èƒ½å’Œç¨³å®šæ€§çš„æ ¸å¿ƒå·¥å…·ã€‚ä¸€ä¸ªå®Œå–„çš„ç›‘æ§ä½“ç³»èƒ½å¤ŸåŠæ—¶å‘ç°ç³»ç»Ÿé—®é¢˜ã€åˆ†æé—®é¢˜æ ¹æºå¹¶å¿«é€Ÿé‡‡å–åº”å¯¹æªæ–½ï¼Œé¿å…æ•…éšœè¿›ä¸€æ­¥æ‰©æ•£ã€‚æœ¬æ–‡å°†ä»åŸºç¡€è®¾æ–½å±‚ã€ä¸­é—´ä»¶å±‚ã€å®¹å™¨ä¸ç¼–æ’å±‚ã€åº”ç”¨ä¸æœåŠ¡å±‚é€æ­¥å±•å¼€ï¼Œå…¨é¢ä»‹ç»å¦‚ä½•æ„å»ºç”Ÿäº§ç¯å¢ƒçš„ç›‘æ§ä½“ç³»ã€‚ 1. åŸºç¡€è®¾æ–½å±‚ç›‘æ§ åŸºç¡€è®¾æ–½æ˜¯æ”¯æ’‘æ•´ä¸ª IT ç³»ç»Ÿè¿è¡Œçš„æ ¹åŸºï¼Œå¯¹å…¶è¿›è¡Œæœ‰æ•ˆçš„ç›‘æ§ï¼Œå¯ä»¥åŠæ—¶å‘ç°å¹¶è§£å†³é—®é¢˜ï¼Œç¡®ä¿æ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚\nå…³é”®ç›‘æ§æŒ‡æ ‡ï¼š CPUï¼š ç›‘æ§ CPU ä½¿ç”¨ç‡ï¼ŒåŠæ—¶å‘ç°è¿‡é«˜ä½¿ç”¨æƒ…å†µã€‚ åˆ†æå¯èƒ½çš„åŸå› ï¼Œå¦‚æ— æ•ˆå¾ªç¯ã€æ­»é”ç­‰ã€‚ å·¥å…·å»ºè®®ï¼šä½¿ç”¨ Prometheus + Node Exporterã€‚ å†…å­˜ï¼š ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œé¿å…å†…å­˜æ³„éœ²å¯¼è‡´æœåŠ¡å´©æºƒã€‚ è®¾ç½®é˜ˆå€¼å‘Šè­¦ï¼Œæå‰é¢„è­¦ã€‚ ç½‘ç»œï¼š ç›‘æ§ç½‘ç»œæµé‡å’Œè¿æ¥çŠ¶æ€ï¼Œç¡®ä¿ç½‘ç»œé€šç•…ã€‚ åŠæ—¶å‘ç°å¹¶å¤„ç†ç½‘ç»œæ‹¥å µæˆ–æ”»å‡»äº‹ä»¶ã€‚ å·¥å…·å»ºè®®ï¼šä½¿ç”¨ cAdvisorã€Ntopã€‚ ç¡¬ç›˜ï¼š ç›‘æ§ç¡¬ç›˜ä½¿ç”¨ç‡å’Œ I/O æ€§èƒ½ï¼Œé¿å…ç£ç›˜ç©ºé—´ä¸è¶³æˆ– I/O ç“¶é¢ˆã€‚ å·¥å…·å»ºè®®ï¼šPrometheus Disk Exporterã€‚ 2. ä¸­é—´ä»¶å±‚ç›‘æ§ ä¸­é—´ä»¶æ˜¯åº”ç”¨ä¸åº•å±‚åŸºç¡€è®¾æ–½ä¹‹é—´çš„æ¡¥æ¢ï¼Œå…¶æ€§èƒ½ç›´æ¥å½±å“ä¸Šå±‚åº”ç”¨çš„å“åº”é€Ÿåº¦å’Œç¨³å®šæ€§ã€‚\nå¸¸è§ä¸­é—´ä»¶çš„ç›‘æ§ç­–ç•¥ï¼š Nginxï¼š ç›‘æ§è¯·æ±‚å¤„ç†æ—¶é—´ã€å¹¶å‘è¿æ¥æ•°ã€5xx é”™è¯¯ç‡ç­‰æŒ‡æ ‡ã€‚ å·¥å…·å»ºè®®ï¼šNginx æ¨¡å— + Prometheusã€‚ MySQLï¼š ç›‘æ§æ•°æ®åº“å“åº”æ—¶é—´ã€æŸ¥è¯¢æ•ˆç‡ã€è¿æ¥æ•°ã€‚ è®¾ç½®æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†ææ€§èƒ½ç“¶é¢ˆã€‚ å·¥å…·å»ºè®®ï¼šPercona Monitoring Plugins æˆ– Prometheus MySQL Exporterã€‚ RabbitMQï¼š ç›‘æ§æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦ã€å¤„ç†é€Ÿåº¦ã€æ¶ˆè´¹è€…çŠ¶æ€ã€‚ å·¥å…·å»ºè®®ï¼šRabbitMQ ç®¡ç†æ’ä»¶ã€‚ Consulï¼š ç›‘æ§æœåŠ¡å‘ç°ä¸é…ç½®çš„å¥åº·çŠ¶æ€ã€‚ å·¥å…·å»ºè®®ï¼šConsul å†…ç½®ç›‘æ§ API + Prometheusã€‚ Kafka + Zookeeperï¼š ç›‘æ§ Kafka æ¶ˆæ¯æµé‡ã€å»¶è¿Ÿå’Œæ¶ˆè´¹è€…ç»„çŠ¶æ€ã€‚ ç›‘æ§ Zookeeper çš„èŠ‚ç‚¹çŠ¶æ€ã€‚ å·¥å…·å»ºè®®ï¼šKafka Exporter + Zookeeper Exporterã€‚ 3. å®¹å™¨ä¸ç¼–æ’å±‚ç›‘æ§ å®¹å™¨åŒ–å’Œè‡ªåŠ¨åŒ–ç¼–æ’æ˜¯ç°ä»£äº‘åŸç”Ÿåº”ç”¨çš„æ ‡é…ï¼Œå¯¹å…¶è¿›è¡Œç›‘æ§å¯ä»¥ç¡®ä¿æœåŠ¡çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚\nå®¹å™¨ä¸ç¼–æ’å±‚ç›‘æ§çš„é‡ç‚¹ï¼š Kubernetes é›†ç¾¤ï¼š ç›‘æ§é›†ç¾¤çš„èµ„æºä½¿ç”¨æƒ…å†µã€èŠ‚ç‚¹å¥åº·çŠ¶æ€å’ŒæœåŠ¡éƒ¨ç½²çŠ¶æ€ã€‚ å·¥å…·å»ºè®®ï¼škube-state-metrics + Prometheusã€‚ Kubernetes äº‹ä»¶ç›‘æ§ï¼š ç›‘æ§äº‹ä»¶æ—¥å¿—ï¼ŒåŠæ—¶å“åº” Pod çš„å¼‚å¸¸çŠ¶æ€å’Œè°ƒåº¦å¤±è´¥ã€‚ Docker å®¹å™¨ç›‘æ§ï¼š ç›‘æ§å®¹å™¨çš„è¿è¡ŒçŠ¶æ€ã€èµ„æºä½¿ç”¨æƒ…å†µï¼Œç¡®ä¿å®¹å™¨çš„ç¨³å®šè¿è¡Œã€‚ å·¥å…·å»ºè®®ï¼šcAdvisorã€Prometheus Docker Exporterã€‚ 4. åº”ç”¨ä¸æœåŠ¡å±‚ç›‘æ§ åº”ç”¨ä¸æœåŠ¡å±‚æ˜¯ä¸ç”¨æˆ·ç›´æ¥äº¤äº’çš„å±‚é¢ï¼Œå…¶æ€§èƒ½å’Œç¨³å®šæ€§ç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒã€‚\nç›‘æ§å…³é”®ç‚¹ï¼š æœåŠ¡åº”ç”¨è¿›ç¨‹ï¼š ç›‘æ§åº”ç”¨è¿›ç¨‹çš„å¥åº·çŠ¶æ€ï¼ŒåŒ…æ‹¬å†…å­˜æ³„éœ²ã€æ­»é”ç­‰é—®é¢˜ã€‚ ä¸šåŠ¡é“¾è·¯è¿½è¸ªï¼š ä½¿ç”¨åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªå·¥å…·ï¼ˆå¦‚ Pinpointã€SkyWalking æˆ–é˜¿é‡Œäº‘ ARMSï¼‰è¿½è¸ªæœåŠ¡è°ƒç”¨é“¾è·¯ã€‚ åˆ†ææœåŠ¡é—´è°ƒç”¨çš„å»¶è¿Ÿï¼Œä¼˜åŒ–æ€§èƒ½ã€‚ ä¸šåŠ¡æ—¥å¿—ç›‘æ§ï¼š ä½¿ç”¨ Elasticsearchã€Logstash å’Œ Kibana (ELK Stack) åˆ†æä¸šåŠ¡æ—¥å¿—ã€‚ åœ¨èµ„æºæœ‰é™ï¼ˆå¦‚ç£ç›˜ç©ºé—´ 200Gï¼‰æ—¶ï¼Œå¯ç»“åˆé˜¿é‡Œäº‘ SLSã€‚ ä¸šåŠ¡æ¥å£å“åº”æ—¶é—´ç›‘æ§ï¼š ç›‘æ§æ¥å£çš„å“åº”æ—¶é—´ï¼Œç¡®ä¿å¿«é€Ÿå“åº”ç”¨æˆ·è¯·æ±‚ã€‚ å·¥å…·å»ºè®®ï¼šSkyWalking æˆ– Prometheusã€‚ è°ƒç”¨å¤±è´¥æ¬¡æ•°ç›‘æ§ï¼š ç›‘æ§æœåŠ¡è°ƒç”¨å¤±è´¥æ¬¡æ•°ï¼Œåˆ†æå¤±è´¥åŸå› å¹¶å¿«é€Ÿä¿®å¤ã€‚ 5. å‘Šè­¦å¹³å°å»ºè®¾ å‘Šè­¦ç­–ç•¥ï¼š å¤šæ¸ é“é€šçŸ¥ï¼š é›†æˆé’‰é’‰ã€é‚®ä»¶ã€ç”µè¯ã€çŸ­ä¿¡ã€å¾®ä¿¡ç­‰å¤šç§é€šçŸ¥æ–¹å¼ã€‚ å·¥å…·é€‰æ‹©ï¼š å¼€æºè‡ªå»ºï¼šAlertmanagerã€PrometheusAlertã€‚ å•†ä¸šæ–¹æ¡ˆï¼šé˜¿é‡Œäº‘å‘Šè­¦å¹³å°ã€‚ å…³é”®é…ç½®ï¼š å®šä¹‰å‘Šè­¦è§„åˆ™ï¼ˆå¦‚ CPU ä½¿ç”¨ç‡è¶… 90%ã€æ¥å£å“åº”æ—¶é—´è¶…è¿‡ 1 ç§’ï¼‰ã€‚ é…ç½®åˆ†çº§å‘Šè­¦ç­–ç•¥ï¼Œæ ¹æ®é—®é¢˜ä¸¥é‡æ€§é€‰æ‹©é€šçŸ¥æ–¹å¼ã€‚ 6. ç›‘æ§å¯è§†åŒ–å»ºè®¾ å¯è§†åŒ–çš„é‡è¦æ€§ï¼š ç›‘æ§å¯è§†åŒ–æ˜¯ç›‘æ§ä½“ç³»ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒå¯ä»¥å°†å¤æ‚çš„æ•°æ®ä»¥å›¾å½¢åŒ–çš„æ–¹å¼ç›´è§‚å±•ç¤ºï¼Œå¸®åŠ©è¿ç»´å’Œå¼€å‘äººå‘˜å¿«é€Ÿç†è§£ç³»ç»ŸçŠ¶æ€ã€‚\nå·¥å…·é€‰æ‹©ï¼š Grafanaï¼š æ”¯æŒå¤šç§æ•°æ®æºï¼ˆå¦‚ Prometheusï¼‰ã€‚ æä¾›ä¸°å¯Œçš„å›¾è¡¨ç±»å‹ï¼ˆæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾ç­‰ï¼‰ã€‚ Nightingaleï¼š æ±‡æ€»å„ä¸ªå¹³å°çš„ç›‘æ§æ•°æ®ï¼Œé›†ä¸­å±•ç¤ºã€‚ æ€»ç»“ ä¸€ä¸ªå®Œå–„çš„ç”Ÿäº§ç›‘æ§ä½“ç³»éœ€è¦æ¶µç›–åŸºç¡€è®¾æ–½ã€ä¸­é—´ä»¶ã€å®¹å™¨ä¸ç¼–æ’ã€åº”ç”¨ä¸æœåŠ¡ç­‰å¤šä¸ªå±‚é¢ï¼Œå¹¶è¾…ä»¥å‘Šè­¦å’Œå¯è§†åŒ–å·¥å…·æ¥æå‡ç›‘æ§æ•ˆæœã€‚é€šè¿‡åˆç†çš„ç›‘æ§éƒ¨ç½²å’ŒæŒç»­ä¼˜åŒ–ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡ç³»ç»Ÿçš„å¯é æ€§ã€æ€§èƒ½å’Œè¿ç»´æ•ˆç‡ï¼Œæœ€ç»ˆä¸ºä¸šåŠ¡ä¿é©¾æŠ¤èˆªã€‚\n","date":"2024-12-18T22:18:28Z","image":"https://www.ownit.top/title_pic/16.jpg","permalink":"https://www.ownit.top/p/202412182218/","title":"æ„å»ºå…¨é¢çš„ç”Ÿäº§ç›‘æ§ä½“ç³»ï¼šä»åŸºç¡€è®¾æ–½åˆ°ä¸šåŠ¡æœåŠ¡"},{"content":"ç®€ä»‹ åœ¨æ„å»º Web åº”ç”¨æ—¶ï¼Œå¤„ç†å’Œä¼ è¾“å¤§é‡æ•°æ®æ˜¯ä¸å¯é¿å…çš„ã€‚å¯¹äºéœ€è¦é«˜æ•ˆã€å¯æ‰©å±•çš„æ¶ˆæ¯å¤„ç†å’Œå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçš„åœºæ™¯ï¼Œä½¿ç”¨ RabbitMQï¼ˆä¸€ç§æµè¡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼‰ä¸ Flaskï¼ˆä¸€ä¸ªè½»é‡çº§çš„ Python Web æ¡†æ¶ï¼‰ç»“åˆï¼Œèƒ½å¤Ÿå¤§å¤§æå‡åº”ç”¨çš„æ€§èƒ½å’Œå¯é æ€§ã€‚æœ¬æ–‡å°†å¸¦ä½ é€šè¿‡ä¸€ä¸ªåŸºäº Flask å’Œ RabbitMQ çš„å®é™…åº”ç”¨æ¡ˆä¾‹ï¼Œæ·±å…¥äº†è§£å¦‚ä½•æ„å»ºä¸€ä¸ªé«˜æ•ˆçš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œå®Œæˆä»ç”Ÿæˆå‡æ•°æ®åˆ°æ¶ˆè´¹æ•°æ®çš„å…¨è¿‡ç¨‹ã€‚\nèƒŒæ™¯ æˆ‘ä»¬è¦å¼€å‘ä¸€ä¸ªç§»åŠ¨å¯è§†åŒ–å¹³å°ç›‘æ§ç³»ç»Ÿï¼Œå¹¶ä¸”è¿™äº›ä¿¡æ¯éœ€è¦è¢«å®æ—¶åˆ†ææˆ–å­˜å‚¨ã€‚é¢å¯¹è¿™æ ·çš„éœ€æ±‚ï¼Œç›´æ¥å°†æ‰€æœ‰é€»è¾‘æ”¾åœ¨å•ä¸ªåº”ç”¨ä¸­å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚å› æ­¤ï¼Œæˆ‘ä»¬è€ƒè™‘é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œé€šè¿‡åˆ†ç¦»æ•°æ®ç”Ÿæˆä¸å¤„ç†é€»è¾‘æ¥æé«˜ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå“åº”é€Ÿåº¦ã€‚\nç¯å¢ƒä»‹ç» ä¸ºäº†å®ç°è¿™ä¸ªé¡¹ç›®ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ä¸‹ç¯å¢ƒï¼š\nPythonï¼šä¸€ä¸ªå¼ºå¤§çš„ç¼–ç¨‹è¯­è¨€ï¼Œé€‚åˆå¿«é€Ÿå¼€å‘ã€‚ Flaskï¼šä¸€ä¸ªè½»é‡çº§çš„Webåº”ç”¨æ¡†æ¶ã€‚ Pikaï¼šPythonçš„RabbitMQå®¢æˆ·ç«¯åº“ã€‚ Fakerï¼šä¸€ä¸ªç”Ÿæˆä¼ªæ•°æ®çš„Pythonåº“ï¼Œç”¨äºç”Ÿæˆæµ‹è¯•æ•°æ® RabbitMQï¼šæ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œç”¨æ¥å­˜å‚¨ ç”Ÿäº§è€…äº§ç”Ÿçš„æ•°æ® æŠ€æœ¯é€‰å‹ Flaskï¼šè½»é‡çº§Webæ¡†æ¶ï¼Œéå¸¸é€‚åˆå¿«é€Ÿå¼€å‘å°å‹åˆ°ä¸­ç­‰è§„æ¨¡çš„åº”ç”¨ã€‚ RabbitMQï¼šä¸€ä¸ªå¹¿æ³›ä½¿ç”¨çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼ˆä¹Ÿç§°ä¸ºæ¶ˆæ¯ä¸­é—´ä»¶ï¼‰ï¼Œç”¨äºå®ç°åº”ç”¨ç¨‹åºä¹‹é—´çš„é€šä¿¡ã€‚ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ ç”Ÿäº§è€…ï¼šè´Ÿè´£ç”Ÿæˆæ¨¡æ‹Ÿç”¨æˆ·æ•°æ®å¹¶å°†å…¶å‘é€è‡³RabbitMQã€‚ æ¶ˆè´¹è€…ï¼šä»RabbitMQæ¥æ”¶æ•°æ®åæ‰§è¡Œç‰¹å®šä»»åŠ¡ï¼Œå¦‚æ•°æ®åˆ†ææˆ–å­˜å‚¨ã€‚ Flaskåº”ç”¨ï¼šæä¾›REST APIæ¥å£ç»™å¤–éƒ¨è°ƒç”¨ï¼ŒåŒæ—¶å¯åŠ¨æ¶ˆè´¹è€…çº¿ç¨‹ç›‘å¬RabbitMQä¸­çš„æ¶ˆæ¯ã€‚ æ­å»ºRabbitMQæœåŠ¡ æˆ‘ä»¬ä½¿ç”¨dockeræ¥æ­å»ºæœåŠ¡ï¼Œå¦‚æœwinå¯ä»¥ç›´æ¥è·‘ç¨‹åºï¼Œç›¸å…³æµç¨‹è¯·è‡ªè¡ŒæŸ¥è¯¢\nä¸´æ—¶ä½¿ç”¨ï¼ˆåœæ­¢ä¼šè‡ªåŠ¨åˆ é™¤æœåŠ¡ï¼‰\n1 docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 docker.cloudimages.asia/rabbitmq:4.0-management é•¿ä¹…ä½¿ç”¨\n1 docker run -it -d --name rabbitmq -p 5672:5672 -p 15672:15672 docker.cloudimages.asia/rabbitmq:4.0-management 1 2 [root@prometheus-server ~]# docker ps | grep 9b3a9355fa4a 9b3a9355fa4a docker.cloudimages.asia/rabbitmq:4.0-management \u0026#34;docker-entrypoint.sâ€¦\u0026#34; 21 seconds ago Up 19 seconds 4369/tcp, 5671/tcp, 0.0.0.0:5672-\u0026gt;5672/tcp, :::5672-\u0026gt;5672/tcp, 15671/tcp, 15691-15692/tcp, 25672/tcp, 0.0.0.0:15672-\u0026gt;15672/tcp, :::15672-\u0026gt;15672/tcp rabbitmq è®¿é—®é¡µé¢åœ°å€ï¼šhttp://192.168.82.105:15672/ ä½¿ç”¨ RabbitMQ çš„ç®¡ç†ç•Œé¢ã€‚ è®¿é—®è´¦å·å’Œå¯†ç ï¼š guest | guest\né˜Ÿåˆ—é¡µé¢ ç”Ÿäº§è€…ï¼šå°†æ•°æ®å‘é€åˆ° RabbitMQ é˜Ÿåˆ— ç”Ÿäº§è€…çš„ä»»åŠ¡æ˜¯ç”Ÿæˆä¸€äº›å‡æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®å‘é€åˆ° RabbitMQ é˜Ÿåˆ—ä¸­ã€‚æˆ‘ä»¬ä½¿ç”¨ Faker åº“ç”Ÿæˆæ•°æ®ï¼Œå¹¶é€šè¿‡ RabbitMQ çš„ basic_publish æ–¹æ³•å‘é€æ¶ˆæ¯ã€‚\nç¡®ä¿ä½ çš„ç¯å¢ƒä¸­å®‰è£…äº†Pythonã€‚ç„¶åï¼Œä½¿ç”¨pipå®‰è£…Flaskã€Pikaå’ŒFakerï¼š\n1 pip install flask pika faker ç”Ÿäº§è€…ä»£ç  ç”Ÿäº§è€…éƒ¨åˆ†ä¸»è¦è´Ÿè´£ç”Ÿæˆéšæœºæ•°æ®å¹¶é€šè¿‡RabbitMQå‘é€å‡ºå»ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Fakeråº“æ¥ç”Ÿæˆçœ‹èµ·æ¥çœŸå®çš„æ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 # -*- coding: utf-8 -*- # @Time : 2024/11/24 10:20 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : test.py # @Software: PyCharm from faker import Faker import pika import json import time # åˆå§‹åŒ– Faker å®ä¾‹ fake = Faker() # é…ç½® RabbitMQ è¿æ¥ connection = pika.BlockingConnection(pika.ConnectionParameters(host=\u0026#39;192.168.82.105\u0026#39;,heartbeat=60)) channel = connection.channel() # å£°æ˜ä¸€ä¸ªé˜Ÿåˆ— queue_name = \u0026#39;ownit_queue\u0026#39; channel.queue_declare(queue=queue_name) # ç”Ÿæˆå¹¶å‘é€å‡æ•°æ® def generate_fake_data(): return { \u0026#34;name\u0026#34;: fake.name(), \u0026#34;address\u0026#34;: fake.address(), \u0026#34;email\u0026#34;: fake.email(), \u0026#34;phone\u0026#34;: fake.phone_number(), \u0026#34;company\u0026#34;: fake.company(), \u0026#34;date\u0026#34;: fake.date_this_year().isoformat(), \u0026#34;text\u0026#34;: fake.text(max_nb_chars=200), } try: for _ in range(10000): # ç”Ÿæˆ 1000 æ¡å‡æ•°æ® fake_data = generate_fake_data() channel.basic_publish( exchange=\u0026#39;\u0026#39;, routing_key=queue_name, body=json.dumps(fake_data) # å°†æ•°æ®åºåˆ—åŒ–ä¸º JSON æ ¼å¼ ) # time.sleep(0.1) print(f\u0026#34;Sent: {fake_data}\u0026#34;) finally: connection.close() æ‰§è¡Œæ’å…¥10000æ¡æ•°æ® æ•°æ®æŒä¹…åŒ– é‡å¯docker æœåŠ¡ã€‚è®©mqé‡å¯\n1 docker restart 9b3a9355fa4a å› ä¸ºé‡å¯ï¼Œé˜Ÿåˆ—æ²¡æœ‰æŒä¹…åŒ–ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤± ä¸ºäº†ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œå¯ä»¥é…ç½® RabbitMQ çš„é˜Ÿåˆ—ä¸ºæŒä¹…åŒ–é˜Ÿåˆ—ï¼Œå³ä½¿ RabbitMQ å®•æœºæˆ–é‡å¯ï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¹Ÿèƒ½è¢«æ¢å¤ã€‚\n1 2 3 4 5 channel.queue_declare(queue=\u0026#39;ownit_queue\u0026#39;, durable=True) properties=pika.BasicProperties(delivery_mode=2) å’¦ï¼Œè¿˜æ˜¯æ²¡æœ‰æ•°æ®ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ å› ä¸ºä½¿ç”¨Dokcerå¯åŠ¨æ²¡æœ‰æŒä¹…æ•°æ®ï¼Œé‡å¯ä¼šä¸¢å¤±æ•°æ®ï¼Œå°±ç®—æˆ‘ä»¬mqåšæŒä¹…åŒ–ä¹Ÿä¸èµ·ä½œç”¨ã€‚ 1 docker stop 9b3a9355fa4a \u0026amp;\u0026amp; docker rm 9b3a9355fa4a æŒä¹…åŒ–å‘½ä»¤\n1 2 3 4 5 6 docker run -it -d \\ --name rabbitmq \\ -p 5672:5672 \\ -p 15672:15672 \\ -v rabbitmq_data:/var/lib/rabbitmq/mnesia \\ docker.cloudimages.asia/rabbitmq:4.0-management è§£é‡Šï¼š -it -dï¼šä»¥äº¤äº’æ¨¡å¼å¯åŠ¨å¹¶åœ¨åå°è¿è¡Œå®¹å™¨ã€‚ --name rabbitmqï¼šç»™å®¹å™¨æŒ‡å®šä¸€ä¸ªåå­— rabbitmqã€‚ -p 5672:5672ï¼šæ˜ å°„ RabbitMQ çš„é»˜è®¤ AMQP åè®®ç«¯å£ï¼ˆ5672ï¼‰åˆ°å®¿ä¸»æœºã€‚ -p 15672:15672ï¼šæ˜ å°„ RabbitMQ çš„ç®¡ç†ç•Œé¢ç«¯å£ï¼ˆ15672ï¼‰åˆ°å®¿ä¸»æœºã€‚ -v rabbitmq_data:/var/lib/rabbitmq/mnesiaï¼šå°†å®¿ä¸»æœºçš„ Docker å· rabbitmq_data æŒä¹…åŒ–åˆ°å®¹å™¨å†…çš„ /var/lib/rabbitmq/mnesia ç›®å½•ï¼Œè¿™æ˜¯ RabbitMQ é»˜è®¤å­˜å‚¨é˜Ÿåˆ—å’Œæ¶ˆæ¯æ•°æ®çš„åœ°æ–¹ã€‚ ä½¿ç”¨å®¿ä¸»æœºç›®å½• 1 2 3 4 5 6 docker run -it -d \\ --name rabbitmq \\ -p 5672:5672 \\ -p 15672:15672 \\ -v /root/rabbitmq:/var/lib/rabbitmq \\ docker.cloudimages.asia/rabbitmq:4.0-management 1 2 [root@prometheus-server ~]# docker restart 9e200cf168c3 9e200cf168c3 å…³é”®ç‚¹è§£æ Faker åº“ï¼šç”¨äºç”Ÿæˆè™šæ‹Ÿæ•°æ®ã€‚æ¯æ¬¡è°ƒç”¨ generate_fake_data å‡½æ•°æ—¶éƒ½ä¼šç”Ÿæˆä¸åŒçš„å§“åã€åœ°å€ã€é‚®ç®±ç­‰ä¿¡æ¯ã€‚ RabbitMQ è¿æ¥ï¼šæˆ‘ä»¬ä½¿ç”¨ pika åº“ä¸ RabbitMQ è¿›è¡Œè¿æ¥ï¼Œå¹¶å£°æ˜äº†ä¸€ä¸ªé˜Ÿåˆ— ownit_queueï¼Œç”¨äºå­˜å‚¨æ¶ˆæ¯ã€‚ æ•°æ®å‘å¸ƒï¼šä½¿ç”¨ channel.basic_publish() æ–¹æ³•å°†æ¶ˆæ¯å‘å¸ƒåˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆæ¯ä½“ä½¿ç”¨ json.dumps() åºåˆ—åŒ–ä¸º JSON æ ¼å¼ã€‚ æŒä¹…åŒ–å®Œæ•´ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 # -*- coding: utf-8 -*- # @Time : 2024/11/24 10:20 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : test.py # @Software: PyCharm from faker import Faker import pika import json import time # åˆå§‹åŒ– Faker å®ä¾‹ fake = Faker() # é…ç½® RabbitMQ è¿æ¥ connection = pika.BlockingConnection(pika.ConnectionParameters(host=\u0026#39;192.168.82.105\u0026#39;,heartbeat=60)) channel = connection.channel() # å£°æ˜ä¸€ä¸ªé˜Ÿåˆ— queue_name = \u0026#39;ownit_queue\u0026#39; channel.queue_declare(queue=queue_name, durable=True) # ç”Ÿæˆå¹¶å‘é€å‡æ•°æ® def generate_fake_data(): return { \u0026#34;name\u0026#34;: fake.name(), \u0026#34;address\u0026#34;: fake.address(), \u0026#34;email\u0026#34;: fake.email(), \u0026#34;phone\u0026#34;: fake.phone_number(), \u0026#34;company\u0026#34;: fake.company(), \u0026#34;date\u0026#34;: fake.date_this_year().isoformat(), \u0026#34;text\u0026#34;: fake.text(max_nb_chars=200), } try: for _ in range(1000): # ç”Ÿæˆ 1000 æ¡å‡æ•°æ® fake_data = generate_fake_data() channel.basic_publish( exchange=\u0026#39;\u0026#39;, routing_key=queue_name, body=json.dumps(fake_data), # å°†æ•°æ®åºåˆ—åŒ–ä¸º JSON æ ¼å¼ properties=pika.BasicProperties(delivery_mode=2) ) # time.sleep(0.1) print(f\u0026#34;Sent: {fake_data}\u0026#34;) finally: connection.close() æ¶ˆè´¹è€…ï¼šä» RabbitMQ ä¸­è·å–æ•°æ® æ¶ˆè´¹è€…éƒ¨åˆ†ç”±Flaskåº”ç”¨æ‰˜ç®¡ï¼Œå®ƒä¸ä»…æä¾›äº†APIæ¥å£ï¼Œè¿˜å¯åŠ¨äº†ä¸€ä¸ªåå°çº¿ç¨‹æŒç»­ç›‘å¬RabbitMQä¸Šçš„æ¶ˆæ¯ã€‚ æ¶ˆè´¹è€…çš„ä»»åŠ¡æ˜¯ä»é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†æ¨¡æ‹Ÿä¸€ä¸ªç®€å•çš„æ¶ˆæ¯æ¶ˆè´¹è¿‡ç¨‹ï¼Œæ‰“å°æ¥æ”¶åˆ°çš„æ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 import json import threading import time import pika from flask import Flask, request app = Flask(__name__) @app.route(\u0026#39;/\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) def send_order(): return \u0026#39;Hello, World! MQ\u0026#39; # æ¶ˆè´¹è€…å‡½æ•° def consume(): # åˆ›å»ºä¸ RabbitMQ æœåŠ¡å™¨çš„è¿æ¥ connection = pika.BlockingConnection(pika.ConnectionParameters(\u0026#39;192.168.82.105\u0026#39;)) # ä»è¿æ¥ä¸­åˆ›å»ºä¸€ä¸ªé€šé“ channel = connection.channel() # å£°æ˜ä¸€ä¸ªåä¸º order_queue çš„é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—ä¸å­˜åœ¨åˆ™åˆ›å»ºå®ƒ channel.queue_declare(queue=\u0026#39;ownit_queue\u0026#39;,durable=True) # å®šä¹‰ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºå¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ def callback(ch, method, properties, body): # æ‰“å°æ¥æ”¶åˆ°çš„æ¶ˆæ¯ä½“ print(f\u0026#34;æ•°æ®æ¥å—: {body}\u0026#34;) time.sleep(1) # é…ç½®é€šé“ä»¥æ¶ˆè´¹æ¥è‡ª order_queue çš„æ¶ˆæ¯ï¼ŒæŒ‡å®šå›è°ƒå‡½æ•°å¤„ç†æ¶ˆæ¯ï¼Œå¹¶è®¾ç½®è‡ªåŠ¨ç¡®è®¤æ¶ˆæ¯ channel.basic_consume(queue=\u0026#39;ownit_queue\u0026#39;, on_message_callback=callback, auto_ack=True) # æ‰“å°æ¶ˆæ¯è¡¨ç¤ºç¨‹åºæ­£åœ¨ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ï¼Œå¹¶æç¤ºç”¨æˆ·æŒ‰ CTRL+C é€€å‡º print(\u0026#39;Waiting for messages. To exit press CTRL+C\u0026#39;) # å¼€å§‹ä¸€ä¸ªå¾ªç¯ä»¥æŒç»­æ¥æ”¶æ¶ˆæ¯ channel.start_consuming() # å¯åŠ¨æ¶ˆè´¹è€…çº¿ç¨‹ def run_consumer(): thread = threading.Thread(target=consume, daemon=True) # è®¾ç½®å®ˆæŠ¤çº¿ç¨‹ thread.start() print(\u0026#34;Consumer thread started.\u0026#34;) if __name__ == \u0026#39;__main__\u0026#39;: run_consumer() app.run(debug=True) å…³é”®ç‚¹è§£æ consume() å‡½æ•°ï¼šé€šè¿‡ pika è¿æ¥ RabbitMQï¼Œå£°æ˜ ownit_queue é˜Ÿåˆ—ï¼Œå¹¶é€šè¿‡å›è°ƒå‡½æ•° callback å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚ çº¿ç¨‹åŒ–æ¶ˆè´¹ï¼šä¸ºäº†ä½¿ Flask åº”ç”¨èƒ½å¤Ÿæ­£å¸¸å¤„ç† Web è¯·æ±‚ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°†æ¶ˆæ¯æ¶ˆè´¹éƒ¨åˆ†æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œã€‚ auto_ack=Trueï¼šè‡ªåŠ¨ç¡®è®¤æ¶ˆæ¯ï¼Œè¡¨ç¤ºä¸€æ—¦æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åä¼šè‡ªåŠ¨ä»é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥æ¶ˆæ¯ã€‚ æŒç»­å‘é€æ•°æ® æ¯ç§’æ¥æ”¶1æ¡æ•°æ® æ²¡æ¶ˆè´¹çš„æ•°æ®ä¸€ç›´åœ¨MQä¸­ æ€»ç»“ ç»“åˆ Flask å’Œ RabbitMQ æ„å»ºä¸€ä¸ªé«˜æ•ˆçš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œä»å‡æ•°æ®çš„ç”Ÿæˆåˆ°æ•°æ®çš„æ¶ˆè´¹å¤„ç†ï¼Œæ•´ä¸ªè¿‡ç¨‹éƒ½å¾—åˆ°äº†è¯¦ç»†å±•ç¤ºã€‚åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æ¶µç›–äº†ä»¥ä¸‹å†…å®¹ï¼š\nRabbitMQ çš„å®‰è£…ä¸é…ç½®ï¼šäº†è§£äº†å¦‚ä½•é€šè¿‡ RabbitMQ ç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»¥åŠå¦‚ä½•ä¸ Python è¿›è¡Œäº¤äº’ã€‚ ç”Ÿäº§è€…çš„å®ç°ï¼šä½¿ç”¨ Faker åº“ç”Ÿæˆå‡æ•°æ®ï¼Œå¹¶å°†å…¶å‘å¸ƒåˆ° RabbitMQ é˜Ÿåˆ—ä¸­ã€‚é€šè¿‡ pika åº“ä¸ RabbitMQ è¿›è¡Œè¿æ¥ï¼Œç¡®ä¿æ•°æ®èƒ½å¤Ÿè¢«æˆåŠŸå‘é€åˆ°é˜Ÿåˆ—ä¸­ã€‚ æ¶ˆè´¹è€…çš„å®ç°ï¼šé€šè¿‡ Flask å¯åŠ¨ä¸€ä¸ªç‹¬ç«‹çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œä» RabbitMQ é˜Ÿåˆ—ä¸­è·å–æ•°æ®å¹¶è¿›è¡Œå¤„ç†ã€‚æˆ‘ä»¬è¿˜è®¨è®ºäº†å¦‚ä½•åœ¨ Flask åº”ç”¨ä¸­åµŒå…¥å¤šçº¿ç¨‹æ“ä½œï¼Œä¿è¯ Web åº”ç”¨çš„å“åº”æ€§å’Œæ¶ˆæ¯å¤„ç†çš„é«˜æ•ˆæ€§ã€‚ æ¶ˆæ¯ç¡®è®¤å’ŒæŒä¹…åŒ–ï¼šæˆ‘ä»¬è®¨è®ºäº†æ¶ˆæ¯çš„æŒä¹…åŒ–å’Œç¡®è®¤æœºåˆ¶ï¼Œè¿™å¯¹äºç”Ÿäº§ç¯å¢ƒä¸­çš„é«˜å¯ç”¨æ€§å’Œæ•°æ®å®‰å…¨æ€§è‡³å…³é‡è¦ã€‚ ","date":"2024-11-27T14:27:58Z","image":"https://www.ownit.top/title_pic/03.jpg","permalink":"https://www.ownit.top/p/202411271427/","title":"åŸºäº Flask å’Œ RabbitMQ æ„å»ºé«˜æ•ˆæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼šä»æ•°æ®ç”Ÿæˆåˆ°æ¶ˆè´¹"},{"content":"ç®€ä»‹ è¯·å‚è€ƒä¸‹æ–¹ï¼Œå­¦ä¹ å…¥é—¨æ“ä½œ\nåŸºäº Flask å’Œ Socket.IO çš„ WebSocket å®æ—¶æ•°æ®æ›´æ–°å®ç°\nåœ¨å½“ä»Šæ•°å­—åŒ–æ—¶ä»£ï¼Œå®æ—¶æ€§æ˜¯è¡¡é‡äº’è”ç½‘åº”ç”¨çš„é‡è¦æŒ‡æ ‡ä¹‹ä¸€ã€‚æ— è®ºæ˜¯è‚¡ç¥¨äº¤æ˜“ã€åœ¨çº¿æ¸¸æˆï¼Œè¿˜æ˜¯å®æ—¶ç›‘æ§å¤§å±ï¼ŒWebSocket å·²æˆä¸ºå®ç°é«˜æ•ˆã€åŒå‘å®æ—¶é€šä¿¡çš„æœ€ä½³é€‰æ‹©ä¹‹ä¸€ã€‚æœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªåŸºäº WebSocket å®ç°çš„å®æ—¶æ•°æ®å¤§å±æ¡ˆä¾‹ï¼Œæ·±å…¥æ¢è®¨ WebSocket çš„é«˜çº§ç”¨æ³•å’Œä¼˜åŒ–æŠ€å·§ã€‚\nWebSocket çš„å…¸å‹åº”ç”¨åœºæ™¯ å®æ—¶æ•°æ®ç›‘æ§ï¼šå¦‚è¿è¥ç›‘æ§å¤§å±ã€è®¾å¤‡çŠ¶æ€ç›‘æ§ç­‰ã€‚ åœ¨çº¿åä½œï¼šå¦‚ Google Docs çš„å¤šäººç¼–è¾‘ã€‚ å®æ—¶èŠå¤©ï¼šå¦‚å³æ—¶é€šè®¯å·¥å…·ã€‚ å®æ—¶é€šçŸ¥ï¼šå¦‚ç”µå•†çš„ä»·æ ¼å˜åŠ¨æé†’ã€‚ åœºæ™¯åˆ†æï¼šå®æ—¶æ•°æ®ç›‘æ§å¤§å± æœ¬æ¡ˆä¾‹çš„ç›®æ ‡æ˜¯å®ç°ä¸€ä¸ªå®æ—¶æ•°æ®ç›‘æ§å¤§å±ï¼Œé€šè¿‡ WebSocket æŠ€æœ¯ï¼Œå°†å®æ—¶æ›´æ–°çš„æ•°æ®åŠ¨æ€å±•ç¤ºåœ¨ç”¨æˆ·ç•Œé¢ä¸­ã€‚\néœ€æ±‚åˆ†æ å®ç°ä¸åŒæˆ¿é—´çš„æ•°æ®è®¢é˜…ï¼ˆå¦‚é”€å”®æ•°æ®å’Œè®¿é—®æ•°æ®ï¼‰ã€‚ æ”¯æŒå¤šå®¢æˆ·ç«¯å®æ—¶æ¥æ”¶æœåŠ¡å™¨æ¨é€çš„æœ€æ–°æ•°æ®ã€‚ åŠ¨æ€æ›´æ–°ç•Œé¢ï¼Œæä¾›æµç•…çš„ç”¨æˆ·ä½“éªŒã€‚ æŠ€æœ¯é€‰å‹ å‰ç«¯ï¼šHTMLã€CSSã€JavaScript ä½¿ç”¨ Socket.IO å®¢æˆ·ç«¯åº“ã€‚ åç«¯ï¼šåŸºäº Flask å’Œ Flask-SocketIO å®ç° WebSocket æœåŠ¡ã€‚ å®æ—¶æ•°æ®ç”Ÿæˆï¼šä½¿ç”¨ Python çš„ random æ¨¡å—æ¨¡æ‹Ÿå®æ—¶æ•°æ®ã€‚ åç«¯å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 from flask import Flask, render_template, request from flask_socketio import SocketIO, emit, join_room, leave_room import random import time from threading import Thread app = Flask(__name__) app.config[\u0026#39;SECRET_KEY\u0026#39;] = \u0026#39;secret!\u0026#39; socketio = SocketIO(app) # å­˜å‚¨å®¢æˆ·ç«¯è®¢é˜…çš„æˆ¿é—´ä¿¡æ¯ client_rooms = {} # å­˜å‚¨æ•°æ®ç”Ÿæˆå™¨çº¿ç¨‹ data_threads = {} def generate_sales_data(room): \u0026#34;\u0026#34;\u0026#34;ç”Ÿæˆé”€å”®ç›¸å…³æ•°æ®\u0026#34;\u0026#34;\u0026#34; while room in data_threads and data_threads[room][\u0026#39;active\u0026#39;]: data = { \u0026#39;sales\u0026#39;: random.randint(1000, 5000), \u0026#39;orders\u0026#39;: random.randint(50, 200), \u0026#39;timestamp\u0026#39;: time.strftime(\u0026#39;%H:%M:%S\u0026#39;) } socketio.emit(\u0026#39;update_data\u0026#39;, data, room=room) time.sleep(2) def generate_visitor_data(room): \u0026#34;\u0026#34;\u0026#34;ç”Ÿæˆè®¿é—®é‡ç›¸å…³æ•°æ®\u0026#34;\u0026#34;\u0026#34; while room in data_threads and data_threads[room][\u0026#39;active\u0026#39;]: data = { \u0026#39;visitors\u0026#39;: random.randint(100, 1000), \u0026#39;active_users\u0026#39;: random.randint(50, 300), \u0026#39;timestamp\u0026#39;: time.strftime(\u0026#39;%H:%M:%S\u0026#39;) } socketio.emit(\u0026#39;update_data\u0026#39;, data, room=room) time.sleep(3) @app.route(\u0026#39;/\u0026#39;) def index(): return render_template(\u0026#39;index.html\u0026#39;) @socketio.on(\u0026#39;join\u0026#39;) def on_join(data): \u0026#34;\u0026#34;\u0026#34;å¤„ç†å®¢æˆ·ç«¯åŠ å…¥æˆ¿é—´è¯·æ±‚\u0026#34;\u0026#34;\u0026#34; room = data.get(\u0026#39;room\u0026#39;) if not room: return # è·å–å®¢æˆ·ç«¯ID client_id = request.sid # å°†å®¢æˆ·ç«¯åŠ å…¥æˆ¿é—´ join_room(room) client_rooms[client_id] = room print(f\u0026#39;Client {client_id} joined room: {room}\u0026#39;) # å¦‚æœæˆ¿é—´æ²¡æœ‰æ•°æ®ç”Ÿæˆå™¨çº¿ç¨‹ï¼Œåˆ›å»ºä¸€ä¸ª if room not in data_threads: data_threads[room] = { \u0026#39;active\u0026#39;: True, \u0026#39;thread\u0026#39;: Thread( target=generate_sales_data if room == \u0026#39;sales\u0026#39; else generate_visitor_data, args=(room,), daemon=True ) } data_threads[room][\u0026#39;thread\u0026#39;].start() @socketio.on(\u0026#39;leave\u0026#39;) def on_leave(data): \u0026#34;\u0026#34;\u0026#34;å¤„ç†å®¢æˆ·ç«¯ç¦»å¼€æˆ¿é—´è¯·æ±‚\u0026#34;\u0026#34;\u0026#34; room = data.get(\u0026#39;room\u0026#39;) if not room: return client_id = request.sid leave_room(room) if client_id in client_rooms: del client_rooms[client_id] print(f\u0026#39;Client {client_id} left room: {room}\u0026#39;) @socketio.on(\u0026#39;connect\u0026#39;) def handle_connect(): print(f\u0026#39;Client connected: {request.sid}\u0026#39;) @socketio.on(\u0026#39;disconnect\u0026#39;) def handle_disconnect(): client_id = request.sid if client_id in client_rooms: room = client_rooms[client_id] leave_room(room) del client_rooms[client_id] # æ£€æŸ¥æˆ¿é—´æ˜¯å¦è¿˜æœ‰å…¶ä»–å®¢æˆ·ç«¯ if not client_rooms.values().__contains__(room): # å¦‚æœæ²¡æœ‰ï¼Œåœæ­¢æ•°æ®ç”Ÿæˆå™¨ if room in data_threads: data_threads[room][\u0026#39;active\u0026#39;] = False data_threads[room][\u0026#39;thread\u0026#39;].join(timeout=1) del data_threads[room] print(f\u0026#39;Client disconnected: {client_id}\u0026#39;) if __name__ == \u0026#39;__main__\u0026#39;: socketio.run(app, debug=True, host=\u0026#39;0.0.0.0\u0026#39;, port=5000) æ•°æ®ç”Ÿæˆä¸æ¨é€ åç«¯çš„æ ¸å¿ƒé€»è¾‘æ˜¯æ•°æ®ç”Ÿæˆä¸æ¨é€ï¼š\næ•°æ®ç”Ÿæˆï¼šé€šè¿‡ generate_sales_data å’Œ generate_visitor_data å‡½æ•°ç”Ÿæˆéšæœºæ•°æ®ï¼Œå¹¶å®šæ—¶æ¨é€åˆ°å®¢æˆ·ç«¯ã€‚ æˆ¿é—´ç®¡ç†ï¼šé€šè¿‡ join_room å’Œ leave_room æ–¹æ³•ç®¡ç†å®¢æˆ·ç«¯çš„æˆ¿é—´è®¢é˜…ã€‚ çº¿ç¨‹ç®¡ç†ï¼šä½¿ç”¨çº¿ç¨‹æ¥ç”Ÿæˆæ•°æ®ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯ç¦»å¼€æˆ¿é—´æ—¶åœæ­¢çº¿ç¨‹ã€‚ HTML ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;zh\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; \u0026lt;title\u0026gt;å®æ—¶æ•°æ®å¤§å±\u0026lt;/title\u0026gt; \u0026lt;script src=\u0026#34;https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;style\u0026gt; body { margin: 0; padding: 20px; background-color: #1a1a1a; color: #fff; font-family: Arial, sans-serif; } .controls { text-align: center; margin-bottom: 30px; } .btn { background-color: #4CAF50; border: none; color: white; padding: 10px 20px; margin: 0 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; } .btn:hover { background-color: #45a049; } .btn.active { background-color: #2E7D32; } .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; } .card { background-color: #2a2a2a; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); } .card h2 { margin: 0 0 10px 0; color: #4CAF50; } .value { font-size: 2.5em; font-weight: bold; margin: 10px 0; } .timestamp { text-align: right; color: #888; margin-top: 20px; } @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } } .update { animation: pulse 0.5s ease-in-out; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1 style=\u0026#34;text-align: center; margin-bottom: 40px;\u0026#34;\u0026gt;å®æ—¶æ•°æ®ç›‘æ§\u0026lt;/h1\u0026gt; \u0026lt;div class=\u0026#34;controls\u0026#34;\u0026gt; \u0026lt;button class=\u0026#34;btn\u0026#34; onclick=\u0026#34;toggleRoom(\u0026#39;sales\u0026#39;)\u0026#34; id=\u0026#34;salesBtn\u0026#34;\u0026gt;é”€å”®æ•°æ®\u0026lt;/button\u0026gt; \u0026lt;button class=\u0026#34;btn\u0026#34; onclick=\u0026#34;toggleRoom(\u0026#39;visitors\u0026#39;)\u0026#34; id=\u0026#34;visitorsBtn\u0026#34;\u0026gt;è®¿é—®æ•°æ®\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;dashboard\u0026#34;\u0026gt; \u0026lt;!-- é”€å”®æ•°æ®å¡ç‰‡ --\u0026gt; \u0026lt;div class=\u0026#34;card\u0026#34; id=\u0026#34;salesCard\u0026#34; style=\u0026#34;display: none;\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;é”€å”®é¢\u0026lt;/h2\u0026gt; \u0026lt;div id=\u0026#34;sales\u0026#34; class=\u0026#34;value\u0026#34;\u0026gt;0\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;å®æ—¶é”€å”®é‡‘é¢ (å…ƒ)\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;card\u0026#34; id=\u0026#34;ordersCard\u0026#34; style=\u0026#34;display: none;\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;è®¢å•æ•°\u0026lt;/h2\u0026gt; \u0026lt;div id=\u0026#34;orders\u0026#34; class=\u0026#34;value\u0026#34;\u0026gt;0\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;å®æ—¶è®¢å•ç»Ÿè®¡\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;!-- è®¿é—®æ•°æ®å¡ç‰‡ --\u0026gt; \u0026lt;div class=\u0026#34;card\u0026#34; id=\u0026#34;visitorsCard\u0026#34; style=\u0026#34;display: none;\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;è®¿é—®é‡\u0026lt;/h2\u0026gt; \u0026lt;div id=\u0026#34;visitors\u0026#34; class=\u0026#34;value\u0026#34;\u0026gt;0\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;å½“å‰è®¿é—®äººæ•°\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;card\u0026#34; id=\u0026#34;activeUsersCard\u0026#34; style=\u0026#34;display: none;\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;æ´»è·ƒç”¨æˆ·\u0026lt;/h2\u0026gt; \u0026lt;div id=\u0026#34;active_users\u0026#34; class=\u0026#34;value\u0026#34;\u0026gt;0\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;å®æ—¶æ´»è·ƒç”¨æˆ·æ•°\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;timestamp\u0026#34; id=\u0026#34;timestamp\u0026#34;\u0026gt;æœ€åæ›´æ–°æ—¶é—´: --:--:--\u0026lt;/div\u0026gt; \u0026lt;script\u0026gt; const socket = io(); let currentRooms = new Set(); // æ›´æ–°æ•°æ®çš„å‡½æ•° function updateValue(elementId, value) { const element = document.getElementById(elementId); if (element) { element.textContent = value; element.classList.remove(\u0026#39;update\u0026#39;); void element.offsetWidth; // è§¦å‘é‡ç»˜ element.classList.add(\u0026#39;update\u0026#39;); } } // åˆ‡æ¢æˆ¿é—´ function toggleRoom(room) { const btn = document.getElementById(room + \u0026#39;Btn\u0026#39;); if (currentRooms.has(room)) { // ç¦»å¼€æˆ¿é—´ socket.emit(\u0026#39;leave\u0026#39;, { room: room }); currentRooms.delete(room); btn.classList.remove(\u0026#39;active\u0026#39;); // éšè—ç›¸å…³å¡ç‰‡ if (room === \u0026#39;sales\u0026#39;) { document.getElementById(\u0026#39;salesCard\u0026#39;).style.display = \u0026#39;none\u0026#39;; document.getElementById(\u0026#39;ordersCard\u0026#39;).style.display = \u0026#39;none\u0026#39;; } else { document.getElementById(\u0026#39;visitorsCard\u0026#39;).style.display = \u0026#39;none\u0026#39;; document.getElementById(\u0026#39;activeUsersCard\u0026#39;).style.display = \u0026#39;none\u0026#39;; } } else { // åŠ å…¥æˆ¿é—´ socket.emit(\u0026#39;join\u0026#39;, { room: room }); currentRooms.add(room); btn.classList.add(\u0026#39;active\u0026#39;); // æ˜¾ç¤ºç›¸å…³å¡ç‰‡ if (room === \u0026#39;sales\u0026#39;) { document.getElementById(\u0026#39;salesCard\u0026#39;).style.display = \u0026#39;block\u0026#39;; document.getElementById(\u0026#39;ordersCard\u0026#39;).style.display = \u0026#39;block\u0026#39;; } else { document.getElementById(\u0026#39;visitorsCard\u0026#39;).style.display = \u0026#39;block\u0026#39;; document.getElementById(\u0026#39;activeUsersCard\u0026#39;).style.display = \u0026#39;block\u0026#39;; } } } // ç›‘å¬æ•°æ®æ›´æ–°äº‹ä»¶ socket.on(\u0026#39;update_data\u0026#39;, function(data) { // æ›´æ–°æ‰€æœ‰æ”¶åˆ°çš„æ•°æ® Object.keys(data).forEach(key =\u0026gt; { if (key !== \u0026#39;timestamp\u0026#39;) { updateValue(key, data[key]); } }); document.getElementById(\u0026#39;timestamp\u0026#39;).textContent = \u0026#39;æœ€åæ›´æ–°æ—¶é—´: \u0026#39; + data.timestamp; }); // è¿æ¥æ—¶è‡ªåŠ¨åŠ å…¥é”€å”®æ•°æ®æˆ¿é—´ socket.on(\u0026#39;connect\u0026#39;, function() { toggleRoom(\u0026#39;sales\u0026#39;); }); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; JavaScript é€»è¾‘ åœ¨å‰ç«¯ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Socket.IO å®¢æˆ·ç«¯åº“æ¥ä¸æœåŠ¡å™¨è¿›è¡Œ WebSocket é€šä¿¡ã€‚ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š\nè¿æ¥æœåŠ¡å™¨ï¼šé€šè¿‡ io() æ–¹æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚ åˆ‡æ¢æˆ¿é—´ï¼šç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œé€šè¿‡ toggleRoom å‡½æ•°åˆ‡æ¢ä¸åŒçš„æ•°æ®æˆ¿é—´ã€‚ æ›´æ–°æ•°æ®ï¼šç›‘å¬ update_data äº‹ä»¶ï¼Œæ›´æ–°é¡µé¢ä¸Šçš„æ•°æ®ã€‚ WebSocket çš„é«˜çº§å®è·µä¸ä¼˜åŒ– åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½éœ€è¦ç®¡ç†å¤šä¸ªæˆ¿é—´ï¼Œæ¯ä¸ªæˆ¿é—´å¯¹åº”ä¸åŒçš„æ•°æ®ç±»å‹æˆ–ç”¨æˆ·ç»„ã€‚é€šè¿‡ join_room å’Œ leave_room æ–¹æ³•ï¼Œå¯ä»¥è½»æ¾å®ç°å¤šæˆ¿é—´ç®¡ç†ã€‚\næ•°æ®å‹ç¼©ä¸ä¼˜åŒ– å¯¹äºå¤§è§„æ¨¡æ•°æ®ä¼ è¾“ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ•°æ®å‹ç¼©æŠ€æœ¯æ¥å‡å°‘å¸¦å®½å ç”¨ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ gzip æˆ– brotli å‹ç¼©æ•°æ®åŒ…ï¼Œæˆ–è€…åœ¨å‰ç«¯è¿›è¡Œæ•°æ®è§£å‹ç¼©ã€‚\næ–­çº¿é‡è¿ä¸å¿ƒè·³æœºåˆ¶ WebSocket è¿æ¥å¯èƒ½ä¼šå› ä¸ºç½‘ç»œé—®é¢˜è€Œæ–­å¼€ã€‚ä¸ºäº†ä¿è¯è¿æ¥çš„ç¨³å®šæ€§ï¼Œå¯ä»¥å®ç°æ–­çº¿é‡è¿æœºåˆ¶å’Œå¿ƒè·³åŒ…æ£€æµ‹ã€‚é€šè¿‡å®šæ—¶å‘é€å¿ƒè·³åŒ…ï¼Œå¯ä»¥åŠæ—¶æ£€æµ‹è¿æ¥çŠ¶æ€ï¼Œå¹¶åœ¨æ–­çº¿æ—¶è‡ªåŠ¨é‡è¿ã€‚\nå®‰å…¨æ€§ä¸æƒé™æ§åˆ¶ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå®‰å…¨æ€§æ˜¯ä¸€ä¸ªä¸å¯å¿½è§†çš„é—®é¢˜ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¢å¼º WebSocket è¿æ¥çš„å®‰å…¨æ€§ï¼š\nä½¿ç”¨ HTTPSï¼šç¡®ä¿ WebSocket è¿æ¥é€šè¿‡åŠ å¯†çš„ HTTPS åè®®è¿›è¡Œã€‚ èº«ä»½éªŒè¯ï¼šåœ¨è¿æ¥å»ºç«‹æ—¶è¿›è¡Œèº«ä»½éªŒè¯ï¼Œç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·æ‰èƒ½è®¿é—®æ•°æ®ã€‚ æƒé™æ§åˆ¶ï¼šæ ¹æ®ç”¨æˆ·è§’è‰²æ§åˆ¶å…¶è®¿é—®çš„æˆ¿é—´å’Œæ•°æ®ç±»å‹ã€‚ æ‰©å±•ä¸å®šåˆ¶ WebSocket çš„åº”ç”¨åœºæ™¯éå¸¸å¹¿æ³›ï¼Œå¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚è¿›è¡Œæ‰©å±•å’Œå®šåˆ¶ã€‚ä¾‹å¦‚ï¼Œç»“åˆ WebRTC å®ç°å®æ—¶éŸ³è§†é¢‘é€šä¿¡ï¼Œæˆ–è€…ç»“åˆ WebGL å®ç°å®æ—¶3Dæ•°æ®å¯è§†åŒ–ã€‚\n","date":"2024-11-25T11:39:51Z","image":"https://www.ownit.top/title_pic/39.jpg","permalink":"https://www.ownit.top/p/202411251139/","title":"æ·±å…¥æµ…å‡º WebSocketï¼šæ„å»ºå®æ—¶æ•°æ®å¤§å±çš„é«˜çº§å®è·µ"},{"content":"ç®€ä»‹ éšç€ç°ä»£åŒ–åº”ç”¨çš„å¿«é€Ÿå‘å±•ï¼Œå®æ—¶æ•°æ®äº¤äº’å·²ç»æˆä¸ºè®¸å¤š Web åº”ç”¨çš„æ ¸å¿ƒéœ€æ±‚ï¼Œæ¯”å¦‚å®æ—¶æ¶ˆæ¯æ¨é€ã€æ•°æ®ç›‘æ§å¤§å±ç­‰ã€‚æœ¬æ–‡å°†åŸºäºä¸€ä¸ªå®Œæ•´çš„ WebSocket å®ç°ç¤ºä¾‹ï¼Œå¸¦ä½ ä¸€æ­¥æ­¥ç†è§£å¦‚ä½•ä½¿ç”¨ Flask å’Œ Socket.IO æ„å»ºå®æ—¶æ•°æ®æ›´æ–°çš„ Web åº”ç”¨ã€‚ å°†å®ç°ä¸€ä¸ªå®æ—¶æ•°æ®ç›‘æ§å¤§å±ï¼Œæ•°æ®ä¼šé€šè¿‡åå°è‡ªåŠ¨ç”Ÿæˆï¼Œå¹¶ä»¥ WebSocket çš„æ–¹å¼å®æ—¶æ¨é€åˆ°å‰ç«¯é¡µé¢è¿›è¡Œå±•ç¤º\nèƒŒæ™¯ ä¸ºä»€ä¹ˆé€‰æ‹© WebSocketï¼Ÿ ä¼ ç»Ÿçš„ HTTP åè®®æ˜¯æ— çŠ¶æ€çš„ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„äº¤äº’é€šå¸¸æ˜¯åŸºäºè¯·æ±‚-å“åº”æ¨¡å¼ã€‚å¦‚æœéœ€è¦å®æ—¶æ›´æ–°æ•°æ®ï¼Œæ¯”å¦‚å±•ç¤ºé”€å”®é¢ã€è®¿é—®é‡ç­‰ç»Ÿè®¡ä¿¡æ¯ï¼Œé‚£ä¹ˆé€šå¸¸éœ€è¦å®¢æˆ·ç«¯å®šæ—¶å‘æœåŠ¡ç«¯å‘èµ·è½®è¯¢è¯·æ±‚ã€‚ä½†è¿™ç§æ–¹å¼æœ‰æ˜æ˜¾çš„ç¼ºç‚¹ï¼š\næ•ˆç‡ä½ä¸‹ï¼šè½®è¯¢ä¼šæ¶ˆè€—å¤§é‡çš„èµ„æºï¼Œå› ä¸ºå¤§å¤šæ•°æƒ…å†µä¸‹æ•°æ®å¹¶æœªæ”¹å˜ï¼Œä½†è½®è¯¢ä»ç„¶ä¼šå ç”¨å¸¦å®½å’Œè®¡ç®—èµ„æºã€‚ å»¶è¿Ÿè¾ƒé«˜ï¼šæ— æ³•è¾¾åˆ°æ¯«ç§’çº§çš„å®æ—¶æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜é¢‘åœºæ™¯ä¸­ï¼Œæ•°æ®æ›´æ–°çš„å»¶è¿Ÿå¯èƒ½å¯¼è‡´ç”¨æˆ·ä½“éªŒä¸‹é™ã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼ŒWebSocket æ˜¯ä¸€ç§æŒä¹…åŒ–çš„åŒå‘é€šä¿¡åè®®ï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å»ºç«‹å…¨åŒå·¥è¿æ¥ï¼Œèƒ½å¤Ÿæ›´é«˜æ•ˆåœ°å®ç°å®æ—¶æ•°æ®çš„åŒå‘ä¼ è¾“ã€‚è¿™ä½¿å¾— WebSocket æˆä¸ºå®æ—¶åº”ç”¨çš„é¦–é€‰æŠ€æœ¯ã€‚\né¡¹ç›®å®ç°çš„æ ¸å¿ƒåŠŸèƒ½ æœåŠ¡ç«¯ï¼š\nä½¿ç”¨ Flask æ¡†æ¶å’Œ Flask-SocketIO å®ç° WebSocket åè®®ã€‚ åå°è‡ªåŠ¨ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼ˆå¦‚é”€å”®é¢ã€è®¿é—®é‡ã€è®¢å•æ•°ç­‰ï¼‰ã€‚ å°†ç”Ÿæˆçš„æ•°æ®é€šè¿‡ WebSocket å®æ—¶æ¨é€åˆ°å®¢æˆ·ç«¯ã€‚ å®¢æˆ·ç«¯ï¼š\né€šè¿‡ Socket.IO å®¢æˆ·ç«¯æ¥æ”¶æœåŠ¡ç«¯æ¨é€çš„æ•°æ®ã€‚ åŠ¨æ€æ›´æ–°é¡µé¢å†…å®¹å¹¶å±•ç¤ºå®æ—¶å˜åŒ–ã€‚ æä¾›ç¾è§‚çš„å‰ç«¯ç•Œé¢ï¼Œæ¨¡æ‹Ÿæ•°æ®ç›‘æ§å¤§å±çš„æ•ˆæœã€‚ ç¯å¢ƒå‡†å¤‡ åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä½ çš„å¼€å‘ç¯å¢ƒä¸­å®‰è£…äº†ä»¥ä¸‹å·¥å…·ï¼š\nPython 3.x Flask Flask-SocketIO ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ç›¸å…³ä¾èµ–åº“ï¼š\n1 pip install flask flask-socketio æœåŠ¡ç«¯å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 from flask import Flask, render_template from flask_socketio import SocketIO, emit import random import time from threading import Thread # åˆ›å»º Flask åº”ç”¨ app = Flask(__name__) app.config[\u0026#39;SECRET_KEY\u0026#39;] = \u0026#39;secret!\u0026#39; socketio = SocketIO(app) # æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå‡½æ•° def generate_random_data(): \u0026#34;\u0026#34;\u0026#34;åå°çº¿ç¨‹ï¼šç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®å¹¶æ¨é€åˆ°å®¢æˆ·ç«¯\u0026#34;\u0026#34;\u0026#34; while True: # ç”Ÿæˆéšæœºæ•°æ® data = { \u0026#39;sales\u0026#39;: random.randint(1000, 5000), # é”€å”®é¢ \u0026#39;visitors\u0026#39;: random.randint(100, 1000), # è®¿é—®é‡ \u0026#39;orders\u0026#39;: random.randint(50, 200), # è®¢å•æ•° \u0026#39;timestamp\u0026#39;: time.strftime(\u0026#39;%H:%M:%S\u0026#39;) # å½“å‰æ—¶é—´ } # æ¨é€æ•°æ®åˆ°å®¢æˆ·ç«¯ socketio.emit(\u0026#39;update_data\u0026#39;, data) time.sleep(2) # æ¯ 2 ç§’ç”Ÿæˆä¸€æ¬¡æ•°æ® # é¦–é¡µè·¯ç”± @app.route(\u0026#39;/\u0026#39;) def index(): return render_template(\u0026#39;index.html\u0026#39;) # WebSocket äº‹ä»¶ï¼šå®¢æˆ·ç«¯è¿æ¥ @socketio.on(\u0026#39;connect\u0026#39;) def handle_connect(): print(\u0026#39;Client connected\u0026#39;) emit(\u0026#39;server_response\u0026#39;, {\u0026#39;data\u0026#39;: \u0026#39;Connected to server!\u0026#39;}) # WebSocket äº‹ä»¶ï¼šå®¢æˆ·ç«¯æ–­å¼€è¿æ¥ @socketio.on(\u0026#39;disconnect\u0026#39;) def handle_disconnect(): print(\u0026#39;Client disconnected\u0026#39;) # WebSocket äº‹ä»¶ï¼šæ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯ @socketio.on(\u0026#39;client_message\u0026#39;) def handle_message(message): print(\u0026#39;Received message:\u0026#39;, message) # å°†å®¢æˆ·ç«¯æ¶ˆæ¯å¹¿æ’­ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ emit(\u0026#39;server_response\u0026#39;, {\u0026#39;data\u0026#39;: message[\u0026#39;data\u0026#39;]}, broadcast=True) # ä¸»å‡½æ•°ï¼šå¯åŠ¨åº”ç”¨ if __name__ == \u0026#39;__main__\u0026#39;: # å¯åŠ¨åå°çº¿ç¨‹ Thread(target=generate_random_data, daemon=True).start() # å¯åŠ¨ Flask-SocketIO æœåŠ¡ socketio.run(app, debug=True, host=\u0026#39;0.0.0.0\u0026#39;, port=5000) æœåŠ¡ç«¯ä»£ç è§£æ Flask-SocketIO çš„ä½¿ç”¨ï¼š Flask-SocketIO æ˜¯åŸºäº Flask çš„æ‰©å±•åº“ï¼Œæ”¯æŒ WebSocket åè®®ï¼Œå¯ä»¥è½»æ¾å®ç°å®æ—¶é€šä¿¡ã€‚\n1 socketio = SocketIO(app) åå°æ•°æ®ç”Ÿæˆçº¿ç¨‹ï¼š ä½¿ç”¨ Python çš„ Thread æ¨¡å—åœ¨åå°ä¸æ–­ç”Ÿæˆéšæœºæ•°æ®å¹¶é€šè¿‡ socketio.emit æ–¹æ³•æ¨é€åˆ°å®¢æˆ·ç«¯ã€‚\n1 Thread(target=generate_random_data, daemon=True).start() WebSocket äº‹ä»¶ç›‘å¬ï¼š\n@socketio.on('connect')ï¼šå½“å®¢æˆ·ç«¯è¿æ¥æ—¶è§¦å‘ã€‚ @socketio.on('disconnect')ï¼šå½“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶è§¦å‘ã€‚ @socketio.on('client_message')ï¼šç›‘å¬å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œå¹¶å°†å…¶å¹¿æ’­ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ã€‚ å‰ç«¯å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;zh\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; \u0026lt;title\u0026gt;å®æ—¶æ•°æ®å¤§å±\u0026lt;/title\u0026gt; \u0026lt;script src=\u0026#34;https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;style\u0026gt; body { margin: 0; padding: 20px; background-color: #1a1a1a; color: #fff; font-family: Arial, sans-serif; } .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 1200px; margin: 0 auto; } .card { background-color: #2a2a2a; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); } .card h2 { margin: 0 0 10px 0; color: #4CAF50; } .value { font-size: 2.5em; font-weight: bold; margin: 10px 0; } .timestamp { text-align: right; color: #888; margin-top: 20px; } @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } } .update { animation: pulse 0.5s ease-in-out; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1 style=\u0026#34;text-align: center; margin-bottom: 40px;\u0026#34;\u0026gt;å®æ—¶æ•°æ®ç›‘æ§\u0026lt;/h1\u0026gt; \u0026lt;div class=\u0026#34;dashboard\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;card\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;é”€å”®é¢\u0026lt;/h2\u0026gt; \u0026lt;div id=\u0026#34;sales\u0026#34; class=\u0026#34;value\u0026#34;\u0026gt;0\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;å®æ—¶é”€å”®é‡‘é¢ (å…ƒ)\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;card\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;è®¿é—®é‡\u0026lt;/h2\u0026gt; \u0026lt;div id=\u0026#34;visitors\u0026#34; class=\u0026#34;value\u0026#34;\u0026gt;0\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;å½“å‰è®¿é—®äººæ•°\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;card\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;è®¢å•æ•°\u0026lt;/h2\u0026gt; \u0026lt;div id=\u0026#34;orders\u0026#34; class=\u0026#34;value\u0026#34;\u0026gt;0\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;å®æ—¶è®¢å•ç»Ÿè®¡\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;timestamp\u0026#34; id=\u0026#34;timestamp\u0026#34;\u0026gt;æœ€åæ›´æ–°æ—¶é—´: --:--:--\u0026lt;/div\u0026gt; \u0026lt;script\u0026gt; const socket = io(); // æ›´æ–°æ•°æ®çš„å‡½æ•° function updateValue(elementId, value) { const element = document.getElementById(elementId); element.textContent = value; element.classList.remove(\u0026#39;update\u0026#39;); void element.offsetWidth; // è§¦å‘é‡ç»˜ element.classList.add(\u0026#39;update\u0026#39;); } // ç›‘å¬æ•°æ®æ›´æ–°äº‹ä»¶ socket.on(\u0026#39;update_data\u0026#39;, function(data) { updateValue(\u0026#39;sales\u0026#39;, data.sales); updateValue(\u0026#39;visitors\u0026#39;, data.visitors); updateValue(\u0026#39;orders\u0026#39;, data.orders); document.getElementById(\u0026#39;timestamp\u0026#39;).textContent = \u0026#39;æœ€åæ›´æ–°æ—¶é—´: \u0026#39; + data.timestamp; }); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; å‰ç«¯ä»£ç è§£æ å¼•å…¥ Socket.IO å®¢æˆ·ç«¯åº“ï¼š å¼•å…¥ Socket.IO å®¢æˆ·ç«¯åº“ï¼Œç”¨äºä¸æœåŠ¡ç«¯å»ºç«‹ WebSocket è¿æ¥ã€‚\n1 \u0026lt;script src=\u0026#34;https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; åŠ¨æ€æ›´æ–°æ•°æ®çš„å®ç°ï¼š å‰ç«¯ JavaScript ä»£ç é€šè¿‡ç›‘å¬ update_data äº‹ä»¶æ¥è·å–æœåŠ¡ç«¯æ¨é€çš„æ•°æ®ï¼Œç„¶åæ›´æ–°å¯¹åº”çš„ HTML å…ƒç´ å†…å®¹ï¼Œå¹¶é€šè¿‡ CSS åŠ¨ç”»å¢åŠ è§†è§‰æ•ˆæœã€‚\n1 2 3 4 5 6 socket.on(\u0026#39;update_data\u0026#39;, function(data) { updateValue(\u0026#39;sales\u0026#39;, data.sales); updateValue(\u0026#39;visitors\u0026#39;, data.visitors); updateValue(\u0026#39;orders\u0026#39;, data.orders); document.getElementById(\u0026#39;timestamp\u0026#39;).textContent = \u0026#39;æœ€åæ›´æ–°æ—¶é—´: \u0026#39; + data.timestamp; }); æ ·å¼å’Œå¸ƒå±€ï¼š ä½¿ç”¨ CSS Grid å¸ƒå±€åˆ›å»ºæ•´æ´çš„æ•°æ®å¡ç‰‡ç•Œé¢ï¼Œæ¯ä¸ªå¡ç‰‡æ˜¾ç¤ºä¸€ç§æ•°æ®ç±»å‹ã€‚å¡ç‰‡ä½¿ç”¨åŠ¨ç”»æ•ˆæœçªå‡ºæ•°æ®æ›´æ–°ã€‚\n","date":"2024-11-25T11:05:13Z","image":"https://www.ownit.top/title_pic/51.jpg","permalink":"https://www.ownit.top/p/202411251105/","title":"åŸºäº Flask å’Œ Socket.IO çš„ WebSocket å®æ—¶æ•°æ®æ›´æ–°å®ç°"},{"content":"OpenStackä»‹ç» OpenStackæ˜¯ä¸€ä¸ªå¼€æºçš„äº‘è®¡ç®—ç®¡ç†å¹³å°ï¼Œæ—¨åœ¨ä¸ºå…¬å…±åŠç§æœ‰äº‘çš„å»ºè®¾ä¸ç®¡ç†æä¾›è½¯ä»¶ã€‚å®ƒç”±å‡ ä¸ªä¸»è¦çš„ç»„ä»¶ç»„åˆèµ·æ¥å®Œæˆä¸€äº›å…·ä½“çš„å·¥ä½œï¼ŒåŒ…æ‹¬è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œèµ„æºçš„ç®¡ç†ã€‚OpenStackæ”¯æŒæ‰€æœ‰ç±»å‹çš„äº‘ç¯å¢ƒï¼Œå¯ä»¥ç®€å•åœ°å®æ–½å¹¶å¤§è§„æ¨¡æ‰©å±•ï¼Œæä¾›äº†ä¸€ä¸ªä¸°å¯Œã€æ ‡å‡†åŒ–ã€ç»Ÿä¸€çš„äº‘è®¡ç®—ç®¡ç†å¹³å°ã€‚\nåœ¨ç§æœ‰äº‘çš„éƒ¨ç½²ä¸­ï¼ŒOpenStackæä¾›äº†å¼ºå¤§çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ï¼Œå…è®¸ä¼ä¸šæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å®šåˆ¶å’Œä¼˜åŒ–äº‘ç¯å¢ƒã€‚ä¾‹å¦‚ï¼Œé€šè¿‡OpenStackï¼Œä¼ä¸šå¯ä»¥è§„åˆ’å¹¶ç®¡ç†å¤§é‡è™šæ‹Ÿæœºï¼Œæä¾›æ‰€éœ€çš„å¯¹è±¡åŠå—å­˜å‚¨èµ„æºï¼Œå¹¶å®ç°ç½‘ç»œèµ„æºçš„é«˜æ‰©å±•å’Œè‡ªåŠ¨åŒ–ç®¡ç†\nç»„ä»¶ è¯´æ˜ Nova Compute HyperVç®¡ç†(libvirt,qumu\u0026hellip;) Neutron ç½‘ç»œå’Œåœ°å€ç®¡ç†(åŸåQuantum) Swift å¯¹è±¡å­˜å‚¨(Object) Cinder å—å­˜å‚¨ç®¡ç†(Cinder):ä¸»æœºæŒ‡è™šæ‹Ÿæœºçš„å­˜å‚¨ç®¡ç† Keystone èº«ä»½è®¤è¯æˆæƒ(Identity) Glance é•œè±¡ç®¡ç†(Image)ï¼Œæ”¯æŒæœ¬åœ°å­˜å‚¨ã€NFSã€Swiftã€sheepdogå’ŒCeph Horizon UIç•Œé¢ (Dashboard) Ceilometer ç›‘æ§è®¡é‡(Metering) Heat è½¯ä»¶éƒ¨ç½²(ç¼–é…Orchestration) Lbass è´Ÿè½½å‡è¡¡ï¼Œåç«¯å¯ä»¥æ˜¯å„ç§å•†ä¸šå’Œå¼€æºäº§å“ï¼Œå¦‚ï¼šF5ã€Nginxã€Haproxyã€LVS oslo æŠŠæ‰€æœ‰ç»„ä»¶éœ€è¦ç”¨çš„ç›¸åŒçš„ä¸œè¥¿é›†ä¸­èµ·æ¥ Moniker DNS:æ¯ä¸ªè™šæ‹Ÿæœºï¼Œéƒ½ä¼šè‡ªåŠ¨æœ‰ä¸€ä¸ªdnsè®°å½• marconi æ¶ˆæ¯é˜Ÿåˆ—æ‰©å±•(Queue Service) Trove Database Service Ironic è£¸æœºéƒ¨ç½²(Bare Metal) Savannah Data Processing å…¬å¸éœ€æ±‚ å› ä¸ºå…¬å¸ä¸šåŠ¡æ‹“å±•ï¼Œéœ€è¦æœ‰ç›¸å…³çš„è®¾å¤‡å»ºè®¾å¯¹åº”çš„ç¯å¢ƒï¼Œæˆ‘ä»¬é‡‡è´­å¤šå°æœåŠ¡å™¨ï¼Œä½¿ç”¨raid5åœ¨ç»„æˆå­˜å‚¨ã€‚åœ¨è¿™åŸºç¡€ä¸Šä½¿ç”¨OpenStackæ­å»ºç§æœ‰äº‘ï¼Œæ¥è¿è¡Œç›¸å…³çš„ä¸šåŠ¡å’Œè™šæ‹Ÿæœºã€‚\næœºæˆ¿æ£€æµ‹ç¯å¢ƒé€šå¸¸éœ€è¦ä¸€ä¸ªç¨³å®šã€å®‰å…¨ã€å¯æ§åˆ¶çš„ç§æœ‰äº‘ç¯å¢ƒã€‚åœ¨è¿™æ ·çš„ç¯å¢ƒä¸­ï¼ŒOpenStackèƒ½å¤Ÿæä¾›ä»¥ä¸‹ä¼˜åŠ¿ï¼š\nè‡ªä¸»å¯æ§ï¼šä¼ä¸šå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å®šåˆ¶å’Œä¼˜åŒ–äº‘ç¯å¢ƒï¼Œä¸å—å¤–éƒ¨äº‘æœåŠ¡æä¾›å•†çš„é™åˆ¶ã€‚ å®‰å…¨æ€§ï¼šç§æœ‰äº‘éƒ¨ç½²åœ¨ä¼ä¸šå†…éƒ¨ï¼Œå¯ä»¥æä¾›æ›´é«˜çš„å®‰å…¨å’Œéšç§çº§åˆ«ï¼Œç¡®ä¿æ•æ„Ÿæ•°æ®ä¸è¢«ç¬¬ä¸‰æ–¹è®¿é—®ã€‚ çµæ´»æ€§ï¼šOpenStackçš„å¼€æºç‰¹æ€§ä½¿å¾—ä¼ä¸šå¯ä»¥çµæ´»åœ°é€‰æ‹©ç¡¬ä»¶å’Œè½¯ä»¶ï¼Œä»¥åŠå¦‚ä½•éƒ¨ç½²å’Œç®¡ç†è¿™äº›èµ„æºã€‚ æˆæœ¬æ•ˆç›Šï¼šè™½ç„¶åˆæœŸå»ºè®¾æˆæœ¬å¯èƒ½è¾ƒé«˜ï¼Œä½†éšç€ä¸šåŠ¡é‡çš„å¢åŠ ï¼Œç§æœ‰äº‘çš„å¹³å‡è¿è¥æˆæœ¬å¯èƒ½ä¼šä½äºå…¬æœ‰äº‘ã€‚ å‡†å¤‡ OSï¼šCentos 7 1804 Minimal CPUï¼š4c MEMï¼š8G xvdaï¼š50G ç³»ç»Ÿç›˜ xvdbï¼š100G æ•°æ®ç›˜ Master IPï¼š192.168.81.40\nç›®æ ‡ï¼š 1.å®‰è£…openstack Ocata 2.å‚è€ƒæ–‡æ¡£ https://docs.openstack.org/ocata/install-guide-rdo/\nåˆå§‹åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 #åˆå§‹åŒ–é…ç½® 1.é…ç½®é™æ€IP 2.å…³é—­ selinux sed -i \u0026#34;s/SELINUX=.*/SELINUX=disabled/g\u0026#34; /etc/selinux/config 3.å…³é—­ NetworkManger systemctl stop NetworkManger systemctl disable NetworkManager 4.å…³é—­ firewalld systemctl stop firewalld systemctl disable firewalld 5.é…ç½®ä¸»æœºå hostnamectl set-hostname controller.openstack.fjf 6.é‡å¯ reboot ç½‘ç»œæ—¶é—´åè®®ï¼ˆNTPï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 1.ç¼–è¾‘ /etc/chrony.conf server ntp1.aliyun.com iburst server ntp2.aliyun.com iburst server ntp3.aliyun.com iburst server 0.centos.pool.ntp.org iburst server 1.centos.pool.ntp.org iburst server 2.centos.pool.ntp.org iburst server 3.centos.pool.ntp.org iburst driftfile /var/lib/chrony/drift makestep 1.0 3 rtcsync allow 192.168.0.0/16 logdir /var/log/chrony 2.é‡å¯æœåŠ¡ systemctl restart chronyd å®‰è£…OpenStackè½¯ä»¶åŒ… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 1.å‡†å¤‡å¯†ç  ADMIN_PASS=Pass@w0rd CINDER_DBPASS=Pass@w0rd CINDER_PASS=Pass@w0rd DASH_DBPASS=Pass@w0rd DEMO_PASS=Pass@w0rd GLANCE_DBPASS=Pass@w0rd GLANCE_PASS=Pass@w0rd KEYSTONE_DBPASS=Pass@w0rd METADATA_SECRET=Pass@w0rd NEUTRON_DBPASS=Pass@w0rd NEUTRON_PASS=Pass@w0rd NOVA_DBPASS=Pass@w0rd NOVA_PASS=Pass@w0rd PLACEMENT_PASS=Pass@w0rd RABBIT_PASS=Pass@w0rd 2.é…ç½®hosts echo \u0026#34;192.168.81.40 controller.openstack.fjf\u0026#34; \u0026gt;\u0026gt; /etc/hosts echo \u0026#34;192.168.81.40 controller\u0026#34; \u0026gt;\u0026gt; /etc/hosts 3.å®‰è£…openstack yum æºï¼Œå®˜æ–¹å·²ç»ç§»é™¤äº†ocataçš„yumæºï¼Œæ‰€ä»¥ç”¨æœ¬åœ°åŒæ­¥å¥½çš„ mkdir /etc/yum.repos.d/bak mv /etc/yum.repos.d/* /etc/yum.repos.d/bak/ for i in CentOS-Base.repo CentOS-OpenStack-Ocata.repo epel.repo;do curl -s -o /etc/yum.repos.d/$i http://source.fjf.com/bdata/centos7/$i done 4.é‡å»ºyumç¼“å­˜ yum clean all yum makecache 5.å‡çº§è½¯ä»¶ yum upgrade -y 6.å†…æ ¸å¯èƒ½ä¼šæœ‰æ›´æ–°ï¼Œé‡å¯ä¸€æ¬¡ç³»ç»Ÿ reboot 7.å®‰è£…openstack client yum install python-openstackclient -y åˆ›å»ºç›®å½• 1 mkdir -p /var/lib/nova åˆ†åŒºå¹¶æ ¼å¼åŒ–ç£ç›˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 [root@controller nova]# fdisk /dev/xvdb Welcome to fdisk (util-linux 2.23.2). Changes will remain in memory only, until you decide to write them. Be careful before using the write command. Device does not contain a recognized partition table Building a new DOS disklabel with disk identifier 0x3974d932. Command (m for help): n Partition type: p primary (0 primary, 0 extended, 4 free) e extended Select (default p): p Partition number (1-4, default 1): 1 First sector (2048-209715199, default 2048): Using default value 2048 Last sector, +sectors or +size{K,M,G} (2048-209715199, default 209715199): Using default value 209715199 Partition 1 of type Linux and of size 100 GiB is set Command (m for help): p Disk /dev/xvdb: 107.4 GB, 107374182400 bytes, 209715200 sectors Units = sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disk label type: dos Disk identifier: 0x3974d932 Device Boot Start End Blocks Id System /dev/xvdb1 2048 209715199 104856576 83 Linux Command (m for help): w The partition table has been altered! Calling ioctl() to re-read partition table. Syncing disks. [root@controller lib]# mkfs.xfs /dev/xvdb1 æŒ‚è½½è‡³/var/lib/nova 1 2 3 mount /dev/xvdb1 /var/lib/nova ç¼–è¾‘/etc/fstab,æ·»åŠ ä¸€è¡Œ /dev/xvdb1 /var/lib/nova xfs defaults 0 0 éƒ¨ç½²åŸºç¡€ç»„ä»¶ å®‰è£…æ•°æ®åº“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 1.å®‰è£… yum install mariadb mariadb-server python2-PyMySQL -y 2.é…ç½® cat \u0026gt; /etc/my.cnf.d/openstack.cnf \u0026lt;\u0026lt;EOF [mysqld] bind-address = 192.168.81.40 default-storage-engine = innodb innodb_file_per_table = on max_connections = 4096 collation-server = utf8_general_ci character-set-server = utf8 EOF 3.ä¼˜åŒ–å‚æ•° åœ¨æ–‡ä»¶ /usr/lib/systemd/system/mariadb.service çš„[Service]å­—æ®µæ·»åŠ ä¸‹åˆ—å‚æ•°ï¼Œå¦åˆ™ä¼šé€ æˆè™šæ‹Ÿæœºåˆ›å»ºå¤±è´¥çš„æƒ…å†µ LimitNOFILE=10000 LimitNPROC=10000 4.å¯åŠ¨ systemctl enable mariadb.service systemctl start mariadb.service 5.è®¾ç½®å¯†ç  [root@master ~]# mysql_secure_installation NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB SERVERS IN PRODUCTION USE! PLEASE READ EACH STEP CAREFULLY! In order to log into MariaDB to secure it, we\u0026#39;ll need the current password for the root user. If you\u0026#39;ve just installed MariaDB, and you haven\u0026#39;t set the root password yet, the password will be blank, so you should just press enter here. Enter current password for root (enter for none): é»˜è®¤æ²¡å¯†ç ï¼Œç›´æ¥å›è½¦ OK, successfully used password, moving on... Setting the root password ensures that nobody can log into the MariaDB root user without the proper authorisation. Set root password? [Y/n] Y New password: Pass@w0rd Re-enter new password: Pass@w0rd Password updated successfully! Reloading privilege tables.. ... Success! By default, a MariaDB installation has an anonymous user, allowing anyone to log into MariaDB without having to have a user account created for them. This is intended only for testing, and to make the installation go a bit smoother. You should remove them before moving into a production environment. Remove anonymous users? [Y/n] Y ... Success! Normally, root should only be allowed to connect from \u0026#39;localhost\u0026#39;. This ensures that someone cannot guess at the root password from the network. Disallow root login remotely? [Y/n] Y #ç¦æ­¢rootè¿œç¨‹ç™»é™†ï¼Œé€‰æ‹©ä¸ºYä¹‹ååªæœ‰masterèŠ‚ç‚¹èƒ½ä½¿ç”¨rootè´¦å·ç™»é™†ã€‚å¦‚æœä¸æƒ³è¿™æ ·ï¼ŒæŒ‰n ... Success! By default, MariaDB comes with a database named \u0026#39;test\u0026#39; that anyone can access. This is also intended only for testing, and should be removed before moving into a production environment. Remove test database and access to it? [Y/n] Y - Dropping test database... ... Success! - Removing privileges on test database... ... Success! Reloading the privilege tables will ensure that all changes made so far will take effect immediately. Reload privilege tables now? [Y/n] Y ... Success! Cleaning up... All done! If you\u0026#39;ve completed all of the above steps, your MariaDB installation should now be secure. Thanks for using MariaDB! 6.æµ‹è¯•ä¸€ä¸‹ [root@master ~]# mysql -uroot -pPass@w0rd Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 16 Server version: 10.3.20-MariaDB MariaDB Server Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | +--------------------+ 3 rows in set (0.001 sec) å®‰è£…æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 1.å®‰è£…rabbitmq yum install rabbitmq-server -y 2.å¯åŠ¨ systemctl enable rabbitmq-server.service systemctl start rabbitmq-server.service 3.è®¾ç½®å¯†ç  rabbitmqctl add_user openstack Pass@w0rd 4.æˆæƒ rabbitmqctl set_permissions openstack \u0026#34;.*\u0026#34; \u0026#34;.*\u0026#34; \u0026#34;.*\u0026#34; 5.å¼€å¯rabbitmq managementæ–¹ä¾¿ä»¥åç®¡ç† rabbitmq-plugins enable rabbitmq_management é»˜è®¤å¯†ç ï¼šguest/guest åå°ï¼š192.168.81.40:15672 å®‰è£…ç¼“å­˜æœåŠ¡ 1 2 3 4 5 6 7 8 1.å®‰è£…memcached yum install memcached python-memcached -y 2.ä¿®æ”¹é…ç½®æ–‡ä»¶ vim /etc/sysconfig/memcached OPTIONS=\u0026#34;-l 127.0.0.1,::1,controller.openstack.fjf\u0026#34; 3.å¯åŠ¨ systemctl enable memcached.service systemctl start memcached.service å®‰è£…é”®å€¼å­˜å‚¨æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 1.å®‰è£…etcd yum install etcd -y 2.é…ç½® cat \u0026gt; /etc/etcd/etcd.conf \u0026lt;\u0026lt;EOF #[Member] ETCD_DATA_DIR=\u0026#34;/var/lib/etcd/default.etcd\u0026#34; ETCD_LISTEN_PEER_URLS=\u0026#34;http://192.168.81.40:2380\u0026#34; ETCD_LISTEN_CLIENT_URLS=\u0026#34;http://192.168.81.40:2379\u0026#34; ETCD_NAME=\u0026#34;controller.openstack.fjf\u0026#34; #[Clustering] ETCD_INITIAL_ADVERTISE_PEER_URLS=\u0026#34;http://192.168.81.40:2380\u0026#34; ETCD_ADVERTISE_CLIENT_URLS=\u0026#34;http://192.168.81.40:2379\u0026#34; ETCD_INITIAL_CLUSTER=\u0026#34;controller.openstack.fjf=http://192.168.81.40:2380\u0026#34; ETCD_INITIAL_CLUSTER_TOKEN=\u0026#34;etcd-cluster-01\u0026#34; ETCD_INITIAL_CLUSTER_STATE=\u0026#34;new\u0026#34; EOF 3.å¯åŠ¨ systemctl enable etcd systemctl start etcd ç³»ç»Ÿå‚æ•°ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 1.ä¿®æ”¹/etc/security/limits.d/20-nproc.conf * soft nproc 65535 root soft nproc unlimited 2.ä¿®æ”¹ /etc/security/limits.conf * soft nofile 655350 * hard nofile 655350 * soft nproc 655350 * hard nproc 655350 å®‰è£…keystone ä¸€. å®‰è£…keystone(èº«ä»½è®¤è¯æœåŠ¡)\nå»ºåº“ï¼Œå»ºç”¨æˆ·\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@controller ~]# mysql -uroot -pPass@w0rd Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 11 Server version: 10.1.20-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; CREATE DATABASE keystone; Query OK, 1 row affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON keystone.* TO \u0026#39;keystone\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;Pass@w0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON keystone.* TO \u0026#39;keystone\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;Pass@w0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) å®‰è£…ç»„ä»¶\n1 yum install openstack-keystone httpd mod_wsgi -y ç¼–è¾‘/etc/keystone/keystone.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 1.åœ¨è¯¥[database]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æ•°æ®åº“è®¿é—®ï¼š [database] # ... connection = mysql+pymysql://keystone:Pass@w0rd@controller.openstack.fjf/keystone 2.åœ¨è¯¥[token]éƒ¨åˆ†ä¸­ï¼Œé…ç½®Fernetä»¤ç‰Œæä¾›è€… [token] # ... provider = fernet å¡«å……èº«ä»½æœåŠ¡æ•°æ®åº“\n1 su -s /bin/sh -c \u0026#34;keystone-manage db_sync\u0026#34; keystone åˆå§‹åŒ–Fernetå¯†é’¥å­˜å‚¨åº“\n1 2 keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone keystone-manage credential_setup --keystone-user keystone --keystone-group keystone å¼•å¯¼èº«ä»½æœåŠ¡\n1 2 3 4 5 keystone-manage bootstrap --bootstrap-password Pass@w0rd \\ --bootstrap-admin-url http://controller.openstack.fjf:5000/v3/ \\ --bootstrap-internal-url http://controller.openstack.fjf:5000/v3/ \\ --bootstrap-public-url http://controller.openstack.fjf:5000/v3/ \\ --bootstrap-region-id RegionOne é…ç½®HTTPæ¥å£\n1 2 vim /etc/httpd/conf/httpd.conf ServerName controller.openstack.fjf åˆ›å»ºé“¾æ¥\n1 ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/ å¯åŠ¨\n1 2 systemctl enable httpd.service systemctl start httpd.service åˆ›å»ºadmin-openrc\n1 2 3 4 5 6 7 8 9 cat \u0026gt; /root/admin-openrc \u0026lt;\u0026lt;EOF export OS_USERNAME=admin export OS_PASSWORD=Pass@w0rd export OS_PROJECT_NAME=admin export OS_USER_DOMAIN_NAME=Default export OS_PROJECT_DOMAIN_NAME=Default export OS_AUTH_URL=http://controller.openstack.fjf:5000/v3 export OS_IDENTITY_API_VERSION=3 EOF åŠ è½½admin-openrc\n1 2 . admin-openrc åˆ›å»ºservice\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 openstack project create --domain default \\ --description \u0026#34;Service Project\u0026#34; service +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Service Project | | domain_id | default | | enabled | True | | id | 2c7d5b03d68746229cb60b9ae382d0ae | | is_domain | False | | name | service | | parent_id | default | | tags | [] | +-------------+----------------------------------+ éªŒè¯æ“ä½œ\n1 2 3 4 5 6 7 8 9 10 11 openstack --os-auth-url http://controller.openstack.fjf:5000/v3 \\ --os-project-domain-name Default --os-user-domain-name Default \\ --os-project-name admin --os-username admin token issue +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Field | Value | +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | expires | 2021-03-18T12:10:01+0000 | | id | gAAAAABgUzUJjJTsx4Vz1OY_vBBN28FQC3hH-xpqhITyvjSdF4pOykX8tCd0WX59rChxhC7kWZkrhQygcLj9Ari3pmKcZ5u9Ae4RTYJh1NpF8418xbbZCeZgxbVb9SOUgqCe0ftFzbewGmEL-hxhOmr3rd3WO2HYG47H6CR9WmDzSWsIei2NpPw | | project_id | 750d6512fc3043d1b1c6d832465cbf9f | | user_id | 99cb132981a74d339868e54a0a4deb3c | +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ å®‰è£…glance äºŒã€å®‰è£…glance(é•œåƒæœåŠ¡)\nå»ºåº“ï¼Œå»ºç”¨æˆ·\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@controller ~]# mysql -uroot -pPass@w0rd Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 3 Server version: 10.1.20-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; CREATE DATABASE glance; Query OK, 1 row affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON glance.* TO \u0026#39;glance\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;Passw0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON glance.* TO \u0026#39;glance\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;Passw0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) åŠ è½½admin-openrc\n1 . admin-openrc åˆ›å»ºç”¨æˆ·\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@controller ~]# openstack user create --domain default --password-prompt glance User Password:Pass@w0rd Repeat User Password:Pass@w0rd +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | 06d7dd9775a3482886790405f3bfe298 | | name | glance | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ æˆæƒ\n1 openstack role add --project service --user glance admin åˆ›å»ºæœåŠ¡\n1 2 3 4 5 6 7 8 9 10 [root@controller ~]# openstack service create --name glance --description \u0026#34;OpenStack Image\u0026#34; image +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Image | | enabled | True | | id | 56c2b257f48d4d7aa4768a0f1f2367ca | | name | glance | | type | image | +-------------+----------------------------------+ åˆ›å»ºAPIæ¥å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 [root@controller ~]# openstack endpoint create --region RegionOne image public http://controller.openstack.fjf:9292 +--------------+--------------------------------------+ | Field | Value | +--------------+--------------------------------------+ | enabled | True | | id | 36c0f0dec23f435fb5e3bbd6ac0ce5ff | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 56c2b257f48d4d7aa4768a0f1f2367ca | | service_name | glance | | service_type | image | | url | http://controller.openstack.fjf:9292 | +--------------+--------------------------------------+ [root@controller ~]# openstack endpoint create --region RegionOne image internal http://controller.openstack.fjf:9292 +--------------+--------------------------------------+ | Field | Value | +--------------+--------------------------------------+ | enabled | True | | id | 236f70c24afb4049ac2660cbecd0b7a2 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 56c2b257f48d4d7aa4768a0f1f2367ca | | service_name | glance | | service_type | image | | url | http://controller.openstack.fjf:9292 | +--------------+--------------------------------------+ [root@controller ~]# openstack endpoint create --region RegionOne image admin http://controller.openstack.fjf:9292 +--------------+--------------------------------------+ | Field | Value | +--------------+--------------------------------------+ | enabled | True | | id | 36f005f69dd74f52b3f5bf0cce3c46d7 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 56c2b257f48d4d7aa4768a0f1f2367ca | | service_name | glance | | service_type | image | | url | http://controller.openstack.fjf:9292 | +--------------+--------------------------------------+ å®‰è£…å’Œé…ç½®ç»„ä»¶\n1 2 yum install openstack-glance -y ç¼–è¾‘/etc/glance/glance-api.conf\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 [database] # ... # æ³¨æ„æ­¤å¤„çš„å¯†ç æ˜¯Passw0rdè€Œä¸æ˜¯Pass@w0rd,æ”¹ç»„ä»¶è¿æ¥ä¸²ä¸­ä¸æ”¯æŒ\u0026#39;@\u0026#39;ç¬¦å· connection = mysql+pymysql://glance:Passw0rd@controller.openstack.fjf/glance [keystone_authtoken] # ... www_authenticate_uri = http://controller.openstack.fjf:5000 auth_url = http://controller.openstack.fjf:5000 memcached_servers = controller.openstack.fjf:11211 auth_type = password project_domain_name = Default user_domain_name = Default project_name = service username = glance password = Pass@w0rd [paste_deploy] # ... flavor = keystone [glance_store] # ... stores = file,http default_store = file filesystem_store_datadir = /var/lib/glance/images/ å¡«å……å›¾åƒæœåŠ¡æ•°æ®åº“\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 [root@controller ~]# su -s /bin/sh -c \u0026#34;glance-manage db_sync\u0026#34; glance # å‡ºç°æ­¤è­¦å‘Šå¯ä»¥å¿½ç•¥ /usr/lib/python2.7/site-packages/oslo_db/sqlalchemy/enginefacade.py:1336: OsloDBDeprecationWarning: EngineFacade is deprecated; please use oslo_db.sqlalchemy.enginefacade expire_on_commit=expire_on_commit, _conf=conf) INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. INFO [alembic.runtime.migration] Running upgrade -\u0026gt; liberty, liberty initial INFO [alembic.runtime.migration] Running upgrade liberty -\u0026gt; mitaka01, add index on created_at and updated_at columns of \u0026#39;images\u0026#39; table INFO [alembic.runtime.migration] Running upgrade mitaka01 -\u0026gt; mitaka02, update metadef os_nova_server INFO [alembic.runtime.migration] Running upgrade mitaka02 -\u0026gt; ocata_expand01, add visibility to images INFO [alembic.runtime.migration] Running upgrade ocata_expand01 -\u0026gt; pike_expand01, empty expand for symmetry with pike_contract01 INFO [alembic.runtime.migration] Running upgrade pike_expand01 -\u0026gt; queens_expand01 INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. Upgraded database to: queens_expand01, current revision(s): queens_expand01 INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. Database migration is up to date. No migration needed. INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. INFO [alembic.runtime.migration] Running upgrade mitaka02 -\u0026gt; ocata_contract01, remove is_public from images INFO [alembic.runtime.migration] Running upgrade ocata_contract01 -\u0026gt; pike_contract01, drop glare artifacts tables INFO [alembic.runtime.migration] Running upgrade pike_contract01 -\u0026gt; queens_contract01 INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. Upgraded database to: queens_contract01, current revision(s): queens_contract01 INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. Database is synced successfully. å¯åŠ¨\n1 2 systemctl enable openstack-glance-api.service systemctl start openstack-glance-api.service å®‰è£…Compute|æ§åˆ¶èŠ‚ç‚¹ ä¸‰ã€å®‰è£…Compute(è®¡ç®—æœåŠ¡)\u0026amp;Placement(è°ƒåº¦æœåŠ¡)\nå»ºåº“ï¼Œå»ºç”¨æˆ·\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 [root@controller ~]# mysql -uroot -pPass@w0rd Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 11 Server version: 10.1.20-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; CREATE DATABASE nova_api; Query OK, 1 row affected (0.00 sec) MariaDB [(none)]\u0026gt; CREATE DATABASE nova; Query OK, 1 row affected (0.00 sec) MariaDB [(none)]\u0026gt; CREATE DATABASE nova_cell0; Query OK, 1 row affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON nova_api.* TO \u0026#39;nova\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;Pass@w0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON nova_api.* TO \u0026#39;nova\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;Pass@w0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON nova.* TO \u0026#39;nova\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;Pass@w0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON nova.* TO \u0026#39;nova\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;Pass@w0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON nova_cell0.* TO \u0026#39;nova\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;Pass@w0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON nova_cell0.* TO \u0026#39;nova\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;Pass@w0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) åŠ è½½admin-openrc\n1 . admin-openrc åˆ›å»ºNovaç”¨æˆ·\n1 2 3 4 5 6 7 8 9 10 11 12 13 [root@controller ~]# openstack user create --domain default --password-prompt nova User Password:Pass@w0rd Repeat User Password:Pass@w0rd +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | fa90e0ee1be34a7c8d9d77bf2db3ca7e | | name | nova | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ æˆæƒNova\n1 openstack role add --project service --user nova admin åˆ›å»ºè®¡ç®—æœåŠ¡\n1 2 3 4 5 6 7 8 9 10 [root@controller ~]# openstack service create --name nova --description \u0026#34;OpenStack Compute\u0026#34; compute +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Compute | | enabled | True | | id | 0795642e98ce42c8bac111a21625976c | | name | nova | | type | compute | +-------------+----------------------------------+ åˆ›å»ºè®¡ç®—APIæ¥å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 [root@controller ~]# openstack endpoint create --region RegionOne compute public http://controller.openstack.fjf:8774/v2.1 +--------------+-------------------------------------------+ | Field | Value | +--------------+-------------------------------------------+ | enabled | True | | id | f1569159f0444831b29d4e0732aeca27 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 0795642e98ce42c8bac111a21625976c | | service_name | nova | | service_type | compute | | url | http://controller.openstack.fjf:8774/v2.1 | +--------------+-------------------------------------------+ [root@controller ~]# openstack endpoint create --region RegionOne compute internal http://controller.openstack.fjf:8774/v2.1 +--------------+-------------------------------------------+ | Field | Value | +--------------+-------------------------------------------+ | enabled | True | | id | 465c36ab7dcc4e849c835ae9ef174eba | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 0795642e98ce42c8bac111a21625976c | | service_name | nova | | service_type | compute | | url | http://controller.openstack.fjf:8774/v2.1 | +--------------+-------------------------------------------+ [root@controller ~]# openstack endpoint create --region RegionOne compute admin http://controller.openstack.fjf:8774/v2.1 +--------------+-------------------------------------------+ | Field | Value | +--------------+-------------------------------------------+ | enabled | True | | id | 879816f84f6444b4a65bab6f8d620d08 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 0795642e98ce42c8bac111a21625976c | | service_name | nova | | service_type | compute | | url | http://controller.openstack.fjf:8774/v2.1 | +--------------+-------------------------------------------+ åˆ›å»ºplacementç”¨æˆ·\n1 2 3 4 5 6 7 8 9 10 11 12 13 [root@controller ~]# openstack user create --domain default --password-prompt placement User Password:Pass@w0rd Repeat User Password:Pass@w0rd +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | f0b41802435f4d3dad27c6711bb3de73 | | name | placement | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ æˆæƒplacement\n1 openstack role add --project service --user placement admin åˆ›å»ºè°ƒåº¦å™¨æœåŠ¡\n1 2 3 4 5 6 7 8 9 10 [root@controller ~]# openstack service create --name placement --description \u0026#34;Placement API\u0026#34; placement +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Placement API | | enabled | True | | id | 315aa5dae18c4c6bb2a6105f25a11c98 | | name | placement | | type | placement | +-------------+----------------------------------+ åˆ›å»ºè°ƒåº¦å™¨APIæ¥å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 [root@controller ~]# openstack endpoint create --region RegionOne placement public http://controller.openstack.fjf:8778 +--------------+--------------------------------------+ | Field | Value | +--------------+--------------------------------------+ | enabled | True | | id | bb6eeb117b2c421498bd5d74ab2304e0 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 7b2281d9a2e1436e8d6b9721774deb01 | | service_name | placement | | service_type | placement | | url | http://controller.openstack.fjf:8778 | +--------------+--------------------------------------+ [root@controller ~]# openstack endpoint create --region RegionOne placement internal http://controller.openstack.fjf:8778 +--------------+--------------------------------------+ | Field | Value | +--------------+--------------------------------------+ | enabled | True | | id | fed2080d301247e4b9cb9e2b2a4bde55 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 7b2281d9a2e1436e8d6b9721774deb01 | | service_name | placement | | service_type | placement | | url | http://controller.openstack.fjf:8778 | +--------------+--------------------------------------+ [root@controller ~]# openstack endpoint create --region RegionOne placement admin http://controller.openstack.fjf:8778 +--------------+--------------------------------------+ | Field | Value | +--------------+--------------------------------------+ | enabled | True | | id | 3d255c3a2ebb4d249f063e1392767fd7 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 7b2281d9a2e1436e8d6b9721774deb01 | | service_name | placement | | service_type | placement | | url | http://controller.openstack.fjf:8778 | +--------------+--------------------------------------+ å®‰è£…å’Œé…ç½®ç»„ä»¶\n1 yum install openstack-nova-api openstack-nova-conductor openstack-nova-console openstack-nova-novncproxy openstack-nova-scheduler openstack-nova-placement-api -y ç¼–è¾‘/etc/nova/nova.conf\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 [DEFAULT] # ... enabled_apis = osapi_compute,metadata use_neutron = True firewall_driver = nova.virt.firewall.NoopFirewallDriver my_ip = 192.168.81.40 connection = mysql+pymysql://nova:Pass@w0rd@controller.openstack.fjf/nova_api transport_url = rabbit://openstack:Pass@w0rd@controller.openstack.fjf [api_database] # ... connection = mysql+pymysql://nova:Pass@w0rd@controller.openstack.fjf/nova_api [database] # ... connection = mysql+pymysql://nova:Pass@w0rd@controller.openstack.fjf/nova [api] # ... auth_strategy = keystone [keystone_authtoken] # ... auth_uri = http://controller.openstack.fjf:5000 auth_url = http://controller.openstack.fjf:35357 memcached_servers = controller.openstack.fjf:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = Pass@w0rd [vnc] enabled = true # ... vncserver_listen = $my_ip vncserver_proxyclient_address = $my_ip novncproxy_base_url = http://controller.openstack.fjf:6080/vnc_auto.html [glance] # ... api_servers = http://controller.openstack.fjf:9292 [oslo_concurrency] # ... lock_path = /var/lib/nova/tmp [placement] # ... os_region_name = RegionOne project_domain_name = Default project_name = service auth_type = password user_domain_name = Default auth_url = http://controller.openstack.fjf:35357/v3 username = placement password = Pass@w0rd ç¼–è¾‘/etc/httpd/conf.d/00-nova-placement-api.confï¼Œå°¾éƒ¨æ·»åŠ \n1 2 3 4 5 6 7 8 9 \u0026lt;Directory /usr/bin\u0026gt; \u0026lt;IfVersion \u0026gt;= 2.4\u0026gt; Require all granted \u0026lt;/IfVersion\u0026gt; \u0026lt;IfVersion \u0026lt; 2.4\u0026gt; Order allow,deny Allow from all \u0026lt;/IfVersion\u0026gt; \u0026lt;/Directory\u0026gt; é‡å¯httpd\n1 systemctl restart httpd åˆå§‹åŒ–æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 [root@controller ~]# su -s /bin/sh -c \u0026#34;nova-manage api_db sync\u0026#34; nova [root@controller ~]# su -s /bin/sh -c \u0026#34;nova-manage cell_v2 map_cell0\u0026#34; nova [root@controller ~]# su -s /bin/sh -c \u0026#34;nova-manage cell_v2 create_cell --name=cell1 --verbose\u0026#34; nova 5d590937-4a0e-488e-9766-9db19d151a51 [root@controller ~]# su -s /bin/sh -c \u0026#34;nova-manage db sync\u0026#34; nova # è­¦å‘Šä¿¡æ¯å¯ä»¥å¿½ç•¥ /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u\u0026#39;Duplicate index `block_device_mapping_instance_uuid_virtual_name_device_name_idx`. This is deprecated and will be disallowed in a future release.\u0026#39;) result = self._query(query) /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u\u0026#39;Duplicate index `uniq_instances0uuid`. This is deprecated and will be disallowed in a future release.\u0026#39;) result = self._query(query) [root@controller ~]# nova-manage cell_v2 list_cells # éªŒè¯æ•°æ® +-------+--------------------------------------+--------------------------------------------------+---------------------------------------------------------------+ | Name | UUID | Transport URL | Database Connection | +-------+--------------------------------------+--------------------------------------------------+---------------------------------------------------------------+ | cell0 | 00000000-0000-0000-0000-000000000000 | none:/ | mysql+pymysql://nova:****@controller.openstack.fjf/nova_cell0 | | cell1 | 5d590937-4a0e-488e-9766-9db19d151a51 | rabbit://openstack:****@controller.openstack.fjf | mysql+pymysql://nova:****@controller.openstack.fjf/nova | +-------+--------------------------------------+--------------------------------------------------+---------------------------------------------------------------+ å¯åŠ¨æœåŠ¡\n1 2 3 systemctl enable openstack-nova-api.service openstack-nova-consoleauth.service openstack-nova-scheduler.service openstack-nova-conductor.service openstack-nova-novncproxy.service systemctl start openstack-nova-api.service openstack-nova-consoleauth.service openstack-nova-scheduler.service openstack-nova-conductor.service openstack-nova-novncproxy.service å®‰è£…Compute|è®¡ç®—èŠ‚ç‚¹ å››ã€å®‰è£…Compute(è®¡ç®—æœåŠ¡)ï¼Œä¸ºäº†èŠ‚çœèµ„æºå¯ä»¥å°†è®¡ç®—èŠ‚ç‚¹å’Œæ§åˆ¶èŠ‚ç‚¹å®‰è£…åœ¨ä¸€èµ·è¿™æ ·æ§åˆ¶èŠ‚ç‚¹ä¹Ÿå¯ä»¥è¿è¡Œè™šæ‹Ÿæœº\nå®‰è£…ç»„ä»¶\n1 yum install openstack-nova-compute ç¼–è¾‘é…ç½®/etc/nova/nova.confï¼Œå¦‚æœæ˜¯åœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šæ·»åŠ è®¡ç®—æœåŠ¡åˆ™ä¸éœ€è¦ä¿®æ”¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 [DEFAULT] # ... enabled_apis = osapi_compute,metadata my_ip = 192.168.81.40 use_neutron = True firewall_driver = nova.virt.firewall.NoopFirewallDriver transport_url = rabbit://openstack:Pass@w0rd@controller.openstack.fjf [api] # ... auth_strategy = keystone [keystone_authtoken] # ... auth_uri = http://controller.openstack.fjf:5000 auth_url = http://controller.openstack.fjf:35357 memcached_servers = controller.openstack.fjf:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = Pass@w0rd [vnc] # ... enabled = True vncserver_listen = 0.0.0.0 vncserver_proxyclient_address = $my_ip novncproxy_base_url = http://controller.openstack.fjf:6080/vnc_auto.html [glance] # ... api_servers = http://controller.openstack.fjf:9292 [oslo_concurrency] # ... lock_path = /var/lib/nova/tmp [placement] # ... os_region_name = RegionOne project_domain_name = Default project_name = service auth_type = password user_domain_name = Default auth_url = http://controller.openstack.fjf:35357/v3 username = placement password = Pass@w0rd æ£€æŸ¥æ˜¯å¦æ”¯æŒç¡¬ä»¶è™šæ‹ŸåŒ–\n1 2 3 4 5 6 7 [root@controller ~]# egrep -c \u0026#39;(vmx|svm)\u0026#39; /proc/cpuinfo 8 # å¦‚æœç»“æœä¸º0ï¼Œåˆ™éœ€è¦æ·»åŠ ä»¥ä¸‹é…ç½® ç¼–è¾‘ /etc/nova/nova.conf [libvirt] # ... virt_type = qemu å¯åŠ¨æœåŠ¡\n1 2 systemctl enable libvirtd.service openstack-nova-compute.service systemctl start libvirtd.service openstack-nova-compute.service æ·»åŠ è®¡ç®—èŠ‚ç‚¹åˆ°å…ƒæ•°æ®åº“\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 . admin-openrc # æ‰«æè®¡ç®—ä¸»æœº [root@controller ~]# su -s /bin/sh -c \u0026#34;nova-manage cell_v2 discover_hosts --verbose\u0026#34; nova Found 2 cell mappings. Skipping cell0 since it does not contain hosts. Getting computes from cell \u0026#39;cell1\u0026#39;: 5d590937-4a0e-488e-9766-9db19d151a51 Checking host mapping for compute host \u0026#39;controller.openstack.fjf\u0026#39;: deb6c5fe-24a6-4b1e-af8f-fe448491a565 Creating host mapping for compute host \u0026#39;controller.openstack.fjf\u0026#39;: deb6c5fe-24a6-4b1e-af8f-fe448491a565 Found 1 unmapped computes in cell: 5d590937-4a0e-488e-9766-9db19d151a51 # æŸ¥çœ‹ä¸»æœºçŠ¶æ€ [root@controller ~]# openstack hypervisor list +----+--------------------------+-----------------+---------------+-------+ | ID | Hypervisor Hostname | Hypervisor Type | Host IP | State | +----+--------------------------+-----------------+---------------+-------+ | 1 | controller.openstack.fjf | QEMU | 192.168.81.40 | up | +----+--------------------------+-----------------+---------------+-------+ æ³¨æ„ï¼šæ·»åŠ è®¡ç®—èŠ‚ç‚¹åå¿…é¡»åœ¨æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œnova-manage cell_v2 discover_hostsæ‰èƒ½å‘ç°æ–°çš„è®¡ç®—èŠ‚ç‚¹ï¼Œå¯ä»¥è°ƒæ•´/etc/nova/nova.confä¸­çš„å‚æ•°discover_hosts_in_cells_interval = 300ï¼Œè¡¨ç¤ºä¸º300sè‡ªåŠ¨æ‰«æä¸€æ¬¡\nå®‰è£…neutron äº”ã€å®‰è£…neutron(ç½‘ç»œæœåŠ¡)\nå»ºåº“ï¼Œå»ºç”¨æˆ·\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 [root@controller ~]# mysql -uroot -pPass@w0rd Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 3182 Server version: 10.1.20-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; CREATE DATABASE neutron; Query OK, 1 row affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON neutron.* TO \u0026#39;neutron\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;Pass@w0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) MariaDB [(none)]\u0026gt; GRANT ALL PRIVILEGES ON neutron.* TO \u0026#39;neutron\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;Pass@w0rd\u0026#39;; Query OK, 0 rows affected (0.00 sec) åŠ è½½admin-openrc\n1 2 . admin-openrc åˆ›å»ºç”¨æˆ·\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@controller ~]# openstack user create --domain default --password-prompt neutron User Password: Repeat User Password: +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | c6ea433a2f83472f8218b60dbdf1827a | | name | neutron | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ æˆæƒ\n1 2 openstack role add --project service --user neutron admin åˆ›å»ºæœåŠ¡\n1 2 3 4 5 6 7 8 9 10 [root@controller ~]# openstack service create --name neutron --description \u0026#34;OpenStack Networking\u0026#34; network +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Networking | | enabled | True | | id | 9b2865e3489c4da3b6c250abf2e73e80 | | name | neutron | | type | network | +-------------+----------------------------------+ åˆ›å»ºAPIæ¥å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 [root@controller ~]# openstack endpoint create --region RegionOne network public http://controller.openstack.fjf:9696 +--------------+--------------------------------------+ | Field | Value | +--------------+--------------------------------------+ | enabled | True | | id | f3a7c91366d84b49aa84841585ee3d36 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 9b2865e3489c4da3b6c250abf2e73e80 | | service_name | neutron | | service_type | network | | url | http://controller.openstack.fjf:9696 | +--------------+--------------------------------------+ [root@controller ~]# openstack endpoint create --region RegionOne network internal http://controller.openstack.fjf:9696 +--------------+--------------------------------------+ | Field | Value | +--------------+--------------------------------------+ | enabled | True | | id | e5bac77508904343b93f12a19294a7dd | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 9b2865e3489c4da3b6c250abf2e73e80 | | service_name | neutron | | service_type | network | | url | http://controller.openstack.fjf:9696 | +--------------+--------------------------------------+ [root@controller ~]# openstack endpoint create --region RegionOne network admin http://controller.openstack.fjf:9696 +--------------+--------------------------------------+ | Field | Value | +--------------+--------------------------------------+ | enabled | True | | id | 20e22cf74f9b4ac99ee20bc95cfd3433 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 9b2865e3489c4da3b6c250abf2e73e80 | | service_name | neutron | | service_type | network | | url | http://controller.openstack.fjf:9696 | +--------------+--------------------------------------+ å®‰è£…ç½‘ç»œç»„ä»¶ï¼Œæœ‰ä¸¤ç§Provider networkså’ŒSelf-service networksï¼ŒSelf-service networksæä¾›L3ï¼ˆä¸‰å±‚è·¯ç”±ï¼‰çš„èƒ½åŠ›ï¼Œå› ä¸ºç½‘ç»œç»„ä»¶éƒ¨ç½²åæ— æ³•æ›´æ”¹ï¼Œæ‰€ä»¥ä½¿ç”¨Self-service networksï¼Œå…¶å¯ä»¥æ¶µç›–æ›´å¤šçš„ç½‘ç»œç±»å‹æ–¹ä¾¿ä»¥åç½‘ç»œå˜åŒ–\n1 yum install openstack-neutron openstack-neutron-ml2 openstack-neutron-linuxbridge ebtables -y ç¼–è¾‘é…ç½®æ–‡ä»¶\nç¼–è¾‘/etc/neutron/neutron.conf\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 [database] # ... connection = mysql+pymysql://neutron:Pass@w0rd@controller.openstack.fjf/neutron [DEFAULT] # ... core_plugin = ml2 service_plugins = router allow_overlapping_ips = true transport_url = rabbit://openstack:Pass@w0rd@controller.openstack.fjf auth_strategy = keystone notify_nova_on_port_status_changes = true notify_nova_on_port_data_changes = true [keystone_authtoken] # ... auth_uri = http://controller.openstack.fjf:5000 auth_url = http://controller.openstack.fjf:35357 memcached_servers = controller.openstack.fjf:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = neutron password = Pass@w0rd [nova] # ... auth_url = http://controller.openstack.fjf:35357 auth_type = password project_domain_name = default user_domain_name = default region_name = RegionOne project_name = service username = nova password = Pass@w0rd [oslo_concurrency] # ... lock_path = /var/lib/neutron/tmp ç¼–è¾‘/etc/neutron/plugins/ml2/ml2_conf.ini\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [ml2] # ... type_drivers = flat,vlan,vxlan tenant_network_types = vxlan mechanism_drivers = linuxbridge,l2population extension_drivers = port_security [ml2_type_flat] # ... flat_networks = provider [ml2_type_vlan] # ... network_vlan_ranges = physvlan:1:1000 [ml2_type_vxlan] # ... vni_ranges = 1:1000 [securitygroup] # ... enable_ipset = true ç¼–è¾‘/etc/neutron/plugins/ml2/linuxbridge_agent.ini\n1 2 3 4 5 6 7 8 9 10 11 12 [linux_bridge] physical_interface_mappings = provider:eth0 [vxlan] enable_vxlan = true local_ip = 192.168.81.40 l2_population = true [securitygroup] # ... enable_security_group = true firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver ç¼–è¾‘/etc/neutron/l3_agent.ini\n1 2 3 [DEFAULT] # ... interface_driver = linuxbridge ç¼–è¾‘/etc/neutron/dhcp_agent.ini\n1 2 3 4 5 [DEFAULT] # ... interface_driver = linuxbridge dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq enable_isolated_metadata = true ç¼–è¾‘/etc/neutron/metadata_agent.ini\n1 2 3 4 5 [DEFAULT] # ... nova_metadata_host = controller.openstack.fjf # å…±äº«å¯†é’¥éšæœºç”Ÿæˆä¸€ä¸ª metadata_proxy_shared_secret = RpP55i3dSRRoHq8x ç¼–è¾‘/etc/nova/nova.conf\n1 2 3 4 5 6 7 8 9 10 11 12 13 [neutron] # ... url = http://controller.openstack.fjf:9696 auth_url = http://controller.openstack.fjf:35357 auth_type = password project_domain_name = default user_domain_name = default region_name = RegionOne project_name = service username = neutron password = Pass@w0rd service_metadata_proxy = true metadata_proxy_shared_secret = RpP55i3dSRRoHq8x åˆ›å»ºé…ç½®é“¾æ¥\n1 ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini åˆå§‹åŒ–æ•°æ®åº“\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 [root@controller ~]# su -s /bin/sh -c \u0026#34;neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head\u0026#34; neutron INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. Running upgrade for neutron ... INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. INFO [alembic.runtime.migration] Running upgrade -\u0026gt; kilo, kilo_initial INFO [alembic.runtime.migration] Running upgrade kilo -\u0026gt; 354db87e3225, nsxv_vdr_metadata.py INFO [alembic.runtime.migration] Running upgrade 354db87e3225 -\u0026gt; 599c6a226151, neutrodb_ipam INFO [alembic.runtime.migration] Running upgrade 599c6a226151 -\u0026gt; 52c5312f6baf, Initial operations in support of address scopes INFO [alembic.runtime.migration] Running upgrade 52c5312f6baf -\u0026gt; 313373c0ffee, Flavor framework INFO [alembic.runtime.migration] Running upgrade 313373c0ffee -\u0026gt; 8675309a5c4f, network_rbac INFO [alembic.runtime.migration] Running upgrade 8675309a5c4f -\u0026gt; 45f955889773, quota_usage INFO [alembic.runtime.migration] Running upgrade 45f955889773 -\u0026gt; 26c371498592, subnetpool hash INFO [alembic.runtime.migration] Running upgrade 26c371498592 -\u0026gt; 1c844d1677f7, add order to dnsnameservers INFO [alembic.runtime.migration] Running upgrade 1c844d1677f7 -\u0026gt; 1b4c6e320f79, address scope support in subnetpool INFO [alembic.runtime.migration] Running upgrade 1b4c6e320f79 -\u0026gt; 48153cb5f051, qos db changes INFO [alembic.runtime.migration] Running upgrade 48153cb5f051 -\u0026gt; 9859ac9c136, quota_reservations INFO [alembic.runtime.migration] Running upgrade 9859ac9c136 -\u0026gt; 34af2b5c5a59, Add dns_name to Port INFO [alembic.runtime.migration] Running upgrade 34af2b5c5a59 -\u0026gt; 59cb5b6cf4d, Add availability zone INFO [alembic.runtime.migration] Running upgrade 59cb5b6cf4d -\u0026gt; 13cfb89f881a, add is_default to subnetpool INFO [alembic.runtime.migration] Running upgrade 13cfb89f881a -\u0026gt; 32e5974ada25, Add standard attribute table INFO [alembic.runtime.migration] Running upgrade 32e5974ada25 -\u0026gt; ec7fcfbf72ee, Add network availability zone INFO [alembic.runtime.migration] Running upgrade ec7fcfbf72ee -\u0026gt; dce3ec7a25c9, Add router availability zone INFO [alembic.runtime.migration] Running upgrade dce3ec7a25c9 -\u0026gt; c3a73f615e4, Add ip_version to AddressScope INFO [alembic.runtime.migration] Running upgrade c3a73f615e4 -\u0026gt; 659bf3d90664, Add tables and attributes to support external DNS integration INFO [alembic.runtime.migration] Running upgrade 659bf3d90664 -\u0026gt; 1df244e556f5, add_unique_ha_router_agent_port_bindings INFO [alembic.runtime.migration] Running upgrade 1df244e556f5 -\u0026gt; 19f26505c74f, Auto Allocated Topology - aka Get-Me-A-Network INFO [alembic.runtime.migration] Running upgrade 19f26505c74f -\u0026gt; 15be73214821, add dynamic routing model data INFO [alembic.runtime.migration] Running upgrade 15be73214821 -\u0026gt; b4caf27aae4, add_bgp_dragent_model_data INFO [alembic.runtime.migration] Running upgrade b4caf27aae4 -\u0026gt; 15e43b934f81, rbac_qos_policy INFO [alembic.runtime.migration] Running upgrade 15e43b934f81 -\u0026gt; 31ed664953e6, Add resource_versions row to agent table INFO [alembic.runtime.migration] Running upgrade 31ed664953e6 -\u0026gt; 2f9e956e7532, tag support INFO [alembic.runtime.migration] Running upgrade 2f9e956e7532 -\u0026gt; 3894bccad37f, add_timestamp_to_base_resources INFO [alembic.runtime.migration] Running upgrade 3894bccad37f -\u0026gt; 0e66c5227a8a, Add desc to standard attr table INFO [alembic.runtime.migration] Running upgrade 0e66c5227a8a -\u0026gt; 45f8dd33480b, qos dscp db addition INFO [alembic.runtime.migration] Running upgrade 45f8dd33480b -\u0026gt; 5abc0278ca73, Add support for VLAN trunking INFO [alembic.runtime.migration] Running upgrade 5abc0278ca73 -\u0026gt; d3435b514502, Add device_id index to Port INFO [alembic.runtime.migration] Running upgrade d3435b514502 -\u0026gt; 30107ab6a3ee, provisioning_blocks.py INFO [alembic.runtime.migration] Running upgrade 30107ab6a3ee -\u0026gt; c415aab1c048, add revisions table INFO [alembic.runtime.migration] Running upgrade c415aab1c048 -\u0026gt; a963b38d82f4, add dns name to portdnses INFO [alembic.runtime.migration] Running upgrade kilo -\u0026gt; 30018084ec99, Initial no-op Liberty contract rule. INFO [alembic.runtime.migration] Running upgrade 30018084ec99 -\u0026gt; 4ffceebfada, network_rbac INFO [alembic.runtime.migration] Running upgrade 4ffceebfada -\u0026gt; 5498d17be016, Drop legacy OVS and LB plugin tables INFO [alembic.runtime.migration] Running upgrade 5498d17be016 -\u0026gt; 2a16083502f3, Metaplugin removal INFO [alembic.runtime.migration] Running upgrade 2a16083502f3 -\u0026gt; 2e5352a0ad4d, Add missing foreign keys INFO [alembic.runtime.migration] Running upgrade 2e5352a0ad4d -\u0026gt; 11926bcfe72d, add geneve ml2 type driver INFO [alembic.runtime.migration] Running upgrade 11926bcfe72d -\u0026gt; 4af11ca47297, Drop cisco monolithic tables INFO [alembic.runtime.migration] Running upgrade 4af11ca47297 -\u0026gt; 1b294093239c, Drop embrane plugin table INFO [alembic.runtime.migration] Running upgrade 1b294093239c -\u0026gt; 8a6d8bdae39, standardattributes migration INFO [alembic.runtime.migration] Running upgrade 8a6d8bdae39 -\u0026gt; 2b4c2465d44b, DVR sheduling refactoring INFO [alembic.runtime.migration] Running upgrade 2b4c2465d44b -\u0026gt; e3278ee65050, Drop NEC plugin tables INFO [alembic.runtime.migration] Running upgrade e3278ee65050 -\u0026gt; c6c112992c9, rbac_qos_policy INFO [alembic.runtime.migration] Running upgrade c6c112992c9 -\u0026gt; 5ffceebfada, network_rbac_external INFO [alembic.runtime.migration] Running upgrade 5ffceebfada -\u0026gt; 4ffceebfcdc, standard_desc INFO [alembic.runtime.migration] Running upgrade 4ffceebfcdc -\u0026gt; 7bbb25278f53, device_owner_ha_replicate_int INFO [alembic.runtime.migration] Running upgrade 7bbb25278f53 -\u0026gt; 89ab9a816d70, Rename ml2_network_segments table INFO [alembic.runtime.migration] Running upgrade a963b38d82f4 -\u0026gt; 3d0e74aa7d37, Add flavor_id to Router INFO [alembic.runtime.migration] Running upgrade 3d0e74aa7d37 -\u0026gt; 030a959ceafa, uniq_routerports0port_id INFO [alembic.runtime.migration] Running upgrade 030a959ceafa -\u0026gt; a5648cfeeadf, Add support for Subnet Service Types INFO [alembic.runtime.migration] Running upgrade a5648cfeeadf -\u0026gt; 0f5bef0f87d4, add_qos_minimum_bandwidth_rules INFO [alembic.runtime.migration] Running upgrade 0f5bef0f87d4 -\u0026gt; 67daae611b6e, add standardattr to qos policies INFO [alembic.runtime.migration] Running upgrade 89ab9a816d70 -\u0026gt; c879c5e1ee90, Add segment_id to subnet INFO [alembic.runtime.migration] Running upgrade c879c5e1ee90 -\u0026gt; 8fd3918ef6f4, Add segment_host_mapping table. INFO [alembic.runtime.migration] Running upgrade 8fd3918ef6f4 -\u0026gt; 4bcd4df1f426, Rename ml2_dvr_port_bindings INFO [alembic.runtime.migration] Running upgrade 4bcd4df1f426 -\u0026gt; b67e765a3524, Remove mtu column from networks. INFO [alembic.runtime.migration] Running upgrade 67daae611b6e -\u0026gt; 6b461a21bcfc, uniq_floatingips0floating_network_id0fixed_port_id0fixed_ip_addr INFO [alembic.runtime.migration] Running upgrade 6b461a21bcfc -\u0026gt; 5cd92597d11d, Add ip_allocation to port INFO [alembic.runtime.migration] Running upgrade 5cd92597d11d -\u0026gt; 929c968efe70, add_pk_version_table INFO [alembic.runtime.migration] Running upgrade 929c968efe70 -\u0026gt; a9c43481023c, extend_pk_with_host_and_add_status_to_ml2_port_binding INFO [alembic.runtime.migration] Running upgrade a9c43481023c -\u0026gt; 804a3c76314c, Add data_plane_status to Port INFO [alembic.runtime.migration] Running upgrade 804a3c76314c -\u0026gt; 2b42d90729da, qos add direction to bw_limit_rule table INFO [alembic.runtime.migration] Running upgrade 2b42d90729da -\u0026gt; 62c781cb6192, add is default to qos policies INFO [alembic.runtime.migration] Running upgrade 62c781cb6192 -\u0026gt; c8c222d42aa9, logging api INFO [alembic.runtime.migration] Running upgrade c8c222d42aa9 -\u0026gt; 349b6fd605a6, Add dns_domain to portdnses INFO [alembic.runtime.migration] Running upgrade 349b6fd605a6 -\u0026gt; 7d32f979895f, add mtu for networks INFO [alembic.runtime.migration] Running upgrade 7d32f979895f -\u0026gt; 594422d373ee, fip qos INFO [alembic.runtime.migration] Running upgrade b67e765a3524 -\u0026gt; a84ccf28f06a, migrate dns name from port INFO [alembic.runtime.migration] Running upgrade a84ccf28f06a -\u0026gt; 7d9d8eeec6ad, rename tenant to project INFO [alembic.runtime.migration] Running upgrade 7d9d8eeec6ad -\u0026gt; a8b517cff8ab, Add routerport bindings for L3 HA INFO [alembic.runtime.migration] Running upgrade a8b517cff8ab -\u0026gt; 3b935b28e7a0, migrate to pluggable ipam INFO [alembic.runtime.migration] Running upgrade 3b935b28e7a0 -\u0026gt; b12a3ef66e62, add standardattr to qos policies INFO [alembic.runtime.migration] Running upgrade b12a3ef66e62 -\u0026gt; 97c25b0d2353, Add Name and Description to the networksegments table INFO [alembic.runtime.migration] Running upgrade 97c25b0d2353 -\u0026gt; 2e0d7a8a1586, Add binding index to RouterL3AgentBinding INFO [alembic.runtime.migration] Running upgrade 2e0d7a8a1586 -\u0026gt; 5c85685d616d, Remove availability ranges. é‡å¯NovaæœåŠ¡\n1 systemctl restart openstack-nova-api.service å¯åŠ¨ç½‘ç»œæœåŠ¡\n1 2 systemctl enable neutron-server.service neutron-linuxbridge-agent.service neutron-dhcp-agent.service neutron-metadata-agent.service neutron-l3-agent.service systemctl start neutron-server.service neutron-linuxbridge-agent.service neutron-dhcp-agent.service neutron-metadata-agent.service neutron-l3-agent.service å®‰è£…dashboard å®‰è£…Dashboard(WEBç®¡ç†æ§åˆ¶å°)\nå®‰è£…ç»„ä»¶\n1 yum install openstack-dashboard -y ç¼–è¾‘é…ç½®/etc/openstack-dashboard/local_settingsï¼Œå¦‚æœæ˜¯åœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šæ·»åŠ è®¡ç®—æœåŠ¡åˆ™ä¸éœ€è¦ä¿®æ”¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 OPENSTACK_HOST = \u0026#34;controller.openstack.fjf\u0026#34; ALLOWED_HOSTS = [\u0026#39;controller.openstack.fjf\u0026#39;, \u0026#39;192.168.81.40\u0026#39;,\u0026#39;localhost\u0026#39;] SESSION_ENGINE = \u0026#39;django.contrib.sessions.backends.cache\u0026#39; CACHES = { \u0026#39;default\u0026#39;: { \u0026#39;BACKEND\u0026#39;: \u0026#39;django.core.cache.backends.memcached.MemcachedCache\u0026#39;, \u0026#39;LOCATION\u0026#39;: \u0026#39;controller.openstack.fjf:11211\u0026#39;, } } OPENSTACK_KEYSTONE_URL = \u0026#34;http://%s:5000/v3\u0026#34; % OPENSTACK_HOST OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True OPENSTACK_API_VERSIONS = { \u0026#34;identity\u0026#34;: 3, \u0026#34;image\u0026#34;: 2, \u0026#34;volume\u0026#34;: 2, } OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = \u0026#34;Default\u0026#34; OPENSTACK_KEYSTONE_DEFAULT_ROLE = \u0026#34;admin\u0026#34; OPENSTACK_NEUTRON_NETWORK = { ... \u0026#39;enable_router\u0026#39;: False, \u0026#39;enable_quotas\u0026#39;: False, \u0026#39;enable_distributed_router\u0026#39;: False, \u0026#39;enable_ha_router\u0026#39;: False, \u0026#39;enable_lb\u0026#39;: False, \u0026#39;enable_firewall\u0026#39;: False, \u0026#39;enable_vpn\u0026#39;: False, \u0026#39;enable_fip_topology_check\u0026#39;: False, } TIME_ZONE = \u0026#34;Asia/Shanghai\u0026#34; é‡å¯æœåŠ¡\n1 systemctl restart httpd.service memcached.service è®¿é—®æ§åˆ¶å°ï¼šhttp://192.168.81.40/dashboard è´¦å·/å¯†ç \n1 2 3 4 5 cat admin-openrc # è¿™ä¸ªè´¦å·å¯†ç å°±æ˜¯ç”¨æ¥ç™»é™†æ§åˆ¶å°çš„ï¼Œå¦‚æœè¦æ±‚è¾“å…¥åŸŸåˆ™å‚è€ƒOS_USER_DOMAIN_NAME export OS_USERNAME=admin export OS_PASSWORD=Pass@w0rd export OS_USER_DOMAIN_NAME=Default ä¸‹è½½å¹¶å¯¼å…¥é•œåƒ å¯¼å…¥é•œåƒ\nä¸‹è½½é•œåƒ\n1 2 3 4 5 6 #æµ‹è¯•é•œåƒï¼šcirrosï¼Œæœ€å°çš„ä¸€ç§é•œåƒï¼Œåªæœ‰16Mï¼Œæ–¹ä¾¿æµ‹è¯• wget http://download.cirros-cloud.net/0.5.1/cirros-0.5.1-x86_64-disk.img #Centos7é•œåƒ http://cloud.centos.org/centos/7/images/ #å…¶ä»–ç±»å‹é•œåƒ https://docs.openstack.org/image-guide/obtain-images.html åŠ è½½admin-openrc\n1 . admin-openrc å¯¼å…¥é•œåƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 openstack image create \u0026#34;cirros\u0026#34; --file cirros-0.5.1-x86_64-disk.img --disk-format qcow2 --container-format bare --public +------------------+------------------------------------------------------+ | Field | Value | +------------------+------------------------------------------------------+ | checksum | 1d3062cd89af34e419f7100277f38b2b | | container_format | bare | | created_at | 2021-03-26T11:09:11Z | | disk_format | qcow2 | | file | /v2/images/b3befb16-19c7-4775-ac0a-1961ff269461/file | | id | b3befb16-19c7-4775-ac0a-1961ff269461 | | min_disk | 0 | | min_ram | 0 | | name | cirros | | owner | 750d6512fc3043d1b1c6d832465cbf9f | | protected | False | | schema | /v2/schemas/image | | size | 16338944 | | status | active | | tags | | | updated_at | 2021-03-26T11:09:11Z | | virtual_size | None | | visibility | public | +------------------+------------------------------------------------------+ åˆ›å»ºç½‘ç»œ\u0026amp;è™šæ‹Ÿæœº åˆ›å»ºä¸€ä¸ªæ¡¥æ¥ç½‘ç»œï¼ŒFlatï¼Œç®¡ç†å‘˜ -\u0026gt; ç½‘ç»œ -\u0026gt; ç½‘ç»œ -\u0026gt; åˆ›å»ºç½‘ç»œ ç‰©ç†ç½‘ç»œåç§°é€šè¿‡ï¼šcat /etc/neutron/plugins/ml2/ml2_conf.ini |grep flat_networks è·å– é…ç½®ç½‘ç»œä¿¡æ¯ åˆ›å»ºå®ä¾‹ç±»å‹ï¼Œç®¡ç†å‘˜ -\u0026gt; è®¡ç®— -\u0026gt; å®ä¾‹ç±»å‹ -\u0026gt; åˆ›å»ºå®ä¾‹ç±»å‹ åˆ›å»ºå¯†é’¥å¯¹ï¼Œé¡¹ç›® -\u0026gt; è®¡ç®— -\u0026gt; å¯†é’¥å¯¹ -\u0026gt; å¯¼å…¥å…¬é’¥ï¼Œåˆ›å»ºå®Œä¼šè‡ªåŠ¨ä¸‹è½½ç§é’¥ï¼Œä¹Ÿå¯ä»¥å¯¼å…¥å·²ç»å­˜åœ¨çš„å¯†é’¥å¯¹å…¬é’¥ å¯ä»¥è¿›å…¥æ§åˆ¶å° é€šè¿‡SSHè¿æ¥ ","date":"2024-10-25T16:28:51Z","image":"https://www.ownit.top/title_pic/01.jpg","permalink":"https://www.ownit.top/p/202410251628/","title":"æœºæˆ¿ç§æœ‰äº‘OpenStackæ­å»ºè¯¦ç»†æ­¥éª¤æµç¨‹"},{"content":"é¡¹ç›®èƒŒæ™¯ OpenStackï¼Œä½œä¸ºä¸€ä¸ªå¼€æºçš„äº‘è®¡ç®—å¹³å°ï¼Œç»å¸¸è¢«ç”¨äºæ„å»ºç§æœ‰äº‘å’Œå…¬æœ‰äº‘æœåŠ¡ã€‚ç„¶è€Œï¼Œéšç€ä¸šåŠ¡çš„å‘å±•å’Œæ‰©å±•ï¼Œä¼ä¸šå¯èƒ½ä¼šé¢ä¸´å°†åœ¨OpenStackä¸Šè¿è¡Œçš„è™šæ‹Ÿæœºè¿ç§»åˆ°å…¶ä»–äº‘æœåŠ¡ä¾›åº”å•†çš„éœ€æ±‚\néœ€æ±‚ å› ä¸ºè¿è¥å›¢é˜Ÿåœ¨æœ¬åœ°æœºæˆ¿æœ‰ä¸€å° OpenStackä¸­çš„è™šæ‹Ÿæœºä¸šåŠ¡ï¼Œè´Ÿè´£é‚®ä»¶å‘é€ï¼Œè·‘å®šæ—¶ä»»åŠ¡ç­‰ç­‰ã€‚ä½†æ˜¯ç”±äºæœºæˆ¿è¿ç§»ï¼Œä¼šå¯¼è‡´æœºæˆ¿æœåŠ¡ä¸­æ–­ã€‚ä½†ç”±äºè€ƒè™‘ä¸šåŠ¡ç»§ç»­è·‘ï¼Œéœ€è¦æŠŠè¿™å°æœºå™¨ è¿ç§»åˆ°é˜¿é‡Œäº‘çš„ç¯å¢ƒã€‚ä½†æ˜¯ç”±äºä¾èµ–å’Œç¯å¢ƒä¼—å¤šï¼Œå·®å¼‚æ€§å¤ªå¤§ï¼Œéœ€è¦æœ‰ä¸ªç®€ä¾¿çš„æ–¹å¼å®Œæˆè¿ç§»ã€‚\nç¯å¢ƒä»‹ç» ç¯å¢ƒä»‹ç»\næºç¯å¢ƒï¼šOpenStack ç‰ˆæœ¬ï¼ˆé€‚ç”¨äºå…¶ä»–ç‰ˆæœ¬ï¼Œä½†æ­¥éª¤å¯èƒ½ç•¥æœ‰ä¸åŒï¼‰ ç›®æ ‡ç¯å¢ƒï¼šé˜¿é‡Œäº‘ECS æ“ä½œç³»ç»Ÿï¼šä»¥Centos7 ä¸ºä¾‹ï¼ˆå…¶ä»–Linuxå‘è¡Œç‰ˆçš„æ“ä½œå¯èƒ½ç±»ä¼¼ï¼‰ å¿…è¦å·¥å…·ï¼šqemu-imgï¼ˆç”¨äºè½¬æ¢é•œåƒæ ¼å¼ï¼‰ å‡†å¤‡å·¥ä½œ åœ¨å¼€å§‹ä¹‹å‰ï¼Œç¡®ä¿æ‚¨æœ‰ä»¥ä¸‹å‡†å¤‡ï¼š\nç¡®è®¤æ‚¨æœ‰è¶³å¤Ÿçš„æƒé™æ¥è®¿é—®OpenStackç¯å¢ƒå’Œé˜¿é‡Œäº‘è´¦æˆ·ã€‚ å®‰è£…qemu-imgå·¥å…·ï¼Œè¿™é€šå¸¸å¯ä»¥åœ¨Linuxå‘è¡Œç‰ˆçš„å®˜æ–¹ä»“åº“ä¸­æ‰¾åˆ°ã€‚ ç¡®ä¿æœ‰è¶³å¤Ÿçš„æœ¬åœ°å­˜å‚¨ç©ºé—´æ¥ä¿å­˜å¯¼å‡ºçš„QCOW2é•œåƒæ–‡ä»¶ã€‚ å¯¼å‡ºOpenStackè™šæ‹Ÿæœºé•œåƒ é¦–å…ˆæ’æŸ¥è¿™å°æœºå™¨è™šæ‹Ÿæœºåœ¨é‚£å°OpenStackå®¿ä¸»æœºä¸Šï¼Œ æ¯”å¦‚æˆ‘è¿™å°OpenStackè™šæ‹Ÿæœºåœ¨ compute4.openstack.fjfï¼Œ è™šæ‹Ÿæœºidï¼še7c5b097-e842-4db1-849b-fd4af3cb9380 è¿›å…¥å·¥ä½œç›®å½• è¿›å…¥compute4.openstack.fjf è¿™å°OpenStack çš„nodeèŠ‚ç‚¹ï¼Œåœ¨è¿›å…¥ä¸‹æ–¹ç›®å½•\n1 2 3 cd /var/lib/nova/instaces/$your_instance_id$ è¿™ä¸ªæ˜¯æˆ‘çš„ cd /var/lib/nova/instances/e7c5b097-e842-4db1-849b-fd4af3cb9380/ å¯¼å‡ºè¿è¡Œçš„é•œåƒ ä½¿ç”¨qemu-imgå·¥å…·å°†OpenStackçš„QCOW2é•œåƒè½¬æ¢ä¸ºé€‚åˆé˜¿é‡Œäº‘çš„æ ¼å¼ï¼š\nå¦‚æœä¿å­˜ï¼Œè¯·å…³é—­è™šæ‹Ÿæœºåœ¨è¯•è¯•\n1 2 3 4 5 6 7 [dev][root@compute4-192.168.81.14 e7c5b097-e842-4db1-849b-fd4af3cb9380]# qemu-img convert -c -O qcow2 disk test.qcow2 qemu-img: Could not open \u0026#39;disk\u0026#39;: Failed to get shared \u0026#34;write\u0026#34; lock Is another process using the image [disk]? #è¿™ä¸ªæ­£å¸¸çš„ qemu-img convert -c -O qcow2 disk test.qcow2 #è¿™ä¸ªå‘½ä»¤ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‹ç¼©çš„QCOW2é•œåƒæ–‡ä»¶ ä¼ é•œåƒåˆ°é˜¿é‡Œäº‘OSS åœ¨å¯¼å…¥é•œåƒåˆ°é˜¿é‡Œäº‘ECSä¹‹å‰ï¼Œæ‚¨éœ€è¦å…ˆå°†é•œåƒä¸Šä¼ åˆ°é˜¿é‡Œäº‘çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼ˆOSSï¼‰ã€‚\nç™»å½•åˆ°é˜¿é‡Œäº‘æ§åˆ¶å°ã€‚ åˆ›å»ºä¸€ä¸ªOSS Bucketã€‚ ä½¿ç”¨OSSçš„ä¸Šä¼ åŠŸèƒ½æˆ–è€…OSSæä¾›çš„å‘½ä»¤è¡Œå·¥å…·ossutilä¸Šä¼ æ‚¨çš„QCOW2é•œåƒæ–‡ä»¶ã€‚ å¯¼å…¥é•œåƒåˆ°é˜¿é‡Œäº‘ECS ä¸€æ—¦é•œåƒä¸Šä¼ åˆ°OSSï¼Œæ‚¨å¯ä»¥é€šè¿‡é˜¿é‡Œäº‘ECSæ§åˆ¶å°å¯¼å…¥é•œåƒï¼š\nåœ¨ECSæ§åˆ¶å°ä¸­ï¼Œæ‰¾åˆ°â€œé•œåƒå’Œæ¨¡æ¿â€éƒ¨åˆ†ã€‚ é€‰æ‹©â€œå¯¼å…¥é•œåƒâ€ã€‚ æä¾›OSSä¸­é•œåƒçš„URLï¼Œä»¥åŠå…¶ä»–å¿…è¦çš„ä¿¡æ¯ã€‚ å¯åŠ¨å¯¼å…¥ä»»åŠ¡ã€‚ é˜¿é‡Œäº‘ä¼šå¤„ç†é•œåƒçš„å¯¼å…¥è¿‡ç¨‹ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚ åˆ›å»ºECSå®ä¾‹ å¯¼å…¥é•œåƒå®Œæˆåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¥é•œåƒåˆ›å»ºæ–°çš„ECSå®ä¾‹ï¼š\nåœ¨ECSæ§åˆ¶å°ä¸­ï¼Œé€‰æ‹©â€œå®ä¾‹â€ã€‚ ç‚¹å‡»â€œåˆ›å»ºå®ä¾‹â€ã€‚ åœ¨åˆ›å»ºå‘å¯¼ä¸­ï¼Œé€‰æ‹©æ‚¨åˆšåˆšå¯¼å…¥çš„é•œåƒä½œä¸ºåŸºç¡€ã€‚ å®Œæˆå®ä¾‹çš„é…ç½®ï¼ŒåŒ…æ‹¬é€‰æ‹©å®ä¾‹ç±»å‹ã€é…ç½®ç½‘ç»œå’Œå®‰å…¨ç»„ç­‰ã€‚ å¯åŠ¨å®ä¾‹ã€‚ æ€»ç»“ å°†OpenStackç¯å¢ƒä¸­çš„è™šæ‹Ÿæœºé•œåƒæˆåŠŸè¿ç§»åˆ°é˜¿é‡Œäº‘ECSã€‚è¿™ä¸ªè¿‡ç¨‹ä¸ä»…å¢å¼ºäº†äº‘èµ„æºçš„å¯ç§»æ¤æ€§ï¼Œè€Œä¸”ä¸ºä¼ä¸šæä¾›äº†æ›´å¤šçš„çµæ´»æ€§å’Œé€‰æ‹©æƒã€‚æ— è®ºæ˜¯ä¸ºäº†æˆæœ¬ä¼˜åŒ–ã€æ€§èƒ½æå‡è¿˜æ˜¯éµå¾ªåˆè§„æ€§è¦æ±‚ï¼Œè¿™ç§è¿ç§»ç­–ç•¥éƒ½æ˜¯ç°ä»£äº‘åŸºç¡€è®¾æ–½ç®¡ç†ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚\n","date":"2024-10-23T18:44:38Z","image":"https://www.ownit.top/title_pic/77.jpg","permalink":"https://www.ownit.top/p/202410231844/","title":"OpenStackå°†è¿è¡Œçš„ç³»ç»Ÿå¯¼å‡º QCOW2 é•œåƒå¹¶å¯¼å…¥é˜¿é‡Œäº‘"},{"content":" HAProxy + Keepalived éƒ¨ç½²é«˜å¯ç”¨æ€§å…¥å£ï¼š éƒ¨ç½²ä¸¤å°æˆ–å¤šå°èŠ‚ç‚¹è¿è¡Œ HAProxy ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨ã€‚ ä½¿ç”¨ Keepalived å®ç° VIPï¼ˆè™šæ‹Ÿ IPï¼‰ï¼Œä¸º HAProxy æä¾›é«˜å¯ç”¨æ€§ã€‚Keepalived ä¼šç›‘æ§ HAProxy çš„çŠ¶æ€ï¼Œå¦‚æœä¸»èŠ‚ç‚¹å¤±æ•ˆï¼ŒVIP ä¼šè‡ªåŠ¨æ¼‚ç§»åˆ°å¤‡ç”¨èŠ‚ç‚¹ï¼Œç¡®ä¿é«˜å¯ç”¨æ€§ã€‚ HAProxy é…ç½®ï¼š HAProxy ä¼šä½œä¸º Kubernetes çš„å…¥å£ï¼Œè½¬å‘æµé‡åˆ° Kubernetes é›†ç¾¤çš„ apiserverã€‚ é…ç½® HAProxy è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œåˆ†å‘æµé‡åˆ°å¤šä¸ª Kubernetes master èŠ‚ç‚¹çš„ API serverã€‚ Keepalived é…ç½®ï¼š Keepalived ä¼šç›‘æ§ HAProxy çš„çŠ¶æ€ï¼Œç¡®ä¿åœ¨èŠ‚ç‚¹å¤±æ•ˆæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡å™¨ï¼Œä¿éšœæœåŠ¡è¿ç»­æ€§ã€‚ é…ç½®é«˜ä¼˜å…ˆçº§çš„ä¸»èŠ‚ç‚¹å’Œä½ä¼˜å…ˆçº§çš„å¤‡ä»½èŠ‚ç‚¹ï¼Œå½“ä¸»èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼ŒVIP åˆ‡æ¢åˆ°å¤‡ä»½èŠ‚ç‚¹ã€‚ åŠå…¬ç½‘ç»œæ‰“é€šï¼š åŠå…¬ç½‘ç»œé€šè¿‡ VPN æˆ–è·¯ç”±å™¨é…ç½®ï¼Œå°†åŠå…¬ç½‘ç»œå’Œ Kubernetes é›†ç¾¤çš„ç½‘ç»œæ‰“é€šã€‚ ç¡®ä¿åŠå…¬ç½‘ç»œèƒ½å¤Ÿé€šè¿‡ VIP è®¿é—® Kubernetes é›†ç¾¤æœåŠ¡ï¼ŒåŒ…æ‹¬ API server å’Œé›†ç¾¤å†…çš„å…¶ä»–æœåŠ¡ã€‚ ç¯å¢ƒå‡†å¤‡ ç¯å¢ƒ ç³»ç»Ÿç‰ˆæœ¬ï¼šCentOS 7.5.1804 Kubernetes ç‰ˆæœ¬ï¼šv1.23.1 Calico ç‰ˆæœ¬ï¼šv3.8.0\næœºå™¨ ä¸»æœºå IP è§’è‰² å®‰è£…è½¯ä»¶ k8s-test-lvs-1.fjf 192.168.83.15/vip 192.168.83.3 é«˜å¯ç”¨\u0026amp;è´Ÿè½½å‡è¡¡ Master keepaliveã€haproxy k8s-test-lvs-2.fjf 192.168.83.26/vip 192.168.83.3 é«˜å¯ç”¨\u0026amp;è´Ÿè½½å‡è¡¡ Slave keepaliveã€haproxy k8s-test-master-1.fjf 192.168.83.36 Kubernetes Master Node kubernetes k8s-test-master-2.fjf 192.168.83.54 Kubernetes Master Node kubernetes k8s-test-master-3.fjf 192.168.83.49 Kubernetes Master Node kubernetes k8s-test-node-1.fjf 192.168.83.52 Kubernetes Worker Node kubernetes k8s-test-node-2.fjf 192.168.83.22 Kubernetes Worker Node kubernetes k8s-test-node-3.fjf 192.168.83.37 Kubernetes Worker Node kubernetes ç½‘ç»œè§„åˆ’ åç§° ç½‘ç»œ å¤‡æ³¨ èŠ‚ç‚¹ç½‘ç»œ 192.168.83.0/24 å®¹å™¨å®¿ä¸»æœºæ‰€ç”¨ç½‘ç»œ Podç½‘ç»œ 172.15.0.0/16 å®¹å™¨ç½‘ç»œ Svc ç½‘ç»œ 172.16.0.0/16 æœåŠ¡ç½‘ç»œ ç³»ç»Ÿé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 # æ‰€æœ‰èŠ‚ç‚¹å…³é—­Selinux sed -i \u0026#34;/SELINUX/ s/enforcing/disabled/g\u0026#34; /etc/selinux/config # æ‰€æœ‰èŠ‚ç‚¹å…³é—­é˜²ç«å¢™ systemctl disable firewalld # æ‰€æœ‰èŠ‚ç‚¹é…ç½®å†…æ ¸å‚æ•° cat \u0026gt; /etc/sysctl.conf \u0026lt;\u0026lt;EOF net.ipv6.conf.all.disable_ipv6 = 1 net.ipv6.conf.default.disable_ipv6 = 1 net.ipv6.conf.lo.disable_ipv6 = 1 vm.swappiness = 0 net.ipv4.neigh.default.gc_stale_time=120 # see details in https://help.aliyun.com/knowledge_detail/39428.html net.ipv4.conf.all.rp_filter=0 net.ipv4.conf.default.rp_filter=0 net.ipv4.conf.default.arp_announce = 2 net.ipv4.conf.lo.arp_announce=2 net.ipv4.conf.all.arp_announce=2 # see details in https://help.aliyun.com/knowledge_detail/41334.html net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 1024 net.ipv4.tcp_synack_retries = 2 net.ipv4.tcp_fin_timeout = 30 net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.ipv4.ip_forward = 1 EOF å¦‚æœæ˜¯åœ¨OpenStackä¸­éƒ¨ç½²ï¼Œéœ€è¦å…³é—­æ‰€æœ‰ä¸»æœºçš„ç«¯å£å®‰å…¨ç»„ï¼Œå¦‚æœä¸å…³é—­ï¼Œpodç½‘ç»œå’Œsvcç½‘ç»œå°†æ— æ³•æ­£å¸¸é€šä¿¡ åœ¨openstackæ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 # æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨forå¾ªç¯æ‰¹é‡æ“ä½œï¼Œä¸‹é¢æ˜¯å•ä¸»æœºç§»é™¤æ­¥éª¤ # æŸ¥çœ‹ç«¯å£ID neutron port-list| grep 192.168.83.15 | ea065e6c-65d9-457b-a68e-282653c890e5 | | 9f83fb35aed1422588096b578cc01341 | fa:16:3e:bd:41:81 | {\u0026#34;subnet_id\u0026#34;: \u0026#34;710ffde5-d820-4a30-afe2-1dfd6f40e288\u0026#34;, \u0026#34;ip_address\u0026#34;: \u0026#34;192.168.83.15\u0026#34;} | # ç§»é™¤å®‰å…¨ç»„ neutron port-update --no-security-groups ea065e6c-65d9-457b-a68e-282653c890e5 Updated port: ea065e6c-65d9-457b-a68e-282653c890e5 # å…³é—­ç«¯å£å®‰å…¨ç»„ neutron port-update ea065e6c-65d9-457b-a68e-282653c890e5 --port-security-enabled=False Updated port: ea065e6c-65d9-457b-a68e-282653c890e5 # æŸ¥çœ‹çŠ¶æ€ neutron port-show fcf46a43-5a72-4a28-8e57-1eb04ae24c42 +-----------------------+--------------------------------------------------------------------------------------+ | Field | Value | +-----------------------+--------------------------------------------------------------------------------------+ | admin_state_up | True | | allowed_address_pairs | | | binding:host_id | compute6.openstack.fjf | | binding:profile | {} | | binding:vif_details | {\u0026#34;port_filter\u0026#34;: true} | | binding:vif_type | bridge | | binding:vnic_type | normal | | created_at | 2021-07-01T10:13:32Z | | description | | | device_id | 0a10a372-95fa-4b95-a036-ee43675f1ff4 | | device_owner | compute:nova | | extra_dhcp_opts | | | fixed_ips | {\u0026#34;subnet_id\u0026#34;: \u0026#34;710ffde5-d820-4a30-afe2-1dfd6f40e288\u0026#34;, \u0026#34;ip_address\u0026#34;: \u0026#34;192.168.83.22\u0026#34;} | | id | fcf46a43-5a72-4a28-8e57-1eb04ae24c42 | | mac_address | fa:16:3e:3f:1d:a8 | | name | | | network_id | 02a8d505-af1e-4da5-af08-ed5ea7600293 | | port_security_enabled | False | # æ­¤é¡¹ä¸ºFalseåˆ™ä»£è¡¨ç«¯å£å®‰å…¨ç»„å…³é—­ | project_id | 9f83fb35aed1422588096b578cc01341 | | revision_number | 10 | | security_groups | | # æ­¤é¡¹å¿…é¡»ä¸ºç©º | status | ACTIVE | | tags | | | tenant_id | 9f83fb35aed1422588096b578cc01341 | | updated_at | 2021-07-01T10:13:42Z | +-----------------------+--------------------------------------------------------------------------------------+ éƒ¨ç½²haproxy+keepalived [192.168.83.15,192.168.83.26]å®‰è£…haproxy+keepalived\n1 yum -y install haproxy keepalived [192.168.83.15,192.168.83.26]é…ç½®haproxy\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 cat \u0026gt; /etc/haproxy/haproxy.cfg \u0026lt;\u0026lt;EOF global log 127.0.0.1 local2 chroot /var/lib/haproxy pidfile /var/run/haproxy.pid maxconn 4000 user haproxy group haproxy daemon stats socket /var/lib/haproxy/stats defaults mode http log global option httplog option dontlognull option http-server-close option forwardfor except 127.0.0.0/8 option redispatch retries 3 timeout http-request 10s timeout queue 1m timeout connect 10s timeout client 1m timeout server 1m timeout http-keep-alive 10s timeout check 10s maxconn 5000 defaults mode tcp option redispatch option abortonclose timeout connect 5000s timeout client 50000s timeout server 50000s log 127.0.0.1 local0 balance roundrobin maxconn 50000 listen admin_stats 0.0.0.0:50101 mode http stats uri / stats realm Global\\ statistics stats auth haproxy:password stats hide-version stats admin if TRUE listen KubeApi bind 0.0.0.0:6443 mode tcp server KubeMaster1 192.168.83.36:6443 weight 1 check port 6443 inter 12000 rise 1 fall 3 server KubeMaster2 192.168.83.54:6443 weight 1 check port 6443 inter 12000 rise 1 fall 3 server KubeMaster3 192.168.83.49:6443 weight 1 check port 6443 inter 12000 rise 1 fall 3 EOF [192.168.83.15]é…ç½®keepalived\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 cat \u0026gt; /etc/keepalived/keepalived.conf \u0026lt;\u0026lt;EOF ! Configuration File for keepalived global_defs { router_id LVS_DEVEL vrrp_skip_check_adv_addr vrrp_strict vrrp_garp_interval 0 vrrp_gna_interval 0 } vrrp_instance VI_1 { state MASTER interface eth0 virtual_router_id 52 priority 100 advert_int 1 authentication { auth_type PASS auth_pass test-pass } virtual_ipaddress { 192.168.83.3 } } EOF [192.168.83.26]é…ç½®keepalived\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 cat \u0026gt; /etc/keepalived/keepalived.conf \u0026lt;\u0026lt;EOF ! Configuration File for keepalived global_defs { router_id LVS_DEVEL vrrp_skip_check_adv_addr vrrp_strict vrrp_garp_interval 0 vrrp_gna_interval 0 } vrrp_instance VI_1 { state BACKUP # ä¸masterå€¼ä¸åŒ interface eth0 virtual_router_id 52 priority 99 # ä¸masterå€¼ä¸åŒ advert_int 1 authentication { auth_type PASS auth_pass test-pass } virtual_ipaddress { 192.168.83.3 } } EOF [192.168.83.15,192.168.83.26]å¯åŠ¨æœåŠ¡\n1 2 3 4 systemctl start haproxy keepalived systemctl enable haproxy keepalived Created symlink from /etc/systemd/system/multi-user.target.wants/haproxy.service to /usr/lib/systemd/system/haproxy.service. Created symlink from /etc/systemd/system/multi-user.target.wants/keepalived.service to /usr/lib/systemd/system/keepalived.service. æŸ¥çœ‹ç®¡ç†åå°ï¼Œhttp://192.168.83.3:50101/ï¼Œè´¦å·å¯†ç åœ¨haproxyé…ç½®æ–‡ä»¶ä¸­stats authå­—æ®µã€‚ æ­¤æ—¶æ‰€æœ‰åç«¯å¤„äºDownçš„çŠ¶æ€å±äºæ­£å¸¸æƒ…å†µï¼Œå› ä¸ºkubernetes masterèŠ‚ç‚¹è¿˜æ²¡æœ‰éƒ¨ç½² éƒ¨ç½²kubernetes master [192.168.83.36,192.168.83.54,192.168.83.49]æ·»åŠ Yumæº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # ç§»é™¤å¯èƒ½å­˜åœ¨çš„ç»„ä»¶ yum remove docker docker-common docker-selinux docker-engine # å®‰è£…ä¸€äº›ä¾èµ– yum install -y yum-utils device-mapper-persistent-data lvm2 # é…ç½®Docker CE æº wget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo sudo sed -i \u0026#39;s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+\u0026#39; /etc/yum.repos.d/docker-ce.repo # Kubernetes cat \u0026gt; /etc/yum.repos.d/kubernetes.repo \u0026lt;\u0026lt;EOF [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/ enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF # é‡å»ºç¼“å­˜ yum makecache fast [192.168.83.36,192.168.83.54,192.168.83.49]å®‰è£…\n1 yum -y install docker-ce kubelet-1.23.1 kubeadm-1.23.1 kubectl-1.23.1 [192.168.83.36,192.168.83.54,192.168.83.49]æ·»åŠ dockeré…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 mkdir /etc/docker cat \u0026gt; /etc/docker/daemon.json \u0026lt;\u0026lt;EOF { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;https://xxxxxx.mirror.aliyuncs.com\u0026#34;], \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;], \u0026#34;log-driver\u0026#34;: \u0026#34;json-file\u0026#34;, \u0026#34;log-opts\u0026#34;: { \u0026#34;max-size\u0026#34;: \u0026#34;100m\u0026#34;, \u0026#34;max-file\u0026#34;: \u0026#34;10\u0026#34; }, \u0026#34;oom-score-adjust\u0026#34;: -1000, \u0026#34;live-restore\u0026#34;: true } EOF [192.168.83.36,192.168.83.54,192.168.83.49]å¯åŠ¨æœåŠ¡\n1 2 3 4 systemctl start docker kubelet systemctl enable docker kubelet Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service. Created symlink from /etc/systemd/system/multi-user.target.wants/kubelet.service to /usr/lib/systemd/system/kubelet.service. [192.168.83.36]åˆ›å»ºé›†ç¾¤åˆå§‹åŒ–é…ç½®æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 cat \u0026gt; /etc/kubernetes/kubeadm-config.yaml \u0026lt;\u0026lt;EOF apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration kubernetesVersion: stable controlPlaneEndpoint: \u0026#34;192.168.83.3:6443\u0026#34; #VIPï¼Œæµ®åŠ¨IPï¼Œç«¯å£å›ºå®š6443ä¸è¦ä¿®æ”¹ kubernetesVersion: v1.15.0 networking: podSubnet: 172.15.0.0/16 serviceSubnet: 172.16.0.0/16 dnsDomain: k8s-test.fjf # é»˜è®¤å€¼ï¼šcluster.local,åœ¨ä½¿ç”¨svcç½‘ç»œæ˜¯å¯ä»¥ä½¿ç”¨æ­¤åç¼€,éœ€è¦dnsæŒ‡å®šåˆ°k8så†…éƒ¨dnsæ‰èƒ½å®Œæˆè§£æ EOF [192.168.83.36,192.168.83.54,192.168.83.49]æ‰‹åŠ¨ä¸‹è½½é•œåƒï¼ŒåŠ é€Ÿé›†ç¾¤åˆå§‹åŒ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 KUBE_VERSION=v1.15.0 KUBE_PAUSE_VERSION=3.1 ETCD_VERSION=3.3.10 CORE_DNS_VERSION=1.3.1 GCR_URL=k8s.gcr.io ALIYUN_URL=registry.cn-hangzhou.aliyuncs.com/google_containers images=(kube-proxy:${KUBE_VERSION} kube-scheduler:${KUBE_VERSION} kube-controller-manager:${KUBE_VERSION} kube-apiserver:${KUBE_VERSION} pause:${KUBE_PAUSE_VERSION} etcd:${ETCD_VERSION} coredns:${CORE_DNS_VERSION}) for imageName in ${images[@]} ; do docker pull $ALIYUN_URL/$imageName docker tag $ALIYUN_URL/$imageName $GCR_URL/$imageName docker rmi $ALIYUN_URL/$imageName done [192.168.83.36]åˆå§‹åŒ–é›†ç¾¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 # --upload-certs ç”¨äºä¸Šä¼ è¯ä¹¦åˆ°é›†ç¾¤ï¼Œå…¶ä»–èŠ‚ç‚¹å°±ä¸éœ€è¦æ‰‹åŠ¨å¤åˆ¶è¯ä¹¦äº† # tee kubeadm-init.log ä¿å­˜å±å¹•è¾“å‡ºä¿¡æ¯ï¼Œåé¢èŠ‚ç‚¹åŠ å…¥éœ€è¦æ­¤ä¿¡æ¯ kubeadm init --config=/etc/kubernetes/kubeadm-config.yaml --upload-certs | tee kubeadm-init.log # ä»¥ä¸‹ï¼Œè¾“å‡ºä¿¡æ¯ W0705 18:04:22.814808 11579 strict.go:54] error unmarshaling configuration schema.GroupVersionKind{Group:\u0026#34;kubeadm.k8s.io\u0026#34;, Version:\u0026#34;v1beta2\u0026#34;, Kind:\u0026#34;ClusterConfiguration\u0026#34;}: error converting YAML to JSON: yaml: unmarshal errors: line 5: key \u0026#34;kubernetesVersion\u0026#34; already set in map [init] Using Kubernetes version: v1.15.0 [preflight] Running pre-flight checks [WARNING SystemVerification]: this Docker version is not on the list of validated versions: 20.10.7. Latest validated version: 18.09 [WARNING Hostname]: hostname \u0026#34;k8s-test-master-1.fjf\u0026#34; could not be reached [WARNING Hostname]: hostname \u0026#34;k8s-test-master-1.fjf\u0026#34;: lookup k8s-test-master-1.fjf on 192.168.81.10:53: no such host [preflight] Pulling images required for setting up a Kubernetes cluster [preflight] This might take a minute or two, depending on the speed of your internet connection [preflight] You can also perform this action in beforehand using \u0026#39;kubeadm config images pull\u0026#39; [kubelet-start] Writing kubelet environment file with flags to file \u0026#34;/var/lib/kubelet/kubeadm-flags.env\u0026#34; [kubelet-start] Writing kubelet configuration to file \u0026#34;/var/lib/kubelet/config.yaml\u0026#34; [kubelet-start] Activating the kubelet service [certs] Using certificateDir folder \u0026#34;/etc/kubernetes/pki\u0026#34; [certs] Generating \u0026#34;etcd/ca\u0026#34; certificate and key [certs] Generating \u0026#34;apiserver-etcd-client\u0026#34; certificate and key [certs] Generating \u0026#34;etcd/server\u0026#34; certificate and key [certs] etcd/server serving cert is signed for DNS names [k8s-test-master-1.fjf localhost] and IPs [192.168.83.36 127.0.0.1 ::1] [certs] Generating \u0026#34;etcd/peer\u0026#34; certificate and key [certs] etcd/peer serving cert is signed for DNS names [k8s-test-master-1.fjf localhost] and IPs [192.168.83.36 127.0.0.1 ::1] [certs] Generating \u0026#34;etcd/healthcheck-client\u0026#34; certificate and key [certs] Generating \u0026#34;ca\u0026#34; certificate and key [certs] Generating \u0026#34;apiserver-kubelet-client\u0026#34; certificate and key [certs] Generating \u0026#34;apiserver\u0026#34; certificate and key [certs] apiserver serving cert is signed for DNS names [k8s-test-master-1.fjf kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.k8s-test.fjf] and IPs [172.16.0.1 192.168.83.36 192.168.83.3] [certs] Generating \u0026#34;front-proxy-ca\u0026#34; certificate and key [certs] Generating \u0026#34;front-proxy-client\u0026#34; certificate and key [certs] Generating \u0026#34;sa\u0026#34; key and public key [kubeconfig] Using kubeconfig folder \u0026#34;/etc/kubernetes\u0026#34; [kubeconfig] Writing \u0026#34;admin.conf\u0026#34; kubeconfig file [kubeconfig] Writing \u0026#34;kubelet.conf\u0026#34; kubeconfig file [kubeconfig] Writing \u0026#34;controller-manager.conf\u0026#34; kubeconfig file [kubeconfig] Writing \u0026#34;scheduler.conf\u0026#34; kubeconfig file [control-plane] Using manifest folder \u0026#34;/etc/kubernetes/manifests\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-apiserver\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-controller-manager\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-scheduler\u0026#34; [etcd] Creating static Pod manifest for local etcd in \u0026#34;/etc/kubernetes/manifests\u0026#34; [wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \u0026#34;/etc/kubernetes/manifests\u0026#34;. This can take up to 4m0s [apiclient] All control plane components are healthy after 18.005364 seconds [upload-config] Storing the configuration used in ConfigMap \u0026#34;kubeadm-config\u0026#34; in the \u0026#34;kube-system\u0026#34; Namespace [kubelet] Creating a ConfigMap \u0026#34;kubelet-config-1.15\u0026#34; in namespace kube-system with the configuration for the kubelets in the cluster [upload-certs] Storing the certificates in Secret \u0026#34;kubeadm-certs\u0026#34; in the \u0026#34;kube-system\u0026#34; Namespace [upload-certs] Using certificate key: d3123a4998a8715f1c12830d7d54a63aa790fcf3da0cf4b5e7514cd7ffd6e200 [mark-control-plane] Marking the node k8s-test-master-1.fjf as control-plane by adding the label \u0026#34;node-role.kubernetes.io/master=\u0026#39;\u0026#39;\u0026#34; [mark-control-plane] Marking the node k8s-test-master-1.fjf as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule] [bootstrap-token] Using token: mpzs9m.oec6ixeesemzbxle [bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials [bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token [bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster [bootstrap-token] Creating the \u0026#34;cluster-info\u0026#34; ConfigMap in the \u0026#34;kube-public\u0026#34; namespace [addons] Applied essential addon: CoreDNS [addons] Applied essential addon: kube-proxy Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run \u0026#34;kubectl apply -f [podnetwork].yaml\u0026#34; with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ You can now join any number of the control-plane node running the following command on each as root: # MasteråŠ å…¥ kubeadm join 192.168.83.3:6443 --token mpzs9m.oec6ixeesemzbxle \\ --discovery-token-ca-cert-hash sha256:7c05c8001693061902d6f20947fbc60c1b6a12e9ded449e6c59a71e6448fac5d \\ --experimental-control-plane --certificate-key d3123a4998a8715f1c12830d7d54a63aa790fcf3da0cf4b5e7514cd7ffd6e200 Please note that the certificate-key gives access to cluster sensitive data, keep it secret! As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use \u0026#34;kubeadm init phase upload-certs --upload-certs\u0026#34; to reload certs afterward. Then you can join any number of worker nodes by running the following on each as root: # WorkerèŠ‚ç‚¹æ¥å…¥ kubeadm join 192.168.83.3:6443 --token mpzs9m.oec6ixeesemzbxle \\ --discovery-token-ca-cert-hash sha256:7c05c8001693061902d6f20947fbc60c1b6a12e9ded449e6c59a71e6448fac5d [192.168.83.54,192.168.83.49]å…¶ä»–masterèŠ‚ç‚¹åŠ å…¥é›†ç¾¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 # æ­¤å‘½ä»¤ç›´æ¥å¤åˆ¶ä¸Šä¸€æ­¥è¾“å‡ºçš„ç»“æœå°±å¯ä»¥äº†ï¼Œæ³¨æ„åŒºåˆ†masterèŠ‚ç‚¹å’ŒworkerèŠ‚ç‚¹çš„æŒ‡ä»¤æ˜¯ä¸åŒçš„ kubeadm join 192.168.83.3:6443 --token mpzs9m.oec6ixeesemzbxle \\ --discovery-token-ca-cert-hash sha256:7c05c8001693061902d6f20947fbc60c1b6a12e9ded449e6c59a71e6448fac5d \\ --experimental-control-plane --certificate-key d3123a4998a8715f1c12830d7d54a63aa790fcf3da0cf4b5e7514cd7ffd6e200 # ä»¥ä¸‹ï¼Œè¾“å‡ºä¿¡æ¯ Flag --experimental-control-plane has been deprecated, use --control-plane instead [preflight] Running pre-flight checks [WARNING SystemVerification]: this Docker version is not on the list of validated versions: 20.10.7. Latest validated version: 18.09 [WARNING Hostname]: hostname \u0026#34;k8s-test-master-2.fjf\u0026#34; could not be reached [WARNING Hostname]: hostname \u0026#34;k8s-test-master-2.fjf\u0026#34;: lookup k8s-test-master-2.fjf on 192.168.81.10:53: no such host [preflight] Reading configuration from the cluster... [preflight] FYI: You can look at this config file with \u0026#39;kubectl -n kube-system get cm kubeadm-config -oyaml\u0026#39; [preflight] Running pre-flight checks before initializing the new control plane instance [preflight] Pulling images required for setting up a Kubernetes cluster [preflight] This might take a minute or two, depending on the speed of your internet connection [preflight] You can also perform this action in beforehand using \u0026#39;kubeadm config images pull\u0026#39; [download-certs] Downloading the certificates in Secret \u0026#34;kubeadm-certs\u0026#34; in the \u0026#34;kube-system\u0026#34; Namespace [certs] Using certificateDir folder \u0026#34;/etc/kubernetes/pki\u0026#34; [certs] Generating \u0026#34;etcd/server\u0026#34; certificate and key [certs] etcd/server serving cert is signed for DNS names [k8s-test-master-2.fjf localhost] and IPs [192.168.83.54 127.0.0.1 ::1] [certs] Generating \u0026#34;etcd/peer\u0026#34; certificate and key [certs] etcd/peer serving cert is signed for DNS names [k8s-test-master-2.fjf localhost] and IPs [192.168.83.54 127.0.0.1 ::1] [certs] Generating \u0026#34;etcd/healthcheck-client\u0026#34; certificate and key [certs] Generating \u0026#34;apiserver-etcd-client\u0026#34; certificate and key [certs] Generating \u0026#34;apiserver-kubelet-client\u0026#34; certificate and key [certs] Generating \u0026#34;apiserver\u0026#34; certificate and key [certs] apiserver serving cert is signed for DNS names [k8s-test-master-2.fjf kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.k8s-test.fjf] and IPs [172.16.0.1 192.168.83.54 192.168.83.3] [certs] Generating \u0026#34;front-proxy-client\u0026#34; certificate and key [certs] Valid certificates and keys now exist in \u0026#34;/etc/kubernetes/pki\u0026#34; [certs] Using the existing \u0026#34;sa\u0026#34; key [kubeconfig] Generating kubeconfig files [kubeconfig] Using kubeconfig folder \u0026#34;/etc/kubernetes\u0026#34; [kubeconfig] Writing \u0026#34;admin.conf\u0026#34; kubeconfig file [kubeconfig] Writing \u0026#34;controller-manager.conf\u0026#34; kubeconfig file [kubeconfig] Writing \u0026#34;scheduler.conf\u0026#34; kubeconfig file [control-plane] Using manifest folder \u0026#34;/etc/kubernetes/manifests\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-apiserver\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-controller-manager\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-scheduler\u0026#34; [check-etcd] Checking that the etcd cluster is healthy [kubelet-start] Downloading configuration for the kubelet from the \u0026#34;kubelet-config-1.15\u0026#34; ConfigMap in the kube-system namespace [kubelet-start] Writing kubelet configuration to file \u0026#34;/var/lib/kubelet/config.yaml\u0026#34; [kubelet-start] Writing kubelet environment file with flags to file \u0026#34;/var/lib/kubelet/kubeadm-flags.env\u0026#34; [kubelet-start] Activating the kubelet service [kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap... [etcd] Announced new etcd member joining to the existing etcd cluster [etcd] Wrote Static Pod manifest for a local etcd member to \u0026#34;/etc/kubernetes/manifests/etcd.yaml\u0026#34; [etcd] Waiting for the new etcd member to join the cluster. This can take up to 40s [upload-config] Storing the configuration used in ConfigMap \u0026#34;kubeadm-config\u0026#34; in the \u0026#34;kube-system\u0026#34; Namespace [mark-control-plane] Marking the node k8s-test-master-2.fjf as control-plane by adding the label \u0026#34;node-role.kubernetes.io/master=\u0026#39;\u0026#39;\u0026#34; [mark-control-plane] Marking the node k8s-test-master-2.fjf as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule] This node has joined the cluster and a new control plane instance was created: * Certificate signing request was sent to apiserver and approval was received. * The Kubelet was informed of the new secure connection details. * Control plane (master) label and taint were applied to the new node. * The Kubernetes control plane instances scaled up. * A new etcd member was added to the local/stacked etcd cluster. To start administering your cluster from this node, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Run \u0026#39;kubectl get nodes\u0026#39; to see this node join the cluster. [192.168.83.36,192.168.83.54,192.168.83.49]åˆ›å»ºé›†ç¾¤é…ç½®æ–‡ä»¶\n1 2 3 mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config æ£€æŸ¥é›†ç¾¤çŠ¶æ€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 kubectl get node NAME STATUS ROLES AGE VERSION k8s-test-master-1.fjf NotReady master 7m19s v1.15.0 k8s-test-master-2.fjf NotReady master 112s v1.15.0 k8s-test-master-3.fjf NotReady master 62s v1.15.0 kubectl get pod -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system coredns-5c98db65d4-6kxg6 0/1 Pending 0 7m30s # PendingçŠ¶æ€æ­£å¸¸ï¼Œåœ¨å®‰è£…ç½‘ç»œç»„ä»¶åå³å¯æ¢å¤ kube-system coredns-5c98db65d4-x6x4b 0/1 Pending 0 7m30s # PendingçŠ¶æ€æ­£å¸¸ï¼Œåœ¨å®‰è£…ç½‘ç»œç»„ä»¶åå³å¯æ¢å¤ kube-system etcd-k8s-test-master-1.fjf 1/1 Running 0 6m37s kube-system etcd-k8s-test-master-2.fjf 1/1 Running 0 2m22s kube-system etcd-k8s-test-master-3.fjf 1/1 Running 0 93s kube-system kube-apiserver-k8s-test-master-1.fjf 1/1 Running 0 6m31s kube-system kube-apiserver-k8s-test-master-2.fjf 1/1 Running 0 2m22s kube-system kube-apiserver-k8s-test-master-3.fjf 1/1 Running 1 91s kube-system kube-controller-manager-k8s-test-master-1.fjf 1/1 Running 1 6m47s kube-system kube-controller-manager-k8s-test-master-2.fjf 1/1 Running 0 2m22s kube-system kube-controller-manager-k8s-test-master-3.fjf 1/1 Running 0 22s kube-system kube-proxy-hrfgq 1/1 Running 0 2m23s kube-system kube-proxy-nlm68 1/1 Running 0 93s kube-system kube-proxy-tt8dg 1/1 Running 0 7m30s kube-system kube-scheduler-k8s-test-master-1.fjf 1/1 Running 1 6m28s kube-system kube-scheduler-k8s-test-master-2.fjf 1/1 Running 0 2m22s kube-system kube-scheduler-k8s-test-master-3.fjf 1/1 Running 0 21s æŸ¥çœ‹ç®¡ç†åå°ï¼Œhttp://192.168.83.3:50101/ï¼Œè´¦å·å¯†ç åœ¨haproxyé…ç½®æ–‡ä»¶ä¸­stats authå­—æ®µã€‚ æ‰€æœ‰MasterèŠ‚ç‚¹çŠ¶æ€ä¸ºUPåˆ™ä¸ºæ­£å¸¸ï¼Œå¦‚æœä¸æ˜¯ï¼Œæ£€æŸ¥å‰é¢çš„æ­¥éª¤æ˜¯å¦å…¨éƒ¨å®Œæˆï¼Œå¹¶ä¸”è¾“å‡ºå†…å®¹ä¸€è‡´ éƒ¨ç½²kubernetes ç½‘ç»œç»„ä»¶ ç›®å‰ä¸»è¦æ”¯æŒçš„CNIç»„ä»¶ CNIæ’ä»¶ï¼šFlannelã€Calicoã€Weaveå’ŒCanal(æŠ€æœ¯ä¸Šæ˜¯å¤šä¸ªæ’ä»¶çš„ç»„åˆ) æœ¬æ¬¡éƒ¨ç½²ï¼Œä½¿ç”¨Calicoç»„ä»¶ï¼Œå¯ä»¥ä½¿ç”¨æ”¹ç»„ä»¶çš„BGPåŠŸèƒ½ä¸å†…ç½‘æ‰“é€šPodå’ŒSVCç½‘ç»œ\nåœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²Calicoï¼Œåœ¨ä»»ä¸€MasterèŠ‚ç‚¹æ‰§è¡Œå³å¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # ä¸‹è½½calicoéƒ¨ç½²æ–‡ä»¶ wget https://docs.projectcalico.org/v3.8/manifests/calico.yaml # ä¿®æ”¹CIDR - name: CALICO_IPV4POOL_CIDR value: \u0026#34;172.15.0.0/16\u0026#34; #ä¿®æ”¹ä¸ºPodçš„ç½‘ç»œ # éƒ¨ç½²calico kubectl apply -f calico.yaml # ä»¥ä¸‹ä¸ºè¾“å‡º configmap/calico-config created customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created clusterrole.rbac.authorization.k8s.io/calico-node created clusterrolebinding.rbac.authorization.k8s.io/calico-node created daemonset.apps/calico-node created serviceaccount/calico-node created deployment.apps/calico-kube-controllers created serviceaccount/calico-kube-controllers created ç­‰å¾…CNIç”Ÿæ•ˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 watch kubectl get pods --all-namespaces # æ‰€æœ‰PodçŠ¶æ€ä¸ºRunningåå³å¯é€€å‡º Every 2.0s: kubectl get pods --all-namespaces Mon Jul 5 18:49:49 2021 NAMESPACE NAME READY STATUS RESTARTS AGE kube-system calico-kube-controllers-7fc57b95d4-wsvpm 1/1 Running 0 85s kube-system calico-node-7f99k 0/1 Running 0 85s kube-system calico-node-jssb6 0/1 Running 0 85s kube-system calico-node-qgvp9 1/1 Running 0 85s kube-system coredns-5c98db65d4-6kxg6 1/1 Running 0 44m kube-system coredns-5c98db65d4-x6x4b 1/1 Running 0 44m kube-system etcd-k8s-test-master-1.fjf 1/1 Running 0 43m kube-system etcd-k8s-test-master-2.fjf 1/1 Running 0 39m kube-system etcd-k8s-test-master-3.fjf 1/1 Running 0 38m kube-system kube-apiserver-k8s-test-master-1.fjf 1/1 Running 0 43m kube-system kube-apiserver-k8s-test-master-2.fjf 1/1 Running 0 39m kube-system kube-apiserver-k8s-test-master-3.fjf 1/1 Running 1 38m kube-system kube-controller-manager-k8s-test-master-1.fjf 1/1 Running 1 44m kube-system kube-controller-manager-k8s-test-master-2.fjf 1/1 Running 0 39m kube-system kube-controller-manager-k8s-test-master-3.fjf 1/1 Running 0 37m kube-system kube-proxy-hrfgq 1/1 Running 0 39m kube-system kube-proxy-nlm68 1/1 Running 0 38m kube-system kube-proxy-tt8dg 1/1 Running 0 44m kube-system kube-scheduler-k8s-test-master-1.fjf 1/1 Running 1 43m kube-system kube-scheduler-k8s-test-master-2.fjf 1/1 Running 0 39m kube-system kube-scheduler-k8s-test-master-3.fjf 1/1 Running 0 37m æŸ¥çœ‹CoreDNSçŠ¶æ€æ˜¯å¦æ¢å¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 kubectl get pod -A -owide NAMESPACE NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES kube-system calico-kube-controllers-7fc57b95d4-zxc4d 1/1 Running 0 88s 172.15.139.1 k8s-test-master-1.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system calico-node-24j88 1/1 Running 0 89s 192.168.83.36 k8s-test-master-1.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system calico-node-49vnk 1/1 Running 0 89s 192.168.83.54 k8s-test-master-2.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system calico-node-vzjk8 1/1 Running 0 89s 192.168.83.49 k8s-test-master-3.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system coredns-5c98db65d4-frfx7 1/1 Running 0 16s 172.15.159.129 k8s-test-master-2.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; # çŠ¶æ€å·²ç»ä¸ºRunning kube-system coredns-5c98db65d4-tt9w5 1/1 Running 0 27s 172.15.221.1 k8s-test-master-3.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; # çŠ¶æ€å·²ç»ä¸ºRunning kube-system etcd-k8s-test-master-1.fjf 1/1 Running 0 48m 192.168.83.36 k8s-test-master-1.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system etcd-k8s-test-master-2.fjf 1/1 Running 0 44m 192.168.83.54 k8s-test-master-2.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system etcd-k8s-test-master-3.fjf 1/1 Running 0 43m 192.168.83.49 k8s-test-master-3.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-apiserver-k8s-test-master-1.fjf 1/1 Running 0 48m 192.168.83.36 k8s-test-master-1.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-apiserver-k8s-test-master-2.fjf 1/1 Running 0 44m 192.168.83.54 k8s-test-master-2.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-apiserver-k8s-test-master-3.fjf 1/1 Running 1 43m 192.168.83.49 k8s-test-master-3.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-controller-manager-k8s-test-master-1.fjf 1/1 Running 1 48m 192.168.83.36 k8s-test-master-1.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-controller-manager-k8s-test-master-2.fjf 1/1 Running 0 44m 192.168.83.54 k8s-test-master-2.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-controller-manager-k8s-test-master-3.fjf 1/1 Running 0 42m 192.168.83.49 k8s-test-master-3.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-proxy-hrfgq 1/1 Running 0 44m 192.168.83.54 k8s-test-master-2.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-proxy-nlm68 1/1 Running 0 43m 192.168.83.49 k8s-test-master-3.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-proxy-tt8dg 1/1 Running 0 49m 192.168.83.36 k8s-test-master-1.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-scheduler-k8s-test-master-1.fjf 1/1 Running 1 48m 192.168.83.36 k8s-test-master-1.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-scheduler-k8s-test-master-2.fjf 1/1 Running 0 44m 192.168.83.54 k8s-test-master-2.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-system kube-scheduler-k8s-test-master-3.fjf 1/1 Running 0 42m 192.168.83.49 k8s-test-master-3.fjf \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; éƒ¨ç½²kuberntes node [192.168.83.52,192.168.83.22,192.168.83.37]æ·»åŠ Yumæº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # ç§»é™¤å¯èƒ½å­˜åœ¨çš„ç»„ä»¶ yum remove docker docker-common docker-selinux docker-engine # å®‰è£…ä¸€äº›ä¾èµ– yum install -y yum-utils device-mapper-persistent-data lvm2 # é…ç½®Docker CE æº wget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo sudo sed -i \u0026#39;s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+\u0026#39; /etc/yum.repos.d/docker-ce.repo # Kubernetes cat \u0026gt; /etc/yum.repos.d/kubernetes.repo \u0026lt;\u0026lt;EOF [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/ enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF # é‡å»ºç¼“å­˜ yum makecache fast [192.168.83.52,192.168.83.22,192.168.83.37]å®‰è£…\n1 2 3 yum -y install kubelet-1.23.1 kubeadm-1.23.1 kubectl-1.23.1 yum install -y docker-ce-18.09.9 docker-ce-cli-18.09.9 containerd.io [192.168.83.52,192.168.83.22,192.168.83.37]æ·»åŠ dockeré…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 mkdir /etc/docker cat \u0026gt; /etc/docker/daemon.json \u0026lt;\u0026lt;EOF { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;https://h3klxkkx.mirror.aliyuncs.com\u0026#34;], \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;], \u0026#34;log-driver\u0026#34;: \u0026#34;json-file\u0026#34;, \u0026#34;log-opts\u0026#34;: { \u0026#34;max-size\u0026#34;: \u0026#34;100m\u0026#34;, \u0026#34;max-file\u0026#34;: \u0026#34;10\u0026#34; }, \u0026#34;oom-score-adjust\u0026#34;: -1000, \u0026#34;live-restore\u0026#34;: true } EOF [192.168.83.52,192.168.83.22,192.168.83.37]å¯åŠ¨æœåŠ¡\n1 2 3 4 systemctl start docker kubelet systemctl enable docker kubelet Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service. Created symlink from /etc/systemd/system/multi-user.target.wants/kubelet.service to /usr/lib/systemd/system/kubelet.service. [192.168.83.52,192.168.83.22,192.168.83.37]æ‰‹åŠ¨ä¸‹è½½é•œåƒï¼ŒåŠ é€Ÿé›†ç¾¤åˆå§‹åŒ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 KUBE_VERSION=v1.15.0 KUBE_PAUSE_VERSION=3.1 GCR_URL=k8s.gcr.io ALIYUN_URL=registry.cn-hangzhou.aliyuncs.com/google_containers images=(kube-proxy:${KUBE_VERSION} pause:${KUBE_PAUSE_VERSION}) for imageName in ${images[@]} ; do docker pull $ALIYUN_URL/$imageName docker tag $ALIYUN_URL/$imageName $GCR_URL/$imageName docker rmi $ALIYUN_URL/$imageName done [192.168.83.52,192.168.83.22,192.168.83.37]åŠ å…¥é›†ç¾¤\n1 2 # æ­¤å‘½ä»¤åœ¨åˆå§‹åŒ–Masteré›†ç¾¤æ—¶æœ‰è®°å½•ï¼Œå¦‚æœæ‰¾ä¸åˆ°äº†ï¼Œå¯ä»¥å‚è€ƒ http://wiki.fjf.com/pages/viewpage.action?pageId=14682096 kubeadm join 192.168.83.2:6443 --token wiqtis.k4g3jm9z94qykiyl --discovery-token-ca-cert-hash sha256:2771e3f29b2628edac9c5e1433dff5c3275ab870ad14ca7c9e6adaf1eed3179e åœ¨MasterèŠ‚ç‚¹æŸ¥çœ‹nodeèŠ‚ç‚¹çŠ¶æ€\n1 2 3 4 5 6 7 8 kubectl get node NAME STATUS ROLES AGE VERSION k8s-test-master-1.fjf Ready master 73m v1.15.0 k8s-test-master-2.fjf Ready master 68m v1.15.0 k8s-test-master-3.fjf Ready master 67m v1.15.0 k8s-test-node-1.fjf Ready \u0026lt;none\u0026gt; 75s v1.15.0 #çŠ¶æ€ä¸ºReadyå³ä¸ºæˆåŠŸåŠ å…¥é›†ç¾¤ k8s-test-node-2.fjf Ready \u0026lt;none\u0026gt; 63s v1.15.0 #çŠ¶æ€ä¸ºReadyå³ä¸ºæˆåŠŸåŠ å…¥é›†ç¾¤ k8s-test-node-3.fjf Ready \u0026lt;none\u0026gt; 59s v1.15.0 #çŠ¶æ€ä¸ºReadyå³ä¸ºæˆåŠŸåŠ å…¥é›†ç¾¤ ä½¿ç”¨Calicoæ‰“é€šPodç½‘ç»œ ç°çŠ¶ é›†ç¾¤å†…pod\u0026amp;nodeå¯ä»¥é€šè¿‡pod ipç›´æ¥è¿›è¡Œè®¿é—®ï¼Œå®¹å™¨è®¿é—®è™šæ‹Ÿæœºæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯è™šæ‹Ÿæœºä¸èƒ½è®¿é—®å®¹å™¨ï¼Œå°¤å…¶æ˜¯é€šè¿‡consulæ³¨å†Œçš„æœåŠ¡ï¼Œå¿…é¡»æ‰“é€šç½‘ç»œåæ‰å¯ä»¥äº’ç›¸è°ƒç”¨\nç›®æ ‡ æ‰“é€špodå’Œè™šæ‹Ÿæœºçš„ç½‘ç»œï¼Œä½¿è™šæ‹Ÿæœºå¯ä»¥è®¿é—®pod ip å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.projectcalico.org/archive/v3.8/networking/bgp\n[Kubernetes MasterèŠ‚ç‚¹]å®‰è£…calicoæ§åˆ¶å‘½ä»¤calicoctl\n1 2 3 curl -O -L https://github.com/projectcalico/calicoctl/releases/download/v3.8.9/calicoctl chmod +x calicoctl mv calicoctl /usr/bin/calicoctl [calicoctlå®‰è£…èŠ‚ç‚¹]æ·»åŠ calicoé…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 mkdir /etc/calico cat \u0026gt; /etc/calico/calicoctl.cfg \u0026lt;\u0026lt;EOF apiVersion: projectcalico.org/v3 kind: CalicoAPIConfig metadata: spec: datastoreType: \u0026#34;kubernetes\u0026#34; kubeconfig: \u0026#34;/root/.kube/config\u0026#34; EOF # æµ‹è¯• calicoctl version Client Version: v3.8.9 Git commit: 0991d2fb Cluster Version: v3.8.9 # å‡ºç°æ­¤è¡Œä»£è¡¨é…ç½®æ­£ç¡® Cluster Type: k8s,bgp,kdd # å‡ºç°æ­¤è¡Œä»£è¡¨é…ç½®æ­£ç¡® [calicoctlå®‰è£…èŠ‚ç‚¹]é…ç½®é›†ç¾¤è·¯ç”±åå°„å™¨ï¼ŒnodeèŠ‚ç‚¹ä¸masterèŠ‚ç‚¹å¯¹ç­‰ã€masterèŠ‚ç‚¹å½¼æ­¤å¯¹ç­‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 # åœ¨æœ¬ç¯å¢ƒä¸‹å°†kubernetes masterèŠ‚ç‚¹ä½œä¸ºåå°„å™¨ä½¿ç”¨ # æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ kubectl get node NAME STATUS ROLES AGE VERSION k8s-test-master-1.fjf Ready master 3d1h v1.15.0 k8s-test-master-2.fjf Ready master 3d1h v1.15.0 k8s-test-master-3.fjf Ready master 3d1h v1.15.0 k8s-test-node-1.fjf Ready \u0026lt;none\u0026gt; 2d23h v1.15.0 k8s-test-node-2.fjf Ready \u0026lt;none\u0026gt; 2d23h v1.15.0 k8s-test-node-3.fjf Ready \u0026lt;none\u0026gt; 2d23h v1.15.0 # å¯¼å‡ºMasterèŠ‚ç‚¹é…ç½® calicoctl get node k8s-test-master-1.fjf --export -o yaml \u0026gt; k8s-test-master-1.yml calicoctl get node k8s-test-master-2.fjf --export -o yaml \u0026gt; k8s-test-master-2.yml calicoctl get node k8s-test-master-3.fjf --export -o yaml \u0026gt; k8s-test-master-3.yml # åœ¨3ä¸ªMasterèŠ‚ç‚¹é…ç½®ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ç”¨äºæ ‡è¯†è¯¥èŠ‚ç‚¹ä¸ºåå°„å™¨ metadata: ...... labels: ...... i-am-a-route-reflector: true ...... spec: bgp: ...... routeReflectorClusterID: 224.0.0.1 # æ›´æ–°èŠ‚ç‚¹é…ç½® calicoctl apply -f k8s-test-master-1.yml calicoctl apply -f k8s-test-master-2.yml calicoctl apply -f k8s-test-master-3.yml # å…¶ä»–èŠ‚ç‚¹ä¸åå°„å™¨å¯¹ç­‰ calicoctl apply -f - \u0026lt;\u0026lt;EOF kind: BGPPeer apiVersion: projectcalico.org/v3 metadata: name: peer-to-rrs spec: nodeSelector: \u0026#34;!has(i-am-a-route-reflector)\u0026#34; peerSelector: has(i-am-a-route-reflector) EOF # åå°„å™¨å½¼æ­¤å¯¹ç­‰ calicoctl apply -f - \u0026lt;\u0026lt;EOF kind: BGPPeer apiVersion: projectcalico.org/v3 metadata: name: rr-mesh spec: nodeSelector: has(i-am-a-route-reflector) peerSelector: has(i-am-a-route-reflector) EOF [calicoctlå®‰è£…èŠ‚ç‚¹]é…ç½®MasterèŠ‚ç‚¹ä¸æ ¸å¿ƒäº¤æ¢æœºå¯¹ç­‰\n1 2 3 4 5 6 7 8 9 10 11 12 calicoctl apply -f - \u0026lt;\u0026lt;EOF apiVersion: projectcalico.org/v3 kind: BGPPeer metadata: name: rr-border spec: nodeSelector: has(i-am-a-route-reflector) peerIP: 192.168.83.1 asNumber: 64512 EOF # peerIP: æ ¸å¿ƒäº¤æ¢æœºIP # asNumber: ç”¨äºå’Œæ ¸å¿ƒäº¤æ¢æœºå¯¹ç­‰çš„ID [192.168.83.1,è®¾å¤‡å‹å·ï¼šcisco 3650]é…ç½®æ ¸å¿ƒäº¤æ¢ä¸Master(åå°„å™¨)èŠ‚ç‚¹å¯¹ç­‰ï¼Œè¿™ä¸€æ­¥éœ€è¦åœ¨å¯¹ç«¯BGPè®¾å¤‡ä¸Šæ“ä½œï¼Œè¿™é‡Œæ˜¯ç”¨æ ¸å¿ƒäº¤æ¢æœº\n1 2 3 4 5 router bgp 64512 bgp router-id 192.168.83.1 neighbor 192.168.83.36 remote-as 64512 neighbor 192.168.83.49 remote-as 64512 neighbor 192.168.83.54 remote-as 64512 æŸ¥çœ‹BGP å¯¹ç­‰çŠ¶æ€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 calicoctl node status # INFOå­—æ®µå…¨éƒ¨ä¸ºEstablished å³ä¸ºæ­£å¸¸ Calico process is running. IPv4 BGP status +---------------+---------------+-------+----------+-------------+ | PEER ADDRESS | PEER TYPE | STATE | SINCE | INFO | +---------------+---------------+-------+----------+-------------+ | 192.168.83.1 | node specific | up | 06:38:55 | Established | | 192.168.83.54 | node specific | up | 06:38:55 | Established | | 192.168.83.22 | node specific | up | 06:38:55 | Established | | 192.168.83.37 | node specific | up | 06:38:55 | Established | | 192.168.83.49 | node specific | up | 06:38:55 | Established | | 192.168.83.52 | node specific | up | 06:38:55 | Established | +---------------+---------------+-------+----------+-------------+ IPv6 BGP status No IPv6 peers found. æµ‹è¯•ï¼Œä½¿ç”¨å…¶ä»–ç½‘æ®µï¼Œå¦‚192.168.82.0/24çš„è™šæ‹Ÿæœºping æŸä¸€ä¸ªpod ipï¼Œèƒ½æ­£å¸¸é€šä¿¡å³ä»£è¡¨æˆåŠŸ\n1 2 3 4 5 6 7 8 9 10 [dev][root@spring-boot-demo1-192.168.82.85 ~]# ping -c 3 172.15.190.2 PING 172.15.190.2 (172.15.190.2) 56(84) bytes of data. 64 bytes from 172.15.190.2: icmp_seq=1 ttl=62 time=0.677 ms 64 bytes from 172.15.190.2: icmp_seq=2 ttl=62 time=0.543 ms 64 bytes from 172.15.190.2: icmp_seq=3 ttl=62 time=0.549 ms --- 172.15.190.2 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2000ms rtt min/avg/max/mdev = 0.543/0.589/0.677/0.067 ms [dev][root@spring-boot-demo1-192.168.82.85 ~]# ä½¿ç”¨Calicoæ‰“é€šSvcç½‘ç»œ ç°çŠ¶ ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒKuberntesé›†ç¾¤æš´éœ²æœåŠ¡çš„æ–¹å¼æœ‰Ingressã€NodePortã€HostNetworkï¼Œè¿™å‡ ç§æ–¹å¼ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå®‰å…¨æ€§å’Œç¨³å®šæ€§æœ‰ä¿éšœã€‚ä½†æ˜¯åœ¨å†…éƒ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨èµ·æ¥å°±æœ‰è¯¸å¤šä¸ä¾¿ï¼Œå¼€å‘å¸Œæœ›å¯ä»¥ç›´æ¥è®¿é—®è‡ªå·±çš„æœåŠ¡ï¼Œä½†æ˜¯Pod IPåˆæ˜¯éšæœºå˜åŒ–çš„ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨SVC IP æˆ–è€…SVC Nameè¿›è¡Œè®¿é—®\nç›®æ ‡ æ‰“é€šSVCç½‘ç»œï¼Œä½¿å¼€å‘æœ¬åœ°å¯ä»¥é€šè¿‡SVC IP æˆ– SVC Nameè®¿é—®é›†ç¾¤æœåŠ¡ å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.projectcalico.org/archive/v3.8/networking/service-advertisement æ³¨æ„ï¼šå‰ææ˜¯å·²ç»ç”¨BGPæ‰“é€šäº†Podç½‘ç»œæˆ–å·²ç»å»ºç«‹äº†BGPå¯¹ç­‰æ‰å¯ä»¥ç»§ç»­è¿›è¡Œ\n[Kubernetes Master]ç¡®å®šSVCç½‘ç»œä¿¡æ¯\n1 2 3 4 5 kubectl cluster-info dump|grep -i \u0026#34;service-cluster-ip-range\u0026#34; # ä»¥ä¸‹ä¸ºè¾“å‡º \u0026#34;--service-cluster-ip-range=172.16.0.0/16\u0026#34;, \u0026#34;--service-cluster-ip-range=172.16.0.0/16\u0026#34;, \u0026#34;--service-cluster-ip-range=172.16.0.0/16\u0026#34;, [Kubernetes Master]å¯ç”¨SVCç½‘ç»œå¹¿æ’­\n1 2 3 4 kubectl patch ds -n kube-system calico-node --patch \\ \u0026#39;{\u0026#34;spec\u0026#34;: {\u0026#34;template\u0026#34;: {\u0026#34;spec\u0026#34;: {\u0026#34;containers\u0026#34;: [{\u0026#34;name\u0026#34;: \u0026#34;calico-node\u0026#34;, \u0026#34;env\u0026#34;: [{\u0026#34;name\u0026#34;: \u0026#34;CALICO_ADVERTISE_CLUSTER_IPS\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;172.16.0.0/16\u0026#34;}]}]}}}}\u0026#39; # ä»¥ä¸‹ä¸ºè¾“å‡º daemonset.extensions/calico-node patched æµ‹è¯•ï¼Œæ­£å¸¸æƒ…å†µä¸‹å¯ç”¨BGPå¹¿æ’­åï¼Œ3åˆ†é’Ÿå†…æ ¸å¿ƒäº¤æ¢å³å¯æ¥æ”¶åˆ°è·¯ç”±ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # æ‰¾åˆ°é›†ç¾¤DNSæœåŠ¡è¿›è¡Œæµ‹è¯• kubectl get svc kube-dns -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kube-dns ClusterIP 172.16.0.10 \u0026lt;none\u0026gt; 53/UDP,53/TCP,9153/TCP 3d21h # æ‰¾ä¸€ä¸ªPod IPåœ¨é›†ç¾¤å¤–è¿›è¡Œè§£ææµ‹è¯•ï¼Œå¦‚æœå¯ä»¥è§£æåˆ°ç»“æœè¯´æ˜SVCç½‘ç»œå·²ç»æ‰“é€š [dev][root@spring-boot-demo1-192.168.82.85 ~]# dig -x 172.15.190.2 @172.16.0.10 ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.9.4-RedHat-9.9.4-61.el7_5.1 \u0026lt;\u0026lt;\u0026gt;\u0026gt; -x 172.15.190.2 @172.16.0.10 ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 23212 ;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ;; QUESTION SECTION: ;2.190.15.172.in-addr.arpa. IN PTR ;; ANSWER SECTION: 2.190.15.172.in-addr.arpa. 30 IN PTR 172-15-190-2.ingress-nginx.ingress-nginx.svc.k8s-test.fjf. # å¯ä»¥æ­£å¸¸è§£æåˆ°ä¸»æœºè®°å½• ;; Query time: 3 msec ;; SERVER: 172.16.0.10#53(172.16.0.10) ;; WHEN: Fri Jul 09 15:26:55 CST 2021 ;; MSG SIZE rcvd: 150 ","date":"2024-09-09T15:43:46Z","image":"https://www.ownit.top/title_pic/48.jpg","permalink":"https://www.ownit.top/p/202409091543/","title":"Kuberneteséƒ¨ç½²(haproxy+keepalived)é«˜å¯ç”¨ç¯å¢ƒå’ŒåŠå…¬ç½‘ç»œæ‰“é€š"},{"content":"é¡¹ç›®èƒŒæ™¯ åœ¨äº‘è®¡ç®—å’Œå®¹å™¨æŠ€æœ¯é£é€Ÿå‘å±•çš„ä»Šå¤©ï¼ŒKubernetes å·²ç»æˆä¸ºå®¹å™¨ç¼–æ’å’Œç®¡ç†çš„äº‹å®æ ‡å‡†ã€‚ç„¶è€Œï¼Œéšç€ä¸šåŠ¡çš„ä¸æ–­æ‰©å±•ï¼Œå¦‚ä½•åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸‹ä¿æŠ¤å’Œè¿ç§» Kubernetes é›†ç¾¤èµ„æºï¼Œæˆä¸ºäº†æ‘†åœ¨è¿ç»´äººå‘˜é¢å‰çš„ä¸€å¤§æŒ‘æˆ˜ã€‚Veleroï¼Œä½œä¸ºä¸€æ¬¾äº‘åŸç”Ÿçš„ç¾éš¾æ¢å¤å’Œè¿ç§»å·¥å…·ï¼Œä»¥å…¶å¼ºå¤§çš„åŠŸèƒ½å’Œçµæ´»çš„ä½¿ç”¨æ–¹å¼ï¼Œä¸º Kubernetes é›†ç¾¤çš„æ•°æ®å®‰å…¨æä¾›äº†åšå®çš„ä¿éšœã€‚\nç¯å¢ƒä»‹ç» æœ¬æ–‡å°†åŸºäºä¸€ä¸ªå…¸å‹çš„äº‘åŸç”Ÿç¯å¢ƒï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨ Velero è¿›è¡Œ Kubernetes é›†ç¾¤çš„å¤‡ä»½ä¸è¿ç§»\nKubernetesï¼šv1.23.1 Veleroï¼š1.11 å¼€æºåœ°å€ï¼šhttps://github.com/vmware-tanzu/velero å®˜æ–¹æ–‡æ¡£ï¼šhttps://velero.io/docs/v1.11/\næ”¯æŒçš„ç‰ˆæœ¬åˆ—è¡¨ ç»„ä»¶ä»‹ç» Veleroç»„ä»¶ Velero ç»„ä»¶ä¸€å…±åˆ†ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ã€‚\næœåŠ¡ç«¯ï¼šè¿è¡Œåœ¨ä½  Kubernetes çš„é›†ç¾¤ä¸­ å®¢æˆ·ç«¯ï¼šæ˜¯ä¸€äº›è¿è¡Œåœ¨æœ¬åœ°çš„å‘½ä»¤è¡Œçš„å·¥å…·ï¼Œéœ€è¦å·²é…ç½®å¥½ kubectl åŠé›†ç¾¤ kubeconfig çš„æœºå™¨ä¸Š veleroå¤‡ä»½æµç¨‹ Velero å®¢æˆ·ç«¯ å‘é€ API è¯·æ±‚è‡³ Kubernetes API Serverï¼Œåˆ›å»ºå¤‡ä»½ä»»åŠ¡ã€‚ Kubernetes API Server æ¥æ”¶å¹¶å¤„ç† Velero å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œåˆ›å»ºå¤‡ä»½ä»»åŠ¡ï¼ŒåŒæ—¶é€šè¿‡ Watch æœºåˆ¶é€šçŸ¥ç›¸å…³çš„æ§åˆ¶å™¨ã€‚ Backup æ§åˆ¶å™¨ é€šè¿‡ Watch æœºåˆ¶ç›‘å¬ API Serverï¼Œè·å–å¤‡ä»½ä»»åŠ¡åï¼Œå‘ API Server è¯·æ±‚éœ€è¦å¤‡ä»½çš„æ•°æ®ã€‚ å¯¹è±¡å­˜å‚¨æœåŠ¡å™¨ Backup æ§åˆ¶å™¨å°†ä» API Server è·å–çš„æ•°æ®å¤‡ä»½è‡³æŒ‡å®šçš„å¯¹è±¡å­˜å‚¨æœåŠ¡å™¨ã€‚ Velero åç«¯å­˜å‚¨ Velero æ”¯æŒä¸¤ç§ç”¨äºé…ç½®åç«¯å­˜å‚¨çš„è‡ªå®šä¹‰èµ„æºå®šä¹‰ (CRD)ï¼Œåˆ†åˆ«æ˜¯ BackupStorageLocation å’Œ VolumeSnapshotLocationã€‚\nBackupStorageLocation BackupStorageLocation ä¸»è¦ç”¨äºå®šä¹‰ Kubernetes é›†ç¾¤èµ„æºçš„å¤‡ä»½å­˜å‚¨ä½ç½®ï¼Œé’ˆå¯¹çš„æ˜¯é›†ç¾¤å¯¹è±¡æ•°æ®ï¼Œè€ŒéæŒä¹…åŒ–å· (PVC) çš„æ•°æ®ã€‚è¯¥å­˜å‚¨é€šå¸¸æ˜¯ S3 å…¼å®¹çš„å¯¹è±¡å­˜å‚¨ï¼Œå¦‚ MinIOã€é˜¿é‡Œäº‘ OSS ç­‰ã€‚\nVolumeSnapshotLocation VolumeSnapshotLocation ä¸»è¦ç”¨äºå¯¹æŒä¹…åŒ–å· (PV) è¿›è¡Œå¿«ç…§å¤‡ä»½ï¼Œè¿™è¦æ±‚äº‘æä¾›å•†æä¾›ç›¸åº”çš„æ’ä»¶ã€‚é˜¿é‡Œäº‘å·²ç»æä¾›äº†è¯¥æ’ä»¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ CSI (å®¹å™¨å­˜å‚¨æ¥å£) ç­‰å­˜å‚¨æœºåˆ¶æ¥è¿›è¡Œ PV çš„å¿«ç…§å¤‡ä»½ã€‚æ­¤å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥ä½¿ç”¨ä¸“é—¨çš„å¤‡ä»½å·¥å…· Resticï¼Œå°† PV çš„æ•°æ®å¤‡ä»½åˆ°é˜¿é‡Œäº‘ OSSï¼ˆå®‰è£… Velero æ—¶å¯ä»¥é€‰æ‹©è‡ªå®šä¹‰è¯¥é€‰é¡¹ï¼‰ã€‚\nRestic æ˜¯ä¸€æ¬¾ GO è¯­è¨€å¼€å‘çš„æ•°æ®åŠ å¯†å¤‡ä»½å·¥å…·ï¼Œé¡¾åæ€ä¹‰ï¼Œå¯ä»¥å°†æœ¬åœ°æ•°æ®åŠ å¯†åä¼ è¾“åˆ°æŒ‡å®šçš„ä»“åº“ã€‚æ”¯æŒçš„ä»“åº“æœ‰ Localã€SFTPã€Aws S3ã€Minioã€OpenStack Swiftã€Backblaze B2ã€Azure BSã€Google Cloud storageã€Rest Serverã€‚\nveleroå®¢æˆ·ç«¯ åœ¨ Github Release é¡µé¢ä¸‹è½½æŒ‡å®šçš„ velero äºŒè¿›åˆ¶å®¢æˆ·ç«¯å®‰è£…åŒ…ï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬ä¸‹è½½æˆ‘ä»¬k8sé›†ç¾¤å¯¹åº”çš„ç‰ˆæœ¬ä¸º v1.11.1 ç‰ˆæœ¬åˆ—è¡¨ï¼šhttps://github.com/vmware-tanzu/velero/releases\nå®‰è£…veleroå®¢æˆ·ç«¯ 1 2 3 4 5 6 7 $ wget https://github.com/vmware-tanzu/velero/releases/download/v1.11.1/velero-v1.11.1-linux-amd64.tar.gz $ tar zxf velero-v1.11.1-linux-amd64.tar.gz $ mv velero-v1.11.1-linux-amd64/velero /usr/bin/ $ velero -h # å¯ç”¨å‘½ä»¤è¡¥å…¨ $ source \u0026lt;(velero completion bash) $ velero completion bash \u0026gt; /etc/bash_completion.d/velero å®‰è£…minio Veleroæ”¯æŒå¾ˆå¤šç§å­˜å‚¨æ’ä»¶ï¼Œå¯æŸ¥çœ‹ï¼šVelero Docs - Providersè·å–æ’ä»¶ä¿¡æ¯ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨minioä½œä¸ºS3å…¼å®¹çš„å¯¹è±¡å­˜å‚¨æä¾›ç¨‹åºã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨ä»»æ„åœ°æ–¹éƒ¨ç½²Minioå¯¹è±¡å­˜å‚¨ï¼Œåªéœ€è¦ä¿è¯K8Sé›†ç¾¤å¯ä»¥è®¿é—®åˆ°å³å¯ã€‚ minio.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 --- apiVersion: v1 kind: Namespace metadata: name: velero --- apiVersion: apps/v1 kind: Deployment metadata: namespace: velero name: minio labels: component: minio spec: strategy: type: Recreate selector: matchLabels: component: minio template: metadata: labels: component: minio spec: volumes: - name: storage emptyDir: {} - name: config emptyDir: {} containers: - name: minio image: minio/minio:latest imagePullPolicy: IfNotPresent args: - server - /storage - --config-dir=/config - --console-address=:9001 env: - name: MINIO_ACCESS_KEY value: \u0026#34;minio\u0026#34; - name: MINIO_SECRET_KEY value: \u0026#34;minio123\u0026#34; ports: - containerPort: 9000 volumeMounts: - name: storage mountPath: \u0026#34;/storage\u0026#34; - name: config mountPath: \u0026#34;/config\u0026#34; --- apiVersion: v1 kind: Service metadata: namespace: velero name: minio labels: component: minio spec: # ClusterIP is recommended for production environments. # Change to NodePort if needed per documentation, # but only if you run Minio in a test/trial environment, for example with Minikube. type: NodePort ports: - name: api port: 9000 targetPort: 9000 nodePort: 32000 - name: console port: 9001 targetPort: 9001 nodePort: 32001 selector: component: minio --- apiVersion: batch/v1 kind: Job metadata: namespace: velero name: minio-setup labels: component: minio spec: template: metadata: name: minio-setup spec: restartPolicy: OnFailure volumes: - name: config emptyDir: {} containers: - name: mc image: minio/mc:latest imagePullPolicy: IfNotPresent command: - /bin/sh - -c - \u0026#34;mc --config-dir=/config config host add velero http://minio:9000 minio minio123 \u0026amp;\u0026amp; mc --config-dir=/config mb -p velero/velero\u0026#34; volumeMounts: - name: config mountPath: \u0026#34;/config\u0026#34; åˆ›å»ºminioåº”ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # åˆ›å»ºveleroå‘½åç©ºé—´ $ kubectl create namespace velero # åˆ›å»ºminioèµ„æº $ kubectl apply -f minio.yaml # æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€ [root@bt velero]# kubectl get sts,pod,svc -n velero NAME READY STATUS RESTARTS AGE pod/minio-78f994f86c-4t9lw 1/1 Running 0 27h pod/minio-setup-d7vbl 0/1 Completed 4 27h pod/node-agent-6z5mn 1/1 Running 0 27h pod/node-agent-8kjcm 1/1 Running 0 27h pod/node-agent-k8zbk 1/1 Running 0 27h pod/velero-85dd87c457-mz5jm 1/1 Running 0 27h NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/minio NodePort 172.21.25.69 \u0026lt;none\u0026gt; 9000:32000/TCP,9001:32001/TCP 27h # å¼€æ”¾NodePortç«¯å£ $ kubectl patch svc minio -n velero -p \u0026#39;{\u0026#34;spec\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;NodePort\u0026#34;}}\u0026#39; $ kubectl patch svc minio -n velero --type=\u0026#39;json\u0026#39; -p=\u0026#39;[{\u0026#34;op\u0026#34;: \u0026#34;replace\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/spec/ports/0/nodePort\u0026#34;, \u0026#34;value\u0026#34;:9000},{\u0026#34;op\u0026#34;: \u0026#34;replace\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/spec/ports/1/nodePort\u0026#34;, \u0026#34;value\u0026#34;:9001}]\u0026#39; [root@bt velero]# kubectl get svc -n velero NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE minio NodePort 172.21.25.69 \u0026lt;none\u0026gt; 9000:32000/TCP,9001:32001/TCP 27h é€šè¿‡æµè§ˆå™¨è®¿é—®æœåŠ¡å™¨IP:30282ï¼Œå¹¶ä½¿ç”¨è´¦å·minioå¯†ç minio123ç™»å…¥éªŒè¯ã€‚ velero æœåŠ¡ç«¯ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ velero å®¢æˆ·ç«¯æ¥å®‰è£…æœåŠ¡ç«¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Helm Chart æ¥è¿›è¡Œå®‰è£…ï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬ç”¨å®¢æˆ·ç«¯æ¥å®‰è£…ï¼Œvelero å‘½ä»¤é»˜è®¤è¯»å– kubectl é…ç½®çš„é›†ç¾¤ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥å‰ææ˜¯ velero å®¢æˆ·ç«¯æ‰€åœ¨çš„èŠ‚ç‚¹æœ‰å¯è®¿é—®é›†ç¾¤çš„ kubeconfig é…ç½®ã€‚\nåˆ›å»ºå¯†é’¥ é¦–å…ˆå‡†å¤‡å¯†é’¥æ–‡ä»¶ï¼Œåœ¨å½“å‰ç›®å½•å»ºç«‹ä¸€ä¸ªç©ºç™½æ–‡æœ¬æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 $ cat \u0026gt; credentials-velero \u0026lt;\u0026lt;EOF [default] aws_access_key_id = minio aws_secret_access_key = minio123 EOF å®‰è£…veleroåˆ°k8sé›†ç¾¤ æ›¿æ¢ä¸ºä¹‹å‰æ­¥éª¤ä¸­ minio çš„å¯¹åº” access key id å’Œ secret access keyå¦‚æœ minio å®‰è£…åœ¨ kubernetes é›†ç¾¤å†…æ—¶æŒ‰ç…§å¦‚ä¸‹å‘½ä»¤å®‰è£… velero æœåŠ¡ç«¯:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 $ velero install \\ --provider aws \\ --image velero/velero:v1.11.1 \\ --plugins velero/velero-plugin-for-aws:v1.7.1 \\ --bucket velero \\ --secret-file ./credentials-velero \\ --use-node-agent \\ --use-volume-snapshots=false \\ --namespace velero \\ --backup-location-config region=minio,s3ForcePathStyle=\u0026#34;true\u0026#34;,s3Url=http://minio:9000 \\ --wait # æ‰§è¡Œinstallå‘½ä»¤åä¼šåˆ›å»ºä¸€ç³»åˆ—æ¸…å•ï¼ŒåŒ…æ‹¬CustomResourceDefinitionã€Namespaceã€Deploymentç­‰ã€‚ # velero install .... --dry-run -o yaml \u0026gt; velero_deploy.yaml å¦‚æœä¸ºç§ä»“ï¼Œå¯ä»¥é€šè¿‡--dry-run å¯¼å‡º YAML æ–‡ä»¶è°ƒæ•´åœ¨åº”ç”¨ã€‚ # å¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹è¿è¡Œæ—¥å¿— $ kubectl logs deployment/velero -n velero # æŸ¥çœ‹veleroåˆ›å»ºçš„apiå¯¹è±¡ $ kubectl api-versions | grep velero velero.io/v1 # æŸ¥çœ‹å¤‡ä»½ä½ç½® $ velero backup-location get NAME PROVIDER BUCKET/PREFIX PHASE LAST VALIDATED ACCESS MODE DEFAULT default aws velero Available 2024-08-16 14:42:38 +0800 CST ReadWrite true #å¸è½½å‘½ä»¤ # velero uninstall --namespace velero You are about to uninstall Velero. Are you sure you want to continue (Y/N)? y Waiting for velero namespace \u0026#34;velero\u0026#34; to be deleted ............................................................................................................................................................................................ Velero namespace \u0026#34;velero\u0026#34; deleted Velero uninstalled â›µ é€‰é¡¹è¯´æ˜ï¼š\n--kubeconfig(å¯é€‰)ï¼šæŒ‡å®škubeconfigè®¤è¯æ–‡ä»¶ï¼Œé»˜è®¤ä½¿ç”¨.kube/configï¼› --providerï¼šå®šä¹‰æ’ä»¶æä¾›æ–¹ï¼› --imageï¼šå®šä¹‰è¿è¡Œveleroçš„é•œåƒï¼Œé»˜è®¤ä¸veleroå®¢æˆ·ç«¯ä¸€è‡´ï¼› --pluginsï¼šæŒ‡å®šä½¿ç”¨aws s3å…¼å®¹çš„æ’ä»¶é•œåƒï¼› --bucketï¼šæŒ‡å®šå¯¹è±¡å­˜å‚¨Bucketæ¡¶åç§°ï¼› --secret-fileï¼šæŒ‡å®šå¯¹è±¡å­˜å‚¨è®¤è¯æ–‡ä»¶ï¼› --use-node-agentï¼šåˆ›å»ºVelero Node Agentå®ˆæŠ¤è¿›ç¨‹ï¼Œæ‰˜ç®¡FSBæ¨¡å—ï¼› --use-volume-snapshotsï¼šæ˜¯å¦å¯ä½¿ç”¨å¿«ç…§ï¼› --namespaceï¼šæŒ‡å®šéƒ¨ç½²çš„namespaceåç§°ï¼Œé»˜è®¤ä¸ºveleroï¼› --backup-location-configï¼šæŒ‡å®šå¯¹è±¡å­˜å‚¨åœ°å€ä¿¡æ¯ï¼› awsæ’ä»¶ä¸veleroç‰ˆæœ¬å¯¹åº”å…³ç³»ï¼š å¸è½½velero å¦‚æœæ‚¨æƒ³ä»é›†ç¾¤ä¸­å®Œå…¨å¸è½½Veleroï¼Œåˆ™ä»¥ä¸‹å‘½ä»¤å°†åˆ é™¤ç”±velero installåˆ›å»ºçš„æ‰€æœ‰èµ„æº:\n1 2 kubectl delete namespace/velero clusterrolebinding/velero kubectl delete crds -l component=velero å¤‡ä»½ä¸æ¢å¤ å¤‡ä»½å‘½ä»¤ï¼švelero create backup NAME [flags] backupé€‰é¡¹ï¼š\n--exclude-namespaces stringArray : è¦ä»å¤‡ä»½ä¸­æ’é™¤çš„åç§°ç©ºé—´ --exclude-resources stringArray: è¦ä»å¤‡ä»½ä¸­æ’é™¤çš„èµ„æºï¼Œå¦‚storageclasses.storage.k8s.io --include-cluster-resources optionalBool[=true]: åŒ…å«é›†ç¾¤èµ„æºç±»å‹ --include-namespaces stringArray: è¦åŒ…å«åœ¨å¤‡ä»½ä¸­çš„åç§°ç©ºé—´(é»˜è®¤\u0026rsquo;*') --include-resources stringArray: å¤‡ä»½ä¸­è¦åŒ…æ‹¬çš„èµ„æº --labels mapStringString: ç»™è¿™ä¸ªå¤‡ä»½åŠ ä¸Šæ ‡ç­¾ -o, --output string: æŒ‡å®šè¾“å‡ºæ ¼å¼ï¼Œæ”¯æŒ\u0026rsquo;table\u0026rsquo;ã€\u0026lsquo;json\u0026rsquo;å’Œ\u0026rsquo;yaml\u0026rsquo;ï¼› -l, --selector labelSelector: å¯¹æŒ‡å®šæ ‡ç­¾çš„èµ„æºè¿›è¡Œå¤‡ä»½ --snapshot-volumes optionalBool[=true]: å¯¹ PV åˆ›å»ºå¿«ç…§ --storage-location string: æŒ‡å®šå¤‡ä»½çš„ä½ç½® --ttl duration: å¤‡ä»½æ•°æ®å¤šä¹…åˆ æ‰ --volume-snapshot-locations strings: æŒ‡å®šå¿«ç…§çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯å“ªä¸€ä¸ªå…¬æœ‰äº‘é©±åŠ¨ ä½¿ç”¨å®˜æ–¹æ¡ˆä¾‹åˆ›å»ºæµ‹è¯•åº”ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 $ kubectl apply -f examples/nginx-app/base.yaml namespace/nginx-example created deployment.apps/nginx-deployment created service/my-nginx created # æŸ¥çœ‹èµ„æºæ¸…å• $ kubectl get all -n nginx-example NAME READY STATUS RESTARTS AGE pod/nginx-deployment-5c844b66c8-t5l9z 1/1 Running 0 27h pod/nginx-deployment-5c844b66c8-vlkqj 1/1 Running 0 27h NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/my-nginx LoadBalancer 172.21.18.168 192.168.102.51 80:31831/TCP 27h NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deployment 2/2 2 2 27h NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-deployment-5c844b66c8 2 2 2 27h å¤‡ä»½æµ‹è¯•åº”ç”¨ 1 2 3 $ velero backup create nginx-backup --include-namespaces nginx-example Backup request \u0026#34;nginx-backup\u0026#34; submitted successfully. Run `velero backup describe nginx-backup` or `velero backup logs nginx-backup` for more details. é€‰é¡¹ï¼š\n--include-namespacesï¼šæŒ‡å®šå‘½åç©ºé—´ --selectorï¼šæ ‡ç­¾é€‰æ‹©å™¨ï¼Œå¦‚app=nginx æŸ¥çœ‹å¤‡ä»½åˆ—è¡¨ 1 2 3 4 5 6 7 8 9 10 $ velero backup get NAME STATUS ERRORS WARNINGS CREATED EXPIRES STORAGE LOCATION SELECTOR nginx-backup Completed 0 0 2024-08-15 11:17:18 +0800 CST 28d default \u0026lt;none\u0026gt; # æŸ¥çœ‹å¤‡ä»½è¯¦ç»†ä¿¡æ¯ $ velero backup describe nginx-backup # æŸ¥çœ‹å¤‡ä»½æ—¥å¿— $ velero backup logs nginx-backup ç™»å…¥minioæ§åˆ¶å°æŸ¥çœ‹å¤‡ä»½å†…å®¹ å®šæ—¶å¤‡ä»½æŒ‡å— 1 2 3 4 5 6 7 8 # ä½¿ç”¨cronè¡¨è¾¾å¼å¤‡ä»½ $ velero schedule create nginx-daily --schedule=\u0026#34;0 1 * * *\u0026#34; --include-namespaces nginx-example # ä½¿ç”¨ä¸€äº›éæ ‡å‡†çš„é€Ÿè®° cron è¡¨è¾¾å¼ $ velero schedule create nginx-daily --schedule=\u0026#34;@daily\u0026#34; --include-namespaces nginx-example # æ‰‹åŠ¨è§¦å‘å®šæ—¶ä»»åŠ¡ $ velero backup create --from-schedule nginx-daily æ›´å¤šcronç¤ºä¾‹è¯·å‚è€ƒï¼šcron packageâ€™s documentation\næ¢å¤ æ¨¡æ‹Ÿç¾éš¾\n1 2 3 4 5 # åˆ é™¤nginx-exampleå‘½åç©ºé—´å’Œèµ„æº $ kubectl delete namespace nginx-example # æ£€æŸ¥æ˜¯å¦åˆ é™¤ $ kubectl get all -n nginx-example No resources found in nginx-example namespace. æ¢å¤èµ„æº\n1 2 3 4 5 6 7 $ velero backup get NAME STATUS ERRORS WARNINGS CREATED EXPIRES STORAGE LOCATION SELECTOR nginx-backup Completed 0 0 2024-04-06 21:47:16 +0800 CST 29d default \u0026lt;none\u0026gt; $ velero restore create --from-backup nginx-backup Restore request \u0026#34;nginx-backup-20240406215611\u0026#34; submitted successfully. Run `velero restore describe nginx-backup-20240406215611` or `velero restore logs nginx-backup-20240406215611` for more details. æ£€æŸ¥æ¢å¤çš„èµ„æº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 $ velero restore get NAME BACKUP STATUS STARTED COMPLETED ERRORS WARNINGS CREATED SELECTOR nginx-backup-20240406215611 nginx-backup Completed 2024-04-06 21:56:11 +0800 CST 2024-04-06 21:56:12 +0800 CST 0 2 2024-04-06 21:56:11 +0800 CST \u0026lt;none\u0026gt; # æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ $ velero restore describe nginx-backup-20240406215611 # æ£€æŸ¥èµ„æºçŠ¶æ€ $ kubectl get all -n nginx-example NAME READY STATUS RESTARTS AGE pod/nginx-deployment-5c844b66c8-t5l9z 1/1 Running 0 27h pod/nginx-deployment-5c844b66c8-vlkqj 1/1 Running 0 27h NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/my-nginx LoadBalancer 172.21.18.168 192.168.102.51 80:31831/TCP 27h NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deployment 2/2 2 2 27h NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-deployment-5c844b66c8 2 2 2 27h å‚è€ƒ: https://www.cnblogs.com/nf01/p/18118159 https://github.com/vmware-tanzu/velero https://velero.io/docs/v1.11/\n","date":"2024-08-16T15:19:11Z","image":"https://www.ownit.top/title_pic/60.jpg","permalink":"https://www.ownit.top/p/202408161519/","title":"äº‘åŸç”Ÿæ—¶ä»£çš„æ•°æ®å®ˆæŠ¤è€…ï¼šVelero å¤‡ä»½ä¸è¿ç§»å®æˆ˜"},{"content":"èƒŒæ™¯ï¼š åœ¨ç°ä»£ä¼ä¸šä¸­ï¼Œè·¨åœ°åŒºçš„åŠå…¬å®¤å’Œæ•°æ®ä¸­å¿ƒä¹‹é—´çš„äº’è”äº’é€šæ˜¯éå¸¸å¸¸è§çš„éœ€æ±‚ã€‚ä¼ä¸šå¯èƒ½æ‹¥æœ‰å¤šä¸ªåˆ†æ”¯æœºæ„ã€æ•°æ®ä¸­å¿ƒï¼ˆIDCï¼‰ï¼Œè¿™äº›åœ°ç‚¹éœ€è¦é€šè¿‡å¯é çš„ç½‘ç»œè¿æ¥è¿›è¡Œæ•°æ®ä¼ è¾“ã€èµ„æºå…±äº«å’Œè¿œç¨‹ç®¡ç†ã€‚ä¼ ç»Ÿä¸Šï¼Œä¼ä¸šå¯èƒ½ä¼šé€‰æ‹©ç§Ÿç”¨ä¸“çº¿æ¥è¿æ¥ä¸åŒåœ°ç‚¹çš„ç½‘ç»œï¼Œä½†è¿™ç§æ–¹å¼æˆæœ¬è¾ƒé«˜ä¸”å®æ–½å¤æ‚ã€‚ä¸ºäº†åœ¨ä¿æŒå®‰å…¨æ€§å’Œå¯é æ€§çš„åŒæ—¶é™ä½æˆæœ¬ï¼Œè¶Šæ¥è¶Šå¤šçš„ä¼ä¸šé€‰æ‹©ä½¿ç”¨ VPNï¼ˆè™šæ‹Ÿä¸“ç”¨ç½‘ç»œï¼‰æŠ€æœ¯ï¼Œè€Œ OpenVPN æ˜¯å…¶ä¸­ä¸€ç§å¹¿å—æ¬¢è¿çš„è§£å†³æ–¹æ¡ˆã€‚\nOpenVPN æ˜¯ä¸€ä¸ªå¼€æºçš„ VPN è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡åˆ›å»ºåŠ å¯†çš„éš§é“ï¼Œç¡®ä¿ä¸åŒç½‘ç»œä¹‹é—´çš„é€šä¿¡å®‰å…¨æ— è™ã€‚è¿™ç§åŠ å¯†éš§é“ä¸ä»…èƒ½æœ‰æ•ˆä¿æŠ¤æ•°æ®ä¼ è¾“ï¼Œè¿˜èƒ½è®©ä¸åŒåœ°ç†ä½ç½®çš„ç½‘ç»œçœ‹èµ·æ¥åƒæ˜¯åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ï¼ˆLANï¼‰å†…ã€‚è¿™å¯¹äºéœ€è¦è·¨åœ°åŸŸè¿›è¡Œæ•°æ®å…±äº«ã€èµ„æºè®¿é—®å’Œè¿œç¨‹ç®¡ç†çš„ä¼ä¸šæ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„å·¥å…·ã€‚\nå¸¸è§åº”ç”¨åœºæ™¯ åˆ†æ”¯æœºæ„ä¸æ€»éƒ¨çš„ç½‘ç»œäº’é€šï¼š åˆ†æ”¯æœºæ„çš„æ•°æ®éœ€è¦å®æ—¶ä¼ è¾“åˆ°æ€»éƒ¨è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå…¬å¸åœ¨åŒ—äº¬è®¾æœ‰æ€»éƒ¨ï¼Œåœ¨ä¸Šæµ·è®¾æœ‰åˆ†æ”¯æœºæ„ï¼ŒåŒ—äº¬çš„æœåŠ¡å™¨éœ€è¦å®æ—¶æ¥æ”¶å’Œå¤„ç†æ¥è‡ªä¸Šæµ·çš„ä¸šåŠ¡æ•°æ®ã€‚ åŠå…¬å®¤ä¸ IDC æœºæˆ¿çš„ç½‘ç»œäº’é€šï¼š IT è¿ç»´æˆ–æŠ€æœ¯äººå‘˜éœ€è¦ä»åŠå…¬å®¤è¿œç¨‹ç®¡ç†ä½äº IDC æœºæˆ¿çš„æœåŠ¡å™¨ã€‚æ­¤å¤–ï¼ŒIDC å†…çš„æœåŠ¡å™¨ä¹Ÿå¯èƒ½éœ€è¦è®¿é—®åŠå…¬å®¤å†…ç½‘ä¸­çš„èµ„æºã€‚ä¾‹å¦‚ï¼Œè¿ç»´å›¢é˜Ÿåœ¨åŒ—äº¬çš„åŠå…¬å®¤ï¼Œè€ŒæœåŠ¡å™¨éƒ¨ç½²åœ¨ä¸Šæµ·çš„ IDC æœºæˆ¿ä¸­ï¼Œé€šè¿‡ OpenVPNï¼Œå¯ä»¥è®©ä»–ä»¬è½»æ¾è¿œç¨‹ç®¡ç†è¿™äº›æœåŠ¡å™¨ã€‚ ä¸åŒ IDC æœºæˆ¿ä¹‹é—´çš„ç½‘ç»œäº’é€šï¼š ä¸¤ä¸ªæ•°æ®ä¸­å¿ƒä¹‹é—´å¯èƒ½éœ€è¦åŒæ­¥æ•°æ®æˆ–å…±äº«èµ„æºã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªä¼ä¸šåœ¨åŒ—äº¬å’Œä¸Šæµ·éƒ½æ‹¥æœ‰æ•°æ®ä¸­å¿ƒï¼Œä¸ºäº†ç¡®ä¿æ•°æ®çš„é«˜å¯ç”¨æ€§å’Œå®‰å…¨æ€§ï¼Œä»–ä»¬éœ€è¦åœ¨ä¸¤ä¸ªæ•°æ®ä¸­å¿ƒä¹‹é—´å»ºç«‹ä¸€ä¸ªåŠ å¯†çš„è¿æ¥ï¼Œç¡®ä¿æ•°æ®èƒ½å¤Ÿåœ¨ä¸¤ä¸ª IDC ä¹‹é—´å®‰å…¨ä¼ è¾“ã€‚ æˆ‘ä»¬ä½¿ç”¨çš„åœºæ™¯ æˆ‘ä»¬åŒ—äº¬å’Œæ·±åœ³å„æœ‰åˆ†éƒ¨ï¼Œä½†æ˜¯ç”±äºç½‘ç»œåŸå› ï¼Œå¯¼è‡´ä¸¤è¾¹çš„èµ„æºä¸äº’é€šï¼Œç»å¸¸åšä¸€äº›äº‹æƒ…æ•ˆç‡åº•ä¸‹ã€‚ç°åœ¨è¿›è¡Œç½‘ç»œè°ƒæ•´ä¼˜åŒ–ï¼ŒåŒ—äº¬å¯ä»¥è®¿é—®æ·±åœ³ç½‘ç»œï¼Œæ·±åœ³å¯ä»¥è®¿é—®åŒ—äº¬ç½‘ç»œï¼Œè¿™æ ·ç½‘ç»œæ‰“é€šï¼Œèµ„æºå…±äº«æ–¹ä¾¿ï¼Œæœ‰åŠ©äºæé«˜å·¥ä½œæ•ˆç‡å’Œæµç¨‹åŠäº‹é€Ÿåº¦ã€‚\nä¸ºä»€ä¹ˆé€‰æ‹© OpenVPN å®‰å…¨æ€§ï¼š OpenVPN ä½¿ç”¨ SSL/TLS åè®®è¿›è¡ŒåŠ å¯†ï¼Œèƒ½å¤Ÿæä¾›é«˜æ°´å¹³çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«çªƒå–æˆ–ç¯¡æ”¹ã€‚ æˆæœ¬æ•ˆç›Šï¼š ä¸ç§Ÿç”¨ä¸“çº¿ç›¸æ¯”ï¼Œä½¿ç”¨ OpenVPN å¯ä»¥å¤§å¹…é™ä½ä¼ä¸šçš„ç½‘ç»œè¿æ¥æˆæœ¬ã€‚ çµæ´»æ€§ï¼š OpenVPN æ”¯æŒå¤šç§ç½‘ç»œæ¶æ„å’Œé…ç½®ï¼Œèƒ½å¤Ÿé€‚åº”ä¼ä¸šçš„å¤šæ ·åŒ–éœ€æ±‚ã€‚ä¸è®ºæ˜¯é€šè¿‡äº’è”ç½‘è¿æ¥ä¸åŒåœ°ç‚¹ï¼Œè¿˜æ˜¯åœ¨å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸‹å»ºç«‹å¤šç‚¹è¿æ¥ï¼ŒOpenVPN éƒ½èƒ½è½»æ¾åº”å¯¹ã€‚ è·¨å¹³å°æ”¯æŒï¼š OpenVPN å…¼å®¹å¤šç§æ“ä½œç³»ç»Ÿï¼ŒåŒ…æ‹¬ Windowsã€Linuxã€macOS ä»¥åŠå„ç§ç§»åŠ¨è®¾å¤‡ï¼Œç¡®ä¿ä¼ä¸šèƒ½å¤Ÿåœ¨ä¸åŒçš„å¹³å°ä¸Šå®ç°æ— ç¼è¿æ¥ åŒ—äº¬å’Œæ·±åœ³ä¸¤è¾¹ç½‘ç»œåŒå‘äº’é€šæµç¨‹ ç¯å¢ƒé…ç½® ä¸»æœº ip ç”¨é€” openvpnæœåŠ¡ç«¯ï¼ˆæ·±åœ³ï¼‰ 172.17.10.20 openvpn-server openvpn-serverç½‘æ®µæœºå™¨ï¼ˆæ·±åœ³åŠå…¬åŒºåŸŸï¼‰ 172.17.10.21 serveråŒä¸€ç½‘æ®µæœºå™¨ openvpnå®¢æˆ·ç«¯ï¼ˆåŒ—äº¬ï¼‰ 172.17.20.20 openvpn-client openvpn-clientç½‘æ®µæœºå™¨ï¼ˆåŒ—äº¬åŠå…¬åŒºåŸŸï¼‰ 172.17.20.21 clientåŒä¸€ç½‘æ®µæœºå™¨ è™šæ‹ŸIP 10.10.10.0/24 openvpnçš„è™šæ‹ŸIP éƒ¨ç½²æµç¨‹ å®‰è£…openvpnã€easy-rsaã€iptables-server 1 2 yum install epel-* -y yum -y install openvpn easy-rsa iptables-services ç”Ÿæˆè¯ä¹¦åŠç›¸å…³æ–‡ä»¶ åˆ©ç”¨easy-rsaç”Ÿæˆç›¸å…³è¯ä¹¦æ–‡ä»¶\nCAæ ¹è¯ä¹¦\nopenvpnæœåŠ¡å™¨è¯ä¹¦\nDiffie-Hellmanç®—æ³•ç”¨åˆ°çš„key å¤åˆ¶easy-rsaè„šæœ¬åˆ°/etc/openvpnä¸‹é¢ï¼Œè¯¥è„šæœ¬æ˜¯ç”¨æ¥ç”ŸæˆCAè¯ä¹¦å’Œå„ç§keyæ–‡ä»¶\nå¤åˆ¶easy-rsaè„šæœ¬åˆ°/etc/openvpnä¸‹é¢ï¼Œè¯¥è„šæœ¬æ˜¯ç”¨æ¥ç”ŸæˆCAè¯ä¹¦å’Œå„ç§keyæ–‡ä»¶\n1 cp -r /usr/share/easy-rsa/ /etc/openvpn/ 1 2 3 4 5 6 7 8 9 10 11 12 13 [root@openvpn openvpn]# cd /etc/openvpn/easy-rsa/3.0.8/ [root@openvpn 3.0.8]# ls easyrsa openssl-easyrsa.cnf vars x509-types #æ–°å»ºvarsæ–‡ä»¶ï¼Œç¼–è¾‘å˜é‡ï¼Œåˆå§‹åŒ– [root@openvpn 3.0.8]# vim vars export KEY_COUNTRY=\u0026#34;CN\u0026#34; export KEY_PROVINCE=\u0026#34;ShangHai\u0026#34; export KEY_CITY=\u0026#34;ShangHai\u0026#34; export KEY_ORG=\u0026#34;YCZB\u0026#34; export KEY_EMAIL=\u0026#34;heian@heian.com\u0026#34; [root@openvpn 3.0.8]# source ./vars ç”ŸæˆCAæ ¹è¯ä¹¦ 1 2 3 #åˆå§‹åŒ– pki ç›¸å…³ç›®å½• ./easyrsa init-pki ç”Ÿæˆ CA æ ¹è¯ä¹¦, è¾“å…¥ Common Nameï¼Œåå­—éšä¾¿èµ·ã€‚\n1 2 ./easyrsa build-ca nopass è¿™ä¸ªå‘½ä»¤æ˜¯ä¸ç”Ÿæˆå¯†ç  ç”ŸæˆopenvpnæœåŠ¡å™¨è¯ä¹¦å’Œå¯†é’¥ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¯ä¹¦åç§°\n1 ./easyrsa build-server-full server nopass ç”ŸæˆDiffie-Hellmanç®—æ³•éœ€è¦çš„å¯†é’¥æ–‡ä»¶\n1 /easyrsa gen-dh #åˆ›å»º Diffie-Hellman ï¼Œæ—¶é—´æ¯”è¾ƒä¹…ä¸€äº› ç”Ÿæˆtls-auth keyï¼Œä¸ºäº†é˜²æ­¢DDOSå’ŒTLSæ”»å‡»ï¼Œè¿™ä¸ªå±äºå¯é€‰å®‰å…¨é…ç½®\n1 openvpn --genkey --secret ta.key openvpnæ–‡ä»¶æ•´ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 mkdir /etc/openvpn/server/certs cd /etc/openvpn/server/certs/ # SSL åå•†æ—¶ Diffie-Hellman ç®—æ³•éœ€è¦çš„ key cp /etc/openvpn/easy-rsa/3/pki/dh.pem ./ # CA æ ¹è¯ä¹¦ cp /etc/openvpn/easy-rsa/3/pki/ca.crt ./ # open VPN æœåŠ¡å™¨è¯ä¹¦ cp /etc/openvpn/easy-rsa/3/pki/issued/yczbjt.crt ./server.crt # open VPN æœåŠ¡å™¨è¯ä¹¦ key cp /etc/openvpn/easy-rsa/3/pki/private/yczbjt.key ./server.key # tls-auth key cp /etc/openvpn/easy-rsa/3/ta.key ./ ----------------------------------- åˆ›å»ºopenvpnæ—¥å¿—ç›®å½• 1 2 3 4 5 [root@openvpnservice certs]# /etc/openvpn/cdd #åˆ›å»ºæ—¥å¿—ç›®å½• [root@openvpnservice certs]# mkdir -p /var/log/openvpn/ #ç»™äºˆæƒé™ [root@openvpnservice certs]# chown openvpn:openvpn /var/log/openvpn é…ç½®OpenVPN æ·±åœ³æœåŠ¡ç«¯é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 port 1194 proto udp dev tun ca /etc/openvpn/server/certs/ca.crt cert /etc/openvpn/server/certs/server.crt key /etc/openvpn/server/certs/server.key dh /etc/openvpn/server/certs/dh.pem tls-auth /etc/openvpn/server/certs/ta.key 0 server 10.10.10.0 255.255.255.0 route 172.17.20.0 255.255.255.0 push \u0026#34;route 172.17.10.0 255.255.255.0\u0026#34; ifconfig-pool-persist ipp.txt client-to-client compress lzo keepalive 10 120 client-config-dir /etc/openvpn/ccd cipher AES-256-CBC comp-lzo persist-key persist-tun log /var/log/openvpn/server.log log-append /var/log/openvpn/server.log status /var/log/openvpn/status.log verb 3 explicit-exit-notify 1 script-security 2 client-connect /etc/openvpn/script/connect.sh client-disconnect /etc/openvpn/script/disconnect.sh connect.sh 1 2 3 4 5 6 7 8 9 #!/bin/bash Time=`date +%F` if [ -f /etc/openvpn/log/openvpn_$Time.log ];then touch /etc/openvpn/log/openvpn_$Time.log echo \u0026#34;`date \u0026#39;+%F %H:%M:%S\u0026#39;` User $common_name trust_ip $trusted_ip is login,Remote_ip is $ifconfig_pool_remote_ip, Mask is $route_netmask_1\u0026#34; \u0026gt;\u0026gt; /etc/openvpn/log/openvpn_$Time.log else touch /etc/openvpn/log/openvpn_$Time.log echo \u0026#34;`date \u0026#39;+%F %H:%M:%S\u0026#39;` User $common_name trust_ip $trusted_ip is login,Remote_ip is $ifconfig_pool_remote_ip, Mask is $route_netmask_1\u0026#34; \u0026gt;\u0026gt; /etc/openvpn/log/openvpn_$Time.log fi disconnect.sh 1 2 3 4 5 6 7 8 9 #!/bin/bash Time=`date +%F` if [ -f /etc/openvpn/log/openvpn_$Time.log ];then touch /etc/openvpn/log/openvpn_$Time.log echo \u0026#34;`date \u0026#39;+%F %H:%M:%S\u0026#39;` User $common_name trust_ip $trusted_ip is logout,Remote_ip is $ifconfig_pool_remote_ip, Mask is $route_netmask_1\u0026#34; \u0026gt;\u0026gt; /etc/openvpn/log/openvpn_$Time.log else touch /etc/openvpn/log/openvpn_$Time.log echo \u0026#34;`date \u0026#39;+%F %H:%M:%S\u0026#39;` User $common_name trust_ip $trusted_ip is logout,Remote_ip is $ifconfig_pool_remote_ip, Mask is $route_netmask_1\u0026#34; \u0026gt;\u0026gt; /etc/openvpn/log/openvpn_$Time.log fi å¼€å¯è·¯ç”±è½¬å‘ 1 2 echo net.ipv4.ip_forward = 1 \u0026gt;\u0026gt;/etc/sysctl.conf sysctl -p æ·»åŠ IPtables 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 [root@bt script]# cat /etc/sysconfig/iptables # Generated by iptables-save v1.4.21 on Sun Jun 26 10:24:16 2022 *filter :INPUT ACCEPT [1248:200636] :FORWARD ACCEPT [0:0] :OUTPUT ACCEPT [2012:242515] -A FORWARD -j ACCEPT COMMIT # Completed on Sun Jun 26 10:24:16 2022 # Generated by iptables-save v1.4.21 on Sun Jun 26 10:24:16 2022 *nat :PREROUTING ACCEPT [2:162] :INPUT ACCEPT [1:78] :OUTPUT ACCEPT [271:36649] :POSTROUTING ACCEPT [72:5056] -A POSTROUTING -s 172.17.10.0/24 -j MASQUERADE -A POSTROUTING -s 10.10.10.0/24 -o ens33 -j SNAT --to-source 172.17.10.20 COMMIT # Completed on Sun Jun 26 10:24:16 2022 è¿™æ˜¯ä¸€äº›iptablesè§„åˆ™ï¼Œç”¨äºç½‘ç»œåœ°å€è½¬æ¢ï¼ˆNATï¼‰å’ŒIPæ•°æ®åŒ…è¿‡æ»¤ã€‚è¿™äº›è§„åˆ™å¯èƒ½åœ¨Linuxæ“ä½œç³»ç»Ÿä¸Šçš„iptablesé˜²ç«å¢™ä¸­ä½¿ç”¨ã€‚\nç¬¬ä¸€ä¸ªè§„åˆ™çš„æ„æ€æ˜¯å°†æ¥è‡ª172.17.10.0/24å­ç½‘ä¸­çš„æ•°æ®åŒ…çš„æºåœ°å€æ”¹ä¸ºé˜²ç«å¢™çš„IPåœ°å€ï¼Œä»¥ä¾¿å°†æ•°æ®åŒ…ä¼ é€’åˆ°äº’è”ç½‘ï¼Œå¹¶ç¡®ä¿å“åº”æ•°æ®åŒ…å¯ä»¥æ­£ç¡®è¿”å›ã€‚ä½¿ç”¨MASQUERADEé€‰é¡¹çš„ç›®çš„æ˜¯è‡ªåŠ¨æ ¹æ®é˜²ç«å¢™çš„å‡ºå£IPåœ°å€è¿›è¡Œåœ°å€è½¬æ¢ã€‚\nç¬¬äºŒä¸ªè§„åˆ™çš„æ„æ€æ˜¯å°†æ¥è‡ª10.10.10.0/24å­ç½‘çš„æ•°æ®åŒ…çš„æºIPåœ°å€æ”¹ä¸º172.17.10.20ï¼Œå¹¶åœ¨é˜²ç«å¢™çš„ç½‘ç»œæ¥å£ï¼ˆens33ï¼‰ä¸Šå‘é€ã€‚è¿™ä¸ªè§„åˆ™å¯èƒ½ä¼šç”¨äºç‰¹æ®Šæƒ…å†µï¼Œä¾‹å¦‚éœ€è¦ä½¿ç”¨ç‰¹å®šçš„IPåœ°å€æ¥ç»•è¿‡æŸäº›é˜²ç«å¢™æˆ–ç½‘ç»œé™åˆ¶ã€‚\nåŠ è½½é˜²ç«å¢™\n1 iptables-restore \u0026gt; /etc/sysconfig/iptables ccd 1 2 3 [root@bt openvpn]# cat ccd/fujinfu iroute 172.17.20.0 255.255.255.0 é…ç½®å®¢æˆ·ç«¯æ¨é€çš„è·¯ç”± æ·»åŠ å®¢æˆ·ç«¯ç”¨æˆ·é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@openvpnservice ~]# cd /etc/openvpn/client/ [root@openvpnservice client]# touch sample.ovpn [root@openvpnservice client]# vim sample.ovpn client proto udp dev tun remote 49.234.26.34 1194 #openvpnå…¬ç½‘æ˜ å°„çš„ipåœ°å€å’Œç«¯å£ ca ca.crt cert admin.crt key admin.key tls-auth ta.key 1 remote-cert-tls server persist-tun persist-key comp-lzo verb 3 mute-replay-warnings åˆ›å»ºç”¨æˆ·è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 yum install -y zip,unzip [root@bt client]# cat bash_openuser.sh # ! /bin/bash set -e OVPN_USER_KEYS_DIR=/etc/openvpn/client/keys EASY_RSA_VERSION=3 EASY_RSA_DIR=/etc/openvpn/easy-rsa/ PKI_DIR=$EASY_RSA_DIR/$EASY_RSA_VERSION/pki for user in \u0026#34;$@\u0026#34; do if [ -d \u0026#34;$OVPN_USER_KEYS_DIR/$user\u0026#34; ]; then rm -rf $OVPN_USER_KEYS_DIR/$user rm -rf $PKI_DIR/reqs/$user.req sed -i \u0026#39;/\u0026#39;\u0026#34;$user\u0026#34;\u0026#39;/d\u0026#39; $PKI_DIR/index.txt fi cd $EASY_RSA_DIR/$EASY_RSA_VERSION # ç”Ÿæˆå®¢æˆ·ç«¯ ssl è¯ä¹¦æ–‡ä»¶ ./easyrsa build-client-full $user nopass # æ•´ç†ä¸‹ç”Ÿæˆçš„æ–‡ä»¶ mkdir -p $OVPN_USER_KEYS_DIR/$user cp $PKI_DIR/ca.crt $OVPN_USER_KEYS_DIR/$user/ # CA æ ¹è¯ä¹¦ cp $PKI_DIR/issued/$user.crt $OVPN_USER_KEYS_DIR/$user/ # å®¢æˆ·ç«¯è¯ä¹¦ cp $PKI_DIR/private/$user.key $OVPN_USER_KEYS_DIR/$user/ # å®¢æˆ·ç«¯è¯ä¹¦å¯†é’¥ cp /etc/openvpn/client/sample.ovpn $OVPN_USER_KEYS_DIR/$user/$user.ovpn # å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ sed -i \u0026#39;s/admin/\u0026#39;\u0026#34;$user\u0026#34;\u0026#39;/g\u0026#39; $OVPN_USER_KEYS_DIR/$user/$user.ovpn cp /etc/openvpn/server/certs/ta.key $OVPN_USER_KEYS_DIR/$user/ta.key # auth-tls æ–‡ä»¶ cd $OVPN_USER_KEYS_DIR zip -r $user.zip $user done exit 0 åŒ—äº¬å®¢æˆ·ç«¯é…ç½® iptablesè®¾ç½® å¼€å¯è½¬å‘è·¯ç”±\n1 2 3 4 5 6 7 systemctl stop firewalld systemctl mask firewalld setenforce 0\t# ä¸´æ—¶å…³é—­ sed -i \u0026#39;s/SELINUX=enforcing/SELINUX=disabled/g\u0026#39; /etc/selinux/config echo net.ipv4.ip_forward = 1 \u0026gt;\u0026gt;/etc/sysctl.conf sysctl -p æ ¹æ®ä¸‹å›¾è®¾ç½®IPtablesçš„è§„åˆ™\n1 2 3 4 5 6 7 8 vim /etc/sysconfig/iptables -A POSTROUTING -s 172.17.20.0/24 -j MASQUERADE -A POSTROUTING -s 10.10.10.0/24 -o ens33 -j SNAT --to-source 172.17.20.20 åŠ è½½é˜²ç«å¢™ iptables-restore \u0026gt; /etc/sysconfig/iptables äº¤æ¢æœºé…ç½® æ·±åœ³è®¿é—®åŒ—äº¬çš„æœºå™¨ 1 route add -net 172.17.20.0/24 gw 172.17.10.20 å¦‚æœä½¿ç”¨çš„æ˜¯åä¸ºäº¤æ¢æœºï¼ˆHuaweiï¼‰ï¼Œå‘½ä»¤åˆ™å¦‚ä¸‹ï¼š\n1 ip route-static 172.17.20.0 255.255.255.0 172.17.10.20 è¯·æ ¹æ®å…·ä½“ä½¿ç”¨çš„äº¤æ¢æœºå‹å·å’Œå“ç‰Œï¼Œé€‰æ‹©ç›¸åº”çš„å‘½ä»¤æ ¼å¼ã€‚\nåŒ—äº¬æœºå™¨è®¿é—®æ·±åœ³æ®µçš„æœºå™¨ 1 route add -net 172.17.10.0/24 gw 172.17.20.20 å¦‚æœä½¿ç”¨çš„æ˜¯åä¸ºäº¤æ¢æœºï¼ˆHuaweiï¼‰ï¼Œå‘½ä»¤åˆ™å¦‚ä¸‹ï¼š\n1 ip route-static 172.17.10.0 255.255.255.0 172.17.20.20 ä¸Šé¢æ˜¯ä¸´æ—¶åŠ åˆ°æœºå™¨ä¸Šï¼Œæˆ‘ä»¬åº”è¯¥åŠ åˆ°äº¤æ¢æœºä¸Šï¼Œè¿™æ ·æ•´ä¸ªç½‘æ®µéƒ½å¯ä»¥è®¿é—®\nåœ¨å®é™…çš„ç¯å¢ƒä¸­å¯ä»¥åœ¨å†…ç½‘çš„è·¯ç”±å™¨ä¸Šåšï¼Œè¿™æ ·å°±ä¸éœ€è¦åœ¨ä¸»æœºä¸Šé…ï¼Œæ¯”è¾ƒçœäº‹.\nå‚è€ƒæ–‡æ¡£ï¼š\nhttps://ownit.top/p/202407290930/\nhttps://www.cnblogs.com/huangweimin/articles/7700892.html\n","date":"2024-07-30T22:22:16Z","image":"https://www.ownit.top/title_pic/11.jpg","permalink":"https://www.ownit.top/p/202407302222/","title":"Openvpnæ‰“é€šåŒ—äº¬å’Œæ·±åœ³ä¸¤åœ°åŠå…¬å®¤ç½‘ç»œ"},{"content":"openvpnä»‹ç» OpenVPNæ˜¯ä¸€ä¸ªå…¨ç‰¹æ€§çš„SSL VPNï¼Œæ”¯æŒå¼¹æ€§çš„å®¢æˆ·ç«¯è®¤è¯æ–¹æ³•ï¼ŒåŸºäºè¯ä¹¦ã€æ™ºèƒ½å¡ï¼Œå’Œ/æˆ–ç”¨æˆ·ååŠå¯†ç å‡­è¯ç­‰ï¼Œå¹¶ä¸”é€šè¿‡åº”ç”¨äºVPNè™šæ‹Ÿæ¥å£çš„é˜²ç«å¢™è§„åˆ™ï¼Œå¯ä»¥ä½¿ç”¨ç‰¹å®šç”¨æˆ·æˆ–ç»„çš„è®¿é—®æ§åˆ¶ç­–ç•¥ã€‚\nVPN å…¨ç§°ä¸ºè™šæ‹Ÿç§äººç½‘ç»œ(Virtual Private Network)ï¼Œå¸¸ç”¨äºè¿æ¥ä¸­ã€å¤§å‹ä¼ä¸šæˆ–å›¢ä½“é—´ç§äººç½‘ç»œçš„é€šè®¯æ–¹æ³•ï¼Œåˆ©ç”¨éš§é“åè®®ï¼ˆTunneling Protocolï¼‰æ¥è¾¾åˆ°å‘é€ç«¯è®¤è¯ã€æ¶ˆæ¯ä¿å¯†ä¸å‡†ç¡®æ€§ç­‰åŠŸèƒ½ã€‚\næ¯”å¦‚å¤šåœ°åŠå…¬çš„å…¬å¸ï¼Œå¯ä»¥ä½¿ç”¨ VPN å°†ä¸åŒåœ°åŒºè¿æ¥åœ¨åŒä¸€å†…ç½‘ä¸‹ï¼›æˆ–è€…åœ¨å®¶åŠå…¬çš„æ—¶å€™ä¹Ÿå¯ä»¥é€šè¿‡ VPN æ¥å…¥å…¬å¸å†…ç½‘ä¸­ã€‚\nVPN ä»¥ CS æ¶æ„è¿è¡Œï¼Œå·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š\nVPNå·¥ä½œæµç¨‹\nåœ¨å¤–ç½‘çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨ vpn client è¿æ¥ç»„ç»‡æ­å»ºçš„ vpn server ä»¥å»ºç«‹é€šä¿¡éš§é“ï¼Œéšåä¾¿å»ºç«‹äº†è™šæ‹Ÿçš„ç§äººç½‘ç»œï¼Œå¤„äºå¤–ç½‘çš„ worker å’Œå†…ç½‘ä¸­çš„ server å¯ä»¥ç›¸äº’é€šä¿¡ã€‚\né‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç®€å•ç†è§£ VPNï¼Œç”± VPN client æ•è·ç”¨æˆ·å‘å‡ºçš„æŠ¥æ–‡ï¼Œå°è£…æŠ¥æ–‡åé€šè¿‡ç‰©ç†ç½‘ç»œé€šä¿¡é“¾è·¯å°†æŠ¥æ–‡å‘ç»™ VPN serverï¼ŒVPN server æ¥æ”¶åˆ°æŠ¥æ–‡åè¿›è¡Œè§£åŒ…ï¼Œå†å°†å…¶è½¬å‘ç»™å®é™…çš„ç›®æ ‡ï¼Œåä¹‹åŒç†ï¼› VPN åœ¨é€»è¾‘å±‚é¢æ„å»ºäº†è™šæ‹Ÿç½‘ç»œã€‚\nopenvpnåŸç† OpenVpnçš„æŠ€æœ¯æ ¸å¿ƒæ˜¯è™šæ‹Ÿç½‘å¡ï¼Œå…¶æ¬¡æ˜¯SSLåè®®å®ç°ï¼Œç”±äºSSLåè®®åœ¨å…¶å®ƒçš„è¯æ¡ä¸­ä»‹ç»çš„æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œè¿™é‡Œé‡ç‚¹å¯¹è™šæ‹Ÿç½‘å¡åŠå…¶åœ¨OpenVpnçš„ä¸­çš„å·¥ä½œæœºç†è¿›è¡Œä»‹ç»ï¼š\nè™šæ‹Ÿç½‘å¡æ˜¯ä½¿ç”¨ç½‘ç»œåº•å±‚ç¼–ç¨‹æŠ€æœ¯å®ç°çš„ä¸€ä¸ªé©±åŠ¨è½¯ä»¶ï¼Œå®‰è£…ååœ¨ä¸»æœºä¸Šå¤šå‡ºç°ä¸€ä¸ªç½‘å¡ï¼Œå¯ä»¥åƒå…¶å®ƒç½‘å¡ä¸€æ ·è¿›è¡Œé…ç½®ã€‚æœåŠ¡ç¨‹åºå¯ä»¥åœ¨åº”ç”¨å±‚æ‰“å¼€è™šæ‹Ÿç½‘å¡ï¼Œå¦‚æœåº”ç”¨è½¯ä»¶ï¼ˆå¦‚IEï¼‰å‘è™šæ‹Ÿç½‘å¡å‘é€æ•°æ®ï¼Œåˆ™æœåŠ¡ç¨‹åºå¯ä»¥è¯»å–åˆ°è¯¥æ•°æ®ï¼Œå¦‚æœæœåŠ¡ç¨‹åºå†™åˆé€‚çš„æ•°æ®åˆ°è™šæ‹Ÿç½‘å¡ï¼Œåº”ç”¨è½¯ä»¶ä¹Ÿå¯ä»¥æ¥æ”¶å¾—åˆ°ã€‚è™šæ‹Ÿç½‘å¡åœ¨å¾ˆå¤šçš„æ“ä½œç³»ç»Ÿä¸‹éƒ½æœ‰ç›¸åº”çš„å®ç°ï¼Œè¿™ä¹Ÿæ˜¯OpenVpnèƒ½å¤Ÿè·¨å¹³å°ä¸€ä¸ªå¾ˆé‡è¦çš„ç†ç”±ã€‚\nåœ¨OpenVpnä¸­ï¼Œå¦‚æœç”¨æˆ·è®¿é—®ä¸€ä¸ªè¿œç¨‹çš„è™šæ‹Ÿåœ°å€ï¼ˆå±äºè™šæ‹Ÿç½‘å¡é…ç”¨çš„åœ°å€ç³»åˆ—ï¼ŒåŒºåˆ«äºçœŸå®åœ°å€ï¼‰ï¼Œåˆ™æ“ä½œç³»ç»Ÿä¼šé€šè¿‡è·¯ç”±æœºåˆ¶å°†æ•°æ®åŒ…ï¼ˆTUNæ¨¡å¼ï¼‰æˆ–æ•°æ®å¸§ï¼ˆTAPæ¨¡å¼ï¼‰å‘é€åˆ°è™šæ‹Ÿç½‘å¡ä¸Šï¼ŒæœåŠ¡ç¨‹åºæ¥æ”¶è¯¥æ•°æ®å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†åï¼Œé€šè¿‡SOCKETä»å¤–ç½‘ä¸Šå‘é€å‡ºå»ï¼Œè¿œç¨‹æœåŠ¡ç¨‹åºé€šè¿‡SOCKETä»å¤–ç½‘ä¸Šæ¥æ”¶æ•°æ®ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†åï¼Œå‘é€ç»™è™šæ‹Ÿç½‘å¡ï¼Œåˆ™åº”ç”¨è½¯ä»¶å¯ä»¥æ¥æ”¶åˆ°ï¼Œå®Œæˆäº†ä¸€ä¸ªå•å‘ä¼ è¾“çš„è¿‡ç¨‹ï¼Œåä¹‹äº¦ç„¶ã€‚\nOpenVPNåº”ç”¨åœºæ™¯ Peer-to-Peer VPN(ç‚¹å¯¹ç‚¹è¿æ¥)ï¼Œå°†Internetä¸¤å°æœºå™¨ï¼ˆå…¬ç½‘åœ°å€ï¼‰ä½¿ç”¨VPNè¿æ¥èµ·æ¥ï¼Œæ¯”å¦‚ä¸Šæµ·æœåŠ¡å™¨å’ŒåŒ—äº¬æœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®éœ€è¦ç›¸äº’è°ƒç”¨ï¼Œä½†æ˜¯æ•°æ®åˆæ¯”è¾ƒæ•æ„Ÿï¼Œç›´æ¥é€šè¿‡httpå…¬å…±ç½‘ç»œä¼ è¾“ï¼Œå®¹æ˜“è¢«çªƒå–ï¼Œå¦‚æœæ‹‰ä¸€æ¡ä¸“çº¿æˆæœ¬åˆå¤ªé«˜ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡VPNä½¿ç”¨ç°æœ‰ç½‘ç»œï¼Œå°†ä¸¤å°ä¸»æœºé€»è¾‘ä¸Šæ†ç»‘åœ¨ä¸€ä¸ªè™šæ‹Ÿç½‘ç»œä¸­ï¼Œè¿™æ ·æ—¢ä¿è¯äº†æ•°æ®ä¼ è¾“å®‰å…¨ï¼ŒåŒæ—¶åˆèŠ‚çœäº†æˆæœ¬ã€‚\n1.ç”¨æˆ·é€šè¿‡Internetè¿æ¥vpnæœåŠ¡é€šè¿‡åŠ å¯†æŠ€æœ¯è¿›è¡Œæ•°æ®ä¼ è¾“ï¼›\n2.åŠ å¯†å®ç°æ–¹å¼æ˜¯å®¢æˆ·ç«¯å…¬é’¥åŠ å¯†ï¼ŒæœåŠ¡ç«¯ç§é’¥è§£å¯†ï¼›\n3.å®¢æˆ·ç«¯è¿æ¥vpnåï¼Œvpnä¼šç»™å®¢æˆ·ç«¯æ¨é€ä¸€æ¡å†…ç½‘è·¯ç”±ä»¥æ­¤å®ç°å†…éƒ¨ä¸»æœºé€šä¿¡\nç§æœ‰ç½‘æ®µåˆ’åˆ† æ­å»ºVPNé€šå¸¸æ˜¯ä¸ºäº†å°†ä½äºä¸åŒåœ°ç†ä½ç½®çš„ç§æœ‰ç½‘æ®µè¿æ¥èµ·æ¥ã€‚è¦æ³¨æ„ï¼ŒVPNæ‰€è¿æ¥çš„ä¸¤ç«¯çš„ç§ç½‘ç½‘æ®µä¸èƒ½å†²çªã€‚\nIANA (The Internet Assigned Numbers Authority)å®šä¹‰äº†ä¸‹é¢ä¸‰ä¸ªIPåœ°å€å—ç”¨äºç§æœ‰ç½‘ç»œï¼š\n10.0.0.0 10.255.255.255 (10/8å‰ç¼€) 172.16.0.0 172.31.255.255 (172.16/12å‰ç¼€) 192.168.0.0 192.168.255.255 (192.168/16å‰ç¼€) Openvpnéƒ¨ç½² ç¯å¢ƒä»‹ç»\nä¸»æœº ip ç½‘æ®µ openvpn-server(vpn-192.168.83.44 ) 192.168.83.10ï¼ˆç‰©ç†ipï¼‰/192.168.255.1(è™šæ‹Ÿip) 192.168.0.0/16 openvpn-client01\u0026ndash;ï¼ˆä¸»èŠ‚ç‚¹ï¼‰ 10.134.18.10ï¼ˆç‰©ç†ipï¼‰/192.168.255.10(è™šæ‹Ÿip) 10.0.0.0/8 openvpn-client02\u0026ndash;ï¼ˆå¤‡èŠ‚ç‚¹ï¼‰ 10.128.19.10ï¼ˆç‰©ç†ipï¼‰/192.168.255.6 10.0.0.0/8 serverè™šæ‹Ÿip 192.168.255.1/24 192.168.255.0/16 å®‰è£…ç³»ç»Ÿï¼šCentOS Linux release 7.5.1804 (Core)\nå¯ç”¨EPELçš„yumæºï¼Œå®‰è£…OpenVPNï¼š\n1 2 3 [root@gw ~]# yum install epel-release [root@gw ~]# yum install openvpn OpenVPNç¨‹åºåº”è¯¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æœºå™¨éƒ½å®‰è£…ï¼Œå®ƒæ˜¯åŒä¸€ä¸ªç¨‹åºåŒ…æä¾›å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯çš„åŠŸèƒ½ï¼Œå–å†³äºä½ çš„é…ç½® æœåŠ¡ç«¯ ç”Ÿæˆæ‰€æœ‰è¯ä¹¦\u0026amp;å¯†é’¥åŸç† æ­å»ºOpenVPNï¼Œéœ€è¦è®¾ç½®ä½ è‡ªå·±çš„CA(Certificate Authority)å¹¶ä¸”ä¸ºOpenVPNæœåŠ¡å™¨å’Œå¤šä¸ªå®¢æˆ·ç«¯åˆ†åˆ«ç”Ÿæˆè¯ä¹¦å’Œå¯†é’¥ã€‚\næ„å»ºä¸€ä¸ªOpenVPN 2.xé…ç½®çš„ç¬¬ä¸€ä¸ªæ­¥éª¤æ˜¯å»ºç«‹ä¸€ä¸ªPKI(public key infrastructure)ã€‚è¯¥PKIåŒ…å«ï¼š\næœåŠ¡å™¨å’Œæ¯ä¸€ä¸ªå®¢æˆ·ç«¯éƒ½è¦æœ‰ä¸€ä¸ªå•ç‹¬çš„è¯ä¹¦(ä¹Ÿå«åšå…¬é’¥)å’Œç§é’¥ã€‚\nä¸€ä¸ªmaster CA (Certificate Authority)è¯ä¹¦å’Œå¯†é’¥ï¼Œç”¨äºä¸ºæ¯ä¸€ä¸ªæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¯ä¹¦ç­¾åã€‚\nOpenVPNæ”¯æŒåŸºäºè¯ä¹¦çš„åŒå‘è®¤è¯ï¼Œè¿™æ„å‘³ç€ï¼Œåœ¨å»ºç«‹ç›¸äº’ä¿¡ä»»ä¹‹å‰ï¼Œå®¢æˆ·ç«¯å¿…é¡»è®¤è¯æœåŠ¡å™¨è¯ä¹¦ï¼ŒæœåŠ¡ç«¯ä¹Ÿå¿…é¡»è®¤è¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åœ¨è®¤è¯å½¼æ­¤æ—¶ï¼Œä¼šé¦–å…ˆéªŒè¯å¯¹æ–¹å‘ˆç°çš„è¯ä¹¦æ˜¯å¦ç”±master CAç­¾åï¼Œç„¶åæµ‹è¯•è¯ä¹¦æŠ¥å¤´ä¸­çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯ä¹¦common nameæˆ–è¯ä¹¦ç±»å‹(å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨)ã€‚\næ³¨æ„ï¼šæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ—¶é’Ÿéœ€è¦åŸºæœ¬åŒæ­¥ï¼Œå¦åˆ™è¯ä¹¦å¯èƒ½ä¸ä¼šæ­£å¸¸å·¥ä½œã€‚\nç”ŸæˆCAçš„è¯ä¹¦\u0026amp;å¯†é’¥ ç”Ÿæˆä¸€ä¸ªmaster CAè¯ä¹¦å’Œå¯†é’¥ï¼Œä¸€ä¸ªæœåŠ¡å™¨è¯ä¹¦å’Œå¯†é’¥ï¼Œå’Œä¸º3ä¸ªä¸åŒçš„å®¢æˆ·ç«¯ç”Ÿæˆè¯ä¹¦å’Œå¯†é’¥ã€‚\nå¯¹äºPKIç®¡ç†ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨easy-rsa 2ï¼Œè¿™æ˜¯ä¸OpenVPN 2.2.xå’Œä¹‹å‰çš„ç‰ˆæœ¬ç»‘å®šçš„ä¸€ä¸ªè„šæœ¬é›†åˆã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯OpenVPN 2.3.xï¼Œä½ éœ€è¦å•ç‹¬ä»easy-rsa-oldé¡¹ç›®é¡µé¢ä¸‹è½½easy-rsa 2ã€‚è€Œåœ¨*NIXå¹³å°ä¸Šï¼Œä½ åº”è¯¥ä½¿ç”¨easy-rsa 3ï¼Œå‚è€ƒå®ƒçš„æ–‡æ¡£ä»¥äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 [root@gw ~]# yum install easy-rsa å°†æ•´ä¸ªeasy-rsaçš„ç›®å½•æ‹·è´åˆ°å¦ä¸€ä¸ªç›®å½•ä¸‹ï¼Œæ¯”å¦‚/etc/openvpnï¼Œè¿™æ ·æœªæ¥å‡çº§OpenVPNåŒ…æ—¶ä¸ä¼šè¦†ç›–ä½ çš„ä¿®æ”¹ã€‚ [root@gw ~]# cp -ar /usr/share/easy-rsa /etc/openvpn ç”Ÿæˆå˜é‡é…ç½®æ–‡ä»¶ï¼š [root@gw ~]# cp /usr/share/doc/easy-rsa-3.0.3/vars.example /etc/openvpn/easy-rsa/3.0.3/vars å¯ä»¥åœ¨varsä¸­è®¾ç½®è¯ä¹¦æœ‰æ•ˆæœŸ [root@gw ~]# vim vars #é…ç½®ä¸€ä¸‹ç›¸å…³çš„ä¿¡æ¯ export KEY_COUNTRY=\u0026#34;CN\u0026#34; export KEY_PROVINCE=\u0026#34;ShangHai\u0026#34; export KEY_CITY=\u0026#34;ShangHai\u0026#34; export KEY_ORG=\u0026#34;YCZB\u0026#34; export KEY_EMAIL=\u0026#34;heian@heian.com\u0026#34; set_var EASYRSA_CA_EXPIRE 3650 // CAè¯ä¹¦çš„é»˜è®¤æœ‰æ•ˆæœŸ set_var EASYRSA_CERT_EXPIRE 3650 // CAç­¾å‘çš„è¯ä¹¦çš„é»˜è®¤æœ‰æ•ˆæœŸ set_var EASYRSA_CRL_DAYS 3650 // è²Œä¼¼å¦‚æœCRLæ–‡ä»¶åœ¨è¯¥æ—¶é—´å†…éƒ½æœªä¿®æ”¹è¿‡çš„è¯ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯éƒ½å°†æ— æ³•è¿æ¥ è¿›å…¥easy-rsaçš„ç›®å½•ï¼Œåˆå§‹åŒ–ç¯å¢ƒï¼š cd /etc/openvpn/easy-rsa/3.0.3/ source ./vars ./easyrsa init-pki #åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„PKIï¼Œå…¶å®å°±æ˜¯ç§»é™¤å¹¶é‡æ–°åˆ›å»ºpkiç›®å½•ç»“æ„ åˆ›å»ºCAè¯ä¹¦å’Œå¯†é’¥å¯¹ï¼š ./easyrsa build-ca nopass # build-caå‘½ä»¤åˆ›å»ºCAè¯ä¹¦å’Œå¯†é’¥å¯¹ã€‚nopassé€‰é¡¹è¡¨ç¤ºä¸å¯¹CAå¯†é’¥è¿›è¡ŒåŠ å¯†ã€‚nopass é…ç½®æ— å¯†ç ã€‚ #ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½®å¯†ç ã€‚åœ¨ç”Ÿæˆè¯ä¹¦ã€å¯†é’¥çš„æ—¶å€™ï¼Œä¼šè¦æ±‚è¾“å…¥è¯¥CAå¯†é’¥çš„å¯†ç ã€‚ ç°åœ¨ï¼Œå·²ç»ç”Ÿæˆäº†CAçš„è¯ä¹¦æ–‡ä»¶pki/ca.crtå’Œç§é’¥æ–‡ä»¶pki/private/ca.keyã€‚ Generating a 2048 bit RSA private key .................................+++ ...............+++ writing new private key to \u0026#39;/etc/openvpn/easy-rsa/3.0.3/pki/private/ca.key.lhgETNINjO\u0026#39; ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter \u0026#39;.\u0026#39;, the field will be left blank. ----- Common Name (eg: your user, host, or server name) [Easy-RSA CA]:Guowei_CA #è¾“å…¥ç”¨äºè¾¨è¯†çš„ä¸€ä¸ªåç§° CA creation complete and you may now import and sign cert requests. Your new CA certificate file for publishing is at: /etc/openvpn/easy-rsa/3.0.3/pki/ca.crt ç°åœ¨ï¼Œå·²ç»ç”Ÿæˆäº†CAçš„è¯ä¹¦æ–‡ä»¶pki/ca.crtå’Œç§é’¥æ–‡ä»¶pki/private/ca.keyã€‚\nç”ŸæˆæœåŠ¡ç«¯çš„è¯ä¹¦\u0026amp;å¯†é’¥ ç”ŸæˆOpenVPNæœåŠ¡ç«¯çš„è¯ä¹¦å’Œå¯†é’¥å¯¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ./easyrsa build-server-full server nopass # build-server-fullå‘½ä»¤ç”ŸæˆæœåŠ¡ç«¯çš„è¯ä¹¦å’Œå¯†é’¥å¯¹ã€‚ # serverå‚æ•°æ˜¯ç”Ÿæˆè¯ä¹¦æ—¶ç”¨çš„Common Nameï¼Œå»ºè®®å°±ä½¿ç”¨serverã€‚nopassé€‰é¡¹è¡¨ç¤ºä¸å¯¹å¯†é’¥è¿›è¡ŒåŠ å¯†ã€‚ Generating a 2048 bit RSA private key ..+++ ................+++ writing new private key to \u0026#39;/etc/openvpn/easy-rsa/3.0.3/pki/private/server.key.gYkfUBDAFl\u0026#39; ----- Using configuration from ./openssl-1.0.cnf Check that the request matches the signature Signature ok The Subject\u0026#39;s Distinguished Name is as follows commonName :ASN.1 12:\u0026#39;server\u0026#39; Certificate is to be certified until Aug 12 01:22:27 2028 GMT (3650 days) Write out database with 1 new entries Data Base Updated ç°åœ¨ï¼Œå·²ç»ç”Ÿæˆäº†æœåŠ¡ç«¯çš„è¯ä¹¦æ–‡ä»¶pki/issued/server.crtå’Œç§é’¥æ–‡ä»¶pki/private/server.keyã€‚å¹¶ä¸”ï¼Œç”Ÿæˆçš„æœåŠ¡ç«¯è¯ä¹¦å·²ç»æ˜¯ç»è¿‡å…ˆå‰çš„CAå¯†é’¥ç­¾åçš„äº†ã€‚\nç”Ÿæˆå®¢æˆ·ç«¯çš„è¯ä¹¦\u0026amp;å¯†é’¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ./easyrsa build-client-full clientname nopass # build-client-fullå‘½ä»¤ç”Ÿæˆå®¢æˆ·ç«¯çš„è¯ä¹¦å’Œå¯†é’¥å¯¹ã€‚ # client1å‚æ•°æ˜¯ç”Ÿæˆè¯ä¹¦æ—¶ç”¨çš„Common Nameã€‚nopassé€‰é¡¹è¡¨ç¤ºä¸å¯¹å¯†é’¥è¿›è¡ŒåŠ å¯†ã€‚ Generating a 2048 bit RSA private key ......................................+++ ............................................................................+++ writing new private key to \u0026#39;/etc/openvpn/easy-rsa/3.0.3/pki/private/client1.key.wQ7i2qbP93\u0026#39; ----- Using configuration from ./openssl-1.0.cnf Check that the request matches the signature Signature ok The Subject\u0026#39;s Distinguished Name is as follows commonName :ASN.1 12:\u0026#39;client1\u0026#39; Certificate is to be certified until Aug 12 02:08:02 2028 GMT (3650 days) Write out database with 1 new entries Data Base Updated ç°åœ¨ï¼Œå·²ç»ç”Ÿæˆäº†æœåŠ¡ç«¯çš„è¯ä¹¦æ–‡ä»¶pki/issued/client1.crtå’Œç§é’¥æ–‡ä»¶pki/private/client1.keyã€‚å¹¶ä¸”ï¼Œç”Ÿæˆçš„å®¢æˆ·ç«¯è¯ä¹¦å·²ç»æ˜¯ç»è¿‡å…ˆå‰çš„CAå¯†é’¥ç­¾åçš„äº†ã€‚\nç±»ä¼¼çš„ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¸ºclient2ã€client3ç­‰åˆ†åˆ«ç”Ÿæˆè¯ä¹¦å’Œå¯†é’¥å¯¹ã€‚æ€»æ˜¯ä¸ºæ¯ä¸€ä¸ªå®¢æˆ·ç«¯ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€çš„Common Nameã€‚\nç”ŸæˆDiffie Hellmanå‚æ•° æˆ‘ä»¬éœ€è¦ä¸ºOpenVPNæœåŠ¡ç«¯ç”ŸæˆDiffie Hellmanå‚æ•°ï¼š\n1 2 3 4 5 ./easyrsa gen-dh Generating DH parameters, 2048 bit long safe prime, generator 2 This is going to take a long time ......................................................................+.......+...........................+......................................+................................................+....+.............................................................................................................................................................................. DH parameters of size 2048 created at /etc/openvpn/easy-rsa/3.0.3/pki/dh.pem ç°åœ¨ï¼Œå·²ç»ç”Ÿæˆäº†Diffie Hellmanå‚æ•°æ–‡ä»¶pki/dh.pemã€‚\nç”Ÿæˆtls-auth key ç”Ÿæˆtls-auth keyï¼Œä¸ºäº†é˜²æ­¢DDOSå’ŒTLSæ”»å‡»ï¼Œè¿™ä¸ªå±äºå¯é€‰å®‰å…¨é…ç½®\n1 openvpn --genkey --secret ta.key æœåŠ¡ç«¯å’Œåˆ›å»ºé…ç½®æ–‡ä»¶ OpenVPNè½¯ä»¶åŒ…è‡ªå¸¦äº†ä¸€äº›ç¤ºä¾‹é…ç½®æ–‡ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ä½¿ç”¨rpmåŒ…å®‰è£…çš„ï¼Œå¯ä»¥åœ¨/usr/share/doc/openvpn-2.4.6/sample/sample-config-files/ç›®å½•ä¸‹æ‰¾åˆ°ï¼š\næœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ç¤ºä¾‹é…ç½®æ–‡ä»¶åˆ†åˆ«æ˜¯server.confå’Œclient.conf\nè¯ä¹¦ç›®å½•ä¼˜åŒ– 1 2 3 4 5 6 # mkdir /etc/openvpn/server/certs \u0026amp;\u0026amp; cd /etc/openvpn/server/certs # cp /etc/openvpn/easy-rsa/pki/dh.pem ./ # cp /etc/openvpn/easy-rsa/pki/ca.crt ./ # cp /etc/openvpn/easy-rsa/pki/issued/server.crt ./ # cp /etc/openvpn/easy-rsa/pki/private/server.key ./ # cp /etc/openvpn/easy-rsa/ta.key ./ ServeræœåŠ¡å™¨é…ç½®æ–‡ä»¶ OpenVPNè½¯ä»¶åŒ…è‡ªå¸¦çš„æœåŠ¡å™¨ç¤ºä¾‹é…ç½®æ–‡ä»¶å¾ˆé€‚åˆç”¨æ¥ç”ŸæˆçœŸæ­£ä½¿ç”¨çš„æœåŠ¡å™¨é…ç½®æ–‡ä»¶ã€‚å®ƒä¼šåˆ›å»ºä¸€ä¸ªVPNï¼Œä½¿ç”¨ä¸€ä¸ªè™šæ‹Ÿçš„TUNç½‘ç»œæ¥å£(ç”¨äºè·¯ç”±)ï¼Œä¼šåœ¨UDPç«¯å£1194(OpenVPNçš„å®˜æ–¹ç«¯å£å·)ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ï¼Œå¹¶åˆ†å‘10.8.0.0/24å­ç½‘ä¸­çš„è™šæ‹Ÿåœ°å€ç»™è¿æ¥è¿›æ¥çš„å®¢æˆ·ç«¯ã€‚\nåœ¨ä½ ä½¿ç”¨è¯¥é…ç½®æ–‡ä»¶ä¹‹å‰ï¼Œä½ åº”è¯¥ä¿®æ”¹è¯¥é…ç½®æ–‡ä»¶ä¸­çš„caã€certã€keyå’Œdhé€‰é¡¹ï¼Œè®©å®ƒä»¬æŒ‡å‘å„è‡ªçš„æ–‡ä»¶(æˆ‘ä»¬å…ˆå‰ç”Ÿæˆçš„)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 #å¯åŠ¨çš„ç«¯å£ port 1194 #ä½¿ç”¨çš„tcpåè®® proto tcp ## \u0026#34;dev tun\u0026#34;å°†ä¼šåˆ›å»ºä¸€ä¸ªè·¯ç”±IPéš§é“ dev tun # ç”Ÿæˆçš„caè¯ä¹¦ ca /etc/openvpn/server/certs/ca.crt #æœåŠ¡ç«¯çš„è¯ä¹¦ cert /etc/openvpn/server/certs/server.crt #æœåŠ¡ç«¯çš„å¯†é’¥ key /etc/openvpn/server/certs/server.key #Diffie-Hellmanå¯†é’¥äº¤æ¢ æ–‡ä»¶ dh /etc/openvpn/server/certs/dh.pem #openvpn serverçš„è™šæ‹Ÿipç½‘æ®µ server 192.168.255.0 255.255.255.0 #routeæ§åˆ¶äº†ä»å†…æ ¸åˆ°OpenVPNæœåŠ¡å™¨(é€šè¿‡TUNæ¥å£)çš„è·¯ç”± ### å…·ä½“ä¸‹ä¸€è·³æ˜¯å“ªé‡Œï¼Œç”± client-config é‡Œçš„ iroute æŒ‡å®š route 10.0.0.0 255.0.0.0 # åœ¨æ­¤æ–‡ä»¶ä¸­ç»´æŠ¤å®¢æˆ·ç«¯ä¸è™šæ‹ŸIPåœ°å€ä¹‹é—´çš„å…³è”è®°å½• # å¦‚æœOpenVPNé‡å¯ï¼Œé‡æ–°è¿æ¥çš„å®¢æˆ·ç«¯å¯ä»¥è¢«åˆ†é…åˆ°å…ˆå‰åˆ†é…çš„è™šæ‹ŸIPåœ°å€ ifconfig-pool-persist /etc/openvpn/server/ipp.txt #ä¸‹é¢æ˜¯å®šä¹‰æœåŠ¡å™¨è¯»å–ç‰¹æ®Šå®¢æˆ·ç«¯é…ç½®æ–‡ä»¶çš„ç›®å½•ä¸ºccdï¼› client-config-dir /etc/openvpn/ccd #å…è®¸å®¢æˆ·ç«¯å­ç½‘äº’é€š client-to-client # keepaliveæŒ‡ä»¤å°†å¯¼è‡´ç±»ä¼¼äºpingå‘½ä»¤çš„æ¶ˆæ¯è¢«æ¥å›å‘é€ï¼Œä»¥ä¾¿äºæœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯çŸ¥é“å¯¹æ–¹ä½•æ—¶è¢«å…³é—­ # æ¯10ç§’é’Ÿpingä¸€æ¬¡ï¼Œå¦‚æœ120ç§’å†…éƒ½æ²¡æœ‰æ”¶åˆ°å¯¹æ–¹çš„å›å¤ï¼Œåˆ™è¡¨ç¤ºè¿œç¨‹è¿æ¥å·²ç»å…³é—­ keepalive 10 120 # æœåŠ¡å™¨å’Œæ¯ä¸ªå®¢æˆ·ç«¯éƒ½éœ€è¦æ‹¥æœ‰è¯¥å¯†é’¥çš„ä¸€ä¸ªæ‹·è´ # ç¬¬äºŒä¸ªå‚æ•°åœ¨æœåŠ¡å™¨ç«¯åº”è¯¥ä¸º\u0026#39;0\u0026#39;ï¼Œåœ¨å®¢æˆ·ç«¯åº”è¯¥ä¸º\u0026#39;1\u0026#39; tls-auth /etc/openvpn/server/certs/ta.key 0 # é€‰æ‹©ä¸€ä¸ªå¯†ç åŠ å¯†ç®—æ³•ï¼Œè¯¥é…ç½®é¡¹ä¹Ÿå¿…é¡»å¤åˆ¶åˆ°æ¯ä¸ªå®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ä¸­ cipher AES-256-CBC # æŒä¹…åŒ–é€‰é¡¹å¯ä»¥å°½é‡é¿å…è®¿é—®é‚£äº›åœ¨é‡å¯ä¹‹åç”±äºç”¨æˆ·æƒé™é™ä½è€Œæ— æ³•è®¿é—®çš„æŸäº›èµ„æº persist-key persist-tun #æ—¥å¿—æ–‡ä»¶ status /var/log/openvpn-status.log # ä¸ºæ—¥å¿—æ–‡ä»¶è®¾ç½®é€‚å½“çš„å†—ä½™çº§åˆ«(0~9) # å†—ä½™çº§åˆ«è¶Šé«˜ï¼Œè¾“å‡ºçš„ä¿¡æ¯è¶Šè¯¦ç»† # # 0 è¡¨ç¤ºé™é»˜è¿è¡Œï¼Œåªè®°å½•è‡´å‘½é”™è¯¯ # 4 è¡¨ç¤ºåˆç†çš„å¸¸è§„ç”¨æ³• # 5å’Œ6 å¯ä»¥å¸®åŠ©è°ƒè¯•è¿æ¥é”™è¯¯ # 9 è¡¨ç¤ºæåº¦å†—ä½™ï¼Œè¾“å‡ºéå¸¸è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ verb 3 # é€šçŸ¥å®¢æˆ·ç«¯ï¼Œå½“æœåŠ¡å™¨é‡æ–°å¯åŠ¨æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨é‡æ–°è¿æ¥ # åªèƒ½æ˜¯UDPåè®®ä½¿ç”¨ï¼ŒTCPä½¿ç”¨çš„è¯ä¸èƒ½å¯åŠ¨æœåŠ¡ # æµ‹è¯•éœ€è¦pushåˆ°å®¢æˆ·ç«¯æ‰æœ‰æ•ˆæœ #explicit-exit-notify 1 explicit-exit-notify 1 script-security 2 client-connect /etc/openvpn/script/connect.sh client-disconnect /etc/openvpn/script/disconnect.sh connect.sh\n1 2 3 4 5 6 7 8 9 #!/bin/bash Time=`date +%F` if [ -f /etc/openvpn/log/openvpn_$Time.log ];then touch /etc/openvpn/log/openvpn_$Time.log echo \u0026#34;`date \u0026#39;+%F %H:%M:%S\u0026#39;` User $common_name trust_ip $trusted_ip is login,Remote_ip is $ifconfig_pool_remote_ip, Mask is $route_netmask_1\u0026#34; \u0026gt;\u0026gt; /etc/openvpn/log/openvpn_$Time.log else touch /etc/openvpn/log/openvpn_$Time.log echo \u0026#34;`date \u0026#39;+%F %H:%M:%S\u0026#39;` User $common_name trust_ip $trusted_ip is login,Remote_ip is $ifconfig_pool_remote_ip, Mask is $route_netmask_1\u0026#34; \u0026gt;\u0026gt; /etc/openvpn/log/openvpn_$Time.log fi disconnect.sh\n1 2 3 4 5 6 7 8 9 #!/bin/bash Time=`date +%F` if [ -f /etc/openvpn/log/openvpn_$Time.log ];then touch /etc/openvpn/log/openvpn_$Time.log echo \u0026#34;`date \u0026#39;+%F %H:%M:%S\u0026#39;` User $common_name trust_ip $trusted_ip is logout,Remote_ip is $ifconfig_pool_remote_ip, Mask is $route_netmask_1\u0026#34; \u0026gt;\u0026gt; /etc/openvpn/log/openvpn_$Time.log else touch /etc/openvpn/log/openvpn_$Time.log echo \u0026#34;`date \u0026#39;+%F %H:%M:%S\u0026#39;` User $common_name trust_ip $trusted_ip is logout,Remote_ip is $ifconfig_pool_remote_ip, Mask is $route_netmask_1\u0026#34; \u0026gt;\u0026gt; /etc/openvpn/log/openvpn_$Time.log fi å¼€å¯forwardè½¬å‘ 1 2 3 4 systemctl stop firewalld systemctl mask firewalld setenforce 0\t# ä¸´æ—¶å…³é—­ sed -i \u0026#39;s/SELINUX=enforcing/SELINUX=disabled/g\u0026#39; /etc/selinux/config\t1 2 3 echo net.ipv4.ip_forward = 1 \u0026gt;\u0026gt;/etc/sysctl.conf sysctl -p é…ç½®iptablesè§„åˆ™ 1 2 3 systemctl enable iptables systemctl start iptables iptables -F # æ¸…ç†æ‰€æœ‰é˜²ç«å¢™è§„åˆ™ å°† openvpn çš„ç½‘ç»œæµé‡è½¬å‘åˆ°å…¬ç½‘ï¼šsnat è§„åˆ™\n1 2 3 4 # å¦‚ä¸‹ç½‘æ®µè®°å¾—ä¸server.conf å½“ä¸­å®šä¹‰çš„ç½‘æ®µä¿æŒä¸€è‡´ iptables -t nat -A POSTROUTING -s 10.0.0.0/8 -o eth0 -j MASQUERADE iptables -L -t nat iptables-save \u0026gt; /etc/sysconfig/iptables # iptables è§„åˆ™æŒä¹…åŒ–ä¿å­˜ 1 2 3 4 5 æŠŠiptablesè§„åˆ™å¤‡ä»½åˆ°/etc/sysconfig/iptablesæ–‡ä»¶ä¸­ iptables-save \u0026gt; /etc/sysconfig/iptables æ¢å¤åˆšæ‰å¤‡ä»½çš„è§„åˆ™ iptables-restore \u0026lt; /etc/sysconfig/iptables æˆ‘æµ‹è¯•ç¯å¢ƒçš„iptablesé…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 [dev][root@foxconn-vpn-192.168.83.44 backup_openvpn]# cat /etc/sysconfig/iptables # Generated by iptables-save v1.4.21 on Thu May 6 14:02:02 2021 *nat :PREROUTING ACCEPT [4743102:251117700] :INPUT ACCEPT [2104299:126313633] :OUTPUT ACCEPT [54995:3991628] :POSTROUTING ACCEPT [25003:2044398] :l - [0:0] #è¡¨ç¤ºèµ° 10.0.0.0/8æ•°æ®çš„æºIPéƒ½è½¬æ¢tun0è¿™ä¸ªæ¥å£çš„IPç„¶åè½¬å‘å‡ºå»ã€‚ -A POSTROUTING -d 10.0.0.0/8 -o tun0 -j MASQUERADE #è¡¨ç¤ºèµ° 192.168.0.0/16æ•°æ®çš„æºIPéƒ½è½¬æ¢eth0è¿™ä¸ªæ¥å£çš„IPç„¶åè½¬å‘å‡ºå»ã€‚ -A POSTROUTING -d 192.168.0.0/16 -o eth0 -j MASQUERADE COMMIT # Completed on Thu May 6 14:02:02 2021 # Generated by iptables-save v1.4.21 on Thu May 6 14:02:02 2021 *filter :INPUT ACCEPT [431:383193] :FORWARD ACCEPT [512:393937] :OUTPUT ACCEPT [374:70793] -A FORWARD -d 10.128.199.248/32 -j DROP -A FORWARD -d 10.128.199.254/32 -j DROP COMMIT # Completed on Thu May 6 14:02:02 2021 # Generated by iptables-save v1.4.21 on Thu May 6 14:02:02 2021 *mangle :PREROUTING ACCEPT [64983188:19955544594] :INPUT ACCEPT [32316135:9267024863] :FORWARD ACCEPT [30855150:10615986243] :OUTPUT ACCEPT [31879646:5718904613] :POSTROUTING ACCEPT [62734647:16334877032] COMMIT # Completed on Thu May 6 14:02:02 2021 ç‰¹æ®Šå®¢æˆ·ç«¯é…ç½®ccd 1 2 3 4 5 6 7 8 9 [dev][root@foxconn-vpn-192.168.83.44 ccd]# pwd /etc/openvpn/ccd [dev][root@foxconn-vpn-192.168.83.44 ccd]# ls lh.dmz [dev][root@foxconn-vpn-192.168.83.44 ccd]# cat lh.dmz iroute 10.0.0.0 255.0.0.0 #10.0.0.0/8å­ç½‘ç½‘æ®µåº”è¯¥è¢«è·¯ç”±åˆ°lh.dmz #irouteæ§åˆ¶äº†ä»OpenVPNæœåŠ¡å™¨åˆ°è¿œç¨‹å®¢æˆ·ç«¯çš„è·¯ç”± #å’Œå‰é¢server.conf é…ç½®ç›¸äº’ route 10.0.0.0 255.0.0.0 é…åˆ æ˜¯å¦å…è®¸client2å­ç½‘(10.0.0.0/8)å’Œå…¶å®ƒå®¢æˆ·ç«¯ä¹‹é—´çš„ç½‘ç»œæµé‡ã€‚å¦‚æœæ˜¯ï¼Œæ·»åŠ ä¸‹é¢çš„è¯­å¥åˆ°æœåŠ¡å™¨é…ç½®æ–‡ä»¶ä¸­ï¼š(ç›®å‰çš„ç¯å¢ƒæš‚æ—¶æ²¡æœ‰ç”¨åˆ°)\n1 2 3 client-to-client push \u0026#34;route 10.0.0.0 255.0.0.0\u0026#34; #è¿™ä¼šè®©OpenVPNæœåŠ¡å™¨é€šå‘Šclient2çš„å­ç½‘åˆ°å…¶å®ƒå®¢æˆ·ç«¯ã€‚ æœåŠ¡ç«¯è„šæœ¬é…ç½® é’‰é’‰å‘é€æ¥å£è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 #!/usr/bin/python # -*- coding: utf-8 -*- import requests import json import sys import os import time import hmac import hashlib import base64 import urllib def signature(): timestamp = long(round(time.time() * 1000)) secret = \u0026#39;xxxxxxxxxx\u0026#39; secret_enc = bytes(secret).encode(\u0026#39;utf-8\u0026#39;) string_to_sign = \u0026#39;{0}\\n{1}\u0026#39;.format(timestamp, secret) string_to_sign_enc = bytes(string_to_sign).encode(\u0026#39;utf-8\u0026#39;) hmac_code = hmac.new(secret_enc, string_to_sign_enc, digestmod=hashlib.sha256).digest() sign = urllib.quote_plus(base64.b64encode(hmac_code)) return timestamp,sign def Dingtalk_Push(title, message, msgtype=None): (timestamp,sign) = signature() headers = {\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json;charset=utf-8\u0026#39;} token = \u0026#34;xxxxxxxxxxxxxxxxxxxxxxxxxx\u0026#34; api_url = \u0026#34;https://oapi.dingtalk.com/robot/send?access_token=%s\u0026amp;timestamp=%s\u0026amp;sign=%s\u0026#34; % (token,timestamp,sign) json_data = { \u0026#34;msgtype\u0026#34;: \u0026#34;markdown\u0026#34;, \u0026#34;markdown\u0026#34;: { \u0026#34;title\u0026#34;: title, \u0026#34;text\u0026#34;: message.replace(\u0026#39;\\r\u0026#39;,\u0026#39;\\n\u0026#39;).replace(\u0026#39;\\\\n\u0026#39;,\u0026#39;\\n\u0026#39;) }, \u0026#34;at\u0026#34;: { \u0026#34;isAtAll\u0026#34;: True } } with open(\u0026#34;/tmp/dd_notice.log\u0026#34;, \u0026#34;w\u0026#34;) as f: f.write(json.dumps(json_data)) requests.post(api_url,json.dumps(json_data),headers=headers).text if __name__ == \u0026#39;__main__\u0026#39;: title = sys.argv[1] message = sys.argv[2] Dingtalk_Push(title, message) çº¿è·¯æ£€æŸ¥-ä¸»å¤‡åˆ‡æ¢è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 #!/bin/bash #Check To Fox Network Script PingCheck(){ ip=$1 status_code=0 for i in {1..3} do /usr/sbin/fping -c 10 -t 1 $ip \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 if [ $? != 0 ];then status_code=$(expr $status_code + 1) fi sleep 1 done echo $status_code } CheckLine(){ if [ -f /etc/openvpn/ccd/lh.fox ];then echo \u0026#34;lh.fox\u0026#34; elif [ -f /etc/openvpn/ccd/lh.dmz ];then echo \u0026#34;lh.dmz\u0026#34; fi } ChangeLine(){ S_Line=$1 D_Line=$2 mv /etc/openvpn/ccd/$S_Line /etc/openvpn/ccd/$D_Line kill $(ps -ef |grep \u0026#34;/sbin/openvpn --daemo[n]\u0026#34;|awk \u0026#39;{print $2}\u0026#39;) sleep 3 /sbin/openvpn --daemon --config /etc/openvpn/server.conf --log-append /var/log/openvpn.log } #Start Check M_IP=\u0026#34;192.168.255.10\u0026#34; B_IP=\u0026#34;192.168.255.6\u0026#34; M_S=$(PingCheck $M_IP) Line=$(CheckLine) if [ \u0026#34;$M_S\u0026#34; = \u0026#34;3\u0026#34; ] \u0026amp;\u0026amp; [ \u0026#34;$Line\u0026#34; = \u0026#34;lh.dmz\u0026#34; ];then B_S=$(PingCheck $B_IP) if [ \u0026#34;$B_S\u0026#34; = \u0026#34;3\u0026#34; ];then msg=\u0026#34;$(date +\u0026#34;%Y/%m/%d %H:%M:%S\u0026#34;)\\\\\\nå£¹åŸToå‚åŒºï¼šä¸»çº¿è·¯ä¸å¤‡ç”¨çº¿è·¯å‡å¼‚å¸¸\u0026#34; else msg=\u0026#34;$(date +\u0026#34;%Y/%m/%d %H:%M:%S\u0026#34;)\\\\\\nå£¹åŸToå‚åŒºï¼šä¸»çº¿è·¯å¼‚å¸¸ï¼Œåˆ‡æ¢å¤‡ç”¨çº¿è·¯\u0026#34; fi ChangeLine lh.dmz lh.fox /usr/bin/python /etc/openvpn/script/dd-notice.py \u0026#34;å£¹åŸToå‚åŒºç½‘ç»œå‘Šè­¦\u0026#34; \u0026#34;$msg\u0026#34; elif [ \u0026#34;$M_S\u0026#34; = \u0026#34;0\u0026#34; ] \u0026amp;\u0026amp; [ \u0026#34;$Line\u0026#34; = \u0026#34;lh.fox\u0026#34; ];then msg=\u0026#34;$(date +\u0026#34;%Y/%m/%d %H:%M:%S\u0026#34;)\\\\\\nå£¹åŸToå‚åŒºï¼šä¸»çº¿è·¯æ¢å¤ï¼Œåˆ‡å›ä¸»çº¿è·¯\u0026#34; ChangeLine lh.fox lh.dmz /usr/bin/python /etc/openvpn/script/dd-notice.py \u0026#34;å£¹åŸToå‚åŒºç½‘ç»œå‘Šè­¦\u0026#34; \u0026#34;$msg\u0026#34; fi å®šæ—¶ä»»åŠ¡ 1 */5 * * * * /bin/bash -x /etc/openvpn/script/check-network.sh \u0026gt; /tmp/debug.log 2\u0026gt;\u0026amp;1 openvpnç®¡ç†è„šæœ¬ï¼ˆç¬¬ä¸€ç‰ˆï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 #!/bin/bash USER=$2 PASS=$(echo \u0026#34;${USER}@xxxx.com $(date)\u0026#34;|md5sum |cut -b 1-12) CA_PASS=\u0026#34;xxxxx.88\u0026#34; OVDIR=\u0026#34;/etc/openvpn\u0026#34; SER_ERSA=\u0026#34;${OVDIR}/easy-rsa/3.0.6\u0026#34; CLI_ERSA=\u0026#34;${OVDIR}/easy-rsa/3.0.6\u0026#34; KEYS_DIR=\u0026#34;${OVDIR}/client\u0026#34; DB_FILE=\u0026#34;${SER_ERSA}/pki/index.txt\u0026#34; if [ ! -f /bin/expect ];then echo \u0026#34;expect is not installed, start the installation...\u0026#34; yum -y install expect if [ $? != 0 ];then echo \u0026#34;Installation failed, please install manually\u0026#34; exit 1 fi fi function GenerateAkey(){ rlist=$(find /etc/openvpn/ -name \u0026#34;${USER}*\u0026#34;) if [ -n \u0026#34;$rlist\u0026#34; ];then echo \u0026#34;ç”¨æˆ·: ${USER} å·²å­˜åœ¨\u0026#34; exit 1 fi cd ${CLI_ERSA}/ /bin/expect \u0026lt;\u0026lt;EOF spawn ./easyrsa gen-req $USER expect \u0026#34;Enter PEM pass phrase:\u0026#34; send \u0026#34;${PASS}\\r\u0026#34; expect \u0026#34;Verifying - Enter PEM pass phrase\u0026#34; send \u0026#34;${PASS}\\r\u0026#34; expect \u0026#34;Common Name\u0026#34; send \u0026#34;\\r\u0026#34; expect eof EOF } function GenerateAconf(){ cat \u0026gt; ${KEYS_DIR}/${USER}/${USER}.ovpn \u0026lt;\u0026lt;EOF client dev tun proto udp remote xxx.xxx.xxx.xxx 1194 resolv-retry infinite nobind persist-key persist-tun ca ca.crt cert ${USER}.crt key ${USER}.key remote-cert-tls server tls-auth ta.key 1 cipher AES-256-CBC verb 3 EOF } function ImportAkey(){ cd ${SER_ERSA}/ ./easyrsa import-req ${CLI_ERSA}/pki/reqs/${USER}.req ${USER} /bin/expect \u0026lt;\u0026lt;EOF spawn ./easyrsa sign client $USER expect \u0026#34;Confirm request details:\u0026#34; send \u0026#34;yes\\r\u0026#34; expect \u0026#34;Enter pass phrase for\u0026#34; send \u0026#34;${CA_PASS}\\r\u0026#34; expect eof EOF } function CreateUser(){ GenerateAkey ImportAkey mkdir ${KEYS_DIR}/${USER} cp ${SER_ERSA}/pki/issued/${USER}.crt ${KEYS_DIR}/${USER}/ cp ${CLI_ERSA}/pki/private/${USER}.key ${KEYS_DIR}/${USER}/ cp ${OVDIR}/{ca.crt,ta.key} ${KEYS_DIR}/${USER}/ cd ${KEYS_DIR}/ GenerateAconf zip -r ${USER}.zip ${USER}/ if [ -d ${USER} ];then rm -rf ${USER} fi echo -e \u0026#34;\\033[32mPlease Download ${KEYS_DIR}/${USER}.zip\\033[0m\u0026#34; if [ -f ${SER_ERSA}/pki/issued/${USER}.crt ];then #/bin/python2.7 /etc/openvpn/script/mail.py reg ${USER} ${PASS} ${KEYS_DIR}/${USER}.zip echo -e \u0026#34;\\033[32mSenMail To ${USER}@fujfu.com\\033[0m\u0026#34; else echo -e \u0026#34;\\033[31mUser creation failed\\033[0m\u0026#34; fi } function RemoveUser(){ rlist=$(find /etc/openvpn/ -name \u0026#34;${USER}*\u0026#34;) if [ ! -n \u0026#34;$rlist\u0026#34; ];then echo \u0026#34;ç”¨æˆ·: ${USER} ä¸å­˜åœ¨\u0026#34; exit 1 fi echo -e \u0026#34;\\033[31m${rlist}\\033[0m\u0026#34; read -p \u0026#34;ä¸Šè¿°æ–‡ä»¶å°†è¢«ç§»é™¤,è¯·ç¡®è®¤(yes/no): \u0026#34; yn if [ \u0026#34;$yn\u0026#34; = \u0026#34;yes\u0026#34; ];then for f in $rlist;do rm -rf $f if [ $? = 0 ];then echo -e \u0026#34;\\033[31m$f\\033[0m \\033[32m[del]\\033[0m\u0026#34; else echo -e \u0026#34;\\033[31m$f\\033[0m \\033[31m[fail]\\033[0m\u0026#34; fi sleep 0.5 done sed -i \u0026#34;/=${USER}$/d\u0026#34; ${DB_FILE} if [ $? = 0 ];then cd ${SER_ERSA}/ /bin/expect \u0026lt;\u0026lt;EOF spawn ./easyrsa update-db expect \u0026#34;Enter pass phrase for\u0026#34; send \u0026#34;${CA_PASS}\\r\u0026#34; expect eof EOF echo -e \u0026#34;\\033[31m${DB_FILE}\\033[0m \\033[32m[update]\\033[0m\u0026#34; else echo -e \u0026#34;\\033[31m${DB_FILE}\\033[0m \\033[32m[fail]\\033[0m\u0026#34; fi else exit 0 fi } function RevokeUser(){ rlist=$(find /etc/openvpn/ -name \u0026#34;${USER}*\u0026#34;) if [ ! -n \u0026#34;$rlist\u0026#34; ];then echo \u0026#34;ç”¨æˆ·: ${USER} ä¸å­˜åœ¨\u0026#34; exit 1 fi cd ${SER_ERSA}/ /bin/expect \u0026lt;\u0026lt;EOF spawn ./easyrsa revoke ${USER} expect \u0026#34;Continue with revocation\u0026#34; send \u0026#34;yes\\r\u0026#34; expect \u0026#34;Enter pass phrase for\u0026#34; send \u0026#34;${CA_PASS}\\r\u0026#34; expect eof EOF } function Gencrl(){ cd ${SER_ERSA}/ /bin/expect \u0026lt;\u0026lt;EOF spawn ./easyrsa gen-crl expect \u0026#34;Enter pass phrase for\u0026#34; send \u0026#34;${CA_PASS}\\r\u0026#34; expect eof EOF } case \u0026#34;$1\u0026#34; in start) /usr/sbin/openvpn --daemon --config /etc/openvpn/server.conf --log-append /var/log/openvpn.log ;; restart) /usr/bin/pkill --signal SIGHUP --exact openvpn ;; add) if [ -n \u0026#34;$2\u0026#34; ];then CreateUser else echo $\u0026#34;Usage: $0 add username\u0026#34; fi ;; remove) if [ -n \u0026#34;$2\u0026#34; ];then RevokeUser Gencrl RemoveUser else echo $\u0026#34;Usage: $0 remove username\u0026#34; fi ;; *) echo $\u0026#34;Usage: $0 {start|restart|add|remove} username\u0026#34; exit 1 esac openvpnç®¡ç†è„šæœ¬ï¼ˆç¬¬äºŒç‰ˆï¼‰ ä¸ºäº†ç®€åŒ–å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶çš„ç®¡ç†ï¼ŒOpenVPN æä¾›äº†ä¸€ç§ä¾¿æ·çš„å†…è”æ–‡ä»¶æ–¹å¼ï¼Œå…è®¸ç”¨æˆ·å°†æ ¹è¯ä¹¦ï¼ˆca.crtï¼‰ã€å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆclient.crtï¼‰ä»¥åŠå®¢æˆ·ç«¯ç§é’¥ï¼ˆclient.keyï¼‰ç­‰å¿…è¦æ–‡ä»¶ç›´æ¥åµŒå…¥åˆ°é…ç½®æ–‡ä»¶ä¸­ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç”¨æˆ·æ— éœ€åˆ†åˆ«ç®¡ç†å¤šä¸ªæ–‡ä»¶ï¼Œä»è€Œæé«˜äº†é…ç½®çš„ä¾¿æ·æ€§å’Œå®‰å…¨æ€§ã€‚ å…·ä½“æ¥è¯´ï¼Œç”¨æˆ·å¯ä»¥åœ¨OpenVPNçš„é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯.ovpnæ–‡ä»¶ï¼‰ä¸­ï¼Œé€šè¿‡ç‰¹å®šçš„æŒ‡ä»¤å°†è¿™äº›è¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶çš„å†…å®¹ç›´æ¥åŒ…å«è¿›æ¥ã€‚è¿™æ ·ï¼Œå½“é…ç½®æ–‡ä»¶è¢«åŠ è½½æ—¶ï¼ŒOpenVPNä¼šè‡ªåŠ¨è¯»å–å¹¶åº”ç”¨è¿™äº›å†…è”çš„è¯ä¹¦å’Œå¯†é’¥ä¿¡æ¯ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨æŒ‡å®šè¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶çš„è·¯å¾„ã€‚ è¿™ç§æ–¹æ³•ä¸ä»…ä½¿å¾—æ–‡ä»¶ç®¡ç†æ›´ä¸ºé›†ä¸­å’Œé«˜æ•ˆï¼Œè€Œä¸”ä¹Ÿå‡å°‘äº†é…ç½®é”™è¯¯çš„å¯èƒ½æ€§ï¼Œå› ä¸ºæ‰€æœ‰çš„ä¿¡æ¯éƒ½åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œç”¨æˆ·åªéœ€ç»´æŠ¤ä¸€ä¸ªé…ç½®æ–‡ä»¶å³å¯ã€‚è¿™å¯¹äºç”¨æˆ·æ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ä¾¿åˆ©ï¼Œç‰¹åˆ«æ˜¯å¯¹äºé‚£äº›éœ€è¦é¢‘ç¹éƒ¨ç½²å’Œæ›´æ–°VPNé…ç½®çš„åœºæ™¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 #!/bin/bash #è·å–ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•° USER=$2 PASS=$(echo \u0026#34;${USER} $(date)\u0026#34; | md5sum | cut -b 1-12) CA_PASS=\u0026#34;xxxx.88\u0026#34; OVDIR=\u0026#34;/etc/openvpn\u0026#34; SER_ERSA=\u0026#34;${OVDIR}/easy-rsa/3.0.6\u0026#34; CLI_ERSA=\u0026#34;${OVDIR}/easy-rsa/3.0.6\u0026#34; KEYS_DIR=\u0026#34;${OVDIR}/client\u0026#34; DB_FILE=\u0026#34;${SER_ERSA}/pki/index.txt\u0026#34; #åˆ¤æ–­æ˜¯å¦å®‰è£…expect if [ ! -f /bin/expect ]; then echo \u0026#34;expect is not installed, start the installation...\u0026#34; yum -y install expect if [ $? != 0 ]; then echo \u0026#34;Installation failed, please install manually\u0026#34; exit 1 fi fi function GenerateAkey() { #åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ rlist=$(find /etc/openvpn/ -name \u0026#34;${USER}*\u0026#34;) if [ -n \u0026#34;$rlist\u0026#34; ]; then echo \u0026#34;ç”¨æˆ·: ${USER} å·²å­˜åœ¨\u0026#34; exit 1 fi cd ${CLI_ERSA}/ || exit # ç”Ÿæˆå®¢æˆ·å•çš„è¯ä¹¦ /bin/expect \u0026lt;\u0026lt;EOF spawn ./easyrsa gen-req $USER expect \u0026#34;Enter PEM pass phrase:\u0026#34; send \u0026#34;${PASS}\\r\u0026#34; expect \u0026#34;Verifying - Enter PEM pass phrase\u0026#34; send \u0026#34;${PASS}\\r\u0026#34; expect \u0026#34;Common Name\u0026#34; send \u0026#34;\\r\u0026#34; expect eof EOF } #ç”Ÿæˆå•ä¸ªé…ç½®æ–‡ä»¶ new_client() { # Generates the custom client.ovpn { cat /etc/openvpn/server/client-common.txt echo \u0026#34;\u0026lt;ca\u0026gt;\u0026#34; cat /etc/openvpn/easy-rsa/3.0.6/pki/ca.crt echo \u0026#34;\u0026lt;/ca\u0026gt;\u0026#34; echo \u0026#34;\u0026lt;cert\u0026gt;\u0026#34; sed -ne \u0026#39;/BEGIN CERTIFICATE/,$ p\u0026#39; /etc/openvpn/easy-rsa/3.0.6/pki/issued/\u0026#34;$USER\u0026#34;.crt echo \u0026#34;\u0026lt;/cert\u0026gt;\u0026#34; echo \u0026#34;\u0026lt;key\u0026gt;\u0026#34; cat /etc/openvpn/easy-rsa/3.0.6/pki/private/\u0026#34;$USER\u0026#34;.key echo \u0026#34;\u0026lt;/key\u0026gt;\u0026#34; echo \u0026#34;key-direction 1\u0026#34; echo \u0026#34;\u0026lt;tls-auth\u0026gt;\u0026#34; sed -ne \u0026#39;/BEGIN OpenVPN Static key/,$ p\u0026#39; /etc/openvpn/server/ta.key echo \u0026#34;\u0026lt;/tls-auth\u0026gt;\u0026#34; } \u0026gt;~/\u0026#34;$USER\u0026#34;.ovpn } function ImportAkey() { cd ${SER_ERSA}/ || exit #å¯¼å…¥clientç­¾çº¦è¯ä¹¦ ./easyrsa import-req ${CLI_ERSA}/pki/reqs/${USER}.req ${USER} #ç»™clientç«¯è¯ä¹¦åšç­¾å /bin/expect \u0026lt;\u0026lt;EOF spawn ./easyrsa sign client $USER expect \u0026#34;Confirm request details:\u0026#34; send \u0026#34;yes\\r\u0026#34; expect \u0026#34;Enter pass phrase for\u0026#34; send \u0026#34;${CA_PASS}\\r\u0026#34; expect eof EOF } #åˆ›å»ºè¯ä¹¦ç›®å½•ï¼Œè¿›è¡Œå½’çº³ å‹ç¼©ï¼Œå‘é€é‚®ä»¶ function CreateUser() { GenerateAkey ImportAkey echo \u0026#34; client dev tun proto tcp remote xxx.xxx.xxx.xxx 11191 resolv-retry infinite nobind persist-key persist-tun remote-cert-tls server cipher AES-256-CBC block-outside-dns verb 3\u0026#34; \u0026gt;/etc/openvpn/server/client-common.txt new_client echo -e \u0026#34;\\033[32mPlease Download ${KEYS_DIR}/${USER}-yc.zip\\033[0m\u0026#34; echo -e \u0026#34;\u0026#34; #åˆ¤æ–­client ç”Ÿæˆæ–‡ä»¶å­˜åœ¨ if [ -f ${SER_ERSA}/pki/issued/${USER}.crt ]; then #é€šè¿‡Pythonå‘é€é‚®ä»¶ ï¼ŒåŒ…å«è¯ä¹¦å’Œä½¿ç”¨æ–¹æ³• # /bin/python2.7 /etc/openvpn/script/mail.py ${USER} ${PASS} ${KEYS_DIR}/${USER}-yc.zip # /bin/python2.7 /etc/openvpn/script/mail.py ${USER} ${PASS} ~/\u0026#34;$USER\u0026#34;.ovpn echo -e \u0026#34;\\033[32mSenMail To ${USER}@fujfu.com\\033[0m\u0026#34; echo -e \u0026#34;\\033[32mPrivate Key Password: \\033[0m\\033[31m${PASS}\\033[0m\u0026#34; else echo -e \u0026#34;\\033[31mUser creation failed\\033[0m\u0026#34; fi } #ç§»é™¤è´¦å·æ–‡ä»¶ function RemoveUser() { #åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ rlist=$(find /etc/openvpn/ -name \u0026#34;${USER}*\u0026#34;) if [ ! -n \u0026#34;$rlist\u0026#34; ]; then echo \u0026#34;ç”¨æˆ·: ${USER} ä¸å­˜åœ¨\u0026#34; exit 1 fi echo -e \u0026#34;\\033[31m${rlist}\\033[0m\u0026#34; read -p \u0026#34;ä¸Šè¿°æ–‡ä»¶å°†è¢«ç§»é™¤,è¯·ç¡®è®¤(yes/no): \u0026#34; yn if [ \u0026#34;$yn\u0026#34; = \u0026#34;yes\u0026#34; ]; then for f in $rlist; do rm -rf $f if [ $? = 0 ]; then echo -e \u0026#34;\\033[31m$f\\033[0m \\033[32m[del]\\033[0m\u0026#34; else echo -e \u0026#34;\\033[31m$f\\033[0m \\033[31m[fail]\\033[0m\u0026#34; fi done #åˆ é™¤openvpnçš„è¯ä¹¦ä¸­çš„ç”¨æˆ· sed -i \u0026#34;/=${USER}$/d\u0026#34; ${DB_FILE} if [ $? = 0 ]; then cd ${SER_ERSA}/ # update-db å‘½ä»¤æ¥æ›´æ–°è¯ä¹¦æ•°æ®åº“ /bin/expect \u0026lt;\u0026lt;EOF spawn ./easyrsa update-db expect \u0026#34;Enter pass phrase for\u0026#34; send \u0026#34;${CA_PASS}\\r\u0026#34; expect eof EOF echo -e \u0026#34;\\033[31m${DB_FILE}\\033[0m \\033[32m[update]\\033[0m\u0026#34; else echo -e \u0026#34;\\033[31m${DB_FILE}\\033[0m \\033[32m[fail]\\033[0m\u0026#34; fi else exit 0 fi } #åˆ é™¤è´¦å· function RevokeUser() { rlist=$(find /etc/openvpn/ -name \u0026#34;${USER}*\u0026#34;) if [ ! -n \u0026#34;$rlist\u0026#34; ]; then echo \u0026#34;ç”¨æˆ·: ${USER} ä¸å­˜åœ¨\u0026#34; exit 1 fi cd ${SER_ERSA}/ #gen-crlä¼šç”Ÿæˆä¸€ä»½åŠé”€è¯ä¹¦çš„åå•ï¼Œæ”¾åœ¨pki/crl.pemæ–‡ä»¶é‡Œ /bin/expect \u0026lt;\u0026lt;EOF spawn ./easyrsa revoke ${USER} expect \u0026#34;Continue with revocation\u0026#34; send \u0026#34;yes\\r\u0026#34; expect \u0026#34;Enter pass phrase for\u0026#34; send \u0026#34;${CA_PASS}\\r\u0026#34; expect eof EOF } # æ’¤é”€è¯ä¹¦å¹¶åˆ›å»ºCRL # è¿™æ˜¯CAç‰¹å®šçš„ä»»åŠ¡ã€‚ # è¦æ°¸ä¹…æ’¤æ¶ˆå·²é¢å‘çš„è¯ä¹¦ï¼Œè¯·æä¾›å¯¼å…¥æœŸé—´ä½¿ç”¨çš„çŸ­åç§°ï¼š # ./easyrsa revoke EntityName # è¦åˆ›å»ºåŒ…å«æ‰€æœ‰å·²æ’¤é”€çš„è¯ä¹¦çš„æ›´æ–°CRLï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š # ./easyrsa gen-crl function Gencrl() { cd ${SER_ERSA}/ /bin/expect \u0026lt;\u0026lt;EOF spawn ./easyrsa gen-crl expect \u0026#34;Enter pass phrase for\u0026#34; send \u0026#34;${CA_PASS}\\r\u0026#34; expect eof EOF } case \u0026#34;$1\u0026#34; in start) /usr/sbin/openvpn --daemon --config /etc/openvpn/server.conf --log-append /var/log/openvpn.log ;; restart) /usr/bin/pkill --signal SIGHUP --exact openvpn ;; add) if [ -n \u0026#34;$2\u0026#34; ]; then CreateUser else echo $\u0026#34;Usage: $0 add username\u0026#34; fi ;; remove) if [ -n \u0026#34;$2\u0026#34; ]; then RevokeUser Gencrl RemoveUser else echo $\u0026#34;Usage: $0 remove username\u0026#34; fi ;; *) echo $\u0026#34;Usage: $0 {start|restart|add|remove} username\u0026#34; exit 1 ;; esac ä¸Šé¢ç”Ÿæˆä¸‹æ–¹æ ¼å¼é…ç½®æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 client dev tun proto udp sndbuf 0 rcvbuf 0 remote openvpnserver 1194 resolv-retry infinite nobind persist-key persist-tun remote-cert-tls server comp-lzo verb 3 cipher AES-256-CBC script-security 3 key-direction 1 auth-nocache auth-user-pass # ca ca.crt \u0026lt;ca\u0026gt; -----BEGIN CERTIFICATE----- ...... ...... ...... -----END CERTIFICATE----- \u0026lt;/ca\u0026gt; # cert client.crt \u0026lt;cert\u0026gt; Certificate: Data: Version: 3 (0x2) Serial Number: 89:53:31:72:cf:04:52:82:fb:e9:53:fe:82:fc:13:25 Signature Algorithm: sha256WithRSAEncryption Issuer: CN=192.168.1.10 Validity Not Before: Nov 14 03:32:32 2023 GMT Not After : Feb 16 03:32:32 2026 GMT Subject: CN=client Subject Public Key Info: Public Key Algorithm: rsaEncryption Public-Key: (2048 bit) Modulus: ...... ...... ...... Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Basic Constraints: CA:FALSE X509v3 Subject Key Identifier: 6E:0A:D2:EF:CE:55:4F:56:C7:57:D1:77:37:0D:AD:28:EF:A2:C8:41 X509v3 Authority Key Identifier: keyid:1A:CE:DD:A8:65:0E:3D:32:E0:74:17:15:5D:F7:6E:3B:7D:C1:59:05 DirName:/CN=192.168.1.10 serial:D8:A8:9B:71:84:77:C8:9B X509v3 Extended Key Usage: TLS Web Client Authentication X509v3 Key Usage: Digital Signature Netscape Comment: Easy-RSA (3.0.8) Generated Certificate Netscape Cert Type: SSL Client Signature Algorithm: sha256WithRSAEncryption ...... ...... ...... -----BEGIN CERTIFICATE----- ...... ...... ...... -----END CERTIFICATE----- \u0026lt;/cert\u0026gt; # key client.key \u0026lt;key\u0026gt; -----BEGIN PRIVATE KEY----- ...... ...... ...... -----END PRIVATE KEY----- \u0026lt;/key\u0026gt; # tls-crypt ta.key 1 \u0026lt;tls-crypt\u0026gt; # # 2048 bit OpenVPN static key # -----BEGIN OpenVPN Static key V1----- ...... ...... ...... -----END OpenVPN Static key V1----- \u0026lt;/tls-crypt\u0026gt; å¼€é€šè´¦å·è‡ªåŠ¨å‘é€é‚®ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 #!/usr/bin/env python # -*- coding: utf-8 -*- import datetime import smtplib,os,datetime,sys from email.header import Header from email.mime.text import MIMEText from email.mime.base import MIMEBase from email.mime.application import MIMEApplication import email.MIMEMultipart def GenHtml(UserName,UserPass): Data = datetime.datetime.now().strftime(\u0026#39;%Y-%m-%d %H:%M:%S\u0026#39;) html = \u0026#34;\u0026#34;\u0026#34; \u0026lt;html xmlns=\u0026#34;http://www.w3.org/1999/xhtml\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta http-equiv=\u0026#34;Content-Type\u0026#34; content=\u0026#34;text/html; charset=utf-8\u0026#34; /\u0026gt; \u0026lt;style type=\u0026#34;text/css\u0026#34;\u0026gt; table { border-collapse: collapse; font-family: Futura, Arial, sans-serif; } caption { font-size: larger; margin: 1em auto; } th,td { padding: .65em; } th { background: #555 nonerepeat scroll 0 0; border: 1px solid #777; color: #fff; } td { border: 1px solid#000000; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div id=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div id=\u0026#34;content\u0026#34;\u0026gt; \u0026lt;table style=\u0026#34;tablestyle\u0026#34; border=\u0026#34;1\u0026#34;\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td bgcolor=\u0026#34;#66B3FF\u0026#34; style=\u0026#34;color: #F3F3FA\u0026#34; align=\u0026#34;center\u0026#34;\u0026gt;\u0026lt;b\u0026gt;å¼€é€šæ—¶é—´\u0026lt;/b\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;td align=\u0026#34;center\u0026#34;\u0026gt;%s\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td bgcolor=\u0026#34;#66B3FF\u0026#34; style=\u0026#34;color: #F3F3FA\u0026#34; align=\u0026#34;center\u0026#34;\u0026gt;\u0026lt;b\u0026gt;è´¦å·\u0026lt;/b\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;td align=\u0026#34;center\u0026#34;\u0026gt;\u0026lt;font color=\u0026#34;red\u0026#34;\u0026gt;\u0026lt;b\u0026gt;%s\u0026lt;/b\u0026gt;\u0026lt;/font\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td bgcolor=\u0026#34;#66B3FF\u0026#34; style=\u0026#34;color: #F3F3FA\u0026#34; align=\u0026#34;center\u0026#34;\u0026gt;\u0026lt;b\u0026gt;å¯†ç \u0026lt;/b\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;td align=\u0026#34;center\u0026#34;\u0026gt;\u0026lt;font color=\u0026#34;red\u0026#34;\u0026gt;\u0026lt;b\u0026gt;%s\u0026lt;/b\u0026gt;\u0026lt;/font\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td bgcolor=\u0026#34;#66B3FF\u0026#34; style=\u0026#34;color: #F3F3FA\u0026#34; align=\u0026#34;center\u0026#34;\u0026gt;\u0026lt;b\u0026gt;æœ‰æ•ˆæœŸ\u0026lt;/b\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;td align=\u0026#34;center\u0026#34;\u0026gt;\u0026lt;font color=\u0026#34;red\u0026#34;\u0026gt;\u0026lt;b\u0026gt;7å¤©\u0026lt;/b\u0026gt;\u0026lt;/font\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td bgcolor=\u0026#34;#66B3FF\u0026#34; style=\u0026#34;color: #F3F3FA\u0026#34; align=\u0026#34;center\u0026#34;\u0026gt;\u0026lt;b\u0026gt;è¯ä¹¦åŠé…ç½®æ–‡ä»¶\u0026lt;/b\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;td align=\u0026#34;center\u0026#34;\u0026gt;\u0026lt;font color=\u0026#34;red\u0026#34;\u0026gt;\u0026lt;b\u0026gt;è§é™„ä»¶\u0026lt;/b\u0026gt;\u0026lt;/font\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;/table\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/br\u0026gt; \u0026lt;h2\u0026gt;ä½¿ç”¨è¯´æ˜:\u0026lt;/h2\u0026gt; \u0026lt;ul\u0026gt;\u0026lt;li\u0026gt;\u0026lt;b\u0026gt;Windows\u0026lt;/b\u0026gt;\u0026lt;/li\u0026gt;\u0026lt;/ul\u0026gt; \u0026lt;p\u0026gt;ä¸‹è½½ openvpn çš„å®‰è£…ç¨‹åº \u0026lt;a href=\u0026#34;https://aliyuncs.com/software/OpenVPN-2.5.3-I601-amd64.msi\u0026#34; title=\u0026#34;OpenVPN-2.5.3-I601-amd64.msi\u0026#34;\u0026gt;OpenVPN-2.5.3-I601-amd64.msi\u0026lt;/a\u0026gt; å®‰è£…å®Œæˆï¼Œå°†è¯ä¹¦æ‹·è´è‡³ OpenVPN\\config ä¸‹å³å¯ï¼Œopenvpn çš„è½¯ä»¶è¯·ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ‰“å¼€ã€‚\u0026lt;/p\u0026gt; \u0026lt;ul\u0026gt;\u0026lt;li\u0026gt;\u0026lt;b\u0026gt;MacOS\u0026lt;/b\u0026gt;\u0026lt;/li\u0026gt;\u0026lt;/ul\u0026gt; \u0026lt;p\u0026gt;ä¸‹è½½ Tunnelblick ç­‰ï¼Œæ”¯æŒopenvpn çš„å®¢æˆ·ç«¯åŒå‡» *.ovpn å³å¯å¯¼å…¥ã€‚\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;ä¸‹è½½ Tunnelblick å®‰è£…ç¨‹åº \u0026lt;a href=\u0026#34;https://aliyuncs.com/software/Tunnelblick_3.8.5a_build_5671.dmg\u0026#34; title=\u0026#34;Tunnelblick_3.8.5a_build_5671.dmg\u0026#34;\u0026gt;Tunnelblick_3.8.5a_build_5671.dmg\u0026lt;/a\u0026gt; \u0026lt;ul\u0026gt;\u0026lt;li\u0026gt;\u0026lt;b\u0026gt;æ¸©é¦¨æç¤º\u0026lt;/b\u0026gt;\u0026lt;/li\u0026gt;\u0026lt;/ul\u0026gt; \u0026lt;p\u0026gt;è¯·å¦¥å–„ä¿ç®¡å¥½ä½ çš„è´¦å·ã€å¯†ç ä»¥åŠå¯†é’¥æ–‡ä»¶ï¼Œå¦‚å‘ç”Ÿä¿¡æ¯ä¸¢å¤±ï¼Œè¯·åŠæ—¶è”ç³»ç®¡ç†å‘˜ã€‚\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; \u0026#34;\u0026#34;\u0026#34; % (Data, UserName, UserPass) return html def VpnMailTo(html, mailSubject, mailto, key_file): mailuser = \u0026#34;yunwei@qq.com\u0026#34; mailpass = \u0026#34;xxxxxxx\u0026#34; server = smtplib.SMTP_SSL(\u0026#39;smtp.qq.com\u0026#39;, 465) server.login(mailuser, mailpass) main_msg = email.MIMEMultipart.MIMEMultipart() text_msg = email.MIMEText.MIMEText(html, _subtype=\u0026#39;html\u0026#39;, _charset=\u0026#39;utf-8\u0026#39;) main_msg.attach(text_msg) contype = \u0026#39;application/octet-stream\u0026#39; maintype, subtype = contype.split(\u0026#39;/\u0026#39;, 1) files = [\u0026#34;/etc/openvpn/script/docs/åŠå…¬å®¤å†…ç½‘OpenVPNä½¿ç”¨æ‰‹å†Œ.docx\u0026#34;, key_file] #for f in files: # data = open(f, \u0026#39;rb\u0026#39;) # file_msg = email.MIMEBase.MIMEBase(maintype, subtype) # file_msg.set_payload(data.read()) # data.close() # email.Encoders.encode_base64(f) # basename = os.path.basename(f) # file_msg.add_header(\u0026#39;Content-Disposition\u0026#39;,\u0026#39;attachment\u0026#39;, filename = f) # main_msg.attach(f) for fs in files: with open(fs,\u0026#39;rb\u0026#39;) as f: basename = os.path.basename(fs) part = MIMEApplication(f.read()) part.add_header(\u0026#39;Content-Disposition\u0026#39;, \u0026#39;attachment\u0026#39;, filename = basename) main_msg.attach(part) main_msg[\u0026#39;From\u0026#39;] = \u0026#39;VPNService \u0026lt;yunwei@qq.com\u0026gt;\u0026#39; main_msg[\u0026#39;Subject\u0026#39;] = Header(mailSubject, \u0026#39;utf8\u0026#39;).encode() main_msg[\u0026#39;To\u0026#39;] = \u0026#34;,\u0026#34;.join(mailto) main_msg[\u0026#39;Date\u0026#39;] = email.Utils.formatdate() server.sendmail(\u0026#39;yunwei@qq.com\u0026#39;, mailto, main_msg.as_string()) def VpnReg(User, Pass, KeysFile): mailSubject = User + \u0026#34; ä½ å¥½ï¼ŒåŠå…¬ç½‘ç»œç¯å¢ƒçš„VPNè´¦å·å·²å¼€é€šæˆåŠŸï¼\u0026#34; html = GenHtml(User,Pass) MailTo = [] MailTo.append(User+\u0026#34;@qq.com\u0026#34;) VpnMailTo(html, mailSubject, MailTo, KeysFile) if __name__ == \u0026#39;__main__\u0026#39;: User = sys.argv[1] Pass = sys.argv[2] KeysFile = sys.argv[3] VpnReg(User,Pass,KeysFile) openvpnç®¡ç† 1 2 3 4 [dev][root@foxconn-vpn-192.168.1.1 script]# pwd /etc/openvpn/script [dev][root@foxconn-vpn-192.168.1.1 script]# ./vpncli -h Usage: ./vpncli {start|restart|add|remove} username openvpn-clientå®¢æˆ·ç«¯ OpenVPN å®¢æˆ·ç«¯é…ç½® - ä¸»èŠ‚ç‚¹ å®¢æˆ·ç«¯æ ‡è¯† ç‰©ç† IP / è™šæ‹Ÿ IP ç›®æ ‡ç½‘ç»œèŒƒå›´ ä¸»èŠ‚ç‚¹ï¼ˆopenvpn-client01ï¼‰ 10.134.18.10 / 192.168.255.10 10.0.0.0/8 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #å®¢æˆ·æ®µ client #ä½¿ç”¨çš„tcpåè®® dev tun ## \u0026#34;dev tun\u0026#34;å°†ä¼šåˆ›å»ºä¸€ä¸ªè·¯ç”±IPéš§é“ proto tcp #vpn serverçš„åœ°å€ remote xxx.xxx.xxx.xxx 1194 # å¯ç”¨è¯¥æŒ‡ä»¤ï¼Œä¸æœåŠ¡å™¨è¿æ¥ä¸­æ–­åå°†è‡ªåŠ¨é‡æ–°è¿æ¥ï¼Œ # è¿™åœ¨ç½‘ç»œä¸ç¨³å®šçš„æƒ…å†µä¸‹(ä¾‹å¦‚ï¼šç¬”è®°æœ¬ç”µè„‘æ— çº¿ç½‘ç»œ)éå¸¸æœ‰ç”¨ resolv-retry infinite # å¤§å¤šæ•°å®¢æˆ·ç«¯ä¸éœ€è¦ç»‘å®šæœ¬æœºç‰¹å®šçš„ç«¯å£å· nobind # æŒä¹…åŒ–é€‰é¡¹å¯ä»¥å°½é‡é¿å…è®¿é—®åœ¨é‡å¯æ—¶ç”±äºç”¨æˆ·æƒé™é™ä½è€Œæ— æ³•è®¿é—®çš„æŸäº›èµ„æº persist-key persist-tun #caè¯ä¹¦ ca ca.crt #å®¢æˆ·ç«¯è¯ä¹¦ cert lh.dmz.crt #å®¢æˆ·ç«¯ç§˜é’¥ key lh.dmz.key # é€šè¿‡æ£€æŸ¥è¯ä¹¦å…·æœ‰æ­£ç¡®çš„å¯†é’¥ä½¿ç”¨è®¾ç½®æ¥éªŒè¯æœåŠ¡å™¨è¯ä¹¦ # è¿™æ˜¯é˜²æ­¢æ­¤å¤„è®¨è®ºçš„æ½œåœ¨æ”»å‡»çš„é‡è¦é¢„é˜²æªæ–½ï¼š # http://openvpn.net/howto.html#mitm # è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼ŒEasyRSAç”ŸæˆæœåŠ¡å™¨è¯ä¹¦çš„æ—¶å€™è¿›è¡Œç›¸å…³è®¾ç½® remote-cert-tls server # å¦‚æœåœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨tls-authå¯†é’¥ï¼Œé‚£ä¹ˆæ¯ä¸ªå®¢æˆ·ç«¯ä¹Ÿå¿…é¡»æ‹¥æœ‰å¯†é’¥ tls-auth ta.key 1 ## é€‰æ‹©ä¸€ä¸ªåŠ å¯†ç®—æ³•ï¼ŒæœåŠ¡å™¨ä½¿ç”¨çš„ç®—æ³•é€‰é¡¹ï¼Œä¹Ÿå¿…é¡»åœ¨è¿™é‡ŒæŒ‡å®šå®ƒ # æ³¨æ„ï¼Œv2.4å®¢æˆ·ç«¯/æœåŠ¡å™¨å°†è‡ªåŠ¨ä»¥TLSæ¨¡å¼åå•†AES-256-GCMã€‚ cipher AES-256-CBC #ä¿¡æ¯æ—¥å¿— verb 3 å¯åŠ¨å®¢æˆ·ç«¯ 1 openvpn --daemon --cd /etc/openvpn/lh.dmz/ --config lh.dmz.ovpn --log-append /var/log/openvpn_dmz.log --askpass /etc/openvpn/lh.dmz/lh.dmz.pass OpenVPN å®¢æˆ·ç«¯é…ç½® - å¤‡èŠ‚ç‚¹ï¼ˆé€šè¿‡ä»£ç†ï¼‰ å®¢æˆ·ç«¯æ ‡è¯† ç‰©ç† IP / è™šæ‹Ÿ IP ç›®æ ‡ç½‘ç»œèŒƒå›´ å¤‡èŠ‚ç‚¹ï¼ˆopenvpn-client02ï¼‰ 10.128.19.10 / 192.168.255.6 10.0.0.0/8 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 client dev tun proto tcp remote xxx.xxx.xxx.xxx 1194 resolv-retry infinite route 192.168.0.0 255.255.0.0 route xxx.xxx.xxx.xxx 255.255.255.255 #å…¬ç½‘è·¯ç”± nobind persist-key persist-tun ca ca.crt cert lh.fox.crt key lh.fox.key remote-cert-tls server tls-auth ta.key 1 cipher AES-256-CBC verb 3 #http-proxy 10.xxx.xxx.xxx 3128 #http-proxy 10.xxx.xxx.xxx 3128 # å¦‚æœé€šè¿‡HTTPä»£ç†æ–¹å¼æ¥è¿æ¥åˆ°å®é™…çš„VPNæœåŠ¡å™¨ # åœ¨æ­¤å¤„æŒ‡å®šä»£ç†æœåŠ¡å™¨çš„ä¸»æœºå(æˆ–IP)å’Œç«¯å£å· # å¦‚æœä»£ç†æœåŠ¡å™¨éœ€è¦èº«ä»½è®¤è¯ï¼Œè¯·å‚è€ƒå®˜æ–¹æ‰‹å†Œ http-proxy 10.xxx.xxx.xxx 3128 # è¿æ¥å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯• http-proxy-retry å¯åŠ¨å®¢æˆ·ç«¯ 1 openvpn --daemon --cd /etc/openvpn/lh.fox --config lh.fox.ovpn --log-append /var/log/openvpn.log --askpass /etc/openvpn/lh.fox/lh.fox.pass #è¿™ä¸ªvpnåœ¨è¿æ¥æ—¶ï¼Œä¼šä½¿ç”¨åˆ°å¯†ç  äº¤æ¢æœºé…ç½® äº¤æ¢æœºæ·»åŠ è·¯ç”±\n10.0.0.0/8 è¿™ä¸ªç½‘æ®µæ˜¯ å¼‚åœ° çš„ç½‘æ®µ\nè®¿é—® 10.0.0.0/8çš„ æ•°æ®ï¼Œä¸‹ä¸€è·³ 192.168.83.44 ï¼ˆopenvpn-serverï¼‰\nå‚è€ƒæ–‡æ¡£ï¼šhttps://www.gaoyufu.cn/archives/openvpn\n","date":"2024-07-29T09:30:50Z","image":"https://www.ownit.top/title_pic/76.jpg","permalink":"https://www.ownit.top/p/202407290930/","title":"é«˜å¯ç”¨openvpnå…¨å±€å•å‘Aè®¿é—®BåŒºçš„ç½‘ç»œ"},{"content":"1ã€èƒŒæ™¯ä»‹ç» ç›®å‰å…¬å¸ä½¿ç”¨PowerDNSè¿›è¡ŒDNSç®¡ç†ï¼Œä½†ç”±äºé‡‡ç”¨çš„æ˜¯å•èŠ‚ç‚¹æ¶æ„ï¼Œå­˜åœ¨ä¸å¯ç”¨çš„é£é™©ã€‚ä¸ºæå‡ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ï¼Œæˆ‘ä»¬è®¡åˆ’å¯¹ç°æœ‰æ¶æ„è¿›è¡Œé‡æ„ã€‚é€šè¿‡å¼•å…¥é«˜å¯ç”¨æ€§è®¾è®¡ï¼Œæˆ‘ä»¬å°†ä¼˜åŒ–ç³»ç»Ÿæ¶æ„ï¼Œä½¿å…¶èƒ½å¤Ÿåœ¨æ•…éšœæƒ…å†µä¸‹ä¾ç„¶ä¿æŒæœåŠ¡çš„è¿ç»­æ€§å’Œé«˜æ•ˆæ€§ï¼Œä»è€Œæå‡æ•´ä½“çš„ä¸šåŠ¡ç¨³å®šæ€§ã€‚\n2ã€ç¯å¢ƒä»‹ç» ç³»ç»Ÿï¼šCnetos7 è½¯ä»¶ï¼š pdns-4.1.8-1.el7.MIND.x86_64 pdns-recursor-4.1.11-1.el7.MIND.x86_64 ï¼ˆç›¸å…³ä¿¡æ¯å·²ç»è„±æ•ï¼‰\nåç§° ip ç»„ä»¶ matser 172.17.20.20 nginxï¼Œmysqlï¼ŒPowerDNS Authoritative ï¼ŒPowerDNS Recursor ï¼ˆä¸»ï¼‰ slave 172.17.20.21 nginxï¼Œmysqlï¼ŒPowerDNS Authoritative ï¼ŒPowerDNS Recursor (å¤‡) nginxï¼ˆ53ï¼‰ï¼šä½œä¸ºupstream ä»£ç† 53 ç«¯å£\nmysqlï¼ˆ3306ï¼‰ï¼šä½œä¸ºPowerDNSçš„åç«¯å­˜å‚¨\nPowerDNS Authoritativeï¼ˆ5300ï¼‰ï¼šç”¨äºç®¡ç†ä¼ä¸šç§æœ‰åŸŸå\nPowerDNS Recursorï¼ˆ5301ï¼‰ï¼š ç”¨äºDNSè§£æè½¬å‘ã€ç¼“å­˜\n3ã€ç»„ä»¶ä»‹ç» PowerDNSå…¨å®¶æ¡¶ä¸­åŒ…å«PowerDNS Authoritativeã€Recursorã€DNSListï¼ˆæš‚ä¸ä½¿ç”¨ï¼‰ä¸‰ä¸ªç»„ä»¶ã€‚\nPowerDNS Authoritativeï¼šDNSæƒå¨æœåŠ¡å™¨ï¼Œç”¨äºæä¾›ä¼ä¸šç§æœ‰åŸŸåçš„ç®¡ç†å’Œè§£æï¼› PowerDNS Recursorï¼šDNSé€’å½’æœåŠ¡å™¨ï¼Œç”¨äºæ¥å—å®¢æˆ·ç«¯DNSæŸ¥è¯¢è¯·æ±‚ï¼Œå¹¶æ ¹æ®ç›®æ ‡åŸŸè½¬å‘é…ç½®è½¬å‘åˆ°ä¸åŒçš„ä¸Šæ¸¸DNSæœåŠ¡å™¨è¿›è¡Œè§£æï¼Œå¹¶å¯¹DNSè§£æè®°å½•è¿›è¡Œç¼“å­˜ï¼› PowerDNS-Adminï¼šDNSæƒå¨æœåŠ¡å™¨çš„Webç®¡ç†é¡µé¢ï¼› PowerDNS-Monitorï¼šä½¿ç”¨Grafanaæä¾›æƒå¨æœåŠ¡å™¨å’Œé€’å½’æœåŠ¡å™¨çš„ç›‘æ§é¡µé¢ PowerDNSæƒå¨æœåŠ¡å™¨æ”¯æŒå¤šç§å¤åˆ¶æ¨¡å¼ï¼Œæœ¬æ¶æ„é‡‡ç”¨MySQLä½œä¸ºåç«¯å­˜å‚¨ï¼Œå¹¶é€šè¿‡MySQLå¤åˆ¶å®ç°ä¸»å¤‡æ•°æ®åŒæ­¥ã€‚\nPowerDNSï¼ˆPDNSï¼‰æˆç«‹äº20ä¸–çºª90å¹´ä»£æœ«ï¼Œæ˜¯å¼€æºDNSè½¯ä»¶ã€æœåŠ¡å’Œæ”¯æŒçš„ä¸»è¦ä¾›åº”å•†ï¼Œå®ƒä»¬æä¾›çš„æƒå¨è®¤è¯DNSæœåŠ¡å™¨å’Œé€’å½’è®¤è¯DNSæœåŠ¡å™¨éƒ½æ˜¯100%å¼€æºçš„è½¯ä»¶ï¼ŒåŒæ—¶ä¹Ÿå’Œçº¢å¸½ç­‰å¼€æºæ–¹æ¡ˆæä¾›å•†ä¸€æ ·æä¾›äº†ä»˜è´¹çš„æŠ€æœ¯æ”¯æŒç‰ˆæœ¬ã€‚åŒæ—¶å®˜æ–¹è¡¨ç¤ºä¸ºäº†é¿å…å’Œè½¯ä»¶ä½¿ç”¨è€…å‡ºç°ç«äº‰ï¼Œä»–ä»¬åªæä¾›æœåŠ¡æ”¯æŒè€Œä¸æä¾›DNSæ‰˜ç®¡æœåŠ¡ã€‚\nç†Ÿæ‚‰DNSå·¥ä½œåŸç†çš„åŒå­¦å¯ä»¥å¤§è‡´åœ°å°†DNSè®°å½•çš„æŸ¥è¯¢åˆ†ä¸ºä¸¤ç§ï¼šæŸ¥è¯¢æœ¬åœ°ç¼“å­˜å’Œå‘ä¸Šé€’å½’æŸ¥è¯¢ã€‚å’Œå…¶ä»–çš„å¦‚BINDã€dnsmasqç­‰å°†è¿™äº›åŠŸèƒ½é›†æˆåˆ°ä¸€èµ·çš„DNSè½¯ä»¶ä¸åŒï¼ŒPowerDNSå°†å…¶ä¸€åˆ†ä¸ºäºŒï¼Œåˆ†ä¸ºäº†PowerDNS Authoritative Serverå’ŒPowerDNS Recursorï¼Œåˆ†åˆ«å¯¹åº”è¿™ä¸¤ç§ä¸»è¦çš„éœ€æ±‚ï¼Œè€Œæˆ‘ä»¬å¸¸è¯´çš„pdnsæŒ‡çš„å°±æ˜¯PowerDNS Authoritative Server (åé¢ç®€ç§°PDNS Auth)ï¼Œä¸»è¦ç”¨é€”å°±æ˜¯ä½œä¸ºæƒå¨åŸŸåæœåŠ¡å™¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½œä¸ºæ™®é€šçš„DNSæœåŠ¡å™¨æä¾›DNSæŸ¥è¯¢åŠŸèƒ½ã€‚\nå¯¹äºPowerDNS-Recursorï¼ŒPowerDNSå®˜ç½‘ä»‹ç»å…¶æ˜¯ä¸€ä¸ªå†…ç½®è„šæœ¬èƒ½åŠ›çš„é«˜æ€§èƒ½çš„DNSé€’å½’æŸ¥è¯¢æœåŠ¡å™¨ï¼Œå¹¶ä¸”å·²ç»ä¸ºä¸€äº¿äº”åƒä¸‡ä¸ªäº’è”ç½‘è¿æ¥æä¾›æ”¯æŒã€‚ 4ã€MySQLå®‰è£… å¯å‚ç…§åšå®¢å®‰è£… ï¼š https://blog.csdn.net/heian_99/article/details/106644755\nMySQLä¸»ä»åŒæ­¥ masteråˆ›å»ºè´¦å· 1 2 3 grant replication slave on *.* to repl@\u0026#39;172.17.20.%\u0026#39; identified by \u0026#39;123\u0026#39;; flush privileges; show master status; #æŸ¥è¯¢masterçš„çŠ¶æ€ ï¼Œè¿›è¡ŒåŒæ­¥ slaveåº“åŒæ­¥ æ³¨æ„ï¼šä¸»ä»åº“çš„server_id ä¸èƒ½è®¾ç½®ä¸€æ ·ï¼Œauto.cnf è®¾ç½®ä¹Ÿä¸èƒ½ä¸€æ ·ï¼Œä¸æ»¡ä¼šå‡ºç°mysqlä¸»ä»åŒæ­¥å¤±è´¥çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 mysql\u0026gt; change master to master_host=\u0026#39;172.17.20.20â€²,master_user=\u0026#39;repl\u0026#39;,master_password=\u0026#39;123\u0026#39;,master_log_file=\u0026#39;mysql-bin.000006â€²,master_log_pos=407; CHANGE MASTER TO MASTER_HOST=\u0026#39;172.17.20.20\u0026#39;, MASTER_PORT=3306, MASTER_USER=\u0026#39;repl\u0026#39;, MASTER_PASSWORD=\u0026#39;123\u0026#39;, MASTER_LOG_FILE=\u0026#39;mysql-bin.000006\u0026#39;, MASTER_LOG_POS=407; mysql\u0026gt; start slave; mysql\u0026gt; show slave status\\G åˆ›å»ºpowerdnsæ•°æ®åº“ éœ€è¦åœ¨ä¸»ä»é…ç½®å®Œæˆååˆ›å»º\nåœ¨ä¸»åº“æ‰§è¡Œä»¥ä¸‹å‘½ä»¤\n1 2 3 4 mysql -uroot -p CREATE DATABASE powerdns; GRANT ALL ON powerdns.* TO \u0026#39;powerdns\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;VMware1!\u0026#39;; FLUSH PRIVILEGES; å¯¼å…¥PowerDNS çš„æ•°æ®åº“\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 CREATE TABLE domains ( id INT AUTO_INCREMENT, name VARCHAR(255) NOT NULL, master VARCHAR(128) DEFAULT NULL, last_check INT DEFAULT NULL, type VARCHAR(6) NOT NULL, notified_serial INT DEFAULT NULL, account VARCHAR(40) CHARACTER SET \u0026#39;utf8\u0026#39; DEFAULT NULL, PRIMARY KEY (id) ) Engine=InnoDB CHARACTER SET \u0026#39;latin1\u0026#39;; CREATE UNIQUE INDEX name_index ON domains(name); CREATE TABLE records ( id BIGINT AUTO_INCREMENT, domain_id INT DEFAULT NULL, name VARCHAR(255) DEFAULT NULL, type VARCHAR(10) DEFAULT NULL, content VARCHAR(64000) DEFAULT NULL, ttl INT DEFAULT NULL, prio INT DEFAULT NULL, change_date INT DEFAULT NULL, disabled TINYINT(1) DEFAULT 0, ordername VARCHAR(255) BINARY DEFAULT NULL, auth TINYINT(1) DEFAULT 1, PRIMARY KEY (id) ) Engine=InnoDB CHARACTER SET \u0026#39;latin1\u0026#39;; CREATE INDEX nametype_index ON records(name,type); CREATE INDEX domain_id ON records(domain_id); CREATE INDEX ordername ON records (ordername); CREATE TABLE supermasters ( ip VARCHAR(64) NOT NULL, nameserver VARCHAR(255) NOT NULL, account VARCHAR(40) CHARACTER SET \u0026#39;utf8\u0026#39; NOT NULL, PRIMARY KEY (ip, nameserver) ) Engine=InnoDB CHARACTER SET \u0026#39;latin1\u0026#39;; CREATE TABLE comments ( id INT AUTO_INCREMENT, domain_id INT NOT NULL, name VARCHAR(255) NOT NULL, type VARCHAR(10) NOT NULL, modified_at INT NOT NULL, account VARCHAR(40) CHARACTER SET \u0026#39;utf8\u0026#39; DEFAULT NULL, comment TEXT CHARACTER SET \u0026#39;utf8\u0026#39; NOT NULL, PRIMARY KEY (id) ) Engine=InnoDB CHARACTER SET \u0026#39;latin1\u0026#39;; CREATE INDEX comments_name_type_idx ON comments (name, type); CREATE INDEX comments_order_idx ON comments (domain_id, modified_at); CREATE TABLE domainmetadata ( id INT AUTO_INCREMENT, domain_id INT NOT NULL, kind VARCHAR(32), content TEXT, PRIMARY KEY (id) ) Engine=InnoDB CHARACTER SET \u0026#39;latin1\u0026#39;; CREATE INDEX domainmetadata_idx ON domainmetadata (domain_id, kind); CREATE TABLE cryptokeys ( id INT AUTO_INCREMENT, domain_id INT NOT NULL, flags INT NOT NULL, active BOOL, content TEXT, PRIMARY KEY(id) ) Engine=InnoDB CHARACTER SET \u0026#39;latin1\u0026#39;; CREATE INDEX domainidindex ON cryptokeys(domain_id); CREATE TABLE tsigkeys ( id INT AUTO_INCREMENT, name VARCHAR(255), algorithm VARCHAR(50), secret VARCHAR(255), PRIMARY KEY (id) ) Engine=InnoDB CHARACTER SET \u0026#39;latin1\u0026#39;; CREATE UNIQUE INDEX namealgoindex ON tsigkeys(name, algorithm); åˆ›å»ºæ–‡ä»¶å¯¼å…¥æ•°æ®åº“\n1 2 3 4 5 6 touch /opt/schema.mysql.sql æŠŠmysqlçš„å†…å®¹å†™åˆ°è¿™ä¸ªæ–‡ä»¶é‡Œé¢ mysql\u0026gt; use powerdns Database changed mysql\u0026gt; source /opt/schema.mysql.sql Query OK, 0 rows affected (0.01 sec) 5ã€PowerDNS Authoritative Serverå®‰è£… å‚è€ƒå®˜ç½‘æ–‡æ¡£ï¼šhttps://doc.powerdns.com/authoritæ–‡ç« æ¥æº(Source)ï¼šhttps://www.dqzboy.comative/installation.html PowerDNSå·²ç»é›†æˆåˆ°epelæºä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆéœ€è¦å®‰è£…elelæº 1 2 3 4 5 6 7 [root@localhost ~]# wget https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm [root@localhost ~]# rpm -ivh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm [root@localhost ~]# yum clean all [root@localhost ~]# yum makecache [root@localhost ~]# yum install -y pdns pdns-backend-mysql ä¿®æ”¹é…ç½®æ–‡ä»¶ /etc/pdns/pdns.conf 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 [root@master ~]# cp /etc/pdns/pdns.conf /etc/pdns/pdns.conf_`date \u0026#39;+%Y_%m_%d\u0026#39;` [root@master ~]# tree /etc/pdns/ /etc/pdns/ â””â”€â”€ pdns.conf 0 directories, 1 file [root@master ~]# cat /etc/pdns/pdns.conf | grep -Ev \u0026#34;^#|^$\u0026#34; launch=bind setgid=pdns setuid=pdns æ·»åŠ é…ç½® ç”Ÿäº§ç¯å¢ƒå¦‚ä¸‹ ############### cache-ttl=60 config-dir=/etc/pdns disable-axfr=yes distributor-threads=3 #æ•°æ®åº“çš„è¿æ¥ä¿¡æ¯ gmysql-dbname=powerdns gmysql-host=127.0.0.1 gmysql-password=VMware1! gmysql-user=powerdns guardian=no launch=gmysql ## pdns config æœ¬åœ°åœ°å€å’Œå¯åŠ¨ç«¯å£ local-address=127.0.0.1 local-port=5300 log-dns-details=no disable-syslog=no negquery-cache-ttl=60 query-cache-ttl=60 query-logging=no receiver-threads=12 cache-ttl=0 setuid=pdns setgid=pdns ## pdns API æ¿€æ´» API æœåŠ¡ api-key=3jEkItlrSHfuqJbr api=yes #webé¡µé¢ä¹Ÿä¿¡æ¯ webserver-address=0.0.0.0 webserver-password=bdata.pdns # webserver-allow-fromæŒ‡å®šå…è®¸è®¿é—®webserverå’ŒAPIçš„IPç™½åå•ï¼Œå¤šä¸ªIPå¯ä»¥ä½¿ç”¨è‹±æ–‡é€—å·éš”å¼€ webserver-allow-from=0.0.0.0/0 webserver-port=8281 webserver=yes loglevel=9 å¯åŠ¨PdnsæœåŠ¡ 1 2 3 4 5 [root@master pdns]# systemctl enable pdns Created symlink from /etc/systemd/system/multi-user.target.wants/pdns.service to /usr/lib/systemd/system/pdns.service. [root@master pdns]# systemctl start pdns.service [root@master pdns]# systemctl status pdns.service 6ã€PowerDNS Recursorå®‰è£… 1 [root@master pdns]# yum install pdns-recursor -y ä¿®æ”¹é…ç½®æ–‡ä»¶ /etc/pdns-recursor/recursor.conf\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 [root@master pdns]# tree /etc/pdns-recursor/ /etc/pdns-recursor/ â””â”€â”€ recursor.conf [root@master pdns]# cp /etc/pdns-recursor/recursor.conf /etc/pdns-recursor/recursor.conf_`date \u0026#39;+%Y_%m_%d\u0026#39;` [root@master pdns]# cat /etc/pdns-recursor/recursor.conf | grep -Ev \u0026#34;^#|^$\u0026#34; security-poll-suffix= setgid=pdns-recursor setuid=pdns-recursor æ·»åŠ é…ç½® ç”Ÿäº§ç¯å¢ƒå¦‚ä¸‹ ############### #å…è®¸æ‰€æœ‰ç”¨æˆ·ç«¯è¯·æ±‚ allow-from=0.0.0.0/0,::/0 ## pdns-re API æ¿€æ´» API æœåŠ¡ api-key=3jEkItlrSHfuqJbr disable-packetcache=no export-etc-hosts=yes #ç”¨æˆ·è§£æçš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ ä¸forward-zonesç›¸åŒï¼Œä»æ–‡ä»¶ä¸­è§£æ forward-zones-file=/etc/pdns-recursor/forward #/etc/hosts æ–‡ä»¶çš„è·¯å¾„æˆ–ç­‰æ•ˆæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å¯ç”¨äºä½¿ç”¨export-etc-hostsæƒå¨åœ°æä¾›æ•°æ®ã€‚ etc-hosts-file=/etc/pdns-recursor/hosts #æœ¬åœ°ç›‘å¬åœ°å€ local-address=0.0.0.0 local-port=5301 max-cache-entries=1000000 max-cache-ttl=60 max-mthreads=1024 max-packetcache-entries=500000 packetcache-servfail-ttl=0 packetcache-ttl=0 quiet=yes setgid=pdns-recursor setuid=pdns-recursor threads=6 #webé¡µé¢ä¹Ÿä¿¡æ¯ webserver-address=0.0.0.0 webserver-password=bdata.pdns webserver-port=8282 webserver-allow-from=172.17.0.0/16 webserver=yes loglevel=9 åˆ›å»ºforward å’Œhosts æ–‡ä»¶ 1. Forward é…ç½® forward é…ç½®ç”¨äºæŒ‡å®š PowerDNS åœ¨æ— æ³•è§£ææŸä¸ª DNS è¯·æ±‚æ—¶ï¼Œå°†è¯·æ±‚è½¬å‘ç»™å…¶ä»–ä¸Šæ¸¸ DNS æœåŠ¡å™¨è¿›è¡Œè§£æã€‚è¿™åœ¨å¤šç§æƒ…å†µä¸‹éƒ½å¾ˆæœ‰ç”¨ï¼Œæ¯”å¦‚å…¬å¸å†…éƒ¨ç½‘ç»œä¸­çš„ DNS æœåŠ¡å™¨éœ€è¦è§£æå¤–éƒ¨äº’è”ç½‘åŸŸåæ—¶ã€‚\nä¸»è¦ç”¨é€”ï¼š\nå¤–éƒ¨è§£æï¼šå¦‚æœæœ¬åœ° DNS æœåŠ¡å™¨æ²¡æœ‰ç›¸åº”çš„è®°å½•ï¼Œå¯ä»¥é€šè¿‡ forward é…ç½®å°†è¯·æ±‚è½¬å‘ç»™å…¬å…± DNS æœåŠ¡å™¨ï¼Œå¦‚ Google DNSï¼ˆ8.8.8.8ï¼‰ã€‚ è´Ÿè½½å‡è¡¡å’Œå†—ä½™ï¼šå¯ä»¥é…ç½®å¤šä¸ªä¸Šæ¸¸ DNS æœåŠ¡å™¨ï¼Œæé«˜è§£æè¯·æ±‚çš„æˆåŠŸç‡å’Œå“åº”é€Ÿåº¦ã€‚ é…ç½®ç¤ºä¾‹ï¼š\n1 forward-zones=.=8.8.8.8;8.8.4.4 ä¸Šé¢çš„ç¤ºä¾‹è¡¨ç¤ºå°†æ‰€æœ‰ï¼ˆ. ä»£è¡¨æ‰€æœ‰åŸŸåï¼‰æœªè§£æçš„è¯·æ±‚è½¬å‘ç»™ Google çš„ DNS æœåŠ¡å™¨ã€‚\n2. Hosts æ–‡ä»¶ hosts æ–‡ä»¶æ˜¯ä¸€ä¸ªé™æ€çš„ DNS è®°å½•æ–‡ä»¶ï¼Œç”¨äºæ‰‹åŠ¨å®šä¹‰ç‰¹å®šåŸŸåçš„ IP åœ°å€ã€‚è¿™ç±»ä¼¼äºä¼ ç»Ÿçš„ /etc/hosts æ–‡ä»¶ï¼Œç”¨äºå¿«é€Ÿã€æœ¬åœ°åŒ–åœ°è§£æä¸€äº›å¸¸ç”¨æˆ–ç‰¹å®šçš„åŸŸåï¼Œè€Œæ— éœ€é€šè¿‡å¤–éƒ¨ DNS æœåŠ¡å™¨ã€‚\nä¸»è¦ç”¨é€”ï¼š\næœ¬åœ°è§£æï¼šå¿«é€Ÿè§£æå¸¸ç”¨åŸŸåï¼Œé¿å…æ¯æ¬¡éƒ½å»æŸ¥è¯¢å¤–éƒ¨ DNSã€‚ è‡ªå®šä¹‰è§£æï¼šä¸ºæœ¬åœ°ç½‘ç»œè®¾å¤‡æˆ–ç‰¹å®šæœåŠ¡è‡ªå®šä¹‰åŸŸåè§£æè®°å½•ã€‚ ç®€åŒ–å¼€å‘å’Œæµ‹è¯•ï¼šå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒä¸­ï¼Œç›´æ¥åœ¨ hosts æ–‡ä»¶ä¸­æ·»åŠ è®°å½•ï¼Œæ–¹ä¾¿å¿«æ·ã€‚ é…ç½®ç¤ºä¾‹ï¼š\nå‡è®¾ hosts æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n1 2 192.168.1.1 server1.local 192.168.1.2 server2.local è¿™è¡¨ç¤ºå°† server1.local è§£æä¸º 192.168.1.1ï¼Œå°† server2.local è§£æä¸º 192.168.1.2ã€‚\næ€»ç»“ Forward é…ç½®ï¼šç”¨äºæŒ‡å®š PowerDNS åœ¨æ— æ³•è§£æè¯·æ±‚æ—¶ï¼Œå°†è¯·æ±‚è½¬å‘ç»™å…¶ä»–ä¸Šæ¸¸ DNS æœåŠ¡å™¨ï¼Œç¡®ä¿è§£æçš„æˆåŠŸç‡å’Œé€Ÿåº¦ã€‚ Hosts æ–‡ä»¶ï¼šç”¨äºæ‰‹åŠ¨å®šä¹‰ç‰¹å®šåŸŸåçš„ IP åœ°å€ï¼Œå®ç°æœ¬åœ°åŒ–ã€é™æ€çš„ DNS è§£æã€‚ é€šè¿‡åˆç†é…ç½®å’Œä½¿ç”¨ forward å’Œ hosts æ–‡ä»¶ï¼Œå¯ä»¥å¤§å¤§æå‡ PowerDNS ç³»ç»Ÿçš„çµæ´»æ€§å’Œè§£ææ•ˆç‡ï¼Œæ»¡è¶³å„ç§ä¸åŒçš„ç½‘ç»œéœ€æ±‚ã€‚\n1 touch {forward,hosts} å€Ÿé‰´é…ç½®\n1 2 3 4 5 6 7 8 9 [root@prometheus-server pdns-recursor]# cat forward +fjf.com=127.0.0.1:5300 +sit.com=127.0.0.1:5300 +fjf=127.0.0.1:5300 +cloudcs.fjf=172.31.0.10 +168.192.in-addr.arpa=127.0.0.1:5300 +30.172.in-addr.arpa=172.31.0.10 +31.172.in-addr.arpa=172.31.0.10 +.=223.5.5.5,223.6.6.6,119.29.29.29 1 2 3 4 5 6 [root@prometheus-server pdns-recursor]# cat hosts 192.168.82.22 mvn.test.com 192.168.84.47 gitlab.test.com 192.168.81.11 mirrors.test.cn 192.168.82.22 img.test.cn 192.168.82.22 test.xxx.com å¯åŠ¨Pdns-recursor 1 2 3 4 5 [root@master pdns-recursor]# systemctl enable pdns-recursor.service Created symlink from /etc/systemd/system/multi-user.target.wants/pdns-recursor.service to /usr/lib/systemd/system/pdns-recursor.service. [root@master pdns-recursor]# systemctl start pdns-recursor [root@master pdns-recursor]# systemctl status pdns-recursor.service 7ã€PowerAdminå®‰è£… 1 2 3 wget https://nchc.dl.sourceforge.net/project/poweradmin/poweradmin-2.1.7.tgz yum -y install php56u php56u-fpm php56u-fpm tengine php56u-mcrypt php56u-pdo php56u-soap php56u-mysqlnd https://linux.cn/article-5623-2.html #è·Ÿéšæ­¤è¿æ¥å®‰è£…å³å¯ å®‰è£…æ­¥éª¤\n1 2 æ‰“å¼€æµè§ˆå™¨ ï¼Œæ‰“å¼€é¡µé¢ http://172.17.20.20:90/install/ éœ€è¦ç§»é™¤ä»PowerAdminçš„æ ¹ç›®å½•ä¸­ç§»é™¤â€œinstallâ€æ–‡ä»¶å¤¹ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š æ·»åŠ ä¸»åŸŸå æ·»åŠ å­åŸŸå 8ã€æˆåŠŸæµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 [root@master pdns-recursor]# cat /etc/resolv.conf # Generated by NetworkManager nameserver 172.17.20.20 [root@master pdns-recursor]# nslookup www.fjf.com Server:\t172.17.20.20 Address:\t172.17.20.20#53 Non-authoritative answer: Name:\twww.fjf.com Address: 172.17.20.21 [root@master pdns-recursor]# nslookup test.fjf.com Server:\t172.17.20.20 Address:\t172.17.20.20#53 Non-authoritative answer: Name:\ttest.fjf.com Address: 172.17.20.21 [root@master pdns-recursor]# nslookup 112.efoxconn.com Server:\t172.17.20.20 Address:\t172.17.20.20#53 Non-authoritative answer: Name:\t112.efoxconn.com Address: 10.134.192.116 9ã€å¤‡æœåŠ¡å™¨åŒä¸Šæ­¥éª¤ å¤‡ä»½æœåŠ¡å™¨ æŒ‰ç…§ä¸Šé¢é…ç½®ï¼Œå¯ä»¥è¿›è¡Œå®‰è£… å’Œé…ç½®æ–‡ä»¶scp\n1 2 3 4 5 6 7 8 9 10 11 12 yum install -y pdns pdns-backend-mysql yum install pdns-recursor -y [root@master pdns-recursor]# scp -r /etc/pdns/* 172.17.20.21:/etc/pdns/ [root@master pdns-recursor]# scp -r /etc/pdns-recursor/* 172.17.20.21:/etc/pdns-recursor/ [root@slave pdns]# systemctl start pdns \u0026amp;\u0026amp;systemctl status pdns [root@slave pdns]# systemctl start pdns-recursor \u0026amp;\u0026amp; systemctl status pdns-recursor.service [root@slave pdns]# systemctl enable pdns \u0026amp;\u0026amp; systemctl enable pdns-recursor 10ã€nginxè´Ÿè½½å‡è¡¡ å®‰è£…nginx\n1 yum install -y nginx æŠŠè¿™ä¸ªé…ç½®åŠ å…¥ nginx.conf åé¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 stream { # æ·»åŠ socketè½¬å‘çš„ä»£ç† upstream dns { server 172.17.20.21:5301 max_fails=3 fail_timeout=3s; server 172.17.20.21:5301 max_fails=3 fail_timeout=3s; } # æä¾›è½¬å‘çš„æœåŠ¡ï¼Œå³è®¿é—®localhost:30001ï¼Œä¼šè·³è½¬è‡³ä»£ç†bss_num_socketæŒ‡å®šçš„è½¬å‘åœ°å€ server { listen 53 udp; proxy_pass dns; proxy_timeout 3s; proxy_connect_timeout 3s; } } 1 2 3 4 5 6 7 8 9 [root@master ~]# netstat -ltunp |grep 53 tcp 0 0 127.0.0.1:5300 0.0.0.0:* LISTEN 39851/pdns_server tcp 0 0 0.0.0.0:53 0.0.0.0:* LISTEN 41809/nginx: master tcp 0 0 0.0.0.0:5301 0.0.0.0:* LISTEN 40930/pdns_recursor tcp6 0 0 :::5300 :::* LISTEN 39851/pdns_server udp 0 0 127.0.0.1:5300 0.0.0.0:* 39851/pdns_server udp 0 0 0.0.0.0:5301 0.0.0.0:* 40930/pdns_recursor udp 0 0 0.0.0.0:53 0.0.0.0:* 41809/nginx: master udp6 0 0 :::5300 :::* 39851/pdns_server å¤‡ä»½æœåŠ¡å™¨çš„nginxä¹Ÿå¦‚ä¸Šé…ç½®å³å¯\n","date":"2024-07-28T17:21:50Z","image":"https://www.ownit.top/title_pic/68.jpg","permalink":"https://www.ownit.top/p/202407281721/","title":"PowerDNSæ¶æ„è§£æä¸å®‰è£…éƒ¨ç½²æŒ‡å—"},{"content":"1ã€é—®é¢˜èƒŒæ™¯ åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç‰ˆæœ¬æ§åˆ¶æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„ç¯èŠ‚ã€‚Git ä½œä¸ºä¸€ç§æµè¡Œçš„åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œè¢«å¹¿æ³›åº”ç”¨äºå„ç§é¡¹ç›®ä¸­ã€‚ç„¶è€Œï¼Œè¿‘æœŸæˆ‘ä»¬å‘ç°åœ¨è¿›è¡Œé¡¹ç›®å‘ç‰ˆæ—¶ï¼ŒGit å…‹éš†é¡¹ç›®çš„æ—¶é—´æ˜¾è‘—å¢åŠ ï¼Œä¸¥é‡å½±å“äº†å‘ç‰ˆçš„æ•ˆç‡ã€‚ç»è¿‡åˆ†æï¼Œæˆ‘ä»¬å‘ç°é—®é¢˜ä¸»è¦å‡ºåœ¨é¡¹ç›®æ–‡ä»¶è¿‡å¤§ï¼Œå¯¼è‡´å…‹éš†è¿‡ç¨‹ç¼“æ…¢ã€‚\nåŸå› ï¼šå¼€å‘è¯¯æ“ä½œä¸Šä¼ JaråŒ…ï¼Œå¯¼è‡´é¡¹ç›®å˜å¤§ï¼Œåé¢å°±ç®—åˆ é™¤jarï¼Œä½†æ˜¯æœ‰commitè®°å½•ï¼Œä¾æ—§å¯¼è‡´æ–‡ä»¶è¿‡å¤§ã€‚ æ­£å¸¸å¤§å°ï¼š226M å¼‚å¸¸å¤§å°ï¼š2.6GB\n2ã€ç¯å¢ƒä»‹ç» é¡¹ç›®åç§°: xxxx_adc_backend ä»£ç æ‰˜ç®¡å¹³å°: GitLab ä¸»è¦åˆ†æ”¯: pre-fjfsim æ¸…ç†å·¥å…·: BFG Repo-Cleaner 3ã€æ¸…ç†åŸå›  åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé¡¹ç›®ä¸­å¼•å…¥äº†ä¸€äº›å¤§æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä¸ä»…å¢åŠ äº†ä»£ç åº“çš„ä½“ç§¯ï¼Œè¿˜å½±å“äº†ä»£ç çš„æ¨é€å’Œæ‹‰å–æ•ˆç‡ã€‚ä¸ºäº†æé«˜é¡¹ç›®çš„æ•´ä½“æ€§èƒ½å’Œç»´æŠ¤æ€§ï¼Œæˆ‘ä»¬å†³å®šé‡‡ç”¨ BFG Repo-Cleaner è¿›è¡Œæ¸…ç†ã€‚\n4ã€æ¸…ç†æ­¥éª¤ 1. å¼€å‘äººå‘˜ç¦æ­¢æ¨é€ä»£ç  åœ¨å¼€å§‹æ¸…ç†ä¹‹å‰ï¼Œéœ€è¦ç¡®ä¿æ‰€æœ‰å¼€å‘äººå‘˜åœæ­¢æ¨é€ä»£ç ï¼Œé¿å…åœ¨æ¸…ç†è¿‡ç¨‹ä¸­äº§ç”Ÿæ–°çš„æäº¤ã€‚\n2. è¿ç»´å¤‡ä»½ä»£ç  è¿ç»´äººå‘˜éœ€è¦å¯¹ xxxx_adc_backend é¡¹ç›®è¿›è¡Œå¤‡ä»½ï¼Œä»¥ä¾¿åœ¨æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜æ—¶å¯ä»¥å¿«é€Ÿå›æ»šã€‚ 3ã€æŸ¥è¯¢å¤§æ–‡ä»¶è®°å½• å‚è€ƒæ–‡æ¡£ï¼šhttps://blog.csdn.net/cysear/article/details/102823671 æ³¨æ„ï¼šè®°å½•æ˜¯commitä¸­ï¼Œæœ€å¥½å®šä½åˆ°æœ‰é—®é¢˜çš„åˆ†æ”¯ï¼Œåœ¨é—®é¢˜åˆ†æ”¯ä¸Šæ“ä½œã€‚æ¯”å¦‚æˆ‘çš„å¤§æ–‡ä»¶è®°å½•ï¼Œåœ¨pre-fjfsim ä¸Šï¼Œæ‰€ä»¥æˆ‘æŒ‡å®šçš„æ˜¯ pre-fjfsim\n1 2 #å…‹éš†ä»“åº“çš„é•œåƒ git clone --mirror -b pre-fjfsim git@gitlab.fujfu.com:ownit/ownit_test.git git clone --mirrorï¼šå…‹éš†ä»“åº“çš„é•œåƒã€‚é•œåƒå…‹éš†ä¼šå…‹éš†æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾ï¼Œä½†ä¸ä¼šå…‹éš†å·¥ä½œç›®å½•å’Œå†å²è®°å½•ã€‚ -b pre-fjfsimï¼šæŒ‡å®šå…‹éš†çš„åˆ†æ”¯ä¸º pre-fjfsimã€‚\ngit@gitlab.fujfu.com:ownit/ownit_test.gitï¼šä»“åº“çš„ URLã€‚\n1 2 #æŸ¥æ‰¾å¤§æ–‡ä»¶çš„ SHA-1 å“ˆå¸Œå€¼ git rev-list --objects --all | grep \u0026#34;$(git verify-pack -v .git/objects/pack/*.idx | sort -k 3 -n | tail -5 | awk \u0026#39;{print$1}\u0026#39;)\u0026#34; git rev-list --objects --allï¼šåˆ—å‡ºæ‰€æœ‰å¯¹è±¡çš„ SHA-1 å“ˆå¸Œå€¼ã€‚ 1 grep \u0026#34;$(git verify-pack -v .git/objects/pack/*.idx | sort -k 3 -n | tail -5 | awk \u0026#39;{print$1}\u0026#39;)\u0026#34; ï¼šè¿™éƒ¨åˆ†æ˜¯ä¸€ä¸ªå¤æ‚çš„ç®¡é“å‘½ä»¤ï¼Œç”¨äºè¿‡æ»¤å‡ºå¤§æ–‡ä»¶çš„ SHA-1 å“ˆå¸Œå€¼ã€‚\ngit verify-pack -v .git/objects/pack/*.idxï¼šéªŒè¯æ‰“åŒ…æ–‡ä»¶ï¼Œå¹¶æ˜¾ç¤ºæ¯ä¸ªå¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ã€‚ sort -k 3 -nï¼šæ ¹æ®ç¬¬ä¸‰åˆ—ï¼ˆæ–‡ä»¶å¤§å°ï¼‰è¿›è¡Œæ•°å­—æ’åºã€‚ tail -5ï¼šæ˜¾ç¤ºæ’åºåçš„æœ€åäº”è¡Œï¼Œé€šå¸¸æ˜¯æœ€å¤§çš„äº”ä¸ªæ–‡ä»¶ã€‚ awk '{print$1}'ï¼šæ‰“å°æ¯è¡Œçš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œå³ SHA-1 å“ˆå¸Œå€¼ã€‚ grepï¼šä½¿ç”¨è¿™äº› SHA-1 å“ˆå¸Œå€¼ä½œä¸ºæœç´¢æ¨¡å¼ï¼Œä» git rev-list --objects --all çš„è¾“å‡ºä¸­è¿‡æ»¤å‡ºç›¸å…³çš„å¯¹è±¡ã€‚ 4ã€ä½¿ç”¨ BFG æ¸…ç†å¤§æ–‡ä»¶ BFG Repo-Cleaner æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿæ¸…ç† Git å†å²ä¸­çš„å¤§æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯å…·ä½“çš„æ¸…ç†æ­¥éª¤ï¼š å‚è€ƒè®°å½•ï¼šhttps://rtyley.github.io/bfg-repo-cleaner/\nå…‹éš†é¡¹ç›® 1 git clone --mirror -b pre-fjfsim git@gitlab.xxxx.com:ownit/ownit_test.git æ¸…é™¤å¤§æ–‡ä»¶ 1 2 java -jar bfg.jar --delete-files xxxx_adc_backend_mac.tgz ownit_test.git java -jar bfg.jar --delete-files xxxx_adc_backend_mac_2024_0202.tgz ownit_test.git åˆ é™¤æ–‡ä»¶é‡æ„ç´¢å¼• 1 2 cd ownit_test git reflog expire --expire=now --all \u0026amp;\u0026amp; git gc --prune=now --aggressive æŸ¥çœ‹å®¹é‡ 1 git count-objects -vH æ›´æ–°è¿œç¨‹ 1 git push -f 5ã€å¼€å‘äººå‘˜æ£€æŸ¥ æ¸…ç†å®Œæˆåï¼Œå¼€å‘äººå‘˜éœ€è¦æ£€æŸ¥ä»£ç åº“æ˜¯å¦æ­£å¸¸ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œåˆ™å¯ä»¥ç»§ç»­æ¨é€ä»£ç ã€‚å¦‚æœå‘ç°å¼‚å¸¸ï¼Œå¯ä»¥æ ¹æ®å¤‡ä»½ä»£ç è¿›è¡Œå›æ»šã€‚\n5ã€æ€»ç»“ é€šè¿‡è¿™æ¬¡æ¸…ç†ï¼Œæˆ‘ä»¬æˆåŠŸåœ°ä» xxxx_adc_backend é¡¹ç›®ä¸­ç§»é™¤äº†ä¸å¿…è¦çš„å¤§æ–‡ä»¶ï¼Œä¸ä»…å‡è½»äº†ä»£ç åº“çš„è´Ÿæ‹…ï¼Œè¿˜æé«˜äº†ä»£ç ç®¡ç†çš„æ•ˆç‡ã€‚BFG Repo-Cleaner ä»¥å…¶é«˜æ•ˆå’Œç¨³å®šæ€§ï¼Œæˆä¸ºäº†æˆ‘ä»¬æ¸…ç† Git å†å²å¤§æ–‡ä»¶çš„é¦–é€‰å·¥å…·ã€‚\n","date":"2024-07-18T11:55:47Z","image":"https://www.ownit.top/title_pic/58.jpg","permalink":"https://www.ownit.top/p/202407181155/","title":"å¤„ç†.gitæ–‡ä»¶å¤¹è¿‡å¤§å‡ºç°è‡ƒè‚¿é—®é¢˜"},{"content":"1ã€å¼•è¨€ åœ¨å½“ä»Šæ•°å­—åŒ–æ—¶ä»£ï¼Œç½‘ç»œå®‰å…¨å·²æˆä¸ºä¼ä¸šå’Œä¸ªäººç”¨æˆ·å…³æ³¨çš„ç„¦ç‚¹ã€‚IPé»‘ç™½åå•ä½œä¸ºä¸€ç§æœ‰æ•ˆçš„ç½‘ç»œå®‰å…¨ç­–ç•¥ï¼Œå…è®¸æˆ‘ä»¬ç²¾ç¡®æ§åˆ¶å¯¹Webèµ„æºçš„è®¿é—®æƒé™ã€‚é€šè¿‡ç™½åå•ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿åªæœ‰å¯ä¿¡çš„IPåœ°å€èƒ½å¤Ÿè®¿é—®æ•æ„Ÿèµ„æºï¼›è€Œé»‘åå•åˆ™å¯ä»¥é˜»æ­¢æ¶æ„IPçš„è®¿é—®ï¼Œä»è€Œå‡å°‘å®‰å…¨é£é™©ã€‚\né€‰æ‹©Nginx OpenRestyä¸Redisä½œä¸ºå®ç°é»‘ç™½åå•çš„è§£å†³æ–¹æ¡ˆï¼Œæ˜¯åŸºäºä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š\né«˜æ€§èƒ½ï¼šNginxä»¥å…¶è½»é‡çº§å’Œé«˜æ€§èƒ½è‘—ç§°ï¼Œé€‚åˆå¤„ç†é«˜å¹¶å‘è¯·æ±‚ã€‚ çµæ´»æ€§ï¼šOpenRestyé€šè¿‡é›†æˆLuaè„šæœ¬ï¼Œæä¾›äº†å¼ºå¤§çš„å®šåˆ¶èƒ½åŠ›ã€‚ å¯æ‰©å±•æ€§ï¼šRedisä½œä¸ºä¸€ä¸ªå†…å­˜æ•°æ®ç»“æ„å­˜å‚¨ï¼Œæ”¯æŒæ•°æ®çš„å¿«é€Ÿè¯»å†™ï¼Œé€‚åˆå®ç°åŠ¨æ€çš„é»‘ç™½åå•ç®¡ç†ã€‚ 2ã€ç®€ä»‹ 1ã€ä»€ä¹ˆæ˜¯OpenRestyï¼Ÿ OpenRestyæ˜¯ä¸€ä¸ªåŸºäºNginxçš„å…¨åŠŸèƒ½Webå¹³å°ï¼Œå®ƒé›†æˆäº†ä¸€ç³»åˆ—ç²¾å¿ƒè®¾è®¡çš„Luaåº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—å’Œä¸€ä¸ªåŸºäºLuaJITçš„è½»é‡çº§Webæ¡†æ¶ã€‚OpenRestyçš„æ ¸å¿ƒæ˜¯Nginxï¼Œä½†å®ƒé€šè¿‡Luaè¯­è¨€æ‰©å±•äº†Nginxçš„åŠŸèƒ½ï¼Œä½¿å…¶èƒ½å¤Ÿæ„å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘çš„åŠ¨æ€Webåº”ç”¨ã€‚\n2ã€OpenRestyä¸Nginxçš„å…³ç³» OpenRestyæ˜¯åœ¨Nginxçš„åŸºç¡€ä¸Šæ„å»ºçš„ï¼Œå®ƒä¿ç•™äº†Nginxçš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶é€šè¿‡Luaè¯­è¨€æ‰©å±•äº†å…¶èƒ½åŠ›ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨OpenRestyæ¥å®ç°Nginxçš„æ‰€æœ‰åŠŸèƒ½ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿåˆ©ç”¨Luaè„šæœ¬æ¥å®ç°æ›´å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚\n3ã€ç¯å¢ƒå®‰è£… 1ã€ç¯å¢ƒç‰ˆæœ¬ 1 2 3 centos 7 redis 7.2 nginx version: openresty/1.25.3.1 2ã€ç¯å¢ƒå®‰è£… 1ã€æ·»åŠ OpenRestyä»“åº“\n1 2 3 4 5 # ç”±äºå…¬å…±åº“ä¸­æ‰¾ä¸åˆ°openrestyï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ openrestyçš„æºä»“åº“ yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo # æ³¨æ„ï¼Œå¦‚æœä¸Šé¢å‘½ä»¤æç¤ºä¸å­˜åœ¨,é‚£å°±å…ˆå®‰è£…ä¸€ä¸‹ yum install -y yum-utils å®‰è£…OpenResty 1 2 3 4 # å®‰è£…openresty yum install -y openresty # å®‰è£…OpenRestyç®¡ç†å·¥å…·ï¼Œå¸®åŠ©æˆ‘ä»¬å®‰è£…ç¬¬ä¸‰æ–¹çš„Luaæ¨¡å— yum install -y openresty-opm 3ã€ç›®å½•ç»“æ„ â€‹ é»˜è®¤å®‰è£…åœ¨/usr/local/openresty çœ‹åˆ°é‡Œé¢æœ‰ä¸€ä¸ªnginxç›®å½•ï¼Œè¿›å»å¯ä»¥çœ‹åˆ°è·Ÿæˆ‘ä»¬å¹³å¸¸ç”¨çš„nginxæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼ŒOpenRestyå°±æ˜¯åœ¨NginxåŸºç¡€ä¸Šé›†æˆäº†ä¸€äº›Luaæ¨¡å—\nåˆ°è¿™é‡Œæˆ‘ä»¬å°±å®‰è£…å¥½äº†\n4ã€å¯åŠ¨å’Œè¿è¡Œ OpenRestyåº•å±‚æ˜¯åŸºäºNginxçš„ï¼ŒæŸ¥çœ‹OpenRestyç›®å½•çš„nginxç›®å½•ï¼Œç»“æ„ä¸windowsä¸­å®‰è£…çš„nginxåŸºæœ¬ä¸€è‡´\n5ã€å®‰è£…é…ç½®redis\n1 sudo yum install redis -y Redisé…ç½®ä¸»è¦åŒ…æ‹¬è®¾ç½®æŒä¹…åŒ–é€‰é¡¹ã€ç½‘ç»œé…ç½®ã€å®‰å…¨æ€§è®¾ç½®ç­‰ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºæœ¬çš„é…ç½®ç¤ºä¾‹ï¼š\n1 2 3 4 5 # redis.conf port 6379 bind 127.0.0.1 protected-mode yes requirepass \u0026#34;yourpassword\u0026#34; 4ã€ç™½åå•å®ç° å›¾ä¾‹è¯´æ˜ï¼š å®¢æˆ·ç«¯ï¼šå‘é€HTTPè¯·æ±‚çš„ç”¨æˆ·æˆ–åº”ç”¨ã€‚ Nginx (OpenResty)ï¼šå¤„ç†å’Œç®¡ç†HTTPè¯·æ±‚ï¼Œæ‰§è¡ŒLuaè„šæœ¬è¿›è¡Œè®¿é—®æ§åˆ¶ã€‚ Luaè„šæœ¬ï¼šåœ¨Nginxä¸­è¿è¡Œï¼Œè´Ÿè´£ä»Redisè·å–ç™½åå•å¹¶è¿›è¡ŒIPæ£€æŸ¥ã€‚ Redisï¼šå­˜å‚¨ç™½åå•æ•°æ®ï¼Œç”¨äºå¿«é€ŸæŸ¥è¯¢ã€‚ äº¤äº’æµç¨‹ï¼š å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°Nginxã€‚ Nginxè°ƒç”¨Luaè„šæœ¬è¿›è¡Œè®¿é—®æ§åˆ¶ã€‚ Luaè„šæœ¬è¿æ¥Redisï¼Œå¹¶æŸ¥è¯¢IPæ˜¯å¦åœ¨ç™½åå•ä¸­ã€‚ Luaè„šæœ¬è¿”å›æŸ¥è¯¢ç»“æœç»™Nginxã€‚ Nginxæ ¹æ®ç»“æœå†³å®šæ˜¯å¦å…è®¸è¯·æ±‚ï¼Œå¹¶è¿”å›å“åº”ç»™å®¢æˆ·ç«¯ å®šä¹‰ç™½åå•çš„ä½œç”¨ä¸é‡è¦æ€§ ç™½åå•æ˜¯ä¸€ç§å®‰å…¨ç­–ç•¥ï¼Œç”¨äºå®šä¹‰ä¸€ç»„è¢«ä¿¡ä»»çš„IPåœ°å€æˆ–å®ä½“ï¼Œå®ƒä»¬è¢«å…è®¸è®¿é—®ç‰¹å®šçš„èµ„æºæˆ–æœåŠ¡ã€‚åœ¨Webåº”ç”¨ä¸­ï¼Œç™½åå•çš„ä½œç”¨å°¤ä¸ºæ˜¾è‘—ï¼š\nå®‰å…¨æ€§å¢å¼ºï¼šé™åˆ¶è®¿é—®æƒé™ï¼Œä»…å…è®¸ç‰¹å®šçš„IPåœ°å€è®¿é—®æ•æ„Ÿèµ„æºã€‚ é˜²æ­¢æ»¥ç”¨ï¼šå‡å°‘æ¶æ„ç”¨æˆ·æˆ–çˆ¬è™«å¯¹æœåŠ¡çš„æ»¥ç”¨ã€‚ æµé‡ç®¡ç†ï¼šé€šè¿‡æ§åˆ¶è®¿é—®æºï¼Œæ›´æœ‰æ•ˆåœ°ç®¡ç†ç½‘ç»œæµé‡ã€‚ é€šè¿‡OpenResty Luaè„šæœ¬å®ç°ç™½åå•é€»è¾‘ åœ¨OpenRestyä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Luaè„šæœ¬æ¥å®ç°ç™½åå•é€»è¾‘ã€‚Luaè„šæœ¬å¯ä»¥åœ¨Nginxçš„é…ç½®æ–‡ä»¶ä¸­ç›´æ¥ç¼–å†™ï¼Œæˆ–è€…å­˜å‚¨åœ¨å¤–éƒ¨æ–‡ä»¶ä¸­ï¼Œå¹¶åœ¨é…ç½®æ–‡ä»¶ä¸­å¼•ç”¨ã€‚\nLuaè„šæœ¬å®ç°æ­¥éª¤ï¼š å®šä¹‰ç™½åå•ï¼šåœ¨Redisä¸­å­˜å‚¨ç™½åå•IPåœ°å€ã€‚ è®¿é—®æ§åˆ¶ï¼šåœ¨Nginxé…ç½®ä¸­ä½¿ç”¨access_by_lua_blockæˆ–access_by_lua_fileæŒ‡ä»¤è°ƒç”¨Luaè„šæœ¬ã€‚ è„šæœ¬é€»è¾‘ï¼šæ£€æŸ¥è¯·æ±‚çš„IPåœ°å€æ˜¯å¦åœ¨ç™½åå•ä¸­ï¼Œå¦‚æœä¸åœ¨ï¼Œåˆ™æ‹’ç»è®¿é—®ã€‚ æ¡ˆä¾‹æ¼”ç¤º jenkins.ownit.top.conf è¿™ä¸ªæ˜¯nginxçš„é…ç½®æ–‡ä»¶ æœ€ä¸»è¦å†…å®¹:access_by_lua_file /opt/nginx/lua_script/white.lua;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 upstream jenkins-uat { server 192.168.102.20:91; } server { listen 80; server_name jenkins.ownit.top; #ç™½åå• æˆ–è€… é»‘åå• #include /opt/nginx/whitelist/corporation.conf; location / { rewrite ^/(.*)$ https://$host/$1 permanent; } access_log /www/wwwlogs/dns.ownit.top.log; error_log /www/wwwlogs/dns.ownit.top.error.log; } server { listen 443 ssl; server_name jenkins.ownit.top; #ç™½åå• æˆ–è€… é»‘åå• #include /opt/nginx/whitelist/corporation.conf; #ssl on; ssl_certificate /opt/nginx/ssl/ownit.top.crt; ssl_certificate_key /opt/nginx/ssl/ownit.top.key; include ssl.conf; location / { access_by_lua_file /opt/nginx/lua_script/white.lua; # nginxçš„luaè„šæœ¬ proxy_pass http://jenkins-uat; include https_proxy.conf; } access_log /www/wwwlogs/dns.ownit.top.log; error_log /www/wwwlogs/dns.ownit.top.error.log; } white.luaæ–‡ä»¶\né€šè¿‡ä½¿ç”¨Luaè„šæœ¬ï¼Œåœ¨æ¥æ”¶åˆ°HTTPè¯·æ±‚æ—¶æ£€æŸ¥è¯·æ±‚çš„IPåœ°å€æ˜¯å¦åœ¨Rediså­˜å‚¨çš„ç™½åå•ä¸­ã€‚å¦‚æœIPä¸åœ¨ç™½åå•ä¸­ï¼Œåˆ™æ‹’ç»è®¿é—®ã€‚\næ€è·¯ è·å–å®¢æˆ·ç«¯IPå’Œè¯·æ±‚è·¯å¾„ï¼šåœ¨Luaè„šæœ¬ä¸­è·å–å®¢æˆ·ç«¯çš„IPåœ°å€å’Œè¯·æ±‚è·¯å¾„ã€‚ è¿æ¥Redisï¼šä½¿ç”¨resty.redisæ¨¡å—è¿æ¥Redisæ•°æ®åº“ã€‚ æƒé™æ ¡éªŒï¼šå¯¹è¿æ¥çš„Redisè¿›è¡Œè®¤è¯ã€‚ æ£€æŸ¥IPæ˜¯å¦åœ¨ç™½åå•ä¸­ï¼šä»Redisä¸­æ£€æŸ¥IPæ˜¯å¦å­˜åœ¨äºç™½åå•é›†åˆä¸­ã€‚ è¿”å›ç»“æœï¼šå¦‚æœIPåœ¨ç™½åå•ä¸­ï¼Œå…è®¸è®¿é—®ï¼›å¦åˆ™ï¼Œè¿”å›403 ForbiddençŠ¶æ€ç ï¼Œæ‹’ç»è®¿é—®ã€‚ é‡Šæ”¾Redisè¿æ¥ï¼šå°†Redisè¿æ¥è¿”å›åˆ°è¿æ¥æ± ä¸­ï¼Œä»¥ä¾¿å¤ç”¨ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 -- è·å–å®¢æˆ·ç«¯IPå’Œè¯·æ±‚è·¯å¾„ local client_ip = ngx.var.remote_addr local path = ngx.var.uri -- Redisç›¸å…³é…ç½® local redis_key_white_list = \u0026#34;map_request_white_list\u0026#34; -- è¿æ¥Redis local redis = require \u0026#34;resty.redis\u0026#34; local red = redis:new() red:set_timeout(1000) -- è®¾ç½®è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ local ok, err = red:connect(\u0026#34;127.0.0.1\u0026#34;, 6379) if not ok then ngx.log(ngx.ERR, \u0026#34;Redisè¿æ¥å¤±è´¥: \u0026#34;, err) return ngx.exit(500) end -- æƒé™æ ¡éªŒ local res, err = red:auth(\u0026#34;123456\u0026#34;) if not res then ngx.say(\u0026#34;failed to authenticate: \u0026#34;, err) return end -- æ£€æŸ¥IPæ˜¯å¦åœ¨ç™½åå•ä¸­ local is_in_whitelist, err = red:sismember(redis_key_white_list, client_ip) if is_in_whitelist == 1 then ngx.log(ngx.INFO, \u0026#34;IPåœ¨ç™½åå•ä¸­: \u0026#34;, client_ip) else ngx.status = ngx.HTTP_FORBIDDEN ngx.say(\u0026#34;Access Denied\u0026#34;) return ngx.exit(ngx.HTTP_FORBIDDEN) end -- è¿”è¿˜redisè¿æ¥åˆ°è¿æ¥æ±  local ok, err = red:set_keepalive(10000, 100) if not ok then ngx.log(ngx.ERR, \u0026#34;è®¾ç½®keepaliveå¤±è´¥: \u0026#34;, err) end è¯¦ç»†è§£é‡Š è·å–å®¢æˆ·ç«¯IPå’Œè¯·æ±‚è·¯å¾„\n1 2 local client_ip = ngx.var.remote_addr local path = ngx.var.uri è¿™ä¸¤è¡Œä»£ç ä»Nginxå˜é‡ä¸­è·å–å®¢æˆ·ç«¯çš„IPåœ°å€å’Œè¯·æ±‚è·¯å¾„ï¼Œclient_ipç”¨äºåç»­çš„ç™½åå•æ£€æŸ¥ã€‚\nRedisç›¸å…³é…ç½®\n1 local redis_key_white_list = \u0026#34;map_request_white_list\u0026#34; å®šä¹‰å­˜å‚¨ç™½åå•çš„Redisé”®ã€‚\nè¿æ¥Redis\n1 2 3 4 5 6 7 8 local redis = require \u0026#34;resty.redis\u0026#34; local red = redis:new() red:set_timeout(1000) -- è®¾ç½®è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ local ok, err = red:connect(\u0026#34;127.0.0.1\u0026#34;, 6379) if not ok then ngx.log(ngx.ERR, \u0026#34;Redisè¿æ¥å¤±è´¥: \u0026#34;, err) return ngx.exit(500) end ä½¿ç”¨resty.redisæ¨¡å—åˆ›å»ºRedisè¿æ¥å¯¹è±¡ï¼Œå¹¶è®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´ã€‚å°è¯•è¿æ¥åˆ°RedisæœåŠ¡å™¨ï¼Œå¦‚æœè¿æ¥å¤±è´¥ï¼Œè®°å½•é”™è¯¯æ—¥å¿—å¹¶è¿”å›500é”™è¯¯ã€‚\næƒé™æ ¡éªŒ\n1 2 3 4 5 local res, err = red:auth(\u0026#34;123456\u0026#34;) if not res then ngx.say(\u0026#34;failed to authenticate: \u0026#34;, err) return end å¯¹Redisè¿›è¡Œè®¤è¯ï¼Œå¦‚æœè®¤è¯å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶åœæ­¢æ‰§è¡Œã€‚\næ£€æŸ¥IPæ˜¯å¦åœ¨ç™½åå•ä¸­ 1 2 3 4 5 6 7 8 local is_in_whitelist, err = red:sismember(redis_key_white_list, client_ip) if is_in_whitelist == 1 then ngx.log(ngx.INFO, \u0026#34;IPåœ¨ç™½åå•ä¸­: \u0026#34;, client_ip) else ngx.status = ngx.HTTP_FORBIDDEN ngx.say(\u0026#34;Access Denied\u0026#34;) return ngx.exit(ngx.HTTP_FORBIDDEN) end ä½¿ç”¨SISMEMBERå‘½ä»¤æ£€æŸ¥IPæ˜¯å¦åœ¨Redisçš„ç™½åå•é›†åˆä¸­ã€‚å¦‚æœIPåœ¨ç™½åå•ä¸­ï¼Œè®°å½•ä¿¡æ¯æ—¥å¿—ï¼›å¦åˆ™ï¼Œè¿”å›403 ForbiddençŠ¶æ€ç å¹¶æ‹’ç»è®¿é—®ã€‚\né‡Šæ”¾Redisè¿æ¥ 1 2 3 4 local ok, err = red:set_keepalive(10000, 100) if not ok then ngx.log(ngx.ERR, \u0026#34;è®¾ç½®keepaliveå¤±è´¥: \u0026#34;, err) end å°†Redisè¿æ¥è¿”å›åˆ°è¿æ¥æ± ä¸­ï¼Œä»¥ä¾¿åç»­è¯·æ±‚å¤ç”¨è¯¥è¿æ¥ã€‚å¦‚æœè®¾ç½®å¤±è´¥ï¼Œè®°å½•é”™è¯¯æ—¥å¿—ã€‚\nåœ¨Nginxä¸­é…ç½®Luaè„šæœ¬ åœ¨Nginxçš„locationé…ç½®ä¸­ï¼Œä½¿ç”¨access_by_lua_fileæŒ‡ä»¤æ¥è°ƒç”¨ä¸Šè¿°Luaè„šæœ¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 http { â€‹```lua http { server { listen 80; server_name example.com; location / { access_by_lua_file /opt/nginx/lua_script/white.lua; proxy_pass http://backend; } } } ä¸Šè¿°é…ç½®åœ¨æ¥æ”¶åˆ°HTTPè¯·æ±‚æ—¶ï¼Œä¼šé¦–å…ˆæ‰§è¡Œ/opt/nginx/lua_script/white.luaè„šæœ¬è¿›è¡Œç™½åå•æ£€æŸ¥ã€‚å¦‚æœé€šè¿‡æ£€æŸ¥ï¼Œåˆ™ç»§ç»­å°†è¯·æ±‚è½¬å‘åˆ°åç«¯æœåŠ¡å™¨ã€‚\næˆåŠŸè®¿é—®ï¼š ç¦æ­¢è®¿é—®ï¼š 5ã€é»‘åå•å®ç° é»‘åå•çš„ä½œç”¨ä¸åœºæ™¯ é»‘åå•æ˜¯ä¸€ç§ç½‘ç»œå®‰å…¨æœºåˆ¶ï¼Œç”¨äºè¯†åˆ«å¹¶é˜»æ­¢æ¶æ„IPåœ°å€å¯¹æœåŠ¡å™¨èµ„æºçš„è®¿é—®ã€‚å®ƒåœ¨å¤šç§åœºæ™¯ä¸­å‘æŒ¥ç€é‡è¦ä½œç”¨ï¼š\né˜²æ­¢æ¶æ„æ”»å‡»ï¼šé€šè¿‡å°ç¦å·²çŸ¥çš„æ”»å‡»è€…IPï¼Œå‡å°‘æœåŠ¡å™¨é­å—çš„æ¶æ„æ”»å‡»ã€‚ æ‰“å‡»çˆ¬è™«æ»¥ç”¨ï¼šé™åˆ¶çˆ¬è™«å¯¹ç½‘ç«™èµ„æºçš„è¿‡åº¦è®¿é—®ï¼Œä¿æŠ¤æ•°æ®ä¸è¢«æ»¥ç”¨ã€‚ å‡è½»æœåŠ¡å™¨è´Ÿè½½ï¼šé€šè¿‡é™åˆ¶ç‰¹å®šIPçš„è®¿é—®é¢‘ç‡ï¼Œå‡è½»æœåŠ¡å™¨å‹åŠ›ï¼Œæé«˜æœåŠ¡ç¨³å®šæ€§ã€‚ DDoSé˜²å¾¡ï¼šå¿«é€Ÿå“åº”DDoSæ”»å‡»ï¼Œå°ç¦æ”»å‡»æºIPï¼Œä¿æŠ¤æœåŠ¡å¯ç”¨æ€§ã€‚ ä½¿ç”¨Luaè„šæœ¬ä¸Rediså®ç°åŠ¨æ€IPå°ç¦ OpenRestyç»“åˆRediså¯ä»¥å®ç°ä¸€ä¸ªé«˜æ•ˆçš„åŠ¨æ€IPå°ç¦ç³»ç»Ÿã€‚ä»¥ä¸‹æ˜¯å®ç°çš„å…³é”®æ­¥éª¤ï¼š\nç¯å¢ƒé…ç½®ï¼šç¡®ä¿Nginx OpenRestyå’ŒRedisç¯å¢ƒå‡†å¤‡å°±ç»ªã€‚ Luaè„šæœ¬ç¼–å†™ï¼šç¼–å†™Luaè„šæœ¬æ¥åŠ¨æ€æŸ¥è¯¢å’Œæ›´æ–°Redisä¸­çš„é»‘åå•çŠ¶æ€ã€‚ Nginxé…ç½®æ•´åˆï¼šåœ¨Nginxé…ç½®æ–‡ä»¶ä¸­é›†æˆLuaè„šæœ¬ï¼Œå®ç°è®¿é—®æ§åˆ¶ã€‚ æ¡ˆä¾‹æ¼”ç¤º é€šè¿‡ä½¿ç”¨Luaè„šæœ¬ï¼Œåœ¨æ¥æ”¶åˆ°HTTPè¯·æ±‚æ—¶æ£€æŸ¥è¯·æ±‚çš„IPåœ°å€æ˜¯å¦åœ¨é»‘åå•ä¸­ï¼Œæˆ–æ§åˆ¶IPçš„è®¿é—®é¢‘ç‡ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚\næ€è·¯ è·å–å®¢æˆ·ç«¯IPï¼šåœ¨Luaè„šæœ¬ä¸­è·å–å®¢æˆ·ç«¯çš„IPåœ°å€ã€‚ è¿æ¥Redisï¼šä½¿ç”¨resty.redisæ¨¡å—è¿æ¥Redisæ•°æ®åº“ã€‚ æƒé™æ ¡éªŒï¼šå¯¹è¿æ¥çš„Redisè¿›è¡Œè®¤è¯ã€‚ æ£€æŸ¥IPæ˜¯å¦åœ¨é»‘åå•ä¸­ï¼šä»Redisä¸­æ£€æŸ¥IPæ˜¯å¦å­˜åœ¨äºé»‘åå•é›†åˆä¸­ã€‚ è®¿é—®é¢‘æ¬¡æ§åˆ¶ï¼šå¯¹æ¯ä¸ªIPçš„è®¿é—®é¢‘æ¬¡è¿›è¡Œé™åˆ¶ï¼Œå¦‚æœè¶…è¿‡æŒ‡å®šçš„é¢‘æ¬¡ï¼Œåˆ™å°†IPåŠ å…¥é»‘åå•ã€‚ è¿”å›ç»“æœï¼šå¦‚æœIPåœ¨é»‘åå•ä¸­ï¼Œè¿”å›403 ForbiddençŠ¶æ€ç ï¼Œæ‹’ç»è®¿é—®ï¼›å¦åˆ™ï¼Œå…è®¸è¯·æ±‚ç»§ç»­ã€‚ Nginx é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 upstream jms-uat { server 192.168.82.105:81; } server { listen 80; server_name jms.ownit.top; # ç™½åå• æˆ–è€… é»‘åå• # include /opt/nginx/whitelist/corporation.conf; rewrite ^/(.*)$ https://$host/$1 permanent; access_log /www/wwwlogs/dns.ownit.top.log; error_log /www/wwwlogs/dns.ownit.top.error.log; } server { listen 443 ssl; server_name jms.ownit.top; # ç™½åå• æˆ–è€… é»‘åå• # include /opt/nginx/whitelist/corporation.conf; ssl_certificate /opt/nginx/ssl/ownit.top.crt; ssl_certificate_key /opt/nginx/ssl/ownit.top.key; include ssl.conf; location = /core/auth/login/ { access_by_lua_file /opt/nginx/lua_script/login.lua; proxy_pass http://jms-uat; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#34;upgrade\u0026#34;; } location / { if ($request_uri !~ \\.(html|htm|jpg|png|ico|js|css)$) { access_by_lua_file /opt/nginx/lua_script/rule.lua; } proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#34;upgrade\u0026#34;; proxy_pass http://jms-uat; include https_proxy.conf; client_max_body_size 0; } access_log /www/wwwlogs/dns.ownit.top.log; error_log /www/wwwlogs/dns.ownit.top.error.log; } location = /core/auth/login/\n1 2 3 4 5 6 location = /core/auth/login/ { access_by_lua_file /opt/nginx/lua_script/login.lua; proxy_pass http://jms-uat; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#34;upgrade\u0026#34;; } è§£é‡Š location = /core/auth/login/ï¼š è¿™æ˜¯ä¸€ä¸ªç²¾ç¡®åŒ¹é…çš„locationå—ï¼Œä»…å¯¹è¯·æ±‚è·¯å¾„ä¸¥æ ¼ç­‰äº/core/auth/login/çš„è¯·æ±‚ç”Ÿæ•ˆã€‚ access_by_lua_file /opt/nginx/lua_script/login.lua;ï¼š ä½¿ç”¨OpenRestyçš„Luaæ¨¡å—ï¼ŒæŒ‡å®šåœ¨è®¿é—®æ§åˆ¶é˜¶æ®µæ‰§è¡Œ/opt/nginx/lua_script/login.luaè„šæœ¬ã€‚è¿™ä¸ªè„šæœ¬é€šå¸¸ç”¨äºæ‰§è¡Œè®¤è¯ã€æƒé™æ£€æŸ¥æˆ–å…¶ä»–é¢„å¤„ç†é€»è¾‘ã€‚ proxy_pass http://jms-uat;ï¼š å°†åŒ¹é…åˆ°çš„è¯·æ±‚ä»£ç†åˆ°ä¸Šæ¸¸æœåŠ¡å™¨http://jms-uatã€‚ proxy_set_header Upgrade $http_upgrade;ï¼š è®¾ç½®Upgradeè¯·æ±‚å¤´ï¼Œæ”¯æŒWebSocketç­‰åè®®å‡çº§ã€‚$http_upgradeå˜é‡åŒ…å«åŸå§‹è¯·æ±‚ä¸­çš„Upgradeå¤´å­—æ®µçš„å€¼ã€‚ proxy_set_header Connection \u0026quot;upgrade\u0026quot;;ï¼š è®¾ç½®Connectionè¯·æ±‚å¤´ä¸ºupgradeï¼Œé€šå¸¸ä¸Upgradeå¤´ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ç¡®ä¿è¿æ¥å‡çº§ã€‚ location /\n1 2 3 4 5 6 7 8 9 10 11 location / { # å¦‚æœè¯¥location ä¸‹å­˜åœ¨é™æ€èµ„æºæ–‡ä»¶å¯ä»¥åšä¸€ä¸ªåˆ¤æ–­ if ($request_uri !~ \\.(html|htm|jpg|png|ico|js|css)$) { access_by_lua_file /opt/nginx/lua_script/rule.lua; åŠ ä¸Šäº†è¿™æ¡é…ç½®ï¼Œåˆ™ä¼šæ ¹æ® rule.lua çš„è§„åˆ™è¿›è¡Œé™æµ } proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#34;upgrade\u0026#34;; proxy_pass http://jms-uat; include https_proxy.conf; client_max_body_size 0; } è§£é‡Š location /ï¼š è¿™æ˜¯ä¸€ä¸ªé€šé…ç¬¦åŒ¹é…çš„locationå—ï¼Œè¡¨ç¤ºæ‰€æœ‰è·¯å¾„çš„è¯·æ±‚éƒ½ä¼šåŒ¹é…åˆ°è¿™ä¸ªå—ï¼Œé™¤éæœ‰å…¶ä»–æ›´ç²¾ç¡®çš„åŒ¹é…å—ã€‚ if ($request_uri !~ \\.(html|htm|jpg|png|ico|js|css)$)ï¼š ä½¿ç”¨ifæŒ‡ä»¤å¯¹è¯·æ±‚è·¯å¾„è¿›è¡Œæ£€æŸ¥ã€‚ä»…åœ¨è¯·æ±‚è·¯å¾„ä¸åŒ¹é…æŒ‡å®šçš„é™æ€èµ„æºæ–‡ä»¶æ‰©å±•åï¼ˆå¦‚.html, .htm, .jpg, .png, .ico, .js, .cssï¼‰æ—¶ï¼Œæ‰§è¡Œåç»­çš„Luaè„šæœ¬ã€‚è¿™ç§æ£€æŸ¥æœ‰åŠ©äºå°†åŠ¨æ€èµ„æºä¸é™æ€èµ„æºåŒºåˆ†å¼€æ¥ã€‚ access_by_lua_file /opt/nginx/lua_script/rule.lua;ï¼š ä½¿ç”¨OpenRestyçš„Luaæ¨¡å—ï¼ŒæŒ‡å®šåœ¨è®¿é—®æ§åˆ¶é˜¶æ®µæ‰§è¡Œ/opt/nginx/lua_script/rule.luaè„šæœ¬ã€‚è¿™ä¸ªè„šæœ¬é€šå¸¸ç”¨äºå®ç°é™æµã€é˜²ç«å¢™æˆ–å…¶ä»–åŠ¨æ€è®¿é—®æ§åˆ¶é€»è¾‘ã€‚ proxy_set_header Upgrade $http_upgrade;ï¼š è®¾ç½®Upgradeè¯·æ±‚å¤´ï¼Œæ”¯æŒWebSocketç­‰åè®®å‡çº§ã€‚$http_upgradeå˜é‡åŒ…å«åŸå§‹è¯·æ±‚ä¸­çš„Upgradeå¤´å­—æ®µçš„å€¼ã€‚ proxy_set_header Connection \u0026quot;upgrade\u0026quot;;ï¼š è®¾ç½®Connectionè¯·æ±‚å¤´ä¸ºupgradeï¼Œé€šå¸¸ä¸Upgradeå¤´ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ç¡®ä¿è¿æ¥å‡çº§ã€‚ proxy_pass http://jms-uat;ï¼š å°†åŒ¹é…åˆ°çš„è¯·æ±‚ä»£ç†åˆ°ä¸Šæ¸¸æœåŠ¡å™¨http://jms-uatã€‚ include https_proxy.conf;ï¼š åŒ…å«é¢å¤–çš„é…ç½®æ–‡ä»¶https_proxy.confï¼Œè¯¥æ–‡ä»¶å¯èƒ½åŒ…å«HTTPSä»£ç†ç›¸å…³çš„å…¶ä»–é…ç½®é¡¹ã€‚ client_max_body_size 0;ï¼š è®¾ç½®å®¢æˆ·ç«¯è¯·æ±‚ä½“çš„æœ€å¤§å¤§å°ä¸º0ï¼Œè¡¨ç¤ºä¸é™åˆ¶è¯·æ±‚ä½“çš„å¤§å°ã€‚ è¿™ä¸¤ä¸ªlocationå—ä¸»è¦ç”¨äºå¤„ç†ä¸åŒè·¯å¾„çš„è¯·æ±‚ï¼Œå¹¶åœ¨è®¿é—®æ§åˆ¶é˜¶æ®µä½¿ç”¨Luaè„šæœ¬è¿›è¡Œç›¸åº”çš„é€»è¾‘å¤„ç†ã€‚ç²¾ç¡®åŒ¹é…çš„/core/auth/login/è·¯å¾„ä¸“ç”¨äºç‰¹å®šçš„è®¤è¯æˆ–é¢„å¤„ç†ï¼Œè€Œé€šé…ç¬¦åŒ¹é…çš„/è·¯å¾„åˆ™å¤„ç†æ‰€æœ‰å…¶ä»–è¯·æ±‚ï¼Œå¹¶è¿›è¡ŒåŠ¨æ€è®¿é—®æ§åˆ¶é€»è¾‘ã€‚ä¸¤è€…å…±åŒç¡®ä¿äº†NginxæœåŠ¡å™¨çš„çµæ´»æ€§å’Œå®‰å…¨æ€§ã€‚\nLuaè„šæœ¬ (rule.lua) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 -- è¿æ¥æ± è¶…æ—¶å›æ”¶æ¯«ç§’ local pool_max_idle_time = 10000 -- è¿æ¥æ± å¤§å° local pool_size = 100 -- redis è¿æ¥è¶…æ—¶æ—¶é—´ local redis_connection_timeout = 100 -- redis host local redis_host = \u0026#34;192.168.102.20\u0026#34; -- redis port local redis_port = \u0026#34;6379\u0026#34; -- redis auth local redis_auth = \u0026#34;123456\u0026#34; -- å°ç¦IPæ—¶é—´ï¼ˆç§’ï¼‰ local ip_block_time = 120 -- æŒ‡å®šipè®¿é—®é¢‘ç‡æ—¶é—´æ®µï¼ˆç§’ï¼‰ local ip_time_out = 10 -- æŒ‡å®šipè®¿é—®é¢‘ç‡è®¡æ•°æœ€å¤§å€¼ï¼ˆæ¬¡ï¼‰ local ip_max_count = 60 -- é”™è¯¯æ—¥å¿—è®°å½• local function errlog(msg, ex) ngx.log(ngx.ERR, msg, ex) end -- é‡Šæ”¾è¿æ¥æ±  local function close_redis(red) if not red then return end local ok, err = red:set_keepalive(pool_max_idle_time, pool_size) if not ok then ngx.say(\u0026#34;redis connct err:\u0026#34;, err) return red:close() end end -- è¿æ¥redis local redis = require \u0026#34;resty.redis\u0026#34; local client = redis:new() local ok, err = client:connect(redis_host, redis_port) -- è¿æ¥å¤±è´¥è¿”å›æœåŠ¡å™¨é”™è¯¯ if not ok then return end -- è®¾ç½®è¶…æ—¶æ—¶é—´ client:set_timeout(redis_connection_timeout) -- ä¼˜åŒ–éªŒè¯å¯†ç æ“ä½œ local connCount, err = client:get_reused_times() -- æ–°å»ºè¿æ¥ï¼Œéœ€è¦è®¤è¯å¯†ç  if 0 == connCount then local ok, err = client:auth(redis_auth) if not ok then errlog(\u0026#34;failed to auth: \u0026#34;, err) return end elseif err then errlog(\u0026#34;failed to get reused times: \u0026#34;, err) return end -- è·å–è¯·æ±‚ip local function getIp() local clientIP = ngx.req.get_headers()[\u0026#34;X-Real-IP\u0026#34;] if clientIP == nil then clientIP = ngx.req.get_headers()[\u0026#34;x_forwarded_for\u0026#34;] end if clientIP == nil then clientIP = ngx.var.remote_addr end return clientIP end local clientIp = getIp() local incrKey = \u0026#34;limit:all:count:\u0026#34; .. clientIp local blockKey = \u0026#34;limit:all:block:\u0026#34; .. clientIp -- æŸ¥è¯¢ipæ˜¯å¦è¢«ç¦æ­¢è®¿é—®ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›403é”™è¯¯ä»£ç  local is_block, err = client:get(blockKey) if tonumber(is_block) == 1 then ngx.exit(ngx.HTTP_FORBIDDEN) close_redis(client) end local ip_count, err = client:incr(incrKey) if tonumber(ip_count) == 1 then client:expire(incrKey, ip_time_out) end -- å¦‚æœè¶…è¿‡å•ä½æ—¶é—´é™åˆ¶çš„è®¿é—®æ¬¡æ•°ï¼Œåˆ™æ·»åŠ é™åˆ¶è®¿é—®æ ‡è¯†ï¼Œé™åˆ¶æ—¶é—´ä¸ºip_block_time if tonumber(ip_count) \u0026gt; tonumber(ip_max_count) then client:set(blockKey, 1) client:expire(blockKey, ip_block_time) end close_redis(client) æˆåŠŸè®¿é—®ï¼š å¤±è´¥è®¿é—®ï¼š å‚è€ƒæ–‡æ¡£ï¼š https://www.cnblogs.com/KingArmy/p/18019489 https://blog.csdn.net/qq_45503196/article/details/134648292\n","date":"2024-07-15T16:47:03Z","image":"https://www.ownit.top/title_pic/18.jpg","permalink":"https://www.ownit.top/p/202407151647/","title":"ä½¿ç”¨Nginx OpenRestyä¸Rediså®ç°é«˜æ•ˆIPé»‘ç™½åå•ç®¡ç†"},{"content":"1ã€ç®€ä»‹ åœ¨ç°ä»£çš„å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¯¹ç³»ç»Ÿçš„å®æ—¶ç›‘æ§å˜å¾—å°¤ä¸ºé‡è¦ã€‚Prometheusä½œä¸ºä¸€æ¬¾å¼€æºçš„ç³»ç»Ÿç›‘æ§ä¸æŠ¥è­¦å·¥å…·ï¼Œä»¥å…¶å¼ºå¤§çš„æ•°æ®æ¨¡å‹å’Œçµæ´»çš„æŸ¥è¯¢è¯­è¨€ï¼Œæˆä¸ºäº†ç›‘æ§é¢†åŸŸçš„ä½¼ä½¼è€…ã€‚ç„¶è€Œï¼Œå¯¹äºç‰¹å®šçš„ç¡¬ä»¶è®¾å¤‡ï¼Œå¦‚åŸºäºPadavanå›ºä»¶çš„è·¯ç”±å™¨ï¼Œç›´æ¥é›†æˆPrometheuså¯èƒ½å¹¶éæ˜“äº‹ã€‚å› æ­¤ï¼Œå¼€å‘ä¸€ä¸ªé’ˆå¯¹Padavanè®¾å¤‡çš„Prometheus exporterï¼Œèƒ½å¤Ÿæå¤§åœ°ç®€åŒ–ç›‘æ§é›†æˆè¿‡ç¨‹ï¼Œæå‡è¿ç»´æ•ˆç‡ã€‚\næœ¬æ–‡å°†ä»¥padavan_exporteré¡¹ç›®ä¸ºä¾‹ï¼Œæ¢è®¨å¦‚ä½•åŸºäºæ­¤é¡¹ç›®è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œä»¥é€‚åº”æ›´å¹¿æ³›çš„ç›‘æ§éœ€æ±‚ã€‚æˆ‘ä»¬å°†æ·±å…¥åˆ†æä»£ç ç»“æ„ï¼Œäº†è§£å…¶å·¥ä½œåŸç†ï¼Œå¹¶æ¢ç´¢å¦‚ä½•æ‰©å±•å…¶åŠŸèƒ½ã€‚ é¡¹ç›®åœ°å€ï¼šhttps://github.com/Bpazy/padavan_exporter 2ã€é¡¹ç›®èƒŒæ™¯ padavan_exporteræ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºåŸºäºPadavanå›ºä»¶çš„è·¯ç”±å™¨è®¾è®¡çš„Prometheus exporterã€‚å®ƒé€šè¿‡SSHè¿æ¥è‡³è·¯ç”±å™¨ï¼Œæ”¶é›†åŒ…æ‹¬CPUä½¿ç”¨ç‡ã€å†…å­˜çŠ¶æ€ã€ç½‘ç»œæ¥å£çŠ¶æ€ã€ç½‘ç»œè¿æ¥ç»Ÿè®¡åœ¨å†…çš„å…³é”®æŒ‡æ ‡ï¼Œç„¶åä»¥Prometheuså…¼å®¹çš„æ ¼å¼æš´éœ²è¿™äº›æŒ‡æ ‡ï¼Œä¾›PrometheusæœåŠ¡å™¨æŠ“å–ã€‚\n3ã€ç¯å¢ƒä»‹ç» åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿å¼€å‘ç¯å¢ƒçš„æ­£ç¡®é…ç½®ã€‚ä»¥ä¸‹æ˜¯å¼€å‘æ­¤é¡¹ç›®æ‰€éœ€çš„ç¯å¢ƒå’Œå·¥å…·ï¼š\nGo è¯­è¨€ï¼šPadavan Exporter æ˜¯ç”¨ Go è¯­è¨€ç¼–å†™çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®‰è£… Go è¯­è¨€ç¯å¢ƒã€‚ Prometheusï¼šç”¨äºé‡‡é›†å’Œå­˜å‚¨æ¥è‡ª Exporter çš„æŒ‡æ ‡æ•°æ®ã€‚ Grafanaï¼šç”¨äºå¯è§†åŒ– Prometheus å­˜å‚¨çš„æ•°æ®ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰ã€‚ Padavan å›ºä»¶è®¾å¤‡ï¼šå®é™…è¿è¡Œçš„ Padavan å›ºä»¶è®¾å¤‡ï¼Œç”¨äºæµ‹è¯•å’ŒéªŒè¯ã€‚ 4ã€è®¾è®¡æ€è·¯ é¡¹ç›®ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š\nå‘½ä»¤è¡Œå‚æ•°è§£æï¼šä½¿ç”¨ kingpin åº“è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè·å– SSH è¿æ¥ä¿¡æ¯å’Œ Web æœåŠ¡ç›‘å¬åœ°å€ã€‚ SSH å®¢æˆ·ç«¯åˆå§‹åŒ–ï¼šä½¿ç”¨ golang.org/x/crypto/ssh åº“å»ºç«‹ SSH è¿æ¥ï¼Œè·å– Padavan è®¾å¤‡çš„æ€§èƒ½æ•°æ®ã€‚ Prometheus æ”¶é›†å™¨ï¼šå®ç° Prometheus æ”¶é›†å™¨ï¼Œç”¨äºä» SSH å®¢æˆ·ç«¯è·å–æ•°æ®å¹¶æä¾›ç»™ Prometheus æœåŠ¡å™¨ã€‚ HTTP æœåŠ¡å™¨ï¼šå¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œæä¾› /metrics æ¥å£ä¾› Prometheus æœåŠ¡å™¨æŠ“å–æ•°æ®ã€‚ 5ã€main.go 1. å‘½ä»¤è¡Œå‚æ•°è§£æ åœ¨ init å‡½æ•°ä¸­ï¼Œä½¿ç”¨ kingpin åº“è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚å®šä¹‰äº†å››ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼š\nweb.listen-addressï¼šç›‘å¬çš„ HTTP æœåŠ¡åœ°å€ï¼Œé»˜è®¤ä¸º :9100ã€‚ padavan.ssh.hostï¼šPadavan è®¾å¤‡çš„ SSH ä¸»æœºåœ°å€ï¼Œé»˜è®¤ä¸º 127.0.0.1:22ã€‚ padavan.ssh.usernameï¼šSSH ç™»å½•çš„ç”¨æˆ·åï¼Œé»˜è®¤ä¸º adminã€‚ padavan.ssh.passwordï¼šSSH ç™»å½•çš„å¯†ç ï¼Œé»˜è®¤ä¸º adminã€‚ debugï¼šæ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼ã€‚ é€šè¿‡è§£æè¿™äº›å‚æ•°ï¼Œè®¾ç½®æ—¥å¿—çº§åˆ«ä¸º Debugï¼Œå¹¶è¾“å‡ºè§£æåçš„å‚æ•°å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func init() { // å®šä¹‰å‘½ä»¤è¡Œå‚æ•° la = kingpin.Flag(\u0026#34;web.listen-address\u0026#34;, \u0026#34;Address on which to expose metrics and web interface\u0026#34;).Default(\u0026#34;:9100\u0026#34;).String() ph = kingpin.Flag(\u0026#34;padavan.ssh.host\u0026#34;, \u0026#34;Padavan ssh host\u0026#34;).Default(\u0026#34;127.0.0.1:22\u0026#34;).String() pu = kingpin.Flag(\u0026#34;padavan.ssh.username\u0026#34;, \u0026#34;Padavan ssh username\u0026#34;).Default(\u0026#34;admin\u0026#34;).String() pp = kingpin.Flag(\u0026#34;padavan.ssh.password\u0026#34;, \u0026#34;Padavan ssh password\u0026#34;).Default(\u0026#34;admin\u0026#34;).String() isDebug := kingpin.Flag(\u0026#34;debug\u0026#34;, \u0026#34;Debug mode\u0026#34;).Bool() kingpin.Parse() if *isDebug { log.SetLevel(log.DebugLevel) } log.Debugf(\u0026#34;web.listen-address(%s) padavan.ssh.host(%s) padavan.ssh.username(%s) padavan.ssh.password(%s)\u0026#34;, *la, *ph, *pu, *pp) } 2. åˆå§‹åŒ– SSH å®¢æˆ·ç«¯ initSshClient å‡½æ•°ç”¨äºåˆ›å»ºå’Œè¿”å›ä¸€ä¸ª SSH å®¢æˆ·ç«¯ã€‚è¯¥å®¢æˆ·ç«¯ç”¨äºä¸ Padavan è®¾å¤‡è¿›è¡Œ SSH è¿æ¥ï¼Œä»¥æ”¶é›†ç›‘æ§æ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func initSshClient() *ssh.Client { sshConfig := ssh.ClientConfig{ User: *pu, Auth: []ssh.AuthMethod{ssh.Password(*pp)}, Timeout: 5 * time.Second, HostKeyCallback: ssh.InsecureIgnoreHostKey(), } log.Printf(\u0026#34;Connecting to %s\u0026#34;, *ph) sshClient, err := ssh.Dial(\u0026#34;tcp\u0026#34;, *ph, \u0026amp;sshConfig) if err != nil { log.Fatalf(\u0026#34;create ssh client failed: %+v\u0026#34;, err) } return sshClient } 3. åˆå§‹åŒ– Prometheus æ³¨å†Œè¡¨å’Œæ”¶é›†å™¨ åœ¨ main å‡½æ•°ä¸­ï¼Œåˆå§‹åŒ– Prometheus æ³¨å†Œè¡¨ï¼ˆpedantic registryï¼‰å’Œ SSH å®¢æˆ·ç«¯ã€‚ç„¶åæ³¨å†Œå„ç§æ”¶é›†å™¨åˆ° Prometheus æ³¨å†Œè¡¨ã€‚è¿™äº›æ”¶é›†å™¨å°†ä» Padavan è®¾å¤‡è·å–ä¸åŒç±»å‹çš„æ€§èƒ½æ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func main() { reg := prometheus.NewPedanticRegistry() sc := initSshClient() reg.MustRegister(collector.NewLoadAverageCollector(sc)) reg.MustRegister(collector.NewNetDevController(sc)) reg.MustRegister(collector.NewCpuCollector(sc)) reg.MustRegister(collector.NewMemoryCollector(sc)) reg.MustRegister(collector.NewNetconnCollector(sc)) gatherers := prometheus.Gatherers{reg} h := promhttp.HandlerFor(gatherers, promhttp.HandlerOpts{ ErrorLog: log.StandardLogger(), ErrorHandling: promhttp.ContinueOnError, }) http.HandleFunc(\u0026#34;/metrics\u0026#34;, func(w http.ResponseWriter, r *http.Request) { h.ServeHTTP(w, r) }) http.HandleFunc(\u0026#34;/\u0026#34;, func(w http.ResponseWriter, r *http.Request) { _, _ = fmt.Fprintln(w, homePage()) }) log.Printf(\u0026#34;Start server at %s\u0026#34;, *la) log.Fatal(http.ListenAndServe(*la, nil)) } 4. å¯åŠ¨ HTTP æœåŠ¡å™¨ åœ¨ main å‡½æ•°ä¸­ï¼Œå¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œæä¾› /metrics æ¥å£ä¾› Prometheus æœåŠ¡å™¨æŠ“å–æ•°æ®ã€‚åŒæ—¶æä¾›ä¸€ä¸ªç®€å•çš„é¦–é¡µï¼Œé€šè¿‡ / è·¯å¾„è®¿é—®ï¼Œæ˜¾ç¤ºä¸€äº›åŸºæœ¬ä¿¡æ¯å’Œæœ‰ç”¨çš„é“¾æ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func homePage() string { return ` \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;padavan_exporter\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;padavan_exporter\u0026lt;/h2\u0026gt; \u0026lt;span\u0026gt;See docs at \u0026lt;a href=\u0026#34;https://github.com/Bpazy/padavan_exporter\u0026#34;\u0026gt;https://github.com/Bpazy/padavan_exporter\u0026lt;/a\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;br\u0026gt; \u0026lt;br\u0026gt; \u0026lt;span\u0026gt; Useful endpoints: \u0026lt;/span\u0026gt; \u0026lt;br\u0026gt; \u0026lt;span\u0026gt; \u0026lt;a href=\u0026#34;/metrics\u0026#34;\u0026gt;metrics\u0026lt;/a\u0026gt; \u0026lt;span\u0026gt; - available service metrics \u0026lt;/span\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt;` } 5ã€æ•´ä½“ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 import ( \u0026#34;fmt\u0026#34; \u0026#34;github.com/Bpazy/padavan_exporter/collector\u0026#34; \u0026#34;github.com/prometheus/client_golang/prometheus\u0026#34; \u0026#34;github.com/prometheus/client_golang/prometheus/promhttp\u0026#34; log \u0026#34;github.com/sirupsen/logrus\u0026#34; \u0026#34;golang.org/x/crypto/ssh\u0026#34; \u0026#34;gopkg.in/alecthomas/kingpin.v2\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;time\u0026#34; ) var ( ph *string // Padavan address pu *string // Padavan username pp *string // Padavan password la *string // Address on which to expose metrics and web interface ) // init å‡½æ•°ç”¨äºåˆå§‹åŒ–å‘½ä»¤è¡Œå‚æ•°ã€‚ // é€šè¿‡ kingpin è§£æå‘½ä»¤è¡Œå‚æ•°ï¼ŒåŒ…æ‹¬ web æœåŠ¡ç›‘å¬åœ°å€ã€Padavan SSH ä¸»æœºåœ°å€ã€ç”¨æˆ·åã€å¯†ç ç­‰ã€‚ // å¹¶æ ¹æ®æ˜¯å¦å¼€å¯ debug æ¨¡å¼è®¾ç½®æ—¥å¿—çº§åˆ«ã€‚ func init() { // å®šä¹‰å‘½ä»¤è¡Œå‚æ•° la = kingpin.Flag(\u0026#34;web.listen-address\u0026#34;, \u0026#34;Address on which to expose metrics and web interface\u0026#34;).Default(\u0026#34;:9100\u0026#34;).String() ph = kingpin.Flag(\u0026#34;padavan.ssh.host\u0026#34;, \u0026#34;Padavan ssh host\u0026#34;).Default(\u0026#34;127.0.0.1:22\u0026#34;).String() pu = kingpin.Flag(\u0026#34;padavan.ssh.username\u0026#34;, \u0026#34;Padavan ssh username\u0026#34;).Default(\u0026#34;admin\u0026#34;).String() pp = kingpin.Flag(\u0026#34;padavan.ssh.password\u0026#34;, \u0026#34;Padavan ssh password\u0026#34;).Default(\u0026#34;admin\u0026#34;).String() // è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶åœ¨ debug æ¨¡å¼ä¸‹è®¾ç½®æ—¥å¿—çº§åˆ« isDebug := kingpin.Flag(\u0026#34;debug\u0026#34;, \u0026#34;Debug mode\u0026#34;).Bool() kingpin.Parse() if *isDebug { log.SetLevel(log.DebugLevel) } log.Debugf(\u0026#34;web.listen-address(%s) padavan.ssh.host(%s) padavan.ssh.username(%s) padavan.ssh.password(%s)\u0026#34;, *la, *ph, *pu, *pp) } // main å‡½æ•°ä½œä¸ºç¨‹åºå…¥å£ç‚¹ï¼Œè´Ÿè´£åˆå§‹åŒ– Prometheus ç›‘æ§æ•°æ®æ”¶é›†å™¨ã€SSH å®¢æˆ·ç«¯ï¼Œå¹¶å¯åŠ¨ HTTP æœåŠ¡æä¾›ç›‘æ§æ•°æ®ã€‚ func main() { // åˆå§‹åŒ– Prometheus æ³¨å†Œè¡¨å’Œ SSH å®¢æˆ·ç«¯ reg := prometheus.NewPedanticRegistry() sc := initSshClient() // æ³¨å†Œå„ç§æ”¶é›†å™¨åˆ° Prometheus reg.MustRegister(collector.NewLoadAverageCollector(sc)) reg.MustRegister(collector.NewNetDevController(sc)) reg.MustRegister(collector.NewCpuCollector(sc)) reg.MustRegister(collector.NewMemoryCollector(sc)) reg.MustRegister(collector.NewNetconnCollector(sc)) gatherers := prometheus.Gatherers{reg} h := promhttp.HandlerFor(gatherers, promhttp.HandlerOpts{ ErrorLog: log.StandardLogger(), ErrorHandling: promhttp.ContinueOnError, }) // å¤„ç† /metrics è¯·æ±‚ä»¥æä¾›ç›‘æ§æ•°æ® http.HandleFunc(\u0026#34;/metrics\u0026#34;, func(w http.ResponseWriter, r *http.Request) { h.ServeHTTP(w, r) }) // å¤„ç†æ ¹è·¯å¾„è¯·æ±‚ï¼Œæä¾›ç®€å•ä¿¡æ¯é¡µé¢ http.HandleFunc(\u0026#34;/\u0026#34;, func(w http.ResponseWriter, r *http.Request) { _, _ = fmt.Fprintln(w, homePage()) }) log.Printf(\u0026#34;Start server at %s\u0026#34;, *la) // å¯åŠ¨ HTTP æœåŠ¡ log.Fatal(http.ListenAndServe(*la, nil)) } func homePage() string { return ` \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;padavan_exporter\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;padavan_exporter\u0026lt;/h2\u0026gt; \u0026lt;span\u0026gt;See docs at \u0026lt;a href=\u0026#34;https://github.com/Bpazy/padavan_exporter\u0026#34;\u0026gt;https://github.com/Bpazy/padavan_exporter\u0026lt;/a\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;br\u0026gt; \u0026lt;br\u0026gt; \u0026lt;span\u0026gt; Useful endpoints: \u0026lt;/span\u0026gt; \u0026lt;br\u0026gt; \u0026lt;span\u0026gt; \u0026lt;a href=\u0026#34;/metrics\u0026#34;\u0026gt;metrics\u0026lt;/a\u0026gt; \u0026lt;span\u0026gt; - available service metrics \u0026lt;/span\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt;` } // initSshClient å‡½æ•°ç”¨äºåˆå§‹åŒ–å¹¶è¿”å›ä¸€ä¸ª SSH å®¢æˆ·ç«¯ã€‚ // è¯¥å®¢æˆ·ç«¯ç”¨äºä¸ Padavan è®¾å¤‡è¿›è¡Œ SSH è¿æ¥ä»¥æ”¶é›†ç›‘æ§æ•°æ®ã€‚ func initSshClient() *ssh.Client { // åˆ›å»º SSH å®¢æˆ·ç«¯é…ç½®ï¼ŒåŒ…æ‹¬ç”¨æˆ·åã€å¯†ç å’Œä¸€äº›è¿æ¥é€‰é¡¹ sshConfig := ssh.ClientConfig{ User: *pu, Auth: []ssh.AuthMethod{ssh.Password(*pp)}, Timeout: 5 * time.Second, HostKeyCallback: ssh.InsecureIgnoreHostKey(), } log.Printf(\u0026#34;Connecting to %s\u0026#34;, *ph) // å°è¯•å»ºç«‹ SSH è¿æ¥ sshClient, err := ssh.Dial(\u0026#34;tcp\u0026#34;, *ph, \u0026amp;sshConfig) if err != nil { log.Fatalf(\u0026#34;create ssh client failed: %+v\u0026#34;, err) } return sshClient } 6ã€collector.go 1ã€æ•´ä½“æ€è·¯ å»ºç«‹ SSH ä¼šè¯å¹¶æ‰§è¡Œå‘½ä»¤ï¼šé€šè¿‡ SSH å®¢æˆ·ç«¯è¿æ¥åˆ°è¿œç¨‹è®¾å¤‡å¹¶æ‰§è¡Œå‘½ä»¤ï¼Œè·å–å‘½ä»¤çš„è¾“å‡ºç»“æœã€‚ è·å–æ–‡ä»¶å†…å®¹ï¼šé€šè¿‡æ‰§è¡Œ cat å‘½ä»¤è·å–è¿œç¨‹è®¾å¤‡ä¸ŠæŒ‡å®šæ–‡ä»¶çš„å†…å®¹ã€‚ è§£ææµ®ç‚¹æ•°ï¼šå°†å­—ç¬¦ä¸²å½¢å¼çš„æ•°å­—è§£æä¸ºæµ®ç‚¹æ•°ã€‚ 2ã€åŠŸèƒ½è§£é‡Š import éƒ¨åˆ†\n1 2 3 4 5 6 import ( \u0026#34;fmt\u0026#34; log \u0026#34;github.com/sirupsen/logrus\u0026#34; \u0026#34;golang.org/x/crypto/ssh\u0026#34; \u0026#34;strconv\u0026#34; ) è¿™éƒ¨åˆ†ä»£ç å¯¼å…¥äº†æ‰€éœ€çš„åŒ…ã€‚fmt ç”¨äºæ ¼å¼åŒ–è¾“å‡ºï¼Œlog ç”¨äºæ—¥å¿—è®°å½•ï¼Œssh ç”¨äº SSH è¿æ¥ï¼Œstrconv ç”¨äºå­—ç¬¦ä¸²å’Œæ•°å€¼ä¹‹é—´çš„è½¬æ¢ã€‚\nmustGetContent å‡½æ•°\n1 2 3 4 5 6 7 func mustGetContent(sshClient *ssh.Client, path string) string { rsp, err := execCommand(sshClient, \u0026#34;cat \u0026#34;+path) if err != nil { panic(err) } return rsp } è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ª SSH å®¢æˆ·ç«¯å’Œä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œé€šè¿‡è°ƒç”¨ execCommand å‡½æ•°æ‰§è¡Œ cat å‘½ä»¤è·å–æ–‡ä»¶å†…å®¹ã€‚å¦‚æœæ‰§è¡Œå‘½ä»¤å¤±è´¥ï¼Œä¼šå¼•å‘ panicã€‚æˆåŠŸæ‰§è¡Œåï¼Œè¿”å›æ–‡ä»¶å†…å®¹ä½œä¸ºå­—ç¬¦ä¸²ã€‚\nexecCommand å‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 func execCommand(sshClient *ssh.Client, command string) (string, error) { session, err := sshClient.NewSession() if err != nil { return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;create ssh session failed: %+v\u0026#34;, err) } defer session.Close() rsp, err := session.CombinedOutput(command) if err != nil { return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;execute ssh command failed: %+v\u0026#34;, err) } return string(rsp), nil } è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ª SSH å®¢æˆ·ç«¯å’Œä¸€ä¸ªå‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ SSH ä¼šè¯å¹¶æ‰§è¡Œå‘½ä»¤ï¼Œè·å–å‘½ä»¤çš„è¾“å‡ºç»“æœã€‚å¦‚æœåˆ›å»ºä¼šè¯æˆ–æ‰§è¡Œå‘½ä»¤å¤±è´¥ï¼Œè¿”å›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚æˆåŠŸæ‰§è¡Œåï¼Œè¿”å›å‘½ä»¤è¾“å‡ºç»“æœä½œä¸ºå­—ç¬¦ä¸²ã€‚\nmustParseFloat å‡½æ•°\n1 2 3 4 5 6 7 8 func mustParseFloat(fs string) float64 { float, err := strconv.ParseFloat(fs, 32) if err != nil { log.Printf(\u0026#34;%+v\u0026#34;, err) return 0 } return float } è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå°è¯•å°†å…¶è§£æä¸ºæµ®ç‚¹æ•°ã€‚å¦‚æœè§£æå¤±è´¥ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯å¹¶è¿”å› 0ã€‚æˆåŠŸè§£æåï¼Œè¿”å›æµ®ç‚¹æ•°ã€‚\n3ã€æ•´ä½“ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 import ( \u0026#34;fmt\u0026#34; log \u0026#34;github.com/sirupsen/logrus\u0026#34; \u0026#34;golang.org/x/crypto/ssh\u0026#34; \u0026#34;strconv\u0026#34; ) // mustGetContent ä»æŒ‡å®šè·¯å¾„è¯»å–æ–‡ä»¶å†…å®¹ func mustGetContent(sshClient *ssh.Client, path string) string { // æ‰§è¡ŒSSHå‘½ä»¤è¯»å–æ–‡ä»¶å†…å®¹ rsp, err := execCommand(sshClient, \u0026#34;cat \u0026#34;+path) if err != nil { // å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œpanic panic(err) } // è¿”å›æ–‡ä»¶å†…å®¹ return rsp } // execCommand æ‰§è¡ŒSSHå‘½ä»¤å¹¶è¿”å›ç»“æœ func execCommand(sshClient *ssh.Client, command string) (string, error) { // åˆ›å»ºä¸€ä¸ªæ–°çš„SSHä¼šè¯ session, err := sshClient.NewSession() if err != nil { // å¦‚æœåˆ›å»ºä¼šè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;create ssh session failed: %+v\u0026#34;, err) } // ç¡®ä¿ä¼šè¯åœ¨å‡½æ•°ç»“æŸæ—¶å…³é—­ defer session.Close() // æ‰§è¡Œå‘½ä»¤å¹¶è·å–ç»“æœ rsp, err := session.CombinedOutput(command) if err != nil { // å¦‚æœæ‰§è¡Œå‘½ä»¤å¤±è´¥ï¼Œè¿”å›é”™è¯¯ return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;execute ssh command failed: %+v\u0026#34;, err) } // è¿”å›å‘½ä»¤æ‰§è¡Œç»“æœ return string(rsp), nil } // mustParseFloat è§£æå­—ç¬¦ä¸²ä¸ºæµ®ç‚¹æ•° func mustParseFloat(fs string) float64 { // å°è¯•è§£æå­—ç¬¦ä¸²ä¸ºæµ®ç‚¹æ•° float, err := strconv.ParseFloat(fs, 32) if err != nil { // å¦‚æœè§£æå¤±è´¥ï¼Œè®°å½•é”™è¯¯å¹¶è¿”å›0 log.Printf(\u0026#34;%+v\u0026#34;, err) return 0 } // è¿”å›è§£æåçš„æµ®ç‚¹æ•° return float } 7ã€memory.go 1ã€æ•´ä½“æ€è·¯ è¿™ä¸ªä»£ç ç‰‡æ®µçš„ç›®çš„æ˜¯é€šè¿‡ Prometheus é‡‡é›†è¿œç¨‹è®¾å¤‡çš„å†…å­˜æŒ‡æ ‡ã€‚é€šè¿‡ SSH è¿æ¥è¿œç¨‹è®¾å¤‡ï¼Œè¯»å– /proc/meminfo æ–‡ä»¶çš„å†…å®¹ï¼Œç„¶åè§£æå‡ºç›¸å…³çš„å†…å­˜ä¿¡æ¯ï¼Œæœ€åå°†è¿™äº›ä¿¡æ¯ä½œä¸º Prometheus æŒ‡æ ‡å‘é€ã€‚\n2ã€åŠŸèƒ½è§£é‡Š æ­£åˆ™è¡¨è¾¾å¼\n1 2 3 var ( meminfoReg = regexp.MustCompile(`(\\w+):\\s+(\\d+) kB`) ) è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ç”¨äºåŒ¹é… /proc/meminfo æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œï¼Œæ•è·å†…å­˜æŒ‡æ ‡çš„åç§°å’Œæ•°å€¼ã€‚\nmemoryCollector ç»“æ„ä½“\n1 2 3 4 type memoryCollector struct { metrics map[string]*prometheus.Desc // å­˜å‚¨æŒ‡æ ‡æè¿°ä¿¡æ¯ sc *ssh.Client // SSHå®¢æˆ·ç«¯ï¼Œç”¨äºè¿œç¨‹æ”¶é›†æŒ‡æ ‡ä¿¡æ¯ } memoryCollector ç»“æ„ä½“åŒ…å«ä¸¤ä¸ªå­—æ®µï¼šä¸€ä¸ªç”¨äºå­˜å‚¨ Prometheus æŒ‡æ ‡æè¿°ä¿¡æ¯çš„å­—å…¸ metricsï¼Œå¦ä¸€ä¸ªæ˜¯ SSH å®¢æˆ·ç«¯ scï¼Œç”¨äºè¿æ¥è¿œç¨‹è®¾å¤‡ã€‚\nDescribe æ–¹æ³•\n1 2 3 func (m *memoryCollector) Describe(ch chan\u0026lt;- *prometheus.Desc) { // metrics created when Collect } è¿™ä¸ªæ–¹æ³•æ˜¯ Prometheus é‡‡é›†å™¨æ¥å£çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºæè¿°æŒ‡æ ‡ã€‚ä½†åœ¨è¿™ä¸ªå®ç°ä¸­ï¼ŒæŒ‡æ ‡æ˜¯åœ¨ Collect æ–¹æ³•ä¸­åŠ¨æ€åˆ›å»ºçš„ï¼Œæ‰€ä»¥è¿™é‡Œæ²¡æœ‰å…·ä½“å®ç°ã€‚\nCollect æ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 func (m *memoryCollector) Collect(ch chan\u0026lt;- prometheus.Metric) { // é€šè¿‡SSHå®¢æˆ·ç«¯è·å–è¿œç¨‹æœºå™¨çš„/proc/meminfoæ–‡ä»¶å†…å®¹ content := mustGetContent(m.sc, \u0026#34;/proc/meminfo\u0026#34;) // åˆ›å»ºScannerç”¨äºé€è¡Œè¯»å–å†…å®¹ scanner := bufio.NewScanner(strings.NewReader(content)) // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¡Œå†…å®¹ï¼Œè·å–æŒ‡æ ‡åå’Œå€¼ for scanner.Scan() { parts := meminfoReg.FindStringSubmatch(scanner.Text()) if len(parts) != 3 { // å¦‚æœåŒ¹é…ä¸æˆåŠŸï¼Œåˆ™è·³è¿‡å½“å‰è¡Œ continue } // æŒ‡æ ‡å key := parts[1] // è§£ææŒ‡æ ‡å€¼ value, err := strconv.ParseFloat(parts[2], 64) if err != nil { continue // å¦‚æœè§£æå¤±è´¥ï¼Œåˆ™è·³è¿‡å½“å‰è¡Œ } value *= 1024 // å°†å€¼ä»kBè½¬æ¢ä¸ºB var desc *prometheus.Desc var ok bool // æ ¹æ®æŒ‡æ ‡åï¼Œè·å–æˆ–åˆ›å»ºå¯¹åº”çš„Descå¯¹è±¡ switch key { case \u0026#34;MemTotal\u0026#34;: desc, ok = m.metrics[\u0026#34;MemTotal\u0026#34;] if !ok { desc = prometheus.NewDesc(\u0026#34;node_memory_total_bytes\u0026#34;, \u0026#34;Total memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;MemTotal\u0026#34;] = desc } case \u0026#34;MemFree\u0026#34;: desc, ok = m.metrics[\u0026#34;MemFree\u0026#34;] if !ok { desc = prometheus.NewDesc(\u0026#34;node_memory_free_bytes\u0026#34;, \u0026#34;Free memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;MemFree\u0026#34;] = desc } case \u0026#34;Buffers\u0026#34;: desc, ok = m.metrics[\u0026#34;Buffers\u0026#34;] if !ok { desc = prometheus.NewDesc(\u0026#34;node_memory_buffers_bytes\u0026#34;, \u0026#34;Buffers memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;Buffers\u0026#34;] = desc } case \u0026#34;Cached\u0026#34;: desc, ok = m.metrics[\u0026#34;Cached\u0026#34;] if (!ok) { desc = prometheus.NewDesc(\u0026#34;node_memory_cached_bytes\u0026#34;, \u0026#34;Cached memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;Cached\u0026#34;] = desc } default: continue // å¦‚æœä¸æ˜¯æˆ‘ä»¬å…³å¿ƒçš„æŒ‡æ ‡ï¼Œåˆ™è·³è¿‡å½“å‰è¡Œ } // å‘é€šé“å‘é€æŒ‡æ ‡ ch \u0026lt;- prometheus.MustNewConstMetric(desc, prometheus.GaugeValue, value) } } è¿™ä¸ªæ–¹æ³•æ˜¯ Prometheus é‡‡é›†å™¨æ¥å£çš„å¦ä¸€éƒ¨åˆ†ï¼Œç”¨äºæ”¶é›†æŒ‡æ ‡æ•°æ®å¹¶å‘ Prometheus å‘é€ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š\né€šè¿‡ mustGetContent å‡½æ•°è·å–è¿œç¨‹è®¾å¤‡ä¸Š /proc/meminfo æ–‡ä»¶çš„å†…å®¹ã€‚ ä½¿ç”¨ bufio.Scanner é€è¡Œè¯»å–æ–‡ä»¶å†…å®¹ã€‚ ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ¯ä¸€è¡Œï¼Œæå–å†…å­˜æŒ‡æ ‡åç§°å’Œå€¼ã€‚ æ ¹æ®æŒ‡æ ‡åç§°åˆ›å»ºæˆ–è·å–å¯¹åº”çš„ prometheus.Desc å¯¹è±¡ã€‚ å°†è§£æåçš„æŒ‡æ ‡å€¼ä¹˜ä»¥ 1024ï¼Œä» kB è½¬æ¢ä¸ºå­—èŠ‚ã€‚ ä½¿ç”¨ prometheus.MustNewConstMetric å‡½æ•°åˆ›å»º Prometheus æŒ‡æ ‡å¹¶å‘é€åˆ°é€šé“ chã€‚ NewMemoryCollector å‡½æ•°\n1 2 3 4 5 6 func NewMemoryCollector(sc *ssh.Client) *memoryCollector { return \u0026amp;memoryCollector{ sc: sc, metrics: map[string]*prometheus.Desc{}, } } è¿™ä¸ªå‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ memoryCollector å®ä¾‹ï¼Œåˆå§‹åŒ– SSH å®¢æˆ·ç«¯å’ŒæŒ‡æ ‡æè¿°ä¿¡æ¯çš„å­—å…¸ã€‚\n3ã€æ•´ä½“æµç¨‹ åˆå§‹åŒ–ï¼šé€šè¿‡ NewMemoryCollector å‡½æ•°åˆ›å»ºä¸€ä¸ª memoryCollector å®ä¾‹ï¼Œä¼ å…¥ SSH å®¢æˆ·ç«¯ã€‚\næ”¶é›†æŒ‡æ ‡ï¼š\nCollect æ–¹æ³•é€šè¿‡ SSH å®¢æˆ·ç«¯è·å–è¿œç¨‹è®¾å¤‡ä¸Šçš„ /proc/meminfo æ–‡ä»¶å†…å®¹ã€‚ ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£ææ–‡ä»¶å†…å®¹ï¼Œæå–å†…å­˜æŒ‡æ ‡ã€‚ å°†è§£æåçš„æŒ‡æ ‡è½¬æ¢ä¸º Prometheus æ ¼å¼å¹¶å‘é€åˆ°é€šé“ chã€‚ æè¿°æŒ‡æ ‡ï¼šDescribe æ–¹æ³•ç”¨äºå‘ Prometheus æè¿°æŒ‡æ ‡ï¼Œä½†å…·ä½“å®ç°ä¸­æ˜¯åœ¨ Collect æ–¹æ³•ä¸­åŠ¨æ€åˆ›å»ºæŒ‡æ ‡ã€‚\n4ã€æ•´ä½“ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 package collector import ( \u0026#34;bufio\u0026#34; \u0026#34;github.com/prometheus/client_golang/prometheus\u0026#34; \u0026#34;golang.org/x/crypto/ssh\u0026#34; \u0026#34;regexp\u0026#34; \u0026#34;strconv\u0026#34; \u0026#34;strings\u0026#34; ) /** * @Author: å—å®«ä¹˜é£ * @Description: * @File: memory.go * @Email: 1794748404@qq.com * @Date: 2024-05-22 15:05 */ var ( meminfoReg = regexp.MustCompile(`(\\w+):\\s+(\\d+) kB`) ) // memoryCollector æ”¶é›†å†…å­˜ç›¸å…³æŒ‡æ ‡ä¿¡æ¯ type memoryCollector struct { metrics map[string]*prometheus.Desc // å­˜å‚¨æŒ‡æ ‡æè¿°ä¿¡æ¯ sc *ssh.Client // SSHå®¢æˆ·ç«¯ï¼Œç”¨äºè¿œç¨‹æ”¶é›†æŒ‡æ ‡ä¿¡æ¯ } // Describe å‘é€šé“å‘é€æè¿°æŒ‡æ ‡çš„Descå¯¹è±¡ // è¿™ä¸ªæ–¹æ³•ä¸å…·ä½“å®ç°ï¼Œå› ä¸ºmetricsåœ¨Collectæ–¹æ³•ä¸­åŠ¨æ€åˆ›å»ºã€‚ func (m *memoryCollector) Describe(ch chan\u0026lt;- *prometheus.Desc) { // metrics created when Collect } // Collect å‘é€šé“å‘é€å†…å­˜æŒ‡æ ‡æ•°æ® // @param ch ç”¨äºå‘é€æŒ‡æ ‡çš„é€šé“ func (m *memoryCollector) Collect(ch chan\u0026lt;- prometheus.Metric) { // é€šè¿‡SSHå®¢æˆ·ç«¯è·å–è¿œç¨‹æœºå™¨çš„/proc/meminfoæ–‡ä»¶å†…å®¹ content := mustGetContent(m.sc, \u0026#34;/proc/meminfo\u0026#34;) // åˆ›å»ºScannerç”¨äºé€è¡Œè¯»å–å†…å®¹ scanner := bufio.NewScanner(strings.NewReader(content)) // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¡Œå†…å®¹ï¼Œè·å–æŒ‡æ ‡åå’Œå€¼ for scanner.Scan() { parts := meminfoReg.FindStringSubmatch(scanner.Text()) if len(parts) != 3 { // å¦‚æœåŒ¹é…ä¸æˆåŠŸï¼Œåˆ™è·³è¿‡å½“å‰è¡Œ continue } // æŒ‡æ ‡å key := parts[1] // è§£ææŒ‡æ ‡å€¼ value, err := strconv.ParseFloat(parts[2], 64) if err != nil { continue // å¦‚æœè§£æå¤±è´¥ï¼Œåˆ™è·³è¿‡å½“å‰è¡Œ } value *= 1024 // å°†å€¼ä»kBè½¬æ¢ä¸ºB var desc *prometheus.Desc var ok bool // æ ¹æ®æŒ‡æ ‡åï¼Œè·å–æˆ–åˆ›å»ºå¯¹åº”çš„Descå¯¹è±¡ switch key { case \u0026#34;MemTotal\u0026#34;: desc, ok = m.metrics[\u0026#34;MemTotal\u0026#34;] if !ok { desc = prometheus.NewDesc(\u0026#34;node_memory_total_bytes\u0026#34;, \u0026#34;Total memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;MemTotal\u0026#34;] = desc } case \u0026#34;MemFree\u0026#34;: desc, ok = m.metrics[\u0026#34;MemFree\u0026#34;] if !ok { desc = prometheus.NewDesc(\u0026#34;node_memory_free_bytes\u0026#34;, \u0026#34;Free memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;MemFree\u0026#34;] = desc } case \u0026#34;Buffers\u0026#34;: desc, ok = m.metrics[\u0026#34;Buffers\u0026#34;] if !ok { desc = prometheus.NewDesc(\u0026#34;node_memory_buffers_bytes\u0026#34;, \u0026#34;Buffers memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;Buffers\u0026#34;] = desc } case \u0026#34;Cached\u0026#34;: desc, ok = m.metrics[\u0026#34;Cached\u0026#34;] if !ok { desc = prometheus.NewDesc(\u0026#34;node_memory_cached_bytes\u0026#34;, \u0026#34;Cached memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;Cached\u0026#34;] = desc } default: continue // å¦‚æœä¸æ˜¯æˆ‘ä»¬å…³å¿ƒçš„æŒ‡æ ‡ï¼Œåˆ™è·³è¿‡å½“å‰è¡Œ } // å‘é€šé“å‘é€æŒ‡æ ‡ ch \u0026lt;- prometheus.MustNewConstMetric(desc, prometheus.GaugeValue, value) } } // NewMemoryCollector åˆ›å»ºä¸€ä¸ªæ–°çš„memoryCollectorå®ä¾‹ // @param sc SSHå®¢æˆ·ç«¯ // @return è¿”å›memoryCollectorå®ä¾‹çš„æŒ‡é’ˆ func NewMemoryCollector(sc *ssh.Client) *memoryCollector { return \u0026amp;memoryCollector{ sc: sc, metrics: map[string]*prometheus.Desc{}, } } 8ã€è°ƒç”¨ NewMemoryCollector çš„åŸç† NewMemoryCollector å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ memoryCollector å®ä¾‹ã€‚è¿™ä¸ªå®ä¾‹è´Ÿè´£ä» Padavan è®¾å¤‡ä¸­æ”¶é›†å†…å­˜ç›¸å…³çš„æŒ‡æ ‡ä¿¡æ¯ã€‚è°ƒç”¨ NewMemoryCollector çš„è¿‡ç¨‹å’ŒåŸç†å¦‚ä¸‹ï¼š\n1ã€NewMemoryCollector å‡½æ•°çš„å®šä¹‰ NewMemoryCollector å‡½æ•°æ¥æ”¶ä¸€ä¸ª *ssh.Client ä½œä¸ºå‚æ•°å¹¶è¿”å›ä¸€ä¸ª *memoryCollector å®ä¾‹ã€‚\n1 2 3 4 5 6 func NewMemoryCollector(sc *ssh.Client) *memoryCollector { return \u0026amp;memoryCollector{ sc: sc, metrics: map[string]*prometheus.Desc{}, } } 2ã€memoryCollector çš„å®šä¹‰ memoryCollector ç»“æ„ä½“åŒ…å«ä¸¤ä¸ªå­—æ®µï¼š\nmetricsï¼šä¸€ä¸ª map[string]*prometheus.Descï¼Œç”¨äºå­˜å‚¨æŒ‡æ ‡çš„æè¿°ä¿¡æ¯ã€‚ scï¼šä¸€ä¸ª *ssh.Clientï¼Œç”¨äºé€šè¿‡ SSH è¿æ¥åˆ° Padavan è®¾å¤‡ä»¥æ”¶é›†ç›‘æ§æ•°æ®ã€‚ 1 2 3 4 type memoryCollector struct { metrics map[string]*prometheus.Desc // å­˜å‚¨æŒ‡æ ‡æè¿°ä¿¡æ¯ sc *ssh.Client // SSHå®¢æˆ·ç«¯ï¼Œç”¨äºè¿œç¨‹æ”¶é›†æŒ‡æ ‡ä¿¡æ¯ } 3ã€åœ¨ main å‡½æ•°ä¸­è°ƒç”¨ NewMemoryCollector åœ¨ main å‡½æ•°ä¸­ï¼Œé¦–å…ˆåˆå§‹åŒ– Prometheus æ³¨å†Œè¡¨å’Œ SSH å®¢æˆ·ç«¯ï¼Œç„¶åè°ƒç”¨ NewMemoryCollector å‡½æ•°åˆ›å»ºä¸€ä¸ª memoryCollector å®ä¾‹ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ° Prometheus æ³¨å†Œè¡¨ä¸­ã€‚\n1 reg.MustRegister(collector.NewMemoryCollector(sc)) 4ã€memoryCollector çš„å·¥ä½œåŸç† åˆå§‹åŒ– SSH å®¢æˆ·ç«¯ï¼š initSshClient å‡½æ•°åˆ›å»ºä¸€ä¸ª SSH å®¢æˆ·ç«¯ï¼Œç”¨äºè¿æ¥åˆ° Padavan è®¾å¤‡ã€‚ åˆ›å»º memoryCollector å®ä¾‹ï¼š è°ƒç”¨ NewMemoryCollector(sc)ï¼Œä¼ å…¥ SSH å®¢æˆ·ç«¯ï¼Œè¿”å›ä¸€ä¸ª memoryCollector å®ä¾‹ã€‚ æ³¨å†Œæ”¶é›†å™¨ï¼š ä½¿ç”¨ reg.MustRegister(collector.NewMemoryCollector(sc)) å°† memoryCollector æ³¨å†Œåˆ° Prometheus æ³¨å†Œè¡¨ä¸­ã€‚è¿™æ · Prometheus å°±å¯ä»¥é€šè¿‡ /metrics æ¥å£è°ƒç”¨ memoryCollector çš„ Collect æ–¹æ³•æ”¶é›†å†…å­˜æŒ‡æ ‡æ•°æ®ã€‚ æ”¶é›†æŒ‡æ ‡æ•°æ®ï¼š memoryCollector çš„ Collect æ–¹æ³•é€šè¿‡ SSH å®¢æˆ·ç«¯è¿æ¥åˆ° Padavan è®¾å¤‡ï¼Œè¯»å– /proc/meminfo æ–‡ä»¶ï¼Œè§£ææ–‡ä»¶å†…å®¹å¹¶ç”Ÿæˆ Prometheus æŒ‡æ ‡ï¼Œç„¶åå°†æŒ‡æ ‡å‘é€åˆ°é€šé“ä¸­ä¾› Prometheus æ”¶é›†ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 func (m *memoryCollector) Collect(ch chan\u0026lt;- prometheus.Metric) { // é€šè¿‡SSHå®¢æˆ·ç«¯è·å–è¿œç¨‹æœºå™¨çš„/proc/meminfoæ–‡ä»¶å†…å®¹ content := mustGetContent(m.sc, \u0026#34;/proc/meminfo\u0026#34;) // åˆ›å»ºScannerç”¨äºé€è¡Œè¯»å–å†…å®¹ scanner := bufio.NewScanner(strings.NewReader(content)) // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¡Œå†…å®¹ï¼Œè·å–æŒ‡æ ‡åå’Œå€¼ for scanner.Scan() { parts := meminfoReg.FindStringSubmatch(scanner.Text()) if len(parts) != 3 { // å¦‚æœåŒ¹é…ä¸æˆåŠŸï¼Œåˆ™è·³è¿‡å½“å‰è¡Œ continue } // æŒ‡æ ‡å key := parts[1] // è§£ææŒ‡æ ‡å€¼ value, err := strconv.ParseFloat(parts[2], 64) if err != nil { continue // å¦‚æœè§£æå¤±è´¥ï¼Œåˆ™è·³è¿‡å½“å‰è¡Œ } value *= 1024 // å°†å€¼ä»kBè½¬æ¢ä¸ºB var desc *prometheus.Desc var ok bool // æ ¹æ®æŒ‡æ ‡åï¼Œè·å–æˆ–åˆ›å»ºå¯¹åº”çš„Descå¯¹è±¡ switch key { case \u0026#34;MemTotal\u0026#34;: desc, ok = m.metrics[\u0026#34;MemTotal\u0026#34;] if !ok { desc = prometheus.NewDesc(\u0026#34;node_memory_total_bytes\u0026#34;, \u0026#34;Total memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;MemTotal\u0026#34;] = desc } case \u0026#34;MemFree\u0026#34;: desc, ok = m.metrics[\u0026#34;MemFree\u0026#34;] if (!ok) { desc = prometheus.NewDesc(\u0026#34;node_memory_free_bytes\u0026#34;, \u0026#34;Free memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;MemFree\u0026#34;] = desc } case \u0026#34;Buffers\u0026#34;: desc, ok = m.metrics[\u0026#34;Buffers\u0026#34;] if (!ok) { desc = prometheus.NewDesc(\u0026#34;node_memory_buffers_bytes\u0026#34;, \u0026#34;Buffers memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;Buffers\u0026#34;] = desc } case \u0026#34;Cached\u0026#34;: desc, ok = m.metrics[\u0026#34;Cached\u0026#34;] if (!ok) { desc = prometheus.NewDesc(\u0026#34;node_memory_cached_bytes\u0026#34;, \u0026#34;Cached memory in bytes.\u0026#34;, nil, nil) m.metrics[\u0026#34;Cached\u0026#34;] = desc } default: continue // å¦‚æœä¸æ˜¯æˆ‘ä»¬å…³å¿ƒçš„æŒ‡æ ‡ï¼Œåˆ™è·³è¿‡å½“å‰è¡Œ } // å‘é€šé“å‘é€æŒ‡æ ‡ ch \u0026lt;- prometheus.MustNewConstMetric(desc, prometheus.GaugeValue, value) } } ","date":"2024-07-09T10:24:28Z","image":"https://www.ownit.top/title_pic/27.jpg","permalink":"https://www.ownit.top/p/202407091024/","title":"åŸºäºPadavan Exporterçš„Prometheuså®¢æˆ·ç«¯äºŒæ¬¡å¼€å‘å®è·µ"},{"content":"1ã€ç®€ä»‹ åœ¨ç°ä»£ IT åŸºç¡€è®¾æ–½ä¸­ï¼Œç®¡ç†å¤§é‡æœåŠ¡å™¨æ˜¯ä¸€é¡¹å¤æ‚è€Œç¹ççš„ä»»åŠ¡ã€‚ç‰¹åˆ«æ˜¯åœ¨æ£€æŸ¥æœåŠ¡å™¨çš„å­˜æ´»çŠ¶æ€ä»¥åŠ SSH ç™»å½•ç­‰ä»»åŠ¡ä¸Šï¼Œæ‰‹åŠ¨æ“ä½œéå¸¸è€—æ—¶ä¸”å®¹æ˜“å‡ºé”™ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Python è„šæœ¬å®ç°å¯¹å¤šå°æœåŠ¡å™¨çš„æ‰¹é‡æ£€æŸ¥å’Œç®¡ç†ï¼ŒåŒ…æ‹¬æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦åœ¨çº¿ï¼Œä»¥åŠé€šè¿‡å¯†ç æˆ– SSH å¯†é’¥ç™»å½•æœåŠ¡å™¨ã€‚\n2ã€èƒŒæ™¯ åœ¨æˆ‘ä»¬æµ‹è¯•æœºæˆ¿ç¯å¢ƒï¼Œä¸ºäº†æ–¹ä¾¿ç®¡ç†å’Œä½¿ç”¨ã€‚éœ€è¦ç»Ÿä¸€ è´¦å·ï¼Œç™»å½•æ–¹å¼ï¼Œä»¥åŠå ¡å’æœºå®‰å…¨éªŒè¯ã€‚åœ¨ä¹‹å‰æ¶æ„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬éœ€è¦æ¢³ç†æ•´åˆç°æœ‰æ‰€æœ‰æµ‹è¯•æœºå™¨ã€‚ éœ€è¦æ‰¹é‡ç®¡ç†å’Œç›‘æ§å¤šå°æœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å­˜æ´»ã€æ˜¯å¦å¯ä»¥é€šè¿‡ SSH ç™»å½•ç­‰ã€‚æ‰‹åŠ¨æ‰§è¡Œè¿™äº›ä»»åŠ¡æ•ˆç‡ä½ä¸”å®¹æ˜“å‡ºé”™ã€‚é€šè¿‡ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œå¯ä»¥å¤§å¤§æé«˜å·¥ä½œæ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚\n3ã€ç¯å¢ƒä»‹ç» 1ã€ä¾èµ–åº“ paramikoï¼šç”¨äº SSH ç™»å½•ã€‚ tqdmï¼šç”¨äºæ˜¾ç¤ºè¿›åº¦æ¡ã€‚ concurrent.futuresï¼šç”¨äºå¤šçº¿ç¨‹å¤„ç†ã€‚ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…è¿™äº›åº“ï¼š\n1 pip install paramiko tqdm 2ã€æ–‡ä»¶ç»“æ„ hostsï¼šåŒ…å«æœåŠ¡å™¨ IP åœ°å€çš„æ–‡ä»¶ï¼Œæ¯è¡Œä¸€ä¸ª IP åœ°å€ã€‚ ssh_keyï¼šSSH ç§é’¥æ–‡ä»¶è·¯å¾„ã€‚ script.pyï¼šä¸»è„šæœ¬æ–‡ä»¶ã€‚ 4ã€Pythonå®ç°æ­¥éª¤ æ–¹ä¾¿ç»Ÿè®¡ä½¿ç”¨ï¼Œå½’æ¡£æ–‡ä»¶ åæœŸæ•´ç†ç»´æŠ¤\nç¬¬ä¸€æ­¥ï¼šè¯»å– IP åœ°å€ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è¯»å– hosts æ–‡ä»¶ä¸­çš„ IP åœ°å€ã€‚æ¯è¡Œä¸€ä¸ª IP åœ°å€ã€‚\n1 2 3 # è¯»å– IP åœ°å€ with open(\u0026#39;hosts\u0026#39;, \u0026#39;r\u0026#39;) as file: ip_addresses = [line.strip() for line in file.readlines()] ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ IP æ˜¯å¦å­˜æ´» æˆ‘ä»¬ä½¿ç”¨ ping å‘½ä»¤æ£€æŸ¥æ¯ä¸ª IP æ˜¯å¦å­˜æ´»ã€‚é€šè¿‡ subprocess æ¨¡å—æ‰§è¡Œ ping å‘½ä»¤ï¼Œå¹¶æ£€æŸ¥è¿”å›ç æ¥åˆ¤æ–­ IP æ˜¯å¦å­˜æ´»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 import subprocess def is_alive(ip): try: #è¿™é‡Œæ³¨æ„åˆ¤æ–­ # For Unix/Linux/Mac result = subprocess.run([\u0026#39;ping\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;1\u0026#39;, ip], stdout=subprocess.PIPE, stderr=subprocess.PIPE) except FileNotFoundError: # For Windows result = subprocess.run([\u0026#39;ping\u0026#39;, \u0026#39;-n\u0026#39;, \u0026#39;1\u0026#39;, ip], stdout=subprocess.PIPE, stderr=subprocess.PIPE) return result.returncode == 0 ç¬¬ä¸‰æ­¥ï¼šå°è¯• SSH ç™»å½• æˆ‘ä»¬ä½¿ç”¨ paramiko åº“å°è¯•é€šè¿‡å¯†ç å’Œ SSH å¯†é’¥ç™»å½•æœåŠ¡å™¨ã€‚ä¸ºäº†å¤„ç† RSA æ ¼å¼çš„å¯†é’¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ paramiko.RSAKey.from_private_key_file å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 import paramiko from paramiko import SSHClient, AutoAddPolicy, RSAKey def ssh_login_with_password(ip, username, password): try: client = SSHClient() client.set_missing_host_key_policy(AutoAddPolicy()) client.connect(ip, username=username, password=password, timeout=5) client.close() return True except Exception as e: return False def ssh_login_with_key(ip, username, key_path): try: client = SSHClient() client.set_missing_host_key_policy(AutoAddPolicy()) key = RSAKey.from_private_key_file(key_path) client.connect(ip, username=username, pkey=key, timeout=5) client.close() return True except Exception as e: return False ç¬¬å››æ­¥ï¼šå¹¶è¡Œå¤„ç† IP åœ°å€ ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ concurrent.futures.ThreadPoolExecutor å®ç°å¤šçº¿ç¨‹å¤„ç†ã€‚æ¯ä¸ªçº¿ç¨‹ä¼šæ£€æŸ¥ä¸€ä¸ª IP çš„å­˜æ´»çŠ¶æ€ï¼Œå¹¶å°è¯•é€šè¿‡å¯†ç å’Œ SSH å¯†é’¥ç™»å½•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 from concurrent.futures import ThreadPoolExecutor, as_completed from tqdm import tqdm def check_ip(ip): if not is_alive(ip): return (\u0026#39;non_alive\u0026#39;, ip) else: if ssh_login_with_password(ip, USERNAME, PASSWORD): return (\u0026#39;ssh_password_success\u0026#39;, ip) elif ssh_login_with_key(ip, USERNAME, KEY_PATH): return (\u0026#39;ssh_key_success\u0026#39;, ip) else: return (\u0026#39;ssh_failures\u0026#39;, ip) with ThreadPoolExecutor(max_workers=10) as executor: futures = {executor.submit(check_ip, ip): ip for ip in ip_addresses} for future in tqdm(as_completed(futures), total=len(ip_addresses), desc=\u0026#34;Checking IPs\u0026#34;): result, ip = future.result() if result == \u0026#39;non_alive\u0026#39;: non_alive_ips.append(ip) elif result == \u0026#39;ssh_password_success\u0026#39;: ssh_password_success.append(ip) elif result == \u0026#39;ssh_key_success\u0026#39;: ssh_key_success.append(ip) elif result == \u0026#39;ssh_failures\u0026#39;: ssh_failures.append(ip) ç¬¬äº”æ­¥ï¼šç”Ÿæˆç»“æœæ–‡ä»¶ æœ€åï¼Œæˆ‘ä»¬å°†æ£€æŸ¥ç»“æœå†™å…¥ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼ŒæŒ‰ç…§æŒ‡å®šçš„æ ¼å¼è®°å½•æ¯ä¸ª IP çš„çŠ¶æ€ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # å†™å…¥ç»“æœåˆ°æ–‡ä»¶ with open(\u0026#39;output.txt\u0026#39;, \u0026#39;w\u0026#39;) as output_file: output_file.write(\u0026#34;[no_alive]\\n\u0026#34;) output_file.write(\u0026#34;\\n\u0026#34;.join(non_alive_ips) + \u0026#34;\\n\u0026#34;) output_file.write(\u0026#34;[password]\\n\u0026#34;) output_file.write(\u0026#34;\\n\u0026#34;.join(ssh_password_success) + \u0026#34;\\n\u0026#34;) output_file.write(\u0026#34;[key]\\n\u0026#34;) output_file.write(\u0026#34;\\n\u0026#34;.join(ssh_key_success) + \u0026#34;\\n\u0026#34;) output_file.write(\u0026#34;[fail]\\n\u0026#34;) output_file.write(\u0026#34;\\n\u0026#34;.join(ssh_failures) + \u0026#34;\\n\u0026#34;) print(\u0026#34;Results have been written to output.txt\u0026#34;) å®Œæ•´çš„ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 # -*- coding: utf-8 -*- # @Time : 2024-06-27 11:46 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : kvm.py # @Software: PyCharm import os import subprocess from paramiko import SSHClient, AutoAddPolicy from tqdm import tqdm from concurrent.futures import ThreadPoolExecutor, as_completed # è¯»å– IP åœ°å€ with open(\u0026#39;hosts\u0026#39;, \u0026#39;r\u0026#39;) as file: ip_addresses = [line.strip() for line in file.readlines()] # åˆå§‹åŒ–åˆ—è¡¨ non_alive_ips = [] ssh_password_success = [] ssh_key_success = [] ssh_failures = [] # æ£€æŸ¥ IP å­˜æ´»çŠ¶æ€ def is_alive(ip): # For Windows result = subprocess.run([\u0026#39;ping\u0026#39;, \u0026#39;-n\u0026#39;, \u0026#39;1\u0026#39;, ip], stdout=subprocess.PIPE, stderr=subprocess.PIPE) return result.returncode == 0 # å°è¯•ä½¿ç”¨å¯†ç è¿›è¡Œ SSH ç™»å½• def ssh_login_with_password(ip, username, password): try: client = SSHClient() client.set_missing_host_key_policy(AutoAddPolicy()) client.connect(ip, username=username, password=password, timeout=5) client.close() return True except Exception as e: return False # å°è¯•ä½¿ç”¨ SSH å¯†é’¥è¿›è¡Œç™»å½• def ssh_login_with_key(ip, username, key_path): try: client = SSHClient() client.set_missing_host_key_policy(AutoAddPolicy()) client.connect(ip, username=username, key_filename=key_path, timeout=5) client.close() return True except Exception as e: return False # ç”¨æˆ·åå’Œå¯†ç /å¯†é’¥è·¯å¾„é…ç½® USERNAME = \u0026#39;root\u0026#39; PASSWORD = \u0026#39;xxxx.88\u0026#39; KEY_PATH = r\u0026#39;E:\\Code\\Gitlab_Code\\aliyun\\kvm_centos\\ssh_key\u0026#39; def check_ip(ip): if not is_alive(ip): return \u0026#39;non_alive\u0026#39;, ip else: if ssh_login_with_password(ip, USERNAME, PASSWORD): return \u0026#39;ssh_password_success\u0026#39;, ip elif ssh_login_with_key(ip, USERNAME, KEY_PATH): return \u0026#39;ssh_key_success\u0026#39;, ip else: return \u0026#39;ssh_failures\u0026#39;, ip # æ£€æŸ¥æ¯ä¸ª IP åœ°å€ # ä½¿ç”¨å¤šçº¿ç¨‹æ£€æŸ¥ IP åœ°å€ # ä½¿ç”¨ThreadPoolExecutoræ¥å¹¶å‘æ‰§è¡Œä»»åŠ¡ï¼Œæœ€å¤§å·¥ä½œçº¿ç¨‹æ•°ä¸º10 with ThreadPoolExecutor(max_workers=10) as executor: # æäº¤æ£€æŸ¥æ¯ä¸ªIPåœ°å€çš„ä»»åŠ¡ï¼Œå¹¶å°†ä»»åŠ¡å¯¹è±¡ä¸IPåœ°å€æ˜ å°„å…³ç³»å­˜å‚¨åœ¨å­—å…¸futuresä¸­ futures = {executor.submit(check_ip, ip): ip for ip in ip_addresses} # éå†æ‰€æœ‰å®Œæˆçš„ä»»åŠ¡ï¼Œä½¿ç”¨tqdmæ˜¾ç¤ºè¿›åº¦æ¡ for future in tqdm(as_completed(futures), total=len(ip_addresses), desc=\u0026#34;Checking IPs\u0026#34;): # è·å–ä»»åŠ¡æ‰§è¡Œç»“æœå’Œå¯¹åº”çš„IPåœ°å€ result, ip = future.result() # æ ¹æ®æ£€æŸ¥ç»“æœï¼Œå°†IPåœ°å€æ·»åŠ åˆ°ç›¸åº”çš„åˆ—è¡¨ä¸­ if result == \u0026#39;non_alive\u0026#39;: non_alive_ips.append(ip) elif result == \u0026#39;ssh_password_success\u0026#39;: ssh_password_success.append(ip) elif result == \u0026#39;ssh_key_success\u0026#39;: ssh_key_success.append(ip) elif result == \u0026#39;ssh_failures\u0026#39;: ssh_failures.append(ip) # è¾“å‡ºç»“æœ print(\u0026#34;Non-alive IPs:\u0026#34;, non_alive_ips) print(\u0026#34;SSH login with password successful:\u0026#34;, ssh_password_success) print(\u0026#34;SSH login with key successful:\u0026#34;, ssh_key_success) print(\u0026#34;Alive but SSH login failed:\u0026#34;, ssh_failures) # å†™å…¥ç»“æœåˆ°æ–‡ä»¶ with open(\u0026#39;output.txt\u0026#39;, \u0026#39;w\u0026#39;) as output_file: output_file.write(\u0026#34;[no_alive]\\n\u0026#34;) output_file.write(\u0026#34;\\n\u0026#34;.join(non_alive_ips) + \u0026#34;\\n\u0026#34;) output_file.write(\u0026#34;[password]\\n\u0026#34;) output_file.write(\u0026#34;\\n\u0026#34;.join(ssh_password_success) + \u0026#34;\\n\u0026#34;) output_file.write(\u0026#34;[key]\\n\u0026#34;) output_file.write(\u0026#34;\\n\u0026#34;.join(ssh_key_success) + \u0026#34;\\n\u0026#34;) output_file.write(\u0026#34;[fail]\\n\u0026#34;) output_file.write(\u0026#34;\\n\u0026#34;.join(ssh_failures) + \u0026#34;\\n\u0026#34;) print(\u0026#34;Results have been written to output.txt\u0026#34;) 5ã€Ansbileå®ç°æ­¥éª¤ 1ã€ä¸Šé¢ç”Ÿæˆçš„æ–‡ä»¶ä½œä¸ºhostsä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 [fail] 192.168.84.37 192.168.84.38 192.168.99.160 192.168.99.176 192.168.99.254 192.168.102.200 192.168.102.248 192.168.102.249 192.168.102.250 192.168.102.251 #å¯ä»¥å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿ç™»å½•ä½¿ç”¨ [fail:vars] ansible_user=root ansible_password=\u0026#34;xxxxxx.88\u0026#34; ansible_ssh_private_key_file=/opt/ansible/ssh_key 2ã€ç»™å¯†ç ç™»å½•çš„æ·»åŠ å…¬é’¥ 1 ansible password -i ./all_host -m authorized_key -a \u0026#34;user={{ ansible_user }} state=present key=\u0026#39;{{ lookup(\u0026#39;file\u0026#39;, \u0026#39;~/.ssh/id_rsa.pub\u0026#39;) }}\u0026#39;\u0026#34; -u root --ask-pass ä½œç”¨ï¼šè¿™æ¡å‘½ä»¤ä¼šæç¤ºç”¨æˆ·è¾“å…¥ SSH å¯†ç ï¼Œå¹¶å°†è¿è¡Œ Ansible ä»¥ root ç”¨æˆ·èº«ä»½è¿æ¥åˆ° all_host æ–‡ä»¶ä¸­åˆ—å‡ºçš„æ‰€æœ‰ä¸»æœºã€‚ç„¶åï¼Œå®ƒä¼šå°†å½“å‰ç”¨æˆ·çš„å…¬é’¥æ·»åŠ åˆ°è¿™äº›ä¸»æœºä¸ŠæŒ‡å®šç”¨æˆ·çš„ authorized_keys æ–‡ä»¶ä¸­ï¼Œä»¥å®ç°æ— å¯†ç  SSH ç™»å½•ã€‚\nansible password -i ./all_hostï¼š\nansibleï¼šAnsible å‘½ä»¤çš„å…¥å£ç‚¹ã€‚ passwordï¼šè¿™é‡Œåº”è¯¥æ˜¯æŒ‡ Ansible çš„ inventory æ–‡ä»¶ä¸­å®šä¹‰çš„æ¨¡å—åç§° -i ./all_hostï¼šæŒ‡å®š Ansible inventory æ–‡ä»¶çš„ä½ç½®ï¼Œè¿™é‡Œæ˜¯ ./all_hostã€‚ -m authorized_keyï¼š\n-m authorized_keyï¼šæŒ‡å®šè¦ä½¿ç”¨çš„ Ansible æ¨¡å—ï¼Œè¿™é‡Œæ˜¯ authorized_key æ¨¡å—ï¼Œç”¨äºç®¡ç† ~/.ssh/authorized_keys æ–‡ä»¶ã€‚ -a \u0026quot;user={{ ansible_user }} state=present key='{{ lookup('file', '~/.ssh/id_rsa.pub') }}'\u0026quot;ï¼š\n-aï¼šä¸ºæŒ‡å®šçš„æ¨¡å—ä¼ é€’å‚æ•°ã€‚\n\u0026quot;user={{ ansible_user }} state=present key='{{ lookup('file', '~/.ssh/id_rsa.pub') }}'\u0026quot;\nuser={{ ansible_user }}ï¼šæŒ‡å®šè¦åœ¨ç›®æ ‡ä¸»æœºä¸Šæ“ä½œçš„ç”¨æˆ·ï¼Œè¿™é‡Œä½¿ç”¨äº†å˜é‡ {{ ansible_user }}ï¼Œè¿™ä¸ªå˜é‡é€šå¸¸åœ¨ Ansible çš„é…ç½®æ–‡ä»¶æˆ–å‘½ä»¤è¡Œä¸­å®šä¹‰ã€‚ state=presentï¼šç¡®ä¿å…¬é’¥å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±æ·»åŠ ã€‚ key='{{ lookup('file', '~/.ssh/id_rsa.pub') }}'ï¼šä»æœ¬åœ°æ–‡ä»¶ ~/.ssh/id_rsa.pub ä¸­è¯»å–å…¬é’¥ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ç›®æ ‡ä¸»æœºçš„ authorized_keys æ–‡ä»¶ä¸­ã€‚ -u rootï¼š\n-u rootï¼šä»¥ root ç”¨æˆ·èº«ä»½è¿æ¥åˆ°ç›®æ ‡ä¸»æœºã€‚ --ask-passï¼š\n--ask-passï¼šæç¤ºè¾“å…¥ SSH å¯†ç ã€‚è¿™åœ¨ç›®æ ‡ä¸»æœºè¿˜æ²¡æœ‰é…ç½®æ— å¯†ç  SSH ç™»å½•æ—¶å¾ˆæœ‰ç”¨ã€‚ 6ã€è‡ªåŠ¨åŒ–é…ç½®å®‰å…¨ hosts.allow å’Œ hosts.deny æ–‡ä»¶æ˜¯ TCP Wrappers çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºåœ¨ Unix å’Œ Linux ç³»ç»Ÿä¸Šæ§åˆ¶å¯¹æœåŠ¡çš„è®¿é—®ã€‚TCP Wrappers æä¾›äº†ä¸€ç§é€šè¿‡ IP åœ°å€ã€ä¸»æœºåæˆ–åŸŸåé™åˆ¶æˆ–å…è®¸è®¿é—®æœåŠ¡çš„æœºåˆ¶ã€‚\nhosts.allow å’Œ hosts.deny æ–‡ä»¶çš„ä½œç”¨ hosts.allowï¼šå®šä¹‰å…è®¸å“ªäº›ä¸»æœºè®¿é—®å“ªäº›æœåŠ¡ã€‚ hosts.denyï¼šå®šä¹‰æ‹’ç»å“ªäº›ä¸»æœºè®¿é—®å“ªäº›æœåŠ¡ã€‚ è¿™ä¸¤ä¸ªæ–‡ä»¶é€šå¸¸ä½äº /etc ç›®å½•ä¸‹ã€‚\næ ¼å¼ è¿™ä¸¤ä¸ªæ–‡ä»¶çš„æ¯ä¸€è¡ŒåŒ…å«ä¸€æ¡è®¿é—®æ§åˆ¶è§„åˆ™ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n1 phpå¤åˆ¶ä»£ç \u0026lt;æœåŠ¡åˆ—è¡¨\u0026gt; : \u0026lt;å®¢æˆ·ç«¯åˆ—è¡¨\u0026gt; [: \u0026lt;é€‰é¡¹\u0026gt;] æœåŠ¡åˆ—è¡¨ï¼šè¦æ§åˆ¶çš„æœåŠ¡åç§°ï¼Œå¯ä»¥æ˜¯å•ä¸ªæœåŠ¡åï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªæœåŠ¡åï¼Œä»¥é€—å·åˆ†éš”ã€‚ å®¢æˆ·ç«¯åˆ—è¡¨ï¼šå…è®¸æˆ–æ‹’ç»è®¿é—®çš„å®¢æˆ·ç«¯ï¼Œå¯ä»¥æ˜¯ IP åœ°å€ã€ä¸»æœºåæˆ–åŸŸåï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªå®¢æˆ·ç«¯ï¼Œä»¥é€—å·åˆ†éš”ã€‚ é€‰é¡¹ï¼ˆå¯é€‰ï¼‰ï¼šå¯ä»¥åŒ…å«æ—¥å¿—è®°å½•æˆ–æ‰§è¡Œå‘½ä»¤ç­‰é¢å¤–æ“ä½œã€‚ ä½¿ç”¨ç¤ºä¾‹ å‡è®¾ä½ æœ‰ä¸€å°æœåŠ¡å™¨ï¼Œæƒ³æ§åˆ¶å¯¹ SSH æœåŠ¡çš„è®¿é—®ã€‚\nhosts.allow å…è®¸ç‰¹å®š IP åœ°å€è®¿é—® SSH æœåŠ¡ï¼š\n1 sshd : 192.168.1.100 å…è®¸ç‰¹å®šå­ç½‘è®¿é—® SSH æœåŠ¡ï¼š\n1 sshd : 192.168.1.0/24 å…è®¸ç‰¹å®šä¸»æœºåè®¿é—® SSH æœåŠ¡ï¼š\n1 sshd : trustedhost.example.com hosts.deny æ‹’ç»æ‰€æœ‰å…¶ä»–ä¸»æœºè®¿é—® SSH æœåŠ¡ï¼š\n1 sshd : ALL ä½¿ç”¨åœºæ™¯ å®‰å…¨æ§åˆ¶ï¼šé€šè¿‡é™åˆ¶å¯¹æŸäº›å…³é”®æœåŠ¡ï¼ˆå¦‚ SSHã€FTPã€SMTP ç­‰ï¼‰çš„è®¿é—®ï¼Œå¯ä»¥å¢å¼ºç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚ è®¿é—®ç®¡ç†ï¼šåœ¨å¤šç”¨æˆ·ç¯å¢ƒä¸­ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚çµæ´»æ§åˆ¶å“ªäº›ç”¨æˆ·æˆ–ä¸»æœºèƒ½å¤Ÿè®¿é—®ç‰¹å®šæœåŠ¡ã€‚ æ—¥å¿—è®°å½•ï¼šç»“åˆæ—¥å¿—é€‰é¡¹ï¼Œå¯ä»¥è®°å½•è®¿é—®å°è¯•ï¼Œä»¥ä¾¿å®¡è®¡å’Œç›‘æ§ã€‚ ç¤ºä¾‹éœ€æ±‚ åœ¨ /etc/hosts.deny ä¸­å†™å…¥ sshd:ALLï¼Œæ‹’ç»æ‰€æœ‰ä¸»æœºçš„ SSH è®¿é—®ã€‚\nåœ¨/etc/hosts.allow ä¸­å…è®¸ç‰¹å®š IP åœ°å€æ®µå’Œå•ä¸ª IP åœ°å€çš„ SSH è®¿é—®ï¼š\nsshd:192.168.0.0/16:allow sshd:192.168.102.20:allow å¦‚æœæ–‡ä»¶æœ‰å˜åŠ¨ï¼Œåˆ™é‡å¯ sshd æœåŠ¡ã€‚\nAnsible å‰§æœ¬ ç¼–å†™ä¸€ä¸ª Ansible å‰§æœ¬æ¥è‡ªåŠ¨æ‰§è¡Œä¸Šè¿°æ“ä½œã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„ Ansible å‰§æœ¬ä»£ç ï¼šconfigure_ssh_hosts.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 --- - name: é…ç½® hosts.allow å’Œ hosts.deny hosts: test become: yes # ä½¿ç”¨sudoæƒé™ vars: hosts_deny_content: \u0026#34;sshd:ALL\u0026#34; hosts_allow_content: | sshd:192.168.0.0/16:allow sshd:192.168.102.20:allow tasks: - name: æ›´æ–° hosts.deny æ–‡ä»¶ lineinfile: path: /etc/hosts.deny line: \u0026#34;{{ hosts_deny_content }}\u0026#34; create: yes register: hosts_deny_result - name: æ›´æ–° hosts.allow æ–‡ä»¶ copy: content: \u0026#34;{{ hosts_allow_content }}\u0026#34; dest: /etc/hosts.allow register: hosts_allow_result - name: å¦‚æœé…ç½®å‘ç”Ÿå˜åŒ–åˆ™é‡å¯ sshd æœåŠ¡ systemd: name: sshd state: restarted when: hosts_deny_result.changed or hosts_allow_result.changed - name: ç¡®ä¿ sshd æœåŠ¡å·²å¯ç”¨å¹¶æ­£åœ¨è¿è¡Œ systemd: name: sshd state: started enabled: yes ä½¿ç”¨æ–¹å¼ å®šä¹‰å‰§æœ¬åç§°å’Œç›®æ ‡ä¸»æœºï¼š\n1 2 3 4 [root@ansible-yunwei ansible]# cat hosts [test] 192.168.102.20 192.168.102.30 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 [root@ansible-yunwei ansible]# ansible-playbook -i ./hosts configure_ssh_hosts.yml PLAY [é…ç½® hosts.allow å’Œ hosts.deny] ******************************************************************************************************************************* TASK [Gathering Facts] ******************************************************************************************************************************************* ok: [192.168.102.30] ok: [192.168.102.20] TASK [æ›´æ–° hosts.deny æ–‡ä»¶] ****************************************************************************************************************************************** ok: [192.168.102.30] ok: [192.168.102.20] TASK [æ›´æ–° hosts.allow æ–‡ä»¶] ***************************************************************************************************************************************** ok: [192.168.102.30] ok: [192.168.102.20] TASK [å¦‚æœé…ç½®å‘ç”Ÿå˜åŒ–åˆ™é‡å¯ sshd æœåŠ¡] *************************************************************************************************************************************** skipping: [192.168.102.20] skipping: [192.168.102.30] TASK [ç¡®ä¿ sshd æœåŠ¡å·²å¯ç”¨å¹¶æ­£åœ¨è¿è¡Œ] **************************************************************************************************************************************** ok: [192.168.102.30] ok: [192.168.102.20] PLAY RECAP ******************************************************************************************************************************************************* 192.168.102.20 : ok=4 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 192.168.102.30 : ok=4 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 æ³¨æ„äº‹é¡¹ hosts.allow æ–‡ä»¶ä¸­çš„è§„åˆ™ä¼˜å…ˆäº hosts.deny ä¸­çš„è§„åˆ™ã€‚å¦‚æœä¸€ä¸ªä¸»æœºè¢« hosts.allow å…è®¸ï¼Œåˆ™ä¸ä¼šè¢« hosts.deny æ‹’ç»ã€‚ ç¡®ä¿è§„åˆ™çš„é¡ºåºå’Œé€»è¾‘æ­£ç¡®ï¼Œä»¥å…æ„å¤–æ‹’ç»åˆæ³•è®¿é—®æˆ–å…è®¸éæ³•è®¿é—®ã€‚ è¿™äº›æ–‡ä»¶é€‚ç”¨äºæ”¯æŒ TCP Wrappers çš„æœåŠ¡ï¼Œä¸é€‚ç”¨äºæ‰€æœ‰æœåŠ¡ã€‚ é€šè¿‡åˆç†é…ç½® hosts.allow å’Œ hosts.deny æ–‡ä»¶ï¼Œå¯ä»¥æœ‰æ•ˆæ§åˆ¶æœåŠ¡è®¿é—®ï¼Œæé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚\n","date":"2024-06-27T17:27:24Z","image":"https://www.ownit.top/title_pic/33.jpg","permalink":"https://www.ownit.top/p/202406271727/","title":"Python ï¼ˆAnsbileï¼‰è„šæœ¬é«˜æ•ˆæ‰¹é‡ç®¡ç†æœåŠ¡å™¨å’Œå®‰å…¨"},{"content":"1ã€èƒŒæ™¯ åœ¨å¾ˆå¤šç»„ç»‡ä¸­ï¼Œéœ€è¦å¯¹ç”¨æˆ·å’Œç³»ç»Ÿè¿›è¡Œç»Ÿä¸€çš„èº«ä»½è®¤è¯å’Œæˆæƒç®¡ç†ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç›®æ ‡ï¼Œé€šå¸¸ä¼šä½¿ç”¨LDAPï¼ˆè½»é‡çº§ç›®å½•è®¿é—®åè®®ï¼‰æ¥æ„å»ºé›†ä¸­åŒ–çš„èº«ä»½è®¤è¯å’ŒæˆæƒæœåŠ¡ã€‚è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ºäº†ä¿è¯é«˜å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§ï¼Œéœ€è¦æ„å»ºOpenLDAPä¸»ä»é›†ç¾¤æ¥æä¾›ç¨³å®šçš„èº«ä»½è®¤è¯æœåŠ¡ã€‚\n2ã€ç¯å¢ƒ åœ¨å¼€å§‹éƒ¨ç½²ä¹‹å‰ï¼Œéœ€è¦å‡†å¤‡ä»¥ä¸‹ç¯å¢ƒï¼š\næ“ä½œç³»ç»Ÿï¼šCentos7 OpenLDAPç‰ˆæœ¬ï¼šOpenLDAP: slapd 2.4.44 æœåŠ¡å™¨æ•°é‡ï¼š2å°ï¼ˆ1å°ä¸»æœåŠ¡å™¨å’Œ1å°ä»æœåŠ¡å™¨ï¼‰ ç½‘ç»œç¯å¢ƒï¼šä¸¤å°æœåŠ¡å™¨åº”åœ¨åŒä¸€å±€åŸŸç½‘å†…ï¼Œç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®š 3ã€ä¸»èŠ‚ç‚¹å®‰è£… æ¸…å‚è€ƒä¸‹æ–¹é“¾æ¥ https://blog.csdn.net/heian_99/article/details/138963912\n4ã€ä»èŠ‚ç‚¹å®‰è£… å‡è®¾masterèŠ‚ç‚¹çš„åœ°å€ä¸º192.168.102.20ã€‚å¯¹äºmasterèŠ‚ç‚¹ï¼Œå®Œå…¨å‚ç…§å‰è¿°ç« èŠ‚æ“ä½œå¹¶é…ç½®å¥½ã€‚\nå¯¹äºslaveèŠ‚ç‚¹ï¼Œä¹Ÿå‚ç…§å‰è¿°ç« èŠ‚å®‰è£…å¹¶é…ç½®ï¼Œä½†åªåˆ°æ‰§è¡Œldapdomain.ldifæ–‡ä»¶åå°±è¡Œã€‚ä¹Ÿå°±æ˜¯è®¾ç½®äº†ç®¡ç†å‘˜ç”¨æˆ·è´¦å·å°±è¡Œï¼Œä¸ç”¨æ·»åŠ éƒ¨é—¨æˆ–å…¶å®ƒäººå‘˜ä¿¡æ¯ã€‚å¦å¤–ï¼ŒphpLDAPadminå¯ä»¥å®‰è£…ã€‚\n1ã€é…ç½®masterèŠ‚ç‚¹ åœ¨masterèŠ‚ç‚¹ä¸Šï¼Œæˆ‘ä»¬éœ€è¦å¯¼å…¥ç›¸å…³çš„ä¿¡æ¯ã€‚\nåˆ›å»ºsyncprov_mod.ldifæ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 cat \u0026gt; syncprov_mod.ldif \u0026lt;\u0026lt; \u0026#34;EOF\u0026#34; dn: cn=module,cn=config objectClass: olcModuleList cn: module olcModulePath: /usr/lib64/openldap olcModuleLoad: syncprov.la EOF æ‰§è¡Œï¼š\n1 ldapadd -Y EXTERNAL -H ldapi:/// -f syncprov_mod.ldif åˆ›å»ºsyncprov.ldifæ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 cat \u0026gt; syncprov.ldif \u0026lt;\u0026lt; \u0026#34;EOF\u0026#34; dn: olcOverlay=syncprov,olcDatabase={2}hdb,cn=config objectClass: olcOverlayConfig objectClass: olcSyncProvConfig olcOverlay: syncprov olcSpCheckpoint: 1 1 olcSpSessionLog: 1024 EOF æ‰§è¡Œï¼š\n1 ldapadd -Y EXTERNAL -H ldapi:/// -f syncprov.ldif 2ã€é…ç½®slaveèŠ‚ç‚¹ åœ¨slaveèŠ‚ç‚¹ä¸Šé…ç½®ä¸»ä»ã€‚\nåˆ›å»ºrp.ldifæ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 cat \u0026gt; rp.ldif \u0026lt;\u0026lt; \u0026#34;EOF\u0026#34; dn: olcDatabase={2}hdb,cn=config changetype: modify add: olcSyncRepl olcSyncRepl: rid=001 provider=ldap://192.168.102.20:389 bindmethod=simple binddn=\u0026#34;cn=Manager,dc=fujfu,dc=com\u0026#34; credentials=examplePassword searchbase=\u0026#34;dc=fujfu,dc=com\u0026#34; scope=sub schemachecking=on type=refreshAndPersist retry=\u0026#34;30 5 300 3\u0026#34; attrs=\u0026#34;*,+\u0026#34; interval=00:00:02:00 EOF providerè¡¨ç¤ºmasterçš„åœ°å€ï¼Œå…¶ä»–çš„éƒ½æ˜¯äº›åŸºç¡€ä¿¡æ¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è®¤è¯ç”¨æˆ·ä¸€å®šè¦ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜ï¼Œå¦‚æœä½¿ç”¨æ™®é€šç”¨æˆ·è¿æ¥masterçš„è¯ï¼Œslaveå°†ä¸ä¼šåŒæ­¥ç”¨æˆ·çš„å¯†ç å­—æ®µä¿¡æ¯ã€‚credentialsæ˜¯ç®¡ç†å‘˜çš„å¯†ç ã€‚ æ‰§è¡Œï¼š\n1 ldapmodify -Y EXTERNAL -H ldapi:/// -f rp.ldif é™¤æ­¤ä¹‹å¤–ï¼Œä¸ºäº†ä¼˜åŒ–openldapçš„æŸ¥è¯¢é€Ÿåº¦ï¼Œæˆ‘ä»¬æ·»åŠ äº†ç›¸å…³å­—æ®µå±æ€§çš„ç´¢å¼•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 cat \u0026gt; index.ldif \u0026lt;\u0026lt; \u0026#34;EOF\u0026#34; dn: olcDatabase={2}hdb,cn=config changetype: modify add: olcDbIndex olcDbIndex: uid eq,pres olcDbIndex: uniqueMember eq,pres olcDbIndex: uidNumber,gidNumber eq,pres olcDbIndex: member,memberUid eq,pres olcDbIndex: entryUUID eq olcDbIndex: entryCSN eq EOF æ‰§è¡Œï¼š\n1 ldapadd -Y EXTERNAL -H ldapi:/// -f index.ldif 3ã€éªŒè¯ä¸»ä»æ­£ç¡®æ€§ slaveæœºå™¨ä¸Šé…ç½®å®Œæ¯•åï¼Œæ— éœ€é‡å¯masteræœºå™¨å’Œslaveæœºå™¨çš„slapdæœåŠ¡ã€‚\nåœ¨slaveæœºå™¨ä¸ŠæŸ¥çœ‹openldapæ—¥å¿—ï¼Œå¦‚ä¸‹ï¼š\n1 journalctl -u slapd -n 100 -f é€šè¿‡ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°slaveæœºå™¨ä¸ŠslapdæœåŠ¡æ²¡æœ‰æŠ¥é”™ï¼Œè€Œä¸”å·²ç»åœ¨åŒæ­¥ç›¸å…³openldapæ•°æ®ã€‚\nç°åœ¨åˆ‡æ¢åˆ°masteræœºå™¨ä¸ŠæŸ¥çœ‹openldapæ—¥å¿—ï¼Œå¦‚ä¸‹ï¼š\n1 journalctl -u slapd -n 100 -f é€šè¿‡ä¸Šå›¾æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°masteræ²¡æœ‰æŠ¥é”™ï¼Œè€Œä¸”ä¹Ÿçœ‹åˆ°slaveæœºå™¨å·²ç»åœ¨åŒæ­¥ä¿¡æ¯äº†ã€‚\nç°åœ¨æˆ‘ä»¬å†ä½¿ç”¨phpLDAPadminå·¥å…·ï¼Œç™»å½•slaveæŸ¥çœ‹ç›¸å…³ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š é€šè¿‡ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°slaveèŠ‚ç‚¹ä¸Šå·²ç»æœ‰è´¦å·ä¿¡æ¯äº†ã€‚è¿™ä¹Ÿå°±è¯´æ˜OpenLDAPçš„master-slaveå·²ç»åœ¨æ­£å¸¸åŒæ­¥æ•°æ®ã€‚\n4ã€æµ‹è¯• å¯æµ‹è¯•å¦‚ä¸‹ä¸¤ç‚¹ï¼š 1ã€åœ¨masterèŠ‚ç‚¹ä¸Šä¿®æ”¹ç”¨æˆ·å­—æ®µä¿¡æ¯ï¼ŒslaveèŠ‚ç‚¹ä¸Šåº”èƒ½åŒæ­¥åˆ°ä¿®æ”¹ä¿¡æ¯ã€‚ 2ã€åœ¨slaveèŠ‚ç‚¹ä¿®æ”¹ç”¨æˆ·å­—æ®µä¿¡æ¯ï¼Œåº”è¯¥æ— æ³•æ“ä½œã€‚å› ä¸ºæˆ‘ä»¬é‡‡ç”¨çš„ä¸»ä»æ¨¡å¼ä¸­ï¼ŒslaveèŠ‚ç‚¹æ˜¯è‡ªè¯»çš„ã€‚\nå¦‚æœæµ‹è¯•æ— é—®é¢˜ï¼Œè¯´æ˜æˆ‘ä»¬çš„ä¸»ä»çš„ç¡®æ­£å¸¸è¿è¡Œã€‚ LDAPæŸ¥çœ‹å‘½ä»¤ é™„ldapæŸ¥çœ‹é…ç½®å‘½ä»¤ï¼š ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b cn=config ldapsearch -x cn=test -b dc=local,dc=cn\n","date":"2024-06-20T17:00:04Z","image":"https://www.ownit.top/title_pic/63.jpg","permalink":"https://www.ownit.top/p/202406201700/","title":"ç”Ÿäº§ç¯å¢ƒOpenLDAPä¸»ä»é›†ç¾¤"},{"content":"1ã€é¡¹ç›®èƒŒæ™¯ åœ¨å½“å‰çš„ITè¿ç»´ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡ç³»ç»Ÿæ—¥ç›Šå¤æ‚ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹ç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘å’Œå®šåˆ¶åŒ–éœ€æ±‚ï¼Œä¼ ç»Ÿçš„é€šç”¨ç›‘æ§å·¥å…·å¾€å¾€éš¾ä»¥è¦†ç›–æ‰€æœ‰çš„ç›‘æ§åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘åˆ°ä¸€ä¸ªå¤æ‚çš„ç”µå•†å¹³å°ï¼Œé™¤äº†åŸºç¡€çš„æœåŠ¡å™¨æ€§èƒ½ã€ç½‘ç»œçŠ¶å†µç­‰åŸºç¡€è®¾æ–½ç›‘æ§å¤–ï¼Œæˆ‘ä»¬è¿˜è¿«åˆ‡éœ€è¦å¯¹ç‰¹å®šä¸šåŠ¡æŒ‡æ ‡è¿›è¡Œç›‘æ§ï¼Œæ¯”å¦‚DNSè§£ææˆåŠŸç‡ã€APIå“åº”å»¶è¿Ÿã€ç‰¹å®šä¸šåŠ¡æµç¨‹çš„é”™è¯¯ç‡ç­‰ï¼Œè¿™äº›éƒ½æ˜¯ç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒå’Œä¸šåŠ¡è¿ç»­æ€§çš„å…³é”®å› ç´ ã€‚\né¢å¯¹è¿™æ ·çš„éœ€æ±‚ï¼Œè™½ç„¶Prometheuså®˜æ–¹æä¾›äº†ä¸€ç³»åˆ—æ ‡å‡†çš„Exporterï¼Œå¦‚node_exporterå’Œsnmp_exporterï¼Œå®ƒä»¬åœ¨åŸºç¡€ç›‘æ§å±‚é¢è¡¨ç°ä¼˜ç§€ï¼Œä½†å¯¹äºä¸Šè¿°æåˆ°çš„ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„ç›‘æ§éœ€æ±‚å´é­é•¿è«åŠã€‚ä¸ºäº†å¼¥è¡¥è¿™ä¸€ç©ºç™½ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªä¸“ä¸ºä¸šåŠ¡å®šåˆ¶çš„Prometheus Exporterï¼Œä»¥å®ç°å¯¹è¿™äº›ç‰¹å®šä¸šåŠ¡æŒ‡æ ‡çš„ç²¾å‡†ç›‘æ§ã€‚\nä¸ºæ­¤ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨Goè¯­è¨€ï¼ˆGolangï¼‰æ¥ç¼–å†™è¿™ä¸ªExporterï¼ŒåŸå› åœ¨äºGoè¯­è¨€å¤©ç”Ÿå¯¹å¹¶å‘å‹å¥½ï¼Œé€‚åˆç¼–å†™é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡ï¼Œä¸”å®˜æ–¹æä¾›äº†æˆç†Ÿçš„Prometheuså®¢æˆ·ç«¯åº“ï¼Œä¾¿äºå¿«é€Ÿé›†æˆå’Œå¼€å‘\nä¸‹é¢çš„ä»£ç åœ°å€ï¼šhttps://github.com/nangongchengfeng/Prometheus-Go-Template\n2ã€å¼€å‘ç¯å¢ƒæ­å»º å®‰è£…Goè¯­è¨€ï¼šç¡®ä¿æœºå™¨ä¸Šå®‰è£…äº†Goè¯­è¨€ï¼ˆ1.20ç‰ˆæœ¬ä»¥ä¸Šï¼‰å¹¶é…ç½®äº†GOPATHã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 curl -L https://go.dev/dl/go1.21.3.linux-amd64.tar.gz -o ./go-linux-amd64.tar.gz è§£å‹ sudo tar -zxvf go-linux-amd64.tar.gz -C /usr/local/lib/ ä¸‹é¢è¯­å¥æ˜¯ç»™æ‰€æœ‰ç”¨æˆ·åˆ›å»ºç¯å¢ƒå˜é‡ # ä¸‹é¢å†…å®¹éœ€è¦å¤šè¡Œå¤åˆ¶ sudo tee -a ~/.bashrc \u0026lt;\u0026lt; EOF export GOROOT=/usr/local/lib/go/ export GOPATH=/home/${USER}/sdk/go export PATH=\\$PATH:\\$GOROOT/bin:\\$GOPATH/bin EOF # å•è¡Œ source ~/.bashrc ä¸‹è½½PrometheusåŒ…ï¼šé€šè¿‡go getå‘½ä»¤ä¸‹è½½client_golangåŒ…ã€‚\n1 2 go get github.com/prometheus/client_golang/prometheus go get github.com/prometheus/client_golang/prometheus/promhttp å¼€å¯Goæ¨¡å—ä»£ç†\n1 2 3 4 5 6 7 8 go env -w GO111MODULE=on go env -w GOPROXY=https://goproxy.cn,direct å¦‚æœä¸è¡Œï¼Œè¯·ä¿®æ”¹ å¦‚ä¸‹è®¾ç½®ï¼š set GOPRIVATE=gitlab.xx.com set GOPROXY=https://goproxy.cn set GONOPROXY=gitlab.xx.com set GONOSUMDB=gitlab.xx.com 3ã€ç¼–å†™ExporteråŸºç¡€ä»£ç  åˆ›å»ºHTTPæœåŠ¡ï¼šä½¿ç”¨Goçš„httpæ¨¡å—åˆ›å»ºä¸€ä¸ªæœåŠ¡ï¼ŒæŒ‡å®š/metricsè·¯å¾„ï¼Œå¹¶ä½¿ç”¨promhttp.Handler()ä½œä¸ºå¤„ç†å™¨ã€‚ å¯åŠ¨æœåŠ¡ï¼šé€šè¿‡http.ListenAndServeå¯åŠ¨HTTPæœåŠ¡ç›‘å¬8080ç«¯å£ã€‚ 1 2 3 4 5 6 7 8 9 10 11 package main import ( \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;github.com/prometheus/client_golang/prometheus/promhttp\u0026#34; ) func main() { http.Handle(\u0026#34;/metrics\u0026#34;, promhttp.Handler()) log.Fatal(http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil)) } è®¿é—®ï¼šip+ç«¯å£:/metrics ä¼šå‡ºç°å¦‚ä¸‹é¡µé¢ï¼ŒGoæ¨¡å—è‡ªå¸¦çš„ç›‘æ§é¡¹ï¼Œä»…ä»…å±•ç¤ºäº†ä¸€ä¸ªé»˜è®¤çš„é‡‡é›†å™¨ï¼Œå¹¶ä¸”é€šè¿‡æ¥å£è°ƒç”¨éšè—äº†å¤ªå¤šå®æ–½ç»†èŠ‚ 4ã€ç†è§£PrometheusæŒ‡æ ‡ æŒ‡æ ‡ç±»å‹ï¼šPrometheusæ”¯æŒå››ç§ä¸»è¦çš„æŒ‡æ ‡ç±»å‹ï¼š\nCounterï¼ˆç´¯åŠ æŒ‡æ ‡ï¼‰ Gaugeï¼ˆæµ‹é‡æŒ‡æ ‡ï¼‰ Summaryï¼ˆæ¦‚ç•¥å›¾ï¼‰ Histogramï¼ˆç›´æ–¹å›¾ï¼‰ 1. Counterï¼ˆç´¯åŠ æŒ‡æ ‡ï¼‰ ä»€ä¹ˆæ˜¯Counterï¼Ÿ\nCounteræ˜¯ä¸€ç§åªèƒ½å¢åŠ çš„æŒ‡æ ‡ã€‚å®ƒç”¨æ¥è®°å½•ä¸€äº›åªä¼šç´¯åŠ çš„æ•°å€¼ï¼Œä¾‹å¦‚å¤„ç†çš„è¯·æ±‚æ•°é‡ã€å®Œæˆçš„ä»»åŠ¡æ•°é‡ç­‰ã€‚ é€šä¿—è§£é‡Šï¼š\næƒ³è±¡ä¸€ä¸ªåªèƒ½åŠ æ³•ä¸èƒ½å‡æ³•çš„è®¡æ•°å™¨ã€‚æ¯å½“ä½ å®Œæˆä¸€ä¸ªä»»åŠ¡ï¼Œå°±æŒ‰ä¸€æ¬¡åŠ å·ï¼Œè¿™ä¸ªæ•°å­—ä¼šä¸€ç›´å¢åŠ ï¼Œä¸ä¼šå‡å°‘ã€‚ ä¾‹å­ï¼š\nè®°å½•ä¸€ä¸ªç½‘ç«™çš„è®¿é—®æ¬¡æ•°ï¼Œæ¯æ¬¡æœ‰æ–°çš„è®¿é—®æ—¶ï¼Œè®¡æ•°å™¨å¢åŠ 1ã€‚ 2. Gaugeï¼ˆæµ‹é‡æŒ‡æ ‡ï¼‰ ä»€ä¹ˆæ˜¯Gaugeï¼Ÿ\nGaugeæ˜¯ä¸€ç§å¯ä»¥ä»»æ„å¢å‡çš„æŒ‡æ ‡ã€‚å®ƒç”¨æ¥è®°å½•ä¸€äº›ç¬æ—¶çš„æ•°å€¼ï¼Œä¾‹å¦‚å½“å‰çš„æ¸©åº¦ã€CPUä½¿ç”¨ç‡ç­‰ã€‚ é€šä¿—è§£é‡Šï¼š\næƒ³è±¡ä¸€ä¸ªæ¸©åº¦è®¡ï¼Œæ¸©åº¦å¯ä»¥å‡é«˜ä¹Ÿå¯ä»¥é™ä½ã€‚å®ƒåæ˜ çš„æ˜¯å½“å‰çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç´¯ç§¯çš„æ•°å€¼ã€‚ ä¾‹å­ï¼š\nè®°å½•æœåŠ¡å™¨å½“å‰çš„å†…å­˜ä½¿ç”¨é‡ï¼Œè¿™ä¸ªæ•°å€¼ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå¢åŠ æˆ–å‡å°‘ã€‚ 3. Summaryï¼ˆæ¦‚ç•¥å›¾ï¼‰ ä»€ä¹ˆæ˜¯Summaryï¼Ÿ\nSummaryæ˜¯ä¸€ç§ç”¨æ¥è®°å½•ä¸€ç³»åˆ—æ•°å€¼çš„åˆ†å¸ƒæƒ…å†µçš„æŒ‡æ ‡ã€‚å®ƒä¼šç»Ÿè®¡è¿™äº›æ•°å€¼çš„åˆ†ä½æ•°ï¼ˆä¾‹å¦‚ä¸­ä½æ•°ã€90%åˆ†ä½æ•°ç­‰ï¼‰ã€‚ é€šä¿—è§£é‡Šï¼š\næƒ³è±¡ä½ æœ‰ä¸€å †è€ƒè¯•æˆç»©ï¼Œä½ æƒ³çŸ¥é“è¿™äº›æˆç»©çš„ä¸­ä½æ•°æ˜¯å¤šå°‘ï¼Œ90%çš„æˆç»©åœ¨å“ªä¸ªåˆ†æ•°ä»¥ä¸Šã€‚è¿™ç§æŒ‡æ ‡ä¼šå¸®åŠ©ä½ äº†è§£ä¸€ç»„æ•°æ®çš„åˆ†å¸ƒæƒ…å†µã€‚ ä¾‹å­ï¼š\nè®°å½•APIå“åº”æ—¶é—´ï¼Œé€šè¿‡Summaryå¯ä»¥çŸ¥é“å¤§å¤šæ•°è¯·æ±‚çš„å“åº”æ—¶é—´æƒ…å†µï¼Œæ¯”å¦‚ä¸­ä½æ•°å“åº”æ—¶é—´ã€90%è¯·æ±‚çš„å“åº”æ—¶é—´ç­‰ã€‚ 4. Histogramï¼ˆç›´æ–¹å›¾ï¼‰ ä»€ä¹ˆæ˜¯Histogramï¼Ÿ\nHistogramä¹Ÿæ˜¯ä¸€ç§è®°å½•æ•°å€¼åˆ†å¸ƒçš„æŒ‡æ ‡ï¼Œä½†å®ƒä¼šæŠŠæ•°å€¼åˆ’åˆ†åˆ°ä¸åŒçš„åŒºé—´ï¼ˆæ¡¶ï¼‰ä¸­ï¼Œç»Ÿè®¡æ¯ä¸ªåŒºé—´çš„æ•°é‡ã€‚ é€šä¿—è§£é‡Šï¼š\næƒ³è±¡ä½ æœ‰ä¸€å †ä¸åŒé«˜åº¦çš„å­©å­ï¼Œä½ æŠŠä»–ä»¬åˆ†æˆä¸åŒçš„èº«é«˜åŒºé—´ï¼Œæ¯”å¦‚1ç±³åˆ°1ç±³1ï¼Œ1ç±³1åˆ°1ç±³2ç­‰ï¼Œç„¶åç»Ÿè®¡æ¯ä¸ªåŒºé—´æœ‰å¤šå°‘å­©å­ã€‚Histogramä¼šå¸®åŠ©ä½ çŸ¥é“æ•°æ®åœ¨ä¸åŒåŒºé—´çš„åˆ†å¸ƒæƒ…å†µã€‚ ä¾‹å­ï¼š\nè®°å½•APIå“åº”æ—¶é—´ï¼Œé€šè¿‡Histogramå¯ä»¥çŸ¥é“ä¸åŒå“åº”æ—¶é—´èŒƒå›´å†…çš„è¯·æ±‚æ•°é‡ï¼Œæ¯”å¦‚0åˆ°100msæœ‰å¤šå°‘è¯·æ±‚ï¼Œ100åˆ°200msæœ‰å¤šå°‘è¯·æ±‚ç­‰ã€‚ å¯ä»¥ç†è§£ä¸ºæŸ±çŠ¶å›¾ï¼Œå…¸å‹çš„åº”ç”¨å¦‚ï¼šè¯·æ±‚æŒç»­æ—¶é—´ï¼Œå“åº”å¤§å°ã€‚å¯ä»¥å¯¹è§‚å¯Ÿç»“æœé‡‡æ ·ï¼Œåˆ†ç»„åŠç»Ÿè®¡ã€‚ä¾‹å¦‚è®¾ç½®ä¸€ä¸ªnameä¸ºweb_request_duration_secondsçš„Histogram çš„metrics,å¹¶è®¾ç½®åŒºé—´å€¼ä¸º[0.1,0.5,1]ä¼šå¯¹åŒºé—´ç‚¹ç”Ÿæˆä¸€æ¡ç»Ÿè®¡æ•°æ®.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # å“åº”æ—¶é—´å°äº0.1sçš„è¯·æ±‚æœ‰5æ¬¡ web_request_duration_seconds_bucket{endpoint=\u0026#34;/query\u0026#34;,method=\u0026#34;GET\u0026#34;,le=\u0026#34;0.1\u0026#34;} 3 # å“åº”æ—¶é—´å°äº0.5sçš„è¯·æ±‚æœ‰æ¬¡ web_request_duration_seconds_bucket{endpoint=\u0026#34;/query\u0026#34;,method=\u0026#34;GET\u0026#34;,le=\u0026#34;0.5\u0026#34;} 5 # å“åº”æ—¶é—´å°äº1sçš„è¯·æ±‚æœ‰7æ¬¡ web_request_duration_seconds_bucket{endpoint=\u0026#34;/query\u0026#34;,method=\u0026#34;GET\u0026#34;,le=\u0026#34;1\u0026#34;} 7 # æ€»å…±7æ¬¡è¯·æ±‚ web_request_duration_seconds_bucket{endpoint=\u0026#34;/query\u0026#34;,method=\u0026#34;GET\u0026#34;,le=\u0026#34;+Inf\u0026#34;} 7 # 7æ¬¡è¯·æ±‚durationçš„æ€»å’Œ web_request_duration_seconds_sum{endpoint=\u0026#34;/query\u0026#34;,method=\u0026#34;GET\u0026#34;} 2.7190880529999997 5. Summary å’Œ Histogram çš„åŒºåˆ« åœ¨ä½¿ç”¨ Prometheus è¿›è¡Œç›‘æ§æ—¶ï¼ŒSummary å’Œ Histogram éƒ½æ˜¯ç”¨äºæµ‹é‡å’Œåˆ†ææ•°æ®åˆ†å¸ƒçš„å¼ºå¤§å·¥å…·ï¼Œä½†å®ƒä»¬åœ¨ç»†èŠ‚å’Œåº”ç”¨åœºæ™¯ä¸Šæœ‰æ‰€ä¸åŒã€‚ä¸‹é¢å°†ä»ä¸¤è€…çš„å®šä¹‰ã€ä½¿ç”¨åœºæ™¯å’Œç‰¹ç‚¹æ¥è¯¦ç»†é˜è¿°å®ƒä»¬çš„åŒºåˆ«ã€‚\nSummary\nSummary ç”¨äºæä¾›ä¸€ç»„æ•°æ®çš„æ¦‚è¿°ä¿¡æ¯ï¼Œå®ƒèƒ½å¤Ÿè®¡ç®—æ•°æ®çš„åˆ†ä½æ•°ï¼ˆä¾‹å¦‚ä¸­ä½æ•°ã€90%åˆ†ä½æ•°ç­‰ï¼‰ã€‚è¿™ç§æŒ‡æ ‡ç‰¹åˆ«é€‚åˆéœ€è¦äº†è§£æ•´ä½“æ•°æ®åˆ†å¸ƒæƒ…å†µä½†ä¸éœ€è¦ç²¾ç»†åŒºé—´åˆ’åˆ†çš„åœºæ™¯ã€‚\nç‰¹ç‚¹ï¼š\nåˆ†ä½æ•°è®¡ç®—ï¼šå¯ä»¥ç›´æ¥è®¡ç®—å‡ºæŒ‡å®šåˆ†ä½æ•°ï¼Œä¾‹å¦‚ä¸­ä½æ•°ã€90%åˆ†ä½æ•°ç­‰ã€‚ é€‚åˆæ ·æœ¬é‡å¤§æ—¶ï¼šå½“ä½ éœ€è¦äº†è§£å¤§é‡è¯·æ±‚çš„æ•´ä½“å“åº”æ—¶é—´åˆ†å¸ƒæ—¶ï¼ŒSummary æ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ã€‚ æ— éœ€é¢„å®šä¹‰æ¡¶ï¼šSummary é€šè¿‡ç®—æ³•åŠ¨æ€è®¡ç®—åˆ†ä½æ•°ï¼Œè€Œæ— éœ€æå‰åˆ’åˆ†æ•°æ®åŒºé—´ï¼ˆæ¡¶ï¼‰ã€‚ ä½¿ç”¨åœºæ™¯ï¼š\nAPI å“åº”æ—¶é—´åˆ†æï¼šéœ€è¦çŸ¥é“ç»å¤§å¤šæ•°è¯·æ±‚çš„å“åº”æ—¶é—´æƒ…å†µï¼Œä¾‹å¦‚ä¸­ä½æ•°å“åº”æ—¶é—´å’Œ90%çš„è¯·æ±‚å“åº”æ—¶é—´ã€‚ æ•´ä½“æ€§èƒ½è¯„ä¼°ï¼šé€‚åˆè¯„ä¼°ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ï¼Œè€Œä¸éœ€è¦è¯¦ç»†çš„åŒºé—´æ•°æ®ã€‚ Histogram\nHistogram åˆ™æ˜¯å°†æ•°æ®åˆ’åˆ†åˆ°ä¸åŒçš„åŒºé—´ï¼ˆæ¡¶ï¼‰ä¸­ï¼Œç»Ÿè®¡æ¯ä¸ªåŒºé—´çš„æ•°æ®é‡ã€‚å®ƒé€‚åˆéœ€è¦è¯¦ç»†äº†è§£æ•°æ®åœ¨ä¸åŒèŒƒå›´å†…åˆ†å¸ƒæƒ…å†µçš„åœºæ™¯ã€‚\nç‰¹ç‚¹ï¼š\nåŒºé—´åˆ’åˆ†ï¼šå°†æ•°æ®åˆ’åˆ†åˆ°ä¸åŒçš„åŒºé—´ï¼ˆæ¡¶ï¼‰ä¸­ï¼Œæ¯ä¸ªåŒºé—´ç»Ÿè®¡æ•°æ®é‡ã€‚ ç²¾ç»†æ•°æ®åˆ†æï¼šé€‚åˆéœ€è¦è¯¦ç»†äº†è§£æ•°æ®åˆ†å¸ƒæƒ…å†µçš„åœºæ™¯ï¼Œå¯ä»¥æ˜ç¡®çŸ¥é“æ•°æ®åœ¨ä¸åŒåŒºé—´çš„åˆ†å¸ƒã€‚ éœ€è¦é¢„å®šä¹‰æ¡¶ï¼šåœ¨ä½¿ç”¨å‰éœ€è¦å®šä¹‰æ•°æ®çš„åŒºé—´ï¼ˆæ¡¶ï¼‰ï¼Œé€‚åˆäº‹å…ˆå·²çŸ¥æ•°æ®èŒƒå›´çš„æƒ…å†µã€‚ ä½¿ç”¨åœºæ™¯ï¼š\nè¯¦ç»†å“åº”æ—¶é—´åˆ†æï¼šéœ€è¦çŸ¥é“åœ¨ä¸åŒå“åº”æ—¶é—´èŒƒå›´å†…çš„è¯·æ±‚æ•°é‡ï¼Œæ¯”å¦‚0-100msã€100-200msç­‰ã€‚ èµ„æºä½¿ç”¨æƒ…å†µç›‘æ§ï¼šå¯ä»¥ç”¨æ¥ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µçš„åˆ†å¸ƒï¼Œä¾‹å¦‚å†…å­˜ä½¿ç”¨é‡åœ¨ä¸åŒèŒƒå›´å†…çš„åˆ†å¸ƒã€‚ 5ã€å®šä¹‰å’Œæ³¨å†ŒæŒ‡æ ‡ å¼•å…¥ä¾èµ–åº“ï¼šé€šè¿‡go getå‘½ä»¤è·å–prometheusåº“ã€‚\n1 2 3 4 import ( \u0026#34;github.com/prometheus/client_golang/prometheus\u0026#34; \u0026#34;sync/atomic\u0026#34; ) å®šä¹‰æŒ‡æ ‡ï¼šåˆ›å»ºCounterç±»å‹çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚APIè¯·æ±‚æ¬¡æ•°çš„ç›‘æ§\n1 2 3 4 5 6 // APIRequestCounter ç»“æ„ä½“ï¼Œç”¨äºç®¡ç†APIè¯·æ±‚æ¬¡æ•°çš„ç›‘æ§ type APIRequestCounter struct { Zone string APIRequestDesc *prometheus.Desc requestCount uint64 } æ³¨å†ŒæŒ‡æ ‡ï¼šä½¿ç”¨prometheus.MustRegisterå°†æŒ‡æ ‡æ³¨å†Œåˆ°é»˜è®¤çš„Registryä¸­ã€‚\n1 2 3 4 5 6 apiRequestCounter := collector.NewAPIRequestCounter(*metricsNamespace) // åˆ›å»ºä¸€ä¸ªæ–°çš„PrometheusæŒ‡æ ‡æ³¨å†Œè¡¨ registry := prometheus.NewRegistry() // æ³¨å†ŒAPIRequestCounterå®ä¾‹åˆ°Prometheusæ³¨å†Œè¡¨ registry.MustRegister(apiRequestCounter) 6ã€å®ç°è‡ªå®šä¹‰æ•°æ®é‡‡é›† å®ç°Collectoræ¥å£ï¼šåˆ›å»ºè‡ªå®šä¹‰çš„Collectorç»“æ„ä½“æ¥å®ç°æ•°æ®é‡‡é›†ã€‚\n1 2 3 4 5 6 // APIRequestCounter ç»“æ„ä½“ï¼Œç”¨äºç®¡ç†APIè¯·æ±‚æ¬¡æ•°çš„ç›‘æ§ type APIRequestCounter struct { Zone string APIRequestDesc *prometheus.Desc requestCount uint64 } å®šä¹‰æŒ‡æ ‡æè¿°ç¬¦ï¼šä½¿ç”¨prometheus.NewDescåˆ›å»ºæŒ‡æ ‡æè¿°ç¬¦ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 // NewAPIRequestCounter åˆ›å»ºä¸€ä¸ªæ–°çš„APIRequestCounterå®ä¾‹ func NewAPIRequestCounter(zone string) *APIRequestCounter { return \u0026amp;APIRequestCounter{ Zone: zone, APIRequestDesc: prometheus.NewDesc( \u0026#34;api_request_count_total\u0026#34;, \u0026#34;APIè¯·æ±‚æ€»æ¬¡æ•°\u0026#34;, nil, prometheus.Labels{\u0026#34;zone\u0026#34;: zone}, ), } } å®ç°Describeå’ŒCollectæ–¹æ³•ï¼šDescribeæ–¹æ³•å‘é€æŒ‡æ ‡æè¿°ç¬¦åˆ°channelï¼ŒCollectæ–¹æ³•æ‰§è¡Œæ•°æ®é‡‡é›†å¹¶è¿”å›æ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Describe å‘Prometheusæè¿°æ”¶é›†çš„æŒ‡æ ‡ func (c *APIRequestCounter) Describe(ch chan\u0026lt;- *prometheus.Desc) { ch \u0026lt;- c.APIRequestDesc } // Collect æ”¶é›†æŒ‡æ ‡æ•°æ®å¹¶å‘é€åˆ°Prometheus func (c *APIRequestCounter) Collect(ch chan\u0026lt;- prometheus.Metric) { count := atomic.LoadUint64(\u0026amp;c.requestCount) ch \u0026lt;- prometheus.MustNewConstMetric( c.APIRequestDesc, prometheus.CounterValue, float64(count), ) } 7ã€å®ç°æ•°æ®é‡‡é›†é€»è¾‘ è‡ªå®šä¹‰æ•°æ®é‡‡é›†å‡½æ•°ï¼šå®ç°ä¸€ä¸ªå‡½æ•°æ¥æ¨¡æ‹Ÿæˆ–è·å–ç³»ç»ŸçŠ¶æ€æ•°æ®ã€‚\n1 2 3 4 // IncrementRequestCount å¢åŠ APIè¯·æ±‚è®¡æ•° func (c *APIRequestCounter) IncrementRequestCount() { atomic.AddUint64(\u0026amp;c.requestCount, 1) } æ”¶é›†æ•°æ®ï¼šåœ¨Collectæ–¹æ³•ä¸­è°ƒç”¨æ•°æ®é‡‡é›†å‡½æ•°ï¼Œå¹¶ä½¿ç”¨MustNewConstMetricåˆ›å»ºæŒ‡æ ‡æ•°æ®ã€‚\n8ã€é›†æˆå’Œæµ‹è¯• åˆ›å»ºè‡ªå®šä¹‰Collectorå®ä¾‹ï¼šæ ¹æ®éœ€è¦åˆ›å»ºå¤šä¸ªCollectorå®ä¾‹ã€‚ æ³¨å†Œåˆ°Registryï¼šä½¿ç”¨NewPedanticRegistryåˆ›å»ºä¸€ä¸ªæ–°çš„Registryï¼Œå¹¶æ³¨å†Œè‡ªå®šä¹‰Collectorã€‚ è®¾ç½®HTTP Handlerï¼šä½¿ç”¨promhttp.HandlerForåˆ›å»ºä¸€ä¸ªHTTP Handlerï¼Œç”¨äºå¤„ç†/metricsè·¯å¾„çš„è¯·æ±‚å¹¶è¿”å›æŒ‡æ ‡æ•°æ®ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 var ( // Set during go build // version string // gitCommit string // å‘½ä»¤è¡Œå‚æ•° listenAddr = flag.String(\u0026#34;web.listen-port\u0026#34;, \u0026#34;8080\u0026#34;, \u0026#34;An port to listen on for web interface and telemetry.\u0026#34;) metricsPath = flag.String(\u0026#34;web.telemetry-path\u0026#34;, \u0026#34;/metrics\u0026#34;, \u0026#34;A path under which to expose metrics.\u0026#34;) metricsNamespace = flag.String(\u0026#34;metric.namespace\u0026#34;, \u0026#34;app\u0026#34;, \u0026#34;Prometheus metrics namespace, as the prefix of metrics name\u0026#34;) ) func main() { // è§£æå‘½ä»¤è¡Œå‚æ•° flag.Parse() apiRequestCounter := collector.NewAPIRequestCounter(*metricsNamespace) // åˆ›å»ºä¸€ä¸ªæ–°çš„PrometheusæŒ‡æ ‡æ³¨å†Œè¡¨ registry := prometheus.NewRegistry() // æ³¨å†ŒAPIRequestCounterå®ä¾‹åˆ°Prometheusæ³¨å†Œè¡¨ registry.MustRegister(apiRequestCounter) // è®¾ç½®HTTPæœåŠ¡å™¨ä»¥å¤„ç†PrometheusæŒ‡æ ‡çš„HTTPè¯·æ±‚ http.Handle(*metricsPath, promhttp.HandlerFor(registry, promhttp.HandlerOpts{})) // è®¾ç½®æ ¹è·¯å¾„çš„å¤„ç†å‡½æ•°ï¼Œç”¨äºè¿”å›ä¸€ä¸ªç®€å•çš„HTMLé¡µé¢ï¼ŒåŒ…å«æŒ‡å‘æŒ‡æ ‡é¡µé¢çš„é“¾æ¥ http.HandleFunc(\u0026#34;/\u0026#34;, func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(`\u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;A Prometheus Exporter\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;A Prometheus Exporter\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;\u0026lt;a href=\u0026#39;/metrics\u0026#39;\u0026gt;Metrics\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt;`)) }) // æ¨¡æ‹ŸAPIè¯·æ±‚çš„å¤„ç†å‡½æ•° http.HandleFunc(\u0026#34;/api\u0026#34;, func(w http.ResponseWriter, r *http.Request) { apiRequestCounter.IncrementRequestCount() // æ¨¡æ‹ŸAPIå¤„ç†æ—¶é—´ w.Write([]byte(\u0026#34;APIè¯·æ±‚å¤„ç†æˆåŠŸ\u0026#34;)) }) // è®°å½•å¯åŠ¨æ—¥å¿—å¹¶å¯åŠ¨HTTPæœåŠ¡å™¨ç›‘å¬ log.Printf(\u0026#34;Starting Server at http://localhost:%s%s\u0026#34;, *listenAddr, *metricsPath) log.Fatal(http.ListenAndServe(\u0026#34;:\u0026#34;+*listenAddr, nil)) } 9ã€å¯åŠ¨æœåŠ¡å¹¶æµ‹è¯• è¯·ä¸‹è½½ï¼šhttps://github.com/nangongchengfeng/Prometheus-Go-Template.git å¯åŠ¨æµ‹è¯•\nå¯åŠ¨HTTPæœåŠ¡ï¼šå¯åŠ¨æœåŠ¡å¹¶ç›‘å¬8080ç«¯å£ã€‚ è®¿é—®æŒ‡æ ‡æ•°æ®ï¼šé€šè¿‡æµè§ˆå™¨è®¿é—®http://localhost:8080/metricsæŸ¥çœ‹æŒ‡æ ‡æ•°æ®ã€‚ 1 2 3 æµ‹è¯•æ¥å£ http://localhost:8080/api http://localhost:8080/query 10ã€åŸç† 1ã€Prometheus ç›‘æ§æ€»ç»“ åœ¨ä½¿ç”¨ Prometheus è¿›è¡Œç›‘æ§æ—¶ï¼Œç†è§£æŒ‡æ ‡çš„é‡‡é›†æ–¹å¼å’Œä¸åŒæŒ‡æ ‡ç±»å‹çš„åº”ç”¨åœºæ™¯è‡³å…³é‡è¦ã€‚ä»¥ä¸‹æ˜¯å¯¹ç›¸å…³æ¦‚å¿µçš„æ€»ç»“ï¼š\næŒ‡æ ‡é‡‡é›†ï¼š Exporter å®šæœŸé‡‡é›†æŒ‡æ ‡æ•°æ®ï¼Œå¹¶é€šè¿‡ HTTP æ¥å£æš´éœ²ã€‚è¿™äº›æ•°æ®å¯ä»¥ç”± Prometheus æœåŠ¡è¿›è¡ŒæŠ“å–å’Œå­˜å‚¨ï¼Œä¾¿äºåç»­çš„åˆ†æå’Œå±•ç¤ºã€‚\næŒ‡æ ‡ç±»å‹ï¼š\nCounterï¼šé€‚ç”¨äºæŒç»­å¢é•¿çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚è¯·æ±‚è®¡æ•°ã€ä»»åŠ¡å®Œæˆæ¬¡æ•°ç­‰ã€‚å®ƒåªä¼šé€’å¢ï¼Œä¸ä¼šå‡å°‘ã€‚ Gaugeï¼šé€‚ç”¨äºå¯èƒ½å¢å‡çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚å½“å‰å†…å­˜ä½¿ç”¨é‡ã€CPU ä½¿ç”¨ç‡ç­‰ã€‚å®ƒæ—¢å¯ä»¥é€’å¢ï¼Œä¹Ÿå¯ä»¥é€’å‡ã€‚ Histogramï¼šé€‚ç”¨äºéœ€è¦èšåˆå’Œç»Ÿè®¡æ•°æ®åˆ†å¸ƒçš„åœºæ™¯ï¼Œä¾‹å¦‚è¯·æ±‚å“åº”æ—¶é—´åˆ†å¸ƒã€‚å®ƒå°†æ•°æ®åˆ’åˆ†åˆ°ä¸åŒçš„åŒºé—´ï¼ˆæ¡¶ï¼‰ä¸­ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªåŒºé—´çš„æ•°æ®é‡ã€‚ Summaryï¼šåŒæ ·é€‚ç”¨äºéœ€è¦èšåˆå’Œç»Ÿè®¡åˆ†å¸ƒçš„åœºæ™¯ï¼Œä½†å®ƒé€šè¿‡è®¡ç®—åˆ†ä½æ•°æ¥æè¿°æ•°æ®åˆ†å¸ƒæƒ…å†µï¼Œä¾‹å¦‚ä¸­ä½æ•°ã€90% åˆ†ä½æ•°ç­‰ã€‚ æ•°æ®èšåˆï¼š Histogram å’Œ Summary è¿™ä¸¤ç§ç±»å‹çš„æŒ‡æ ‡ä¸“æ³¨äºæ•°æ®çš„èšåˆå’Œç»Ÿè®¡åˆ†å¸ƒã€‚å®ƒä»¬èƒ½å¤Ÿæä¾›å…³äºæ•°æ®åˆ†å¸ƒçš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾¿äºæ·±å…¥åˆ†æç³»ç»Ÿæ€§èƒ½å’Œè¡Œä¸ºã€‚\nè‡ªå®šä¹‰ Collectorï¼š å¼€å‘è€…å¯ä»¥é€šè¿‡å®ç° Collector æ¥å£æ¥è‡ªå®šä¹‰æ•°æ®é‡‡é›†é€»è¾‘ï¼Œä»¥æ»¡è¶³ç‰¹å®šçš„ç›‘æ§éœ€æ±‚ã€‚è‡ªå®šä¹‰ Collector éœ€è¦å®ç° describe å’Œ collect ä¸¤ä¸ªæ–¹æ³•ï¼Œä»¥ä¾¿å°†è‡ªå®šä¹‰é€»è¾‘é›†æˆåˆ° Prometheus çš„æ•°æ®é‡‡é›†æµç¨‹ä¸­ã€‚\n2ã€Golang ä¸­çš„ç›‘æ§å™¨é€»è¾‘è§£æ åœ¨ Golang ä¸­ä½¿ç”¨ Prometheus è¿›è¡Œç›‘æ§æ—¶ï¼Œäº†è§£ç›‘æ§å™¨çš„é€»è¾‘å’Œå·¥ä½œåŸç†è‡³å…³é‡è¦ã€‚ä¸‹é¢å°†ç®€è¦æ€»ç»“ä¸€ä¸‹ç›‘æ§å™¨çš„åŸºæœ¬é€»è¾‘ï¼š\nç›‘æ§å™¨åˆå§‹åŒ–ï¼š é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å¼•å…¥ registry åŒ…æ—¶ï¼Œä¼šè§¦å‘å¯¹ gocollect è¿™ä¸ªé‡‡é›†å™¨çš„åˆå§‹åŒ–ï¼Œè¿™æ˜¯å› ä¸º registry åœ¨åˆå§‹åŒ–æ—¶ä¼šè°ƒç”¨ describe æ¥å£ï¼Œè€Œ gocollect æ­£æ˜¯å®ç°äº†è¿™ä¸ªæ¥å£ã€‚\næ•°æ®é‡‡é›†æµç¨‹ï¼š å½“æœ‰ HTTP è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œhttp.handle ä¼šè°ƒç”¨ registry çš„ gather å‡½æ•°ã€‚åœ¨ gather å‡½æ•°å†…éƒ¨ï¼Œä¼šè°ƒç”¨å…·ä½“é‡‡é›†å™¨çš„ collect æ¥å£ï¼Œè¿™ä¸ªå®ç°å°±æ˜¯ gocollect ä¸­çš„ collect å‡½æ•°ã€‚è¿™ä¸€æµç¨‹ç¡®ä¿äº†æ•°æ®çš„é‡‡é›†å’Œå¤„ç†ã€‚\nå¤šç±»å‹å¤„ç†ï¼š ä¸Šè¿°æµç¨‹ä»…æ˜¯ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå®é™…ä¸Šï¼Œå¯¹äºå››ç§ä¸åŒç±»å‹çš„ç›‘æ§å™¨ï¼ˆCounterã€Gaugeã€Histogram å’Œ Summaryï¼‰ï¼Œéƒ½æœ‰å¯¹åº”çš„ç»“æ„ä½“ç»§æ‰¿äº†åŸºæœ¬å‡½æ•°æ¥å£ï¼Œå¹¶å®ç°äº†ç›¸åº”çš„æ¥å£ã€‚æ¯ç§ç›‘æ§å™¨éƒ½æœ‰è‡ªå·±ç‹¬ç‰¹çš„é€»è¾‘å’Œå®ç°æ–¹å¼ï¼Œä½†æ•´ä½“æµç¨‹å¤§è‡´ç›¸åŒã€‚\nè‡ªå®šä¹‰ç›‘æ§å™¨ï¼š å¦‚æœéœ€è¦å®ç°è‡ªå®šä¹‰çš„ç›‘æ§å™¨é€»è¾‘ï¼Œå¯ä»¥æ–°å»ºä¸€ä¸ªç»“æ„ä½“ä½œä¸ºç›‘æ§å™¨ï¼Œå®ç° describe å’Œ collect æ¥å£ã€‚è¿™æ ·ï¼Œå°±å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å®ç°ç‰¹å®šçš„ç›‘æ§é€»è¾‘ã€‚æœ€ç»ˆï¼Œè¿™äº›è‡ªå®šä¹‰ç›‘æ§å™¨çš„å®ç°åŸç†ä¹Ÿæ˜¯è°ƒç”¨äº†å››ç§ä¸åŒç±»å‹ç›‘æ§å™¨çš„ç›¸å…³å‡½æ•°ï¼Œä»¥å®ç°æ•°æ®çš„é‡‡é›†å’Œå¤„ç†ã€‚\nå‚è€ƒé¡¹ç›®å’Œæ–‡æ¡£ï¼š\nhttps://github.com/crockitwood/go-prometheus-example.git\nPrometheuså››ç§æŒ‡æ ‡è¯¦ç»†è§£é‡Š\nhttps://kingjcy.github.io/post/monitor/metrics/prometheus/library/client_golang/\n","date":"2024-05-29T18:10:56Z","image":"https://www.ownit.top/title_pic/57.jpg","permalink":"https://www.ownit.top/p/202405291810/","title":"Goå¼€å‘Prometheuså®¢æˆ·ç«¯å®æˆ˜æ­¥éª¤"},{"content":"1ã€å¼•è¨€ éšç€åº”ç”¨ç¨‹åºå’Œä¸šåŠ¡æ•°æ®çš„æŒç»­å¢é•¿ï¼Œæœ‰æ•ˆåœ°ç®¡ç†æ•°æ®åº“å­˜å‚¨ç©ºé—´æˆä¸ºç»´æŠ¤ç³»ç»Ÿæ€§èƒ½çš„å…³é”®ã€‚åœ¨MongoDBè¿™ç±»NoSQLæ•°æ®åº“ä¸­ï¼Œå®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®å˜å¾—å°¤ä¸ºé‡è¦ï¼Œè¿™ä¸ä»…èƒ½é‡Šæ”¾å®è´µçš„å­˜å‚¨èµ„æºï¼Œè¿˜èƒ½ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼Œç¡®ä¿æ•°æ®åº“è¿è¡Œçš„é«˜æ•ˆä¸ç¨³å®šã€‚ æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ä¸€ç§è‡ªåŠ¨åŒ–æ¸…ç†MongoDBä¸­è¿‡æœŸæ•°æ®çš„ç­–ç•¥ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®é™…çš„Pythonè„šæœ¬ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•å®ç°è¿™ä¸€åŠŸèƒ½ã€‚\n2ã€éœ€æ±‚èƒŒæ™¯ æ ¹æ®å…¬å¸ä¸šåŠ¡å‘å±•ç§¯ç´¯ï¼Œåœ¨ä¼—å¤šåº”ç”¨åœºæ™¯ä¸­ï¼Œå¦‚æ—¥å¿—è®°å½•ã€ä¸´æ—¶ç¼“å­˜ã€ä¼šè¯ç®¡ç†ç­‰ï¼Œæ•°æ®å¾€å¾€å…·æœ‰æ—¶æ•ˆæ€§ï¼Œè¶…è¿‡ä¸€å®šæ—¶é—´åä¾¿ä¸å†æœ‰ç”¨ã€‚å¦‚æœä¸åŠæ—¶æ¸…ç†ï¼Œè¿™äº›è¿‡æœŸæ•°æ®ä¼šå ç”¨å¤§é‡å­˜å‚¨ç©ºé—´ï¼Œå¢åŠ æ•°æ®åº“ç»´æŠ¤æˆæœ¬ï¼Œç”šè‡³å½±å“æŸ¥è¯¢æ•ˆç‡ã€‚ ç›®å‰æˆ‘ä»¬çš„ MongoDBæ•°æ®åº“å•è¡¨è¾¾åˆ°70Gï¼Œå†—ä½™æ•°æ®ç§¯ç´¯ã€‚å¯¼è‡´ç©ºé—´å ç”¨æå¤§ã€‚ä¸ºäº†å®ç°â€œé™æœ¬å¢æ•ˆâ€ æ¸…ç†è¿‡æœŸçš„æ•°æ® ï¼ˆåˆ‡å¿Œï¼šè¿‡æœŸæ•°æ®ä¹Ÿéœ€è¦ä½¿ç”¨mongodumpå¤‡ä»½ï¼‰å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè‡ªåŠ¨åŒ–æœºåˆ¶ï¼Œèƒ½å¤Ÿæ ¹æ®æ•°æ®çš„â€œæœ€åä¿®æ”¹æ—¥æœŸâ€ç­‰æ—¶é—´æˆ³å­—æ®µï¼Œè¯†åˆ«å¹¶åˆ é™¤è¿‡æœŸè®°å½•ã€‚\n3ã€åŠŸèƒ½æ¦‚è¿° æœ¬æ–¹æ¡ˆè®¾è®¡äº†ä¸€ä¸ªPythonè„šæœ¬ï¼Œé›†æˆäº†ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š\né…ç½®æ–‡ä»¶è¯»å–ï¼šå…è®¸ç”¨æˆ·çµæ´»é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€ç›®æ ‡é›†åˆåã€æ•°æ®è¿‡æœŸå¤©æ•°ä»¥åŠæ‰¹å¤„ç†å¤§å°ç­‰å‚æ•°ã€‚ åŠ¨æ€æ—¶é—´é˜ˆå€¼è®¡ç®—ï¼šæ ¹æ®ç”¨æˆ·è®¾å®šçš„è¿‡æœŸå¤©æ•°ï¼Œè®¡ç®—å‡ºéœ€åˆ é™¤æ•°æ®çš„æˆªæ­¢æ—¶é—´æˆ³ã€‚ åˆ†æ‰¹åˆ é™¤æœºåˆ¶ï¼šä¸ºäº†å‡å°‘å¯¹æ•°æ®åº“çš„å†²å‡»ï¼Œè„šæœ¬é‡‡ç”¨åˆ†æ‰¹åˆ é™¤ç­–ç•¥ï¼Œæ¯æ¬¡åªå¤„ç†ä¸€æ‰¹æ•°æ®ï¼Œç›´è‡³æ‰€æœ‰è¿‡æœŸæ•°æ®è¢«æ¸…ç†å®Œæ¯•ã€‚ è¿›åº¦å¯è§†åŒ–ï¼šé›†æˆtqdmåº“ï¼Œå®æ—¶æ˜¾ç¤ºåˆ é™¤è¿›åº¦ï¼Œä½¿æ“ä½œè¿‡ç¨‹é€æ˜ä¸”ç›´è§‚ã€‚ é”™è¯¯å¤„ç†ï¼šåŒ…å«äº†å¯¹é…ç½®åŠ è½½ã€æ•°æ®åº“è¿æ¥ã€æ•°æ®æ“ä½œç­‰ç¯èŠ‚çš„å¼‚å¸¸å¤„ç†ï¼Œç¡®ä¿è„šæœ¬çš„å¥å£®æ€§ã€‚ 4ã€å®ç°æ­¥éª¤ 1ã€æ•°æ®åº“è¡¨ç»“æ„åˆ†æ å‡å¦‚æˆ‘ä»¬æœ‰ä¸ªï¼štag_logs çš„é›†åˆ æ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 db.getCollection(\u0026#34;tag_logs\u0026#34;).insert( { _id: ObjectId(\u0026#34;65dd5f067db3e415f0d3972f\u0026#34;), taskId: \u0026#34;65dd5efd7db3e415f0d39630\u0026#34;, modelId: \u0026#34;6285a9890d45000030004392\u0026#34;, name: \u0026#34;nihaogengx\u0026#34;, ruleResult: \u0026#34;NOT_HIT\u0026#34;, logic: \u0026#34;AND\u0026#34;, conditionResults: [ { name: \u0026#34;nihaogengx\u0026#34;, result: \u0026#34;NOT_HIT\u0026#34;, logic: \u0026#34;AND\u0026#34;, subRuleResults: [ { name: \u0026#34;nihaogengx\u0026#34;, result: \u0026#34;NOT_HIT\u0026#34;, variableCode: \u0026#34;var-instant-core-xxxxxx\u0026#34; } ] } ], type: \u0026#34;AUDIT_TAG\u0026#34;, createdDate: NumberLong(\u0026#34;1709006598851\u0026#34;), lastModifiedDate: NumberLong(\u0026#34;1709006598851\u0026#34;), _class: \u0026#34;com.fujfu.shinji.entity.TagResultDO\u0026#34; } ); ç´¢å¼•æŸ¥è¯¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 db.createCollection(\u0026#34;tag_logs\u0026#34;); db.getCollection(\u0026#34;tag_logs\u0026#34;).createIndex({ taskId: NumberInt(\u0026#34;1\u0026#34;) }, { name: \u0026#34;idx_tagResult_taskId\u0026#34; }); db.getCollection(\u0026#34;tag_logs\u0026#34;).createIndex({ createdDate: NumberInt(\u0026#34;1\u0026#34;) }, { name: \u0026#34;createdDate_1\u0026#34;, background: true }); db.getCollection(\u0026#34;tag_logs\u0026#34;).createIndex({ lastModifiedDate: NumberInt(\u0026#34;-1\u0026#34;) }, { name: \u0026#34;lastModifiedDate_-1\u0026#34;, background: true }); 2ã€å¢åŠ ç´¢å¼• æˆ‘ä»¬æ˜¯æ ¹æ® lastModifiedDate æ¥è·å–è¿‡æœŸçš„æ—¶é—´ï¼Œæ‰€ä»¥è¿™ä¸ªå¿…é€‰åŠ ç´¢å¼•ã€‚å¦‚æœæ²¡æœ‰ç´¢å¼•ï¼Œæ ¹æ®ä¸‹æ–¹æ·»åŠ \n1 db.tag_logs.createIndex( { lastModifiedDate: -1 }, { background: true } ) è¿™ä¸ªå‘½ä»¤çš„ä½œç”¨æ˜¯åœ¨ tag_logs é›†åˆä¸Šåˆ›å»ºä¸€ä¸ªç´¢å¼•ã€‚å…·ä½“æ¥è¯´ï¼š\ndb.tag_logs.createIndexï¼šè¿™æ˜¯åœ¨ tag_logs é›†åˆä¸Šåˆ›å»ºç´¢å¼•çš„æ–¹æ³•ã€‚ { lastModifiedDate: -1 }ï¼šè¿™æ˜¯ç´¢å¼•çš„é”®å’Œæ’åºé¡ºåºã€‚å…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š lastModifiedDate æ˜¯ä½ å¸Œæœ›åˆ›å»ºç´¢å¼•çš„å­—æ®µåã€‚ -1 è¡¨ç¤ºä½ å¸Œæœ›æŒ‰ç…§è¯¥å­—æ®µçš„é™åºæ’åºæ¥åˆ›å»ºç´¢å¼•ã€‚å¦‚æœä½ ç”¨çš„æ˜¯ 1ï¼Œåˆ™è¡¨ç¤ºæŒ‰ç…§å‡åºæ’åºã€‚ { background: true }ï¼šè¿™æ˜¯ç´¢å¼•åˆ›å»ºçš„é€‰é¡¹ã€‚å…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š background: true è¡¨ç¤ºåœ¨åå°åˆ›å»ºç´¢å¼•ã€‚è¿™æ„å‘³ç€ç´¢å¼•åˆ›å»ºæ“ä½œä¸ä¼šé˜»å¡å…¶ä»–æ•°æ®åº“æ“ä½œï¼Œå…è®¸å…¶ä»–è¯»å†™æ“ä½œç»§ç»­è¿›è¡Œã€‚è¿™å¯¹äºç”Ÿäº§ç¯å¢ƒä¸­çš„å¤§å‹é›†åˆéå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå¯ä»¥å‡å°‘å¯¹åº”ç”¨ç¨‹åºæ­£å¸¸æ“ä½œçš„å¹²æ‰°ã€‚ 3ã€è„šæœ¬æ ¸å¿ƒé€»è¾‘ config.ini\n1 2 3 4 5 6 [database] uri = mongodb://root:xxxx.88@mongo2.fat.xxxx.fjf:27017/?authSource=admin #Mongoè¿æ¥å­—ç¬¦ä¸² db_name = xxx-xxx-engine # æ•°æ®åº“åç§° collection_name = variable_result_1 # é›†åˆåç§° expired_days = 90 # åˆ é™¤è¿‡æœŸå¤šå°‘å¤©çš„ã€‚ åˆ é™¤3ä¸ªæœˆä¹‹å‰çš„æ•°æ® batch_size=1000 #æ¯æ¬¡åˆ é™¤çš„æ¡æ•° clean_expired_data.py\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 import configparser from pymongo import MongoClient, errors from datetime import datetime, timedelta from tqdm import tqdm def load_config(file_path=\u0026#39;config.ini\u0026#39;): \u0026#34;\u0026#34;\u0026#34;Load configuration from the specified file.\u0026#34;\u0026#34;\u0026#34; config = configparser.ConfigParser() config.read(file_path) return config def get_mongo_client(uri): \u0026#34;\u0026#34;\u0026#34;Create and return a MongoDB client.\u0026#34;\u0026#34;\u0026#34; return MongoClient(uri) def get_cutoff_timestamp(days): \u0026#34;\u0026#34;\u0026#34;Calculate and return the cutoff timestamp.\u0026#34;\u0026#34;\u0026#34; cutoff_date = datetime.now() - timedelta(days=days) return int(cutoff_date.timestamp() * 1000) def delete_expired_documents(collection, cutoff_timestamp, batch_size): \u0026#34;\u0026#34;\u0026#34;Delete documents older than the cutoff timestamp in batches.\u0026#34;\u0026#34;\u0026#34; total_deleted = 0 all_documents = collection.count_documents({}) # 1. æŸ¥è¯¢å‡ºéœ€è¦åˆ é™¤çš„é›†åˆæ•°é‡ total_to_delete = collection.count_documents({\u0026#39;lastModifiedDate\u0026#39;: {\u0026#39;$lt\u0026#39;: cutoff_timestamp}}) print(f\u0026#34;é›†åˆæ€»æ•°: {all_documents}, éœ€è¦åˆ é™¤çš„æ–‡æ¡£æ•°é‡: {total_to_delete}\u0026#34;) # 2. ä½¿ç”¨ tqdm æ˜¾ç¤ºè¿›åº¦æ¡ with tqdm(total=total_to_delete, desc=\u0026#39;Deleting documents\u0026#39;, unit=\u0026#39;doc\u0026#39;) as pbar: while True: documents = collection.find( {\u0026#39;lastModifiedDate\u0026#39;: {\u0026#39;$lt\u0026#39;: cutoff_timestamp}}, limit=batch_size ) document_ids = [doc[\u0026#39;_id\u0026#39;] for doc in documents] if not document_ids: break result = collection.delete_many({\u0026#39;_id\u0026#39;: {\u0026#39;$in\u0026#39;: document_ids}}) deleted_count = result.deleted_count total_deleted += deleted_count # print(f\u0026#39;Deleted {deleted_count} documents\u0026#39;) # 3. æ›´æ–°è¿›åº¦æ¡ pbar.update(deleted_count) if deleted_count \u0026lt; batch_size: break return total_deleted def clean_mongo_expired_data(): \u0026#34;\u0026#34;\u0026#34;Main function to clean expired data from MongoDB.\u0026#34;\u0026#34;\u0026#34; config = load_config() try: uri = config[\u0026#39;database\u0026#39;][\u0026#39;uri\u0026#39;] db_name = config[\u0026#39;database\u0026#39;][\u0026#39;db_name\u0026#39;] collection_name = config[\u0026#39;database\u0026#39;][\u0026#39;collection_name\u0026#39;] expired_days = int(config[\u0026#39;database\u0026#39;][\u0026#39;expired_days\u0026#39;]) batch_size = int(config[\u0026#39;database\u0026#39;][\u0026#39;batch_size\u0026#39;]) client = get_mongo_client(uri) db = client[db_name] collection = db[collection_name] cutoff_timestamp = get_cutoff_timestamp(expired_days) total_deleted = delete_expired_documents(collection, cutoff_timestamp, batch_size) print(\u0026#39;Completed deletion\u0026#39;) print(f\u0026#39;Deleted {total_deleted} documents\u0026#39;) except (configparser.Error, ValueError, errors.PyMongoError) as e: print(f\u0026#39;Error occurred: {e}\u0026#39;) if __name__ == \u0026#39;__main__\u0026#39;: clean_mongo_expired_data() requirements.txt python ç¯å¢ƒç‰ˆæœ¬ï¼šPython 3.8.10\n1 2 pymongo==4.3.3 tqdm==4.66.4 5ã€å®æˆ˜æµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 python3 -m venv py3 #åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ source env_py/py3/bin/activate #åŠ è½½ç¯å¢ƒ pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple # å®‰è£…ä¾èµ– æ›´æ”¹config.ini å¯åŠ¨ç¨‹åº nohup python clean_expired_data.py \u0026amp; (py3) [root@jenkins mongodb_clean]# tail -f nohup.out é›†åˆæ€»æ•°: 410565470, éœ€è¦åˆ é™¤çš„æ–‡æ¡£æ•°é‡: 404724244 Deleting documents: 13%|â–ˆâ– | 53910000/404724244 [1:17:54\u0026lt;8:13:39, 11844.06doc/s] 6ã€æ€§èƒ½åˆ†æ åœ¨æ•°æ®åº“ç»´æŠ¤æ“ä½œä¸­ï¼Œå°¤å…¶æ˜¯æ¶‰åŠå¤§é‡æ•°æ®åˆ é™¤çš„åœºæ™¯ï¼Œé‡‡å–æ‰¹é‡åˆ é™¤ç­–ç•¥æ˜¯å‡ºäºå¯¹ç³»ç»Ÿæ€§èƒ½å’Œç¨³å®šæ€§çš„å…³é”®è€ƒé‡ã€‚ç›´æ¥é’ˆå¯¹å¤§é‡æ•°æ®æ‰§è¡Œä¸€æ¬¡æ€§åˆ é™¤æ“ä½œå¯èƒ½ä¼šå¼•å‘ä»¥ä¸‹å‡ ä¸ªæ½œåœ¨é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å¯¹äºç”Ÿäº§ç¯å¢ƒä¸­çš„MongoDBæ•°æ®åº“å°¤ä¸ºæ•æ„Ÿï¼š\nIOPSï¼ˆæ¯ç§’è¾“å…¥/è¾“å‡ºæ“ä½œï¼‰æ¿€å¢ å¤§è§„æ¨¡æ•°æ®åˆ é™¤ä¼šå¯¼è‡´ç£ç›˜I/Oæ“ä½œæ˜¾è‘—å¢åŠ ï¼Œç¬é—´çš„é«˜IOPSéœ€æ±‚å¯èƒ½è¿…é€Ÿæ¶ˆè€—æ•°æ®åº“çš„I/Oèµ„æºã€‚è¿™ä¸ä»…ä¼šå‡æ…¢å½“å‰æ“ä½œçš„é€Ÿåº¦ï¼Œè¿˜å¯èƒ½å½±å“åˆ°å…¶ä»–æ­£åœ¨æ‰§è¡Œçš„é‡è¦æ•°æ®åº“æ“ä½œï¼Œå¦‚å…³é”®æŸ¥è¯¢å’Œäº‹åŠ¡å¤„ç†ã€‚ é”ç«äº‰ä¸é˜»å¡ è™½ç„¶MongoDBé‡‡ç”¨äº†æ›´ç»†ç²’åº¦çš„é”æœºåˆ¶ï¼Œä½†åœ¨æç«¯æƒ…å†µä¸‹ï¼Œå¤§é‡å†™æ“ä½œä»å¯èƒ½å¼•å‘é”äº‰ç”¨ï¼Œå¯¼è‡´å…¶ä»–è¯»å†™æ“ä½œè¢«é˜»å¡ã€‚è¿™ä¼šç›´æ¥å½±å“ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ã€‚ èµ„æºæ¶ˆè€— å¤§é‡æ•°æ®çš„è¿ç»­åˆ é™¤æ“ä½œä¼šæ¶ˆè€—å¤§é‡çš„CPUå’Œå†…å­˜èµ„æºã€‚åœ¨èµ„æºæœ‰é™çš„ç³»ç»Ÿä¸­ï¼Œè¿™å¯èƒ½å¯¼è‡´ç³»ç»Ÿå“åº”å˜æ…¢ï¼Œç”šè‡³å‡ºç°çŸ­æš‚çš„æœåŠ¡ä¸å¯ç”¨çŠ¶æ€ã€‚ æ—¥å¿—è†¨èƒ€ æ•°æ®åº“çš„æ¯ä¸€æ¬¡å†™æ“ä½œï¼ŒåŒ…æ‹¬åˆ é™¤ï¼Œéƒ½ä¼šè¢«è®°å½•åˆ°äº‹åŠ¡æ—¥å¿—ä¸­ã€‚å¤§é‡åˆ é™¤æ“ä½œä¼šå¯¼è‡´æ—¥å¿—æ–‡ä»¶è¿…é€Ÿå¢å¤§ï¼Œä¸ä»…å ç”¨å­˜å‚¨ç©ºé—´ï¼Œè¿˜ä¼šå¢åŠ æ—¥å¿—å›æ”¾å’Œæ¢å¤çš„æ—¶é—´ã€‚ é‡‡ç”¨ä¸Šè¿°æ–¹å¼å¯ä»¥ç®€å•æœ‰æ•ˆè§£å†³\nç›®å‰æˆ‘åˆ é™¤ 404724244ï¼ˆ4äº¿æ¡æ•°æ®ï¼‰ï¼Œè‡ªåŠ¨æ¯æ¬¡åˆ é™¤1wæ¡ï¼ŒæŒç»­åˆ  ï¼ˆä¸å½±å“ä¸šåŠ¡è¿è¡Œï¼‰ 7äº¿æ¡æ•°æ® ","date":"2024-05-27T16:05:30Z","image":"https://www.ownit.top/title_pic/74.jpg","permalink":"https://www.ownit.top/p/202405271605/","title":"MongoDBæ•°æ®åº“ï¼ˆ10äº¿æ¡æ•°æ®ï¼‰æ¸…ç†ç­–ç•¥- è‡ªåŠ¨åŒ–è¿‡æœŸæ•°æ®åˆ é™¤å®æˆ˜"},{"content":"1ã€ç®€ä»‹ åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œå°¤å…¶æ˜¯æ¶‰åŠåˆ°æ•°æ®é©±åŠ¨çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒä¸­æ•°æ®åº“çš„ç®¡ç†æ˜¯è‡³å…³é‡è¦çš„ä¸€ç¯ã€‚ä¸ºäº†ç¡®ä¿å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒä¸­çš„æ•°æ®åº“å§‹ç»ˆå¤„äºä¸€è‡´çš„çŠ¶æ€ï¼Œè‡ªåŠ¨åŒ–é‡ç½®æ•°æ®åº“æˆä¸ºäº†ä¸€ç§å¸¸è§çš„å®è·µã€‚æœ¬æ–‡æ—¨åœ¨ä»‹ç»å¦‚ä½•é€šè¿‡Shellè„šæœ¬æ¥è‡ªåŠ¨åŒ–é‡ç½®MySQLæ•°æ®åº“ï¼Œä»¥ä¾¿å¼€å‘å›¢é˜Ÿèƒ½å¤Ÿè½»æ¾åœ°åœ¨æ¯æ¬¡æµ‹è¯•æˆ–å¼€å‘æ–°åŠŸèƒ½å‰å°†æ•°æ®åº“æ¢å¤åˆ°ä¸€ä¸ªå·²çŸ¥çš„åˆå§‹çŠ¶æ€ã€‚\n2ã€æŠ€æœ¯æ”¯æ’‘ Shellè„šæœ¬åŸºç¡€ï¼šç†Ÿæ‚‰åŸºæœ¬çš„Shellå‘½ä»¤å’Œè„šæœ¬ç¼–å†™æŠ€å·§ã€‚ MySQLæ“ä½œï¼šäº†è§£å¦‚ä½•é€šè¿‡å‘½ä»¤è¡Œä¸MySQLæ•°æ®åº“è¿›è¡Œäº¤äº’ï¼ŒåŒ…æ‹¬å¤‡ä»½ã€æ¢å¤å’Œæ‰§è¡ŒSQLè„šæœ¬ã€‚ å®‰å…¨æ€§è€ƒè™‘ï¼šç¡®ä¿æ•°æ®åº“æ“ä½œçš„å®‰å…¨æ€§ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠåˆ°æ•°æ®åº“å¯†ç å’Œæ•æ„Ÿæ•°æ®æ—¶ã€‚ è‡ªåŠ¨åŒ–å®è·µï¼šé€šè¿‡è®¡åˆ’ä»»åŠ¡ï¼ˆå¦‚cron jobsï¼‰å®ç°è‡ªåŠ¨åŒ–çš„æ•°æ®åº“é‡ç½®ã€‚ 3ã€æ•°æ®åº“è§„åˆ™çº¦æŸ 1ã€æ–°å»ºGitlabçš„ä»“åº“ 2ã€æ ¹æ®æ•°æ®åº“åç§°ä½œä¸ºç›®å½•ï¼Œåœ°ä¸‹æœ‰3ï¼ˆschemaï¼Œinitã€appendï¼‰ç›®å½• 4ã€è‡ªåŠ¨åŒ–è„šæœ¬å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 #!/bin/bash # å®šä¹‰ä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨é€‰é¡¹ï¼Œè¿™äº›é€‰é¡¹å°†ç”± `ls fat-db` å‘½ä»¤çš„è¾“å‡ºå¡«å……ã€‚ options=() read -ra options \u0026lt;\u0026lt;\u0026lt; $(ls fat-db) # å®šä¹‰é¢œè‰²ä»£ç ï¼Œç”¨äºåœ¨ç»ˆç«¯ä¸­è¾“å‡ºä¸åŒé¢œè‰²çš„æ–‡æœ¬ã€‚ INFO=\u0026#39;\\033[0;32m\u0026#39; EINFO=\u0026#39;\\033[0m\u0026#39; # å¦‚æœ `fat-db` ç›®å½•å­˜åœ¨ï¼Œåˆ™åˆ é™¤å®ƒã€‚ if [ -d fat-db ]; then rm -rf fat-db ;fi # å…‹éš† git ä»“åº“åˆ°å½“å‰ç›®å½•ã€‚ git clone https://xxxx.xxxx.com/group/fat-db.git \u0026gt;\u0026gt; /dev/null 2\u0026gt;\u0026amp;1 # å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ‰§è¡Œ SQL è„šæœ¬ã€‚ function exec_sql(){ # è®¾ç½®æ•°æ®åº“æœåŠ¡å™¨çš„ä¸»æœºåœ°å€ã€‚ host=\u0026#34;127.0.0.1\u0026#34; # ä¸º MySQL å®¢æˆ·ç«¯è®¾ç½®ç¯å¢ƒå˜é‡å¯†ç ã€‚ export MYSQL_PWD=\u0026#34;xxxx.88\u0026#34; # è¿æ¥åˆ°æ•°æ®åº“ï¼Œå¹¶æ˜¾ç¤ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨ã€‚ # ç„¶ååˆ é™¤è¿™äº›è¡¨ã€‚ read -ra list \u0026lt;\u0026lt;\u0026lt; `mysql -u root -h $host -e \u0026#34;use $1;show tables;\u0026#34;` tb_list=`echo ${list[@]:1} | sed \u0026#39;s/ /,/g\u0026#39;` echo -e \u0026#34;${INFO}å¼€å§‹åˆ é™¤${1}æ‰€æœ‰è¡¨ ${EINFO}\u0026#34; mysql -u root -h $host -e \u0026#34;use $1;drop tables $tb_list;\u0026#34; # æ‰§è¡Œæ•°æ®åº“çš„ schema è„šæœ¬ã€‚ schema_sqls=`find fat-db/\\$1/schema -type f -name *.sql` for schema_sql in $schema_sqls;do echo -e \u0026#34;${INFO}å¼€å§‹æ‰§è¡Œ${schema_sql} ${EINFO}\u0026#34; mysql -u root -h $host $1 \u0026lt; $schema_sql done # å¦‚æœå­˜åœ¨åˆå§‹åŒ–è„šæœ¬ç›®å½•ï¼Œåˆ™æ‰§è¡Œå…¶ä¸­çš„ SQL è„šæœ¬ã€‚ if [ -d fat-db/$1/init ]; then init_sqls=`find fat-db/\\$1/init -type f -name *.sql` for init_sql in $init_sqls;do echo -e \u0026#34;${INFO}å¼€å§‹æ‰§è¡Œ${init_sql} ${EINFO}\u0026#34; mysql -u root -h $host $1 \u0026lt; $init_sql done fi # å¦‚æœå­˜åœ¨è¿½åŠ è„šæœ¬ç›®å½•ï¼Œåˆ™æ ¹æ®æ—¥æœŸæ’åºåæ‰§è¡Œå…¶ä¸­çš„ SQL è„šæœ¬ã€‚ if [ -d fat-db/$1/append ]; then append_sqls=`find fat-db/$1/append -type f -name *.sql | sort -t \u0026#39;/\u0026#39; -k 4` for append_sql in $append_sqls;do echo -e \u0026#34;${INFO}å¼€å§‹æ‰§è¡Œ${append_sql} ${EINFO}\u0026#34; mysql -u root -h $host $1 \u0026lt; $append_sql done fi } # å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå½“æ²¡æœ‰å‚æ•°æ—¶ï¼Œé€šè¿‡ select æä¾›ä¸€ä¸ªèœå•æ¥é€‰æ‹©æ•°æ®åº“ã€‚ function select_db() { # å°† \u0026#34;all\u0026#34; å’Œ \u0026#34;quit\u0026#34; æ·»åŠ åˆ°é€‰é¡¹èœå•ä¸­ã€‚ options+=(\u0026#34;all\u0026#34; \u0026#34;quit\u0026#34;) # ä½¿ç”¨ select æ˜¾ç¤ºèœå•å¹¶å…è®¸ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ã€‚ select option in \u0026#34;${options[@]}\u0026#34;; do # æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚ case $option in \u0026#34;quit\u0026#34;) echo \u0026#34;Exiting...\u0026#34; break ;; \u0026#34;all\u0026#34;) # å¦‚æœé€‰æ‹© \u0026#34;all\u0026#34;ï¼Œåˆ™å¯¹æ‰€æœ‰æ•°æ®åº“æ‰§è¡Œ exec_sql å‡½æ•°ã€‚ for db in ${options[@]}; do if [[ $db =~ \u0026#34;all\u0026#34; || $db =~ \u0026#34;quit\u0026#34; ]];then continue ;fi exec_sql $db done ;; *) # å¦‚æœç”¨æˆ·é€‰æ‹©äº†ä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®åº“åç§°ï¼Œåˆ™æ‰§è¡Œ exec_sql å‡½æ•°ã€‚ if [[ \u0026#34;${options[@]}\u0026#34; =~ \u0026#34;$option\u0026#34; ]]; then echo \u0026#34;You selected: $option\u0026#34; exec_sql $option else echo \u0026#34;Please choose a valid option.\u0026#34; fi ;; esac done } # å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå½“æœ‰ä¸€ä¸ªå‚æ•°æ—¶æ‰§è¡Œã€‚ function arges_db() { # å¦‚æœå‚æ•°å­˜åœ¨äºé€‰é¡¹æ•°ç»„ä¸­ï¼Œåˆ™æ‰§è¡Œè¯¥æ•°æ®åº“çš„ SQL è„šæœ¬ã€‚ if [[ ${options[@]/$1/} != ${options[@]} ]]; then exec_sql $1 # å¦‚æœå‚æ•°æ˜¯ \u0026#34;all\u0026#34;ï¼Œåˆ™å¯¹æ‰€æœ‰æ•°æ®åº“æ‰§è¡Œ SQL è„šæœ¬ã€‚ elif [[ $1 == \u0026#34;all\u0026#34; ]];then for db in ${options[@]}; do exec_sql $db done # å¦‚æœå‚æ•°ä¸åœ¨é€‰é¡¹ä¸­ä¸”ä¸æ˜¯ \u0026#34;all\u0026#34;ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚ else echo \u0026#34;You selected $1 not exist!\u0026#34; fi } # æ£€æŸ¥ä¼ å…¥çš„å‚æ•°æ•°é‡ã€‚ if [[ $# == 0 ]];then # å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™è°ƒç”¨ select_db å‡½æ•°ã€‚ select_db elif [[ $# == 1 ]];then # å¦‚æœæœ‰ä¸€ä¸ªå‚æ•°ï¼Œåˆ™è°ƒç”¨ arges_db å‡½æ•°å¹¶ä¼ å…¥è¯¥å‚æ•°ã€‚ arges_db $1 else # å¦‚æœå‚æ•°æ•°é‡ä¸æ˜¯0æˆ–1ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚ echo \u0026#34;database:${options[@]}\u0026#34; echo \u0026#34;example : $(basename $0)\u0026#34; echo \u0026#34;example : $(basename $0) ${options[1]}\u0026#34; echo \u0026#34;example : $(basename $0) all\u0026#34; fi 5ã€æµ‹è¯•ç»“æœ æ‰§è¡Œ sh fatdb-init.shï¼Œä¼šåˆ—ä¸¾å½“ä¸‹çš„æ‰€æœ‰æ•°æ®åº“ å¦‚æœæƒ³é‡ç½®loan_urgeåº“ï¼Œè¾“å…¥7åå›è½¦å°±å¯ä»¥è‡ªåŠ¨æ‰§è¡Œ åŒç†ï¼Œæƒ³é‡ç½®å“ªä¸ªåº“å°±è¾“å…¥åº“åå‰é¢çš„æ•°å­—å³å¯ã€‚8ä»£è¡¨å…¨éƒ¨åº“ï¼Œ9ä»£è¡¨é€€å‡ºå½“å‰æ“ä½œ\n6ã€ç»“è¯­ï¼š è‡ªåŠ¨åŒ–æ•°æ®åº“é‡ç½®è„šæœ¬çš„å¼€å‘ä¸å®æ–½ï¼Œæ˜¯æé«˜å¼€å‘æ•ˆç‡ã€ä¿è¯æµ‹è¯•è´¨é‡çš„å…³é”®ä¸€ç¯ã€‚é€šè¿‡ç»¼åˆè€ƒè™‘æŠ€æœ¯é€‰å‹ã€ç²¾å¿ƒè®¾è®¡æ ¸å¿ƒé€»è¾‘ã€å¼ºåŒ–å®‰å…¨æªæ–½åŠæ— ç¼èå…¥CI/CDæµç¨‹ï¼Œå¯æ„å»ºå‡ºæ—¢é«˜æ•ˆåˆå¯é çš„æ•°æ®åº“ç®¡ç†è‡ªåŠ¨åŒ–è§£å†³æ–¹æ¡ˆã€‚å®è·µè¿‡ç¨‹ä¸­ï¼Œä¸æ–­è¿­ä»£ä¼˜åŒ–ï¼Œç»“åˆå…·ä½“é¡¹ç›®éœ€æ±‚çµæ´»è°ƒæ•´ï¼Œæ˜¯å®ç°é•¿æœŸæˆåŠŸçš„å…³é”®ã€‚\n","date":"2024-05-24T14:37:11Z","image":"https://www.ownit.top/title_pic/45.jpg","permalink":"https://www.ownit.top/p/202405241437/","title":"è‡ªåŠ¨åŒ–é‡ç½®æ•°æ®åº“åŠŸèƒ½çš„æ¢ç´¢ä¸å®è·µ"},{"content":"LDAP ç®€ä»‹ ä»€ä¹ˆæ˜¯ç›®å½•æœåŠ¡(directory service)ï¼Ÿ\nä¸€ä¸ªç›®å½•ï¼Œé™¤äº†æ”¯æŒåŸºæœ¬çš„æŸ¥æ‰¾å’Œæ›´æ–°åŠŸèƒ½å¤–ï¼Œæ˜¯ä¸€ä¸ªç‰¹åˆ«è®¾è®¡ç”¨æ¥æœç´¢å’Œæµè§ˆçš„ä¸“é—¨çš„æ•°æ®åº“ã€‚ç›®å½•å€¾å‘äºåŒ…å«æè¿°æ€§çš„ã€åŸºäºå±æ€§çš„ä¿¡æ¯ï¼Œå¹¶æ”¯æŒç²¾ç»†çš„è¿‡æ»¤èƒ½åŠ›ã€‚ç›®å½•é€šå¸¸ä¸æ”¯æŒå¤æ‚çš„äº‹åŠ¡å’Œå›æ»šæœºåˆ¶ï¼Œè¿™ä¸å…³ç³»æ•°æ®åº“ä¸ä¸€æ ·ã€‚\nä»€ä¹ˆæ˜¯ LDAPï¼Ÿ\nLDAP ä»£è¡¨è½»é‡ç›®å½•è®¿é—®åè®®(Lightweight Directory Access Protocol)ã€‚æ­£å¦‚åç§°ä¸­æ‰€æš—ç¤ºçš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨äºè®¿é—®ç›®å½•æœåŠ¡çš„è½»é‡åè®®ï¼Œå…·ä½“æ¥è¯´ï¼Œæ˜¯åŸºäº X.500 çš„ç›®å½•æœåŠ¡ã€‚\nä»€ä¹ˆæ ·çš„ä¿¡æ¯å¯ä»¥å­˜å‚¨åœ¨ç›®å½•ä¸­ï¼ŸLDAP ä¿¡æ¯æ¨¡å‹æ˜¯åŸºäºæ¡ç›®(entries)çš„ã€‚ä¸€ä¸ªæ¡ç›®(entry)æ˜¯ä¸€äº›å±æ€§çš„é›†åˆï¼Œå®ƒæœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å¯è¾¨è¯†åç§°(Distinguished Nameï¼ŒDN)ã€‚DN ç”¨äºæ— æ­§ä¹‰åœ°å¼•ç”¨è¯¥æ¡ç›®ã€‚æ¡ç›®çš„æ¯ä¸€ä¸ªå±æ€§éƒ½ç”±ä¸€ä¸ªç±»å‹(type)å’Œä¸€ä¸ªæˆ–å¤šä¸ªå€¼(values)æ„æˆã€‚ç±»å‹é€šå¸¸æ˜¯ä¸€ä¸ªåŠ©è®°ç¬¦å­—ç¬¦ï¼Œæ¯”å¦‚â€œcnâ€ä»£è¡¨ common nameï¼Œâ€œmailâ€ä»£è¡¨ email addressã€‚å€¼çš„è¯­æ³•å–å†³äºå±æ€§ç±»å‹ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ª cn å±æ€§çš„å€¼å¯èƒ½æ˜¯ Babs Jensenï¼Œä¸€ä¸ª mail å±æ€§çš„å€¼å¯èƒ½æ˜¯ babs@example.comï¼Œä¸€ä¸ª jpegPhoto å±æ€§å¯èƒ½åŒ…å«ä¸€ä¸ª JPEG(äºŒè¿›åˆ¶)æ ¼å¼çš„ç…§ç‰‡ã€‚\næ¸©é¦¨æç¤ºï¼šdn å¿…é¡»æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚\nLDAP ä¸­ï¼Œå°†æ•°æ®ç»„ç»‡æˆä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œè¿™ä¸ç°å®ç”Ÿæ´»ä¸­çš„å¾ˆå¤šæ•°æ®ç»“æ„å¯ä»¥å¯¹åº”èµ·æ¥ï¼Œè€Œä¸åƒè®¾è®¡å…³ç³»å‹æ•°æ®åº“çš„è¡¨ï¼Œéœ€è¦è¿›è¡Œå¤šç§å˜åŒ–ã€‚å¦‚ä¸‹å›¾æ‰€å±•ç¤ºçš„å°±æ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æ„çš„æ•°æ®ã€‚ åœ¨ä¸Šå›¾æ‰€ç¤ºçš„æ ‘å½¢ç»“æ„ä¸­ï¼Œæ ‘çš„æ ¹ç»“ç‚¹æ˜¯ä¸€ä¸ªç»„ç»‡çš„åŸŸåï¼ˆnode3.comï¼Œå¯ä»¥æ ¹æ®è‡ªå·±æ„æ„¿é…ï¼‰ï¼Œå…¶ä¸‹åˆ†ä¸º 2 ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ ou=admin å’Œ dc=hdpï¼Œdc=hdp ä¸‹é¢åˆåˆ† ou=people å’Œ ou=groupã€‚admin ç”¨æ¥ç®¡ç†æ‰€æœ‰ç®¡ç†äººå‘˜ï¼Œpeople ç”¨æ¥ç®¡ç†ç™»å½•ç³»ç»Ÿçš„ç”¨æˆ·ï¼Œgroup ç”¨æ¥ç®¡ç†ç³»ç»Ÿä¸­çš„ç”¨æˆ·ç»„ã€‚å½“ç„¶ï¼Œåœ¨è¯¥å›¾ä¸­è¿˜å¯ç»§ç»­å¢åŠ å…¶ä»–åˆ†æ”¯ã€‚\nå¯¹äºå›¾ä¸­æ‰€ç¤ºçš„æ ‘å½¢ç»“æ„ï¼Œä½¿ç”¨å…³ç³»æ•°æ®åº“æ¥ä¿å­˜æ•°æ®çš„è¯ï¼Œéœ€è¦è®¾ç½®å¤šä¸ªè¡¨ï¼Œä¸€å±‚ä¸€å±‚åˆ†åˆ«ä¿å­˜ï¼Œå½“éœ€è¦æŸ¥æ‰¾æŸä¸ªä¿¡æ¯æ—¶ï¼Œå†é€å±‚è¿›è¡ŒæŸ¥è¯¢ï¼Œæœ€ç»ˆå¾—åˆ°ç»“æœã€‚\nè‹¥ä½¿ç”¨ç›®å½•æ¥ä¿å­˜è¯¥å›¾ä¸­çš„æ•°æ®ï¼Œåˆ™æ›´ç›´è§‚ã€‚å›¾ä¸­æ¯ä¸ªç»“ç‚¹ç”¨ä¸€ä¸ªæ¡ç›®æ¥ä¿å­˜ï¼Œä¸åŒç±»å‹çš„ç»“ç‚¹éœ€è¦ä¿å­˜çš„æ•°æ®å¯èƒ½ä¸åŒï¼Œåœ¨ LDAP ä¸­é€šè¿‡ä¸€ä¸ªç§°ä¸º objectClass çš„ç±»å‹æ¥æ§åˆ¶ä¸åŒç»“ç‚¹éœ€è¦çš„æ•°æ®ï¼ˆç§°ä¸ºå±æ€§ï¼‰ã€‚\nå‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/weixin_42578481/article/details/80863890\nåè¯è§£é‡Šï¼š\nDCï¼šdomain componentï¼Œä¸€èˆ¬ä¸ºå…¬å¸åï¼Œä¾‹å¦‚ï¼šdc=163,dc=com\nOUï¼šorganization unitï¼Œä¸ºç»„ç»‡å•å…ƒï¼Œæœ€å¤šå¯ä»¥æœ‰å››çº§ï¼Œæ¯çº§æœ€é•¿ 32 ä¸ªå­—ç¬¦ï¼Œå¯ä»¥ä¸ºä¸­æ–‡\nCNï¼šcommon nameï¼Œä¸ºç”¨æˆ·åæˆ–è€…æœåŠ¡å™¨åï¼Œæœ€é•¿å¯ä»¥åˆ° 80 ä¸ªå­—ç¬¦ï¼Œå¯ä»¥ä¸ºä¸­æ–‡\nDNï¼šdistinguished nameï¼Œä¸ºä¸€æ¡ LDAP è®°å½•é¡¹çš„åå­—ï¼Œæœ‰å”¯ä¸€æ€§ï¼Œä¾‹å¦‚ï¼šdc:â€cn=admin,ou=developer,dc=163,dc=comâ€\nå›¾å½¢ç¤ºä¾‹\nä¸Šè¾¹æ¥äº†ä¸€å †çš„åè¯è§£é‡Šï¼Œçœ‹çš„äº‘é‡Œé›¾é‡Œï¼Œè¿˜ä¸æ˜¯å¾ˆæ˜ç™½ï¼Œæ€ä¹ˆè·Ÿè‡ªå·±çš„ç»„ç»‡æ¶æ„å¯¹åº”èµ·æ¥å‘¢ï¼Ÿçœ‹çœ‹ä¸‹è¾¹çš„å›¾æ˜¯ä¸æ˜¯æ¸…æ™°æ˜äº† éƒ¨ç½² OpenLDAP è¯´æ˜ ä¸‹é¢æ˜¯ LDAP ä¸­çš„ä¸€äº›æœ¯è¯­ï¼š\nentry(æ¡ç›®)ï¼šLDAP ç›®å½•ä¸­çš„ä¸€ä¸ªå•ä½ã€‚æ¯ä¸€ä¸ªæ¡ç›®éƒ½ç”±å®ƒçš„å”¯ä¸€çš„å¯è¾¨è¯†åç§°(Distinguished** Name ï¼Œ DN**)æ¥å”¯ä¸€ç¡®å®šã€‚\nattribute(å±æ€§)ï¼šä¸ä¸€ä¸ª entry ç›´æ¥å…³è”çš„ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½¿ç”¨ä¸€ä¸ª LDAP entry æ¥ä»£è¡¨ä¸€ä¸ªç»„ç»‡çš„è¯ï¼Œé‚£ä¹ˆï¼Œä¸è¯¥ç»„ç»‡ç›¸å…³è”çš„å±æ€§å¯èƒ½åŒ…æ‹¬ä¸€ä¸ªåœ°å€ã€ä¸€ä¸ªä¼ çœŸå·ç ï¼Œç­‰ç­‰ã€‚\nä¸€ä¸ªå±æ€§å¯èƒ½æœ‰ä¸€ä¸ªå•ä¸€çš„å€¼ï¼Œæˆ–è€…æ˜¯æœªæ’åºçš„ã€ç©ºæ ¼åˆ†éš”å¼€æ¥çš„å€¼çš„åˆ—è¡¨ã€‚æœ‰ä¸€äº›å±æ€§æ˜¯å¯é€‰çš„ï¼Œæœ‰ä¸€äº›åˆ™æ˜¯å¿…é¡»çš„ã€‚å¿…é¡»çš„å±æ€§ä½¿ç”¨ objectClass å®šä¹‰æ¥æŒ‡å®šï¼Œå¯ä»¥åœ¨ /etc/openldap/slapd.d/cn=config/cn=schema/ ç›®å½•ä¸‹çš„ schema æ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚\nä¸€ä¸ªå±æ€§å’Œå®ƒç›¸åº”å€¼çš„æ–­è¨€(assertion)ä¹Ÿè¢«ç§°ä¸ºæ˜¯ä¸€ä¸ªç›¸å¯¹å¯è¾¨è¯†çš„åç§°(Relative** Distinguished Name ï¼Œ RDN**)ã€‚ä¸ Distinguished Name(å®ƒæ˜¯å…¨å±€å”¯ä¸€çš„)ä¸åŒçš„æ˜¯ï¼ŒRelative Distinguished Name åªåœ¨æ¯ä¸ªæ¡ç›®ä¸­æ˜¯å”¯ä¸€çš„ã€‚\nLDIFï¼šLDAP æ•°æ®äº¤æ¢æ ¼å¼(LDAP Data Interchange Formatï¼ŒLDIF)æ˜¯ä¸€ä¸ª LDAP entry çš„çº¯æ–‡æœ¬è¡¨ç°å½¢å¼ã€‚å®ƒæœ‰å¦‚ä¸‹æ ¼å¼ï¼š id æ˜¯å¯é€‰çš„ï¼Œæ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå®ƒç”±åº”ç”¨ç¨‹åºå†³å®šï¼Œè¢«ç”¨æ¥ç¼–è¾‘è¯¥æ¡ç›®ã€‚æ¯ä¸€ä¸ªæ¡ç›®å¯ä»¥åŒ…å«ä»»æ„æ•°é‡çš„ attribute_type å’Œ attribute_value å¯¹ï¼Œåªè¦å®ƒä»¬éƒ½åœ¨ç›¸åº”çš„ schema file ä¸­å®šä¹‰äº†å°±è¡Œã€‚ç©ºç™½è¡Œä»£è¡¨äº†è¯¥æ¡ç›®çš„ç»“æŸã€‚\nschema æ–‡ä»¶ï¼šç®€å•æ¥è¯´ï¼Œå¯ä»¥ç†è§£ä¸ºæ¨¡æ¿æ–‡ä»¶ï¼Œæ˜¯å¯¹ OpenLDAP é…ç½®æ–‡ä»¶ä¸­æ‰€èƒ½ä½¿ç”¨çš„å±æ€§è¿›è¡Œé™å®šçš„æ–‡ä»¶ã€‚\nå®‰è£… OpenLDAP å¥—ä»¶ OpenLDAP å¥—ä»¶åŒ…å«å¦‚ä¸‹è½¯ä»¶åŒ…ï¼š\nè½¯ä»¶åŒ…å è¯´æ˜ openldap åŒ…å«è¿è¡Œ OpenLDAP server å’Œ client ç«¯åº”ç”¨ç¨‹åºæ‰€éœ€çš„åº“ã€‚ openldap-clients åŒ…å«å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºæŸ¥çœ‹å’Œä¿®æ”¹ LDAP server ä¸Šçš„ç›®å½•ã€‚ openldap-servers åŒ…å«ç”¨äºé…ç½®å’Œè¿è¡Œä¸€ä¸ª LDAP server çš„æœåŠ¡å’Œå·¥å…·ã€‚è¿™åŒ…æ‹¬ä¸€ä¸ªç‹¬ç«‹çš„ LDAP æœåŠ¡ç¨‹åºï¼Œslapdã€‚ compat-openldap åŒ…å« OpenLDAP å…¼å®¹åº“ã€‚ è¦æ­å»ºä¸€ä¸ªåŸºæœ¬çš„ LDAP æœåŠ¡å™¨ï¼Œå®‰è£…å¦‚ä¸‹è½¯ä»¶åŒ…ï¼š\n1 [root@gw ~]# yum install openldap openldap-clients openldap-servers æˆ‘è¿™é‡Œå®‰è£…çš„æ˜¯ 2.4.44 ç‰ˆæœ¬çš„ openldapï¼š\nå¯åŠ¨ OpenLDAP æœåŠ¡ ç›´æ¥å¯åŠ¨ OpenLDAP æœåŠ¡å¹¶è®¾ç½®å¼€æœºå¯åŠ¨ï¼š\n1 2 [root@gw ~]# systemctl start slapd [root@gw ~]# systemctl enable slapd é…ç½® OpenLDAP æœåŠ¡ OpenLDAP çš„é…ç½®æ–‡ä»¶å’Œç›®å½•ï¼š\né…ç½®æ–‡ä»¶ è¯´æ˜ /etc/openldap/ldap.conf ä½¿ç”¨ OpenLDAP åº“çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ã€‚åŒ…æ‹¬ ldapaddã€ldapsearchã€Evolution ç­‰ã€‚å…³äºè¯¥æ–‡ä»¶ä¸­é…ç½®çš„è¯¦ç»†è¯´æ˜ï¼Œå¯æ‰§è¡Œ man ldap.conf å‘½ä»¤ã€‚ /etc/openldap/slapd.d/ åŒ…å« slapd é…ç½®æ–‡ä»¶çš„ç›®å½•ã€‚å…³äºè¯¥ç›®å½•ä¸‹é…ç½®çš„è¯¦ç»†è¯´æ˜ï¼Œå¯æ‰§è¡Œ man slapd-config å‘½ä»¤ã€‚ æ³¨æ„ï¼ŒOpenLDAP æœåŠ¡è¿›ç¨‹å·²ä¸å†ä»/etc/openldap/slapd.conf æ–‡ä»¶è¯»å–å®ƒçš„é…ç½®ï¼Œå®ƒçš„æ˜¯ä½¿ç”¨ä½äº/etc/openldap/slapd.d/ç›®å½•ä¸‹çš„é…ç½®ã€‚ä½†æ˜¯ï¼Œä¸è¦æ‰‹åŠ¨å»ä¿®æ”¹é‡Œé¢çš„é…ç½®ï¼Œè€Œåº”è¯¥ä½¿ç”¨å®¢æˆ·ç«¯å·¥å…·ï¼Œæ¯”å¦‚ ldapmodifyã€‚\nè¯¥ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶çš„ç»“æ„ç±»ä¼¼äºä¸‹é¢è¿™æ ·(è¿™é‡Œçœç•¥äº†ä¸€äº›é…ç½®æ–‡ä»¶ï¼Œåªæ˜¯ä¸ºäº†ä¾¿äºè§£é‡Š)ï¼š\nå¯ä»¥çœ‹åˆ°ï¼Œæ ‘çš„æ ¹èŠ‚ç‚¹æ˜¯â€œcn=configâ€æ¡ç›®ï¼Œå³ cn=config.ldif æ–‡ä»¶ï¼Œå®ƒåŒ…å«å…¨å±€çš„é…ç½®ã€‚å…¶å®ƒçš„è®¾ç½®åŒ…å«åœ¨ cn=config æ–‡ä»¶å¤¹ä¸‹çš„å„å­æ¡ç›®ä¸­ã€‚\nå®é™…æ¥è¯´ï¼Œcn=config æ–‡ä»¶å¤¹ä¸‹æœ‰å¦‚ä¸‹è¿™äº›æ–‡ä»¶ï¼š\ncn=schema.ldif æ–‡ä»¶ï¼šåŒ…å« schema ç›¸å…³çš„è®¾ç½®ã€‚â€œcn=schema,cn=configâ€æ¡ç›®åŒ…å«äº†è¯¥ç³»ç»Ÿçš„ schema(æ‰€æœ‰ç¡¬ç¼–ç åˆ° slapd ä¸­çš„ schema)ã€‚\nolcDatabase={0}config.ldif æ–‡ä»¶ï¼šè¯¥æ–‡ä»¶æ˜¯ç‰¹æ®Šçš„ï¼Œç”¨äºè®¾ç½® OpenLDAP config æ•°æ®åº“è‡ªèº«ã€‚\nolcDatabase={-1}frontend.ldif æ–‡ä»¶ï¼šè¯¥æ–‡ä»¶åŒ…å« OpenLDAP å‰ç«¯(front end)çš„ç›¸å…³é…ç½®ï¼Œå¹¶å®šä¹‰äº†å…¨å±€çš„æ•°æ®åº“é€‰é¡¹ï¼Œæ¯”å¦‚è®¿é—®æ§åˆ¶åˆ—è¡¨(ACL)ã€‚è¯¥æ–‡ä»¶æ˜¯ç‰¹æ®Šçš„ï¼Œå®ƒé‡Œé¢çš„è®¾ç½®ä¼šè¢«å…¶å®ƒæ•°æ®åº“æ‰€ç»§æ‰¿ï¼Œé™¤éå®ƒä»¬æ˜¾å¼è¿›è¡Œäº†é‡æ–°å®šä¹‰ã€‚\nolcDatabase={1}monitor.ldif æ–‡ä»¶ï¼šè¯¥æ–‡ä»¶åŒ…å« OpenLDAP ç›‘æ§åç«¯(monitor back end)çš„ç›¸å…³é…ç½®ã€‚å½“å¯ç”¨æ—¶ï¼Œå®ƒæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå¹¶ä¸”ä¼šä½¿ç”¨ OpenLDAP æœåŠ¡çš„è¿è¡ŒçŠ¶æ€ä¿¡æ¯æ¥åŠ¨æ€åœ°æ›´æ–°å®ƒã€‚\nolcDatabase={2}hdb.ldif æ–‡ä»¶ï¼šè¯¥æ–‡ä»¶åŒ…å« hdb æ•°æ®åº“åç«¯(database back end)çš„ç›¸å…³é…ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒOpenLDAP ä½¿ç”¨ hdb ä½œä¸ºå®ƒçš„æ•°æ®åº“åç«¯ã€‚ä¸è¿‡ï¼Œå®˜æ–¹æ–‡æ¡£ä¸­è¯´ï¼Œhdb å·²å¼ƒç”¨ï¼Œæ¨èä½¿ç”¨ mdb ä½œä¸ºæ•°æ®åº“åç«¯ã€‚\nè¿™äº›æ–‡ä»¶æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä¸è¦æ‰‹åŠ¨å»ç¼–è¾‘å®ƒï¼Œè¦ä½¿ç”¨ ldapmodify è¿™ç±»å·¥å…·ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ cat å‘½ä»¤å»æŸ¥çœ‹å®ƒçš„å†…å®¹ã€‚\nldif æ–‡ä»¶çš„è¯­æ³•ï¼šåœ¨ ldif æ–‡ä»¶ä¸­ï¼Œ\u0026rsquo;#\u0026rsquo; ç¬¦å·å¼€å¤´çš„è¡Œæ˜¯æ³¨é‡Šè¯­å¥ã€‚å¦‚æœæŸä¸€è¡Œä»¥ä¸€ä¸ªç©ºæ ¼å¼€å¤´ï¼Œè¯¥è¡Œä¼šè¢«è®¤ä¸ºæ˜¯å‰ä¸€è¡Œçš„å»¶ç»­(å³ä¾¿ä¸Šä¸€è¡Œæ˜¯ä¸€ä¸ªæ³¨é‡Šè¯­å¥)å¹¶ä¸”è¯¥å•ä¸€çš„æ‰“å¤´çš„ç©ºæ ¼ä¼šè¢«ç§»é™¤ã€‚ä¸åŒçš„æ¡ç›®(entries)ä¹‹é—´ä»¥ç©ºè¡Œåˆ†éš”å¼€ã€‚\nç”Ÿæˆå“ˆå¸Œåçš„å¯†ç  æ‰§è¡Œ slappasswd å‘½ä»¤ï¼Œè¾“å…¥ä½ æ‰“ç®—ä½¿ç”¨çš„å¯†ç ï¼Œç”Ÿæˆè¯¥å¯†ç å“ˆå¸Œåçš„å€¼ï¼š\n1 2 3 4 [root@gw ~]# slappasswd New password: # è¾“å…¥ä½ æ‰“ç®—ä½¿ç”¨çš„å¯†ç  Re-enter new password: # å†æ¬¡è¾“å…¥ {SSHA}XGQdioFMQPvxjs8z1YeT7RIyn3FJTURB # å¾—åˆ°ç»è¿‡å“ˆå¸Œåçš„å¯†ç  è®¾ç½® OpenLDAP config æ•°æ®åº“çš„å¯†ç  éšä¾¿æ‰¾ä¸ªç›®å½•ï¼Œåˆ›å»ºä¸ª ldif æ–‡ä»¶ï¼Œæ–‡ä»¶åéšæ„ï¼Œåªè¦æ‰©å±•åæ˜¯ ldif å°±è¡Œï¼š\n1 2 3 4 5 [root@gw ~]# vim ldaprootpasswd.ldif dn: olcDatabase={0}config,cn=config changetype: modify add: olcRootPW olcRootPW: {SSHA}XGQdioFMQPvxjs8z1YeT7RIyn3FJTURB dnï¼šè¿™é‡Œè¾“å…¥æˆ‘ä»¬æƒ³è¦è¿›è¡Œæ›´æ”¹çš„æ¡ç›®çš„ dn åç§°ã€‚è¿™é‡Œå®é™…æŒ‡å‘çš„æ˜¯ cn=config/olcDatabase={0}config.ldif è¿™ä¸ªæ–‡ä»¶ï¼Œå³ OpenLDAP çš„ config æ•°æ®åº“æ–‡ä»¶ã€‚\nchangetypeï¼šå€¼ä¸º modifyï¼Œè¡¨ç¤ºæˆ‘ä»¬æƒ³è¦å¯¹ç›®æ ‡æ¡ç›®è¿›è¡Œçš„æ˜¯ä¿®æ”¹æ“ä½œã€‚\naddï¼šå€¼ä¸º olcRootPWï¼Œè¡¨ç¤ºæˆ‘ä»¬æƒ³è¦ç»™ç›®æ ‡æ¡ç›®æ·»åŠ ä¸€ä¸ª olcRootPW å±æ€§ã€‚\nolcRootPWï¼šè¿™é‡Œè¾“å…¥å‰é¢å¾—åˆ°çš„å“ˆå¸Œåçš„å¯†ç å­—ç¬¦ä¸²ã€‚è¡¨ç¤ºæˆ‘ä»¬æƒ³è¦æŠŠ olcRootPW å±æ€§çš„å€¼è®¾ä¸ºè¿™ä¸ªå€¼ã€‚ç›´æ¥ä½¿ç”¨æ˜æ–‡çš„å¯†ç ä¹Ÿå¯ä»¥ï¼Œä½†ä¸å»ºè®®è¿™æ ·åšï¼Œå› ä¸ºæ˜æ–‡å¯†ç ç›´æ¥å†™é…ç½®æ–‡ä»¶ä¸­ï¼Œå¾ˆå®¹æ˜“æ³„éœ²å‡ºå»å˜›ã€‚\nldapadd æ˜¯ä¸€ä¸ªå¾€ LDAP ä¸­æ·»åŠ æ–°æ¡ç›®(æˆ–ç»™ç°æœ‰æ¡ç›®æ·»åŠ æ–°å±æ€§)çš„å·¥å…·ã€‚ä½¿ç”¨ ldapadd å‘½ä»¤å®é™…æ‰§è¡Œè¯¥ ldif æ–‡ä»¶ï¼Œå¯¹ OpenLDAP æ¡ç›®è¿›è¡Œä¿®æ”¹ï¼š\n1 [root@gw ~]# ldapadd -Y EXTERNAL -H ldapi:/// -f ldaprootpasswd.ldif -Y é€‰é¡¹ï¼šæŒ‡å®šåœ¨è¿æ¥ LDAP æœåŠ¡å™¨æ—¶æ‰€è¦ä½¿ç”¨çš„ SASL è®¤è¯æœºåˆ¶ã€‚EXTERNAL ä¸çŸ¥é“æ˜¯ä»€ä¹ˆæœºåˆ¶æ¥çš„ï¼Œå°±ç›´æ¥ä½¿ç”¨å§ -H é€‰é¡¹ï¼šæ‰€è¦è¿æ¥çš„ LDAP æœåŠ¡å™¨çš„ URI åœ°å€ã€‚ -f é€‰é¡¹ï¼šæ‰€è¦æ‰§è¡Œçš„ ldif æ–‡ä»¶ã€‚ é…ç½® LDAP æ•°æ®åº“ æ‹·è´ç¤ºä¾‹æ•°æ®åº“é…ç½®æ–‡ä»¶åˆ° /var/lib/ldap ç›®å½•(è¿™ä¸ªæ˜¯é»˜è®¤çš„ hdb æ•°æ®åº“åç«¯çš„æ•°æ®ç›®å½•)ï¼Œå¹¶è®¾ç½®æ‰€å±ç”¨æˆ·å’Œç»„(ä¸ slapd æœåŠ¡ç¨‹åºçš„å±ä¸»ç›¸åŒ)ã€‚è¿™ä¸ªå®é™…ä½¿ç”¨çš„æ•°æ®åº“ç±»å‹ä¸º Oracle Berkeley DBã€‚\n1 2 3 [root@gw ~]# cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG [root@gw ~]# chown -R ldap:ldap /var/lib/ldap/DB_CONFIG [root@gw ~]# systemctl restart slapd ä» /etc/openldap/schema ç›®å½•ä¸‹å¯¼å…¥å‡ ä¸ªåŸºæœ¬çš„ LDAP schema æ–‡ä»¶ï¼š\n1 2 3 [root@gw ~]# ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif [root@gw ~]# ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif [root@gw ~]# ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif æ¥ä¸‹æ¥ï¼Œæ·»åŠ ä½ çš„åŸŸåˆ° LDAPã€‚åˆ›å»ºä¸€ä¸ª ldif æ–‡ä»¶ï¼Œåœ¨ä¸‹é¢çš„æ–‡ä»¶ä¸­ï¼Œexample å­—ç¬¦ä¸²å¯ä»¥ä½¿ç”¨ä½ çš„åŸŸæ›¿ä»£ï¼ŒolcRootPW å€¼åˆ™ä½¿ç”¨å“ˆå¸Œå¾—åˆ°çš„å¯†ç å­—ç¬¦ä¸²æ›¿ä»£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 [root@gw ~]# vim ldapdomain.ldif #ä¿®æ”¹olcDatabase={1}monitor.ldifæ–‡ä»¶çš„olcAccesså±æ€§å€¼ dn: olcDatabase={1}monitor,cn=config changetype: modify replace: olcAccess olcAccess: {0}to * by dn.base=\u0026#34;gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth\u0026#34; read by dn.base=\u0026#34;cn=Manager,dc=example,dc=com\u0026#34; read by * none #ä¿®æ”¹olcDatabase={2}hdb.ldifæ–‡ä»¶çš„olcSuffixå±æ€§å€¼ dn: olcDatabase={2}hdb,cn=config changetype: modify replace: olcSuffix olcSuffix: dc=example,dc=com #ä¿®æ”¹olcDatabase={2}hdb.ldifæ–‡ä»¶çš„olcRootDNå±æ€§å€¼ dn: olcDatabase={2}hdb,cn=config changetype: modify replace: olcRootDN olcRootDN: cn=Manager,dc=example,dc=com #å‘olcDatabase={2}hdb.ldifæ–‡ä»¶ä¸­æ·»åŠ olcRootPWå±æ€§å’Œå€¼ dn: olcDatabase={2}hdb,cn=config changetype: modify add: olcRootPW olcRootPW: {SSHA}XGQdioFMQPvxjs8z1YeT7RIyn3FJTURB #å‘olcDatabase={2}hdb.ldifæ–‡ä»¶ä¸­æ·»åŠ olcAccesså±æ€§å’Œå€¼ï¼Œå¤šä¸ªolcAccessé¡¹ dn: olcDatabase={2}hdb,cn=config changetype: modify add: olcAccess olcAccess: {0}to attrs=userPassword,shadowLastChange by dn=\u0026#34;cn=Manager,dc=example,dc=com\u0026#34; write by anonymous auth by self write by * none olcAccess: {1}to dn.base=\u0026#34;\u0026#34; by * read olcAccess: {2}to * by dn=\u0026#34;cn=Manager,dc=example,dc=com\u0026#34; write by * read olcAccessï¼šACL è§„åˆ™ï¼Œè®¾ç½®æŒ‡å®šç”¨æˆ·(by åæ¥çš„)å¯¹æŒ‡å®šèµ„æº(æ¡ç›®å’Œ/æˆ–å±æ€§)çš„æƒé™(readã€write)ã€‚åœ¨ frontend ä¸­è®¾ç½®çš„ ACL è§„åˆ™ä¼šè¢«é™„åŠ åˆ°å…¶å®ƒä»»æ„ç‰¹å®šæ•°æ®åº“çš„ ACL è§„åˆ™åã€‚ç‰¹å®šæ•°æ®åº“çš„ rootdn æ€»æ˜¯å…·æœ‰è¯»å†™é‚£ä¸ªæ•°æ®åº“æ‰€æœ‰ä¸œè¥¿çš„æƒé™ã€‚\nolcSuffixï¼šç”¨äºæŒ‡å®šç‰¹å®šæ•°æ®åº“çš„ DN åç¼€ã€‚æ¯”å¦‚ï¼Œåç¼€ä¸ºâ€œdc=example,dc=comâ€çš„æŸ¥è¯¢éƒ½å°†è¢«è½¬å‘åˆ°è¯¥åç«¯æ•°æ®åº“ã€‚dc çš„å€¼å¯ä»¥è‡ªè¡Œè®¾å®šã€‚å¦‚æœ‰å¤šä¸ªï¼Œä¹Ÿè¿˜å¯å†åŠ ï¼Œæ¯”å¦‚â€œdc=gate,dc=ykd,dc=fujfu,dc=comâ€ã€‚\nolcRootDNï¼šç”¨äºæŒ‡å®šç®¡ç†è¯¥æ•°æ®åº“çš„ Root DN çš„åç§°ã€‚é»˜è®¤ä¸ºç©ºï¼Œè¡¨ç¤ºä¸æŒ‡å®š root ç”¨æˆ·ã€‚å¦‚æœ Root DN æ˜¯ä½äº olcSuffix æŒ‡å®šçš„ DN åç¼€çš„é‡Œé¢ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡»ä½¿ç”¨ olcRootPW æ¥è®¾å®š Root DN çš„å¯†ç ã€‚\næ‰§è¡Œè¯¥ ldif æ–‡ä»¶ï¼Œå¯¹ LDAP å®é™…è¿›è¡Œä¿®æ”¹ï¼š\n1 [root@gw ~]# ldapmodify -Y EXTERNAL -H ldapi:/// -f ldapdomain.ldif æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€äº›æ¡ç›®åˆ° LDAP ç›®å½•ä¸­ã€‚åˆ›å»ºä¸ª ldif æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 [root@gw ~]# vim baseldapdomain.ldif dn: dc=example,dc=com objectClass: top objectClass: dcObject objectclass: organization o: example com dc: example dn: cn=Manager,dc=example,dc=com objectClass: organizationalRole cn: Manager description: Directory Manager dn: ou=People,dc=example,dc=com objectClass: organizationalUnit ou: People dn: ou=Group,dc=example,dc=com objectClass: organizationalUnit ou: Group o å±æ€§ï¼šåœ¨ schema æ–‡ä»¶ä¸­ï¼Œo ä»£è¡¨ organizationNameï¼Œç»„ç»‡åç§°ã€‚\ndc å±æ€§ï¼šåœ¨ schema æ–‡ä»¶ä¸­ï¼Œdc ä»£è¡¨ domainComponentï¼ŒåŸŸéƒ¨ä»¶ã€‚\nou å±æ€§ï¼šåœ¨ schema æ–‡ä»¶ä¸­ï¼Œou ä»£è¡¨ organizationalUnitNameï¼Œç»„ç»‡å•å…ƒåç§°ã€‚\næ‰§è¡Œè¯¥ ldif æ–‡ä»¶ã€‚æ‰§è¡Œè¯¥å‘½ä»¤åï¼Œä¼šæç¤ºä½ è¾“å…¥ LDAP root ç”¨æˆ·å¯†ç ã€‚\n1 [root@gw ~]# ldapadd -x -W -D \u0026#34;cn=Manager,dc=example,dc=com\u0026#34; -f baseldapdomain.ldif -x é€‰é¡¹ï¼šä½¿ç”¨ç®€å•è®¤è¯(simple authentication)è€Œä¸æ˜¯ SASLã€‚\n-W é€‰é¡¹ï¼šæç¤ºè¾“å…¥ç”¨äºç®€å•è®¤è¯çš„å¯†ç ã€‚è¿™ä¸ç›´æ¥åœ¨å‘½ä»¤è¡ŒæŒ‡å®šå¯†ç æ˜¯ä¸åŒçš„ã€‚\n-D é€‰é¡¹ï¼šä½¿ç”¨æŒ‡å®šçš„ DN åç§°æ¥ç»‘å®šåˆ° LDAP ç›®å½•ã€‚\næ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ª LDAP ç”¨æˆ· tecmintï¼Œå¹¶ä¸ºå®ƒè®¾ç½®ä¸€ä¸ªå¯†ç ï¼š\n1 2 [root@gw ~]# useradd tecmint [root@gw ~]# passwd tecmint åˆ›å»ºä¸€ä¸ª ldif æ–‡ä»¶ï¼Œä¸º LDAP group è¿›è¡Œå®šä¹‰ï¼š\n1 2 3 4 5 [root@gw ~]# vim ldapgroup.ldif dn: cn=Manager,ou=Group,dc=example,dc=com objectClass: top objectClass: posixGroup gidNumber: 1002 åœ¨ä¸Šé¢çš„é…ç½®ä¸­ï¼ŒgidNumber æ˜¯/etc/group æ–‡ä»¶ä¸­ tecmint çš„ GIDï¼Œå¹¶å°†å®ƒæ·»åŠ åˆ° OpenLDAP ç›®å½•ã€‚\næ‰§è¡Œè¯¥ LDIF æ–‡ä»¶ï¼š\n1 [root@gw ~]# ldapadd -x -W -D \u0026#34;cn=Manager,dc=example,dc=com\u0026#34; -f ldapgroup.ldif æ¥ä¸‹æ¥ï¼Œåˆ›å»ºå¦ä¸€ä¸ª ldif æ–‡ä»¶ï¼Œæ·»åŠ  tecmint ç”¨æˆ·çš„å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@gw ~]# vim ldapuser.ldif dn: uid=tecmint,ou=People,dc=example,dc=com objectClass: top objectClass: account objectClass: posixAccount objectClass: shadowAccount cn: tecmint uid: tecmint uidNumber: 1002 gidNumber: 1002 homeDirectory: /home/tecmint userPassword: {SSHA}E6DO8V0dK5km8ZTJzCE0QO++/EX8GFax #è¯¥ç”¨æˆ·çš„å¯†ç å“ˆå¸Œåçš„å­—ç¬¦ä¸² loginShell: /bin/bash gecos: tecmint shadowLastChange: 0 shadowMax: 0 shadowWarning: 0 æ‰§è¡Œè¯¥ LDIF æ–‡ä»¶ï¼š\n1 [root@gw ~]# ldapadd -x -W -D \u0026#34;cn=Manager,dc=example,dc=com\u0026#34; -f ldapuser.ldif å®‰è£… phpLDAPadmin å®‰è£… phpLDAPadminï¼š\n1 2 [root@gw ~]# yum install epel-release [root@gw ~]# yum install phpldapadmin äº‹å®ä¸Šï¼Œè¿™ä¸ä»…å®‰è£…äº† phpldapadminï¼Œè¿˜å®‰è£…äº† httpã€php ç­‰ç›¸å…³çš„ä¾èµ–ã€‚phpldapadmin å…¶å®å°±æ˜¯è¿è¡Œåœ¨ httpd ç¨‹åºçš„ php æ¨¡å—ä¸Šçš„ä¸€ä¸ª php åº”ç”¨ã€‚\nä¿®æ”¹ httpd é…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹ httpd ä¸ phpldapadmin é›†æˆçš„é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@gw ~]# vim /etc/httpd/conf.d/phpldapadmin.conf Alias /phpldapadmin /usr/share/phpldapadmin/htdocs Alias /ldapadmin /usr/share/phpldapadmin/htdocs \u0026lt;Directory /usr/share/phpldapadmin/htdocs\u0026gt; \u0026lt;IfModule mod_authz_core.c\u0026gt; # Apache 2.4 Require all granted \u0026lt;/IfModule\u0026gt; \u0026lt;IfModule !mod_authz_core.c\u0026gt; # Apache 2.2 Order Deny,Allow Deny from all Allow from 127.0.0.1 Allow from ::1 \u0026lt;/IfModule\u0026gt; \u0026lt;/Directory\u0026gt; ä¿®æ”¹ phpldapadmin çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 [root@gw ~]# vim /etc/phpldapadmin/config.php \u0026lt;?php $config-\u0026gt;custom-\u0026gt;session[\u0026#39;blowfish\u0026#39;] = \u0026#39;036b0f2d39d36791dd3a8effa7c3411f\u0026#39;; # å€¼æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ $config-\u0026gt;custom-\u0026gt;appearance[\u0026#39;hide_template_warning\u0026#39;] = true; # é¿å…ä¸å¿…è¦çš„å‘Šè­¦ä¿¡æ¯æç¤º $config-\u0026gt;custom-\u0026gt;appearance[\u0026#39;minimalMode\u0026#39;] = true; # ä¸è¦é¡µé¢å¤´å’Œæ³¨è„šï¼Œä½¿é¡µé¢æ›´ç®€æ´ $config-\u0026gt;custom-\u0026gt;appearance[\u0026#39;friendly_attrs\u0026#39;] = array( \u0026#39;facsimileTelephoneNumber\u0026#39; =\u0026gt; \u0026#39;Fax\u0026#39;, \u0026#39;gid\u0026#39; =\u0026gt; \u0026#39;Group\u0026#39;, \u0026#39;mail\u0026#39; =\u0026gt; \u0026#39;Email\u0026#39;, \u0026#39;telephoneNumber\u0026#39; =\u0026gt; \u0026#39;Telephone\u0026#39;, \u0026#39;uid\u0026#39; =\u0026gt; \u0026#39;User Name\u0026#39;, \u0026#39;userPassword\u0026#39; =\u0026gt; \u0026#39;Password\u0026#39; ); $servers = new Datastore(); $servers-\u0026gt;newServer(\u0026#39;ldap_pla\u0026#39;); $servers-\u0026gt;setValue(\u0026#39;server\u0026#39;,\u0026#39;name\u0026#39;,\u0026#39;Local LDAP Server\u0026#39;); $servers-\u0026gt;setValue(\u0026#39;server\u0026#39;,\u0026#39;host\u0026#39;,\u0026#39;172.31.2.6\u0026#39;); # LDAPæœåŠ¡å™¨çš„åœ°å€ $servers-\u0026gt;setValue(\u0026#39;server\u0026#39;,\u0026#39;port\u0026#39;,389); $servers-\u0026gt;setValue(\u0026#39;server\u0026#39;,\u0026#39;base\u0026#39;,array(\u0026#39;dc=example,dc=com\u0026#39;)); # LDAPåŸŸçš„base DNs $servers-\u0026gt;setValue(\u0026#39;login\u0026#39;,\u0026#39;auth_type\u0026#39;,\u0026#39;session\u0026#39;); $servers-\u0026gt;setValue(\u0026#39;appearance\u0026#39;,\u0026#39;password_hash\u0026#39;,\u0026#39;\u0026#39;); $servers-\u0026gt;setValue(\u0026#39;login\u0026#39;,\u0026#39;attr\u0026#39;,\u0026#39;dn\u0026#39;); # å–æ¶ˆæ³¨é‡Š // $servers-\u0026gt;setValue(\u0026#39;login\u0026#39;,\u0026#39;attr\u0026#39;,\u0026#39;uid\u0026#39;); # æ·»åŠ æ³¨é‡Š $servers-\u0026gt;setValue(\u0026#39;unique\u0026#39;,\u0026#39;attrs\u0026#39;,array(\u0026#39;uid\u0026#39;,\u0026#39;sn\u0026#39;)); ?\u0026gt; ç”¨æˆ·ç™»å½•æ–¹å¼ï¼Œåœ¨æ­¤æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ dn æ–¹å¼è¿›è¡Œç™»å½•ï¼Œphpldapadmin é»˜è®¤ä½¿ç”¨çš„æ˜¯ uid æ–¹å¼è¿›è¡Œç™»å½•ã€‚\nunique å”¯ä¸€æ€§ï¼Œåœ¨æ­¤æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ uid å’Œ sn ä½œä¸ºå”¯ä¸€çš„æ ‡å¿—ï¼Œè¿™ä¸ªä¸€å®šè¦æ³¨æ„ä¸‹ã€‚ç‰¹åˆ«æ˜¯ä»ä¸€ä¸ªç”¨æˆ·å¤åˆ¶ä¸ºå¦å¤–ä¸€ä¸ªç”¨æˆ·æ—¶ï¼Œè¦ä½¿ç”¨åˆ°è¯¥é…ç½®ã€‚\nå¯åŠ¨ httpdï¼š\n1 2 [root@gw ~]# systemctl start httpd [root@gw ~]# systemctl enable httpd è®¿é—® phpLDAPadmin è®¿é—® phpLDAPadmin åœ°å€ http://â€‹server_ip**â€‹ /ldapadmin/ ï¼š ä¸Šè¿°æˆªå›¾ä¸­ï¼Œç™»å½• DNï¼Œå¦‚æœæ˜¯ OpenLDAP ç®¡ç†å‘˜ç™»å½•çš„è¯ï¼Œä½¿ç”¨ cn=Manager,dc=example,dc=comã€‚\nå¦‚æœæ˜¯ OpenLDAP æ™®é€šç”¨æˆ·ç™»å½•çš„è¯ï¼Œä½¿ç”¨ uid=tecmint,ou=People,dc=example,dc=comã€‚\n","date":"2024-05-16T15:44:43Z","image":"https://www.ownit.top/title_pic/76.jpg","permalink":"https://www.ownit.top/p/202405161544/","title":"ç”Ÿäº§ç¯å¢ƒ OpenLDAP éƒ¨ç½²æµç¨‹"},{"content":"é»‘çŒ«æŠ•è¯‰å¹³å°ï¼Œèˆ†è®ºç›‘æ§ç³»ç»Ÿ BuzzMonitor https://github.com/nangongchengfeng/BuzzMonitor.git\nç®€ä»‹ \u0026ldquo;é»‘çŒ«æŠ•è¯‰\u0026quot;èˆ†è®ºç›‘æ§ç³»ç»Ÿæ˜¯ä¸€æ¬¾ä¸“ä¸ºå¿«é€Ÿè¯†åˆ«å’Œå“åº”ç½‘ç»œæŠ•è¯‰è€Œè®¾è®¡çš„åº”ç”¨ï¼Œæ—¨åœ¨å¸®åŠ©ä¼ä¸šæˆ–æœºæ„ç¬¬ä¸€æ—¶é—´æŒæ¡å…¬ä¼—æ„è§å’Œåé¦ˆã€‚é€šè¿‡å®æ—¶ç›‘æ§ç½‘ç«™åŠå…¶ä»–åœ¨çº¿å¹³å°ï¼Œç³»ç»Ÿèƒ½å¤Ÿè¿…é€Ÿä¾¦æµ‹åˆ°å…³äºå“ç‰Œæˆ–æœåŠ¡çš„è´Ÿé¢è¯„è®ºã€æŠ•è¯‰æˆ–æè®®ã€‚ æµç¨‹ å‚è€ƒæ–‡æ¡£ï¼šhttps://blog.csdn.net/qq_45270849/article/details/135416529\né’ˆå¯¹ä¼ä¸šå…¬å¸å…³é”®å­— æ¯”å¦‚ï¼šç¾å›¢å¤–å–\n1ã€æ‰“å¼€é¡µé¢ https://tousu.sina.com.cn/company/view/?couid=1003626\u0026sid=26857\n2ã€æ‰¾åˆ°å•†å®¶åˆ—è¡¨ï¼Œè·å–åˆ°couidçš„å€¼ï¼Œè¿™å°±æ˜¯å…³é”®å­—\n3ã€æ ¹æ®å…³é”®å­—ç»„åˆï¼Œè§£å¯†è·å–åˆ°apiæ¥å£çš„æ•°æ®\nå®šæ—¶ä»»åŠ¡ çˆ¬è™«æ˜¯å®šæ—¶ä»»åŠ¡é©±åŠ¨ï¼Œä½¿ç”¨apscheduler\n1 2 3 4 5 6 7 8 9 # åˆ›å»ºä¸€ä¸ªåå°è°ƒåº¦å™¨ scheduler = BackgroundScheduler(timezone=\u0026#34;Asia/Shanghai\u0026#34;) # æ·»åŠ ä¸€ä¸ªæ¯éš”20ç§’æ‰§è¡Œä¸€æ¬¡çš„å®šæ—¶ä»»åŠ¡ æµ‹è¯• scheduler.add_job(func=send_alert, trigger=\u0026#34;interval\u0026#34;, seconds=20) # æ·»åŠ ä¸€ä¸ªæ¯éš”10åˆ†é’Ÿ æ‰§è¡Œçš„å®šæ—¶ä»»åŠ¡ scheduler.add_job(func=get_heimao, trigger=CronTrigger(minute=\u0026#39;*/10\u0026#39;)) # å¯åŠ¨è°ƒåº¦å™¨ scheduler.start() return app å‘é€é’‰é’‰å‘Šè­¦ ä½¿ç”¨æ–¹å¼ 1ã€æ•°æ®åº“åˆ›å»ºæ•°æ®åº“åç§°å’Œæ‰§è¡Œå‘½ä»¤ 1 2 3 4 5 6 7 8 9 10 11 12 pip3 install Flask-Migrate åˆå§‹åŒ–(åªéœ€è¦æ‰§è¡Œä¸€æ¬¡) flask db init ç”Ÿæˆæ–‡ä»¶ flask db migrate è¿ç§»æ•°æ®åº“ flask db upgrade è®°å¾— ï¼ˆæˆ‘å·²ç»å¯¼å…¥ï¼‰ åªéœ€è¦åœ¨ app.py ä¸­å¯¼å…¥ models.py ä¸­çš„ç±»å³å¯ã€‚ è€Œä¸”å¯¼å…¥å…¨éƒ¨å’Œå¯¼å…¥ä¸€ä¸ªï¼Œç»“æœéƒ½æ˜¯å¯ä»¥å¯¹æ‰€æœ‰çš„è¡¨è¿›è¡Œåˆ›å»ºã€‚ 2ã€è®¾ç½®çˆ¬è™«çš„ä¿¡æ¯ æ¥å£åˆ†é¡µè·å–æ•°æ®åº“å†…å®¹ 1 2 3 4 5 6 http://127.0.0.1:5000/info/ # é»˜è®¤å€¼ page = int(request.args.get(\u0026#39;page\u0026#39;, 1)) per_page = int(request.args.get(\u0026#39;per_page\u0026#39;, 10)) ","date":"2024-04-24T22:31:16Z","image":"https://www.ownit.top/title_pic/49.jpg","permalink":"https://www.ownit.top/p/202404242231/","title":"Pythonå®ç°â€œé»‘çŒ«æŠ•è¯‰å¹³å°ï¼Œèˆ†è®ºç›‘æ§ç³»ç»Ÿâ€"},{"content":"ESçš„å¤‡ä»½ï¼šESå¿«ç…§å¤‡ä»½ æ ¹æ®æ—¶é—´ï¼Œæ¯å¤©é›¶ç‚¹åœ¨Linuxæœºå™¨crontabæ¥è°ƒç”¨apiæ¥å£å®ç°å¿«ç…§å¤‡ä»½ï¼Œé€šè¿‡å¿«ç…§å¤‡ä»½ï¼Œå¯ä»¥å®šå‡†æ¢å¤åˆ°æŸä¸€å¤©çš„æ—¥å¿—ã€‚ ç°è±¡ï¼šï¼ˆå‘ï¼šä½†æ˜¯æ¢å¤æŸä¸€å¤©æ—¥å¿—ï¼Œå‘ç°ä¼šå°‘8å°æ—¶çš„æ—¥å¿—ï¼ŒåŸºæœ¬æ˜¯ï¼š0:00 - 08:00 æ—¶é—´æ®µï¼‰\n1ã€å¼•è¨€ï¼š åœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒELKï¼ˆElasticsearchã€Logstashã€Kibanaï¼‰æ ˆå·²æˆä¸ºæ—¥å¿—ç®¡ç†å’Œåˆ†æçš„æ ‡å‡†å·¥å…·é›†ã€‚ç„¶è€Œï¼Œå®é™…éƒ¨ç½²ä¸è¿ç»´è¿‡ç¨‹ä¸­ï¼Œå¾€å¾€ä¼šé­é‡å„ç§æŒ‘æˆ˜ï¼Œå…¶ä¸­æ—¶åŒºé—®é¢˜å¯¼è‡´çš„æ—¥å¿—æ—¶é—´æ»åå°¤ä¸ºå¸¸è§ã€‚æœ¬æ–‡å°†èšç„¦äºè§£å†³ELKæ—¥å¿—æ”¶é›†ä¸å¤‡ä»½è¿‡ç¨‹ä¸­å‡ºç°çš„æ»å8å°æ—¶ç­‰æ—¶åŒºé—®é¢˜ï¼Œåˆ†äº«å®æˆ˜ç»éªŒä¸å¡«å‘ç­–ç•¥ã€‚\n2ã€é—®é¢˜ç°è±¡ä¸åŸå›  1ã€å‰–ææ»å8å°æ—¶æ—¶åŒº ç°è±¡æè¿°ï¼šåœ¨Kibanaä¸Šè§‚å¯Ÿåˆ°çš„ä¸€ä¸ªå…¸å‹ç°è±¡æ˜¯ï¼Œå³ä½¿æ—¥å¿—äº‹ä»¶æ˜¯åœ¨å½“åœ°æ—¶é—´ä¸Šåˆ9ç‚¹å‘ç”Ÿçš„ï¼Œä½†åœ¨æ—¥å¿—ç³»ç»Ÿä¸­æ˜¾ç¤ºçš„æ—¶é—´å´æ˜¯ä¸‹åˆ5ç‚¹ã€‚è¿™ç§æ—¶å·®é—®é¢˜ä¼šå¯¼è‡´è¿ç»´å›¢é˜Ÿåœ¨å®æ—¶ç›‘æ§å’Œå“åº”ä¸­é­é‡ä¸å°‘å›°éš¾ï¼Œå› ä¸ºæ‰€æœ‰çš„æ—¥å¿—æ•°æ®éƒ½æ˜¾ç¤ºä¸º8å°æ—¶å‰çš„äº‹ä»¶ã€‚\né—®é¢˜æ ¹æº\nè¿™ä¸€é—®é¢˜é€šå¸¸ç”±ä»¥ä¸‹å‡ ä¸ªå› ç´ é€ æˆï¼š\næ—¥å¿—æºç«¯æ—¶åŒºè®¾ç½®é”™è¯¯ï¼š æ—¥å¿—ç”Ÿæˆæ—¶ï¼Œå¾ˆå¤šç³»ç»Ÿé»˜è®¤ä½¿ç”¨æ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´ï¼ˆGMTï¼‰æ¥è®°å½•æ—¶é—´æˆ³ï¼Œè€Œä¸æ˜¯å½“åœ°æ—¶é—´ã€‚å¦‚æœæ—¥å¿—æºè®¾å¤‡æˆ–æœåŠ¡çš„æ—¶åŒºè®¾ç½®ä¸æ­£ç¡®ï¼Œæˆ–æœªæ˜ç¡®æŒ‡å®šæ—¶åŒºï¼Œå°±ä¼šåœ¨æºå¤´äº§ç”Ÿæ—¶é—´åå·®ã€‚\nä¼ è¾“è¿‡ç¨‹ä¸­çš„æ—¶åŒºå¤„ç†ä¸å½“ï¼š åœ¨æ—¥å¿—æ•°æ®çš„æ”¶é›†è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½¿ç”¨Logstashæˆ–Filebeatç­‰å·¥å…·ï¼Œè‹¥è¿™äº›å·¥å…·æ²¡æœ‰è¢«æ­£ç¡®é…ç½®ä¸ºè½¬æ¢æˆ–è¯†åˆ«æ­£ç¡®çš„æ—¶åŒºï¼Œå®ƒä»¬åœ¨å¤„ç†æ—¥å¿—æ—¶ä¼šç»§ç»­ä½¿ç”¨GMTæ—¶é—´æˆ³ï¼Œä»è€Œè¿›ä¸€æ­¥ä¼ é€’é”™è¯¯çš„æ—¶é—´ä¿¡æ¯ã€‚\nElasticsearchå­˜å‚¨ä¸å±•ç¤ºçš„æ—¶åŒºé…ç½®ä¸å½“ï¼š Elasticsearchåœ¨å­˜å‚¨æ—¶é—´æ•°æ®æ—¶ï¼Œé»˜è®¤ä½¿ç”¨UTCæ—¶é—´ã€‚å¦‚æœåœ¨Elasticsearchæˆ–Kibanaä¸­æ²¡æœ‰è®¾ç½®æ­£ç¡®çš„æ—¶åŒºï¼Œå³ä½¿åŸå§‹æ—¥å¿—çš„æ—¶é—´æˆ³æ˜¯æ­£ç¡®çš„ï¼Œå±•ç¤ºæ—¶ä¹Ÿä¼šå› ä¸ºæ—¶åŒºè½¬æ¢é”™è¯¯è€Œå¯¼è‡´æ—¶é—´æ˜¾ç¤ºä¸æ­£ç¡®\n2ã€æ—¶åŒºé—®é¢˜æ‹†è§£ Elasticserch é»˜è®¤æ—¶åŒºæ˜¯ï¼Ÿèƒ½æ”¹å—ï¼Ÿ å®˜æ–¹æ–‡æ¡£å¼ºè°ƒï¼šåœ¨ Elasticsearch å†…éƒ¨ï¼Œæ—¥æœŸè¢«è½¬æ¢ä¸º UTCæ—¶åŒºå¹¶å­˜å‚¨ä¸ºä¸€ä¸ªè¡¨ç¤ºè‡ª1970-01-01 00:00:00 ä»¥æ¥ç»è¿‡çš„æ¯«ç§’æ•°çš„å€¼ã€‚\nInternally, dates are converted to UTC (if the time-zone is specified) and stored as a long number representing milliseconds-since-the-epoch.\nhttps://www.elastic.co/guide/en/elasticsearch/reference/current/date.html\nElasticsearch date ç±»å‹é»˜è®¤æ—¶åŒºï¼šUTCã€‚\næ­£å¦‚å®˜æ–¹å·¥ç¨‹å¸ˆå¼ºè°ƒï¼ˆå¦‚ä¸‹æˆªå›¾æ‰€ç¤ºï¼‰ï¼šElasticsearch é»˜è®¤æ—¶åŒºä¸å¯ä»¥ä¿®æ”¹ https://discuss.elastic.co/t/index-creates-in-different-timezone-other-than-utc/148941ä½†ï¼Œæˆ‘ä»¬å¯ä»¥â€œæ›²çº¿æ•‘å›½â€ï¼Œé€šè¿‡ï¼š\ningest pipeline é¢„å¤„ç†æ–¹å¼å†™å…¥çš„æ—¶å€™ä¿®æ”¹æ—¶åŒºï¼› logstash filter ç¯èŠ‚åšæ—¶åŒºè½¬æ¢ï¼› æŸ¥è¯¢æ—¶æŒ‡å®šæ—¶åŒºï¼› èšåˆæ—¶æŒ‡å®šæ—¶åŒºã€‚\nKibana é»˜è®¤æ—¶åŒºæ˜¯ï¼Ÿèƒ½æ”¹å—ï¼Ÿ kibana é»˜è®¤æ—¶åŒºæ˜¯æµè§ˆå™¨æ—¶åŒºã€‚å¯ä»¥ä¿®æ”¹ï¼Œä¿®æ”¹æ–¹å¼å¦‚ä¸‹ï¼šStack Management -\u0026gt; Advanced Settings -\u0026gt;Timezone for data formatting. Logstash é»˜è®¤æ—¶åŒºæ˜¯ï¼Ÿèƒ½æ”¹å—ï¼Ÿ\né»˜è®¤ï¼šUTCã€‚å¯ä»¥é€šè¿‡ä¸­é—´ï¼šfilter ç¯èŠ‚è¿›è¡Œæ—¥æœŸæ•°æ®å¤„ç†ï¼ŒåŒ…æ‹¬ï¼šè½¬æ—¶åŒºæ“ä½œã€‚ logstash é»˜è®¤ UTC æ—¶åŒºã€‚ Elasticsearch é»˜è®¤ UTC æ—¶åŒºã€‚ Kibana é»˜è®¤æµè§ˆå™¨æ—¶åŒºï¼ŒåŸºæœ¬æˆ‘ä»¬ç”¨å°±æ˜¯ï¼šä¸œå…«åŒºã€‚ å¦‚æœåŸºäºMysql åŒæ­¥æ•°æ®ï¼ŒMysql æ•°æ®æ˜¯ï¼šä¸œå…«åŒºã€‚ 3ã€å¡«å‘å®æˆ˜ä¸è§£å†³æ–¹æ¡ˆ åŸºäºä¸Šé¢çš„åˆ†æï¼Œå¦‚ä½•è§£å†³æ—¶åŒºé—®é¢˜å‘¢ï¼Ÿã€‚ å®æˆ˜é¡¹ç›®ä¸­ï¼Œæ—¶é—´é—®é¢˜å°±è½¬å«ä¸ºï¼šå†™å…¥çš„æ—¶å€™è½¬æ¢æˆç»™å®šæ—¶åŒºï¼ˆå¦‚ï¼šä¸œ8åŒºï¼‰å°±å¯ä»¥ã€‚ 1ã€æŸ¥çœ‹æœºå™¨çš„æ—¶åŒºå’Œæ—¥å¿—\n1 2 / # date Mon Apr 15 11:21:29 CST 2024 2ã€Filebeaet æ”¶é›†é…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 filebeat.inputs: - type: log enabled: true paths: - /app/logs/app/*.log multiline.pattern: ^\\d{4}-\\d{2}-\\d{2}\\s\\d{2}:\\d{2}:\\d{2}[.,:]0{0,1}\\d{3} multiline.negate: true multiline.match: after fields: logtype: ${LOGTYPE:app} fields_under_root: true fields: ip: ${POD_IP} output.logstash: hosts: [\u0026#34;logstash-server.default.svc.cloudcs.fjf:5044\u0026#34;] 3ã€logstash ä¸­é—´ filter ç¯èŠ‚å¤„ç† æ•°æ®æºç«¯ï¼šAPPæ—¥å¿—ï¼› æ•°æ®ç›®çš„ç«¯ï¼šElasticsearchï¼› åŒæ­¥æ–¹å¼ï¼šlogstashï¼Œæœ¬è´¨å€ŸåŠ©ï¼šlogstash_input_jdbc æ’ä»¶åŒæ­¥ï¼› æ—¶åŒºå¤„ç†ï¼šlogstash filter ç¯èŠ‚ ruby è„šæœ¬å¤„ç†ã€‚\n1 2 {\u0026#34;@timestamp\u0026#34;:\u0026#34;2024-04-15T10:48:34.518811962+08:00\u0026#34;,\u0026#34;severity\u0026#34;:\u0026#34;INFO\u0026#34;,\u0026#34;service\u0026#34;:\u0026#34;cat-outer-gateway\u0026#34;,\u0026#34;trace\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;span\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;parent\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;exportable\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;pid\u0026#34;:\u0026#34;1\u0026#34;,\u0026#34;thread\u0026#34;:\u0026#34;reactor-http-epoll-2\u0026#34;,\u0026#34;class\u0026#34;:\u0026#34;c.fujfu.gateway.filter.CallBackUriFilter\u0026#34;,\u0026#34;rest\u0026#34;:\u0026#34;path:/cat-payment-dock/api/minSheng/notify,method:POST\\n\u0026#34;} {\u0026#34;@timestamp\u0026#34;:\u0026#34;2024-04-15T10:55:29.711692942+08:00\u0026#34;,\u0026#34;severity\u0026#34;:\u0026#34;INFO\u0026#34;,\u0026#34;service\u0026#34;:\u0026#34;cat-outer-gateway\u0026#34;,\u0026#34;trace\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;span\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;parent\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;exportable\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;pid\u0026#34;:\u0026#34;1\u0026#34;,\u0026#34;thread\u0026#34;:\u0026#34;reactor-http-epoll-4\u0026#34;,\u0026#34;class\u0026#34;:\u0026#34;c.fujfu.gateway.filter.CallBackUriFilter\u0026#34;,\u0026#34;rest\u0026#34;:\u0026#34;path:/cat-payment-dock/api/minSheng/notify,method:POST\\n\u0026#34;} 1 2 2024-04-15 11:32:57.582 INFO [HzgDfyOvQqCH4DsY5Al7Jw] 1 --- [nio-8050-exec-9] c.f.f.s.impl.FpProductCfgServiceImpl : capitalId:1724007481146916866-è¯¥ç”¨æˆ·æ¸ é“è¢«é™åˆ¶ï¼ŒchannelCodeList:[huawei, oppo, vivo, xiaomi, yingyongbao, yingyongbaotuiguang, Android_oppo, Android_yingyongbao, Android_huawei, Android_xiaomi, FYH-rongyao, FYH-vivo, FYH-xiaomi, FYH-huawei] ,userReqVO.getRegisterChannel():huawei 2024-04-15 11:32:57.695 INFO [TtPg4TgCQI+MFkLxSCZzMA] 1 --- [nio-8050-exec-2] c.f.f.s.f.request.JUZIFundProductCaller : ã€æ¡”å­æ•°ç§‘ã€‘è¯·æ±‚æ˜æ–‡ï¼šhttps://api-gateway.jzhlkj.com/bus/standard/credit/queryQuotaï¼Œå‚æ•°ï¼š{\u0026#34;channelUid\u0026#34;:\u0026#34;29443d29067c4182baec1115026cf8d5\u0026#34;} ä¸‹æ–¹çš„è„šæœ¬å°±å®ç°æ”¶é›†ä¸Šæ–¹ä¸¤ç§æ—¥å¿—æ ¼å¼ å’Œ å†™å…¥çš„æ—¶å€™è½¬æ¢æˆç»™å®šæ—¶åŒºè¿™ä¸ªåŠŸèƒ½ã€‚\ndate çš„æ•°æ® å°±æ˜¯ ä¸œå…«åŒº çš„æ—¶é—´ã€‚æˆ‘ç›´æ¥æŠŠ ä¸œå…«åŒºçš„æ—¶é—´ å†™å…¥@timestamp åœ¨ä¼ å…¥åˆ°ESï¼ˆä¸œå…«åŒºï¼‰ ã€‚ç„¶ååœ¨ Kibanaä¸­è®¿é—® ä¹Ÿæ˜¯ä¸œå…«åŒºï¼Œå½¢æˆä¸€ä¸ªé—­ç¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 input { beats { port =\u0026gt; 5044 } } filter { if [fields][json] == \u0026#34;true\u0026#34; { json { source =\u0026gt; \u0026#34;message\u0026#34; remove_field =\u0026gt; [\u0026#34;message\u0026#34;,\u0026#34;agent\u0026#34;,\u0026#34;tags\u0026#34;,\u0026#34;ecs\u0026#34;] add_field =\u0026gt; { \u0026#34;loglevel\u0026#34; =\u0026gt; \u0026#34;%{[severity]}\u0026#34; } } } else if [fields][logtype] == \u0026#34;powerjob\u0026#34; { grok { match =\u0026gt; { \u0026#34;message\u0026#34; =\u0026gt; \u0026#34;%{TIMESTAMP_ISO8601:date} \\s{0,1}(?\u0026lt;severity\u0026gt;.*?) (?\u0026lt;pid\u0026gt;.*?) --- \\[(?\u0026lt;thread\u0026gt;.*?)\\] (?\u0026lt;class\u0026gt;.*?) \\s*: (?\u0026lt;rest\u0026gt;.*+?)\u0026#34; } remove_field =\u0026gt; [\u0026#34;message\u0026#34;,\u0026#34;agent\u0026#34;,\u0026#34;tags\u0026#34;] add_field =\u0026gt; { \u0026#34;loglevel\u0026#34; =\u0026gt; \u0026#34;%{[severity]}\u0026#34; } } mutate { update =\u0026gt; { \u0026#34;[fields][logtype]\u0026#34; =\u0026gt; \u0026#34;logstash\u0026#34; } } } else { grok { match =\u0026gt; { \u0026#34;message\u0026#34; =\u0026gt; [ \u0026#34;%{TIMESTAMP_ISO8601:date} (?\u0026lt;loglevel\u0026gt;.*?)\\s{1,2}\\| \\[(?\u0026lt;threadname\u0026gt;.*?)\\] (?\u0026lt;classname\u0026gt;.*?) \\[(?\u0026lt;codeline\u0026gt;.*?)\\] \\| \\[(?\u0026lt;traceid\u0026gt;.*?)\\] \\| (?\u0026lt;msg\u0026gt;.*+?)\u0026#34;, \u0026#34;%{TIMESTAMP_ISO8601:date} (?\u0026lt;loglevel\u0026gt;.*?)\\s{1,2}\\| \\[(?\u0026lt;threadname\u0026gt;.*?)\\] (?\u0026lt;classname\u0026gt;.*?) \\[(?\u0026lt;codeline\u0026gt;.*?)\\] \\| (?\u0026lt;msg\u0026gt;.*+?)\u0026#34;, \u0026#34;\\[%{TIMESTAMP_ISO8601:date}\\] \\[(?\u0026lt;loglevel\u0026gt;.*?)\\s{0,2}\\] \\[(?\u0026lt;threadname\u0026gt;.*?)\\] (?\u0026lt;classname\u0026gt;.*?) (?\u0026lt;codeline\u0026gt;.*?) - (?\u0026lt;msg\u0026gt;.*+?)\u0026#34;, \u0026#34;%{TIMESTAMP_ISO8601:date} \\[(?\u0026lt;threadname\u0026gt;.*?)\\] (?\u0026lt;loglevel\u0026gt;.*?)\\s{0,2} (?\u0026lt;classname\u0026gt;.*?) (?\u0026lt;codeline\u0026gt;.*?) - (?\u0026lt;msg\u0026gt;.*+?)\u0026#34;, \u0026#34;\\[%{TIMESTAMP_ISO8601:date}\\] \\[\\s{0,2}(?\u0026lt;loglevel\u0026gt;.*?)\\] \\[(?\u0026lt;threadid\u0026gt;.*?)\\] \\[(?\u0026lt;threadname\u0026gt;.*?)\\] \\[(?\u0026lt;classname\u0026gt;.*?)\\] : (?\u0026lt;msg\u0026gt;.*+?)\u0026#34; ]} remove_field =\u0026gt; [\u0026#34;message\u0026#34;,\u0026#34;agent\u0026#34;,\u0026#34;tags\u0026#34;] } } ruby { code =\u0026gt;\u0026#39; arr = event.get(\u0026#34;host\u0026#34;)[\u0026#34;name\u0026#34;].split(\u0026#34;.\u0026#34;)[0] event.set(\u0026#34;projectname\u0026#34;,arr) \u0026#39; } date { match =\u0026gt; [\u0026#34;date\u0026#34;,\u0026#34;ISO8601\u0026#34;,\u0026#34;yyyy-MM-dd HH:mm:ss.SSS\u0026#34;] #è·å–dateçš„æ—¶é—´ target =\u0026gt; \u0026#34;@timestamp\u0026#34; # å¤åˆ¶ç»™@timestamp å­—æ®µ timezone =\u0026gt; \u0026#34;Asia/Shanghai\u0026#34; # è®¾ç½® ä¸Šæµ·åœ°åŒº } } output { elasticsearch { hosts =\u0026gt; [\u0026#34;elasticsearch-log.prod.server.fjf:9200\u0026#34;] user =\u0026gt; \u0026#34;xxxxx\u0026#34; password =\u0026gt; \u0026#34;xxxxx\u0026#34; manage_template =\u0026gt; false index =\u0026gt; \u0026#34;%{[fields][logtype]}-prod-%{+YYYY.MM.dd}\u0026#34; } } ä¿®æ”¹å‰\nä¿®æ”¹å 4ã€æ€»ç»“ æ•°æ®å†™å…¥æ—¶é—´ä¸ä¸€è‡´ã€æ•°æ®æ»å8å°æ—¶ç­‰æ—¶åŒºé—®é¢˜çš„æœ¬è´¨æ˜¯ï¼šå„ä¸ªå¤„ç†ç«¯æ—¶åŒºä¸ä¸€è‡´ï¼Œå†™å…¥æºçš„æ—¶åŒºã€Kibanaé»˜è®¤æ˜¯æœ¬åœ°æ—¶åŒºï¼ˆå¦‚ä¸­å›½ä¸ºï¼šä¸œ8åŒºæ—¶åŒºï¼‰ï¼Œè€Œ logstashã€Elasticsearch æ˜¯UTCæ—¶åŒºã€‚\nå‚è€ƒæ–‡æ¡£ï¼šhttps://www.cnblogs.com/fat-girl-spring/p/15122906.html\n","date":"2024-04-15T11:39:49Z","image":"https://www.ownit.top/title_pic/30.jpg","permalink":"https://www.ownit.top/p/202404151139/","title":"ELKæ—¥å¿—æ”¶é›†å’Œå¤‡ä»½å¡«å‘å®æˆ˜ ï¼ˆæ»å8ä¸ªå°æ—¶ç­‰æ—¶åŒºé—®é¢˜ï¼‰"},{"content":"ä»‹ç» åœ¨ä¼ ç»Ÿçš„ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œåº”ç”¨å¾®æœåŠ¡åŒ–åï¼Œéœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£æ¥å°†å„ä¸ªæœåŠ¡è¿›è¡Œæ•´åˆï¼Œè¿™ä¸ªå…¥å£å¯ä»¥æ˜¯Nginxã€Apacheã€HAproxyç­‰ç­‰ã€‚è€Œåœ¨K8sä¸­ï¼ŒåŒæ ·éœ€è¦ä¸€ä¸ªå·¥å…·æ¥å°†åº”ç”¨çš„å„ä¸ªserviceæ•´åˆåˆ°ç»Ÿä¸€çš„å…¥å£ï¼Œè¿™ä¸ªå·¥å…·å°±å«Ingressæ§åˆ¶å™¨ï¼ŒIngressçš„ä¸­æ–‡ç¿»è¯‘å³ä¸ºâ€œå…¥å£â€ã€‚\nIngress-nginxï¼š å®ƒæ˜¯ç”±Kubernetesç¤¾åŒºåŸºäºNginx WebæœåŠ¡å™¨å¼€å‘çš„ï¼Œå¹¶è¡¥å……äº†ä¸€ç»„ç”¨äºå®ç°é¢å¤–åŠŸèƒ½çš„Luaæ’ä»¶ï¼Œä½œä¸ºâ€œå®˜æ–¹â€é»˜è®¤æ§åˆ¶å™¨æ”¯æŒå½“ç„¶æœ€ä¼˜ã€‚\nGithubâ€‹https://github.com/kubernetes/ingress-nginx\nè¯´æ˜æ–‡æ¡£â€‹https://kubernetes.github.io/ingress-nginx/deploy/\nNginx-ingress è¿™æ˜¯Nginxå®˜æ–¹ç¤¾åŒºå¼€å‘äº§å“ï¼ŒNginx ingresså…·æœ‰å¾ˆé«˜çš„ç¨³å®šæ€§ï¼ŒæŒç»­çš„å‘åå…¼å®¹æ€§ï¼Œæ²¡æœ‰ä»»ä½•ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¹¶ä¸”ç”±äºæ¶ˆé™¤äº†Luaä»£ç è€Œä¿è¯äº†è¾ƒé«˜çš„é€Ÿåº¦ã€‚\nGithubâ€‹https://github.com/nginxinc/kubernetes-ingress\nè¯´æ˜æ–‡æ¡£â€‹https://docs.nginx.com/nginx-ingress-controller/installation/installation-with-manifests/ Nginx Ingress Controller åŸºäº Nginx å®ç°äº† Kubernetes Ingress APIï¼ŒNginx æ˜¯å…¬è®¤çš„é«˜æ€§èƒ½ç½‘å…³ï¼Œä½†å¦‚æœä¸å¯¹å…¶è¿›è¡Œä¸€äº›å‚æ•°è°ƒä¼˜ï¼Œå°±ä¸èƒ½å……åˆ†å‘æŒ¥å‡ºé«˜æ€§èƒ½çš„ä¼˜åŠ¿ã€‚Nginx Ingresså·¥ä½œåŸç†ï¼š Kubernetesä¸­ingress-nginxä¼˜åŒ–é…ç½® æè¿°: åœ¨K8sé›†ç¾¤ä¸­éƒ¨ç½²å®‰è£… ingress-nginx åé»˜è®¤å¹¶æœªè¿›è¡Œç›¸åº”çš„ä¼˜åŒ–é…ç½®ï¼Œæœ¬å°ç»“å°†é’ˆå¯¹äºç”Ÿäº§ç¯å¢ƒçš„ä¸­çš„ ingress-nginx æ§åˆ¶å™¨è¿›è¡Œä¼˜åŒ–ã€‚\næˆ‘ä»¬å¯ä»¥ä» ingress-nginx-controller èµ„æºçš„ Pod ã€ConfigMap ã€ä»¥åŠä¸šåŠ¡çš„ ingress è§„åˆ™å…¥æ‰‹ã€‚\næˆ‘ä»¬å½“æ—¶é»˜è®¤ç›´æ¥å®‰è£…ç¯å¢ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 kubectl get deployments.apps -n ingress-nginx ingress-nginx-controller # æ•´ä½“å°±è¿™ä¸ªæ ·å­ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•ä¼˜åŒ–ï¼Œæ€§èƒ½è‚¯å®šæ¬ ç¼º kubectl get deployments.apps -n ingress-nginx ingress-nginx-controller -o yaml apiVersion: apps/v1 kind: Deployment metadata: annotations: deployment.kubernetes.io/revision: \u0026#34;1\u0026#34; #æš´éœ²Prometheus ç«¯å£è¿›è¡Œç›‘æ§ prometheus.io/port: \u0026#34;10254\u0026#34; prometheus.io/scrape: \u0026#34;true\u0026#34; labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: ingress-nginx app.kubernetes.io/version: 1.0.0 helm.sh/chart: ingress-nginx-4.0.1 k8s.kuboard.cn/name: ingress-nginx-controller name: ingress-nginx-controller namespace: ingress-nginx resourceVersion: \u0026#34;91407609\u0026#34; uid: a5452fcf-f99c-4866-b0a1-93fe9e165cb6 spec: progressDeadlineSeconds: 600 replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx strategy: rollingUpdate: maxSurge: 25% maxUnavailable: 25% type: RollingUpdate template: metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx spec: containers: - args: - /nginx-ingress-controller - --election-id=ingress-controller-leader - --controller-class=k8s.io/ingress-nginx - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller - --validating-webhook=:8443 - --validating-webhook-certificate=/usr/local/certificates/cert - --validating-webhook-key=/usr/local/certificates/key - --watch-ingress-without-class=true env: - name: POD_NAME valueFrom: fieldRef: apiVersion: v1 fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: apiVersion: v1 fieldPath: metadata.namespace - name: LD_PRELOAD value: /usr/local/lib/libmimalloc.so image: willdockerhub/ingress-nginx-controller:v1.0.0 imagePullPolicy: IfNotPresent lifecycle: preStop: exec: command: - /wait-shutdown ........... åˆå§‹åŒ–Podå†…æ ¸å‚æ•° æ¸©é¦¨æç¤º: æˆ‘ä»¬éœ€è¦é’ˆå¯¹æ‰¿è½½ ingress-nginx çš„ç›¸å…³ Pod å®¹å™¨è¿›è¡Œå†…æ ¸å‚æ•°ä¼˜åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 # åœ¨ spec.template.spec å¯¹è±¡ä¸‹æ·»åŠ ä¸€ä¸ªåˆå§‹åŒ– initContainers å®¹å™¨ initContainers: - command: - /bin/sh - -c - | mount -o remount rw /proc/sys sysctl -w net.core.somaxconn=65535 sysctl -w net.ipv4.ip_local_port_range=\u0026#34;1024 65535\u0026#34; sysctl -w net.ipv4.tcp_tw_reuse=1 sysctl -w fs.file-max=1048576 sysctl -w fs.inotify.max_user_instances=16384 sysctl -w fs.inotify.max_user_watches=524288 sysctl -w fs.inotify.max_queued_events=16384 image: busybox:1.29.3 imagePullPolicy: IfNotPresent name: init-sysctl resources: {} securityContext: capabilities: add: - SYS_ADMIN drop: - ALL terminationMessagePath: /dev/termination-log terminationMessagePolicy: File #ä¿®æ”¹deployment kubectl edit deployments.apps -n ingress-nginx ingress-nginx-controller æ³¨æ„ï¼šå¦‚æœæŒ‰ç…§æ–‡æ¡£å®‰è£…ï¼ŒæŒ‡å®šæœºå™¨çš„è·‘ingresï¼Œä¼šè°ƒåº¦å¤±è´¥ï¼Œå› ä¸ºåŸå…ˆçš„podå·²ç»å ç”¨äº†80å’Œ443ç«¯å£ï¼ˆå”¯ä¸€æ–¹å¼ï¼šå…ˆåˆ é™¤podï¼ˆå…ˆæŠŠå‰¯æœ¬é‡ç½®ä¸º0ï¼Œä¿®æ”¹å®Œæ¯•ï¼Œåœ¨æ”¹æˆ1ï¼‰ï¼Œå†ä¿®æ”¹deploymentï¼‰\nç”±æ­¤çœ‹ï¼Œå®šåˆ¶åŒ–æœ‰ä¼˜åŠ¿ï¼Œä¹Ÿæœ‰åŠ£åŠ¿ã€‚\nå› ä¸ºä¸Šé¢çš„é”™è¯¯ï¼Œç»™æ— ç”Ÿæˆå¤§é‡çš„\nä¸»è¦æ˜¯è°ƒåº¦å¤±è´¥å¼•èµ·çš„ã€‚\n1 2 ingress-nginx-controller-5d9cbf7bd7-27q74 0/1 NodePorts 0 74s ingress-nginx-controller-5d9cbf7bd7-5lh9x 0/1 NodePorts 0 75s 1 2 æ‰¹é‡æ¸…é™¤ï¼ˆæ¸…é™¤å®Œæˆå¯èƒ½ä¸€ç›´å¡ï¼Œéœ€è¦è‡ªå·±çœ‹ä¸€ä¸‹æ•°é‡ï¼‰ kubectl get pods -n ingress-nginx -o custom-columns=NAME:.metadata.name,STATUS:.status.phase |grep \u0026#34;Failed\u0026#34; |awk \u0026#39;{print $1}\u0026#39; | xargs -r kubectl delete pod -n ingress-nginx Ingreeçš„ConfigMapä¼˜åŒ– æˆ‘ä»¬éœ€è¦æŒ‰ç…§éœ€è¦å°†ä¸‹è¿°K/Vé…ç½®é¡¹æ’å…¥åˆ° ingress-nginx çš„ configMap é‡Œçš„ data å¯¹è±¡ä¸‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 spec: containers: - args: - /nginx-ingress-controller - --election-id=ingress-controller-leader - --controller-class=k8s.io/ingress-nginx - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller - --validating-webhook=:8443 - --validating-webhook-certificate=/usr/local/certificates/cert - --validating-webhook-key=/usr/local/certificates/key - --watch-ingress-without-class=true ingress-nginx-controller è¿™ä¸€ä¸ªå°±æ˜¯ Ingreeçš„configmapçš„é…ç½®æ–‡ä»¶\ningress-nginx èµ„æºæŸ¥çœ‹\n1 2 # æŸ¥çœ‹ Ingress-nginx å…¨å±€é…ç½®å‚æ•°: kubectl get cm -n ingress-nginx ingress-nginx-controller -oyaml é»˜è®¤æ²¡æœ‰ä»»ä½•æ•°æ® ä¸‹é¢é¢æ˜¯dataçš„å†…å®¹ï¼Œéƒ¨åˆ†å¯ä»¥å†æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹\nåœ¨Ingress Nginxä¸­ï¼ŒConfigMapçš„ä¿®æ”¹å¯ä»¥å®ç°æ‰€è°“çš„\u0026quot;çƒ­åŠ è½½\u0026quot;ã€‚è¿™æ„å‘³ç€å½“ä½ æ›´æ”¹Ingress Nginxçš„ConfigMapæ—¶ï¼ŒIngressæ§åˆ¶å™¨èƒ½å¤Ÿæ¥æ”¶è¿™äº›æ›´æ”¹å¹¶åº”ç”¨å®ƒä»¬ï¼Œè€Œä¸éœ€è¦é‡å¯Podsã€‚æ§åˆ¶å™¨ä¼šç›‘å¬ConfigMapçš„å˜åŒ–ï¼Œå¹¶è‡ªåŠ¨æ›´æ–°å…¶é…ç½®ï¼Œä»è€Œåæ˜ å‡ºæ‰€åšçš„ä¿®æ”¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 [root@bt ingress]# kubectl apply -f ingress-nginx-controller.yaml #çƒ­åŠ è½½ä¸€ä¸‹ [root@bt ingress]# cat ingress-nginx-controller.yaml apiVersion: v1 data: compute-full-forwarded-for: \u0026#34;true\u0026#34; forwarded-for-header: X-Forwarded-For log-format-upstream: \u0026#39;{\u0026#34;@timestamp\u0026#34;:\u0026#34;$time_iso8601\u0026#34;,\u0026#34;time\u0026#34;:\u0026#34;$time_local\u0026#34;,\u0026#34;remote_addr\u0026#34;:\u0026#34;$remote_addr\u0026#34;,\u0026#34;http_x_forwarded_for\u0026#34;:\u0026#34;$http_x_forwarded_for\u0026#34;,\u0026#34;remote_port\u0026#34;:\u0026#34;$remote_port\u0026#34;,\u0026#34;remote_user\u0026#34;:\u0026#34;$remote_user\u0026#34;,\u0026#34;host\u0026#34;:\u0026#34;$host\u0026#34;,\u0026#34;upstream_addr\u0026#34;:\u0026#34;$upstream_addr\u0026#34;,\u0026#34;upstream_status\u0026#34;:\u0026#34;$upstream_status\u0026#34;,\u0026#34;upstream_response_time\u0026#34;:$upstream_response_time,\u0026#34;upstream_cache_status\u0026#34;:\u0026#34;$upstream_cache_status\u0026#34;,\u0026#34;request\u0026#34;:\u0026#34;$request\u0026#34;,\u0026#34;status\u0026#34;:\u0026#34;$status\u0026#34;,\u0026#34;request_time\u0026#34;:$request_time,\u0026#34;body_bytes_sent\u0026#34;:\u0026#34;$body_bytes_sent\u0026#34;,\u0026#34;http_referer\u0026#34;:\u0026#34;$http_referer\u0026#34;,\u0026#34;http_user_agent\u0026#34;:\u0026#34;$http_user_agent\u0026#34;}\u0026#39; proxy-body-size: 10g proxy-buffer-size: 256k proxy-connect-timeout: \u0026#34;90\u0026#34; proxy-read-timeout: \u0026#34;90\u0026#34; proxy-send-timeout: \u0026#34;90\u0026#34; use-forwarded-headers: \u0026#34;true\u0026#34; # å®¢æˆ·ç«¯è¯·æ±‚å¤´çš„ç¼“å†²åŒºå¤§å° client-header-buffer-size: \u0026#34;512k\u0026#34; # è®¾ç½®ç”¨äºè¯»å–å¤§å‹å®¢æˆ·ç«¯è¯·æ±‚æ ‡å¤´çš„æœ€å¤§å€¼numberå’Œsizeç¼“å†²åŒº large-client-header-buffers: \u0026#34;4 512k\u0026#34; # è¯»å–å®¢æˆ·ç«¯è¯·æ±‚bodyçš„ç¼“å†²åŒºå¤§å° client-body-buffer-size: \u0026#34;128k\u0026#34; # ä»£ç†ç¼“å†²åŒºå¤§å° proxy-buffer-size: \u0026#34;256k\u0026#34; # ä»£ç†bodyå¤§å° proxy-body-size: \u0026#34;50m\u0026#34; # æœåŠ¡å™¨åç§°å“ˆå¸Œå¤§å° server-name-hash-bucket-size: \u0026#34;128\u0026#34; # mapå“ˆå¸Œå¤§å° map-hash-bucket-size: \u0026#34;128\u0026#34; # SSLåŠ å¯†å¥—ä»¶ ssl-ciphers: \u0026#34;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA\u0026#34; # ssl åè®® ssl-protocols: \u0026#34;TLSv1 TLSv1.1 TLSv1.2\u0026#34; kind: ConfigMap metadata: labels: app: ingress-nginx name: ingress-nginx-controller namespace: ingress-nginx è¿™ä¸ªJson æ›´åŠ å…¨é¢ï¼Œå¯ä»¥æ¥å…¥ELKå±•ç¤º\n1 {\u0026#34;@timestamp\u0026#34;:\u0026#34;$time_iso8601\u0026#34;,\u0026#34;request_time\u0026#34;:\u0026#34;$request_time\u0026#34;,\u0026#34;status\u0026#34;:\u0026#34;$status\u0026#34;,\u0026#34;body_bytes_sent\u0026#34;:\u0026#34;$body_bytes_sent\u0026#34;,\u0026#34;bytes_sent\u0026#34;:\u0026#34;$bytes_sent\u0026#34;,\u0026#34;remote_addr\u0026#34;:\u0026#34;$remote_addr\u0026#34;,\u0026#34;remote_user\u0026#34;:\u0026#34;$remote_user\u0026#34;,\u0026#34;remote_port\u0026#34;:\u0026#34;$remote_port\u0026#34;,\u0026#34;request_uri\u0026#34;:\u0026#34;$request_uri\u0026#34;,\u0026#34;args\u0026#34;:\u0026#34;$args\u0026#34;,\u0026#34;request_id\u0026#34;:\u0026#34;$request_id\u0026#34;,\u0026#34;connection\u0026#34;:\u0026#34;$connection\u0026#34;,\u0026#34;connection_requests\u0026#34;:\u0026#34;$connection_requests\u0026#34;,\u0026#34;pid\u0026#34;:\u0026#34;$pid\u0026#34;,\u0026#34;request_length\u0026#34;:\u0026#34;$request_length\u0026#34;,\u0026#34;time_local\u0026#34;:\u0026#34;$time_local\u0026#34;,\u0026#34;http_referer\u0026#34;:\u0026#34;$http_referer\u0026#34;,\u0026#34;http_user_agent\u0026#34;:\u0026#34;$http_user_agent\u0026#34;,\u0026#34;http_x_forwarded_for\u0026#34;:\u0026#34;$http_x_forwarded_for\u0026#34;,\u0026#34;http_host\u0026#34;:\u0026#34;$http_host\u0026#34;,\u0026#34;server_name\u0026#34;:\u0026#34;$server_name\u0026#34;,\u0026#34;ssl_protocol\u0026#34;:\u0026#34;$ssl_protocol\u0026#34;,\u0026#34;ssl_cipher\u0026#34;:\u0026#34;$ssl_cipher\u0026#34;,\u0026#34;scheme\u0026#34;:\u0026#34;$scheme\u0026#34;,\u0026#34;request_method\u0026#34;:\u0026#34;$request_method\u0026#34;,\u0026#34;server_protocol\u0026#34;:\u0026#34;$server_protocol\u0026#34;,\u0026#34;pipe\u0026#34;:\u0026#34;$pipe\u0026#34;,\u0026#34;gzip_ratio\u0026#34;:\u0026#34;$gzip_ratio\u0026#34;,\u0026#34;http_cf_ray\u0026#34;:\u0026#34;$http_cf_ray\u0026#34;,\u0026#34;request_host\u0026#34;:\u0026#34;$host\u0026#34;,\u0026#34;is_completion\u0026#34;:\u0026#34;$request_completion\u0026#34;,\u0026#34;upstream\u0026#34;:\u0026#34;$upstream_addr\u0026#34;,\u0026#34;upstream_name\u0026#34;:\u0026#34;$proxy_host\u0026#34;,\u0026#34;upstream_status\u0026#34;:\u0026#34;$upstream_status\u0026#34;,\u0026#34;upstream_bytes_sent\u0026#34;:\u0026#34;$upstream_bytes_sent\u0026#34;,\u0026#34;upstream_bytes_received\u0026#34;:\u0026#34;$upstream_bytes_received\u0026#34;,\u0026#34;upstream_connect_time\u0026#34;:\u0026#34;$upstream_connect_time\u0026#34;,\u0026#34;upstream_header_time\u0026#34;:\u0026#34;$upstream_header_time\u0026#34;,\u0026#34;upstream_response_time\u0026#34;:\u0026#34;$upstream_response_time\u0026#34;,\u0026#34;upstream_response_length\u0026#34;:\u0026#34;$upstream_response_length\u0026#34;,\u0026#34;upstream_cache_status\u0026#34;:\u0026#34;$upstream_cache_status\u0026#34;,\u0026#34;nginx_host\u0026#34;:\u0026#34;$hostname\u0026#34;} TCPå’ŒUPD 1 2 3 4 5 6 7 8 9 10 - /nginx-ingress-controller - --election-id=ingress-controller-leader - --controller-class=k8s.io/ingress-nginx - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller - --validating-webhook=:8443 - --validating-webhook-certificate=/usr/local/certificates/cert - --validating-webhook-key=/usr/local/certificates/key - --watch-ingress-without-class=true - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services #å¢åŠ tcpé…ç½® - --udp-services-configmap=$(POD_NAMESPACE)/udp-services #å¢åŠ updé…ç½® é™¤äº† HTTP æµé‡ä¹‹å¤–ï¼ŒNGINX Ingress Controller è¿˜å¯ä»¥è´Ÿè½½ TCP å’Œ UDP æµé‡ï¼Œå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥ç®¡ç†åŸºäºä»¥ä¸‹åè®®çš„å„ç§åº”ç”¨å’Œå®ç”¨ç¨‹åºçš„æµé‡ï¼Œå®ƒä»¬åŒ…æ‹¬ï¼š\nMySQLã€LDAP å’Œ MQTT â€”â€” è®¸å¤šæµè¡Œåº”ç”¨ä½¿ç”¨çš„åŸºäº TCP åè®®çš„åº”ç”¨ DNSã€syslog å’Œ RADIUS â€”â€” è¾¹ç¼˜è®¾å¤‡å’Œéäº‹åŠ¡æ€§åº”ç”¨ä½¿ç”¨çš„åŸºäº UDP åè®®çš„å®ç”¨ç¨‹åº https://www.niewx.cn/2021/11/09/2021-11-09-Use-Nginx-Ingress-to-expose-TCP-and-udp-services/\nhttps://www.nginx-cn.net/blog/load-balancing-tcp-and-udp-traffic-in-kubernetes-with-nginx/\nIngressæ—¥å¿—è¿½è¸ª åœ¨å½“ä»Šäº’è”ç½‘æ¶æ„ä¸­ï¼ŒWebåº”ç”¨é˜²ç«å¢™ï¼ˆWAFï¼‰ä¸Nginx(Ingress)ä½œä¸ºå‰ç«¯ä»£ç†çš„æ•´åˆè¶Šæ¥è¶Šå¸¸è§ï¼Œç‰¹åˆ«æ˜¯åœ¨æå‡Webåº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§æ–¹é¢ã€‚è¿™ç§ç»“æ„ä¸ä»…å¢å¼ºäº†å¯¹åº”ç”¨çš„ä¿æŠ¤ï¼Œè¿˜æå‡äº†ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚åœ¨è¿™ç§æ¶æ„ä¸­ï¼Œç†è§£WAFä¸Nginx(ingress)å¦‚ä½•åä½œï¼Œä»¥åŠå¦‚ä½•å®ç°æ—¥å¿—è¿½è¸ªçš„æ•´åˆå°¤ä¸ºé‡è¦ã€‚\nç”¨æˆ·è®¿é—®æµç¨‹æ—¥å¿—åˆ†æ æ€»ç»“ï¼šé˜¿é‡Œäº‘çš„WAFæ—¥å¿—æ›´åŠ è¯¦ç»†ï¼ŒNginxå±‚é¢çš„æ—¥å¿—ä¹Ÿæ˜¯WAFè¿‡æ¥çš„ï¼ˆæ•°æ®ä¸€æ ·çš„ï¼‰\nä¸‹æ–¹å››ä¸ªæˆªå›¾çš„æ•°æ®æ—¥å¿—ï¼Œå°±æ˜¯ä¸€æ¡çš„è¯·æ±‚çš„è®¿é—®ã€‚æ•°æ®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå„ä¸ªå±‚é¢éƒ½æœ‰æ—¥å¿—è®°å½•ã€‚æ¯«æ— ç–‘é—® WAFæ›´åŠ ä¸“ä¸š ï¼Œå›¾åƒåŒ–æ›´å¤šã€‚ é˜¿é‡Œäº‘çš„WAF Nginxä¸­è½¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 server { listen 80; server_name xx.xxx.com; # IPç™½åå• include /usr/local/openresty/nginx/whitelist/corporation.conf; rewrite ^/(.*)$ https://$host/$1 permanent; } server { listen 443 ssl; server_name kpi.xxxx.com; #proxy_read_timeout 180; #proxy_send_timeout 180; # IPç™½åå• include /usr/local/openresty/nginx/whitelist/corporation.conf; ssl on; ssl_certificate /usr/local/openresty/nginx/ssl/xxx.com.crt; ssl_certificate_key /usr/local/openresty/nginx/ssl/xx.com.key; include ssl.conf; location / { proxy_pass http://kubernetes-cluster; include https_proxy.conf; } } ä¸‹æ–¹çš„åœ°å€ä¸ºINgressçš„åœ°å€ç«¯å£ï¼ˆå¯ä»¥çœ‹å‡ºï¼ŒNginxèµ°httpsï¼ŒIngreeèµ°httpï¼‰\n1 2 3 4 [root@nginx sites]# cat kubernetes-cluster.conf upstream kubernetes-cluster { server 172.18.xxx.xxx:80; } Ingreeï¼ˆä¸­è½¬ï¼‰\nIngress\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 [root@jenkins ops]# kubectl get ingresses -n prod new-fujfu-kpi-frontend -oyaml apiVersion: extensions/v1beta1 kind: Ingress metadata: name: new-fujfu-kpi-frontend namespace: prod resourceVersion: \u0026#34;3381713262\u0026#34; spec: rules: - host: kpi.xxx.com http: paths: - backend: serviceName: new-fujfu-kpi-frontend servicePort: 80 path: / SVC\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 [root@jenkins ops]# kubectl get svc -n prod new-fujfu-kpi-frontend -oyaml apiVersion: v1 kind: Service metadata: labels: app: new-fujfu-kpi-frontend name: new-fujfu-kpi-frontend namespace: prod spec: clusterIP: 172.21.14.20 ports: - name: http port: 80 protocol: TCP targetPort: 80 selector: app: new-fujfu-kpi-frontend sessionAffinity: None type: ClusterIP Pod\n1 2 [root@jenkins ops]# kubectl get pod -n prod --show-labels | grep \u0026#34;new-fujfu-kpi-frontend\u0026#34; new-fujfu-kpi-frontend.prod-8464c5df44-vsdcw 1/1 Running 0 185d app=new-fujfu-kpi-frontend,notfixedvalue=value-20231009171117,pod-template-hash=8464c5df44 æ•´ä¸ªIngreeè®¿é—®æµç¨‹\nIngreeçš„æ—¥å¿—\n1 kubectl logs -f nginx-ingress-controller-7795b48595-n2dcr -n kube-system |grep \u0026#34;kpi.xxxx.com\u0026#34; Nginxï¼ˆPodï¼‰\nNginxå‰ç«¯ ä¹Ÿåªæ˜¯Pod\npodä¸­çš„Nginxé…ç½®\n1 2 3 4 5 6 7 8 9 10 root@new-fujfu-kpi-frontend:/etc/nginx/conf.d# cat default.conf server { listen 80; server_name localhost; root /usr/share/nginx/html; index index.html index.htm; location / { try_files $uri /index.html; } } 1 2 [root@jenkins ops]# kubectl get pod -n prod --show-labels | grep \u0026#34;new-fujfu-kpi-frontend\u0026#34; new-fujfu-kpi-frontend.prod-8464c5df44-vsdcw 1/1 Running 0 185d app=new-fujfu-kpi-frontend,notfixedvalue=value-20231009171117,pod-template-hash=8464c5df44 æ—¥å¿—æ—¶é—´ä¸å¯¹ï¼Œå› ä¸ºpodä¸­å·®ä¸ª8ä¸ªå°æ—¶å¼•èµ·çš„ æ—¥å¿—åˆ†æä¸å¯è§†åŒ– åˆ©ç”¨è‡ªå®šä¹‰æ—¥å¿—æ•°æ®è¿›è¡Œæ—¥å¿—åˆ†æä¸å¯è§†åŒ–æ˜¯æé«˜å®‰å…¨æ€§å’Œå“åº”èƒ½åŠ›çš„å…³é”®ã€‚é€šè¿‡é›†æˆSIEMå·¥å…·ã€ELKæ ˆï¼ˆElasticsearchã€Logstashã€Kibanaï¼‰æˆ–å…¶ä»–æ—¥å¿—åˆ†æå¹³å°ï¼Œå¯ä»¥å¯¹æ—¥å¿—æ•°æ®è¿›è¡Œå®æ—¶ç›‘æ§ã€å¼‚å¸¸æ£€æµ‹å’Œæ”»å‡»è¡Œä¸ºåˆ†æã€‚è¿™äº›å·¥å…·èƒ½å¤Ÿå¸®åŠ©å›¢é˜Ÿå¿«é€Ÿè¯†åˆ«å¹¶å“åº”å®‰å…¨å¨èƒï¼ŒåŒæ—¶æä¾›ç›´è§‚çš„æ•°æ®å¯è§†åŒ–ï¼Œä»¥ä¾¿æ·±å…¥ç†è§£å’Œæ”¹è¿›å®‰å…¨ç­–ç•¥ã€‚\nå‚è€ƒæ–‡æ¡£ï¼š\nä»é€»è¾‘ä¸Šæ·±å…¥ç†è§£Kubernetesä¸­IngressåŠNginx Ingress Controllerçš„æ¦‚å¿µåŠåŸç†\nhttps://www.cnblogs.com/varden/p/15128802.html\nhttps://www.modb.pro/db/405641\nKuberneteså®‰è£…ingress-nginx\n","date":"2024-04-11T18:30:08Z","image":"https://www.ownit.top/title_pic/73.jpg","permalink":"https://www.ownit.top/p/202404111830/","title":"Ingressé…ç½®ä¼˜åŒ–å’Œè¿½è¸ª"},{"content":"èƒŒæ™¯ Nginxæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„WebæœåŠ¡å™¨ï¼Œå¯¹äºç½‘ç»œç¯å¢ƒä¸­çš„æ—¥å¿—è®°å½•å’Œé…ç½®è‡³å…³é‡è¦ã€‚å®šåˆ¶åŒ–Nginxæ—¥å¿—æ ¼å¼å¯ä»¥å¸®åŠ©ç®¡ç†å‘˜æ›´å¥½åœ°ç›‘æ§æœåŠ¡å™¨æ€§èƒ½ã€åˆ†æç”¨æˆ·è¡Œä¸ºå¹¶åšå‡ºç›¸åº”ä¼˜åŒ–ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨Nginxæ—¥å¿—æ ¼å¼çš„é«˜çº§å®šåˆ¶åŒ–ç­–ç•¥ï¼ŒåŒ…æ‹¬ç†è§£åŸºç¡€æ—¥å¿—ç»“æ„ã€æ—¥å¿—æ ¼å¼è‡ªå®šä¹‰å®ä¾‹ã€æ¨¡å—é›†æˆä¸æ‰©å±•ä»¥åŠæ—¥å¿—åˆ‡å‰²ä¸ç®¡ç†ã€‚\nNginxçš„è‡ªå®šä¹‰æ—¥å¿—ï¼ˆæŒ‡æ ‡å…¨é¢ï¼‰\nNginxä¹‹é—´çš„æ—¥å¿—è¿½è¸ªï¼ˆåˆ†ææ•´ä¸ªæµç¨‹ï¼‰\nNginxè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ 1. ç†è§£åŸºç¡€æ—¥å¿—ç»“æ„ log_format æœ‰ä¸€ä¸ªé»˜è®¤çš„æ— éœ€è®¾ç½®çš„ combined æ—¥å¿—æ ¼å¼ï¼Œç›¸å½“äºapache çš„ combined æ—¥å¿—æ ¼å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 log_format combined \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#39; \u0026#39; \u0026#34;$request\u0026#34; $status $body_bytes_sent \u0026#39; \u0026#39; \u0026#34;$http_referer\u0026#34; \u0026#34;$http_user_agent\u0026#34; \u0026#39;; Nginxé»˜è®¤æ—¥å¿—æ ¼å¼åŒ…å«å¤šä¸ªå­—æ®µï¼Œæ¯ä¸ªå­—æ®µéƒ½æä¾›äº†æœ‰ç”¨çš„ä¿¡æ¯æ¥å¸®åŠ©åˆ†ææœåŠ¡å™¨è¡Œä¸ºã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§å­—æ®µåŠå…¶å«ä¹‰ï¼š\n$remote_addr: å®¢æˆ·ç«¯çš„IPåœ°å€ $remote_user: å®¢æˆ·ç«¯ç”¨æˆ·çš„åç§° $time_local: è®¿é—®æ—¶é—´ä¸æ—¶åŒº $request: å®Œæ•´çš„HTTPè¯·æ±‚è¡Œï¼ŒåŒ…æ‹¬è¯·æ±‚æ–¹æ³•ã€URIå’Œåè®® $status: æœåŠ¡å™¨å“åº”çš„HTTPçŠ¶æ€ç  $body_bytes_sent: å‘é€ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°ï¼Œä¸åŒ…æ‹¬å“åº”å¤´çš„å¤§å° $http_referer: å®¢æˆ·ç«¯å‘é€çš„HTTP Refererå¤´éƒ¨ä¿¡æ¯ $http_user_agent: å®¢æˆ·ç«¯å‘é€çš„User-Agentå¤´éƒ¨ä¿¡æ¯ è¿™äº›å­—æ®µçš„ç»„åˆå¯ä»¥æä¾›å…¨é¢çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯ï¼Œæœ‰åŠ©äºåˆ†æç”¨æˆ·è¡Œä¸ºå’ŒæœåŠ¡å™¨æ€§èƒ½ã€‚\nå¦‚æœ nginx ä½äºè´Ÿè½½å‡è¡¡å™¨ï¼Œ squidï¼Œ nginx åå‘ä»£ç†ä¹‹åï¼Œ web æœåŠ¡å™¨æ— æ³•ç›´æ¥è·å–åˆ°å®¢æˆ·ç«¯çœŸå®çš„ IP åœ°å€äº†ã€‚ $remote_addr è·å–åå‘ä»£ç†çš„ IP åœ°å€ã€‚åå‘ä»£ç†æœåŠ¡å™¨åœ¨è½¬å‘è¯·æ±‚çš„ http å¤´ä¿¡æ¯ä¸­ï¼Œå¯ä»¥å¢åŠ  X-ForwardedFor ä¿¡æ¯ï¼Œç”¨æ¥è®°å½• å®¢æˆ·ç«¯ IP åœ°å€å’Œå®¢æˆ·ç«¯è¯·æ±‚çš„æœåŠ¡å™¨åœ°å€ã€‚ å¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 log_format porxy \u0026#39;$http_x_forwarded_for - $remote_user [$time_local] \u0026#39; \u0026#39; \u0026#34;$request\u0026#34; $status $body_bytes_sent \u0026#39; \u0026#39; \u0026#34;$http_referer\u0026#34; \u0026#34;$http_user_agent\u0026#34; \u0026#39;; 2. æ—¥å¿—æ ¼å¼è‡ªå®šä¹‰å®ä¾‹ é€šè¿‡Nginxçš„access_logæŒ‡ä»¤ï¼Œç®¡ç†å‘˜å¯ä»¥è½»æ¾è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼\nå…·ä½“log_formatçš„è¯­æ³•å¦‚ä¸‹ï¼š\n1 log_format name [escape=default|json|none] string ...; æ¯ä¸€ä¸ªæ—¥å¿—æ ¼å¼éƒ½æœ‰ä¸€ä¸ªåç§°ï¼Œç„¶ååœ¨é…ç½®access_logçš„æ—¶å€™å¯ä»¥æŒ‡å®šç”¨å“ªç§æ ¼å¼æ¥è¿›è¡Œè®°å½•æ—¥å¿—ã€‚log_formatåªèƒ½å®šä¹‰åœ¨httpå—ä¸­ã€‚æŸ¥çœ‹åœ¨Nginxé…ç½®æ–‡ä»¶ä¸­çš„å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 http { #å¯ä»¥å®šä¹‰å¤šä¸ªlog_formatï¼Œåç§°åªéœ€è¦ä¸ä¸€æ ·å³å¯ log_format main \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34; \u0026#39; \u0026#39;$status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#39; \u0026#39;\u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34;\u0026#39;; } server { access_log /var/log/nginx/access.log main; # æ³¨æ„è¿™é‡Œçš„é…ç½® error_log /var/log/nginx/error.log; } å¦‚ä¸Šåœ¨httpå—ä¸­å®šä¹‰äº†ä¸€ä¸ªåç§°ä¸ºmainçš„æ—¥å¿—æ ¼å¼ï¼Œåœ¨serverå—ä¸­é€šè¿‡åç§°å¯¹è¯¥æ—¥å¿—æ ¼å¼è¿›è¡Œäº†å¼•ç”¨ï¼Œè¿™æ ·å­æ—¥å¿—çš„æ ¼å¼éƒ½ä¼šæŒ‰æ‰¾mainä¸­å®šä¹‰çš„ä¸€äº›å±æ€§æ¥è¿›è¡Œè®°å½•è®¿é—®ä¿¡æ¯ã€‚\né€šè¿‡ä¸Šè¾¹å¯¹æ—¥å¿—æ ¼å¼å’Œæ—¥å¿—æ–‡ä»¶çš„ä¸€äº›äº†è§£ï¼Œæˆ‘ä»¬å°±å¯ä»¥éå¸¸å®¹æ˜“çš„æŠŠæ—¥å¿—çš„æ ¼å¼è®¾ç½®æˆJSONäº†ï¼Œåªéœ€è¦å®šä¹‰ä¸€ä¸ªlog_formatï¼ŒæŠŠå®ƒçš„æ ¼å¼å®šä¹‰æˆä¸€ä¸ªjsonå­—ç¬¦ä¸²ï¼Œç„¶ååœ¨æ‰“å°æ—¥å¿—çš„æ—¶å€™å¼•ç”¨è¿™ä¸ªæ ¼å¼å°±å¯ä»¥å®ç°äº†ï¼Œä¸‹è¾¹æ˜¯ä¸€ä¸ªå®Œæˆçš„å®šä¹‰æ–‡ä»¶:ï¼ˆå¯æ ¹æ®è‡ªå·±çš„éœ€æ±‚å®šåˆ¶ï¼‰\nç¬¬ä¸€ç§ ç¨‹åºå‹å¥½å‹jsonæ ¼å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 log_format json escape=json \u0026#39;{\u0026#39; \u0026#39;\u0026#34;time_iso8601\u0026#34;: \u0026#34;$time_iso8601\u0026#34;, \u0026#39; # local time in the ISO 8601 standard format \u0026#39;\u0026#34;request_time\u0026#34;: \u0026#34;$request_time\u0026#34;, \u0026#39; # request processing time in seconds with msec resolution \u0026#39;\u0026#34;status\u0026#34;: \u0026#34;$status\u0026#34;, \u0026#39; # response status code \u0026#39;\u0026#34;body_bytes_sent\u0026#34;: \u0026#34;$body_bytes_sent\u0026#34;, \u0026#39; # the number of body bytes exclude headers sent to a client \u0026#39;\u0026#34;bytes_sent\u0026#34;: \u0026#34;$bytes_sent\u0026#34;, \u0026#39; # the number of bytes sent to a client \u0026#39;\u0026#34;remote_addr\u0026#34;: \u0026#34;$remote_addr\u0026#34;, \u0026#39; # client IP \u0026#39;\u0026#34;remote_user\u0026#34;: \u0026#34;$remote_user\u0026#34;, \u0026#39; # client HTTP username \u0026#39;\u0026#34;remote_port\u0026#34;: \u0026#34;$remote_port\u0026#34;, \u0026#39; # client port \u0026#39;\u0026#34;request_uri\u0026#34;: \u0026#34;$request_uri\u0026#34;, \u0026#39; # full path and arguments if the request \u0026#39;\u0026#34;args\u0026#34;: \u0026#34;$args\u0026#34;, \u0026#39; # args \u0026#39;\u0026#34;request_id\u0026#34;: \u0026#34;$request_id\u0026#34;, \u0026#39; # the unique request id \u0026#39;\u0026#34;connection\u0026#34;: \u0026#34;$connection\u0026#34;, \u0026#39; # connection serial number \u0026#39;\u0026#34;connection_requests\u0026#34;: \u0026#34;$connection_requests\u0026#34;, \u0026#39; # number of requests made in connection \u0026#39;\u0026#34;pid\u0026#34;: \u0026#34;$pid\u0026#34;, \u0026#39; # process pid \u0026#39;\u0026#34;request_length\u0026#34;: \u0026#34;$request_length\u0026#34;, \u0026#39; # request length (including headers and body) \u0026#39;\u0026#34;time_local\u0026#34;: \u0026#34;$time_local\u0026#34;, \u0026#39; \u0026#39;\u0026#34;http_referer\u0026#34;: \u0026#34;$http_referer\u0026#34;, \u0026#39; # HTTP referer \u0026#39;\u0026#34;http_user_agent\u0026#34;: \u0026#34;$http_user_agent\u0026#34;, \u0026#39; # user agent \u0026#39;\u0026#34;http_x_forwarded_for\u0026#34;: \u0026#34;$http_x_forwarded_for\u0026#34;, \u0026#39; # http_x_forwarded_for \u0026#39;\u0026#34;http_host\u0026#34;: \u0026#34;$http_host\u0026#34;, \u0026#39; # the request Host: header \u0026#39;\u0026#34;server_name\u0026#34;: \u0026#34;$server_name\u0026#34;, \u0026#39; # the name of the vhost serving the request \u0026#39;\u0026#34;ssl_protocol\u0026#34;: \u0026#34;$ssl_protocol\u0026#34;, \u0026#39; # TLS protocol \u0026#39;\u0026#34;ssl_cipher\u0026#34;: \u0026#34;$ssl_cipher\u0026#34;, \u0026#39; # TLS cipher \u0026#39;\u0026#34;scheme\u0026#34;: \u0026#34;$scheme\u0026#34;, \u0026#39; # http or https \u0026#39;\u0026#34;request_method\u0026#34;: \u0026#34;$request_method\u0026#34;, \u0026#39; # request method \u0026#39;\u0026#34;server_protocol\u0026#34;: \u0026#34;$server_protocol\u0026#34;, \u0026#39; # request protocol, like HTTP/1.1 or HTTP/2.0 \u0026#39;\u0026#34;pipe\u0026#34;: \u0026#34;$pipe\u0026#34;, \u0026#39; # \u0026#34;p\u0026#34; if request was pipelined, \u0026#34;.\u0026#34; otherwise \u0026#39;\u0026#34;gzip_ratio\u0026#34;: \u0026#34;$gzip_ratio\u0026#34;, \u0026#39; \u0026#39;\u0026#34;http_cf_ray\u0026#34;: \u0026#34;$http_cf_ray\u0026#34;, \u0026#39; \u0026#39;\u0026#34;request_host\u0026#34;: \u0026#34;$host\u0026#34;, \u0026#39; \u0026#39;\u0026#34;is_completion\u0026#34;: \u0026#34;$request_completion\u0026#34;, \u0026#39; \u0026#39;\u0026#34;upstream\u0026#34;: \u0026#34;$upstream_addr\u0026#34;, \u0026#39; # upstream backend server for proxied requests \u0026#39;\u0026#34;upstream_name\u0026#34;: \u0026#34;$proxy_host\u0026#34;, \u0026#39; # upstream name \u0026#39;\u0026#34;upstream_status\u0026#34;: \u0026#34;$upstream_status\u0026#34;, \u0026#39; # upstream status \u0026#39;\u0026#34;upstream_bytes_sent\u0026#34;: \u0026#34;$upstream_bytes_sent\u0026#34;, \u0026#39; # upstream bytes sent \u0026#39;\u0026#34;upstream_bytes_received\u0026#34;: \u0026#34;$upstream_bytes_received\u0026#34;, \u0026#39; # upstream bytes received \u0026#39;\u0026#34;upstream_connect_time\u0026#34;: \u0026#34;$upstream_connect_time\u0026#34;, \u0026#39; # upstream handshake time incl. TLS \u0026#39;\u0026#34;upstream_header_time\u0026#34;: \u0026#34;$upstream_header_time\u0026#34;, \u0026#39; # time spent receiving upstream headers \u0026#39;\u0026#34;upstream_response_time\u0026#34;: \u0026#34;$upstream_response_time\u0026#34;, \u0026#39; # time spend receiving upstream body \u0026#39;\u0026#34;upstream_response_length\u0026#34;: \u0026#34;$upstream_response_length\u0026#34;, \u0026#39; # upstream response length \u0026#39;\u0026#34;upstream_cache_status\u0026#34;: \u0026#34;$upstream_cache_status\u0026#34;, \u0026#39; # cache HIT/MISS where applicable \u0026#39;\u0026#34;nginx_host\u0026#34;: \u0026#34;$hostname\u0026#34;\u0026#39; \u0026#39;}\u0026#39;; jsonæ ¼å¼å¯¹ç¨‹åºå‹å¥½ï¼Œé…åˆELKç­‰æ—¥å¿—é‡‡é›†ã€åˆ†æç³»ç»Ÿä½¿ç”¨å¾ˆæ–¹ä¾¿ï¼Œæ–¹ä¾¿å¯¹æ—¥å¿—è¿›è¡Œæ·±åº¦åˆ†æã€‚ä½†æ˜¯å¤šæ•°äººå¹³æ—¶æ¯”è¾ƒå–œæ¬¢ç›´æ¥æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼Œè¿™æ—¶jsonæ ¼å¼çš„æ—¥å¿—æ–‡ä»¶çœ‹èµ·æ¥å°±ä¸å¤Ÿæ¸…æ™°äº†ï¼Œæ—¥å¿—è¾ƒé•¿ï¼Œå†—ä½™ä¿¡æ¯è¾ƒå¤šï¼Œä½¿ç”¨shellå‘½ä»¤è¿›è¡Œç»Ÿè®¡å’Œåˆ†æä¹Ÿä¸æ–¹ä¾¿ã€‚\n1 {\u0026#34;time_iso8601\u0026#34;: \u0026#34;2024-04-10T16:55:26+08:00\u0026#34;, \u0026#34;request_time\u0026#34;: \u0026#34;0.009\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;200\u0026#34;, \u0026#34;body_bytes_sent\u0026#34;: \u0026#34;397\u0026#34;, \u0026#34;bytes_sent\u0026#34;: \u0026#34;916\u0026#34;, \u0026#34;remote_addr\u0026#34;: \u0026#34;192.168.96.19\u0026#34;, \u0026#34;remote_user\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;remote_port\u0026#34;: \u0026#34;8145\u0026#34;, \u0026#34;request_uri\u0026#34;: \u0026#34;/default_sso_heartbeat.html\u0026#34;, \u0026#34;args\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;request_id\u0026#34;: \u0026#34;c002e29f30c5e85a01dc1927991a9175\u0026#34;, \u0026#34;connection\u0026#34;: \u0026#34;759864\u0026#34;, \u0026#34;connection_requests\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;pid\u0026#34;: \u0026#34;8459\u0026#34;, \u0026#34;request_length\u0026#34;: \u0026#34;1017\u0026#34;, \u0026#34;time_local\u0026#34;: \u0026#34;10/Apr/2024:16:55:26 +0800\u0026#34;, \u0026#34;http_referer\u0026#34;: \u0026#34;https://apollo.ownit.top/default_sso_heartbeat.html\u0026#34;, \u0026#34;http_user_agent\u0026#34;: \u0026#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36\u0026#34;, \u0026#34;http_x_forwarded_for\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;http_host\u0026#34;: \u0026#34;apollo.ownit.top\u0026#34;, \u0026#34;server_name\u0026#34;: \u0026#34;apollo.ownit.top\u0026#34;, \u0026#34;ssl_protocol\u0026#34;: \u0026#34;TLSv1.2\u0026#34;, \u0026#34;ssl_cipher\u0026#34;: \u0026#34;ECDHE-RSA-AES256-GCM-SHA384\u0026#34;, \u0026#34;scheme\u0026#34;: \u0026#34;https\u0026#34;, \u0026#34;request_method\u0026#34;: \u0026#34;GET\u0026#34;, \u0026#34;server_protocol\u0026#34;: \u0026#34;HTTP/1.1\u0026#34;, \u0026#34;pipe\u0026#34;: \u0026#34;.\u0026#34;, \u0026#34;gzip_ratio\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;http_cf_ray\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;request_host\u0026#34;: \u0026#34;apollo.ownit.top\u0026#34;, \u0026#34;is_completion\u0026#34;: \u0026#34;OK\u0026#34;, \u0026#34;upstream\u0026#34;: \u0026#34;192.168.102.40:80\u0026#34;, \u0026#34;upstream_name\u0026#34;: \u0026#34;kubernetes-cluster\u0026#34;, \u0026#34;upstream_status\u0026#34;: \u0026#34;200\u0026#34;, \u0026#34;upstream_bytes_sent\u0026#34;: \u0026#34;1100\u0026#34;, \u0026#34;upstream_bytes_received\u0026#34;: \u0026#34;880\u0026#34;, \u0026#34;upstream_connect_time\u0026#34;: \u0026#34;0.000\u0026#34;, \u0026#34;upstream_header_time\u0026#34;: \u0026#34;0.009\u0026#34;, \u0026#34;upstream_response_time\u0026#34;: \u0026#34;0.009\u0026#34;, \u0026#34;upstream_response_length\u0026#34;: \u0026#34;397\u0026#34;, \u0026#34;upstream_cache_status\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;nginx_host\u0026#34;: \u0026#34;bt\u0026#34;} ç¬¬äºŒç§ è¿ç»´å‹å¥½å‹è‡ªå®šä¹‰æ ¼å¼ï¼š\n1 2 log_format main escape=json \u0026#39;$remote_addr |$ipdb_raw |[$time_local] |$host |$request |$status |BodySent:$body_bytes_sent |ReqTime:$request_time |$request_completion |$http_x_forwarded_for |$proxy_host |$upstream_addr |$upstream_status |$upstream_cache_status |UpResTime:$upstream_response_time |UpConnTime:$upstream_connect_time |UpResLen:$upstream_response_length |$hostname-$request_id |$scheme |$request_body |$http_referer |$http_user_agent |$http_cookie\u0026#39;; è¿™ç§æ ¼å¼ä½¿ç”¨â€œ|â€ä½œä¸ºåˆ†éš”ç¬¦ï¼Œæ—¥å¿—æ‰“å°ä¹Ÿä¸æ˜¯å¾ˆé•¿ï¼Œæ–¹ä¾¿ä½¿ç”¨AWKç­‰å‘½ä»¤è¿›è¡Œç»Ÿè®¡\néœ€æ³¨æ„ä»¥ä¸‹å‡ ç‚¹:\n$ipdb_rawè¿™ä¸ªå˜é‡æ˜¯ipip.net ipåº“çš„nginxæ¨¡å—ï¼Œå¦‚æœæœªä½¿ç”¨è¿™ä¸ªæ¨¡å—ä¼šæŠ¥é”™ï¼Œå»æ‰æˆ–æ¢æˆGEOIPå³å¯ã€‚ escape=json è¡¨ç¤ºä»¥jsonæ ¼å¼è¾“å‡ºï¼Œé«˜ç‰ˆæœ¬çš„Nginxå·²ç»æ”¯æŒjsonæ ¼å¼ï¼Œå¯¹äºç¬¬äºŒç§è‡ªå®šä¹‰æ ¼å¼ï¼Œå¼€å¯è¿™ä¸ªå‚æ•°èƒ½åœ¨access logä¸­æ‰“å°ä¸­æ–‡ï¼Œä¸ä¼šä¹±ç  $http_cookieæ˜¯æ‰“å°æ‰€æœ‰cookies,å½“ç„¶ä¹Ÿå¯ä»¥æ‰“å°session,å¯¹äºé«˜å®‰å…¨è¦æ±‚çš„æƒ…å†µï¼Œæ—¥å¿—ä¸­ä¸ä¼šå…è®¸æ³„æ¼ç”¨æˆ·cookiesã€‚ä½†æ˜¯æŸäº›æƒ…å†µéœ€è°ƒè¯•æˆ–æ‰“å°éæ•æ„Ÿçš„cookies,å¯ä»¥æ‰“å°æŒ‡å®šcookiesï¼Œå¦‚æ‰“å°nginx session stickyç”Ÿäº§çš„cookies,å‡è®¾åå­—å«backendï¼š \u0026lsquo;TRACE:$cookie_backend\u0026rsquo;ã€‚ $hostname-$request_id å¦‚æœæœ‰åšå…¨å±€è°ƒç”¨é“¾åˆ†æçš„éœ€æ±‚ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥åšä¸ºå…¨å±€çš„UUIDï¼Œnginxå¯¹æ¯ä¸ªè¯·æ±‚éƒ½ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„UUIDï¼Œä¼ ç»™åç«¯å·¥ç¨‹æ‰“å°å‡ºæ¥å³å¯ã€‚ æ¨¡å—é›†æˆä¸æ‰©å±• é€šè¿‡é›†æˆç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¦‚ngx_http_geoip_moduleå’Œngx_http_log_moduleï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¸°å¯Œæ—¥å¿—ä¿¡æ¯ã€‚ngx_http_geoip_moduleå…è®¸åœ¨æ—¥å¿—ä¸­æ·»åŠ å®¢æˆ·ç«¯çš„åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚å›½å®¶ã€åŸå¸‚ç­‰ï¼Œè¿™å¯¹äºåˆ†æç”¨æˆ·çš„åœ°ç†åˆ†å¸ƒéå¸¸æœ‰ç”¨ã€‚ngx_http_log_moduleåˆ™æä¾›äº†çµæ´»çš„æ—¥å¿—é…ç½®é€‰é¡¹ï¼ŒåŒ…æ‹¬åŸºäºå˜é‡çš„æ—¥å¿—è®°å½•å’Œæ¡ä»¶æ—¥å¿—è®°å½•ï¼Œä½¿æ—¥å¿—è®°å½•æ›´åŠ ç²¾ç»†å’Œé«˜æ•ˆã€‚\nè¯·å‚è€ƒï¼š\nhttps://blog.csdn.net/fishinhouse/article/details/88966258 https://blog.csdn.net/zzhongcy/article/details/86214969\næ—¥å¿—åˆ‡å‰²ä¸ç®¡ç† æ—¥å¿—æ–‡ä»¶çš„å®šæœŸæ»šåŠ¨åˆ†å‰²æ˜¯æ—¥å¿—ç®¡ç†ä¸­çš„ä¸€ä¸ªé‡è¦æ–¹é¢ã€‚è¿™å¯ä»¥é€šè¿‡è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚ä½¿ç”¨cronï¼‰æ¥å®ç°ï¼Œä»¥å®šæœŸæ‰§è¡Œæ—¥å¿—åˆ‡å‰²æ“ä½œï¼Œä¾‹å¦‚æ¯å¤©æˆ–æ¯å‘¨åˆ‡å‰²ä¸€æ¬¡æ—¥å¿—æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œè¿˜éœ€è¦è€ƒè™‘æ—¥å¿—çš„å½’æ¡£å’Œå®‰å…¨å­˜å‚¨ï¼Œç¡®ä¿æ—¥å¿—æ•°æ®åœ¨ä¿æŒå¯è®¿é—®æ€§çš„åŒæ—¶ï¼Œä¸ä¼šå› è¿‡æ—¶æˆ–å®‰å…¨é—®é¢˜è€Œé­åˆ°ç ´åã€‚ä½¿ç”¨å¦‚logrotateç­‰å·¥å…·å¯ä»¥å¸®åŠ©å®ç°è¿™äº›æ—¥å¿—ç®¡ç†ä»»åŠ¡ï¼Œä¿è¯æ—¥å¿—æ•°æ®çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚\né€šè¿‡æ·±å…¥æ¢ç´¢è¿™äº›ç­–ç•¥ï¼Œå¯ä»¥å®ç°å¯¹NginxæœåŠ¡å™¨æ—¥å¿—è®°å½•çš„ç²¾ç»†åŒ–é…ç½®ï¼Œä»è€Œä¸ºåº”ç”¨ç¨‹åºçš„ç›‘æ§å’Œåˆ†ææä¾›å¼ºå¤§çš„æ”¯æŒ\nåœ¨Nginxçš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸å¯¹Nginxçš„æ—¥å¿—åšè‡ªå®šä¹‰çš„é…ç½®çš„è¯ï¼Œé‚£ä¹ˆé»˜è®¤çš„access.logæ—¥å¿—é»˜è®¤å°±åªæœ‰è¿™ä¹ˆä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œéšç€ç³»ç»Ÿä½¿ç”¨æ—¶é—´è¶Šæ¥è¶Šå°±ï¼Œæ—¥å¿—æ–‡ä»¶å°±ä¼šè¶Šæ¥è¶Šå¤§ï¼Œè€Œä¸”é»˜è®¤çš„æ—¥å¿—è®°å½•çš„æ ¼å¼ä¹Ÿä¸æ–¹ä¾¿åˆ†æã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨Nginxçš„è¿‡ç¨‹ä¸­éœ€è¦å¯¹å…¶æ—¥å¿—åšä¸€äº›é…ç½®ã€‚ åœ¨httpé…ç½®å—ä¸­è¿›è¡Œé…ç½®ï¼Œä¹Ÿå¯ä»¥åœ¨æ¯ä¸ªserverå—ä¸­é…ç½®ä¸åŒçš„access_logç”¨ä»¥åŒºåˆ†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 http{ # å®šä¹‰ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨å¹´æœˆæ—¥ map $time_iso8601 $date { default \u0026#34;date-not-found\u0026#34;; \u0026#39;~^(?\u0026lt;ymd\u0026gt;\\d{4}-\\d{2}-\\d{2})\u0026#39; $ymd; } # å®šä¹‰ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨æ—¶åˆ†ç§’ map $time_iso8601 $time { default \u0026#34;time-not-found\u0026#34;; \u0026#39;~T(?\u0026lt;hms\u0026gt;\\d{2}:\\d{2}:\\d{2})\u0026#39; $hms; } # å®šä¹‰æ—¥å¿—æ ¼å¼ä¸ºjsonæ ¼å¼ log_format json_format \u0026#39;{ \u0026#34;timestamp\u0026#34;: \u0026#34;$date $time\u0026#34;, \u0026#34;remote_addr\u0026#34;: \u0026#34;$remote_addr\u0026#34;, \u0026#34;remote_user\u0026#34;: \u0026#34;$remote_user\u0026#34;, \u0026#34;request\u0026#34;: \u0026#34;$request\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;$status\u0026#34;, \u0026#34;body_bytes_sent\u0026#34;: \u0026#34;$body_bytes_sent\u0026#34;, \u0026#34;http_referer\u0026#34;: \u0026#34;$http_referer\u0026#34;, \u0026#34;http_user_agent\u0026#34;: \u0026#34;$http_user_agent\u0026#34;, \u0026#34;http_x_forwarded_for\u0026#34;: \u0026#34;$http_x_forwarded_for\u0026#34; }\u0026#39;; # å®šä¹‰ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨å¹´æœˆ,å¯ç”¨æ¥ä½œä¸ºaccess.logçš„æ—¥å¿—æ–‡ä»¶åï¼ŒæŒ‰æœˆè‡ªåŠ¨åˆ†å‰²æ—¥å¿— map $time_iso8601 $logmonth { \u0026#39;~^(?\u0026lt;ym\u0026gt;\\d{4}-\\d{2})\u0026#39; $ym; default \u0026#39;date-not-found\u0026#39;; } # å®šä¹‰ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨å¹´æœˆæ—¥ï¼Œå¯ç”¨æ¥ä½œä¸ºaccess.logçš„æ—¥å¿—æ–‡ä»¶åï¼ŒæŒ‰å¤©è‡ªåŠ¨åˆ†å‰²æ—¥å¿— map $time_iso8601 $logdate { \u0026#39;~^(?\u0026lt;ymd\u0026gt;\\d{4}-\\d{2}-\\d{2})\u0026#39; $ymd; default \u0026#39;date-not-found\u0026#39;; } # å¼€å¯access.logæ—¥å¿—ï¼Œå¯è®¾ç½®æ—¥å¿—åå˜é‡(è¿™é‡Œé€‰æ‹©ä¸Šé¢çš„æŒ‰å¤©)ä»¥ä¾¿åˆ†å‰²æ—¥å¿—ï¼›å¯è®¾ç½®æ—¥å¿—æ ¼å¼ï¼Œä»¥ä¾¿æ›´ç›´è§‚åˆ†ææ—¥å¿— access_log logs/access-$logdate.log json_format; } Nginxçš„æ—¥å¿—å¸¸è§é…ç½®é¡¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 $args #è¯·æ±‚ä¸­çš„å‚æ•°å€¼ $query_string #åŒ $args $arg_NAME #GETè¯·æ±‚ä¸­NAMEçš„å€¼ $is_args #å¦‚æœè¯·æ±‚ä¸­æœ‰å‚æ•°ï¼Œå€¼ä¸º\u0026#34;?\u0026#34;ï¼Œå¦åˆ™ä¸ºç©ºå­—ç¬¦ä¸² $uri #è¯·æ±‚ä¸­çš„å½“å‰URI(ä¸å¸¦è¯·æ±‚å‚æ•°ï¼Œå‚æ•°ä½äº$args)ï¼Œå¯ä»¥ä¸åŒäºæµè§ˆå™¨ä¼ é€’çš„$request_uriçš„å€¼ï¼Œå®ƒå¯ä»¥é€šè¿‡å†…éƒ¨é‡å®šå‘ï¼Œæˆ–è€…ä½¿ç”¨indexæŒ‡ä»¤è¿›è¡Œä¿®æ”¹ï¼Œ$uriä¸åŒ…å«ä¸»æœºåï¼Œå¦‚\u0026#34;/foo/bar.html\u0026#34;ã€‚ $document_uri #åŒ $uri $document_root #å½“å‰è¯·æ±‚çš„æ–‡æ¡£æ ¹ç›®å½•æˆ–åˆ«å $host #ä¼˜å…ˆçº§ï¼šHTTPè¯·æ±‚è¡Œçš„ä¸»æœºå\u0026gt;\u0026#34;HOST\u0026#34;è¯·æ±‚å¤´å­—æ®µ\u0026gt;ç¬¦åˆè¯·æ±‚çš„æœåŠ¡å™¨å.è¯·æ±‚ä¸­çš„ä¸»æœºå¤´å­—æ®µï¼Œå¦‚æœè¯·æ±‚ä¸­çš„ä¸»æœºå¤´ä¸å¯ç”¨ï¼Œåˆ™ä¸ºæœåŠ¡å™¨å¤„ç†è¯·æ±‚çš„æœåŠ¡å™¨åç§° $hostname #ä¸»æœºå $https #å¦‚æœå¼€å¯äº†SSLå®‰å…¨æ¨¡å¼ï¼Œå€¼ä¸º\u0026#34;on\u0026#34;ï¼Œå¦åˆ™ä¸ºç©ºå­—ç¬¦ä¸²ã€‚ $binary_remote_addr #å®¢æˆ·ç«¯åœ°å€çš„äºŒè¿›åˆ¶å½¢å¼ï¼Œå›ºå®šé•¿åº¦ä¸º4ä¸ªå­—èŠ‚ $body_bytes_sent #ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°ï¼Œå“åº”å¤´ä¸è®¡ç®—åœ¨å†…ï¼›è¿™ä¸ªå˜é‡å’ŒApacheçš„mod_log_configæ¨¡å—ä¸­çš„\u0026#34;%B\u0026#34;å‚æ•°ä¿æŒå…¼å®¹ $bytes_sent #ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•° $connection #TCPè¿æ¥çš„åºåˆ—å· $connection_requests #TCPè¿æ¥å½“å‰çš„è¯·æ±‚æ•°é‡ $content_length #\u0026#34;Content-Length\u0026#34; è¯·æ±‚å¤´å­—æ®µ $content_type #\u0026#34;Content-Type\u0026#34; è¯·æ±‚å¤´å­—æ®µ $cookie_name #cookieåç§° $limit_rate #ç”¨äºè®¾ç½®å“åº”çš„é€Ÿåº¦é™åˆ¶ $msec #å½“å‰çš„Unixæ—¶é—´æˆ³ $nginx_version #nginxç‰ˆæœ¬ $pid #å·¥ä½œè¿›ç¨‹çš„PID $pipe #å¦‚æœè¯·æ±‚æ¥è‡ªç®¡é“é€šä¿¡ï¼Œå€¼ä¸º\u0026#34;p\u0026#34;ï¼Œå¦åˆ™ä¸º\u0026#34;.\u0026#34; $proxy_protocol_addr #è·å–ä»£ç†è®¿é—®æœåŠ¡å™¨çš„å®¢æˆ·ç«¯åœ°å€ï¼Œå¦‚æœæ˜¯ç›´æ¥è®¿é—®ï¼Œè¯¥å€¼ä¸ºç©ºå­—ç¬¦ä¸² $realpath_root #å½“å‰è¯·æ±‚çš„æ–‡æ¡£æ ¹ç›®å½•æˆ–åˆ«åçš„çœŸå®è·¯å¾„ï¼Œä¼šå°†æ‰€æœ‰ç¬¦å·è¿æ¥è½¬æ¢ä¸ºçœŸå®è·¯å¾„ $remote_addr #å®¢æˆ·ç«¯åœ°å€ $remote_port #å®¢æˆ·ç«¯ç«¯å£ $remote_user #ç”¨äºHTTPåŸºç¡€è®¤è¯æœåŠ¡çš„ç”¨æˆ·å $request #ä»£è¡¨å®¢æˆ·ç«¯çš„è¯·æ±‚åœ°å€ $request_body #å®¢æˆ·ç«¯çš„è¯·æ±‚ä¸»ä½“ï¼šæ­¤å˜é‡å¯åœ¨locationä¸­ä½¿ç”¨ï¼Œå°†è¯·æ±‚ä¸»ä½“é€šè¿‡proxy_passï¼Œfastcgi_passï¼Œuwsgi_passå’Œscgi_passä¼ é€’ç»™ä¸‹ä¸€çº§çš„ä»£ç†æœåŠ¡å™¨ $request_body_file #å°†å®¢æˆ·ç«¯è¯·æ±‚ä¸»ä½“ä¿å­˜åœ¨ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚æ–‡ä»¶å¤„ç†ç»“æŸåï¼Œæ­¤æ–‡ä»¶éœ€åˆ é™¤ã€‚å¦‚æœéœ€è¦ä¹‹ä¸€å¼€å¯æ­¤åŠŸèƒ½ï¼Œéœ€è¦è®¾ç½®client_body_in_file_onlyã€‚å¦‚æœå°†æ¬¡æ–‡ä»¶ä¼  é€’ç»™åç«¯çš„ä»£ç†æœåŠ¡å™¨ï¼Œéœ€è¦ç¦ç”¨request bodyï¼Œå³è®¾ç½®proxy_pass_request_body offï¼Œfastcgi_pass_request_body offï¼Œuwsgi_pass_request_body offï¼Œor scgi_pass_request_body off $request_completion #å¦‚æœè¯·æ±‚æˆåŠŸï¼Œå€¼ä¸º\u0026#34;OK\u0026#34;ï¼Œå¦‚æœè¯·æ±‚æœªå®Œæˆæˆ–è€…è¯·æ±‚ä¸æ˜¯ä¸€ä¸ªèŒƒå›´è¯·æ±‚çš„æœ€åä¸€éƒ¨åˆ†ï¼Œåˆ™ä¸ºç©º $request_filename #å½“å‰è¿æ¥è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„ï¼Œç”±rootæˆ–aliasæŒ‡ä»¤ä¸URIè¯·æ±‚ç”Ÿæˆ $request_length #è¯·æ±‚çš„é•¿åº¦ (åŒ…æ‹¬è¯·æ±‚çš„åœ°å€ï¼Œhttpè¯·æ±‚å¤´å’Œè¯·æ±‚ä¸»ä½“) $request_method #HTTPè¯·æ±‚æ–¹æ³•ï¼Œé€šå¸¸ä¸º\u0026#34;GET\u0026#34;æˆ–\u0026#34;POST\u0026#34; $request_time #å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ä½¿ç”¨çš„æ—¶é—´,å•ä½ä¸ºç§’ï¼Œç²¾åº¦æ¯«ç§’ï¼› ä»è¯»å…¥å®¢æˆ·ç«¯çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹ï¼Œç›´åˆ°æŠŠæœ€åä¸€ä¸ªå­—ç¬¦å‘é€ç»™å®¢æˆ·ç«¯åè¿›è¡Œæ—¥å¿—å†™å…¥ä¸ºæ­¢ã€‚ $request_uri #è¿™ä¸ªå˜é‡ç­‰äºåŒ…å«ä¸€äº›å®¢æˆ·ç«¯è¯·æ±‚å‚æ•°çš„åŸå§‹URIï¼Œå®ƒæ— æ³•ä¿®æ”¹ï¼Œè¯·æŸ¥çœ‹$uriæ›´æ”¹æˆ–é‡å†™URIï¼Œä¸åŒ…å«ä¸»æœºåï¼Œä¾‹å¦‚ï¼š\u0026#34;/cnphp/test.php?arg=freemouse\u0026#34; $scheme #è¯·æ±‚ä½¿ç”¨çš„Webåè®®ï¼Œ\u0026#34;http\u0026#34; æˆ– \u0026#34;https\u0026#34; $server_addr #æœåŠ¡å™¨ç«¯åœ°å€ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¸ºäº†é¿å…è®¿é—®linuxç³»ç»Ÿå†…æ ¸ï¼Œåº”å°†ipåœ°å€æå‰è®¾ç½®åœ¨é…ç½®æ–‡ä»¶ä¸­ $server_name #æœåŠ¡å™¨å $server_port #æœåŠ¡å™¨ç«¯å£ $server_protocol #æœåŠ¡å™¨çš„HTTPç‰ˆæœ¬ï¼Œé€šå¸¸ä¸º \u0026#34;HTTP/1.0\u0026#34; æˆ– \u0026#34;HTTP/1.1\u0026#34; $status #HTTPå“åº”ä»£ç  $time_iso8601 #æœåŠ¡å™¨æ—¶é—´çš„ISO 8610æ ¼å¼ $time_local #æœåŠ¡å™¨æ—¶é—´ï¼ˆLOG Format æ ¼å¼ï¼‰ $cookie_NAME #å®¢æˆ·ç«¯è¯·æ±‚Headerå¤´ä¸­çš„cookieå˜é‡ï¼Œå‰ç¼€\u0026#34;$cookie_\u0026#34;åŠ ä¸Šcookieåç§°çš„å˜é‡ï¼Œè¯¥å˜é‡çš„å€¼å³ä¸ºcookieåç§°çš„å€¼ $http_NAME #åŒ¹é…ä»»æ„è¯·æ±‚å¤´å­—æ®µï¼›å˜é‡åä¸­çš„ååŠéƒ¨åˆ†NAMEå¯ä»¥æ›¿æ¢æˆä»»æ„è¯·æ±‚å¤´å­—æ®µï¼Œå¦‚åœ¨é…ç½®æ–‡ä»¶ä¸­éœ€è¦è·å–httpè¯·æ±‚å¤´ï¼š\u0026#34;Accept-Language\u0026#34;ï¼Œ$http_accept_languageå³å¯ $http_cookie $http_host #è¯·æ±‚åœ°å€ï¼Œå³æµè§ˆå™¨ä¸­ä½ è¾“å…¥çš„åœ°å€ï¼ˆIPæˆ–åŸŸåï¼‰ $http_referer #urlè·³è½¬æ¥æº,ç”¨æ¥è®°å½•ä»é‚£ä¸ªé¡µé¢é“¾æ¥è®¿é—®è¿‡æ¥çš„ $http_user_agent #ç”¨æˆ·ç»ˆç«¯æµè§ˆå™¨ç­‰ä¿¡æ¯ $http_x_forwarded_for $sent_http_NAME #å¯ä»¥è®¾ç½®ä»»æ„httpå“åº”å¤´å­—æ®µï¼›å˜é‡åä¸­çš„ååŠéƒ¨åˆ†NAMEå¯ä»¥æ›¿æ¢æˆä»»æ„å“åº”å¤´å­—æ®µï¼Œå¦‚éœ€è¦è®¾ç½®å“åº”å¤´Content-lengthï¼Œ$sent_http_content_lengthå³å¯ $sent_http_cache_control $sent_http_connection $sent_http_content_type $sent_http_keep_alive $sent_http_last_modified $sent_http_location $sent_http_transfer_encoding Nginxä¹‹é—´çš„æ—¥å¿—è¿½è¸ª åœ¨å½“ä»Šäº’è”ç½‘æ¶æ„ä¸­ï¼ŒWebåº”ç”¨é˜²ç«å¢™ï¼ˆWAFï¼‰ä¸Nginxä½œä¸ºå‰ç«¯ä»£ç†çš„æ•´åˆè¶Šæ¥è¶Šå¸¸è§ï¼Œç‰¹åˆ«æ˜¯åœ¨æå‡Webåº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§æ–¹é¢ã€‚è¿™ç§ç»“æ„ä¸ä»…å¢å¼ºäº†å¯¹åº”ç”¨çš„ä¿æŠ¤ï¼Œè¿˜æå‡äº†ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚åœ¨è¿™ç§æ¶æ„ä¸­ï¼Œç†è§£WAFä¸Nginxå¦‚ä½•åä½œï¼Œä»¥åŠå¦‚ä½•å®ç°æ—¥å¿—è¿½è¸ªçš„æ•´åˆå°¤ä¸ºé‡è¦ã€‚\nWAFä¸Nginxåä½œåŸç† WAFé€šå¸¸ä½œä¸ºNginxçš„ä¸Šæ¸¸ç»„ä»¶éƒ¨ç½²ï¼Œæ‹¦æˆªå‘Webåº”ç”¨ç¨‹åºå‘èµ·çš„è¯·æ±‚ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯è¯„ä¼°æ¯ä¸ªè¯·æ±‚ä¸­çš„æ½œåœ¨å¨èƒï¼Œå¦‚SQLæ³¨å…¥ã€è·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰ç­‰ï¼Œç„¶åæ ¹æ®é¢„å®šä¹‰çš„è§„åˆ™é›†æ¥å†³å®šæ˜¯å¦å…è®¸è¯·æ±‚é€šè¿‡ã€‚é€šè¿‡ä¸Nginxçš„ç´§å¯†åä½œï¼ŒWAFèƒ½å¤Ÿåœ¨è¯·æ±‚åˆ°è¾¾åº”ç”¨æœåŠ¡å™¨ä¹‹å‰æä¾›ä¸€å±‚é¢å¤–çš„ä¿æŠ¤ã€‚\nåœ¨è¯·æ±‚å’Œå“åº”è¿‡ç¨‹ä¸­ï¼ŒWAFä¸Nginxä¹‹é—´çš„äº¤äº’æ¶‰åŠåˆ°è¯·æ±‚çš„æ¥æ”¶ã€åˆ†æã€å¤„ç†å’Œè½¬å‘ã€‚å½“WAFæ£€æµ‹åˆ°æ½œåœ¨å¨èƒæ—¶ï¼Œå¯ä»¥å†³å®šç›´æ¥é˜»æ­¢è¯¥è¯·æ±‚ï¼Œæˆ–è€…å°†å…¶è½¬å‘ç»™Nginxè¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ã€‚\næ—¥å¿—é›†æˆæŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ åœ¨å°†WAFä¸Nginxæ•´åˆè¿›ä¸€è‡´æ€§å’Œå¯è¿½æº¯æ€§çš„æ—¥å¿—ç³»ç»Ÿæ—¶ï¼Œé¢ä¸´çš„æŒ‘æˆ˜ä¸»è¦åŒ…æ‹¬è·¨ç»„ä»¶çš„æ—¥å¿—åŒæ­¥å’Œå…³è”ã€‚æ—¥å¿—è®°å½•éœ€è¦ä»WAFåˆ°Nginxï¼Œå†åˆ°åº”ç”¨æœåŠ¡å™¨ï¼Œå½¢æˆä¸€ä¸ªè¿ç»­çš„é“¾è·¯ï¼Œä»¥ç¡®ä¿å¯¹æ•´ä¸ªè¯·æ±‚-å“åº”å‘¨æœŸçš„å®Œå…¨å¯è§æ€§ã€‚\nä¸ºäº†è§£å†³è¿™ä¸€æŒ‘æˆ˜ï¼Œä¸€ç§æ–¹æ³•æ˜¯åœ¨æ‰€æœ‰ç»„ä»¶ä¸­ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—IDã€‚é€šè¿‡åœ¨HTTPå¤´éƒ¨æ’å…¥ä¸€ä¸ªå”¯ä¸€çš„è·Ÿè¸ªæ ‡è¯†ç¬¦ï¼Œä¾‹å¦‚é€šè¿‡X-Request-IDï¼Œå¯ä»¥è·¨å¤šä¸ªç³»ç»Ÿè·Ÿè¸ªå•ä¸ªè¯·æ±‚ï¼Œä»è€Œç®€åŒ–æ—¥å¿—æ•°æ®çš„å…³è”å’Œåˆ†æã€‚\nç”¨æˆ·è®¿é—®æµç¨‹æ—¥å¿—åˆ†æ æ€»ç»“ï¼šé˜¿é‡Œäº‘çš„WAFæ—¥å¿—æ›´åŠ è¯¦ç»†ï¼ŒNginxå±‚é¢çš„æ—¥å¿—ä¹Ÿæ˜¯WAFè¿‡æ¥çš„ï¼ˆæ•°æ®ä¸€æ ·çš„ï¼‰\nä¸‹æ–¹ä¸‰ä¸ªæˆªå›¾çš„æ•°æ®æ—¥å¿—ï¼Œå°±æ˜¯ä¸€æ¡çš„è¯·æ±‚çš„è®¿é—®ã€‚æ•°æ®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå„ä¸ªå±‚é¢éƒ½æœ‰æ—¥å¿—è®°å½•ã€‚æ¯«æ— ç–‘é—® WAFæ›´åŠ ä¸“ä¸š ï¼Œå›¾åƒåŒ–æ›´å¤šã€‚ é˜¿é‡Œäº‘çš„WAF Nginxä¸­è½¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 server { listen 80; server_name bd.xxx.com ; rewrite ^/(.*)$ https://$host/$1 permanent; } server { listen 443 ssl; server_name bd.xxx.com; ssl on; ssl_certificate /usr/local/openresty/nginx/ssl/xx.com.crt; ssl_certificate_key /usr/local/openresty/nginx/ssl/xxx.com.key; include ssl.conf; location / { proxy_pass http://172.18.199.115:8085; include https_proxy.conf; } } Nginxå‰ç«¯ å‰ç«¯æœºå™¨ï¼š172.18.199.115\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 server { listen 8085; server_name bd.xxxx.com; root /opt/mfbd/dist; index index.html index.htm; location / { try_files $uri /index.html; add_header Access-Control-Allow-Origin *; add_header Access-Control-Allow-Headers Content-Type; add_header Access-Control-Allow-Methods GET,POST,OPTIONS; add_header Access-Control-Allow-Credentials true; } } æ—¥å¿—åˆ†æä¸å¯è§†åŒ– åˆ©ç”¨è‡ªå®šä¹‰æ—¥å¿—æ•°æ®è¿›è¡Œæ—¥å¿—åˆ†æä¸å¯è§†åŒ–æ˜¯æé«˜å®‰å…¨æ€§å’Œå“åº”èƒ½åŠ›çš„å…³é”®ã€‚é€šè¿‡é›†æˆSIEMå·¥å…·ã€ELKæ ˆï¼ˆElasticsearchã€Logstashã€Kibanaï¼‰æˆ–å…¶ä»–æ—¥å¿—åˆ†æå¹³å°ï¼Œå¯ä»¥å¯¹æ—¥å¿—æ•°æ®è¿›è¡Œå®æ—¶ç›‘æ§ã€å¼‚å¸¸æ£€æµ‹å’Œæ”»å‡»è¡Œä¸ºåˆ†æã€‚è¿™äº›å·¥å…·èƒ½å¤Ÿå¸®åŠ©å›¢é˜Ÿå¿«é€Ÿè¯†åˆ«å¹¶å“åº”å®‰å…¨å¨èƒï¼ŒåŒæ—¶æä¾›ç›´è§‚çš„æ•°æ®å¯è§†åŒ–ï¼Œä»¥ä¾¿æ·±å…¥ç†è§£å’Œæ”¹è¿›å®‰å…¨ç­–ç•¥ã€‚\nç»¼ä¸Šæ‰€è¿°ï¼ŒWAFä¸Nginxå‰ç«¯ä»£ç†çš„æ•´åˆä¸ä»…åŠ å¼ºäº†Webåº”ç”¨çš„å®‰å…¨å±‚ï¼Œè€Œä¸”é€šè¿‡æœ‰æ•ˆçš„æ—¥å¿—è¿½è¸ªå’Œåˆ†æï¼Œä¸ºå›¢é˜Ÿæä¾›äº†å…³é”®çš„æ´å¯Ÿï¼Œä»¥æŒç»­æ”¹è¿›å®‰å…¨å§¿æ€å’Œå“åº”èƒ½åŠ›ã€‚\nå‚è€ƒæ–‡æ¡£ï¼š\nhttps://www.cnblogs.com/ouym/p/15393191.html\nhttps://www.iminling.com/2023/10/04/272.html\nhttps://opswill.com/articles/nginx-custom-access-log-format.html\n","date":"2024-04-10T17:25:30Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/202404101725/","title":"Nginxæ—¥å¿—æ ¼å¼åŒ–å’Œè¿½è¸ª"},{"content":"MongoDBå’ŒLVMå¿«ç…§æ¦‚è¿° MongoDBçš„é‡è¦æ€§ï¼šMongoDBæ”¯æŒçš„çµæ´»çš„æ–‡æ¡£æ¨¡å‹ï¼Œä½¿å…¶æˆä¸ºå¤„ç†å¤§é‡åˆ†æ•£æ•°æ®çš„ç†æƒ³é€‰æ‹©ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦å¿«é€Ÿè¿­ä»£å’Œé¢‘ç¹æ›´æ”¹æ•°æ®ç»“æ„çš„åº”ç”¨ä¸­ã€‚\nLVMï¼ˆé€»è¾‘å·ç®¡ç†ï¼‰å¿«ç…§æŠ€æœ¯åŸºæœ¬æ¦‚å¿µï¼šLVMå…è®¸åœ¨ä¸åœæ­¢æ•°æ®åº“æœåŠ¡çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºæ•°æ®åœ¨æŸä¸€æ—¶é—´ç‚¹çš„å¿«ç…§ã€‚è¿™æ„å‘³ç€å¯ä»¥åœ¨ä¸å½±å“æ•°æ®åº“æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒçš„æƒ…å†µä¸‹è¿›è¡Œå¤‡ä»½ã€‚\nåº”ç”¨æ–¹é¢ 1ã€å¤‡ä»½ï¼ˆæ¢å¤ï¼‰çš„é‡è¦æ€§ï¼š\nå¤‡ä»½MongoDBæ•°æ®å¯¹äºç¡®ä¿æ•°æ®å®‰å…¨å’Œä¸šåŠ¡è¿ç»­æ€§è‡³å…³é‡è¦ã€‚æ— è®ºæ˜¯å› ä¸ºç¡¬ä»¶æ•…éšœã€è½¯ä»¶æ•…éšœã€è¿˜æ˜¯äººä¸ºé”™è¯¯ï¼Œæ•°æ®ä¸¢å¤±çš„åæœéƒ½å¯èƒ½æ˜¯ç¾éš¾æ€§çš„ã€‚å®šæœŸå¤‡ä»½å¯ä»¥æœ€å°åŒ–è¿™äº›é£é™©ï¼Œç¡®ä¿åœ¨å‡ºç°é—®é¢˜æ—¶å¯ä»¥å¿«é€Ÿæ¢å¤ã€‚\n2ã€æµ‹è¯•å’Œå¼€å‘ç¯å¢ƒçš„åˆ›å»º\nåœ¨æµ‹è¯•å’Œå¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªä¸ç”Ÿäº§ç¯å¢ƒç›¸åŒçš„æ•°æ®åº“å‰¯æœ¬ã€‚é€šè¿‡ä½¿ç”¨å¿«ç…§ï¼Œå¯ä»¥åœ¨æµ‹è¯•å’Œå¼€å‘ç¯å¢ƒä¸­å¿«é€Ÿåˆ›å»ºä¸€ä¸ªå…·æœ‰ç›¸åŒæ•°æ®å’Œç»“æ„çš„æ•°æ®åº“å‰¯æœ¬ï¼Œä»¥ä¾¿è¿›è¡Œæœ‰æ•ˆçš„æµ‹è¯•å’Œå¼€å‘å·¥ä½œã€‚\n3ã€æ•°æ®åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆ\næŸäº›æƒ…å†µä¸‹ï¼Œéœ€è¦å¯¹æ•°æ®åº“è¿›è¡Œç¦»çº¿åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆã€‚é€šè¿‡ä½¿ç”¨å¿«ç…§ï¼Œåœ¨ä¸å½±å“ç”Ÿäº§ç¯å¢ƒçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åœ¨å¤‡ä»½ä¸­åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼Œç”¨äºæ•°æ®åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆï¼Œè€Œä¸ä¼šå¯¹ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚\nLVMå¿«ç…§çš„ä¼˜åŠ¿ ä½¿ç”¨LVMå¿«ç…§ä½œä¸ºMongoDBå¤‡ä»½ç­–ç•¥çš„ä¼˜ç‚¹åŒ…æ‹¬ï¼š\nå¿«é€Ÿå¤‡ä»½ï¼šèƒ½å¤Ÿè¿…é€Ÿæ•æ‰åˆ°æ•°æ®çš„ç¬æ—¶çŠ¶æ€ï¼Œå‡å°‘å¤‡ä»½æ—¶é—´ã€‚ æœ€å°åŒ–åœæœºæ—¶é—´ï¼šå¤‡ä»½è¿‡ç¨‹ä¸­ä¸éœ€è¦åœæ­¢æœåŠ¡ï¼Œè¿™å¯¹äºéœ€è¦24/7è¿è¡Œçš„ä¸šåŠ¡è‡³å…³é‡è¦ã€‚ æœ‰æ•ˆåœ°æ¢å¤æ•°æ®ï¼šå¯ä»¥ç²¾ç¡®åˆ°å¤‡ä»½æ—¶çš„çŠ¶æ€æ¢å¤æ•°æ®ï¼Œæé«˜æ¢å¤æ•ˆç‡ã€‚ ç¯å¢ƒå‡†å¤‡ è¿›è¡ŒMongoDBå¤‡ä»½å‰çš„ç¯å¢ƒå‡†å¤‡åŒ…æ‹¬ï¼š\nç¡®ä¿å·²å®‰è£…LVMå¹¶æ­£ç¡®é…ç½®å­˜å‚¨ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 sudo yum install lvm2 é¦–å…ˆï¼Œè¯†åˆ«å¯ç”¨çš„ç£ç›˜æˆ–åˆ†åŒºï¼ˆä¾‹å¦‚ï¼Œ/dev/sdbï¼‰å¹¶åˆ›å»ºç‰©ç†å·ï¼š sudo pvcreate /dev/sdb å±•ç¤ºæ•ˆæœï¼šè¯¥å‘½ä»¤åº”è¿”å›â€œPhysical volume \u0026#34;/dev/sdb\u0026#34; successfully createdâ€çš„ä¿¡æ¯ã€‚ æ¥ç€ï¼Œåˆ›å»ºä¸€ä¸ªå·ç»„ï¼ŒåŠ å…¥åˆšåˆ›å»ºçš„ç‰©ç†å·ï¼š sudo vgcreate vg0 /dev/sdb å±•ç¤ºæ•ˆæœï¼šè¿”å›â€œVolume group \u0026#34;vg0\u0026#34; successfully createdâ€è¡¨æ˜å·ç»„åˆ›å»ºæˆåŠŸã€‚ æ­¥éª¤ä¸‰ï¼šåˆ›å»ºé€»è¾‘å· æœ€åï¼Œåœ¨å·ç»„å†…åˆ›å»ºé€»è¾‘å·ç”¨äºMongoDBæ•°æ®å­˜å‚¨ï¼š sudo lvcreate -L 10G -n mongo_data vg0 å±•ç¤ºæ•ˆæœï¼šåº”è¿”å›â€œLogical volume \u0026#34;mongo_data\u0026#34; createdâ€çš„æ¶ˆæ¯ã€‚ MongoDBæ•°æ®åº“è¿è¡Œåœ¨æ”¯æŒLVMçš„å­˜å‚¨å·ä¸Šã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 é…ç½®MongoDBä»¥ä½¿ç”¨é€»è¾‘å· ä¿®æ”¹MongoDBçš„é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸ä¸º/etc/mongod.confï¼‰ï¼ŒæŒ‡å®šæ•°æ®å­˜å‚¨è·¯å¾„åˆ°åˆšåˆ›å»ºçš„é€»è¾‘å·ä¸Šçš„æŸä¸ªç›®å½•ï¼š storage: dbPath: \u0026#34;/mnt/mongo_data\u0026#34; ç„¶åï¼Œå°†MongoDBæ•°æ®ç›®å½•ç§»åŠ¨åˆ°æ–°çš„ä½ç½®ï¼Œå¹¶ä¿®æ”¹ç›®å½•æƒé™ï¼š sudo mkdir /mnt/mongo_data sudo mount /dev/vg0/mongo_data /mnt/mongo_data sudo rsync -av /var/lib/mongo/ /mnt/mongo_data sudo chown -R mongodb:mongodb /mnt/mongo_data éªŒè¯ç³»ç»Ÿçš„æ€§èƒ½å’Œå­˜å‚¨ç©ºé—´ï¼Œç¡®ä¿å¿«ç…§æ“ä½œä¸ä¼šå¯¼è‡´æ€§èƒ½ç“¶é¢ˆæˆ–ç©ºé—´è€—å°½ã€‚ 1 2 htop htopå°†æ˜¾ç¤ºCPUå’Œå†…å­˜çš„å®æ—¶ä½¿ç”¨æƒ…å†µï¼Œç”¨æˆ·éœ€è¦ç¡®ä¿åœ¨åˆ›å»ºå¿«ç…§æœŸé—´ï¼Œè¿™äº›èµ„æºçš„ä½¿ç”¨ä¸ä¼šè¾¾åˆ°é¥±å’Œ æ­¥éª¤è¯¦è§£ ç¡®è®¤MongoDBæ•°æ®åº“çš„å­˜å‚¨å· é¦–å…ˆï¼Œä½¿ç”¨lvdisplayå‘½ä»¤æ¥æŸ¥æ‰¾MongoDBæ•°æ®å­˜å‚¨åœ¨å“ªä¸ªé€»è¾‘å·ä¸Šï¼š\n1 lvdisplay è¿™ä¸ªå‘½ä»¤ä¼šåˆ—å‡ºç³»ç»Ÿä¸­æ‰€æœ‰çš„é€»è¾‘å·ã€‚ä½ éœ€è¦æ‰¾åˆ°ä¸MongoDBæ•°æ®ç›¸å…³è”çš„é€»è¾‘å·ä¿¡æ¯ï¼Œæ¯”å¦‚å·åï¼ˆVolume Nameï¼‰ã€å·ç»„åï¼ˆVG Nameï¼‰ç­‰ã€‚\nåˆ›å»ºå¿«ç…§å· **æ³¨æ„ï¼šåœ¨æ‰§è¡Œçš„æ—¶å€™éœ€è¦å…³é—­æ•°æ®åº“ï¼Œä»¥é˜²æ­¢æœ‰æ•°æ®ç»§ç»­å†™å…¥ï¼ˆ**â€‹systemctl stop mongodâ€‹ ï¼‰\næ¥ç€ï¼Œæ ¹æ®ç¡®è®¤çš„MongoDBæ•°æ®å·ï¼Œä½¿ç”¨lvcreateå‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„å¿«ç…§å·ã€‚ä¾‹å¦‚ï¼Œå¦‚æœMongoDBæ•°æ®å­˜å‚¨åœ¨åä¸ºmongo_dataçš„é€»è¾‘å·ä¸Šï¼Œä½äºå·ç»„vg0ä¸­ï¼Œå¯ä»¥æ‰§è¡Œï¼š\n1 sudo lvcreate --size 1G --snapshot --name mongo_backup /dev/vg0/mongo_data è¿™ä¸ªå‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ªåä¸ºmongo_backupçš„å¿«ç…§å·ï¼Œå¤§å°ä¸º1GBã€‚\næŒ‚è½½å¿«ç…§å·å¹¶å¤‡ä»½ åˆ›å»ºå¿«ç…§å·åï¼Œéœ€è¦å°†å…¶æŒ‚è½½åˆ°ç³»ç»Ÿçš„ä¸€ä¸ªç›®å½•ä¸Šï¼Œä»¥ä¾¿è®¿é—®å’Œå¤‡ä»½æ•°æ®ã€‚é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œç„¶åæŒ‚è½½å¿«ç…§å·ï¼š\n1 2 sudo mkdir /mnt/mongo_backup sudo mount /dev/vg0/mongo_backup /mnt/mongo_backup æŒ‚è½½å®Œæˆåï¼Œä½¿ç”¨æ ‡å‡†å¤‡ä»½å·¥å…·ï¼ˆå¦‚taræˆ–rsyncï¼‰å¤‡ä»½æ•°æ®ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨taråˆ›å»ºä¸€ä¸ªå‹ç¼©çš„å¤‡ä»½æ–‡ä»¶ï¼š\n1 sudo tar czf /path/to/backup/mongo_backup.tar.gz /mnt/mongo_backup å¸è½½å¿«ç…§å·å¹¶åˆ é™¤ å¤‡ä»½å®Œæˆåï¼Œä¸è¦å¿˜è®°å¸è½½å¿«ç…§å·å¹¶åˆ é™¤å®ƒï¼Œä»¥é‡Šæ”¾ç©ºé—´ï¼š\n1 2 sudo umount /mnt/mongo_backup sudo lvremove /dev/vg0/mongo_backup åœ¨åˆ é™¤å¿«ç…§å·æ—¶ï¼Œç³»ç»Ÿä¼šè¯¢é—®ä½ æ˜¯å¦ç¡®å®šåˆ é™¤ï¼Œè¾“å…¥yç¡®è®¤ã€‚\nå¿«ç…§æ¢å¤æµç¨‹ å‡†å¤‡æ¢å¤ç¯å¢ƒ åœ¨æ¢å¤æ•°æ®ä¹‹å‰ï¼Œç¡®ä¿ç›®æ ‡ä½ç½®æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥æ”¶ä»å¿«ç…§ä¸­æ¢å¤çš„æ•°æ®ã€‚å¯ä»¥ä½¿ç”¨df -hå‘½ä»¤æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼Œå¹¶æ ¹æ®éœ€è¦æ¸…ç†æˆ–æ·»åŠ å­˜å‚¨ç©ºé—´ã€‚\nä½¿ç”¨å¿«ç…§æ•°æ®æ¢å¤ åœ¨è¿›è¡Œæ•°æ®æ¢å¤ä¹‹å‰ï¼Œç¡®ä¿MongoDBæœåŠ¡å·²åœæ­¢ï¼Œä»¥é¿å…æ•°æ®æ¢å¤è¿‡ç¨‹ä¸­çš„å†²çªã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœæ­¢MongoDBæœåŠ¡ï¼š\n1 sudo systemctl stop mongod ç„¶åï¼Œå°†å¿«ç…§æ•°æ®æ¢å¤åˆ°MongoDBçš„æ•°æ®ç›®å½•ä¸­ã€‚é¦–å…ˆï¼Œç¡®è®¤å¿«ç…§æŒ‚è½½ç‚¹å’ŒMongoDBçš„æ•°æ®ç›®å½•è·¯å¾„ã€‚å‡è®¾å¿«ç…§æŒ‚è½½åœ¨/mnt/mongo_backupï¼ŒMongoDBæ•°æ®ç›®å½•ä¸º/var/lib/mongoï¼Œå¯ä»¥ä½¿ç”¨rsyncè¿›è¡Œæ•°æ®æ¢å¤ï¼š\n1 sudo rsync -av /mnt/mongo_backup/ /var/lib/mongo/ ç¡®ä¿ä½¿ç”¨ç»“æŸæ–œæ /æ¥æŒ‡ç¤ºåŒæ­¥ç›®å½•å†…å®¹è€Œéç›®å½•æœ¬èº«ã€‚\nå¯åŠ¨MongoDBæœåŠ¡ æ•°æ®æ¢å¤å®Œæˆåï¼Œé‡å¯MongoDBæœåŠ¡ï¼Œå¹¶éªŒè¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ï¼š\n1 sudo systemctl start mongod é‡å¯æœåŠ¡åï¼Œæ£€æŸ¥MongoDBçš„æ—¥å¿—æ–‡ä»¶ï¼Œç¡®ä¿æ²¡æœ‰å¯åŠ¨é”™è¯¯ï¼Œå¹¶è¿›è¡Œå¿…è¦çš„æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ã€‚ä½¿ç”¨MongoDBå®¢æˆ·ç«¯æˆ–åº”ç”¨ç¨‹åºéªŒè¯æ•°æ®å®Œæ•´æ€§å’Œè®¿é—®æ€§ã€‚\nMongoDBï¼Œä½œä¸ºä¸€ä¸ªé«˜æ€§èƒ½ã€å¼€æºã€æ— æ¨¡å¼çš„æ–‡æ¡£æ•°æ®åº“ï¼Œå› å…¶é«˜å¯ä¼¸ç¼©æ€§å’Œçµæ´»æ€§è€Œå—åˆ°å¹¿æ³›æ¬¢è¿ã€‚ç„¶è€Œï¼Œæ­£å¦‚ä»»ä½•æŠ€æœ¯ä¸“å®¶æ‰€çŸ¥ï¼Œæ— è®ºæ•°æ®åº“çš„å¼ºå¤§ä¸å¦ï¼Œæ•°æ®å¤‡ä»½å’Œæ¢å¤è®¡åˆ’çš„é‡è¦æ€§éƒ½ä¸å¯å¿½è§†ã€‚æœ¬æ–‡å°†æ¢è®¨å¦‚ä½•åˆ©ç”¨é€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰å¿«ç…§æŠ€æœ¯æ¥å¤‡ä»½MongoDBæ•°æ®åº“ï¼Œç¡®ä¿æ•°æ®çš„å®‰å…¨å’Œä¸šåŠ¡çš„è¿ç»­æ€§ã€‚\nä¸šåŠ¡å®æˆ˜ ï¼ˆæ•°æ®åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆï¼šæŸäº›æƒ…å†µä¸‹ï¼Œéœ€è¦å¯¹æ•°æ®åº“è¿›è¡Œç¦»çº¿åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆã€‚é€šè¿‡ä½¿ç”¨å¿«ç…§ï¼Œåœ¨ä¸å½±å“ç”Ÿäº§ç¯å¢ƒçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åœ¨å¤‡ä»½ä¸­åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼Œç”¨äºæ•°æ®åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆï¼Œè€Œä¸ä¼šå¯¹ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ï¼‰ã€‚\nè´¢åŠ¡æŠ¥è¡¨çš„å‡†ç¡®æ€§å¯¹äºå…¬å¸çš„åŠæ—¶å†³ç­–è‡³å…³é‡è¦ã€‚å½“å‰ï¼ŒæŠ¥è¡¨ç›´æ¥åœ¨ä¸šåŠ¡æ•°æ®åº“ä¸Šè¿è¡Œï¼Œä¸ä»…è€—æ—¶é•¿ï¼Œè€Œä¸”åœ¨æœˆåˆå‡ºæŠ¥æ—¶å¸¸å¸¸å¤±è´¥ï¼Œè¿™å¯¹è´¢åŠ¡éƒ¨é—¨å’Œå…¬å¸å†³ç­–äº§ç”Ÿäº†å½±å“ã€‚éšç€å…¬å¸ä¸šåŠ¡è§„æ¨¡çš„æŒç»­å¢é•¿ï¼Œç°æœ‰çš„æŠ¥è¡¨è¿è¡Œæ–¹å¼å·²ä¸å†é€‚ç”¨ã€‚\næˆ‘ä»¬çš„ä¸šåŠ¡æ•°æ®æ¯æ—¥å‡Œæ™¨ä»å¤šä¸ªä¸šåŠ¡æ•°æ®åº“åŒæ­¥åˆ°æ•°æ®ä»“åº“ä¸­ã€‚æ•°æ®åŒæ­¥çš„è€—æ—¶é•¿æ„å‘³ç€ï¼ŒåŒæ­¥å®Œæˆæ—¶çš„æ•°æ®å·²ä¸å†æ˜¯æŸä¸€æ—¶åˆ»çš„ç²¾å‡†å¿«ç…§ï¼ˆå› ä¸ºä¸šåŠ¡æ•°æ®åº“åœ¨ä¸æ–­æ›´æ–°ï¼‰ã€‚\néœ€æ±‚ï¼šæˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½å°†æ•°æ®ä»MongoDBä¸šåŠ¡æ•°æ®åº“ç²¾å‡†åŒæ­¥åˆ°é˜¿é‡Œäº‘MaxComputeæ•°æ®ä»“åº“çš„ç®€å•ä¸”å¯é æ–¹æ¡ˆã€‚ç®€å•æ€§è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒèƒ½æé«˜ç³»ç»Ÿçš„å¯é æ€§ã€‚ç†æƒ³çš„è§£å†³æ–¹æ¡ˆä¸­åº”é¿å…ä½¿ç”¨å¤æ‚çš„è‡ªç¼–è„šæœ¬æ¥å¤„ç†ä¸»ä»åŒæ­¥çš„ç»†èŠ‚ï¼Œä¾‹å¦‚ç¡®å®šbinlogçš„ä½ç½®æˆ–æ—¶é—´ç‚¹ç­‰æŠ€æœ¯æ ˆï¼Œè€Œæ˜¯åº”å°½å¯èƒ½ä½¿ç”¨å°è£…è‰¯å¥½çš„æŠ€æœ¯è§£å†³æ–¹æ¡ˆã€‚æ•°æ®çš„ç²¾ç¡®æ€§éå¸¸å…³é”®ï¼Œä»»ä½•é”™è¯¯éƒ½å¯èƒ½å¯¼è‡´ä¸å¯é€†çš„åæœã€‚\næ€è·¯ï¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„LVMå¿«ç…§æŠ€æœ¯ï¼Œå¯ä»¥åœ¨æŸä¸€æ—¶åˆ»å°†åŸºäºMongoDBçš„ä¸šåŠ¡æ•°æ®åº“æ•°æ®ç²¾å‡†åŒæ­¥åˆ°å¦ä¸€ä¸ªMongoDBæ•°æ®åº“ä¸­ã€‚è¿™æ ·ï¼ŒMaxComputeå°±å¯ä»¥ä»åè€…è·å–æ•°æ®ï¼Œè¿›è¡ŒåŒæ­¥ä»»åŠ¡ã€‚\nå®è·µï¼šä»¥æ ¸å¿ƒç³»ç»Ÿçš„MongoDBæ•°æ®åº“ä¸ºä¾‹ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•å°†æ•°æ®ç²¾å‡†åŒæ­¥åˆ°æ•°æ®ä»“åº“ä¸­ï¼Œä»è€Œä¸ºè´¢åŠ¡æŠ¥è¡¨çš„ç”Ÿæˆæä¾›å¯é çš„æ•°æ®åŸºç¡€ã€‚ å®è·µæ­¥éª¤ 1. å‡†å¤‡å·¥ä½œ é¦–å…ˆï¼Œç¡®ä¿å·²ç»åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…å¹¶é…ç½®äº†MongoDBï¼Œå¹¶ä¸”æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ç”¨äºåˆ›å»ºå¿«ç…§ã€‚\n2. è‡ªåŠ¨åŒ–è„šæœ¬ ä¸ºäº†å®ç°è¿™ä¸€è¿‡ç¨‹çš„è‡ªåŠ¨åŒ–ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªMongoDBè„šæœ¬å’Œä¸€ä¸ªShellè„šæœ¬ã€‚MongoDBè„šæœ¬ç”¨äºé”å®šæ•°æ®åº“ï¼Œè§¦å‘å¿«ç…§çš„åˆ›å»ºï¼Œç„¶åè§£é”æ•°æ®åº“ã€‚Shellè„šæœ¬è´Ÿè´£å®é™…åˆ›å»ºLVMå¿«ç…§ã€‚\nMongoDB è„šæœ¬ (snapshot.js) è¿™ä¸ªJavaScriptè„šæœ¬æ˜¯ä¸ºäº†åœ¨MongoDBæ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®å¿«ç…§ï¼ŒåŒæ—¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œè€Œè®¾è®¡çš„ã€‚è¿™æ˜¯é€šè¿‡åœ¨ä¸å®Œå…¨åœæ­¢æ•°æ®åº“æœåŠ¡çš„æƒ…å†µä¸‹â€œé”å®šâ€æ•°æ®åº“æ¥å®ç°çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 conn = new Mongo(); db = conn.getDB(\u0026#34;admin\u0026#34;); db.auth(\u0026#39;root\u0026#39;,\u0026#39;xxx\u0026#39;); db = db.getSiblingDB(\u0026#39;æ•°æ®åº“åç§°\u0026#39;); session = db.getMongo().startSession(); session.startTransaction(); db.fsyncLock(); run(\u0026#39;/opt/mongodb_snap.sh\u0026#39;); db.fsyncUnlock(); session.commitTransaction(); session.endSession(); conn.close(); å»ºç«‹è¿æ¥å’Œè®¤è¯ï¼š\nconn = new Mongo(); åˆ›å»ºä¸€ä¸ªæ–°çš„MongoDBè¿æ¥ã€‚ db = conn.getDB(\u0026quot;admin\u0026quot;); é€‰æ‹©adminæ•°æ®åº“è¿›è¡Œæ“ä½œã€‚ db.auth('root','xxx'); ä½¿ç”¨rootè´¦å·å’Œå¯¹åº”å¯†ç è¿›è¡Œè®¤è¯ã€‚ db = db.getSiblingDB('fubaodai'); åˆ‡æ¢åˆ°ç›®æ ‡æ•°æ®åº“fubaodaiï¼Œè¿™æ˜¯å®é™…è¦å¿«ç…§çš„æ•°æ®åº“ã€‚ äº‹åŠ¡å’Œé”å®šï¼š\nsession = db.getMongo().startSession(); å¯åŠ¨ä¸€ä¸ªæ–°çš„ä¼šè¯ã€‚ session.startTransaction(); åœ¨è¯¥ä¼šè¯ä¸­å¼€å§‹ä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚ db.fsyncLock(); é”å®šæ•°æ®åº“ï¼Œä»¥å‡†å¤‡è¿›è¡Œå¿«ç…§ã€‚è¿™ä¸ªæ“ä½œä¼šé˜»æ­¢å†™æ“ä½œï¼Œä½†è¯»æ“ä½œä»ç„¶å¯ä»¥ç»§ç»­ï¼Œä»è€Œä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§è€Œä¸å®Œå…¨åœæ­¢æœåŠ¡ã€‚ æ‰§è¡Œå¿«ç…§è„šæœ¬ï¼š\nrun('/opt/mongodb_snap.sh'); æ‰§è¡ŒShellè„šæœ¬/opt/mongodb_snap.shæ¥åˆ›å»ºä¸€ä¸ªLVMå¿«ç…§ã€‚æ³¨æ„ï¼Œrunå‡½æ•°åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­å¹¶ä¸æ˜¯MongoDB Shellçš„å†…ç½®å‡½æ•°ï¼Œè¿™é‡Œå‡è®¾å®ƒæ˜¯ä¸ºäº†è¯´æ˜ç›®çš„è€Œä½¿ç”¨çš„ã€‚åœ¨å®é™…MongoDB Shellè„šæœ¬ä¸­ï¼Œä½ å¯èƒ½éœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼è§¦å‘å¿«ç…§è„šæœ¬ï¼Œæ¯”å¦‚é€šè¿‡MongoDBçš„ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œæˆ–å¤–éƒ¨ç¨‹åºè°ƒåº¦ã€‚ è§£é”å’Œç»“æŸï¼š\ndb.fsyncUnlock(); è§£é”æ•°æ®åº“ï¼Œæ¢å¤æ­£å¸¸çš„è¯»å†™æ“ä½œã€‚ session.commitTransaction(); æäº¤äº‹åŠ¡ï¼Œè™½ç„¶è¿™é‡Œçš„äº‹åŠ¡ä¸»è¦ç”¨äºfsyncé”å®šå’Œè§£é”æ“ä½œã€‚ session.endSession(); ç»“æŸä¼šè¯ã€‚ conn.close(); å…³é—­ä¸MongoDBçš„è¿æ¥ã€‚ é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œè¿™ä¸ªè„šæœ¬ä½¿å¾—æ•°æ®åº“èƒ½å¤Ÿåœ¨ç¡®ä¿æ•°æ®ä¸€è‡´æ€§çš„åŒæ—¶ï¼Œè¿›è¡ŒLVMå¿«ç…§åˆ›å»ºï¼Œè€Œä¸éœ€è¦åœæœºæˆ–é‡å¯æœåŠ¡ã€‚è¿™å¯¹äºéœ€è¦24/7è¿è¡Œçš„ç”Ÿäº§ç¯å¢ƒå°¤ä¸ºé‡è¦ã€‚\nShell è„šæœ¬ (mongodb_snap.sh) 1 2 3 #!/bin/bash name=mongodb-$(date +%Y%m%d%H%M%S) /usr/sbin/lvcreate -s -L 100G -n $name /dev/mapper/data-mongodb è¿™äº›è„šæœ¬é€šè¿‡Cronä»»åŠ¡åœ¨æ¯å¤©é›¶ç‚¹è‡ªåŠ¨æ‰§è¡Œï¼Œä»¥ç¡®ä¿æ•°æ®åŒæ­¥çš„å‡†ç¡®æ€§å’ŒåŠæ—¶æ€§ã€‚\nè¦é€šè¿‡cronåœ¨å‡Œæ™¨è‡ªåŠ¨æ‰§è¡Œmongo --nodb mongodb_snap.jså‘½ä»¤ï¼Œä½ éœ€è¦æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š\nåœ¨ç»ˆç«¯ä¸­è¿è¡Œcrontab -eå‘½ä»¤ã€‚è¿™å°†æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå…è®¸ä½ ç¼–è¾‘å½“å‰ç”¨æˆ·çš„cronä½œä¸šã€‚\n1 0 1 * * * /usr/bin/mongo --nodb /path/to/mongodb_snap.js åœ¨æ¯å¤©çš„1:00 AMï¼Œæ‰§è¡Œ/usr/bin/mongo --nodb /path/to/mongodb_snap.jså‘½ä»¤ã€‚è¯·ç¡®ä¿æ ¹æ®ä½ çš„ç¯å¢ƒæ›¿æ¢/usr/bin/mongoå’Œ/path/to/mongodb_snap.jsä¸ºmongoå‘½ä»¤å’Œmongodb_snap.jsè„šæœ¬çš„å®é™…è·¯å¾„ã€‚\n3. æ•°æ®åŒæ­¥ å®ŒæˆLVMå¿«ç…§åï¼Œæˆ‘ä»¬å¯ä»¥å°†å¿«ç…§æ•°æ®åŒæ­¥åˆ°å¦ä¸€ä¸ªMongoDBæ•°æ®åº“å®ä¾‹ï¼Œè¯¥å®ä¾‹å°†ä½œä¸ºæ•°æ®ä»“åº“åŒæ­¥ä»»åŠ¡çš„æ•°æ®æºã€‚è¿™ä¿è¯äº†æ•°æ®ä»“åº“ä¸­çš„æ•°æ®æ—¢å‡†ç¡®åˆæ˜¯æœ€æ–°çš„ã€‚\næ€»ç»“ MongoDBæ•°æ®åº“çš„å¤‡ä»½å’Œæ¢å¤æ˜¯ç¡®ä¿æ•°æ®å®‰å…¨å’Œä¸šåŠ¡è¿ç»­æ€§çš„é‡è¦ç¯èŠ‚ã€‚é€šè¿‡ä½¿ç”¨LVMå¿«ç…§ä½œä¸ºå¤‡ä»½ç­–ç•¥ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¿«é€Ÿå¤‡ä»½MongoDBæ•°æ®ï¼Œæœ€å°åŒ–åœæœºæ—¶é—´ï¼Œå¹¶ä»¥é«˜æ•ˆçš„æ–¹å¼æ¢å¤æ•°æ®ã€‚è¿™ç§å¤‡ä»½æ–¹å¼çš„ä¼˜ç‚¹åœ¨äºå®ƒæä¾›äº†é«˜çº§åˆ«çš„æ•°æ®ä¿æŠ¤å’Œå¯é æ€§ï¼Œä½¿å¾—ä¼ä¸šèƒ½å¤Ÿåœ¨æ•°æ®é£é™©å’Œç¾éš¾å‘ç”Ÿæ—¶ä¿æŒé«˜åº¦çš„å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚\n","date":"2024-04-08T16:16:38Z","image":"https://www.ownit.top/title_pic/66.jpg","permalink":"https://www.ownit.top/p/202404081616/","title":"MongoDBå¿«ç…§ï¼ˆLVMï¼‰ä¸šåŠ¡åœºæ™¯åº”ç”¨å®æˆ˜"},{"content":"ç®€ä»‹ åœ¨ç°ä»£DevOpsç¯å¢ƒä¸­ï¼ŒNginxä½œä¸ºè´Ÿè½½å‡è¡¡å™¨ä¸Kubernetesçš„Ingressèµ„æºçš„ç»“åˆï¼Œä¸ºåº”ç”¨ç¨‹åºæä¾›äº†å¼ºå¤§çš„è·¯ç”±å’Œå®‰å…¨è§£å†³æ–¹æ¡ˆã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•åˆ©ç”¨Nginxçš„çµæ´»æ€§å’ŒåŠŸèƒ½ï¼Œå®ç°é«˜æ•ˆã€å®‰å…¨çš„å¤–éƒ¨è®¿é—®æ§åˆ¶ï¼Œä»¥åŠå¦‚ä½•é…ç½®Ingressä»¥ä¼˜åŒ–æµé‡ç®¡ç†å’ŒSSL/TLSæ”¯æŒã€‚\nNginx å¯ä»¥ä¸ Kubernetes çš„ Ingress èµ„æºé…åˆä½¿ç”¨ï¼Œä»¥æä¾›é«˜çº§çš„è·¯ç”±å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚Ingress å…è®¸ä½ é€šè¿‡å®šä¹‰è§„åˆ™æ¥ç®¡ç†å¤–éƒ¨è®¿é—®é›†ç¾¤å†…æœåŠ¡çš„è·¯å¾„ã€‚å½“ä¸ Nginx Ingress æ§åˆ¶å™¨ç»“åˆä½¿ç”¨æ—¶ï¼Œä½ å¯ä»¥åˆ©ç”¨ Nginx çš„å¼ºå¤§åŠŸèƒ½æ¥å¤„ç† HTTP å’Œ HTTPS æµé‡ï¼ŒåŒ…æ‹¬ SSL/TLS ç»ˆç«¯ã€è™šæ‹Ÿä¸»æœºã€é‡å†™å’Œæ›´å¤šã€‚ ç¯å¢ƒ NginxæœåŠ¡ï¼šéƒ¨ç½²åœ¨å…¬ç½‘ï¼ŒIPåœ°å€ä¸º172.1x.1x9.90ï¼Œä½œä¸ºé›†ç¾¤çš„å…¥å£ç‚¹ã€‚ å†…ç½‘ç¯å¢ƒï¼šåŸºäºKubernetesçš„é›†ç¾¤ï¼Œä½¿ç”¨Ingressèµ„æºç®¡ç†æœåŠ¡é—´çš„é€šä¿¡ã€‚ Nginxæ„å»ºæ­¥éª¤ å…¬ç½‘Nginxä¸ºå…¥å£ åœ¨ç°ä»£çš„ç½‘ç»œæ¶æ„ä¸­ï¼Œä½¿ç”¨ Nginx ä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨æ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬å°†å…¬ç½‘æµé‡æœ‰æ•ˆåœ°è½¬å‘åˆ°å†…ç½‘çš„åº”ç”¨ç¨‹åºæœåŠ¡å™¨ã€‚\nhttp_proxy.conf 1 2 3 4 5 6 [root@monitor conf]# cat http_proxy.conf proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_http_version 1.1; proxy_set_header Connection \u0026#34;\u0026#34;; è¿™æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œé€šå¸¸ç”¨äºè®¾ç½® HTTP ä»£ç†æœåŠ¡å™¨çš„è¡Œä¸ºã€‚ä¸‹é¢æ˜¯æ¯ä¸€è¡Œçš„è§£é‡Šï¼š\nproxy_set_header Host $host; è¿™ä¸€è¡Œè®¾ç½®ä»£ç†æœåŠ¡å™¨å‘ç›®æ ‡æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œå°†ä½¿ç”¨åŸå§‹è¯·æ±‚ä¸­çš„ Host å¤´éƒ¨ã€‚$host æ˜¯ Nginx é…ç½®ä¸­çš„å˜é‡ï¼Œä»£è¡¨è¯·æ±‚è¡Œä¸­çš„ä¸»æœºåã€‚ proxy_set_header X-Real-IP $remote_addr; è¿™é‡Œé…ç½®ä»£ç†æœåŠ¡å™¨å‘ç›®æ ‡æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œä¼šæ·»åŠ ä¸€ä¸ª X-Real-IP å¤´éƒ¨ï¼Œå…¶å€¼ä¸ºå‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯çš„ IP åœ°å€ã€‚$remote_addr æ˜¯ Nginx é…ç½®ä¸­çš„å˜é‡ï¼Œä»£è¡¨å®¢æˆ·ç«¯çš„ IP åœ°å€ã€‚ proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; è¿™ä¸€è¡Œé…ç½®ä»£ç†æœåŠ¡å™¨åœ¨å‘ç›®æ ‡æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œä¼šæ·»åŠ ä¸€ä¸ª X-Forwarded-For å¤´éƒ¨ï¼Œç”¨äºè¡¨ç¤ºå‘èµ·è¯·æ±‚çš„åŸå§‹å®¢æˆ·ç«¯çš„ IP åœ°å€ã€‚$proxy_add_x_forwarded_for æ˜¯ä¸€ä¸ªå˜é‡ï¼Œå®ƒåŒ…å«äº†åŸå§‹è¯·æ±‚ä¸­çš„ X-Forwarded-For å¤´éƒ¨çš„å€¼ï¼Œå¦‚æœæœ‰çš„è¯ã€‚ proxy_http_version 1.1;\nè¿™é‡ŒæŒ‡å®šä»£ç†æœåŠ¡å™¨ä½¿ç”¨ HTTP ç‰ˆæœ¬ 1.1 ä¸ç›®æ ‡æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚è¿™æ˜¯å› ä¸º HTTP/1.1 æ”¯æŒæŒä¹…è¿æ¥ï¼Œå¯ä»¥æé«˜æ€§èƒ½å’Œæ•ˆç‡ã€‚ proxy_set_header Connection \u0026quot;\u0026quot;;\nè¿™ä¸€è¡Œè®¾ç½®ä»£ç†æœåŠ¡å™¨å‘ç›®æ ‡æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼ŒConnection å¤´éƒ¨å°†ä¸ä¼šè¢«å‘é€ã€‚è¿™é€šå¸¸ç”¨äºé˜²æ­¢ç›®æ ‡æœåŠ¡å™¨å…³é—­è¿æ¥ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨ HTTP/1.1 æˆ– HTTP/2 æ—¶ï¼ŒæŒä¹…è¿æ¥æ˜¯æœ‰ç›Šçš„ã€‚ è¿™äº›é…ç½®é€šå¸¸ç”¨äºç¡®ä¿ä»£ç†æœåŠ¡å™¨æ­£ç¡®åœ°è½¬å‘å®¢æˆ·ç«¯çš„è¯·æ±‚åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼Œå¹¶ä¸”ç›®æ ‡æœåŠ¡å™¨èƒ½å¤Ÿæ¥æ”¶åˆ°æ­£ç¡®çš„åŸå§‹è¯·æ±‚ä¿¡æ¯ã€‚\nhttps_proxy.conf 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@monitor conf]# cat https_proxy.conf add_header Front-End-Https on; proxy_http_version 1.1; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Connection \u0026#34;\u0026#34;; proxy_set_header X-Forwarded-Proto https; proxy_set_header X-Forwarded-HTTPS on; proxy_connect_timeout 90; proxy_send_timeout 90; proxy_read_timeout 90; proxy_buffer_size 256k; proxy_buffers 4 256k; proxy_busy_buffers_size 256k; proxy_temp_file_write_size 256k; proxy_max_temp_file_size 8m; ssl.conf 1 2 3 4 5 6 7 8 9 10 11 12 [root@monitor conf]# cat ssl.conf ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers \u0026#34;ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4\u0026#34;; ssl_prefer_server_ciphers on; ssl_stapling on; ssl_stapling_verify off; resolver 223.5.5.5 223.6.6.6 valid=300s; resolver_timeout 10s; Serverçš„conf 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 server { listen 80; server_name admin-uat.xxx.net; rewrite ^/(.*)$ https://$host/$1 permanent; #å®ƒæ‰§è¡Œäº†ä¸€ä¸ªæ°¸ä¹…é‡å®šå‘ç­–ç•¥ï¼Œå¼ºåˆ¶æ‰€æœ‰HTTPæµé‡è½¬å‘HTTPSï¼ŒåŒæ—¶å¼•ç”¨äº†å…¬å¸ç™½åå•é…ç½®æ–‡ä»¶ï¼Œä»¥ç¡®ä¿åªæœ‰ç»è¿‡æˆæƒçš„ç”¨æˆ·æˆ–IPåœ°å€å¯ä»¥è®¿é—®æ­¤æœåŠ¡ã€‚ include /usr/local/openresty/nginx/whitelist/corporation.conf; } server { listen 443 ssl; server_name admin-uat.xxx.net; include /usr/local/openresty/nginx/whitelist/corporation.conf; ssl on; ssl_certificate /usr/local/openresty/nginx/ssl/xxx.net.crt; ssl_certificate_key /usr/local/openresty/nginx/ssl/xxx.net.key; include ssl.conf; location / { proxy_pass http://kubernetes-cluster; include https_proxy.conf; } } è¿™ä¸ªæœåŠ¡å™¨å—è´Ÿè´£å¤„ç†åŠ å¯†çš„HTTPSæµé‡ï¼Œé…ç½®äº†SSLè¯ä¹¦å’Œå¯†é’¥ä»¥ä¿è¯ä¼ è¾“å®‰å…¨ï¼Œå¹¶ä¸”åœ¨locationä¸Šä¸‹æ–‡ä¸­è®¾ç½®äº†ä»£ç†è½¬å‘è‡³åä¸ºkubernetes-clusterçš„ä¸Šæ¸¸æœåŠ¡å™¨ç»„ã€‚\næµé‡è¿›è¡Œè½¬å‘ 1 2 3 4 5 [root@monitor vhosts]# cat kubernetes-cluster.conf upstream kubernetes-cluster { server 192.168.82.42 weight=5; keepalive 16; } è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªä¸Šæ¸¸æœåŠ¡å™¨æ± ï¼ŒåŒ…å«äº†ä¸€å°å†…ç½‘IPåœ°å€ä¸º192.168.82.42çš„æœåŠ¡å™¨ï¼Œæƒé‡è®¾ç½®ä¸º5ï¼Œæ„å‘³ç€ç›¸å¯¹å…¶ä»–å¯èƒ½å­˜åœ¨çš„æœåŠ¡å™¨ï¼Œæ­¤æœåŠ¡å™¨å°†æ¥æ”¶åˆ°æ›´å¤šæ¯”ä¾‹çš„è¯·æ±‚ã€‚åŒæ—¶ï¼Œä¿æŒ16ä¸ªæ´»åŠ¨è¿æ¥ï¼ˆkeepaliveï¼‰ï¼Œæœ‰åŠ©äºå‡å°‘å»ºç«‹æ–°è¿æ¥çš„å¼€é”€ï¼Œæé«˜æ€§èƒ½ã€‚\nå†…ç½‘Nginx default.conf 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 server { listen 80 default_server; # ç›‘å¬80ç«¯å£ï¼Œé»˜è®¤æœåŠ¡å™¨é…ç½® index index.html index.htm index.php; # é»˜è®¤çš„ç´¢å¼•æ–‡ä»¶ root /usr/share/nginx/html; # æ ¹ç›®å½•é…ç½® location / { proxy_pass http://kubernetes-cluster; # åå‘ä»£ç†åˆ°kubernetes-cluster include proxy.conf; # åŒ…å«proxy.confæ–‡ä»¶ } location ~ ^/Bdata_Nginx_Status$ { stub_status on; # å¯ç”¨NginxçŠ¶æ€é¡µé¢ allow 127.0.0.1; allow 10.0.0.0/8; allow 172.16.0.0/12; allow 192.168.0.0/16; deny all; # æ‹’ç»å…¶ä»–IPè®¿é—® } location /Bdata_Check_Status { check_status; # å¯ç”¨Nginxå¥åº·æ£€æŸ¥ allow 127.0.0.1; allow 10.0.0.0/8; allow 172.16.0.0/12; allow 192.168.0.0/16; deny all; # æ‹’ç»å…¶ä»–IPè®¿é—® } access_log /var/log/nginx/access.log main; # è®¿é—®æ—¥å¿—è·¯å¾„å’Œæ ¼å¼ } server { listen 443 ssl default_server; # ç›‘å¬443ç«¯å£ï¼Œé»˜è®¤æœåŠ¡å™¨é…ç½®ï¼Œå¯ç”¨SSL index index.html index.htm index.php; # é»˜è®¤çš„ç´¢å¼•æ–‡ä»¶ root /usr/share/nginx/html; # æ ¹ç›®å½•é…ç½® ssl_certificate /etc/nginx/ssl/server.crt; # SSLè¯ä¹¦è·¯å¾„ ssl_certificate_key /etc/nginx/ssl/server.key; # SSLè¯ä¹¦ç§é’¥è·¯å¾„ location / { proxy_pass https://kubernetes-cluster-https; # åå‘ä»£ç†åˆ°kubernetes-cluster-https include proxy.conf; # åŒ…å«proxy.confæ–‡ä»¶ } location ~ ^/Bdata_Nginx_Status$ { stub_status on; # å¯ç”¨NginxçŠ¶æ€é¡µé¢ allow 127.0.0.1; allow 10.0.0.0/8; allow 172.16.0.0/12; allow 192.168.0.0/16; deny all; # æ‹’ç»å…¶ä»–IPè®¿é—® } location /Bdata_Check_Status { check_status; # å¯ç”¨Nginxå¥åº·æ£€æŸ¥ allow 127.0.0.1; allow 10.0.0.0/8; allow 172.16.0.0/12; allow 192.168.0.0/16; deny all; # æ‹’ç»å…¶ä»–IPè®¿é—® } access_log /var/log/nginx/access.log main; # è®¿é—®æ—¥å¿—è·¯å¾„å’Œæ ¼å¼ } upstream kubernetes-cluster-https.confï¼š\n1 2 3 4 5 upstream kubernetes-cluster-https { server 172.31.154.47:443 weight=5; # åç«¯æœåŠ¡çš„åœ°å€å’Œç«¯å£ï¼Œè®¾ç½®æƒé‡ä¸º5 check interval=10000 rise=3 fall=2 timeout=1500 type=tcp; # é…ç½®å¥åº·æ£€æŸ¥å‚æ•° keepalive 16; # é…ç½® keepalive è¿æ¥æ•° } kubernetes-cluster.confï¼š\n1 2 3 4 5 upstream kubernetes-cluster { server 172.31.154.47 weight=5; # åç«¯æœåŠ¡çš„åœ°å€å’Œç«¯å£ï¼Œè®¾ç½®æƒé‡ä¸º5 check interval=10000 rise=3 fall=2 timeout=1500 type=tcp; # é…ç½®å¥åº·æ£€æŸ¥å‚æ•° keepalive 16; # é…ç½® keepalive è¿æ¥æ•° } è¿™äº›é…ç½®å®šä¹‰äº†è´Ÿè½½å‡è¡¡çš„ upstream ç»„ï¼Œå…¶ä¸­ kubernetes-cluster-https ç”¨äºå¤„ç† HTTPS æµé‡ï¼Œè€Œ kubernetes-cluster ç”¨äºå¤„ç† HTTP æµé‡ã€‚æ¯ä¸ª upstream ç»„åªåŒ…å«ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼ˆIP åœ°å€ä¸º 172.31.154.47ï¼‰ï¼Œå¹¶åˆ†é…äº†æƒé‡ä¸º 5ã€‚æ­¤å¤–ï¼Œè¿˜é…ç½®äº†å¥åº·æ£€æŸ¥å‚æ•°å’Œ keepalive è¿æ¥æ•°ã€‚\nIngressæœåŠ¡ ä¸Šé¢çš„â€œ172.31.154.47â€ ä¸º Ingressçš„IP\n1 2 3 [dev][root@kubernetes-master-192.168.83.13 ~]# kubectl get svc -n ingress-nginx NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE ingress-nginx NodePort 172.31.154.47 \u0026lt;none\u0026gt; 80:30274/TCP,443:30994/TCP 4y22d 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 [dev][root@kubernetes-master-192.168.83.13 ~]# kubectl get ingresses -n uat hire-admin NAME HOSTS ADDRESS PORTS AGE hire-admin hire-admin-uat.xxx.net 172.31.154.47 80 2y4d [dev][root@kubernetes-master-192.168.83.13 ~]# kubectl get ingresses -n uat hire-admin -oyaml apiVersion: extensions/v1beta1 kind: Ingress metadata: annotations: kubernetes.io/ingress.class: nginx # ä½¿ç”¨ nginx ä½œä¸º Ingress æ§åˆ¶å™¨ name: hire-admin namespace: uat selfLink: /apis/extensions/v1beta1/namespaces/uat/ingresses/hire-admin spec: rules: - host: hire-admin-uat.xxx.net # Ingress è§„åˆ™ä¸­çš„ä¸»æœºå http: paths: - backend: serviceName: hire-admin # åç«¯æœåŠ¡çš„åç§° servicePort: 8503 # åç«¯æœåŠ¡çš„ç«¯å£ path: / # Ingress è·¯å¾„ status: loadBalancer: ingress: - ip: 172.31.154.47 # è´Ÿè½½å‡è¡¡å™¨çš„ IP åœ°å€ åç«¯æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 [dev][root@kubernetes-master-192.168.83.13 ~]# kubectl get svc -n uat hire-admin NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE hire-admin ClusterIP 172.31.183.155 \u0026lt;none\u0026gt; 8503/TCP 2y4d [dev][root@kubernetes-master-192.168.83.13 ~]# kubectl get svc -n uat hire-admin -oyaml apiVersion: v1 kind: Service metadata: annotations: kubectl.kubernetes.io/last-applied-configuration: | {\u0026#34;apiVersion\u0026#34;:\u0026#34;v1\u0026#34;,\u0026#34;kind\u0026#34;:\u0026#34;Service\u0026#34;,\u0026#34;metadata\u0026#34;:{\u0026#34;annotations\u0026#34;:{},\u0026#34;labels\u0026#34;:{\u0026#34;app\u0026#34;:\u0026#34;hire-admin\u0026#34;},\u0026#34;name\u0026#34;:\u0026#34;hire-admin\u0026#34;,\u0026#34;namespace\u0026#34;:\u0026#34;uat\u0026#34;},\u0026#34;spec\u0026#34;:{\u0026#34;ports\u0026#34;:[{\u0026#34;name\u0026#34;:\u0026#34;http\u0026#34;,\u0026#34;port\u0026#34;:8503,\u0026#34;protocol\u0026#34;:\u0026#34;TCP\u0026#34;,\u0026#34;targetPort\u0026#34;:8503}],\u0026#34;selector\u0026#34;:{\u0026#34;app\u0026#34;:\u0026#34;hire-admin\u0026#34;}}} creationTimestamp: \u0026#34;2022-03-30T02:37:57Z\u0026#34; labels: app: hire-admin name: hire-admin namespace: uat resourceVersion: \u0026#34;260185009\u0026#34; selfLink: /api/v1/namespaces/uat/services/hire-admin uid: dc559c3a-abfb-4f70-927d-75ac5227b433 spec: clusterIP: 172.31.183.155 # Service çš„ ClusterIP ports: - name: http port: 8503 protocol: TCP targetPort: 8503 # Service æŒ‡å‘çš„ç›®æ ‡ç«¯å£ selector: app: hire-admin sessionAffinity: None type: ClusterIP status: loadBalancer: {} # æ²¡æœ‰è´Ÿè½½å‡è¡¡å™¨ç›¸å…³çš„çŠ¶æ€ä¿¡æ¯ æ€»ç»“æ¥è¯´ï¼Œé€šè¿‡æ·±åº¦æ•´åˆNginxä¸Kubernetes Ingressèµ„æºï¼Œæˆ‘ä»¬å¯ä»¥å®ç°é«˜åº¦å®šåˆ¶åŒ–çš„æµé‡è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä¸ä»…ä¿éšœäº†æœåŠ¡çš„å®‰å…¨æ€§å’Œé«˜å¯ç”¨æ€§ï¼ŒåŒæ—¶ä¹Ÿæå¤§åœ°æå‡äº†å†…å¤–ç½‘äº¤äº’çš„çµæ´»æ€§ä¸å“åº”é€Ÿåº¦ã€‚\n","date":"2024-04-02T16:13:11Z","image":"https://www.ownit.top/title_pic/74.jpg","permalink":"https://www.ownit.top/p/202404021613/","title":"Nginxåœ¨Kubernetesé›†ç¾¤ä¸­çš„è¿›é˜¶åº”ç”¨"},{"content":"èƒŒæ™¯ åœ¨ç°ä»£è½¯ä»¶å¼€å‘å®è·µä¸­ï¼ŒæŒç»­é›†æˆï¼ˆContinuous Integration, CIï¼‰æ˜¯ç¡®ä¿ä»£ç è´¨é‡å’Œå¿«é€Ÿå“åº”è½¯ä»¶ç¼ºé™·çš„å…³é”®ç­–ç•¥ã€‚GitLab æä¾›äº†å¼ºå¤§çš„ CI/CD åŠŸèƒ½ï¼Œå…è®¸å¼€å‘è€…è‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²æµç¨‹ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•è®¾ç½® GitLab æµæ°´çº¿è®¡åˆ’ä»»åŠ¡ï¼Œä»¥å®ç°å¯¹ dev åˆ†æ”¯æ¯å°æ—¶çš„è‡ªåŠ¨æµ‹è¯•ã€‚\néœ€æ±‚ï¼š GitLab æµæ°´çº¿è®¡åˆ’ä»»åŠ¡ï¼ˆpipeline-schedulesï¼‰ï¼šå®ç°æ¯å°æ—¶è‡ªåŠ¨æµ‹è¯• dev åˆ†æ”¯çš„æ›´æ–°\nç¯å¢ƒ Gitlabä¼ä¸šç‰ˆæœ¬ï¼šv16.9.2-ee GitLab æµæ°´çº¿æ˜¯ä¸€ç³»åˆ—ä½œä¸šï¼ˆjobsï¼‰çš„é›†åˆï¼Œè¿™äº›ä½œä¸šå¯ä»¥å¹¶è¡Œæˆ–é¡ºåºæ‰§è¡Œï¼Œä»¥å®Œæˆæ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²ç­‰ä»»åŠ¡ã€‚æµæ°´çº¿å¯ä»¥ç”±ä»£ç æäº¤ã€å®šæ—¶è®¡åˆ’æˆ–å…¶ä»–äº‹ä»¶è§¦å‘ã€‚\nè®¡åˆ’ä»»åŠ¡æ˜¯ GitLab æµæ°´çº¿çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒå…è®¸ä½ æŒ‰è®¡åˆ’æ‰§è¡Œæµæ°´çº¿ï¼Œè€Œä¸éœ€è¦ä»£ç æäº¤æˆ–å…¶ä»–è§¦å‘æ¡ä»¶ã€‚è¿™å¯¹äºå®šæœŸè¿è¡Œæµ‹è¯•ã€å¤‡ä»½æˆ–å…¶ä»–ç»´æŠ¤ä»»åŠ¡ç‰¹åˆ«æœ‰ç”¨ã€‚\næ¯å°æ—¶è‡ªåŠ¨æµ‹è¯• dev åˆ†æ”¯çš„æ­¥éª¤ åˆ›å»º .gitlab-ci.yml é…ç½®æ–‡ä»¶ åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œåˆ›å»ºæˆ–ç¼–è¾‘ .gitlab-ci.yml æ–‡ä»¶ï¼Œè¿™æ˜¯ GitLab æµæ°´çº¿çš„é…ç½®æ–‡ä»¶ã€‚æˆ‘ä»¬å°†å®šä¹‰ä¸¤ä¸ªä½œä¸šï¼šä¸€ä¸ªæ˜¯å¸¸è§„çš„æµ‹è¯•ä½œä¸šï¼Œå¦ä¸€ä¸ªæ˜¯è®¡åˆ’ä»»åŠ¡ä½œä¸šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 stages: - test - alert - jar before_script: - export PATH=/usr/lib/jvm/java-21/bin:${PATH} # å°†javaè·¯å¾„æ·»åŠ åˆ°PATHè·¯å¾„ä¸­ã€‚å¦‚æœæ˜¯java 11ï¼Œä½¿ç”¨/usr/lib/jvm/java-11/binã€‚ ci_test: stage: test script: - | if [ \u0026#34;$(git log origin/dev --since=\u0026#39;1 hour ago\u0026#39; --pretty=format:\u0026#39;%h\u0026#39;)\u0026#34; != \u0026#34;\u0026#34; ]; then mvn clean test else echo \u0026#34;No changes in the last hour\u0026#34; fi - export rules: - if: \u0026#39;$CI_PIPELINE_SOURCE == \u0026#34;schedule\u0026#34; \u0026amp;\u0026amp; $CI_COMMIT_BRANCH == \u0026#34;dev\u0026#34;\u0026#39; dingTalk_fail_alert: stage: alert script: - /bin/bash /opt/k8s/dingtalk/ding_ci_alert.sh fail when: on_failure allow_failure: true rules: - if: \u0026#39;$CI_PIPELINE_SOURCE == \u0026#34;schedule\u0026#34; \u0026amp;\u0026amp; $CI_COMMIT_BRANCH == \u0026#34;dev\u0026#34;\u0026#39; dingTalk_succes_alert: stage: alert script: - /bin/bash /opt/k8s/dingtalk/ding_ci_alert.sh success when: on_success allow_failure: true rules: - if: \u0026#39;$CI_PIPELINE_SOURCE == \u0026#34;schedule\u0026#34; \u0026amp;\u0026amp; $CI_COMMIT_BRANCH == \u0026#34;dev\u0026#34;\u0026#39; jar: stage: jar tags: - pdd cache: paths: - manage-analysis/target/*.jar - manage-listener/target/*.jar - manage-backend/target/*.jar policy: push key: ${CI_BUILD_REF_NAME} script: - mvn clean install -Dmaven.test.skip=true rules: - if: \u0026#39;$CI_PIPELINE_SOURCE != \u0026#34;schedule\u0026#34; \u0026amp;\u0026amp; $CI_COMMIT_BRANCH == \u0026#34;dev\u0026#34;\u0026#39; é…ç½®é’‰é’‰å‘Šè­¦æœºå™¨äºº é…ç½®é’‰é’‰å‘Šè­¦æœºå™¨äººï¼šå…³é”®å­—è®¤è¯ â€œå‘Šè­¦â€ é…ç½®å‘Šè­¦è„šæœ¬è„šæœ¬æ¨¡æ¿ åœ¨GitLab CI/CD ç®¡é“ä¸­ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªåä¸º ding_ci_alert.sh çš„Shellè„šæœ¬ï¼Œç”¨äºå¯¹æ¥é’‰é’‰æœºå™¨äººå‘é€æ„å»ºçŠ¶æ€çš„é€šçŸ¥ã€‚é’ˆå¯¹ä¸åŒçš„æ„å»ºç»“æœï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹éœ€æ±‚ï¼š\nå½“Mavenæµ‹è¯•ä»»åŠ¡å¤±è´¥æ—¶ï¼Œæˆ‘ä»¬ä¼šå‘è„šæœ¬ä¼ é€’ä¸€ä¸ªå‚æ•° \u0026quot;fail\u0026quot;ï¼Œè¡¨ç¤ºæ„å»ºå¤±è´¥ã€‚æ­¤æ—¶ï¼Œè„šæœ¬ä¸ä»…ä¼šè°ƒç”¨é’‰é’‰æœºå™¨äººå‘é€ä¸€æ¡åŒ…å«å¤±è´¥è¯¦æƒ…çš„å‘Šè­¦æ¶ˆæ¯ï¼Œè¿˜ä¼šå°†æ­¤æ¬¡å¤±è´¥çš„æ„å»ºIDå†™å…¥ä¸€ä¸ªä¸“é—¨è®°å½•å¤±è´¥æ„å»ºçš„æ–‡ä»¶ä¸­ã€‚ å½“åç»­çš„Mavenæµ‹è¯•ä»»åŠ¡æˆåŠŸæ—¶ï¼Œæˆ‘ä»¬å°†å‘è„šæœ¬ä¼ é€’ä¸€ä¸ªå‚æ•° \u0026quot;success\u0026quot;ï¼Œä»¥æ ‡è¯†æ„å»ºæˆåŠŸã€‚è¿™æ—¶ï¼Œè„šæœ¬é¦–å…ˆä¼šæ£€æŸ¥è®°å½•å¤±è´¥æ„å»ºçš„æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨å½“å‰æ„å»ºIDã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™è°ƒç”¨é’‰é’‰æœºå™¨äººå‘é€ä¸€æ¡æˆåŠŸæ¢å¤çš„æ¶ˆæ¯ï¼Œå¹¶ä»è®°å½•æ–‡ä»¶ä¸­ç§»é™¤æ­¤æ„å»ºIDï¼›åä¹‹ï¼Œè‹¥å½“å‰æ„å»ºIDæœªåœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œåˆ™ä¸å‘é€æˆåŠŸå‘Šè­¦ä¿¡æ¯ã€‚ è¿™æ ·ï¼Œæˆ‘ä»¬é€šè¿‡çµæ´»è°ƒç”¨å’Œæ™ºèƒ½åˆ¤æ–­ï¼Œç¡®ä¿äº†åœ¨æ„å»ºå¤±è´¥æ—¶åŠæ—¶é€šçŸ¥ç›¸å…³äººå‘˜ï¼Œå¹¶åœ¨é—®é¢˜å¾—åˆ°è§£å†³åå‘é€æˆåŠŸé€šçŸ¥ï¼Œæ—¢é¿å…äº†ä¸å¿…è¦çš„é€šçŸ¥å¹²æ‰°ï¼Œåˆä¿è¯äº†å›¢é˜Ÿèƒ½å¤ŸåŠæ—¶äº†è§£åˆ°æ„å»ºçŠ¶æ€çš„å˜åŒ–ã€‚åœ¨å®é™…çš„åšå®¢æ–‡ç« ä¸­ï¼Œæ‚¨å¯ä»¥æ’å…¥ç¤ºä¾‹ä»£ç å’Œè¯¦ç»†è¯´æ˜ï¼Œè®©è¯»è€…æ›´ç›´è§‚åœ°ç†è§£è¿™ä¸€è¿‡ç¨‹ã€‚\nvim /opt/k8s/dingtalk/ding_ci_alert.sh\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 #!/bin/bash WEBHOOK_URL=\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=xxxxx\u0026#34; # æ£€æŸ¥æ˜¯å¦æä¾›äº†å‚æ•° if [ \u0026#34;$#\u0026#34; -ne 1 ]; then echo \u0026#34;Usage: $0 \u0026lt;success|fail\u0026gt;\u0026#34; exit 1 fi # å®šä¹‰è®°å½•æ–‡ä»¶è·¯å¾„ RECORD_FILE=\u0026#34;/tmp/build_records.txt\u0026#34; # æ ¹æ®ä¼ å…¥çš„å‚æ•°æ‰§è¡Œç›¸åº”æ“ä½œ case $1 in fail) # æ„å»ºå¤±è´¥ï¼Œå‘é€å‘Šè­¦å¹¶è®°å½• echo \u0026#34;æ„å»ºå¤±è´¥ï¼Œå‘é€å‘Šè­¦...\u0026#34; # å‡†å¤‡å‘Šè­¦æ¶ˆæ¯ JSON_DATA=$(printf \u0026#39;{ \u0026#34;msgtype\u0026#34;: \u0026#34;markdown\u0026#34;, \u0026#34;markdown\u0026#34;: { \u0026#34;title\u0026#34;: \u0026#34;å‘Šè­¦:æ„å»ºå¤±è´¥é€šçŸ¥\u0026#34;, \u0026#34;text\u0026#34;: \u0026#34;#### **[%s çš„ Maven æµ‹è¯•æœªé€šè¿‡æ„å»ºå¤±è´¥](%s/pipelines/%s)**\\n\\n\u0026gt; - **æäº¤ä¿¡æ¯**: %s\\n\u0026gt; - **æäº¤è€…åç§°**: %s\\n\u0026gt; - **æäº¤æ—¶é—´**: %s\\n\\nè¯·åŠæ—¶å¤„ç†ï¼Œæ›´å¤šè¯¦æƒ…å¯ç‚¹å‡»é¡¹ç›®åç§°ã€‚\u0026#34; }, \u0026#34;at\u0026#34;: { \u0026#34;isAtAll\u0026#34;: false } }\u0026#39; \u0026#34;$CI_PROJECT_NAME\u0026#34; \u0026#34;$CI_PROJECT_URL\u0026#34; \u0026#34;$CI_PIPELINE_ID\u0026#34; \u0026#34;$CI_COMMIT_MESSAGE\u0026#34; \u0026#34;$CI_COMMIT_AUTHOR\u0026#34; \u0026#34;$CI_COMMIT_TIMESTAMP\u0026#34;) # å‘é€å‘Šè­¦ curl \u0026#34;$WEBHOOK_URL\u0026#34; -X POST -H \u0026#39;Content-Type: application/json;charset=utf-8\u0026#39; -d \u0026#34;$JSON_DATA\u0026#34; # è®°å½•å¤±è´¥çš„æ„å»º echo \u0026#34;$CI_PROJECT_NAME failed\u0026#34; \u0026gt;\u0026gt; \u0026#34;$RECORD_FILE\u0026#34; ;; success) # æ„å»ºæˆåŠŸï¼Œæ£€æŸ¥è®°å½•æ–‡ä»¶ if grep -q \u0026#34;$CI_PROJECT_NAME failed\u0026#34; \u0026#34;$RECORD_FILE\u0026#34;; then echo \u0026#34;æ„å»ºæˆåŠŸï¼Œå‘é€å‘Šè­¦...\u0026#34; # å‡†å¤‡æˆåŠŸå‘Šè­¦æ¶ˆæ¯ SUCCESS_JSON_DATA=$(printf \u0026#39;{ \u0026#34;msgtype\u0026#34;: \u0026#34;markdown\u0026#34;, \u0026#34;markdown\u0026#34;: { \u0026#34;title\u0026#34;: \u0026#34;å‘Šè­¦:æ„å»ºæˆåŠŸé€šçŸ¥\u0026#34;, \u0026#34;text\u0026#34;: \u0026#34;#### **[%s çš„ Maven æµ‹è¯•å·²é€šè¿‡æ„å»ºæˆåŠŸ]**\\n\\n\u0026gt; - **æäº¤ä¿¡æ¯**: %s\\n\u0026gt; - **æäº¤è€…åç§°**: %s\\n\u0026gt; - **æäº¤æ—¶é—´**: %s\\n\\næ„å»ºæˆåŠŸï¼Œå¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚\u0026#34; }, \u0026#34;at\u0026#34;: { \u0026#34;isAtAll\u0026#34;: false } }\u0026#39; \u0026#34;$CI_PROJECT_NAME\u0026#34; \u0026#34;$CI_COMMIT_MESSAGE\u0026#34; \u0026#34;$CI_COMMIT_AUTHOR\u0026#34; \u0026#34;$CI_COMMIT_TIMESTAMP\u0026#34;) # å‘é€æˆåŠŸå‘Šè­¦ curl \u0026#34;$WEBHOOK_URL\u0026#34; -X POST -H \u0026#39;Content-Type: application/json;charset=utf-8\u0026#39; -d \u0026#34;$SUCCESS_JSON_DATA\u0026#34; # æ¸…é™¤è®°å½• sed -i \u0026#34;/$CI_PROJECT_NAME failed/d\u0026#34; \u0026#34;$RECORD_FILE\u0026#34; else echo \u0026#34;æ²¡æœ‰æ‰¾åˆ°æ„å»ºå¤±è´¥çš„è®°å½•ï¼Œä¸å‘é€æˆåŠŸå‘Šè­¦ã€‚\u0026#34; fi ;; *) echo \u0026#34;Invalid argument: $1. Expected \u0026#39;success\u0026#39; or \u0026#39;fail\u0026#39;.\u0026#34; exit 1 ;; esac exit 0 è®¾ç½®æµæ°´çº¿è®¡åˆ’ æ­¥éª¤1ï¼šç™»å½•GitLabå¹¶è¿›å…¥é¡¹ç›®\nç™»å½•åˆ°æ‚¨çš„GitLabè´¦å·ã€‚ å¯¼èˆªåˆ°æ‚¨æƒ³è¦è®¾ç½®æµæ°´çº¿è®¡åˆ’çš„é¡¹ç›®ã€‚ æ­¥éª¤2ï¼šè¿›å…¥CI/CDè®¾ç½®\nåœ¨é¡¹ç›®ä¸»é¡µï¼Œç‚¹å‡»å·¦ä¾§é¢æ¿ä¸­çš„â€œCI/CDâ€é€‰é¡¹å¡ã€‚ åœ¨CI/CDè®¾ç½®åŒºåŸŸï¼Œç‚¹å‡»â€œSchedulesâ€ï¼ˆè°ƒåº¦ï¼‰ã€‚ æ­¥éª¤3ï¼šåˆ›å»ºæ–°çš„æµæ°´çº¿è®¡åˆ’\nåœ¨â€œSchedulesâ€é¡µé¢ï¼Œç‚¹å‡»â€œNew scheduleâ€æŒ‰é’®ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„æµæ°´çº¿è®¡åˆ’ã€‚ æ­¥éª¤4ï¼šé…ç½®æµæ°´çº¿è®¡åˆ’è¯¦ç»†ä¿¡æ¯\næè¿°ï¼šä¸ºæ‚¨çš„æµæ°´çº¿è®¡åˆ’æä¾›ä¸€ä¸ªæ˜“äºç†è§£çš„æè¿°ï¼Œä»¥ä¾¿æ—¥åè¯†åˆ«ã€‚ CRON è¡¨è¾¾å¼ï¼šè¾“å…¥ä¸€ä¸ªcronè¡¨è¾¾å¼æ¥å®šä¹‰è®¡åˆ’æ‰§è¡Œçš„æ—¶é—´è§„å¾‹ã€‚ä¾‹å¦‚ï¼Œæ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œï¼Œå¯ä»¥è¾“å…¥0 1 * * *ã€‚è¯·å‚è€ƒcronè¡¨è¾¾å¼æ–‡æ¡£ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚ åˆ†æ”¯/æ ‡ç­¾ï¼šå¯ä»¥é€‰æ‹©æµæ°´çº¿å°†åœ¨å“ªä¸ªåˆ†æ”¯æˆ–æ ‡ç­¾ä¸Šæ‰§è¡Œï¼Œé»˜è®¤é€šå¸¸æ˜¯å½“å‰é¡¹ç›®çš„é»˜è®¤åˆ†æ”¯ï¼ˆå¦‚master/mainï¼‰ã€‚ é¢å¤–å˜é‡ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥ä¸ºæµæ°´çº¿æä¾›é¢å¤–çš„ç¯å¢ƒå˜é‡ï¼Œè¿™å°†åœ¨è®¡åˆ’æ‰§è¡Œæ—¶æ³¨å…¥åˆ°ç¯å¢ƒä¸­ã€‚ ä¿æŠ¤ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æœ‰å¿…è¦ï¼Œæ‚¨å¯ä»¥å‹¾é€‰â€œProtect this pipelineâ€ï¼Œè¿™æ ·åªæœ‰å…·æœ‰é€‚å½“æƒé™çš„ç”¨æˆ·æ‰èƒ½æ‰§è¡Œæˆ–ä¿®æ”¹è¯¥æµæ°´çº¿è®¡åˆ’ã€‚ æ­¥éª¤5ï¼šä¿å­˜æµæ°´çº¿è®¡åˆ’\né…ç½®å®Œæ‰€æœ‰é€‰é¡¹åï¼Œæ»šåŠ¨åˆ°åº•éƒ¨å¹¶ç‚¹å‡»â€œSave changesâ€ã€‚ æ­¥éª¤6ï¼šéªŒè¯æµæ°´çº¿è®¡åˆ’\nåœ¨æŒ‡å®šçš„æ—¶é—´ï¼ŒGitLabå°†æ ¹æ®æ‚¨è®¾ç½®çš„cronè¡¨è¾¾å¼è‡ªåŠ¨è§¦å‘æµæ°´çº¿ã€‚æ‚¨å¯ä»¥åœ¨é¡¹ç›®çš„å†å²æµæ°´çº¿è®°å½•ä¸­æŸ¥çœ‹æµæ°´çº¿è®¡åˆ’çš„æ‰§è¡Œæƒ…å†µã€‚ æ³¨æ„äº‹é¡¹\nç¡®ä¿æ‚¨çš„é¡¹ç›®ä¸­æœ‰.gitlab-ci.ymlæ–‡ä»¶ï¼Œå¹¶ä¸”æ–‡ä»¶ä¸­å®šä¹‰äº†é€‚å½“çš„CI/CDæµæ°´çº¿é…ç½®ï¼Œè¿™æ ·æ‰èƒ½åœ¨è®¡åˆ’æ—¶é—´åˆ°æ¥æ—¶æ‰§è¡Œé¢„å®šçš„ä»»åŠ¡ã€‚ å¦‚æœæµæ°´çº¿æ¶‰åŠåˆ°æ•æ„Ÿä¿¡æ¯ï¼Œæ‚¨å¯èƒ½éœ€è¦é¢„å…ˆé…ç½®å¥½å˜é‡å¹¶é€šè¿‡å¯†é’¥ç®¡ç†æˆ–GitLabçš„å—ä¿æŠ¤å˜é‡åŠŸèƒ½æ¥å®‰å…¨åœ°ä¼ é€’è¿™äº›ä¿¡æ¯ã€‚ æŸäº›é«˜çº§è®¾ç½®ï¼Œå¦‚è¿è¡Œç‰¹å®šjobï¼Œéœ€è¦åœ¨.gitlab-ci.ymlæ–‡ä»¶ä¸­é€šè¿‡rulesæˆ–only/exceptå…³é”®å­—è¿›è¡Œå®šä¹‰ã€‚ æ³¨æ„ï¼šç¬¬äºŒå¼ å›¾ç‰‡ CI_PIPELINE_SOURCE æ˜¯è‡ªå·±å®šä¹‰çš„å˜é‡\né¢ å¤– å˜ é‡ ï¼ˆ å¯ é€‰ ï¼‰ ï¼š å¦‚ æœ éœ€ è¦ ï¼Œ æ‚¨ å¯ ä»¥ ä¸º æµ æ°´ çº¿ æ ä¾› é¢ å¤– çš„ ç¯ å¢ƒ å˜ é‡ ï¼Œ è¿™ å°† åœ¨ è®¡ åˆ’ æ‰§ è¡Œ æ—¶ æ³¨ å…¥ åˆ° ç¯ å¢ƒ ä¸­ ï¼Œ ä¸€ èˆ¬ æˆ‘ ä»¬ ä¼š é… ç½® ä¸€ ä¸ª å˜ é‡ å å­— å« $CI PIPELINE_SOURCE ï¼Œ å®ƒ çš„ å€¼ ä¸º s c h ed u le é€š è¿‡ è¿™ ä¸ª æ–¹ å¼ ï¼Œ æˆ‘ ä»¬ å°± èƒ½ å¤Ÿ ç¡® ä¿ .gitlab-ci.yml æ–‡ ä»¶ é‡Œ é¢ åª æœ‰ å®š ä¹‰ äº† ä»¥ ä¸‹ è§„ åˆ™ çš„ stage æ‰ ä¼š æ‰§ è¡Œ è¿™ ä¸ª å®š æ—¶ ä»» åŠ¡ ï¼š\n1 2 rules: - if: \u0026#39;$CI_PIPELINE_SOURCE == \u0026#34;schedule\u0026#34; \u0026amp;\u0026amp; $CI_COMMIT_BRANCH == \u0026#34;dev\u0026#34;\u0026#39; ä¿ æŠ¤ ï¼ˆ å¯ é€‰ ï¼‰ ï¼š å¦‚ æœ‰ å¿… è¦ ï¼Œ æ‚¨ å¯ ä»¥ å‹¾ é€‰ \u0026ldquo;Protect this pipeline\u0026rdquo;, è¿™ æ · åª æœ‰ å…· æœ‰ é€‚ å½“ æƒ é™ çš„ ç”¨ æˆ· æ‰ èƒ½ æ‰§ è¡Œ æˆ– ä¿® æ”¹ è¯¥ æµ æ°´ çº¿ è®¡ åˆ’ ã€‚ éªŒè¯æµæ°´çº¿è‡ªåŠ¨åŒ– ","date":"2024-03-22T16:32:28Z","image":"https://www.ownit.top/title_pic/64.jpg","permalink":"https://www.ownit.top/p/202403221632/","title":"Gitlabçš„æµæ°´çº¿ä»»åŠ¡ã€å®ç°æ¯å°æ—¶è‡ªåŠ¨æµ‹è¯• devåˆ†æ”¯çš„æ›´æ–°ã€‘"},{"content":"æ¨è Istio å¤šé›†ç¾¤ç›‘æ§ä½¿ç”¨ Prometheusï¼Œå…¶ä¸»è¦åŸå› æ˜¯åŸºäº Prometheus çš„åˆ†å±‚è”é‚¦ï¼ˆHierarchical Federationï¼‰ã€‚\né€šè¿‡ Istio éƒ¨ç½²åˆ°æ¯ä¸ªé›†ç¾¤ä¸­çš„ Prometheus å®ä¾‹ä½œä¸ºåˆå§‹æ”¶é›†å™¨ï¼Œç„¶åå°†æ•°æ®èšåˆåˆ°ç½‘æ ¼å±‚æ¬¡çš„ Prometheus å®ä¾‹ä¸Šã€‚ ç½‘æ ¼å±‚æ¬¡çš„ Prometheus æ—¢å¯ä»¥éƒ¨ç½²åœ¨ç½‘æ ¼ä¹‹å¤–ï¼ˆå¤–éƒ¨ï¼‰ï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨ç½‘æ ¼å†…çš„é›†ç¾¤ä¸­ã€‚\nä½¿ç”¨ Istio ä»¥åŠ Prometheus è¿›è¡Œç”Ÿäº§è§„æ¨¡çš„ç›‘æ§æ—¶æ¨èçš„æ–¹å¼æ˜¯ä½¿ç”¨åˆ†å±‚è”é‚¦å¹¶ä¸”ç»“åˆä¸€ç»„è®°å½•è§„åˆ™ã€‚\nå°½ç®¡å®‰è£… Istio ä¸ä¼šé»˜è®¤éƒ¨ç½² Prometheusï¼Œå…¥é—¨æŒ‡å¯¼ä¸­ Option 1: Quick Start çš„éƒ¨ç½²æŒ‰ç…§ Prometheus é›†æˆæŒ‡å¯¼å®‰è£…äº† Prometheusã€‚ æ­¤ Prometheus éƒ¨ç½²åˆ»æ„åœ°é…ç½®äº†å¾ˆçŸ­çš„ä¿ç•™çª—å£ï¼ˆ6 å°æ—¶ï¼‰ã€‚æ­¤å¿«é€Ÿå…¥é—¨ Prometheus éƒ¨ç½²åŒæ—¶ä¹Ÿé…ç½®ä¸ºä»ç½‘æ ¼ä¸Šè¿è¡Œçš„æ¯ä¸€ä¸ª Envoy ä»£ç†ä¸Šæ”¶é›†æŒ‡æ ‡ï¼ŒåŒæ—¶é€šè¿‡ä¸€ç»„æœ‰å…³å®ƒä»¬çš„æºçš„æ ‡ç­¾ï¼ˆinstanceã€pod å’Œ namespaceï¼‰æ¥æ‰©å……æŒ‡æ ‡ ä½¿ç”¨è´Ÿè½½çº§åˆ«çš„èšåˆæŒ‡æ ‡è¿›è¡Œè”é‚¦ ä¸ºäº†å»ºç«‹ Prometheus è”é‚¦ï¼Œè¯·ä¿®æ”¹æ‚¨çš„ Prometheus ç”Ÿäº§éƒ¨ç½²é…ç½®æ¥æŠ“å– Istio Prometheus è”é‚¦ç»ˆç«¯çš„æŒ‡æ ‡æ•°æ®ã€‚\nå°†ä»¥ä¸‹çš„ Job æ·»åŠ åˆ°é…ç½®ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 - job_name: \u0026#39;istio-prometheus\u0026#39; honor_labels: true metrics_path: \u0026#39;/federate\u0026#39; kubernetes_sd_configs: - role: pod namespaces: names: [\u0026#39;istio-system\u0026#39;] metric_relabel_configs: - source_labels: [__name__] regex: \u0026#39;workload:(.*)\u0026#39; target_label: __name__ action: replace params: \u0026#39;match[]\u0026#39;: - \u0026#39;{__name__=~\u0026#34;workload:(.*)\u0026#34;}\u0026#39; - \u0026#39;{__name__=~\u0026#34;pilot(.*)\u0026#34;}\u0026#39; å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Prometheus Operatorï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹çš„é…ç½®ï¼š\næˆ‘è¿™è¾¹å°±æ˜¯ä½¿ç”¨ è¿™ç§æ–¹å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 apiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: name: istio-federation labels: app.kubernetes.io/name: istio-prometheus spec: namespaceSelector: matchNames: - istio-system selector: matchLabels: app: prometheus endpoints: - interval: 30s scrapeTimeout: 30s params: \u0026#39;match[]\u0026#39;: - \u0026#39;{__name__=~\u0026#34;workload:(.*)\u0026#34;}\u0026#39; - \u0026#39;{__name__=~\u0026#34;pilot(.*)\u0026#34;}\u0026#39; path: /federate targetPort: 9090 honorLabels: true metricRelabelings: - sourceLabels: [\u0026#34;__name__\u0026#34;] regex: \u0026#39;workload:(.*)\u0026#39; targetLabel: \u0026#34;__name__\u0026#34; action: replace 1 2 3 4 5 6 kubectl apply -f istio-federation.yaml -n monitoring [root@bt ~]# kubectl get servicemonitors.monitoring.coreos.com -n monitoring istio-federation NAME AGE istio-federation 44d è”é‚¦é…ç½®çš„å…³é”®æ˜¯é¦–å…ˆåŒ¹é…é€šè¿‡ Istio éƒ¨ç½²çš„ Prometheus ä¸­æ”¶é›† Istio æ ‡å‡†æŒ‡æ ‡çš„ Jobã€‚å¹¶ä¸”å°†æ”¶é›†åˆ°çš„æŒ‡æ ‡é‡å‘½åï¼Œæ–¹æ³•ä¸ºå»é™¤è´Ÿè½½ç­‰çº§è®°å½•è§„åˆ™å‘½åå‰ç¼€ (workload:)ã€‚ è¿™ä½¿å¾—ç°æœ‰çš„ä»ªè¡¨ç›˜ä»¥åŠå¼•ç”¨èƒ½å¤Ÿæ— ç¼åœ°é’ˆå¯¹ç”Ÿäº§ç”¨ Prometheus ç»§ç»­å·¥ä½œï¼ˆå¹¶ä¸”ä¸åœ¨æŒ‡å‘ Istio å®ä¾‹ï¼‰ã€‚\næ‚¨å¯ä»¥åœ¨è®¾ç½®è”é‚¦æ—¶åŒ…å«é¢å¤–çš„æŒ‡æ ‡ï¼ˆä¾‹å¦‚ envoyã€go ç­‰ï¼‰ã€‚\næ§åˆ¶é¢æŒ‡æ ‡ä¹Ÿè¢«ç”Ÿäº§ç”¨ Prometheus æ”¶é›†å¹¶è”é‚¦ã€‚\né…ç½®æ–‡ä»¶ç›‘æ§kubernetes-istio-pods Prometheus çš„æŠ“å–ä½œä¸šé…ç½®æ–‡ä»¶ï¼Œæ€ä¹ˆå®ç° Prometheus å¦‚ä½•æŠ“å–å’Œå¤„ç†ä¸ Kubernetes Istio pods ç›¸å…³çš„æŒ‡æ ‡æ•°æ®ï¼Ÿ\n1ã€é¦–å…ˆIstioå†…éƒ¨é›†æˆå®‰è£…Prometheus\n2ã€æˆ‘ä»¬å¯ä»¥å»istioæŸ¥çœ‹ äººå®¶çš„é…ç½®æ€ä¹ˆå†™\n3ã€æ ¹æ®äººå®¶çš„é…ç½® ï¼Œä¿®æ”¹ä¸€ä¸‹ï¼Œé›†æˆåˆ°Prometheusä¸Š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 global: evaluation_interval: 1m scrape_interval: 15s scrape_timeout: 10s rule_files: - /etc/config/recording_rules.yml - /etc/config/alerting_rules.yml - /etc/config/rules - /etc/config/alerts scrape_configs: - job_name: prometheus static_configs: - targets: - localhost:9090 - bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token job_name: kubernetes-apiservers kubernetes_sd_configs: - role: endpoints relabel_configs: - action: keep regex: default;kubernetes;https source_labels: - __meta_kubernetes_namespace - __meta_kubernetes_service_name - __meta_kubernetes_endpoint_port_name scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt insecure_skip_verify: true - bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token job_name: kubernetes-nodes kubernetes_sd_configs: - role: node relabel_configs: - action: labelmap regex: __meta_kubernetes_node_label_(.+) - replacement: kubernetes.default.svc:443 target_label: __address__ - regex: (.+) replacement: /api/v1/nodes/$1/proxy/metrics source_labels: - __meta_kubernetes_node_name target_label: __metrics_path__ scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt insecure_skip_verify: true - bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token job_name: kubernetes-nodes-cadvisor kubernetes_sd_configs: - role: node relabel_configs: - action: labelmap regex: __meta_kubernetes_node_label_(.+) - replacement: kubernetes.default.svc:443 target_label: __address__ - regex: (.+) replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor source_labels: - __meta_kubernetes_node_name target_label: __metrics_path__ scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt insecure_skip_verify: true - honor_labels: true job_name: kubernetes-service-endpoints kubernetes_sd_configs: - role: endpoints relabel_configs: - action: keep regex: true source_labels: - __meta_kubernetes_service_annotation_prometheus_io_scrape - action: drop regex: true source_labels: - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow - action: replace regex: (https?) source_labels: - __meta_kubernetes_service_annotation_prometheus_io_scheme target_label: __scheme__ - action: replace regex: (.+) source_labels: - __meta_kubernetes_service_annotation_prometheus_io_path target_label: __metrics_path__ - action: replace regex: (.+?)(?::\\d+)?;(\\d+) replacement: $1:$2 source_labels: - __address__ - __meta_kubernetes_service_annotation_prometheus_io_port target_label: __address__ - action: labelmap regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+) replacement: __param_$1 - action: labelmap regex: __meta_kubernetes_service_label_(.+) - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace - action: replace source_labels: - __meta_kubernetes_service_name target_label: service - action: replace source_labels: - __meta_kubernetes_pod_node_name target_label: node - honor_labels: true job_name: kubernetes-service-endpoints-slow kubernetes_sd_configs: - role: endpoints relabel_configs: - action: keep regex: true source_labels: - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow - action: replace regex: (https?) source_labels: - __meta_kubernetes_service_annotation_prometheus_io_scheme target_label: __scheme__ - action: replace regex: (.+) source_labels: - __meta_kubernetes_service_annotation_prometheus_io_path target_label: __metrics_path__ - action: replace regex: (.+?)(?::\\d+)?;(\\d+) replacement: $1:$2 source_labels: - __address__ - __meta_kubernetes_service_annotation_prometheus_io_port target_label: __address__ - action: labelmap regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+) replacement: __param_$1 - action: labelmap regex: __meta_kubernetes_service_label_(.+) - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace - action: replace source_labels: - __meta_kubernetes_service_name target_label: service - action: replace source_labels: - __meta_kubernetes_pod_node_name target_label: node scrape_interval: 5m scrape_timeout: 30s - honor_labels: true job_name: prometheus-pushgateway kubernetes_sd_configs: - role: service relabel_configs: - action: keep regex: pushgateway source_labels: - __meta_kubernetes_service_annotation_prometheus_io_probe - honor_labels: true job_name: kubernetes-services kubernetes_sd_configs: - role: service metrics_path: /probe params: module: - http_2xx relabel_configs: - action: keep regex: true source_labels: - __meta_kubernetes_service_annotation_prometheus_io_probe - source_labels: - __address__ target_label: __param_target - replacement: blackbox target_label: __address__ - source_labels: - __param_target target_label: instance - action: labelmap regex: __meta_kubernetes_service_label_(.+) - source_labels: - __meta_kubernetes_namespace target_label: namespace - source_labels: - __meta_kubernetes_service_name target_label: service - honor_labels: true job_name: kubernetes-pods kubernetes_sd_configs: - role: pod relabel_configs: - action: keep regex: true source_labels: - __meta_kubernetes_pod_annotation_prometheus_io_scrape - action: drop regex: true source_labels: - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow - action: replace regex: (https?) source_labels: - __meta_kubernetes_pod_annotation_prometheus_io_scheme target_label: __scheme__ - action: replace regex: (.+) source_labels: - __meta_kubernetes_pod_annotation_prometheus_io_path target_label: __metrics_path__ - action: replace regex: (\\d+);(([A-Fa-f0-9]{1,4}::?){1,7}[A-Fa-f0-9]{1,4}) replacement: \u0026#39;[$2]:$1\u0026#39; source_labels: - __meta_kubernetes_pod_annotation_prometheus_io_port - __meta_kubernetes_pod_ip target_label: __address__ - action: replace regex: (\\d+);((([0-9]+?)(\\.|$)){4}) replacement: $2:$1 source_labels: - __meta_kubernetes_pod_annotation_prometheus_io_port - __meta_kubernetes_pod_ip target_label: __address__ - action: labelmap regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+) replacement: __param_$1 - action: labelmap regex: __meta_kubernetes_pod_label_(.+) - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace - action: replace source_labels: - __meta_kubernetes_pod_name target_label: pod - action: drop regex: Pending|Succeeded|Failed|Completed source_labels: - __meta_kubernetes_pod_phase - honor_labels: true job_name: kubernetes-pods-slow kubernetes_sd_configs: - role: pod relabel_configs: - action: keep regex: true source_labels: - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow - action: replace regex: (https?) source_labels: - __meta_kubernetes_pod_annotation_prometheus_io_scheme target_label: __scheme__ - action: replace regex: (.+) source_labels: - __meta_kubernetes_pod_annotation_prometheus_io_path target_label: __metrics_path__ - action: replace regex: (\\d+);(([A-Fa-f0-9]{1,4}::?){1,7}[A-Fa-f0-9]{1,4}) replacement: \u0026#39;[$2]:$1\u0026#39; source_labels: - __meta_kubernetes_pod_annotation_prometheus_io_port - __meta_kubernetes_pod_ip target_label: __address__ - action: replace regex: (\\d+);((([0-9]+?)(\\.|$)){4}) replacement: $2:$1 source_labels: - __meta_kubernetes_pod_annotation_prometheus_io_port - __meta_kubernetes_pod_ip target_label: __address__ - action: labelmap regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+) replacement: __param_$1 - action: labelmap regex: __meta_kubernetes_pod_label_(.+) - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace - action: replace source_labels: - __meta_kubernetes_pod_name target_label: pod - action: drop regex: Pending|Succeeded|Failed|Completed source_labels: - __meta_kubernetes_pod_phase scrape_interval: 5m scrape_timeout: 30s ä¸Šé¢æ˜¯äººå®¶çš„å†™çš„é…ç½®ï¼Œä¿®æ”¹é…ç½®ä¸ºä¸‹æ–¹\nåœ¨prometheus-prometheus.yamlçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå®˜æ–¹å†…ç½®äº†ä¸€ä¸ªå­—æ®µadditionalScrapeConfigsç”¨äºæ·»åŠ è‡ªå®šä¹‰çš„æŠ“å–ç›®æ ‡\nhttps://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/api.md#PrometheusSpec\næ‰€ä»¥åªéœ€è¦æŒ‰ç…§å®˜æ–¹çš„è¦æ±‚å†™å…¥é…ç½®å³å¯ã€‚æ–°å»ºé¢å¤–æŠ“å–çš„ä¿¡æ¯prometheus-additional.yamlï¼š\nprometheus-additional.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 - job_name: kubernetes-istio-pods honor_labels: true honor_timestamps: true scrape_interval: 15s scrape_timeout: 10s metrics_path: /metrics scheme: http follow_redirects: true relabel_configs: - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape] separator: ; regex: \u0026#34;true\u0026#34; replacement: $1 action: keep - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape_slow] separator: ; regex: \u0026#34;true\u0026#34; replacement: $1 action: drop - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme] separator: ; regex: (https?) target_label: __scheme__ replacement: $1 action: replace - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path] separator: ; regex: (.+) target_label: __metrics_path__ replacement: $1 action: replace - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port, __meta_kubernetes_pod_ip] separator: ; regex: (\\d+);(([A-Fa-f0-9]{1,4}::?){1,7}[A-Fa-f0-9]{1,4}) target_label: __address__ replacement: \u0026#39;[$2]:$1\u0026#39; action: replace - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port, __meta_kubernetes_pod_ip] separator: ; regex: (\\d+);((([0-9]+?)(\\.|$)){4}) target_label: __address__ replacement: $2:$1 action: replace - separator: ; regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+) replacement: __param_$1 action: labelmap - separator: ; regex: __meta_kubernetes_pod_label_(.+) replacement: $1 action: labelmap - source_labels: [__meta_kubernetes_namespace] separator: ; regex: (.*) target_label: namespace replacement: $1 action: replace - source_labels: [__meta_kubernetes_pod_name] separator: ; regex: (.*) target_label: pod replacement: $1 action: replace - source_labels: [__meta_kubernetes_pod_phase] separator: ; regex: Pending|Succeeded|Failed|Completed replacement: $1 action: drop kubernetes_sd_configs: - role: pod kubeconfig_file: \u0026#34;\u0026#34; follow_redirects: true æŠ“å–çš„ç›®æ ‡åˆ¶å®šä¸ºtargetsåˆ—è¡¨ï¼Œåˆ›å»ºsecretå¯¹è±¡istio-additional-configså¼•ç”¨è¯¥é…ç½®\n1 kubectl create secret generic `istio-additional-configs` --from-file=./prometheus-additional.yaml -n monitoring 1 2 3 4 5 6 kubectl edit prometheus -n monitoring spec: additionalScrapeConfigs: key: prometheus-additional.yaml name: istio-additional-configs æˆ–è€…\nåœ¨promethes-prometheus.yamlä¸­æ·»åŠ additionalScrapeConfigså¼•ç”¨åˆ›å»ºçš„secret\n1 2 3 4 5 6 7 serviceAccountName: prometheus-k8s serviceMonitorNamespaceSelector: {} serviceMonitorSelector: {} version: v2.11.0 additionalScrapeConfigs: name: ingress-nginx-additional-configs key: prometheus-additional.yaml é‡å»ºpromethesé…ç½®:\n1 $ kubectl delete -f ./prometheus-prometheus.yaml \u0026amp;\u0026amp; kubectl apply -f ./prometheus-prometheus.yaml Grafanç›‘æ§ å…³äºGrafançš„ç›‘æ§é¢æ¿ï¼Œå¯ä»¥å»å®˜æ–¹è¿›è¡Œå¯»æ‰¾\nhttps://grafana.com/grafana/dashboards/\nIstioä¹Ÿæä¾›äº†è‡ªèº«å¹³å°çš„ç›‘æ§å¤§ç›˜ï¼Œå¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡ºIstioçš„é»˜è®¤ç›‘æ§å¤§ç›˜éå¸¸å…¨é¢ï¼Œè¯¥ç›‘æ§çš„éƒ½ç›‘æ§èµ·æ¥äº† å‚è€ƒæ–‡æ¡£ï¼šhttps://www.cnblogs.com/justmine/p/12269587.html\n","date":"2024-03-04T11:44:38Z","image":"https://www.ownit.top/title_pic/51.jpg","permalink":"https://www.ownit.top/p/202403041144/","title":"Kube-Prometheus ç›‘æ§Istio"},{"content":"Ansibleæ‰¹é‡ä¸»æœºæœºå™¨åˆ°Jumpserver 1ã€èƒŒæ™¯ åœ¨ç°ä»£ IT ç¯å¢ƒä¸­ï¼Œéšç€æœºå™¨æ•°é‡çš„å¢åŠ å’Œå¤æ‚æ€§çš„æé«˜ï¼Œæ‰‹åŠ¨ç®¡ç†å’Œé…ç½®æœºå™¨å˜å¾—è¶Šæ¥è¶Šå›°éš¾å’Œè€—æ—¶ã€‚ä¸ºäº†æé«˜æ•ˆç‡å¹¶ç¡®ä¿ä¸€è‡´æ€§ï¼Œè‡ªåŠ¨åŒ–å·¥å…·æˆä¸ºäº†ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚Jumpserver æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å ¡å’æœºå’ŒæœåŠ¡å™¨ç®¡ç†å¹³å°ï¼Œå¯ä»¥å¸®åŠ©ç®¡ç†å‘˜æ›´å¥½åœ°ç®¡ç†å’Œæ§åˆ¶è¿œç¨‹æœºå™¨ã€‚\næœ€è¿‘ï¼Œæˆ‘ä»¬é¢ä¸´ç€ä¸€ä¸ªæŒ‘æˆ˜ï¼šéœ€è¦å°†ä¸€æ‰¹æ–°çš„æœºå™¨ï¼ˆçº¦ K å°ï¼‰å¯¼å…¥åˆ° Jumpserver ä¸­ï¼Œå¹¶æŒ‰ç…§é¢„å®šä¹‰çš„åˆ†ç»„è¿›è¡Œç»„ç»‡ã€‚æ‰‹åŠ¨é€ä¸ªå¯¼å…¥è¿™äº›æœºå™¨å°†æ˜¯ä¸€é¡¹ç¹çä¸”å®¹æ˜“å‡ºé”™çš„ä»»åŠ¡ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬æ¥æ‰¹é‡å¯¼å…¥æœºå™¨åˆ° Jumpserverï¼Œå¹¶æ ¹æ®åˆ†ç»„è¿›è¡Œç»„ç»‡ã€‚\n2ã€ç¯å¢ƒå‡†å¤‡ Ansible\n1 2 3 4 5 6 7 root@wq-1:~/file# ansible --version ansible 2.10.8 config file = /etc/ansible/ansible.cfg configured module search path = [\u0026#39;/root/.ansible/plugins/modules\u0026#39;, \u0026#39;/usr/share/ansible/plugins/modules\u0026#39;] ansible python module location = /usr/lib/python3/dist-packages/ansible executable location = /usr/bin/ansible python version = 3.10.12 (main, Nov 20 2023, 15:14:05) [GCC 11.4.0] Jumpserver ç‰ˆæœ¬ï¼ˆ3.8.1ï¼‰\nâ€\n3ã€æ“ä½œæµç¨‹ jumpserverAPI æ–‡æ¡£ âš“ï¸ https://docs.jumpserver.org/zh/master/dev/rest_api/\nâ€\n1ã€è·å– Jumpserver çš„ token éœ€è¦æ›¿æ¢ ç½‘ç«™åœ°å€ å’Œ ç”¨æˆ· è´¦å· å’Œ å¯†ç ã€‚\nï¼ˆæ³¨æ„ï¼‰ï¼šJumpserver çš„ç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œæ¥å£æ–‡æ¡£çš„å‚æ•°ä¹Ÿä¼šå˜å¾—ï¼Œè¯·ä¾ç…§è‡ªå·±çš„ç‰ˆæœ¬æ¥å£è°ƒè¯•ã€‚\n1 curl -X POST https://jms.ç½‘ç«™.top/api/v1/authentication/auth/ -H \u0026#39;Content-Type: application/json\u0026#39; -d \u0026#39;{\u0026#34;username\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;xxxx\u0026#34;}\u0026#39; â€‹\n2ã€åˆ›å»ºæ‰€æœ‰æœºå™¨çš„æ¨¡æ¿è´¦å· æ‰€æœ‰çš„æœºå™¨å¯ä»¥ç»Ÿä¸€ä½¿ç”¨åŒä¸€ è´¦å·æ¥ç®¡ç†ã€‚è´¦å·å¯ä»¥ä½¿ç”¨ ï¼Œå¯†ç æˆ–ç§˜é’¥ã€‚æ ¹æ®è‡ªå·±æƒ…å†µæ¥æ“ä½œï¼Œæˆ‘ä»¬è¿™è¾¹éœ€è¦è¿™ä¸ªæ¨¡æ¿è´¦å·çš„ id è¿›è¡Œç»‘å®šï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ Jumpserver ä¸­è¿œç¨‹è®¿é—®æœºå™¨ã€‚\næ­¥éª¤ 1 â€‹\næ­¥éª¤ 2 â€‹â€‹\næ­¥éª¤ 3 â€‹â€‹\næˆ‘ä»¬éœ€è¦è¿™ä¸ª id å·ã€‚\n3ã€è‡ªåŠ¨åˆ›å»ºåˆ†ç»„å’Œæœºå™¨è„šæœ¬ add_jms_hosts.sh ï¼ˆä¼šå‚å…¥ä¸‰ä¸ªå‚æ•° åˆ†ç»„åç§° IP åœ°å€ ä¸»æœºåç§°ï¼‰ æ³¨æ„ï¼šè¿™ä¸ªè„šæœ¬å¿…é€‰ é…åˆ jq ã€‚è¯·å…ˆå®‰è£…å®Œæˆä½¿ç”¨\n1 yum install -y jq ä¸»æœºåç§°ä½œä¸º id æ¥çš„ï¼Œæ‰€ä»¥å€¼å¿…é€‰å”¯ä¸€ï¼Œè¯·æ³¨æ„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 #!/bin/bash # JumpServer API ç›¸å…³ä¿¡æ¯ JUMPSERVER_URL=\u0026#34;http://10.1.10.3/api/v1\u0026#34; JUMPSERVER_TOKEN=\u0026#34;8j85rhlicQ8Mjxxxxx\u0026#34; # ä¼ å…¥çš„å‚æ•° GROUP_NAME=\u0026#34;$1\u0026#34; IP=\u0026#34;$2\u0026#34; HOST_NAME=\u0026#34;$3\u0026#34; # æ£€æŸ¥åˆ†ç»„æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º check_and_create_group() { echo \u0026#34;æ£€æŸ¥åˆ†ç»„æ˜¯å¦å­˜åœ¨...\u0026#34; group_id=$(curl -s -H \u0026#34;Authorization: Bearer $JUMPSERVER_TOKEN\u0026#34; \u0026#34;$JUMPSERVER_URL/assets/nodes/\u0026#34; | jq -r --arg GROUP_NAME \u0026#34;$GROUP_NAME\u0026#34; \u0026#39;.[] | select(.name==$GROUP_NAME) | .id\u0026#39;) if [ -z \u0026#34;$group_id\u0026#34; ]; then echo \u0026#34;åˆ†ç»„ä¸å­˜åœ¨ï¼Œåˆ›å»ºåˆ†ç»„...\u0026#34; group_id=$(curl -s -X POST -H \u0026#34;Authorization: Bearer $JUMPSERVER_TOKEN\u0026#34; -H \u0026#34;Content-Type: application/json\u0026#34; -d \u0026#39;{\u0026#34;value\u0026#34;: \u0026#34;\u0026#39;$GROUP_NAME\u0026#39;\u0026#34;}\u0026#39; \u0026#34;$JUMPSERVER_URL/assets/nodes/\u0026#34; | jq -r \u0026#39;.id\u0026#39;) echo \u0026#34;åˆ›å»ºåçš„åˆ†ç»„ID: $group_id\u0026#34; else echo \u0026#34;æ‰¾åˆ°çš„åˆ†ç»„ID: $group_id\u0026#34; fi } # åˆ›å»ºæˆ–æ›´æ–°èµ„äº§ create_or_update_asset() { echo \u0026#34;åˆ›å»ºæˆ–æ›´æ–°èµ„äº§ $HOST_NAME ...\u0026#34; asset_data=\u0026#39;{ \u0026#34;name\u0026#34;: \u0026#34;\u0026#39;$HOST_NAME\u0026#39;\u0026#34;, \u0026#34;address\u0026#34;: \u0026#34;\u0026#39;$IP\u0026#39;\u0026#34;, \u0026#34;platform\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;protocols\u0026#34;: [{\u0026#34;name\u0026#34;: \u0026#34;ssh\u0026#34;, \u0026#34;port\u0026#34;: 22}], \u0026#34;is_active\u0026#34;: true, \u0026#34;nodes\u0026#34;: [\u0026#34;\u0026#39;$group_id\u0026#39;\u0026#34;], \u0026#34;accounts\u0026#34;: [{\u0026#34;template\u0026#34;: \u0026#34;f728c07f-003e-415e-a6be-d02e6fbf7f28\u0026#34;}] }\u0026#39; #æ­¤å¤„çš„idï¼Œä¸ºæ¨¡æ¿è´¦å· id response=$(curl -s -X POST -H \u0026#34;Authorization: Bearer $JUMPSERVER_TOKEN\u0026#34; -H \u0026#34;Content-Type: application/json\u0026#34; -d \u0026#34;$asset_data\u0026#34; \u0026#34;$JUMPSERVER_URL/assets/hosts/\u0026#34;) echo \u0026#34;èµ„äº§åˆ›å»ºæˆ–æ›´æ–°å“åº”: $response\u0026#34; } check_and_create_group create_or_update_asset æ‰§è¡Œ demo\n1 2 3 4 5 6 root@wq-1:~/file# ./add_jms_hosts.sh ownit 192.168.16.16 ownit-16 æ£€æŸ¥åˆ†ç»„æ˜¯å¦å­˜åœ¨... åˆ†ç»„ä¸å­˜åœ¨ï¼Œåˆ›å»ºåˆ†ç»„... åˆ›å»ºåçš„åˆ†ç»„ID: b939d606-e334-494f-8a87-b1b464a941ce åˆ›å»ºæˆ–æ›´æ–°èµ„äº§ ownit-16 ... èµ„äº§åˆ›å»ºæˆ–æ›´æ–°å“åº”: {\u0026#34;id\u0026#34;:\u0026#34;ec503228-77e8-4d44-9c5a-a322f45ad4ec\u0026#34;,\u0026#34;name\u0026#34;:\u0026#34;ownit-16\u0026#34;,\u0026#34;address\u0026#34;:\u0026#34;192.168.16.16\u0026#34;,\u0026#34;comment\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;domain\u0026#34;:null,\u0026#34;platform\u0026#34;:{\u0026#34;id\u0026#34;:1,\u0026#34;name\u0026#34;:\u0026#34;Linux\u0026#34;},\u0026#34;nodes\u0026#34;:[{\u0026#34;id\u0026#34;:\u0026#34;b939d606-e334-494f-8a87-b1b464a941ce\u0026#34;,\u0026#34;name\u0026#34;:\u0026#34;ownit\u0026#34;}],\u0026#34;labels\u0026#34;:[],\u0026#34;protocols\u0026#34;:[{\u0026#34;name\u0026#34;:\u0026#34;ssh\u0026#34;,\u0026#34;port\u0026#34;:22}],\u0026#34;nodes_display\u0026#34;:[\u0026#34;/Default/ownit\u0026#34;],\u0026#34;category\u0026#34;:{\u0026#34;value\u0026#34;:\u0026#34;host\u0026#34;,\u0026#34;label\u0026#34;:\u0026#34;ä¸»æœº\u0026#34;},\u0026#34;type\u0026#34;:{\u0026#34;value\u0026#34;:\u0026#34;linux\u0026#34;,\u0026#34;label\u0026#34;:\u0026#34;Linux\u0026#34;},\u0026#34;connectivity\u0026#34;:{\u0026#34;value\u0026#34;:\u0026#34;-\u0026#34;,\u0026#34;label\u0026#34;:\u0026#34;æœªçŸ¥\u0026#34;},\u0026#34;auto_config\u0026#34;:{\u0026#34;su_enabled\u0026#34;:true,\u0026#34;domain_enabled\u0026#34;:true,\u0026#34;ansible_enabled\u0026#34;:true,\u0026#34;id\u0026#34;:1,\u0026#34;ansible_config\u0026#34;:{\u0026#34;ansible_connection\u0026#34;:\u0026#34;smart\u0026#34;},\u0026#34;ping_enabled\u0026#34;:true,\u0026#34;ping_method\u0026#34;:\u0026#34;posix_ping\u0026#34;,\u0026#34;ping_params\u0026#34;:{},\u0026#34;gather_facts_enabled\u0026#34;:true,\u0026#34;gather_facts_method\u0026#34;:\u0026#34;gather_facts_posix\u0026#34;,\u0026#34;gather_facts_params\u0026#34;:{},\u0026#34;change_secret_enabled\u0026#34;:true,\u0026#34;change_secret_method\u0026#34;:\u0026#34;change_secret_posix\u0026#34;,\u0026#34;change_secret_params\u0026#34;:{},\u0026#34;push_account_enabled\u0026#34;:true,\u0026#34;push_account_method\u0026#34;:\u0026#34;push_account_posix\u0026#34;,\u0026#34;push_account_params\u0026#34;:{\u0026#34;sudo\u0026#34;:\u0026#34;/bin/whoami\u0026#34;,\u0026#34;shell\u0026#34;:\u0026#34;/bin/bash\u0026#34;,\u0026#34;home\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;groups\u0026#34;:\u0026#34;\u0026#34;},\u0026#34;verify_account_enabled\u0026#34;:true,\u0026#34;verify_account_method\u0026#34;:\u0026#34;verify_account_posix\u0026#34;,\u0026#34;verify_account_params\u0026#34;:{},\u0026#34;gather_accounts_enabled\u0026#34;:true,\u0026#34;gather_accounts_method\u0026#34;:\u0026#34;gather_accounts_posix\u0026#34;,\u0026#34;gather_accounts_params\u0026#34;:{},\u0026#34;remove_account_enabled\u0026#34;:true,\u0026#34;remove_account_method\u0026#34;:\u0026#34;remove_account_posix\u0026#34;,\u0026#34;remove_account_params\u0026#34;:{},\u0026#34;platform\u0026#34;:1},\u0026#34;created_by\u0026#34;:\u0026#34;Administrator\u0026#34;,\u0026#34;gathered_info\u0026#34;:{},\u0026#34;org_id\u0026#34;:\u0026#34;00000000-0000-0000-0000-000000000002\u0026#34;,\u0026#34;org_name\u0026#34;:\u0026#34;Default\u0026#34;,\u0026#34;spec_info\u0026#34;:{},\u0026#34;is_active\u0026#34;:true,\u0026#34;date_verified\u0026#34;:null,\u0026#34;date_created\u0026#34;:\u0026#34;2024/01/26 09:50:54 +0800\u0026#34;} 4ã€Ansible æ‰¹é‡è·‘è„šæœ¬ ä¸Šé¢çš„è„šæœ¬å·²ç»å®ç°ï¼Œç°åœ¨å°±æ‰¹é‡è·‘æ•°æ®ã€‚ï¼ˆæ³¨æ„ï¼Œä½¿ç”¨ Ansible è·‘ï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œæœ‰äº›ä¸æˆåŠŸï¼‰ æœ€åä½¿ç”¨ shell è„šæœ¬æ¥å¤„ç† çš„\nâ€\nAnsible çš„ hosts å®šä¹‰\n1 2 3 4 5 6 7 8 9 root@wq-1:~/ansible# cat hosts [all:vars] ansible_ssh_user=root ansible_ssh_pass=dgadxxx [wq] 10.1.11.[1:90] [li] 10.1.17.[1:46] Ansible çš„å‰§æœ¬æ–‡ä»¶ï¼ˆæ³¨æ„ hosts çš„å®šä¹‰ï¼Œæˆ‘æ˜¯æŒ‰åˆ†ç»„å•ä¸ªæ‰§è¡Œï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 {{ group_names[0] }} {{ inventory_hostname }} è¿™ä¸¤ä¸ªæ˜¯Ansibleçš„å†…ç½®å˜é‡ ansible own -m setup å¯ä»¥ä½¿ç”¨ è¿™ä¸ªæŸ¥è¯¢é‚£ä¸ªæœ‰å†…ç½®å˜é‡ [root@bt ~]# ansible own -m setup | head -n 50 192.168.102.20 | SUCCESS =\u0026gt; { \u0026#34;ansible_facts\u0026#34;: { \u0026#34;ansible_all_ipv4_addresses\u0026#34;: [ \u0026#34;192.168.102.20\u0026#34;, \u0026#34;172.17.0.1\u0026#34;, \u0026#34;172.23.0.1\u0026#34;, \u0026#34;172.18.0.1\u0026#34;, \u0026#34;172.22.0.1\u0026#34;, \u0026#34;172.25.1.10\u0026#34;, \u0026#34;172.19.0.1\u0026#34; ], \u0026#34;ansible_all_ipv6_addresses\u0026#34;: [ \u0026#34;fe80::a095:f2ff:fe80:413b\u0026#34;, \u0026#34;fe80::42:b1ff:fe02:9e5f\u0026#34;, \u0026#34;fe80::42:20ff:fe5e:7cfd\u0026#34;, \u0026#34;fe80::6c19:a7ff:fe5e:a4f\u0026#34;, \u0026#34;fe80::ac72:32ff:feaa:3ef\u0026#34;, \u0026#34;fe80::c0a1:c1ff:fea2:63b9\u0026#34; ], \u0026#34;ansible_apparmor\u0026#34;: { \u0026#34;status\u0026#34;: \u0026#34;disabled\u0026#34; }, 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 root@wq-1:~/ansible# cat add_jms_host.yml - hosts: wq remote_user: root gather_facts: no tasks: - name: å¤åˆ¶ jq åˆ°è¿œç¨‹ä¸»æœº copy: src: /usr/bin/jq dest: /usr/bin/jq mode: \u0026#39;0755\u0026#39; - name: è·å–ç³»ç»Ÿçš„ä¸»æœºåç§° shell: hostname register: result - name: æ‰“å°å˜é‡ debug: msg: - \u0026#34;Group Name: {{ group_names[0] }}\u0026#34; - \u0026#34;Ansible Host: {{ inventory_hostname }}\u0026#34; - \u0026#34;Inventory Hostname: {{ result.stdout }}\u0026#34; - name: \u0026#34;æ‰§è¡Œæ·»åŠ åˆ° JumpServer çš„è„šæœ¬\u0026#34; script: /root/file/add_jms_hosts.sh {{ group_names[0] }} {{ inventory_hostname }} {{ result.stdout }} args: executable: /bin/bash æ‰§è¡Œçš„ demo\n1 ansible-playbook add_jms_host.yml -i ./hosts ä¸Šæ‰§è¡Œå®Œæ¯•ï¼Œä½†æ˜¯æœ‰é—®é¢˜ï¼Œæˆ‘ 90 å°æœºå™¨ï¼Œä½†å®é™…æ·»åŠ çš„åªæœ‰ 30 å°ï¼Œå…¶ä½™æ˜¯æ‰§è¡Œæ­£å¸¸çš„ï¼Œä½†æ˜¯æ²¡æœ‰æ·»åŠ ã€‚\næˆ–è€…ä½¿ç”¨ä¸‹é¢çš„\nâ€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 - hosts: wq remote_user: root gather_facts: no tasks: - name: å¤åˆ¶ jq åˆ°è¿œç¨‹ä¸»æœº copy: src: /usr/bin/jq dest: /usr/bin/jq mode: \u0026#39;0755\u0026#39; - name: å¤åˆ¶ add_jms_hosts.sh åˆ°è¿œç¨‹ä¸»æœº copy: src: /root/file/add_jms_hosts.sh dest: /root/add_jms_hosts.sh mode: \u0026#39;0755\u0026#39; - name: è·å–ç³»ç»Ÿçš„ä¸»æœºåç§° shell: hostname register: result - name: æ‰“å°å˜é‡ debug: msg: - \u0026#34;Group Name: {{ group_names[0] }}\u0026#34; - \u0026#34;Ansible Host: {{ inventory_hostname }}\u0026#34; - \u0026#34;Inventory Hostname: {{ result.stdout }}\u0026#34; - name: æ‰§è¡Œæ·»åŠ åˆ° JumpServer çš„è„šæœ¬ command: /bin/bash /root/add_jms_hosts.sh {{ group_names[0] }} {{ inventory_hostname }} {{ result.stdout }} â€\n5ã€shell æ‰§è¡Œæ‰¹é‡æ•°æ® å¦‚æœä¸Šé¢çš„æ‰§è¡Œè¿˜æ˜¯ä¸è¡Œï¼Œé‚£å°±ä½¿ç”¨ ä¸‹æ–¹çš„æ–¹å¼ 100 % å¯ä»¥ã€‚\næˆ‘å…ˆä½¿ç”¨ ansible è·‘å‡º åˆ†ç»„ ip å’Œ ä¸»æœºåç§°\nâ€\n1 2 3 4 5 6 7 8 9 10 11 12 - hosts: li remote_user: root gather_facts: no tasks: - name: è·å–ç³»ç»Ÿçš„ä¸»æœºåç§° shell: hostname register: result - name: æ‰“å°å˜é‡ debug: msg: - \u0026#34;{{ group_names[0] }} {{ inventory_hostname }} {{ result.stdout }} \u0026#34; æ‰§è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ansible-playbook test.yml -i ./hosts \u0026gt;\u0026gt; 1.txt cat 1.txt | grep wq \u0026gt; /root/file/host ï¼ˆç¼–è¾‘host åˆ é™¤ ç¬¬ä¸€è¡Œ é ipçš„ï¼‰ sed \u0026#39;s/. *\u0026amp;quot;(.* \\)\u0026#34;.*/\\1/\u0026#39; host \u0026gt; 1.txt (å‡ºå» åŒå¼•å·) è¿‡æ»¤åçš„æ•°æ®æ ¼å¼ root@wq-1:~/file# cat 1.txt li 10.1.17.1 li-1 li 10.1.17.2 li-2 li 10.1.17.3 li-3 li 10.1.17.4 li-4 li 10.1.17.5 li-5 li 10.1.17.6 li-6 li 10.1.17.7 li-7 li 10.1.17.8 li-8 li 10.1.17.9 li-9 1 2 3 4 5 6 7 8 9 10 11 root@wq-1:~/file# cat star_add.sh #!/bin/bash while IFS= read -r line; do group=$(echo \u0026#34;$line\u0026#34; | awk \u0026#39;{print $1}\u0026#39;) ip=$(echo \u0026#34;$line\u0026#34; | awk \u0026#39;{print $2}\u0026#39;) name=$(echo \u0026#34;$line\u0026#34; | awk \u0026#39;{print $3}\u0026#39;) echo \u0026#34;Group: $group, IP: $ip, Name: $name\u0026#34; # åœ¨è¿™é‡Œæ‰§è¡Œæ‚¨çš„æ“ä½œï¼Œä¾‹å¦‚è°ƒç”¨å…¶ä»–è„šæœ¬å¹¶ä¼ é€’è¿™ä¸‰ä¸ªå˜é‡ ./add_jms_hosts.sh \u0026#34;$group\u0026#34; \u0026#34;$ip\u0026#34; \u0026#34;$name\u0026#34; done \u0026lt; 1.txt bash star_add.sh æ³¨å†Œåˆ° jumpserver ä¸Š\nâ€‹\nâ€\n4ã€æ€»ç»“ æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯ç¼–å†™ä¸€ä¸ªè„šæœ¬ï¼Œè¯¥è„šæœ¬å¯ä»¥è¯»å–åŒ…å«æœºå™¨ä¿¡æ¯çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ Jumpserver æä¾›çš„ API è¿›è¡Œè‡ªåŠ¨å¯¼å…¥ã€‚è„šæœ¬é¦–å…ˆé€šè¿‡é€è¡Œè¯»å–æ–‡æœ¬æ–‡ä»¶æ¥è·å–æ¯å°æœºå™¨çš„ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚ IP åœ°å€ã€ä¸»æœºåå’Œåˆ†ç»„ã€‚ç„¶åï¼Œå®ƒä½¿ç”¨ Jumpserver çš„ API è°ƒç”¨æ¥åˆ›å»ºæ–°çš„æœºå™¨å¯¹è±¡ï¼Œå¹¶å°†å…¶åˆ†é…åˆ°ç›¸åº”çš„åˆ†ç»„ä¸­ã€‚\né€šè¿‡ä½¿ç”¨è¿™ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥å¤§å¤§å‡å°‘æ‰‹åŠ¨æ“ä½œçš„å·¥ä½œé‡ï¼Œå¹¶ç¡®ä¿å¯¼å…¥çš„æœºå™¨è¢«æ­£ç¡®åœ°ç»„ç»‡åˆ° Jumpserver ä¸­çš„ç›¸åº”åˆ†ç»„ä¸­ã€‚è¿™ä¸ä»…æé«˜äº†æ“ä½œæ•ˆç‡ï¼Œè¿˜é™ä½äº†å‡ºé”™çš„é£é™©ï¼Œå¹¶æä¾›äº†ä¸€è‡´æ€§å’Œå¯è¿½æº¯æ€§ã€‚\næ€»ç»“èµ·æ¥ï¼Œé€šè¿‡ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬æ¥æ‰¹é‡å¯¼å…¥æœºå™¨åˆ° Jumpserverï¼Œå¹¶æ ¹æ®é¢„å®šä¹‰çš„åˆ†ç»„è¿›è¡Œç»„ç»‡ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæé«˜å·¥ä½œæ•ˆç‡ã€é™ä½é”™è¯¯ç‡ï¼Œå¹¶ç¡®ä¿ä¸€è‡´æ€§å’Œå¯è¿½æº¯æ€§ã€‚è¿™ä¸ªè§£å†³æ–¹æ¡ˆä¸ºæˆ‘ä»¬èŠ‚çœäº†å®è´µçš„æ—¶é—´å’Œç²¾åŠ›ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ›´å¥½åœ°ç®¡ç†å’Œæ§åˆ¶è¿œç¨‹æœºå™¨ã€‚\n","date":"2024-01-26T10:29:52Z","image":"https://www.ownit.top/title_pic/15.jpg","permalink":"https://www.ownit.top/p/202401261029/","title":"è‡ªåŠ¨åŒ–æ‰¹é‡å¯¼å…¥æœºå™¨åˆ°Jumpserverï¼šæé«˜æ•ˆç‡ä¸ä¸€è‡´æ€§çš„å…³é”®æ­¥éª¤"},{"content":"Kube-Prometheus ç›‘æ§Ingress Kube-Prometheus æ˜¯ä¸€ä¸ªåœ¨ Kubernetes ä¸Šè¿è¡Œçš„ Prometheus å †æ ˆï¼Œå®ƒæä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥ç›‘æ§ä½ çš„ Kubernetes é›†ç¾¤ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Kube-Prometheus æ¥ç›‘æ§ Kubernetes Ingressã€‚\n1ã€å‰ææ¡ä»¶ åœ¨å¼€å§‹ä¹‹å‰ï¼Œä½ éœ€è¦ç¡®ä¿ä½ å·²ç»åœ¨ä½ çš„ Kubernetes é›†ç¾¤ä¸Šå®‰è£…äº†ä»¥ä¸‹ç»„ä»¶ï¼š\nKube-Prometheus Ingress Controllerï¼ˆä¾‹å¦‚ NGINX Ingress Controllerï¼‰ Kubernetes v1.23.0é›†ç¾¤ â€\nå¦‚æœæ²¡æœ‰ï¼Œè¿™å¯ä»¥å‚è€ƒä¸‹æ–¹åšå®¢è¿›è¡Œéƒ¨ç½²æ„å»º\nKube-Prometheus æ‰‹åŠ¨éƒ¨ç½²\nKuberneteså®‰è£…ingress-nginx\nä½¿ç”¨kubeadméƒ¨ç½²ä¸€å¥—Kubernetes v1.23.0é›†ç¾¤\nâ€\n2ã€Ingressä»‹ç» åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ â€œNginx Ingressâ€ å®ç°é›†ç¾¤å—åŒ—å‘æµé‡çš„ä»£ç†è½¬å‘ï¼ŒNginx Ingress åŸºäºé›†ç¾¤å†… Ingress èµ„æºé…ç½®ç”Ÿæˆå…·ä½“çš„è·¯ç”±è§„åˆ™ã€‚Ingress èµ„æºè´Ÿè´£å¯¹å¤–å…¬å¼€æœåŠ¡çš„ç®¡ç†ï¼Œä¸€èˆ¬è¿™ç±»æœåŠ¡é€šè¿‡ HTTP åè®®è¿›è¡Œè®¿é—®ã€‚é€šè¿‡ Nginx Ingress + Ingress èµ„æºå¯ä»¥å®ç°ä»¥ä¸‹åœºæ™¯ï¼š\nâ€\nä¸€ã€é€šè¿‡ Nginx Ingress å°†æ¥è‡ªå®¢æˆ·ç«¯çš„å…¨éƒ¨æµé‡è½¬å‘ç»™å•ä¸€ Serviceã€‚\nâ€‹â€‹\näºŒã€é€šè¿‡ Nginx Ingress å®ç°æ›´å¤æ‚çš„è·¯ç”±è½¬å‘è§„åˆ™ï¼Œå°†æ¥è‡ªå•ä¸€ç»‘å®š IP åœ°å€çš„æ‰€æœ‰æµé‡æ ¹æ® URL è¯·æ±‚è·¯å¾„å‰ç¼€è½¬å‘ç»™ä¸åŒçš„ Serviceã€‚\nâ€‹â€‹\nä¸‰ã€æ ¹æ® HTTP è¯·æ±‚å¤´éƒ¨æºå¸¦çš„ Host å­—æ®µâ€”â€”é€šå¸¸ç”±è®¿é—®çš„åŸŸåå†³å®šï¼Œå°†æ¥è‡ªå•ä¸€ç»‘å®š IP åœ°å€çš„æµé‡åˆ†å‘ç»™ä¸åŒåç«¯ Serviceï¼Œå®ç°åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœºï¼ˆName-based Virtual Hostingï¼‰èƒ½åŠ›ã€‚\nâ€‹â€‹\né€šå¸¸ï¼Œå›´ç»• Nginx Ingress ç½‘å…³ç›‘æ§åœºæ™¯ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå…³æ³¨ä¸¤ç±»æ ¸å¿ƒæŒ‡æ ‡æ•°æ®ï¼š\nå·¥ä½œè´Ÿè½½èµ„æº å³ Nginx Ingress Controller Pod çš„è´Ÿè½½æƒ…å†µï¼Œå½“ CPU ã€å†…å­˜ç­‰èµ„æºæ°´ä½å¤„äºé¥±å’Œæˆ–è¿‡è½½ï¼Œä¼šå¯¼è‡´é›†ç¾¤å¯¹å¤–æœåŠ¡ä¸ç¨³å®šã€‚é’ˆå¯¹â€œå·¥ä½œè´Ÿè½½ç›‘æ§â€ï¼Œä¸€èˆ¬å»ºè®®å…³æ³¨ â€œUSEâ€ æŒ‡æ ‡ï¼Œå³ï¼šä½¿ç”¨ç‡ï¼ˆUtilizationï¼‰ã€é¥±å’Œåº¦ï¼ˆSaturationï¼‰ã€é”™è¯¯ç‡ï¼ˆErrorsï¼‰ã€‚å¯¹æ­¤ï¼Œé˜¿é‡Œäº‘ Prometheus ç›‘æ§æä¾›äº†é¢„ç½®æ€§èƒ½ç›‘æ§å¤§ç›˜ï¼Œå¯å‚è€ƒ ã€Šå·¥ä½œè´Ÿè½½æ€§èƒ½ç›‘æ§ç»„ä»¶æ¥å…¥ã€‹ [1] å®Œæˆæ•°æ®é‡‡é›†ä¸å¤§ç›˜åˆ›å»ºã€‚\nå…¥å£è¯·æ±‚æµé‡ åŒ…æ‹¬é›†ç¾¤èŒƒå›´å…¨å±€çš„æµé‡ã€æŸä¸ª Ingress è§„åˆ™è½¬å‘çš„æµé‡ã€æŸä¸ª Service çš„æµé‡ï¼Œä»¥åŠå¯¹åº”çš„æˆåŠŸç‡/é”™è¯¯ç‡ã€å»¶è¿Ÿï¼Œä¹ƒè‡³è¯·æ±‚æ¥æºçš„åœ°å€ã€è®¾å¤‡ç­‰ä¿¡æ¯çš„åˆ†æä¸ç»Ÿè®¡ã€‚é’ˆå¯¹â€œå…¥å£è¯·æ±‚æµé‡ç›‘æ§â€ï¼Œä¸€èˆ¬å»ºè®®å…³æ³¨ â€œREDâ€ æŒ‡æ ‡ï¼Œå³ï¼šè¯·æ±‚é€Ÿç‡ï¼ˆRateï¼‰ã€è¯·æ±‚å¤±è´¥æ•°ï¼ˆErrorsï¼‰ã€è¯·æ±‚å»¶è¿Ÿï¼ˆDurationï¼‰ã€‚å¯é€šè¿‡æœ¬æ–‡æœ€ä½³å®è·µå®ç°æ¥å…¥ã€‚\n3ã€Ingressé…ç½® Ingressçš„ç›‘æ§ç«¯å£ï¼š10254\nâ€‹â€‹\nâ€\næŸ¥çœ‹SVCï¼ŒPOD\nâ€‹â€‹\n1ã€ä¿®æ”¹Ingress deploymentå†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 apiVersion: v1 kind: Deployment metadata: annotations: prometheus.io/scrape: \u0026#34;true\u0026#34; prometheus.io/port: \u0026#34;10254\u0026#34; .. spec: ports: - name: prometheus containerPort: 10254 .. é‡æ–°applyä¸€ä¸‹yamlæ–‡ä»¶è®©ä¿®æ”¹çš„é…ç½®ç”Ÿæ•ˆ kubectl apply -f ingress-deploy.yml æˆ–è€…\nå› ä¸ºå·²ç»éƒ¨ç½²å¯ä»¥ç›´æ¥ç¼–è¾‘\n1 2 3 4 5 6 7 8 kubectl edit deployments.apps -n ingress-nginx ingress-nginx-controller ports: - containerPort: 10254 hostPort: 10254 name: prometheus protocol: TCP â€‹â€‹\nä¹‹åä¿å­˜é€€å‡º\næ³¨æ„ï¼šè¿™è¾¹æœ‰ä¸ªå‘ï¼Œå› ä¸ºæˆ‘çš„Ingressæ˜¯ä½¿ç”¨çš„hostnetwork å›ºå®šnode01 ä¸Šï¼Œ\næ‰€ä»¥ä¿å­˜é‡å¯ ä¼šå¤±è´¥ï¼Œå› ä¸º80 å’Œ 443 ç«¯å£å·²ç»è¢«å ç”¨ã€‚\nè§£å†³é—®é¢˜ï¼šå¤‡ä»½åŸæœ¬Ingressçš„yamlæ–‡ä»¶ï¼Œåˆ é™¤Ingressçš„deploymentï¼Œåœ¨ä½¿ç”¨yamlæ–‡ä»¶é‡å»º å³å¯\nâ€\nhostNetwork: true\nnodeName: node01\nnodeSelector:\nkubernetes.io/os: linux\n2ã€ä¿®æ”¹Ingress Serviceå†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: v1 kind: Service metadata: annotations: prometheus.io/scrape: \u0026#34;true\u0026#34; prometheus.io/port: \u0026#34;10254\u0026#34; .. spec: ports: - name: prometheus port: 10254 targetPort: 10254 .. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 --- apiVersion: v1 kind: Service metadata: annotations: #svc è¿™ä¸€å—å¿…é¡»è¦åŠ ï¼Œä¸ç„¶ä¸ä¼šç›‘æ§åˆ° prometheus.io/port: \u0026#39;10254\u0026#39; prometheus.io/scrape: \u0026#39;true\u0026#39; labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: ingress-nginx app.kubernetes.io/version: 1.0.0 helm.sh/chart: ingress-nginx-4.0.1 name: ingress-nginx-controller namespace: ingress-nginx spec: ports: - appProtocol: http name: http port: 80 protocol: TCP targetPort: http - appProtocol: https name: https port: 443 protocol: TCP targetPort: https - name: prometheus port: 10254 protocol: TCP targetPort: prometheus selector: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx sessionAffinity: None type: ClusterIP 3ã€æµ‹è¯•ä¸€ä¸‹ä¿®æ”¹æ˜¯å¦æ­£å¸¸ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 [root@bt app]# kubectl get po,svc -n ingress-nginx NAME READY STATUS RESTARTS AGE pod/ingress-nginx-controller-d494d449b-k7z5q 1/1 Running 0 59m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/ingress-nginx-controller ClusterIP 172.21.20.203 \u0026lt;none\u0026gt; 80/TCP,443/TCP,10254/TCP 448d service/ingress-nginx-controller-admission ClusterIP 172.21.18.217 \u0026lt;none\u0026gt; 443/TCP 448d [root@bt app]# [root@bt app]# curl 172.21.20.203:10254/metrics # HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles. # TYPE go_gc_duration_seconds summary go_gc_duration_seconds{quantile=\u0026#34;0\u0026#34;} 4.1684e-05 go_gc_duration_seconds{quantile=\u0026#34;0.25\u0026#34;} 0.000148229 go_gc_duration_seconds{quantile=\u0026#34;0.5\u0026#34;} 0.000936162 go_gc_duration_seconds{quantile=\u0026#34;0.75\u0026#34;} 0.001216288 go_gc_duration_seconds{quantile=\u0026#34;1\u0026#34;} 0.002295067 go_gc_duration_seconds_sum 0.039017271 go_gc_duration_seconds_count 46 # HELP go_goroutines Number of goroutines that currently exist. â€‹â€‹\n4ã€ServiceMonitor æ–°å¢Ingress ServiceMonitor\næŸ¥è¯¢æ ‡ç­¾\n1 2 3 4 [root@bt app]# kubectl get svc -n ingress-nginx --show-labels NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE LABELS ingress-nginx-controller ClusterIP 172.21.20.203 \u0026lt;none\u0026gt; 80/TCP,443/TCP,10254/TCP 448d app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/version=1.0.0,helm.sh/chart=ingress-nginx-4.0.1 ingress-nginx-controller-admission ClusterIP 172.21.18.217 \u0026lt;none\u0026gt; 443/TCP 448d app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/version=1.0.0,helm.sh/chart=ingress-nginx-4.0.1 æ ¹æ®æ­¤å¤„çš„æ ‡ç­¾æ¥å¡«å†™ä¸‹é¢çš„selector åŒ¹é…æ ‡ç­¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 apiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: name: ingress-nginx namespace: monitoring spec: endpoints: - interval: 15s port: prometheus namespaceSelector: matchNames: - ingress-nginx selector: matchLabels: #æ­¤å¤„ä¸æ˜¯ä¹±å†™çš„ï¼Œè¦æ ¹æ®è‡ªå·±å®é™…æƒ…å†µï¼ŒæŸ¥æ ‡ç­¾ app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/version: 1.0.0 --- # åœ¨å¯¹åº”çš„nsä¸­åˆ›å»ºè§’è‰² apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: prometheus-k8s namespace: ingress-nginx rules: - apiGroups: - \u0026#34;\u0026#34; resources: - services - endpoints - pods verbs: - get - list - watch --- # ç»‘å®šè§’è‰² prometheus-k8s è§’è‰²åˆ° Role apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: prometheus-k8s namespace: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: prometheus-k8s subjects: - kind: ServiceAccount name: prometheus-k8s # Prometheus å®¹å™¨ä½¿ç”¨çš„ serviceAccountï¼Œkube-prometheusé»˜è®¤ä½¿ç”¨prometheus-k8sè¿™ä¸ªç”¨æˆ· namespace: monitoring 5ã€æ·»åŠ æŠ¥è­¦è§„åˆ™ â€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 apiVersion: monitoring.coreos.com/v1 kind: PrometheusRule metadata: labels: prometheus: k8s role: alert-rules name: nginx-ingress-rules namespace: monitoring spec: groups: - name: nginx-ingress-rules rules: - alert: NginxFailedtoLoadConfiguration expr: nginx_ingress_controller_config_last_reload_successful == 0 for: 1m labels: severity: critical annotations: summary: \u0026#34;Nginx Ingress Controlleré…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥\u0026#34; description: \u0026#34;Nginx Ingress Controllerçš„é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®ã€‚\u0026#34; - alert: NginxHighHttp4xxErrorRate expr: rate(nginx_ingress_controller_requests{status=~\u0026#34;^404\u0026#34;}[5m]) * 100 \u0026gt; 1 for: 1m labels: severity: warining annotations: description: Nginx high HTTP 4xx error rate ( namespaces {{ $labels.exported_namespace }} host {{ $labels.host }} ) summary: \u0026#34;Too many HTTP requests with status 404 (\u0026gt; 1%)\u0026#34; - alert: NginxHighHttp5xxErrorRate expr: rate(nginx_ingress_controller_requests{status=~\u0026#34;^5..\u0026#34;}[5m]) * 100 \u0026gt; 1 for: 1m labels: severity: warining annotations: description: Nginx high HTTP 5xx error rate ( namespaces {{ $labels.exported_namespace }} host {{ $labels.host }} ) summary: \u0026#34;Too many HTTP requests with status 5xx (\u0026gt; 1%)\u0026#34; - alert: NginxLatencyHigh expr: histogram_quantile(0.99, sum(rate(nginx_ingress_controller_request_duration_seconds_bucket[2m])) by (host, node)) \u0026gt; 3 for: 2m labels: severity: warining annotations: description: Nginx latency high ( namespaces {{ $labels.exported_namespace }} host {{ $labels.host }} ) summary: \u0026#34;Nginx p99 latency is higher than 3 seconds\u0026#34; - alert: NginxHighRequestRate expr: rate(nginx_ingress_controller_nginx_process_requests_total[5m]) * 100 \u0026gt; 1000 for: 1m labels: severity: warning annotations: description: Nginx ingress controller high request rate ( instance {{ $labels.instance }} namespaces {{ $labels.namespaces }} pod {{$labels.pod}}) summary: \u0026#34;Nginx ingress controller high request rate (\u0026gt; 1000 requests per second)\u0026#34; - alert: SSLCertificateExpiration15day expr: nginx_ingress_controller_ssl_expire_time_seconds \u0026lt; 1296000 for: 30m labels: severity: warning annotations: summary: SSL/TLS certificate for {{ $labels.host $labels.secret_name }} is about to expire description: The SSL/TLS certificate for {{ $labels.host $labels.secret_name }} will expire in less than 15 days. - alert: SSLCertificateExpiration7day expr: nginx_ingress_controller_ssl_expire_time_seconds \u0026lt; 604800 for: 30m labels: severity: critical annotations: summary: SSL/TLS certificate for {{ $labels.host $labels.secret_name }} is about to expire description: The SSL/TLS certificate for {{ $labels.host $labels.secret_name }} will expire in less than 7 days. æ‰§è¡ŒæŸ¥è¯¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 [root@bt app]# kubectl apply -f ingress_rule_yaml [root@bt app]# kubectl get prometheusrules.monitoring.coreos.com -n monitoring NAME AGE alertmanager-main-rules 24h etcd-rules 21h kube-prometheus-rules 24h kube-state-metrics-rules 24h kubernetes-monitoring-rules 24h nginx-ingress-rules 11s node-exporter-rules 24h prometheus-k8s-prometheus-rules 24h prometheus-operator-rules 24h â€‹â€‹\n6ã€Grafanå¯¼å…¥æ¨¡ç‰ˆ\nIngress-nginxæ¨¡æ¿IDï¼š9614ã€14314\nâ€‹â€‹\nâ€‹â€‹\nâ€\n6ã€ç›‘æ§æŒ‡æ ‡ 1 curl http://172.21.20.203:10254/metrics è®¿é—®ä¸Šé¢çš„æ¥å£ï¼Œä¼šè¿”å›ç›‘æ§æŒ‡æ ‡ï¼Œè¿™å†™æ•°æ®Prometheusä¼šå®šæ—¶æ‹‰å»ã€‚\næ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹è¿™äº›æ•°æ®çš„å«ä¹‰\n1 curl http://172.21.20.203:10254/metrics | grep -Ev \u0026#39;^#\u0026#39; |awk -F \u0026#39;{\u0026#39; \u0026#39;{print $1}\u0026#39; | sort | uniq | awk \u0026#39;{print $1}\u0026#39; â€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 [root@bt ~]# curl http://172.21.20.203:10254/metrics | grep -Ev \u0026#39;^#\u0026#39; |awk -F \u0026#39;{\u0026#39; \u0026#39;{print $1}\u0026#39; | sort | uniq | awk \u0026#39;{print $1}\u0026#39; % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 291k 0 291k 0 0 6654k 0 --:--:-- --:--:-- --:--:-- 6781k go_gc_duration_seconds go_gc_duration_seconds_count go_gc_duration_seconds_sum go_goroutines go_info go_memstats_alloc_bytes go_memstats_alloc_bytes_total go_memstats_buck_hash_sys_bytes go_memstats_frees_total go_memstats_gc_cpu_fraction go_memstats_gc_sys_bytes go_memstats_heap_alloc_bytes go_memstats_heap_idle_bytes go_memstats_heap_inuse_bytes go_memstats_heap_objects go_memstats_heap_released_bytes go_memstats_heap_sys_bytes go_memstats_last_gc_time_seconds go_memstats_lookups_total go_memstats_mallocs_total go_memstats_mcache_inuse_bytes go_memstats_mcache_sys_bytes go_memstats_mspan_inuse_bytes go_memstats_mspan_sys_bytes go_memstats_next_gc_bytes go_memstats_other_sys_bytes go_memstats_stack_inuse_bytes go_memstats_stack_sys_bytes go_memstats_sys_bytes go_threads nginx_ingress_controller_bytes_sent_bucket nginx_ingress_controller_bytes_sent_count nginx_ingress_controller_bytes_sent_sum nginx_ingress_controller_config_hash nginx_ingress_controller_config_last_reload_successful nginx_ingress_controller_config_last_reload_successful_timestamp_seconds nginx_ingress_controller_ingress_upstream_latency_seconds nginx_ingress_controller_ingress_upstream_latency_seconds_count nginx_ingress_controller_ingress_upstream_latency_seconds_sum nginx_ingress_controller_leader_election_status nginx_ingress_controller_nginx_process_connections nginx_ingress_controller_nginx_process_connections_total nginx_ingress_controller_nginx_process_cpu_seconds_total nginx_ingress_controller_nginx_process_num_procs nginx_ingress_controller_nginx_process_oldest_start_time_seconds nginx_ingress_controller_nginx_process_read_bytes_total nginx_ingress_controller_nginx_process_requests_total nginx_ingress_controller_nginx_process_resident_memory_bytes nginx_ingress_controller_nginx_process_virtual_memory_bytes nginx_ingress_controller_nginx_process_write_bytes_total nginx_ingress_controller_request_duration_seconds_bucket nginx_ingress_controller_request_duration_seconds_count nginx_ingress_controller_request_duration_seconds_sum nginx_ingress_controller_requests nginx_ingress_controller_request_size_bucket nginx_ingress_controller_request_size_count nginx_ingress_controller_request_size_sum nginx_ingress_controller_response_duration_seconds_bucket nginx_ingress_controller_response_duration_seconds_count nginx_ingress_controller_response_duration_seconds_sum nginx_ingress_controller_response_size_bucket nginx_ingress_controller_response_size_count nginx_ingress_controller_response_size_sum nginx_ingress_controller_ssl_expire_time_seconds nginx_ingress_controller_success process_cpu_seconds_total process_max_fds process_open_fds process_resident_memory_bytes process_start_time_seconds process_virtual_memory_bytes process_virtual_memory_max_bytes promhttp_metric_handler_requests_in_flight promhttp_metric_handler_requests_total [root@bt ~]# å‚è€ƒæ–‡æ¡£ï¼š\nhttps://help.aliyun.com/zh/arms/prometheus-monitoring/basic-metrics\nhttps://www.volcengine.com/docs/6731/802251\nâ€\nä¸Šé¢goå¼€å¤´çš„ä¸ç”¨ç®¡ï¼Œè¿™æ˜¯ç›‘æ§è½¯ä»¶è‡ªå¸¦ç›‘æ§æœ¬èº«æ•°æ®æŒ‡æ ‡çš„ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸‹æ–¹çš„çš„æŒ‡æ ‡æ•°æ®\næ­¤å¤„æ ¹æ®è‡ªå·±çš„æ•´ç†ï¼Œä»¥åŠå‚è€ƒChatGPTè¿›è¡Œæ±‡æ€»ï¼Œä»…ä¾›å‚è€ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 è¿™äº›æŒ‡æ ‡é€šè¿‡ Prometheus æš´éœ²ï¼Œå¹¶å¯ä»¥ç”¨äºç›‘æ§å’Œå‘Šè­¦ï¼š nginx_ingress_controller_bytes_sent_bucket: è¯·æ±‚å‘é€å­—èŠ‚å¤§å°çš„åˆ†å¸ƒæƒ…å†µï¼ˆé€šå¸¸ä¸ºç›´æ–¹å›¾çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºè®¡ç®—è¯·æ±‚å­—èŠ‚é‡çš„åˆ†ä½æ•°ï¼‰ã€‚ nginx_ingress_controller_bytes_sent_count: å‘é€çš„æ€»è¯·æ±‚æ•°é‡ï¼Œæ¯ä¸ªè¯·æ±‚å‘é€çš„å­—èŠ‚ç´¯åŠ çš„æ€»å’Œã€‚ nginx_ingress_controller_bytes_sent_sum: å‘é€çš„æ€»å­—èŠ‚é‡ï¼Œç´¯è®¡æ‰€æœ‰è¯·æ±‚å‘é€çš„å­—èŠ‚ã€‚ nginx_ingress_controller_config_hash: å½“å‰Nginxé…ç½®çš„å“ˆå¸Œå€¼ï¼Œå¯ç”¨æ¥æ£€æµ‹é…ç½®æ˜¯å¦æœ‰å˜åŒ–ã€‚ nginx_ingress_controller_config_last_reload_successful: æ ‡è¯†æœ€åä¸€æ¬¡é‡æ–°åŠ è½½Nginxé…ç½®æ˜¯å¦æˆåŠŸï¼ˆ1è¡¨ç¤ºæˆåŠŸï¼Œ0è¡¨ç¤ºå¤±è´¥ï¼‰ã€‚ nginx_ingress_controller_config_last_reload_successful_timestamp_seconds: æœ€åä¸€æ¬¡æˆåŠŸé‡æ–°åŠ è½½Nginxé…ç½®çš„æ—¶é—´æˆ³ã€‚ nginx_ingress_controller_ingress_upstream_latency_seconds: è®°å½•ä»ingressåˆ°ä¸Šæ¸¸æœåŠ¡çš„å»¶è¿Ÿã€‚ nginx_ingress_controller_ingress_upstream_latency_seconds_count: ä¸Šæ¸¸æœåŠ¡å»¶è¿Ÿè®¡æ•°ã€‚ nginx_ingress_controller_ingress_upstream_latency_seconds_sum: ä¸Šæ¸¸æœåŠ¡å»¶è¿Ÿæ€»å’Œã€‚ nginx_ingress_controller_leader_election_status: æ ‡è¯†å½“å‰å®ä¾‹æ˜¯å¦æ˜¯é¢†å¯¼è€…ï¼ˆleader electionç”¨äºå†³å®šå“ªä¸ªIngress controllerå®ä¾‹æ˜¯ä¸»æ§ï¼‰ã€‚ nginx_ingress_controller_nginx_process_connections: Nginxè¿›ç¨‹å½“å‰çš„æ´»è·ƒè¿æ¥æ•°ã€‚ nginx_ingress_controller_nginx_process_connections_total: Nginxè¿›ç¨‹å¤„ç†çš„æ€»è¿æ¥æ•°ã€‚ nginx_ingress_controller_nginx_process_cpu_seconds_total: Nginxè¿›ç¨‹æ¶ˆè€—çš„CPUæ—¶é—´æ€»é‡ã€‚ nginx_ingress_controller_nginx_process_num_procs: Nginxè¿›ç¨‹æ•°ã€‚ nginx_ingress_controller_nginx_process_oldest_start_time_seconds: æœ€è€çš„Nginxè¿›ç¨‹å¯åŠ¨æ—¶é—´ã€‚ nginx_ingress_controller_nginx_process_read_bytes_total: Nginxè¿›ç¨‹è¯»æ“ä½œçš„æ€»å­—èŠ‚æ•°ã€‚ nginx_ingress_controller_nginx_process_requests_total: Nginxè¿›ç¨‹å¤„ç†çš„æ€»è¯·æ±‚æ•°é‡ã€‚ nginx_ingress_controller_nginx_process_resident_memory_bytes: Nginxè¿›ç¨‹çš„å¸¸é©»å†…å­˜å¤§å°ã€‚ nginx_ingress_controller_nginx_process_virtual_memory_bytes: Nginxè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å¤§å°ã€‚ nginx_ingress_controller_nginx_process_write_bytes_total: Nginxè¿›ç¨‹å†™æ“ä½œçš„æ€»å­—èŠ‚æ•°ã€‚ nginx_ingress_controller_request_duration_seconds_bucket: å¤„ç†è¯·æ±‚çš„æŒç»­æ—¶é—´çš„åˆ†å¸ƒæƒ…å†µã€‚ nginx_ingress_controller_request_duration_seconds_count: è¯·æ±‚æŒç»­æ—¶é—´çš„è®¡æ•°ã€‚ nginx_ingress_controller_request_duration_seconds_sum: è¯·æ±‚æŒç»­æ—¶é—´çš„æ€»å’Œã€‚ nginx_ingress_controller_requests: å¤„ç†çš„æ€»è¯·æ±‚é‡ã€‚ nginx_ingress_controller_request_size_bucket: è¯·æ±‚å¤§å°çš„åˆ†å¸ƒæƒ…å†µã€‚ nginx_ingress_controller_request_size_count: è¯·æ±‚å¤§å°çš„è®¡æ•°ã€‚ nginx_ingress_controller_request_size_sum: è¯·æ±‚å¤§å°çš„æ€»å’Œã€‚ nginx_ingress_controller_response_duration_seconds_bucket: å“åº”æ—¶é—´çš„åˆ†å¸ƒæƒ…å†µã€‚ nginx_ingress_controller_response_duration_seconds_count: å“åº”æ—¶é—´çš„è®¡æ•°ã€‚ nginx_ingress_controller_response_duration_seconds_sum: å“åº”æ—¶é—´çš„æ€»å’Œã€‚ nginx_ingress_controller_response_size_bucket: å“åº”å¤§å°çš„åˆ†å¸ƒæƒ…å†µã€‚ nginx_ingress_controller_response_size_count: å“åº”å¤§å°çš„è®¡æ•°ã€‚ nginx_ingress_controller_response_size_sum: å“åº”å¤§å°çš„æ€»å’Œã€‚ nginx_ingress_controller_ssl_expire_time_seconds: SSLè¯ä¹¦åˆ°æœŸæ—¶é—´ã€‚ nginx_ingress_controller_success: æˆåŠŸå¤„ç†çš„è¯·æ±‚è®¡æ•°ã€‚ process_cpu_seconds_total: è¿›ç¨‹æ¶ˆè€—çš„CPUæ—¶é—´æ€»é‡ã€‚ process_max_fds: è¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡ã€‚ process_open_fds: è¿›ç¨‹å½“å‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ã€‚ process_resident_memory_bytes: è¿›ç¨‹çš„å¸¸é©»å†…å­˜å¤§å°ã€‚ process_start_time_seconds: è¿›ç¨‹å¯åŠ¨çš„å¼€å§‹æ—¶é—´ã€‚ process_virtual_memory_bytes: è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å¤§å°ã€‚ process_virtual_memory_max_bytes: è¿›ç¨‹å¯ä»¥ä½¿ç”¨çš„æœ€å¤§è™šæ‹Ÿå†…å­˜å¤§å°ã€‚ promhttp_metric_handler_requests_in_flight: å½“å‰æ­£åœ¨å¤„ç†çš„promhttpæŒ‡æ ‡å¤„ç†å™¨çš„è¯·æ±‚æ•°é‡ã€‚ promhttp_metric_handler_requests_total: promhttpæŒ‡æ ‡å¤„ç†å™¨å¤„ç†çš„æ€»è¯·æ±‚æ•°é‡ã€‚ â€\n","date":"2024-01-19T10:19:00Z","image":"https://www.ownit.top/title_pic/49.jpg","permalink":"https://www.ownit.top/p/202401191019/","title":"Kube-Prometheus ç›‘æ§Ingresså®æˆ˜"},{"content":"Kube-Prometheus æ‰‹åŠ¨éƒ¨ç½² ä½¿ç”¨ Prometheus Operator ç›‘æ§ Kubernetes é›†ç¾¤ï¼ˆPrometheus Operator å·²æ”¹åä¸º Kube-Prometheusï¼‰\næ³¨æ„ï¼š\nPrometheus-operator å·²ç»æ”¹åä¸º Kube-promethues\nä»‹ç»å’ŒåŠŸèƒ½ prometheus-operator ä»‹ç»\nå½“ä»Š Cloud Native æ¦‚å¿µæµè¡Œï¼Œå¯¹äºå®¹å™¨ã€æœåŠ¡ã€èŠ‚ç‚¹ä»¥åŠé›†ç¾¤çš„ç›‘æ§å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚Prometheus ä½œä¸º Kubernetes ç›‘æ§çš„äº‹å®æ ‡å‡†ï¼Œæœ‰ç€å¼ºå¤§çš„åŠŸèƒ½å’Œè‰¯å¥½çš„ç”Ÿæ€ã€‚ä½†æ˜¯å®ƒä¸æ”¯æŒåˆ†å¸ƒå¼ï¼Œä¸æ”¯æŒæ•°æ®å¯¼å…¥ã€å¯¼å‡ºï¼Œä¸æ”¯æŒé€šè¿‡ API ä¿®æ”¹ç›‘æ§ç›®æ ‡å’ŒæŠ¥è­¦è§„åˆ™ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨å®ƒæ—¶ï¼Œé€šå¸¸éœ€è¦å†™è„šæœ¬å’Œä»£ç æ¥ç®€åŒ–æ“ä½œã€‚\nPrometheus Operator ä¸ºç›‘æ§ Kubernetes serviceã€deploymentã€daemonsets å’Œ Prometheus å®ä¾‹çš„ç®¡ç†æä¾›äº†ç®€å•çš„å®šä¹‰ç­‰ï¼Œç®€åŒ–åœ¨ Kubernetes ä¸Šéƒ¨ç½²ã€ç®¡ç†å’Œè¿è¡Œ Prometheus å’Œ Alertmanager é›†ç¾¤ã€‚\nprometheus-operator åŠŸèƒ½\nâ€‹åˆ›å»º/é”€æ¯â€‹ï¼šåœ¨ Kubernetes namespace ä¸­æ›´åŠ å®¹æ˜“åœ°å¯åŠ¨ä¸€ä¸ª Prometheues å®ä¾‹ï¼Œä¸€ä¸ªç‰¹å®šåº”ç”¨ç¨‹åºæˆ–è€…å›¢é˜Ÿå¯ä»¥æ›´å®¹æ˜“ä½¿ç”¨ Prometheus Operatorã€‚ â€‹ä¾¿æ·é…ç½®â€‹ï¼šé€šè¿‡ Kubernetes èµ„æºé…ç½® Prometheus çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚ç‰ˆæœ¬ã€å­˜å‚¨ã€å‰¯æœ¬é›†ç­‰ã€‚ â€‹é€šè¿‡æ ‡ç­¾æ ‡è®°ç›®æ ‡æœåŠ¡â€‹ï¼š åŸºäºå¸¸è§çš„ Kubernetes label æŸ¥è¯¢è‡ªåŠ¨ç”Ÿæˆç›‘æ§ç›®æ ‡é…ç½®ï¼›ä¸éœ€è¦å­¦ä¹  Prometheus ç‰¹å®šçš„é…ç½®è¯­è¨€ã€‚ Prometheus Operator çš„å·¥ä½œåŸç†\nâ€‹â€‹\nä¸Šé¢æ¶æ„å›¾ä¸­ï¼Œå„ç»„ä»¶ä»¥ä¸åŒçš„æ–¹å¼è¿è¡Œåœ¨ Kubernetes é›†ç¾¤ä¸­ï¼š\nOperatorï¼š æ ¹æ®è‡ªå®šä¹‰èµ„æºï¼ˆCustom Resource Definition / CRDsï¼‰æ¥éƒ¨ç½²å’Œç®¡ç† Prometheus Serverï¼ŒåŒæ—¶ç›‘æ§è¿™äº›è‡ªå®šä¹‰èµ„æºäº‹ä»¶çš„å˜åŒ–æ¥åšç›¸åº”çš„å¤„ç†ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ§åˆ¶ä¸­å¿ƒã€‚ Prometheusï¼šå£°æ˜ Prometheus deployment æœŸæœ›çš„çŠ¶æ€ï¼ŒOperator ç¡®ä¿è¿™ä¸ª deployment è¿è¡Œæ—¶ä¸€ç›´ä¸å®šä¹‰ä¿æŒä¸€è‡´ã€‚ Prometheus Serverï¼š Operator æ ¹æ®è‡ªå®šä¹‰èµ„æº Prometheus ç±»å‹ä¸­å®šä¹‰çš„å†…å®¹è€Œéƒ¨ç½²çš„ Prometheus Server é›†ç¾¤ï¼Œè¿™äº›è‡ªå®šä¹‰èµ„æºå¯ä»¥çœ‹ä½œæ˜¯ç”¨æ¥ç®¡ç† Prometheus Server é›†ç¾¤çš„ StatefulSets èµ„æºã€‚ ServiceMonitorï¼šå£°æ˜æŒ‡å®šç›‘æ§çš„æœåŠ¡ï¼Œæè¿°äº†ä¸€ç»„è¢« Prometheus ç›‘æ§çš„ç›®æ ‡åˆ—è¡¨ã€‚è¯¥èµ„æºé€šè¿‡ Labels æ¥é€‰å–å¯¹åº”çš„ Service Endpointï¼Œè®© Prometheus Server é€šè¿‡é€‰å–çš„ Service æ¥è·å– Metrics ä¿¡æ¯ã€‚ Serviceï¼šç®€å•çš„è¯´å°±æ˜¯ Prometheus ç›‘æ§çš„å¯¹è±¡ã€‚ Alertmanagerï¼šå®šä¹‰ AlertManager deployment æœŸæœ›çš„çŠ¶æ€ï¼ŒOperator ç¡®ä¿è¿™ä¸ª deployment è¿è¡Œæ—¶ä¸€ç›´ä¸å®šä¹‰ä¿æŒä¸€è‡´ã€‚ è‡ªå®šä¹‰èµ„æº\nPrometheus Operator ä¸ºæˆ‘ä»¬æä¾›äº†å“ªäº›è‡ªå®šä¹‰çš„ Kubernetes èµ„æºï¼Œåˆ—å‡ºäº† Prometheus Operator ç›®å‰æä¾›çš„ ï¸4 ç±»èµ„æºï¼š\nPrometheusï¼šå£°æ˜å¼åˆ›å»ºå’Œç®¡ç† Prometheus Server å®ä¾‹ï¼› ServiceMonitorï¼šè´Ÿè´£å£°æ˜å¼çš„ç®¡ç†ç›‘æ§é…ç½®ï¼› PrometheusRuleï¼šè´Ÿè´£å£°æ˜å¼çš„ç®¡ç†å‘Šè­¦é…ç½®ï¼› Alertmanagerï¼šå£°æ˜å¼çš„åˆ›å»ºå’Œç®¡ç† Alertmanager å®ä¾‹ã€‚ â€\nPrometheus Operator å®˜æ–¹æä¾›æ ¹æ® Prometheus Operator CRD è‡ªåŠ¨ç®¡ç† Prometheus Server çš„å·¥ä½œæœºåˆ¶åŸç†å›¾å¦‚ä¸‹ï¼š\nâ€‹â€‹\nServiceMonitor å¯ä»¥é€šè¿‡ labelSelector çš„æ–¹å¼å»åŒ¹é…ä¸€ç±» Serviceï¼ŒPrometheus ä¹Ÿå¯ä»¥é€šè¿‡ labelSelector å»åŒ¹é…å¤šä¸ª ServiceMonitorã€‚Prometheus Operator è‡ªåŠ¨æ£€æµ‹ Kubernetes API æœåŠ¡å™¨å¯¹ä¸Šè¿°ä»»ä½•å¯¹è±¡çš„æ›´æ”¹ï¼Œå¹¶ç¡®ä¿åŒ¹é…çš„éƒ¨ç½²å’Œé…ç½®ä¿æŒåŒæ­¥ã€‚\nä¸ºäº†èƒ½è®© prom ç›‘æ§ k8s å†…çš„åº”ç”¨ï¼ŒPrometheus-Operator é€šè¿‡é…ç½® servicemonitor åŒ¹é…åˆ°ç”± service å¯¹è±¡è‡ªåŠ¨å¡«å……çš„ Endpointsï¼Œå¹¶é…ç½® prometheus ç›‘æ§è¿™äº› Endpoints åç«¯çš„ podsï¼ŒServiceMonitor.Spec çš„ Endpoints éƒ¨åˆ†å°±æ˜¯ç”¨äºé…ç½® Endpoints çš„å“ªäº›ç«¯å£å°†è¢« scrape æŒ‡æ ‡ã€‚ servicemonitor å¯¹è±¡å¾ˆå·§å¦™ï¼Œå®ƒè§£è€¦äº†â€œç›‘æ§çš„éœ€æ±‚â€å’Œâ€œéœ€æ±‚çš„å®ç°æ–¹â€ã€‚servicemonitor åªéœ€è¦ç”¨åˆ° label-selector è¿™ç§ç®€å•åˆé€šç”¨çš„æ–¹å¼å£°æ˜ä¸€ä¸ª â€œç›‘æ§éœ€æ±‚â€ï¼Œä¹Ÿå°±æ˜¯å“ªäº› Endpoints éœ€è¦æœé›†ï¼Œæ€ä¹ˆæ”¶é›†å°±è¡Œäº†ã€‚è®©ç”¨æˆ·åªå…³å¿ƒéœ€æ±‚ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„å…³æ³¨ç‚¹åˆ†ç¦»ã€‚å½“ç„¶ servicemonitor æœ€åè¿˜æ˜¯ä¼šè¢« operator è½¬åŒ–ä¸ºåŸå§‹çš„å¤ æ‚çš„ scrape config,ä½†è¿™ä¸ªå¤æ‚åº¦å·²ç»å®Œå…¨è¢« operator å±è”½äº†ã€‚ â€\nprometheus åœ¨é…ç½®æŠ¥è­¦æ—¶éœ€è¦æ“ä½œå“ªäº›èµ„æºï¼ŒåŠå„èµ„æºèµ·åˆ°çš„ä½œç”¨\nâ€‹â€‹\né¦–å…ˆé€šè¿‡é…ç½® servicemonitor/podmonitor æ¥è·å–åº”ç”¨çš„ç›‘æ§æŒ‡æ ‡ï¼›Prometheus.spec.alerting å­—æ®µä¼šåŒ¹é… Alertmanager ä¸­çš„é…ç½®ï¼ŒåŒ¹é…åˆ° alertmanager å®ä¾‹ ç„¶åé€šè¿‡ prometheusrule å¯¹ç›‘æ§åˆ°çš„æŒ‡æ ‡é…ç½®æŠ¥è­¦è§„åˆ™ï¼› æœ€åé…ç½®å‘Šè­¦æ¥æ”¶å™¨ï¼Œé…ç½® alertmanagerconfig æ¥é…ç½®å¦‚ä½•å¤„ç†å‘Šè­¦ï¼ŒåŒ…æ‹¬å¦‚ä½•æ¥æ”¶ã€è·¯ç”±ã€æŠ‘åˆ¶å’Œå‘é€è­¦æŠ¥ç­‰ï¼› â€\nç‰ˆæœ¬åŒºåˆ«\nä¸ºäº†ä½¿ç”¨ Prometheus-Operatorï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ kube-prometheus è¿™ä¸ªé¡¹ç›®æ¥è¿›è¡Œå®‰è£…ï¼Œè¯¥é¡¹ç›®å’Œ Prometheus-Operator çš„åŒºåˆ«å°±ç±»ä¼¼äº Linux å†…æ ¸å’Œ CentOS/Ubuntu è¿™äº›å‘è¡Œç‰ˆçš„å…³ç³»ï¼ŒçœŸæ­£èµ·ä½œç”¨çš„æ˜¯ Operator å»å®ç°çš„ï¼Œè€Œ kube-prometheus åªæ˜¯åˆ©ç”¨ Operator ç¼–å†™äº†ä¸€ç³»åˆ—å¸¸ç”¨çš„ç›‘æ§èµ„æºæ¸…å•ã€‚ä¸è¿‡éœ€è¦æ³¨æ„ Kubernetes ç‰ˆæœ¬å’Œ kube-prometheusâ€‹ çš„å…¼å®¹ï¼š\nâ€‹â€‹\nâ€‹â€‹\nâ€\nPrometheus Operator å’Œ kube-prometheus çš„åŒºåˆ« Prometheus Operator å’Œ kube-prometheus éƒ½æ˜¯ç”¨äºç®€åŒ– Prometheus åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²å’Œç®¡ç†çš„å·¥å…·ï¼Œä½†å®ƒä»¬çš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹å¼æœ‰æ‰€ä¸åŒã€‚\nPrometheus Operator: Prometheus Operator æ˜¯ CoreOS å¼€å‘çš„ä¸€ä¸ª Kubernetes Operatorï¼Œå®ƒçš„ç›®æ ‡æ˜¯ç®€åŒ– Prometheus åœ¨ Kubernetes é›†ç¾¤ä¸­çš„éƒ¨ç½²å’Œç®¡ç†è¿‡ç¨‹ã€‚Prometheus Operator é€šè¿‡å®šä¹‰ä¸€ç»„ CRD (Custom Resource Definitions)ï¼Œä½¿ç”¨æˆ·å¯ä»¥ä»¥å£°æ˜æ€§çš„æ–¹å¼æ¥éƒ¨ç½²å’Œé…ç½® Prometheusï¼ŒAlertmanagerï¼Œä»¥åŠç›¸å…³çš„ç›‘æ§ç»„ä»¶ã€‚è¿™äº› CRD åŒ…æ‹¬ Prometheusâ€‹ï¼ŒServiceMonitorâ€‹ï¼ŒPodMonitorâ€‹ï¼ŒAlertmanager â€‹ç­‰ã€‚ kube-prometheus: kube-prometheus æ˜¯ä¸€ä¸ªé¢„é…ç½®çš„ Prometheusã€Alertmanagerã€Grafana ä»¥åŠä¸€ç³»åˆ—çš„ Prometheus Exporters çš„é›†åˆï¼Œç”¨äºç›‘æ§ Kubernetes é›†ç¾¤ã€‚å®ƒä½¿ç”¨ Prometheus Operator ç®¡ç† Prometheus å’Œ Alertmanager å®ä¾‹ï¼Œå¹¶æä¾›äº†ä¸€ç³»åˆ—é¢„å®šä¹‰çš„ Grafana ä»ªè¡¨æ¿å’Œ Prometheus è§„åˆ™ã€‚æ¢å¥è¯è¯´ï¼Œkube-prometheus æ˜¯åœ¨ Prometheus Operator çš„åŸºç¡€ä¸Šï¼Œæä¾›äº†ä¸€å¥—å®Œæ•´çš„ã€å¼€ç®±å³ç”¨çš„ Kubernetes é›†ç¾¤ç›‘æ§è§£å†³æ–¹æ¡ˆã€‚ æ€»çš„æ¥è¯´ï¼ŒPrometheus Operator æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œè®©ä½ å¯ä»¥åœ¨ Kubernetes ä¸­æ›´å®¹æ˜“åœ°ç®¡ç†å’Œè¿è¡Œ Prometheusã€‚è€Œ kube-prometheus åˆ™æ˜¯ä½¿ç”¨è¿™ç§æœºåˆ¶ï¼Œæä¾›äº†ä¸€å¥—å®Œæ•´çš„ Kubernetes é›†ç¾¤ç›‘æ§æ–¹æ¡ˆã€‚\nâ€\nå‡†å¤‡æ­¥éª¤ æ‹‰å– Prometheus Operator ç¯å¢ƒï¼škubeadm éƒ¨ç½² v1.23.1\nä½¿ç”¨çš„ç‰ˆæœ¬ï¼šhttps://github.com/prometheus-operator/kube-prometheus/tree/release-0.10\nâ€\nå…ˆä» Github ä¸Šå°†æºç æ‹‰å–ä¸‹æ¥ï¼Œåˆ©ç”¨æºç é¡¹ç›®å·²ç»å†™å¥½çš„ kubernetes çš„ yaml æ–‡ä»¶è¿›è¡Œä¸€ç³»åˆ—é›†æˆé•œåƒçš„å®‰è£…ï¼Œå¦‚ grafanaã€prometheus ç­‰ç­‰ã€‚\nä» GitHub æ‹‰å– Prometheus Operator æºç \n1 2 $ git clone https://github.com/prometheus-operator/kube-prometheus.git -b release-0.10 $ cd kube-prometheus/manifests/ è¿›è¡Œæ–‡ä»¶åˆ†ç±» ç”±äºå®ƒçš„æ–‡ä»¶éƒ½å­˜æ”¾åœ¨é¡¹ç›®æºç çš„ manifests æ–‡ä»¶å¤¹ä¸‹ï¼Œæ‰€ä»¥éœ€è¦è¿›å…¥å…¶ä¸­è¿›è¡Œå¯åŠ¨è¿™äº› kubernetes åº”ç”¨ yaml æ–‡ä»¶ã€‚åˆç”±äºè¿™äº›æ–‡ä»¶å †æ”¾åœ¨ä¸€èµ·ï¼Œä¸åˆ©äºåˆ†ç±»å¯åŠ¨ï¼Œæ‰€ä»¥è¿™é‡Œå°†å®ƒä»¬åˆ†ç±»ã€‚\nè¿›å…¥æºç çš„ manifests æ–‡ä»¶å¤¹\n1 cd kube-prometheus/manifests/ â€‹â€‹\nåˆ›å»ºæ–‡ä»¶å¤¹å¹¶ä¸”å°† yaml æ–‡ä»¶åˆ†ç±»\nâ€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # åˆ›å»ºæ–‡ä»¶å¤¹ $ mkdir -p operator node-exporter alertmanager grafana kube-state-metrics prometheus serviceMonitor adapter blackbox # ç§»åŠ¨ yaml æ–‡ä»¶ï¼Œè¿›è¡Œåˆ†ç±»åˆ°å„ä¸ªæ–‡ä»¶å¤¹ä¸‹ mv *-serviceMonitor* serviceMonitor/ mv prometheusOperator-* operator mv grafana-* grafana/ mv kubeStateMetrics-* kube-state-metrics mv alertmanager-* alertmanager/ mv nodeExporter-* node-exporter/ mv prometheusAdapter-* adapter mv prometheus-* prometheus/ mv blackboxExporter-* blackbox/ mv kubePrometheus-prometheusRule.yaml kubernetesControlPlane-prometheusRule.yaml prometheus/ â€‹â€‹\nä¿®æ”¹é•œåƒæº å›½å¤–é•œåƒæºæŸäº›é•œåƒæ— æ³•æ‹‰å–ï¼Œæˆ‘ä»¬è¿™é‡Œä¿®æ”¹ prometheus-operatorï¼Œprometheusï¼Œalertmanagerï¼Œkube-state-metricsï¼Œnode-exporterï¼Œprometheus-adapter çš„é•œåƒæºä¸ºå›½å†…é•œåƒæºã€‚æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ä¸­ç§‘å¤§çš„é•œåƒæºã€‚\n1 2 3 4 5 6 7 # æŸ¥æ‰¾ grep -rn \u0026#39;quay.io\u0026#39; * # æ‰¹é‡æ›¿æ¢ sed -i \u0026#39;s/quay.io/quay.mirrors.ustc.edu.cn/g\u0026#39; `grep \u0026#34;quay.io\u0026#34; -rl *` # å†æŸ¥æ‰¾ grep -rn \u0026#39;quay.io\u0026#39; * grep -rn \u0026#39;image: \u0026#39; * ä¿®æ”¹ Service ç«¯å£è®¾ç½® ä¸ºäº†å¯ä»¥ä»å¤–éƒ¨è®¿é—® prometheusâ€‹ï¼Œalertmanagerâ€‹ï¼Œgrafanaâ€‹ï¼Œæˆ‘ä»¬è¿™é‡Œä¿®æ”¹ promethesâ€‹ï¼Œalertmanagerâ€‹ï¼Œgrafana â€‹çš„ serviceâ€‹ ç±»å‹ä¸º NodePortâ€‹ ç±»å‹ã€‚\nä¿®æ”¹ prometheus-service.yaml æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 vim prometheus/prometheus-service.yaml ä¿®æ”¹prometheus Serviceç«¯å£ç±»å‹ä¸ºNodePortï¼Œè®¾ç½®nodePortç«¯å£ä¸º32101 apiVersion: v1 kind: Service metadata: labels: prometheus: k8s name: prometheus-k8s namespace: monitoring spec: type: NodePort ports: - name: web port: 9090 targetPort: web nodePort: 32101 selector: app: prometheus prometheus: k8s sessionAffinity: ClientIP ä¿®æ”¹ grafana-service.yaml æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 vim grafana/grafana-service.yaml ä¿®æ”¹garafana Serviceç«¯å£ç±»å‹ä¸ºNodePortï¼Œè®¾ç½®nodePortç«¯å£ä¸º32102 apiVersion: v1 kind: Service metadata: labels: app: grafana name: grafana namespace: monitoring spec: type: NodePort ports: - name: http port: 3000 targetPort: http nodePort: 32102 selector: app: grafana ä¿®æ”¹æ•°æ®æŒä¹…åŒ–å­˜å‚¨ prometheus å®é™…ä¸Šæ˜¯é€šè¿‡ emptyDir è¿›è¡ŒæŒ‚è½½çš„ï¼Œæˆ‘ä»¬çŸ¥é“ emptyDir æŒ‚è½½çš„æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸå’Œ Pod ç”Ÿå‘½å‘¨æœŸä¸€è‡´çš„ï¼Œå¦‚æœ Pod æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆæ•°æ®ä¹Ÿå°±ä¸¢å¤±äº†ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬é‡å»º Pod åä¹‹å‰çš„æ•°æ®å°±æ²¡æœ‰äº†çš„åŸå› ï¼Œæ‰€ä»¥è¿™é‡Œä¿®æ”¹å®ƒçš„æŒä¹…åŒ–é…ç½®ã€‚\nGlusterFS å­˜å‚¨çš„ StorageClass é…ç½®\n1 2 3 4 5 6 7 8 9 10 apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: fast #---SorageClass åç§° provisioner: kubernetes.io/glusterfs #---æ ‡è¯† provisioner ä¸º GlusterFS parameters: resturl: \u0026#34;http://10.10.249.63:8080\u0026#34; restuser: \u0026#34;admin\u0026#34; gidMin: \u0026#34;40000\u0026#34; gidMax: \u0026#34;50000\u0026#34; volumetype: \u0026#34;none\u0026#34; #---åˆ†å¸ƒå·»æ¨¡å¼ï¼Œä¸æä¾›å¤‡ä»½ï¼Œæ­£å¼ç¯å¢ƒåˆ‡å‹¿ç”¨æ­¤æ¨¡å¼ NFS å­˜å‚¨çš„ StorageClass é…ç½®\n1 2 3 4 5 6 7 apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: fast provisioner: nfs-client #---åŠ¨æ€å·åˆ†é…åº”ç”¨è®¾ç½®çš„åç§°ï¼Œå¿…é¡»å’Œé›†ç¾¤ä¸­çš„\u0026#34;nfs-provisioner\u0026#34;åº”ç”¨è®¾ç½®çš„å˜é‡åç§°ä¿æŒä¸€è‡´ parameters: archiveOnDelete: \u0026#34;true\u0026#34; #---è®¾ç½®ä¸º\u0026#34;false\u0026#34;æ—¶åˆ é™¤PVCä¸ä¼šä¿ç•™æ•°æ®,\u0026#34;true\u0026#34;åˆ™ä¿ç•™æ•°æ® ä¿®æ”¹ Prometheus æŒä¹…åŒ– ä¿®æ”¹ prometheus-prometheus.yaml æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 $ vim prometheus/prometheus-prometheus.yaml prometheusæ˜¯ä¸€ç§ StatefulSet æœ‰çŠ¶æ€é›†çš„éƒ¨ç½²æ¨¡å¼ï¼Œæ‰€ä»¥ç›´æ¥å°† StorageClass é…ç½®åˆ°é‡Œé¢ï¼Œåœ¨ä¸‹é¢çš„yamlä¸­æœ€ä¸‹é¢æ·»åŠ æŒä¹…åŒ–é…ç½®ï¼š apiVersion: monitoring.coreos.com/v1 kind: Prometheus metadata: labels: prometheus: k8s name: k8s namespace: monitoring spec: alerting: alertmanagers: - name: alertmanager-main namespace: monitoring port: web baseImage: quay.io/prometheus/prometheus nodeSelector: beta.kubernetes.io/os: linux replicas: 2 resources: requests: memory: 400Mi ruleSelector: matchLabels: prometheus: k8s role: alert-rules securityContext: fsGroup: 2000 runAsNonRoot: true runAsUser: 1000 serviceAccountName: prometheus-k8s serviceMonitorNamespaceSelector: {} serviceMonitorSelector: {} version: v2.7.2 storage: #----æ·»åŠ æŒä¹…åŒ–é…ç½®ï¼ŒæŒ‡å®šStorageClassä¸ºä¸Šé¢åˆ›å»ºçš„fast volumeClaimTemplate: spec: storageClassName: fass #---æŒ‡å®šä¸ºfast resources: requests: storage: 10Gi â€\nå› ä¸ºæˆ‘é›†ç¾¤æœ‰å¤šä¸ª pvc æ²¡æœ‰è¢«ä½¿ç”¨åˆ°ï¼Œæ¸…ç†ç©ºé—´\né›†ç¾¤æœ‰å¤šä¸ª pvcï¼Œæ€ä¹ˆæŸ¥è¯¢å‡ºæ²¡æœ‰è¢«ä½¿ç”¨çš„ï¼ˆé¢˜å¤–è¯ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 kubectl get pvc --all-namespaces -o json | jq -r \u0026#39;.items[] | \u0026#34;\\(.metadata.namespace) \\(.metadata.name)\u0026#34;\u0026#39; | while read -r line; do if ! kubectl get pods --all-namespaces -o json | jq -r \u0026#39;.items[] | select(any(.spec.volumes[]; .persistentVolumeClaim.claimName == \u0026#34;\u0026#39;$(echo $line | awk \u0026#39;{print $2}\u0026#39;)\u0026#39;\u0026#34;)) | \u0026#34;\\(.metadata.namespace) \\(.metadata.name)\u0026#34;\u0026#39; | grep -q \u0026#34;$(echo $line | awk \u0026#39;{print $1}\u0026#39;)\u0026#34;; then echo $line fi done #åˆ—å‡ºæ²¡æœ‰ä½¿ç”¨çš„ default storage-loki-0 jenkins maven-pvc kube-system grafana-data-grafana-0 kube-system prometheus-data-prometheus-0 kuboard prometheus-k8s-db-prometheus-k8s-0 åˆ é™¤ä½ åˆ—å‡ºçš„ PVCï¼š kubectl delete pvc storage-loki-0 -n default kubectl delete pvc maven-pvc -n jenkins kubectl delete pvc grafana-data-grafana-0 -n kube-system kubectl delete pvc prometheus-data-prometheus-0 -n kube-system kubectl delete pvc prometheus-k8s-db-prometheus-k8s-0 -n kuboard ä¿®æ”¹ Grafana æŒä¹…åŒ–é…ç½® åˆ›å»º grafana-pvc.yaml æ–‡ä»¶\nç”±äº Grafana æ˜¯éƒ¨ç½²æ¨¡å¼ä¸º Deploymentï¼Œæ‰€ä»¥æˆ‘ä»¬æå‰ä¸ºå…¶åˆ›å»ºä¸€ä¸ª grafana-pvc.yaml æ–‡ä»¶ï¼ŒåŠ å…¥ä¸‹é¢ PVC é…ç½®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 kind: PersistentVolumeClaim apiVersion: v1 metadata: name: grafana namespace: monitoring #---æŒ‡å®šnamespaceä¸ºmonitoring spec: storageClassName: fast #---æŒ‡å®šStorageClassä¸ºä¸Šé¢åˆ›å»ºçš„fast accessModes: - ReadWriteOnce resources: requests: storage: 5Gi ä¿®æ”¹ grafana-deployment.yaml æ–‡ä»¶è®¾ç½®æŒä¹…åŒ–é…ç½®ï¼Œåº”ç”¨ä¸Šé¢çš„ PVC\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 vim grafana/grafana-deployment.yaml å°† volumes é‡Œé¢çš„ â€œgrafana-storageâ€ é…ç½®æ³¨æ‰ï¼Œæ–°å¢å¦‚ä¸‹é…ç½®ï¼ŒæŒ‚è½½ä¸€ä¸ªåä¸º grafana çš„ PVC ...... volumes: - name: grafana-storage #-------æ–°å¢æŒä¹…åŒ–é…ç½® persistentVolumeClaim: claimName: grafana #-------è®¾ç½®ä¸ºåˆ›å»ºçš„PVCåç§° #- emptyDir: {} #-------æ³¨é‡Šæ‰æ—§çš„é…ç½® # name: grafana-storage - name: grafana-datasources secret: secretName: grafana-datasources - configMap: name: grafana-dashboards name: grafana-dashboards ...... â€\nâ€\nå®‰è£…æ­¥éª¤ å®‰è£… Setup 1 2 3 4 5 6 7 8 9 10 11 12 [root@bt manifests]# pwd /app/kube-prometheus/manifests [root@bt manifests]# kubectl apply --server-side -f setup customresourcedefinition.apiextensions.k8s.io/alertmanagerconfigs.monitoring.coreos.com serverside-applied customresourcedefinition.apiextensions.k8s.io/alertmanagers.monitoring.coreos.com serverside-applied customresourcedefinition.apiextensions.k8s.io/podmonitors.monitoring.coreos.com serverside-applied customresourcedefinition.apiextensions.k8s.io/probes.monitoring.coreos.com serverside-applied customresourcedefinition.apiextensions.k8s.io/prometheuses.monitoring.coreos.com serverside-applied customresourcedefinition.apiextensions.k8s.io/prometheusrules.monitoring.coreos.com serverside-applied customresourcedefinition.apiextensions.k8s.io/servicemonitors.monitoring.coreos.com serverside-applied customresourcedefinition.apiextensions.k8s.io/thanosrulers.monitoring.coreos.com serverside-applied namespace/monitoring serverside-applied 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ç­‰å¾… kubectl wait \\ --for condition=Established \\ --all CustomResourceDefinition \\ --namespace=monitoring [root@bt manifests]# kubectl get crd |grep coreos alertmanagerconfigs.monitoring.coreos.com 2024-01-17T07:04:28Z alertmanagers.monitoring.coreos.com 2024-01-17T07:04:28Z podmonitors.monitoring.coreos.com 2024-01-17T07:04:28Z probes.monitoring.coreos.com 2024-01-17T07:04:28Z prometheuses.monitoring.coreos.com 2024-01-17T07:04:29Z prometheusrules.monitoring.coreos.com 2024-01-17T07:04:29Z servicemonitors.monitoring.coreos.com 2024-01-17T07:04:29Z thanosrulers.monitoring.coreos.com 2024-01-17T07:04:29Z â€‹â€‹\nè¿™ä¼šåˆ›å»ºä¸€ä¸ªåä¸º monitoringâ€‹ çš„å‘½åç©ºé—´ï¼Œä»¥åŠç›¸å…³çš„ CRD èµ„æºå¯¹è±¡å£°æ˜ã€‚å‰é¢ç« èŠ‚ä¸­æˆ‘ä»¬è®²è§£è¿‡ CRD å’Œ Operator çš„ä½¿ç”¨ï¼Œå½“æˆ‘ä»¬å£°æ˜å®Œ CRD è¿‡åï¼Œå°±å¯ä»¥æ¥è‡ªå®šä¹‰èµ„æºæ¸…å•äº†ï¼Œä½†æ˜¯è¦è®©æˆ‘ä»¬å£°æ˜çš„è‡ªå®šä¹‰èµ„æºå¯¹è±¡ç”Ÿæ•ˆå°±éœ€è¦å®‰è£…å¯¹åº”çš„ Operator æ§åˆ¶å™¨ï¼Œåœ¨ manifestsâ€‹ ç›®å½•ä¸‹é¢å°±åŒ…å«äº† Operator çš„èµ„æºæ¸…å•ä»¥åŠå„ç§ç›‘æ§å¯¹è±¡å£°æ˜ï¼Œæ¯”å¦‚ Prometheusã€Alertmanager ç­‰ï¼Œç›´æ¥åº”ç”¨å³å¯ï¼š\nå®‰è£… Operator 1 kubectl apply -f operator/ æŸ¥çœ‹ Podï¼Œç­‰ pod åˆ›å»ºèµ·æ¥åœ¨è¿›è¡Œä¸‹ä¸€æ­¥\n1 2 3 4 $ kubectl get pods -n monitoring NAME READY STATUS RESTARTS prometheus-operator-5d6f6f5d68-mb88p 1/1 Running 0 â€‹â€‹\nå®‰è£…å…¶å®ƒç»„ä»¶ 1 2 3 4 5 6 7 8 kubectl apply -f adapter/ kubectl apply -f alertmanager/ kubectl apply -f node-exporter/ kubectl apply -f kube-state-metrics/ kubectl apply -f grafana/ kubectl apply -f prometheus/ kubectl apply -f serviceMonitor/ kubectl apply -f blackbox/ â€‹â€‹\nä¸Šå›¾æœåŠ¡å·²ç»å…¨éƒ¨å¯åŠ¨ï¼Œä½†æ˜¯æœ‰ node-exporter ä¸ºä»€ä¹ˆå¯åŠ¨å¤±è´¥ï¼Ÿ å› ä¸ºæœ¬åœ°çš„å®¿ä¸»æœºå·²ç»å¯åŠ¨ç›¸åº”çš„ç¨‹åºï¼Œå ç”¨ 9100 çš„ç«¯å£\nåç»­è§£å†³åŠæ³•ï¼š1ã€ä¿®æ”¹ k8s ä¸­çš„ node-exporter çš„ç«¯å£\nâ€‹â€‹\nâ€\nâ€\né—®é¢˜è§£å†³ â€‹â€‹\nä¸Šé¢çš„å›¾ä¸­æœ‰å‡ ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼Ÿ\n1ã€kube-controller-manager/0 (0/0 up)\n2ã€kube-scheduler/0 (0/0 up)\n3ã€node-exporter å¤±è´¥\n4ã€æ²¡æœ‰ç›‘æ§ etcd æ•°æ®åº“\nå¿…é¡»æå‰è®¾ç½®ä¸€äº› Kubernetes ä¸­çš„é…ç½®ï¼Œå¦åˆ™ kube-scheduler å’Œ kube-controller-manager æ— æ³•ç›‘æ§åˆ°æ•°æ®ã€‚\nâ€\nç”±äº Kubernetes é›†ç¾¤æ˜¯ç”± kubeadm æ­å»ºçš„ï¼Œå…¶ä¸­ kube-scheduler å’Œ kube-controller-manager é»˜è®¤ç»‘å®š IP æ˜¯ 127.0.0.1 åœ°å€ã€‚Prometheus Operator æ˜¯é€šè¿‡èŠ‚ç‚¹ IP å»è®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬å°† kube-scheduler ç»‘å®šçš„åœ°å€æ›´æ”¹æˆ 0.0.0.0ã€‚\nä¿®æ”¹ kube-scheduler å’Œ kube-controller-manager ç¼–è¾‘ /etc/kubernetes/manifests/kube-scheduler.yaml æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 vim /etc/kubernetes/manifests/kube-scheduler.yaml å°† command çš„ bind-address åœ°å€æ›´æ”¹æˆ 0.0.0.0 ...... spec: containers: - command: - kube-scheduler - --bind-address=0.0.0.0 #æ”¹ä¸º0.0.0.0 - --kubeconfig=/etc/kubernetes/scheduler.conf - --leader-elect=true ...... ç¼–è¾‘ /etc/kubernetes/manifests/kube-controller-manager.yaml æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 vim /etc/kubernetes/manifests/kube-controller-manager.yaml å°† command çš„ bind-address åœ°å€æ›´æ”¹æˆ 0.0.0.0 spec: containers: - command: - kube-controller-manager - --allocate-node-cidrs=true - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf - --bind-address=0.0.0.0 #æ”¹ä¸º0.0.0.0 ...... åˆ›å»º kube-scheduler \u0026amp; controller-manager å¯¹åº” Service å› ä¸º Prometheus Operator é…ç½®ç›‘æ§å¯¹è±¡ serviceMonitor æ˜¯æ ¹æ® label é€‰å– Service æ¥è¿›è¡Œç›‘æ§å…³è”çš„ï¼Œè€Œé€šè¿‡ Kuberadm å®‰è£…çš„ Kubernetes é›†ç¾¤åªåˆ›å»ºäº† kube-scheduler \u0026amp; controller-manager çš„ Pod å¹¶æ²¡æœ‰åˆ›å»º Serviceï¼Œæ‰€ä»¥ Prometheus Operator æ— æ³•è¿™ä¸¤ä¸ªç»„ä»¶ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬æ”¶åˆ°åˆ›å»ºä¸€ä¸‹è¿™ä¿©ä¸ªç»„ä»¶çš„ Service\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 apiVersion: v1 kind: Service metadata: namespace: kube-system name: kube-controller-manager labels: k8s-app: kube-controller-manager spec: selector: component: kube-controller-manager type: ClusterIP clusterIP: None ports: - name: http-metrics port: 10252 targetPort: 10252 protocol: TCP --- apiVersion: v1 kind: Service metadata: namespace: kube-system name: kube-scheduler labels: k8s-app: kube-scheduler spec: selector: component: kube-scheduler type: ClusterIP clusterIP: None ports: - name: http-metrics port: 10251 targetPort: 10251 protocol: TCP â€‹â€‹\nå¦‚æœæ˜¯äºŒè¿›åˆ¶éƒ¨ç½²è¿˜å¾—åˆ›å»ºå¯¹åº”çš„ Endpoints å¯¹è±¡å°†ä¸¤ä¸ªç»„ä»¶æŒ‚å…¥åˆ° kubernetes é›†ç¾¤å†…ï¼Œç„¶åé€šè¿‡ Service æä¾›è®¿é—®ï¼Œæ‰èƒ½è®© Prometheus ç›‘æ§åˆ°ã€‚\nä¸Šé¢å¦‚æœä¸èµ·æ•ˆï¼Œè¯·çœ‹ä¸‹é¢çš„æ­¥éª¤\nâ€\nâ€\nâ€\næ³¨æ„\nå°ç»“ä¸€ä¸‹, é€šè¿‡ä¹‹å‰çš„è¿™äº›é…ç½®, Kubernetes ç»„ä»¶çš„ Metrics ç›‘å¬ç«¯å£åˆ†åˆ«ä¸º:\nController Manager: (Kubernetes v1.23+)\nç«¯å£: 10257 åè®®: https Scheduler: (Kubernetes v1.23+)\nç«¯å£: 10259 åè®®: https Kube Proxy\nç«¯å£: 10249 åè®®: http etcd\nç«¯å£: 2381 åè®®: http å¯ä»¥é€šè¿‡ netstatâ€‹ å‘½ä»¤æŸ¥çœ‹ä¹‹å‰çš„é…ç½®æ˜¯å¦å…¨éƒ¨ç”Ÿæ•ˆ:\n1 2 3 4 5 6 7 8 9 10 11 12 13 tcp 0 0 127.0.0.1:10249 0.0.0.0:* LISTEN 3454/kube-proxy tcp 0 0 192.168.102.30:2381 0.0.0.0:* LISTEN 6742/etcd tcp 0 0 127.0.0.1:2381 0.0.0.0:* LISTEN 2577/etcd tcp6 0 0 :::10257 :::* LISTEN 18313/kube-controll tcp6 0 0 :::10259 :::* LISTEN 18245/kube-schedule # æµ‹è¯•etcdæŒ‡æ ‡ curl -k http://localhost:2381/metrics # æµ‹è¯• kube-proxy æŒ‡æ ‡ curl -k http://localhost:10249/metrics â€\næŸ¥çœ‹ serviceMonitor çš„é…ç½®\nserviceMonitor/kubernetesControlPlane-serviceMonitorKubeScheduler.yaml\nserviceMonitor/kubernetesControlPlane-serviceMonitorKubeControllerManager.yaml\nçœ‹çœ‹ ä»–ä»¬çš„åŒ¹é…è§„åˆ™\nï¼ˆæ˜¯ä¸‹æ–¹ä¸¤ä¸ªï¼‰\napp.kubernetes.io/name: kube-controller-manager\napp.kubernetes.io/name: kube-scheduler\nåœ¨é«˜ç‰ˆæœ¬ï¼Œä¸šåŠ¡ç«¯å£å°±æ˜¯ Prometheus çš„ç«¯å£ï¼Œä½¿ç”¨ https åè®®\n1 2 3 4 5 6 7 8 9 10 11 12 [root@master01 manifests]# curl -k https://192.168.102.30:10257/metrics { \u0026#34;kind\u0026#34;: \u0026#34;Status\u0026#34;, \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;metadata\u0026#34;: {}, \u0026#34;status\u0026#34;: \u0026#34;Failure\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;forbidden: User \\\u0026#34;system:anonymous\\\u0026#34; cannot get path \\\u0026#34;/metrics\\\u0026#34;\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;Forbidden\u0026#34;, \u0026#34;details\u0026#34;: {}, \u0026#34;code\u0026#34;: 403 } ä¸Šé¢çš„é”™è¯¯å°±æ˜¯æ²¡æœ‰æƒé™éªŒè¯ï¼Œæ— æ³•æ”¶é›† â€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 cat svc_error.yaml apiVersion: v1 kind: Service metadata: namespace: kube-system name: kube-controller-manager labels: k8s-app: kube-controller-manager app.kubernetes.io/name: kube-controller-manager spec: selector: component: kube-controller-manager type: ClusterIP # clusterIP: None ports: - name: https-metrics port: 10257 targetPort: 10257 protocol: TCP --- apiVersion: v1 kind: Service metadata: namespace: kube-system name: kube-scheduler labels: k8s-app: kube-scheduler app.kubernetes.io/name: kube-scheduler spec: selector: component: kube-scheduler type: ClusterIP # clusterIP: None ports: - name: https-metrics port: 10259 targetPort: 10259 protocol: TCP kubectl apply -f svc_error.yaml â€‹â€‹\nâ€\nnodeExporter ç«¯å£è¢«å ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 [root@bt node-exporter]# grep -nr \u0026#34;9100\u0026#34; nodeExporter-daemonset.yaml:29: - --web.listen-address=127.0.0.1:9100 nodeExporter-daemonset.yaml:57: - --secure-listen-address=[$(IP)]:9100 nodeExporter-daemonset.yaml:59: - --upstream=http://127.0.0.1:9100/ nodeExporter-daemonset.yaml:68: - containerPort: 9100 nodeExporter-daemonset.yaml:69: hostPort: 9100 nodeExporter-service.yaml:15: port: 9100 æŠŠè¿™ä¸ªä¿®æ”¹æˆ9101 å³å¯ vim node-exporter/nodeExporter-daemonset.yaml æˆ–è€… cd node-exporter/ sed -i \u0026#39;s/9100/9101/g\u0026#39; nodeExporter-daemonset.yaml nodeExporter-service.yaml kubectl apply -f nodeExporter-daemonset.yaml kubectl apply -f nodeExporter-service.yaml é‡å¯ Prometheusï¼ˆçƒ­åŠ è½½ï¼‰\n1 2 3 4 5 6 7 8 IP=`kubectl get svc -n monitoring -owide | grep prometheus-k8s | awk \u0026#39;{print $3}\u0026#39;` curl -X POST \u0026#34;http://$IP:9090/-/reload\u0026#34; if [ $? -ne 0 ]; then echo \u0026#34;failed\u0026#34; else echo \u0026#34;succeed\u0026#34; fi â€\nâ€‹â€‹\nâ€\nç›‘æ§ ETCD etcd é»˜è®¤ä¼šåœ¨ 2379 ç«¯å£ä¸Šæš´éœ² metricsï¼Œä¾‹å¦‚ï¼š curl -k http://localhost:2381/metrics\nå…ˆç”¨ curl å‘½ä»¤æ£€æµ‹ä¸€ä¸‹ï¼Œæ˜¯å¦æ­£å¸¸ã€‚\n1 curl -k http://localhost:2381/metrics ä¿®æ”¹ ETCD yaml æ–‡ä»¶\n1 2 3 4 vim /etc/kubernetes/manifests/etcd.yaml ... --listen-metrics-urls=http://0.0.0.0:2381\t# é»˜è®¤æ˜¯127.0.0.1,æ”¹æˆä»»æ„èŠ‚ç‚¹è®¿é—® ... é…ç½® ServiceMonitorï¼ŒService\nService\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 cat etcd_svc.yaml apiVersion: v1 kind: Service metadata: labels: k8s-app: etcd-k8s name: etcd-k8s namespace: kube-system spec: ports: - name: http-etcd port: 2381 targetPort: 2381 selector: component: etcd ServiceMonitor\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 cat etcd-ServiceMonitor.yaml apiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: name: etcd-k8s namespace: monitoring labels: k8s-app: etcd-k8s spec: jobLabel: k8s-app selector: matchLabels: k8s-app: etcd-k8s namespaceSelector: matchNames: - kube-system endpoints: - port: http-etcd interval: 15s â€‹â€‹\nâ€\nGrafan ç”»å›¾ï¼ˆ3070â€‹ï¼‰\nâ€‹â€‹\nâ€\né…ç½®å‘Šè­¦\nå¯¹äºéƒ¨åˆ†æ ¸å¿ƒæŒ‡æ ‡ï¼Œå»ºè®®é…ç½®åˆ°å‘Šè­¦è§„åˆ™é‡Œï¼Œè¿™æ ·å‡ºé—®é¢˜æ—¶èƒ½åŠæ—¶å‘ç°ã€‚\nEtcd å®˜æ–¹ä¹Ÿæä¾›äº†ä¸€ä¸ªå‘Šè­¦è§„åˆ™,ç‚¹å‡»æŸ¥çœ‹â€“\u0026gt; etcd3_alert.rules.ymlï¼Œå†…å®¹æ¯”è¾ƒå¤šå°±ä¸è´´åœ¨è¿™é‡Œæ¥äº†ã€‚\nä»¥ä¸‹æ˜¯åŸºäºè¯¥æ–‡ä»¶å»é™¤è¿‡æ—¶æŒ‡æ ‡åçš„ç‰ˆæœ¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 # these rules synced manually from https://github.com/etcd-io/etcd/blob/master/Documentation/etcd-mixin/mixin.libsonnet groups: - name: etcd rules: - alert: etcdInsufficientMembers annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: insufficient members ({{ $value }}).\u0026#39; expr: | sum(up{job=~\u0026#34;.*etcd.*\u0026#34;} == bool 1) by (job) \u0026lt; ((count(up{job=~\u0026#34;.*etcd.*\u0026#34;}) by (job) + 1) / 2) for: 3m labels: severity: critical - alert: etcdNoLeader annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: member {{ $labels.instance }} has no leader.\u0026#39; expr: | etcd_server_has_leader{job=~\u0026#34;.*etcd.*\u0026#34;} == 0 for: 1m labels: severity: critical - alert: etcdHighNumberOfLeaderChanges annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: instance {{ $labels.instance }} has seen {{ $value }} leader changes within the last hour.\u0026#39; expr: | rate(etcd_server_leader_changes_seen_total{job=~\u0026#34;.*etcd.*\u0026#34;}[15m]) \u0026gt; 3 for: 15m labels: severity: warning - alert: etcdHighNumberOfFailedGRPCRequests annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: {{ $value }}% of requests for {{ $labels.grpc_method }} failed on etcd instance {{ $labels.instance }}.\u0026#39; expr: | 100 * sum(rate(grpc_server_handled_total{job=~\u0026#34;.*etcd.*\u0026#34;, grpc_code!=\u0026#34;OK\u0026#34;}[5m])) BY (job, instance, grpc_service, grpc_method) / sum(rate(grpc_server_handled_total{job=~\u0026#34;.*etcd.*\u0026#34;}[5m])) BY (job, instance, grpc_service, grpc_method) \u0026gt; 1 for: 10m labels: severity: warning - alert: etcdHighNumberOfFailedGRPCRequests annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: {{ $value }}% of requests for {{ $labels.grpc_method }} failed on etcd instance {{ $labels.instance }}.\u0026#39; expr: | 100 * sum(rate(grpc_server_handled_total{job=~\u0026#34;.*etcd.*\u0026#34;, grpc_code!=\u0026#34;OK\u0026#34;}[5m])) BY (job, instance, grpc_service, grpc_method) / sum(rate(grpc_server_handled_total{job=~\u0026#34;.*etcd.*\u0026#34;}[5m])) BY (job, instance, grpc_service, grpc_method) \u0026gt; 5 for: 5m labels: severity: critical - alert: etcdHighNumberOfFailedProposals annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: {{ $value }} proposal failures within the last hour on etcd instance {{ $labels.instance }}.\u0026#39; expr: | rate(etcd_server_proposals_failed_total{job=~\u0026#34;.*etcd.*\u0026#34;}[15m]) \u0026gt; 5 for: 15m labels: severity: warning - alert: etcdHighFsyncDurations annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: 99th percentile fync durations are {{ $value }}s on etcd instance {{ $labels.instance }}.\u0026#39; expr: | histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket{job=~\u0026#34;.*etcd.*\u0026#34;}[5m])) \u0026gt; 0.5 for: 10m labels: severity: warning - alert: etcdHighCommitDurations annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: 99th percentile commit durations {{ $value }}s on etcd instance {{ $labels.instance }}.\u0026#39; expr: | histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket{job=~\u0026#34;.*etcd.*\u0026#34;}[5m])) \u0026gt; 0.25 for: 10m labels: severity: warning - alert: etcdHighNodeRTTDurations annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: node RTT durations {{ $value }}s on etcd instance {{ $labels.instance }}.\u0026#39; expr: | histogram_quantile(0.99,rate(etcd_network_peer_round_trip_time_seconds_bucket[5m])) \u0026gt; 0.5 for: 10m labels: severity: warning å®é™…ä¸Šåªéœ€è¦å¯¹å‰é¢æåˆ°çš„å‡ ä¸ªæ ¸å¿ƒæŒ‡æ ‡é…ç½®ä¸Šå‘Šè­¦è§„åˆ™å³å¯ï¼š\nâ€‹sum(up{job=~\u0026quot;.\\*etcd.\\*\u0026quot;} == bool 1) by (job) \u0026lt; ((count(up{job=~\u0026quot;.\\*etcd.\\*\u0026quot;}) by (job) + 1) / 2) â€‹ ï¼š å½“å‰å­˜æ´»çš„ etcd èŠ‚ç‚¹æ•°æ˜¯å¦å°äº (n+1)/2\né›†ç¾¤ä¸­å­˜æ´»å°äº (n+1)/2 é‚£ä¹ˆæ•´ä¸ªé›†ç¾¤éƒ½ä¼šä¸å¯ç”¨\nâ€‹etcd_server_has_leader{job=~\u0026quot;.\\*etcd.\\*\u0026quot;} == 0â€‹ ï¼šetcd æ˜¯å¦å­˜åœ¨ leader\nä¸º 0 åˆ™è¡¨ç¤ºä¸å­˜åœ¨ leaderï¼ŒåŒæ ·æ•´ä¸ªé›†ç¾¤ä¸å¯ç”¨ â€‹rate(etcd_server_leader_changes_seen_total{job=~\u0026quot;.\\*etcd.\\*\u0026quot;}[15m]) \u0026gt; 3â€‹ : 15 åˆ†é’Ÿ å†…é›†ç¾¤ leader åˆ‡æ¢æ¬¡æ•°æ˜¯å¦è¶…è¿‡ 3 æ¬¡\né¢‘ç¹ Leader åˆ‡æ¢ä¼šå½±å“é›†ç¾¤ç¨³å®šæ€§ â€‹histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket{job=~\u0026quot;.\\*etcd.\\*\u0026quot;}[5m])) \u0026gt; 0.5â€‹ ï¼š5 åˆ†é’Ÿå†… WAL fsync è°ƒç”¨å»¶è¿Ÿ p99 å¤§äº 500ms\nâ€‹histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket{job=~\u0026quot;.\\*etcd.\\*\u0026quot;}[5m])) \u0026gt; 0.25â€‹ ï¼š5 åˆ†é’Ÿå†… DB fsync è°ƒç”¨å»¶è¿Ÿ p99 å¤§äº 500ms\nâ€‹histogram_quantile(0.99,rate(etcd_network_peer_round_trip_time_seconds_bucket[5m])) \u0026gt; 0.5â€‹ï¼š 5 åˆ†é’Ÿå†… èŠ‚ç‚¹ä¹‹é—´ RTT å¤§äº 500 ms\nåªåŒ…å«ä¸Šè¿°æŒ‡æ ‡å‘Šè­¦ç­–ç•¥çš„ç²¾ç®€ç‰ˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 # these rules synced manually from https://github.com/etcd-io/etcd/blob/master/Documentation/etcd-mixin/mixin.libsonnet groups: - name: etcd rules: - alert: etcdInsufficientMembers annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: insufficient members ({{ $value }}).\u0026#39; expr: | sum(up{job=~\u0026#34;.*etcd.*\u0026#34;} == bool 1) by (job) \u0026lt; ((count(up{job=~\u0026#34;.*etcd.*\u0026#34;}) by (job) + 1) / 2) for: 3m labels: severity: critical - alert: etcdNoLeader annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: member {{ $labels.instance }} has no leader.\u0026#39; expr: | etcd_server_has_leader{job=~\u0026#34;.*etcd.*\u0026#34;} == 0 for: 1m labels: severity: critical - alert: etcdHighFsyncDurations annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: 99th percentile fync durations are {{ $value }}s on etcd instance {{ $labels.instance }}.\u0026#39; expr: | histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket{job=~\u0026#34;.*etcd.*\u0026#34;}[5m])) \u0026gt; 0.5 for: 10m labels: severity: warning - alert: etcdHighCommitDurations annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: 99th percentile commit durations {{ $value }}s on etcd instance {{ $labels.instance }}.\u0026#39; expr: | histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket{job=~\u0026#34;.*etcd.*\u0026#34;}[5m])) \u0026gt; 0.25 for: 10m labels: severity: warning - alert: etcdHighNodeRTTDurations annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: node RTT durations {{ $value }}s on etcd instance {{ $labels.instance }}.\u0026#39; expr: | histogram_quantile(0.99,rate(etcd_network_peer_round_trip_time_seconds_bucket[5m])) \u0026gt; 0.5 for: 10m labels: severity: warning â€\nåˆ›å»º PrometheusRule\nä½¿ç”¨ PrometheusRule å¯¹è±¡æ¥å­˜å‚¨è¿™éƒ¨åˆ†è§„åˆ™ã€‚\næ¯”è¾ƒé‡è¦çš„æ˜¯ labelï¼Œåç»­ä¼šæ ¹æ® label æ¥å…³è”åˆ°æ­¤å‘Šè­¦è§„åˆ™ã€‚\nè¿™é‡Œçš„ label å’Œé»˜è®¤ç”Ÿæˆçš„å†…ç½® PrometheusRule å¯¹è±¡ label ä¸€è‡´ï¼Œè¿™æ ·å°±ä¸ä¼šå½±å“åˆ°å…¶ä»– ruleã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 cat \u0026gt; pr.yaml \u0026lt;\u0026lt; \u0026#34;EOF\u0026#34; apiVersion: monitoring.coreos.com/v1 kind: PrometheusRule metadata: labels: prometheus: k8s role: alert-rules name: etcd-rules namespace: monitoring spec: groups: - name: etcd rules: - alert: etcdInsufficientMembers annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: insufficient members ({{ $value }}).\u0026#39; expr: | sum(up{job=~\u0026#34;.*etcd.*\u0026#34;} == bool 1) by (job) \u0026lt; ((count(up{job=~\u0026#34;.*etcd.*\u0026#34;}) by (job) + 1) / 2) for: 3m labels: severity: critical - alert: etcdNoLeader annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: member {{ $labels.instance }} has no leader.\u0026#39; expr: | etcd_server_has_leader{job=~\u0026#34;.*etcd.*\u0026#34;} == 0 for: 1m labels: severity: critical - alert: etcdHighFsyncDurations annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: 99th percentile fsync durations are {{ $value }}s(normal is \u0026lt; 10ms) on etcd instance {{ $labels.instance }}.\u0026#39; expr: | histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket{job=~\u0026#34;.*etcd.*\u0026#34;}[5m])) \u0026gt; 0.5 for: 3m labels: severity: warning - alert: etcdHighCommitDurations annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: 99th percentile commit durations {{ $value }}s(normal is \u0026lt; 120ms) on etcd instance {{ $labels.instance }}.\u0026#39; expr: | histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket{job=~\u0026#34;.*etcd.*\u0026#34;}[5m])) \u0026gt; 0.25 for: 3m labels: severity: warning - alert: etcdHighNodeRTTDurations annotations: message: \u0026#39;etcd cluster \u0026#34;{{ $labels.job }}\u0026#34;: node RTT durations {{ $value }}s on etcd instance {{ $labels.instance }}.\u0026#39; expr: | histogram_quantile(0.99, rate(etcd_network_peer_round_trip_time_seconds_bucket[5m])) \u0026gt; 0.5 for: 3m labels: severity: warning EOF kubectl -n monitoring apply -f pr.yaml é…ç½®åˆ° Prometheus\nâ€‹kubectl -n monitoring get prometheusâ€‹\nå¯¹ä¸Šè¿°å¯¹è±¡è¿›è¡Œä¿®æ”¹ï¼Œæ·»åŠ  ruleSelector å­—æ®µæ¥é€šè¿‡ label ç­›é€‰å‰é¢çš„å‘Šè­¦è§„åˆ™ã€‚\n1 2 3 4 5 6 7 8 æŸ¥çœ‹é…ç½®æ–‡ä»¶ kubectl get prometheuses.monitoring.coreos.com -n monitoring k8s -oyaml ruleSelector: matchLabels: prometheus: k8s role: alert-rules â€‹â€‹\nâ€‹â€‹\nâ€\nå‚è€ƒæ–‡æ¡£ï¼š\nhttp://www.mydlq.club/article/10\nhttps://www.lixueduan.com/posts/etcd/17-monitor/\nâ€\n","date":"2024-01-18T09:12:41Z","image":"https://www.ownit.top/title_pic/13.jpg","permalink":"https://www.ownit.top/p/202401180912/","title":"Kube-Prometheus æ‰‹åŠ¨éƒ¨ç½²"},{"content":"1ã€Istioç®€ä»‹ Istio æ˜¯ä¸€ä¸ªå¼€æºæœåŠ¡ç½‘æ ¼ï¼Œå®ƒé€æ˜åœ°åˆ†å±‚åˆ°ç°æœ‰çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºä¸Šã€‚ Istio å¼ºå¤§çš„ç‰¹æ€§æä¾›äº†ä¸€ç§ç»Ÿä¸€å’Œæ›´æœ‰æ•ˆçš„æ–¹å¼æ¥ä¿æŠ¤ã€è¿æ¥å’Œç›‘è§†æœåŠ¡ã€‚ Istio æ˜¯å®ç°è´Ÿè½½å¹³è¡¡ã€æœåŠ¡åˆ°æœåŠ¡èº«ä»½éªŒè¯å’Œç›‘è§†çš„è·¯å¾„â€”â€”åªéœ€è¦å¾ˆå°‘æˆ–ä¸éœ€è¦æ›´æ”¹æœåŠ¡ä»£ç ã€‚å®ƒå¼ºå¤§çš„æ§åˆ¶å¹³é¢å¸¦æ¥äº†é‡è¦çš„ç‰¹ç‚¹ï¼ŒåŒ…æ‹¬ï¼š\nä½¿ç”¨ TLS åŠ å¯†ã€å¼ºèº«ä»½è®¤è¯å’Œæˆæƒçš„é›†ç¾¤å†…æœåŠ¡åˆ°æœåŠ¡çš„å®‰å…¨é€šä¿¡ è‡ªåŠ¨è´Ÿè½½å‡è¡¡çš„ HTTP, gRPC, WebSocketï¼Œå’Œ TCP æµé‡ é€šè¿‡ä¸°å¯Œçš„è·¯ç”±è§„åˆ™ã€é‡è¯•ã€æ•…éšœè½¬ç§»å’Œæ•…éšœæ³¨å…¥å¯¹æµé‡è¡Œä¸ºè¿›è¡Œç»†ç²’åº¦æ§åˆ¶ ä¸€ä¸ªå¯æ’å…¥çš„ç­–ç•¥å±‚å’Œé…ç½® APIï¼Œæ”¯æŒè®¿é—®æ§åˆ¶ã€é€Ÿç‡é™åˆ¶å’Œé…é¢ å¯¹é›†ç¾¤å†…çš„æ‰€æœ‰æµé‡(åŒ…æ‹¬é›†ç¾¤å…¥å£å’Œå‡ºå£)è¿›è¡Œè‡ªåŠ¨åº¦é‡ã€æ—¥å¿—å’Œè·Ÿè¸ª Istio ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯æ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢ã€‚\næ•°æ®å¹³é¢ï¼šæ•°æ®å¹³é¢æˆ–è€…æ•°æ®å±‚æ˜¯ç”±ä»£ç†æœåŠ¡çš„é›†åˆæ‰€ç»„æˆçš„ï¼Œå®ƒä»¬ä¼šä½¿ç”¨æ‰©å±•çš„ Envoy ä»£ç†æœåŠ¡å™¨ï¼Œè¡¨ç°å½¢å¼æ˜¯æ¯ä¸ª Kubernetes pod ä¸­çš„ sidecar å®¹å™¨ã€‚è¿™äº› sidecar ä¼šåè°ƒå’Œæ§åˆ¶æ‰€æœ‰å¾®æœåŠ¡ä¹‹é—´çš„ç½‘ç»œé€šä¿¡ï¼ŒåŒæ—¶è¿˜ä¼šæ”¶é›†å’ŒæŠ¥å‘Šæœ‰ç”¨çš„é¥æµ‹æ•°æ®ã€‚ æ§åˆ¶å¹³é¢ï¼šæ§åˆ¶å¹³é¢æˆ–è€…æ§åˆ¶å±‚ç”±ä¸€ä¸ªåä¸º istiod çš„äºŒè¿›åˆ¶æ–‡ä»¶ç»„æˆï¼Œè´Ÿè´£å°†é«˜å±‚çº§çš„è·¯ç”±è§„åˆ™å’Œæµé‡æ§åˆ¶è¡Œä¸ºè½¬æ¢æˆ Envoy çš„ç‰¹å®šé…ç½®ï¼Œç„¶ååœ¨è¿è¡Œæ—¶å°†å®ƒä»¬ä¼ æ’­åˆ° sidecar ä¸­ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ§åˆ¶å¹³é¢è¿˜æä¾›å®‰å…¨æªæ–½ï¼Œé€šè¿‡å†…ç½®çš„èº«ä»½æ ‡è¯†å’Œè¯ä¹¦ç®¡ç†ï¼Œå®ç°å¼ºå¤§çš„æœåŠ¡é—´å’Œç»ˆç«¯ç”¨æˆ·è®¤è¯ï¼ŒåŒæ—¶æ ¹æ®æœåŠ¡çš„èº«ä»½æ ‡è¯†æ‰§è¡Œå®‰å…¨ç­–ç•¥ã€‚ 2ã€Istio æ ¸å¿ƒåŠŸèƒ½ Istio æ˜¯ä¸€ä¸ªä¸ Kubernetes ç´§å¯†ç»“åˆçš„æœåŠ¡ç½‘æ ¼(Service Mesh)ï¼Œç”¨äºæœåŠ¡æ²»ç†ã€‚\næ³¨æ„ï¼ŒIstio æ˜¯ç”¨äºæœåŠ¡æ²»ç†çš„ï¼Œä¸»è¦æœ‰æµé‡ç®¡ç†ã€æœåŠ¡é—´å®‰å…¨ã€å¯è§‚æµ‹æ€§è¿™å‡ ç§åŠŸèƒ½ã€‚åœ¨å¾®æœåŠ¡ç³»ç»Ÿä¸­ï¼Œä¼šç¢°åˆ°å¾ˆå¤šæ£˜æ‰‹çš„é—®é¢˜ï¼ŒIstio åªèƒ½è§£å†³å…¶ä¸­ä¸€å°éƒ¨åˆ†ã€‚\næœåŠ¡æ²»ç†æœ‰ä¸‰ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯æ¯ä¸ªé¡¹ç›®ä¸­åŒ…å«å•ç‹¬çš„æ²»ç†é€»è¾‘ï¼Œè¿™æ ·æ¯”è¾ƒç®€å•ï¼›ç¬¬äºŒç§æ˜¯å°†é€»è¾‘å°è£…åˆ° SDK ä¸­ï¼Œæ¯ä¸ªé¡¹ç›®å¼•ç”¨ SDK å³å¯ï¼Œä¸å¢åŠ æˆ–åªéœ€è¦å°‘é‡é…ç½®æˆ–ä»£ç å³å¯ï¼›ç¬¬ä¸‰ç§æ˜¯ä¸‹æ²‰åˆ°åŸºç¡€è®¾æ–½å±‚ã€‚Istio ä¾¿æ˜¯ç¬¬ä¸‰ç§æ–¹å¼ã€‚ 3ã€Istio åŸç† Istio å¯ä»¥çš„ä½œç”¨åŸç†æ˜¯æ‹¦æˆª Kubernetes éƒ¨ç½² Pod çš„äº‹ä»¶ï¼Œç„¶åä» Pod ä¸­æ³¨å…¥ä¸€ä¸ªåä¸º Envoy çš„å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨ä¼šæ‹¦æˆªå¤–éƒ¨åˆ°ä¸šåŠ¡åº”ç”¨çš„æµé‡ã€‚ç”±äºæ‰€æœ‰æµé‡éƒ½è¢« Envoy â€œåŠ«æŒâ€ äº†ï¼Œæ‰€ä»¥ Istio å¯ä»¥å¯¹æµé‡è¿›è¡Œåˆ†æä¾‹å¦‚æ”¶é›†è¯·æ±‚ä¿¡æ¯ï¼Œä»¥åŠä¸€ç³»åˆ—çš„æµé‡ç®¡ç†æ“ä½œï¼Œä¹Ÿå¯ä»¥éªŒè¯æˆæƒä¿¡æ¯ã€‚å½“ Envoy æ‹¦æˆªæµé‡å¹¶æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œä¹‹åï¼Œå¦‚æœè¯·æ±‚æ²¡é—®é¢˜ï¼Œå°±ä¼šè½¬å‘æµé‡åˆ°ä¸šåŠ¡åº”ç”¨çš„ Pod ä¸­ã€‚ ã€å·¦ï¼šæ™®é€š Podï¼›Istioï¼›å³ï¼šIstio ä»£ç†äº†å‡ºå…¥å£æµé‡ã€‘\nå½“ç„¶ï¼Œç”±äº Envoy éœ€è¦æ‹¦æˆªæµé‡ä¹‹åè½¬å‘ç»™ä¸šåŠ¡åº”ç”¨ï¼Œè¿™æ ·å°±å¤šäº†ä¸€å±‚è½¬å‘ï¼Œä¼šå¯¼è‡´ç³»ç»Ÿå“åº”é€Ÿåº¦ä¼šæœ‰æ‰€ä¸‹é™ï¼Œä½†æ˜¯å¢åŠ çš„å“åº”æ—¶é—´å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚\næ¯ä¸ª Pod éƒ½æœ‰ä¸€ä¸ª Envoy è´Ÿè´£æ‹¦æˆªã€å¤„ç†å’Œè½¬å‘è¿›å‡º Pod çš„æ‰€æœ‰ç½‘ç»œæµé‡ï¼Œè¿™ç§æ–¹å¼è¢«ç§°ä¸º Sidecarã€‚\nä»¥ä¸‹æ˜¯ Istio Sidecar çš„ä¸€äº›ä¸»è¦åŠŸèƒ½ï¼š\næµé‡ç®¡ç†ï¼šEnvoy ä»£ç†å¯ä»¥æ ¹æ® Istio é…ç½®çš„è·¯ç”±è§„åˆ™ï¼ˆå¦‚ VirtualService å’Œ DestinationRuleï¼‰å®ç°æµé‡çš„è½¬å‘ã€åˆ†å‰²å’Œé•œåƒç­‰åŠŸèƒ½ã€‚ å®‰å…¨é€šä¿¡ï¼šEnvoy ä»£ç†è´Ÿè´£åœ¨æœåŠ¡ä¹‹é—´å»ºç«‹å®‰å…¨çš„åŒå‘ TLS è¿æ¥ï¼Œç¡®ä¿æœåŠ¡é—´é€šä¿¡çš„å®‰å…¨æ€§ã€‚ é¥æµ‹æ•°æ®æ”¶é›†ï¼šEnvoy ä»£ç†å¯ä»¥æ”¶é›†å…³äºç½‘ç»œæµé‡çš„è¯¦ç»†é¥æµ‹æ•°æ®ï¼ˆå¦‚å»¶è¿Ÿã€æˆåŠŸç‡ç­‰ï¼‰ï¼Œå¹¶å°†è¿™äº›æ•°æ®ä¸ŠæŠ¥ç»™ Istio çš„é¥æµ‹ç»„ä»¶ï¼Œä»¥ä¾¿è¿›è¡Œç›‘æ§å’Œåˆ†æã€‚ ç­–ç•¥æ‰§è¡Œï¼šEnvoy ä»£ç†å¯ä»¥æ ¹æ® Istio é…ç½®çš„ç­–ç•¥è§„åˆ™ï¼ˆå¦‚ RateLimit å’Œ AuthorizationPolicyï¼‰æ‰§è¡Œé™æµã€è®¿é—®æ§åˆ¶ç­‰ç­–ç•¥ã€‚ ç”±äº Pod æ˜¯é€šè¿‡ Envoy æš´éœ²ç«¯å£çš„ï¼Œæ‰€æœ‰è¿›å‡ºå£æµé‡éƒ½éœ€è¦ç»è¿‡ Envoy çš„æ£€æŸ¥ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“åˆ¤æ–­è®¿é—®æ¥æºï¼Œå¦‚æœè¯·æ±‚æ–¹ä¸æ˜¯åœ¨ Istio ä¸­çš„æœåŠ¡ï¼Œé‚£ä¹ˆ Envoy ä¾¿ä¼šæ‹’ç»è®¿é—®ã€‚ åœ¨ Istio ä¸­ï¼ŒEnvoy è¿™ä¸€å—ç§°ä¸ºæ•°æ®å¹³é¢ï¼Œè€Œè´Ÿè´£ç®¡ç†é›†ç¾¤çš„ istiod ç»„ä»¶ç§°ä¸ºæ§åˆ¶å¹³é¢ã€‚\næ³¨æ„ï¼Œè¿™é‡Œæ˜¯ istiod ï¼Œæ˜¯ Istio è´Ÿè´£ç®¡ç†é›†ç¾¤çš„ä¸€ç§ç»„ä»¶ã€‚\n4ã€Istio å®‰è£… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 istioctl(å¯ä»¥é€šè¿‡curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.20.1 sh å®‰è£…) [root@bt ~]# istioctl profile list Istio configuration profiles: ambient default demo empty external minimal openshift preview remote æˆ–è€… å®‰è£…profile=demoçš„ istio istioctl manifest apply --set profile=demo \\ --set cni.enabled=true --set cni.components.cni.namespace=kube-system \\ --set values.gateways.istio-ingressgateway.type=ClusterIP è®¾ç½®è‡ªåŠ¨ istio æ³¨å…¥ï¼Œå¯ä»¥é€šè¿‡ namespace å»åš\n1 2 3 4 5 #ç»™ns1çš„å‘½åç©ºé—´æ·»åŠ istioæ ‡ç­¾ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ ‡ç­¾é‡Œï¼Œæ‰€æœ‰åˆ›å»ºçš„ pod éƒ½ä¼šè¢«è‡ªåŠ¨æ³¨å…¥ istio kubectl label ns ns1 istio-injection=enabled # æŸ¥çœ‹labels kubectl get ns --show-labels ä½¿ç”¨ istio å•ç‹¬çš„æ³¨å…¥ä¸€ä¸ªpod\n1 2 3 4 5 6 7 8 9 10 11 12 # åˆ›å»º istioctl kube-inject -f pod1.yaml | kubectl apply -f - # æŸ¥çœ‹podæ•°é‡ kubectl get pods #æ­¤æ—¶READYæ•°ä¸º2 #è¿™ä¸ªpodæ–°å¢çš„dockerï¼Œå°±æ˜¯ pilotï¼Œenvoy ## åœ¨åˆ›å»ºä¸€ä¸ª pod æµ‹è¯• sed \u0026#39;s/pod1/pod2/\u0026#39; pod1.yaml | kubectl apply -f - kubectl get pods # å‘ç°è¿™ä¸ª pod2 æ˜¯æ²¡æœ‰è¢«æ³¨å…¥çš„ å®‰è£…kiali ï¼šå›¾å½¢åŒ–å·¥å…·ï¼Œå¯ä»¥ç›´è§‚çš„æŸ¥çœ‹æµé‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 kubectl get pods -n istio-system # å®‰è£… kubectl apply -f istio-1.10.3/samples/addons/kiali.yaml # æˆ–è€…å¯ä»¥é€‰æ‹©ç›´æ¥å…¨éƒ¨éƒ½å®‰è£…ä¸Š kubectl apply -f istio-1.10.3/samples/addons/ kubectl get svc -n istio-system # kiali çš„PORTï¼š20001ï¼ŒTYPEä¸º ClusterIP # ä¿®æ”¹ kiali çš„ svc kubectl edit svc kiali -n istio-system sessionAffinity: None type: LoadBalancer #æŠŠClusterIPä¿®æ”¹ä¸ºNodePortæˆ–è€…LoadBalancer # æŸ¥çœ‹å¹¶éªŒè¯ kubectl get svc -n istio-system # æŸ¥çœ‹ kiali çš„ ip å’Œç«¯å£ï¼Œä½¿ç”¨æµè§ˆå™¨è®¿é—® # è¿›å…¥æµè§ˆå™¨åå¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼Œè¿›å…¥ Graph é¡µé¢ï¼Œé€‰æ‹© istio-system å’Œ ns1 çš„ Namespaceï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç°åœ¨ç¯å¢ƒä¸­çš„æ‹“æ‰‘å›¾ Kiali çš„ Graph æ•°æ®ä¸»è¦æ¥è‡ªä¸¤ä¸ªæ¥æºï¼šPrometheus å’Œ Istio æœ¬èº«çš„é¥æµ‹æ•°æ®ã€‚\nPrometheusï¼šPrometheus æ˜¯ä¸€ä¸ªå¼€æºç›‘æ§å’Œè­¦æŠ¥å·¥å…·ï¼Œå®ƒç”¨äºæ”¶é›†å’Œå­˜å‚¨ Istio æœåŠ¡ç½‘æ ¼ä¸­çš„æŒ‡æ ‡æ•°æ®ã€‚Istio ä½¿ç”¨ Envoy ä»£ç†æ”¶é›†é¥æµ‹æ•°æ®ï¼Œè¿™äº›æ•°æ®éšåè¢« Prometheus æŠ“å–å’Œå­˜å‚¨ã€‚Kiali ä½¿ç”¨è¿™äº› Prometheus æ•°æ®æ¥ç”ŸæˆæœåŠ¡ä¹‹é—´çš„æµé‡ã€é”™è¯¯ç‡ã€å»¶è¿Ÿç­‰æŒ‡æ ‡ã€‚\nIstio é¥æµ‹æ•°æ®ï¼šIstio æœåŠ¡ç½‘æ ¼ç”Ÿæˆçš„é¥æµ‹æ•°æ®åŒ…æ‹¬è¯·æ±‚ã€å“åº”ã€å»¶è¿Ÿä»¥åŠ Envoy ä»£ç†çš„å…¶ä»–æ€§èƒ½æŒ‡æ ‡ã€‚è¿™äº›æ•°æ®ç”± Istio ç»„ä»¶ï¼ˆä¾‹å¦‚ Mixer å’Œ Pilotï¼‰ä»¥åŠ Envoy ä»£ç†æœ¬èº«ç”Ÿæˆã€‚Kiali ä»è¿™äº›é¥æµ‹æ•°æ®ä¸­è·å–æœåŠ¡æ‹“æ‰‘ä¿¡æ¯ï¼Œä»¥åˆ›å»ºæœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»å›¾ã€‚\nKiali å°†è¿™ä¸¤ä¸ªæ•°æ®æºçš„ä¿¡æ¯æ•´åˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆ Graphï¼Œå®ƒå±•ç¤ºäº†æœåŠ¡ç½‘æ ¼çš„æ‹“æ‰‘ç»“æ„ã€æœåŠ¡ä¹‹é—´çš„æµé‡ä»¥åŠå…¶ä»–æ€§èƒ½æŒ‡æ ‡ã€‚è¿™æœ‰åŠ©äºç”¨æˆ·æ›´å¥½åœ°ç†è§£æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå‘ç°æ½œåœ¨çš„æ€§èƒ½é—®é¢˜ï¼Œå¹¶ä¼˜åŒ–æœåŠ¡ç½‘æ ¼é…ç½®ã€‚\nå¯èƒ½å¤±è´¥çš„åŸå›  å¦‚æœä½ çš„ Kiali ä¸€ç›´æ˜¾ç¤º Empty Graphã€‚è¯·å…³æ³¨ä»¥ä¸‹å‡ ç§å¯èƒ½çš„æƒ…å†µï¼š\né›†ç¾¤ç‰ˆæœ¬ä½äº 1.23 ï¼Œéœ€è¦å‡çº§ Kubernetes é›†ç¾¤ã€‚ å®‰è£…äº† Kubesphereï¼Œè¯´å¤šäº†éƒ½æ˜¯æ³ªï¼ŒKubesphere å¤ªé‡äº†ï¼Œç¬”è€…èŠ±äº†ä¸€æ™šä¸Šæ—¶é—´é‡æ–°å®‰è£…é›†ç¾¤ã€‚ è®¿é—®çš„åœ°å€ä¸æ­£ç¡®ï¼Œæ²¡æœ‰é…ç½®å¯¹ /productpage çš„è®¿é—®åœ°å€ï¼Œè¯·æ±‚æµé‡æ²¡æœ‰æ‰“å…¥é›†ç¾¤ã€‚ Pod æ²¡æœ‰è¢«æ³¨å…¥ istio-proxyã€‚ ä½ å¯ä»¥åœ¨ Kiali çš„ Workloads æŸ¥çœ‹æ¯ä¸ªè´Ÿè½½çš„ Pod ä¿¡æ¯ï¼Œæ­£å¸¸æƒ…å†µåº”å½“å¦‚ä¸‹æ‰€ç¤ºï¼š ä¿®å¤ Kiali Grafana é—®é¢˜ ç‚¹å‡»å³ä¸Šè§’çš„æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šæç¤ºé…ç½®ä¸æ­£ç¡®ï¼Œå› ä¸º kiali éœ€è¦ä» Grafana æ‹‰å–æ•°æ®ã€‚ ç¼–è¾‘ configmap ã€‚\n1 2 3 4 5 6 7 8 kubectl edit configmap kiali -n istio-system grafana: \\n enabled: true \\n url: \\\u0026#34;http://grafana.istio-system.svc.cluster.local:3000\\\u0026#34; \\ \\n in_cluster_url: \\\u0026#34;http://grafana.istio-system.svc.cluster.local:3000\\\u0026#34;\\n å¦‚æœä¸Šæ–¹ä¸è¡Œï¼Œå°±æ·»åŠ ä¸‹æ–¹ grafana: \\n enabled: true \\n url: \\\u0026#34;http://grafana.istio-system.svc.cluster.local:3000\\\u0026#34; å¦‚æœä½¿ç”¨çš„æ˜¯å¯è§†åŒ–å·¥å…·ï¼Œæ·»åŠ å°±ç®€å•äº†ã€‚\n1 2 3 4 grafana: enabled: true url: \u0026#34;http://grafana.istio-system.svc.cluster.local:3000\u0026#34; in_cluster_url: \u0026#34;http://grafana.istio-system\u0026gt;.svc.cluster.local:3000\u0026#34; ç„¶åä½¿ç”¨ kubectl describe configmap kiali -n istio-system æŸ¥çœ‹é…ç½®æ˜¯å¦æ­£ç¡®ã€‚\n5ã€Istioæ ¸å¿ƒèµ„æº å’ŒKubernetesèµ„æºä¸€è‡´ï¼ŒIstioçš„é…ç½®ä¹Ÿæ˜¯é€šè¿‡å£°æ˜å¼è‡ªå®šä¹‰èµ„æºé…ç½®æ¥åŠ è½½çš„ã€‚å¸¸ç”¨çš„æ ¸å¿ƒèµ„æºæœ‰VirtualServiceã€DestinationRuleã€Gatewayã€ServiceEntryã€Sidecarç­‰ã€‚\nGateway ç±»ä¼¼ Nginx éœ€è¦åˆ›å»ºä¸€ä¸ªåå‘ä»£ç†æ—¶éœ€è¦ç»‘å®šçš„åŸŸåé…ç½®ã€‚\nIstio VistualService ä¸­å¯ä»¥é™åˆ¶å¤–éƒ¨èƒ½å¤Ÿè®¿é—®çš„è·¯ç”±åœ°å€ï¼Œ\nDestinationRule åˆ™å¯ä»¥é…ç½®è®¿é—®çš„ Pod ç­–ç•¥ã€‚\nå¯ä»¥ä¸º Istio VistualService ç»‘å®šä¸€ä¸ª Istio DestinationRule\né€šè¿‡ DestinationRule æˆ‘ä»¬è¿˜å¯ä»¥å®šä¹‰ç‰ˆæœ¬å­é›†ç­‰ï¼Œé€šè¿‡æ›´åŠ ä¸°å¯Œçš„ç­–ç•¥è½¬å‘æµé‡ã€‚ istio-ingressgatewayï¼ˆé‚®å±€çš„å…¥å£ï¼‰ï¼š å½“ä¸€ä¸ªè¯·æ±‚ï¼ˆé‚®ä»¶ï¼‰åˆ°è¾¾ä½ çš„åº”ç”¨æ—¶ï¼Œå®ƒé¦–å…ˆä¼šåˆ°è¾¾istio-ingressgatewayã€‚è¿™å°±åƒä¸€ä¸ªé‚®å±€çš„å…¥å£ï¼Œæ‰€æœ‰çš„é‚®ä»¶éƒ½å¿…é¡»å…ˆç»è¿‡è¿™é‡Œã€‚ Gatewayï¼ˆé‚®å±€çš„æ¥æ”¶å‘˜ï¼‰ï¼š Gatewayå°±åƒæ˜¯é‚®å±€çš„æ¥æ”¶å‘˜ï¼Œå®ƒçš„å·¥ä½œæ˜¯æ£€æŸ¥æ¯ä¸ªè¿›æ¥çš„è¯·æ±‚ï¼ˆé‚®ä»¶ï¼‰ï¼Œçœ‹çœ‹å®ƒåº”è¯¥è¢«å‘é€åˆ°å“ªé‡Œã€‚åœ¨ä½ çš„ä¾‹å­ä¸­ï¼ŒGatewayä¼šæŠŠæ‰€æœ‰çš„è¯·æ±‚éƒ½å‘é€åˆ°bookinfoæœåŠ¡ã€‚ VirtualServiceï¼ˆé‚®å±€çš„åˆ†æ‹£å‘˜ï¼‰ï¼š å½“è¯·æ±‚ï¼ˆé‚®ä»¶ï¼‰åˆ°è¾¾bookinfoæœåŠ¡æ—¶ï¼ŒVirtualServiceå°±åƒæ˜¯ä¸€ä¸ªåˆ†æ‹£å‘˜ï¼Œå®ƒä¼šæ ¹æ®è¯·æ±‚çš„è·¯å¾„æˆ–è€…å…¶ä»–å±æ€§ï¼Œå†³å®šè¯·æ±‚åº”è¯¥è¢«å‘é€åˆ°å“ªä¸ªæœåŠ¡ã€‚åœ¨ä½ çš„ä¾‹å­ä¸­ï¼Œproductpageçš„VirtualServiceå¯èƒ½ä¼šæŠŠè¯·æ±‚å‘é€åˆ°productpageæœåŠ¡ã€‚ DestinationRuleï¼ˆé‚®å±€çš„åŒ…è£…å‘˜ï¼‰ï¼š å½“è¯·æ±‚ï¼ˆé‚®ä»¶ï¼‰è¢«å‘é€åˆ°ä¸€ä¸ªç‰¹å®šçš„æœåŠ¡æ—¶ï¼ŒDestinationRuleå°±åƒæ˜¯ä¸€ä¸ªåŒ…è£…å‘˜ï¼Œå®ƒä¼šæ ¹æ®è§„åˆ™ï¼Œå†³å®šå¦‚ä½•å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼ˆé‚®ä»¶ï¼‰ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½ä¼šå†³å®šè¯·æ±‚åº”è¯¥è¢«å‘é€åˆ°å“ªä¸ªç‰ˆæœ¬çš„æœåŠ¡ï¼Œæˆ–è€…è¯·æ±‚åº”è¯¥å¦‚ä½•è¢«è´Ÿè½½å‡è¡¡ã€‚ Envoyï¼ˆé‚®å±€çš„å¿«é€’å‘˜ï¼‰ï¼š å½“productpageæœåŠ¡éœ€è¦è®¿é—®å…¶ä»–æœåŠ¡ï¼ˆå¦‚reviewsï¼‰æ—¶ï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªè¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚å°±åƒæ˜¯ä¸€ä¸ªæ–°çš„é‚®ä»¶ï¼Œå®ƒä¼šè¢«Envoyï¼ˆå¿«é€’å‘˜ï¼‰æ‹¿åˆ°ï¼Œç„¶åæ ¹æ®VirtualServiceå’ŒDestinationRuleçš„è§„åˆ™ï¼Œè¢«å‘é€åˆ°æ­£ç¡®çš„æœåŠ¡ã€‚ åœ¨ Istio ä¸­ï¼ŒVirtualService å’Œ DestinationRule æ˜¯ä¸¤ä¸ªå…³é”®çš„è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDï¼‰ï¼Œå®ƒä»¬ç”¨äºé…ç½®å’Œæ§åˆ¶æœåŠ¡é—´çš„æµé‡è·¯ç”±ã€‚\nå®ƒä»¬ä¹‹é—´çš„å…³ç³»å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š\nVirtualService å®šä¹‰äº†æµé‡çš„è·¯ç”±è§„åˆ™ï¼Œ\nDestinationRule å®šä¹‰äº†æµé‡åˆ°è¾¾ç›®çš„åœ°åå¦‚ä½•è¿›è¡Œè´Ÿè½½åˆ†å‘å’Œè¿æ¥æ± ç®¡ç†ã€‚\nVirtualService ç”¨äºå®šä¹‰æµé‡çš„è·¯ç”±è§„åˆ™ã€‚ å½“è¯·æ±‚ä»ä¸€ä¸ªæœåŠ¡åˆ°å¦ä¸€ä¸ªæœåŠ¡æ—¶ï¼ŒVirtualService å¯ä»¥æŒ‡å®šå¦‚ä½•å°†æµé‡è·¯ç”±åˆ°ä¸åŒçš„ç›®çš„åœ°ï¼ˆä¾‹å¦‚ï¼Œä¸åŒçš„æœåŠ¡å®ä¾‹ï¼Œç‰ˆæœ¬æˆ–å­é›†ï¼‰ã€‚VirtualService è¿˜å¯ä»¥æ ¹æ®è¯·æ±‚çš„å±æ€§ï¼ˆå¦‚è¯·æ±‚å¤´ã€è·¯å¾„ã€æ¥æºç­‰ï¼‰å¯¹æµé‡è¿›è¡ŒåŒ¹é…å’Œåˆ†å‘ã€‚æ­¤å¤–ï¼ŒVirtualService å¯ä»¥é…ç½®å¤æ‚çš„è·¯ç”±è¡Œä¸ºï¼Œå¦‚é‡è¯•ã€è¶…æ—¶å’Œæ•…éšœæ³¨å…¥ç­‰ã€‚\nDestinationRule è¢«ç”¨äºæ§åˆ¶æµé‡çš„åˆ†å‘å’Œè¿æ¥æ± ç®¡ç†ã€‚ DestinationRule å®šä¹‰äº†æœåŠ¡çš„å­é›†ï¼ˆå³æœåŠ¡çš„ä¸åŒç‰ˆæœ¬æˆ–å˜ä½“ï¼‰ï¼Œå¹¶æŒ‡å®šå¦‚ä½•æ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆå¦‚è½®è¯¢ã€éšæœºã€æœ€å°‘è¿æ¥ç­‰ï¼‰å°†æµé‡åˆ†å‘åˆ°è¿™äº›å­é›†ã€‚æ­¤å¤–ï¼ŒDestinationRule è¿˜å¯ä»¥é…ç½®è¿æ¥æ± è®¾ç½®ï¼ˆå¦‚æœ€å¤§è¿æ¥æ•°ã€ç©ºé—²è¶…æ—¶ç­‰ï¼‰å’Œä¼ è¾“å±‚å®‰å…¨ç­–ç•¥ï¼ˆå¦‚ TLS è®¾ç½®ï¼‰ã€‚\næ€»ä¹‹ï¼ŒVirtualService å’Œ DestinationRule åœ¨ Istio ä¸­å…±åŒå®ç°äº†æµé‡çš„ç²¾ç»†æ§åˆ¶ã€‚VirtualService ç”¨äºå®šä¹‰æµé‡çš„è·¯ç”±è§„åˆ™ï¼Œè€Œ DestinationRule åˆ™è´Ÿè´£å¤„ç†æµé‡åˆ°è¾¾ç›®çš„åœ°åçš„è´Ÿè½½åˆ†å‘å’Œè¿æ¥æ± ç®¡ç†ã€‚ Istio çš„åšæ³•æ˜¯ Gateway ç›‘æ§å…¥å£æµé‡ï¼Œ é€šè¿‡ VirtualService è®¾ç½®æµé‡è¿›å…¥çš„ç­–ç•¥ï¼Œå¹¶æŒ‡å‘ Serviceã€‚ è€Œ DestinationRule åˆ™å®šä¹‰äº†æµé‡æµå‘ Pod çš„ç­–ç•¥ã€‚\nVirtualService VirtualServiceï¼ˆè™šæ‹ŸæœåŠ¡ï¼‰å’ŒKubernetesçš„Serviceç±»ä¼¼ï¼Œä½†æ˜¯ä¸¤ç§å¹¶ä¸æ˜¯å¯¹ç­‰çš„èµ„æºç±»å‹ã€‚VirtualServiceåŸºäºIstioå’Œå¯¹åº”å¹³å°æä¾›çš„åŸºæœ¬è¿é€šæ€§å’ŒæœåŠ¡å‘ç°èƒ½åŠ›ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°å¯¹åº”çš„ç›®æ ‡ã€‚æ¯ä¸€ä¸ªVirtualServiceåŒ…å«ä¸€ç»„è·¯ç”±è§„åˆ™ï¼ŒIstioå°†æ¯ä¸ªè¯·æ±‚æ ¹æ®è·¯ç”±åŒ¹é…åˆ°æŒ‡å®šçš„ç›®æ ‡åœ°å€ã€‚\nå’ŒKubernetesçš„Serviceä¸åŒçš„æ˜¯ï¼ŒKubernetesçš„Serviceåªæä¾›äº†æœ€ç®€å•çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ï¼Œå¦‚æœæƒ³è¦å®ç°æ›´åŠ ç»†ç²’åº¦çš„æµé‡åˆ†å‘ï¼Œæ¯”å¦‚ç°åº¦ã€è“ç»¿ç­‰æµé‡ç®¡ç†ï¼ŒKubernetesçš„Serviceæ˜¾å¾—æ¯”è¾ƒåƒåŠ›æˆ–è€…æ— æ³•å®ç°ï¼Œè€ŒVirtualServiceåœ¨æµé‡ç®¡ç†æ–¹é¢æœ‰ç€æ¯”è¾ƒå¥½çš„çµæ´»æ€§å’Œæœ‰æ•ˆæ€§ï¼Œå¯ä»¥åœ¨ä»£ç é›¶ä¾µå…¥çš„æƒ…å†µä¸‹å®ç°æ›´åŠ ä¸°å¯Œçš„æµé‡ç®¡ç†ï¼Œæ¯”å¦‚ç°åº¦ç­‰ã€‚\nä¸€ä¸ªå…¸å‹çš„ç”¨ä¾‹æ˜¯å°†æµé‡å‘é€åˆ°è¢«æŒ‡å®šæœåŠ¡çš„ä¸åŒç‰ˆæœ¬ï¼Œæ¯”å¦‚80%çš„æµé‡å‘é€ç»™v1ç‰ˆæœ¬ï¼Œ20%çš„æµé‡å‘é€ç»™æ–°ç‰ˆæœ¬ã€‚æˆ–è€…å°†æŸä¸ªç™»å½•ç”¨æˆ·æŒ‡å®šåˆ°æ–°ç‰ˆæœ¬ï¼Œå…¶ä»–ç”¨æˆ·æŒ‡å®šåˆ°æ—§ç‰ˆæœ¬ï¼Œå¯ä»¥å®ç°ABæµ‹è¯•ç­‰åŠŸèƒ½ã€‚\næ¥ä¸‹æ¥çœ‹ä¸€ä¸ªVirtualServiceçš„é…ç½®ç¤ºä¾‹ï¼Œæ ¹æ®ç‰¹å®šç”¨æˆ·å°†æµé‡åˆ†å‘è‡³ä¸åŒç‰ˆæœ¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 apiVersion: networking.istio.io/v1beta1 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: end-user: exact: jason route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v3 ä¸Šé¢å‚æ•°è¯´æ˜:\napiVersionï¼šå¯¹åº”çš„APIç‰ˆæœ¬ kindï¼šåˆ›å»ºçš„èµ„æºç±»å‹ï¼Œå’ŒKubernetesçš„Serviceç±»ä¼¼ metadataï¼šå…ƒæ•°æ®ï¼Œå’ŒKubernetesèµ„æºç±»ä¼¼ï¼Œå¯ä»¥å®šä¹‰annotationsã€labelsã€nameç­‰ metadata.nameï¼šVirtualServiceçš„åç§° specï¼šå…³äºVirtualServiceçš„å®šä¹‰ spec.hostsï¼šVirtualServiceçš„ä¸»æœºï¼Œå³ç”¨æˆ·æŒ‡å®šçš„ç›®æ ‡æˆ–è·¯ç”±è§„åˆ™çš„ç›®æ ‡ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚æ—¶ä½¿ç”¨çš„ä¸€ä¸ªæˆ–å¤šä¸ªåœ°å€ï¼Œå¯ä»¥æ˜¯IPåœ°å€ã€DNSåç§°ï¼Œæˆ–è€…æ˜¯ä¾èµ–äºåº•å±‚å¹³å°çš„ä¸€ä¸ªç®€ç§°ï¼ˆæ¯”å¦‚Kubernetesçš„ServiceçŸ­åç§°ï¼‰ï¼Œéšå¼æˆ–æ˜¾å¼åœ°æŒ‡å‘ä¸€ä¸ªå®Œå…¨é™å®šåŸŸåï¼ˆFQDNï¼‰ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé€šé…ç¬¦\u0026quot;*\u0026quot; spec.httpï¼šè·¯ç”±è§„åˆ™é…ç½®ï¼Œç”¨æ¥æŒ‡å®šæµé‡çš„è·¯ç”±è¡Œä¸ºï¼Œé€šè¿‡è¯¥å¤„çš„é…ç½®å°†HTTP/1.1ã€HTTP2å’ŒgRPCç­‰æµé‡å‘é€åˆ°hostså­—æ®µæŒ‡å®šçš„ç›®æ ‡ spec.http[].matchï¼šè·¯ç”±è§„åˆ™çš„æ¡ä»¶ï¼Œå¯ä»¥æ ¹æ®ä¸€äº›æ¡ä»¶åˆ¶å®šæ›´åŠ ç»†ç²’åº¦çš„è·¯ç”±ã€‚æ¯”å¦‚å½“å‰ç¤ºä¾‹çš„headersï¼Œè¡¨ç¤ºåŒ¹é…headersé‡Œé¢çš„end-userå­—æ®µï¼Œå¹¶ä¸”å€¼ä¸ºjasonçš„è¯·æ±‚ routeï¼šè·¯ç”±è§„åˆ™ï¼Œdestinationå­—æ®µæŒ‡å®šäº†ç¬¦åˆæ­¤æ¡ä»¶çš„æµé‡çš„å®é™…ç›®æ ‡åœ°å€ã€‚æ¯”å¦‚è¯¥ç¤ºä¾‹çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚å¤´åŒ…å«end-user=jasonå­—æ®µï¼Œåˆ™è¯¥è¯·æ±‚ä¼šè¢«è·¯ç”±åˆ°reviewsçš„v2ç‰ˆæœ¬ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°è¯¥è¯·æ±‚å¤´ï¼Œåˆ™æµé‡ä¼šè¢«è·¯ç”±åˆ°v3ç‰ˆæœ¬ï¼ˆç‰ˆæœ¬ç”±DestinationRuleåˆ’åˆ†ï¼‰ æ³¨æ„ï¼šVirtualServiceè·¯ç”±è§„åˆ™æŒ‰ç…§ä»ä¸Šå¾€ä¸‹çš„é¡ºåºè¿›è¡ŒåŒ¹é…ï¼Œç¬¬ä¸€ä¸ªè§„åˆ™æœ‰æœ€é«˜çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœä¸æ»¡è¶³ç¬¬ä¸€ä¸ªè·¯ç”±è§„åˆ™ï¼Œåˆ™æµé‡ä¼šé€‰æ‹©ä¸‹ä¸€ä¸ªè§„åˆ™ã€‚\né™¤äº†ä¸Šè¿°çš„è·¯ç”±åŒ¹é…å¤–ï¼ŒVirtualServiceä¹Ÿæ”¯æŒåŸŸå+è·¯å¾„çš„æ–¹å¼è¿›è¡Œè·¯ç”±ã€‚æ¯”å¦‚åç«¯æœ‰ä¸¤ä¸ªæœåŠ¡ï¼Œä¸€ä¸ªæ˜¯reviewsï¼Œé€šè¿‡http://â€‹**bookinfo.com/reviewsè®¿é—®ï¼›å¦ä¸€ä¸ªæ˜¯ratingsï¼Œé€šè¿‡http://â€‹bookinfo.com/ratings**è®¿é—®ã€‚æ­¤æ—¶å¯ä»¥é…ç½®VirtualServiceå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 apiVersion: networking.istio.io/v1beta1 kind: VirtualService metadata: name: reviews spec: hosts: - bookinfo.com http: - match: - uri: prefix: /reviews route: - destination: host: reviews - match: - uri: prefix: /ratings route: - destination: host: ratings DestinationRule å°†VirtualServiceç†è§£ä¸ºKubernetes Serviceå±‚é¢ï¼ŒDestinationRuleç†è§£ä¸ºServiceåç«¯çœŸå®çš„ç›®æ ‡åœ°å€ï¼Œå³VirtualServiceç”¨äºServiceå±‚é¢çš„è·¯ç”±ç®¡æ§ï¼ŒDestinationRuleç”¨äºå¯¹åç«¯çœŸå®çš„æœåŠ¡å†åšè¿›ä¸€æ­¥çš„åˆ’åˆ†ã€‚æ¯”å¦‚å­˜åœ¨ä¸€ä¸ªServiceåä¸ºpaycenterï¼ŒæŒ‡å‘åç«¯å¤šä¸ªpaycenterçš„Podï¼ˆè¯¥Podå¯èƒ½æ˜¯ä¸åŒçš„Deploymentåˆ›å»ºçš„ï¼‰ï¼Œè€ŒDestinationRuleå¯ä»¥å¯¹åç«¯çš„å¤šä¸ªPodåŒºåˆ†æ–°æ—§ç‰ˆæœ¬ï¼Œåˆ’åˆ†æˆä¸åŒçš„subnetï¼Œä¹‹åVirtualServiceå¯ä»¥é’ˆå¯¹ä¸åŒçš„ç‰ˆæœ¬è¿›è¡Œæµé‡ç®¡æ§ã€‚\nåœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œç›®æ ‡è§„åˆ™ä¸º my-svc ç›®æ ‡æœåŠ¡é…ç½®äº† 3 ä¸ªå…·æœ‰ä¸åŒè´Ÿè½½å‡è¡¡ç­–ç•¥çš„å­é›†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 apiVersion: networking.istio.io/v1beta1 kind: DestinationRule metadata: name: my-destination-rule spec: host: my-svc trafficPolicy: loadBalancer: simple: RANDOM subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 trafficPolicy: loadBalancer: simple: ROUND_ROBIN - name: v3 labels: version: v3 ä¸Šé¢å‚æ•°è¯´æ˜ï¼š\ntrafficPolicyï¼šè¿™æ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰æµé‡ç­–ç•¥çš„éƒ¨åˆ†ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå®šä¹‰äº†ä¸‰ä¸ªå­é›†ï¼ˆsubsetsï¼‰çš„æµé‡ç­–ç•¥ loadBalancerï¼šç”¨äºæŒ‡å®šè´Ÿè½½å‡è¡¡ç®—æ³•çš„é…ç½® subsetsï¼šè¿™é‡Œå®šä¹‰äº†ä¸‰ä¸ªå­é›†ï¼ˆv1ã€v2ã€v3ï¼‰ï¼Œæ¯ä¸ªå­é›†é€šè¿‡ labels æ¥é€‰æ‹©å¯¹åº”ç‰ˆæœ¬çš„æœåŠ¡å®ä¾‹ã€‚ç¬¬ä¸€ä¸ªå­é›† v1 å¯¹åº”ç‰ˆæœ¬ä¸º v1 çš„æœåŠ¡å®ä¾‹ï¼Œå¹¶ä½¿ç”¨ simple: RANDOM è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚è¿™æ„å‘³ç€è¯·æ±‚å°†éšæœºè·¯ç”±åˆ° v1 å­é›†ä¸­çš„æœåŠ¡å®ä¾‹ï¼›ç¬¬äºŒä¸ªå­é›† v2 å¯¹åº”ç‰ˆæœ¬ä¸º v2 çš„æœåŠ¡å®ä¾‹ï¼Œå¹¶ä½¿ç”¨ simple: ROUND_ROBIN è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚è¿™æ„å‘³ç€è¯·æ±‚å°†ä»¥å¾ªç¯æ–¹å¼ï¼ˆRound Robinï¼‰è·¯ç”±åˆ° v2 å­é›†ä¸­çš„æœåŠ¡å®ä¾‹ï¼›ç¬¬ä¸‰ä¸ªå­é›† v3 å¯¹åº”ç‰ˆæœ¬ä¸º v3 çš„æœåŠ¡å®ä¾‹ã€‚åœ¨è¿™é‡Œæ²¡æœ‰æŒ‡å®šè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå› æ­¤å°†ä½¿ç”¨é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚ æ¯ä¸ªå­é›†éƒ½æ˜¯åŸºäºä¸€ä¸ªæˆ–å¤šä¸ª labels å®šä¹‰çš„ï¼Œåœ¨ Kubernetes ä¸­å®ƒæ˜¯é™„åŠ åˆ°åƒ Pod è¿™ç§å¯¹è±¡ä¸Šçš„é”®/å€¼å¯¹ã€‚è¿™äº›æ ‡ç­¾åº”ç”¨äº Kubernetes æœåŠ¡çš„ Deployment å¹¶ä½œä¸º metadata æ¥è¯†åˆ«ä¸åŒçš„ç‰ˆæœ¬ã€‚\né™¤äº†å®šä¹‰å­é›†ä¹‹å¤–ï¼Œæ­¤ç›®æ ‡è§„åˆ™å¯¹äºæ‰€æœ‰å­é›†éƒ½æœ‰é»˜è®¤çš„æµé‡ç­–ç•¥ï¼Œè€Œå¯¹äºè¯¥å­é›†ï¼Œ åˆ™æœ‰ç‰¹å®šäºå­é›†çš„ç­–ç•¥è¦†ç›–å®ƒã€‚å®šä¹‰åœ¨ subsets ä¸Šçš„é»˜è®¤ç­–ç•¥ï¼Œä¸º v1 å’Œ v3 å­é›†è®¾ç½®äº†ä¸€ä¸ªç®€å•çš„éšæœºè´Ÿè½½å‡è¡¡å™¨ã€‚åœ¨ v2 ç­–ç•¥ä¸­ï¼Œè½®è¯¢è´Ÿè½½å‡è¡¡å™¨è¢«æŒ‡å®šåœ¨ç›¸åº”çš„å­é›†å­—æ®µä¸Š\né»˜è®¤æƒ…å†µä¸‹ï¼ŒIstio ä½¿ç”¨è½®è¯¢çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå®ä¾‹æ± ä¸­çš„æ¯ä¸ªå®ä¾‹ä¾æ¬¡è·å–è¯·æ±‚ã€‚Istio åŒæ—¶æ”¯æŒå¦‚ä¸‹çš„è´Ÿè½½å‡è¡¡æ¨¡å‹ï¼Œ å¯ä»¥åœ¨ DestinationRule ä¸­ä¸ºæµå‘æŸä¸ªç‰¹å®šæœåŠ¡æˆ–æœåŠ¡å­é›†çš„æµé‡æŒ‡å®šè¿™äº›æ¨¡å‹ã€‚\néšæœºï¼šè¯·æ±‚ä»¥éšæœºçš„æ–¹å¼è½¬å‘åˆ°æ± ä¸­çš„å®ä¾‹ æƒé‡ï¼šè¯·æ±‚æ ¹æ®æŒ‡å®šçš„ç™¾åˆ†æ¯”è½¬å‘åˆ°æ± ä¸­çš„å®ä¾‹ æœ€å°‘è¯·æ±‚ï¼šè¯·æ±‚è¢«è½¬å‘åˆ°æœ€å°‘è¢«è®¿é—®çš„å®ä¾‹ Gateway IstioåŒæ ·æ”¯æŒç½‘å…³åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨Gatewayåœ¨ç½‘æ ¼æœ€å¤–å±‚æ¥æ”¶HTTP/TCPæµé‡ï¼Œå¹¶å°†æµé‡è½¬å‘åˆ°ç½‘æ ¼å†…çš„æŸä¸ªæœåŠ¡ã€‚\nåœ¨å®‰è£…Istioæ—¶ï¼Œå¯ä»¥åœ¨istio-systemå‘½åç©ºé—´ä¸‹å®‰è£…ingressgatewayçš„Podï¼Œç”¨æ¥å……å½“Ingress Gatewayã€‚å…¶ä¸­Ingress Gatewayä¸ºå…¥å£ç½‘å…³ï¼Œå¯ä»¥å°†ç½‘æ ¼å†…çš„æœåŠ¡â€œæš´éœ²â€å‡ºå»ï¼Œä¸€èˆ¬å’ŒVirtualServiceé…ç½®ä½¿ç”¨ï¼Œå¹¶é…ç½®ä¸€ä¸ªå¯ä»¥è¢«å¤–éƒ¨æœåŠ¡è®¿é—®çš„åŸŸåï¼Œä»è€Œå¤–éƒ¨æœåŠ¡å¯ä»¥é€šè¿‡è¯¥åŸŸåè®¿é—®ç½‘æ ¼å†…çš„æœåŠ¡ã€‚\né…ç½®Gatewayå’ŒIstioå…¶ä»–èµ„æºç±»ä¼¼ï¼ŒkindæŒ‡å®šä¸ºGatewayå³å¯ã€‚æ¯”å¦‚é…ç½®ä¸€ä¸ªVirtualServiceå’ŒGatewayå®ç°å¯¹ç½‘æ ¼å†…çš„æŸä¸ªæœåŠ¡è¿›è¡Œå‘å¸ƒï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªGatewayï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: networking.istio.io/v1beta1 kind: Gateway metadata: name: httpbin-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - \u0026#34;httpbin.example.com\u0026#34; ä¸Šé¢å‚æ•°è¯´æ˜ï¼š\nselectorï¼šå¿…é€‰å­—æ®µã€‚é€‰æ‹©ç”±å“ªä¸ªingressgatewayçš„Podå‘å¸ƒæœåŠ¡ï¼Œé»˜è®¤ä¸ºistio-systemå‘½åç©ºé—´ä¸‹å…·æœ‰istio=ingressgatewayæ ‡ç­¾çš„Pod serversï¼šå¿…é€‰å­—æ®µã€‚è¡¨ç¤ºå‘å¸ƒçš„æœåŠ¡åˆ—è¡¨ï¼Œç”¨äºæè¿°å‘å¸ƒæœåŠ¡çš„å±æ€§ï¼Œæ¯”å¦‚ä»£ç†ç›‘å¬çš„ç«¯å£ã€åè®®å’Œç«¯å£çš„åç§°ç­‰ hostsï¼šå¿…é€‰å­—æ®µã€‚Gatewayå‘å¸ƒçš„æœåŠ¡åœ°å€ï¼Œä¹Ÿå°±æ˜¯å…è®¸ç”¨æˆ·è®¿é—®çš„åŸŸåï¼Œå¯ä»¥é…ç½®ä¸ºâ€œ*â€ï¼Œè¡¨ç¤ºä»»ä½•åŸŸåéƒ½å¯ä»¥è¢«ä»£ç†ï¼Œæœ¬ç¤ºä¾‹ä¸ºhttp://httpbin.example.comå¯è¢«è·¯ç”± ä¹‹åé…ç½®ä¸€ä¸ªVirtualServiceä¸ä¹‹åŒ¹é…ï¼Œå³å¯é€šè¿‡è¯¥åŸŸåè®¿é—®VirtualServiceé…ç½®çš„æœåŠ¡ã€‚æ¯”å¦‚å°†http://httpbin.example.comçš„/statuså’Œ/delayä»£ç†åˆ°httpbinæœåŠ¡çš„8000ç«¯å£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 apiVersion: networking.istio.io/v1beta1 kind: VirtualService metadata: name: httpbin spec: hosts: - \u0026#34;httpbin.example.com\u0026#34; gateways: - httpbin-gateway http: - match: - uri: prefix: /status - uri: prefix: /delay route: - destination: host: httpbin port: number: 8000 ä¹‹åå°†åŸŸåè§£æè‡³ingressgateway Podçš„Serviceä¸Šå³å¯è®¿é—®è¯¥åŸŸåã€‚\n","date":"2024-01-12T17:19:48Z","image":"https://www.ownit.top/title_pic/32.jpg","permalink":"https://www.ownit.top/p/202401121719/","title":"Istioå®‰è£…å’ŒåŸºç¡€åŸç†"},{"content":"èƒŒæ™¯ åœ¨æœ¬åœ°é›†ç¾¤è¿›è¡Œæµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸é¢ä¸´ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼šService Typeä¸æ”¯æŒLoadBalancerï¼Œè€Œæˆ‘ä»¬åªèƒ½é€‰æ‹©ä½¿ç”¨NodePortä½œä¸ºæ›¿ä»£ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šé…ç½®Serviceä¸ºNodePortï¼Œå¹¶ä½¿ç”¨externalIPså°†æµé‡å¯¼å…¥Kubernetesç¯å¢ƒã€‚ç„¶è€Œï¼Œè¿™äº›è§£å†³æ–¹æ¡ˆéƒ½å­˜åœ¨æ˜æ˜¾çš„ç¼ºé™·ï¼Œä½¿å¾—åœ¨ç§æœ‰ç¯å¢ƒéƒ¨ç½²Kubernetesçš„ç”¨æˆ·åœ¨è¿™ä¸ªç”Ÿæ€ä¸­æ„Ÿè§‰è‡ªå·±åƒæ˜¯äºŒç­‰å…¬æ°‘ã€‚\nå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒKubernetesé»˜è®¤å¹¶æœªæä¾›è´Ÿè½½å‡è¡¡å™¨çš„å®ç°ã€‚åœ¨Kubernetesç”Ÿæ€ä¸­ï¼Œç½‘ç»œè´Ÿè½½å‡è¡¡å™¨çš„å®ç°é€šå¸¸ä¾èµ–äºå„ç§IaaSå¹³å°ï¼Œå¦‚Google Cloud Platform (GCP)ã€Amazon Web Services (AWS)ã€Azureç­‰ã€‚å› æ­¤ï¼Œå¦‚æœä½ ä¸åœ¨è¿™äº›IaaSå¹³å°ä¸Šè¿è¡ŒKubernetesï¼Œä½ åˆ›å»ºçš„Serviceä¸­çš„type: LoadBalancerså°†ä¸€ç›´å¤„äºPendingçŠ¶æ€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx LoadBalancer 10.93.15.64 \u0026lt;pending\u0026gt; 8080:31322/TCP,443:31105/TCP 1h è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ€¥éœ€ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œä¸€ä¸ªå¯ä»¥åœ¨æœ¬åœ°ç¯å¢ƒä¸­å®ç°è´Ÿè½½å‡è¡¡çš„è§£å†³æ–¹æ¡ˆã€‚è¿™å°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦ä»‹ç»çš„ä¸»è§’â€”â€”MetalLBã€‚\nMetallb é€šè¿‡æ ‡å‡†è·¯ç”±åè®®èƒ½è§£å†³è¯¥é—®é¢˜ã€‚MetalLB ä¹Ÿæ˜¯ CNCF çš„æ²™ç®±é¡¹ç›®ï¼Œæœ€æ—©å‘å¸ƒåœ¨ https://github.com/google/metallb å¼€å‘ï¼Œåæ¥è¿ç§»åˆ° https://github.com/metallb/metallb ä¸­ã€‚\nåŸç† Metallb ä¼šåœ¨ Kubernetes å†…è¿è¡Œï¼Œç›‘æ§æœåŠ¡å¯¹è±¡çš„å˜åŒ–ï¼Œä¸€æ—¦å¯Ÿè§‰æœ‰æ–°çš„LoadBalancer æœåŠ¡è¿è¡Œï¼Œå¹¶ä¸”æ²¡æœ‰å¯ç”³è¯·çš„è´Ÿè½½å‡è¡¡å™¨ä¹‹åï¼Œ\nMetalLB é€šè¿‡ MetalLB hooks ä¸º Kubernetes ä¸­æä¾›ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨çš„å®ç°ã€‚ç®€å•çš„è¯´ï¼Œå®ƒå…è®¸ä½ åœ¨éäº‘ä¾›åº”å•†æä¾›çš„ï¼ˆç§æœ‰çš„ï¼‰ Kubernetes ä¸­åˆ›å»º type: LoadBalancer çš„ servicesã€‚\nMetalLB æœ‰ä¸¤å¤§åŠŸèƒ½ï¼š\nåœ°å€åˆ†é…ï¼šåœ¨ IaaS å¹³å°ç”³è¯· LBï¼Œä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªå…¬ç½‘ IPï¼Œå› æ­¤ï¼ŒMetalLBä¹Ÿéœ€è¦ç®¡ç† IP åœ°å€çš„åˆ†é…å·¥ä½œ IP å¤–éƒ¨å£°æ˜ï¼šå½“ MetalLB è·å–å¤–éƒ¨åœ°å€åï¼Œéœ€è¦å¯¹å¤–å£°æ˜è¯¥ IP åœ¨ k8s ä¸­ä½¿ç”¨ï¼Œå¹¶å¯ä»¥æ­£å¸¸é€šä¿¡ã€‚ IP å£°æ˜å¯ä»¥ä½¿ç”¨ ARPã€ NDPã€æˆ– BGP åè®®ï¼Œå› æ­¤ MetalLB æœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š\nBGP å·¥ä½œæ¨¡å¼ï¼Œä½¿ç”¨ BGP åè®®åˆ†é…åœ°å€æ±  L2 å·¥ä½œæ¨¡å¼ï¼Œä½¿ç”¨ ARP/NDP åè®®åˆ†é…åœ°å€æ±  Layer2æ¨¡å¼ åœ¨2å±‚æ¨¡å¼ä¸‹ï¼ŒMetallbä¼šåœ¨NodeèŠ‚ç‚¹ä¸­é€‰å‡ºä¸€å°ä½œä¸ºLeaderï¼Œä¸æœåŠ¡IPç›¸å…³çš„æ‰€æœ‰æµé‡éƒ½ä¼šæµå‘è¯¥èŠ‚ç‚¹ã€‚åœ¨è¯¥èŠ‚ç‚¹ä¸Šï¼Œ kube-proxyå°†æ¥æ”¶åˆ°çš„æµé‡ä¼ æ’­åˆ°å¯¹åº”æœåŠ¡çš„Podã€‚å½“leaderèŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œä¼šç”±å¦ä¸€ä¸ªèŠ‚ç‚¹æ¥ç®¡ã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œ2å±‚æ¨¡å¼æ›´åƒæ˜¯é«˜å¯ç”¨ï¼Œè€Œä¸æ˜¯è´Ÿè½½å‡è¡¡ï¼Œå› ä¸ºåŒæ—¶åªèƒ½åœ¨ä¸€ä¸ªèŠ‚ç‚¹è´Ÿè´£æ¥æ”¶æ•°æ®ã€‚\nåœ¨äºŒå±‚æ¨¡å¼ä¸­ä¼šå­˜åœ¨ä»¥ä¸‹ä¸¤ç§å±€é™æ€§ï¼šå•èŠ‚ç‚¹ç“¶é¢ˆå’Œæ•…éšœè½¬ç§»æ…¢çš„æƒ…å†µã€‚\nç”±äºLayer 2 æ¨¡å¼ä¼šä½¿ç”¨å•ä¸ªé€‰ä¸¾å‡ºæ¥çš„Leaderæ¥æ¥æ”¶æœåŠ¡IPçš„æ‰€æœ‰æµé‡ï¼Œè¿™å°±æ„å‘³ç€æœåŠ¡çš„å…¥å£å¸¦å®½è¢«é™åˆ¶ä¸ºå•ä¸ªèŠ‚ç‚¹çš„å¸¦å®½ï¼Œå•èŠ‚ç‚¹çš„æµé‡å¤„ç†èƒ½åŠ›å°†æˆä¸ºæ•´ä¸ªé›†ç¾¤çš„æ¥æ”¶å¤–éƒ¨æµé‡çš„ç“¶é¢ˆã€‚\nåœ¨æ•…éšœè½¬ç§»æ–¹é¢ï¼Œç›®å‰çš„æœºåˆ¶æ˜¯MetalLBé€šè¿‡å‘é€2å±‚æ•°æ®åŒ…æ¥é€šçŸ¥å„ä¸ªèŠ‚ç‚¹ï¼Œå¹¶é‡æ–°é€‰ä¸¾Leaderï¼Œè¿™é€šå¸¸èƒ½åœ¨å‡ ç§’å†…å®Œæˆã€‚ä½†å¦‚æœæ˜¯è®¡åˆ’å¤–çš„äº‹æ•…å¯¼è‡´çš„ï¼Œæ­¤æ—¶åœ¨æœ‰æ•…éšœçš„å®¢æˆ·ç«¯åˆ·æ–°å…¶ç¼“å­˜æ¡ç›®ä¹‹å‰ï¼Œå°†æ— æ³•è®¿é—®æœåŠ¡IPã€‚\nBGPæ¨¡å¼ BGPæ¨¡å¼æ˜¯çœŸæ­£çš„è´Ÿè½½å‡è¡¡ï¼Œè¯¥æ¨¡å¼éœ€è¦è·¯ç”±å™¨æ”¯æŒBGPåè®® ï¼Œç¾¤é›†ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä¼šä¸ç½‘ç»œè·¯ç”±å™¨å»ºè®®åŸºäºBGPçš„å¯¹ç­‰ä¼šè¯ï¼Œå¹¶ä½¿ç”¨è¯¥ä¼šè¯æ¥é€šå‘Šè´Ÿè½½å‡è¡¡çš„IPã€‚MetalLBå‘å¸ƒçš„è·¯ç”±å½¼æ­¤ç­‰æ•ˆï¼Œè¿™æ„å‘³ç€è·¯ç”±å™¨å°†ä½¿ç”¨æ‰€æœ‰çš„ç›®æ ‡èŠ‚ç‚¹ï¼Œå¹¶åœ¨å®ƒä»¬ä¹‹é—´è¿›è¡Œè´Ÿè½½å¹³è¡¡ã€‚æ•°æ®åŒ…åˆ°è¾¾èŠ‚ç‚¹åï¼Œkube-proxyè´Ÿè´£æµé‡è·¯ç”±çš„æœ€åä¸€è·³ï¼Œå°†æ•°æ®åŒ…å‘é€åˆ°å¯¹åº”æœåŠ¡çš„Podã€‚\nè´Ÿè½½å¹³è¡¡çš„æ–¹å¼å–å†³äºæ‚¨ç‰¹å®šçš„è·¯ç”±å™¨å‹å·å’Œé…ç½®ï¼Œå¸¸è§çš„æœ‰åŸºäºæ•°æ®åŒ…å“ˆå¸Œå¯¹æ¯ä¸ªè¿æ¥è¿›è¡Œå‡è¡¡ï¼Œè¿™æ„å‘³ç€å•ä¸ªTCPæˆ–UDPä¼šè¯çš„æ‰€æœ‰æ•°æ®åŒ…éƒ½å°†å®šå‘åˆ°ç¾¤é›†ä¸­çš„å•ä¸ªè®¡ç®—æœºã€‚\nBGPæ¨¡å¼ä¹Ÿå­˜åœ¨ç€è‡ªèº«çš„å±€é™æ€§ï¼Œè¯¥æ¨¡å¼é€šè¿‡å¯¹æ•°æ®åŒ…å¤´ä¸­çš„æŸäº›å­—æ®µè¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œå¹¶å°†è¯¥å“ˆå¸Œå€¼ç”¨ä½œåç«¯æ•°ç»„çš„ç´¢å¼•ï¼Œå°†ç»™å®šçš„æ•°æ®åŒ…åˆ†é…ç»™ç‰¹å®šçš„ä¸‹ä¸€è·³ã€‚ä½†è·¯ç”±å™¨ä¸­ä½¿ç”¨çš„å“ˆå¸Œé€šå¸¸ä¸ç¨³å®šï¼Œå› æ­¤åªè¦åç«¯èŠ‚ç‚¹æ•°é‡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç°æœ‰è¿æ¥å°±ä¼šè¢«éšæœºåœ°é‡æ–°å“ˆå¸Œï¼Œè¿™æ„å‘³ç€å¤§å¤šæ•°ç°æœ‰è¿æ¥å°†è¢«è½¬å‘åˆ°å¦ä¸€åç«¯ï¼Œè€Œè¯¥åç«¯å¹¶ä¸æ¸…æ¥šåŸæœ‰çš„è¿æ¥çŠ¶æ€ã€‚ä¸ºäº†å‡å°‘è¿™ç§éº»çƒ¦ï¼Œå»ºè®®ä½¿ç”¨æ›´åŠ ç¨³å®šçš„BGPç®—æ³•ï¼Œå¦‚ï¼šECMPæ•£åˆ—ç®—æ³•ã€‚\nç³»ç»Ÿè¦æ±‚ åœ¨å¼€å§‹éƒ¨ç½²MetalLBä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šéƒ¨ç½²ç¯å¢ƒèƒ½å¤Ÿæ»¡è¶³æœ€ä½è¦æ±‚ï¼š\nä¸€ä¸ªk8sé›†ç¾¤ï¼Œè¦æ±‚ç‰ˆæœ¬ä¸ä½äº1.13.0ï¼Œä¸”æ²¡æœ‰è´Ÿè½½å‡è¡¡å™¨ç›¸å…³æ’ä»¶ k8sé›†ç¾¤ä¸Šçš„CNIç»„ä»¶å’ŒMetalLBå…¼å®¹ é¢„ç•™ä¸€æ®µIPv4åœ°å€ç»™MetalLBä½œä¸ºLoadBalanceçš„VIPä½¿ç”¨ å¦‚æœä½¿ç”¨çš„æ˜¯MetalLBçš„BGPæ¨¡å¼ï¼Œè¿˜éœ€è¦è·¯ç”±å™¨æ”¯æŒBGPåè®® å¦‚æœä½¿ç”¨çš„æ˜¯MetalLBçš„Layer2æ¨¡å¼ï¼Œå› ä¸ºä½¿ç”¨äº†memberlistç®—æ³•æ¥å®ç°é€‰ä¸»ï¼Œå› æ­¤éœ€è¦ç¡®ä¿å„ä¸ªk8sèŠ‚ç‚¹ä¹‹é—´çš„7946ç«¯å£å¯è¾¾ï¼ˆåŒ…æ‹¬TCPå’ŒUDPåè®®ï¼‰ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é…ç½®ä¸ºå…¶ä»–ç«¯å£ å®‰è£…è¦æ±‚ å‡†å¤‡ ï¼ˆæ ¹æ®æƒ…å†µè€Œå®šï¼‰ å¦‚æœä½ åœ¨ IPVS æ¨¡å¼ä¸‹ä½¿ç”¨ kube-proxyï¼Œä» Kubernetes v1.14.2 å¼€å§‹ï¼Œå¿…é¡»å¯ç”¨ä¸¥æ ¼ ARP æ¨¡å¼ã€‚\næ³¨æ„ï¼Œå¦‚æœä½¿ç”¨ kube-router ä½œä¸º service-proxyï¼Œåˆ™ä¸éœ€è¦è¿™æ ·åšï¼Œå› ä¸ºå®ƒé»˜è®¤å¯ç”¨ä¸¥æ ¼ ARPã€‚\néƒ¨ç½²Layer2æ¨¡å¼éœ€è¦æŠŠk8sé›†ç¾¤ä¸­çš„ipvsé…ç½®æ‰“å¼€strictARPï¼Œå¼€å¯ä¹‹åk8sé›†ç¾¤ä¸­çš„kube-proxyä¼šåœæ­¢å“åº”kube-ipvs0ç½‘å¡ä¹‹å¤–çš„å…¶ä»–ç½‘å¡çš„arpè¯·æ±‚ï¼Œè€Œç”±MetalLBæ¥æ‰‹å¤„ç†ã€‚\nstrict ARPå¼€å¯ä¹‹åç›¸å½“äºæŠŠ å°† arp_ignore è®¾ç½®ä¸º 1 å¹¶å°† arp_announce è®¾ç½®ä¸º 2 å¯ç”¨ä¸¥æ ¼çš„ ARPï¼Œè¿™ä¸ªåŸç†å’ŒLVSä¸­çš„DRæ¨¡å¼å¯¹RSçš„é…ç½®ä¸€æ ·ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ä¸­çš„è§£é‡Šã€‚\nå¯ä»¥é€šè¿‡ç¼–è¾‘å½“å‰é›†ç¾¤çš„ kube-proxy é…ç½®æ¥å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # æŸ¥çœ‹kube-proxyä¸­çš„strictARPé…ç½® $ kubectl get configmap -n kube-system kube-proxy -o yaml | grep strictARP strictARP: false # æ‰‹åŠ¨ä¿®æ”¹strictARPé…ç½®ä¸ºtrue $ kubectl edit configmap -n kube-system kube-proxy configmap/kube-proxy edited # ä½¿ç”¨å‘½ä»¤ç›´æ¥ä¿®æ”¹å¹¶å¯¹æ¯”ä¸åŒ $ kubectl get configmap kube-proxy -n kube-system -o yaml | sed -e \u0026#34;s/strictARP: false/strictARP: true/\u0026#34; | kubectl diff -f - -n kube-system # ç¡®è®¤æ— è¯¯åä½¿ç”¨å‘½ä»¤ç›´æ¥ä¿®æ”¹å¹¶ç”Ÿæ•ˆ $ kubectl get configmap kube-proxy -n kube-system -o yaml | sed -e \u0026#34;s/strictARP: false/strictARP: true/\u0026#34; | kubectl apply -f - -n kube-system # é‡å¯kube-proxyç¡®ä¿é…ç½®ç”Ÿæ•ˆ $ kubectl rollout restart ds kube-proxy -n kube-system # ç¡®è®¤é…ç½®ç”Ÿæ•ˆ $ kubectl get configmap -n kube-system kube-proxy -o yaml | grep strictARP strictARP: true éƒ¨ç½²MetalLB(Layer2æ¨¡å¼) MetalLBçš„éƒ¨ç½²ä¹Ÿååˆ†ç®€å•ï¼Œå®˜æ–¹æä¾›äº†manifestæ–‡ä»¶éƒ¨ç½²ï¼ˆyamléƒ¨ç½²ï¼‰ï¼Œhelm3éƒ¨ç½²å’ŒKustomizeéƒ¨ç½²ä¸‰ç§æ–¹å¼ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨manifestæ–‡ä»¶éƒ¨ç½²ã€‚\nå¤§å¤šæ•°çš„å®˜æ–¹æ•™ç¨‹ä¸ºäº†ç®€åŒ–éƒ¨ç½²çš„æ­¥éª¤ï¼Œéƒ½æ˜¯å†™ç€ç›´æ¥ç”¨kubectlå‘½ä»¤éƒ¨ç½²ä¸€ä¸ªyamlçš„urlï¼Œè¿™æ ·å­çš„å¥½å¤„æ˜¯éƒ¨ç½²ç®€å•å¿«æ·ï¼Œä½†æ˜¯åå¤„å°±æ˜¯æœ¬åœ°è‡ªå·±æ²¡æœ‰å­˜æ¡£ï¼Œä¸æ–¹ä¾¿ä¿®æ”¹ç­‰æ“ä½œï¼Œå› æ­¤æˆ‘ä¸ªäººæ›´å€¾å‘äºæŠŠyamlæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ä¿å­˜å†è¿›è¡Œéƒ¨ç½²\n1 2 3 4 5 6 7 # ä¸‹è½½v0.12.1çš„ä¸¤ä¸ªéƒ¨ç½²æ–‡ä»¶ $ wget https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml $ wget https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml # å¦‚æœä½¿ç”¨frræ¥è¿›è¡ŒBGPè·¯ç”±ç®¡ç†ï¼Œåˆ™ä¸‹è½½è¿™ä¸¤ä¸ªéƒ¨ç½²æ–‡ä»¶ $ wget https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml $ wget https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb-frr.yaml ä¸‹è½½å®˜æ–¹æä¾›çš„yamlæ–‡ä»¶ä¹‹åï¼Œæˆ‘ä»¬å†æå‰å‡†å¤‡å¥½configmapçš„é…ç½®ï¼Œgithubä¸Šé¢æœ‰æä¾›ä¸€ä¸ªå‚è€ƒæ–‡ä»¶ï¼Œlayer2æ¨¡å¼éœ€è¦çš„é…ç½®å¹¶ä¸å¤šï¼Œè¿™é‡Œæˆ‘ä»¬åªåšæœ€åŸºç¡€çš„ä¸€äº›å‚æ•°é…ç½®å®šä¹‰å³å¯ï¼š\nprotocolè¿™ä¸€é¡¹æˆ‘ä»¬é…ç½®ä¸ºlayer2 addressesè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨CIDRæ¥æ‰¹é‡é…ç½®ï¼ˆ198.51.100.0/24ï¼‰ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šé¦–å°¾IPæ¥é…ç½®ï¼ˆ192.168.0.150-192.168.0.200ï¼‰ï¼ŒæŒ‡å®šä¸€æ®µå’Œk8sèŠ‚ç‚¹åœ¨åŒä¸€ä¸ªå­ç½‘çš„IPã€‚ä¹Ÿå¯ä»¥æŒ‡å®šå®¿ä¸»æœºçš„ç½‘ç»œåˆ†é…ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 # config.yaml apiVersion: v1 kind: ConfigMap metadata: namespace: metallb-system name: config data: config: | address-pools: - name: default protocol: layer2 addresses: - 192.168.102.50-192.168.102.60 è¿˜å¯ä»¥æŒ‡å®šå¤šä¸ªç½‘æ®µ\n1 2 3 addresses: - 192.168.12.0/24 - 192.168.144.0/20 é™¤äº†è‡ªåŠ¨åˆ†é…IPå¤–ï¼ŒMetallb è¿˜æ”¯æŒåœ¨å®šä¹‰æœåŠ¡çš„æ—¶å€™ï¼Œé€šè¿‡ spec.loadBalancerIP æŒ‡å®šä¸€ä¸ªé™æ€IP ã€‚\nä½¿ç”¨kubectl log -f [matellb-contoller-pod]èƒ½çœ‹åˆ°é…ç½®æ›´æ–°è¿‡ç¨‹\næ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹è¿›è¡Œéƒ¨ç½²ï¼Œæ•´ä½“å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š\néƒ¨ç½²namespace éƒ¨ç½²deploymentå’Œdaemonset é…ç½®configmap 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 # åˆ›å»ºnamespace $ kubectl apply -f namespace.yaml namespace/metallb-system created $ kubectl get ns NAME STATUS AGE default Active 8d kube-node-lease Active 8d kube-public Active 8d kube-system Active 8d metallb-system Active 8s nginx-quic Active 8d # éƒ¨ç½²deploymentå’Œdaemonsetï¼Œä»¥åŠç›¸å…³æ‰€éœ€çš„å…¶ä»–èµ„æº $ kubectl apply -f metallb.yaml Warning: policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ podsecuritypolicy.policy/controller created podsecuritypolicy.policy/speaker created serviceaccount/controller created serviceaccount/speaker created clusterrole.rbac.authorization.k8s.io/metallb-system:controller created clusterrole.rbac.authorization.k8s.io/metallb-system:speaker created role.rbac.authorization.k8s.io/config-watcher created role.rbac.authorization.k8s.io/pod-lister created role.rbac.authorization.k8s.io/controller created clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller created clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker created rolebinding.rbac.authorization.k8s.io/config-watcher created rolebinding.rbac.authorization.k8s.io/pod-lister created rolebinding.rbac.authorization.k8s.io/controller created daemonset.apps/speaker created deployment.apps/controller created # è¿™é‡Œä¸»è¦å°±æ˜¯éƒ¨ç½²äº†controllerè¿™ä¸ªdeploymentæ¥æ£€æŸ¥serviceçš„çŠ¶æ€ $ kubectl get deploy -n metallb-system NAME READY UP-TO-DATE AVAILABLE AGE controller 1/1 1 1 86s # speakeråˆ™æ˜¯ä½¿ç”¨dséƒ¨ç½²åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šé¢ç”¨æ¥åå•†VIPã€æ”¶å‘ARPã€NDPç­‰æ•°æ®åŒ… $ kubectl get ds -n metallb-system NAME DESIRED CURRENT READY UP-TO-DATE AVAILABLE NODE SELECTOR AGE speaker 3 3 3 3 3 kubernetes.io/os=linux 64s $ kubectl get pod -n metallb-system -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES controller-55bbcf48c8-qst68 1/1 Running 0 2d19h 172.20.28.118 node02 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; speaker-8wctf 1/1 Running 0 2d19h 192.168.102.41 node02 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; speaker-txdsv 1/1 Running 0 2d19h 192.168.102.30 master01 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; speaker-xdzrr 1/1 Running 0 2d19h 192.168.102.40 node01 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; $ kubectl apply -f configmap-layer2.yaml configmap/config created kubectl wait --for=condition=Ready pods --all -n metallb-system # pod/controller-57fd9c5bb-d5z9j condition met # pod/speaker-6hz2h condition met # pod/speaker-7pzb4 condition met # pod/speaker-trr9v condition met éƒ¨ç½²æµ‹è¯•æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 # mentallb/whoami.yaml apiVersion: apps/v1 kind: Deployment metadata: name: whoami labels: app: containous name: whoami spec: replicas: 2 selector: matchLabels: app: containous task: whoami template: metadata: labels: app: containous task: whoami spec: containers: - name: containouswhoami image: containous/whoami resources: ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: whoami spec: ports: - name: http port: 80 selector: app: containous task: whoami type: LoadBalancer æˆ–è€… nginx\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 apiVersion: apps/v1 kind: Deployment metadata: name: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.23-alpine ports: - name: http containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: nginx spec: #loadBalancerIP: x.y.z.a # æŒ‡å®šå…¬ç½‘IP ports: - name: http port: 80 protocol: TCP targetPort: 80 selector: app: nginx type: LoadBalancer å¯è§åˆ†é…çš„ EXTERNAL-IP ä¸º 192.168.102.52\nåˆ†åˆ«åœ¨è™šæ‹Ÿæœºå’Œå®¿ä¸»æœºè¯•è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 curl 192.168.102.52 [root@bt metallb]# curl 192.168.102.52 Hostname: whoami-665585b57c-kngqc IP: 127.0.0.1 IP: 172.20.28.123 RemoteAddr: 127.0.0.6:47635 GET / HTTP/1.1 Host: 192.168.102.52 User-Agent: curl/7.29.0 Accept: */* X-B3-Sampled: 1 X-B3-Spanid: 0268f13fd66b2858 X-B3-Traceid: c6984aca633971850268f13fd66b2858 X-Forwarded-Proto: http X-Request-Id: 6664e21c-b2d4-9abe-af63-6d79485cbdd8 è¿™æ—¶å¦‚æœä½  ping è¿™ä¸ª ip çš„è¯ï¼Œä¼šå‘ç°æ— æ³• ping é€š\nè¿™ä¸ªæ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªè™šæ‹ŸIPåœ°å€ï¼Œæ‰€ä»¥æ ¹æœ¬æ— æ³•ping é€šï¼ˆæ­¤è™šæ‹ŸIPä¸ç‰©ç†ç½‘å¡å…±ç”¨åŒä¸€ä¸ª MAC åœ°å€ï¼Œé‚£ä¹ˆè¿™ä¸ªIPæ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿåˆæ˜¯å¦‚ä½•æ”¶åˆ°æµé‡è¯·æ±‚çš„å‘¢ï¼Ÿå¾ˆå€¼å¾—æ€è€ƒï¼‰ã€‚\né‚£å¦‚ä½•æµ‹è¯•è¿™ä¸ªè™šæ‹ŸIPæ˜¯å¦èƒ½æ­£å¸¸æä¾›æœåŠ¡å‘¢ï¼Œå…¶å®åªéœ€è¦ä½¿ç”¨ telnet å‘½ä»¤å°±å¯ä»¥äº†ï¼Œå¦‚\n1 2 3 4 [root@bt metallb]# telnet 192.168.102.52 80 Trying 192.168.102.52... Connected to 192.168.102.52. Escape character is \u0026#39;^]\u0026#39;. æ³¨æ„ï¼š\næ³¨æ„ï¼šå¹¶éæ‰€æœ‰çš„LoadBalanceréƒ½å…è®¸è®¾ç½® loadBalancerIPã€‚\nå¦‚æœLoadBalanceræ”¯æŒè¯¥å­—æ®µï¼Œé‚£ä¹ˆå°†æ ¹æ®ç”¨æˆ·è®¾ç½®çš„ loadBalancerIP æ¥åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨ã€‚\nå¦‚æœæ²¡æœ‰è®¾ç½® loadBalancerIP å­—æ®µï¼Œå°†ä¼šç»™è´Ÿè½½å‡è¡¡å™¨æŒ‡æ´¾ä¸€ä¸ªä¸´æ—¶ IPã€‚\nå¦‚æœè®¾ç½®äº† loadBalancerIPï¼Œä½†LoadBalancerå¹¶ä¸æ”¯æŒè¿™ç§ç‰¹æ€§ï¼Œé‚£ä¹ˆè®¾ç½®çš„ loadBalancerIP å€¼å°†ä¼šè¢«å¿½ç•¥æ‰ã€‚\næˆ‘ä»¬åœ¨åˆ›å»ºLoadBalanceræœåŠ¡çš„æ—¶å€™ï¼Œé»˜è®¤æƒ…å†µä¸‹k8sä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªnodeportæœåŠ¡ï¼Œè¿™ä¸ªæ“ä½œå¯ä»¥é€šè¿‡æŒ‡å®šServiceä¸­çš„allocateLoadBalancerNodePortså­—æ®µæ¥å®šä¹‰å¼€å…³ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºtrue\nä¸åŒçš„loadbalancerå®ç°åŸç†ä¸åŒï¼Œæœ‰äº›æ˜¯éœ€è¦ä¾èµ–nodeportæ¥è¿›è¡Œæµé‡è½¬å‘ï¼Œæœ‰äº›åˆ™æ˜¯ç›´æ¥è½¬å‘è¯·æ±‚åˆ°podä¸­ã€‚å¯¹äºMetalLBè€Œè¨€ï¼Œæ˜¯é€šè¿‡kube-proxyå°†è¯·æ±‚çš„æµé‡ç›´æ¥è½¬å‘åˆ°podï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…³é—­nodeportçš„è¯å¯ä»¥ä¿®æ”¹serviceä¸­çš„spec.allocateLoadBalancerNodePortså­—æ®µï¼Œå°†å…¶è®¾ç½®ä¸ºfalseï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºsvcçš„æ—¶å€™å°±ä¸ä¼šåˆ†é…nodeportã€‚\nä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœæ˜¯å¯¹å·²æœ‰serviceè¿›è¡Œä¿®æ”¹ï¼Œå…³é—­nodeportï¼ˆä»trueæ”¹ä¸ºfalseï¼‰ï¼Œk8sä¸ä¼šè‡ªåŠ¨å»æ¸…é™¤å·²æœ‰çš„ipvsè§„åˆ™ï¼Œè¿™éœ€è¦æˆ‘ä»¬è‡ªè¡Œæ‰‹åŠ¨åˆ é™¤ã€‚\næˆ‘ä»¬é‡æ–°å®šä¹‰åˆ›å»ºä¸€ä¸ªsvc\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: v1 kind: Service metadata: name: nginx-lb-service namespace: nginx-quic spec: allocateLoadBalancerNodePorts: false externalTrafficPolicy: Cluster internalTrafficPolicy: Cluster selector: app: nginx-lb ports: - protocol: TCP port: 80 # match for service access port targetPort: 80 # match for pod access port type: LoadBalancer loadBalancerIP: 10.31.8.100 æ­¤æ—¶å†å»æŸ¥çœ‹å¯¹åº”çš„svcçŠ¶æ€å’Œipvsè§„åˆ™ä¼šå‘ç°å·²ç»æ²¡æœ‰nodeportç›¸å…³çš„é…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $ ipvsadm -ln IP Virtual Server version 1.2.1 (size=4096) Prot LocalAddress:Port Scheduler Flags -\u0026gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 10.8.62.180:80 rr -\u0026gt; 10.8.65.18:80 Masq 1 0 0 -\u0026gt; 10.8.65.19:80 Masq 1 0 0 -\u0026gt; 10.8.66.14:80 Masq 1 0 0 -\u0026gt; 10.8.66.15:80 Masq 1 0 0 TCP 10.31.8.100:80 rr -\u0026gt; 10.8.65.18:80 Masq 1 0 0 -\u0026gt; 10.8.65.19:80 Masq 1 0 0 -\u0026gt; 10.8.66.14:80 Masq 1 0 0 -\u0026gt; 10.8.66.15:80 Masq 1 0 0 $ kubectl get svc -n nginx-quic NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx-lb-service LoadBalancer 10.8.62.180 10.31.8.100 80/TCP 23s å¦‚æœæ˜¯æŠŠå·²æœ‰æœåŠ¡çš„spec.allocateLoadBalancerNodePortsä»trueæ”¹ä¸ºfalseï¼ŒåŸæœ‰çš„nodeportä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œå› æ­¤æœ€å¥½åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±è§„åˆ’å¥½ç›¸å…³å‚æ•°\n1 2 3 4 5 $ kubectl get svc -n nginx-quic nginx-lb-service -o yaml | egrep \u0026#34; allocateLoadBalancerNodePorts: \u0026#34; allocateLoadBalancerNodePorts: false $ kubectl get svc -n nginx-quic NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx-lb-service LoadBalancer 10.8.62.180 10.31.8.100 80:31405/TCP 85m å‚è€ƒæ–‡æ¡£ï¼š https://tinychen.com/20220519-k8s-06-loadbalancer-metallb https://juejin.cn/post/6906447786112516110\n","date":"2023-12-28T09:32:55Z","image":"https://www.ownit.top/title_pic/68.jpg","permalink":"https://www.ownit.top/p/202312280932/","title":"MetalLBï¼šæœ¬åœ°Kubernetesé›†ç¾¤çš„LoadBalancerè´Ÿè½½å‡è¡¡åˆ©å™¨"},{"content":"ä½¿ç”¨kubeadméƒ¨ç½²ä¸€å¥—Kubernetes v1.23.0é›†ç¾¤ 1ã€å‰ç½®çŸ¥è¯†ç‚¹ 1.1 ç”Ÿäº§ç¯å¢ƒå¯éƒ¨ç½²Kubernetesé›†ç¾¤çš„ä¸¤ç§æ–¹å¼ ç›®å‰ç”Ÿäº§éƒ¨ç½²Kubernetesé›†ç¾¤ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š\nâ€¢ kubeadm\nKubeadmæ˜¯ä¸€ä¸ªK8séƒ¨ç½²å·¥å…·ï¼Œæä¾›kubeadm initå’Œkubeadm joinï¼Œç”¨äºå¿«é€Ÿéƒ¨ç½²Kubernetesé›†ç¾¤ã€‚\nâ€¢ äºŒè¿›åˆ¶åŒ…\nä»githubä¸‹è½½å‘è¡Œç‰ˆçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰‹åŠ¨éƒ¨ç½²æ¯ä¸ªç»„ä»¶ï¼Œç»„æˆKubernetesé›†ç¾¤ã€‚\nè¿™é‡Œé‡‡ç”¨kubeadmæ­å»ºé›†ç¾¤ã€‚\nkubeadmå·¥å…·åŠŸèƒ½ï¼š\nâ€¢ kubeadm initï¼š åˆå§‹åŒ–ä¸€ä¸ªMasterèŠ‚ç‚¹\nâ€¢ kubeadm joinï¼š å°†å·¥ä½œèŠ‚ç‚¹åŠ å…¥é›†ç¾¤\nâ€¢ kubeadm upgradeï¼š å‡çº§K8sç‰ˆæœ¬\nâ€¢ kubeadm tokenï¼š ç®¡ç† kubeadm join ä½¿ç”¨çš„ä»¤ç‰Œ\nâ€¢ kubeadm resetï¼š æ¸…ç©º kubeadm init æˆ–è€… kubeadm join å¯¹ä¸»æœºæ‰€åšçš„ä»»ä½•æ›´æ”¹\nâ€¢ kubeadm versionï¼š æ‰“å° kubeadm ç‰ˆæœ¬\nâ€¢ kubeadm alphaï¼š é¢„è§ˆå¯ç”¨çš„æ–°åŠŸèƒ½\n1.2 å‡†å¤‡ç¯å¢ƒ æœåŠ¡å™¨è¦æ±‚ï¼š\nâ€¢ å»ºè®®æœ€å°ç¡¬ä»¶é…ç½®ï¼š2æ ¸CPUã€2Gå†…å­˜ã€20Gç¡¬ç›˜\nâ€¢ æœåŠ¡å™¨æœ€å¥½å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œä¼šæœ‰ä»ç½‘ä¸Šæ‹‰å–é•œåƒéœ€æ±‚ï¼Œå¦‚æœæœåŠ¡å™¨ä¸èƒ½ä¸Šç½‘ï¼Œéœ€è¦æå‰ä¸‹è½½å¯¹åº”é•œåƒå¹¶å¯¼å…¥èŠ‚ç‚¹\nè½¯ä»¶ç¯å¢ƒï¼š\nè½¯ä»¶ ç‰ˆæœ¬ æ“ä½œç³»ç»Ÿ CentOS7.9_x64 ï¼ˆminiï¼‰ Docker 20-ce Kubernetes 1.23 æœåŠ¡å™¨è§„åˆ’ï¼š\nè§’è‰² IP k8s-master 192.168.31.71 k8s-node1 192.168.31.72 k8s-node2 192.168.31.73 æ¶æ„å›¾ï¼š\nâ€‹\n1.3 æ“ä½œç³»ç»Ÿåˆå§‹åŒ–é…ç½®ã€æ‰€æœ‰èŠ‚ç‚¹ã€‘ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # å…³é—­é˜²ç«å¢™ systemctl stop firewalld systemctl disable firewalld # å…³é—­selinux sed -i \u0026#39;s/enforcing/disabled/\u0026#39; /etc/selinux/config # æ°¸ä¹… setenforce 0 # ä¸´æ—¶ # å…³é—­swap swapoff -a # ä¸´æ—¶ sed -ri \u0026#39;s/.*swap.*/#\u0026amp;/\u0026#39; /etc/fstab # æ°¸ä¹… # æ ¹æ®è§„åˆ’è®¾ç½®ä¸»æœºå hostnamectl set-hostname \u0026lt;hostname\u0026gt; # åœ¨masteræ·»åŠ hosts cat \u0026gt;\u0026gt; /etc/hosts \u0026lt;\u0026lt; EOF 192.168.31.71 k8s-master 192.168.31.72 k8s-node1 192.168.31.73 k8s-node2 EOF # å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾ cat \u0026gt; /etc/sysctl.d/k8s.conf \u0026lt;\u0026lt; EOF net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sysctl --system # ç”Ÿæ•ˆ # æ—¶é—´åŒæ­¥ yum install ntpdate -y ntpdate time.windows.com 2. å®‰è£…Docker/kubeadm/kubelet ã€æ‰€æœ‰èŠ‚ç‚¹ã€‘\nè¿™é‡Œä½¿ç”¨Dockerä½œä¸ºå®¹å™¨å¼•æ“ï¼Œä¹Ÿå¯ä»¥æ¢æˆåˆ«çš„ï¼Œä¾‹å¦‚containerd\n2.1 å®‰è£…Docker 1 2 3 wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo yum -y install docker-ce systemctl enable docker \u0026amp;\u0026amp; systemctl start docker é…ç½®é•œåƒä¸‹è½½åŠ é€Ÿå™¨ï¼š\n1 2 3 4 5 6 7 8 9 cat \u0026gt; /etc/docker/daemon.json \u0026lt;\u0026lt; EOF { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;https://b9pmyelo.mirror.aliyuncs.com\u0026#34;], \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;] } EOF systemctl restart docker docker info 2.2 æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº 1 2 3 4 5 6 7 8 9 cat \u0026gt; /etc/yum.repos.d/kubernetes.repo \u0026lt;\u0026lt; EOF [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF 2.3 å®‰è£…kubeadmï¼Œkubeletå’Œkubectl ç”±äºç‰ˆæœ¬æ›´æ–°é¢‘ç¹ï¼Œè¿™é‡ŒæŒ‡å®šç‰ˆæœ¬å·éƒ¨ç½²ï¼š\n1 2 yum install -y kubelet-1.23.0 kubeadm-1.23.0 kubectl-1.23.0 systemctl enable kubelet â€\n3. éƒ¨ç½²Kubernetes Master åœ¨192.168.31.71ï¼ˆMasterï¼‰æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 kubeadm init \\ --apiserver-advertise-address=192.168.31.71 \\ --image-repository registry.aliyuncs.com/google_containers \\ --kubernetes-version v1.23.0 \\ --service-cidr=10.96.0.0/12 \\ --pod-network-cidr=10.244.0.0/16 \\ --ignore-preflight-errors=all pod 172.20.20.0/20 svc 172.21.20.0/20 â€¢\t\u0026ndash;apiserver-advertise-address é›†ç¾¤é€šå‘Šåœ°å€\nâ€¢\t\u0026ndash;image-repository ç”±äºé»˜è®¤æ‹‰å–é•œåƒåœ°å€k8s.gcr.ioå›½å†…æ— æ³•è®¿é—®ï¼Œè¿™é‡ŒæŒ‡å®šé˜¿é‡Œäº‘é•œåƒä»“åº“åœ°å€\nâ€¢\t\u0026ndash;kubernetes-version K8sç‰ˆæœ¬ï¼Œä¸ä¸Šé¢å®‰è£…çš„ä¸€è‡´\nâ€¢\t\u0026ndash;service-cidr é›†ç¾¤å†…éƒ¨è™šæ‹Ÿç½‘ç»œï¼ŒPodç»Ÿä¸€è®¿é—®å…¥å£\nâ€¢\t\u0026ndash;pod-network-cidr Podç½‘ç»œï¼Œä¸ä¸‹é¢éƒ¨ç½²çš„CNIç½‘ç»œç»„ä»¶yamlä¸­ä¿æŒä¸€è‡´\nâ€\nåˆå§‹åŒ–å®Œæˆåï¼Œæœ€åä¼šè¾“å‡ºä¸€ä¸ªjoinå‘½ä»¤ï¼Œå…ˆè®°ä½ï¼Œä¸‹é¢ç”¨ã€‚\næ‹·è´kubectlä½¿ç”¨çš„è¿æ¥k8sè®¤è¯æ–‡ä»¶åˆ°é»˜è®¤è·¯å¾„ï¼š\n1 2 3 mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config æŸ¥çœ‹å·¥ä½œèŠ‚ç‚¹ï¼š\n1 2 3 kubectl get nodes NAME STATUS ROLES AGE VERSION localhost.localdomain NotReady control-plane,master 20s v1.23.0 æ³¨ï¼šç”±äºç½‘ç»œæ’ä»¶è¿˜æ²¡æœ‰éƒ¨ç½²ï¼Œè¿˜æ²¡æœ‰å‡†å¤‡å°±ç»ª NotReadyï¼Œå…ˆç»§ç»­\nå‚è€ƒèµ„æ–™ï¼š\nhttps://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/#config-file\nhttps://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#initializing-your-control-plane-node\n4. åŠ å…¥Kubernetes Node åœ¨192.168.31.72/73ï¼ˆNodeï¼‰æ‰§è¡Œã€‚\nå‘é›†ç¾¤æ·»åŠ æ–°èŠ‚ç‚¹ï¼Œæ‰§è¡Œåœ¨kubeadm initè¾“å‡ºçš„kubeadm joinå‘½ä»¤ï¼š\n1 2 kubeadm join 192.168.31.71:6443 --token 7gqt13.kncw9hg5085iwclx \\ --discovery-token-ca-cert-hash sha256:66fbfcf18649a5841474c2dc4b9ff90c02fc05de0798ed690e1754437be35a01 é»˜è®¤tokenæœ‰æ•ˆæœŸä¸º24å°æ—¶ï¼Œå½“è¿‡æœŸä¹‹åï¼Œè¯¥tokenå°±ä¸å¯ç”¨äº†ã€‚è¿™æ—¶å°±éœ€è¦é‡æ–°åˆ›å»ºtokenï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤å¿«æ·ç”Ÿæˆï¼š\n1 kubeadm token create --print-join-command å‚è€ƒèµ„æ–™ï¼šhttps://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/\n5. éƒ¨ç½²å®¹å™¨ç½‘ç»œï¼ˆCNIï¼‰ Calicoæ˜¯ä¸€ä¸ªçº¯ä¸‰å±‚çš„æ•°æ®ä¸­å¿ƒç½‘ç»œæ–¹æ¡ˆï¼Œæ˜¯ç›®å‰Kubernetesä¸»æµçš„ç½‘ç»œæ–¹æ¡ˆã€‚\nä¸‹è½½YAMLï¼š\n1 wget https://docs.projectcalico.org/manifests/calico.yaml ä¸‹è½½å®Œåè¿˜éœ€è¦ä¿®æ”¹é‡Œé¢å®šä¹‰Podç½‘ç»œï¼ˆCALICO_IPV4POOL_CIDRï¼‰ï¼Œä¸å‰é¢kubeadm\ninitçš„ \u0026ndash;pod-network-cidræŒ‡å®šçš„ä¸€æ ·ã€‚\nä¿®æ”¹å®Œåæ–‡ä»¶åï¼Œéƒ¨ç½²ï¼š\n1 2 kubectl apply -f calico.yaml kubectl get pods -n kube-system ç­‰Calico Podéƒ½Runningï¼ŒèŠ‚ç‚¹ä¹Ÿä¼šå‡†å¤‡å°±ç»ªã€‚\næ³¨ï¼šä»¥åæ‰€æœ‰yamlæ–‡ä»¶éƒ½åªåœ¨MasterèŠ‚ç‚¹æ‰§è¡Œã€‚\nå®‰è£…ç›®å½•ï¼š/etc/kubernetes/\nç»„ä»¶é…ç½®æ–‡ä»¶ç›®å½•ï¼š/etc/kubernetes/manifests/\nå‚è€ƒèµ„æ–™ï¼šhttps://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network\n6. éƒ¨ç½² Dashboard Dashboardæ˜¯å®˜æ–¹æä¾›çš„ä¸€ä¸ªUIï¼Œå¯ç”¨äºåŸºæœ¬ç®¡ç†K8sèµ„æºã€‚\nYAMLä¸‹è½½åœ°å€ï¼š\n1 https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml è¯¾ä»¶ä¸­æ–‡ä»¶åæ˜¯ï¼škubernetes-dashboard.yaml\né»˜è®¤Dashboardåªèƒ½é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œä¿®æ”¹Serviceä¸ºNodePortç±»å‹ï¼Œæš´éœ²åˆ°å¤–éƒ¨:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 vi recommended.yaml ... kind: Service apiVersion: v1 metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kubernetes-dashboard spec: ports: - port: 443 targetPort: 8443 nodePort: 30001 selector: k8s-app: kubernetes-dashboard type: NodePort ... kubectl apply -f recommended.yaml kubectl get pods -n kubernetes-dashboard è®¿é—®åœ°å€ï¼šhttps://NodeIP:30001\nåˆ›å»ºservice accountå¹¶ç»‘å®šé»˜è®¤cluster-adminç®¡ç†å‘˜é›†ç¾¤è§’è‰²ï¼š\n1 2 3 4 5 6 7 8 9 10 11 # åˆ›å»ºç”¨æˆ· kubectl create serviceaccount dashboard-admin -n kube-system # ç”¨æˆ·æˆæƒ kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin # è·å–ç”¨æˆ·Token kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk \u0026#39;/dashboard-admin/{print $1}\u0026#39;) ä½¿ç”¨è¾“å‡ºçš„tokenç™»å½•Dashboardã€‚\nâ€\n7.K8S ç½‘ç»œå’Œå±€åŸŸç½‘æ‰“é€š å‚è€ƒæ–‡æ¡£ï¼šåŠå…¬ç¯å¢ƒä¸‹ kubernetes ç½‘ç»œäº’é€šæ–¹æ¡ˆ\nåœ¨ kubernetes çš„ç½‘ç»œæ¨¡å‹ä¸­ï¼ŒåŸºäºå®˜æ–¹é»˜è®¤çš„ CNI ç½‘ç»œæ’ä»¶ Flannelï¼Œè¿™ç§ Overlay Networkï¼ˆè¦†ç›–ç½‘ç»œï¼‰å¯ä»¥è½»æ¾çš„å®ç° pod é—´ç½‘ç»œçš„äº’é€šã€‚å½“æˆ‘ä»¬æŠŠåŸºäº spring cloud çš„å¾®æœåŠ¡è¿ç§»åˆ° k8s ä¸­åï¼Œæ— é¡»ä»»ä½•æ”¹åŠ¨ï¼Œå¾®æœåŠ¡ pod å¯ä»¥é€šè¿‡ Eureka æ³¨å†Œåå¯ä»¥äº’ç›¸è½»æ¾è®¿é—®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ingress + ingress controller ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼ŒæŠŠåŸºäº http 80ç«¯å£ã€https 443ç«¯å£çš„ç”¨æˆ·è¯·æ±‚æµé‡å¼•å…¥åˆ°é›†ç¾¤æœåŠ¡ä¸­ã€‚\nä½†æ˜¯å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å‡ºç°äº†ä»¥ä¸‹éœ€æ±‚ï¼š\n1.åŠå…¬å®¤ç½‘ç»œ å’Œ k8s pod ç½‘ç»œä¸é€šã€‚å¼€å‘åœ¨ç”µè„‘å®ŒæˆæŸä¸ªå¾®æœåŠ¡æ¨¡å—å¼€å‘åï¼Œå¸Œæœ›æœ¬åœ°å¯åŠ¨åï¼Œèƒ½æ³¨å†Œåˆ° k8s ä¸­å¼€å‘ç¯å¢ƒçš„æœåŠ¡ä¸­å¿ƒè¿›è¡Œè°ƒè¯•ï¼Œè€Œä¸æ˜¯æœ¬åœ°èµ·ä¸€å †ä¾èµ–çš„æœåŠ¡ã€‚ 2.åŠå…¬å®¤ç½‘ç»œ å’Œ k8s svc ç½‘ç»œä¸é€šã€‚åœ¨ k8s ä¸­è¿è¡Œçš„ mysqlã€redis ç­‰ï¼Œæ— æ³•é€šè¿‡ ingress 7å±‚æš´éœ²ï¼Œç”µè„‘æ— æ³•é€šè¿‡å®¢æˆ·ç«¯å·¥å…·ç›´æ¥è®¿é—®ï¼›å¦‚æœæˆ‘ä»¬é€šè¿‡ service çš„ NodePort æ¨¡å¼ï¼Œä¼šå¯¼è‡´ç»´æŠ¤é‡å·¥ä½œé‡å·¨å¤§ã€‚ ç½‘ç»œäº’é€šé…ç½® k8s é›†ç¾¤ä¸­æ–°åŠ ä¸€å°é…ç½®ä¸é«˜ï¼ˆ2æ ¸4Gï¼‰çš„ node èŠ‚ç‚¹ï¼ˆnode-30ï¼‰ä¸“é—¨åšè·¯ç”±è½¬å‘ï¼Œè¿æ¥åŠå…¬å®¤ç½‘ç»œå’Œ k8s é›†ç¾¤ podã€svc\nnode-30 IP åœ°å€ 192.168.102.30 å†…ç½‘ DNS IP åœ°å€ 192.168.102.20 pod ç½‘æ®µ 172.20.20.0/20ï¼Œsvc ç½‘æ®µ 172.21.20.0/20 åŠå…¬ç½‘æ®µ 192.168.0.0/16 ç»™ node-30èŠ‚ç‚¹æ‰“ä¸Šæ±¡ç‚¹æ ‡ç­¾ï¼ˆtaintsï¼‰ï¼Œä¸è®© k8s è°ƒåº¦ pod æ¥å ç”¨èµ„æºï¼š\n1 kubectl taint nodes node-30 forward=node-30:NoSchedule node-30èŠ‚ç‚¹ï¼Œåšsnatï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 # å¼€å¯è½¬å‘ # vim /etc/sysctl.d/k8s.conf net.ipv4.ip_forward = 1 # sysctl -p (kubeadm init --apiserver-advertise-address=192.168.102.30 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.23.0 --service-cidr=172.21.20.0/20 --pod-network-cidr=172.20.20.0/20 --ignore-preflight-errors=all ) # æ¥è‡ªåŠå…¬å®¤è®¿é—®podã€service snat SVC iptables -t nat -A POSTROUTING -s 192.168.0.0/16 -d 172.21.20.0/20 -j MASQUERADE POD iptables -t nat -A POSTROUTING -s 192.168.0.0/16 -d 172.20.20.0/20 -j MASQUERADE åœ¨åŠå…¬å®¤çš„å‡ºå£è·¯ç”±å™¨ä¸Šï¼Œè®¾ç½®é™æ€è·¯ç”±ï¼Œå°† k8s pod å’Œ service çš„ç½‘æ®µï¼Œè·¯ç”±åˆ° node-30 èŠ‚ç‚¹ä¸Š\n1 2 3 4 5 6 7 8 9 è·¯ç”±å™¨ä¸Š ip route 172.20.0.0 255.255.255.0 192.168.102.30 ip route 172.21.0.0 255.255.255.0 192.168.102.30 Linuxä¸»æœº route add -net 172.20.20.0/20 gw 192.168.102.30 route add -net 172.21.20.0/20 gw 192.168.102.30 sudo ip route add 172.20.0.0/16 via 192.168.102.30 dev eth0 â€‹\nDNS è§£æé…ç½® ä»¥ä¸Šæ­¥éª¤æ“ä½œåï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æœ¬åœ°ç”µè„‘é€šè¿‡è®¿é—® pod ip å’Œ service ip å»è®¿é—®æœåŠ¡ã€‚ä½†æ˜¯åœ¨ k8s ä¸­ï¼Œç”±äº pod ip éšæ—¶éƒ½å¯èƒ½åœ¨å˜åŒ–ï¼Œservice ip ä¹Ÿä¸æ˜¯å¼€å‘ã€æµ‹è¯•èƒ½è½»æ¾è·å–åˆ°çš„ã€‚æˆ‘ä»¬å¸Œæœ›å†…ç½‘ DNS åœ¨è§£æ *.cluster.localï¼Œå»coreDNSå¯»æ‰¾è§£æç»“æœã€‚\nä¾‹å¦‚ï¼Œæˆ‘ä»¬çº¦å®šå°†ï¼ˆé¡¹ç›®A ã€å¼€å‘ç¯å¢ƒä¸€ ã€æ•°æ®åº“mysqlï¼‰éƒ¨ç½²åˆ° ProjectA-dev1 è¿™ä¸ª namespace ä¸‹ï¼Œç”±äºæœ¬åœ°åˆ° k8s é›†ç¾¤ service ç½‘ç»œå·²ç»æ‰“é€šï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°ç”µè„‘ä½¿ç”¨ mysql å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œåªéœ€è¦å¡«å†™mysql.ProjectA-dev1.svc.cluster.localå³å¯ï¼ŒDNS æŸ¥è¯¢è¯·æ±‚åˆ°äº†å†…ç½‘DNSåï¼Œèµ°å‘ CoreDNSï¼Œä»è€Œè§£æå‡º service ipã€‚\nç”±äºå†…ç½‘ DNS åœ¨è§£æ *.cluster.localï¼Œéœ€è¦è®¿é—® CoreDNS å¯»æ‰¾è§£æç»“æœã€‚è¿™å°±éœ€è¦ä¿è¯ç½‘ç»œå¯è¾¾\nâ€\næ–¹æ¡ˆä¸€ï¼Œ æœ€ç®€å•çš„åšæ³•ï¼Œæˆ‘ä»¬æŠŠå†…ç½‘DNSæ¶è®¾åœ¨node-30è¿™å°èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆä»–è‚¯å®šè®¿é—®åˆ°kube-dns 10.96.0.10\n1 2 # kubectl get svc -n kube-system |grep kube-dns kube-dns ClusterIP 10.96.0.10 \u0026lt;none\u0026gt; 53/UDP,53/TCP 20d æ–¹æ¡ˆäºŒï¼Œç”±äºæˆ‘ä»¬å®éªŒåœºæ™¯å†…ç½‘DNS IPåœ°å€ 192.168.102.20 ï¼Œå¹¶ä¸åœ¨node-30ä¸Šï¼Œæˆ‘ä»¬éœ€è¦æ‰“é€š192.168.102.20 è®¿é—® svcç½‘æ®µ172.21.20.0/20 å³å¯\n1 2 3 4 5 6 7 #å†…ç½‘DNSï¼ˆIP 192.168.102.20ï¼‰ æ·»åŠ é™æ€è·¯ç”± route add -net 172.21.0.0/16 gw 192.168.102.30 route add -net 172.20.0.0/16 gw 192.168.102.30 # node-30ï¼ˆIP 192.168.102.30ï¼‰ åšsnat iptables -t nat -A POSTROUTING -s 192.168.102.30 -d 172.21.0.0/16 -j MASQUERADE iptables -t nat -A POSTROUTING -s 192.168.102.30 -d 172.20.0.0/16 -j MASQUERADE æ–¹æ¡ˆä¸‰ï¼ˆå®éªŒé€‰æ‹©ï¼‰ï¼Œç”±äºæˆ‘ä»¬å®éªŒåœºæ™¯å†…ç½‘DNS IP 192.168.102.20 å¹¶ä¸åœ¨node-30ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç”¨nodeSelectoråœ¨node-30éƒ¨ç½² ä¸€ä¸ªnginx ingress controllerï¼Œ ç”¨4å±‚æš´éœ²å‡ºæ¥coredns çš„TCP/UDP 53ç«¯å£ã€‚ ","date":"2023-12-11T10:30:51Z","image":"https://www.ownit.top/title_pic/27.jpg","permalink":"https://www.ownit.top/p/202312111030/","title":"ä½¿ç”¨kubeadméƒ¨ç½²ä¸€å¥—Kubernetes v1.23.0é›†ç¾¤"},{"content":"Kuberneteså®‰è£…ingress-nginx 1 ã€Ingress ç®€ä»‹ 1.1 kubernetesè®¿é—®æ–¹å¼ åœ¨Kubernetesä¸­ï¼ŒæœåŠ¡å’ŒPodçš„IPåœ°å€ä»…å¯ä»¥åœ¨é›†ç¾¤ç½‘ç»œå†…éƒ¨ä½¿ç”¨ï¼Œå¯¹äºé›†ç¾¤å¤–çš„åº”ç”¨æ˜¯ä¸å¯è§çš„ã€‚ä¸ºäº†ä½¿å¤–éƒ¨çš„åº”ç”¨èƒ½å¤Ÿè®¿é—®é›†ç¾¤å†…çš„æœåŠ¡ï¼Œåœ¨Kubernetes ç›®å‰ æä¾›äº†ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆï¼š\nK8sé›†ç¾¤å¯¹å¤–æš´éœ²æœåŠ¡çš„æ–¹å¼ç›®å‰åªæœ‰ä¸‰ç§ï¼šLoadbalancerï¼›NodePortï¼›Ingress\nLoadbalancer ç¼ºç‚¹ï¼šéœ€è¦é˜¿é‡Œäº‘ç­‰å…¬æœ‰äº‘æ”¯æŒï¼Œè€Œä¸”éœ€è¦é¢å¤–æ”¯ä»˜è´¹ç”¨ NodePort ç¼ºç‚¹ï¼šè¦æš´éœ²ç«¯å£ï¼Œç«¯å£èŒƒå›´åªèƒ½æ˜¯ 30000-32767 Ingress å¥½å¤„ï¼šIngress ä¸ä¼šå…¬å¼€ä»»æ„ç«¯å£æˆ–åè®®ã€‚å¯èƒ½å°±æ˜¯å¸¦æ¥ä¸€äº›å­¦ä¹ æˆæœ¬ï¼Œéœ€è¦äº†è§£Traefikå’ŒNginxçš„å¸¸ç”¨é…ç½®å’Œåå‘ä»£ç†ã€‚ ä¸€å›¾çœ‹Ingressæµç¨‹,ç”±å›¾å¯çŸ¥ï¼Œingresså……å½“çš„æ˜¯ä»£ç†çš„è§’è‰²ï¼ŒæŠŠå¤–éƒ¨æ¥çš„è¯·æ±‚ï¼Œæ ¹æ®è·¯ç”±åœ°å€è½¬å‘åˆ°k8sä¸­åŒ¹é…åˆ°çš„åç«¯serviceï¼Œè€Œä¸”serviceåˆè¿æ¥äº†deploymentï¼Œä¸€ä¸ªdeploymentåˆè·‘äº†Nä¸ªPodï¼Œè¾¾åˆ°äº†æµé‡è½¬å‘çš„ç›®çš„ã€‚\nâ€\nserviceåªèƒ½é€šè¿‡å››å±‚è´Ÿè½½å°±æ˜¯ip+ç«¯å£çš„å½¢å¼æ¥æš´éœ²\nNodePortï¼šä¼šå ç”¨é›†ç¾¤æœºå™¨çš„å¾ˆå¤šç«¯å£ï¼Œå½“é›†ç¾¤æœåŠ¡å˜å¤šçš„æ—¶å€™ï¼Œè¿™ä¸ªç¼ºç‚¹å°±è¶Šå‘æ˜æ˜¾ LoadBalancerï¼šæ¯ä¸ªServiceéƒ½éœ€è¦ä¸€ä¸ªLBï¼Œæ¯”è¾ƒéº»çƒ¦å’Œæµªè´¹èµ„æºï¼Œå¹¶ä¸”éœ€è¦ k8sä¹‹å¤–çš„è´Ÿè½½å‡è¡¡è®¾å¤‡æ”¯æŒ ingresså¯ä»¥æä¾›7å±‚çš„è´Ÿè´£å¯¹å¤–æš´éœ²æ¥å£ï¼Œè€Œä¸”å¯ä»¥è°ƒåº¦ä¸åŒçš„ä¸šåŠ¡åŸŸï¼Œä¸åŒçš„urlè®¿é—®è·¯å¾„çš„ä¸šåŠ¡æµé‡ã€‚\nIngressï¼šK8s ä¸­çš„ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œä½œç”¨æ˜¯å®šä¹‰è¯·æ±‚å¦‚ä½•è½¬å‘åˆ° service çš„è§„åˆ™ Ingress Controllerï¼šå…·ä½“å®ç°åå‘ä»£ç†åŠè´Ÿè½½å‡è¡¡çš„ç¨‹åºï¼Œå¯¹Ingresså®šä¹‰çš„è§„åˆ™è¿›è¡Œè§£æï¼Œæ ¹æ®é…ç½®çš„è§„åˆ™æ¥å®ç°è¯·æ±‚è½¬å‘ï¼Œæœ‰å¾ˆå¤šç§å®ç°æ–¹å¼ï¼Œå¦‚ Nginxã€Contorã€Haproxyç­‰ â€\nâ€\n1.2 Ingress ç»„æˆ ingress controller\nå°†æ–°åŠ å…¥çš„Ingressè½¬åŒ–æˆNginxçš„é…ç½®æ–‡ä»¶å¹¶ä½¿ä¹‹ç”Ÿæ•ˆ\ningressæœåŠ¡\nå°†Nginxçš„é…ç½®æŠ½è±¡æˆä¸€ä¸ªIngresså¯¹è±¡ï¼Œæ¯æ·»åŠ ä¸€ä¸ªæ–°çš„æœåŠ¡åªéœ€å†™ä¸€ä¸ªæ–°çš„Ingressçš„yamlæ–‡ä»¶å³å¯\nâ€\n1.3 Ingress å·¥ä½œåŸç† 1.ingress controlleré€šè¿‡å’Œkubernetes apiäº¤äº’ï¼ŒåŠ¨æ€çš„å»æ„ŸçŸ¥é›†ç¾¤ä¸­ingressè§„åˆ™å˜åŒ–ï¼Œ\n2.ç„¶åè¯»å–å®ƒï¼ŒæŒ‰ç…§è‡ªå®šä¹‰çš„è§„åˆ™ï¼Œè§„åˆ™å°±æ˜¯å†™æ˜äº†å“ªä¸ªåŸŸåå¯¹åº”å“ªä¸ªserviceï¼Œç”Ÿæˆä¸€æ®µnginxé…ç½®ï¼Œ\n3.å†å†™åˆ°nginx-ingress-controlçš„podé‡Œï¼Œè¿™ä¸ªIngress controllerçš„podé‡Œè¿è¡Œç€ä¸€ä¸ªNginxæœåŠ¡ï¼Œæ§åˆ¶å™¨ä¼šæŠŠç”Ÿæˆçš„nginxé…ç½®å†™å…¥/etc/nginx.confæ–‡ä»¶ä¸­ï¼Œ\n4.ç„¶åreloadä¸€ä¸‹ä½¿é…ç½®ç”Ÿæ•ˆã€‚ä»¥æ­¤è¾¾åˆ°åŸŸååˆ†é…ç½®å’ŒåŠ¨æ€æ›´æ–°çš„é—®é¢˜ã€‚\nâ€‹\nç”¨æˆ·ç¼–å†™ Ingress Serviceè§„åˆ™ï¼Œ è¯´æ˜æ¯ä¸ªåŸŸåå¯¹åº” K8sé›†ç¾¤ä¸­çš„å“ªä¸ªService Ingressæ§åˆ¶å™¨ä¼šåŠ¨æ€æ„ŸçŸ¥åˆ° Ingress æœåŠ¡è§„åˆ™çš„å˜åŒ–ï¼Œç„¶åç”Ÿæˆä¸€æ®µå¯¹åº”çš„Nginxåå‘ä»£ç†é…ç½® Ingressæ§åˆ¶å™¨ä¼šå°†ç”Ÿæˆçš„Nginxé…ç½®å†™å…¥åˆ°ä¸€ä¸ªè¿è¡Œä¸­çš„NginxæœåŠ¡ä¸­ï¼Œå¹¶åŠ¨æ€æ›´æ–° ç„¶åå®¢æˆ·ç«¯é€šè¿‡è®¿é—®åŸŸåï¼Œå®é™…ä¸ŠNginxä¼šå°†è¯·æ±‚è½¬å‘åˆ°å…·ä½“çš„Podä¸­ï¼Œåˆ°æ­¤å°±å®Œæˆäº†æ•´ä¸ªè¯·æ±‚çš„è¿‡ç¨‹ â€‹\n1.4 Ingresså¯ä»¥è§£å†³ä»€ä¹ˆé—®é¢˜ 1.åŠ¨æ€é…ç½®æœåŠ¡\nå¦‚æœæŒ‰ç…§ä¼ ç»Ÿæ–¹å¼, å½“æ–°å¢åŠ ä¸€ä¸ªæœåŠ¡æ—¶, æˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨æµé‡å…¥å£åŠ ä¸€ä¸ªåå‘ä»£ç†æŒ‡å‘æˆ‘ä»¬æ–°çš„k8sæœåŠ¡. è€Œå¦‚æœç”¨äº†Ingress, åªéœ€è¦é…ç½®å¥½è¿™ä¸ªæœåŠ¡, å½“æœåŠ¡å¯åŠ¨æ—¶, ä¼šè‡ªåŠ¨æ³¨å†Œåˆ°Ingressçš„ä¸­, ä¸éœ€è¦è€Œå¤–çš„æ“ä½œ.\n2.å‡å°‘ä¸å¿…è¦çš„ç«¯å£æš´éœ²\né…ç½®è¿‡k8sçš„éƒ½æ¸…æ¥š, ç¬¬ä¸€æ­¥æ˜¯è¦å…³é—­é˜²ç«å¢™çš„, ä¸»è¦åŸå› æ˜¯k8sçš„å¾ˆå¤šæœåŠ¡ä¼šä»¥NodePortæ–¹å¼æ˜ å°„å‡ºå», è¿™æ ·å°±ç›¸å½“äºç»™å®¿ä¸»æœºæ‰“äº†å¾ˆå¤šå­”, æ—¢ä¸å®‰å…¨ä¹Ÿä¸ä¼˜é›…. è€ŒIngresså¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜, é™¤äº†Ingressè‡ªèº«æœåŠ¡å¯èƒ½éœ€è¦æ˜ å°„å‡ºå», å…¶ä»–æœåŠ¡éƒ½ä¸è¦ç”¨NodePortæ–¹å¼\n2 ã€éƒ¨ç½²é…ç½®Ingress 2.1 éƒ¨ç½²æ–‡ä»¶ä»‹ç»ã€å‡†å¤‡ https://kubernetes.github.io/ingress-nginx/deploy/\nç½‘ä¸Šçš„èµ„æ–™ä¸€èˆ¬æ˜¯åŸºäºv0.30.0æ¥å®‰è£…ï¼Œä½†æ˜¯å¯¹äºkubernetes@1.22æ¥è¯´è¦å®‰è£…ingress-nginx@v1.0.0ä»¥ä¸Šç‰ˆæœ¬ï¼ˆç›®å‰æœ€æ–°ç‰ˆæœ¬æ˜¯v1.0.4ï¼Œæœ¬æ–‡é‡‡ç”¨v1.0.0ï¼‰ï¼ŒåŸå› æ˜¯ kubectl@v1.22ç‰ˆæœ¬ä¸å†æ”¯æŒv1beta1\nå¦‚æœå®‰è£…ingress-nginx@v0.30.0ç‰ˆæœ¬åå¯åŠ¨podæœ‰å¦‚ä¸‹é—®é¢˜\n1 Failed to list *v1beta1.Ingress: the server could not find the requested resource æœ‰ä¸€ä¸ªç‰ˆæœ¬çš„æ”¯æŒæƒ…å†µï¼ˆhttps://github.com/kubernetes/ingress-nginx/ï¼‰\ningress å®˜æ–¹ç½‘ç«™ ingress ä»“åº“åœ°å€\ningress-nginx v1.0 æœ€æ–°ç‰ˆæœ¬ v1.0\né€‚ç”¨äº Kubernetes ç‰ˆæœ¬ v1.19+ ï¼ˆåŒ…æ‹¬ v1.19 ï¼‰\nKubernetes-v1.22+ éœ€è¦ä½¿ç”¨ ingress-nginx\u0026gt;=1.0ï¼Œå› ä¸ºnetworking.k8s.io/v1beta å·²ç»ç§»é™¤\nâ€‹\n2.2 ç›´æ¥éƒ¨ç½² ingress-nginx ç›´æ¥éƒ¨ç½²æ¯”è¾ƒç®€å•ï¼Œç›´æ¥æ‹‰å» girhub çš„æ–‡ä»¶å°±å¯ä»¥äº†ï¼Œå¦‚æœé‡åˆ°é•¿æ—¶é—´æ— å“åº”ï¼Œå¯ä»¥ç»ˆæ­¢ä»»åŠ¡ä»æ–°æ‹‰å–ã€‚\næ‹‰å–é•œåƒyamlæ–‡ä»¶\n1 2 3 4 5 wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.0.0/deploy/static/provider/baremetal/deploy.yaml #æ›´æ¢å›½å†…é•œåƒ sed -i \u0026#39;s@k8s.gcr.io/ingress-nginx/controller:v1.0.0\\(.*\\)@willdockerhub/ingress-nginx-controller:v1.0.0@\u0026#39; deploy.yaml sed -i \u0026#39;s@k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.0\\(.*\\)$@hzde0128/kube-webhook-certgen:v1.0@\u0026#39; deploy.yaml â€\n2.3 ä¼˜åŒ–yamlé…ç½®æ–‡ä»¶ 1ã€é»˜è®¤ ingress-nginx éšæœºæä¾› nodeport ç«¯å£ï¼Œå¼€å¯ hostNetwork å¯ç”¨80ã€443ç«¯å£ã€‚\nâ€\nâ€\néœ€è¦åœ¨åŸdeploy.yamlæ–‡ä»¶ä¸Šä¿®æ”¹ä¿®æ”¹åå†éƒ¨ç½²\nä¿®æ”¹ç‚¹å¦‚ä¸‹ 1ï¼šk8s.gcr.io/ingress-nginx/controller:v1.0.0@sha256:0851b34f69f69352bf168e6ccf30e1e20714a264ab1ecd1933e4d8c0fc3215c6 æ”¹ä¸ºï¼šwilldockerhub/ingress-nginx-controller:v1.0.0\n2ï¼šk8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.0@sha256:f3b6b39a6062328c095337b4cadcefd1612348fdd5190b1dcbcb9b9e90bd8068 æ”¹ä¸ºï¼šjettech/kube-webhook-certgen:v1.0.0\n#3ï¼šDeploymentä¿®æ”¹ç‚¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 template: metadata: labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller spec: dnsPolicy: ClusterFirstWithHostNet #æ—¢èƒ½ä½¿ç”¨å®¿ä¸»æœºDNSï¼Œåˆèƒ½ä½¿ç”¨é›†ç¾¤DNS åŸæ–‡lineï¼š319 hostNetwork: true #ä¸å®¿ä¸»æœºå…±äº«ç½‘ç»œ nodeName: k8s-master-1 #è®¾ç½®åªèƒ½åœ¨k8s-master-1èŠ‚ç‚¹è¿è¡Œ tolerations: #è®¾ç½®èƒ½å®¹å¿masteræ±¡ç‚¹ - key: node-role.kubernetes.io/master operator: Exists containers: - name: controller image: willdockerhub/ingress-nginx-controller:v1.0.0 imagePullPolicy: IfNotPresent å¦‚æœä¸å…³å¿ƒ ingressClass æˆ–è€…å¾ˆå¤šæ²¡æœ‰ ingressClass é…ç½®çš„ ingress å¯¹è±¡ï¼Œ æ·»åŠ å‚æ•° ingress-controller --watch-ingress-without-class=true ã€‚ ä¼˜åŒ–ä¸Šä¼ ç­‰å‚æ•° # Source: ingress-nginx/templates/controller-configmap.yaml apiVersion: v1 kind: ConfigMap metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginx data: # headeré»˜è®¤å¤§å°ä¸Šé™æ˜¯4kï¼Œè¶…è¿‡ä¼šè¿”å›400é”™è¯¯ client_header_buffer_size: \u0026#34;16k\u0026#34; large_client_header_buffers: \u0026#34;4 16k\u0026#34; # è¯·æ±‚ä½“é»˜è®¤å¤§å°ä¸Šé™æ˜¯1mï¼Œè¶…è¿‡ä¼šè¿”å›413é”™è¯¯ proxy-body-size: \u0026#34;10m\u0026#34; â€\nä¿®æ”¹åçš„yamlæ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 apiVersion: v1 kind: Namespace metadata: name: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx --- # Source: ingress-nginx/templates/controller-serviceaccount.yaml apiVersion: v1 kind: ServiceAccount metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginx automountServiceAccountToken: true --- # Source: ingress-nginx/templates/controller-configmap.yaml apiVersion: v1 kind: ConfigMap metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginx data: # headeré»˜è®¤å¤§å°ä¸Šé™æ˜¯4kï¼Œè¶…è¿‡ä¼šè¿”å›400é”™è¯¯ client_header_buffer_size: \u0026#34;16k\u0026#34; large_client_header_buffers: \u0026#34;4 16k\u0026#34; # è¯·æ±‚ä½“é»˜è®¤å¤§å°ä¸Šé™æ˜¯1mï¼Œè¶…è¿‡ä¼šè¿”å›413é”™è¯¯ proxy-body-size: \u0026#34;10m\u0026#34; --- # Source: ingress-nginx/templates/clusterrole.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm name: ingress-nginx rules: - apiGroups: - \u0026#39;\u0026#39; resources: - configmaps - endpoints - nodes - pods - secrets verbs: - list - watch - apiGroups: - \u0026#39;\u0026#39; resources: - nodes verbs: - get - apiGroups: - \u0026#39;\u0026#39; resources: - services verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch - apiGroups: - \u0026#39;\u0026#39; resources: - events verbs: - create - patch - apiGroups: - networking.k8s.io resources: - ingresses/status verbs: - update - apiGroups: - networking.k8s.io resources: - ingressclasses verbs: - get - list - watch --- # Source: ingress-nginx/templates/clusterrolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm name: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: ingress-nginx subjects: - kind: ServiceAccount name: ingress-nginx namespace: ingress-nginx --- # Source: ingress-nginx/templates/controller-role.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginx rules: - apiGroups: - \u0026#39;\u0026#39; resources: - namespaces verbs: - get - apiGroups: - \u0026#39;\u0026#39; resources: - configmaps - pods - secrets - endpoints verbs: - get - list - watch - apiGroups: - \u0026#39;\u0026#39; resources: - services verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses/status verbs: - update - apiGroups: - networking.k8s.io resources: - ingressclasses verbs: - get - list - watch - apiGroups: - \u0026#39;\u0026#39; resources: - configmaps resourceNames: - ingress-controller-leader verbs: - get - update - apiGroups: - \u0026#39;\u0026#39; resources: - configmaps verbs: - create - apiGroups: - \u0026#39;\u0026#39; resources: - events verbs: - create - patch --- # Source: ingress-nginx/templates/controller-rolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: ingress-nginx subjects: - kind: ServiceAccount name: ingress-nginx namespace: ingress-nginx --- # Source: ingress-nginx/templates/controller-service-webhook.yaml apiVersion: v1 kind: Service metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller-admission namespace: ingress-nginx spec: type: ClusterIP ports: - name: https-webhook port: 443 targetPort: webhook appProtocol: https selector: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller --- # Source: ingress-nginx/templates/controller-service.yaml apiVersion: v1 kind: Service metadata: annotations: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginx spec: type: ClusterIP ports: - name: http port: 80 protocol: TCP targetPort: http appProtocol: http - name: https port: 443 protocol: TCP targetPort: https appProtocol: https selector: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller --- # Source: ingress-nginx/templates/controller-deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginx spec: selector: matchLabels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller revisionHistoryLimit: 10 minReadySeconds: 0 template: metadata: labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller spec: hostNetwork: true dnsPolicy: ClusterFirstWithHostNet nodeName: node01 tolerations: - key: node-role.kubernetes.io/master operator: Exists containers: - name: controller image: willdockerhub/ingress-nginx-controller:v1.0.0 imagePullPolicy: IfNotPresent lifecycle: preStop: exec: command: - /wait-shutdown args: - /nginx-ingress-controller - --election-id=ingress-controller-leader - --controller-class=k8s.io/ingress-nginx - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller - --validating-webhook=:8443 - --validating-webhook-certificate=/usr/local/certificates/cert - --validating-webhook-key=/usr/local/certificates/key securityContext: capabilities: drop: - ALL add: - NET_BIND_SERVICE runAsUser: 101 allowPrivilegeEscalation: true env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace - name: LD_PRELOAD value: /usr/local/lib/libmimalloc.so livenessProbe: failureThreshold: 5 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 readinessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 ports: - name: http containerPort: 80 protocol: TCP - name: https containerPort: 443 protocol: TCP - name: webhook containerPort: 8443 protocol: TCP volumeMounts: - name: webhook-cert mountPath: /usr/local/certificates/ readOnly: true resources: requests: cpu: 100m memory: 90Mi nodeSelector: kubernetes.io/os: linux serviceAccountName: ingress-nginx terminationGracePeriodSeconds: 300 volumes: - name: webhook-cert secret: secretName: ingress-nginx-admission --- # Source: ingress-nginx/templates/controller-ingressclass.yaml # We don\u0026#39;t support namespaced ingressClass yet # So a ClusterRole and a ClusterRoleBinding is required apiVersion: networking.k8s.io/v1 kind: IngressClass metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: nginx namespace: ingress-nginx spec: controller: k8s.io/ingress-nginx --- # Source: ingress-nginx/templates/admission-webhooks/validating-webhook.yaml # before changing this value, check the required kubernetes version # https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#prerequisites apiVersion: admissionregistration.k8s.io/v1 kind: ValidatingWebhookConfiguration metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook name: ingress-nginx-admission webhooks: - name: validate.nginx.ingress.kubernetes.io matchPolicy: Equivalent rules: - apiGroups: - networking.k8s.io apiVersions: - v1 operations: - CREATE - UPDATE resources: - ingresses failurePolicy: Fail sideEffects: None admissionReviewVersions: - v1 clientConfig: service: namespace: ingress-nginx name: ingress-nginx-controller-admission path: /networking/v1/ingresses --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/serviceaccount.yaml apiVersion: v1 kind: ServiceAccount metadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrole.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: ingress-nginx-admission annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook rules: - apiGroups: - admissionregistration.k8s.io resources: - validatingwebhookconfigurations verbs: - get - update --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: ingress-nginx-admission annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: ingress-nginx-admission subjects: - kind: ServiceAccount name: ingress-nginx-admission namespace: ingress-nginx --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/role.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook rules: - apiGroups: - \u0026#39;\u0026#39; resources: - secrets verbs: - get - create --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/rolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: ingress-nginx-admission subjects: - kind: ServiceAccount name: ingress-nginx-admission namespace: ingress-nginx --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/job-createSecret.yaml apiVersion: batch/v1 kind: Job metadata: name: ingress-nginx-admission-create namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: template: metadata: name: ingress-nginx-admission-create labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: containers: - name: create image: hzde0128/kube-webhook-certgen:v1.0 imagePullPolicy: IfNotPresent args: - create - --host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc - --namespace=$(POD_NAMESPACE) - --secret-name=ingress-nginx-admission env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace restartPolicy: OnFailure serviceAccountName: ingress-nginx-admission nodeSelector: kubernetes.io/os: linux securityContext: runAsNonRoot: true runAsUser: 2000 --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/job-patchWebhook.yaml apiVersion: batch/v1 kind: Job metadata: name: ingress-nginx-admission-patch namespace: ingress-nginx annotations: helm.sh/hook: post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: template: metadata: name: ingress-nginx-admission-patch labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: containers: - name: patch image: hzde0128/kube-webhook-certgen:v1.0 imagePullPolicy: IfNotPresent args: - patch - --webhook-name=ingress-nginx-admission - --namespace=$(POD_NAMESPACE) - --patch-mutating=false - --secret-name=ingress-nginx-admission - --patch-failure-policy=Fail env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace restartPolicy: OnFailure serviceAccountName: ingress-nginx-admission nodeSelector: kubernetes.io/os: linux securityContext: runAsNonRoot: true runAsUser: 2000 å¼€å§‹æ‰§è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 $ kubectl apply -f deploy.yaml namespace/ingress-nginx created serviceaccount/ingress-nginx created configmap/ingress-nginx-controller created clusterrole.rbac.authorization.k8s.io/ingress-nginx created clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created role.rbac.authorization.k8s.io/ingress-nginx created rolebinding.rbac.authorization.k8s.io/ingress-nginx created service/ingress-nginx-controller-admission created service/ingress-nginx-controller created deployment.apps/ingress-nginx-controller created ingressclass.networking.k8s.io/nginx created validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created serviceaccount/ingress-nginx-admission created clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created role.rbac.authorization.k8s.io/ingress-nginx-admission created rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created job.batch/ingress-nginx-admission-create created job.batch/ingress-nginx-admission-patch created æŸ¥çœ‹ç”ŸæˆçŠ¶æ€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 [root@bt ingress]# kubectl get all -n ingress-nginx NAME READY STATUS RESTARTS AGE pod/ingress-nginx-admission-create-hdd2b 0/1 Completed 0 5d12h pod/ingress-nginx-admission-patch-4x2nj 0/1 Completed 1 5d12h pod/ingress-nginx-controller-6db5ddb4ff-jv4rr 1/1 Running 0 5d12h NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/ingress-nginx-controller ClusterIP 172.21.23.131 \u0026lt;none\u0026gt; 80/TCP,443/TCP 5d12h service/ingress-nginx-controller-admission ClusterIP 172.21.21.247 \u0026lt;none\u0026gt; 443/TCP 5d12h NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/ingress-nginx-controller 1/1 1 1 5d12h NAME DESIRED CURRENT READY AGE replicaset.apps/ingress-nginx-controller-6db5ddb4ff 1 1 1 5d12h NAME COMPLETIONS DURATION AGE job.batch/ingress-nginx-admission-create 1/1 3s 5d12h job.batch/ingress-nginx-admission-patch 1/1 4s 5d12h [root@bt ingress]# kubectl get endpoints -n ingress-nginx ingress-nginx-controller NAME ENDPOINTS AGE ingress-nginx-controller 192.168.102.40:443,192.168.102.40:80 5d12h [root@bt ingress]# kubectl get endpoints -n ingress-nginx ingress-nginx-controller-admission NAME ENDPOINTS AGE ingress-nginx-controller-admission 192.168.102.40:8443 5d12h è¿™ä¸ªæ—¶å€™ingress-nginxå°±å®‰è£…å®Œäº†ï¼Œåœ¨kubernetsä¹‹å¤–çš„æœºå™¨ä¸Šè®¿é—®æ¯ä¸ªèŠ‚ç‚¹ï¼Œnginxéƒ½å¯ä»¥è®¿é—®äº†ï¼Œå…ˆä¸ç”¨ç®¡404çš„é”™è¯¯\n1 2 3 4 5 6 7 8 9 [root@bt ingress]# curl http://node01 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;404 Not Found\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;404 Not Found\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; [root@bt ingress]# â€\n3ã€ æµ‹è¯•éªŒè¯ é…ç½®nginxç®€å•yamlæ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 apiVersion: apps/v1 kind: Deployment metadata: namespace: heian name: ingress-heian annotations: k8s.kuboard.cn/workload: ingress-heian deployment.kubernetes.io/revision: \u0026#39;1\u0026#39; k8s.kuboard.cn/service: ClusterIP k8s.kuboard.cn/ingress: \u0026#39;true\u0026#39; labels: app: ingress-heian spec: selector: matchLabels: app: ingress-heian revisionHistoryLimit: 10 template: metadata: labels: app: ingress-heian spec: affinity: {} securityContext: seLinuxOptions: {} imagePullSecrets: [] restartPolicy: Always initContainers: [] containers: - image: \u0026#39;wangyanglinux/myapp:v1\u0026#39; imagePullPolicy: IfNotPresent name: ingress-heian volumeMounts: - name: tz-config mountPath: /usr/share/zoneinfo/Asia/Shanghai - name: tz-config mountPath: /etc/localtime - name: timezone mountPath: /etc/timezone resources: limits: cpu: 100m memory: 100Mi requests: cpu: 10m memory: 10Mi env: - name: TZ value: Asia/Shanghai - name: LANG value: C.UTF-8 lifecycle: {} ports: - name: web containerPort: 80 protocol: TCP terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumes: - name: tz-config hostPath: path: /usr/share/zoneinfo/Asia/Shanghai type: \u0026#39;\u0026#39; - name: timezone hostPath: path: /etc/timezone type: \u0026#39;\u0026#39; dnsPolicy: ClusterFirst dnsConfig: options: [] schedulerName: default-scheduler terminationGracePeriodSeconds: 30 progressDeadlineSeconds: 600 strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 0 maxSurge: 1 replicas: 1 --- apiVersion: v1 kind: Service metadata: namespace: heian name: ingress-heian annotations: k8s.kuboard.cn/workload: ingress-heian labels: app: ingress-heian spec: selector: app: ingress-heian type: ClusterIP ports: - port: 80 targetPort: 80 protocol: TCP name: ingress-web-1 nodePort: 0 sessionAffinity: None --- apiVersion: networking.k8s.io/v1 kind: Ingress metadata: namespace: heian name: ingress-heian annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/proxy-body-size: \u0026#34;0\u0026#34; nginx.ingress.kubernetes.io/proxy-read-timeout: \u0026#34;600\u0026#34; nginx.ingress.kubernetes.io/proxy-send-timeout: \u0026#34;600\u0026#34; kubernetes.io/tls-acme: \u0026#34;true\u0026#34; cert-manager.io/cluster-issuer: \u0026#34;example-issuer\u0026#34; labels: app: ingress-heian spec: rules: - host: ingress.ownit.top #åŸŸå http: paths: - pathType: Prefix path: / backend: service: name: ingress-heian port: number: 80 æµ‹è¯•å®Œæˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 [root@bt heian]# kubectl get pod,svc,ingress -n heian NAME READY STATUS RESTARTS AGE pod/ingress-heian-7ff9cbd9d5-w5f7v 1/1 Running 0 5d NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/ingress-heian ClusterIP 172.21.24.68 \u0026lt;none\u0026gt; 80/TCP 5d NAME CLASS HOSTS ADDRESS PORTS AGE ingress.networking.k8s.io/ingress-heian \u0026lt;none\u0026gt; ingress.ownit.top 192.168.102.40 80 5d [root@bt heian]# curl https://ingress.ownit.top Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; [root@bt heian]# curl https://ingress.ownit.top/hostname.html ingress-heian-7ff9cbd9d5-w5f7v â€‹\n4ã€NGINXä½œä¸ºåå‘ä»£ç† 1ã€å®‰è£…nginx\n1 yum install nginx nginx-mod-stream -y 2ã€é…ç½®kubernetes-cluster.conf\n1 2 3 4 5 [root@bt nginx]# cat kubernetes-cluster.conf upstream kubernetes-cluster { server 192.168.102.40 weight=5; keepalive 16; } 3ã€é…ç½®ingressè®¿é—®æ¥å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 [root@bt nginx]# cat ingress.ownit.top.conf server { listen 80; server_name ingress.ownit.top; rewrite ^/(.*)$ https://$host/$1 permanent; # IPç™½åå• include /opt/nginx/whitelist/corporation.conf; } server { listen 443 ssl; server_name ingress.ownit.top; # IPç™½åå• include /opt/nginx/whitelist/corporation.conf; #ssl on; ssl_certificate /opt/nginx/ssl/ownit.top.crt; ssl_certificate_key /opt/nginx/ssl/ownit.top.key; include ssl.conf; location / { proxy_pass http://kubernetes-cluster; include https_proxy.conf; } access_log /www/wwwlogs/dns.ownit.top.log; error_log /www/wwwlogs/dns.ownit.top.error.log; } 4ã€åˆ™å¯ä»¥HTTPSè®¿é—®åˆ°k8sé‡Œé¢çš„ingressåŸŸå\nâ€‹\nâ€‹\nâ€\n","date":"2023-12-04T09:42:25Z","image":"https://www.ownit.top/title_pic/77.jpg","permalink":"https://www.ownit.top/p/202312040942/","title":"Kuberneteså®‰è£…ingress-nginx"},{"content":"Prometheusç›‘æ§Padavanè·¯ç”±å™¨ 1ã€èƒŒæ™¯ è¿‘æœŸåœ¨Synologyï¼ˆç¾¤è¾‰ï¼‰ä¸­å®‰è£…ä¸€å¥—Prometheusç›‘æ§ç¨‹åºï¼Œç›®å‰å·²ç»ç›‘æ§Synologyï¼Œç„¶åå®¶ä¸­æœ‰æœ‰è·¯ç”±å™¨ï¼ˆPadavanï¼‰å‹å·ï¼Œä¹Ÿå‡†å¤‡ä½¿ç”¨Prometheus+Grafanè¿›è¡Œç›‘æ§ã€‚\nâ€\nç¯å¢ƒï¼š\nPrometheusï¼š2.48.0\nGrafanï¼š10\nPadavanï¼šå›ºä»¶ç‰ˆæœ¬:3.4.3.9-099_22-05-1\nâ€‹â€‹\n2ã€ç›‘æ§æ­¥éª¤ â€\n1ã€padavan_exporter æ­£ç¡®ä½¿ç”¨ åœ°å€ï¼šhttps://github.com/Bpazy/padavan_exporter/blob/master/README-zh_CN.md\npadavan_exporteræœ‰ä¸¤ç§æ–¹å¼ï¼ˆä¸æ˜¯æ”¾åˆ°Padavanç³»ç»Ÿä¸Šçš„ï¼‰\nå®‰è£…åˆ°Linuxæ“ä½œç³»ç»Ÿï¼Œé€šè¿‡sshè¿æ¥åˆ°è·¯ç”±å™¨è¿›è¡Œæ•°æ®è·å– å®‰è£…åˆ°Dockerä¸Šï¼Œé€šè¿‡sshè¿æ¥åˆ°è·¯ç”±å™¨è¿›è¡Œæ•°æ®è·å– Linuxæ“ä½œç³»ç»Ÿ åœ¨Linuxæ“ä½œç³»ç»Ÿä¸‹è½½padavan_exporter\nå‚æ•°ä½¿ç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 $ ./padavan_exporter --help Flags: --help Show context-sensitive help (also try --help-long and --help-man). --web.listen-address=\u0026#34;:9100\u0026#34; Address on which to expose metrics and web interface --padavan.ssh.host=\u0026#34;127.0.0.1:22\u0026#34; Padavan ssh host --padavan.ssh.username=\u0026#34;admin\u0026#34; Padavan ssh username --padavan.ssh.password=\u0026#34;admin\u0026#34; Padavan ssh password --debug Debug mode å®‰è£… padavan_exporter å¹¶ä½¿ç”¨æ­£ç¡®çš„å‚æ•°å¯åŠ¨ï¼ˆç‚¹å‡»è·³è½¬é¡¹ç›®é¦–é¡µï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 wget https://github.com/Bpazy/padavan_exporter/releases/download/v0.0.2/padavan_exporter-linux-amd64-v0.0.2 sudo mv ./padavan_exporter-linux-amd64-v0.0.2 /usr/local/bin/padavan_exporter sudo chmod u=rwx,o=rx,g=rx /usr/local/bin/padavan_exporter sudo chgrp root /usr/local/bin/padavan_exporter sudo chown root /usr/local/bin/padavan_exporter # è‡ªå®šä¹‰ systemd service sudo touch /lib/systemd/system/padavan_exporter.service sudo cat \u0026lt;\u0026lt;EOF \u0026gt;/lib/systemd/system/padavan_exporter.service [Unit] Description=Node exporter After=network.target [Service] Type=simple ExecStart=/usr/local/bin/padavan_exporter --padavan.ssh.host=\u0026#34;127.0.0.1:22\u0026#34; --padavan.ssh.username=\u0026#34;admin\u0026#34; --padavan.ssh.password=\u0026#34;admin\u0026#34; Restart=on-failure [Install] WantedBy=multi-user.target EOF # åŠ è½½è‡ªå®šä¹‰çš„ service sudo systemctl daemon-reload # å¼€æœºè‡ªå¯ sudo systemctl enable padavan_exporter # å¯åŠ¨ sudo systemctl start padavan_exporter â€\nDocker Composeï¼ˆæ¨èï¼‰ å½“ç„¶æ›´å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨ Docker Composeï¼Œä½ å¯ä»¥å‚è€ƒæœ¬é¡¹ç›®é¢„ç½®çš„ docker-compose.yml æ–‡ä»¶ã€‚\nâ€\næ­¤å¤„è¦æ³¨æ„ï¼Œæˆ‘æŠŠ9100ç«¯å£ æ˜ å°„åˆ° 9101ï¼Œå› ä¸º æˆ‘çš„ 9100ç«¯å£å·²ç»è¢«å ç”¨ï¼Œä½ ä»¬è¦æ³¨æ„\n1 2 3 4 5 6 7 8 version: \u0026#39;3\u0026#39; services: padavan_exporter: image: bpazy/padavan_exporter:latest restart: always ports: - \u0026#34;9101:9100\u0026#34; command: [\u0026#34;--padavan.ssh.host=192.168.123.1:22\u0026#34;, \u0026#34;--padavan.ssh.username=admin\u0026#34;, \u0026#34;--padavan.ssh.password=admin\u0026#34;] â€‹â€‹\næµ‹è¯•æ•°æ® â€‹â€‹\nPrometheusä¿®æ”¹é…ç½®é‡è½½ 1 2 3 4 - job_name: \u0026#39;padavan\u0026#39; static_configs: - targets: [\u0026#39;192.168.123.200:9101\u0026#39;] 2ã€Grafana å¯¼å…¥å›¾å½¢ â€\nè¿™ä¸ªå›¾åœ¨Dashboard: https://grafana.com/grafana/dashboards/15978 è¿›è¡Œä¿®æ”¹ æ ¹è¡¥å……\nâ€‹â€‹\nå¦‚æœå¯¼å…¥æ²¡æ•°æ®ï¼Œè¯·ç¼–è¾‘ ç„¶ååœ¨Prometheusä¸Šè¿›è¡Œè°ƒè¯• ä¸‹è½½Jsonæ–‡ä»¶å¯¼å…¥ Padavan-1701611865144.json\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 { \u0026#34;__inputs\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;DS_PROMETHEUS\u0026#34;, \u0026#34;label\u0026#34;: \u0026#34;Prometheus\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;datasource\u0026#34;, \u0026#34;pluginId\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;pluginName\u0026#34;: \u0026#34;Prometheus\u0026#34; } ], \u0026#34;__elements\u0026#34;: {}, \u0026#34;__requires\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;grafana\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;grafana\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;Grafana\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;10.2.2\u0026#34; }, { \u0026#34;type\u0026#34;: \u0026#34;panel\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;graph\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;Graph (old)\u0026#34; }, { \u0026#34;type\u0026#34;: \u0026#34;datasource\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;Prometheus\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;1.0.0\u0026#34; }, { \u0026#34;type\u0026#34;: \u0026#34;panel\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;timeseries\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;Time series\u0026#34; } ], \u0026#34;annotations\u0026#34;: { \u0026#34;list\u0026#34;: [ { \u0026#34;builtIn\u0026#34;: 1, \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;datasource\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;grafana\u0026#34; }, \u0026#34;enable\u0026#34;: true, \u0026#34;hide\u0026#34;: true, \u0026#34;iconColor\u0026#34;: \u0026#34;rgba(0, 211, 255, 1)\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;Annotations \u0026amp; Alerts\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;dashboard\u0026#34; } ] }, \u0026#34;description\u0026#34;: \u0026#34;Padavan exporter\u0026#39;s Dashboard å—å®«ä¹˜é£ fix \u0026#34;, \u0026#34;editable\u0026#34;: true, \u0026#34;fiscalYearStartMonth\u0026#34;: 0, \u0026#34;gnetId\u0026#34;: 15978, \u0026#34;graphTooltip\u0026#34;: 2, \u0026#34;id\u0026#34;: null, \u0026#34;links\u0026#34;: [ { \u0026#34;asDropdown\u0026#34;: false, \u0026#34;icon\u0026#34;: \u0026#34;external link\u0026#34;, \u0026#34;includeVars\u0026#34;: false, \u0026#34;keepTime\u0026#34;: false, \u0026#34;tags\u0026#34;: [], \u0026#34;targetBlank\u0026#34;: false, \u0026#34;title\u0026#34;: \u0026#34;å¦‚æœä¸æ˜¾ç¤ºæ•°æ®ï¼Œè¯·æ‰‹åŠ¨ä¿®æ”¹ é¡µé¢ä¸­çš„æ ‡ç­¾æ•°æ®ï¼ˆè¯·ç‚¹å‡»ï¼Œè¯·æŸ¥è¯¢åšå®¢æ•™ç¨‹ï¼‰\u0026#34;, \u0026#34;tooltip\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;link\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;https://blog.csdn.net/heian_99\u0026#34; } ], \u0026#34;liveNow\u0026#34;: false, \u0026#34;panels\u0026#34;: [ { \u0026#34;collapsed\u0026#34;: false, \u0026#34;gridPos\u0026#34;: { \u0026#34;h\u0026#34;: 1, \u0026#34;w\u0026#34;: 24, \u0026#34;x\u0026#34;: 0, \u0026#34;y\u0026#34;: 0 }, \u0026#34;id\u0026#34;: 9, \u0026#34;panels\u0026#34;: [], \u0026#34;title\u0026#34;: \u0026#34;åŸºç¡€ä¿¡æ¯\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;row\u0026#34; }, { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;fieldConfig\u0026#34;: { \u0026#34;defaults\u0026#34;: { \u0026#34;color\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;palette-classic\u0026#34; }, \u0026#34;custom\u0026#34;: { \u0026#34;axisBorderShow\u0026#34;: true, \u0026#34;axisCenteredZero\u0026#34;: false, \u0026#34;axisColorMode\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;axisLabel\u0026#34;: \u0026#34;è´Ÿè½½\u0026#34;, \u0026#34;axisPlacement\u0026#34;: \u0026#34;auto\u0026#34;, \u0026#34;barAlignment\u0026#34;: 0, \u0026#34;drawStyle\u0026#34;: \u0026#34;line\u0026#34;, \u0026#34;fillOpacity\u0026#34;: 0, \u0026#34;gradientMode\u0026#34;: \u0026#34;none\u0026#34;, \u0026#34;hideFrom\u0026#34;: { \u0026#34;legend\u0026#34;: false, \u0026#34;tooltip\u0026#34;: false, \u0026#34;viz\u0026#34;: false }, \u0026#34;insertNulls\u0026#34;: false, \u0026#34;lineInterpolation\u0026#34;: \u0026#34;linear\u0026#34;, \u0026#34;lineWidth\u0026#34;: 2, \u0026#34;pointSize\u0026#34;: 5, \u0026#34;scaleDistribution\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;linear\u0026#34; }, \u0026#34;showPoints\u0026#34;: \u0026#34;auto\u0026#34;, \u0026#34;spanNulls\u0026#34;: false, \u0026#34;stacking\u0026#34;: { \u0026#34;group\u0026#34;: \u0026#34;A\u0026#34;, \u0026#34;mode\u0026#34;: \u0026#34;none\u0026#34; }, \u0026#34;thresholdsStyle\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;off\u0026#34; } }, \u0026#34;decimals\u0026#34;: 2, \u0026#34;mappings\u0026#34;: [], \u0026#34;thresholds\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;absolute\u0026#34;, \u0026#34;steps\u0026#34;: [ { \u0026#34;color\u0026#34;: \u0026#34;green\u0026#34;, \u0026#34;value\u0026#34;: null }, { \u0026#34;color\u0026#34;: \u0026#34;red\u0026#34;, \u0026#34;value\u0026#34;: 80 } ] } }, \u0026#34;overrides\u0026#34;: [] }, \u0026#34;gridPos\u0026#34;: { \u0026#34;h\u0026#34;: 9, \u0026#34;w\u0026#34;: 11, \u0026#34;x\u0026#34;: 0, \u0026#34;y\u0026#34;: 1 }, \u0026#34;id\u0026#34;: 15, \u0026#34;options\u0026#34;: { \u0026#34;legend\u0026#34;: { \u0026#34;calcs\u0026#34;: [ \u0026#34;max\u0026#34;, \u0026#34;min\u0026#34;, \u0026#34;mean\u0026#34; ], \u0026#34;displayMode\u0026#34;: \u0026#34;table\u0026#34;, \u0026#34;placement\u0026#34;: \u0026#34;bottom\u0026#34;, \u0026#34;showLegend\u0026#34;: true }, \u0026#34;tooltip\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;multi\u0026#34;, \u0026#34;sort\u0026#34;: \u0026#34;none\u0026#34; } }, \u0026#34;targets\u0026#34;: [ { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;expr\u0026#34;: \u0026#34;node_load1{job=\\\u0026#34;padavan\\\u0026#34;}\u0026#34;, \u0026#34;instant\u0026#34;: false, \u0026#34;legendFormat\u0026#34;: \u0026#34;1åˆ†é’Ÿè´Ÿè½½\u0026#34;, \u0026#34;range\u0026#34;: true, \u0026#34;refId\u0026#34;: \u0026#34;A\u0026#34; }, { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;expr\u0026#34;: \u0026#34;node_load5{job=\\\u0026#34;padavan\\\u0026#34;}\u0026#34;, \u0026#34;hide\u0026#34;: false, \u0026#34;instant\u0026#34;: false, \u0026#34;legendFormat\u0026#34;: \u0026#34;5åˆ†é’Ÿè´Ÿè½½\u0026#34;, \u0026#34;range\u0026#34;: true, \u0026#34;refId\u0026#34;: \u0026#34;B\u0026#34; }, { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;expr\u0026#34;: \u0026#34;node_load15{job=\\\u0026#34;padavan\\\u0026#34;}\u0026#34;, \u0026#34;hide\u0026#34;: false, \u0026#34;instant\u0026#34;: false, \u0026#34;legendFormat\u0026#34;: \u0026#34;15åˆ†é’Ÿè´Ÿè½½\u0026#34;, \u0026#34;range\u0026#34;: true, \u0026#34;refId\u0026#34;: \u0026#34;C\u0026#34; } ], \u0026#34;title\u0026#34;: \u0026#34;è®¾å¤‡è´Ÿè½½\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;timeseries\u0026#34; }, { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;description\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;fieldConfig\u0026#34;: { \u0026#34;defaults\u0026#34;: { \u0026#34;color\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;palette-classic\u0026#34; }, \u0026#34;custom\u0026#34;: { \u0026#34;axisBorderShow\u0026#34;: false, \u0026#34;axisCenteredZero\u0026#34;: false, \u0026#34;axisColorMode\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;axisLabel\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;axisPlacement\u0026#34;: \u0026#34;auto\u0026#34;, \u0026#34;barAlignment\u0026#34;: 0, \u0026#34;drawStyle\u0026#34;: \u0026#34;line\u0026#34;, \u0026#34;fillOpacity\u0026#34;: 25, \u0026#34;gradientMode\u0026#34;: \u0026#34;none\u0026#34;, \u0026#34;hideFrom\u0026#34;: { \u0026#34;legend\u0026#34;: false, \u0026#34;tooltip\u0026#34;: false, \u0026#34;viz\u0026#34;: false }, \u0026#34;insertNulls\u0026#34;: false, \u0026#34;lineInterpolation\u0026#34;: \u0026#34;smooth\u0026#34;, \u0026#34;lineStyle\u0026#34;: { \u0026#34;fill\u0026#34;: \u0026#34;solid\u0026#34; }, \u0026#34;lineWidth\u0026#34;: 1, \u0026#34;pointSize\u0026#34;: 5, \u0026#34;scaleDistribution\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;linear\u0026#34; }, \u0026#34;showPoints\u0026#34;: \u0026#34;auto\u0026#34;, \u0026#34;spanNulls\u0026#34;: false, \u0026#34;stacking\u0026#34;: { \u0026#34;group\u0026#34;: \u0026#34;A\u0026#34;, \u0026#34;mode\u0026#34;: \u0026#34;none\u0026#34; }, \u0026#34;thresholdsStyle\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;off\u0026#34; } }, \u0026#34;fieldMinMax\u0026#34;: true, \u0026#34;mappings\u0026#34;: [], \u0026#34;min\u0026#34;: 0, \u0026#34;thresholds\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;absolute\u0026#34;, \u0026#34;steps\u0026#34;: [ { \u0026#34;color\u0026#34;: \u0026#34;green\u0026#34;, \u0026#34;value\u0026#34;: null }, { \u0026#34;color\u0026#34;: \u0026#34;red\u0026#34;, \u0026#34;value\u0026#34;: 80 } ] }, \u0026#34;unit\u0026#34;: \u0026#34;percent\u0026#34; }, \u0026#34;overrides\u0026#34;: [] }, \u0026#34;gridPos\u0026#34;: { \u0026#34;h\u0026#34;: 9, \u0026#34;w\u0026#34;: 12, \u0026#34;x\u0026#34;: 11, \u0026#34;y\u0026#34;: 1 }, \u0026#34;id\u0026#34;: 14, \u0026#34;options\u0026#34;: { \u0026#34;legend\u0026#34;: { \u0026#34;calcs\u0026#34;: [ \u0026#34;max\u0026#34;, \u0026#34;min\u0026#34;, \u0026#34;mean\u0026#34; ], \u0026#34;displayMode\u0026#34;: \u0026#34;table\u0026#34;, \u0026#34;placement\u0026#34;: \u0026#34;bottom\u0026#34;, \u0026#34;showLegend\u0026#34;: true }, \u0026#34;tooltip\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;multi\u0026#34;, \u0026#34;sort\u0026#34;: \u0026#34;none\u0026#34; } }, \u0026#34;targets\u0026#34;: [ { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;expr\u0026#34;: \u0026#34;100- (\\r\\n (\\r\\n sum without (mode) (rate(node_cpu_seconds_total{job=\\\u0026#34;padavan\\\u0026#34;, cpu=\\\u0026#34;cpu\\\u0026#34;}[5m]))\\r\\n -\\r\\n sum without (mode) (rate(node_cpu_seconds_total{job=\\\u0026#34;padavan\\\u0026#34;,cpu=\\\u0026#34;cpu\\\u0026#34;, mode=\\\u0026#34;idle\\\u0026#34;}[5m]))\\r\\n ) / \\r\\n sum without (mode) (rate(node_cpu_seconds_total{job=\\\u0026#34;padavan\\\u0026#34;,cpu=\\\u0026#34;cpu\\\u0026#34;}[5m]))\\r\\n) * 100\u0026#34;, \u0026#34;instant\u0026#34;: false, \u0026#34;legendFormat\u0026#34;: \u0026#34;cpuä½¿ç”¨ç‡\u0026#34;, \u0026#34;range\u0026#34;: true, \u0026#34;refId\u0026#34;: \u0026#34;A\u0026#34; } ], \u0026#34;title\u0026#34;: \u0026#34;CPUä½¿ç”¨ç‡\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;timeseries\u0026#34; }, { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;description\u0026#34;: \u0026#34;1Hè·¯ç”±å™¨æ•°æ®\u0026#34;, \u0026#34;fieldConfig\u0026#34;: { \u0026#34;defaults\u0026#34;: { \u0026#34;color\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;palette-classic\u0026#34; }, \u0026#34;custom\u0026#34;: { \u0026#34;axisBorderShow\u0026#34;: true, \u0026#34;axisCenteredZero\u0026#34;: false, \u0026#34;axisColorMode\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;axisLabel\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;axisPlacement\u0026#34;: \u0026#34;auto\u0026#34;, \u0026#34;barAlignment\u0026#34;: 0, \u0026#34;drawStyle\u0026#34;: \u0026#34;bars\u0026#34;, \u0026#34;fillOpacity\u0026#34;: 100, \u0026#34;gradientMode\u0026#34;: \u0026#34;hue\u0026#34;, \u0026#34;hideFrom\u0026#34;: { \u0026#34;legend\u0026#34;: false, \u0026#34;tooltip\u0026#34;: false, \u0026#34;viz\u0026#34;: false }, \u0026#34;insertNulls\u0026#34;: false, \u0026#34;lineInterpolation\u0026#34;: \u0026#34;linear\u0026#34;, \u0026#34;lineWidth\u0026#34;: 1, \u0026#34;pointSize\u0026#34;: 5, \u0026#34;scaleDistribution\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;linear\u0026#34; }, \u0026#34;showPoints\u0026#34;: \u0026#34;auto\u0026#34;, \u0026#34;spanNulls\u0026#34;: false, \u0026#34;stacking\u0026#34;: { \u0026#34;group\u0026#34;: \u0026#34;A\u0026#34;, \u0026#34;mode\u0026#34;: \u0026#34;percent\u0026#34; }, \u0026#34;thresholdsStyle\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;off\u0026#34; } }, \u0026#34;decimals\u0026#34;: 2, \u0026#34;fieldMinMax\u0026#34;: false, \u0026#34;mappings\u0026#34;: [], \u0026#34;thresholds\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;absolute\u0026#34;, \u0026#34;steps\u0026#34;: [ { \u0026#34;color\u0026#34;: \u0026#34;green\u0026#34;, \u0026#34;value\u0026#34;: null }, { \u0026#34;color\u0026#34;: \u0026#34;red\u0026#34;, \u0026#34;value\u0026#34;: 80 } ] }, \u0026#34;unit\u0026#34;: \u0026#34;bytes\u0026#34; }, \u0026#34;overrides\u0026#34;: [] }, \u0026#34;gridPos\u0026#34;: { \u0026#34;h\u0026#34;: 9, \u0026#34;w\u0026#34;: 11, \u0026#34;x\u0026#34;: 0, \u0026#34;y\u0026#34;: 10 }, \u0026#34;id\u0026#34;: 8, \u0026#34;options\u0026#34;: { \u0026#34;legend\u0026#34;: { \u0026#34;calcs\u0026#34;: [], \u0026#34;displayMode\u0026#34;: \u0026#34;list\u0026#34;, \u0026#34;placement\u0026#34;: \u0026#34;bottom\u0026#34;, \u0026#34;showLegend\u0026#34;: true }, \u0026#34;tooltip\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;multi\u0026#34;, \u0026#34;sort\u0026#34;: \u0026#34;none\u0026#34; } }, \u0026#34;pluginVersion\u0026#34;: \u0026#34;10.2.2\u0026#34;, \u0026#34;targets\u0026#34;: [ { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;expr\u0026#34;: \u0026#34;increase(node_network_receive_bytes_total{job=\\\u0026#34;padavan\\\u0026#34;,device=~\u0026#39;br0|eth2.2\u0026#39;}[1h])\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;time_series\u0026#34;, \u0026#34;interval\u0026#34;: \u0026#34;30m\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;{{device}} ä¸‹è½½\u0026#34;, \u0026#34;range\u0026#34;: true, \u0026#34;refId\u0026#34;: \u0026#34;A\u0026#34; }, { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;exemplar\u0026#34;: false, \u0026#34;expr\u0026#34;: \u0026#34;increase(node_network_transmit_bytes_total{job=\\\u0026#34;padavan\\\u0026#34;,device=~\u0026#39;eth2|br0|eth2.2\u0026#39;}[1h])\u0026#34;, \u0026#34;interval\u0026#34;: \u0026#34;30m\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;{{device}} ä¸Šä¼ \u0026#34;, \u0026#34;range\u0026#34;: true, \u0026#34;refId\u0026#34;: \u0026#34;B\u0026#34; } ], \u0026#34;title\u0026#34;: \u0026#34;1Hè·¯ç”±å™¨æ•°æ®\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;timeseries\u0026#34; }, { \u0026#34;aliasColors\u0026#34;: {}, \u0026#34;bars\u0026#34;: false, \u0026#34;dashLength\u0026#34;: 10, \u0026#34;dashes\u0026#34;: false, \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;description\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;fieldConfig\u0026#34;: { \u0026#34;defaults\u0026#34;: { \u0026#34;links\u0026#34;: [] }, \u0026#34;overrides\u0026#34;: [] }, \u0026#34;fill\u0026#34;: 1, \u0026#34;fillGradient\u0026#34;: 0, \u0026#34;gridPos\u0026#34;: { \u0026#34;h\u0026#34;: 9, \u0026#34;w\u0026#34;: 12, \u0026#34;x\u0026#34;: 11, \u0026#34;y\u0026#34;: 10 }, \u0026#34;hiddenSeries\u0026#34;: false, \u0026#34;id\u0026#34;: 4, \u0026#34;legend\u0026#34;: { \u0026#34;avg\u0026#34;: false, \u0026#34;current\u0026#34;: false, \u0026#34;max\u0026#34;: false, \u0026#34;min\u0026#34;: false, \u0026#34;show\u0026#34;: true, \u0026#34;total\u0026#34;: false, \u0026#34;values\u0026#34;: false }, \u0026#34;lines\u0026#34;: true, \u0026#34;linewidth\u0026#34;: 1, \u0026#34;nullPointMode\u0026#34;: \u0026#34;null\u0026#34;, \u0026#34;options\u0026#34;: { \u0026#34;alertThreshold\u0026#34;: true }, \u0026#34;percentage\u0026#34;: false, \u0026#34;pluginVersion\u0026#34;: \u0026#34;10.2.2\u0026#34;, \u0026#34;pointradius\u0026#34;: 2, \u0026#34;points\u0026#34;: false, \u0026#34;renderer\u0026#34;: \u0026#34;flot\u0026#34;, \u0026#34;seriesOverrides\u0026#34;: [ { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:250\u0026#34;, \u0026#34;alias\u0026#34;: \u0026#34;ppp0 receive rate\u0026#34;, \u0026#34;color\u0026#34;: \u0026#34;#5794F2\u0026#34;, \u0026#34;fill\u0026#34;: 0, \u0026#34;yaxis\u0026#34;: 2 }, { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:251\u0026#34;, \u0026#34;alias\u0026#34;: \u0026#34;ppp0 receive total\u0026#34;, \u0026#34;color\u0026#34;: \u0026#34;#B877D9\u0026#34; } ], \u0026#34;spaceLength\u0026#34;: 10, \u0026#34;stack\u0026#34;: false, \u0026#34;steppedLine\u0026#34;: false, \u0026#34;targets\u0026#34;: [ { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;expr\u0026#34;: \u0026#34;increase(node_network_receive_bytes_total{job=\\\u0026#34;padavan\\\u0026#34;, device=~\\\u0026#34;eth2.2|br0\\\u0026#34;}[1000w])\u0026#34;, \u0026#34;interval\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;{{device}} æ¥æ”¶æ€»æ•°\u0026#34;, \u0026#34;range\u0026#34;: true, \u0026#34;refId\u0026#34;: \u0026#34;A\u0026#34; }, { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;expr\u0026#34;: \u0026#34;rate(node_network_receive_bytes_total{device=~\\\u0026#34;eth2.2|br0\\\u0026#34;, job=\\\u0026#34;padavan\\\u0026#34;}[1m])\u0026#34;, \u0026#34;interval\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;{{device}} æ¥æ”¶é€Ÿç‡\u0026#34;, \u0026#34;range\u0026#34;: true, \u0026#34;refId\u0026#34;: \u0026#34;B\u0026#34; } ], \u0026#34;thresholds\u0026#34;: [], \u0026#34;timeRegions\u0026#34;: [], \u0026#34;title\u0026#34;: \u0026#34;ç½‘ç»œä¸‹è½½æ€»è®¡\u0026#34;, \u0026#34;tooltip\u0026#34;: { \u0026#34;shared\u0026#34;: true, \u0026#34;sort\u0026#34;: 0, \u0026#34;value_type\u0026#34;: \u0026#34;individual\u0026#34; }, \u0026#34;type\u0026#34;: \u0026#34;graph\u0026#34;, \u0026#34;xaxis\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;time\u0026#34;, \u0026#34;show\u0026#34;: true, \u0026#34;values\u0026#34;: [] }, \u0026#34;yaxes\u0026#34;: [ { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:268\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;decbytes\u0026#34;, \u0026#34;label\u0026#34;: \u0026#34;Receive Total\u0026#34;, \u0026#34;logBase\u0026#34;: 1, \u0026#34;show\u0026#34;: true }, { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:269\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;Bps\u0026#34;, \u0026#34;label\u0026#34;: \u0026#34;Receive Rate\u0026#34;, \u0026#34;logBase\u0026#34;: 1, \u0026#34;show\u0026#34;: true } ], \u0026#34;yaxis\u0026#34;: { \u0026#34;align\u0026#34;: false } }, { \u0026#34;aliasColors\u0026#34;: {}, \u0026#34;bars\u0026#34;: false, \u0026#34;dashLength\u0026#34;: 10, \u0026#34;dashes\u0026#34;: false, \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;description\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;fieldConfig\u0026#34;: { \u0026#34;defaults\u0026#34;: { \u0026#34;links\u0026#34;: [] }, \u0026#34;overrides\u0026#34;: [] }, \u0026#34;fill\u0026#34;: 1, \u0026#34;fillGradient\u0026#34;: 0, \u0026#34;gridPos\u0026#34;: { \u0026#34;h\u0026#34;: 9, \u0026#34;w\u0026#34;: 11, \u0026#34;x\u0026#34;: 0, \u0026#34;y\u0026#34;: 19 }, \u0026#34;hiddenSeries\u0026#34;: false, \u0026#34;id\u0026#34;: 6, \u0026#34;legend\u0026#34;: { \u0026#34;avg\u0026#34;: false, \u0026#34;current\u0026#34;: false, \u0026#34;max\u0026#34;: false, \u0026#34;min\u0026#34;: false, \u0026#34;show\u0026#34;: true, \u0026#34;total\u0026#34;: false, \u0026#34;values\u0026#34;: false }, \u0026#34;lines\u0026#34;: true, \u0026#34;linewidth\u0026#34;: 1, \u0026#34;nullPointMode\u0026#34;: \u0026#34;null\u0026#34;, \u0026#34;options\u0026#34;: { \u0026#34;alertThreshold\u0026#34;: true }, \u0026#34;percentage\u0026#34;: false, \u0026#34;pluginVersion\u0026#34;: \u0026#34;10.2.2\u0026#34;, \u0026#34;pointradius\u0026#34;: 2, \u0026#34;points\u0026#34;: false, \u0026#34;renderer\u0026#34;: \u0026#34;flot\u0026#34;, \u0026#34;seriesOverrides\u0026#34;: [ { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:824\u0026#34;, \u0026#34;alias\u0026#34;: \u0026#34;ppp0 download bandwidth\u0026#34;, \u0026#34;color\u0026#34;: \u0026#34;#5794F2\u0026#34; }, { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:825\u0026#34;, \u0026#34;alias\u0026#34;: \u0026#34;ppp0 upload bandwidth\u0026#34;, \u0026#34;color\u0026#34;: \u0026#34;#73BF69\u0026#34; } ], \u0026#34;spaceLength\u0026#34;: 10, \u0026#34;stack\u0026#34;: false, \u0026#34;steppedLine\u0026#34;: false, \u0026#34;targets\u0026#34;: [ { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;expr\u0026#34;: \u0026#34;rate(node_network_transmit_bytes_total{device=~\\\u0026#34;eth2.2|br0\\\u0026#34;, job=\\\u0026#34;padavan\\\u0026#34;}[1m])*8\u0026#34;, \u0026#34;instant\u0026#34;: false, \u0026#34;interval\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;{{device}} ä¸Šä¼ \u0026#34;, \u0026#34;refId\u0026#34;: \u0026#34;A\u0026#34; }, { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;expr\u0026#34;: \u0026#34;rate(node_network_receive_bytes_total{device=~\\\u0026#34;eth2.2|br0\\\u0026#34;, job=\\\u0026#34;padavan\\\u0026#34;}[1m])*8\u0026#34;, \u0026#34;instant\u0026#34;: false, \u0026#34;interval\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;{{device}} ä¸‹è½½\u0026#34;, \u0026#34;refId\u0026#34;: \u0026#34;B\u0026#34; } ], \u0026#34;thresholds\u0026#34;: [], \u0026#34;timeRegions\u0026#34;: [], \u0026#34;title\u0026#34;: \u0026#34;ç½‘ç»œå¸¦å®½\u0026#34;, \u0026#34;tooltip\u0026#34;: { \u0026#34;shared\u0026#34;: true, \u0026#34;sort\u0026#34;: 0, \u0026#34;value_type\u0026#34;: \u0026#34;individual\u0026#34; }, \u0026#34;type\u0026#34;: \u0026#34;graph\u0026#34;, \u0026#34;xaxis\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;time\u0026#34;, \u0026#34;show\u0026#34;: true, \u0026#34;values\u0026#34;: [] }, \u0026#34;yaxes\u0026#34;: [ { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:838\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;decbits\u0026#34;, \u0026#34;label\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;logBase\u0026#34;: 1, \u0026#34;show\u0026#34;: true }, { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:839\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;short\u0026#34;, \u0026#34;label\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;logBase\u0026#34;: 1, \u0026#34;show\u0026#34;: false } ], \u0026#34;yaxis\u0026#34;: { \u0026#34;align\u0026#34;: false } }, { \u0026#34;aliasColors\u0026#34;: {}, \u0026#34;bars\u0026#34;: false, \u0026#34;dashLength\u0026#34;: 10, \u0026#34;dashes\u0026#34;: false, \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;fieldConfig\u0026#34;: { \u0026#34;defaults\u0026#34;: { \u0026#34;links\u0026#34;: [] }, \u0026#34;overrides\u0026#34;: [] }, \u0026#34;fill\u0026#34;: 1, \u0026#34;fillGradient\u0026#34;: 0, \u0026#34;gridPos\u0026#34;: { \u0026#34;h\u0026#34;: 9, \u0026#34;w\u0026#34;: 12, \u0026#34;x\u0026#34;: 11, \u0026#34;y\u0026#34;: 19 }, \u0026#34;hiddenSeries\u0026#34;: false, \u0026#34;id\u0026#34;: 2, \u0026#34;legend\u0026#34;: { \u0026#34;avg\u0026#34;: false, \u0026#34;current\u0026#34;: false, \u0026#34;max\u0026#34;: false, \u0026#34;min\u0026#34;: false, \u0026#34;show\u0026#34;: true, \u0026#34;total\u0026#34;: false, \u0026#34;values\u0026#34;: false }, \u0026#34;lines\u0026#34;: true, \u0026#34;linewidth\u0026#34;: 1, \u0026#34;nullPointMode\u0026#34;: \u0026#34;null\u0026#34;, \u0026#34;options\u0026#34;: { \u0026#34;alertThreshold\u0026#34;: true }, \u0026#34;percentage\u0026#34;: false, \u0026#34;pluginVersion\u0026#34;: \u0026#34;10.2.2\u0026#34;, \u0026#34;pointradius\u0026#34;: 2, \u0026#34;points\u0026#34;: false, \u0026#34;renderer\u0026#34;: \u0026#34;flot\u0026#34;, \u0026#34;seriesOverrides\u0026#34;: [ { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:723\u0026#34;, \u0026#34;alias\u0026#34;: \u0026#34;ppp0 transmit rate\u0026#34;, \u0026#34;color\u0026#34;: \u0026#34;#73BF69\u0026#34;, \u0026#34;fill\u0026#34;: 0, \u0026#34;yaxis\u0026#34;: 2 }, { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:724\u0026#34;, \u0026#34;alias\u0026#34;: \u0026#34;ppp0 transmit total\u0026#34;, \u0026#34;color\u0026#34;: \u0026#34;#B877D9\u0026#34; } ], \u0026#34;spaceLength\u0026#34;: 10, \u0026#34;stack\u0026#34;: false, \u0026#34;steppedLine\u0026#34;: false, \u0026#34;targets\u0026#34;: [ { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;expr\u0026#34;: \u0026#34;increase(node_network_transmit_bytes_total{job=\\\u0026#34;padavan\\\u0026#34;, device=~\\\u0026#34;eth2.2|br0\\\u0026#34;}[1000w])\u0026#34;, \u0026#34;interval\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;{{device}} ä¸Šä¼ æ€»è®¡\u0026#34;, \u0026#34;range\u0026#34;: true, \u0026#34;refId\u0026#34;: \u0026#34;A\u0026#34; }, { \u0026#34;datasource\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;prometheus\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;${DS_PROMETHEUS}\u0026#34; }, \u0026#34;editorMode\u0026#34;: \u0026#34;code\u0026#34;, \u0026#34;expr\u0026#34;: \u0026#34;rate(node_network_transmit_bytes_total{device=~\\\u0026#34;eth2.2|br0\\\u0026#34;, job=\\\u0026#34;padavan\\\u0026#34;}[1m])\u0026#34;, \u0026#34;interval\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;{{device}} ä¸Šä¼ é€Ÿç‡\u0026#34;, \u0026#34;range\u0026#34;: true, \u0026#34;refId\u0026#34;: \u0026#34;B\u0026#34; } ], \u0026#34;thresholds\u0026#34;: [], \u0026#34;timeRegions\u0026#34;: [], \u0026#34;title\u0026#34;: \u0026#34;ç½‘ç»œä¸Šä¼ æ€»è®¡\u0026#34;, \u0026#34;tooltip\u0026#34;: { \u0026#34;shared\u0026#34;: true, \u0026#34;sort\u0026#34;: 0, \u0026#34;value_type\u0026#34;: \u0026#34;individual\u0026#34; }, \u0026#34;type\u0026#34;: \u0026#34;graph\u0026#34;, \u0026#34;xaxis\u0026#34;: { \u0026#34;mode\u0026#34;: \u0026#34;time\u0026#34;, \u0026#34;show\u0026#34;: true, \u0026#34;values\u0026#34;: [] }, \u0026#34;yaxes\u0026#34;: [ { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:741\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;decbytes\u0026#34;, \u0026#34;label\u0026#34;: \u0026#34;Transmit Total\u0026#34;, \u0026#34;logBase\u0026#34;: 1, \u0026#34;show\u0026#34;: true }, { \u0026#34;$$hashKey\u0026#34;: \u0026#34;object:742\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;Bps\u0026#34;, \u0026#34;label\u0026#34;: \u0026#34;Transmit Rate\u0026#34;, \u0026#34;logBase\u0026#34;: 1, \u0026#34;show\u0026#34;: true } ], \u0026#34;yaxis\u0026#34;: { \u0026#34;align\u0026#34;: false, \u0026#34;alignLevel\u0026#34;: 0 } } ], \u0026#34;refresh\u0026#34;: \u0026#34;10s\u0026#34;, \u0026#34;schemaVersion\u0026#34;: 38, \u0026#34;tags\u0026#34;: [ \u0026#34;jokersy\u0026#34; ], \u0026#34;templating\u0026#34;: { \u0026#34;list\u0026#34;: [] }, \u0026#34;time\u0026#34;: { \u0026#34;from\u0026#34;: \u0026#34;now-1h\u0026#34;, \u0026#34;to\u0026#34;: \u0026#34;now\u0026#34; }, \u0026#34;timepicker\u0026#34;: { \u0026#34;refresh_intervals\u0026#34;: [ \u0026#34;10s\u0026#34;, \u0026#34;30s\u0026#34;, \u0026#34;1m\u0026#34;, \u0026#34;5m\u0026#34;, \u0026#34;15m\u0026#34;, \u0026#34;30m\u0026#34;, \u0026#34;1h\u0026#34;, \u0026#34;2h\u0026#34;, \u0026#34;1d\u0026#34; ] }, \u0026#34;timezone\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;title\u0026#34;: \u0026#34;Padavan\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;5BoX3my7z\u0026#34;, \u0026#34;version\u0026#34;: 30, \u0026#34;weekStart\u0026#34;: \u0026#34;\u0026#34; } ","date":"2023-12-03T22:16:28Z","image":"https://www.ownit.top/title_pic/70.jpg","permalink":"https://www.ownit.top/p/202312032216/","title":"ä½¿ç”¨Prometheusç›‘æ§Padavanè·¯ç”±å™¨"},{"content":"1ã€ç®€ä»‹ åœ¨ç°ä»£çš„ITç¯å¢ƒä¸­ï¼Œå¯¹äºæœåŠ¡å™¨å’Œç½‘ç»œè®¾å¤‡çš„ç›‘æ§æ˜¯è‡³å…³é‡è¦çš„ã€‚Synologyï¼ˆç¾¤è¾‰ï¼‰ä½œä¸ºä¸€ç§æµè¡Œçš„ç½‘ç»œå­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œä¸ºç”¨æˆ·æä¾›äº†é«˜æ€§èƒ½å’Œå¯é çš„å­˜å‚¨æœåŠ¡ã€‚ç„¶è€Œï¼Œäº†è§£Synologyè®¾å¤‡çš„è¿è¡ŒçŠ¶å†µå’Œæ€§èƒ½æŒ‡æ ‡å¯¹äºç¡®ä¿å…¶æ­£å¸¸è¿è¡Œå’ŒåŠæ—¶é‡‡å–æªæ–½è‡³å…³é‡è¦ã€‚\nPrometheusæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¼€æºç›‘æ§ç³»ç»Ÿï¼Œå®ƒæä¾›äº†çµæ´»çš„æ•°æ®æ¨¡å‹å’Œä¸°å¯Œçš„æŸ¥è¯¢è¯­è¨€ï¼Œå¯ç”¨äºæ”¶é›†ã€å­˜å‚¨å’Œå¯è§†åŒ–å„ç§åº”ç”¨ç¨‹åºå’Œè®¾å¤‡çš„ç›‘æ§æŒ‡æ ‡ã€‚é€šè¿‡å°†Prometheusä¸Synologyï¼ˆç¾¤è¾‰ï¼‰é›†æˆï¼Œæ‚¨å¯ä»¥å®æ—¶ç›‘æ§Synologyï¼ˆSnmpåè®®ï¼‰è®¾å¤‡çš„å…³é”®æŒ‡æ ‡ï¼Œå¦‚CPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨ç‡ã€ç£ç›˜ç©ºé—´ã€ç½‘ç»œæµé‡ç­‰ï¼Œä»¥ä¾¿åŠæ—¶å‘ç°é—®é¢˜å¹¶é‡‡å–é€‚å½“çš„æªæ–½ã€‚ 2ã€ç¯å¢ƒå‡†å¤‡ Synologyï¼ˆç¾¤è¾‰ï¼‰ï¼š7.2 .1 prometheusï¼š2.48.0 Grafan ï¼š10 Snmp_exporter: 0.22.0 (æ³¨æ„ç‰ˆæœ¬ï¼šæ–°ç‰ˆæœ¬é…ç½®å˜æ›´)\nSnmpç‰ˆæœ¬é—®é¢˜ï¼šhttps://github.com/prometheus/snmp_exporter/blob/main/auth-split-migration.md ä»snmp_exporter v0.23.0 ç‰ˆæœ¬å¼€å§‹ï¼Œé…ç½®æ–‡ä»¶æ ¼å¼snmp_exporterå·²æ›´æ”¹ã€‚v0.22.0 åŠä¹‹å‰ç‰ˆæœ¬çš„é…ç½®æ–‡ä»¶å°†ä¸èµ·ä½œç”¨ 3ã€Synologyé…ç½® 1ã€å¼€å¯SNMPåè®® 2ã€å®‰è£…Docker åœ¨å¥—ä»¶ä¸­å¿ƒï¼Œç›´æ¥æœç´¢ â€œdockerâ€ è¿›è¡Œå®‰è£… 7.0 å’Œ 6.0 çš„ç‰ˆæœ¬ä¸ä¸€æ · 7.0 3ã€Node-Exporter å®‰è£… Node-Exporter æ˜¯ç›‘æ§ Synologyçš„åº•å±‚ç³»ç»Ÿï¼Œç›¸å½“äºLinuxæ“ä½œç³»ç»Ÿï¼Œ è¿™ä¸ªå¯ä»¥ä½¿ç”¨dockerçš„é•œåƒå®‰è£…ï¼Œä¸è¿‡è¿™é‡Œ å¤§ä½¬å·²ç»å°è£…å¥½æ’ä»¶ï¼Œç›´æ¥ä½¿ç”¨ã€‚ æ·»åŠ æº\n1 2 https://spk7.imnks.com/ http://spk.bobohome.store:8880 4ã€Dockerå®‰è£…ç»„ä»¶ å‚è€ƒï¼š https://github.com/ddiiwoong/synology-prometheus Dockerç›®å½•ä¸‹ï¼Œåˆ›å»ºmonitorç›®å½•ï¼Œåç»­çš„é…ç½®å­˜æ”¾é‡Œé¢ 1ã€Snmp_exporter å®‰è£… æˆ‘ä½¿ç”¨dockerfile è¿›è¡Œå®‰è£… snmpçš„æ–‡ä»¶ï¼šhttps://github.com/ddiiwoong/synology-prometheus/blob/master/snmp-synology/snmp.yml\n1 2 3 4 5 6 7 8 9 10 11 version: \u0026#34;3.8\u0026#34; services: snmp-exporter: image: ricardbejarano/snmp_exporter:0.22.0 container_name: snmp_exporter volumes: - ./snmp-synology/snmp.yml:/etc/snmp_exporter/snmp.yml ports: - 9116:9116 command: - \u0026#34;--config.file=/etc/snmp_exporter/snmp.yml\u0026#34; å¯åŠ¨æˆåŠŸ æµ‹è¯• 2ã€Prometheuså®‰è£… è¿™æ¬¡æˆ‘æ‰ç”¨sshåˆ°nasç³»ç»Ÿï¼Œç›´æ¥æ‰§è¡Œå‘½ä»¤è¿›è¡Œåˆ›å»º prometheus.yml é…ç½®æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 global: scrape_interval: 15s evaluation_interval: 15s alerting: alertmanagers: - static_configs: - targets: [\u0026#39;alertmanager:9093\u0026#39;] rule_files: - \u0026#34;/etc/prometheus/rules/*\u0026#34; scrape_configs: - job_name: \u0026#39;prometheus\u0026#39; static_configs: - targets: [\u0026#39;localhost:9090\u0026#39;] labels: group: \u0026#39;prometheus\u0026#39; - job_name: node static_configs: - targets: [\u0026#39;192.168.123.200:9100\u0026#39;] - job_name: \u0026#39;snmp\u0026#39; metrics_path: /snmp static_configs: - targets: - 192.168.123.200 params: module: [synology] relabel_configs: - source_labels: [__address__] target_label: __param_target - source_labels: [__param_target] target_label: instance - target_label: __address__ replacement: 192.168.123.200:9116 æ”¾åˆ°æŒ‡å®šä½ç½®,ç„¶ååˆ›å»ºprometheus\n1 2 3 4 5 6 7 8 9 docker run -d -p 9090:9090 -u root \\ -v /volume1/docker/monitor/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml \\ -v /volume1/docker/monitor/prometheus/rules:/etc/prometheus/rules \\ -v /volume1/docker/monitor/prometheus/data:/etc/prometheus/data \\ --name prometheus \\ prom/prometheus:latest \\ --storage.tsdb.path=/etc/prometheus/data \\ --storage.tsdb.retention.time=90d \\ --config.file=/etc/prometheus/prometheus.yml 3ã€Grafanå®‰è£… å‚è€ƒæ–‡æ¡£ï¼šhttps://blog.csdn.net/wayne_primes/article/details/112467639\n1 2 3 4 5 6 7 8 9 10 docker run \\ -d --name grafana -p 3000:3000 \\ grafana/grafana grafana å°†é…ç½®æ–‡ä»¶æ‹·è´è‡³å®¿ä¸»æœºæ–¹ä¾¿ä¿®æ”¹é…ç½® docker exec -it grafana cat /etc/grafana/grafana.ini \u0026gt; /data/grafana/grafana.ini mkdir -p /data/grafana/data #ä¿®æ”¹ç›®å½•æƒé™å¦åˆ™å¯åŠ¨åå®¹å™¨ä¸­ç”¨æˆ·æ— æ³•åˆ›å»ºæ•°æ®æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ chmod 777 /data/grafana/data Grafanåˆ›å»ºå‘½ä»¤\n1 2 3 4 5 6 7 docker run -d -p 3000:3000 -u root \\ --name grafana \\ -e \u0026#34;GF_SECURITY_ADMIN_PASSWORD=admin\u0026#34; \\ -v \u0026#34;/volume1/docker/monitor/grafana/grafana.ini:/etc/grafana/grafana.ini\u0026#34; \\ -v \u0026#34;/volume1/docker/monitor/grafana/data/:/var/lib/grafana\u0026#34; \\ $(cat /etc/hosts |grep -Ev \u0026#34;^$|[#;]\u0026#34; | awk -F \u0026#39; \u0026#39; \u0026#39;{if(NR\u0026gt;2){print \u0026#34;--add-host \u0026#34;$2\u0026#34;:\u0026#34;$1}}\u0026#39;) \\ grafana/grafana grafana 5ã€ç•Œé¢å±•ç¤º 1ã€æ·»åŠ æ•°æ®æº 2ã€å¯¼å…¥å¤§å±å±•ç¤º IDï¼š Linuxï¼š8919 ç¾¤è¾‰ï¼š14284 14364\n","date":"2023-11-28T15:17:01Z","image":"https://www.ownit.top/title_pic/14.jpg","permalink":"https://www.ownit.top/p/202311281517/","title":"ä½¿ç”¨Prometheusç›‘æ§Synologyï¼ˆç¾¤è¾‰ï¼‰"},{"content":"1ã€å¼•è¨€ åœ¨å½“ä»Šæ•°å­—åŒ–æ—¶ä»£ï¼Œæ•°æ®æ˜¯ä¼ä¸šå’Œç»„ç»‡çš„æ ¸å¿ƒèµ„äº§ã€‚ä¸ºäº†ç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§å’Œå¯æ¢å¤æ€§ï¼Œå¤‡ä»½æ˜¯è‡³å…³é‡ è¦çš„ã€‚ç„¶è€Œï¼Œæ‰‹åŠ¨å¤‡ä»½æ•°æ®å¯èƒ½ä¼šç¹çä¸”å®¹æ˜“å‡ºé”™ï¼Œç‰¹åˆ«æ˜¯åœ¨é¢å¯¹å¤§è§„æ¨¡å’Œåˆ†å¸ƒå¼çš„æ•°æ®å­˜å‚¨æƒ…å†µä¸‹ã€‚å¹¸è¿çš„æ˜¯ï¼ŒAnsibleä½œä¸ºä¸€ç§è‡ªåŠ¨åŒ–å·¥å…·ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬è½»æ¾å®ç°æ ¸å¿ƒæ•°æ®çš„é›†ä¸­å¼è‡ªåŠ¨å¤‡ä»½ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•ä½¿ç”¨Ansibleæ¥è‡ªåŠ¨å¤‡ä»½æ ¸å¿ƒæ•°æ®ï¼Œç¡®ä¿æ•°æ®å®‰å…¨æ— å¿§ã€‚\n2ã€èƒŒæ™¯ å…¬å¸æœ‰ä¸€äº›æ ¸å¿ƒæ•°æ®éœ€è¦å¤‡ä»½ï¼Œæ¯”å¦‚ï¼Œgitlabï¼Œwikiï¼ŒMySQLï¼ŒMongoDBç­‰ç­‰æ•°æ®åº“ã€‚\nä¸ºäº†é˜²æ­¢æ•°æ®ä¸¢å¤±æˆ–æŸåï¼Œæˆ‘ä»¬éœ€è¦å®šæœŸå¤‡ä»½GitLabæ•°æ®ã€‚å¤‡ä»½çš„å†…å®¹é€šå¸¸åŒ…æ‹¬Gitå­˜å‚¨åº“ã€é…ç½®æ–‡ä»¶ã€æ•°æ®åº“ç­‰\nä¹‹å‰æ–¹æ¡ˆï¼š\nåœ¨æ¯å°ç›¸å…³çš„æœºå™¨ä¸Šå¤‡ä»½ï¼Œä»»åŠ¡åˆ†æ•£ï¼Œæ•°æ®ä¸å®¹æ˜“ç®¡ç†ï¼Œå­˜å‚¨\nç°åœ¨æ–¹æ¡ˆï¼š\né‡‡ç”¨ä¸€å°æœºå™¨ï¼Œè®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ŒæŠŠå¤‡ä»½æ•°æ®å½’æ¡£åˆ°åŒä¸€åœ°æ–¹å­˜å‚¨ï¼Œç»Ÿä¸€ç®¡ç†\nä½¿ç”¨Ansibleè‡ªåŠ¨å¤‡ä»½GitLabå…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š\næé«˜æ•ˆç‡ï¼šä½¿ç”¨Ansibleå¯ä»¥è‡ªåŠ¨å¤‡ä»½ï¼Œæ— éœ€æ‰‹åŠ¨æ‰§è¡Œå¤‡ä»½æ“ä½œã€‚\næé«˜å¯é æ€§ï¼šé€šè¿‡Ansibleè‡ªåŠ¨åŒ–å¤‡ä»½å¯ä»¥å‡å°‘äººä¸ºé”™è¯¯ï¼Œæé«˜å¤‡ä»½çš„å¯é æ€§ã€‚\nå……åˆ†åˆ©ç”¨èµ„æºï¼šAnsibleå¯ä»¥åœ¨å¤šä¸ªä¸»æœºä¸Šå¹¶è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œå……åˆ†åˆ©ç”¨èµ„æºæé«˜æ•ˆç‡ã€‚\n3ã€æ–¹æ¡ˆå®ç° ç¼–å†™Ansible Playbookï¼šåœ¨Playbookä¸­å®šä¹‰éœ€è¦å¤‡ä»½çš„æ–‡ä»¶å’Œè·¯å¾„ï¼Œä»¥åŠå¤‡ä»½çš„æ–‡ä»¶å­˜å‚¨ä½ç½®ã€‚\næ‰§è¡ŒAnsible Playbookï¼šé€šè¿‡æ‰§è¡ŒPlaybookæ¥è‡ªåŠ¨å¤‡ä»½GitLabã€‚\néªŒè¯å¤‡ä»½ï¼šæ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å·²æ­£ç¡®å­˜å‚¨ï¼Œå¹¶ç¡®ä¿æ–‡ä»¶å¯ç”¨äºæ¢å¤ã€‚\n1ã€åŸºç¡€ç¯å¢ƒ 1 2 3 4 5 6 7 backupGitlab.yml group_vars hosts [root@ansible-yunwei backupData]# tree . . â”œâ”€â”€ backupGitlab.yml â”œâ”€â”€ group_vars â”‚?? â””â”€â”€ all â””â”€â”€ hosts åˆ›å»ºhostsä¸»æœº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [gitlab] 192.168.xx.xx ansible_ssh_user=root ansible_ssh_pass=\u0026#34;xxxx.xx\u0026#34; [confluence] 192.168.xx.xx ansible_ssh_user=root ansible_ssh_pass=\u0026#34;xxxx.xx\u0026#34; [uatmysql] 192.168.xx.xx ansible_ssh_user=root ansible_ssh_pass=\u0026#34;xxx.xx\u0026#34; [uatmongo8449] 192.168.xx.xx ansible_ssh_user=root ansible_ssh_pass=\u0026#34;xxxx.xx\u0026#34; [uatmongo9942] 192.168.xxx.xx ansible_ssh_user=root ansible_ssh_pass=\u0026#34;xxxxx.xx\u0026#34; å®šä¹‰å˜é‡ç¯å¢ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # gitlabå¤‡ä»½å­˜æ”¾ç›®å½• gitlabBackupDir: /data/backup/gitlab # confluenceå¤‡ä»½å­˜æ”¾ç›®å½• confluenceBackupDir: /data/backup/confluence # uatç¯å¢ƒmysqlå¤‡ä»½å­˜æ”¾ç›®å½• uatMysqlBackupDir: /data/backup/uatmysql # uatç¯å¢ƒmongo(192.168.84.xx)å¤‡ä»½å­˜æ”¾ç›®å½• uatMongo8449BackupDir: /data/backup/uatmongo8449 # uatç¯å¢ƒmongo(192.168.99.xx)å¤‡ä»½å­˜æ”¾ç›®å½• uatMongo9942BackupDir: /data/backup/uatmongo9942 # å¤‡ä»½ç»“æœè®°å½•æ–‡ä»¶ statusFile: /data/backup/backupStatus 2ã€ç¼–å†™Ansible Playbook è·å–å½“å‰æ—¥æœŸï¼Œåˆ›å»ºå¤‡ä»½ç›®å½•ã€‚ ç”ŸæˆGitLabå¤‡ä»½æ–‡ä»¶å¹¶æ‹‰å–è‡³æœ¬åœ°å¤‡ä»½ç›®å½•ã€‚ æ‹‰å–GitLabé…ç½®æ–‡ä»¶å¹¶å­˜å‚¨åœ¨å¤‡ä»½ç›®å½•ä¸­ã€‚ åˆ é™¤åŸå§‹å¤‡ä»½æ–‡ä»¶åŠæ—§å¤‡ä»½æ–‡ä»¶ã€‚ è®°å½•å¤‡ä»½å®ŒæˆçŠ¶æ€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 [root@ansible-yunwei backupData]# cat backupGitlab.yml - name: å¤‡ä»½gitlab hosts: gitlab remote_user: root tasks: - name: è·å–å½“æ—¥æ—¥æœŸ local_action: shell date +%Y%m%d args: warn: no register: date - name: æœ¬æœºåˆ›å»ºå¤‡ä»½ç›®å½• local_action: file path={{gitlabBackupDir}}/{{date.stdout}} state=directory owner=root group=root mode=0700 - name: ç”Ÿæˆgitlabå¤‡ä»½ shell: gitlab-backup create STRATEGY=copy args: warn: no - name: è·å–æ–‡ä»¶å find: paths=/var/opt/gitlab/backups/ recurse=no patterns=\u0026#39;*.tar\u0026#39; register: backupFile - name: æ‹‰å–å¤‡ä»½æ–‡ä»¶ fetch: src={{item.path}} dest={{gitlabBackupDir}}/{{date.stdout}}/ flat=True with_items: - \u0026#39;{{backupFile.files}}\u0026#39; - name: æ‹‰å–é…ç½®æ–‡ä»¶ fetch: src={{item}} dest={{gitlabBackupDir}}/{{date.stdout}}/ flat=True with_items: - /etc/gitlab/gitlab.rb - /etc/gitlab/gitlab-secrets.json - name: åˆ é™¤åŸå§‹æ–‡ä»¶ file: path={{item.path}} state=absent with_items: - \u0026#39;{{backupFile.files}}\u0026#39; - name: æŸ¥æ‰¾æ—§çš„å¤‡ä»½ local_action: find paths={{gitlabBackupDir}}/ recurse=no patterns=\u0026#39;*\u0026#39; age=3d age_stamp=mtime file_type=directory register: backupDir - name: åˆ é™¤æ—§çš„å¤‡ä»½ local_action: file path={{item.path}} state=absent with_items: - \u0026#39;{{backupDir.files}}\u0026#39; - name: è®°å½•å¤‡ä»½å®ŒæˆçŠ¶æ€ local_action: shell if [ ! \u0026#34;`ls -A {{gitlabBackupDir}}/{{date.stdout}}`\u0026#34; = \u0026#34;\u0026#34; ]; then echo \u0026#39;{{date.stdout}}:successful:gitlab\u0026#39; \u0026gt;\u0026gt; {{statusFile}} ; else echo \u0026#39;{{date.stdout}}:failed:gitlab\u0026#39; \u0026gt;\u0026gt; {{statusFile}} ; fi args: warn: no 3ã€æ‰§è¡Œansible-playbook 1 /usr/local/python36/bin/ansible-playbook /opt/ansible/backupData/backupGitlab.yml -i /opt/ansible/backupData/hosts 2\u0026gt;\u0026amp;1 \u0026gt;\u0026gt; /data/backup/backup.log 4ã€è®¾ç½®å®šæ—¶ä»»åŠ¡ 1 1 0 * * * /usr/local/python36/bin/ansible-playbook /opt/ansible/backupData/backupGitlab.yml -i /opt/ansible/backupData/hosts 2\u0026gt;\u0026amp;1 \u0026gt;\u0026gt; /data/backup/backup.log 5ã€æ‰§è¡Œç»“æœ 4ã€å¤‡ä»½å…¶ä½™ç±»å‹ backupConfluence.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 - name: å¤‡ä»½confluence hosts: confluence remote_user: root tasks: - name: è·å–å½“æ—¥æ—¥æœŸ local_action: shell date +%Y%m%d args: warn: no register: date - name: è·å–ç”¨äºæ¨¡å¼åŒ¹é…çš„å½“æ—¥æ—¥æœŸ local_action: shell date +%Y_%m_%d args: warn: no register: datePattern - name: æœ¬æœºåˆ›å»ºå¤‡ä»½ç›®å½• local_action: file path={{confluenceBackupDir}}/{{date.stdout}} state=directory owner=root group=root mode=0700 - name: è·å–æ–‡ä»¶å find: paths=/var/atlassian/application-data/confluence/backups/ recurse=no patterns=\u0026#39;backup-{{datePattern.stdout}}.zip\u0026#39; register: backupFile - name: æ‹‰å–å¤‡ä»½æ–‡ä»¶ fetch: src={{item.path}} dest={{confluenceBackupDir}}/{{date.stdout}}/ flat=True with_items: - \u0026#39;{{backupFile.files}}\u0026#39; - name: æŸ¥æ‰¾æ—§çš„å¤‡ä»½ local_action: find paths={{confluenceBackupDir}}/ recurse=no patterns=\u0026#39;*\u0026#39; age=3d age_stamp=mtime file_type=directory register: backupDir - name: åˆ é™¤æ—§çš„å¤‡ä»½ local_action: file path={{item.path}} state=absent with_items: - \u0026#39;{{backupDir.files}}\u0026#39; - name: è®°å½•å¤‡ä»½å®ŒæˆçŠ¶æ€ local_action: shell if [ ! \u0026#34;`ls -A {{confluenceBackupDir}}/{{date.stdout}}`\u0026#34; = \u0026#34;\u0026#34; ]; then echo \u0026#39;{{date.stdout}}:successful:confluence\u0026#39; \u0026gt;\u0026gt; {{statusFile}} ; else echo \u0026#39;{{date.stdout}}:failed:confluence\u0026#39; \u0026gt;\u0026gt; {{statusFile}} ; fi args: warn: no ** backupUatMongo8449.yml**\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 - name: å¤‡ä»½uatç¯å¢ƒmongoæ•°æ®åº“(192.168.xx.xx) hosts: uatmongo8449 remote_user: root tasks: - name: è·å–å½“æ—¥æ—¥æœŸ local_action: shell date +%Y%m%d args: warn: no register: date - name: æœ¬æœºåˆ›å»ºå¤‡ä»½ç›®å½• local_action: file path={{uatMongo8449BackupDir}}/{{date.stdout}} state=directory owner=root group=root mode=0700 - name: ç”Ÿæˆå¤‡ä»½ shell: mongodump --host \u0026#39;192.168.xx.xx\u0026#39; --port \u0026#39;27017\u0026#39; -u \u0026#39;root\u0026#39; -p \u0026#39;xxx\u0026#39; --authenticationDatabase \u0026#39;admin\u0026#39; --gzip -o /tmp/uatmongo8449-{{date.stdout}} args: warn: no - name: è¿›è¡Œæ‰“åŒ… archive: path=/tmp/uatmongo8449-{{date.stdout}} dest=/tmp/uatmongo8449-{{date.stdout}}.tar format=tar remove=True - name: æ‹‰å–å¤‡ä»½æ–‡ä»¶ fetch: src=/tmp/uatmongo8449-{{date.stdout}}.tar dest={{uatMongo8449BackupDir}}/{{date.stdout}}/ flat=True - name: åˆ é™¤åŸå§‹æ–‡ä»¶ file: path={{item}} state=absent with_items: - \u0026#39;/tmp/uatmongo8449-{{date.stdout}}.tar\u0026#39; - \u0026#39;/tmp/uatmongo8449-{{date.stdout}}\u0026#39; - name: æŸ¥æ‰¾æ—§çš„å¤‡ä»½ local_action: find paths={{uatMongo8449BackupDir}}/ recurse=no patterns=\u0026#39;*\u0026#39; age=3d age_stamp=mtime file_type=directory register: backupDir - name: åˆ é™¤æ—§çš„å¤‡ä»½ local_action: file path={{item.path}} state=absent with_items: - \u0026#39;{{backupDir.files}}\u0026#39; - name: è®°å½•å¤‡ä»½å®ŒæˆçŠ¶æ€ local_action: shell if [ ! \u0026#34;`ls -A {{uatMongo8449BackupDir}}/{{date.stdout}}`\u0026#34; = \u0026#34;\u0026#34; ]; then echo \u0026#39;{{date.stdout}}:successful:uatMongo8449\u0026#39; \u0026gt;\u0026gt; {{statusFile}} ; else echo \u0026#39;{{date.stdout}}:failed:uatMongo8449\u0026#39; \u0026gt;\u0026gt; {{statusFile}} ; fi args: warn: no ** backupUatMysql.yml**\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 - name: å¤‡ä»½uatç¯å¢ƒmysqlæ•°æ®åº“ hosts: uatmysql remote_user: root tasks: - name: è·å–å½“æ—¥æ—¥æœŸ local_action: shell date +%Y%m%d args: warn: no register: date - name: æœ¬æœºåˆ›å»ºå¤‡ä»½ç›®å½• local_action: file path={{uatMysqlBackupDir}}/{{date.stdout}} state=directory owner=root group=root mode=0700 - name: ç”Ÿæˆå¤‡ä»½ shell: mysqldump -h\u0026#39;192.168.1xx.xxx\u0026#39; -u\u0026#39;root\u0026#39; -p\u0026#39;xxxx\u0026#39; --single-transaction --flush-logs --master-data=2 --events --routines --triggers --hex-blob --all-databases | gzip \u0026gt; /tmp/uatmysql-{{date.stdout}}.sql.gz args: warn: no - name: æ‹‰å–å¤‡ä»½æ–‡ä»¶ fetch: src=/tmp/uatmysql-{{date.stdout}}.sql.gz dest={{uatMysqlBackupDir}}/{{date.stdout}}/ flat=True - name: åˆ é™¤åŸå§‹æ–‡ä»¶ file: path=/tmp/uatmysql-{{date.stdout}}.sql.gz state=absent - name: æŸ¥æ‰¾æ—§çš„å¤‡ä»½ local_action: find paths={{uatMysqlBackupDir}}/ recurse=no patterns=\u0026#39;*\u0026#39; age=3d age_stamp=mtime file_type=directory register: backupDir - name: åˆ é™¤æ—§çš„å¤‡ä»½ local_action: file path={{item.path}} state=absent with_items: - \u0026#39;{{backupDir.files}}\u0026#39; - name: è®°å½•å¤‡ä»½å®ŒæˆçŠ¶æ€ local_action: shell if [ ! \u0026#34;`ls -A {{uatMysqlBackupDir}}/{{date.stdout}}`\u0026#34; = \u0026#34;\u0026#34; ]; then echo \u0026#39;{{date.stdout}}:successful:uatMysql\u0026#39; \u0026gt;\u0026gt; {{statusFile}} ; else echo \u0026#39;{{date.stdout}}:failed:uatMysql\u0026#39; \u0026gt;\u0026gt; {{statusFile}} ; fi args: warn: no 1 2 3 4 5 6 7 [root@kvm-master backupData]# crontab -l # å¤‡ä»½æ•°æ®ï¼šGitlabã€Confluenceã€uatç¯å¢ƒmysql(192.168.1xx.xx)ã€uatç¯å¢ƒmongo(192.168.xx.xx) (æ¯å¤©æ‰§è¡Œä¸€æ¬¡) 1 0 * * * /usr/local/python36/bin/ansible-playbook /opt/ansible/backupData/backupGitlab.yml -i /opt/ansible/backupData/hosts 2\u0026gt;\u0026amp;1 \u0026gt;\u0026gt; /data/backup/backup.log 10 0 * * * /usr/local/python36/bin/ansible-playbook /opt/ansible/backupData/backupConfluence.yml -i /opt/ansible/backupData/hosts 2\u0026gt;\u0026amp;1 \u0026gt;\u0026gt; /data/backup/backup.log 20 0 * * * /usr/local/python36/bin/ansible-playbook /opt/ansible/backupData/backupUatMysql.yml -i /opt/ansible/backupData/hosts 2\u0026gt;\u0026amp;1 \u0026gt;\u0026gt; /data/backup/backup.log 30 0 * * * /usr/local/python36/bin/ansible-playbook /opt/ansible/backupData/backupUatMongo8449.yml -i /opt/ansible/backupData/hosts 2\u0026gt;\u0026amp;1 \u0026gt;\u0026gt; /data/backup/backup.log 40 0 * * * /usr/local/python36/bin/ansible-playbook /opt/ansible/backupData/backupUatMongo9942.yml -i /opt/ansible/backupData/hosts 2\u0026gt;\u0026amp;1 \u0026gt;\u0026gt; /data/backup/backup.log 5ã€æ€»ç»“ é€šè¿‡ä¸Šè¿°è‡ªåŠ¨åŒ–å¤‡ä»½ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰æ•ˆåœ°ä¿æŠ¤Gitlabæ•°æ®çš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§ã€‚åœ¨å®é™…åº”ç”¨è¿‡ç¨‹ä¸­ï¼Œè¿™ç§å¤‡ä»½ç­–ç•¥è¿˜å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œå®šåˆ¶å’Œæ‰©å±•ï¼Œä»¥æ»¡è¶³ä¸åŒåœºæ™¯ä¸‹çš„éœ€æ±‚ã€‚å¸Œæœ›è¿™ç¯‡åšå®¢å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ï¼\n","date":"2023-10-20T15:59:21Z","image":"https://www.ownit.top/title_pic/31.jpg","permalink":"https://www.ownit.top/p/202310201559/","title":"ç²¾ç›Šæ±‚ç²¾ï¼šä½¿ç”¨Ansibleé›†ä¸­å¼è‡ªåŠ¨å¤‡ä»½æ ¸å¿ƒæ•°æ®"},{"content":"prometheus-pushgatewayå®‰è£… ä¸€. Pushgatewayç®€ä»‹ Pushgatewayä¸ºPrometheusæ•´ä½“ç›‘æ§æ–¹æ¡ˆçš„åŠŸèƒ½ç»„ä»¶ä¹‹ä¸€ï¼Œå¹¶åšäºä¸€ä¸ªç‹¬ç«‹çš„å·¥å…·å­˜åœ¨ã€‚å®ƒä¸»è¦ç”¨äºPrometheusæ— æ³•ç›´æ¥æ‹¿åˆ°ç›‘æ§æŒ‡æ ‡çš„åœºæ™¯ï¼Œå¦‚ç›‘æ§æºä½äºé˜²ç«å¢™ä¹‹åï¼ŒPrometheusæ— æ³•ç©¿é€é˜²ç«å¢™ï¼›ç›®æ ‡æœåŠ¡æ²¡æœ‰å¯æŠ“å–ç›‘æ§æ•°æ®çš„ç«¯ç‚¹ç­‰å¤šç§æƒ…å†µã€‚\nåœ¨ç±»ä¼¼åœºæ™¯ä¸­ï¼Œå¯é€šè¿‡éƒ¨ç½²Pushgatewayçš„æ–¹å¼è§£å†³é—®é¢˜ã€‚å½“éƒ¨ç½²è¯¥ç»„ä»¶åï¼Œç›‘æ§æºé€šè¿‡ä¸»åŠ¨å‘é€ç›‘æ§æ•°æ®åˆ°Pushgatewayï¼Œå†ç”±Prometheuså®šæ—¶è·å–ä¿¡æ¯ï¼Œå®ç°èµ„æºçš„çŠ¶æ€ç›‘æ§ã€‚ ç®€å•å›¾ â€‹\nå·¥ä½œæµç¨‹ï¼š\na. ç›‘æ§æºé€šè¿‡Postæ–¹å¼ï¼Œå‘é€æ•°æ®åˆ°Pushgatewayï¼Œè·¯å¾„ä¸º/metricsã€‚\nb. PrometheusæœåŠ¡ç«¯è®¾ç½®ä»»åŠ¡ï¼Œå®šæ—¶è·å–Pushgatewayä¸Šé¢çš„ç›‘æ§æŒ‡æ ‡ã€‚\nc. Prometheusæ‹¿åˆ°ç›‘æ§æŒ‡æ ‡åï¼Œæ ¹æ®é…ç½®çš„å‘Šè­¦è§„åˆ™ï¼Œå¦‚æœåŒ¹é…å°†è§¦å‘å‘Šè­¦åˆ°Alertmanagerï¼›åŒæ—¶ï¼ŒGrafanaå¯é…ç½®æ•°æ®æºè°ƒç”¨Prometheusæ•°æ®ï¼Œåšä¸ºæ•°æ®å±•ç¤ºã€‚\nd. Alertmanageræ”¶åˆ°å‘Šè­¦åï¼Œæ ¹æ®è§„åˆ™è½¬å‘åˆ°å¯¹åº”æ¥æ”¶äººåŠæ¥æ”¶ä»‹è´¨ï¼›Grafanaæ–¹é¢ï¼Œç”¨æˆ·å¯ç™»å½•å¹¶æ ¹æ®æ•°æ®æºçš„ç›‘æ§æŒ‡æ ‡ï¼Œé…ç½®ç›¸å…³çš„å›¾è¡¨å±•ç¤º ã€‚\näºŒ. å®‰è£…éƒ¨ç½² äºŒè¿›åˆ¶å®‰è£…\nä¸‹è½½å®‰è£…åŒ… 1 2 3 cd /usr/local wget https://github.com/prometheus/pushgateway/releases/download/v1.4.3/pushgateway-1.4.3.linux-amd64.tar.gz tar -xf pushgateway-1.4.3.linux-amd64.tar.gz systemç®¡ç† å¯åŠ¨æœåŠ¡ï¼Œé»˜è®¤ç«¯å£ä¸º9091,å¯é€šè¿‡\u0026ndash;web.listen-addressæ›´æ”¹ç›‘å¬ç«¯å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 root@bj-1:/usr/local# cat /usr/lib/systemd/system/pushgateway.service [Unit] Description=Prometheus pushgateway Requires=network.target remote-fs.target After=network.target remote-fs.target ? [Service] Type=simple User=root Group=root ExecStart=/usr/local/pushgateway/pushgateway --persistence.file=\u0026#34;/usr/local/pushgateway/data/\u0026#34; --persistence.interval=5m #ä¿å­˜æ—¶é—´5åˆ†é’Ÿ ExecReload=/bin/kill -HUP $MAINPID KillMode=process Restart=on-failure RestartSec=5s ? [Install] WantedBy=multi-user.target â€‹\nä¸‰.prometheusæ·»åŠ é…ç½® æ–°å¢job pushgateway\n1 2 3 4 5 6 7 8 vim /usr/local/prometheus/prometheus.yml - job_name: \u0026#39;pushgateway\u0026#39; scrape_interval: 30s honor_labels: true #åŠ ä¸Šæ­¤é…ç½®exporterèŠ‚ç‚¹ä¸Šä¼ æ•°æ®ä¸­çš„ä¸€äº›æ ‡ç­¾å°†ä¸ä¼šè¢«pushgatewayèŠ‚ç‚¹çš„ç›¸åŒæ ‡ç­¾è¦†ç›– static_configs: - targets: [\u0026#39;10.3.1.11:9091\u0026#39;] labels: instance: pushgateway â€˜â€™æŸ¥çœ‹targetçŠ¶æ€ï¼š\nâ€‹\nå››. æ•°æ®æ¨é€Pushgateway pushgatewayçš„æ•°æ®æ¨é€æ”¯æŒä¸¤ç§æ–¹å¼ï¼ŒPrometheus Client SDKæ¨é€å’ŒAPIæ¨é€ã€‚\nâ€‹\n1ã€Client SDKæ¨é€ Prometheusæœ¬èº«æä¾›äº†æ”¯æŒå¤šç§è¯­è¨€çš„SDKï¼Œå¯é€šè¿‡SDKçš„æ–¹å¼ï¼Œç”Ÿæˆç›¸å…³çš„æ•°æ®ï¼Œå¹¶æ¨é€åˆ°pushgatewayï¼Œè¿™ä¹Ÿæ˜¯å®˜æ–¹æ¨èçš„æ–¹æ¡ˆã€‚ç›®å‰çš„SDKè¦†ç›–è¯­è¨€æœ‰å®˜æ–¹çš„â€‹\n1 2 3 4 Go Java or Scala Python Ruby ä¹Ÿæœ‰è®¸å¤šç¬¬ä¸‰æ–¹çš„ï¼Œè¯¦æƒ…å¯å‚è§æ­¤é“¾æ¥ï¼šhttps://prometheus.io/docs/instrumenting/clientlibs/\nç¤ºä¾‹:\næœ¬ç¤ºä¾‹ä»¥pythonä¸ºä¾‹ï¼Œè®²è§£SDKçš„ä½¿ç”¨\n1 2 3 4 5 6 7 8 from prometheus_client import Counter,Gauge,push_to_gateway from prometheus_client.core import CollectorRegistry registry = CollectorRegistry() data1 = Gauge(\u0026#39;gauge_test_metric\u0026#39;,\u0026#39;This is a gauge-test-metric\u0026#39;,[\u0026#39;method\u0026#39;,\u0026#39;path\u0026#39;,\u0026#39;instance\u0026#39;],registry=registry) data1.labels(method=\u0026#39;get\u0026#39;,path=\u0026#39;/aaa\u0026#39;,instance=\u0026#39;instance1\u0026#39;).inc(3) push_to_gateway(\u0026#39;10.12.61.3:9091\u0026#39;, job=\u0026#39;alex-job\u0026#39;,registry=registry) æ³¨è§£ï¼š\nç¬¬ä¸€ã€äºŒè¡Œä»£ç ï¼šå¼•å…¥ç›¸å…³çš„Prometheus SDKï¼›\nç¬¬äº”è¡Œä»£ç ï¼šåˆ›å»ºç›¸å…³çš„æŒ‡æ ‡ï¼Œç±»å‹ä¸ºGaugeã€‚å…¶ä¸­â€œgauge_test_metricâ€ä¸ºæŒ‡æ ‡åç§°ï¼Œ\u0026lsquo;This is a gauge-test-metric\u0026rsquo;ä¸ºæŒ‡æ ‡æ³¨é‡Šï¼Œ[\u0026lsquo;method\u0026rsquo;,\u0026lsquo;path\u0026rsquo;,\u0026lsquo;instance\u0026rsquo;] ä¸ºæŒ‡æ ‡ç›¸å…³çš„labelã€‚\nç¬¬å…­è¡Œä»£ç ï¼šæ·»åŠ ç›¸å…³çš„labelä¿¡æ¯å’ŒæŒ‡æ ‡value å€¼ã€‚\nç¬¬å…­è¡Œä»£ç ï¼špushæ•°æ®åˆ°pushgatewayï¼Œ\u0026lsquo;10.12.61.3:9091\u0026rsquo;ä¸ºå‘é€åœ°å€ï¼ŒjobæŒ‡å®šè¯¥ä»»åŠ¡åç§°ã€‚\nä»¥ä¸Šä»£ç äº§ç”Ÿçš„æŒ‡æ ‡æ•°æ®ç­‰åŒå¦‚ä¸‹ ï¼š\n1 2 3 # HELP gauge_test_metric This is a gauge-test-metric # TYPE gauge_test_metric gauge gauge_test_metric{instance=\u0026#34;instance1\u0026#34;,method=\u0026#34;get\u0026#34;,path=\u0026#34;/aaa\u0026#34;} 3.0 2ã€Postæ¨é€Node-expoerterç»„ä»¶æ•°æ® å®‰è£…å¥½node_exporter,æ­¤å¤„ä¸å¤šä»‹ç»\nä¼ é€ç›‘æ§æ•°æ®åˆ°pushgatewayèŠ‚ç‚¹\nå¯¹äºä¼ è¿‡å»çš„ç›‘æ§é¡¹ä¼šæ·»åŠ æ­¤å¤„å®šä¹‰çš„æ ‡ç­¾ job=test instance=10.2.1.11 hostname=ip-10-2-1-11\n1 curl 127.0.0.1:9100/metrics|curl --data-binary @- http://10.3.1.11:9091/metrics/job/test/instance/10.2.1.11/hostname/ip-10-2-1-11 ç¼–å†™è„šæœ¬\nnode_date.sh\n1 2 3 4 5 6 #!/bin/bash job_name=\u0026#34;Bj\u0026#34; hostname=$(hostname) HOST_IP=$(hostname --all-ip-addresses | awk \u0026#39;{print $1}\u0026#39;) /usr/bin/curl 127.0.0.1:9100/metrics|/usr/bin/curl --data-binary @- http://sanming.f3322.net:9091/metrics/job/$job_name/instance/$HOST_IP/hostname/$hostname crontabå®šæ—¶ä»»åŠ¡\n1 2 #Ansible: node_date * * * * * /bin/bash /usr/local/node_exporter/node_date.sh æ‰¹é‡ç»™node-exporteræ·»åŠ å®šæ—¶ä»»åŠ¡\nAnsibleå‰§æœ¬\n1 2 3 4 5 6 7 8 9 10 11 root@bj-1:/opt/node_date# cat playbook.yml - hosts: all remote_user: root gather_facts: no tasks: - name: æ¨é€ç£ç›˜è„šæœ¬ copy: src=node_date.sh dest=/usr/local/node_exporter mode=u+x - name: è®¾ç½®å®šæ—¶ä»»åŠ¡ cron: name=\u0026#34;node_date\u0026#34; job=\u0026#34;/bin/bash /usr/local/node_exporter/node_date.sh\u0026#34; state=\u0026#34;present\u0026#34; - name: æ‰§è¡Œè„šæœ¬ shell: /bin/bash /usr/local/node_exporter/node_date.sh åˆ é™¤æŸä¸ªå®ä¾‹çš„æ•°æ®ï¼š\n1 curl -X DELETE http://10.3.1.11:9091/metrics/job/test/instance/10.2.1.11/hostname/ip-10-2-1-11 â€\n3ã€pushgatewayè„šæœ¬ç¤ºä¾‹ (1)TCPè¿æ¥ pushgatewayæœ¬èº«æ²¡æœ‰ä»»ä½•æŠ“å–ç›‘æ§æ•°æ®çš„åŠŸèƒ½ï¼Œå®ƒåªèƒ½è¢«åŠ¨åœ°ç­‰å¾…æ•°æ®è¢«æ¨é€è¿‡æ¥ï¼Œæ•…éœ€è¦ç”¨æˆ·è‡ªè¡Œç¼–å†™æ•°æ®é‡‡é›†è„šæœ¬ã€‚\nä¾‹ï¼šé‡‡é›†TCP waiting_connectionç¬æ—¶æ•°é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 mkdir -p /app/scripts/pushgateway cat \u0026lt;\u0026lt;EOF \u0026gt;/app/scripts/pushgateway/tcp_waiting_connection.sh #!/bin/bash # è·å–hostnameï¼Œä¸”hostä¸èƒ½ä¸ºlocalhost instance_name=`hostname -f | cut -d \u0026#39;.\u0026#39; -f 1` if [ $instance_name = \u0026#34;localhost\u0026#34; ];then echo \u0026#34;Must FQDN hostname\u0026#34; exit 1 fi # For waiting connections label=\u0026#34;count_netstat_wait_connetions\u0026#34; count_netstat_wait_connetions=`netstat -an | grep -i wait | wc -l` echo \u0026#34;$label:$count_netstat_wait_connetions\u0026#34; echo \u0026#34;$label $count_netstat_wait_connetions\u0026#34; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name EOF chmod +x /app/scripts/pushgateway/tcp_waiting_connection.sh 1)netstat -an | grep -i wait | wc -lè¯¥è‡ªå®šä¹‰ç›‘æ§çš„å–å€¼æ–¹æ³•\n2)å®é™…ä¸Šå°±æ˜¯å°†K/Vé”®å€¼å¯¹é€šè¿‡POSTæ–¹å¼æ¨é€ç»™pushgatewayï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\nhttp://localhost:9091/metricspushgateway url\njob/pushgatewayæ•°æ®æ¨é€è¿‡å»çš„ç¬¬ä¸€ä¸ªlabelï¼Œå³exported_job=\u0026ldquo;pushgateway\u0026rdquo;ï¼ˆç±»ä¼¼prometheus.ymlä¸­å®šä¹‰çš„jobï¼‰\ninstance/$instance_nameæ•°æ®æ¨é€è¿‡å»çš„ç¬¬ä¸€ä¸ªlabelï¼Œå³exported_instance=\u0026ldquo;deepin-PC\u0026rdquo;\nâ€\n2.å®šæ—¶æ‰§è¡Œè„šæœ¬\n1 2 3 crontab -e * * * * * /app/scripts/pushgateway/tcp_waiting_connection.sh \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 prometheusé»˜è®¤æ¯15ç§’ä»pushgatewayè·å–ä¸€æ¬¡æ•°æ®ï¼Œè€Œcronå®šæ—¶ä»»åŠ¡æœ€å°ç²¾åº¦æ˜¯æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œè‹¥æƒ³æ²¡15ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œåˆ™ï¼š\næ–¹æ³•1ï¼šsleepï¼šå®šä¹‰å¤šæ¡å®šæ—¶ä»»åŠ¡\n1 2 3 4 * * * * * /app/scripts/pushgateway/tcp_waiting_connection.sh \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 * * * * * * sleep 15; /app/scripts/pushgateway/tcp_waiting_connection.sh \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 * * * * * * sleep 30; /app/scripts/pushgateway/tcp_waiting_connection.sh \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 * * * * * * sleep 45; /app/scripts/pushgateway/tcp_waiting_connection.sh \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 æ–¹æ³•2ï¼šforå¾ªç¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 cat \u0026lt;\u0026lt;EOF \u0026gt;/app/scripts/pushgateway/tcp_waiting_connection.sh #!/bin/bash time=15 for (( i=0; i\u0026lt;60; i=i+time )); do instance_name=`hostname -f | cut -d \u0026#39;.\u0026#39; -f 1` if [ $instance_name = \u0026#34;localhost\u0026#34; ];then echo \u0026#34;Must FQDN hostname\u0026#34; exit 1 fi label=\u0026#34;count_netstat_wait_connetions\u0026#34; count_netstat_wait_connetions=`netstat -an | grep -i wait | wc -l` echo \u0026#34;$label:$count_netstat_wait_connetions\u0026#34; echo \u0026#34;$label $count_netstat_wait_connetions\u0026#34; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name sleep $time done exit 0 EOF æ­¤æ—¶cronå®šæ—¶ä»»åŠ¡åªéœ€è¦å®šä¹‰ä¸€æ¡ï¼š\n1 2 3 crontab -e * * * * * /app/scripts/pushgateway/tcp_waiting_connection.sh \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 æ³¨ï¼šè‹¥è§£é‡Šå™¨ä½¿ç”¨#!/bin/bashï¼Œåˆ™è°ƒè¯•æ—¶ä½¿ç”¨å…¨è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„æˆ–è€…bash /app/scripts/pushgateway/tcp_waiting_connection.shæ‰§è¡Œè„šæœ¬ï¼›è‹¥è§£é‡Šå™¨ä½¿ç”¨#!/bin/shï¼Œåˆ™è°ƒè¯•æ—¶ä½¿ç”¨sh /app/scripts/pushgateway/tcp_waiting_connection.shæ‰§è¡Œè„šæœ¬ï¼Œå¦åˆ™å‡ºç°é”™è¯¯ï¼šSyntax error: Bad for loop variable\n3.promethuesæŸ¥çœ‹ç›‘æ§å€¼count_netstat_wait_connetions\n4.TCPç­‰å¾…è¿æ¥æ•°ï¼šcount_netstat_wait_connetionsï¼ˆé€šè¿‡è‡ªå®šä¹‰è„šæœ¬å®ç°ï¼Œé€šè¿‡node_exporterä¹Ÿå¯å®ç°ï¼‰\nå¤„äºå„ç§waitçŠ¶æ€çš„TCPè¿æ¥ï¼ˆclose_waitï¼Œtime_waitç­‰ï¼‰ä¹Ÿæ˜¯æ—¥å¸¸æ’æŸ¥è´Ÿè½½ï¼ˆç½‘ç»œè´Ÿè½½ï¼ŒæœåŠ¡å™¨è´Ÿè½½ï¼Œæ•°æ®åº“è´Ÿè½½ç­‰ï¼‰çš„ä¸€ä¸ªé‡è¦æŒ‡æ ‡ï¼šä¸€èˆ¬waitç±»å‹çš„TCPè¿‡å¤§æ—¶ï¼Œä¸€å®šè¯´æ˜ç³»ç»Ÿç½‘ç»œè´Ÿè½½ï¼ˆæµé‡è´Ÿè½½ï¼‰å‡ºç°äº†é—®é¢˜ï¼›åŸå› å¤šæ ·ï¼ˆç½‘ç»œé—®é¢˜ï¼Œè®¿é—®è¯·æ±‚é‡ï¼ŒDDOSæµé‡ï¼Œæ•°æ®åº“ï¼ŒCPUç­‰éƒ½æœ‰å¯èƒ½ï¼‰\nâ€\nâ€\n1 2 3 4 5 6 7 8 vi count_netstat_wait_connections.sh #!/bin/bash instance_name=`hostname -f | cut -d\u0026#39;.\u0026#39; -f1` #è·å–æœ¬æœºåï¼Œç”¨äºåé¢çš„çš„æ ‡ç­¾ label=\u0026#34;count_netstat_wait_connections\u0026#34; #å®šä¹‰keyå count_netstat_wait_connections=`netstat -an | grep -i wait | wc -l` #è·å–æ•°æ®çš„å‘½ä»¤ echo \u0026#34;$label: $count_netstat_wait_connections\u0026#34; echo \u0026#34;$label $count_netstat_wait_connections\u0026#34; | curl --data-binary @- http://server.com:9091/metrics/job/pushgateway_test/instance/$instance_name #è¿™é‡Œpushgateway_testå°±æ˜¯prometheusä¸»é…ç½®æ–‡ä»¶é‡Œjobçš„åå­—ï¼Œéœ€è¦ä¿æŒä¸€è‡´ï¼Œè¿™æ ·æ•°æ®å°±ä¼šæ¨é€ç»™è¿™ä¸ªjobã€‚åé¢çš„instanceåˆ™æ˜¯æŒ‡å®šæœºå™¨åï¼Œä½¿ç”¨çš„å°±æ˜¯è„šæœ¬é‡Œè·å–çš„é‚£ä¸ªå˜é‡å€¼ â€\nå‚è€ƒæ–‡æ¡£ï¼š\nPrometheusåˆ†å¸ƒå¼ç›‘æ§\nprometheus-pushgatewayå®‰è£…\nPrometheusç›‘æ§è¿ç»´å®æˆ˜åä¸€ï¼šPushgateway\n","date":"2023-10-16T09:04:53Z","image":"https://www.ownit.top/title_pic/77.jpg","permalink":"https://www.ownit.top/p/202310160904/","title":"Prometheusçš„Pushgatewayå¿«é€Ÿéƒ¨ç½²åŠä½¿ç”¨"},{"content":"ch\næŠ€æœ¯ åç«¯ï¼šflask å¯è§†åŒ–ï¼šecharts å‰ç«¯ï¼šHTML+JavaScript+css\nå¤§å±å¸ƒå±€ å¤§å±æ‹†åˆ† æ¡ˆä¾‹é¡¹ç›®ä¸­å¤§å±å¯æŒ‰ç‰ˆå—è¿›è¡Œæ‹†è§£ï¼Œä¼šå‘ç°è¿™é‡Œå¤§å±ä¸»è¦ç”±æ ‡é¢˜ã€æŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€åœ°å›¾ã€æ»šåŠ¨å›¾å’Œè¯äº‘ç­‰ç»„æˆï¼Œæ•´ä½“å¯åˆ‡åˆ†ä¸º8ä¸ªç‰ˆå—ï¼Œå¦‚ä¸‹ï¼š ä¸‹æ–¹ä¸ºç®€å•æ¼”ç¤ºï¼š HTML æˆ‘ä»¬æ•´ä½“å¸ƒå±€å‰ï¼Œå…ˆé€šè¿‡ç®€å•çš„æ¡ˆä¾‹äº†è§£å‰ç«¯å¸ƒå±€å®ç°æ–¹æ³•ã€‚\nåˆ›å»ºä¸€ä¸ªhtmlæ–‡ä»¶ï¼Œè¿™é‡Œå…ˆè°ƒæ•´æ ‡é¢˜çš„å¸ƒå±€ä½ç½®ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no\u0026#34;\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;/\u0026gt; \u0026lt;title\u0026gt;ECharts\u0026lt;/title\u0026gt; \u0026lt;!-- å¼•å…¥åˆšåˆšä¸‹è½½çš„ ECharts æ–‡ä»¶ --\u0026gt; \u0026lt;!-- å¼•å…¥ jQuery åº“ --\u0026gt; \u0026lt;script src=\u0026#34;https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;static/js/echarts.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div id=\u0026#34;title\u0026#34;\u0026gt;æœºå™¨ç›‘æ§å®æ—¶è·Ÿè¸ª\u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;time\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;!-- ä¸º ECharts å‡†å¤‡ä¸€ä¸ªå®šä¹‰äº†å®½é«˜çš„ DOM --\u0026gt; \u0026lt;div id=\u0026#34;main\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;cpu\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;disk\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;network\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;html\u0026gt; å±•ç¤º CSS åœ¨ä¸Šé¢æ·»åŠ ä¸€äº›cssçš„æ ·å¼ï¼Œåˆ’åˆ†ç›¸å…³çš„ä½ç½®\n1 2 3 4 5 position: absolute; width: 100%; height: 50%; top: 50%; right: 0%; ä¸Šé¢å°±æ˜¯åˆ’åˆ†ä½ç½®çš„å‚æ•°ï¼Œèƒ½å¤Ÿå¸®æˆ‘ä»¬å¿«é€Ÿåˆ’åˆ†å¥½ä½ç½®ã€‚ è¿™æ®µä»£ç æ˜¯ç”¨äºå¯¹ä¸€ä¸ªå…ƒç´ è¿›è¡Œå®šä½çš„ CSS æ ·å¼è®¾ç½®ã€‚ä»¥ä¸‹æ˜¯å¯¹æ¯ä¸ªå‚æ•°çš„è¯¦ç»†ä»‹ç»ï¼š\nposition: absolute;ï¼šå°†å…ƒç´ çš„å®šä½ç±»å‹è®¾ç½®ä¸ºç»å¯¹å®šä½ï¼Œå³ç›¸å¯¹äºå…¶æœ€è¿‘çš„å…·æœ‰å®šä½ï¼ˆéstaticï¼‰çš„çˆ¶å…ƒç´ è¿›è¡Œå®šä½ã€‚ width: 100%;ï¼šå°†å…ƒç´ çš„å®½åº¦è®¾ç½®ä¸ºçˆ¶å…ƒç´ çš„100%ã€‚æ¢å¥è¯è¯´ï¼Œå…ƒç´ çš„å®½åº¦å°†å¡«å……å…¶çˆ¶å…ƒç´ çš„æ•´ä¸ªå®½åº¦ã€‚ height: 50%;ï¼šå°†å…ƒç´ çš„é«˜åº¦è®¾ç½®ä¸ºçˆ¶å…ƒç´ é«˜åº¦çš„50%ã€‚å…ƒç´ å°†å æ®å…¶çˆ¶å…ƒç´ é«˜åº¦çš„ä¸€åŠã€‚ top: 50%;ï¼šå°†å…ƒç´ çš„é¡¶éƒ¨è¾¹ç¼˜ç›¸å¯¹äºå…¶åŒ…å«å—ï¼ˆé€šå¸¸æ˜¯æœ€è¿‘çš„å·²å®šä½ç¥–å…ˆå…ƒç´ ï¼‰çš„é¡¶éƒ¨è¾¹ç¼˜åç§»50%ã€‚æ­¤è®¾ç½®å°†ä½¿å…ƒç´ çš„ä¸­å¿ƒå‚ç›´å±…ä¸­ã€‚ right: 0%;ï¼šå°†å…ƒç´ çš„å³ä¾§è¾¹ç¼˜ç›¸å¯¹äºå…¶åŒ…å«å—çš„å³ä¾§è¾¹ç¼˜åç§»0%ã€‚æ¢å¥è¯è¯´ï¼Œå…ƒç´ å°†ç´§è´´å…¶åŒ…å«å—çš„å³ä¾§è¾¹ç¼˜ã€‚\næ ¹æ®ä»¥ä¸Šå‚æ•°è®¾ç½®ï¼Œè¿™æ®µä»£ç å°†ä½¿å…ƒç´ ä»¥ç»å¯¹å®šä½æ–¹å¼å‡ºç°åœ¨çˆ¶å…ƒç´ å†…éƒ¨ã€‚å…ƒç´ çš„å®½åº¦å°†å¡«æ»¡æ•´ä¸ªçˆ¶å…ƒç´ çš„å®½åº¦ï¼Œé«˜åº¦ä¸ºçˆ¶å…ƒç´ é«˜åº¦çš„ä¸€åŠã€‚å…ƒç´ å°†å‚ç›´å±…ä¸­ï¼Œä¸”å³ä¾§ç´§è´´çˆ¶å…ƒç´ ã€‚è¯·æ³¨æ„ï¼Œæ­¤ä»£ç ç‰‡æ®µä¸­æœªæåŠå…¶ä»–å®šä½ç›¸å…³å±æ€§ï¼ˆå¦‚å·¦ä¾§åç§»é‡ï¼‰ï¼Œå› æ­¤å¯èƒ½è¿˜éœ€è¦å…¶ä»–æ ·å¼è®¾ç½®æ¥å®Œæ•´å®šä¹‰å…ƒç´ çš„ä½ç½®å’Œå¤§å°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no\u0026#34;\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;/\u0026gt; \u0026lt;title\u0026gt;ECharts\u0026lt;/title\u0026gt; \u0026lt;!-- å¼•å…¥åˆšåˆšä¸‹è½½çš„ ECharts æ–‡ä»¶ --\u0026gt; \u0026lt;!-- å¼•å…¥ jQuery åº“ --\u0026gt; \u0026lt;script src=\u0026#34;https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;static/js/echarts.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;style\u0026gt; body { margin: 0; background: #333; } #title { position: absolute; width: 40%; height: 10%; top: 0%; left: 30%; background: #666666; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; /* åŠ ç²—å­—ä½“ */ border-radius: 10px; /* å¢åŠ åœ†æ¶¦æ„Ÿ */ box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* å¢åŠ ä¸€äº›é˜´å½±ï¼Œå¢åŠ ç§‘æŠ€æ„Ÿ */ } #main { position: absolute; width: 40%; height: 40%; top: 10%; left: 30%; background: #46a9be; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; /* åŠ ç²—å­—ä½“ */ border-radius: 10px; /* å¢åŠ åœ†æ¶¦æ„Ÿ */ box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* å¢åŠ ä¸€äº›é˜´å½±ï¼Œå¢åŠ ç§‘æŠ€æ„Ÿ */ } #cpu { position: absolute; width: 30%; height: 40%; top: 10%; left: 0%; background: #48dada; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; /* åŠ ç²—å­—ä½“ */ border-radius: 10px; /* å¢åŠ åœ†æ¶¦æ„Ÿ */ box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* å¢åŠ ä¸€äº›é˜´å½±ï¼Œå¢åŠ ç§‘æŠ€æ„Ÿ */ } #time { position: absolute; /* width: 30%; */ height: 10%; top: 5%; right: 2%; color: #FFFFFF; font-size: 20px; /* background: green; */ } #disk { position: absolute; width: 30%; height: 40%; top: 10%; right: 0%; background: #48dada; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; /* åŠ ç²—å­—ä½“ */ border-radius: 10px; /* å¢åŠ åœ†æ¶¦æ„Ÿ */ box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* å¢åŠ ä¸€äº›é˜´å½±ï¼Œå¢åŠ ç§‘æŠ€æ„Ÿ */ } #network { position: absolute; width: 100%; height: 50%; top: 50%; right: 0%; background: #dea594; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; /* åŠ ç²—å­—ä½“ */ border-radius: 10px; /* å¢åŠ åœ†æ¶¦æ„Ÿ */ box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* å¢åŠ ä¸€äº›é˜´å½±ï¼Œå¢åŠ ç§‘æŠ€æ„Ÿ */ } \u0026lt;/style\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div id=\u0026#34;title\u0026#34;\u0026gt;æœºå™¨ç›‘æ§å®æ—¶è·Ÿè¸ª\u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;time\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;!-- ä¸º ECharts å‡†å¤‡ä¸€ä¸ªå®šä¹‰äº†å®½é«˜çš„ DOM --\u0026gt; \u0026lt;div id=\u0026#34;main\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;cpu\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;disk\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;network\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;html\u0026gt; JS æ—¶é—´æ˜¾ç¤º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 function showTime() { var date = new Date(); var year = date.getFullYear(); var month = date.getMonth() + 1; // getMonth() è¿”å›çš„æœˆä»½æ˜¯ä»0å¼€å§‹çš„ï¼Œæ‰€ä»¥éœ€è¦+1 var day = date.getDate(); var hour = date.getHours(); var minute = date.getMinutes(); var second = date.getSeconds(); // ä½¿ç”¨ \u0026#39;padStart\u0026#39; å‡½æ•°æ¥ç¡®ä¿æ¯ä¸ªéƒ¨åˆ†éƒ½æ˜¯ä¸¤ä½æ•° month = month.toString().padStart(2, \u0026#39;0\u0026#39;); day = day.toString().padStart(2, \u0026#39;0\u0026#39;); hour = hour.toString().padStart(2, \u0026#39;0\u0026#39;); minute = minute.toString().padStart(2, \u0026#39;0\u0026#39;); second = second.toString().padStart(2, \u0026#39;0\u0026#39;); var formattedDate = year + \u0026#39;å¹´\u0026#39; + month + \u0026#39;æœˆ\u0026#39; + day + \u0026#39;æ—¥ï¼Œ\u0026#39; + hour + \u0026#39;æ—¶\u0026#39; + minute + \u0026#39;åˆ†\u0026#39; + second + \u0026#39;ç§’\u0026#39;; document.getElementById(\u0026#34;time\u0026#34;).innerHTML = formattedDate; } setInterval(showTime, 1000); è¿™æ®µä»£ç æ˜¯ç”¨ JavaScript å®ç°ä¸€ä¸ªå®æ—¶æ˜¾ç¤ºå½“å‰æ—¶é—´çš„é¡µé¢ç‰¹æ•ˆ,åŸç†ï¼š é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª showTime() å‡½æ•°ï¼Œå®ƒé€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°çš„ Date å¯¹è±¡æ¥è·å–å½“å‰æ—¶é—´ï¼Œå¹¶ä»ä¸­æå–å¹´ã€æœˆã€æ—¥ã€å°æ—¶ã€åˆ†é’Ÿå’Œç§’çš„å€¼ã€‚ç„¶åä½¿ç”¨ padStart() å‡½æ•°æ¥ç¡®ä¿æœˆã€æ—¥ã€å°æ—¶ã€åˆ†é’Ÿå’Œç§’éƒ½æ˜¯ä¸¤ä½æ•°ï¼ˆå¦‚æœå‰ç¼€ä¸è¶³ï¼Œåˆ™åœ¨å‰é¢æ·»åŠ  \u0026lsquo;0\u0026rsquo;ï¼‰ã€‚ æ¥ä¸‹æ¥ï¼Œå°†å„ä¸ªæå–çš„æ—¶é—´å€¼æ•´åˆä¸ºä¸€ä¸ªå­—ç¬¦ä¸² formattedDateï¼Œå…¶ä¸­å„ä¸ªéƒ¨åˆ†ä¹‹é—´æ·»åŠ äº†ä¸€äº›ä¸­æ–‡å­—ç¬¦ä½œä¸ºåˆ†éš”ç¬¦ã€‚ æœ€åï¼Œå°†æ‹¼æ¥å¥½çš„æ—¶é—´å­—ç¬¦ä¸²èµ‹å€¼ç»™é¡µé¢ä¸Šå¸¦æœ‰ \u0026ldquo;time\u0026rdquo; ID çš„å…ƒç´ ï¼Œå¹¶é€šè¿‡è°ƒç”¨ setInterval() å‡½æ•°æ¯éš”ä¸€ç§’é’Ÿæ›´æ–°ä¸€æ¬¡è¯¥å…ƒç´ çš„å†…å®¹ï¼Œä»è€Œå®ç°äº†å®æ—¶æ˜¾ç¤ºå½“å‰æ—¶é—´çš„æ•ˆæœã€‚\nè¿™ä¸ªä¾‹å­æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯é€šè¿‡è¿™ä¸ªä¾‹å­å¯ä»¥äº†è§£åˆ° JavaScript ä¸­è·å–å’Œå¤„ç†æ—¶é—´çš„åŸºæœ¬æ–¹æ³•ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨å®šæ—¶å™¨æ¥å®šæœŸæ›´æ–°é¡µé¢å†…å®¹ã€‚\necharts\nhttps://echarts.apache.org/examples/zh/index.html#chart-type-line\nä¾‹å­ï¼šhttps://echarts.apache.org/examples/zh/editor.html?c=gauge-simple\næˆ‘ä»¬è¦ä½¿ç”¨ è¿™ä¸ªJSæ¥è¿›è¡Œå¤§å±å±•ç¤º CPU\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 var myChart_CPU = echarts.init(document.getElementById(\u0026#39;cpu\u0026#39;)); // æŒ‡å®šå›¾è¡¨çš„é…ç½®é¡¹å’Œæ•°æ® var option_cpu = { tooltip: { formatter: \u0026#39;{a} \u0026lt;br/\u0026gt;{b} : {c}%\u0026#39; }, series: [ { name: \u0026#39;CPU\u0026#39;, type: \u0026#39;gauge\u0026#39;, progress: { show: true }, detail: { valueAnimation: true, formatter: \u0026#39;{value}\u0026#39; }, data: [ { value: \u0026#39;{{ cpu_percent }} %\u0026#39;, name: \u0026#39;CPUä½¿ç”¨ç‡\u0026#39; } ] } ] }; // å®šä¹‰å‡½æ•°ï¼Œå‘é€ Ajax è¯·æ±‚è·å–å†…å­˜ä½¿ç”¨ç‡æ•°æ® function getCPUData() { // ä½¿ç”¨åŸç”Ÿ JavaScript å‘é€ Ajax è¯·æ±‚ // var xhr = new XMLHttpRequest(); // xhr.onreadystatechange = function () { // if (xhr.readyState === 4 \u0026amp;\u0026amp; xhr.status === 200) { // var cpuPercent = JSON.parse(xhr.responseText).cpu_percent; // updateChart_cpu(cpuPercent); // è°ƒç”¨æ›´æ–°å›¾è¡¨çš„å‡½æ•° // } // }; // xhr.open(\u0026#39;GET\u0026#39;, \u0026#39;/get_cpu_data\u0026#39;, true); // xhr.send(); // ä½¿ç”¨ jQuery å‘é€ Ajax è¯·æ±‚ $.ajax({ url: \u0026#39;/get_cpu_data\u0026#39;, dataType: \u0026#39;json\u0026#39;, type: \u0026#39;GET\u0026#39;, success: function (data) { var cpuPercent = data.cpu_percent; updateChart_cpu(cpuPercent); // è°ƒç”¨æ›´æ–°å›¾è¡¨çš„å‡½æ•° }, error: function (xhr, status, error) { console.log(\u0026#39;è·å–æ•°æ®å¤±è´¥\u0026#39;); } }); } // å®šä¹‰å‡½æ•°ï¼Œæ›´æ–°å›¾è¡¨æ•°æ®å¹¶é‡æ–°æ¸²æŸ“å›¾è¡¨ function updateChart_cpu(cpuPercent) { option_cpu.series[0].data[0].value = cpuPercent; myChart_CPU.setOption(option_cpu); } // ä½¿ç”¨åˆšæŒ‡å®šçš„é…ç½®é¡¹å’Œæ•°æ®æ˜¾ç¤ºå›¾è¡¨ã€‚ myChart_CPU.setOption(option_cpu); // ä½¿ç”¨ setInterval å®šæ—¶åˆ·æ–°æ•°æ® setInterval(getCPUData, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ® è¿™ä¸ªåªæ˜¯å‰ç«¯çš„JSè¯·æ±‚åç«¯çš„æ¥å£è·å–åˆ°æ•°æ®æ‰ä¼šæ˜¾ç¤ºï¼ˆ/get_cpu_dataï¼‰\n1 2 3 4 5 6 @app.route(\u0026#39;/get_cpu_data\u0026#39;) def get_cpu_data(): # è·å–æœºå™¨çš„ CPU ä½¿ç”¨ç‡ cpu_percent = psutil.cpu_percent() print(cpu_percent) return jsonify(cpu_percent=cpu_percent) è¿›å‡»ç‰ˆï¼ˆJSå’ŒCSSå‰¥ç¦»ï¼‰ CSS åœ¨static ç›®å½• åˆ›å»º CSSæ–‡ä»¶ç›®å½• cpu.css\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #cpu { position: absolute; width: 30%; height: 40%; top: 10%; left: 0%; background: #48dada; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; /* åŠ ç²—å­—ä½“ */ border-radius: 10px; /* å¢åŠ åœ†æ¶¦æ„Ÿ */ box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* å¢åŠ ä¸€äº›é˜´å½±ï¼Œå¢åŠ ç§‘æŠ€æ„Ÿ */ } åœ¨htmlé¡µé¢å¼•å…¥ç›¸å…³çš„css\n1 \u0026lt;link href=\u0026#34;../static/css/main.css\u0026#34; rel=\u0026#34;stylesheet\u0026#34; /\u0026gt; JS cpu.js\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 var myChart_CPU = echarts.init(document.getElementById(\u0026#39;cpu\u0026#39;)); // æŒ‡å®šå›¾è¡¨çš„é…ç½®é¡¹å’Œæ•°æ® var option_cpu = { tooltip: { formatter: \u0026#39;{a} \u0026lt;br/\u0026gt;{b} : {c}%\u0026#39; }, series: [ { name: \u0026#39;CPU\u0026#39;, type: \u0026#39;gauge\u0026#39;, progress: { show: true }, detail: { valueAnimation: true, formatter: \u0026#39;{value}\u0026#39; }, data: [ { value: \u0026#39;0\u0026#39;, name: \u0026#39;CPUä½¿ç”¨ç‡\u0026#39; } ] } ] }; // ä½¿ç”¨åˆšæŒ‡å®šçš„é…ç½®é¡¹å’Œæ•°æ®æ˜¾ç¤ºå›¾è¡¨ã€‚ myChart_CPU.setOption(option_cpu); controller.js\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 function getCPUData() { // ä½¿ç”¨åŸç”Ÿ JavaScript å‘é€ Ajax è¯·æ±‚ // var xhr = new XMLHttpRequest(); // xhr.onreadystatechange = function () { // if (xhr.readyState === 4 \u0026amp;\u0026amp; xhr.status === 200) { // var cpuPercent = JSON.parse(xhr.responseText).cpu_percent; // updateChart_cpu(cpuPercent); // è°ƒç”¨æ›´æ–°å›¾è¡¨çš„å‡½æ•° // } // }; // xhr.open(\u0026#39;GET\u0026#39;, \u0026#39;/get_cpu_data\u0026#39;, true); // xhr.send(); // ä½¿ç”¨ jQuery å‘é€ Ajax è¯·æ±‚ $.ajax({ url: \u0026#39;/get_cpu_data\u0026#39;, dataType: \u0026#39;json\u0026#39;, type: \u0026#39;GET\u0026#39;, success: function (data) { var cpuPercent = data.cpu_percent; updateChart_cpu(cpuPercent); // è°ƒç”¨æ›´æ–°å›¾è¡¨çš„å‡½æ•° }, error: function (xhr, status, error) { console.log(\u0026#39;è·å–æ•°æ®å¤±è´¥\u0026#39;); } }); } // å®šä¹‰å‡½æ•°ï¼Œæ›´æ–°å›¾è¡¨æ•°æ®å¹¶é‡æ–°æ¸²æŸ“å›¾è¡¨ function updateChart_cpu(cpuPercent) { option_cpu.series[0].data[0].value = cpuPercent; myChart_CPU.setOption(option_cpu); } getCPUData(); setInterval(getCPUData, 5000); åœ¨htmlé¡µé¢è¿›è¡Œå¼•å…¥ï¼Œåˆ‡è®°ï¼Œcontroller.js æœ€å¥½ä¸€ä¸ªå¼•å…¥\n1 2 \u0026lt;script src=\u0026#34;../static/js/cpu.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;../static/js/controller.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; æ­£å¸¸æ˜¾ç¤º\nåç»­å¦‚æœç»§ç»­æ·±å…¥ç ”ç©¶ï¼Œåç«¯æ¡†æ¶å¯ä»¥æ¢æˆé«˜æ€§èƒ½çš„tornadoæˆ–è€…åŠŸèƒ½æ›´å¼ºå¤§çš„Djangoï¼Œå¯è§†åŒ–çš„ç»„ä»¶å¯ä»¥æ¢æˆpyechartsï¼Œå‰ç«¯å¯ä»¥ä½¿ç”¨vueï¼Œreactæ¡†æ¶ç­‰ã€‚è¿˜å¯ä»¥è€ƒè™‘åŠ å…¥sqliteæ•°æ®åº“æˆ–è¿æ¥dbæ•°æ®åº“ï¼Œæ‰“é€ æˆä¸€ä¸ªæ›´å®Œæ•´çš„é¡¹ç›®ã€‚\nå‚è€ƒæ–‡æ¡£ï¼š https://www.cnblogs.com/hugboy/p/15427793.html https://zhuanlan.zhihu.com/p/584796840 https://github.com/xiaokai1996/big_screen/blob/master/big_screen%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.md https://blog.csdn.net/dwhyxjfm/article/details/127946379\n","date":"2023-09-22T16:13:03Z","image":"https://www.ownit.top/title_pic/27.jpg","permalink":"https://www.ownit.top/p/202309221613/","title":"Flaské…åˆEchartså†™ä¸€ä¸ªåŠ¨æ€å¯è§†åŒ–å¤§å±"},{"content":"å¼•è¨€ åœ¨å¼€å‘åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶ï¼Œè°ƒè¯•æ˜¯ä¸€ä¸ªé‡è¦ä½†å¤æ‚çš„ç¯èŠ‚ã€‚å¼€å‘è€…é€šå¸¸éœ€è¦è·¨è¶Šå¤šä¸ªæœåŠ¡ã€æ¨¡å—å’Œçº¿ç¨‹æ¥è¿½è¸ªå’Œè§£å†³é—®é¢˜ã€‚åœ¨æ²¡æœ‰è¿œç¨‹è°ƒè¯•çš„æƒ…å†µä¸‹ï¼Œè®¸å¤šå¼€å‘è€…ä¼šåœ¨ä»£ç ä¸­æ·»åŠ å„ç§æ—¥å¿—è¯­å¥ï¼Œç„¶åé‡æ–°éƒ¨ç½²å’Œä¸Šçº¿æ¥è°ƒè¯•ã€‚è¿™ç§æ–¹æ³•ä¸ä»…è´¹æ—¶ï¼Œè€Œä¸”å¯èƒ½å¼•å…¥é¢å¤–çš„é”™è¯¯æˆ–é—®é¢˜ã€‚\næœ‰æ—¶å€™ï¼Œåœ¨æœ¬åœ°ç¯å¢ƒä¸­è°ƒè¯•æ—¶æ²¡æœ‰å‘ç°é—®é¢˜ï¼Œä½†å½“ä»£ç è¢«æ‰“åŒ…å¹¶éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒæ—¶ï¼Œå´ä¼šå‡ºç°ä¸€å †è«åå…¶å¦™çš„é—®é¢˜ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºä¸åŒçš„ç¯å¢ƒã€é…ç½®æˆ–æœåŠ¡ä¹‹é—´çš„äº¤äº’å¯¼è‡´äº†é—®é¢˜çš„å‡ºç°ã€‚\nå¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ç§å¼ºå¤§çš„å·¥å…·å¯ä»¥å¸®åŠ©è§£å†³è¿™äº›é—®é¢˜ï¼Œé‚£å°±æ˜¯è¿œç¨‹è°ƒè¯•ã€‚é€šè¿‡è¿œç¨‹è°ƒè¯•ï¼Œå¼€å‘è€…å¯ä»¥åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šç›´æ¥å¯¹Javaåº”ç”¨ç¨‹åºè¿›è¡Œè°ƒè¯•ï¼Œå°±åƒåœ¨æœ¬åœ°ç¯å¢ƒä¸­ä¸€æ ·ã€‚è¿™æ ·ï¼Œå°±å¯ä»¥é¿å…é‡æ–°éƒ¨ç½²å’Œä¸Šçº¿çš„è€—æ—¶è¿‡ç¨‹ï¼Œå¹¶ä¸”å¯ä»¥å®æ—¶æŸ¥çœ‹å’Œä¿®æ”¹å˜é‡çš„å€¼ã€æŸ¥çœ‹å †æ ˆä¿¡æ¯ç­‰ã€‚\næœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨IntelliJ IDEAçš„è¿œç¨‹è°ƒè¯•åŠŸèƒ½æ¥é«˜æ•ˆè°ƒè¯•åˆ†å¸ƒå¼ç³»ç»Ÿã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å°†æ¢è®¨ä¸€äº›å¸¸è§çš„è°ƒè¯•é—®é¢˜å’Œè§£å†³æ–¹æ³•ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°åº”å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿå¼€å‘ä¸­çš„æŒ‘æˆ˜ã€‚\n1ã€å‡†å¤‡å·¥ä½œ 1ã€ç¡®ä¿ä½ çš„IDEAå·²ç»å®‰è£…å¹¶é…ç½®å¥½ï¼Œä¸”å·²å®‰è£…äº†Javaå¼€å‘å·¥å…·åŒ…ï¼ˆJDKï¼‰ã€‚ ç¡®ä¿ä½ çš„Javaåº”ç”¨ç¨‹åºå·²ç»éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Šï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡è¿œç¨‹è®¿é—®è¿›è¡Œè°ƒè¯•ã€‚\n2ã€å¯åŠ¨è°ƒè¯•åº”ç”¨ ä½¿ç”¨ç‰¹å®šJVMå‚æ•°è¿è¡ŒæœåŠ¡ç«¯ä»£ç  è¦è®©è¿œç¨‹æœåŠ¡å™¨è¿è¡Œçš„ä»£ç æ”¯æŒè¿œç¨‹è°ƒè¯•ï¼Œåˆ™å¯åŠ¨çš„æ—¶å€™å¿…é¡»åŠ ä¸Šç‰¹å®šçš„JVMå‚æ•°ï¼Œè¿™äº›å‚æ•°æ˜¯ï¼š\n1 2 3 4 5 6 -Xdebug -Xrunjdwp:transport=dt_socket,suspend=n,server=y,address=${debug_port} æˆ–è€… -Xdebug -Xrunjdwp:transport=dt_socket,suspend=n,server=y,address=127.0.0.1:5555 å°†addressè®¾ç½®ä¸º127.0.0.1:5555ï¼Œè¡¨ç¤ºå°†è°ƒè¯•ç«¯å£é™åˆ¶ä¸ºæœ¬åœ°è®¿é—®ï¼Œè¿œç¨‹æ— æ³•è®¿é—®ï¼Œ è®¾ç½®å‚æ•°åº”è¯¥æ³¨æ„ å…¶ä¸­çš„${debug_port}æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œä¸ºdebugç«¯å£ï¼Œæœ¬ä¾‹ä»¥5005ç«¯å£ä¸ºä¾‹ã€‚ å¦‚æœåªæ˜¯ä¸´æ—¶è°ƒè¯•ï¼Œåœ¨ç«¯å£å·å‰é¢ä¸è¦åŠ ä¸Šé™åˆ¶è®¿é—®çš„IPåœ°å€ï¼Œè°ƒè¯•å®Œæˆä¹‹åï¼Œå°†ä¸Šè¿°JVMå‚æ•°å»é™¤æ‰ä¹‹åé‡æ–°å‘å¸ƒä¸‹ï¼Œé˜²èŒƒå¼€æ”¾è¿œç¨‹è°ƒè¯•ç«¯å£å¯èƒ½å¸¦æ¥çš„å®‰å…¨é£é™©ã€‚\n1 java -Dspring.config.location=application-pre.yml -Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=n -jar fubaodai-app-1.0-SNAPSHOT.jar 3ã€é…ç½®è¿œç¨‹è°ƒè¯• åœ¨IDEAä¸­ï¼Œæ‰“å¼€\u0026quot;Run/Debug Configurations\u0026quot;å¯¹è¯æ¡†ã€‚ åœ¨å¯¹è¯æ¡†ä¸­ï¼Œç‚¹å‡»\u0026quot;+\u0026ldquo;æŒ‰é’®ï¼Œé€‰æ‹©\u0026quot;Remote\u0026rdquo;ã€‚ åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œå¡«å†™è¿œç¨‹æœåŠ¡å™¨çš„è¿æ¥ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨IPåœ°å€ã€ç«¯å£å·ã€è°ƒè¯•åè®®ç­‰ã€‚ ç‚¹å‡»\u0026quot;OK\u0026quot;æŒ‰é’®ä¿å­˜é…ç½®ã€‚ æˆ–è€… Remote 4ã€æœ¬åœ°IDEAå¯åŠ¨debugæ¨¡å¼ **è¦æ±‚ï¼š**åŒæ–¹ä»£ç ä¸€è‡´ï¼Œå¦åˆ™è¿œç¨‹è°ƒè¯•æ— æ³•å¯åŠ¨ï¼› æœ¬åœ°å¯åŠ¨åˆšåˆšé…ç½®çš„ Remote Serverï¼Œæ­£å¸¸æ—¶ä¼šçœ‹åˆ°æ—¥å¿—:\n1 Connected to the target VM, address: \u0026#39;xxx:5005\u0026#39;, transport: \u0026#39;socket\u0026#39; 5ã€è®¾ç½®æ–­ç‚¹ï¼Œå¼€å§‹è°ƒè¯• æœ¬åœ° IDEA ä»£ç ä¸­è®¾ç½®æ–­ç‚¹ æµè§ˆå™¨æˆ–æ‰‹æœº HTTP è®¿é—®æœåŠ¡å™¨ IDEA å³å¯åœ¨æ–­ç‚¹æš‚åœå¹¶è·Ÿè¸ª 6ã€è¿œç¨‹è°ƒè¯•çš„é—®é¢˜å’Œæ³¨æ„äº‹é¡¹ ç¡®ä¿è¿œç¨‹æœåŠ¡å™¨çš„Javaç‰ˆæœ¬å’ŒIDEAçš„Javaç‰ˆæœ¬ä¸€è‡´ã€‚ ç¡®ä¿è¿œç¨‹æœåŠ¡å™¨çš„é˜²ç«å¢™è®¾ç½®å…è®¸IDEAçš„è°ƒè¯•è¿æ¥é€šè¿‡ã€‚ ç¡®ä¿è¿œç¨‹æœåŠ¡å™¨ä¸Šå·²ç»å®‰è£…äº†æ‰€éœ€çš„è°ƒè¯•å·¥å…·ï¼ˆå¦‚jdbï¼‰ã€‚ åœ¨è¿œç¨‹è°ƒè¯•æ—¶ï¼Œéœ€è¦æ³¨æ„ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚å¯†ç ã€å¯†é’¥ç­‰ã€‚ åœ¨ä¿®æ”¹ä»£ç æ—¶ï¼Œéœ€è¦åŒæ­¥è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ä»£ç ï¼Œä»¥å…å‡ºç°ç‰ˆæœ¬ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ ","date":"2023-09-06T15:14:42Z","image":"https://www.ownit.top/title_pic/25.jpg","permalink":"https://www.ownit.top/p/202309061514/","title":"IntelliJ IDEAè¿œç¨‹è°ƒè¯•ï¼šä½¿ç”¨IDEA Remote Debugè¿›è¡Œé«˜æ•ˆè°ƒè¯•çš„æŒ‡å—"},{"content":"å¼•è¨€ Jumpserveræ˜¯ä¸€æ¬¾å¼ºå¤§çš„å ¡å’æœºç³»ç»Ÿï¼Œå¯ä»¥æœ‰æ•ˆç®¡ç†å’Œæ§åˆ¶ä¼ä¸šå†…éƒ¨æœåŠ¡å™¨çš„è®¿é—®æƒé™ï¼Œæé«˜ç½‘ç»œå®‰å…¨æ€§ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨Pythonç¼–ç¨‹è¯­è¨€ï¼Œç»“åˆJumpserveræä¾›çš„APIæ¥å£ï¼Œå®ç°å¯¹è·³æ¿æœºçš„ç®¡ç†å’Œæ“ä½œã€‚\n1ã€ä»€ä¹ˆæ˜¯Jumpserverï¼Ÿ Jumpserveræ˜¯ä¸€ç§å ¡å’æœºç³»ç»Ÿï¼Œå®ƒæä¾›äº†ä¸€ç§å®‰å…¨ä¸”é›†ä¸­çš„æ–¹å¼æ¥ç®¡ç†å’Œæ§åˆ¶ç”¨æˆ·å¯¹æœåŠ¡å™¨çš„è®¿é—®æƒé™ã€‚Jumpserverå¯ä»¥å¸®åŠ©ä¼ä¸šå®ç°ç»Ÿä¸€è®¤è¯ã€å®¡è®¡æ—¥å¿—è®°å½•ã€æƒé™ç®¡ç†ç­‰åŠŸèƒ½ï¼Œä»è€Œæé«˜ç½‘ç»œå®‰å…¨æ€§ã€‚\n2ã€Jumpserveræä¾›çš„APIæ¥å£ Jumpserveræä¾›äº†ä¸€ç»„å¼ºå¤§çš„APIæ¥å£ï¼Œå¯ä»¥å®ç°å¯¹è·³æ¿æœºçš„ç®¡ç†å’Œæ“ä½œã€‚è¿™äº›APIåŒ…æ‹¬è·å–æœåŠ¡å™¨åˆ—è¡¨ã€è®¤è¯è®¿é—®æƒé™ã€æ‰§è¡Œå‘½ä»¤å’Œæ–‡ä»¶ä¼ è¾“ç­‰åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡HTTPè¯·æ±‚è¿›è¡Œè°ƒç”¨ã€‚\nç›®å‰ä½¿ç”¨çš„ç‰ˆæœ¬ï¼šv3.6.2 ä¸åŒæ­¥çš„ç‰ˆæœ¬ï¼ŒAPI æ¥å£æœ‰å˜åŒ–\nhttps://docs.jumpserver.org/zh/v3/dev/rest_api/ 3ã€Pythonä¸­çš„HTTPè¯·æ±‚åº“ åœ¨Pythonä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„HTTPè¯·æ±‚åº“ï¼Œå¦‚requestsåº“æˆ–http.clientåº“ï¼Œæ¥å‘é€HTTPè¯·æ±‚å¹¶è·å–å“åº”ã€‚è¿™äº›åº“æä¾›äº†ç®€æ´çš„æ¥å£ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä¸Jumpserverçš„APIè¿›è¡Œäº¤äº’ã€‚\nrequestsåº“ï¼š requestsæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€ç®€å•æ˜“ç”¨çš„ç¬¬ä¸‰æ–¹HTTPè¯·æ±‚åº“ï¼Œå¹¿æ³›åº”ç”¨äºPythonå¼€å‘ä¸­ã€‚å®ƒæä¾›äº†ç®€æ´çš„APIï¼Œä½¿å¾—å‘é€HTTPè¯·æ±‚å˜å¾—éå¸¸ç®€å•ã€‚ä½¿ç”¨requestsåº“ï¼Œæˆ‘ä»¬å¯ä»¥å‘é€å„ç§ç±»å‹çš„HTTPè¯·æ±‚ï¼ˆGETã€POSTã€PUTç­‰ï¼‰ï¼Œè®¾ç½®è¯·æ±‚å¤´ã€è¯·æ±‚å‚æ•°ã€è¯·æ±‚ä½“ç­‰ï¼Œå¹¶èƒ½å¤Ÿè·å¾—æœåŠ¡å™¨å“åº”çš„çŠ¶æ€ç ã€å†…å®¹ç­‰ä¿¡æ¯ã€‚\nç¤ºä¾‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 import requests # å‘é€GETè¯·æ±‚å¹¶è·å–å“åº” response = requests.get(\u0026#39;https://api.example.com/users\u0026#39;) # è·å–å“åº”å†…å®¹ content = response.text # è·å–å“åº”çŠ¶æ€ç  status_code = response.status_code 4ã€ä½¿ç”¨Pythonè°ƒç”¨Jumpserver APIè¿›è¡Œè®¤è¯ åœ¨ä½¿ç”¨Jumpserverçš„APIä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè¿›è¡Œè®¤è¯ã€‚é€šå¸¸ï¼ŒJumpserverä¼šæä¾›ä¸€ä¸ªç™»å½•æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç™»å½•ï¼Œå¹¶è·å–åˆ°è®¿é—®ä»¤ç‰Œï¼ˆAccess Tokenï¼‰ã€‚åœ¨åç»­çš„APIè¯·æ±‚ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†è¯¥è®¿é—®ä»¤ç‰Œä½œä¸ºè®¤è¯å‡­è¯ã€‚ https://docs.jumpserver.org/zh/v3/dev/rest_api/#12 æ¨èä½¿ç”¨ï¼šAccess Keyæ–¹å¼ æˆ–è€… Private Token 1 2 3 4 5 6 7 8 docker exec -it jms_core /bin/bash cd /opt/jumpserver/apps python manage.py shell from users.models import User u = User.objects.get(username=\u0026#39;admin\u0026#39;) u.create_private_token() å·²ç»å­˜åœ¨ private_tokenï¼Œå¯ä»¥ç›´æ¥è·å–å³å¯ u.private_token æ­¤å¤„æˆ‘æ‰ç”¨åŒå±‚éªŒè¯æ–¹å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 KeyID = \u0026#39;77e76d19-141c-xxx-8d2b-xxxx\u0026#39; SecretID = \u0026#39;a04817bc-0bb1-439f-baa2-xxxx\u0026#39; gmt_form = \u0026#39;%a, %d %b %Y %H:%M:%S GMT\u0026#39; ptivate_token = \u0026#39;xxxxxxxxxx\u0026#39; headers = { \u0026#39;accept\u0026#39;: \u0026#39;application/json\u0026#39;, \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;, # \u0026#39;X-CSRFToken\u0026#39;: \u0026#39;eoLo2AVcQK5X1JQ392JHCzjZ8wPCWZJFJao5O9ObH8zQwtiPhGBzaOnNKjaENShf\u0026#39;, \u0026#34;Authorization\u0026#34;: \u0026#39;Token \u0026#39; + ptivate_token, \u0026#39;X-JMS-ORG\u0026#39;: \u0026#39;00000000-0000-0000-0000-000000000002\u0026#39;, \u0026#39;Date\u0026#39;: datetime.datetime.utcnow().strftime(gmt_form) } # è®¤è¯ def get_auth(KeyID, SecretID): \u0026#34;\u0026#34;\u0026#34; è®¤è¯ :param KeyID: The key ID :param SecretID: The secret ID :return: \u0026#34;\u0026#34;\u0026#34; signature_headers = [\u0026#39;(request-target)\u0026#39;, \u0026#39;accept\u0026#39;, \u0026#39;date\u0026#39;] auth = HTTPSignatureAuth(key_id=KeyID, secret=SecretID, algorithm=\u0026#39;hmac-sha256\u0026#39;, headers=signature_headers) return auth auth = get_auth(KeyID, SecretID) 5ã€Jumpserveræ¥å£è‡ªåŠ¨è°ƒç”¨ è·å–æ‰€æœ‰ç”¨æˆ·\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # è·å–æ‰€æœ‰ç”¨æˆ· def get_user_all(): \u0026#34;\u0026#34;\u0026#34; è·å–æ‰€æœ‰ç”¨æˆ· :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#39;/api/v1/users/users/\u0026#39; response = requests.get(url, auth=auth, headers=headers) user_list = json.loads(response.text) count = 0 for i in user_list: count += 1 print(i) print(count) è·å–ç›‘æ§æŒ‡æ ‡\n1 2 3 4 5 6 7 8 9 10 # è·å–ç›‘æ§æŒ‡æ ‡ def get_prometheus_metric(): \u0026#34;\u0026#34;\u0026#34; è·å–ç›‘æ§æŒ‡æ ‡ :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/prometheus/metrics/\u0026#34; response = requests.get(url, headers=headers, auth=auth) print(response.text) return response.text è·å–æ‰€æœ‰èµ„äº§èŠ‚ç‚¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # è·å–æ‰€æœ‰èµ„äº§èŠ‚ç‚¹ def get_node_all(): \u0026#34;\u0026#34;\u0026#34; è·å–æ‰€æœ‰èµ„äº§èŠ‚ç‚¹ :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/assets/nodes/\u0026#34; response = requests.get(url, headers=headers, auth=auth) node_list = json.loads(response.text) count = 0 for i in node_list: count += 1 print(i) print(count) return response.json() æŸ¥çœ‹å½“å‰tokenï¼ˆå³adminï¼‰çš„æ‰€æœ‰èµ„äº§\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 def get_asset_all(): \u0026#34;\u0026#34;\u0026#34; æŸ¥çœ‹å½“å‰tokenï¼ˆå³adminï¼‰çš„æ‰€æœ‰èµ„äº§ :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/assets/assets/\u0026#34; response = requests.get(url, headers=headers, auth=auth) node_list = json.loads(response.text) count = 0 for i in node_list: count += 1 print(i) print(count) return response.json() åˆ›å»ºèµ„äº§èŠ‚ç‚¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 def assets_nodes_create(node_name): \u0026#34;\u0026#34;\u0026#34; åˆ›å»ºèµ„äº§èŠ‚ç‚¹ :param node_name: :return: \u0026#34;\u0026#34;\u0026#34; node_data = { \u0026#34;value\u0026#34;: node_name } url = jms_url + \u0026#34;/api/v1/assets/nodes/\u0026#34; node_info = get_node_info(node_name) if node_info: # æ ¹æ®node_nameå»æŸ¥è¯¢ï¼Œå¦‚æœæŸ¥åˆ°äº†è¯´æ˜å·²ç»æœ‰äº†ã€‚ print(\u0026#34;{name}å·²å­˜åœ¨, id: {id}\u0026#34;.format(name=node_name, id=node_info[0][\u0026#34;id\u0026#34;])) else: data = json.dumps(node_data) resp = requests.post(url, headers=headers, data=data) return resp.json() æ ¹æ®ipè·å–èµ„äº§ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 def get_assets_list_by_ip(ip): \u0026#34;\u0026#34;\u0026#34; æ ¹æ®ipè·å–èµ„äº§ä¿¡æ¯ :param ip: :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/assets/assets/\u0026#34; response = requests.get(url, headers=headers, params={ \u0026#34;ip\u0026#34;: ip }) print(response.json()) return response.json() æŸ¥çœ‹èµ„äº§èŠ‚ç‚¹ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 def get_node_info(node_name): \u0026#34;\u0026#34;\u0026#34; æŸ¥çœ‹èµ„äº§èŠ‚ç‚¹ä¿¡æ¯ :param node_name: èŠ‚ç‚¹åç§° :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/assets/nodes/\u0026#34; response = requests.get(url, auth=auth, headers=headers, params={ \u0026#34;value\u0026#34;: node_name }) print(response.text) return response.json() åˆ›å»ºèµ„äº§æœºå™¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 # åˆ›å»ºèµ„äº§æœºå™¨ def asset_create(ip, hostname, node_id, comment): \u0026#34;\u0026#34;\u0026#34; åˆ›å»ºèµ„äº§æœºå™¨ :param ip: ipåœ°å€ :param hostname: ä¸»æœºå :param node_id: èŠ‚ç‚¹id :return: è¿”å›åˆ›å»ºçš„èµ„äº§ä¿¡æ¯ \u0026#34;\u0026#34;\u0026#34; asset_Data = { \u0026#34;name\u0026#34;: hostname, \u0026#34;address\u0026#34;: ip, \u0026#34;platform\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;protocols\u0026#34;: [{ \u0026#34;name\u0026#34;: \u0026#34;ssh\u0026#34;, \u0026#34;port\u0026#34;: 22 }], \u0026#34;is_active\u0026#34;: True, \u0026#34;nodes\u0026#34;: [node_id], \u0026#34;comment\u0026#34;: comment, \u0026#34;accounts\u0026#34;: [{ # è´¦å·æ¨¡æ¿id \u0026#34;template\u0026#34;: \u0026#34;60b11033-a6e1-467d-8388-68a0e64134ff\u0026#34;, }] } url = jms_url + \u0026#34;/api/v1/assets/hosts/\u0026#34; print(url) data = json.dumps(asset_Data) print(data) response = requests.post(url, auth=auth, headers=headers, data=data) print(response.text) è¿è¡Œåˆ›å»ºæœåŠ¡å™¨èµ„äº§\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # è¿è¡Œåˆ›å»ºæœåŠ¡å™¨èµ„äº§ def run_create_assets(node_name, project_name, ip, comment): \u0026#34;\u0026#34;\u0026#34; è¿è¡Œåˆ›å»ºæœåŠ¡å™¨èµ„äº§ :param node_name: èŠ‚ç‚¹åç§° :param project_name: æœºå™¨åç§° :param ip: ipåœ°å€ :param comment: å¤‡æ³¨ :return: \u0026#34;\u0026#34;\u0026#34; # èŠ‚ç‚¹idï¼Œæ— èŠ‚ç‚¹æ—¶åˆ›å»ºèŠ‚ç‚¹ node_info = get_node_info(node_name) # å¦‚æœlen(node_info) == 0 è¯´æ˜æ²¡æœ‰èŠ‚ç‚¹ï¼Œéœ€è¦åˆ›å»ºèŠ‚ç‚¹ if len(node_info) == 0: # åˆ›å»ºèŠ‚ç‚¹ node_id = assets_nodes_create(node_name) print(node_id) else: # è·å–èŠ‚ç‚¹id node_id = node_info[0][\u0026#34;id\u0026#34;] print(node_id) # ç®¡ç†ç”¨æˆ· id hostname = \u0026#34;{ip}_{project_name}\u0026#34;.format(ip=ip, project_name=project_name) # æŸ¥IP,åˆ›å»ºèµ„äº§ ip_info = get_assets_list_by_ip(ip) if ip_info: print(\u0026#34;%s å·²å­˜åœ¨ï¼Œnodes: %s\u0026#34; % (ip_info[0][\u0026#34;address\u0026#34;], ip_info[0][\u0026#34;nodes\u0026#34;])) else: asset_create(ip, hostname, node_id, comment) è·å–ç»„ç»‡ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 def get_org_info(): \u0026#34;\u0026#34;\u0026#34; è·å–ç»„ç»‡ä¿¡æ¯ :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/orgs/orgs/\u0026#34; response = requests.get(url, headers=headers) org_list = response.text print(org_list) for i in org_list.split(\u0026#34;id\u0026#34;): print(i) return response.json() 6ã€å®Œæ•´ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 # -*- coding: utf-8 -*- # @Time : 2023/8/29 14:21 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : jms_add.py # @Software: PyCharm import requests, datetime, json from httpsig.requests_auth import HTTPSignatureAuth KeyID = \u0026#39;77e76d19-141c-4545--xxx\u0026#39; SecretID = \u0026#39;a04817bc-0bb1-439f-baa2-xxxx\u0026#39; gmt_form = \u0026#39;%a, %d %b %Y %H:%M:%S GMT\u0026#39; ptivate_token = \u0026#39;xxxxx\u0026#39; headers = { \u0026#39;accept\u0026#39;: \u0026#39;application/json\u0026#39;, \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;, # \u0026#39;X-CSRFToken\u0026#39;: \u0026#39;eoLo2AVcQK5X1JQ392JHCzjZ8wPCWZJFJao5O9ObH8zQwtiPhGBzaOnNKjaENShf\u0026#39;, \u0026#34;Authorization\u0026#34;: \u0026#39;Token \u0026#39; + ptivate_token, \u0026#39;X-JMS-ORG\u0026#39;: \u0026#39;00000000-0000-0000-0000-000000000002\u0026#39;, \u0026#39;Date\u0026#39;: datetime.datetime.utcnow().strftime(gmt_form) } # è®¤è¯ def get_auth(KeyID, SecretID): \u0026#34;\u0026#34;\u0026#34; è®¤è¯ :param KeyID: The key ID :param SecretID: The secret ID :return: \u0026#34;\u0026#34;\u0026#34; signature_headers = [\u0026#39;(request-target)\u0026#39;, \u0026#39;accept\u0026#39;, \u0026#39;date\u0026#39;] auth = HTTPSignatureAuth(key_id=KeyID, secret=SecretID, algorithm=\u0026#39;hmac-sha256\u0026#39;, headers=signature_headers) return auth auth = get_auth(KeyID, SecretID) # è·å–æ‰€æœ‰ç”¨æˆ· def get_user_all(): \u0026#34;\u0026#34;\u0026#34; è·å–æ‰€æœ‰ç”¨æˆ· :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#39;/api/v1/users/users/\u0026#39; response = requests.get(url, auth=auth, headers=headers) user_list = json.loads(response.text) count = 0 for i in user_list: count += 1 print(i) print(count) # è·å–ç›‘æ§æŒ‡æ ‡ def get_prometheus_metric(): \u0026#34;\u0026#34;\u0026#34; è·å–ç›‘æ§æŒ‡æ ‡ :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/prometheus/metrics/\u0026#34; response = requests.get(url, headers=headers, auth=auth) print(response.text) return response.text # è·å–æ‰€æœ‰èµ„äº§èŠ‚ç‚¹ def get_node_all(): \u0026#34;\u0026#34;\u0026#34; è·å–æ‰€æœ‰èµ„äº§èŠ‚ç‚¹ :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/assets/nodes/\u0026#34; response = requests.get(url, headers=headers, auth=auth) node_list = json.loads(response.text) count = 0 for i in node_list: count += 1 print(i) print(count) return response.json() # æŸ¥çœ‹å½“å‰tokenï¼ˆå³adminï¼‰çš„æ‰€æœ‰èµ„äº§ def get_asset_all(): \u0026#34;\u0026#34;\u0026#34; æŸ¥çœ‹å½“å‰tokenï¼ˆå³adminï¼‰çš„æ‰€æœ‰èµ„äº§ :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/assets/assets/\u0026#34; response = requests.get(url, headers=headers, auth=auth) node_list = json.loads(response.text) count = 0 for i in node_list: count += 1 print(i) print(count) return response.json() ################################################################################################### # åˆ›å»ºèµ„äº§èŠ‚ç‚¹ def assets_nodes_create(node_name): \u0026#34;\u0026#34;\u0026#34; åˆ›å»ºèµ„äº§èŠ‚ç‚¹ :param node_name: :return: \u0026#34;\u0026#34;\u0026#34; node_data = { \u0026#34;value\u0026#34;: node_name } url = jms_url + \u0026#34;/api/v1/assets/nodes/\u0026#34; node_info = get_node_info(node_name) if node_info: # æ ¹æ®node_nameå»æŸ¥è¯¢ï¼Œå¦‚æœæŸ¥åˆ°äº†è¯´æ˜å·²ç»æœ‰äº†ã€‚ print(\u0026#34;{name}å·²å­˜åœ¨, id: {id}\u0026#34;.format(name=node_name, id=node_info[0][\u0026#34;id\u0026#34;])) else: data = json.dumps(node_data) resp = requests.post(url, headers=headers, data=data) return resp.json() # def get_assets_list_by_ip(ip): \u0026#34;\u0026#34;\u0026#34; æ ¹æ®ipè·å–èµ„äº§ä¿¡æ¯ :param ip: :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/assets/assets/\u0026#34; response = requests.get(url, headers=headers, params={ \u0026#34;ip\u0026#34;: ip }) print(response.json()) return response.json() # æŸ¥çœ‹èµ„äº§èŠ‚ç‚¹ä¿¡æ¯ def get_node_info(node_name): \u0026#34;\u0026#34;\u0026#34; æŸ¥çœ‹èµ„äº§èŠ‚ç‚¹ä¿¡æ¯ :param node_name: èŠ‚ç‚¹åç§° :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/assets/nodes/\u0026#34; response = requests.get(url, auth=auth, headers=headers, params={ \u0026#34;value\u0026#34;: node_name }) print(response.text) return response.json() # åˆ›å»ºèµ„äº§æœºå™¨ def asset_create(ip, hostname, node_id, comment): \u0026#34;\u0026#34;\u0026#34; åˆ›å»ºèµ„äº§æœºå™¨ :param ip: ipåœ°å€ :param hostname: ä¸»æœºå :param node_id: èŠ‚ç‚¹id :return: è¿”å›åˆ›å»ºçš„èµ„äº§ä¿¡æ¯ \u0026#34;\u0026#34;\u0026#34; asset_Data = { \u0026#34;name\u0026#34;: hostname, \u0026#34;address\u0026#34;: ip, \u0026#34;platform\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;protocols\u0026#34;: [{ \u0026#34;name\u0026#34;: \u0026#34;ssh\u0026#34;, \u0026#34;port\u0026#34;: 22 }], \u0026#34;is_active\u0026#34;: True, \u0026#34;nodes\u0026#34;: [node_id], \u0026#34;comment\u0026#34;: comment, \u0026#34;accounts\u0026#34;: [{ # è´¦å·æ¨¡æ¿id \u0026#34;template\u0026#34;: \u0026#34;60b11033-a6e1-467d-8388-68a0e64134ff\u0026#34;, }] } url = jms_url + \u0026#34;/api/v1/assets/hosts/\u0026#34; print(url) data = json.dumps(asset_Data) print(data) response = requests.post(url, auth=auth, headers=headers, data=data) print(response.text) # è¿è¡Œåˆ›å»ºæœåŠ¡å™¨èµ„äº§ def run_create_assets(node_name, project_name, ip, comment): \u0026#34;\u0026#34;\u0026#34; è¿è¡Œåˆ›å»ºæœåŠ¡å™¨èµ„äº§ :param node_name: èŠ‚ç‚¹åç§° :param project_name: æœºå™¨åç§° :param ip: ipåœ°å€ :param comment: å¤‡æ³¨ :return: \u0026#34;\u0026#34;\u0026#34; # èŠ‚ç‚¹idï¼Œæ— èŠ‚ç‚¹æ—¶åˆ›å»ºèŠ‚ç‚¹ node_info = get_node_info(node_name) # å¦‚æœlen(node_info) == 0 è¯´æ˜æ²¡æœ‰èŠ‚ç‚¹ï¼Œéœ€è¦åˆ›å»ºèŠ‚ç‚¹ if len(node_info) == 0: # åˆ›å»ºèŠ‚ç‚¹ node_id = assets_nodes_create(node_name) print(node_id) else: # è·å–èŠ‚ç‚¹id node_id = node_info[0][\u0026#34;id\u0026#34;] print(node_id) # ç®¡ç†ç”¨æˆ· id hostname = \u0026#34;{ip}_{project_name}\u0026#34;.format(ip=ip, project_name=project_name) # æŸ¥IP,åˆ›å»ºèµ„äº§ ip_info = get_assets_list_by_ip(ip) if ip_info: print(\u0026#34;%s å·²å­˜åœ¨ï¼Œnodes: %s\u0026#34; % (ip_info[0][\u0026#34;address\u0026#34;], ip_info[0][\u0026#34;nodes\u0026#34;])) else: asset_create(ip, hostname, node_id, comment) def get_org_info(): \u0026#34;\u0026#34;\u0026#34; è·å–ç»„ç»‡ä¿¡æ¯ :return: \u0026#34;\u0026#34;\u0026#34; url = jms_url + \u0026#34;/api/v1/orgs/orgs/\u0026#34; response = requests.get(url, headers=headers) org_list = response.text print(org_list) for i in org_list.split(\u0026#34;id\u0026#34;): print(i) return response.json() if __name__ == \u0026#39;__main__\u0026#39;: jms_url = \u0026#39;https://jms.xxx.top\u0026#39; username = \u0026#39;admin\u0026#39; password = \u0026#39;xxxxxx\u0026#39; # è·å–token # token = get_token(jms_url, username, password) # åˆ›å»ºèµ„äº§èŠ‚ç‚¹ # assets_nodes_create(\u0026#34;k8s\u0026#34;) # æ ¹æ®ipè·å–èµ„äº§ä¿¡æ¯ # get_assets_list_by_ip(\u0026#34;192.168.11.10\u0026#34;) # æŸ¥çœ‹èµ„äº§èŠ‚ç‚¹ä¿¡æ¯ # get_node_info(\u0026#34;k8s\u0026#34;) # åˆ›å»ºèµ„äº§è°ƒç”¨ # node_id = [\u0026#34;e8641c37-93e3-450e-aaf8-64d5baa69753\u0026#34;] # get_node_info(\u0026#34;k8s\u0026#34;) # asset_create(ip, hostname, node_id) # è¿è¡Œåˆ›å»ºæœåŠ¡å™¨èµ„äº§ # run_create_assets(\u0026#34;test\u0026#34;, \u0026#34;é£æ§\u0026#34;, \u0026#34;192.168.11.10\u0026#34;, \u0026#34;æµ‹è¯•\u0026#34;) # è·å–ç»„ç»‡ä¿¡æ¯ # get_org_info() # è·å–æ‰€æœ‰ç”¨æˆ· get_user_all() ","date":"2023-09-05T11:44:32Z","image":"https://www.ownit.top/title_pic/55.jpg","permalink":"https://www.ownit.top/p/202309051144/","title":"Pythonè°ƒç”¨Jumpserverçš„Apiæ¥å£å¢åˆ æ”¹æŸ¥"},{"content":"Kubernetes APIä½¿ç”¨ 1ã€ APIæ˜¯ä»€ä¹ˆï¼Ÿ APIï¼ˆApplication Programming Interfaceï¼Œåº”ç”¨ç¨‹åºæ¥å£ï¼‰ï¼š æ˜¯ä¸€äº›é¢„å…ˆå®šä¹‰çš„æ¥å£ï¼ˆå¦‚å‡½æ•°ã€HTTPæ¥å£ï¼‰ï¼Œæˆ–æŒ‡è½¯ä»¶ç³»ç»Ÿä¸åŒç»„æˆéƒ¨åˆ†è¡”æ¥çš„çº¦å®šã€‚ ç”¨æ¥æä¾›åº”ç”¨ç¨‹åºä¸å¼€å‘äººå‘˜åŸºäºæŸè½¯ä»¶æˆ–ç¡¬ä»¶å¾—ä»¥è®¿é—®çš„ä¸€ç»„ä¾‹ç¨‹ï¼Œè€Œåˆæ— éœ€è®¿é—®æºç ï¼Œæˆ–ç†è§£å†…éƒ¨å·¥ä½œæœºåˆ¶çš„ç»†èŠ‚ã€‚\nK8sä¹Ÿæä¾›APIæ¥å£ï¼Œæä¾›è¿™ä¸ªæ¥å£çš„æ˜¯ç®¡ç†èŠ‚ç‚¹çš„apiserverç»„ä»¶ï¼ŒapiserveræœåŠ¡è´Ÿè´£æä¾›HTTP APIï¼Œä»¥ä¾¿ç”¨æˆ·ã€å…¶ä»–ç»„ä»¶ç›¸äº’é€šä¿¡ã€‚\næœ‰ä¸¤ç§æ–¹å¼å¯ä»¥æ“ä½œK8sä¸­çš„èµ„æºï¼š\nHTTP APIï¼šhttps://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/ å®¢æˆ·ç«¯åº“ï¼š https://kubernetes.io/zh/docs/reference/using-api/client-libraries/ 2ã€K8sè®¤è¯æ–¹å¼ K8sæ”¯æŒä¸‰ç§å®¢æˆ·ç«¯èº«ä»½è®¤è¯ï¼š\nHTTPS è¯ä¹¦è®¤è¯ï¼šåŸºäºCAè¯ä¹¦ç­¾åçš„æ•°å­—è¯ä¹¦è®¤è¯\nHTTP Tokenè®¤è¯ï¼šé€šè¿‡ä¸€ä¸ªTokenæ¥è¯†åˆ«ç”¨æˆ·\nHTTP Baseè®¤è¯ï¼šç”¨æˆ·å+å¯†ç çš„æ–¹å¼è®¤è¯\nHTTPSè¯ä¹¦è®¤è¯ï¼ˆkubeconfigï¼‰ï¼š\n1 2 3 4 5 6 7 import os from kubernetes import client, config config.load_kube_config(file_path) # æŒ‡å®škubeconfigé…ç½®æ–‡ä»¶ apps_api = client.AppsV1Api() # èµ„æºæ¥å£ç±»å®ä¾‹åŒ– for dp in apps_api.list_deployment_for_all_namespaces().items: print(dp) HTTP Tokenè®¤è¯ï¼ˆServiceAccountï¼‰ï¼š\n1 2 3 4 5 6 7 8 from kubernetes import client, config configuration = client.Configuration() configuration.host = \u0026#34;https://192.168.31.61:6443\u0026#34; # APISERVERåœ°å€ configuration.ssl_ca_cert=\u0026#34;ca.crt\u0026#34; # CAè¯ä¹¦ configuration.verify_ssl = True # å¯ç”¨è¯ä¹¦éªŒè¯ configuration.api_key = {\u0026#34;authorization\u0026#34;: \u0026#34;Bearer \u0026#34; + token} # æŒ‡å®šTokenå­—ç¬¦ä¸² client.Configuration.set_default(configuration) apps_api = client.AppsV1Api() è·å–Tokenå­—ç¬¦ä¸²ï¼šåˆ›å»ºservice accountå¹¶ç»‘å®šé»˜è®¤cluster-adminç®¡ç†å‘˜é›†ç¾¤è§’è‰²ï¼š\n1 2 3 4 5 6 # åˆ›å»ºç”¨æˆ· $ kubectl create serviceaccount dashboard-admin -n kube-system # ç”¨æˆ·æˆæƒ $ kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin # è·å–ç”¨æˆ·Token $ kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk \u0026#39;/dashboard-admin/{print $1}\u0026#39;) å…¶ä»–å¸¸ç”¨èµ„æºæ¥å£ç±»å®ä¾‹åŒ–ï¼š\n1 2 3 4 core_api = client.CoreV1Api() # namespace,pod,service,pv,pvc apps_api = client.AppsV1Api() # deployment networking_api = client.NetworkingV1beta1Api() # ingress storage_api = client.StorageV1Api() # storage_class Pythonè°ƒç”¨ https://kubernetes.io/zh/docs/reference/using-api/client-libraries/ ç›¸å…³ä»£ç ç¤ºä¾‹ï¼šhttps://github.com/kubernetes-client/python/tree/master/examples\n1ã€å®‰è£…æ’ä»¶æ¨¡å— 1 pip install kubernetes k8s.yml æ–‡ä»¶åˆ™æ˜¯ /root/.kube/config\n2ã€deploymentæœåŠ¡ å¢åŠ  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 import os from kubernetes import client, config config.load_kube_config(\u0026#34;k8s.yml\u0026#34;) # æŒ‡å®škubeconfigé…ç½®æ–‡ä»¶ apps_api = client.AppsV1Api() # èµ„æºæ¥å£ç±»å®ä¾‹åŒ– core_api = client.CoreV1Api() # namespace,pod,service,pv,pvc def deploy_create(): \u0026#34;\u0026#34;\u0026#34; åˆ›å»ºä¸€ä¸ªdeployment,å‘½åç©ºé—´é»˜è®¤ä¸ºdefaultï¼Œå¦‚æœè¦åˆ›å»ºå…¶ä»–å‘½åç©ºé—´çš„ï¼Œéœ€è¦å…ˆåˆ›å»ºå‘½åç©ºé—´ :return: \u0026#34;\u0026#34;\u0026#34; namespace = \u0026#34;default\u0026#34; name = \u0026#34;api-test\u0026#34; replicas = 3 labels = {\u0026#39;a\u0026#39;: \u0026#39;1\u0026#39;, \u0026#39;b\u0026#39;: \u0026#39;2\u0026#39;} # ä¸åŒºåˆ†æ•°æ®ç±»å‹ï¼Œéƒ½è¦åŠ å¼•å· image = \u0026#34;nginx\u0026#34; body = client.V1Deployment( api_version=\u0026#34;apps/v1\u0026#34;, kind=\u0026#34;Deployment\u0026#34;, metadata=client.V1ObjectMeta(name=name), spec=client.V1DeploymentSpec( replicas=replicas, selector={\u0026#39;matchLabels\u0026#39;: labels}, template=client.V1PodTemplateSpec( metadata=client.V1ObjectMeta(labels=labels), spec=client.V1PodSpec( containers=[client.V1Container( name=\u0026#34;web\u0026#34;, image=image )] ) ), ) ) try: apps_api.create_namespaced_deployment(namespace=namespace, body=body) except Exception as e: status = getattr(e, \u0026#34;status\u0026#34;) if status == 400: print(e) print(\u0026#34;æ ¼å¼é”™è¯¯\u0026#34;) elif status == 403: print(\u0026#34;æ²¡æƒé™\u0026#34;) if __name__ == \u0026#39;__main__\u0026#39;: deploy_create() æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 import os from kubernetes import client, config config.load_kube_config(\u0026#34;k8s.yml\u0026#34;) # æŒ‡å®škubeconfigé…ç½®æ–‡ä»¶ apps_api = client.AppsV1Api() # èµ„æºæ¥å£ç±»å®ä¾‹åŒ– core_api = client.CoreV1Api() # namespace,pod,service,pv,pvc def deploy_get(): \u0026#34;\u0026#34;\u0026#34; æŸ¥è¯¢ä¸€ä¸ªdeployment :return: \u0026#34;\u0026#34;\u0026#34; namespace = \u0026#34;default\u0026#34; name = \u0026#34;api-test\u0026#34; try: resp = apps_api.read_namespaced_deployment(namespace=namespace, name=name) print(resp) print(\u0026#34;æŸ¥è¯¢æˆåŠŸ\u0026#34;) except Exception as e: status = getattr(e, \u0026#34;status\u0026#34;) if status == 404: print(\u0026#34;æ²¡æ‰¾åˆ°\u0026#34;) elif status == 403: print(\u0026#34;æ²¡æƒé™\u0026#34;) if __name__ == \u0026#39;__main__\u0026#39;: deploy_get() ä¿®æ”¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 import os from kubernetes import client, config config.load_kube_config(\u0026#34;k8s.yml\u0026#34;) # æŒ‡å®škubeconfigé…ç½®æ–‡ä»¶ apps_api = client.AppsV1Api() # èµ„æºæ¥å£ç±»å®ä¾‹åŒ– core_api = client.CoreV1Api() # namespace,pod,service,pv,pvc def deploy_update(): namespace = \u0026#34;default\u0026#34; name = \u0026#34;api-test\u0026#34; replicas = 6 labels = {\u0026#39;a\u0026#39;: \u0026#39;1\u0026#39;, \u0026#39;b\u0026#39;: \u0026#39;2\u0026#39;} # ä¸åŒºåˆ†æ•°æ®ç±»å‹ï¼Œéƒ½è¦åŠ å¼•å· image = \u0026#34;nginx\u0026#34; body = client.V1Deployment( api_version=\u0026#34;apps/v1\u0026#34;, kind=\u0026#34;Deployment\u0026#34;, metadata=client.V1ObjectMeta(name=name), spec=client.V1DeploymentSpec( replicas=replicas, selector={\u0026#39;matchLabels\u0026#39;: labels}, template=client.V1PodTemplateSpec( metadata=client.V1ObjectMeta(labels=labels), spec=client.V1PodSpec( containers=[client.V1Container( name=\u0026#34;web\u0026#34;, image=image )] ) ), ) ) try: apps_api.patch_namespaced_deployment(namespace=namespace, name=name, body=body) except Exception as e: status = getattr(e, \u0026#34;status\u0026#34;) if status == 400: print(e) print(\u0026#34;æ ¼å¼é”™è¯¯\u0026#34;) elif status == 403: print(\u0026#34;æ²¡æƒé™\u0026#34;) elif status == 404: print(\u0026#34;æ²¡æ‰¾åˆ°\u0026#34;) if __name__ == \u0026#39;__main__\u0026#39;: deploy_update() åˆ é™¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 import os from kubernetes import client, config config.load_kube_config(\u0026#34;k8s.yml\u0026#34;) # æŒ‡å®škubeconfigé…ç½®æ–‡ä»¶ apps_api = client.AppsV1Api() # èµ„æºæ¥å£ç±»å®ä¾‹åŒ– core_api = client.CoreV1Api() # namespace,pod,service,pv,pvc # åˆ é™¤ä¸€ä¸ªdeployment def deploy_delete(): namespace = \u0026#34;default\u0026#34; name = \u0026#34;api-test\u0026#34; body = client.V1DeleteOptions() try: apps_api.delete_namespaced_deployment(namespace=namespace, name=name, body=body) except Exception as e: status = getattr(e, \u0026#34;status\u0026#34;) if status == 404: print(\u0026#34;æ²¡æ‰¾åˆ°\u0026#34;) elif status == 403: print(\u0026#34;æ²¡æƒé™\u0026#34;) elif status == 409: print(\u0026#34;å†²çª\u0026#34;) if __name__ == \u0026#39;__main__\u0026#39;: deploy_delete() 3ã€SVCæœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 def svc_get(): \u0026#34;\u0026#34;\u0026#34; æŸ¥è¯¢ä¸€ä¸ªservice :return: \u0026#34;\u0026#34;\u0026#34; # æŸ¥è¯¢ for svc in core_api.list_namespaced_service(namespace=\u0026#34;default\u0026#34;).items: print(svc.metadata.name) def svc_delete(): \u0026#34;\u0026#34;\u0026#34; åˆ é™¤ä¸€ä¸ªservice :return: \u0026#34;\u0026#34;\u0026#34; namespace = \u0026#34;default\u0026#34; name = \u0026#34;api-test\u0026#34; body = client.V1DeleteOptions() try: core_api.delete_namespaced_service(namespace=namespace, name=name, body=body) except Exception as e: status = getattr(e, \u0026#34;status\u0026#34;) if status == 404: print(\u0026#34;æ²¡æ‰¾åˆ°\u0026#34;) elif status == 403: print(\u0026#34;æ²¡æƒé™\u0026#34;) elif status == 409: print(\u0026#34;å†²çª\u0026#34;) def svc_create(): \u0026#34;\u0026#34;\u0026#34; åˆ›å»ºä¸€ä¸ªservice,å‘½åç©ºé—´é»˜è®¤ä¸ºdefaultï¼Œå¦‚æœè¦åˆ›å»ºå…¶ä»–å‘½åç©ºé—´çš„ï¼Œéœ€è¦å…ˆåˆ›å»ºå‘½åç©ºé—´ :return: \u0026#34;\u0026#34;\u0026#34; namespace = \u0026#34;default\u0026#34; name = \u0026#34;api-test\u0026#34; selector = {\u0026#39;a\u0026#39;: \u0026#39;1\u0026#39;, \u0026#39;b\u0026#39;: \u0026#39;2\u0026#39;} # ä¸åŒºåˆ†æ•°æ®ç±»å‹ï¼Œéƒ½è¦åŠ å¼•å· port = 80 target_port = 80 type = \u0026#34;NodePort\u0026#34; body = client.V1Service( api_version=\u0026#34;v1\u0026#34;, kind=\u0026#34;Service\u0026#34;, metadata=client.V1ObjectMeta( name=name ), spec=client.V1ServiceSpec( selector=selector, ports=[client.V1ServicePort( port=port, target_port=target_port )], type=type ) ) try: core_api.create_namespaced_service(namespace=namespace, body=body) except Exception as e: status = getattr(e, \u0026#34;status\u0026#34;) if status == 400: print(e) print(\u0026#34;æ ¼å¼é”™è¯¯\u0026#34;) elif status == 403: print(\u0026#34;æ²¡æƒé™\u0026#34;) def svc_update(): \u0026#34;\u0026#34;\u0026#34; æ›´æ–°ä¸€ä¸ªservice :return: \u0026#34;\u0026#34;\u0026#34; namespace = \u0026#34;default\u0026#34; name = \u0026#34;api-test\u0026#34; body = client.V1Service( api_version=\u0026#34;v1\u0026#34;, kind=\u0026#34;Service\u0026#34;, metadata=client.V1ObjectMeta( name=name ), spec=client.V1ServiceSpec( selector={\u0026#39;a\u0026#39;: \u0026#39;1\u0026#39;, \u0026#39;b\u0026#39;: \u0026#39;2\u0026#39;}, ports=[client.V1ServicePort( port=80, target_port=8080 )], type=\u0026#34;NodePort\u0026#34; ) ) try: core_api.patch_namespaced_service(namespace=namespace, name=name, body=body) except Exception as e: status = getattr(e, \u0026#34;status\u0026#34;) if status == 400: print(e) print(\u0026#34;æ ¼å¼é”™è¯¯\u0026#34;) elif status == 403: print(\u0026#34;æ²¡æƒé™\u0026#34;) ","date":"2023-08-31T18:41:32Z","image":"https://www.ownit.top/title_pic/43.jpg","permalink":"https://www.ownit.top/p/202308311841/","title":"æŒæ¡Kubernetes APIï¼šé‡Šæ”¾å®¹å™¨ç¼–æ’çš„æ½œåŠ›"},{"content":"ä¸€ã€JupyerHub jupyter notebook æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ä»»æ„ç¼–è¾‘è°ƒè¯•æˆ‘ä»¬çš„pythonä»£ç ï¼Œå¹¶ä¸”æ”¯æŒmarkdown è¯­æ³•ï¼Œå¯ä»¥è¯´æ˜¯ç§‘ç ”åˆ©å™¨ã€‚ä½†æ˜¯è¿™ç§æƒ…å†µé€‚åˆä¸ªäººä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯jupyter notebookä»¥æˆ‘ä»¬è‡ªå·±çš„ä¸»æœºä½œä¸ºæœåŠ¡å™¨ï¼Œç„¶åæˆ‘ä»¬ç”¨è‡ªå·±çš„æµè§ˆå™¨ç¼–è¾‘è‡ªå·±æœ¬æœºçš„pythonä»£ç ã€‚\næœ€è¿‘å…¬å¸æ­å»ºäº†ä¸šåŠ¡æ¨¡å‹çš„æœåŠ¡å™¨ï¼Œæ¯ä¸ªäººéƒ½æœ‰ä¸€ä¸ªç”¨æˆ·å¯ä»¥ä½¿ç”¨GPUèµ„æºï¼Œä½†æ˜¯æ¯æ¬¡å†™ä»£ç è¦åœ¨æœ¬åœ°è°ƒè¯•å¥½äº†ç„¶åå†sshæäº¤åˆ°æœåŠ¡å™¨è¿è¡Œï¼Œå¦‚æœæœ‰é—®é¢˜ï¼Œè¿˜è¦å†åœ¨æœ¬åœ°æ›´æ”¹ç„¶åå†æ¬¡æäº¤ï¼Œéå¸¸çš„éº»çƒ¦ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªçƒ¦æ¼ï¼Œæˆ‘ä»¬åœ¨GPUæœåŠ¡å™¨ä¸Šæ­å»ºäº†jupyterhub, å®ƒå’Œnotebookä¸åŒä¹‹å¤„åœ¨äºå®ƒæ˜¯ä¸€ä¸ªhubï¼Œå“ˆå“ˆï¼Œä¹Ÿå°±æ˜¯notebookçš„æœåŠ¡å™¨ï¼ŒæŠŠå®ƒè£…åœ¨æœåŠ¡å™¨ä¸Šï¼Œç„¶åå¤§å®¶å¯ä»¥é€šè¿‡å±€åŸŸç½‘åœ¨æµè§ˆå™¨ä¸Šè¿›è¡Œpythonä»£ç çš„ç¼–è¾‘å’Œè°ƒè¯•ã€‚\njupyterhub å’Œ jupyter notebookä¸€æ ·æ˜¯pythonçš„ä¸€ä¸ªåŒ…ï¼Œå¯ä»¥é€šè¿‡pipå®‰è£…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ condaå®‰è£…ï¼Œåœ¨æœåŠ¡å™¨ç«¯å®‰è£…å°±å¯ä»¥ä¾›å¤§å®¶ä½¿ç”¨ã€‚\näºŒã€ç¯å¢ƒ ç¡®ä¿ä½ çš„æœåŠ¡å™¨ç¯å¢ƒæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š\nä¸€å°è¿è¡Œæ”¯æŒçš„æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Ubuntuã€CentOS ç­‰ï¼‰çš„æœåŠ¡å™¨ å®‰è£…äº† Python å’Œ pip è¶³å¤Ÿçš„ç³»ç»Ÿèµ„æºï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ç©ºé—´ï¼‰ 1ã€Pythonç¯å¢ƒ å®‰è£… Miniconda æ˜¯ç®¡ç† Python ç¯å¢ƒä»¥åŠå®‰è£… Python åŒ…çš„ä¸€ä¸ªæ–¹ä¾¿å·¥å…·ã€‚ ä»¥ä¸‹æ˜¯åœ¨ CentOS ä¸Šå®‰è£… Miniconda çš„æ­¥éª¤ï¼š\nä¸‹è½½ Miniconda å®‰è£…åŒ…ï¼š åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä¸‹è½½é€‚ç”¨äº CentOS çš„ Miniconda å®‰è£…åŒ…ï¼ˆ64 ä½ï¼‰ï¼š\n1 2 3 4 5 wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh æˆ– curl -O https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh è¿è¡Œå®‰è£…è„šæœ¬ï¼š è¿è¡Œä¸‹è½½çš„è„šæœ¬æ¥å®‰è£… Minicondaã€‚é¦–å…ˆï¼Œç»™è„šæœ¬æ‰§è¡Œæƒé™ï¼š\n1 chmod +x Miniconda3-latest-Linux-x86_64.sh ç„¶åè¿è¡Œå®‰è£…è„šæœ¬ï¼š\n1 ./Miniconda3-latest-Linux-x86_64.sh æŒ‰ç…§æç¤ºï¼Œé˜…è¯»è®¸å¯åè®®å¹¶åŒæ„ã€‚\né…ç½® Minicondaï¼š å®‰è£…è¿‡ç¨‹ä¸­ä¼šæç¤ºä½ æ˜¯å¦å°† Miniconda æ·»åŠ åˆ° shell çš„ PATH ä¸­ã€‚é€‰æ‹© \u0026ldquo;yes\u0026rdquo;ï¼Œè¿™å°†å…è®¸ä½ åœ¨ç»ˆç«¯ä¸­ç›´æ¥ä½¿ç”¨ conda å‘½ä»¤ã€‚\né‡å¯ç»ˆç«¯ï¼š å®‰è£…å®Œæˆåï¼Œä¸ºäº†ä½¿é…ç½®ç”Ÿæ•ˆï¼Œå…³é—­å½“å‰ç»ˆç«¯çª—å£ï¼Œç„¶åé‡æ–°æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ã€‚\n5.æµ‹è¯•å®‰è£…ï¼š\nåœ¨æ–°çš„ç»ˆç«¯ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥éªŒè¯ conda æ˜¯å¦å·²æˆåŠŸå®‰è£…ï¼š\n1 2 root@bt:/home/fengkong# conda --version conda 23.5.0 å®‰è£…æ’ä»¶è¡¥å…¨ 1 conda install -c conda-forge conda-bash-completion å¤‡æ³¨ï¼š\n1 2 3 4 5 6 7 3ã€é…ç½®ç¯å¢ƒå˜é‡ï¼š.bashrc å¦‚æœé€‰æ‹©äº†initä¼šè‡ªå·±é…ç½® export PATH=~/miniconda3/bin:$PATH 3.5ã€å¸è½½miniconda æ‰¾åˆ°miniconda3çš„æ–‡ä»¶å¤¹ï¼Œä½¿ç”¨rmå‘½ä»¤å°†å®ƒåˆ é™¤ï¼š ç„¶åï¼Œç”¨vimå‘½ä»¤è¿›å…¥.bashrcæ–‡ä»¶ï¼Œå°†condaçš„è¯­å¥ç”¨#æ³¨é‡Šæ‰ æœ€åï¼Œé‡æ–°æ¿€æ´»ä¸€ä¸‹source .bashrcå°±å¯ä»¥äº†ã€‚ 2ã€Jupyter Lab å®‰è£… JupyterLab éå¸¸ç®€å•ï¼Œåªéœ€ä¸€è¡Œå‘½ä»¤å³å¯ï¼š\n1 2 3 4 conda å®‰è£… [Miniconda] conda install -c conda-forge jupyterlab or pip å®‰è£… pip install jupyterlab æ³¨å†Œç¯å¢ƒ 1 2 conda create -n python3_7 python=3.7 ipykernel or åˆ›å»ºå conda install ipykernel ç¯å¢ƒæ·»åŠ åˆ°ipykernel ï¼ˆæ·»åŠ çš„æ˜¯å½“å‰ç¯å¢ƒ éœ€è¦å…ˆactivateåˆ°éœ€è¦ç¯å¢ƒï¼‰ 1 python -m ipykernel install --user --name python3_7 --display-name \u0026#34;python3_7\u0026#34; æŸ¥çœ‹ï¼Œåˆ é™¤æ³¨å†Œåˆ°å†…æ ¸çš„ç¯å¢ƒ 1 2 3 jupyter kernelspec list æŸ¥çœ‹ jupyter kernelspec remove python3_7 åˆ é™¤ conda remove -n py36 --all åˆ ç¯å¢ƒ é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 jupyter lab --generate-config ç”Ÿæˆé…ç½® c.ServerApp.ip = \u0026#39;*\u0026#39; æ‰€æœ‰äººè®¿é—® c.LabApp.open_browser = False ä¸å†é»˜è®¤æ‰“å¼€æµè§ˆå™¨ jupyter lab password ä¿®æ”¹å¯†ç  conda config --set auto_activate_base false ç¦æ­¢è‡ªå¯ç¯å¢ƒ æ‰“å¼€è¿™ä¸ª`jupyterhub_config.py` c.Spawner.default_url = \u0026#39;/lab\u0026#39; c.JupyterHub.ip = \u0026#39;0.0.0.0\u0026#39; å®‰è£…æ’ä»¶ 1 conda install nodejs è£…ä¸­æ–‡ 1 pip install jupyterlab-language-pack-zh-CN å¯åŠ¨ 1 nohup jupyterhub -f /opt/jupyterhub/jupyterhub_config.py \u0026amp; 3ã€å…³è”ç³»ç»Ÿçš„å…¶å®ƒè®¤è¯ç”¨æˆ· ç”¨Rootè´¦æˆ·å¯åŠ¨ï¼Œæ‰èƒ½å…³è”ç³»ç»Ÿçš„å…¶å®ƒè®¤è¯ç”¨æˆ·\nå¹³å°ç¯å¢ƒåŸºäºjupyterhub+condaæ„å»ºï¼Œé»˜è®¤ç¯å¢ƒæ˜¯ubuntuè´¦æˆ·ä¸‹çš„condaç¯å¢ƒï¼Œè¯·å‹¿ç”¨ä½œå¼€å‘ç¯å¢ƒï¼Œ è¯·åˆ›å»ºå¹¶ä½¿ç”¨è‡ªå·±çš„linuxè´¦æˆ·åï¼Œå†è‡ªå»ºç¯å¢ƒä½¿ç”¨\nç¯å¢ƒæ³¨å†Œå‘½ä»¤\nç¯å¢ƒåç§° {pythonç‰ˆæœ¬}{å…·ä½“åŠŸç”¨(çœ‹æ˜¯å¦ä¸“ç”¨é¡¹ç›®)}{ä½¿ç”¨äºº} ç¤ºä¾‹ï¼špython38_{xxæ¨¡å‹}_long\n1 2 3 4 5 6 7 8 9 10 11 \u0026gt; æ³¨å†Œç¯å¢ƒï¼šåœ¨åˆ›å»ºç¯å¢ƒçš„åŒæ—¶æ·»åŠ ipykernelæ ¸å¿ƒ conda create -n python38_xxx python=3.8 ipykernel \u0026gt; ç¯å¢ƒæ·»åŠ åˆ°ipykernelï¼ˆæ“ä½œå‰å¿…é¡»å…ˆæ¿€æ´»è¿›å…¥å¯¹åº”ç¯å¢ƒï¼‰ conda activate python38_xxx python -m ipykernel install --user --name python38_xxx --display-name \u0026#34;python38_xxx\u0026#34; å†…æ ¸æ³¨å†Œå¼‚å¸¸å¤„ç† 1ã€æ‰‹åŠ¨æ‰§è¡Œå†…æ ¸æ·»åŠ å‘½ä»¤ å¦‚ä¸Š: python -m ipykernel install --user --name python38_xxx --display-name \u0026#34;python38_xxx\u0026#34; 2ã€é‡å¯é¢æ¿ï¼ŒFile-\u0026gt;HubControlPanel-\u0026gt;stopMyServer\u0026amp;startMyServer 3ã€é€‰æ‹©å†…æ ¸æ—¶å¯é€‰ä¸­always start the preferred kernelï¼Œè®¾ç½®ä¸ºé»˜è®¤å†…æ ¸ç¯å¢ƒ å¯¼å…¥windowsç¯å¢ƒåŒ…\n1 2 3 4 5 6 7 8 9 10 pip list --format=freeze \u0026gt; requirements.txt è¿›å…¥åˆ°éœ€è¦å®‰è£…çš„ç¯å¢ƒ conda activate python38_xxx åˆ é™¤requirements.txtæ–‡ä»¶å¤šä½™çš„åŒ…(condaè‡ªå¸¦æˆ–windowsç‰¹æœ‰ ç±»ä¼¼ï¼šconda,clyent,distribute,pip,jupyter,setuptools,wheel .. å®‰è£…è¿‡ç¨‹å¤±è´¥æˆ–å¡ä½ä¸åŠ¨çš„åŒ…ï¼Œå»ºè®®åˆ é™¤åç»§å†å•ç‹¬å®‰è£… pipå¯¼å…¥ python -m pip install -r requirements.txt ","date":"2023-08-17T15:05:02Z","image":"https://www.ownit.top/title_pic/45.jpg","permalink":"https://www.ownit.top/p/202308171505/","title":"JupyterHubå®æˆ˜åº”ç”¨"},{"content":"1ã€èƒŒæ™¯ åœ¨å¤šè¯­è¨€å¼€å‘ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦è¿›è¡Œè·¨è¯­è¨€çš„æ“ä½œã€‚æœ‰æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šåœ¨Pythonç¯å¢ƒä¸‹éœ€è¦ä½¿ç”¨Javaçš„åº“æˆ–è€…åŠŸèƒ½ã€‚è¿™ä¸ªåšå®¢å°†å±•ç¤ºå¦‚ä½•åœ¨Pythonä¸­è°ƒç”¨Javaçš„JavaParseråº“æ¥è§£æJavaæºä»£ç ã€‚\n2ã€éœ€æ±‚ åœ¨è®¸å¤šè½¯ä»¶å¼€å‘åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦è§£æJavaæºä»£ç ä»¥è·å–å…¶ç»“æ„ä¿¡æ¯ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›çŸ¥é“æºä»£ç ä¸­å®šä¹‰äº†å“ªäº›ç±»å’Œæ–¹æ³•ã€‚è™½ç„¶Pythonåº“javalangå¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†å®ƒä¸èƒ½äº§ç”Ÿæˆ‘ä»¬æƒ³è¦çš„JSONæ ¼å¼çš„è¾“å‡ºï¼Œè¯¥æ ¼å¼ä»¥ç±»ä¼¼äº [{\u0026ldquo;code\u0026rdquo;: \u0026ldquo;xxxx\u0026rdquo;}, {\u0026ldquo;code\u0026rdquo;: \u0026ldquo;xxxx\u0026rdquo;}, {\u0026ldquo;code\u0026rdquo;: \u0026ldquo;xxxx\u0026rdquo;}] çš„å½¢å¼ï¼Œåˆ—å‡ºäº†æºä»£ç ä¸­çš„æ¯ä¸ªç±»å’Œæ–¹æ³•ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Javaçš„JavaParseråº“ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨JavaParseræ¥è§£æJavaæºä»£ç ï¼Œå¹¶ç”Ÿæˆæˆ‘ä»¬æƒ³è¦çš„JSONæ ¼å¼çš„è¾“å‡ºã€‚\n3ã€JavaParseræ¦‚è¿° JavaParseræ˜¯ä¸€ä¸ªJavaåº“ï¼Œå¯ä»¥ç”¨äºè§£æJavaæºä»£ç å¹¶ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ã€‚é€šè¿‡ä½¿ç”¨JavaParserï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°è·å–Javaæºä»£ç çš„ç»“æ„ä¿¡æ¯ï¼Œæ¯”å¦‚ç±»å®šä¹‰ï¼Œæ–¹æ³•å®šä¹‰ç­‰ã€‚\n4ã€åˆ›å»ºJavaè§£æå™¨åº”ç”¨ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„Javaç±»ï¼Œæˆ‘ä»¬å°†å…¶å‘½åä¸ºJavaFileParserã€‚åœ¨JavaFileParserç±»ä¸­ï¼Œæˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªä¸»æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†æ¥å—ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼Œè¯¥å‚æ•°æŒ‡å®šäº†è¦è§£æçš„Javaæºæ–‡ä»¶çš„è·¯å¾„ã€‚\nåœ¨ä¸»æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆæ£€æŸ¥æä¾›çš„æ–‡ä»¶è·¯å¾„æ˜¯å¦æŒ‡å‘ä¸€ä¸ªå®é™…å­˜åœ¨çš„æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬å°†æ‰“å°ä¸€æ¡é”™è¯¯æ¶ˆæ¯å¹¶é€€å‡ºã€‚å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªJavaParserå®ä¾‹ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥è§£ææºæ–‡ä»¶ã€‚\nè§£æç»“æœå°†è¢«å°è£…åœ¨ä¸€ä¸ªOptionalå¯¹è±¡ä¸­ã€‚å¦‚æœè§£ææˆåŠŸï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨Optionalçš„getæ–¹æ³•æ¥è·å–CompilationUnitå¯¹è±¡ã€‚CompilationUnitå¯¹è±¡è¡¨ç¤ºäº†Javaæºæ–‡ä»¶çš„é¡¶çº§ç»“æ„ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªJSONArrayå®ä¾‹ï¼Œç„¶åéå†CompilationUnitä¸­çš„æ‰€æœ‰ç±»å’Œæ¥å£ã€‚å¯¹äºæ¯ä¸ªç±»æˆ–æ¥å£ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªJSONObjectå®ä¾‹ï¼Œå¹¶å°†ç±»æˆ–æ¥å£çš„åç§°å’Œæºä»£ç æ·»åŠ åˆ°è¿™ä¸ªJSONObjectä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†è¿™ä¸ªJSONObjectæ·»åŠ åˆ°JSONArrayä¸­ã€‚\næ¥ç€ï¼Œæˆ‘ä»¬éå†æ¯ä¸ªç±»æˆ–æ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚å¯¹äºæ¯ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬åŒæ ·åˆ›å»ºä¸€ä¸ªJSONObjectå®ä¾‹ï¼Œå¹¶å°†æ–¹æ³•çš„åç§°å’Œæºä»£ç æ·»åŠ åˆ°è¿™ä¸ªJSONObjectä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†è¿™ä¸ªJSONObjectæ·»åŠ åˆ°JSONArrayä¸­ã€‚\næœ€åï¼Œæˆ‘ä»¬å°†JSONArrayè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶æ‰“å°åˆ°æ§åˆ¶å°ã€‚\nå¦‚æœè§£æå¤±è´¥ï¼Œæˆ‘ä»¬å°†æ‰“å°ä¸€æ¡é”™è¯¯æ¶ˆæ¯ã€‚ pom.xml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;project xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.5.12\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;!-- lookup parent from repository --\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;groupId\u0026gt;com.fujfu\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;java-file\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.0.1-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;java-file\u0026lt;/name\u0026gt; \u0026lt;description\u0026gt;java-file\u0026lt;/description\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;java.version\u0026gt;1.8\u0026lt;/java.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.github.javaparser\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;javaparser-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.25.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.vaadin.external.google\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;android-json\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.0.20131108.vaadin1\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;compile\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/project\u0026gt; JavaFileParser\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 package com.fujfu.javafile; import com.github.javaparser.JavaParser; import com.github.javaparser.ParseResult; import com.github.javaparser.ast.CompilationUnit; import com.github.javaparser.ast.body.ClassOrInterfaceDeclaration; import com.github.javaparser.ast.body.MethodDeclaration; import org.json.JSONArray; import org.json.JSONException; import org.json.JSONObject; import java.io.File; import java.io.IOException; import java.util.Optional; public class JavaFileParser { public static void main(String[] args) throws IOException { if (args.length \u0026lt; 1) { System.out.println(\u0026#34;Please provide the file path as an argument.\u0026#34;); return; } String filePath = args[0]; File file = new File(filePath); if (!file.exists()) { System.out.println(\u0026#34;File does not exist: \u0026#34; + filePath); return; } JavaParser javaParser = new JavaParser(); ParseResult\u0026lt;CompilationUnit\u0026gt; parse = javaParser.parse(file); Optional\u0026lt;CompilationUnit\u0026gt; optionalCompilationUnit = parse.getResult(); if (optionalCompilationUnit.isPresent()) { CompilationUnit compilationUnit = optionalCompilationUnit.get(); JSONArray jsonArray = new JSONArray(); // éå†æ‰€æœ‰çš„ç±» compilationUnit.findAll(ClassOrInterfaceDeclaration.class).forEach(c -\u0026gt; { JSONObject classJson = new JSONObject(); try { classJson.put(\u0026#34;name\u0026#34;, c.getName().asString()); } catch (JSONException e) { e.printStackTrace(); } try { classJson.put(\u0026#34;code\u0026#34;, c.toString()); } catch (JSONException e) { e.printStackTrace(); } jsonArray.put(classJson); // éå†ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³• c.findAll(MethodDeclaration.class).forEach(m -\u0026gt; { JSONObject methodJson = new JSONObject(); try { methodJson.put(\u0026#34;name\u0026#34;, m.getName().asString()); } catch (JSONException e) { e.printStackTrace(); } try { methodJson.put(\u0026#34;code\u0026#34;, m.toString()); } catch (JSONException e) { e.printStackTrace(); } jsonArray.put(methodJson); }); }); System.out.println(jsonArray.toString()); //jsonArray.toString() å¾ªç¯ // for (int i = 0; i \u0026lt; jsonArray.length(); i++) { // JSONObject jsonObject = null; // try { // jsonObject = jsonArray.getJSONObject(i); // } catch (JSONException e) { // e.printStackTrace(); // } // try { // System.out.println(\u0026#34;Name: \u0026#34; + jsonObject.getString(\u0026#34;name\u0026#34;)); // } catch (JSONException e) { // e.printStackTrace(); // } //// try { //// System.out.println(\u0026#34;Code: \u0026#34; + jsonObject.getString(\u0026#34;code\u0026#34;)); //// } catch (JSONException e) { //// e.printStackTrace(); //// } // } } else { System.out.println(\u0026#34;Failed to parse the file.\u0026#34;); } } } 5ã€Javaå•æ–‡ä»¶æ‰“åŒ…æˆJar 6ã€åœ¨Pythonä¸­è°ƒç”¨Javaç¨‹åº é¦–å…ˆï¼Œä½ éœ€è¦ä¸€ä¸ªç”¨Javaç¼–å†™çš„ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºéœ€è¦è°ƒç”¨JavaParseråº“æ¥è§£æJavaæºä»£ç ï¼Œå¹¶å°†è§£æç»“æœè½¬æ¢ä¸ºJSONæ ¼å¼è¾“å‡ºã€‚æˆ‘ä»¬å‡è®¾ä½ å·²ç»æœ‰äº†è¿™æ ·çš„Javaç¨‹åºï¼Œå¹¶ä¸”ä½ å·²ç»å°†å®ƒæ‰“åŒ…ä¸ºåä¸ºjavafilejson.jarçš„JARæ–‡ä»¶ã€‚\nç„¶åï¼Œåœ¨Pythonä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨subprocessæ¨¡å—æ¥è°ƒç”¨è¿™ä¸ªJARæ–‡ä»¶ã€‚subprocessæ¨¡å—å…è®¸æˆ‘ä»¬ä»Pythonä»£ç ä¸­æ‰§è¡Œå¤–éƒ¨å‘½ä»¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥è¿è¡Œjava -jar javafilejson.jar {file_path}å‘½ä»¤ï¼Œå…¶ä¸­{file_path}æ˜¯ä½ å¸Œæœ›è§£æçš„Javaæºæ–‡ä»¶çš„è·¯å¾„ã€‚\nå‘½ä»¤çš„æ‰§è¡Œç»“æœå°†è¢«æ•è·å¹¶å­˜å‚¨åœ¨outputå˜é‡ä¸­ã€‚å¦‚æœå‘½ä»¤æˆåŠŸæ‰§è¡Œï¼Œæˆ‘ä»¬å°†æ‰“å°ä¸€æ¡æˆåŠŸä¿¡æ¯ï¼Œç„¶åè§£æoutputå˜é‡çš„å†…å®¹ï¼Œå¹¶ä»¥Pythonå­—å…¸çš„å½¢å¼æ‰“å°å‡ºæ¥ã€‚å¦‚æœå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œæˆ‘ä»¬å°†æ‰“å°ä¸€æ¡é”™è¯¯ä¿¡æ¯ã€‚\nä¸‹é¢æ˜¯å…·ä½“çš„Pythonä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 import json import subprocess def execute_java_command(file_path): command = f\u0026#39;java -jar javafilejson.jar {file_path}\u0026#39; process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True) output, error = process.communicate() if process.returncode == 0: print(\u0026#34;å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼\u0026#34;) print(\u0026#34;è¾“å‡ºï¼š\u0026#34;) all_data = output.decode(\u0026#34;gbk\u0026#34;) lst = json.loads(all_data) for i in lst: print(i[\u0026#34;name\u0026#34;], i[\u0026#34;code\u0026#34;]) else: print(\u0026#34;å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼\u0026#34;) print(\u0026#34;é”™è¯¯ä¿¡æ¯ï¼š\u0026#34;) print(error) # è°ƒç”¨å‡½æ•°ç¤ºä¾‹ file_path = \u0026#34;LoanInfoController.java\u0026#34; execute_java_command(file_path) 7ã€ æ€»ç»“ è¿™å°±æ˜¯å¦‚ä½•åœ¨Pythonç¯å¢ƒä¸‹è°ƒç”¨Javaçš„JavaParseråº“æ¥è§£æJavaæºä»£ç çš„æ–¹æ³•ã€‚è¿™ç§è·¨è¯­è¨€çš„è§£å†³æ–¹æ¡ˆä¸ä»…èƒ½å¤Ÿæ‰©å¤§æˆ‘ä»¬çš„å·¥å…·ç®±ï¼Œè¿˜èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£æºä»£ç çš„ç»“æ„ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚\nJavaParserå®˜æ–¹æ–‡æ¡£ï¼šhttps://javaparser.org/ Python subprocessæ¨¡å—å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.python.org/3/library/subprocess.html\nä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬å…³äº\u0026quot;è·¨è¯­è¨€ä»£ç è§£æï¼šåˆ©ç”¨Pythonè°ƒç”¨Javaçš„JavaParserè§£æJavaæºä»£ç \u0026quot;çš„åšå®¢ã€‚å¸Œæœ›è¿™ç¯‡åšå®¢å¯¹ä½ åœ¨è·¨è¯­è¨€å¼€å‘è¿‡ç¨‹ä¸­æœ‰æ‰€å¸®åŠ©ã€‚\n","date":"2023-07-13T12:10:36Z","image":"https://www.ownit.top/title_pic/70.jpg","permalink":"https://www.ownit.top/p/202307131210/","title":"å®ç°è·¨è¯­è¨€äº’åŠ¨ï¼šå¦‚ä½•åœ¨Pythonä¸­è°ƒç”¨Javaçš„JavaParseråº“è§£æJavaæºä»£ç "},{"content":"ç®€ä»‹ å­¦ä¹ å¦‚ä½•ä½¿ç”¨ Python çš„ retrying åº“æ¥å¤„ç†åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„å„ç§å¼‚å¸¸å’Œé”™è¯¯ã€‚ retrying æ˜¯ä¸€ç§ç®€å•ã€æ˜“äºä½¿ç”¨çš„é‡è¯•æœºåˆ¶ï¼Œå¸®åŠ©æˆ‘ä»¬å¤„ç†ç”±ç½‘ç»œé—®é¢˜æˆ–å…¶ä»–æš‚æ—¶æ€§é”™è¯¯å¼•èµ·çš„å¤±è´¥ã€‚åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œç®€å•çš„é‡è¯•å¯èƒ½å°±æ˜¯è§£å†³é—®é¢˜çš„æœ€å¥½æ–¹å¼ã€‚é€šè¿‡æœ¬ç¯‡åšå®¢ï¼Œä½ å°†äº†è§£åˆ°å¦‚ä½•åœ¨ Python ä¸­ä½¿ç”¨ retryingã€‚\nå®‰è£…retryingåº“ è¦å®‰è£… retrying åº“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ pip å‘½ä»¤ï¼š\n1 pip install retrying retryingçš„åŠŸèƒ½ ä¸€èˆ¬è£…é¥°å™¨api ç‰¹å®šçš„åœæ­¢æ¡ä»¶ï¼ˆé™åˆ¶å°è¯•æ¬¡æ•°ï¼‰ ç‰¹å®šçš„ç­‰å¾…æ¡ä»¶ï¼ˆæ¯æ¬¡å°è¯•ä¹‹é—´çš„æŒ‡æ•°å¢é•¿çš„æ—¶é—´ç­‰å¾…ï¼‰ è‡ªå®šä¹‰çš„å¼‚å¸¸è¿›è¡Œå°è¯• è‡ªå®šä¹‰çš„å¼‚å¸¸è¿›è¡Œå°è¯•è¿”å›ç»“æœ æœ€ç®€å•çš„ä¸€ä¸ªä½¿ç”¨æ–¹æ³•æ˜¯æ— è®ºæœ‰ä»»ä½•å¼‚å¸¸å‡ºç°ï¼Œéƒ½ä¼šä¸€ç›´é‡æ–°è°ƒç”¨ä¸€ä¸ªå‡½æ•°ã€æ–¹æ³•ï¼Œç›´åˆ°è¿”å›ä¸€ä¸ªå€¼ åŸºç¡€ä½¿ç”¨ è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­å¼€å§‹ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç»å¸¸ä¼šå¤±è´¥çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨è¿™ä¸ªå‡½æ•°å¤±è´¥æ—¶è¿›è¡Œé‡è¯•ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ retrying åº“å®ç°è¿™ä¸ªç›®æ ‡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 from retrying import retry @retry def make_trouble(): print(\u0026#34;Trying...\u0026#34;) raise Exception(\u0026#34;Exception!\u0026#34;) try: make_trouble() except Exception: print(\u0026#34;Failed, even with retrying.\u0026#34;) åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† retry ä¿®é¥°å™¨ï¼ˆdecoratorï¼‰ã€‚å¦‚æœ make_trouble å‡½æ•°å¼•å‘å¼‚å¸¸ï¼Œretry ä¼šæ•è·è¿™ä¸ªå¼‚å¸¸å¹¶é‡è¯•å‡½æ•°ã€‚å¦‚æœåœ¨å°è¯•ä¸€å®šæ¬¡æ•°åä»ç„¶å¤±è´¥ï¼Œé‚£ä¹ˆå¼‚å¸¸å°†ä¼šè¢«æŠ›å‡ºã€‚ è‡ªå®šä¹‰é‡è¯• åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œretry ä¼šåœ¨æ¯æ¬¡å¤±è´¥åç«‹å³é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚ç„¶è€Œï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›è‡ªå®šä¹‰é‡è¯•çš„è¡Œä¸ºã€‚retrying åº“æä¾›äº†ä¸€äº›å‚æ•°ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿè¿›è¡Œè‡ªå®šä¹‰ï¼š\nstop_max_attempt_numberï¼šæœ€å¤§é‡è¯•æ¬¡æ•°ã€‚ stop_max_delayï¼šæœ€å¤§å»¶è¿Ÿæ¯«ç§’æ•°ã€‚ wait_fixedï¼šæ¯æ¬¡é‡è¯•ä¹‹é—´çš„å›ºå®šç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚ wait_random_minï¼Œwait_random_maxï¼šæ¯æ¬¡é‡è¯•ä¹‹é—´çš„éšæœºç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚ 1 2 3 4 5 6 7 8 9 10 11 from retrying import retry @retry(stop_max_attempt_number=3, wait_fixed=2000) def make_trouble(): print(\u0026#34;Trying...\u0026#34;) raise Exception(\u0026#34;Exception!\u0026#34;) try: make_trouble() except Exception: print(\u0026#34;Failed, even with retrying.\u0026#34;) åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œmake_trouble å‡½æ•°ä¼šæœ€å¤šå°è¯•3æ¬¡ï¼Œæ¯æ¬¡å°è¯•ä¹‹é—´ç­‰å¾…2ç§’ã€‚ æ›´å¤æ‚çš„é‡è¯•æ¡ä»¶ é™¤äº†è‡ªå®šä¹‰é‡è¯•æ¬¡æ•°å’Œç­‰å¾…æ—¶é—´ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰é‡è¯•çš„æ¡ä»¶ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯èƒ½åªå¸Œæœ›åœ¨ç‰¹å®šçš„å¼‚å¸¸å‡ºç°æ—¶è¿›è¡Œé‡è¯•ã€‚è¿™å¯ä»¥é€šè¿‡åœ¨ retry ä¿®é¥°å™¨ä¸­æ·»åŠ ä¸€ä¸ª retry_on_exception å‡½æ•°æ¥å®ç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from retrying import retry def retry_if_io_error(exception): \u0026#34;\u0026#34;\u0026#34;Return True if we should retry (in this case when it\u0026#39;s an IOError), False otherwise\u0026#34;\u0026#34;\u0026#34; return isinstance(exception, IOError) @retry(retry_on_exception=retry_if_io_error,stop_max_attempt_number=3, wait_fixed=2000) def might_io_error(): print(\u0026#34;Trying...\u0026#34;) raise IOError(\u0026#34;IO Error!\u0026#34;) try: might_io_error() except Exception: print(\u0026#34;Failed, even with retrying.\u0026#34;) åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå‡½æ•° retry_if_io_errorï¼Œåªæœ‰å½“å¼‚å¸¸æ˜¯ IOError ç±»å‹æ—¶ï¼Œæˆ‘ä»¬æ‰è¿›è¡Œé‡è¯•ã€‚ ç»“æŸ ä½¿ç”¨ retrying åº“ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨ Python ä¸­å®ç°é”™è¯¯é‡è¯•æœºåˆ¶ã€‚è¿™åœ¨å¤„ç†ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æ“ä½œæˆ–ä»»ä½•å¯èƒ½å› æš‚æ—¶æ€§é—®é¢˜å¤±è´¥çš„æ“ä½œæ—¶éƒ½éå¸¸æœ‰ç”¨ã€‚å¸Œæœ›ä½ å·²ç»å¯¹å¦‚ä½•ä½¿ç”¨ retrying æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ï¼Œå¹¶èƒ½åœ¨ä½ çš„ Python é¡¹ç›®ä¸­æ‰¾åˆ°å®ƒçš„ç”¨æ­¦ä¹‹åœ°ã€‚\nå‚è€ƒæ–‡æ¡£ https://juejin.cn/post/7108202816665026573\n","date":"2023-07-12T09:27:00Z","image":"https://www.ownit.top/title_pic/32.jpg","permalink":"https://www.ownit.top/p/202307120927/","title":"Pythoné”™è¯¯å¤„ç†çš„è‰ºæœ¯ï¼šä½¿ç”¨retryingåº“å®ç°é«˜æ•ˆé‡è¯•æœºåˆ¶"},{"content":"å¼•è¨€ åœ¨å¼€å‘Webåº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¯¹æŸäº›åŠŸèƒ½æˆ–APIè¿›è¡Œé€Ÿç‡é™åˆ¶ï¼Œä»¥é˜²æ­¢æ»¥ç”¨å’Œä¿æŠ¤æœåŠ¡å™¨èµ„æºã€‚Pythonçš„ratelimitåº“æä¾›äº†ä¸€ç§ç®€å•ä¸”å¼ºå¤§çš„æ–¹æ³•æ¥å®ç°é€Ÿç‡é™åˆ¶ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ratelimitåº“åœ¨Pythonåº”ç”¨ç¨‹åºä¸­å®ç°é€Ÿç‡é™åˆ¶åŠŸèƒ½ã€‚\nä»€ä¹ˆæ˜¯é€Ÿç‡é™åˆ¶ï¼Ÿ é€Ÿç‡é™åˆ¶æ˜¯ä¸€ç§é™åˆ¶æŸä¸ªæ“ä½œæˆ–åŠŸèƒ½çš„è°ƒç”¨é¢‘ç‡çš„æ–¹æ³•ã€‚å®ƒå¯ä»¥é˜²æ­¢æ¶æ„ç”¨æˆ·æˆ–ç¨‹åºå¯¹ç³»ç»Ÿé€ æˆè¿‡å¤§çš„è´Ÿè½½æˆ–æ»¥ç”¨ç³»ç»Ÿèµ„æºã€‚é€Ÿç‡é™åˆ¶é€šå¸¸é€šè¿‡è®¾ç½®æ¯ç§’æˆ–æ¯åˆ†é’Ÿå…è®¸çš„æœ€å¤§è¯·æ±‚æ•°æ¥å®ç°ã€‚\nratelimitåº“ç®€ä»‹ ratelimitæ˜¯ä¸€ä¸ªPythonåº“ï¼Œå®ƒæä¾›äº†é€Ÿç‡é™åˆ¶çš„åŠŸèƒ½ã€‚å®ƒåŸºäºä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå…è®¸æ‚¨ä»¥ç®€æ´è€Œçµæ´»çš„æ–¹å¼å¯¹å‡½æ•°æˆ–æ–¹æ³•è¿›è¡Œé€Ÿç‡é™åˆ¶ã€‚\nratelimit æä¾›çš„è£…é¥°å™¨ï¼Œå¯ä»¥æ§åˆ¶è¢«è£…é¥°çš„å‡½æ•°åœ¨æŸä¸ªå‘¨æœŸå†…è¢«è°ƒç”¨çš„æ¬¡æ•°ä¸è¶…è¿‡ä¸€ä¸ªé˜ˆå€¼ï¼Œå°½ç®¡ä½œè€…æœ¬æ„æ˜¯é™åˆ¶é‚£äº›è®¿é—®web API çš„å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°ï¼Œä½†ä½ å¯ä»¥æ¨è€Œå¹¿ä¹‹ï¼Œæ‰€æœ‰ä¸èƒ½é¢‘ç¹è°ƒç”¨çš„å‡½æ•°éƒ½å¯ä»¥ç”¨è¿™ä¸ªè£…é¥°å™¨æ¥ä¿®é¥°ã€‚\né¡¹ç›®çš„githubåœ°å€: https://github.com/tomasbasham/ratelimit\nratelimitåº“ å®ä¾‹ @sleep_and_retry @limits(calls=2, period=10)\n@sleep_and_retry æ˜¯ä¸€ä¸ª Python è£…é¥°å™¨ï¼Œç”¨äºåœ¨å‡½æ•°è°ƒç”¨è¾¾åˆ°é™åˆ¶åè‡ªåŠ¨è¿›è¡Œé‡è¯•ï¼Œå¹¶åœ¨é‡è¯•ä¹‹å‰è¿›è¡Œä¼‘çœ ã€‚å®ƒé€šå¸¸ä¸é™æµåº“ï¼ˆå¦‚ ratelimitï¼‰ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ç¡®ä¿å‡½æ•°åœ¨é™åˆ¶æ¡ä»¶ä¸‹è¢«æ­£ç¡®æ‰§è¡Œã€‚\n@limits(calls=2, period=10) æ˜¯ ratelimit åº“ä¸­çš„å¦ä¸€ä¸ªè£…é¥°å™¨ï¼Œç”¨äºè®¾ç½®å‡½æ•°çš„é™åˆ¶æ¡ä»¶ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå®ƒæŒ‡å®šäº†å‡½æ•°åœ¨ 10 ç§’å†…æœ€å¤šå¯ä»¥è¢«è°ƒç”¨ 2 æ¬¡ã€‚\nå½“å‡½æ•°è¢«è£…é¥°æ—¶ï¼Œ@sleep_and_retry ä¼šåœ¨å‡½æ•°è°ƒç”¨è¶…è¿‡é™åˆ¶æ—¶è‡ªåŠ¨è¿›è¡Œä¼‘çœ å¹¶é‡è¯•ã€‚å…·ä½“çš„è¡Œä¸ºå¦‚ä¸‹ï¼š\nå½“å‡½æ•°ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šç«‹å³æ‰§è¡Œã€‚ å¦‚æœå‡½æ•°åœ¨ 10 ç§’å†…å·²ç»è¢«è°ƒç”¨äº† 2 æ¬¡ï¼Œå®ƒå°†æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼ŒæŒ‡ç¤ºè¶…è¿‡äº†é™åˆ¶ã€‚ å¦‚æœå‡½æ•°è°ƒç”¨è¾¾åˆ°äº†é™åˆ¶ï¼Œ@sleep_and_retry ä¼šåœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨ä¹‹å‰ä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œä»¥ç¡®ä¿å‡½æ•°åœ¨ä¸‹ä¸€ä¸ªè®¡ç®—å‘¨æœŸå¼€å§‹ä¹‹å‰è¢«é‡è¯•ã€‚ ä¼‘çœ æ—¶é—´çš„è®¡ç®—åŸºäºä¸Šä¸€æ¬¡å‡½æ•°è°ƒç”¨çš„æ—¶é—´å’Œå½“å‰æ—¶é—´ä¹‹é—´çš„å·®å€¼ã€‚\nè¦å¼€å§‹ä½¿ç”¨ratelimitåº“ï¼Œé¦–å…ˆéœ€è¦å®‰è£…å®ƒã€‚å¯ä»¥ä½¿ç”¨pipå‘½ä»¤è¿›è¡Œå®‰è£…ï¼š\n1 pip install ratelimit ä½¿ç”¨ratelimitåº“è¿›è¡Œé€Ÿç‡é™åˆ¶ï¼š\nä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•åœ¨Pythonå‡½æ•°ä¸Šåº”ç”¨é€Ÿç‡é™åˆ¶ï¼š\n1 2 3 4 5 6 7 8 from ratelimit import limits, sleep_and_retry # è®¾ç½®é€Ÿç‡é™åˆ¶ä¸ºæ¯ç§’æœ€å¤šä¸¤æ¬¡è°ƒç”¨ @sleep_and_retry @limits(calls=2, period=1) def my_function(): # åœ¨æ­¤å¤„æ·»åŠ æ‚¨çš„åŠŸèƒ½ä»£ç  pass åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ@limits(calls=2, period=1)è£…é¥°å™¨å®šä¹‰äº†ä¸€ä¸ªé€Ÿç‡é™åˆ¶è§„åˆ™ï¼Œå…è®¸æ¯ç§’æœ€å¤šè°ƒç”¨ä¸¤æ¬¡my_functionå‡½æ•°ã€‚@sleep_and_retryè£…é¥°å™¨å¯ç¡®ä¿å½“è¶…å‡ºé€Ÿç‡é™åˆ¶æ—¶ï¼Œå‡½æ•°å°†ä¼‘çœ å¹¶é‡è¯•ã€‚\næ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæ‚¨å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´callså’Œperiodå‚æ•°çš„å€¼ã€‚\næ—¥å¸¸ä½¿ç”¨ å‡½æ•°é™åˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 from ratelimit import limits, sleep_and_retry import time # è®¾ç½®æ¯åˆ†é’Ÿæœ€å¤šè°ƒç”¨æ¬¡æ•°ä¸º 3 @limits(calls=3, period=60) @sleep_and_retry def my_function(): # åœ¨è¿™é‡Œç¼–å†™ä½ çš„å‡½æ•°é€»è¾‘ print(\u0026#34;å‡½æ•°è¢«è°ƒç”¨\u0026#34;) # æµ‹è¯•å‡½æ•°çš„è°ƒç”¨ for _ in range(10): try: my_function() except Exception as e: print(\u0026#34;è°ƒç”¨æ¬¡æ•°è¶…è¿‡é™åˆ¶ï¼Œç­‰å¾…1åˆ†é’Ÿåç»§ç»­\u0026#34;) time.sleep(60) my_function() 1 2 3 4 5 6 7 8 9 10 11 from ratelimit import limits, sleep_and_retry @sleep_and_retry @limits(calls=1, period=10) def call_api(): print(\u0026#39;call api\u0026#39;) while True: call_api() é«˜å¹¶å‘çº¿ç¨‹æ±  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 from ratelimit import limits, sleep_and_retry from concurrent.futures import ThreadPoolExecutor # è®¾ç½®æ¯åˆ†é’Ÿæœ€å¤šè°ƒç”¨æ¬¡æ•°ä¸º 3 @sleep_and_retry @limits(calls=3, period=10) def my_function(): # åœ¨è¿™é‡Œç¼–å†™ä½ çš„å‡½æ•°é€»è¾‘ print(\u0026#34;å‡½æ•°è¢«è°ƒç”¨\u0026#34;) # åˆ›å»º ThreadPoolExecutor å¯¹è±¡ executor = ThreadPoolExecutor(max_workers=5) # æµ‹è¯•å‡½æ•°çš„è°ƒç”¨ for _ in range(100): executor.submit(my_function) å‚è€ƒæ–‡æ¡£ï¼š pythonå¼€æºé¡¹ç›®è§£è¯»â€”ratelimitï¼Œé™åˆ¶å‡½æ•°å•ä½æ—¶é—´å†…è¢«è°ƒç”¨æ¬¡æ•° Python Django é…ç½®ä½¿ç”¨django-ratelimité™åˆ¶ç½‘ç«™æ¥å£è®¿é—®é¢‘ç‡\n","date":"2023-07-04T11:04:27Z","image":"https://www.ownit.top/title_pic/66.jpg","permalink":"https://www.ownit.top/p/202307041104/","title":"é™åˆ¶é€Ÿåº¦ï¼Œé‡Šæ”¾æ½œåŠ›ï¼šPythonä¸­çš„ratelimitåº“è§£å¯†"},{"content":"ä¸€ ã€èƒŒæ™¯ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å¿«é€Ÿäº†è§£å“ªäº›é¡¹ç›®åŒ…å«ç‰¹å®šçš„é…ç½®ï¼Œä¾‹å¦‚ä½¿ç”¨äº†fastjsonåº“æˆ–æ•°æ®åº“çš„è¿æ¥é…ç½®ã€‚ç„¶è€Œï¼Œåœ¨GitLabä¸Šé€ä¸ªä»£ç ä»“åº“è¿›è¡Œæœç´¢æ˜¯éå¸¸è€—æ—¶çš„ã€‚ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªPythonè„šæœ¬å·¥å…·ï¼Œç”¨äºå®ç°å…¨å±€æœç´¢åŠŸèƒ½ã€‚\nè¯¥è„šæœ¬èƒ½å¤Ÿåœ¨GitLabä¸Šå¯¹æ‰€æœ‰é¡¹ç›®è¿›è¡Œå…¨å±€æœç´¢ï¼Œå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿç¡®å®šå“ªäº›é¡¹ç›®ä½¿ç”¨äº†ç‰¹å®šçš„é…ç½®ã€‚æ— è®ºé¡¹ç›®æ•°é‡æ˜¯å‡ ä¸ªã€å‡ åä¸ªè¿˜æ˜¯ä¸Šç™¾ä¸ªï¼Œè¿™ä¸ªè„šæœ¬éƒ½èƒ½å¤ŸèŠ‚çœå¤§é‡çš„æ—¶é—´å’Œç²¾åŠ›ã€‚\nä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å…³é”®è¯ï¼ˆå¦‚åº“åã€é…ç½®é¡¹ç­‰ï¼‰è¿›è¡Œæœç´¢ï¼Œå¹¶è·å–åŒ…å«è¯¥å…³é”®è¯çš„é¡¹ç›®åˆ—è¡¨ã€‚è„šæœ¬ä¼šè‡ªåŠ¨éå†æ‰€æœ‰é¡¹ç›®ï¼Œå¹¶è¿”å›ç¬¦åˆæ¡ä»¶çš„é¡¹ç›®é“¾æ¥ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›ä¸€æ­¥æŸ¥çœ‹å’Œåˆ†æã€‚\næ— è®ºæ˜¯å¯¹å¤§å‹å›¢é˜Ÿè¿˜æ˜¯ä¸ªäººå¼€å‘è€…ï¼Œè¿™ä¸ªå·¥å…·éƒ½èƒ½æä¾›ä¾¿åˆ©ã€‚å®ƒèƒ½å¤Ÿé«˜æ•ˆåœ°å¸®åŠ©æˆ‘ä»¬äº†è§£é¡¹ç›®ä¸­çš„é…ç½®ä½¿ç”¨æƒ…å†µï¼ŒåŠ å¿«é—®é¢˜æ’æŸ¥å’Œä»£ç å®¡æŸ¥çš„é€Ÿåº¦ã€‚\nå¦‚æœä½ çš„é¡¹ç›®æ•°é‡è¾ƒå°‘ï¼Œåªæœ‰å‡ ä¸ªé¡¹ç›®ï¼Œå¹¶ä¸”èƒ½å¤Ÿè½»æ¾åœ¨GitLabä¸Šé€ä¸ªæœç´¢ï¼Œé‚£ä¹ˆè¿™ä¸ªè„šæœ¬å¯èƒ½å¹¶ä¸é€‚ç”¨äºä½ ã€‚ä½†æ˜¯ï¼Œå½“ä½ é¢å¯¹æ•°åç”šè‡³ä¸Šç™¾ä¸ªé¡¹ç›®æ—¶ï¼Œè¿™ä¸ªè„šæœ¬å°†æˆä¸ºä½ çš„å¾—åŠ›åŠ©æ‰‹ï¼Œæä¾›é«˜æ•ˆçš„å…¨å±€æœç´¢èƒ½åŠ›ã€‚\né€šè¿‡è¿™ä¸ªGitLabå…¨å±€æœç´¢æ–‡æœ¬å·¥å…·ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ›´å¿«åœ°å‘ç°é¡¹ç›®ä¸­çš„é…ç½®ä½¿ç”¨æƒ…å†µï¼Œä¼˜åŒ–ä»£ç ç»“æ„ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼Œä»¥åŠæ›´å¥½åœ°ç®¡ç†å’Œç»´æŠ¤é¡¹ç›®ã€‚\näºŒã€åŸç†æµç¨‹ ç”¨æˆ·è¾“å…¥GitLabçš„URLå’Œè®¿é—®ä»¤ç‰Œã€‚ ç³»ç»Ÿä½¿ç”¨è¾“å…¥çš„URLå’Œè®¿é—®ä»¤ç‰Œä¸GitLabå»ºç«‹è¿æ¥ã€‚ ç³»ç»Ÿè°ƒç”¨GitLabæ¨¡å—ï¼Œè·å–GitLabä¸­çš„æ‰€æœ‰é¡¹ç›®IDã€‚ å¯¹äºæ¯ä¸ªé¡¹ç›®IDï¼Œç³»ç»Ÿæ„å»ºæœç´¢æ¥å£URLï¼ŒåŒ…æ‹¬å…³é”®å­—å’Œé¡¹ç›®IDä½œä¸ºå‚æ•°ã€‚ ç³»ç»Ÿä½¿ç”¨è¯·æ±‚åº“å‘æœç´¢æ¥å£å‘é€HTTPè¯·æ±‚ï¼Œè·å–æœç´¢ç»“æœé¡µé¢å†…å®¹ã€‚ ç³»ç»Ÿä½¿ç”¨XPathè§£ææœç´¢ç»“æœé¡µé¢å†…å®¹ï¼Œæå–ç›¸å…³ä¿¡æ¯ã€‚ å¦‚æœæœç´¢ç»“æœå­˜åœ¨ï¼š ç³»ç»Ÿåˆ¤æ–­å…³é”®å­—åŒ¹é…æˆåŠŸï¼Œå¹¶å°†åŒ¹é…åˆ°çš„é¡¹ç›®IDå’Œå…³é”®å­—ç›¸å…³ä¿¡æ¯å­˜å‚¨èµ·æ¥ã€‚ å¯é€‰ï¼šç³»ç»Ÿå±•ç¤ºåŒ¹é…åˆ°å…³é”®å­—çš„é¡¹ç›®ä¿¡æ¯ç»™ç”¨æˆ·ã€‚ ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªé¡¹ç›®IDï¼Œé‡å¤æ­¥éª¤4-7ï¼Œç›´åˆ°æ‰€æœ‰é¡¹ç›®IDå¤„ç†å®Œæ¯•ã€‚ ç³»ç»Ÿè¾“å‡ºæ‰€æœ‰åŒ¹é…åˆ°å…³é”®å­—çš„é¡¹ç›®ä¿¡æ¯ã€‚ é¡¹ç›®æµç¨‹ç»“æŸã€‚ ä¸‰ã€pythonç‰ˆæœ¬ä¸ä¾èµ– python:3.8.0 (å¦‚æœæœ¬åœ°å·²æœ‰python3çš„ç¯å¢ƒåˆ™ä¸éœ€è¦é€šè¿‡docker) pythonä¾èµ–çš„moduleå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 import json import os import requests from lxml import etree from multiprocessing import Pool import gitlab å››ã€ æ“ä½œæ­¥éª¤ 1ã€å®‰è£…ä¸Šé¢çš„æ¨¡å— 1 2 pip install lxml -i https://pypi.tuna.tsinghua.edu.cn/simple pip install gitlab -i https://pypi.tuna.tsinghua.edu.cn/simple 2ã€è·å–Gitlabçš„token è¦è·å–GitLabçš„è®¿é—®ä»¤ç‰Œï¼ˆTokenï¼‰ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š\nç™»å½•åˆ°GitLabè´¦æˆ·ã€‚ åœ¨å³ä¸Šè§’çš„ç”¨æˆ·èœå•ä¸­ï¼Œç‚¹å‡»\u0026quot;Settings\u0026quot;é€‰é¡¹ã€‚ åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œé€‰æ‹©\u0026quot;Access Tokens\u0026quot;é€‰é¡¹ã€‚ åœ¨\u0026quot;Personal Access Tokens\u0026quot;éƒ¨åˆ†ï¼Œç‚¹å‡»\u0026quot;Create a token\u0026quot;æŒ‰é’®ã€‚ è¾“å…¥è®¿é—®ä»¤ç‰Œçš„åç§°å’Œè¿‡æœŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰ã€‚ é€‰æ‹©æ‰€éœ€çš„æƒé™èŒƒå›´ï¼ˆAPIã€è¯»å–ç”¨æˆ·ä¿¡æ¯ç­‰ï¼‰ã€‚ ç‚¹å‡»\u0026quot;Create personal access token\u0026quot;æŒ‰é’®ã€‚ è®¿é—®ä»¤ç‰Œå°†è¢«ç”Ÿæˆï¼Œå¹¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚è¯·åŠ¡å¿…å¤åˆ¶è¯¥ä»¤ç‰Œå¹¶å¦¥å–„ä¿å­˜ï¼Œå› ä¸ºå®ƒå°†åœ¨åˆ›å»ºååªæ˜¾ç¤ºä¸€æ¬¡ã€‚ æ³¨æ„äº‹é¡¹ï¼š\nè®¿é—®ä»¤ç‰Œå…·æœ‰ä¸æ‚¨çš„è´¦æˆ·ç›¸åŒçš„æƒé™ï¼Œè¯·è°¨æ…ä¿ç®¡ï¼Œå¹¶ä»…å°†å…¶ç”¨äºå—ä¿¡ä»»çš„åº”ç”¨ç¨‹åºæˆ–è„šæœ¬ã€‚ å¦‚æœä¸å†éœ€è¦è®¿é—®ä»¤ç‰Œæˆ–æƒ³è¦æ’¤é”€è®¿é—®æƒé™ï¼Œè¯·è¿”å›åˆ°\u0026quot;Access Tokens\u0026quot;é¡µé¢ï¼Œå¹¶ç‚¹å‡»ç›¸åº”çš„æ’¤é”€æŒ‰é’®ã€‚ è¯·æ³¨æ„ï¼Œè·å–è®¿é—®ä»¤ç‰Œéœ€è¦æœ‰ç›¸åº”çš„æƒé™ï¼Œå¦‚æœæ‚¨æ— æ³•æ‰¾åˆ°æˆ–è®¿é—®\u0026quot;Access Tokens\u0026quot;é€‰é¡¹ï¼Œè¯·è”ç³»æ‚¨çš„GitLabç®¡ç†å‘˜ä»¥è·å–å¸®åŠ©ã€‚ 3ã€è·å–Gitlabæ¥å£çš„cookie è¦è·å–GitLabæ¥å£çš„Cookieï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š\næ‰“å¼€æµè§ˆå™¨å¹¶ç™»å½•åˆ°GitLabè´¦æˆ·ã€‚ åœ¨ç™»å½•æˆåŠŸåï¼Œæ‰“å¼€æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ï¼ˆé€šå¸¸æ˜¯æŒ‰F12é”®æˆ–å³é”®ç‚¹å‡»é¡µé¢å¹¶é€‰æ‹©\u0026quot;æ£€æŸ¥\u0026quot;æˆ–\u0026quot;å¼€å‘è€…å·¥å…·\u0026quot;é€‰é¡¹ï¼‰ã€‚ åœ¨å¼€å‘è€…å·¥å…·ä¸­ï¼Œåˆ‡æ¢åˆ°\u0026quot;ç½‘ç»œ\u0026quot;ï¼ˆNetworkï¼‰é€‰é¡¹å¡ã€‚ åœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œéœ€è¦è·å–Cookieçš„æ“ä½œï¼Œä¾‹å¦‚è®¿é—®æŸä¸ªé¡µé¢æˆ–æ‰§è¡ŒæŸä¸ªAPIè¯·æ±‚ã€‚ åœ¨å¼€å‘è€…å·¥å…·ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°æ‰€æœ‰ç½‘ç»œè¯·æ±‚çš„è®°å½•ã€‚ åœ¨è¯·æ±‚åˆ—è¡¨ä¸­ï¼Œæ‰¾åˆ°ä¸GitLabç›¸å…³çš„è¯·æ±‚ã€‚ ç‚¹å‡»è¯¥è¯·æ±‚ï¼Œåœ¨è¯·æ±‚è¯¦ç»†ä¿¡æ¯çš„å³ä¾§é¢æ¿ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°è¯·æ±‚å¤´ï¼ˆHeadersï¼‰çš„ä¿¡æ¯ã€‚ åœ¨è¯·æ±‚å¤´ä¸­ï¼ŒæŸ¥æ‰¾åä¸º\u0026quot;Cookie\u0026quot;çš„å­—æ®µã€‚è¯¥å­—æ®µçš„å€¼å³ä¸ºGitLabæ¥å£çš„Cookieã€‚ è¯·æ³¨æ„ï¼ŒCookieåŒ…å«äº†ç”¨æˆ·çš„èº«ä»½éªŒè¯ä¿¡æ¯ï¼Œå› æ­¤è¯·å¦¥å–„ä¿ç®¡Cookieï¼Œå¹¶ä»…å°†å…¶ç”¨äºåˆæ³•å’Œæˆæƒçš„ç”¨é€”ã€‚åŒæ—¶ï¼Œè·å–Cookieéœ€è¦æœ‰ç›¸åº”çš„æƒé™ï¼Œå¦‚æœæ‚¨æ— æ³•è·å–Cookieï¼Œè¯·è”ç³»æ‚¨çš„GitLabç®¡ç†å‘˜ä»¥è·å–å¸®åŠ©ã€‚ 4ã€Pythonä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 # -*- coding: utf-8 -*- # @Time : 2023/6/21 14:20 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : git_prod_scan.py # @Software: PyCharm import json import os import requests from lxml import etree from multiprocessing import Pool import gitlab # éœ€è¦æ£€ç´¢çš„å†…å®¹å…³é”®å­— search_content = \u0026#39;yunkedai\u0026#39; token = \u0026#39;xxxxx-Y9FLN\u0026#39; gitlab_url = \u0026#39;https://gitlab.xxxx.com/\u0026#39; gl = gitlab.Gitlab(gitlab_url, token) private_Cookie = \u0026#39;xxxxxxx\u0026#39; headers = { \u0026#39;Cookie\u0026#39;: private_Cookie } def get_all_projects(): data = [] for g in gl.groups.list(all=True): for p in g.projects.list(all=True): project = gl.projects.get(p.id) item = { \u0026#34;id\u0026#34;: p.id, \u0026#34;group\u0026#34;: g.name, \u0026#34;project\u0026#34;: p.name } data.append(item) # å°†æ•°æ®ä¿å­˜ä¸º JSON æ–‡ä»¶ with open(\u0026#39;all_output.json\u0026#39;, \u0026#39;w\u0026#39;) as file: json.dump(data, file, indent=4) def getProject(s): \u0026#34;\u0026#34;\u0026#34; æ ¹æ®é¡¹ç›® ID è·å–é¡¹ç›®ä¿¡æ¯å¹¶æ‰“å°é¡¹ç›®é“¾æ¥ \u0026#34;\u0026#34;\u0026#34; url = \u0026#34;%s/search?utf8=\u0026amp;snippets=\u0026amp;scope=\u0026amp;search=%s\u0026amp;project_id=%s\u0026#34; % (gitlab_url, search_content, s) response = requests.get(url, headers=headers) pagehtml = etree.HTML(response.text) try: li_element = pagehtml.xpath(\u0026#39;//li[@data-qa-selector=\u0026#34;code_tab\u0026#34;]\u0026#39;)[0] projecttitle = li_element.xpath(\u0026#39;.//span/text()\u0026#39;)[0] if int(projecttitle) \u0026gt; 0: # æŸ¥è¯¢é¡¹ç›®ä¿¡æ¯ project = gl.projects.get(s) # è·å–é¡¹ç›®é“¾æ¥ project_url = project.web_url print(\u0026#34;é¡¹ç›®å­˜åœ¨å…³é”®è¯ï¼š\u0026#34; + project_url) else: return except IndexError: pass def start_project(): pool = Pool(processes=5) # è¯»å–é¡¹ç›®æ•°æ® with open(\u0026#39;all_output.json\u0026#39;, \u0026#39;r\u0026#39;) as file: data = file.read() data = json.loads(data) # å¹¶å‘è°ƒç”¨ getProject å‡½æ•° for i in data: id = i.get(\u0026#39;id\u0026#39;) pool.apply_async(func=getProject, args=(id,)) print(\u0026#39;end\u0026#39;) pool.close() pool.join() print(\u0026#34;================================================================\u0026#34;) print(\u0026#34;æ‰€æœ‰é¡¹ç›®å·²æ‰«æå®Œæ¯•\u0026#34;) if __name__ == \u0026#39;__main__\u0026#39;: file_path = \u0026#39;all_output.json\u0026#39; if os.path.isfile(file_path): start_project() else: get_all_projects() start_project() äº”ã€æµ‹è¯•æ•ˆæœ æˆ‘è¦ è·å– æ‰€æœ‰é¡¹ç›® åŒ…å« hire_core çš„å…³é”®å­—\nè¯·ä¿®æ”¹ä»£ç å±‚é¢\n1 search_content = \u0026#39;hire_core\u0026#39; æ‰§è¡Œè„šæœ¬ å…­ã€æ€»ç»“ ä¸Šé¢çš„GitLabå…¨å±€Pythonä»£ç æœç´¢å·¥å…·å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\næœç´¢æ•ˆç‡é«˜ï¼šè¯¥å·¥å…·é€šè¿‡ä½¿ç”¨GitLabçš„APIæ¥å£è¿›è¡Œæœç´¢ï¼Œé¿å…äº†æ‰‹åŠ¨åœ¨æ¯ä¸ªé¡¹ç›®ä¸­è¿›è¡Œæœç´¢çš„ç¹çè¿‡ç¨‹ã€‚å®ƒèƒ½å¤Ÿå¿«é€Ÿæ‰«æå¤šä¸ªé¡¹ç›®ï¼Œä»è€ŒèŠ‚çœäº†å¤§é‡çš„æ—¶é—´å’Œç²¾åŠ›ã€‚ å…¨é¢æ€§ï¼šè¯¥å·¥å…·å¯ä»¥åœ¨GitLabä¸Šè¿›è¡Œå…¨å±€æœç´¢ï¼Œå³åŒæ—¶æœç´¢æ‰€æœ‰é¡¹ç›®ï¼Œè€Œä¸ä»…ä»…å±€é™äºå•ä¸ªé¡¹ç›®ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ²¡æœ‰é—æ¼ä»»ä½•ä¸€ä¸ªé¡¹ç›®ï¼Œæé«˜äº†æœç´¢çš„å…¨é¢æ€§å’Œå‡†ç¡®æ€§ã€‚ å¤šçº¿ç¨‹æ”¯æŒï¼šå·¥å…·é‡‡ç”¨äº†å¤šçº¿ç¨‹çš„å¹¶å‘å¤„ç†æ–¹å¼ï¼Œå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªé¡¹ç›®çš„æœç´¢è¯·æ±‚ï¼Œæé«˜äº†æœç´¢æ•ˆç‡ã€‚è¿™æ„å‘³ç€å¯ä»¥å¿«é€Ÿåœ°å¹¶å‘æœç´¢å¤§é‡çš„é¡¹ç›®ï¼Œæ›´å¿«åœ°æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä»£ç ç‰‡æ®µã€‚ è¾“å‡ºç»“æœæ¸…æ™°ï¼šå·¥å…·ä¼šè¾“å‡ºç¬¦åˆæœç´¢æ¡ä»¶çš„é¡¹ç›®é“¾æ¥ï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿç›´è§‚åœ°æŸ¥çœ‹é¡¹ç›®å’Œç›¸å…³ä»£ç ã€‚è¿™æ–¹ä¾¿äº†ç”¨æˆ·å¯¹æœç´¢ç»“æœçš„æ£€æŸ¥å’Œè¿›ä¸€æ­¥çš„å¤„ç†ã€‚ çµæ´»å¯æ‰©å±•ï¼šå·¥å…·çš„ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œå®šåˆ¶å’Œæ‰©å±•ï¼Œä¾‹å¦‚ä¿®æ”¹æœç´¢å…³é”®å­—ã€è°ƒæ•´å¹¶å‘çº¿ç¨‹æ•°ç­‰ï¼Œä»¥é€‚åº”ä¸åŒçš„æœç´¢åœºæ™¯å’Œé¡¹ç›®è§„æ¨¡ã€‚ ","date":"2023-06-21T18:41:14Z","image":"https://www.ownit.top/title_pic/39.jpg","permalink":"https://www.ownit.top/p/202306211841/","title":"GitPySearch- å…¨å±€Pythonä»£ç æœç´¢å·¥å…·"},{"content":"1ã€èƒŒæ™¯ æ—¥å¿—æ˜¯éå¸¸é‡è¦çš„ä¿¡æ¯èµ„æºã€‚å®ƒä»¬è®°å½•äº†åº”ç”¨ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ã€é”™è¯¯å’Œå¼‚å¸¸æƒ…å†µï¼Œå¸®åŠ©æˆ‘ä»¬äº†è§£ç³»ç»Ÿçš„å¥åº·çŠ¶å†µä»¥åŠå‘ç°æ½œåœ¨çš„é—®é¢˜ã€‚ä¸ºäº†é«˜æ•ˆåœ°ç®¡ç†å’Œåˆ†ææ—¥å¿—æ•°æ®ï¼Œè®¸å¤šç»„ç»‡é‡‡ç”¨äº†Elasticsearchã€Logstashå’ŒKibanaï¼ˆELKï¼‰å †æ ˆä½œä¸ºæ—¥å¿—æ”¶é›†å’Œåˆ†æçš„è§£å†³æ–¹æ¡ˆã€‚\nå¼€å‘ä¸€ä¸ªå®æ—¶ç›‘æ§å’Œå‘Šè­¦è„šæœ¬ï¼Œä¸“é—¨ç”¨äºç›‘æ§ELKå¹³å°ä¸­çš„é”™è¯¯æ—¥å¿—ï¼Œå¹¶åŠæ—¶å‘é€å‘Šè­¦é€šçŸ¥ç»™ç›¸å…³äººå‘˜ã€‚è¯¥ç³»ç»Ÿå°†é€šè¿‡æ‰«æElasticsearchä¸­çš„æ—¥å¿—æ•°æ®ï¼Œç­›é€‰å‡ºç­‰çº§ä¸ºERRORçš„é”™è¯¯æ—¥å¿—ï¼Œå¹¶æ ¹æ®é¢„è®¾çš„å‘Šè­¦è§„åˆ™è¿›è¡Œå¤„ç†ã€‚\n2ã€ç›®çš„ ä½¿ç”¨Pythonä»Elasticsearchä¸­æŸ¥è¯¢ç‰¹å®šçº§åˆ«ä¸ºERRORçš„é”™è¯¯æ—¥å¿—ï¼Œå¹¶é€šè¿‡é’‰é’‰æœºå™¨äººå®ç°å‘Šè­¦èšåˆå’Œå‘é€ï¼Œä»¥æé«˜é”™è¯¯æ—¥å¿—çš„å¤„ç†æ•ˆç‡å’ŒåŠæ—¶å“åº”èƒ½åŠ›ã€‚\nä¸ºä»€ä¹ˆå¼€å‘è¿™ä¸ªè„šæœ¬ï¼Ÿ å› ä¸ºç›®å‰æˆ‘ä»¬è¿™è¾¹æ²¡æœ‰ç›‘æ§æ—¥å¿—çš„ä¿¡æ¯ï¼Œå‡ºç°é—®é¢˜ä¸èƒ½åŠæ—¶å‘ç° å’Œé¢„çŸ¥ ä¼˜åŠ¿ 1ã€æ¶ˆæ¯è¿›è¡Œèšåˆï¼Œæ¯ä¸ªé¡¹ç›®çš„å¤šæ¡å‘Šè­¦ä¿¡æ¯ï¼Œæ±‡æ€»ä¸€æ¡å‘é€ã€‚çªç ´é’‰é’‰æœºå™¨äººæ¯åˆ†é’Ÿåªèƒ½å‘é€20æ¡çš„é™åˆ¶ 2ã€å‘Šè­¦ä¿¡æ¯youå¤ªå¤šçš„é‡å¤ï¼Œè¿›è¡Œå»é‡å¤„ç†ï¼Œæ·»åŠ å‘Šè­¦æ¬¡æ•°å‘é€ã€‚é˜²æ­¢è¢«é’‰é’‰é™æµ 3ã€åŸç† ä½¿ç”¨Pythonçš„Elasticsearchåº“è¿æ¥åˆ°Elasticsearché›†ç¾¤ã€‚ æ„å»ºElasticsearchæŸ¥è¯¢DSLï¼ˆé¢†åŸŸä¸“ç”¨è¯­è¨€ï¼‰ï¼Œè¿‡æ»¤å‡ºçº§åˆ«ä¸ºERRORçš„æ—¥å¿—è®°å½•ã€‚ æ‰§è¡ŒæŸ¥è¯¢å¹¶è·å–ç»“æœã€‚ å¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œèšåˆï¼Œç»Ÿè®¡æ¯ä¸ªé¡¹ç›®çš„é”™è¯¯æ¬¡æ•°ã€‚ æ ¹æ®èšåˆç»“æœï¼Œç”Ÿæˆå‘Šè­¦æ¶ˆæ¯çš„Markdownæ ¼å¼å†…å®¹ã€‚ ä½¿ç”¨é’‰é’‰æœºå™¨äººå‘é€å‘Šè­¦æ¶ˆæ¯åˆ°æŒ‡å®šçš„é’‰é’‰ç¾¤ã€‚ 4ã€æµç¨‹ å¯¼å…¥å¿…è¦çš„Pythonåº“ï¼ŒåŒ…æ‹¬elasticsearchå’Œrequestsã€‚ åˆ›å»ºElasticsearchè¿æ¥ï¼ŒæŒ‡å®šElasticsearché›†ç¾¤çš„ä¸»æœºå’Œç«¯å£ã€‚ æ„å»ºElasticsearchæŸ¥è¯¢DSLï¼Œè®¾ç½®æŸ¥è¯¢æ¡ä»¶ä¸ºæ—¥å¿—çº§åˆ«ä¸ºERRORã€‚ æ‰§è¡ŒæŸ¥è¯¢ï¼Œè·å–æŸ¥è¯¢ç»“æœã€‚ å¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œå¤„ç†ï¼Œèšåˆæ¯ä¸ªé¡¹ç›®çš„é”™è¯¯æ¬¡æ•°ã€‚ æ ¹æ®èšåˆç»“æœç”Ÿæˆå‘Šè­¦æ¶ˆæ¯çš„Markdownå†…å®¹ã€‚ ä½¿ç”¨é’‰é’‰æœºå™¨äººAPIå‘é€å‘Šè­¦æ¶ˆæ¯åˆ°æŒ‡å®šçš„é’‰é’‰ç¾¤ã€‚ 5ã€å®ç°ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 # -*- coding: utf-8 -*- # @Time : 2023/6/17 18:11 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : all_es.py # @Software: PyCharm from collections import Counter from datetime import datetime, timedelta import requests from elasticsearch import Elasticsearch from monitor.es_ding import send_pretty_message # Elasticsearchå®¢æˆ·ç«¯å®ä¾‹ es = Elasticsearch(hosts=[\u0026#39;http://172.18.xxx.xxxx:9200\u0026#39;], http_auth=(\u0026#39;elastic\u0026#39;, \u0026#39;xxxxx\u0026#39;), sniff_on_start=True, # è¿æ¥å‰æµ‹è¯• sniff_on_connection_fail=True, # èŠ‚ç‚¹æ— å“åº”æ—¶åˆ·æ–°èŠ‚ç‚¹ sniff_timeout=300, # è®¾ç½®è¶…æ—¶æ—¶é—´ headers={\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;}) def format_timestamp(timestamp): \u0026#34;\u0026#34;\u0026#34;æ ¼å¼åŒ–æ—¶é—´ä¸ºElasticsearchæ¥å—çš„å­—ç¬¦ä¸²æ ¼å¼\u0026#34;\u0026#34;\u0026#34; return timestamp.strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) def search_errors(): \u0026#34;\u0026#34;\u0026#34;æ‰§è¡ŒæŸ¥è¯¢ï¼Œè·å–é”™è¯¯æ—¥å¿—æ•°æ®\u0026#34;\u0026#34;\u0026#34; current_time = datetime.now() one_minute_ago = current_time - timedelta(minutes=10) current_time_str = format_timestamp(current_time) one_minute_ago_str = format_timestamp(one_minute_ago) index = \u0026#39;app-prod-*\u0026#39; # æ›¿æ¢ä¸ºå®é™…çš„ç´¢å¼•åç§° query = { \u0026#34;query\u0026#34;: { \u0026#34;bool\u0026#34;: { \u0026#34;filter\u0026#34;: [ { \u0026#34;range\u0026#34;: { \u0026#34;@timestamp\u0026#34;: { \u0026#34;gte\u0026#34;: one_minute_ago_str, \u0026#34;lt\u0026#34;: current_time_str, \u0026#34;format\u0026#34;: \u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;, \u0026#34;time_zone\u0026#34;: \u0026#34;+08:00\u0026#34; } } }, { \u0026#34;match\u0026#34;: { \u0026#34;loglevel\u0026#34;: \u0026#34;ERROR\u0026#34; #åŒ¹é…é¡¹ç›®é”™è¯¯ç­‰çº§ } }, { \u0026#34;bool\u0026#34;: { \u0026#34;must_not\u0026#34;: [ { \u0026#34;match\u0026#34;: { \u0026#34;projectname\u0026#34;: \u0026#34;fox-data-spiderman\u0026#34; # éœ€è¦å±è”½çš„é¡¹ç›® } } ] } } ] } }, \u0026#34;_source\u0026#34;: [ ## è¾“å‡ºçš„å­—æ®µ \u0026#34;date\u0026#34;, \u0026#34;projectname\u0026#34;, \u0026#34;threadname\u0026#34;, \u0026#34;msg\u0026#34; ], \u0026#34;from\u0026#34;: 0, \u0026#34;size\u0026#34;: 10000, # è¿”å›æŸ¥è¯¢çš„æ¡æ•° } result = es.search(index=index, body=query) total_documents = result[\u0026#34;hits\u0026#34;][\u0026#34;total\u0026#34;][\u0026#34;value\u0026#34;] print(f\u0026#34;æ€»å…±åŒ¹é…åˆ° {total_documents} æ¡æ–‡æ¡£\u0026#34;) result = result[\u0026#39;hits\u0026#39;][\u0026#39;hits\u0026#39;] all_result = [] for i in result: all_result.append(i[\u0026#39;_source\u0026#39;]) msg_counter = Counter(d[\u0026#39;msg\u0026#39;] for d in all_result if \u0026#39;msg\u0026#39; in d) results = [] for d in all_result: if \u0026#39;msg\u0026#39; in d and d[\u0026#39;msg\u0026#39;] in msg_counter: count = msg_counter[d[\u0026#39;msg\u0026#39;]] del msg_counter[d[\u0026#39;msg\u0026#39;]] d[\u0026#39;count\u0026#39;] = count d[\u0026#39;msg\u0026#39;] = d[\u0026#39;msg\u0026#39;][:100] + (\u0026#39;...\u0026#39; if len(d[\u0026#39;msg\u0026#39;]) \u0026gt; 100 else \u0026#39;\u0026#39;) results.append(d) return results def aggregate_errors(results): \u0026#34;\u0026#34;\u0026#34;æŒ‰é¡¹ç›®åç§°èšåˆé”™è¯¯æ—¥å¿—\u0026#34;\u0026#34;\u0026#34; aggregated_data = {} for d in results: projectname = d.get(\u0026#39;projectname\u0026#39;) if projectname: if projectname not in aggregated_data: aggregated_data[projectname] = [] aggregated_data[projectname].append({\u0026#39;date\u0026#39;: d.get(\u0026#39;date\u0026#39;), \u0026#39;msg\u0026#39;: d.get(\u0026#39;msg\u0026#39;), \u0026#39;count\u0026#39;: d.get(\u0026#39;count\u0026#39;)}) return aggregated_data def generate_summary(projectname, messages): \u0026#34;\u0026#34;\u0026#34;ç”ŸæˆMarkdownæ ¼å¼çš„æ¶ˆæ¯æ‘˜è¦\u0026#34;\u0026#34;\u0026#34; markdown_text = f\u0026#39;### {projectname} \\n\\n\u0026#39; for message in messages: markdown_text += f\u0026#34;**æ—¶é—´ï¼š** {message[\u0026#39;date\u0026#39;]}\\n\\n\u0026#34; markdown_text += f\u0026#34;**å‘Šè­¦æ¬¡æ•°ï¼š** \u0026lt;font color=\u0026#39;red\u0026#39;\u0026gt;\u0026lt;b\u0026gt;{message[\u0026#39;count\u0026#39;]}\u0026lt;/b\u0026gt;\u0026lt;/font\u0026gt;\\n\\n\u0026#34; markdown_text += f\u0026#34;{message[\u0026#39;msg\u0026#39;]}\\n\\n---\\n\\n\u0026#34; return markdown_text def send_message_summary(projectname, messages): \u0026#34;\u0026#34;\u0026#34;å‘é€æ‘˜è¦æ¶ˆæ¯ç»™é’‰é’‰æœºå™¨äºº\u0026#34;\u0026#34;\u0026#34; summary = generate_summary(projectname, messages) data = { \u0026#39;msgtype\u0026#39;: \u0026#39;markdown\u0026#39;, \u0026#39;markdown\u0026#39;: { \u0026#39;title\u0026#39;: f\u0026#39;{projectname}æ¶ˆæ¯å‘Šè­¦\u0026#39;, \u0026#39;text\u0026#39;: summary } } webhook_url = \u0026#39;https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxxxxxxx\u0026#39; # æ›¿æ¢ä¸ºå®é™…çš„Webhook URL response = requests.post(webhook_url, json=data) if response.status_code == 200: print(\u0026#39;æ¶ˆæ¯å‘é€æˆåŠŸ\u0026#39;) else: print(\u0026#39;æ¶ˆæ¯å‘é€å¤±è´¥\u0026#39;) if __name__ == \u0026#39;__main__\u0026#39;: errors = search_errors() aggregated_errors = aggregate_errors(errors) for projectname, messages in aggregated_errors.items(): print(f\u0026#34;{projectname}:\u0026#34;) print(messages) 6ã€Crontabæ·»åŠ å®šæ—¶ä»»åŠ¡ ä¹Ÿå¯ä»¥ç”¨é‡‡ç”¨ï¼šJenkinsä¸GitLabçš„å®šæ—¶ä»»åŠ¡å·¥ä½œæµç¨‹ https://blog.csdn.net/heian_99/article/details/131164591?spm=1001.2014.3001.5501\n1 2 #æ—¥å¿— */2 * * * * cd /python_app/elasticsearch; /opt/anaconda3/envs/py38/bin/python -u es_monitor.py \u0026gt;\u0026gt; es_error_info.log 2\u0026gt;\u0026amp;1 è¯¥å®šæ—¶ä»»åŠ¡çš„å«ä¹‰æ˜¯æ¯éš”2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æŒ‡å®šç›®å½•ä¸‹çš„ es_monitor.py è„šæœ¬ï¼Œå¹¶å°†è¾“å‡ºä¿¡æ¯è¿½åŠ åˆ° es_error_info.log æ–‡ä»¶ä¸­ã€‚è¿™æ ·å¯ä»¥å®šæœŸç›‘æ§ Elasticsearch çš„é”™è¯¯æ—¥å¿—ï¼Œå¹¶è®°å½•ç›¸å…³ä¿¡æ¯ä»¥ä¾¿åç»­æŸ¥çœ‹å’Œåˆ†æã€‚\n7ã€æ€»ç»“ æœ¬åšå®¢ï¼Œä¸ºæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨æ—¥å¿—ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿï¼Œé€šè¿‡ELKæŠ€æœ¯æ ˆå’Œé’‰é’‰æœºå™¨äººçš„ç»“åˆï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å¤ŸåŠæ—¶å‘ç°å’Œå¤„ç†åº”ç”¨ä¸­çš„é”™è¯¯ï¼Œæé«˜äº†å›¢é˜Ÿçš„å·¥ä½œæ•ˆç‡å’Œç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚\n","date":"2023-06-17T18:26:30Z","image":"https://www.ownit.top/title_pic/10.jpg","permalink":"https://www.ownit.top/p/202306171826/","title":"æé«˜é”™è¯¯æ—¥å¿—å¤„ç†æ•ˆç‡ï¼ä½¿ç”¨Pythonå’Œé’‰é’‰æœºå™¨äººå®ç°è‡ªåŠ¨å‘Šè­¦èšåˆ"},{"content":"ç®€ä»‹ï¼š Jenkinsæ˜¯ä¸€ä¸ªæµè¡Œçš„å¼€æºè‡ªåŠ¨åŒ–æœåŠ¡å™¨ï¼Œè€ŒGitLabæ˜¯ä¸€ä¸ªå¼ºå¤§çš„ä»£ç æ‰˜ç®¡å’Œåä½œå¹³å°ã€‚é€šè¿‡ç»“åˆJenkinså’ŒGitLabï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªå¼ºå¤§çš„å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒ–å·¥ä½œæµç¨‹ï¼Œå®ç°ä»£ç æ‹‰å–ã€æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²çš„è‡ªåŠ¨åŒ–ã€‚æœ¬ç¯‡åšå®¢å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨Jenkinsä¸GitLabç›¸ç»“åˆï¼Œæ„å»ºä¸€ä¸ªå®Œæ•´çš„å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒ–æµç¨‹ã€‚\nèƒŒæ™¯ ç›®å‰æˆ‘ä»¬çš„ä»£ç å­˜æ”¾åœ¨gitlabä¸­ï¼Œæœ‰ç‰ˆæœ¬æ§åˆ¶æ¯”è¾ƒæ–¹ä¾¿å¼€å‘ã€‚ç°åœ¨æœ‰ä¸ªCrontabçš„ä»“åº“å­˜æ”¾ï¼Œæ—¥å¸¸çš„å®šæ—¶ä»»åŠ¡è„šæœ¬ã€‚ å¦‚æœæ”¾åœ¨Linuxçš„crontabä¸Šï¼Œä»£ç æ›´æ–°å®Œæ¯• éœ€è¦åŠæ—¶æ‹‰å–æ‰ä¼š æ‰§è¡Œæ–°çš„ä»£ç ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚è¿™è¾¹å°±é‡‡ç”¨jenkinsçš„crontabæ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡\nä¼˜åŠ¿ Jenkinså¯ä»¥æ»¡è¶³æ‚¨æåˆ°çš„æ ¸å¿ƒéœ€æ±‚ï¼Œå¹¶æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š\nå®¡è®¡æ‰§è¡Œæ—¥å¿—ï¼šJenkinsè®°å½•æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¥å¿—ï¼Œå¹¶æä¾›å¯è§†åŒ–ç•Œé¢æ¥æŸ¥çœ‹å’Œå®¡è®¡ä»»åŠ¡çš„æ‰§è¡Œå†å²ã€‚æ‚¨å¯ä»¥éšæ—¶æŸ¥çœ‹ä»»åŠ¡çš„æ‰§è¡Œè¾“å‡ºã€é”™è¯¯ä¿¡æ¯ä»¥åŠä»»ä½•äº§ç”Ÿçš„è­¦å‘Šæˆ–å¼‚å¸¸ã€‚\nä»»åŠ¡è¶…æ—¶å¼ºåˆ¶killï¼šJenkinså…è®¸æ‚¨ä¸ºæ¯ä¸ªä»»åŠ¡è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚å¦‚æœä»»åŠ¡åœ¨æŒ‡å®šçš„æ—¶é—´å†…æœªå®Œæˆï¼ŒJenkinsä¼šå¼ºåˆ¶ç»ˆæ­¢ä»»åŠ¡çš„æ‰§è¡Œï¼Œä»¥é˜²æ­¢æ— é™å¾ªç¯æˆ–èµ„æºå ç”¨ç­‰é—®é¢˜ã€‚\nä»»åŠ¡çš„è¶…æ—¶é‡è¯•ï¼šJenkinsæä¾›äº†å†…ç½®çš„æ’ä»¶ï¼Œå¦‚Pipelineå’ŒJob DSLï¼Œå¯ä»¥è½»æ¾åœ°ç¼–å†™è‡ªå®šä¹‰çš„ä»»åŠ¡æµç¨‹ï¼Œå¹¶æ”¯æŒä»»åŠ¡çš„è¶…æ—¶é‡è¯•ã€‚æ‚¨å¯ä»¥åœ¨ä»»åŠ¡å¤±è´¥æˆ–è¶…æ—¶åè‡ªåŠ¨è§¦å‘é‡è¯•ï¼Œå¹¶è®¾ç½®é‡è¯•æ¬¡æ•°å’Œæ—¶é—´é—´éš”ï¼Œä»¥ç¡®ä¿ä»»åŠ¡èƒ½å¤ŸæˆåŠŸå®Œæˆã€‚\né”™è¯¯é‡è¯•å’Œè‡ªå®šä¹‰æ¬¡æ•°ï¼šJenkinsæä¾›äº†çµæ´»çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œæ‚¨å¯ä»¥åœ¨ä»»åŠ¡æ‰§è¡Œå¤±è´¥æ—¶è‡ªå®šä¹‰å¤„ç†é€»è¾‘ã€‚æ‚¨å¯ä»¥è®¾ç½®ä»»åŠ¡åœ¨é‡åˆ°é”™è¯¯æ—¶è‡ªåŠ¨è§¦å‘é‡è¯•ï¼Œå¹¶æŒ‡å®šé‡è¯•æ¬¡æ•°å’Œé‡è¯•é—´éš”ï¼Œä»¥ä¾¿åº”å¯¹ä¸´æ—¶æ€§çš„é”™è¯¯å’Œé—®é¢˜ã€‚\nJenkinsä½œä¸ºä¸€ä¸ªå¼€æºçš„è‡ªåŠ¨åŒ–æœåŠ¡å™¨ï¼Œå…·æœ‰å¹¿æ³›çš„ç¤¾åŒºæ”¯æŒå’Œä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ç³»ç»Ÿï¼Œå¯ä»¥æ»¡è¶³å„ç§å¤æ‚çš„ä»»åŠ¡è°ƒåº¦å’Œè‡ªåŠ¨åŒ–éœ€æ±‚ã€‚é€šè¿‡é€‚å½“çš„é…ç½®å’Œä½¿ç”¨æ’ä»¶ï¼Œæ‚¨å¯ä»¥å®ç°é«˜åº¦å®šåˆ¶åŒ–çš„ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œæµç¨‹ï¼Œæ»¡è¶³æ‚¨ç‰¹å®šçš„éœ€æ±‚ï¼Œå¹¶ç¡®ä¿ä»»åŠ¡çš„å¯é æ‰§è¡Œå’Œé”™è¯¯å¤„ç†ã€‚\nGitlabåˆ›å»ºä»“åº“ ç™»å½•GitLabï¼šæ‰“å¼€æ‚¨çš„Webæµè§ˆå™¨ï¼Œè¾“å…¥GitLabçš„URLï¼Œå¹¶ä½¿ç”¨æ‚¨çš„GitLabè´¦æˆ·ç™»å½•ã€‚\nå¯¼èˆªåˆ°é¡¹ç›®é¡µé¢ï¼šç™»å½•åï¼Œæ‚¨å°†çœ‹åˆ°GitLabçš„ä»ªè¡¨æ¿æˆ–é¡¹ç›®åˆ—è¡¨ã€‚ç‚¹å‡»é¡µé¢é¡¶éƒ¨çš„â€œ+â€æŒ‰é’®æˆ–å¯¼èˆªæ ä¸Šçš„â€œNew projectâ€æŒ‰é’®ã€‚\nåˆ›å»ºæ–°é¡¹ç›®ï¼šåœ¨æ–°é¡¹ç›®é¡µé¢ä¸Šï¼Œæ‚¨éœ€è¦æä¾›ä»¥ä¸‹ä¿¡æ¯æ¥åˆ›å»ºæ–°çš„ä»“åº“ï¼š\né¡¹ç›®è·¯å¾„ï¼šæŒ‡å®šé¡¹ç›®çš„è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯é¡¹ç›®åœ¨GitLabä¸Šçš„URLåœ°å€ã€‚å®ƒå°†ç”¨äºåœ¨ä»“åº“çš„URLä¸­å”¯ä¸€æ ‡è¯†æ‚¨çš„é¡¹ç›®ã€‚ å¯è§çº§åˆ«ï¼šé€‰æ‹©æ‚¨å¸Œæœ›è°èƒ½è®¿é—®æ‚¨çš„é¡¹ç›®ã€‚æ‚¨å¯ä»¥é€‰æ‹©å…¬å¼€ï¼ˆPublicï¼‰ã€ç§æœ‰ï¼ˆPrivateï¼‰æˆ–å†…éƒ¨ï¼ˆInternalï¼‰å¯è§æ€§çº§åˆ«ã€‚ é¡¹ç›®åç§°ï¼šä¸ºæ‚¨çš„é¡¹ç›®æŒ‡å®šä¸€ä¸ªæ˜“äºè¯†åˆ«çš„åç§°ã€‚ æè¿°ï¼ˆå¯é€‰ï¼‰ï¼šæä¾›å…³äºé¡¹ç›®çš„ç®€è¦æè¿°ï¼Œä»¥ä¾¿å…¶ä»–äººäº†è§£é¡¹ç›®çš„ç›®çš„å’Œå†…å®¹ã€‚ åˆå§‹åŒ–ä»“åº“ï¼šé€‰æ‹©æ˜¯å¦è¦åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ä»“åº“ï¼Œæˆ–è€…æ‚¨å¯ä»¥é€‰æ‹©ä»ç°æœ‰çš„ä»£ç åº“å¯¼å…¥ä»£ç ã€‚ å®Œæˆè®¾ç½®ï¼šåœ¨æä¾›å¿…è¦ä¿¡æ¯åï¼Œå•å‡»é¡µé¢ä¸‹æ–¹çš„â€œCreate projectâ€æŒ‰é’®ã€‚GitLabå°†æ ¹æ®æ‚¨æä¾›çš„ä¿¡æ¯åˆ›å»ºæ–°çš„ä»“åº“ï¼Œå¹¶å°†æ‚¨é‡å®šå‘åˆ°æ–°ä»“åº“çš„é¡µé¢ã€‚\né…ç½®ä»“åº“ï¼ˆå¯é€‰ï¼‰ï¼šåœ¨æ–°ä»“åº“é¡µé¢ä¸Šï¼Œæ‚¨å¯ä»¥è¿›ä¸€æ­¥é…ç½®ä»“åº“çš„è®¾ç½®ï¼Œä¾‹å¦‚æ·»åŠ é¡¹ç›®æˆå‘˜ã€è®¾ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™ã€å¯ç”¨CI/CDç­‰ã€‚è¿™äº›è®¾ç½®å¯ä»¥æ ¹æ®æ‚¨çš„å…·ä½“éœ€æ±‚è¿›è¡Œè°ƒæ•´ã€‚ æ·»åŠ æµ‹è¯•è„šæœ¬\nmonitor.sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 #!/bin/bash echo \u0026#34;=======================\u0026#34; echo $(date) #!/bin/bash # @Author: danqing # @Description: Host Daily Check Script # beseem CentOS6.X CentOS7.X # echo \u0026#34;Host Daily Check Script\u0026#34; [ $(id -u) -gt 0 ] \u0026amp;\u0026amp; echo \u0026#34;è¯·ç”¨rootç”¨æˆ·æ‰§è¡Œæ­¤è„šæœ¬ï¼\u0026#34; \u0026amp;\u0026amp; exit 1 if [ ! -d /root/check_log ];then mkdir /root/check_log echo \u0026#34;/root/check_logæ£€æŸ¥æ—¥å¿—å­˜æ”¾ç›®å½•åˆ›å»ºæˆåŠŸ\u0026#34; else echo \u0026#34;/root/check_logæ£€æŸ¥æ—¥å¿—å­˜æ”¾ç›®å½•å·²å­˜åœ¨\u0026#34; fi function getSystem(){ echo \u0026#34;\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;############################ ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥ ############################\u0026#34; Default_LANG=${LANG} OS=$(uname -o) Release=$(cat /etc/redhat-release 2\u0026gt;/dev/null) Kernel=$(uname -r) Hostname=$(uname -n) Nowdate=$(date +\u0026#39;%F %T\u0026#39;) LastReboot=$(who -b | awk \u0026#39;{print $3,$4}\u0026#39;) uptime=$(uptime | sed \u0026#39;s/.*up \\([^,]*\\), .*/\\1/\u0026#39;) echo \u0026#34; è¯­è¨€ç¯å¢ƒ: $Default_LANG\u0026#34; echo \u0026#34; ç³»ç»Ÿ: $OS\u0026#34; echo \u0026#34; å‘è¡Œç‰ˆæœ¬: $Release\u0026#34; echo \u0026#34; å†…æ ¸: $Kernel\u0026#34; echo \u0026#34; ä¸»æœºå: $Hostname\u0026#34; echo \u0026#34; å½“å‰æ—¶é—´: $Nowdate\u0026#34; echo \u0026#34; æœ€åå¯åŠ¨: $LastReboot\u0026#34; echo \u0026#34; è¿è¡Œæ—¶é—´: $uptime\u0026#34; } function getCpu(){ echo \u0026#34;\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;############################ CPUæ£€æŸ¥ ############################\u0026#34; Physical_CPUs=$(grep \u0026#34;physical id\u0026#34; /proc/cpuinfo| sort | uniq | wc -l) Virt_CPUs=$(grep \u0026#34;processor\u0026#34; /proc/cpuinfo | wc -l) CPU_Kernels=$(grep \u0026#34;cores\u0026#34; /proc/cpuinfo|uniq| awk -F \u0026#39;: \u0026#39; \u0026#39;{print $2}\u0026#39;) CPU_Type=$(grep \u0026#34;model name\u0026#34; /proc/cpuinfo | awk -F \u0026#39;: \u0026#39; \u0026#39;{print $2}\u0026#39; | sort | uniq) CPU_Hz=$(cat /proc/cpuinfo | grep \u0026#34;cpu MHz\u0026#34; | uniq | awk -F\u0026#39;:\u0026#39; \u0026#39;{sub(/ /,\u0026#34;\u0026#34;,$2);printf \u0026#34;%s MHz\\n\u0026#34;,$2}\u0026#39;) CPU_Arch=$(uname -m) CPU_Usage=$(cat /proc/loadavg | awk \u0026#39;{print $1}\u0026#39;) echo \u0026#34;ç‰©ç†CPUä¸ªæ•°: $Physical_CPUs\u0026#34; echo \u0026#34;é€»è¾‘CPUä¸ªæ•°: $Virt_CPUs\u0026#34; echo \u0026#34;æ¯CPUæ ¸å¿ƒæ•°: $CPU_Kernels\u0026#34; echo \u0026#34;CPUå‹å·: $CPU_Type\u0026#34; echo \u0026#34;CPUé¢‘ç‡: $CPU_Hz\u0026#34; echo \u0026#34;CPUæ¶æ„: $CPU_Arch\u0026#34; echo \u0026#34;CPUä½¿ç”¨ç‡: ${CPU_Usage}%\u0026#34; } function getMemory(){ echo \u0026#34;\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;############################ å†…å­˜æ£€æŸ¥ ############################\u0026#34; Memory_Used=$(awk \u0026#39;/MemTotal/{total=$2}/MemFree/{free=$2}END{print (total-free)/1024/1024}\u0026#39; /proc/meminfo) Memory_Total=$(awk \u0026#39;/MemTotal/{total=$2}END{print (total)/1024/1024}\u0026#39; /proc/meminfo) # kbçš„æ¢ç®—æ˜¯1000 kBçš„æ¢ç®—æ˜¯1024 Memory_Usage=$(awk \u0026#39;/MemTotal/{total=$2}/MemFree/{free=$2}END{print (total-free)/total*100}\u0026#39; /proc/meminfo) echo \u0026#34;å·²ä½¿ç”¨å†…å­˜/å…¨éƒ¨å†…å­˜: ${Memory_Used}GB/${Memory_Total}GB\u0026#34; echo \u0026#34;å†…å­˜ä½¿ç”¨ç‡: ${Memory_Usage}%\u0026#34; } function getDisk(){ echo \u0026#34;\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;############################ ç¡¬ç›˜æ£€æŸ¥ ############################\u0026#34; Disk_Count=$(lsblk |awk \u0026#39;/disk/{print $1}\u0026#39;|wc -l) echo \u0026#34;ç¡¬ç›˜æ•°é‡: ${Disk_Count}ä¸ª\u0026#34; echo \u0026#34;ç¡¬ç›˜åˆ†åŒºæƒ…å†µ: \u0026#34; echo \u0026#34;`df -hTP | sort |grep -E \u0026#34;/sd|/mapper\u0026#34; |awk \u0026#39;{print ($1 \u0026#34;\\t\\n\u0026#34; \u0026#34; æ–‡ä»¶ç³»ç»Ÿ\u0026#34;$2 \u0026#34; åˆè®¡\u0026#34;$3 \u0026#34; å·²ç”¨\u0026#34;$4 \u0026#34; å‰©ä½™\u0026#34;$5 \u0026#34; ä½¿ç”¨ç‡\u0026#34;$6 \u0026#34; æŒ‚è½½ç‚¹\u0026#34;$7)}\u0026#39;`\u0026#34; # -P, --portability ä½¿ç”¨ POSIX è¾“å‡ºæ ¼å¼,æ–¹ä¾¿shellè¿‡æ»¤å¤„ç† smartctl -V \u0026gt;\u0026amp;/dev/null if [ $? -eq 0 ]; then echo \u0026#34;smartctlå·¥å…·å·²å®‰è£…,å¯ä»¥è¿›è¡Œç¡¬ç›˜å¥åº·æ£€æµ‹: \u0026#34; for i in $(lsblk |awk \u0026#39;/disk/{print $1}\u0026#39;) do echo \u0026#34;ç¡¬ç›˜\u0026#34;$i `smartctl -H /dev/$i |grep -Ei \u0026#34;OK|PASSED|FAILED|Failure|Failed\u0026#34;` done else echo \u0026#34;smartctlå·¥å…·æœªå®‰è£…,æ— æ³•è¿›è¡Œç¡¬ç›˜å¥åº·æ£€æµ‹\u0026#34; fi # \u0026#34;\\nç£ç›˜IOä¿¡æ¯:$(iotop -bon 1 \u0026amp;\u0026gt;/dev/null || echo \u0026#39;iotop æœªå®‰è£…ä¿¡æ¯è·å–å¤±è´¥\u0026#39;)\u0026#34; } function getNetwork(){ echo \u0026#34;\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;############################ ç½‘ç»œæ£€æŸ¥ ############################\u0026#34; Network_Device=$(cat /proc/net/dev | awk \u0026#39;NR\u0026gt;2 \u0026amp;\u0026amp; $1 !~/lo/ {sub(/:/,\u0026#34;\u0026#34;);print $1}\u0026#39;) for i in $Network_Device do #echo \u0026#34;ç½‘å¡ï¼š$i çŠ¶æ€: $(ip link show $Network_Device | awk \u0026#39;NR==1{print $9}\u0026#39;) RX: $(ethtool -g $Network_Device | grep \u0026#34;RX:\u0026#34; | tail -1 | awk \u0026#39;{print $2}\u0026#39;) TX: $(ethtool -g $Network_Device | grep \u0026#34;TX:\u0026#34; | tail -1 | awk \u0026#39;{print $2}\u0026#39;)\u0026#34; # rxæ˜¯æ¥æ”¶(receive),txæ˜¯å‘é€(transport) Mac_Info=$(ip link | egrep -v \u0026#34;lo\u0026#34; | grep link | awk \u0026#39;{print $2}\u0026#39;) echo \u0026#34;MACåœ°å€: $Mac_Info\u0026#34; Private_Ip=$(ip addr | awk \u0026#39;/^[0-9]+: / {}; /inet.*global/ {print gensub(/(.*)\\/(.*)/, \u0026#34;\\\\1\u0026#34;, \u0026#34;g\u0026#34;, $2)}\u0026#39;) echo \u0026#34;IPåœ°å€: $Private_Ip\u0026#34; # Public_Ip=$(curl ifconfig.me -s) # echo \u0026#34;å…¬ç½‘IPåœ°å€: $Public_Ip\u0026#34; Gateway=$(ip route | grep default | awk \u0026#39;{print $3}\u0026#39;) # echo \u0026#34;ç½‘å…³åœ°å€: $Gateway\u0026#34; # Dns_Config=$(grep nameserver /etc/resolv.conf| grep -v \u0026#34;#\u0026#34; | awk \u0026#39;{print $2}\u0026#39; | tr \u0026#39;\\n\u0026#39; \u0026#39;,\u0026#39; | sed \u0026#39;s/,$//\u0026#39;) # echo \u0026#34;DNSåœ°å€: $Dns_Config\u0026#34; echo \u0026#34;ç½‘å…³è¿æ¥æƒ…å†µ: $(ping -c 4 -i 0.5 -W 3 $Gateway \u0026amp;\u0026gt;/dev/null \u0026amp;\u0026amp; echo \u0026#39;æ­£å¸¸é€šä¿¡\u0026#39; || echo \u0026#39;æ— æ³•é€šä¿¡\u0026#39;)\u0026#34; echo \u0026#34;å¤–ç½‘è¿æ¥æƒ…å†µ: $(ping -c 4 -i 0.5 -W 3 baidu.com \u0026amp;\u0026gt;/dev/null \u0026amp;\u0026amp; echo \u0026#39;æ­£å¸¸é€šä¿¡\u0026#39; || echo \u0026#39;æ— æ³•é€šä¿¡\u0026#39;)\u0026#34; # å‘é€4æ¬¡è¯·æ±‚åŒ…ï¼Œæ¯æ¬¡é—´éš”0.5ç§’ï¼Œæœ€é•¿ç­‰å¾…æ—¶é—´ä¸º3ç§’ done Listen_Port=$(ss -tuln | grep LISTEN | awk \u0026#39;{print $5}\u0026#39; | awk -F: \u0026#39;{print $2$4}\u0026#39; | sort |uniq -d | tr \u0026#39;\\n\u0026#39; \u0026#39;,\u0026#39; | sed \u0026#39;s/,$//\u0026#39;) echo \u0026#34;ç³»ç»Ÿè¿è¡Œçš„ç«¯å£: $Listen_Port\u0026#34; } function check(){ echo \u0026#34;Host Daily Check Script\u0026#34; getSystem getCpu getMemory getDisk getNetwork } RESULTFILE=\u0026#34;/root/check_log/check-`date +%Y%m%d`.txt\u0026#34; check \u0026gt; $RESULTFILE echo \u0026#34;æ£€æŸ¥ç»“æœï¼š$RESULTFILE\u0026#34; cat $RESULTFILE Jenkinsé…ç½®Gitlabçš„è®¤è¯å‡­è¯ åœ¨Jenkinsä¸­é…ç½®GitLabçš„è®¤è¯å‡­è¯ï¼Œæ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼š\nç™»å½•Jenkinsï¼šæ‰“å¼€æ‚¨çš„Webæµè§ˆå™¨ï¼Œè¾“å…¥Jenkinsçš„URLï¼Œå¹¶ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•åˆ°Jenkinsæ§åˆ¶å°ã€‚\nå¯¼èˆªåˆ°å‡­æ®é¡µé¢ï¼šåœ¨Jenkinsæ§åˆ¶å°çš„ä¸»é¡µä¸Šï¼Œç‚¹å‡»å·¦ä¾§å¯¼èˆªæ ä¸­çš„\u0026quot;å‡­æ®\u0026quot;ï¼ˆCredentialsï¼‰é€‰é¡¹ã€‚ åˆ›å»ºæ–°çš„å‡­æ®ï¼šåœ¨å‡­æ®é¡µé¢ï¼Œç‚¹å‡»\u0026quot;ç³»ç»Ÿ\u0026quot;ï¼ˆSystemï¼‰ä¸‹æ–¹çš„\u0026quot;å…¨å±€å‡­æ®\u0026quot;ï¼ˆGlobal credentialsï¼‰é€‰é¡¹ã€‚\næ·»åŠ å‡­æ®ï¼šåœ¨å…¨å±€å‡­æ®é¡µé¢ï¼Œç‚¹å‡»\u0026quot;æ·»åŠ å‡­æ®\u0026quot;ï¼ˆAdd Credentialsï¼‰æŒ‰é’®ã€‚\né€‰æ‹©å‡­æ®ç±»å‹ï¼šåœ¨\u0026quot;æ·»åŠ å‡­æ®\u0026quot;é¡µé¢ï¼Œé€‰æ‹©GitLabå‡­æ®çš„ç±»å‹ã€‚æ ¹æ®æ‚¨çš„GitLabé…ç½®ï¼Œå¯ä»¥é€‰æ‹©ä¸åŒçš„ç±»å‹ï¼Œä¾‹å¦‚\u0026quot;Username with password\u0026quot;ï¼ˆç”¨æˆ·åå’Œå¯†ç ï¼‰æˆ–\u0026quot;SSH Username with private key\u0026quot;ï¼ˆSSHç”¨æˆ·åå’Œç§é’¥ï¼‰ç­‰ã€‚ å¡«å†™å‡­æ®ä¿¡æ¯ï¼šæ ¹æ®æ‚¨é€‰æ‹©çš„å‡­æ®ç±»å‹ï¼Œå¡«å†™ç›¸å…³çš„å‡­æ®ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé€‰æ‹©\u0026quot;Username with password\u0026quot;ï¼Œåˆ™éœ€è¦æä¾›GitLabçš„ç”¨æˆ·åå’Œå¯†ç ï¼›å¦‚æœé€‰æ‹©\u0026quot;SSH Username with private key\u0026quot;ï¼Œåˆ™éœ€è¦æä¾›GitLabçš„SSHç”¨æˆ·åå’Œç§é’¥ç­‰ä¿¡æ¯ã€‚ ä¿å­˜å‡­æ®ï¼šå®Œæˆå¡«å†™å‡­æ®ä¿¡æ¯åï¼Œç‚¹å‡»é¡µé¢ä¸‹æ–¹çš„\u0026quot;ä¿å­˜\u0026quot;ï¼ˆSaveï¼‰æŒ‰é’®ï¼Œå°†å‡­æ®ä¿å­˜åˆ°Jenkinsä¸­ã€‚\né…ç½®Jenkinsé¡¹ç›®ï¼šåœ¨Jenkinsä¸­çš„é¡¹ç›®é…ç½®ä¸­ï¼Œæ‰¾åˆ°ä¸GitLabç›¸å…³çš„é…ç½®éƒ¨åˆ†ï¼Œä¾‹å¦‚æ„å»ºè§¦å‘å™¨æˆ–æºç ç®¡ç†ã€‚åœ¨è¿™äº›é…ç½®ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°\u0026quot;å‡­æ®\u0026quot;ï¼ˆCredentialsï¼‰çš„é€‰é¡¹ã€‚\né€‰æ‹©å‡­æ®ï¼šåœ¨ç›¸å…³é…ç½®ä¸­ï¼Œæ‰¾åˆ°\u0026quot;å‡­æ®\u0026quot;ï¼ˆCredentialsï¼‰é€‰é¡¹ï¼Œå¹¶é€‰æ‹©æ‚¨ä¹‹å‰ä¿å­˜çš„GitLabå‡­æ®ã€‚\nä¿å­˜é…ç½®ï¼šå®Œæˆå‡­æ®é€‰æ‹©åï¼Œç¡®ä¿ä¿å­˜é¡¹ç›®çš„é…ç½®ã€‚\nå®Œæˆä¸Šè¿°æ­¥éª¤åï¼ŒJenkinså°†èƒ½å¤Ÿä½¿ç”¨æ‚¨é…ç½®çš„GitLabå‡­æ®è¿›è¡Œä¸GitLabçš„äº¤äº’ï¼Œä¾‹å¦‚æ‹‰å–ä»£ç ã€è§¦å‘æ„å»ºç­‰æ“ä½œã€‚è¿™æ ·ï¼Œæ‚¨å°±å¯ä»¥é€šè¿‡Jenkinsä¸GitLabè¿›è¡Œæ— ç¼é›†æˆï¼Œå¹¶å®ç°æŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜çš„è‡ªåŠ¨åŒ–æµç¨‹ã€‚\nJenkinsè®¾ç½®å®šæ—¶ä»»åŠ¡ ç™»å½•Jenkinsï¼šä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•åˆ°Jenkinsæ§åˆ¶å°ã€‚\nåˆ›å»ºæ–°é¡¹ç›®ï¼šåœ¨Jenkinsæ§åˆ¶å°ä¸»é¡µä¸Šï¼Œç‚¹å‡»\u0026quot;æ–°å»ºä»»åŠ¡\u0026quot;ï¼ˆNew Itemï¼‰æŒ‰é’®ã€‚\nè¾“å…¥é¡¹ç›®åç§°ï¼šä¸ºæ–°é¡¹ç›®æŒ‡å®šä¸€ä¸ªæ˜“äºè¯†åˆ«çš„åç§°ï¼Œå¹¶é€‰æ‹©è‡ªç”±é£æ ¼çš„è½¯ä»¶é¡¹ç›®ï¼ˆFreeStyle Projectï¼‰ç±»å‹ã€‚ é…ç½®æºç ç®¡ç†ï¼šåœ¨é¡¹ç›®é…ç½®é¡µé¢çš„\u0026quot;æºç ç®¡ç†\u0026quot;ï¼ˆSource Code Managementï¼‰éƒ¨åˆ†ï¼Œé€‰æ‹©Gitä½œä¸ºæºç ç®¡ç†å·¥å…·ï¼Œå¹¶å¡«å†™GitLabä»“åº“çš„URLã€‚\né…ç½®å‡­æ®ï¼šå¦‚æœæ‚¨ä¹‹å‰åœ¨Jenkinsä¸­é…ç½®äº†GitLabçš„è®¤è¯å‡­è¯ï¼Œè¯·åœ¨æºç ç®¡ç†éƒ¨åˆ†é€‰æ‹©ç›¸åº”çš„å‡­æ®ï¼Œä»¥ä¾¿Jenkinsèƒ½å¤Ÿè®¿é—®GitLabä»“åº“ã€‚ é…ç½®æ„å»ºè§¦å‘å™¨ï¼šåœ¨é¡¹ç›®é…ç½®é¡µé¢çš„\u0026quot;æ„å»ºè§¦å‘å™¨\u0026quot;ï¼ˆBuild Triggersï¼‰éƒ¨åˆ†ï¼Œé€‰æ‹©\u0026quot;å®šæ—¶æ„å»º\u0026quot;ï¼ˆBuild periodicallyï¼‰é€‰é¡¹ã€‚\nè®¾ç½®å®šæ—¶ä»»åŠ¡ï¼šåœ¨\u0026quot;å®šæ—¶æ„å»º\u0026quot;é€‰é¡¹ä¸­ï¼Œä½¿ç”¨Cronè¡¨è¾¾å¼æŒ‡å®šå®šæœŸæ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œè¦æ¯å¤©çš„ä¸Šåˆ9ç‚¹æ‰§è¡Œä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨\u0026quot;0 9 * * *\u0026ldquo;çš„Cronè¡¨è¾¾å¼ã€‚ é…ç½®æ„å»ºæ­¥éª¤ï¼šåœ¨é¡¹ç›®é…ç½®é¡µé¢çš„\u0026quot;æ„å»º\u0026rdquo;ï¼ˆBuildï¼‰éƒ¨åˆ†ï¼Œé…ç½®éœ€è¦æ‰§è¡Œçš„æ„å»ºæ­¥éª¤ã€‚è¿™å¯ä»¥æ˜¯æ„å»ºè„šæœ¬ã€æµ‹è¯•å‘½ä»¤ã€éƒ¨ç½²æ“ä½œæˆ–ä»»ä½•å…¶ä»–æ‚¨å¸Œæœ›Jenkinsæ‰§è¡Œçš„ä»»åŠ¡ã€‚ ä¿å­˜é…ç½®ï¼šå®Œæˆé…ç½®åï¼Œç¡®ä¿ä¿å­˜é¡¹ç›®çš„é…ç½®ã€‚\nJenkinså°†æŒ‰ç…§æ‚¨è®¾ç½®çš„å®šæ—¶ä»»åŠ¡ï¼Œå®šæœŸæ‹‰å–GitLabä»“åº“ä¸­çš„ä»£ç ï¼Œå¹¶æ‰§è¡Œæ‚¨é…ç½®çš„æ„å»ºæ­¥éª¤ã€‚æ‚¨å¯ä»¥åœ¨Jenkinsæ§åˆ¶å°çš„é¡¹ç›®é¡µé¢ä¸ŠæŸ¥çœ‹æ¯æ¬¡æ„å»ºçš„æ‰§è¡Œæ—¥å¿—å’Œç»“æœï¼Œä»¥åŠä»»ä½•äº§ç”Ÿçš„è­¦å‘Šæˆ–é”™è¯¯ã€‚\nJenkinså®šæ—¶ä»»åŠ¡æ‰§è¡Œ æ—¶é—´ æŸ¥è¯¢æ—¥å¿— ","date":"2023-06-12T11:20:03Z","image":"https://www.ownit.top/title_pic/12.jpg","permalink":"https://www.ownit.top/p/202306121120/","title":"å®ç°æ— é—´æ–­çš„è‡ªåŠ¨åŒ–ï¼šJenkinsä¸GitLabçš„å®šæ—¶ä»»åŠ¡å·¥ä½œæµç¨‹"},{"content":"æ–¹æ¡ˆä¸€ åŸºäºLVMå¿«ç…§è¿›è¡Œå¤‡ä»½åˆ‡æ¢ ä»‹ç»: MySQLæ•°æ®åº“æœ¬èº«å¹¶ä¸æ”¯æŒå¿«ç…§åŠŸèƒ½(sqlServeræ”¯æŒ) å› æ­¤å¿«ç…§å¤‡ä»½æ˜¯æŒ‡é€šè¿‡æ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„å¿«ç…§åŠŸèƒ½å¯¹æ•°æ®åº“è¿›è¡Œå¤‡ä»½ å¤‡ä»½çš„å‰ææ˜¯å°†æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶æ”¾åœ¨åŒä¸€æ–‡ä»¶åˆ†åŒºä¸­ï¼Œç„¶åå¯¹è¯¥åˆ†åŒºè¿›è¡Œå¿«ç…§æ“ä½œ\nLVMæ˜¯LINUXç³»ç»Ÿä¸‹å¯¹ç£ç›˜åˆ†åŒºè¿›è¡Œç®¡ç†çš„ä¸€ç§æœºåˆ¶,LVMä½¿ç”¨å†™æ—¶å¤åˆ¶(copy-on-write)çš„æŠ€æœ¯æ¥åˆ›å»ºå¿«ç…§â€”â€”ä¾‹å¦‚ï¼Œå½“åˆ›å»ºä¸€ä¸ªå¿«ç…§æ—¶ï¼Œä»…å¤åˆ¶åŸå§‹å·ä¸­æ•°æ®çš„å…ƒæ•°æ®(meta data æ³¨ï¼šdata block)ï¼Œå¹¶ä¸ä¼šæœ‰æ•°æ®çš„ç‰©ç†æ“ä½œï¼Œå› æ­¤ å¿«ç…§çš„åˆ›å»ºè¿‡ç¨‹æ˜¯éå¸¸å¿«çš„. ä»¥ä¸‹æ˜¯å…³äºpvcreateã€vgcreateå’Œlvcreateå‘½ä»¤çš„è§£é‡Šå’Œå®ƒä»¬åœ¨é€»è¾‘å·ç®¡ç†è¿‡ç¨‹ä¸­çš„å…³ç³»å›¾ï¼š\npvcreateï¼špvcreateå‘½ä»¤ç”¨äºåˆ›å»ºç‰©ç†å·ï¼ˆPhysical Volumeï¼ŒPVï¼‰ã€‚ç‰©ç†å·æ˜¯ç¡¬ç›˜æˆ–åˆ†åŒºçš„é€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰ç»„ä»¶ï¼Œç”¨äºå­˜å‚¨æ•°æ®ã€‚pvcreateå‘½ä»¤ä¼šå°†æŒ‡å®šçš„ç¡¬ç›˜æˆ–åˆ†åŒºæ ‡è®°ä¸ºç‰©ç†å·ï¼Œå¹¶å‡†å¤‡å…¶ç”¨äºé€»è¾‘å·çš„åˆ›å»ºã€‚\nvgcreateï¼švgcreateå‘½ä»¤ç”¨äºåˆ›å»ºå·ç»„ï¼ˆVolume Groupï¼ŒVGï¼‰ã€‚å·ç»„æ˜¯ç‰©ç†å·çš„é€»è¾‘åˆ†ç»„ï¼Œå®ƒå…è®¸å°†å¤šä¸ªç‰©ç†å·ç»„ç»‡åœ¨ä¸€èµ·ä»¥å½¢æˆä¸€ä¸ªå¤§å®¹é‡çš„å­˜å‚¨æ± ã€‚vgcreateå‘½ä»¤ä¼šå°†å¤šä¸ªç‰©ç†å·ç»„åˆæˆä¸€ä¸ªå·ç»„ï¼Œå¹¶ä¸ºè¯¥å·ç»„åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„åç§°ã€‚\nlvcreateï¼šlvcreateå‘½ä»¤ç”¨äºåˆ›å»ºé€»è¾‘å·ï¼ˆLogical Volumeï¼ŒLVï¼‰ã€‚é€»è¾‘å·æ˜¯å·ç»„ä¸­çš„é€»è¾‘å­˜å‚¨å•å…ƒï¼Œç±»ä¼¼äºä¼ ç»Ÿçš„åˆ†åŒºã€‚é€»è¾‘å·å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´å¤§å°ï¼Œå¹¶ç”¨äºåˆ›å»ºæ–‡ä»¶ç³»ç»Ÿæˆ–æŒ‚è½½å…¶ä»–æ–‡ä»¶ç³»ç»Ÿã€‚lvcreateå‘½ä»¤ä¼šåœ¨æŒ‡å®šçš„å·ç»„ä¸­åˆ›å»ºä¸€ä¸ªé€»è¾‘å·ï¼Œå¹¶ä¸ºå…¶åˆ†é…å¤§å°å’Œåç§°ã€‚\nä¸‹é¢æ˜¯å®ƒä»¬ä¹‹é—´çš„å…³ç³»å›¾ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 +------------------------+ | pvcreate | | (åˆ›å»ºç‰©ç†å·ï¼ŒPV) | +-----------|------------+ | v +------------------------+ | vgcreate | | (åˆ›å»ºå·ç»„ï¼ŒVG) | +-----------|------------+ | v +------------------------+ | lvcreate | | (åˆ›å»ºé€»è¾‘å·ï¼ŒLV) | +------------------------+ å®æˆ˜åˆ†ç›˜ å‡è®¾æ‚¨è¦ä½¿ç”¨ä¸€å—10TBçš„ç£ç›˜æ¥åˆ›å»ºé€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰ç»“æ„ï¼Œä»¥ä¸‹æ˜¯ä½¿ç”¨pvcreateã€vgcreateå’Œlvcreateçš„å‘½ä»¤å’Œè§£é‡Šï¼š\npvcreateï¼šåˆ›å»ºç‰©ç†å·ï¼ˆPhysical Volumeï¼ŒPVï¼‰ å‘½ä»¤ï¼špvcreate /dev/sdX è§£é‡Šï¼šä½¿ç”¨pvcreateå‘½ä»¤åˆ›å»ºç‰©ç†å·æ—¶ï¼Œå°†/dev/sdXæ›¿æ¢ä¸ºæ‚¨è¦ä½¿ç”¨çš„å®é™…ç£ç›˜è®¾å¤‡è·¯å¾„ï¼Œä¾‹å¦‚/dev/sdaã€‚è¯¥å‘½ä»¤ä¼šå°†ç£ç›˜è®¾å¤‡æ ‡è®°ä¸ºç‰©ç†å·ï¼Œä»¥ä¾¿ç”¨äºé€»è¾‘å·çš„åˆ›å»ºã€‚ vgcreateï¼šåˆ›å»ºå·ç»„ï¼ˆVolume Groupï¼ŒVGï¼‰ å‘½ä»¤ï¼švgcreate vg_name /dev/sdX è§£é‡Šï¼šä½¿ç”¨vgcreateå‘½ä»¤åˆ›å»ºå·ç»„æ—¶ï¼Œå°†vg_nameæ›¿æ¢ä¸ºæ‚¨æƒ³è¦ä¸ºå·ç»„æŒ‡å®šçš„åç§°ï¼Œ/dev/sdXä¸ºå·²åˆ›å»ºç‰©ç†å·çš„ç£ç›˜è®¾å¤‡è·¯å¾„ã€‚è¯¥å‘½ä»¤å°†ä¸€ä¸ªæˆ–å¤šä¸ªç‰©ç†å·ç»„åˆæˆä¸€ä¸ªå·ç»„ï¼Œä»¥ä¾¿åœ¨å…¶ä¸­åˆ›å»ºé€»è¾‘å·ã€‚ lvcreateï¼šåˆ›å»ºé€»è¾‘å·ï¼ˆLogical Volumeï¼ŒLVï¼‰ å‘½ä»¤ï¼šlvcreate -L size -n lv_name vg_name è§£é‡Šï¼šä½¿ç”¨lvcreateå‘½ä»¤åˆ›å»ºé€»è¾‘å·æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‚æ•°ï¼š -L sizeï¼šæŒ‡å®šé€»è¾‘å·çš„å¤§å°ï¼Œå¯ä»¥ä½¿ç”¨å•ä½ï¼ˆå¦‚Gã€Mã€Tï¼‰æ¥è¡¨ç¤ºå¤§å°ã€‚ ä¾‹å¦‚ï¼Œ-L 5Gè¡¨ç¤ºåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º5GBçš„é€»è¾‘å·ã€‚ -n lv_nameï¼šæŒ‡å®šé€»è¾‘å·çš„åç§°ï¼Œæ›¿æ¢lv_nameä¸ºæ‚¨æƒ³è¦ä¸ºé€»è¾‘å·æŒ‡å®šçš„åç§°ã€‚ vg_nameï¼šæŒ‡å®šé€»è¾‘å·æ‰€å±çš„å·ç»„åç§°ã€‚ 1 2 3 pvcreate /dev/sdX vgcreate vg_name /dev/sdX lvcreate -L 5T -n lv_name vg_name å½“å¿«ç…§åˆ›å»ºå®Œæˆï¼ŒåŸå§‹å·ä¸Š æœ‰å†™æ“ä½œæ—¶ï¼Œå¿«ç…§ä¼šè·Ÿè¸ªåŸå§‹å·å—çš„æ”¹å˜ï¼Œå°†è¦æ”¹å˜çš„æ•°æ®åœ¨æ”¹å˜ä¹‹å‰ å¤åˆ¶åˆ°å¿«ç…§é¢„ç•™çš„ç©ºé—´é‡Œï¼Œå› æ­¤è¿™ä¸ªåŸç†çš„å®ç°å«åšå†™æ—¶å¤åˆ¶\nå…ˆå†³æ¡ä»¶å’Œé…ç½® æ‰€æœ‰çš„InnoDBæ–‡ä»¶(InnoDBçš„è¡¨ç©ºé—´æ–‡ä»¶å’ŒInnoDBçš„äº‹åŠ¡æ—¥å¿—)å¿…é¡»æ˜¯åœ¨å•ä¸ªé€»è¾‘å·(åˆ†åŒº); ä½ éœ€è¦ç»å¯¹çš„æ—¶é—´ç‚¹ä¸€è‡´æ€§ï¼ŒLVMä¸èƒ½ä¸ºå¤šäºä¸€ä¸ªå·åšæŸä¸ªæ—¶é—´ç‚¹ä¸€è‡´çš„å¿«ç…§ã€‚(è¿™æ˜¯LVMçš„ä¸€ä¸ªé™åˆ¶ï¼›å…¶ä»–ä¸€äº›ç³»ç»Ÿæ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚) å¿…é¡»åœ¨å·ç»„ä¸­æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´æ¥åˆ›å»ºå¿«ç…§ã€‚éœ€è¦å¤šå°‘å–å†³äºè´Ÿè½½ã€‚å½“é…ç½®ç³»ç»Ÿæ—¶ï¼Œåº”è¯¥ç•™ä¸€äº›æœªåˆ†é…çš„ç©ºé—´ä»¥ä¾¿åé¢åšå¿«ç…§ã€‚ ä¼˜ç¼ºç‚¹: ä¼˜ç‚¹ï¼š\nå‡ ä¹æ˜¯çƒ­å¤‡ (åˆ›å»ºå¿«ç…§å‰æŠŠè¡¨ä¸Šé”ï¼Œåˆ›å»ºå®Œåç«‹å³é‡Šæ”¾) æ”¯æŒæ‰€æœ‰å­˜å‚¨å¼•æ“ å¤‡ä»½é€Ÿåº¦å¿« æ— éœ€ä½¿ç”¨æ˜‚è´µçš„å•†ä¸šè½¯ä»¶(å®ƒæ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«çš„) ç¼ºç‚¹ï¼š\næ— æ³•é¢„è®¡æœåŠ¡åœæ­¢æ—¶é—´ æ•°æ®å¦‚æœåˆ†å¸ƒåœ¨å¤šä¸ªå·ä¸Šæ¯”è¾ƒéº»çƒ¦ (é’ˆå¯¹å­˜å‚¨çº§åˆ«è€Œè¨€) æ­¥éª¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 ## åˆ›å»ºlvmåˆ†åŒº # åˆ›å»ºLVMé€»è¾‘å·ç»„ vgcreate mysql /dev/sdb # åˆ›å»ºLVé€»è¾‘å· lvcreate -n lv_mysql -L 4G mysql # æ ¼å¼åŒ–lvmåˆ†åŒº mkfs.xfs /dev/mysql/lv_mysql ## å°†å½“å‰æ•°æ®è¿ç§»åˆ°é€»è¾‘å·ä¸Š(å› ä¸ºåªæœ‰é€»è¾‘å·ä¸Šçš„æ•°æ®æ‰å¯ä»¥è¿›è¡Œå¿«ç…§) # åœæ­¢æ•°æ®åº“ systemctl stop mysqld # å¤‡ä»½æ‰€æœ‰æ•°æ®æ–‡ä»¶åˆ°æŒ‡å®šçš„ç›®å½•æ–‡ä»¶ä¸‹ cd /var/lib/mysql tar czf /backup/mysql/mysql.tar.gz * # æŒ‚è½½é€»è¾‘å·åˆ°å½“å‰mysqlçš„æ•°æ®ç›®å½•ä¸‹ mount /dev/mysql/lv_mysql /var/lib/mysql # å°†å¤‡ä»½çš„æ•°æ®è§£å‹åˆ°æ•°æ®ç›®å½•ä¸‹ tar xf /backup/mysql/mysql.tar.gz -C /var/lib/mysql # ä¿®æ”¹æƒé™å†é‡æ–°å¯åŠ¨ chown mysql.mysql /var/lib/mysql systemctl start mysqld ## å¿«ç…§å¤‡ä»½æ•°æ®åº“ # ç»™æ•°æ®åº“åŠ è¯»é”,é˜²æ­¢å¿«ç…§æ—¶æ’å…¥æ•°æ® mysql\u0026gt;flush table with read lock; # ç»™mysqlçš„æ•°æ®åº“æ‰€åœ¨çš„é€»è¾‘å·åˆ›å»ºå¿«ç…§ lvcreate -n lv_mysql_s -L 500M -s /dev/mysql/lv_mysql # è§£é” mysql\u0026gt; unlock tables; # å°†é€»è¾‘å·æŒ‚è½½åˆ°ç›®å½•é‡Œ,è¿™é‡Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½• mkdir /mnt/mysql mount -o nouuid /dev/mysql/lv_mysql_s /mnt/mysql/ ## æµ‹è¯•å¿«ç…§å¤‡ä»½,æ­¤å¤„æ˜¯ç›´æ¥åˆ‡æ¢äº†datadirçš„è·¯å¾„,ä¹Ÿå¯ä»¥å°†å¿«ç…§æ•°æ®ä¿å­˜,æ¢å¤æ—¶ç›´æ¥ç”¨å¿«ç…§æ•°æ®æ›¿æ¢åŸè·¯å¾„æ•°æ® # ä¿®æ”¹mysql datadirè·¯å¾„ vim /etc/my.cnf datadir=/mnt/mysql # é‡å¯mysql systemctl restart mysqld ## å…¶ä»–ä¸€äº›æŸ¥çœ‹ä¿¡æ¯çš„å‘½ä»¤ # æŸ¥çœ‹ç£ç›˜åˆ†åŒº lsblk # æŸ¥çœ‹æŒ‚è½½ä¿¡æ¯çš„å‘½ä»¤ df -h # æŸ¥çœ‹é€»è¾‘åˆ†åŒºä¿¡æ¯å‘½ä»¤ lvdisplay æ–¹æ¡ˆäºŒ åŸºäºæ£€æµ‹binlogæ¥è¿›è¡Œæ•°æ®åŒæ­¥: ä»‹ç»: åˆ©ç”¨canalè¿›è¡ŒåŸºäºMySQLæ•°æ®åº“å¢é‡æ—¥å¿—(binlog)è§£æï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…å’Œæ¶ˆè´¹\nåŸç†: 1 2 3 4 canal å·¥ä½œåŸç† 1. canal æ¨¡æ‹Ÿ MySQL slave çš„äº¤äº’åè®®ï¼Œä¼ªè£…è‡ªå·±ä¸º MySQL slave ï¼Œå‘ MySQL master å‘é€dump åè®® 2. MySQL master æ”¶åˆ° dump è¯·æ±‚ï¼Œå¼€å§‹æ¨é€ binary log ç»™ slave (å³ canal ) 3. canal è§£æ binary log å¯¹è±¡(åŸå§‹ä¸º byte æµ) å®˜ç½‘ç¤ºæ„å›¾: ä¼˜ç¼ºç‚¹: 1 2 3 4 5 6 ä¼˜ç‚¹: 1. ç›¸æ¯”äºå¿«ç…§å¤‡ä»½,ä¸éœ€è¦å¯¹æºæ•°æ®åº“é‡å¯æˆ–åŠ é”.å¯ä»¥ç›´æ¥åœ¨ä»£ç å±‚é¢å®ç° 3. ä¸ä¸šåŠ¡å®Œå…¨è§£è€¦,é¢å‘æ•°æ®çš„,æ–¹ä¾¿æ‰©å±•,åç»­å¯ä»¥æ¥å…¥å¤šä¸ªå­˜å‚¨ç›®çš„åœ° 4. å¯ä»¥å¯¹æ•°æ®è¿›è¡Œå¤„ç†,å¯ä»¥åˆ†åˆ«æ ¹æ®DELETE,UPDATE,INSERTåˆ†åˆ«åšä¸åŒçš„æ“ä½œï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®biglogæ—¶é—´æˆ³æ¥æ›´å‡†ç¡®å¤„ç†æ•°æ® ç¼ºç‚¹: 1. éœ€è¦å•ç‹¬ç»´æŠ¤`canalæœåŠ¡`å’Œ`å®¢æˆ·ç«¯`.å­˜åœ¨å¼€å‘ä¸ç»´æŠ¤æˆæœ¬.å¹¶ä¸”è¿˜éœ€è¦å ç”¨æœåŠ¡å™¨IO,å†…å­˜,å¸¦å®½èµ„æº å…³é”®æ­¥éª¤: ç¡®è®¤å·²å¼€å¯mysqlçš„binlog,å¹¶ä¸”é€‰æ‹©ROW(è¡Œ)æ¨¡å¼ show variables like \u0026rsquo;log_bin\u0026rsquo;; å®‰è£…canal(githubç›´æ¥å¯ä»¥ä¸‹è½½),ä¸‹è½½åæ ¹æ®QuickStarté…ç½®å‚æ•°,è¿è¡Œ ç¼–å†™å®¢æˆ·ç«¯ä»£ç (ä¸å±€é™äºjava)\nä¸canalå»ºç«‹é•¿è¿æ¥ å¾ªç¯è·å–æ•°æ®ï¼Œå¦‚æœè·å–åˆ°åˆ™è¿›è¡Œå¤„ç† æ•°æ®å¤„ç†ï¼Œå¯ä»¥æ¥å…¥å¤šä¸ªç›®çš„åœ° ä¸¤ç§æ–¹æ¡ˆé’ˆå¯¹æŠ¥è¡¨ä¸šåŠ¡çš„è§£å†³æ–¹æ¡ˆ lvmå¿«ç…§å¤‡ä»½ å°†å¤‡ä»½åˆ‡æ¢è¿‡ç¨‹ç¼–å†™ä¸ºè„šæœ¬ï¼Œåˆ©ç”¨linuxä¸­cornå®šæ—¶æ‰§è¡Œè„šæœ¬\nç¼ºç‚¹ï¼š\nå› ä¸ºè¦é”è¡¨ç”šè‡³é‡å¯ï¼Œå¯èƒ½ä¼šå½±å“åˆ°ç”Ÿäº§ç¯å¢ƒã€‚ æœ¬èº«å¯¹linuxä¸æ˜¯å¾ˆé€šé€ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€äº›é¢„æœŸä¹‹å¤–çš„é—®é¢˜ã€‚\nbiglogæ£€æµ‹å¢é‡ å½“å¤©ç»“æŸæ•´ç‚¹æ—¶ï¼Œcanalå®¢æˆ·ç«¯æ ¹æ®è¶…è¿‡æ•´ç‚¹åçš„æ•°æ®çš„æ—¶é—´æ¥æ–°å»ºç¬¬äºŒå¤©çš„è¡¨ï¼ŒåŒæ—¶å°†æ—§è¡¨æ•°æ®å¤åˆ¶åˆ°æ–°è¡¨ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ¯æ–°å»ºçš„ä¸€å¼ è¡¨æœ€å¤šåŒ…å«ä¸å¤§äºå½“å¤©çš„æ•°æ®ã€‚\nç¼ºç‚¹ï¼š\nå› ä¸ºè¡¨æ•°æ®æ˜¯ç¿»å€å†é€’å¢çš„ï¼Œæ‰€ä»¥æ•°æ®é‡æ¯”èµ·ä¹‹å‰è¦å¤§å¾ˆå¤š æ–°å»ºè¡¨åå½±å“åˆ°ä¹‹å‰æŠ¥è¡¨ä¸šåŠ¡ï¼Œä¹‹å‰æŠ¥è¡¨ä¹Ÿéœ€è¦åŒæ­¥ä¿®æ”¹ä¸€ä¸‹è¡¨å è¡¥å……ï¼š\nç†æƒ³ä¸Šæ¥è®²,åº”è¯¥æ˜¯ä¸ä¼šå­˜åœ¨ä¸¢å¤±æ¶ˆæ¯,å¹¶ä¸”åœ¨å½“æ—¥ç»“æŸåå‡ ç§’å†…å®Œæˆå½“æ—¥æ•°æ®çš„éš”ç¦»\nå‚è€ƒ:\nhttps://blog.csdn.net/qingsong3333/article/details/77418238 https://help.aliyun.com/document_detail/131141.html https://github.com/alibaba/canal ã€Šé«˜æ€§èƒ½MySQL(ç¬¬3ç‰ˆ)ã€‹\n","date":"2023-06-01T10:53:20Z","image":"https://www.ownit.top/title_pic/20.jpg","permalink":"https://www.ownit.top/p/202306011053/","title":"â€œå®æ—¶æ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„ MySQL æ•°æ®åŒæ­¥æ–¹æ¡ˆâ€œ"},{"content":"åŸç† åœ¨ç°ä»£çš„å®¹å™¨åŒ–ç¯å¢ƒä¸­ï¼ŒèŠ‚ç‚¹èµ„æºçš„ç®¡ç†æ˜¯ä¸€ä¸ªé‡è¦çš„ä»»åŠ¡ã€‚ç‰¹åˆ«æ˜¯å¯¹äºå†…å­˜èµ„æºçš„ç®¡ç†ï¼Œå®ƒç›´æ¥å½±å“ç€å®¹å™¨åº”ç”¨çš„æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚åœ¨ Kubernetes ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è‡ªåŠ¨è°ƒåº¦å’Œæ§åˆ¶çš„æœºåˆ¶æ¥å®ç°å¯¹èŠ‚ç‚¹å†…å­˜çš„æœ‰æ•ˆç®¡ç†ã€‚æœ¬æ–‡å°†ä»‹ç»ä¸€ç§åŸºäº Bash è„šæœ¬çš„èŠ‚ç‚¹å†…å­˜ç®¡ç†æ–¹æ¡ˆï¼Œå¹¶æ¢è®¨å…¶åŸç†ã€ä¼˜åŠ¿ã€ç¼ºç‚¹ä»¥åŠéƒ¨ç½²å’Œåº”ç”¨è¶‹åŠ¿ã€‚\nèƒŒæ™¯ æ³¨æ„åˆ°ä¸€ä¸ªèŠ‚ç‚¹çš„å†…å­˜ä½¿ç”¨ç‡éå¸¸é«˜ï¼Œä¸€äº› Pods åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šæ— æ³•æ­£å¸¸è¿è¡Œå¹¶ä¸æ–­é‡å¯ã€‚ç»è¿‡ä»”ç»†ç ”ç©¶ï¼Œå‘ç°æ˜¯å› ä¸ºè¿™ä¸ªèŠ‚ç‚¹çš„å†…å­˜èµ„æºä¸è¶³ï¼Œå¯¼è‡´ä¸€äº›é«˜å†…å­˜éœ€æ±‚çš„ Pods æ— æ³•æ­£å¸¸è¿è¡Œã€‚æ‚¨å†³å®šå®æ–½ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œä»¥ç¡®ä¿è¿™äº›é«˜å†…å­˜éœ€æ±‚çš„ Pods ä¸ä¼šè¢«è°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œç›´åˆ°æ‚¨èƒ½å¤Ÿé€šè¿‡æ‰©å®¹æˆ–å‡çº§ç¡¬ä»¶ç­‰æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ æ–¹æ¡ˆ ä¸ºäº†å®ç°è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Œæ‚¨å†³å®šä½¿ç”¨ Kubernetes ä¸­çš„æ±¡ç‚¹ï¼ˆTaintï¼‰å’Œå®¹å¿åº¦ï¼ˆTolerationï¼‰æœºåˆ¶ã€‚æ‚¨å°†é¦–å…ˆæ·»åŠ ä¸€ä¸ªæ±¡ç‚¹åˆ°è¿™ä¸ªèŠ‚ç‚¹ï¼Œä»¥æ ‡è¯†å®ƒå½“å‰æ— æ³•å®¹çº³é«˜å†…å­˜éœ€æ±‚çš„ Podsã€‚ç„¶åï¼Œæ‚¨å°†åœ¨è¿™äº› Pods çš„ YAML æ–‡ä»¶ä¸­æ·»åŠ å®¹å¿åº¦å­—æ®µï¼Œä»¥å…è®¸å®ƒä»¬åœ¨å…·æœ‰æ›´å……è¶³å†…å­˜èµ„æºçš„å…¶ä»–èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚æœ€åï¼Œæ‚¨å°†è®¾ç½® SchedulingDisabled æ ‡å¿—ï¼Œä»¥ç¡®ä¿åç»­çš„ Pods ä¸ä¼šè¢«è°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œç›´åˆ°æ‚¨è§£å†³äº†è¯¥èŠ‚ç‚¹çš„å†…å­˜é—®é¢˜ã€‚\nè„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 #!/bin/bash # åŠŸèƒ½ï¼šæ§åˆ¶èŠ‚ç‚¹å†…å­˜ # å¦‚æœèŠ‚ç‚¹å†…å­˜å ç”¨ç‡è¶…è¿‡ 90%ï¼Œåˆ™ç¦æ­¢åœ¨è¯¥èŠ‚ç‚¹ä¸Šè°ƒåº¦ Pod # å¦‚æœèŠ‚ç‚¹å†…å­˜å ç”¨ç‡ä½äºå¹³å‡å€¼ä¸”å¹³å‡å€¼å°äº 90%ï¼Œåˆ™å…è®¸åœ¨è¯¥èŠ‚ç‚¹ä¸Šè°ƒåº¦ Pod # ä½¿ç”¨ kubectl top å‘½ä»¤è·å–èŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡ï¼Œå¹¶å¿½ç•¥æ‰ä¸€äº›ç‰¹å®šçš„èŠ‚ç‚¹ data=$(kubectl top node | grep -v \u0026#34;MEMORY\u0026#34; | grep -v \u0026#34;cn-shenzhen\u0026#34; | sed \u0026#34;s/%//g\u0026#34;) # è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡çš„å¹³å‡å€¼ avg=$(echo \u0026#34;$data\u0026#34; | awk \u0026#39;{ sum += $NF } END { print sum / NR }\u0026#39; | awk -F. \u0026#39;{ print $1 }\u0026#39;) # é€è¡Œè¯»å–æ¯ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼ˆèŠ‚ç‚¹åç§°å’Œå†…å­˜å ç”¨ç‡ï¼‰ echo \u0026#34;$data\u0026#34; | awk \u0026#39;{ print $1, $NF }\u0026#39; | while read line do # è·å–èŠ‚ç‚¹åç§°å’Œå†…å­˜å ç”¨ç‡ n=$(echo $line | awk \u0026#39;{ print $1 }\u0026#39;) m=$(echo $line | awk \u0026#39;{ print $2 }\u0026#39;) # å¦‚æœå†…å­˜å ç”¨ç‡è¶…è¿‡ 90%ï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹æ²¡æœ‰è¢«è®¾ç½®ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ï¼Œåˆ™ç¦æ­¢åœ¨è¯¥èŠ‚ç‚¹ä¸Šè°ƒåº¦ Pod if [ \u0026#34;$m\u0026#34; -ge \u0026#34;90\u0026#34; ];then if kubectl get node | grep $n | grep -q \u0026#34;SchedulingDisabled\u0026#34;;then continue else kubectl cordon $n fi # å¦‚æœå†…å­˜å ç”¨ç‡ä½äºå¹³å‡å€¼ä¸”å¹³å‡å€¼å°äº 90%ï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹å·²è¢«è®¾ç½®ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ï¼Œåˆ™å…è®¸åœ¨è¯¥èŠ‚ç‚¹ä¸Šè°ƒåº¦ Pod elif [ \u0026#34;$m\u0026#34; -lt \u0026#34;$avg\u0026#34; ] \u0026amp;\u0026amp; [ \u0026#34;$avg\u0026#34; -lt \u0026#34;90\u0026#34; ];then if kubectl get node | grep $n | grep -q \u0026#34;SchedulingDisabled\u0026#34;;then kubectl uncordon $n fi fi done å‡çº§ç‰ˆ(åŠ¨æ€) å®ƒå®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š\nä½¿ç”¨ kubectl top å‘½ä»¤è·å–èŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡ï¼Œå¹¶å¿½ç•¥æ‰ç‰¹å®šèŠ‚ç‚¹ï¼ˆä¾‹å¦‚ \u0026ldquo;MEMORY\u0026rdquo; å’Œ \u0026ldquo;cn-shenzhen\u0026rdquo;ï¼‰çš„æ•°æ®ã€‚ è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡çš„å¹³å‡å€¼ã€‚ éå†æ¯ä¸ªèŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡ï¼Œå¹¶æ ¹æ®é˜ˆå€¼åŠ¨æ€è°ƒæ•´èŠ‚ç‚¹çš„è°ƒåº¦çŠ¶æ€ã€‚ å¦‚æœæŸä¸ªèŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡è¶…è¿‡ 90%ï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹æ²¡æœ‰è¢«è®¾ç½®ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ï¼Œåˆ™ç¦æ­¢åœ¨è¯¥èŠ‚ç‚¹ä¸Šè°ƒåº¦ Podï¼ˆä½¿ç”¨ kubectl cordon å‘½ä»¤ï¼‰ã€‚ å¦‚æœæŸä¸ªèŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡ä½äºä¸‹é™é˜ˆå€¼ï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹å·²è¢«è®¾ç½®ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ï¼Œåˆ™å…è®¸åœ¨è¯¥èŠ‚ç‚¹ä¸Šè°ƒåº¦ Podï¼ˆä½¿ç”¨ kubectl uncordon å‘½ä»¤ï¼‰ã€‚ è¿™æ ·ï¼Œè„šæœ¬ä¼šæ ¹æ®èŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡åŠ¨æ€è°ƒæ•´èŠ‚ç‚¹çš„è°ƒåº¦çŠ¶æ€ï¼Œä»¥ç¡®ä¿æ¯å°æœºå™¨èµ„æºä½¿ç”¨ç‡åŸºæœ¬ä¸€æ ·ï¼Œå¹¶åœ¨å†…å­˜å ç”¨ç‡è¾¾åˆ° 90% æ—¶ç¦æ­¢è°ƒåº¦ Podã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 #/********************************************************** # * Author : å—å®«ä¹˜é£ # * Email : 1794748404@qq.com # * Last modified : 2023-07-31 16:21 # * Filename : k8s_auto_mem.sh # * Description : æ ¹æ®èŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡åŠ¨æ€è°ƒæ•´èŠ‚ç‚¹çš„è°ƒåº¦çŠ¶æ€ï¼Œä»¥ç¡®ä¿æ¯å°æœºå™¨èµ„æºä½¿ç”¨ç‡åŸºæœ¬ä¸€æ ·ï¼Œå¹¶åœ¨å†…å­˜å ç”¨ç‡è¾¾åˆ° 90% æ—¶ç¦æ­¢è°ƒåº¦ Podã€‚ # * *******************************************************/ #/bin/bash # æ—¥å¿—å‡½æ•°ï¼Œæ¥æ”¶æ—¶é—´ã€æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—å†…å®¹ä½œä¸ºå‚æ•° log() { local timestamp=$(date +\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) local level=$1 local message=$2 echo \u0026#34;[$timestamp] [$level] $message\u0026#34; } log \u0026#34;info\u0026#34; \u0026#34;å¼€å§‹æ‰§è¡Œè„šæœ¬\u0026#34; # ä½¿ç”¨ kubectl top å‘½ä»¤è·å–èŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡ï¼Œå¹¶å¿½ç•¥æ‰ä¸€äº›ç‰¹å®šçš„èŠ‚ç‚¹ data=$(kubectl top node | grep -v \u0026#34;MEMORY\u0026#34; | grep -v \u0026#34;cn-shenzhen\u0026#34; | sed \u0026#34;s/%//g\u0026#34;) # è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡çš„å¹³å‡å€¼ avg=$(echo \u0026#34;$data\u0026#34; | awk \u0026#39;{ sum += $NF } END { print sum / NR }\u0026#39; | awk -F. \u0026#39;{ print $1 }\u0026#39;) # é€è¡Œè¯»å–æ¯ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼ˆèŠ‚ç‚¹åç§°å’Œå†…å­˜å ç”¨ç‡ï¼‰ echo \u0026#34;$data\u0026#34; | awk \u0026#39;{ print $1, $NF }\u0026#39; | while read line do # è·å–èŠ‚ç‚¹åç§°å’Œå†…å­˜å ç”¨ç‡ n=$(echo $line | awk \u0026#39;{ print $1 }\u0026#39;) m=$(echo $line | awk \u0026#39;{ print $2 }\u0026#39;) # è¾“å‡ºèŠ‚ç‚¹åç§°å’Œå†…å­˜å ç”¨ç‡æ—¥å¿— log \u0026#34;info\u0026#34; \u0026#34;èŠ‚ç‚¹ $n çš„å†…å­˜å ç”¨ç‡ä¸º $m%\u0026#34; # å¦‚æœå†…å­˜å ç”¨ç‡è¶…è¿‡90%ï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹æ²¡æœ‰è¢«è®¾ç½®ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ï¼Œåˆ™ç¦æ­¢åœ¨è¯¥èŠ‚ç‚¹ä¸Šè°ƒåº¦ Pod if [ \u0026#34;$m\u0026#34; -ge 90 ];then if kubectl get node $n | grep -q \u0026#34;SchedulingDisabled\u0026#34;;then log \u0026#34;info\u0026#34; \u0026#34;èŠ‚ç‚¹ $n å†…å­˜å ç”¨ç‡è¶…è¿‡90%ï¼Œå·²ç»ç¦æ­¢è°ƒåº¦ Pod\u0026#34; else log \u0026#34;info\u0026#34; \u0026#34;èŠ‚ç‚¹ $n å†…å­˜å ç”¨ç‡è¶…è¿‡90%ï¼Œç¦æ­¢è°ƒåº¦ Pod\u0026#34; kubectl cordon $n fi else # æ ¹æ®å¹³å‡é˜ˆå€¼åŠ¨æ€è°ƒæ•´é˜ˆå€¼èŒƒå›´ï¼ˆæ¯”å¦‚å°†å¹³å‡é˜ˆå€¼çš„ä¸Šé™å’Œä¸‹é™è®¾ç½®ä¸ºå¹³å‡å€¼çš„ä¸Šä¸‹10%ï¼‰ threshold=$(echo \u0026#34;$avg * 0.1\u0026#34; | bc) upper_threshold=$(printf \u0026#34;%.0f\u0026#34; $(echo \u0026#34;$avg + $threshold\u0026#34; | bc)) lower_threshold=$(printf \u0026#34;%.0f\u0026#34; $(echo \u0026#34;$avg - $threshold\u0026#34; | bc)) # å¦‚æœå†…å­˜å ç”¨ç‡è¶…è¿‡ä¸Šé™é˜ˆå€¼ï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹æ²¡æœ‰è¢«è®¾ç½®ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ï¼Œåˆ™ç¦æ­¢åœ¨è¯¥èŠ‚ç‚¹ä¸Šè°ƒåº¦ Pod if [ \u0026#34;$m\u0026#34; -ge \u0026#34;$upper_threshold\u0026#34; ];then if kubectl get node $n | grep -q \u0026#34;SchedulingDisabled\u0026#34;;then log \u0026#34;info\u0026#34; \u0026#34;èŠ‚ç‚¹ $n å†…å­˜å ç”¨ç‡è¿‡é«˜ï¼Œå·²ç»ç¦æ­¢è°ƒåº¦ Pod\u0026#34; else log \u0026#34;info\u0026#34; \u0026#34;èŠ‚ç‚¹ $n å†…å­˜å ç”¨ç‡è¿‡é«˜ï¼Œç¦æ­¢è°ƒåº¦ Pod\u0026#34; kubectl cordon $n fi # å¦‚æœå†…å­˜å ç”¨ç‡ä½äºä¸‹é™é˜ˆå€¼ï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹å·²è¢«è®¾ç½®ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ï¼Œåˆ™å…è®¸åœ¨è¯¥èŠ‚ç‚¹ä¸Šè°ƒåº¦ Pod elif [ \u0026#34;$m\u0026#34; -lt \u0026#34;$lower_threshold\u0026#34; ];then if kubectl get node $n | grep -q \u0026#34;SchedulingDisabled\u0026#34;;then log \u0026#34;info\u0026#34; \u0026#34;èŠ‚ç‚¹ $n å†…å­˜å ç”¨ç‡è¾ƒä½ï¼Œå…è®¸è°ƒåº¦ Pod\u0026#34; kubectl uncordon $n fi fi fi done log \u0026#34;info\u0026#34; \u0026#34;è„šæœ¬æ‰§è¡Œå®Œæˆ\u0026#34; åŸç† è¯¥è„šæœ¬çš„åŸç†æ˜¯é€šè¿‡è·å–èŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡ï¼Œå¹¶æ ¹æ®é¢„è®¾çš„é˜ˆå€¼è¿›è¡Œåˆ¤æ–­å’Œæ“ä½œã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š\nä½¿ç”¨ kubectl top å‘½ä»¤è·å–èŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡ï¼Œå¹¶å¿½ç•¥æ‰ç‰¹å®šçš„èŠ‚ç‚¹ã€‚ è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡çš„å¹³å‡å€¼ã€‚ é€è¡Œè¯»å–æ¯ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹åç§°å’Œå†…å­˜å ç”¨ç‡ã€‚ å¦‚æœèŠ‚ç‚¹å†…å­˜å ç”¨ç‡è¶…è¿‡è®¾å®šçš„é˜ˆå€¼ï¼ˆä¾‹å¦‚ 90%ï¼‰ï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹æ²¡æœ‰è¢«è®¾ç½®ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ï¼Œåˆ™ç¦æ­¢åœ¨è¯¥èŠ‚ç‚¹ä¸Šè°ƒåº¦ Podã€‚ å¦‚æœèŠ‚ç‚¹å†…å­˜å ç”¨ç‡ä½äºå¹³å‡å€¼ä¸”å¹³å‡å€¼å°äºé˜ˆå€¼ï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹å·²è¢«è®¾ç½®ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ï¼Œåˆ™å…è®¸åœ¨è¯¥èŠ‚ç‚¹ä¸Šè°ƒåº¦ Podã€‚ é€šè¿‡è¿™æ ·çš„åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é›†ç¾¤ä¸­å®ç°å¯¹èŠ‚ç‚¹å†…å­˜çš„åŠ¨æ€ç®¡ç†ï¼Œç¡®ä¿èŠ‚ç‚¹èµ„æºçš„åˆç†åˆ©ç”¨å’Œå®¹å™¨åº”ç”¨çš„ç¨³å®šè¿è¡Œã€‚\nä¼˜åŠ¿ è‡ªåŠ¨åŒ–ç®¡ç†ï¼š è¯¥è„šæœ¬å®ç°äº†è‡ªåŠ¨åŒ–çš„èŠ‚ç‚¹å†…å­˜ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ï¼Œå‡è½»äº†è¿ç»´äººå‘˜çš„è´Ÿæ‹…ã€‚ å®æ—¶ç›‘æµ‹ï¼šé€šè¿‡å®šæœŸæ‰§è¡Œè„šæœ¬ï¼Œå¯ä»¥å®æ—¶ç›‘æµ‹èŠ‚ç‚¹çš„å†…å­˜å ç”¨æƒ…å†µï¼ŒåŠæ—¶åšå‡ºè°ƒæ•´ï¼Œæé«˜äº†å®¹å™¨åº”ç”¨çš„æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚ æ™ºèƒ½å†³ç­–ï¼šæ ¹æ®è®¾å®šçš„é˜ˆå€¼å’Œå¹³å‡å€¼ï¼Œè„šæœ¬èƒ½å¤Ÿæ™ºèƒ½åœ°å†³ç­–æ˜¯å¦ç¦æ­¢æˆ–å…è®¸åœ¨èŠ‚ç‚¹ä¸Šè°ƒåº¦ Podï¼Œç¡®ä¿èµ„æºçš„åˆç†åˆ†é…ã€‚\nç¼ºç‚¹ ä¾èµ–æ€§ï¼š è¯¥è„šæœ¬ä¾èµ–äº Kubernetes å‘½ä»¤è¡Œå·¥å…· kubectl å’Œé›†ç¾¤çš„é…ç½®ï¼Œå› æ­¤éœ€è¦ä¿è¯ç¯å¢ƒçš„æ­£ç¡®é…ç½®å’Œå¯ç”¨æ€§ã€‚ å•ä¸€ç»´åº¦ï¼š è¯¥è„šæœ¬ä»…åŸºäºèŠ‚ç‚¹çš„å†…å­˜å ç”¨ç‡è¿›è¡Œç®¡ç†ï¼Œæ²¡æœ‰è€ƒè™‘å…¶ä»–èµ„æºï¼ˆå¦‚ CPUã€å­˜å‚¨ï¼‰çš„æƒ…å†µï¼Œå› æ­¤åœ¨ç»¼åˆèµ„æºç®¡ç†æ–¹é¢è¿˜æœ‰å¾…å®Œå–„ã€‚\n","date":"2023-05-31T14:13:57Z","image":"https://www.ownit.top/title_pic/17.jpg","permalink":"https://www.ownit.top/p/202305311413/","title":"å½“èŠ‚ç‚¹å†…å­˜ç®¡ç†é‡ä¸Š Kubernetesï¼šè‡ªåŠ¨è°ƒåº¦ä¸æ§åˆ¶"},{"content":"å‰è¨€ åŒæ­¥/å¼‚æ­¥çš„æ¦‚å¿µï¼š\nåŒæ­¥æ˜¯æŒ‡å®Œæˆäº‹åŠ¡çš„é€»è¾‘ï¼Œå…ˆæ‰§è¡Œç¬¬ä¸€ä¸ªäº‹åŠ¡ï¼Œå¦‚æœé˜»å¡äº†ï¼Œä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°è¿™ä¸ªäº‹åŠ¡å®Œæˆï¼Œå†æ‰§è¡Œç¬¬äºŒä¸ªäº‹åŠ¡ï¼Œé¡ºåºæ‰§è¡Œ å¼‚æ­¥æ˜¯å’ŒåŒæ­¥ç›¸å¯¹çš„ï¼Œå¼‚æ­¥æ˜¯æŒ‡åœ¨å¤„ç†è°ƒç”¨è¿™ä¸ªäº‹åŠ¡çš„ä¹‹åï¼Œä¸ä¼šç­‰å¾…è¿™ä¸ªäº‹åŠ¡çš„å¤„ç†ç»“æœï¼Œç›´æ¥å¤„ç†ç¬¬äºŒä¸ªäº‹åŠ¡å»äº†ï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥ã€å›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…å¤„ç†ç»“æœã€‚\nasyncioæ˜¯python3.4ç‰ˆæœ¬å¼•å…¥åˆ°æ ‡å‡†åº“ python3.5åˆåŠ å…¥äº†async/awaitç‰¹æ€§ã€‚\nèƒŒæ™¯ å› ä¸ºä¸šåŠ¡éœ€æ±‚éœ€è¦å†™ä¸€ä¸ªæ¥å£ï¼Œç„¶åè¿”å›æ•°æ®ã€‚ä½†æ˜¯è¿™ä¸ªæ¥å£éœ€è¦æ‰§è¡Œç¨‹åºï¼Œéœ€è¦1åˆ†é’Ÿå·¦å³ã€‚ 1ã€å½“æ¥å£éœ€è¦æ‰§è¡Œé•¿æ—¶é—´çš„ç¨‹åºæ—¶ï¼Œæµè§ˆå™¨å¿…é¡»ç­‰å¾…ç¨‹åºè¿è¡Œç»“æŸå¹¶è¿”å›ç»“æœæ‰èƒ½å“åº”è¯·æ±‚ã€‚ 2ã€å¦‚æœç¨‹åºæ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œæµè§ˆå™¨ä¼šä¸€ç›´ç­‰å¾…ï¼Œè¿™å°†å½±å“ç”¨æˆ·çš„ä½“éªŒï¼Œå› ä¸ºç”¨æˆ·éœ€è¦ç­‰å¾…å¾ˆé•¿æ—¶é—´æ‰èƒ½å¾—åˆ°å“åº”ã€‚ 3ã€æ”¹é€ æˆå¼‚æ­¥æ‰§è¡Œå¯ä»¥é¿å…è¿™ç§æƒ…å†µï¼Œå› ä¸ºå¼‚æ­¥æ‰§è¡Œå¯ä»¥ä½¿å¾—ç¨‹åºä¸éœ€è¦ç­‰å¾…é•¿æ—¶é—´çš„ IO æ“ä½œå®Œæˆï¼Œè€Œæ˜¯è®©ç¨‹åºåœ¨è¿›è¡Œè¿™äº›æ“ä½œæ—¶å¯ä»¥è¿›è¡Œå…¶ä»–çš„è®¡ç®—ä»»åŠ¡ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ•ˆç‡å’Œå“åº”é€Ÿåº¦ï¼Œä»è€Œæé«˜ç”¨æˆ·ä½“éªŒã€‚\nåŸç† å½“æˆ‘ä»¬ä½¿ç”¨ Python è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹æ—¶ï¼Œä½¿ç”¨å¼‚æ­¥è°ƒç”¨å¯ä»¥æé«˜ç¨‹åºçš„æ•ˆç‡ã€‚å¼‚æ­¥è°ƒç”¨æ˜¯æŒ‡ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥åœ¨æŸäº›æ“ä½œç­‰å¾…çš„æ—¶å€™åˆ‡æ¢åˆ°å…¶ä»–ä»»åŠ¡ï¼Œä»è€Œæé«˜ç¨‹åºçš„å¹¶å‘æ€§èƒ½ï¼Œç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡åˆ©ç”¨ I/O ç­‰å¾…æ—¶é—´æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚åœ¨ Python ä¸­ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨ asyncio åº“æ¥å®ç°å¼‚æ­¥è°ƒç”¨ã€‚\nä»‹ç»åœ¨ Python ä¸­ä½¿ç”¨ asyncio å®ç°å¼‚æ­¥è°ƒç”¨çš„ä¸€äº›å¸¸è§æ“ä½œå’ŒæŠ€å·§\n1. ä½¿ç”¨ async/await ä½¿ç”¨ async/await æ˜¯ä½¿ç”¨ asyncio åº“çš„é¦–é€‰æ–¹æ³•ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•å¯ä»¥æŠŠå¼‚æ­¥ä»£ç çœ‹ä½œæ˜¯é¡ºåºæ‰§è¡Œçš„ä»£ç ï¼Œè®©ä»£ç æ›´åŠ æ˜“äºç¼–å†™å’Œé˜…è¯»ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨ async/await è¿›è¡Œå¼‚æ­¥è°ƒç”¨çš„ä¸€ä¸ªç®€å•ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import asyncio async def my_coroutine(): print(\u0026#39;å¼€å§‹æ‰§è¡Œåç¨‹\u0026#39;) await asyncio.sleep(1) print(\u0026#39;åç¨‹æ‰§è¡Œå®Œæ¯•\u0026#39;) async def main(): print(\u0026#39;å¼€å§‹æ‰§è¡Œä¸»ç¨‹åº\u0026#39;) await asyncio.gather( my_coroutine(), my_coroutine(), my_coroutine() ) print(\u0026#39;ä¸»ç¨‹åºæ‰§è¡Œå®Œæ¯•\u0026#39;) asyncio.run(main()) åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª åä¸º my_coroutine çš„åç¨‹ï¼Œå…¶ä¸­ä½¿ç”¨äº† await asyncio.sleep(1) æ¥æ¨¡æ‹Ÿç­‰å¾… 1 ç§’é’Ÿçš„æ“ä½œã€‚åœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ asyncio.gather() å‡½æ•°å¹¶è¡Œæ‰§è¡Œäº† 3 ä¸ª my_coroutine åç¨‹ï¼Œå¹¶ç­‰å¾…å®ƒä»¬å…¨éƒ¨æ‰§è¡Œå®Œåè¾“å‡ºäº†ä¸»ç¨‹åºæ‰§è¡Œå®Œæ¯•çš„æç¤ºã€‚æ³¨æ„ï¼Œåœ¨ Python ä¸­ä½¿ç”¨ asyncio è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹ï¼Œç¨‹åºçš„å…¥å£ç‚¹å¿…é¡»æ˜¯ä¸€ä¸ªåç¨‹ï¼Œè¿™ä¸ªåç¨‹é€šå¸¸è¢«ç§°ä¸ºä¸»ç¨‹åºã€‚\n2. ä½¿ç”¨ asyncio.ensure_future() ç­‰ä»·äº await asyncio.ensure_future() å‡½æ•°å¯ä»¥å°†åç¨‹æˆ–è€…ä¸€ä¸ª Future å¯¹è±¡å°è£…æˆå¦ä¸€ä¸ª Future å¯¹è±¡ï¼Œå¹¶è§¦å‘å…¶æ‰§è¡Œã€‚ç›¸æ¯”äº Awaitable åè®®ï¼ŒFuture æœ‰æ›´å¹¿æ³›çš„ç”¨é€”ï¼ŒFuture å¯ä»¥ç”±æ ‡å‡†åº“ä¸­çš„å…¶ä»–åº“æˆ–è€…ç¬¬ä¸‰æ–¹åº“å¼•å…¥ï¼Œå¯ä»¥åœ¨æœªæ¥çš„æ—¶é—´ç‚¹ä»¥å…¶ä»–æ–¹å¼è¿›è¡Œæ“ä½œã€‚\nä»¥ä¸‹æ˜¯ä½¿ç”¨ asyncio.ensure_future() å‡½æ•°å¹¶å‘æ‰§è¡Œå¤šä¸ªåç¨‹çš„ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 import asyncio async def my_coroutine(i): print(f\u0026#39;åç¨‹ {i} å¼€å§‹æ‰§è¡Œ\u0026#39;) await asyncio.sleep(1) print(f\u0026#39;åç¨‹ {i} æ‰§è¡Œå®Œæ¯•\u0026#39;) async def main(): tasks = [] for i in range(3): task = asyncio.ensure_future(my_coroutine(i)) tasks.append(task) await asyncio.gather(*tasks) print(\u0026#39;ä¸»ç¨‹åºæ‰§è¡Œå®Œæ¯•\u0026#39;) asyncio.run(main()) Â·åŒæ­¥ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 import time def hello(): time.sleep(1) def run(): for i in range(5): hello() print(\u0026#39;Hello World:%s\u0026#39; % time.time()) # ä»»ä½•ä¼Ÿå¤§çš„ä»£ç éƒ½æ˜¯ä»Hello World å¼€å§‹çš„ï¼ if __name__ == \u0026#39;__main__\u0026#39;: run() Â·å¼‚æ­¥ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 import time import asyncio # å®šä¹‰å¼‚æ­¥å‡½æ•° async def hello(): await asyncio.sleep(1) print(\u0026#39;Hello World:%s\u0026#39; % time.time()) if __name__ ==\u0026#39;__main__\u0026#39;: loop = asyncio.get_event_loop() tasks = [hello() for i in range(5)] loop.run_until_complete(asyncio.wait(tasks)) async def ç”¨æ¥å®šä¹‰å¼‚æ­¥å‡½æ•°ï¼Œawait è¡¨ç¤ºå½“å‰åç¨‹ä»»åŠ¡ç­‰å¾…ç¡çœ æ—¶é—´ï¼Œå…è®¸å…¶ä»–ä»»åŠ¡è¿è¡Œã€‚ç„¶åè·å¾—ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œä¸»çº¿ç¨‹è°ƒç”¨asyncio.get_event_loop()æ—¶ä¼šåˆ›å»ºäº‹ä»¶å¾ªç¯ï¼Œä½ éœ€è¦æŠŠå¼‚æ­¥çš„ä»»åŠ¡ä¸¢ç»™è¿™ä¸ªå¾ªç¯çš„run_until_complete()æ–¹æ³•ï¼Œäº‹ä»¶å¾ªç¯ä¼šå®‰æ’ååŒç¨‹åºçš„æ‰§è¡Œã€‚\n3. ä½¿ç”¨ asyncio.Queue asyncio.Queue ç±»æ˜¯ä¸€ä¸ªåŸºäºåç¨‹çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…é˜Ÿåˆ—ï¼Œå®ƒå¯ä»¥è®©ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€šè¿‡å¼‚æ­¥ç¼–ç¨‹æ–¹å¼äº¤æ¢æ•°æ®ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨ asyncio.Queue å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼çš„ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 import asyncio import random async def producer(queue): while True: print(\u0026#39;ç”Ÿäº§è€…æ­£åœ¨ç”Ÿäº§æ•°æ®...\u0026#39;) data = random.randint(1, 100) await queue.put(data) await asyncio.sleep(1) async def consumer(queue): while True: print(\u0026#39;æ¶ˆè´¹è€…æ­£åœ¨ç­‰å¾…æ•°æ®...\u0026#39;) data = await queue.get() print(f\u0026#39;æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ•°æ®: {data}\u0026#39;) async def main(): queue = asyncio.Queue() producer_task = asyncio.ensure_future(producer(queue)) consumer_task = asyncio.ensure_future(consumer(queue)) await asyncio.gather(producer_task, consumer_task) asyncio.run(main()) åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç”Ÿäº§è€…åç¨‹å’Œä¸€ä¸ªæ¶ˆè´¹è€…åç¨‹ï¼Œç”Ÿäº§è€…è´Ÿè´£å¾€é˜Ÿåˆ—ä¸­ç”Ÿäº§æ•°æ®ï¼Œæ¶ˆè´¹è€…åˆ™è´Ÿè´£ä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ•°æ®ã€‚åœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ asyncio.Queue() åˆ›å»ºäº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç„¶åä½¿ç”¨ asyncio.ensure_future() æ¥åˆ›å»ºäº†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€… taskï¼Œæœ€åä½¿ç”¨ asyncio.gather() åŒæ—¶æ‰§è¡Œäº†è¿™ä¸¤ä¸ª taskã€‚\nä½¿ç”¨ asyncio.Queue ä¸ä»…å¯ä»¥å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œè¿˜å¯ä»¥å®ç°å¤šä»»åŠ¡å¹¶å‘å¤„ç†åœºæ™¯ï¼Œä¾‹å¦‚ä½¿ç”¨å¤šä¸ªç”Ÿäº§è€…å¾€é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®ï¼Œä½¿ç”¨å¤šä¸ªæ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­å–æ•°æ®è¿›è¡Œå¤„ç†ç­‰ã€‚\nç»¼ä¸Šæ‰€è¿°ï¼ŒPython ä¸­çš„å¼‚æ­¥è°ƒç”¨æ˜¯é€šè¿‡ asyncio åº“æ¥å®ç°çš„ï¼Œé€šè¿‡ async/await è¯­æ³•æˆ–è€… asyncio.ensure_future() å‡½æ•°å¯ä»¥åˆ›å»ºåç¨‹å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ asyncio.gather() å‡½æ•°å¹¶è¡Œæ‰§è¡Œè¿™äº›åç¨‹ï¼Œä»è€Œå®ç°å¼‚æ­¥è°ƒç”¨çš„ç›®çš„ã€‚æ­¤å¤–ï¼Œasyncio.Queue ç±»å¯ä»¥ç”¨äºå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ç­‰å¤šç§å¼‚æ­¥ç¼–ç¨‹åœºæ™¯ã€‚\nå¼‚æ­¥æ•°æ®è¿”å› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 from flask import Flask, jsonify, request import time import threading app = Flask(__name__) # Dictionary to store task status and results tasks = {} def perform_task(task_id): # Simulating a time-consuming task time.sleep(5) # Update task status and result tasks[task_id][\u0026#39;status\u0026#39;] = \u0026#39;completed\u0026#39; tasks[task_id][\u0026#39;result\u0026#39;] = \u0026#39;Task completed successfully\u0026#39; @app.route(\u0026#39;/task\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) def create_task(): # Generate a unique task ID task_id = str(len(tasks) + 1) # Create a new task with initial status as \u0026#39;processing\u0026#39; tasks[task_id] = {\u0026#39;status\u0026#39;: \u0026#39;processing\u0026#39;, \u0026#39;result\u0026#39;: None} # Start a new thread to perform the task asynchronously thread = threading.Thread(target=perform_task, args=(task_id,)) thread.start() return jsonify({\u0026#39;task_id\u0026#39;: task_id, \u0026#39;status\u0026#39;: \u0026#39;processing\u0026#39;}) @app.route(\u0026#39;/task/\u0026lt;task_id\u0026gt;\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) def get_task_status(task_id): if task_id in tasks: task_status = tasks[task_id][\u0026#39;status\u0026#39;] task_result = tasks[task_id][\u0026#39;result\u0026#39;] if task_status == \u0026#39;completed\u0026#39;: # Task completed, return the result return jsonify({\u0026#39;status\u0026#39;: task_status, \u0026#39;result\u0026#39;: task_result}) else: # Task still processing, return the status return jsonify({\u0026#39;status\u0026#39;: task_status}) else: # Invalid task ID return jsonify({\u0026#39;error\u0026#39;: \u0026#39;Invalid task ID\u0026#39;}), 404 if __name__ == \u0026#39;__main__\u0026#39;: app.run(debug=True) åœ¨è®¿é—®æ¥å£taskæ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªä¿¡æ¯å­˜å…¥åˆ°{}ï¼Œç„¶åå¼‚æ­¥æ‰§è¡Œä»»åŠ¡ã€‚ç½‘é¡µä¼šè‡ªåŠ¨è·³è½¬åˆ°/task/id ç­‰å¾…æ•°æ®è¿”å›ã€‚ å…¶å®ä¹Ÿå¯ä»¥ä½¿ç”¨Flask çš„Celery æ›´åŠ æ–¹ä¾¿ ç®€å•ã€‚\nå‚è€ƒæ–‡æ¡£ï¼š https://juejin.cn/post/6992116138398187533 https://www.cnblogs.com/shenh/p/9090586.html https://www.cnblogs.com/shenh/p/15401891.html\nå®æˆ˜ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 from flask import Flask, jsonify, request, make_response from testrunner import LabourRunner app = Flask(__name__) app.config[\u0026#34;SEND_FILE_MAX_AGE_DEFAULT\u0026#34;] = 300 app.config[\u0026#34;timeout\u0026#34;] = 60 @app.errorhandler(400) def par_err(error): return make_response(jsonify({\u0026#39;code\u0026#39;: \u0026#39;400\u0026#39;, \u0026#39;msg\u0026#39;: \u0026#39;è¯·æ±‚å‚æ•°ä¸åˆæ³•\u0026#39;}), 400) @app.errorhandler(404) def page_not_found(error): return make_response(jsonify({\u0026#39;code\u0026#39;: \u0026#39;404\u0026#39;, \u0026#39;msg\u0026#39;: \u0026#39;è¯·æ±‚å‚æ•°ä¸åˆæ³•\u0026#39;}), 404) @app.route(\u0026#39;/actuator/health\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;HEAD\u0026#39;]) def health(): return jsonify({\u0026#39;online\u0026#39;: True}) @app.route(\u0026#39;/api/autotest\u0026#39;) def autotest(): dir_path = request.args.get(\u0026#39;dir_path\u0026#39;) print(dir_path) # TODO: åœ¨è¿™é‡Œæ·»åŠ å¯¹ path å’Œ file å‚æ•°çš„å¤„ç†é€»è¾‘ # ... if not dir_path: # return make_response(jsonify({\u0026#39;code\u0026#39;: \u0026#39;404\u0026#39;, \u0026#39;msg\u0026#39;: \u0026#39;è¯·æ±‚å‚æ•°ä¸åˆæ³•\u0026#39;}), 404) return \u0026#34;è¯·ä¼ å…¥æ•°æ®\u0026#34; s = LabourRunner() dest_name = s.runner(dir_path) file_url = \u0026#34;https://uat-xxx.xxxx.com/static/\u0026#34; + dest_name result = {\u0026#39;path\u0026#39;: dir_path, \u0026#39;dest_name\u0026#39;: file_url} return result if __name__ == \u0026#34;__main__\u0026#34;: app.run(host=\u0026#34;0.0.0.0\u0026#34;, port=5000, debug=True) å®æˆ˜ä»£ç å¼‚æ­¥ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 import threading import time from flask import Flask, jsonify, request, make_response, url_for, redirect from testrunner import LabourRunner app = Flask(__name__) app.config[\u0026#34;SEND_FILE_MAX_AGE_DEFAULT\u0026#34;] = 300 app.config[\u0026#34;timeout\u0026#34;] = 60 tasks = {} @app.errorhandler(400) def par_err(error): return make_response(jsonify({\u0026#39;code\u0026#39;: \u0026#39;400\u0026#39;, \u0026#39;msg\u0026#39;: \u0026#39;è¯·æ±‚å‚æ•°ä¸åˆæ³•\u0026#39;}), 400) @app.errorhandler(404) def page_not_found(error): return make_response(jsonify({\u0026#39;code\u0026#39;: \u0026#39;404\u0026#39;, \u0026#39;msg\u0026#39;: \u0026#39;è¯·æ±‚å‚æ•°ä¸åˆæ³•\u0026#39;}), 404) @app.route(\u0026#39;/actuator/health\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;HEAD\u0026#39;]) def health(): return jsonify({\u0026#39;online\u0026#39;: True}) def perform_task(task_id, dir_path): # Simulating a time-consuming task s = LabourRunner() dest_name = s.runner(dir_path) file_url = \u0026#34;https://uat-xxxx.xxxx.com/static/\u0026#34; + dest_name # Update task status and result tasks[task_id][\u0026#39;status\u0026#39;] = file_url tasks[task_id][\u0026#39;result\u0026#39;] = dir_path @app.route(\u0026#39;/api/autotest\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) def autotest(): task_id = str(len(tasks) + 1) tasks[task_id] = {\u0026#39;status\u0026#39;: \u0026#39;processing\u0026#39;, \u0026#39;result\u0026#39;: None} dir_path = request.args.get(\u0026#39;dir_path\u0026#39;) # TODO: åœ¨è¿™é‡Œæ·»åŠ å¯¹ path å’Œ file å‚æ•°çš„å¤„ç†é€»è¾‘ # ... if not dir_path: error_msg = {\u0026#39;code\u0026#39;: 400, \u0026#39;msg\u0026#39;: \u0026#39;è¯·æ±‚å‚æ•°ä¸åˆæ³•æˆ–è€…æ–‡ä»¶å¤¹ä¸å­˜åœ¨\u0026#39;} return jsonify(error_msg), 400 # return \u0026#34;è¯·ä¼ å…¥æ•°æ®\u0026#34; thread = threading.Thread(target=perform_task, args=(task_id, dir_path,)) thread.start() return redirect(url_for(\u0026#39;get_task_status\u0026#39;, task_id=task_id)) @app.route(\u0026#39;/api/autotest/\u0026lt;task_id\u0026gt;\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) def get_task_status(task_id): if task_id in tasks: task_status = tasks[task_id][\u0026#39;status\u0026#39;] task_result = tasks[task_id][\u0026#39;result\u0026#39;] if task_status == \u0026#39;completed\u0026#39;: # Task completed, return the result return jsonify({\u0026#39;status\u0026#39;: task_status, \u0026#39;result\u0026#39;: task_result}) else: # Task still processing, return the status return jsonify({\u0026#39;status\u0026#39;: task_status}) else: # Invalid task ID return jsonify({\u0026#39;error\u0026#39;: \u0026#39;Invalid task ID\u0026#39;}), 404 if __name__ == \u0026#34;__main__\u0026#34;: app.run(host=\u0026#34;0.0.0.0\u0026#34;, port=5000, debug=True) ","date":"2023-05-19T15:58:13Z","image":"https://www.ownit.top/title_pic/17.jpg","permalink":"https://www.ownit.top/p/202305191558/","title":"å½“Pythoné‡ä¸Šå¼‚æ­¥ç¼–ç¨‹ï¼šå®ç°é«˜æ•ˆã€å¿«é€Ÿçš„ç¨‹åºè¿è¡Œï¼"},{"content":"é¡¹ç›®èƒŒæ™¯ éšç€é’‰é’‰åº”ç”¨çš„ä¸æ–­æ™®åŠå’Œä¼ä¸šæ•°å­—åŒ–ç¨‹åº¦çš„æé«˜ï¼Œè¶Šæ¥è¶Šå¤šçš„ä¼ä¸šéœ€è¦å¼€å‘é’‰é’‰æ¥å£æ¥å®Œæˆå†…éƒ¨ä¸šåŠ¡æµç¨‹çš„è‡ªåŠ¨åŒ–å’Œä¼˜åŒ–ã€‚è€ŒFlaskæ¡†æ¶ï¼Œåˆ™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„Python webæ¡†æ¶ï¼Œå…·æœ‰å¿«é€Ÿå¼€å‘å’Œçµæ´»æ€§çš„ä¼˜åŠ¿ï¼Œæ˜¯é’‰é’‰æ¥å£å¼€å‘çš„ç†æƒ³é€‰æ‹©ã€‚\nç®€ä»‹ æœ¬åšå®¢å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨Flaskæ¡†æ¶å¼€å‘é’‰é’‰æ¥å£æ¨¡ç‰ˆã€‚é€šè¿‡æœ¬ç¯‡åšå®¢çš„å­¦ä¹ ï¼Œæ‚¨å°†èƒ½å¤Ÿå®ç°ä¼ä¸šè‡ªå®šä¹‰æœºå™¨äººï¼ˆCustom Botï¼‰çš„åŸºæœ¬åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ¥æ”¶å’Œå‘é€æ¶ˆæ¯ï¼Œå›å¤æ¶ˆæ¯æ¨¡ç‰ˆç­‰ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¼šæä¾›å®Œæ•´çš„ä»£ç å’Œç›¸å…³æŠ€æœ¯æ–‡æ¡£ï¼Œæ–¹ä¾¿æ‚¨åœ¨å®é™…å·¥ä½œä¸­å¿«é€Ÿå®ç°è‡ªå·±çš„é’‰é’‰æ¥å£éœ€æ±‚ã€‚\nå¤§è‡´æµç¨‹ ç¯å¢ƒæ­å»ºï¼šå®‰è£…Flaskå’Œé’‰é’‰SDKï¼Œå¹¶è¿›è¡Œé…ç½®ã€‚ æ¥å£å¼€å‘ï¼šç¼–å†™æ¥æ”¶å’Œå¤„ç†é’‰é’‰è¯·æ±‚çš„APIï¼Œå¹¶è¿›è¡Œè·¯ç”±é…ç½®ã€‚ æ¶ˆæ¯å¤„ç†ï¼šè§£æé’‰é’‰è¯·æ±‚çš„æ¶ˆæ¯ä½“ï¼Œè¿›è¡Œè‡ªå®šä¹‰æ¶ˆæ¯çš„æ„å»ºå’Œå‘é€ã€‚ æ¨¡ç‰ˆå›å¤ï¼šä½¿ç”¨Jinja2æ¨¡ç‰ˆå¼•æ“ç”Ÿæˆå›å¤æ¶ˆæ¯ï¼Œå¹¶è¿”å›ç»™é’‰é’‰æœåŠ¡ç«¯ã€‚ è¿è¡Œæµ‹è¯•ï¼šè¿è¡ŒFlaskåº”ç”¨ï¼Œå¹¶ä½¿ç”¨Postmanç­‰å·¥å…·è¿›è¡Œæµ‹è¯•å’Œè°ƒè¯•ã€‚ ä»¥ä¸Šä»…æ˜¯å¤§è‡´æµç¨‹ï¼Œå…·ä½“å®ç°æ­¥éª¤å’ŒæŠ€æœ¯ç»†èŠ‚ä¼šåœ¨åšå®¢ä¸­é€ä¸€è¯¦è§£ã€‚\næ­¥éª¤æµç¨‹ 1ã€é¡¹ç›®ä¾èµ– requirements.txt\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 certifi==2023.5.7 charset-normalizer==3.1.0 click==8.1.3 colorama==0.4.6 DingtalkChatbot==1.5.7 docopt==0.6.2 Flask==2.2.5 idna==3.4 importlib-metadata==6.6.0 itsdangerous==2.1.2 Jinja2==3.1.2 MarkupSafe==2.1.2 pipreqs==0.4.13 requests==2.30.0 typing_extensions==4.5.0 urllib3==1.26.5 Werkzeug==2.2.3 yarg==0.1.9 zipp==3.15.0 2ã€å·¥å…·ç±» utils/send_ding.py\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 # -*- coding: utf-8 -*- # @Time : 2023/5/13 19:16 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : send_ding.py # @Software: PyCharm # -*- coding: utf-8 -*- # @Time : 2023/5/13 13:44 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : send_dingding.py # @Software: PyCharm \u0026#34;\u0026#34;\u0026#34; å‘é€é’‰é’‰çš„apiæ¥å£æ¶ˆæ¯éªŒè¯ \u0026#34;\u0026#34;\u0026#34; # https://oapi.dingtalk.com/robot/send?access_token=xxx # åŠ å¯† xxxx import time import hmac import hashlib import base64 import urllib.parse import requests secret = \u0026#39;xxxx åŠ å¯†ç§˜é’¥\u0026#39; secret_enc = secret.encode(\u0026#39;utf-8\u0026#39;) access_token = \u0026#39;token\u0026#39; def generate_timestamp(): \u0026#34;\u0026#34;\u0026#34;è·å–å½“å‰æ—¶é—´æˆ³\u0026#34;\u0026#34;\u0026#34; return str(round(time.time() * 1000)) def generate_sign(secret_enc, timestamp): \u0026#34;\u0026#34;\u0026#34;ç”Ÿæˆç­¾å\u0026#34;\u0026#34;\u0026#34; string_to_sign = \u0026#39;{}\\n{}\u0026#39;.format(timestamp, secret) string_to_sign_enc = string_to_sign.encode(\u0026#39;utf-8\u0026#39;) hmac_code = hmac.new(secret_enc, string_to_sign_enc, digestmod=hashlib.sha256).digest() sign = urllib.parse.quote_plus(base64.b64encode(hmac_code)) return sign def main(): timestamp = generate_timestamp() sign = generate_sign(secret_enc, timestamp) # æ„é€ è¯·æ±‚ URL url = \u0026#39;https://oapi.dingtalk.com/robot/send?access_token={}\u0026amp;timestamp={}\u0026amp;sign={}\u0026#39;.format(access_token, timestamp, sign) content = \u0026#39;Hello, World!\u0026#39; # æ„é€ è¯·æ±‚ headers å’Œ body headers = {\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;} payload = {\u0026#39;msgtype\u0026#39;: \u0026#39;text\u0026#39;, \u0026#39;text\u0026#39;: {\u0026#39;content\u0026#39;: content}} # å‘é€è¯·æ±‚å¹¶è¿”å›å“åº”ç»“æœ response = requests.post(url, json=payload, headers=headers) print(response.text) if __name__ == \u0026#39;__main__\u0026#39;: main() 3ã€Flaskæ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 # -*- coding: utf-8 -*- # @Time : 2023/5/13 19:15 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : app.py # @Software: PyCharm import datetime import json from time import strftime from utils.send_ding import access_token, generate_timestamp, generate_sign, secret_enc from dingtalkchatbot.chatbot import DingtalkChatbot import datetime from flask import Flask, render_template, request, jsonify app = Flask(__name__) def generate_text_info(url, title, context, author): t = datetime.datetime.now().strftime(\u0026#39;%Y-%m-%d %H:%M:%S\u0026#39;) text = (\u0026#39;\u0026#39;\u0026#39;\u0026lt;font color=\\\u0026#39;#008000\\\u0026#39;\u0026gt;\u0026lt;b\u0026gt;[å·¡æ£€]\u0026lt;/b\u0026gt; \u0026lt;/font\u0026gt;\u0026lt;b\u0026gt;æ¯å¤©å·¡æ£€\u0026lt;/b\u0026gt;\u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\\n\\n --- \\n\\n\u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\u0026lt;font color=\\\u0026#39;#708090\\\u0026#39; size=2\u0026gt;\u0026lt;b\u0026gt;è¯¦æƒ…ï¼š\u0026lt;/b\u0026gt; [ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…](%s)\u0026lt;/font\u0026gt; \\n\\n \u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\u0026lt;font color=\\\u0026#39;#778899\\\u0026#39; size=2\u0026gt;\u0026lt;b\u0026gt;å·¡æ£€æ ‡é¢˜ï¼š\u0026lt;/b\u0026gt; %s\u0026lt;/font\u0026gt; \\n\\n \u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\u0026lt;font color=\\\u0026#39;#708090\\\u0026#39; size=2\u0026gt;\u0026lt;b\u0026gt;å·¡æ£€ç±»å®¹ï¼š\u0026lt;/b\u0026gt; %s\u0026lt;/font\u0026gt; \\n\\n \u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\u0026lt;font color=\\\u0026#39;#708090\\\u0026#39; size=2\u0026gt;\u0026lt;b\u0026gt;ç›¸å…³äººå‘˜ï¼š\u0026lt;/b\u0026gt; %s\u0026lt;/font\u0026gt;\u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\\n\\n --- \\n\\n\u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\u0026lt;b\u0026gt;æ’­æŠ¥æ—¶é—´ï¼š\u0026lt;/b\u0026gt; %s\u0026#39;\u0026#39;\u0026#39;) % (url, title, context, author, t) return text def generate_text_error(url, title, context, author): t = datetime.datetime.now().strftime(\u0026#39;%Y-%m-%d %H:%M:%S\u0026#39;) text = (\u0026#39;\u0026#39;\u0026#39;\u0026lt;font color=\\\u0026#39;#FF0000\\\u0026#39;\u0026gt;\u0026lt;b\u0026gt;[å·¡æ£€]\u0026lt;/b\u0026gt; \u0026lt;/font\u0026gt;\u0026lt;b\u0026gt;æ¯å¤©å·¡æ£€å¼‚å¸¸\u0026lt;/b\u0026gt;\u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\\n\\n --- \\n\\n\u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\u0026lt;font color=\\\u0026#39;#708090\\\u0026#39; size=2\u0026gt;\u0026lt;b\u0026gt;è¯¦æƒ…ï¼š\u0026lt;/b\u0026gt; [ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…](%s)\u0026lt;/font\u0026gt; \\n\\n \u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\u0026lt;font color=\\\u0026#39;#778899\\\u0026#39; size=2\u0026gt;\u0026lt;b\u0026gt;å·¡æ£€æ ‡é¢˜ï¼š\u0026lt;/b\u0026gt; %s\u0026lt;/font\u0026gt; \\n\\n \u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\u0026lt;font color=\\\u0026#39;#708090\\\u0026#39; size=2\u0026gt;\u0026lt;b\u0026gt;å·¡æ£€ç±»å®¹ï¼š\u0026lt;/b\u0026gt; %s\u0026lt;/font\u0026gt; \\n\\n \u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\u0026lt;font color=\\\u0026#39;#708090\\\u0026#39; size=2\u0026gt;\u0026lt;b\u0026gt;ç›¸å…³äººå‘˜ï¼š\u0026lt;/b\u0026gt; %s\u0026lt;/font\u0026gt;\u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\\n\\n --- \\n\\n\u0026#39;\u0026#39;\u0026#39; + \u0026#39;\u0026#39;\u0026#39;\u0026lt;b\u0026gt;æ’­æŠ¥æ—¶é—´ï¼š\u0026lt;/b\u0026gt; %s\u0026#39;\u0026#39;\u0026#39;) % (url, title, context, author, t) return text def send_dingtalk_msg(title, wehook, text): ddrobot = DingtalkChatbot(wehook) ret = ddrobot.send_markdown(title, text=text, is_at_all=False) return ret def dingtalk_robot(url, title, content, author, level): timestamp = generate_timestamp() sign = generate_sign(secret_enc, timestamp) # æ„é€ è¯·æ±‚ URL wehook = \u0026#39;https://oapi.dingtalk.com/robot/send?access_token={}\u0026amp;timestamp={}\u0026amp;sign={}\u0026#39;.format(access_token, timestamp, sign) # wehook = \u0026#39;https://oapi.dingtalk.com/robot/send?access_token=paste_your_token_from_dingtalk\u0026#39; if level == \u0026#34;info\u0026#34;: text = generate_text_info(url, title, content, author) else: text = generate_text_error(url, title, content, author) result = send_dingtalk_msg(title, wehook, text) return result message = { \u0026#39;msg\u0026#39;: \u0026#39;è¯·æŒ‰ç…§ä¸Šé¢æ ¼å¼ post è¯·æ±‚å‚æ•°(sourceï¼ˆè®¤è¯ï¼‰ titleï¼ˆæ ‡é¢˜ï¼‰ contentï¼ˆå†…å®¹ï¼‰ å¿…é€‰å‚æ•°)\u0026#39;, \u0026#39;data\u0026#39;: {\u0026#39;source\u0026#39;: \u0026#39;heian\u0026#39;, \u0026#39;title\u0026#39;: \u0026#39;rdsæ—¥å¿—æ‹‰å»\u0026#39;, \u0026#39;content\u0026#39;: \u0026#39;rdsæ—¥å¿—æ‹‰å»æ­£å¸¸\u0026#39;, \u0026#39;level\u0026#39;: \u0026#39;info|error (é»˜è®¤: info)\u0026#39;, \u0026#39;author\u0026#39;: \u0026#39;å—å®«ä¹˜é£ï¼ˆé»˜è®¤: å·¡æ£€æœºå™¨äººï¼‰\u0026#39;} } @app.route(\u0026#39;/ding/send\u0026#39;, methods=[\u0026#39;POST\u0026#39;, \u0026#34;GET\u0026#34;]) def send(): if request.method == \u0026#39;GET\u0026#39;: return jsonify(message) else: json_data = request.get_json() source = json_data.get(\u0026#39;source\u0026#39;) title = json_data.get(\u0026#39;title\u0026#39;) content = json_data.get(\u0026#39;content\u0026#39;) level = json_data.get(\u0026#39;level\u0026#39;, \u0026#39;info\u0026#39;) author = json_data.get(\u0026#39;author\u0026#39;, \u0026#39;å·¡æ£€æœºå™¨äºº\u0026#39;) if not source or not title or not content: return jsonify(message) if source != \u0026#39;heian\u0026#39;: return \u0026#34;è®¤è¯å¤±è´¥,è¯·è”ç³»è¿ç»´äººå‘˜ï¼\u0026#34; else: # åœ¨è¿™é‡Œå¤„ç†ä¼ å…¥çš„å‚æ•° url = \u0026#39;http://127.0.0.1:5000/\u0026#39; result = dingtalk_robot(url, title, content, author, level) # print(result) if result[\u0026#39;errcode\u0026#39;] == 0: print(\u0026#39;æ¶ˆæ¯å‘é€æˆåŠŸï¼\u0026#39;) return \u0026#34;æ¶ˆæ¯å‘é€æˆåŠŸï¼\u0026#34; else: print(\u0026#39;æ¶ˆæ¯å‘é€å¤±è´¥ï¼š\u0026#39;, result[\u0026#39;errmsg\u0026#39;]) return f\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥, {result[\u0026#39;errmsg\u0026#39;]}\u0026#34; if __name__ == \u0026#39;__main__\u0026#39;: app.run(debug=True) é¡¹ç›®æµ‹è¯• 1ã€å¯åŠ¨Flask 2ã€è®¿é—®æ¥å£ http://127.0.0.1:5000/ding/send\nGETè¯·æ±‚ POSTè¯·æ±‚ å‚æ•°ï¼š\n1 2 3 4 5 6 7 { \u0026#34;author\u0026#34;: \u0026#34;å—å®«ä¹˜é£ï¼ˆé»˜è®¤: å·¡æ£€æœºå™¨äººï¼‰\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;rdsæ—¥å¿—æ‹‰å»æ­£å¸¸\u0026#34;, \u0026#34;level\u0026#34;: \u0026#34;info|error (é»˜è®¤: info)\u0026#34;, \u0026#34;source\u0026#34;: \u0026#34;heian\u0026#34;, \u0026#34;title\u0026#34;: \u0026#34;rdsæ—¥å¿—æ‹‰å»\u0026#34; } ä¼ å…¥JSONæ•°æ®ä¸å¯¹ ","date":"2023-05-13T21:07:25Z","image":"https://www.ownit.top/title_pic/16.jpg","permalink":"https://www.ownit.top/p/202305132107/","title":"Flaskè½»æ¾æ„å»ºé’‰é’‰æ¥å£æ¨¡ç‰ˆï¼Œå®ç°è‡ªåŠ¨åŒ–æµç¨‹ä¼˜åŒ–"},{"content":"1ã€é¡¹ç›®èƒŒæ™¯ éšç€äº‘åŸç”ŸæŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œå®¹å™¨åŒ–åº”ç”¨å·²æˆä¸ºä¼ä¸šæ„å»ºäº‘åŸç”Ÿæ¶æ„çš„é‡è¦æ–¹å¼ã€‚è€Œéšç€é›†ç¾¤è§„æ¨¡ä¸æ–­æ‰©å¤§ï¼Œè·¨ä¸»æœºé€šä¿¡çš„éœ€æ±‚ä¹Ÿè¶Šæ¥è¶Šé‡è¦ã€‚åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼ŒPod æ˜¯æœ€å°çš„è°ƒåº¦å’Œç®¡ç†å•ä½ï¼Œè€Œç½‘ç»œä¹Ÿæ˜¯ Kubernetes ä¸­æœ€é‡è¦çš„ç»„æˆéƒ¨åˆ†ã€‚ä¸ºäº†æ»¡è¶³è·¨ä¸»æœºé€šä¿¡çš„éœ€æ±‚ï¼Œç¤¾åŒºæä¾›äº†å„ç§å„æ ·çš„è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­ Calico æ˜¯ä¸€ç§åˆ©ç”¨ BGP åè®®è§£å†³ Pod ä¸å¤–éƒ¨ç½‘ç»œé€šä¿¡çš„è§£å†³æ–¹æ¡ˆã€‚\n2ã€ç®€ä»‹ Calico æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ BGP åè®®æ¥ç®¡ç†å®¹å™¨ç½‘ç»œã€‚ä¸ä¼ ç»Ÿçš„åŸºäº VXLAN çš„è§£å†³æ–¹æ¡ˆç›¸æ¯”ï¼Œä½¿ç”¨ Calico å¯ä»¥é¿å…ç½‘ç»œæ•°æ®åŒ…çš„å°è£…å’Œè§£å°è¿‡ç¨‹ï¼Œæé«˜äº†ç½‘ç»œä¼ è¾“çš„æ•ˆç‡å’Œååé‡ã€‚åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼ŒCalico å¯ä»¥ç”¨æ¥æ‰“é€š Pod å’Œå±€åŸŸç½‘çš„ç½‘ç»œï¼Œä»è€Œå®ç°è·¨ä¸»æœºé€šä¿¡ã€‚\n3ã€èƒŒæ™¯ ç°çŠ¶ é›†ç¾¤å†…pod\u0026amp;nodeå¯ä»¥é€šè¿‡pod ipç›´æ¥è¿›è¡Œè®¿é—®ï¼Œå®¹å™¨è®¿é—®è™šæ‹Ÿæœºæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯è™šæ‹Ÿæœºä¸èƒ½è®¿é—®å®¹å™¨ï¼Œå°¤å…¶æ˜¯é€šè¿‡consulæ³¨å†Œçš„æœåŠ¡ï¼Œå¿…é¡»æ‰“é€šç½‘ç»œåæ‰å¯ä»¥äº’ç›¸è°ƒç”¨ ç›®æ ‡ æ‰“é€špodå’Œè™šæ‹Ÿæœºçš„ç½‘ç»œï¼Œä½¿è™šæ‹Ÿæœºå¯ä»¥è®¿é—®pod ip å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.projectcalico.org/archive/v3.8/networking/bgp 4ã€ä½¿ç”¨Calicoæ‰“é€šPodç½‘ç»œ 1ã€[Kubernetes MasterèŠ‚ç‚¹]å®‰è£…calicoæ§åˆ¶å‘½ä»¤calicoctl\n1 2 3 curl -O -L https://github.com/projectcalico/calicoctl/releases/download/v3.8.9/calicoctl chmod +x calicoctl mv calicoctl /usr/bin/calicoctl 2ã€ [calicoctlå®‰è£…èŠ‚ç‚¹]æ·»åŠ calicoé…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 mkdir /etc/calico cat \u0026gt; /etc/calico/calicoctl.cfg \u0026lt;\u0026lt;EOF apiVersion: projectcalico.org/v3 kind: CalicoAPIConfig metadata: spec: datastoreType: \u0026#34;kubernetes\u0026#34; kubeconfig: \u0026#34;/root/.kube/config\u0026#34; EOF # æµ‹è¯• calicoctl version Client Version: v3.8.9 Git commit: 0991d2fb Cluster Version: v3.8.9 # å‡ºç°æ­¤è¡Œä»£è¡¨é…ç½®æ­£ç¡® Cluster Type: k8s,bgp,kdd # å‡ºç°æ­¤è¡Œä»£è¡¨é…ç½®æ­£ç¡® 3ã€ [calicoctlå®‰è£…èŠ‚ç‚¹]é…ç½®é›†ç¾¤è·¯ç”±åå°„å™¨ï¼ŒnodeèŠ‚ç‚¹ä¸masterèŠ‚ç‚¹å¯¹ç­‰ã€masterèŠ‚ç‚¹å½¼æ­¤å¯¹ç­‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 # åœ¨æœ¬ç¯å¢ƒä¸‹å°†kubernetes masterèŠ‚ç‚¹ä½œä¸ºåå°„å™¨ä½¿ç”¨ # æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ [root@master1 node]# kubectl get node NAME STATUS ROLES AGE VERSION master Ready control-plane,master 3h19m v1.22.4 node1 Ready \u0026lt;none\u0026gt; 3h16m v1.22.4 node2 Ready \u0026lt;none\u0026gt; 3h15m v1.22.4 # å¯¼å‡ºMasterèŠ‚ç‚¹é…ç½®(å¤šä¸ªå¯¼å‡º) calicoctl get node k8s-test-master-1.fjf --export -o yaml \u0026gt; k8s-test-master-1.yml calicoctl get node k8s-test-master-2.fjf --export -o yaml \u0026gt; k8s-test-master-2.yml calicoctl get node k8s-test-master-3.fjf --export -o yaml \u0026gt; k8s-test-master-3.yml calicoctl get node master --export -o yaml \u0026gt; k8s-test-master-1.yml # åœ¨3ä¸ªMasterèŠ‚ç‚¹é…ç½®ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ç”¨äºæ ‡è¯†è¯¥èŠ‚ç‚¹ä¸ºåå°„å™¨ metadata: ...... labels: ...... i-am-a-route-reflector: true ...... spec: bgp: ...... routeReflectorClusterID: 224.0.0.1 # æ›´æ–°èŠ‚ç‚¹é…ç½® calicoctl apply -f k8s-test-master-1.yml # å…¶ä»–èŠ‚ç‚¹ä¸åå°„å™¨å¯¹ç­‰ calicoctl apply -f - \u0026lt;\u0026lt;EOF kind: BGPPeer apiVersion: projectcalico.org/v3 metadata: name: peer-to-rrs spec: nodeSelector: \u0026#34;!has(i-am-a-route-reflector)\u0026#34; peerSelector: has(i-am-a-route-reflector) EOF # åå°„å™¨å½¼æ­¤å¯¹ç­‰ calicoctl apply -f - \u0026lt;\u0026lt;EOF kind: BGPPeer apiVersion: projectcalico.org/v3 metadata: name: rr-mesh spec: nodeSelector: has(i-am-a-route-reflector) peerSelector: has(i-am-a-route-reflector) EOF 4ã€ [calicoctlå®‰è£…èŠ‚ç‚¹]é…ç½®MasterèŠ‚ç‚¹ä¸æ ¸å¿ƒäº¤æ¢æœºå¯¹ç­‰\n1 2 3 4 5 6 7 8 9 10 11 12 calicoctl apply -f - \u0026lt;\u0026lt;EOF apiVersion: projectcalico.org/v3 kind: BGPPeer metadata: name: rr-border spec: nodeSelector: has(i-am-a-route-reflector) peerIP: 192.168.83.1 asNumber: 64512 EOF # peerIP: æ ¸å¿ƒäº¤æ¢æœºIP # asNumber: ç”¨äºå’Œæ ¸å¿ƒäº¤æ¢æœºå¯¹ç­‰çš„ID 5ã€ [192.168.83.1,è®¾å¤‡å‹å·ï¼šcisco 3650]é…ç½®æ ¸å¿ƒäº¤æ¢ä¸Master(åå°„å™¨)èŠ‚ç‚¹å¯¹ç­‰ï¼Œè¿™ä¸€æ­¥éœ€è¦åœ¨å¯¹ç«¯BGPè®¾å¤‡ä¸Šæ“ä½œï¼Œè¿™é‡Œæ˜¯ç”¨æ ¸å¿ƒäº¤æ¢æœº\n1 2 3 4 5 router bgp 64512 bgp router-id 192.168.83.1 neighbor 192.168.83.36 remote-as 64512 neighbor 192.168.83.49 remote-as 64512 neighbor 192.168.83.54 remote-as 64512 6ã€æŸ¥çœ‹BGP å¯¹ç­‰çŠ¶æ€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 calicoctl node status # INFOå­—æ®µå…¨éƒ¨ä¸ºEstablished å³ä¸ºæ­£å¸¸ Calico process is running. IPv4 BGP status +---------------+---------------+-------+----------+-------------+ | PEER ADDRESS | PEER TYPE | STATE | SINCE | INFO | +---------------+---------------+-------+----------+-------------+ | 192.168.83.1 | node specific | up | 06:38:55 | Established | | 192.168.83.54 | node specific | up | 06:38:55 | Established | | 192.168.83.22 | node specific | up | 06:38:55 | Established | | 192.168.83.37 | node specific | up | 06:38:55 | Established | | 192.168.83.49 | node specific | up | 06:38:55 | Established | | 192.168.83.52 | node specific | up | 06:38:55 | Established | +---------------+---------------+-------+----------+-------------+ IPv6 BGP status No IPv6 peers found. 7ã€æµ‹è¯•ï¼Œä½¿ç”¨å…¶ä»–ç½‘æ®µï¼Œå¦‚192.168.82.0/24çš„è™šæ‹Ÿæœºping æŸä¸€ä¸ªpod ipï¼Œèƒ½æ­£å¸¸é€šä¿¡å³ä»£è¡¨æˆåŠŸ\n1 2 3 4 5 6 7 8 9 10 [dev][root@spring-boot-demo1-192.168.82.85 ~]# ping -c 3 172.15.190.2 PING 172.15.190.2 (172.15.190.2) 56(84) bytes of data. 64 bytes from 172.15.190.2: icmp_seq=1 ttl=62 time=0.677 ms 64 bytes from 172.15.190.2: icmp_seq=2 ttl=62 time=0.543 ms 64 bytes from 172.15.190.2: icmp_seq=3 ttl=62 time=0.549 ms --- 172.15.190.2 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2000ms rtt min/avg/max/mdev = 0.543/0.589/0.677/0.067 ms [dev][root@spring-boot-demo1-192.168.82.85 ~]# 5ã€ä½¿ç”¨Calicoæ‰“é€šSvcç½‘ç»œ ç°çŠ¶ ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒKuberntesé›†ç¾¤æš´éœ²æœåŠ¡çš„æ–¹å¼æœ‰Ingressã€NodePortã€HostNetworkï¼Œè¿™å‡ ç§æ–¹å¼ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå®‰å…¨æ€§å’Œç¨³å®šæ€§æœ‰ä¿éšœã€‚ä½†æ˜¯åœ¨å†…éƒ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨èµ·æ¥å°±æœ‰è¯¸å¤šä¸ä¾¿ï¼Œå¼€å‘å¸Œæœ›å¯ä»¥ç›´æ¥è®¿é—®è‡ªå·±çš„æœåŠ¡ï¼Œä½†æ˜¯Pod IPåˆæ˜¯éšæœºå˜åŒ–çš„ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨SVC IP æˆ–è€…SVC Nameè¿›è¡Œè®¿é—® ç›®æ ‡ æ‰“é€šSVCç½‘ç»œï¼Œä½¿å¼€å‘æœ¬åœ°å¯ä»¥é€šè¿‡SVC IP æˆ– SVC Nameè®¿é—®é›†ç¾¤æœåŠ¡ å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.projectcalico.org/archive/v3.8/networking/service-advertisement æ³¨æ„ï¼šå‰ææ˜¯å·²ç»ç”¨BGPæ‰“é€šäº†Podç½‘ç»œæˆ–å·²ç»å»ºç«‹äº†BGPå¯¹ç­‰æ‰å¯ä»¥ç»§ç»­è¿›è¡Œ 1ã€ [Kubernetes Master]ç¡®å®šSVCç½‘ç»œä¿¡æ¯ 1 2 3 4 [root@master1 node]# kubectl cluster-info dump|grep -i \u0026#34;service-cluster-ip-range\u0026#34; \u0026#34;--service-cluster-ip-range=172.16.0.0/16\u0026#34;, \u0026#34;--service-cluster-ip-range=172.16.0.0/16\u0026#34;, 2ã€ [Kubernetes Master]å¯ç”¨SVCç½‘ç»œå¹¿æ’­\n1 2 [root@master1 ~]# kubectl patch ds -n kube-system calico-node --patch \u0026#39;{\u0026#34;spec\u0026#34;: {\u0026#34;template\u0026#34;: {\u0026#34;spec\u0026#34;: {\u0026#34;containers\u0026#34;: [{\u0026#34;name\u0026#34;: \u0026#34;calico-node\u0026#34;, \u0026#34;env\u0026#34;: [{\u0026#34;name\u0026#34;: \u0026#34;CALICO_ADVERTISE_CLUSTER_IPS\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;172.16.0.0/16\u0026#34;}]}]}}}}\u0026#39; daemonset.apps/calico-node patched 3ã€æµ‹è¯• æ­£å¸¸æƒ…å†µä¸‹å¯ç”¨BGPå¹¿æ’­åï¼Œ3åˆ†é’Ÿå†…æ ¸å¿ƒäº¤æ¢å³å¯æ¥æ”¶åˆ°è·¯ç”±ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # æ‰¾åˆ°é›†ç¾¤DNSæœåŠ¡è¿›è¡Œæµ‹è¯• kubectl get svc kube-dns -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kube-dns ClusterIP 172.16.0.10 \u0026lt;none\u0026gt; 53/UDP,53/TCP,9153/TCP 3d21h # æ‰¾ä¸€ä¸ªPod IPåœ¨é›†ç¾¤å¤–è¿›è¡Œè§£ææµ‹è¯•ï¼Œå¦‚æœå¯ä»¥è§£æåˆ°ç»“æœè¯´æ˜SVCç½‘ç»œå·²ç»æ‰“é€š [dev][root@spring-boot-demo1-192.168.82.85 ~]# dig -x 172.15.190.2 @172.16.0.10 ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.9.4-RedHat-9.9.4-61.el7_5.1 \u0026lt;\u0026lt;\u0026gt;\u0026gt; -x 172.15.190.2 @172.16.0.10 ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 23212 ;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ;; QUESTION SECTION: ;2.190.15.172.in-addr.arpa. IN PTR ;; ANSWER SECTION: 2.190.15.172.in-addr.arpa. 30 IN PTR 172-15-190-2.ingress-nginx.ingress-nginx.svc.k8s-test.fjf. # å¯ä»¥æ­£å¸¸è§£æåˆ°ä¸»æœºè®°å½• ;; Query time: 3 msec ;; SERVER: 172.16.0.10#53(172.16.0.10) ;; WHEN: Fri Jul 09 15:26:55 CST 2021 ;; MSG SIZE rcvd: 150 ","date":"2023-05-11T21:39:12Z","image":"https://www.ownit.top/title_pic/06.jpg","permalink":"https://www.ownit.top/p/202305112139/","title":"Calicoçš„BGPæ‰“é€šKubernetesç½‘ç»œå’Œå±€åŸŸç½‘"},{"content":"èƒŒæ™¯ åœ¨çˆ¬è™«åº”ç”¨å¼€å‘ä¸­ï¼Œå¸¸å¸¸éœ€è¦æ‰¹é‡ä¸‹è½½å›¾ç‰‡ï¼Œå¹¶å¯¹å›¾ç‰‡è¿›è¡Œå»é‡å¤„ç†ã€‚Python æ˜¯ä¸€ç§éå¸¸æµè¡Œçš„ç¼–ç¨‹è¯­è¨€ï¼Œä¹Ÿæ˜¯å¼€å‘çˆ¬è™«åº”ç”¨çš„é¦–é€‰ï¼Œæœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Python ä¸‹è½½å›¾ç‰‡ï¼Œå¹¶å¯¹ä¸‹è½½çš„å›¾ç‰‡è¿›è¡Œå»é‡å¤„ç†ã€‚\nå†…å®¹ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ Python ä¸­çš„ Requests åº“æ¥ä¸‹è½½å›¾ç‰‡ï¼Œå¹¶ä½¿ç”¨ OS åº“æ¥åˆ›å»ºä¿å­˜å›¾ç‰‡çš„æ–‡ä»¶å¤¹ã€‚ä¸‹è½½å›¾ç‰‡åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ hashlib åº“å¯¹å›¾ç‰‡çš„å†…å®¹åšå“ˆå¸Œå¤„ç†ï¼Œå¹¶å°†å¤„ç†åçš„å“ˆå¸Œå€¼ä½œä¸ºå›¾ç‰‡çš„å”¯ä¸€è¯†åˆ«æ ‡å¿—ï¼Œä»¥ä¾¿è¿›è¡Œå»é‡å¤„ç†ã€‚åœ¨å¯¹å›¾ç‰‡è¿›è¡Œå»é‡å¤„ç†æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¸‹è½½çš„å›¾ç‰‡ä¸å·²æœ‰çš„å›¾ç‰‡è¿›è¡Œæ¯”å¯¹ï¼Œå¯ä»¥ä½¿ç”¨å­—å…¸æˆ–é›†åˆç­‰æ•°æ®ç»“æ„æ¥å­˜å‚¨å·²æœ‰å›¾ç‰‡çš„å“ˆå¸Œå€¼ï¼Œä»¥ä¾¿æŸ¥æ‰¾å’Œæ¯”å¯¹ã€‚åœ¨æ‰€æœ‰çš„å›¾ç‰‡ä¸‹è½½å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸‹è½½çš„å›¾ç‰‡çš„æ–‡ä»¶åæˆ–å“ˆå¸Œå€¼ä¿å­˜åˆ°æœ¬åœ°æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œä»¥å¤‡åç»­æŸ¥çœ‹æˆ–å¤„ç†ã€‚ ä¸€äº›å¥½çœ‹çš„åŠ¨æ¼«apiæ¥å£ï¼šhttps://blog.csdn.net/likepoems/article/details/123924270\nhttps://img.r10086.com/\nä»£ç  1ã€çˆ¬å–å›¾ç‰‡ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 # -*- coding: utf-8 -*- # @Time : 2023/3/30 13:56 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : main.py # @Software: PyCharm import os import requests from time import sleep # https://img.r10086.com/ # https://blog.csdn.net/likepoems/article/details/123924270 def download_images(dir_path, file_prefix, num_images): \u0026#34;\u0026#34;\u0026#34; å¾ªç¯è®¿é—®æ¥å£å¹¶ä¿å­˜å›¾ç‰‡åˆ°æŒ‡å®šç›®å½• dir_pathï¼šå›¾ç‰‡ä¿å­˜çš„ç›®å½• file_prefixï¼šä¿å­˜çš„æ–‡ä»¶åå‰ç¼€ num_imagesï¼šéœ€è¦ä¸‹è½½çš„å›¾ç‰‡æ•°é‡ \u0026#34;\u0026#34;\u0026#34; if not os.path.exists(dir_path): os.makedirs(dir_path) # è®¾ç½®è¯·æ±‚å¤´ headers = { \u0026#39;User-Agent\u0026#39;: \u0026#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) \u0026#39; \u0026#39;Chrome/58.0.3029.110 Safari/537.36 \u0026#39; } for i in range(num_images): response = requests.get(\u0026#39;https://api.r10086.com/img-api.php?type=åŸç¥æ¨ªå±ç³»åˆ—1\u0026#39;, headers=headers) if response.status_code == 200: # æ„é€ æ–‡ä»¶å file_name = os.path.join(dir_path, f\u0026#39;{file_prefix}_{i}.jpg\u0026#39;) # ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°æ–‡ä»¶ with open(file_name, \u0026#39;wb\u0026#39;) as f: f.write(response.content) print(file_name + \u0026#34; ä¸‹è½½å®Œæˆ\u0026#34;) else: print(f\u0026#39;è·å–å›¾ç‰‡å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š{response.status_code}\u0026#39;) sleep(1) # ç¤ºä¾‹ if __name__ == \u0026#39;__main__\u0026#39;: dir_path = \u0026#39;dongman\u0026#39; file_prefix = \u0026#39;image\u0026#39; num_images = 1000 download_images(dir_path, file_prefix, num_images) 2ã€å›¾ç‰‡å»é‡ åŸç†ï¼šMD5 æ˜¯ä¸€ç§å¸¸ç”¨çš„å“ˆå¸Œç®—æ³•ï¼Œå®ƒå¯ä»¥å°†ä»»æ„é•¿åº¦çš„è¾“å…¥ï¼ˆæ¯”å¦‚ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…ä¸€ä¸ªæ–‡ä»¶ï¼‰è½¬æ¢æˆä¸€ä¸ª 128 æ¯”ç‰¹é•¿åº¦çš„è¾“å‡ºï¼Œè¾“å‡ºå€¼é€šå¸¸è¡¨ç¤ºä¸ºä¸€ä¸ª 32 ä½çš„åå…­è¿›åˆ¶æ•°å­—ä¸²ã€‚è€Œå¯¹äºä»»æ„è¾“å…¥çš„å˜åŒ–ï¼Œå…¶äº§ç”Ÿçš„è¾“å‡ºä¹Ÿä¼šæœ‰æ‰€ä¸åŒï¼Œå› æ­¤å¯ä»¥å°† MD5 å€¼ä½œä¸ºå”¯ä¸€çš„è¯†åˆ«æ ‡å¿—æ¥å»é‡ã€‚åœ¨ Python ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ hashlib åº“ä¸­çš„ md5 å‡½æ•°æ¥ç”Ÿæˆ MD5 å€¼ã€‚\næµç¨‹ï¼šå…¶å…·ä½“å®ç°æµç¨‹å¦‚ä¸‹ï¼š\nå¯¼å…¥ hashlib åº“ã€‚ å®šä¹‰ä¸å›¾ç‰‡ç›¸å…³çš„ pathã€filename å’Œ filesize ç­‰å˜é‡ï¼Œä½¿ç”¨ os.path åº“ä¸­çš„å‡½æ•°å¤„ç†è·¯å¾„å’Œæ–‡ä»¶åã€‚ å¯¹å›¾ç‰‡çš„äºŒè¿›åˆ¶æ•°æ®ä½¿ç”¨ hashlib.md5() ç”Ÿæˆ MD5 å€¼ã€‚ å°†ç”Ÿæˆçš„ MD5 å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ ¼å¼ï¼Œå»é™¤æ— ç”¨å­—ç¬¦ã€‚ ä½¿ç”¨é›†åˆæˆ–å­—å…¸ç­‰æ•°æ®ç»“æ„å­˜å‚¨å·²æœ‰å›¾ç‰‡çš„ MD5 å€¼ï¼Œåœ¨éå†å¾…ä¸‹è½½çš„å›¾ç‰‡æ—¶ï¼Œåˆ¤æ–­å…¶å¯¹åº”çš„ MD5 å€¼æ˜¯å¦å·²ç»å­˜åœ¨äºé›†åˆæˆ–å­—å…¸ä¸­ï¼Œè‹¥å­˜åœ¨åˆ™è¯´æ˜å›¾ç‰‡å·²ä¸‹è½½è¿‡ï¼Œä¸å†é‡å¤ä¸‹è½½ï¼›å¦åˆ™å¯ä»¥å°†è¯¥å›¾ç‰‡ä¸‹è½½ä¸‹æ¥ï¼Œå¹¶å°†å…¶å¯¹åº”çš„ MD5 å€¼åŠ å…¥åˆ°å·²æœ‰å›¾ç‰‡é›†åˆä¸­ã€‚ ä¸‹è½½å›¾ç‰‡åï¼Œå°†å…¶æ–‡ä»¶åæˆ– MD5 å€¼å­˜å‚¨åˆ°æœ¬åœ°æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œä¾¿äºåç»­æŸ¥çœ‹æˆ–å¤„ç†ã€‚ ä¸Šè¿°æµç¨‹åŸºæœ¬æè¿°äº†ä½¿ç”¨ MD5 å€¼å»é‡çš„å…·ä½“å®ç°è¿‡ç¨‹ï¼Œå…¶ä¸­è¿˜éœ€ç»“åˆå…·ä½“åº”ç”¨åœºæ™¯è¿›è¡Œä¼˜åŒ–å’Œæ”¹è¿›ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 import os import shutil import hashlib def get_md5(file): \u0026#34;\u0026#34;\u0026#34;è®¡ç®—æ–‡ä»¶çš„MD5å€¼\u0026#34;\u0026#34;\u0026#34; if not os.path.isfile(file): return None with open(file, \u0026#39;rb\u0026#39;) as f: md5 = hashlib.md5() md5.update(f.read()) return md5.hexdigest() def find_duplicate_images(dir_path): \u0026#34;\u0026#34;\u0026#34;æŸ¥æ‰¾é‡å¤å›¾ç‰‡\u0026#34;\u0026#34;\u0026#34; all_images = [] md5_list = [] delete_list = [] # éå†æ•´ä¸ªç›®å½•ï¼Œå°†æ‰€æœ‰å›¾ç‰‡çš„è·¯å¾„ä¿å­˜åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­ for root, dirs, files in os.walk(dir_path): for file in files: if file.endswith(\u0026#39;.jpg\u0026#39;) or file.endswith(\u0026#39;.png\u0026#39;): all_images.append(os.path.join(root, file)) # å¯¹äºæ¯ä¸ªå›¾ç‰‡ï¼Œè®¡ç®—å®ƒçš„MD5å€¼ï¼Œå¹¶å°†MD5å€¼å’Œè·¯å¾„ä¿å­˜åˆ°ä¸¤ä¸ªåˆ—è¡¨ä¸­ for image in all_images: md5 = get_md5(image) if md5 is not None: md5_list.append(md5) else: delete_list.append(image) # åˆ¤æ–­MD5å€¼åˆ—è¡¨ä¸­æ˜¯å¦æœ‰é‡å¤çš„å€¼ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è¯´æ˜è¯¥å›¾ç‰‡æ˜¯é‡å¤å›¾ç‰‡ï¼Œå°†å…¶è·¯å¾„ä¿å­˜åˆ°ä¸€ä¸ªåˆ é™¤åˆ—è¡¨ä¸­ for i in range(len(md5_list)): for j in range(i + 1, len(md5_list)): if md5_list[i] == md5_list[j]: delete_list.append(all_images[j]) # éå†åˆ é™¤åˆ—è¡¨ï¼Œå°†å…¶ä¸­çš„å›¾ç‰‡ç§»åŠ¨åˆ°ç›®æ ‡ç›®å½•ä¸­ if not os.path.exists(target_dir): os.makedirs(target_dir) for image in delete_list: try: shutil.move(image, os.path.join(target_dir, os.path.basename(image))) print(\u0026#39;å·²ç§»åŠ¨é‡å¤æ–‡ä»¶ï¼š\u0026#39;, image) except Exception as e: print(\u0026#39;ç§»åŠ¨å¤±è´¥ï¼š%sï¼Œé”™è¯¯ï¼š%s\u0026#39; % (image, str(e))) print(\u0026#39;é‡å¤å›¾ç‰‡æœç´¢å®Œæˆï¼Œå…±æ‰¾åˆ°%dä¸ªé‡å¤æ–‡ä»¶ï¼\u0026#39; % len(delete_list)) # ç¤ºä¾‹ if __name__ == \u0026#39;__main__\u0026#39;: # éœ€è¦ç§»åŠ¨é‡å¤å›¾ç‰‡çš„ç›®æ ‡ç›®å½• # target_dirè®¾ç½®å…¨å±€å˜é‡ global target_dir target_dir = \u0026#39;repeat_image\u0026#39; dir_path = \u0026#39;dongman\u0026#39; find_duplicate_images(dir_path) ","date":"2023-04-13T19:45:42Z","image":"https://www.ownit.top/title_pic/35.jpg","permalink":"https://www.ownit.top/p/202304131945/","title":"Pythonå®ç°æ‰¹é‡å›¾ç‰‡ä¸‹è½½åŠå»é‡å¤„ç†"},{"content":"èƒŒæ™¯ æŸå…¬å¸ä½¿ç”¨é˜¿é‡Œäº‘çš„ ECS å’Œ Redis æœåŠ¡ä½œä¸ºå…¶ä¸šåŠ¡æ”¯æ’‘ï¼Œä¸ºäº†åŠæ—¶äº†è§£æœºå™¨çš„ä½¿ç”¨æƒ…å†µï¼Œé¢†å¯¼è¦æ±‚ä¸šåŠ¡éƒ¨é—¨å¯¹æ‰€æœ‰é˜¿é‡Œäº‘æœºå™¨çš„å¹³å‡èµ„æºä½¿ç”¨ç‡è¿›è¡Œç»Ÿè®¡ï¼Œå¹¶æ±‡æ€»åœ¨ä¸€ä¸ª Excel è¡¨æ ¼ä¸­ï¼Œä»¥ä¾¿é¢†å¯¼æŸ¥çœ‹å’Œåˆ†æã€‚\néœ€æ±‚ ä¸ºäº†æ»¡è¶³é¢†å¯¼çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä»¥ä¸‹åŸºæœ¬éœ€æ±‚ï¼š\nä½¿ç”¨é˜¿é‡Œäº‘ Python SDK è·å–æ‰€æœ‰ ECS å’Œ Redis å®ä¾‹çš„ ID å’Œåç§°ï¼Œä»¥åŠæœºå™¨çš„è§„æ ¼å’Œèµ„æºä½¿ç”¨æƒ…å†µç­‰ä¿¡æ¯ã€‚\nä½¿ç”¨é˜¿é‡Œäº‘ç›‘æ§æœåŠ¡ ECSã€Redis API è·å–å®ä¾‹çš„ç›‘æ§æ•°æ®ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸º Python å­—å…¸ç±»å‹ã€‚\næ ¹æ®ç”¨æˆ·å®šä¹‰çš„æ—¶é—´èŒƒå›´ï¼Œè®¡ç®—æ‰€æœ‰å®ä¾‹çš„å¹³å‡èµ„æºä½¿ç”¨ç‡ï¼Œå¹¶å°†å…¶æ±‡æ€»åˆ°ä¸€ä¸ª Python å­—å…¸ä¸­ã€‚\nä½¿ç”¨ Excel å¤„ç†åº“ï¼ˆä¾‹å¦‚ openpyxlï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Excel æ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ sheetã€‚\nå°†è®¡ç®—å¾—åˆ°çš„æ•°æ®å†™å…¥åˆ° Excel æ–‡ä»¶ä¸­ã€‚åœ¨å†™å…¥æ—¶ï¼Œéœ€è¦æå–å‡ºæ¯ä¸ªå®ä¾‹çš„ IDã€åç§°ã€è§„æ ¼ã€å¹³å‡ CPU ä½¿ç”¨ç‡ã€å¹³å‡å†…å­˜ä½¿ç”¨ç‡å’Œå¹³å‡ç½‘ç»œå¸¦å®½ä½¿ç”¨ç‡ç­‰ä¿¡æ¯ï¼Œå¹¶æŒ‰ç…§ä¸€å®šçš„æ ¼å¼å†™å…¥åˆ° Excel æ–‡ä»¶çš„åˆé€‚ä½ç½®ã€‚\næœ€åï¼Œä¿å­˜ Excel æ–‡ä»¶å¹¶é€€å‡ºç¨‹åºã€‚ç”¨æˆ·åº”å½“èƒ½å¤Ÿæ–¹ä¾¿åœ°æŸ¥çœ‹å’Œä½¿ç”¨å¯¼å‡ºçš„ Excel è¡¨æ ¼ï¼Œå¹¶æ ¹æ®éœ€è¦è¿›è¡Œæ•°æ®åˆ†æå’Œå¤„ç†ã€‚\né€šè¿‡å®ç°ä¸Šè¿°éœ€æ±‚ï¼Œä¸šåŠ¡éƒ¨é—¨å¯ä»¥è¾ƒä¸ºæ–¹ä¾¿å’ŒåŠæ—¶åœ°äº†è§£åˆ°å„ä¸ªæœºå™¨çš„ä½¿ç”¨æƒ…å†µï¼Œå¿«é€Ÿå‘ç°å¹¶è§£å†³èµ„æºä½¿ç”¨è¿‡åº¦æˆ–è€…èµ„æºæµªè´¹çš„é—®é¢˜ï¼Œæé«˜äº‘è®¡ç®—èµ„æºçš„åˆ©ç”¨ç‡å’Œä¼ä¸šè¿è¥æ•ˆç‡ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿå……åˆ†å‘æŒ¥ Python å’Œé˜¿é‡Œäº‘ API çš„å¼ºå¤§èƒ½åŠ›ï¼Œå®ç°ä¸€ä¸ªä¸šåŠ¡éƒ¨é—¨çš„å…¨æ–° Python é¡¹ç›®ï¼Œæå‡è‡ªå·±çš„ç¼–ç¨‹èƒ½åŠ›å’Œé˜¿é‡Œäº‘ API ä½¿ç”¨ç»éªŒã€‚\nç¯å¢ƒ Python 3.8 pip install alibabacloud_cms20190101==2.0.5\npip install alibabacloud_r_kvstore20150101==2.20.7\nè·å–æ‰€æœ‰ECSå’ŒRedis æœºå™¨çš„èµ„æºä½¿ç”¨ç‡\nä½¿ç”¨åˆ°çš„apiæ¥å£\näº§å“æ’åˆ—è¡¨ https://cms.console.aliyun.com/metric-meta/acs_ecs_dashboard/ecs è·å–æ‰€æœ‰æœºå™¨ https://next.api.aliyun.com/api/Cms/2019-01-01/DescribeMonitoringAgentHosts è·å–æ‰€æœ‰redis https://next.api.aliyun.com/api/R-kvstore/2015-01-01/DescribeInstancesOverview\nèµ„æºä½¿ç”¨ç‡è·å– https://next.api.aliyun.com/api/Cms/2019-01-01/DescribeMetricLast å®ä¾‹æ•°æ®è·å–ï¼ˆECSå’ŒRedisï¼‰ å¯ä»¥å‚è€ƒä¸‹æ–¹çš„Apiæ¥å£ï¼Œæˆ‘å·²ç»å°è£…æˆå‡½æ•°\nè·å–æ‰€æœ‰æœºå™¨ https://next.api.aliyun.com/api/Cms/2019-01-01/DescribeMonitoringAgentHosts è·å–æ‰€æœ‰redsi https://next.api.aliyun.com/api/R-kvstore/2015-01-01/DescribeInstancesOverview\nå¦‚æœè¦ä½¿ç”¨ä¸‹æ–¹å‡½æ•°ï¼Œè¯·æ·»åŠ è‡ªå·±çš„å¯†é’¥å¯¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 # -*- coding: utf-8 -*- # @Time : 2023/4/12 9:55 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : ecs_all.py # @Software: PyCharm import json from typing import List from alibabacloud_cms20190101.client import Client as Cms20190101Client from alibabacloud_cms20190101 import models as cms_20190101_models from alibabacloud_r_kvstore20150101.client import Client as R_kvstore20150101Client from alibabacloud_tea_openapi import models as open_api_models from alibabacloud_r_kvstore20150101 import models as r_kvstore_20150101_models from alibabacloud_tea_util import models as util_models from alibabacloud_tea_util.client import Client as UtilClient def create_client_redis( access_key_id: str, access_key_secret: str, ) -\u0026gt; R_kvstore20150101Client: \u0026#34;\u0026#34;\u0026#34; ä½¿ç”¨AK\u0026amp;SKåˆå§‹åŒ–è´¦å·Client @param access_key_id: @param access_key_secret: @return: Client @throws Exception \u0026#34;\u0026#34;\u0026#34; config = open_api_models.Config( # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey ID, access_key_id=access_key_id, # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey Secret, access_key_secret=access_key_secret ) # è®¿é—®çš„åŸŸå config.endpoint = f\u0026#39;r-kvstore.aliyuncs.com\u0026#39; return R_kvstore20150101Client(config) def create_client_ecs( access_key_id: str, access_key_secret: str, ) -\u0026gt; Cms20190101Client: \u0026#34;\u0026#34;\u0026#34; ä½¿ç”¨AK\u0026amp;SKåˆå§‹åŒ–è´¦å·Client @param access_key_id: @param access_key_secret: @return: Client @throws Exception \u0026#34;\u0026#34;\u0026#34; config = open_api_models.Config( # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey ID, access_key_id=access_key_id, # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey Secret, access_key_secret=access_key_secret ) # è®¿é—®çš„åŸŸå config.endpoint = f\u0026#39;metrics.ap-southeast-1.aliyuncs.com\u0026#39; return Cms20190101Client(config) def get_ecs_instances(): \u0026#34;\u0026#34;\u0026#34; è·å–é˜¿é‡Œäº‘ ECS å®ä¾‹åˆ—è¡¨ \u0026#34;\u0026#34;\u0026#34; client = create_client_ecs(\u0026#39;xxxx\u0026#39;, \u0026#39;xxxx\u0026#39;) describe_monitoring_agent_hosts_request = cms_20190101_models.DescribeMonitoringAgentHostsRequest() runtime = util_models.RuntimeOptions() try: # å¤åˆ¶ä»£ç è¿è¡Œè¯·è‡ªè¡Œæ‰“å° API çš„è¿”å›å€¼ data = client.describe_monitoring_agent_hosts_with_options(describe_monitoring_agent_hosts_request, runtime) return data except Exception as error: # å¦‚æœ‰éœ€è¦ï¼Œè¯·æ‰“å° error UtilClient.assert_as_string(error.message) def get_redis_instances(): # å·¥ç¨‹ä»£ç æ³„éœ²å¯èƒ½ä¼šå¯¼è‡´AccessKeyæ³„éœ²ï¼Œå¹¶å¨èƒè´¦å·ä¸‹æ‰€æœ‰èµ„æºçš„å®‰å…¨æ€§ã€‚ä»¥ä¸‹ä»£ç ç¤ºä¾‹ä»…ä¾›å‚è€ƒï¼Œå»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„ STS æ–¹å¼ï¼Œæ›´å¤šé‰´æƒè®¿é—®æ–¹å¼è¯·å‚è§ï¼šhttps://help.aliyun.com/document_detail/378659.html client = create_client_redis(\u0026#39;xxxx\u0026#39;, \u0026#39;xxxx\u0026#39;) describe_instances_overview_request = r_kvstore_20150101_models.DescribeInstancesOverviewRequest( region_id=\u0026#39;cn-shenzhen\u0026#39; ) runtime = util_models.RuntimeOptions() try: # å¤åˆ¶ä»£ç è¿è¡Œè¯·è‡ªè¡Œæ‰“å° API çš„è¿”å›å€¼ data = client.describe_instances_overview_with_options(describe_instances_overview_request, runtime) return data except Exception as error: # å¦‚æœ‰éœ€è¦ï¼Œè¯·æ‰“å° error UtilClient.assert_as_string(error.message) if __name__ == \u0026#39;__main__\u0026#39;: ecs_data = get_ecs_instances().to_map() redis_data = get_redis_instances().to_map() # å°† ECS æ•°æ®å†™å…¥ JSON æ–‡ä»¶ä¸­ with open(\u0026#39;ecs.json\u0026#39;, \u0026#39;w\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: f.write(json.dumps(ecs_data, indent=4,ensure_ascii=False)) # å°† Redis æ•°æ®å†™å…¥ JSON æ–‡ä»¶ä¸­ with open(\u0026#39;redis.json\u0026#39;, \u0026#39;w\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: f.write(json.dumps(redis_data, indent=4,ensure_ascii=False)) print(\u0026#34;æ•°æ®å·²ç»å†™å…¥æœ¬åœ°æ–‡ä»¶\u0026#34;) ECSå®ä¾‹èµ„æº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 # -*- coding: utf-8 -*- # @Time : 2023/4/11 17:17 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : ecs_monitor.py # @Software: PyCharm import json import sys from typing import List from alibabacloud_cms20190101.client import Client as Cms20190101Client from alibabacloud_tea_openapi import models as open_api_models from alibabacloud_cms20190101 import models as cms_20190101_models from alibabacloud_tea_util import models as util_models from alibabacloud_tea_util.client import Client as UtilClient from openpyxl import Workbook from openpyxl.utils import get_column_letter class Sample: def __init__(self): pass @staticmethod def create_client( access_key_id: str, access_key_secret: str, ) -\u0026gt; Cms20190101Client: \u0026#34;\u0026#34;\u0026#34; ä½¿ç”¨AK\u0026amp;SKåˆå§‹åŒ–è´¦å·Client @param access_key_id: @param access_key_secret: @return: Client @throws Exception \u0026#34;\u0026#34;\u0026#34; config = open_api_models.Config( # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey ID, access_key_id=access_key_id, # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey Secret, access_key_secret=access_key_secret ) # è®¿é—®çš„åŸŸå config.endpoint = f\u0026#39;metrics.ap-southeast-1.aliyuncs.com\u0026#39; return Cms20190101Client(config) @staticmethod def main(parameter): # å·¥ç¨‹ä»£ç æ³„éœ²å¯èƒ½ä¼šå¯¼è‡´AccessKeyæ³„éœ²ï¼Œå¹¶å¨èƒè´¦å·ä¸‹æ‰€æœ‰èµ„æºçš„å®‰å…¨æ€§ã€‚ä»¥ä¸‹ä»£ç ç¤ºä¾‹ä»…ä¾›å‚è€ƒï¼Œå»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„ STS æ–¹å¼ï¼Œæ›´å¤šé‰´æƒè®¿é—®æ–¹å¼è¯·å‚è§ï¼šhttps://help.aliyun.com/document_detail/378659.html client = Sample.create_client(\u0026#39;xxxx\u0026#39;, \u0026#39;xxxx\u0026#39;) describe_metric_top_request = cms_20190101_models.DescribeMetricTopRequest( period=\u0026#39;2592000\u0026#39;, namespace=\u0026#39;acs_ecs_dashboard\u0026#39;, metric_name=parameter, orderby=\u0026#39;Average\u0026#39;, start_time=\u0026#39;2023-03-12 00:00:00\u0026#39;, end_time=\u0026#39;2023-04-11 00:00:00\u0026#39;, length=\u0026#39;100\u0026#39;, ) runtime = util_models.RuntimeOptions() try: # å¤åˆ¶ä»£ç è¿è¡Œè¯·è‡ªè¡Œæ‰“å° API çš„è¿”å›å€¼ data = client.describe_metric_top_with_options(describe_metric_top_request, runtime) return data except Exception as error: # å¦‚æœ‰éœ€è¦ï¼Œè¯·æ‰“å° error UtilClient.assert_as_string(error.message) def get_host(): global host_list # æ‰“å¼€ host.json æ–‡ä»¶ with open(\u0026#39;ecs.json\u0026#39;, \u0026#39;r\u0026#39;) as f: # è¯»å–æ–‡ä»¶ä¸­çš„ JSON æ•°æ® data = json.load(f) # è¾“å‡ºè¯»å–åˆ°çš„æ•°æ® host_list = data[\u0026#39;body\u0026#39;][\u0026#34;Hosts\u0026#34;][\u0026#34;Host\u0026#34;] host_list = [{k: v for k, v in d.items() if k not in ( \u0026#39;isAliyunHost\u0026#39;, \u0026#39;NetworkType\u0026#39;, \u0026#39;InstanceTypeFamily\u0026#39;, \u0026#39;Region\u0026#39;, \u0026#39;AliUid\u0026#39;, \u0026#39;SerialNumber\u0026#39;, \u0026#39;EipId\u0026#39;,\u0026#39;EipAddress\u0026#39;)} for d in host_list] print(host_list) return host_list def ecs_dashboard(parameter): data_ecs = Sample.main(parameter) response_dict = data_ecs.body.to_map() data_Datapoints = json.loads(response_dict[\u0026#34;Datapoints\u0026#34;]) # for data in data_Datapoints: # print(data) # print(type(data_Datapoints), data_Datapoints) return data_Datapoints def set_workbook(ece_data_list): data = { \u0026#39;AgentVersion\u0026#39;: \u0026#39;2.1.56\u0026#39;, \u0026#39;HostName\u0026#39;: \u0026#39;xxx\u0026#39;, \u0026#39;InstanceId\u0026#39;: \u0026#39;i-xxxxxxx\u0026#39;, \u0026#39;IpGroup\u0026#39;: \u0026#39;xxxxxxxxxx\u0026#39;, \u0026#39;OperatingSystem\u0026#39;: \u0026#39;Linux\u0026#39;, \u0026#39;CPU_Average\u0026#39;: 4.475, \u0026#39;Memory_Average\u0026#39;: 20.499 } # æ–°å»ºä¸€ä¸ª Workbook å¯¹è±¡ wb = Workbook() # è·å–ç¬¬ä¸€ä¸ª sheet ws = wb.active # è·å–æœ€å¤§è¡Œæ•° max_row = ws.max_row # è®¾ç½®è¡¨å¤´ headers = list(data.keys()) for i, header in enumerate(headers, start=1): ws.cell(row=1, column=i).value = header # å†™å…¥æ•°æ® for row_data in ece_data_list: # å†™å…¥æ•°æ® max_row += 1 for i, header in enumerate(row_data.keys(), start=1): column_letter = get_column_letter(i) cell_address = \u0026#39;{}{}\u0026#39;.format(column_letter, max_row) ws[cell_address] = row_data[header] # ä¿å­˜æ–‡ä»¶ wb.save(\u0026#39;ECS_æœåŠ¡å™¨èµ„æº.xlsx\u0026#39;) if __name__ == \u0026#39;__main__\u0026#39;: host_list_data = get_host() es_monitor_list_cpu = ecs_dashboard(\u0026#34;CPUUtilization\u0026#34;) es_monitor_list_memory = ecs_dashboard(\u0026#34;memory_usedutilization\u0026#34;) # åŒ¹é…CPU # éå† list2ï¼ŒåŒ¹é… instanceId å¹¶æ·»åŠ  Average å€¼åˆ° list1 çš„å¯¹åº”å­—å…¸ä¸­ for d2 in es_monitor_list_cpu: for d1 in host_list_data: if d1[\u0026#39;InstanceId\u0026#39;] == d2[\u0026#39;instanceId\u0026#39;]: d1[\u0026#39;CPU_Average\u0026#39;] = d2[\u0026#39;Average\u0026#39;] # åŒ¹é…å†…å­˜ for d3 in es_monitor_list_memory: for d1 in host_list_data: if d1[\u0026#39;InstanceId\u0026#39;] == d3[\u0026#39;instanceId\u0026#39;]: d1[\u0026#39;Memory_Average\u0026#39;] = d3[\u0026#39;Average\u0026#39;] # è¾“å‡ºæ›´æ–°åçš„ list1 # lst_sorted = sorted(host_list_data, key=lambda x: x[\u0026#39;Memory_Average\u0026#39;], reverse=True) print(host_list_data) set_workbook(host_list_data) Rediså®ä¾‹èµ„æº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 # -*- coding: utf-8 -*- # @Time : 2023/4/11 17:17 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : ecs_monitor.py # @Software: PyCharm # äº§å“æ’åˆ—è¡¨ https://cms.console.aliyun.com/metric-meta/acs_ecs_dashboard/ecs?spm=a2c4g.163515.0.0.27c776abvQGocz # è·å–æ‰€æœ‰æœºå™¨ https://next.api.aliyun.com/api/Cms/2019-01-01/DescribeMonitoringAgentHosts?params={}\u0026amp;tab=DEBUG # è·å–æ‰€æœ‰redsi https://next.api.aliyun.com/api/R-kvstore/2015-01-01/DescribeInstancesOverview?spm=a2c4g.473769.0.i0\u0026amp;lang=PYTHON\u0026amp;params={%22RegionId%22:%22cn-shenzhen%22}\u0026amp;tab=DEBUG import json import sys from typing import List from alibabacloud_cms20190101.client import Client as Cms20190101Client from alibabacloud_tea_openapi import models as open_api_models from alibabacloud_cms20190101 import models as cms_20190101_models from alibabacloud_tea_util import models as util_models from alibabacloud_tea_util.client import Client as UtilClient from openpyxl import Workbook from openpyxl.utils import get_column_letter class Sample: def __init__(self): pass @staticmethod def create_client( access_key_id: str, access_key_secret: str, ) -\u0026gt; Cms20190101Client: \u0026#34;\u0026#34;\u0026#34; ä½¿ç”¨AK\u0026amp;SKåˆå§‹åŒ–è´¦å·Client @param access_key_id: @param access_key_secret: @return: Client @throws Exception \u0026#34;\u0026#34;\u0026#34; config = open_api_models.Config( # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey ID, access_key_id=access_key_id, # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey Secret, access_key_secret=access_key_secret ) # è®¿é—®çš„åŸŸå config.endpoint = f\u0026#39;metrics.ap-southeast-1.aliyuncs.com\u0026#39; return Cms20190101Client(config) @staticmethod def main(parameter): # å·¥ç¨‹ä»£ç æ³„éœ²å¯èƒ½ä¼šå¯¼è‡´AccessKeyæ³„éœ²ï¼Œå¹¶å¨èƒè´¦å·ä¸‹æ‰€æœ‰èµ„æºçš„å®‰å…¨æ€§ã€‚ä»¥ä¸‹ä»£ç ç¤ºä¾‹ä»…ä¾›å‚è€ƒï¼Œå»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„ STS æ–¹å¼ï¼Œæ›´å¤šé‰´æƒè®¿é—®æ–¹å¼è¯·å‚è§ï¼šhttps://help.aliyun.com/document_detail/378659.html client = Sample.create_client(\u0026#39;xxxx\u0026#39;, \u0026#39;xxx\u0026#39;) describe_metric_top_request = cms_20190101_models.DescribeMetricTopRequest( period=\u0026#39;2592000\u0026#39;, namespace=\u0026#39;acs_kvstore\u0026#39;, metric_name=parameter, orderby=\u0026#39;Average\u0026#39;, start_time=\u0026#39;2023-03-12 00:00:00\u0026#39;, end_time=\u0026#39;2023-04-11 00:00:00\u0026#39;, length=\u0026#39;100\u0026#39;, ) runtime = util_models.RuntimeOptions() try: # å¤åˆ¶ä»£ç è¿è¡Œè¯·è‡ªè¡Œæ‰“å° API çš„è¿”å›å€¼ data = client.describe_metric_top_with_options(describe_metric_top_request, runtime) return data except Exception as error: # å¦‚æœ‰éœ€è¦ï¼Œè¯·æ‰“å° error UtilClient.assert_as_string(error.message) def get_host(): global host_list # æ‰“å¼€ host.json æ–‡ä»¶ with open(\u0026#39;redis.json\u0026#39;, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: # è¯»å–æ–‡ä»¶ä¸­çš„ JSON æ•°æ® data = json.load(f) # è¾“å‡ºè¯»å–åˆ°çš„æ•°æ® print(data) host_list = data[\u0026#39;body\u0026#39;][\u0026#34;Instances\u0026#34;] host_list = [{k: v for k, v in d.items() if k not in (\u0026#39;ArchitectureType\u0026#39;, \u0026#39;EngineVersion\u0026#39;, \u0026#39;EndTime\u0026#39;, \u0026#39;ResourceGroupId\u0026#39;, \u0026#39;ZoneId\u0026#39;, \u0026#39;CreateTime\u0026#39;, \u0026#39;VSwitchId\u0026#39;, \u0026#39;InstanceClass\u0026#39;, \u0026#39;ConnectionDomain\u0026#39;, \u0026#39;VpcId\u0026#39;, \u0026#39;ChargeType\u0026#39;, \u0026#39;NetworkType\u0026#39;, \u0026#39;InstanceStatus\u0026#39;, \u0026#39;RegionId\u0026#39;, \u0026#39;InstanceType\u0026#39;, \u0026#39;SecondaryZoneId\u0026#39;)} for d in host_list] return host_list def ecs_dashboard(parameter): data_ecs = Sample.main(parameter) response_dict = data_ecs.body.to_map() data_Datapoints = json.loads(response_dict[\u0026#34;Datapoints\u0026#34;]) return data_Datapoints def set_workbook(host_list_data): data = { \u0026#39;Capacity\u0026#39;: 256, \u0026#39;InstanceId\u0026#39;: \u0026#39;r-xxxxx\u0026#39;, \u0026#39;InstanceName\u0026#39;: \u0026#39;å¤§æ•°æ®\u0026#39;, \u0026#39;PrivateIp\u0026#39;: \u0026#39;xxxxxxxx\u0026#39;, \u0026#39;Memory_Average\u0026#39;: 15.719 } # æ–°å»ºä¸€ä¸ª Workbook å¯¹è±¡ wb = Workbook() # è·å–ç¬¬ä¸€ä¸ª sheet ws = wb.active # è·å–æœ€å¤§è¡Œæ•° max_row = ws.max_row # è®¾ç½®è¡¨å¤´ headers = list(data.keys()) for i, header in enumerate(headers, start=1): ws.cell(row=1, column=i).value = header # å†™å…¥æ•°æ® for row_data in host_list_data: # å†™å…¥æ•°æ® max_row += 1 for i, header in enumerate(row_data.keys(), start=1): column_letter = get_column_letter(i) cell_address = \u0026#39;{}{}\u0026#39;.format(column_letter, max_row) ws[cell_address] = row_data[header] # ä¿å­˜æ–‡ä»¶ wb.save(\u0026#39;Redis_æœåŠ¡å™¨èµ„æº.xlsx\u0026#39;) if __name__ == \u0026#39;__main__\u0026#39;: host_list_data = get_host() redis_monitor_list_Memory = ecs_dashboard(\u0026#34;StandardMemoryUsage\u0026#34;) # åŒ¹é…CPU # éå† list2ï¼ŒåŒ¹é… instanceId å¹¶æ·»åŠ  Average å€¼åˆ° list1 çš„å¯¹åº”å­—å…¸ä¸­ for d2 in redis_monitor_list_Memory: for d1 in host_list_data: if d1[\u0026#39;InstanceId\u0026#39;] == d2[\u0026#39;instanceId\u0026#39;]: d1[\u0026#39;Memory_Average\u0026#39;] = d2[\u0026#39;Average\u0026#39;] # # è¾“å‡ºæ›´æ–°åçš„ list1 lst_sorted = sorted(host_list_data, key=lambda x: x[\u0026#39;Memory_Average\u0026#39;], reverse=True) print(host_list_data) set_workbook(lst_sorted) ","date":"2023-04-12T10:53:54Z","image":"https://www.ownit.top/title_pic/74.jpg","permalink":"https://www.ownit.top/p/202304121053/","title":"Pythonæ‰¹é‡å¯¼å‡ºé˜¿é‡Œäº‘ECSå’ŒRediså®ä¾‹çš„ç›‘æ§æ•°æ®åˆ°Excel"},{"content":"èƒŒæ™¯ åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åˆ›å»ºNginxé…ç½®æ–‡ä»¶çš„æ¨¡æ¿ï¼Œä»¥ä¾¿åœ¨ä¸åŒçš„ç¯å¢ƒä¸­å¿«é€Ÿéƒ¨ç½²å’Œé…ç½®NginxæœåŠ¡å™¨ã€‚ç„¶è€Œï¼Œè¿™æ ·çš„ä»»åŠ¡é€šå¸¸éœ€è¦é‡å¤æ€§é«˜ã€è€—æ—¶é•¿ï¼Œä¸”å®¹æ˜“å‡ºé”™ã€‚ä¸ºäº†åŠ å¿«è¿™äº›ä»»åŠ¡çš„å®Œæˆï¼Œå¹¶æé«˜å·¥ä½œæ•ˆç‡ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›è‡ªåŠ¨åŒ–å·¥å…·æ¥ç®€åŒ–Nginxé…ç½®æ–‡ä»¶çš„ç”Ÿæˆå’Œç®¡ç†ã€‚\nå…¶ä¸­ï¼Œä¸€ç§å¸¸è§çš„æ–¹æ³•æ˜¯ä½¿ç”¨åŸºäºæ–‡æœ¬æ›¿æ¢çš„æ¨¡æ¿å¼•æ“ï¼Œå¦‚Jinja2ã€Mustacheç­‰ï¼Œå°†Nginxé…ç½®æ–‡ä»¶ä¸­çš„å˜é‡æ›¿æ¢ä¸ºå®é™…çš„å€¼ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å°†é…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£å·ã€åŸŸåã€SSLè¯ä¹¦è·¯å¾„ç­‰ä¿¡æ¯ä½œä¸ºå˜é‡ï¼Œåœ¨éƒ¨ç½²æ—¶å†æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œæ›¿æ¢ï¼Œä»è€Œå¿«é€Ÿç”Ÿæˆæ»¡è¶³éœ€æ±‚çš„Nginxé…ç½®æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼ˆå¦‚Gitï¼‰æ¥å¯¹Nginxé…ç½®æ–‡ä»¶è¿›è¡Œç®¡ç†ï¼Œå¹¶åˆ©ç”¨CI/CDå·¥å…·ï¼ˆå¦‚Jenkinsï¼‰è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²NginxæœåŠ¡å™¨ã€‚\né€šè¿‡è‡ªåŠ¨åŒ–å·¥å…·çš„ä½¿ç”¨ï¼Œå¯ä»¥å¤§å¤§æé«˜NginxæœåŠ¡å™¨çš„é…ç½®æ•ˆç‡å’Œå‡†ç¡®æ€§ï¼Œå¹¶æ›´å¥½åœ°é€‚åº”ä¸åŒç¯å¢ƒä¸‹çš„éœ€æ±‚ã€‚\n1ã€éœ€æ±‚ å¼€å‘éƒ¨é—¨ ä¸å®šæœŸä¼šæ›´æ–°æ–°çš„é¡¹ç›®ä¸Šçº¿ï¼Œä¼šç”¨åˆ°åŸŸåç»‘å®šæœåŠ¡å™¨ è¿›è¡Œæš´éœ²ã€‚\næµç¨‹ å¼€å‘éƒ¨é—¨æå‡ºåŸŸåè®¢å•éœ€æ±‚ï¼ŒåŒ…æ‹¬éœ€è¦ç»‘å®šçš„åŸŸåå’Œç›¸åº”çš„æœåŠ¡å™¨åœ°å€ã€‚ è¿ç»´éƒ¨é—¨åœ¨DNSç®¡ç†æ§åˆ¶é¢æ¿ä¸­æ·»åŠ DNSè§£æè®°å½•ï¼Œå°†éœ€è¦ç»‘å®šçš„åŸŸåè§£æåˆ°ç›¸åº”çš„æœåŠ¡å™¨IPåœ°å€ã€‚ è¿ç»´éƒ¨é—¨åœ¨Nginxé…ç½®ä¸­åˆ›å»ºæ–°çš„serverå—ï¼Œé…ç½®è¦ç»‘å®šçš„åŸŸåå’Œç›¸åº”çš„ç«™ç‚¹ä¿¡æ¯ï¼Œä¾‹å¦‚æ–‡æ¡£æ ¹ç›®å½•ã€æ—¥å¿—æ–‡ä»¶ã€SSLè¯ä¹¦ç­‰ã€‚ è¿ç»´éƒ¨é—¨å°†Nginxé…ç½®æ–‡ä»¶ä¸­çš„å˜é‡å’Œå®é™…çš„æœåŠ¡å™¨åœ°å€è¿›è¡Œæ›¿æ¢ï¼Œä¾‹å¦‚æ›¿æ¢$server_nameå˜é‡ä¸ºå®é™…è¦ç»‘å®šçš„åŸŸåã€‚ è¿ç»´éƒ¨é—¨é‡è½½æˆ–é‡æ–°å¯åŠ¨NginxæœåŠ¡ï¼Œä½¿æ–°çš„é…ç½®ç”Ÿæ•ˆã€‚ æœ€ç»ˆï¼ŒåŸŸåè§£æåˆ°ç›¸åº”çš„æœåŠ¡å™¨åœ°å€ï¼Œå¹¶ç”±Nginxæ­£ç¡®åœ°å°†è¯·æ±‚è·¯ç”±åˆ°ç›¸åº”çš„ç«™ç‚¹ã€‚ 2ã€kubernetes+ingresså®æˆ˜ 1ã€è½¬å‘kubernetesçš„ingress kubernetes-cluster.conf\n1 2 3 4 upstream kubernetes-cluster { server 192.168.82.42 weight=5; keepalive 16; } 2ã€åŸŸåé…ç½® ogateway-uat.xxxx.net.conf\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 server { listen 80; server_name ogateway-uat.xxxx.net; rewrite ^/(.*)$ https://$host/$1 permanent; # IPç™½åå• include /usr/local/openresty/nginx/whitelist/corporation.conf; } server { listen 443 ssl; server_name ogateway-uat.xxxx.net; ssl on; ssl_certificate /usr/local/openresty/nginx/ssl/xxx.net.crt; ssl_certificate_key /usr/local/openresty/nginx/ssl/xxx.net.key; include ssl.conf; # IPç™½åå• æ”¾å¼€æ—¶é—´0920-0930 include /usr/local/openresty/nginx/whitelist/corporation.conf; location / { proxy_pass http://kubernetes-cluster; include https_proxy.conf; } } 3ã€åå‘ä»£ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 server { listen 80; server_name customer-uat.xxxxx.com; # IPç™½åå• include /usr/local/openresty/nginx/whitelist/corporation.conf; rewrite ^/(.*)$ https://$host/$1 permanent; } server { listen 443 ssl; server_name customer-uat.xxxx.com; # IPç™½åå• include /usr/local/openresty/nginx/whitelist/corporation.conf; ssl on; ssl_certificate /usr/local/openresty/nginx/ssl/xxxx.com.crt; ssl_certificate_key /usr/local/openresty/nginx/ssl/xxxxx.com.key; include ssl.conf; location / { proxy_pass http://192.168.102.202; include proxy.conf; proxy_set_header X-Forwarded-Proto https; proxy_set_header X-Forwarded-HTTPS on; add_header Front-End-Https on; } } 4ã€è´Ÿè½½è½®è¯¢ä»£ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 upstream xxxx-backend-uat { #server 192.168.99.147:1201; server 192.168.82.42; } server { listen 80; server_name inhouse-xxxx-uat.xxxx.com; include /usr/local/openresty/nginx/whitelist/corporation.conf; location / { proxy_pass http://xxxx-backend-uat; include http_proxy.conf; } } server { listen 443 ssl; server_name xxxx-backend-uat.xxxx.com; include /usr/local/openresty/nginx/whitelist/corporation.conf; ssl on; ssl_certificate /usr/local/openresty/nginx/ssl/xxxx.com.crt; ssl_certificate_key /usr/local/openresty/nginx/ssl/xxxx.com.key; include ssl.conf; location / { proxy_pass http://xxxx-backend-uat; include http_proxy.conf; } } 5ã€è‡ªåŠ¨åŒ–å¤„ç† add_nginx.sh\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 #!/bin/bash #æ—¥å¿—çº§åˆ« debug-1, info-2, warn-3, error-4, always-5 LOG_LEVEL=1 #æ—¥å¿—åç§° job_name=add_nginx #è„šæœ¬ç›®å½• script_dir=/opt #æ—¥å¿—æ–‡ä»¶ LOG_FILE=./${job_name}.log #è°ƒè¯•æ—¥å¿— function log_debug() { content=\u0026#34;[DEBUG] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $@\u0026#34; [ $LOG_LEVEL -le 1 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32m\u0026#34; ${content} \u0026#34;\\033[0m\u0026#34; } #ä¿¡æ¯æ—¥å¿— function log_info() { content=\u0026#34;[INFO] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $@\u0026#34; [ $LOG_LEVEL -le 2 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32m\u0026#34; ${content} \u0026#34;\\033[0m\u0026#34; } #è­¦å‘Šæ—¥å¿— function log_warn() { content=\u0026#34;[WARN] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $@\u0026#34; [ $LOG_LEVEL -le 3 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE \u0026amp;\u0026amp; echo -e \u0026#34;\\033[33m\u0026#34; ${content} \u0026#34;\\033[0m\u0026#34; } #é”™è¯¯æ—¥å¿— function log_err() { content=\u0026#34;[ERROR] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $@\u0026#34; [ $LOG_LEVEL -le 4 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE \u0026amp;\u0026amp; echo -e \u0026#34;\\033[31m\u0026#34; ${content} \u0026#34;\\033[0m\u0026#34; } #ä¸€ç›´éƒ½ä¼šæ‰“å°çš„æ—¥å¿— function log_always() { content=\u0026#34;[ALWAYS] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $@\u0026#34; [ $LOG_LEVEL -le 5 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32m\u0026#34; ${content} \u0026#34;\\033[0m\u0026#34; } function get_Whitelist() { # æç¤ºç”¨æˆ·è¾“å…¥é€‰é¡¹ echo \u0026#34;1. ä½¿ç”¨ç™½åå•\u0026#34; echo \u0026#34;2. ä¸ä½¿ç”¨ç™½åå•\u0026#34; # è·å–ç”¨æˆ·è¾“å…¥ read -p \u0026#34;è¯·é€‰æ‹©è¦ä½¿ç”¨ç™½åå•é…ç½®ï¼š\u0026#34; choice_whitelist # ä½¿ç”¨caseè¯­å¥æ ¹æ®ç”¨æˆ·é€‰æ‹©è®¾ç½®å˜é‡ case $choice_whitelist in 1) use_whitelist=true ;; 2) use_whitelist=false ;; *) echo \u0026#34;é”™è¯¯ï¼šè¯·è¾“å…¥æ­£ç¡®çš„é€‰é¡¹\u0026#34; \u0026gt;\u0026amp;2 exit 1 ;; esac } function set_whitelist() { if [ \u0026#34;$use_whitelist\u0026#34; = true ]; then log_info \u0026#34;å·²ç»è®¾ç½®IPç™½åå•\u0026#34; sed -i -r \u0026#39;s/^(\\s*)#(.*include\\s*\\/usr\\/local\\/openresty\\/nginx\\/whitelist\\/corporation\\.conf;.*)$/\\1\\2/g\u0026#39; \u0026#34;$conf_file\u0026#34; else log_info \u0026#34;ä¸ä½¿ç”¨IPç™½åå•\u0026#34; fi } function check_nginx() { conf_file=\u0026#34;/chen/company_shell/$realm_name.conf\u0026#34; # æ£€æŸ¥Nginxé…ç½®æ–‡ä»¶ if nginx -t \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then echo \u0026#34;Nginx configuration test passed.\u0026#34; else echo \u0026#34;Nginx configuration test failed. Please check your configuration file.\u0026#34; exit 1 fi } function kubernetes_nginx() { re_301=\u0026#39;rewrite ^/(.*)$ https://$host/$1 permanent;\u0026#39; tld=$(echo \u0026#34;$realm_name\u0026#34; | sed -E \u0026#39;s/.*\\.([^.]+\\.[^.]+)$/\\1/\u0026#39;) cat \u0026gt;$realm_name.conf \u0026lt;\u0026lt;EOF server { listen 80; server_name $realm_name; # IPç™½åå• #include /usr/local/openresty/nginx/whitelist/corporation.conf; $re_301 } server { listen 443 ssl; server_name $realm_name; ssl on; ssl_certificate /usr/local/openresty/nginx/ssl/$tld.crt; ssl_certificate_key /usr/local/openresty/nginx/ssl/$tld.key; include ssl.conf; # IPç™½åå• #include /usr/local/openresty/nginx/whitelist/corporation.conf; location / { proxy_pass http://kubernetes-cluster; include https_proxy.conf; } } EOF } function proxy_nginx() { read -p \u0026#34;è®¾ç½®åå‘ä»£ç†ï¼ˆåˆ—å¦‚ï¼šhttp://172.18.199.115ï¼‰ï¼š\u0026#34; proxy_ip re_301=\u0026#39;rewrite ^/(.*)$ https://$host/$1 permanent;\u0026#39; tld=$(echo \u0026#34;$realm_name\u0026#34; | sed -E \u0026#39;s/.*\\.([^.]+\\.[^.]+)$/\\1/\u0026#39;) cat \u0026gt;$realm_name.conf \u0026lt;\u0026lt;EOF server { listen 80; server_name $realm_name; $re_301 # IPç™½åå• #include /usr/local/openresty/nginx/whitelist/corporation.conf; } server { listen 443 ssl; server_name $realm_name; # IPç™½åå• #include /usr/local/openresty/nginx/whitelist/corporation.conf; ssl on; ssl_certificate /usr/local/openresty/nginx/ssl/$tld.crt; ssl_certificate_key /usr/local/openresty/nginx/ssl/$tld.key; include ssl.conf; location / { proxy_pass $proxy_ip; include https_proxy.conf; } } EOF } function upstream_nginx() { pass } # å®šä¹‰å‡½æ•°ï¼šç”Ÿäº§åŸŸå function set_kubernetes_nginx() { # TODO: åœ¨è¿™é‡Œå®ç°ç”Ÿäº§åŸŸåçš„æ“ä½œ log_info \u0026#34;å¼€å§‹é…ç½®nginxæ¨¡æ¿\u0026#34; read -p \u0026#34;è¯·è¾“æ‚¨çš„åŸŸå: \u0026#34; realm_name log_info \u0026#34;åŸŸåè®°å½•ï¼š $realm_name\u0026#34; get_Whitelist kubernetes_nginx # è¾“å‡ºå˜é‡å€¼ set_whitelist #é…ç½®æ–‡ä»¶æ ¡æ£€ check_nginx } function set_reverse_proxy_nginx() { # TODO: åœ¨è¿™é‡Œå®ç°ç”Ÿäº§åŸŸåçš„æ“ä½œ log_info \u0026#34;å¼€å§‹é…ç½®nginxæ¨¡æ¿\u0026#34; read -p \u0026#34;è¯·è¾“æ‚¨çš„åŸŸå: \u0026#34; realm_name log_info \u0026#34;åŸŸåè®°å½•ï¼š $realm_name\u0026#34; get_Whitelist proxy_nginx # è¾“å‡ºå˜é‡å€¼ set_whitelist #é…ç½®æ–‡ä»¶æ ¡æ£€ check_nginx } function set_upstream_proxy_nginx() { # TODO: åœ¨è¿™é‡Œå®ç°ç”Ÿäº§åŸŸåçš„æ“ä½œ log_info \u0026#34;å¼€å§‹é…ç½®nginxæ¨¡æ¿\u0026#34; read -p \u0026#34;è¯·è¾“æ‚¨çš„åŸŸå: \u0026#34; realm_name log_info \u0026#34;åŸŸåè®°å½•ï¼š $realm_name\u0026#34; get_Whitelist upstream_nginx # è¾“å‡ºå˜é‡å€¼ set_whitelist #é…ç½®æ–‡ä»¶æ ¡æ£€ check_nginx } # å®šä¹‰ä¸»å‡½æ•° function main() { # æ˜¾ç¤ºèœå• echo \u0026#34;è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ï¼š\u0026#34; echo \u0026#34;1. kubernetesæ¥å…¥\u0026#34; echo \u0026#34;2. åå‘ä»£ç†æ¥å…¥\u0026#34; echo \u0026#34;3. è´Ÿè½½å‡è¡¡æ¥å…¥\u0026#34; # è¯»å–ç”¨æˆ·è¾“å…¥ read -p \u0026#34;è¯·è¾“æ‚¨çš„é€‰æ‹©: \u0026#34; choice # æ ¹æ®ç”¨æˆ·è¾“å…¥é€‰æ‹©å¯¹åº”çš„æ“ä½œ case $choice in 1) set_kubernetes_nginx ;; 2) set_reverse_proxy_nginx ;; 3) set_upstream_proxy_nginx ;; *) echo \u0026#34;æ— æ•ˆçš„é€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥\u0026#34; ;; esac } # è°ƒç”¨ä¸»å‡½æ•° main ","date":"2023-04-10T14:29:25Z","image":"https://www.ownit.top/title_pic/24.jpg","permalink":"https://www.ownit.top/p/202304101429/","title":"Nginxæ¨¡æ¿è‡ªåŠ¨åŒ–"},{"content":"æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ Spring Boot ä¸­é›†æˆé˜¿æ³¢ç½—ï¼ˆApolloï¼‰å’Œ Consulï¼Œå¹¶ä½¿ç”¨ Apollo å’Œ Consul å®ç°é…ç½®ç®¡ç†å’ŒæœåŠ¡æ³¨å†Œä¸å‘ç°çš„åŠŸèƒ½ã€‚\n1. ä»€ä¹ˆæ˜¯é˜¿æ³¢ç½— é˜¿æ³¢ç½—æ˜¯æºç¨‹å¼€æºçš„åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ã€‚å®ƒæä¾›äº†ä¸€å¥—å®Œæ•´çš„é…ç½®ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…å®ç°é…ç½®ç®¡ç†ã€ç‰ˆæœ¬æ§åˆ¶ã€ç°åº¦å‘å¸ƒç­‰åŠŸèƒ½ã€‚\nApolloï¼ˆé˜¿æ³¢ç½—ï¼‰æ˜¯æºç¨‹æ¡†æ¶éƒ¨é—¨ç ”å‘çš„åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œèƒ½å¤Ÿé›†ä¸­åŒ–ç®¡ç†åº”ç”¨ä¸åŒç¯å¢ƒã€ä¸åŒé›†ç¾¤çš„é…ç½®ï¼Œé…ç½®ä¿®æ”¹åèƒ½å¤Ÿå®æ—¶æ¨é€åˆ°åº”ç”¨ç«¯ï¼Œå¹¶ä¸”å…·å¤‡è§„èŒƒçš„æƒé™ã€æµç¨‹æ²»ç†ç­‰ç‰¹æ€§ï¼Œé€‚ç”¨äºå¾®æœåŠ¡é…ç½®ç®¡ç†åœºæ™¯ã€‚æœåŠ¡ç«¯åŸºäº Spring Boot å’Œ Spring Cloud å¼€å‘ï¼Œæ‰“åŒ…åå¯ä»¥ç›´æ¥è¿è¡Œï¼Œä¸éœ€è¦é¢å¤–å®‰è£… Tomcat ç­‰åº”ç”¨å®¹å™¨ã€‚\nApollo æ”¯æŒ 4 ä¸ªç»´åº¦ç®¡ç† Key-Value æ ¼å¼çš„é…ç½®ï¼š\napplication (åº”ç”¨) environment (ç¯å¢ƒ) cluster (é›†ç¾¤) namespace (å‘½åç©ºé—´ Namespace æ˜¯é…ç½®é¡¹çš„é›†åˆï¼Œç±»ä¼¼äºä¸€ä¸ªé…ç½®æ–‡ä»¶çš„æ¦‚å¿µ) ä¸Šå›¾æ˜¯Apolloé…ç½®ä¸­å¿ƒä¸­ä¸€ä¸ªé¡¹ç›®çš„é…ç½®é¦–é¡µ\nåœ¨é¡µé¢å·¦ä¸Šæ–¹çš„ç¯å¢ƒåˆ—è¡¨æ¨¡å—å±•ç¤ºäº†æ‰€æœ‰çš„ç¯å¢ƒå’Œé›†ç¾¤ï¼Œç”¨æˆ·å¯ä»¥éšæ—¶åˆ‡æ¢ã€‚ é¡µé¢ä¸­å¤®å±•ç¤ºäº†ä¸¤ä¸ªnamespace(applicationå’ŒFX.apollo)çš„é…ç½®ä¿¡æ¯ï¼Œé»˜è®¤æŒ‰ç…§è¡¨æ ¼æ¨¡å¼å±•ç¤ºã€ç¼–è¾‘ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥åˆ‡æ¢åˆ°æ–‡æœ¬æ¨¡å¼ï¼Œä»¥æ–‡ä»¶å½¢å¼æŸ¥çœ‹ã€ç¼–è¾‘ã€‚ é¡µé¢ä¸Šå¯ä»¥æ–¹ä¾¿åœ°è¿›è¡Œå‘å¸ƒã€å›æ»šã€ç°åº¦ã€æˆæƒã€æŸ¥çœ‹æ›´æ”¹å†å²å’Œå‘å¸ƒå†å²ç­‰æ“ä½œã€‚ 1.1 é›†æˆ Apollo çš„åŸç† Spring Boot é›†æˆé˜¿æ³¢ç½—å¯ä»¥é€šè¿‡å¼•å…¥ apollo-client å®¢æˆ·ç«¯åº“ï¼Œå¹¶åœ¨ Spring Boot åº”ç”¨ç¨‹åºä¸­é…ç½®è¿æ¥ä¿¡æ¯å’Œè·å–é…ç½®ä¿¡æ¯æ¥å®ç°ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š\nSpring Boot åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œå…ˆåŠ è½½ bootstrap.yml æˆ–è€… bootstrap.properties æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯ã€‚\nåœ¨ bootstrap.yml æˆ–è€… bootstrap.properties ä¸­é…ç½®é˜¿æ³¢ç½—çš„è¿æ¥ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œé˜¿æ³¢ç½—çš„åœ°å€ã€åº”ç”¨ç¨‹åºåç§°ç­‰ï¼‰ã€‚\nåœ¨ Spring Boot åº”ç”¨ç¨‹åºä¸­æ³¨å…¥ @Value æ³¨è§£ä¸­æŒ‡å®šçš„é˜¿æ³¢ç½—é…ç½®é¡¹çš„å€¼ï¼Œå³å¯ä½¿ç”¨é˜¿æ³¢ç½—ç®¡ç†çš„é…ç½®ä¿¡æ¯ã€‚\nå¦‚æœé˜¿æ³¢ç½—çš„é…ç½®ä¿¡æ¯å‘ç”Ÿæ”¹å˜ï¼ŒSpring Boot åº”ç”¨ç¨‹åºä¼šè‡ªåŠ¨ä»é˜¿æ³¢ç½—æ›´æ–°æœ€æ–°çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶é‡æ–°åŠ è½½åº”ç”¨ç¨‹åºçš„é…ç½®ã€‚\n1.2. é›†æˆ Apollo çš„ä¼˜åŠ¿ é›†æˆé˜¿æ³¢ç½—å¯ä»¥å¸¦æ¥ä»¥ä¸‹ä¼˜åŠ¿ï¼š\nç®¡ç†å¤šä¸ªç¯å¢ƒçš„é…ç½®ï¼šé˜¿æ³¢ç½—æä¾›äº†ç¯å¢ƒåˆ‡æ¢å’Œç°åº¦å‘å¸ƒçš„åŠŸèƒ½ï¼Œå¯ä»¥è½»æ¾ç®¡ç†å¤šä¸ªç¯å¢ƒï¼ˆä¾‹å¦‚ï¼Œå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒç­‰ï¼‰çš„é…ç½®ä¿¡æ¯ã€‚\nå®æ—¶æ›´æ–°é…ç½®ï¼šé˜¿æ³¢ç½—æ”¯æŒå®æ—¶æ›´æ–°é…ç½®ä¿¡æ¯ï¼Œå¯ä»¥åœ¨ä¸é‡å¯åº”ç”¨ç¨‹åºçš„æƒ…å†µä¸‹åŠ¨æ€æ›´æ–°é…ç½®ä¿¡æ¯ã€‚\nç‰ˆæœ¬æ§åˆ¶ï¼šé˜¿æ³¢ç½—æä¾›äº†ç‰ˆæœ¬æ§åˆ¶çš„åŠŸèƒ½ï¼Œå¯ä»¥è®°å½•æ¯ä¸ªé…ç½®é¡¹çš„å†å²ç‰ˆæœ¬ï¼Œæ–¹ä¾¿å›æ»šå’Œæ¢å¤æ•°æ®ã€‚\né›†æˆå¤šç§æ¡†æ¶ï¼šé˜¿æ³¢ç½—æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ï¼Œå¯ä»¥è½»æ¾é›†æˆåˆ°å„ç§åº”ç”¨ç¨‹åºä¸­ã€‚\n2ã€SpringBootå®æˆ˜é›†æˆApollo 1ã€å¼•å…¥ä¾èµ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;project xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.5.4\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;groupId\u0026gt;com.springboot.demo\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;web-demo\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.0.1-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;web-demo\u0026lt;/name\u0026gt; \u0026lt;description\u0026gt;web-demo\u0026lt;/description\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;java.version\u0026gt;1.8\u0026lt;/java.version\u0026gt; \u0026lt;spring-cloud.version\u0026gt;Finchley.RELEASE\u0026lt;/spring-cloud.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-starter-consul-discovery\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-actuator\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.ctrip.framework.apollo\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;apollo-client\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.5.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-dependencies\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2020.0.3\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;scope\u0026gt;import\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/dependencyManagement\u0026gt; \u0026lt;/project\u0026gt; 2ã€å¢åŠ é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 apollo: bootstrap: enabled: true eagerLoad: enabled: true namespaces: application,tech.java.consul,tech.java.logback 3ã€Apolloé…ç½®ï¼ˆå…¬ç”¨é…ç½®ï¼Œå¼•ç”¨ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 spring.cloud.consul.host = localhost spring.cloud.consul.port = 8500 spring.cloud.consul.discovery.prefer-ip-address = true spring.cloud.consul.discovery.instance-id = ${spring.application.name}-${POD_IP:localhost}-${server.port} consul.datacenter = uat spring.cloud.consul.discovery.healthCheckPath = ${management.context-path}/health consul.cluster = uat management.context-path = /actuator consul.version = 1.5.3 log.pattern = %d{yyyy-MM-dd HH:mm:ss.SSS} %level | [%t] %logger{36} [%L] | %msg%n log.dir = /app/logs/app 4ã€Apolloé¡¹ç›®é…ç½® ä¸Šé¢ä¸ºå…¬å…±çš„é…ç½®å¼•ç”¨ï¼Œå¯ä»¥è¢«å¤šä¸ªé¡¹ç›®ä½¿ç”¨\næ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„Apolloé¡¹ç›®ã€‚\nåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ Apollo é¡¹ç›®å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š\nç™»å½•é˜¿æ³¢ç½—æ§åˆ¶å°ï¼šåœ¨æµè§ˆå™¨ä¸­è¾“å…¥ https://config.xxx.com åœ°å€ï¼Œä½¿ç”¨é˜¿æ³¢ç½—ç®¡ç†å‘˜è´¦å·ç™»å½•é˜¿æ³¢ç½—æ§åˆ¶å°ã€‚\nåˆ›å»ºæ–°é¡¹ç›®ï¼šåœ¨é˜¿æ³¢ç½—æ§åˆ¶å°ä¸­ï¼Œç‚¹å‡»å·¦ä¾§å¯¼èˆªæ ä¸­çš„â€œAppListâ€ï¼Œç„¶åç‚¹å‡»â€œCreate Appâ€æŒ‰é’®ï¼Œåœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­å¡«å†™åº”ç”¨ç¨‹åºåç§°ã€æ‰€å±é›†ç¾¤ã€æ‰€å±å‘½åç©ºé—´ç­‰ä¿¡æ¯ï¼Œå¹¶ç‚¹å‡»â€œCreateâ€æŒ‰é’®åˆ›å»ºæ–°é¡¹ç›®ã€‚\næ·»åŠ é…ç½®é¡¹ï¼šè¿›å…¥æ–°åˆ›å»ºçš„é¡¹ç›®é¡µé¢åï¼Œç‚¹å‡»å³ä¾§çš„â€œNamespace Listâ€æ ‡ç­¾é¡µï¼Œç„¶åé€‰æ‹©éœ€è¦æ·»åŠ é…ç½®é¡¹çš„å‘½åç©ºé—´ã€‚åœ¨å‘½åç©ºé—´é¡µé¢ä¸­ï¼Œç‚¹å‡»â€œAdd Itemâ€æŒ‰é’®ï¼Œå¡«å†™é…ç½®é¡¹çš„ Key å’Œ Valueï¼Œå¹¶é€‰æ‹©è¯¥é…ç½®é¡¹æ‰€å±çš„ç¯å¢ƒï¼ˆå¦‚ devã€testã€prod ç­‰ï¼‰å’Œç‰ˆæœ¬å·ã€‚\nä¸‹è½½å®¢æˆ·ç«¯åº“ï¼šåœ¨é˜¿æ³¢ç½—æ§åˆ¶å°ä¸­ï¼Œç‚¹å‡»å³ä¸Šè§’çš„â€œPortalâ€èœå•ï¼Œè¿›å…¥å¼€å‘è€…é—¨æˆ·ç½‘ç«™ã€‚åœ¨ç½‘ç«™ä¸­ï¼Œé€‰æ‹©å¯¹åº”çš„ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ï¼Œç„¶åä¸‹è½½å¯¹åº”çš„å®¢æˆ·ç«¯åº“ï¼ˆä¾‹å¦‚ï¼ŒJava + Spring Boot åº”ç”¨ç¨‹åºéœ€è¦ä¸‹è½½ apollo-client å®¢æˆ·ç«¯åº“ï¼‰ã€‚\né›†æˆå®¢æˆ·ç«¯åº“ï¼šå°†ä¸‹è½½å¥½çš„å®¢æˆ·ç«¯åº“å¼•å…¥åº”ç”¨ç¨‹åºçš„ä¾èµ–ä¸­ï¼Œç„¶ååœ¨åº”ç”¨ç¨‹åºä¸­æ·»åŠ è¿æ¥é˜¿æ³¢ç½—çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨å®¢æˆ·ç«¯åº“ä»é˜¿æ³¢ç½—è·å–é…ç½®ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œåœ¨ Spring Boot åº”ç”¨ç¨‹åºä¸­ï¼Œå¯ä»¥åœ¨ bootstrap.yml æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ä¿¡æ¯ï¼š\n1 2 3 4 5 6 7 8 9 10 yaml spring: application: name: your-application-name profiles: active: dev apollo: meta: http://apollo-config-server-url bootstrap: enabled: true å…¶ä¸­ï¼Œyour-application-name æ˜¯åº”ç”¨ç¨‹åºçš„åç§°ï¼Œdev æ˜¯é…ç½®ç¯å¢ƒçš„åç§°ã€‚http://apollo-config-server-url æ˜¯é˜¿æ³¢ç½—çš„é…ç½®æœåŠ¡ URLã€‚\n6.å¯åŠ¨åº”ç”¨ç¨‹åºï¼šå°†é›†æˆäº† Apollo çš„åº”ç”¨ç¨‹åºæ‰“åŒ…å¹¶å¯åŠ¨ï¼Œé€šè¿‡æ—¥å¿—å’Œæ§åˆ¶å°è¾“å‡ºå¯ä»¥æŸ¥çœ‹åˆ°åº”ç”¨ç¨‹åºä»é˜¿æ³¢ç½—è·å–é…ç½®ä¿¡æ¯çš„æƒ…å†µã€‚\nä»¥ä¸Šå°±æ˜¯åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ Apollo é¡¹ç›®çš„æµç¨‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨å®é™…åº”ç”¨ä¸­è¿˜éœ€æ ¹æ®å…·ä½“æƒ…å†µè¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 name = qqqqqqqqqqqqqqqqqqqqqqqqqqqqq server.port = 8081 spring.application.name = fqdemo4 spring.profiles.active = uat spring.cloud.consul.host = 192.168.102.20 spring.cloud.consul.port = 8500 spring.cloud.enabled = true spring.cloud.consul.discovery.enabled = true spring.cloud.consul.discovery.hostname = 127.0.0.1 spring.cloud.consul.discovery.register = true spring.cloud.consul.discovery.deregister = true spring.cloud.consul.discovery.prefer-ip-address = true spring.cloud.consul.discovery.instance-id = ${spring.application.name} spring.cloud.consul.discovery.service-name = ${spring.application.name} spring.cloud.consul.discovery.health-check-url = http://${spring.cloud.consul.discovery.hostname}:${server.port}/ 5ã€SpringBootä»£ç  WebDemoApplication å¯åŠ¨ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package com.springboot.demo.webdemo; import com.ctrip.framework.apollo.spring.annotation.EnableApolloConfig; import org.springframework.beans.factory.annotation.Value; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.discovery.EnableDiscoveryClient; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestParam; import org.springframework.web.bind.annotation.RestController; @SpringBootApplication @RestController @EnableDiscoveryClient @EnableApolloConfig public class WebDemoApplication { public static void main(String[] args) { SpringApplication.run(WebDemoApplication.class, args); } #apolloçš„å˜é‡è·å– @GetMapping(\u0026#34;/\u0026#34;) @Value(\u0026#34;${name}\u0026#34;) public String hello(@RequestParam(value = \u0026#34;name\u0026#34;, defaultValue = \u0026#34;${name}\u0026#34;) String name) { return String.format(\u0026#34;Hello %s!\u0026#34;, name); } } HelloWorldControllerç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package com.springboot.demo.webdemo.controller; import org.springframework.http.ResponseEntity; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RequestParam; import org.springframework.web.bind.annotation.RestController; import java.util.HashMap; @RestController @RequestMapping(\u0026#34;/hello\u0026#34;) public class HelloWorldController { @GetMapping public String hello(){ return \u0026#34;hello SpringBoot æ­å»ºæˆåŠŸå•¦\u0026#34;; } } EmployeeController ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package com.springboot.demo.webdemo.controller; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; import java.util.HashMap; @RestController @RequestMapping(\u0026#34;/employee\u0026#34;) public class EmployeeController { @GetMapping public HashMap\u0026lt;String, String\u0026gt; index(){ HashMap\u0026lt;String, String\u0026gt; hashmap = new HashMap\u0026lt;String, String\u0026gt;(); hashmap.put(\u0026#34;å§“å\u0026#34;, \u0026#34;ç‹äºŒ\u0026#34;); hashmap.put(\u0026#34;å¹´é¾„\u0026#34;, \u0026#34;27\u0026#34;); hashmap.put(\u0026#34;å·¥é¾„\u0026#34;, \u0026#34;6\u0026#34;); return hashmap; } } 6ã€å¯åŠ¨æµ‹è¯• 1 -Dapp.id=156 -Dapollo.meta=http://config.uat.bdata.api.fjf -Denv=uat -javaagent:pinpoint-agent-2.3.3/pinpoint-bootstrap.jar -Dpinpoint.applicationName=fanqiang.uat nameå˜é‡ ä¿®æ”¹nameå˜é‡ï¼Œæ— éœ€é‡å¯é¡¹ç›®\næµ‹è¯•ä¸¤ä¸ªæ¥å£ Consulå·²ç»è‡ªåŠ¨æ³¨å†Œä¸Š æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•åœ¨ Spring Boot ä¸­é›†æˆé˜¿æ³¢ç½—ï¼Œå¹¶è¯¦ç»†è¯´æ˜äº†å…¶åŸç†å’Œä¼˜åŠ¿ã€‚é€šè¿‡ä½¿ç”¨é˜¿æ³¢ç½—ï¼Œå¯ä»¥è½»æ¾ç®¡ç†å¤šä¸ªç¯å¢ƒçš„é…ç½®ä¿¡æ¯ï¼Œå®ç°é…ç½®ç®¡ç†ã€ç‰ˆæœ¬æ§åˆ¶ã€ç°åº¦å‘å¸ƒç­‰åŠŸèƒ½ã€‚åŒæ—¶ï¼Œæœ¬æ–‡è¿˜ç»™å‡ºäº†é›†æˆé˜¿æ³¢ç½—çš„æœ€ä½³å®è·µï¼Œå¸Œæœ›èƒ½å¤Ÿå¯¹å¼€å‘è€…å’Œè¿ç»´åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨é˜¿æ³¢ç½—æä¾›ä¸€äº›å‚è€ƒå’Œå¸®åŠ©ã€‚\nå‚è€ƒæ–‡æ¡£ï¼š\nhttps://www.cnblogs.com/mrhelloworld/p/apollo1.html\nspring cloud apollo é…ç½®ä¸­å¿ƒ - æ˜é‡‘\nSpring Boot é›†æˆ Apollo é…ç½®ä¸­å¿ƒï¼ŒçœŸé¦™ã€çœŸå¼ºå¤§ï¼_51CTOåšå®¢_apolloé›†æˆspringcloud\n","date":"2023-03-27T10:18:30Z","image":"https://www.ownit.top/title_pic/75.jpg","permalink":"https://www.ownit.top/p/202303271018/","title":"SpringBooté›†æˆApolloå’Œè‡ªåŠ¨æ³¨å†ŒConsul"},{"content":"1ã€èƒŒæ™¯ é˜¿é‡Œäº‘æ˜¯ä¸€ä¸ªå…¨çƒé¢†å…ˆçš„äº‘è®¡ç®—æœåŠ¡æä¾›å•†ï¼Œå…¶åŸŸåè§£ææœåŠ¡å¯ä»¥å¸®åŠ©ç”¨æˆ·å°†åŸŸåæ˜ å°„åˆ°IPåœ°å€ï¼Œä»è€Œä½¿å¾—ç½‘ç«™å¯ä»¥è¢«è®¿é—®ã€‚\n2ã€éœ€æ±‚ æ—¥å¸¸ä½¿ç”¨é˜¿é‡Œäº‘åŸŸåè§£ææœåŠ¡éœ€è¦ç™»å½•é˜¿é‡Œäº‘è´¦å·è¿›è¡Œæ“ä½œï¼Œä½†æ˜¯è¿™æ ·æ‰‹å·¥æ“ä½œè´¹æ—¶è´¹åŠ›ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨Pythonç¼–å†™ç¨‹åºæ¥å®ç°åŸŸåè§£æåŠŸèƒ½ï¼Œä»¥ä¾¿å¿«é€Ÿæ–¹ä¾¿åœ°å®ŒæˆåŸŸåè§£æä»»åŠ¡ã€‚å…·ä½“å®ç°è¿‡ç¨‹ä¸ºï¼šé€šè¿‡è°ƒç”¨é˜¿é‡Œäº‘APIæ¥å£è·å–ç”¨æˆ·æˆæƒï¼Œç„¶åä½¿ç”¨Pythonçš„DNSè§£æåº“å¯¹åŸŸåè¿›è¡Œè§£æï¼Œå¹¶å°†è§£æç»“æœå­˜å‚¨åˆ°æœ¬åœ°æˆ–è€…å‘é€åˆ°æŒ‡å®šé‚®ç®±ã€‚è¿™æ ·å°±å¯ä»¥çœå»æ‰‹åŠ¨ç™»å½•é˜¿é‡Œäº‘çš„æ­¥éª¤ï¼Œå¤§å¤§æé«˜äº†å·¥ä½œæ•ˆç‡ã€‚\n3ã€Python2è‡ªåŠ¨åŸŸåè§£æ Pythonç¯å¢ƒï¼šPython 2.7.5\né˜¿é‡Œäº‘çš„SDKï¼š\naliyun-python-sdk-alidns (2.6.20)\naliyun-python-sdk-core (2.13.30)\nè‡ªåŠ¨åŸŸåè§£ææ˜¯ä¸€ç§é«˜æ•ˆçš„æ–¹å¼ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿåœ°å°†åŸŸåæ˜ å°„åˆ°å¯¹åº”çš„IPåœ°å€ã€‚åœ¨CentOSæœºå™¨ä¸Šï¼Œç”±äºPythonç¯å¢ƒç‰ˆæœ¬è¾ƒè€ï¼Œå› æ­¤éœ€è¦æ³¨æ„å¯¹ä»£ç è¿›è¡Œé€‚é…ï¼Œä»¥ç¡®ä¿ç¨‹åºæ­£å¸¸è¿è¡Œã€‚\nåœ¨Python 2ç¯å¢ƒä¸‹ï¼Œä¸€äº›è¯­æ³•å’Œåº“å‡½æ•°å¯èƒ½å·²ç»è¿‡æ—¶æˆ–ä¸å†æ”¯æŒï¼Œå› æ­¤åœ¨ç¼–å†™ä»£ç æ—¶åº”è¯¥ä»”ç»†æ£€æŸ¥ï¼Œå¹¶æ ¹æ®éœ€è¦è¿›è¡Œç›¸åº”çš„ä¿®æ”¹å’Œæ›¿ä»£ã€‚è¿™æ ·æ‰èƒ½å¤Ÿç¡®ä¿ç¨‹åºçš„ç¨³å®šè¿è¡Œå’Œæ­£ç¡®æ€§ã€‚\nå› ä¸ºCentosæœºå™¨é»˜è®¤å®‰è£…Python2.0çš„ç¯å¢ƒï¼Œæˆ‘ä»¬å°±æ˜¯ç”¨2.0çš„è¯­æ³•è¿›è¡Œä¹¦å†™\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 #!/usr/bin/env python #coding=utf-8 # å¯¼å…¥æ¨¡å— import os # ç”¨äºå’Œæ“ä½œç³»ç»Ÿäº¤äº’ import sys # ç”¨äºè·å–å‘½ä»¤è¡Œå‚æ•° import time # ç”¨äºå¤„ç†æ—¶é—´ç›¸å…³çš„æ“ä½œ import json # ç”¨äºè§£æå’Œç”Ÿæˆ JSON æ ¼å¼çš„æ•°æ® # å¯¼å…¥é˜¿é‡Œäº‘ SDK ç›¸å…³æ¨¡å— from aliyunsdkcore.client import AcsClient from aliyunsdkcore.acs_exception.exceptions import ClientException from aliyunsdkcore.acs_exception.exceptions import ServerException from aliyunsdkalidns.request.v20150109.AddDomainRecordRequest import AddDomainRecordRequest # åˆ›å»ºä¸€ä¸ª AcsClient å®ä¾‹ï¼Œç”¨äºè°ƒç”¨é˜¿é‡Œäº‘ API client = AcsClient(\u0026#39;xxxx\u0026#39;, \u0026#39;xxxx\u0026#39;, \u0026#39;cn-xxxx\u0026#39;) # è·å–å‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æ»¡è¶³è¦æ±‚ v = sys.argv if len(v) \u0026lt; 2: print(\u0026#34;åŸŸåæˆ–è®°å½•å€¼ä¸å­˜åœ¨\u0026#34;) else: m = v[1] value = v[2] domain = m.split(\u0026#34;.xxx.com\u0026#34;)[0] # æå–äºŒçº§åŸŸå # åˆ›å»ºä¸€ä¸ªé˜¿é‡Œäº‘ API è°ƒç”¨è¯·æ±‚å¯¹è±¡ request = AddDomainRecordRequest() request.set_accept_format(\u0026#39;json\u0026#39;) # è®¾ç½®è¯¥è¯·æ±‚éœ€è¦ä¼ é€’çš„å‚æ•° request.set_DomainName(\u0026#34;xxx.com\u0026#34;) # å°† xxx.com æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ä¸€çº§åŸŸå request.set_RR(domain) # è®¾ç½®äºŒçº§åŸŸå if len(value) \u0026lt;= 15: request.set_Type(\u0026#34;A\u0026#34;) # å¦‚æœè®°å½•å€¼ä¸è¶…è¿‡ 15 ä¸ªå­—ç¬¦ï¼Œåˆ™ä¸º A è®°å½• else: request.set_Type(\u0026#34;CNAME\u0026#34;) # å¦åˆ™ä¸º CNAME è®°å½• request.set_Value(value) # è®¾ç½®è®°å½•å€¼ # å‘é€ API è¯·æ±‚ï¼Œå¹¶å¤„ç†å¼‚å¸¸ try: response = client.do_action_with_exception(request) print(response) except Exception as e: print(e) ä½¿ç”¨æ–¹æ³•\n1 2 3 ./addDNS-xxx.py fyhm.xxxx.net éœ€è¦è§£æIP for i in `cat dns.list`;do ./addDNS-xx.py $i IP;done å·²ç»å­˜åœ¨\n4ã€shellç•Œé¢åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 #!/bin/bash #æ—¥å¿—çº§åˆ« debug-1, info-2, warn-3, error-4, always-5 LOG_LEVEL=1 #æ—¥å¿—åç§° job_name=dns_name #è„šæœ¬ç›®å½• script_dir=/opt #æ—¥å¿—æ–‡ä»¶ LOG_FILE=./${job_name}.log #è°ƒè¯•æ—¥å¿— function log_debug() { content=\u0026#34;[DEBUG] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $@\u0026#34; [ $LOG_LEVEL -le 1 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32m\u0026#34; ${content} \u0026#34;\\033[0m\u0026#34; } #ä¿¡æ¯æ—¥å¿— function log_info() { content=\u0026#34;[INFO] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $@\u0026#34; [ $LOG_LEVEL -le 2 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32m\u0026#34; ${content} \u0026#34;\\033[0m\u0026#34; } #è­¦å‘Šæ—¥å¿— function log_warn() { content=\u0026#34;[WARN] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $@\u0026#34; [ $LOG_LEVEL -le 3 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE \u0026amp;\u0026amp; echo -e \u0026#34;\\033[33m\u0026#34; ${content} \u0026#34;\\033[0m\u0026#34; } #é”™è¯¯æ—¥å¿— function log_err() { content=\u0026#34;[ERROR] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $@\u0026#34; [ $LOG_LEVEL -le 4 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE \u0026amp;\u0026amp; echo -e \u0026#34;\\033[31m\u0026#34; ${content} \u0026#34;\\033[0m\u0026#34; } #ä¸€ç›´éƒ½ä¼šæ‰“å°çš„æ—¥å¿— function log_always() { content=\u0026#34;[ALWAYS] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $@\u0026#34; [ $LOG_LEVEL -le 5 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32m\u0026#34; ${content} \u0026#34;\\033[0m\u0026#34; } # å®šä¹‰å‡½æ•°ï¼šå¢åŠ è§£æè®°å½• function add_dns_record() { local domain=$1 local ip=$2 local script=$3 # æ ¡éªŒåŸŸåæ˜¯å¦ç¬¦åˆè¦æ±‚ if [[ $domain =~ $4 ]]; then log_info \u0026#34;$domain æ•ˆéªŒé€šè¿‡ æ­£å¸¸\u0026#34; else log_err \u0026#34;ä¸åŒ…å« $4ï¼Œè¯·æ£€æŸ¥åŸŸåæ˜¯å¦ç¬¦åˆ\u0026#34; exit 1 fi # å¢åŠ è§£æè®°å½• log_info \u0026#34;å¼€å§‹å¢åŠ  $domain è§£æ\u0026#34; $script $domain $ip \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 if [ $? != \u0026#34;0\u0026#34; ]; then log_err \u0026#34;$domain è§£æå·²ç»å­˜åœ¨ï¼Œè¯·æ£€æŸ¥\u0026#34; exit 1 fi log_info \u0026#34;$domain æ·»åŠ è§£æå®Œæ¯•\u0026#34; } # å®šä¹‰å‡½æ•°ï¼šç”Ÿäº§åŸŸå function prod_fujfu() { # TODO: åœ¨è¿™é‡Œå®ç°ç”Ÿäº§åŸŸåçš„æ“ä½œ log_info \u0026#34;æ‚¨é€‰æ‹©äº† prod_fujfu\u0026#34; read -p \u0026#34;è¯·è¾“æ‚¨çš„åŸŸå: \u0026#34; choice2 add_dns_record $choice2 xxxxxxxx $script_dir/addDNS.py \u0026#34;xxxx.com\u0026#34; } # å®šä¹‰å‡½æ•°ï¼šæµ‹è¯•åŸŸå function uat_fujfu() { # TODO: åœ¨è¿™é‡Œå®ç°æµ‹è¯•åŸŸåçš„æ“ä½œ log_info \u0026#34;æ‚¨é€‰æ‹©äº† uat_fujfu\u0026#34; read -p \u0026#34;è¯·è¾“æ‚¨çš„åŸŸå: \u0026#34; choice2 add_dns_record $choice2 xxx.xxx.xxx.xxx $script_dir/addDNS.py \u0026#34;xxxx.com\u0026#34; } # å®šä¹‰å‡½æ•°ï¼šuat åŸŸå function prod_xxxx() { # TODO: åœ¨è¿™é‡Œå®ç°ç”Ÿäº§åŸŸåçš„æ“ä½œ log_info \u0026#34;æ‚¨é€‰æ‹©äº† prod_xxxx\u0026#34; read -p \u0026#34;è¯·è¾“æ‚¨çš„åŸŸå: \u0026#34; choice2 add_dns_record $choice2 xxx.xxx.xxx.xxx $script_dir/addDNS-xxxx.py \u0026#34;xxxx.net\u0026#34; } # å®šä¹‰å‡½æ•°ï¼šdevåŸŸå function uat_xxxx() { # TODO: åœ¨è¿™é‡Œå®ç°devåŸŸåçš„æ“ä½œ log_info \u0026#34;æ‚¨é€‰æ‹©äº† uat_xxxx\u0026#34; read -p \u0026#34;è¯·è¾“æ‚¨çš„åŸŸå: \u0026#34; choice2 add_dns_record $choice2 xxx.xxx.xxx.xxx $script_dir/addDNS-xxxx.py \u0026#34;xxxx.net\u0026#34; } # å®šä¹‰å‡½æ•°ï¼šuat åŸŸå function prod_mumugz() { # TODO: åœ¨è¿™é‡Œå®ç°ç”Ÿäº§åŸŸåçš„æ“ä½œ log_info \u0026#34;æ‚¨é€‰æ‹©äº† prod_mumugz\u0026#34; read -p \u0026#34;è¯·è¾“æ‚¨çš„åŸŸå: \u0026#34; choice2 add_dns_record $choice2 xxx.xxx.xxx.xxx $script_dir/addDNS-mumugz.py \u0026#34;xxxx.com\u0026#34; } # å®šä¹‰å‡½æ•°ï¼šdevåŸŸå function uat_mumugz() { # TODO: åœ¨è¿™é‡Œå®ç°devåŸŸåçš„æ“ä½œ log_info \u0026#34;æ‚¨é€‰æ‹©äº† uat_mumugz\u0026#34; read -p \u0026#34;è¯·è¾“æ‚¨çš„åŸŸå: \u0026#34; choice2 add_dns_record $choice2 xxx.xxx.xxx.xxx $script_dir/addDNS-mumugz.py \u0026#34;xxxx.com\u0026#34; } # å®šä¹‰ä¸»å‡½æ•° function main() { # æ˜¾ç¤ºèœå• echo \u0026#34;è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ï¼š\u0026#34; echo \u0026#34;1. ç”Ÿäº§ xxxx.com\u0026#34; echo \u0026#34;2. æµ‹è¯• xxxx.com\u0026#34; echo \u0026#34;3. ç”Ÿäº§ xxxx.net\u0026#34; echo \u0026#34;4. æµ‹è¯• xxxx.net\u0026#34; echo \u0026#34;5. ç”Ÿäº§ xxxx.com\u0026#34; echo \u0026#34;6. æµ‹è¯• xxxx.com\u0026#34; # è¯»å–ç”¨æˆ·è¾“å…¥ read -p \u0026#34;è¯·è¾“æ‚¨çš„é€‰æ‹©: \u0026#34; choice # æ ¹æ®ç”¨æˆ·è¾“å…¥é€‰æ‹©å¯¹åº”çš„æ“ä½œ case $choice in 1) prod_fujfu ;; 2) uat_fujfu ;; 3) prod_xxxx ;; 4) uat_xxxx ;; 5) prod_mumugz ;; 6) uat_mumugz ;; *) echo \u0026#34;æ— æ•ˆçš„é€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥\u0026#34; ;; esac } # è°ƒç”¨ä¸»å‡½æ•° main ","date":"2023-03-21T10:45:13Z","image":"https://www.ownit.top/title_pic/16.jpg","permalink":"https://www.ownit.top/p/202303211045/","title":"PythonåŸŸåè§£æ"},{"content":"Prometheus å’Œ Grafana ç›‘æ§ Consul ç®€ä»‹ Consulæ˜¯ä¸€æ¬¾å¸¸ç”¨çš„æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†å·¥å…·ï¼Œå¯ä»¥å¾ˆå¥½åœ°ç®¡ç†å’Œå‘ç°åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æœåŠ¡å’Œå®ä¾‹ã€‚è€ŒPrometheusæ˜¯ä¸€æ¬¾å¸¸ç”¨çš„å¼€æºç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿï¼Œå¯ä»¥ç›‘æ§å„ç§ä¸åŒçš„ç³»ç»Ÿç»„ä»¶å¹¶è¿›è¡Œå‘Šè­¦å’Œåˆ†æã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨Prometheusç›‘æ§ConsulæœåŠ¡ç«¯ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†å’Œåˆ†æConsulé›†ç¾¤çš„è¿è¡Œæƒ…å†µã€‚\nå®‰è£…ConuslæœåŠ¡ç«¯ Conuslç‰ˆæœ¬ï¼šConsul v1.5.3\n1ã€é¦–å…ˆä»å®˜æ–¹ç½‘ç«™ï¼ˆhttps://www.consul.io/downloads.htmlï¼‰ä¸‹è½½é€‚ç”¨äºæ‚¨çš„æ“ä½œç³»ç»Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚\n2ã€è§£å‹ç¼©ä¸‹è½½çš„æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œåœ¨Linuxä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è§£å‹ç¼©ï¼š\n1 unzip consul_1.x.x_linux_amd64.zip 3ã€å°†è§£å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ç§»åŠ¨åˆ°ä¸€ä¸ªç›®å½•ä¸­ï¼Œä¾‹å¦‚/usr/local/binâ€‹ï¼š\n1 sudo mv consul /usr/local/bin/ 4ã€åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥é…ç½®ConsulæœåŠ¡ç«¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 mkdir -p /etc/consul/ \u0026amp;\u0026amp; cd /etc/consul/ [root@bt consul]# cat consul.hcl data_dir = \u0026#34;/var/lib/consul\u0026#34; log_level = \u0026#34;WARN\u0026#34; enable_syslog = true server = true bootstrap = true ui = true datacenter = \u0026#34;ownit\u0026#34; check_update_interval = \u0026#34;0s\u0026#34; bind_addr = \u0026#34;192.168.102.20\u0026#34; client_addr = \u0026#34;192.168.102.20\u0026#34; telemetry { prometheus_retention_time = \u0026#34;24h\u0026#34; #Consulè‡ªå¸¦çš„ç›‘æ§ disable_hostname = true } è¯¥é…ç½®æ–‡ä»¶æŒ‡å®šConsulæœåŠ¡ç«¯åº”è¯¥ä½¿ç”¨çš„æ•°æ®ä¸­å¿ƒã€æ˜¯å¦æ˜¯æœåŠ¡å™¨èŠ‚ç‚¹ï¼ˆserverï¼‰ã€å¯åŠ¨é›†ç¾¤æ—¶æœŸæœ›çš„æœåŠ¡å™¨æ•°é‡ï¼ˆbootstrap_expectï¼‰ã€æ•°æ®å­˜å‚¨ç›®å½•ï¼ˆdata_dirï¼‰ã€æ—¥å¿—çº§åˆ«ï¼ˆlog_levelï¼‰ã€æ˜¯å¦å¯ç”¨syslogï¼ˆenable_syslogï¼‰ã€æ˜¯å¦å¯ç”¨UIï¼ˆuiï¼‰ä»¥åŠHTTPåœ°å€ï¼ˆaddresses.httpï¼‰ã€‚ 5ã€å¯åŠ¨ConsulæœåŠ¡ç«¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 vim /usr/lib/systemd/system/consul.service [Unit] Description=consul-server After=network-online.target [Service] User=consul PIDFile=/var/lib/consul/consul-server.pid ExecStart=/usr/bin/consul agent -config-dir /etc/consul -pid-file /var/lib/consul/consul-server.pid -log-file /var/log/consul/consul-server.log ExecReload=/bin/kill -s SIGHUP $MAINPID ExecStop=/bin/kill -INT $MAINPID [Install] WantedBy=multi-user.target systemctl daemon-reload \u0026amp;\u0026amp; systemctl restart consul Prometheusæ¶æ„ Prometheusç›‘æ§ç³»ç»Ÿç”±ä»¥ä¸‹å‡ ä¸ªä¸»è¦ç»„ä»¶ç»„æˆï¼š\nPrometheus Serverï¼šç”¨äºå­˜å‚¨å’ŒæŸ¥è¯¢ç›‘æ§æŒ‡æ ‡æ•°æ®ã€‚ Exporterï¼šç”¨äºå°†ä¸åŒçš„åº”ç”¨ç¨‹åºã€ç³»ç»Ÿç»„ä»¶æˆ–æœåŠ¡çš„ç›‘æ§æŒ‡æ ‡æ•°æ®è½¬æ¢ä¸ºPrometheuså¯ä»¥å¤„ç†çš„æ ¼å¼ã€‚ Alertmanagerï¼šç”¨äºæ¥æ”¶æ¥è‡ªPrometheus Serverçš„å‘Šè­¦ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œå¤„ç†å’Œå‘é€å‘Šè­¦é€šçŸ¥ã€‚ æ–¹æ³•ä¸€ã€Exporterç›‘æ§ConsulæœåŠ¡ç«¯ è¦å°†ConsulæœåŠ¡ç«¯çš„ç›‘æ§æŒ‡æ ‡æ•°æ®å¯¼å…¥åˆ°Prometheusä¸­ï¼Œå¯ä»¥ä½¿ç”¨Consulçš„å®˜æ–¹Exporteræˆ–ç¬¬ä¸‰æ–¹Exporterã€‚è¿™äº›Exporterå°†Consulçš„è¿è¡ŒæŒ‡æ ‡æ•°æ®æš´éœ²ä¸ºPrometheuså¯ä»¥å¤„ç†çš„æ ¼å¼ã€‚ä¸‹é¢ä»¥å®˜æ–¹Exporterä¸ºä¾‹è¿›è¡Œä»‹ç»ã€‚\nå®‰è£…Consul Exporter å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥ä¸‹è½½Consul Exporterï¼š\n1 wget https://github.com/prometheus/consul_exporter/releases/download/v0.6.0/consul_exporter-0.6.0.linux-amd64.tar.gz é…ç½®Consul Exporter éœ€è¦åˆ›å»ºä¸€ä¸ªsystemdæœåŠ¡æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 vim /usr/lib/systemd/system/consul_exporter.service [Unit] Description=Consul Exporter After=network.target [Service] Type=simple #User=conusl ExecStart=/usr/local/consul_exporter/consul_exporter --consul.server=192.168.102.20:8500 Restart=always [Install] WantedBy=multi-user.target systemctl daemon-reload \u0026amp;\u0026amp; systemctl restart consul_exporter systemctl status consul_exporter è®¿é—®åœ°å€ï¼š http://192.168.102.20:9107/metrics\n3ã€é…ç½®prometheusæ–‡ä»¶ 1 2 3 4 5 - job_name: \u0026#39;consul\u0026#39; scrape_interval: 10s scrape_timeout: 10s static_configs: - targets: [\u0026#39;192.168.102.20:9107\u0026#39;] 4ã€grafanaå¯¼å…¥æ¨¡æ¿ https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/custom-consul-grafana-dashboard.json\nhttps://grafana.com/grafana/dashboards/12049-consul-exporter-dashboard/\nâ€\næ–¹æ³•äºŒã€ConsulæœåŠ¡ç«¯è‡ªå¸¦ç›‘æ§ 1ã€é…ç½®Consul 1 2 3 4 telemetry { prometheus_retention_time = \u0026#34;24h\u0026#34; #Consulè‡ªå¸¦çš„ç›‘æ§ disable_hostname = true } 2ã€prometheusé…ç½® 1 2 3 4 5 6 7 8 9 10 11 - job_name: consul-server honor_timestamps: true scrape_interval: 15s scrape_timeout: 10s metrics_path: \u0026#39;/v1/agent/metrics\u0026#39; scheme: http params: format: [\u0026#34;prometheus\u0026#34;] static_configs: - targets: - 192.168.102.20:8500 3ã€grafanaé…ç½® https://grafana.com/grafana/dashboards/2351-consul/\nç‚¹å‡»å·¦ä¾§+â€‹æŒ‰é’®ï¼Œé€‰æ‹© importâ€‹ï¼Œè¾“å…¥Dashboard IDä¸º 10642â€‹ï¼Œé€‰æ‹©Prometheusä¸ºåˆšæ‰æ·»åŠ çš„æ•°æ®æºï¼Œç‚¹å‡»Importåå³å¯çœ‹åˆ°ç›‘æ§é¢æ¿\n","date":"2023-03-17T10:57:56Z","image":"https://www.ownit.top/title_pic/41.jpg","permalink":"https://www.ownit.top/p/202303171057/","title":"Prometheus å’Œ Grafana ç›‘æ§ ConsulæœåŠ¡ç«¯"},{"content":"åŸç† Spring Bootæ˜¯ä¸€ä¸ªåŸºäºSpringæ¡†æ¶çš„å¿«é€Ÿå¼€å‘åº”ç”¨ç¨‹åºçš„æ¡†æ¶ï¼Œå…¶æä¾›äº†è®¸å¤šå¼€ç®±å³ç”¨çš„ç»„ä»¶å’Œè‡ªåŠ¨é…ç½®é€‰é¡¹ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å¿«é€Ÿæ„å»ºé«˜æ•ˆä¸”åŠŸèƒ½å¼ºå¤§çš„åº”ç”¨ç¨‹åºã€‚Consulæ˜¯ä¸€ç§æœåŠ¡å‘ç°å’Œé…ç½®å·¥å…·ï¼Œå®ƒå¯ä»¥ç®¡ç†å’Œå‘ç°æœåŠ¡ï¼Œè¿˜æä¾›äº†ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œä¾‹å¦‚å¥åº·æ£€æŸ¥ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»ç­‰ã€‚\nåœ¨æœ¬åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Spring Bootæ¡†æ¶åˆ›å»ºäº†æ¶ˆè´¹è€…å’Œæä¾›è€…ä¸¤ä¸ªæ¨¡å—ï¼Œå¹¶å°†å®ƒä»¬æ³¨å†Œåˆ°Consulé›†ç¾¤ä¸­ã€‚å½“æ¶ˆè´¹è€…éœ€è¦è®¿é—®æä¾›è€…æ—¶ï¼Œå®ƒå°†ä»Consulä¸­è·å–æä¾›è€…çš„IPåœ°å€å’Œç«¯å£ï¼Œå¹¶é€šè¿‡è¿™äº›ä¿¡æ¯å»ºç«‹è¿æ¥æ¥è¿›è¡Œé€šä¿¡ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°åŸºäºConsulçš„æœåŠ¡å‘ç°å’Œè°ƒç”¨ã€‚\nä¼˜åŠ¿ ä½¿ç”¨Spring Bootå’ŒConsulçš„ç»„åˆæœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜åŠ¿ï¼š\nå¿«é€Ÿå¼€å‘ï¼šSpring Bootæä¾›äº†ä¸°å¯Œçš„è‡ªåŠ¨é…ç½®é€‰é¡¹ï¼Œå¯ä»¥å¤§å¤§åŠ å¿«å¼€å‘é€Ÿåº¦ã€‚åŒæ—¶ï¼ŒConsulæä¾›äº†é›†æˆå¼çš„æœåŠ¡å‘ç°å’Œé…ç½®ï¼Œå¯ä»¥ä½¿å¾—æœåŠ¡æ³¨å†Œå’Œè°ƒç”¨å˜å¾—æ›´åŠ ç®€å•ã€‚\né«˜å¯ç”¨æ€§ï¼šConsulå¯ä»¥è‡ªåŠ¨æ£€æµ‹æœåŠ¡çš„å¥åº·çŠ¶æ€ï¼Œå¹¶åœ¨å‘ç°å¼‚å¸¸æ—¶è‡ªåŠ¨è¿›è¡Œæ•…éšœè½¬ç§»ï¼Œä¿è¯æœåŠ¡çš„é«˜å¯ç”¨æ€§ã€‚\nè´Ÿè½½å‡è¡¡ï¼šConsulå¯ä»¥æ ¹æ®æœåŠ¡çš„è´Ÿè½½æƒ…å†µè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œç¡®ä¿è¯·æ±‚å¯ä»¥å¹³å‡åˆ†å¸ƒåˆ°ä¸åŒçš„æä¾›è€…ä¸Šï¼Œä»è€Œæé«˜æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½å’Œå¯é æ€§ã€‚\nå¯æ‰©å±•æ€§ï¼šä½¿ç”¨Consulå¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰©å±•æœåŠ¡ï¼Œåªéœ€è¦å°†æ–°çš„æœåŠ¡æ³¨å†Œåˆ°Consulé›†ç¾¤ä¸­å³å¯ã€‚\nç¼ºç‚¹ ä½¿ç”¨Spring Bootå’ŒConsulçš„ç»„åˆä¹Ÿæœ‰ä»¥ä¸‹ä¸€äº›ç¼ºç‚¹ï¼š\nå¤æ‚æ€§ï¼šä½¿ç”¨Consuléœ€è¦ä¸€äº›é…ç½®å’Œç®¡ç†å·¥ä½œï¼Œéœ€è¦èŠ±è´¹ä¸€å®šçš„ç²¾åŠ›å»ç†è§£å’ŒæŒæ¡å…¶å·¥ä½œåŸç†ã€‚\nä¾èµ–æ€§ï¼šä½¿ç”¨Consuléœ€è¦ä¾èµ–äºç¬¬ä¸‰æ–¹å·¥å…·ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ä¾èµ–æ€§é—®é¢˜ã€‚\nå®‰å…¨æ€§ï¼šä½¿ç”¨Consuléœ€è¦è€ƒè™‘ä¸€äº›å®‰å…¨æ€§é—®é¢˜ï¼Œä¾‹å¦‚å¦‚ä½•ä¿æŠ¤æœåŠ¡çš„è®¿é—®æƒé™ç­‰ã€‚\næµç¨‹ ä½¿ç”¨Spring Bootå’ŒConsulçš„ç»„åˆå®ç°æœåŠ¡æ³¨å†Œå’Œå‘ç°çš„æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š\næ¶ˆè´¹è€…å¯åŠ¨æ—¶å‘Consulæ³¨å†Œä¸­å¿ƒå‘é€æ³¨å†Œè¯·æ±‚ï¼Œå¹¶å°†è‡ªå·±çš„æœåŠ¡ä¿¡æ¯æ³¨å†Œåˆ°Consulä¸­å¿ƒã€‚ æä¾›è€…å¯åŠ¨æ—¶ä¹Ÿå‘Consulæ³¨å†Œä¸­å¿ƒå‘é€æ³¨å†Œè¯·æ±‚ï¼Œå¹¶å°†è‡ªå·±çš„æœåŠ¡ä¿¡æ¯æ³¨å†Œåˆ°Consulä¸­å¿ƒã€‚ æ¶ˆè´¹è€…éœ€è¦è°ƒç”¨æä¾›è€…æ—¶ï¼Œä»Consulæ³¨å†Œä¸­å¿ƒè·å–æä¾›è€…çš„IPåœ°å€å’Œç«¯å£ã€‚ æ¶ˆè´¹è€…æ ¹æ®æä¾›è€…çš„IPåœ°å€å’Œç«¯å£å»ºç«‹è¿æ¥ï¼Œå¹¶è¿›è¡Œé€šä¿¡ã€‚ Consulå¯ä»¥æ ¹æ®æœåŠ¡çš„è´Ÿè½½æƒ…å†µè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œç¡®ä¿è¯·æ±‚å¯ä»¥å¹³å‡åˆ†å¸ƒåˆ°ä¸åŒçš„æä¾›è€…ä¸Š éƒ¨ç½² ä½¿ç”¨Spring Bootå’ŒConsulçš„ç»„åˆå®ç°æœåŠ¡æ³¨å†Œå’Œå‘ç°çš„éƒ¨ç½²å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š\nå®‰è£…Consulé›†ç¾¤ï¼šé¦–å…ˆéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…å’Œé…ç½®Consulé›†ç¾¤ã€‚å¯ä»¥ä»Consulå®˜ç½‘ä¸‹è½½å®‰è£…åŒ…ï¼Œå¹¶æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è¿›è¡Œå®‰è£…å’Œé…ç½®ã€‚\nåˆ›å»ºæä¾›è€…æœåŠ¡ï¼šä½¿ç”¨Spring Bootæ¡†æ¶åˆ›å»ºæä¾›è€…æœåŠ¡ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°Consulé›†ç¾¤ä¸­ã€‚\nåˆ›å»ºæ¶ˆè´¹è€…æœåŠ¡ï¼šåŒæ ·ä½¿ç”¨Spring Bootæ¡†æ¶åˆ›å»ºæ¶ˆè´¹è€…æœåŠ¡ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°Consulé›†ç¾¤ä¸­ã€‚\næµ‹è¯•æœåŠ¡ï¼šé€šè¿‡è°ƒç”¨æ¶ˆè´¹è€…æœåŠ¡æ¥æµ‹è¯•æ•´ä¸ªç³»ç»Ÿçš„åŠŸèƒ½å’Œæ€§èƒ½ã€‚\nä»£ç ï¼šGitHub - nangongchengfeng/consul-item: SpringBoot å¼€å‘å¤šä¸ªæ¨¡å—ï¼Œä½¿ç”¨consulè¿›è¡Œé€šä¿¡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 HTTP GET http: //172.20.28.82:8080/actuator/health: 200 Output: { \u0026#34;status\u0026#34;: \u0026#34;UP\u0026#34;, \u0026#34;components\u0026#34;: { \u0026#34;consul\u0026#34;: { \u0026#34;status\u0026#34;: \u0026#34;UP\u0026#34;, \u0026#34;details\u0026#34;: { \u0026#34;leader\u0026#34;: \u0026#34;192.168.102.20:8300\u0026#34;, \u0026#34;services\u0026#34;: { \u0026#34;ConsumerServer\u0026#34;: [], \u0026#34;ProviderServer\u0026#34;: [], \u0026#34;consul\u0026#34;: [], \u0026#34;heian\u0026#34;: [], \u0026#34;maple\u0026#34;: [], \u0026#34;nginx\u0026#34;: [] } } }, \u0026#34;discoveryComposite\u0026#34;: { \u0026#34;status\u0026#34;: \u0026#34;UP\u0026#34;, \u0026#34;components\u0026#34;: { \u0026#34;discoveryClient\u0026#34;: { \u0026#34;status\u0026#34;: \u0026#34;UP\u0026#34;, \u0026#34;details\u0026#34;: { \u0026#34;services\u0026#34;: [\u0026#34;ConsumerServer\u0026#34;, \u0026#34;ProviderServer\u0026#34;, \u0026#34;consul\u0026#34;, \u0026#34;heian\u0026#34;, \u0026#34;maple\u0026#34;, \u0026#34;nginx\u0026#34;] } } } }, \u0026#34;diskSpace\u0026#34;: { \u0026#34;status\u0026#34;: \u0026#34;UP\u0026#34;, \u0026#34;details\u0026#34;: { \u0026#34;total\u0026#34;: 76454166528, \u0026#34;free\u0026#34;: 63628378112, \u0026#34;threshold\u0026#34;: 10485760, \u0026#34;exists\u0026#34;: true } }, \u0026#34;livenessState\u0026#34;: { \u0026#34;status\u0026#34;: \u0026#34;UP\u0026#34; }, \u0026#34;ping\u0026#34;: { \u0026#34;status\u0026#34;: \u0026#34;UP\u0026#34; }, \u0026#34;readinessState\u0026#34;: { \u0026#34;status\u0026#34;: \u0026#34;UP\u0026#34; }, \u0026#34;refreshScope\u0026#34;: { \u0026#34;status\u0026#34;: \u0026#34;UP\u0026#34; } }, \u0026#34;groups\u0026#34;: [\u0026#34;liveness\u0026#34;, \u0026#34;readiness\u0026#34;] } æ¶æ„ ä½¿ç”¨Spring Bootå’ŒConsulçš„ç»„åˆå®ç°æœåŠ¡æ³¨å†Œå’Œå‘ç°çš„æ¶æ„å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªå±‚æ¬¡ï¼š\nåº”ç”¨å±‚ï¼šåº”ç”¨å±‚åŒ…æ‹¬æä¾›è€…å’Œæ¶ˆè´¹è€…ä¸¤ä¸ªæœåŠ¡ï¼Œå®ƒä»¬ä½¿ç”¨Spring Bootæ¡†æ¶å®ç°ã€‚\næœåŠ¡å‘ç°å±‚ï¼šæœåŠ¡å‘ç°å±‚ç”±Consulå®ç°ï¼Œå®ƒè´Ÿè´£ç®¡ç†å’Œå‘ç°æœåŠ¡ï¼ŒåŒæ—¶æä¾›å¥åº·æ£€æŸ¥ã€è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½ã€‚\né€šä¿¡å±‚ï¼šé€šä¿¡å±‚è´Ÿè´£æä¾›è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„é€šä¿¡ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„é€šä¿¡åè®®å’Œæ¡†æ¶å®ç°ã€‚\næ•°æ®å±‚ï¼šæ•°æ®å±‚è´Ÿè´£æä¾›æ•°æ®å­˜å‚¨å’Œè®¿é—®æœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨å„ç§æ•°æ®åº“å’Œæ•°æ®å­˜å‚¨æŠ€æœ¯å®ç°ã€‚\nåº”ç”¨è¶‹åŠ¿ éšç€å¾®æœåŠ¡æ¶æ„çš„å‘å±•ï¼ŒæœåŠ¡æ³¨å†Œå’Œå‘ç°æˆä¸ºäº†è¶Šæ¥è¶Šé‡è¦çš„ä¸€ç¯ã€‚ä½¿ç”¨Spring Bootå’ŒConsulçš„ç»„åˆå®ç°æœåŠ¡æ³¨å†Œå’Œå‘ç°å¯ä»¥æé«˜ç³»ç»Ÿçš„å¯é æ€§å’Œå¯æ‰©å±•æ€§ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æé«˜å¼€å‘æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒã€‚å› æ­¤ï¼Œé¢„è®¡è¯¥æŠ€æœ¯ç»„åˆåœ¨æœªæ¥ä¼šå¾—åˆ°æ›´å¹¿æ³›çš„åº”ç”¨ã€‚\n","date":"2023-03-16T16:12:05Z","image":"https://www.ownit.top/title_pic/70.jpg","permalink":"https://www.ownit.top/p/202303161612/","title":"ä½¿ç”¨Spring Bootå’ŒConsulå®ç°é«˜å¯ç”¨çš„æœåŠ¡æ³¨å†Œä¸å‘ç°"},{"content":"Consulæ˜¯ä»€ä¹ˆ Consulæ˜¯ä¸€ä¸ªåŸºäºHTTPçš„æœåŠ¡å‘ç°å·¥å…·ï¼Œç”¨äºé…ç½®å’Œç®¡ç†ç³»ç»Ÿå’ŒæœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚å®ƒæä¾›äº†ä¸€ä¸ªç®€å•çš„æ–¹å¼æ¥æ³¨å†Œã€å‘ç°å’Œé…ç½®æœåŠ¡ï¼Œå¹¶åŒ…æ‹¬å¥åº·æ£€æŸ¥ã€è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»ç­‰åŠŸèƒ½ã€‚\nConsulæ˜¯ä¸€ç§åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç”¨äºåœ¨å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°æœåŠ¡å‘ç°å’Œé…ç½®å…±äº«ã€‚å®ƒä½¿ç”¨Raftåè®®æ¥å®ç°å¼ºä¸€è‡´æ€§ï¼Œä¿è¯äº†åœ¨å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´è¿›è¡Œçš„æ•°æ®æ›´æ–°çš„åŸå­æ€§ã€‚\nConsulå®¢æˆ·ç«¯å¯ä»¥å°†å®ƒä»¬è‡ªå·±çš„æœåŠ¡ä¿¡æ¯æ³¨å†Œåˆ°ConsulæœåŠ¡å™¨ã€‚è¿™æ ·ï¼ŒConsulæœåŠ¡å™¨å°†è‡ªåŠ¨æˆä¸ºæ‰€æœ‰æœåŠ¡çš„æœåŠ¡ç›®å½•ã€‚æ­¤å¤–ï¼ŒConsulè¿˜æä¾›äº†ä¸€ä¸ªå¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œä»¥ç¡®ä¿å·²æ³¨å†Œçš„æœåŠ¡ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚\nå½“ä¸€ä¸ªå®¢æˆ·ç«¯æƒ³è¦è°ƒç”¨ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œå®ƒå¯ä»¥ä»ConsulæœåŠ¡å™¨è·å–æœåŠ¡çš„ç½‘ç»œä½ç½®ä¿¡æ¯ã€‚ç„¶åï¼Œå®¢æˆ·ç«¯å°†ä½¿ç”¨æ­¤ä¿¡æ¯å»ºç«‹ä¸æœåŠ¡çš„ç½‘ç»œè¿æ¥ã€‚\nConsulé€šè¿‡HTTP APIå…¬å¼€å…¶æœåŠ¡å‘ç°å’Œé…ç½®å…±äº«åŠŸèƒ½ï¼Œè¿™ä½¿å¾—ä½¿ç”¨Consulä¸å…¶ä»–ç³»ç»Ÿç›¸å½“å®¹æ˜“ï¼Œå¦‚Kubernetesç­‰å®¹å™¨ç¼–æ’å·¥å…·ã€‚\næ€»ä¹‹ï¼ŒConsulçš„åˆ†å¸ƒå¼æ³¨å†ŒåŸç†æ˜¯é€šè¿‡æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„äº¤äº’æ¥å®ç°æœåŠ¡å‘ç°å’Œå¥åº·æ£€æŸ¥ã€‚å®¢æˆ·ç«¯å°†æœåŠ¡ä¿¡æ¯æ³¨å†Œåˆ°ConsulæœåŠ¡å™¨ï¼Œç„¶åä»ConsulæœåŠ¡å™¨è·å–æœåŠ¡ä¿¡æ¯å¹¶å»ºç«‹ç½‘ç»œè¿æ¥ã€‚Consulä½¿ç”¨Raftåè®®ç¡®ä¿å¼ºä¸€è‡´æ€§ï¼Œå¹¶æä¾›HTTP APIè¿›è¡Œè®¿é—®ã€‚\nConsulåŸç† Consulé‡‡ç”¨çš„æ˜¯é›†ä¸­å¼çš„æ³¨å†Œä¸­å¿ƒæ¶æ„ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæœåŠ¡å‘ç°ç»„ä»¶å’Œä¸€ä¸ªKVå­˜å‚¨ç»„ä»¶ã€‚\næœåŠ¡å‘ç°ç»„ä»¶ï¼šConsulä¸­çš„æœåŠ¡å‘ç°æ˜¯é€šè¿‡ä¸€ç»„Agentå’ŒServerå®ç°çš„ã€‚Agentæ˜¯æ¯ä¸ªä¸»æœºä¸Šè¿è¡Œçš„ä»£ç†ï¼Œç”¨äºä¸æœåŠ¡äº¤äº’å¹¶æŠ¥å‘Šæœ¬åœ°è¿è¡ŒçŠ¶å†µã€‚Serveræ˜¯è´Ÿè´£åœ¨Consulé›†ç¾¤ä¸­è¿è¡ŒRaftç®—æ³•çš„èŠ‚ç‚¹ï¼Œä»¥å®ç°é«˜å¯ç”¨æ€§ã€‚\nå½“æœåŠ¡å¯åŠ¨æ—¶ï¼Œå®ƒä¼šå‘æœ¬åœ°çš„Consul Agentå‘é€ä¸€ä¸ªæœåŠ¡æ³¨å†Œè¯·æ±‚ï¼ŒAgentä¼šå°†æœåŠ¡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼ˆæœåŠ¡åã€åœ°å€ã€ç«¯å£ç­‰ï¼‰æ³¨å†Œåˆ°Consulçš„KVå­˜å‚¨ä¸­ã€‚æœåŠ¡æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡å‘Agentå‘é€æœåŠ¡å‘ç°è¯·æ±‚æ¥è·å–æœåŠ¡çš„åœ°å€å’Œç«¯å£ä¿¡æ¯ï¼Œç„¶åå‘è¯¥åœ°å€å‘é€è¯·æ±‚ä»¥è°ƒç”¨æœåŠ¡ã€‚\nKVå­˜å‚¨ç»„ä»¶ï¼šConsulä¸­çš„KVå­˜å‚¨ç»„ä»¶ç”¨äºå­˜å‚¨é”®å€¼å¯¹ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºå­˜å‚¨ä»»ä½•æ•°æ®ã€‚åœ¨æœåŠ¡æ³¨å†Œå’Œå‘ç°ä¸­ï¼ŒæœåŠ¡å…ƒæ•°æ®ä¿¡æ¯å°±æ˜¯å­˜å‚¨åœ¨KVå­˜å‚¨ä¸­çš„ã€‚\nå½“æœåŠ¡å¯åŠ¨æ—¶ï¼Œå®ƒä¼šå°†è‡ªå·±çš„å…ƒæ•°æ®ä¿¡æ¯å­˜å‚¨åˆ°Consulçš„KVå­˜å‚¨ä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šå®šæœŸå‘é€å¿ƒè·³è¯·æ±‚å‘Šè¯‰ConsulæœåŠ¡è¿˜åœ¨è¿è¡Œã€‚å½“æœåŠ¡ç»ˆæ­¢æ—¶ï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªæ³¨é”€è¯·æ±‚å‘Šè¯‰Consulå°†æœåŠ¡ä»KVå­˜å‚¨ä¸­åˆ é™¤ã€‚\næœåŠ¡æ¶ˆè´¹è€…å¯ä»¥ä»Consulçš„KVå­˜å‚¨ä¸­è·å–æœåŠ¡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œç„¶åä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥è°ƒç”¨æœåŠ¡ã€‚åŒæ—¶ï¼ŒæœåŠ¡æ¶ˆè´¹è€…ä¹Ÿå¯ä»¥ç›‘å¬KVå­˜å‚¨ä¸­å…ƒæ•°æ®ä¿¡æ¯çš„å˜åŒ–ï¼Œå½“æœåŠ¡çš„å…ƒæ•°æ®ä¿¡æ¯å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨æ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚\næ€»ä½“æ¥è¯´ï¼ŒConsulçš„æœåŠ¡æ³¨å†Œå’Œå‘ç°è¿‡ç¨‹å¦‚ä¸‹ï¼š\næœåŠ¡å¯åŠ¨æ—¶ï¼Œå°†è‡ªå·±çš„å…ƒæ•°æ®ä¿¡æ¯æ³¨å†Œåˆ°Consulçš„KVå­˜å‚¨ä¸­ï¼ŒåŒæ—¶å‘æœ¬åœ°çš„Consul Agentå‘é€å¿ƒè·³è¯·æ±‚å‘Šè¯‰ConsulæœåŠ¡è¿˜åœ¨è¿è¡Œã€‚ æœåŠ¡æ¶ˆè´¹è€…å‘Consul Agentå‘é€æœåŠ¡å‘ç°è¯·æ±‚ï¼ŒAgentä»KVå­˜å‚¨ä¸­è·å–æœåŠ¡çš„å…ƒæ•°æ®ä¿¡æ¯å¹¶è¿”å›ç»™æœåŠ¡æ¶ˆè´¹è€…ã€‚ æœåŠ¡æ¶ˆè´¹è€…ä½¿ç”¨è·å–åˆ°çš„æœåŠ¡å…ƒæ•°æ®ä¿¡æ¯æ¥è°ƒç”¨æœåŠ¡ã€‚ å½“æœåŠ¡ç»ˆæ­¢æ—¶ï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªæ³¨é”€è¯·æ±‚å‘Šè¯‰Consulå°†æœåŠ¡ä»KVå­˜å‚¨ä¸­åˆ é™¤ã€‚ å¯åŠ¨ Consul é›†ç¾¤ 1 2 3 4 5 6 7 8 9 10 11 #å¯åŠ¨ç¬¬1ä¸ªServerèŠ‚ç‚¹ï¼Œé›†ç¾¤è¦æ±‚è¦æœ‰3ä¸ªServerï¼Œå°†å®¹å™¨8500ç«¯å£æ˜ å°„åˆ°ä¸»æœº8900ç«¯å£ï¼ŒåŒæ—¶å¼€å¯ç®¡ç†ç•Œé¢Â dockerÂ runÂ -dÂ --name=consul1Â -pÂ 8900:8500Â -eÂ CONSUL_BIND_INTERFACE=eth0Â consulÂ agentÂ --server=trueÂ --bootstrap-expect=3Â --client=0.0.0.0Â -uiÂ #å¯åŠ¨ç¬¬2ä¸ªServerèŠ‚ç‚¹ï¼Œå¹¶åŠ å…¥é›†ç¾¤Â dockerÂ runÂ -dÂ --name=consul2Â -eÂ CONSUL_BIND_INTERFACE=eth0Â consulÂ agentÂ --server=trueÂ --client=0.0.0.0Â --joinÂ 172.17.0.2Â #å¯åŠ¨ç¬¬3ä¸ªServerèŠ‚ç‚¹ï¼Œå¹¶åŠ å…¥é›†ç¾¤Â dockerÂ runÂ -dÂ --name=consul3Â -eÂ CONSUL_BIND_INTERFACE=eth0Â consulÂ agentÂ --server=trueÂ --client=0.0.0.0Â --joinÂ 172.17.0.2Â #å¯åŠ¨ç¬¬4ä¸ªClientèŠ‚ç‚¹ï¼Œå¹¶åŠ å…¥é›†ç¾¤Â dockerÂ runÂ -dÂ --name=consul4Â -eÂ CONSUL_BIND_INTERFACE=eth0Â consulÂ agentÂ --server=falseÂ --client=0.0.0.0Â --joinÂ 172.17.0.2Â ç¬¬ 1 ä¸ªå¯åŠ¨å®¹å™¨çš„ IP ä¸€èˆ¬æ˜¯ 172.17.0.2ï¼Œåè¾¹å¯åŠ¨çš„å‡ ä¸ªå®¹å™¨ IP ä¼šæ’ç€æ¥ï¼š172.17.0.3ã€172.17.0.4ã€172.17.0.5ã€‚\nè¿™äº› Consul èŠ‚ç‚¹åœ¨ Docker çš„å®¹å™¨å†…æ˜¯äº’é€šçš„ï¼Œä»–ä»¬é€šè¿‡æ¡¥æ¥çš„æ¨¡å¼é€šä¿¡ã€‚ä½†æ˜¯å¦‚æœä¸»æœºè¦è®¿é—®å®¹å™¨å†…çš„ç½‘ç»œï¼Œéœ€è¦åšç«¯å£æ˜ å°„ã€‚\nåœ¨å¯åŠ¨ç¬¬ä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå°† Consul çš„ 8500 ç«¯å£æ˜ å°„åˆ°äº†ä¸»æœºçš„ 8900 ç«¯å£ï¼Œè¿™æ ·å°±å¯ä»¥æ–¹ä¾¿çš„é€šè¿‡ä¸»æœºçš„æµè§ˆå™¨æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ã€‚\nkubernetesé›†æˆConsul Kubernetesä¸­çš„ä¸€ä¸ªPodä¸­å¯ä»¥åŒ…å«å¤šä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨å¯ä»¥ååŒå·¥ä½œï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„æœåŠ¡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸€ä¸ªPodä¸­åŒ…å«äº†ä¸‰ä¸ªå®¹å™¨ï¼šConsulå®¢æˆ·ç«¯å®¹å™¨ã€Javaåº”ç”¨å®¹å™¨å’ŒFilebeatå®¹å™¨ã€‚\nConsulå®¢æˆ·ç«¯å®¹å™¨æ˜¯ç”¨æ¥å‘Kubernetesé›†ç¾¤å¤–çš„ConsulæœåŠ¡å™¨æ³¨å†ŒæœåŠ¡çš„ã€‚Consulå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡APIæˆ–DNSæ¥å£ä¸ConsulæœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œå°†æœåŠ¡æ³¨å†Œä¿¡æ¯å‘é€ç»™ConsulæœåŠ¡å™¨ï¼ŒåŒ…æ‹¬æœåŠ¡çš„åç§°ã€IPåœ°å€ã€ç«¯å£å·ç­‰å…ƒæ•°æ®ä¿¡æ¯ã€‚\nJavaåº”ç”¨å®¹å™¨æ˜¯ç”¨æ¥è¿è¡Œä¸šåŠ¡åº”ç”¨ç¨‹åºçš„ã€‚å®ƒä¼šé€šè¿‡Consulå®¢æˆ·ç«¯å®¹å™¨ä¸­çš„APIæˆ–DNSæ¥å£æŸ¥è¯¢æœåŠ¡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬IPåœ°å€å’Œç«¯å£å·ï¼Œä»¥ä¾¿èƒ½å¤Ÿä¸å…¶å®ƒæœåŠ¡é€šä¿¡ã€‚\nFilebeatå®¹å™¨åˆ™æ˜¯ç”¨æ¥æ”¶é›†Javaåº”ç”¨ç¨‹åºçš„æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶å°†å…¶å‘é€åˆ°æŒ‡å®šçš„æ—¥å¿—æœåŠ¡å™¨è¿›è¡Œå¤„ç†å’Œå­˜å‚¨ã€‚\nä¸‹é¢æ˜¯å¤§è‡´çš„æ¶æ„å›¾ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 +---------------------+ | Consul Server | | (é›†ç¾¤å¤–çš„ConsulæœåŠ¡å™¨) | +---------------------+ | | HTTP/DNS API | +---------------------+ | Consul Client | | (Podä¸­çš„å®¹å™¨) | +---------------------+ / \\ / \\ / \\ HTTP/DNS API | HTTP API +-------+ | +--------+ | Java | | | File- | | App |\u0026lt;------+------\u0026gt;| beat | | | | | +-------+ +--------+ åœ¨è¿™ä¸ªæ¶æ„å›¾ä¸­ï¼ŒJavaåº”ç”¨å®¹å™¨å’ŒFilebeatå®¹å™¨éƒ½ä¸Consulå®¢æˆ·ç«¯å®¹å™¨é€šè¿‡HTTP/DNS APIè¿›è¡Œé€šä¿¡ã€‚Javaåº”ç”¨å®¹å™¨ä½¿ç”¨Consulå®¢æˆ·ç«¯å®¹å™¨æä¾›çš„æœåŠ¡æ³¨å†Œä¿¡æ¯ä¸å…¶å®ƒæœåŠ¡è¿›è¡Œé€šä¿¡ï¼ŒFilebeatå®¹å™¨åˆ™é€šè¿‡HTTP APIå°†æ”¶é›†çš„æ—¥å¿—æ–‡ä»¶å‘é€åˆ°æŒ‡å®šçš„æ—¥å¿—æœåŠ¡å™¨ã€‚Consulå®¢æˆ·ç«¯å®¹å™¨é€šè¿‡HTTP APIå°†æœåŠ¡æ³¨å†Œä¿¡æ¯å‘é€ç»™Kubernetesé›†ç¾¤å¤–çš„ConsulæœåŠ¡å™¨ï¼Œä»¥ä¾¿å…¶å®ƒæœåŠ¡å¯ä»¥å‘ç°å’Œä½¿ç”¨å®ƒä»¬ã€‚\nä»¥ä¸‹æ˜¯ Java åº”ç”¨é€šè¿‡ Consul å®¢æˆ·ç«¯æ³¨å†Œåˆ° Consul æœåŠ¡ç«¯çš„è¯¦ç»†æ­¥éª¤æµç¨‹ï¼š\nPod ä¸­çš„ Consul å®¢æˆ·ç«¯å¯åŠ¨ï¼Œå¹¶å‘ Consul é›†ç¾¤å‘ç°æœåŠ¡è¯·æ±‚ã€‚\nConsul å®¢æˆ·ç«¯ä¼šå‘ Consul æœåŠ¡ç«¯çš„ä»»ä¸€èŠ‚ç‚¹å‘å‡ºæ³¨å†Œè¯·æ±‚ï¼Œå‘ŠçŸ¥å®ƒæ‰€åœ¨çš„æœåŠ¡åç§°ã€IP åœ°å€ã€ç«¯å£å·ã€æ ‡ç­¾ç­‰ä¿¡æ¯ï¼Œä»¥åŠè¯¥æœåŠ¡çš„å¥åº·æ£€æŸ¥è§„åˆ™ã€‚\nConsul æœåŠ¡ç«¯æ¥æ”¶åˆ°æ³¨å†Œè¯·æ±‚åï¼Œä¼šå°†è¯¥æœåŠ¡ä¿¡æ¯å­˜å‚¨åœ¨æœ¬åœ°çš„ KV å­˜å‚¨ä¸­ï¼Œå¹¶å°†è¯¥æœåŠ¡çš„çŠ¶æ€æ ‡è®°ä¸ºâ€œä¸å¥åº·â€ã€‚\nConsul å®¢æˆ·ç«¯ä¼šæ ¹æ®æ‰€æ³¨å†Œçš„å¥åº·æ£€æŸ¥è§„åˆ™ï¼Œå®šæœŸå‘ Consul æœåŠ¡ç«¯å‘é€å¥åº·æ£€æŸ¥è¯·æ±‚ï¼Œå¹¶æ ¹æ®å“åº”ç»“æœæ›´æ–°æœ¬åœ°çš„æœåŠ¡çŠ¶æ€ã€‚\nå½“è¯¥æœåŠ¡çš„çŠ¶æ€ä¸ºâ€œå¥åº·â€æ—¶ï¼ŒConsul å®¢æˆ·ç«¯ä¼šå°†è¯¥æœåŠ¡çš„çŠ¶æ€ä¿¡æ¯å­˜å‚¨åœ¨æœ¬åœ°çš„ç¼“å­˜ä¸­ï¼Œå¹¶å‘æœ¬åœ°çš„ Java åº”ç”¨æä¾›æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚\nJava åº”ç”¨é€šè¿‡è°ƒç”¨ Consul å®¢æˆ·ç«¯æä¾›çš„ APIï¼Œè·å–æ‰€éœ€æœåŠ¡çš„ IP åœ°å€å’Œç«¯å£å·ï¼Œå¹¶é€šè¿‡è¿™äº›ä¿¡æ¯ä¸ç›®æ ‡æœåŠ¡å»ºç«‹è¿æ¥ã€‚\nå¦‚æœéœ€è¦å¯¹è¯¥æœåŠ¡è¿›è¡Œä¿®æ”¹æˆ–æ³¨é”€ï¼ŒJava åº”ç”¨å¯ä»¥å‘ Consul å®¢æˆ·ç«¯å‘é€å¯¹åº”çš„è¯·æ±‚ã€‚\nConsul å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šå°†è¯·æ±‚è½¬å‘ç»™ Consul æœåŠ¡ç«¯ï¼Œå¹¶æ›´æ–°æœ¬åœ°çš„ç¼“å­˜ã€‚\nConsul æœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šæ›´æ–°è¯¥æœåŠ¡åœ¨æœ¬åœ° KV å­˜å‚¨ä¸­çš„ä¿¡æ¯ï¼Œå¹¶å°†è¯¥æœåŠ¡çš„çŠ¶æ€æ ‡è®°ä¸ºâ€œä¸å¥åº·â€ã€‚\nConsul å®¢æˆ·ç«¯ä¼šæ ¹æ®æ‰€æ³¨å†Œçš„å¥åº·æ£€æŸ¥è§„åˆ™ï¼Œå®šæœŸå‘ Consul æœåŠ¡ç«¯å‘é€å¥åº·æ£€æŸ¥è¯·æ±‚ï¼Œå¹¶æ ¹æ®å“åº”ç»“æœæ›´æ–°æœ¬åœ°çš„æœåŠ¡çŠ¶æ€ã€‚\næ€»ä½“æ¶æ„å›¾å¦‚ä¸‹ï¼š\nåœ¨è¯¥æ¶æ„ä¸­ï¼ŒConsul å®¢æˆ·ç«¯å’Œ Java åº”ç”¨éƒ½è¿è¡Œåœ¨ Pod ä¸­ï¼Œå…¶ä¸­ Consul å®¢æˆ·ç«¯è´Ÿè´£æœåŠ¡æ³¨å†Œå’ŒæœåŠ¡å‘ç°ï¼ŒJava åº”ç”¨åˆ™é€šè¿‡ Consul å®¢æˆ·ç«¯è·å–æ‰€éœ€æœåŠ¡çš„ä¿¡æ¯ã€‚åŒæ—¶ï¼ŒFilebeat ç”¨äºæ”¶é›†åº”ç”¨çš„æ—¥å¿—æ•°æ®ï¼Œå¹¶å°†å…¶å‘é€è‡³ç›®æ ‡æ—¥å¿—å­˜å‚¨ç³»ç»Ÿã€‚\nSpringBootæ³¨å†ŒConsul SpringBootå¯ä»¥é€šè¿‡ä½¿ç”¨Consulçš„Javaå®¢æˆ·ç«¯åº“æ¥å®ç°ä¸Consulçš„é›†æˆï¼Œè¯¥åº“æä¾›äº†ä¸°å¯Œçš„APIï¼ŒåŒ…æ‹¬æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°ã€KVå­˜å‚¨ç­‰åŠŸèƒ½ã€‚ä¸‹é¢æ˜¯SpringBootæ³¨å†ŒConsulçš„å¤§è‡´æ­¥éª¤å’ŒåŸç†ï¼š\nå¼•å…¥Consulå®¢æˆ·ç«¯åº“ åœ¨SpringBooté¡¹ç›®çš„pom.xmlä¸­å¼•å…¥Consulå®¢æˆ·ç«¯åº“çš„ä¾èµ–ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;project xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.5.4\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;groupId\u0026gt;com.springboot.demo\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;web-demo\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.0.1-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;web-demo\u0026lt;/name\u0026gt; \u0026lt;description\u0026gt;web-demo\u0026lt;/description\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;java.version\u0026gt;1.8\u0026lt;/java.version\u0026gt; \u0026lt;spring-cloud.version\u0026gt;Finchley.RELEASE\u0026lt;/spring-cloud.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-starter-consul-discovery\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-actuator\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-dependencies\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2020.0.3\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;scope\u0026gt;import\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/dependencyManagement\u0026gt; \u0026lt;/project\u0026gt; 2ã€é…ç½®Consulè¿æ¥ä¿¡æ¯\nåœ¨SpringBooté¡¹ç›®çš„application.ymlæ–‡ä»¶ä¸­é…ç½®Consulçš„è¿æ¥ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 server: port: 1000 spring: application: name: heian cloud: consul: enabled: true host: 192.168.102.20 # æ³¨å†Œä¸­å¿ƒåœ°å€ port: 8500 # æ³¨å†Œä¸­å¿ƒåœ°å€çš„ç«¯å£ discovery: hostname: 192.168.96.19 # æœ¬åœ°ip instance-id: ${spring.application.name}:${spring.cloud.consul.discovery.hostname}:${server.port} #health-check-path: ${server.servlet.context-path}/actuator/health # å¦‚æœé…ç½®äº†context-pathå°±é…ç½®ï¼Œæ²¡æœ‰å°±ä¸é… health-check-interval: 15s # æ¯éš”15såšä¸€æ¬¡å¥åº·æ£€æŸ¥ register: true register-health-check: true service-name: ${spring.application.name} # æ”¾å¼€ç«¯å£ management: endpoints: web: exposure: include: \u0026#34;*\u0026#34; endpoint: health: show-details: always 3ã€å®ç°æœåŠ¡æ³¨å†Œ\nå¯åŠ¨ç±»\n1 2 3 4 5 6 7 8 9 10 @EnableDiscoveryClient @SpringBootApplication public class WebDemoApplication { public static void main(String[] args) { SpringApplication.run(WebDemoApplication.class, args); } } æ§åˆ¶ç±»\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package com.springboot.demo.webdemo.controller; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; import java.util.HashMap; @RestController @RequestMapping(\u0026#34;/employee\u0026#34;) public class EmployeeController { @GetMapping public HashMap\u0026lt;String, String\u0026gt; index(){ HashMap\u0026lt;String, String\u0026gt; hashmap = new HashMap\u0026lt;String, String\u0026gt;(); hashmap.put(\u0026#34;å§“å\u0026#34;, \u0026#34;ç‹äºŒ\u0026#34;); hashmap.put(\u0026#34;å¹´é¾„\u0026#34;, \u0026#34;27\u0026#34;); hashmap.put(\u0026#34;å·¥é¾„\u0026#34;, \u0026#34;6\u0026#34;); return hashmap; } } æ€»ç»“Â Spring Bootåº”ç”¨å¯ä»¥é€šè¿‡å‘Consulæ³¨å†Œè‡ªèº«æ¥å®ç°æœåŠ¡å‘ç°å’Œæ²»ç†ï¼Œä½¿å¾—å…¶ä»–æœåŠ¡å¯ä»¥åœ¨Consulä¸­å‘ç°å¹¶è°ƒç”¨å®ƒã€‚\næ–‡æ¡£ï¼š\nhttps://www.cnblogs.com/qingyunye/p/12932493.html\nä¸€ç¯‡æ–‡ç« äº†è§£ConsulæœåŠ¡å‘ç°å®ç°åŸç† | Harries Blogâ„¢\n","date":"2023-03-15T19:28:27Z","image":"https://www.ownit.top/title_pic/22.jpg","permalink":"https://www.ownit.top/p/202303151928/","title":"SpringBootï¼ˆå¾®æœåŠ¡ï¼‰æ³¨å†Œåˆ†å¸ƒå¼Consul"},{"content":"èƒŒæ™¯ï¼šé˜¿é‡Œäº‘çš„ECSæœåŠ¡å™¨å› ä¸ºé˜¿é‡Œäº‘å‡çº§æ’ä»¶ï¼Œå¯¼è‡´å®‰å…¨é˜²æŠ¤ç¨‹åºé‡å¯ï¼Œäº§ç”Ÿä¸åŒçš„ç«¯å£ã€‚å¯¼è‡´ä½è‡ªåŠ¨å‘ç°æ³¨å†Œçš„ç«¯å£ å¤§é‡æŠ¥è­¦ã€‚\nè§£å†³ï¼šæ€æ‰å…³äºå› ä¸ºéä¸šåŠ¡ å˜æ›´çš„ç«¯å£æ£€æµ‹çš„è§¦å‘å™¨ã€‚\nç›¸å…³æ–‡æ¡£ï¼š\nZabbixç›‘æ§ä¹‹ä¸»æœºç«¯å£ç›‘æ§è‡ªåŠ¨å‘ç°\nzabbixç›‘æ§ç«¯å£åŸç† ä¸€ä¸ªä¸ªå»æ·»åŠ listenç›‘æ§tcpçš„è¯ä¸ç°å®å•Šï¼Œè¿˜æ˜¯ä¹Ÿæè‡ªåŠ¨å‘ç°å§\nåˆ†å‰²ä¸‹æ¥ä¹Ÿæ˜¯2æ­¥å•Š\nç¬¬ä¸€æ­¥è„šæœ¬ä¸¢zabbix-agentä¸‹äº§ç”Ÿè‡ªå®šä¹‰é”®å€¼\nç¬¬äºŒæ­¥ä¸å°±æ˜¯zabbix-serveræ·»åŠ è‡ªåŠ¨å‘ç°ç»‘å®šè¿™ä¸ªé”®å€¼å’¯\nä»€ä¹ˆæ˜¯å®‰éª‘å£«Agentæ’ä»¶ï¼Ÿ\nAgent æ’ä»¶_äº‘å®‰å…¨ä¸­å¿ƒï¼ˆå®‰éª‘å£«ï¼‰-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ\nè§£å†³æ€è·¯ 1ã€æ ¹æ®zabbixçš„api è·å–çš„token\n2ã€æ ¹æ®tokenè·å–åˆ°é—®é¢˜ä¸»æœºçš„è§¦å‘å™¨id\n3ã€æ ¹æ®è§¦å‘å™¨id åˆ é™¤ç›¸å…³çš„è§¦å‘å™¨ï¼Œ\n4ã€æ¶ˆåœå¤§é¢ç§¯çš„å‘Šè­¦\nzabbixç›¸å…³çš„APIæ–‡æ¡£ å¯ä»¥æŸ¥è¯¢å®˜æ–¹æ–‡æ¡£æˆ–è€…åšå®¢\nhttps://www.cnblogs.com/rxysg/p/15700912.htmlÂ Pythonè°ƒç”¨Zabbix APIæ¥å£æ‰¹é‡ä¿®æ”¹ï¼ˆç¦ç”¨/å¯ç”¨ï¼‰è§¦å‘å™¨trigger_å•¥æ˜¯æ¯”äºšçš„æŠ€æœ¯åšå®¢_51CTOåšå®¢\n1ã€è·å–zabbixçš„tokenÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 # -*- coding: utf-8 -*- # @Time : 2023/2/17 16:45 # @Author : å—å®«ä¹˜é£ # @File : zabbix_trigger.py # @Software: PyCharm import json import os import requests url = \u0026#34;http://ip/zabbix/api_jsonrpc.php\u0026#34; # æ­¤å¤„åŸŸåä¿®æ”¹ä¸ºç›¸åº”çš„åœ°å€ headers = { \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json-rpc\u0026#39; } tokens = \u0026#39;97553b7342457602a0a6452f0058c0ed\u0026#39; def token_get(): # æ ¹æ®è´¦å·å¯†ç è·å–token data = { \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;user.login\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;user\u0026#34;: \u0026#34;Admin\u0026#34;, # zabbixç®¡ç†å‘˜ç”¨æˆ·å \u0026#34;password\u0026#34;: \u0026#34;å¯†ç \u0026#34; # è´¦æˆ·å¯†ç  }, \u0026#34;auth\u0026#34;: None, \u0026#34;id\u0026#34;: 1 } json_data = json.dumps(data) req = requests.post(url, data=json_data, headers=headers) js_req = req.json() print(js_req[\u0026#39;result\u0026#39;]) return js_req[\u0026#39;result\u0026#39;] 2ã€è·å–zabbixæœ‰é—®é¢˜ä¸»æœºè§¦å‘å™¨çš„id 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 def hosts_get(token): # è·å–æœ‰é—®é¢˜ä¸»æœºçš„è§¦å‘å™¨id # data = { # \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, # \u0026#34;method\u0026#34;: \u0026#34;host.get\u0026#34;, # \u0026#34;params\u0026#34;: { # \u0026#34;output\u0026#34;: [\u0026#34;hostid\u0026#34;, \u0026#34;name\u0026#34;], # \u0026#34;filter\u0026#34;: { # # ç­›é€‰æ¡ä»¶ # \u0026#34;value\u0026#34;: 1, # valueå€¼ä¸º1è¡¨ç¤ºæœ‰é—®é¢˜ # \u0026#34;status\u0026#34;: 0 # statusä¸º0è¡¨ç¤ºå·²å¯ç”¨çš„trigger # }, # }, # # \u0026#34;auth\u0026#34;: token, # \u0026#34;id\u0026#34;: 1 # } data = { \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;trigger.get\u0026#34;, \u0026#34;params\u0026#34;: { # outputè¡¨ç¤ºè¾“å‡ºç»“æœåŒ…å«å‚æ•°æœ‰å“ªäº› \u0026#34;output\u0026#34;: [ \u0026#34;triggerid\u0026#34;, \u0026#34;description\u0026#34;, \u0026#34;status\u0026#34;, \u0026#34;value\u0026#34;, \u0026#34;priority\u0026#34;, \u0026#34;lastchange\u0026#34;, \u0026#34;recovery_mode\u0026#34;, \u0026#34;hosts\u0026#34;, \u0026#34;state\u0026#34;, ], \u0026#34;selectHosts\u0026#34;: \u0026#34;hosts\u0026#34;, # éœ€åŒ…å«ä¸»æœºIDä¿¡æ¯ï¼Œä»¥ä¾¿äºæ ¹æ®ä¸»æœºIDæŸ¥è¯¢ä¸»æœºä¿¡æ¯ \u0026#34;selectItems\u0026#34;: \u0026#34;items\u0026#34;, \u0026#34;filter\u0026#34;: { # ç­›é€‰æ¡ä»¶ \u0026#34;value\u0026#34;: 1, # valueå€¼ä¸º1è¡¨ç¤ºæœ‰é—®é¢˜ \u0026#34;status\u0026#34;: 0 # statusä¸º0è¡¨ç¤ºå·²å¯ç”¨çš„trigger }, }, \u0026#34;auth\u0026#34;: token, # è¿™é‡Œçš„authå°±æ˜¯ç™»å½•åè·å–çš„ \u0026#39;id\u0026#39;: \u0026#39;1\u0026#39; # è¿™ä¸ªidå¯ä»¥éšæ„ } json_data = json.dumps(data) req = requests.post(url, data=json_data, headers=headers) js_req = req.json() print(len(js_req[\u0026#39;result\u0026#39;]), js_req[\u0026#39;result\u0026#39;]) id_list = [] #åˆ¤æ–­ æœ‰é—®é¢˜çš„åœ°è‡ªåŠ¨å‘ç°çš„ç«¯å£ for item in js_req[\u0026#39;result\u0026#39;]: if \u0026#39;PROCESS\u0026#39; in item[\u0026#39;description\u0026#39;]: id_list.append(item[\u0026#39;triggerid\u0026#39;]) print(len(id_list), id_list) return js_req[\u0026#39;result\u0026#39;] 3ã€åˆ é™¤è§¦å‘å™¨çš„ID 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 def del_trigger(id): id_one = [] ids = id_one.append(str(id)) values = { \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;trigger.delete\u0026#34;, \u0026#34;params\u0026#34;: id_one, # è§¦å‘å™¨id \u0026#34;auth\u0026#34;: tokens, \u0026#34;id\u0026#34;: 1 } json_data = json.dumps(values) req = requests.post(url, data=json_data, headers=headers) js_req = req.json() print(js_req) # return js_req[\u0026#39;result\u0026#39;] å®Œæ­£ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 # -*- coding: utf-8 -*- # @Time : 2023/2/17 16:45 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : zabbix_trigger.py # @Software: PyCharm import json import os import requests url = \u0026#34;http://ip/zabbix/api_jsonrpc.php\u0026#34; # æ­¤å¤„åŸŸåä¿®æ”¹ä¸ºç›¸åº”çš„åœ°å€ headers = { \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json-rpc\u0026#39; } tokens = \u0026#39;97553b7342457602a0a6452f0058c0ed\u0026#39; def token_get(): # æ ¹æ®è´¦å·å¯†ç è·å–token data = { \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;user.login\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;user\u0026#34;: \u0026#34;Admin\u0026#34;, # zabbixç®¡ç†å‘˜ç”¨æˆ·å \u0026#34;password\u0026#34;: \u0026#34;å¯†ç \u0026#34; # è´¦æˆ·å¯†ç  }, \u0026#34;auth\u0026#34;: None, \u0026#34;id\u0026#34;: 1 } json_data = json.dumps(data) req = requests.post(url, data=json_data, headers=headers) js_req = req.json() print(js_req[\u0026#39;result\u0026#39;]) return js_req[\u0026#39;result\u0026#39;] def hosts_get(token): # è·å–æ‰€æœ‰ä¸»æœºä¿¡æ¯ # data = { # \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, # \u0026#34;method\u0026#34;: \u0026#34;host.get\u0026#34;, # \u0026#34;params\u0026#34;: { # \u0026#34;output\u0026#34;: [\u0026#34;hostid\u0026#34;, \u0026#34;name\u0026#34;], # \u0026#34;filter\u0026#34;: { # # ç­›é€‰æ¡ä»¶ # \u0026#34;value\u0026#34;: 1, # valueå€¼ä¸º1è¡¨ç¤ºæœ‰é—®é¢˜ # \u0026#34;status\u0026#34;: 0 # statusä¸º0è¡¨ç¤ºå·²å¯ç”¨çš„trigger # }, # }, # # \u0026#34;auth\u0026#34;: token, # \u0026#34;id\u0026#34;: 1 # } data = { \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;trigger.get\u0026#34;, \u0026#34;params\u0026#34;: { # outputè¡¨ç¤ºè¾“å‡ºç»“æœåŒ…å«å‚æ•°æœ‰å“ªäº› \u0026#34;output\u0026#34;: [ \u0026#34;triggerid\u0026#34;, \u0026#34;description\u0026#34;, \u0026#34;status\u0026#34;, \u0026#34;value\u0026#34;, \u0026#34;priority\u0026#34;, \u0026#34;lastchange\u0026#34;, \u0026#34;recovery_mode\u0026#34;, \u0026#34;hosts\u0026#34;, \u0026#34;state\u0026#34;, ], \u0026#34;selectHosts\u0026#34;: \u0026#34;hosts\u0026#34;, # éœ€åŒ…å«ä¸»æœºIDä¿¡æ¯ï¼Œä»¥ä¾¿äºæ ¹æ®ä¸»æœºIDæŸ¥è¯¢ä¸»æœºä¿¡æ¯ \u0026#34;selectItems\u0026#34;: \u0026#34;items\u0026#34;, \u0026#34;filter\u0026#34;: { # ç­›é€‰æ¡ä»¶ \u0026#34;value\u0026#34;: 1, # valueå€¼ä¸º1è¡¨ç¤ºæœ‰é—®é¢˜ \u0026#34;status\u0026#34;: 0 # statusä¸º0è¡¨ç¤ºå·²å¯ç”¨çš„trigger }, }, \u0026#34;auth\u0026#34;: token, # è¿™é‡Œçš„authå°±æ˜¯ç™»å½•åè·å–çš„ \u0026#39;id\u0026#39;: \u0026#39;1\u0026#39; # è¿™ä¸ªidå¯ä»¥éšæ„ } json_data = json.dumps(data) req = requests.post(url, data=json_data, headers=headers) js_req = req.json() print(len(js_req[\u0026#39;result\u0026#39;]), js_req[\u0026#39;result\u0026#39;]) id_list = [] for item in js_req[\u0026#39;result\u0026#39;]: if \u0026#39;PROCESS\u0026#39; in item[\u0026#39;description\u0026#39;]: id_list.append(item[\u0026#39;triggerid\u0026#39;]) print(len(id_list), id_list) return js_req[\u0026#39;result\u0026#39;] #è¿™è¾¹æˆ‘åšäº†ä¸ªè°ƒè¯•ï¼Œå¦‚æœæƒ³ç›´æ¥ä¸€æ¬¡è¿è¡ŒæˆåŠŸï¼Œå»ºè®®è‡ªå·±æ”¹åŠ¨ å¯åŠ¨æ˜¯çš„ä»£ç  id_lists = [\u0026#39;21284\u0026#39;, \u0026#39;21244\u0026#39;, \u0026#39;21249\u0026#39;, \u0026#39;21275\u0026#39;, \u0026#39;21264\u0026#39;, \u0026#39;21278\u0026#39;, \u0026#39;21262\u0026#39;, \u0026#39;21263\u0026#39;, \u0026#39;21266\u0026#39;, \u0026#39;21270\u0026#39;, \u0026#39;21272\u0026#39;, \u0026#39;21276\u0026#39;, \u0026#39;21277\u0026#39;, \u0026#39;21279\u0026#39;, \u0026#39;21267\u0026#39;, \u0026#39;21269\u0026#39;, \u0026#39;21254\u0026#39;, \u0026#39;21282\u0026#39;, \u0026#39;21287\u0026#39;, \u0026#39;21268\u0026#39;, \u0026#39;21273\u0026#39;, \u0026#39;21274\u0026#39;, \u0026#39;21285\u0026#39;, \u0026#39;21289\u0026#39;, \u0026#39;21283\u0026#39;, \u0026#39;21286\u0026#39;, \u0026#39;21290\u0026#39;, \u0026#39;21251\u0026#39;, \u0026#39;21250\u0026#39;, \u0026#39;21243\u0026#39;] def del_trigger(id): id_one = [] ids = id_one.append(str(id)) values = { \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;trigger.delete\u0026#34;, \u0026#34;params\u0026#34;: id_one, # è§¦å‘å™¨id \u0026#34;auth\u0026#34;: tokens, \u0026#34;id\u0026#34;: 1 } json_data = json.dumps(values) req = requests.post(url, data=json_data, headers=headers) js_req = req.json() print(js_req) # return js_req[\u0026#39;result\u0026#39;] for i in id_lists: del_trigger(i) ","date":"2023-02-19T11:06:57Z","image":"https://www.ownit.top/title_pic/35.jpg","permalink":"https://www.ownit.top/p/202302191106/","title":"Pythonè·å–zabbixé—®é¢˜è§¦å‘å™¨"},{"content":"CKAé¢˜ç›® æ¯æ¬¡è¿˜åŸåˆå§‹åŒ–å¿«ç…§åï¼Œå¼€æœºåç­‰5åˆ†é’Ÿï¼Œsshç™»å½•node01ï¼ˆ11.0.1.112ï¼‰æ£€æŸ¥ä¸€ä¸‹æ‰€æœ‰çš„podï¼Œç¡®ä¿éƒ½ä¸ºRunningï¼Œå†å¼€å§‹ç»ƒä¹ ã€‚\n1 kubectl get pod -A 1ã€æƒé™æ§åˆ¶RBAC é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Context ä¸ºéƒ¨ç½²æµæ°´çº¿åˆ›å»ºä¸€ä¸ªæ–°çš„ClusterRoleå¹¶å°†å…¶ç»‘å®šåˆ°èŒƒå›´ä¸ºç‰¹å®šçš„ namespace çš„ç‰¹å®šServiceAccountã€‚ Task åˆ›å»ºä¸€ä¸ªåä¸ºdeployment-clusterroleä¸”ä»…å…è®¸åˆ›å»ºä»¥ä¸‹èµ„æºç±»å‹çš„æ–°ClusterRoleï¼š Deployment StatefulSet DaemonSet åœ¨ç°æœ‰çš„ namespace app-team1ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºcicd-tokençš„æ–° ServiceAccountã€‚ é™äº namespace app-team1ä¸­ï¼Œå°†æ–°çš„ClusterRole deployment-clusterroleç»‘å®šåˆ°æ–°çš„ ServiceAccount cicd-tokenã€‚ è€ƒç‚¹ï¼šRBACæˆæƒæ¨¡å‹çš„ç†è§£ã€‚\næ²¡å¿…è¦å‚è€ƒç½‘å€ï¼Œä½¿ç”¨-hå¸®åŠ©æ›´æ–¹ä¾¿ã€‚\nkubectl create clusterrole -h\nkubectl create rolebinding -h\nè§£ç­” 1 2 3 4 5 6 7 8 kubectl create clusterrole deployment-clusterrole --verb=create --resource=deployments,statefulsets,daemonsets kubectl -n app-team1 create serviceaccount cicd-token # é¢˜ç›®ä¸­å†™äº†â€œé™äºnamespace app-team1ä¸­â€ï¼Œåˆ™åˆ›å»ºrolebindingã€‚æ²¡æœ‰å†™çš„è¯ï¼Œåˆ™åˆ›å»ºclusterrolebindingã€‚ kubectl -n app-team1 create rolebinding cicd-token-rolebinding --clusterrole=deployment-clusterrole --serviceaccount=app-team1:cicd-token # rolebindingåé¢çš„åå­—cicd-token-rolebindingéšä¾¿èµ·çš„ï¼Œå› ä¸ºé¢˜ç›®ä¸­æ²¡æœ‰è¦æ±‚ï¼Œå¦‚æœé¢˜ç›®ä¸­æœ‰è¦æ±‚ï¼Œå°±ä¸èƒ½éšä¾¿èµ·äº†ã€‚ æ£€æŸ¥ï¼ˆè€ƒè¯•æ—¶ï¼Œå¯ä»¥ä¸æ£€æŸ¥çš„ï¼‰ kubectl -n app-team1 describe rolebinding cicd-token-rolebinding â€\n2ã€æŸ¥çœ‹podçš„CPU é—®é¢˜ 1 2 3 4 5 6 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task é€šè¿‡ pod label name=cpu-loaderï¼Œæ‰¾åˆ°è¿è¡Œæ—¶å ç”¨å¤§é‡ CPU çš„ podï¼Œ å¹¶å°†å ç”¨ CPU æœ€é«˜çš„ pod åç§°å†™å…¥æ–‡ä»¶ /opt/KUTR000401/KUTR00401.txtï¼ˆå·²å­˜åœ¨ï¼‰ã€‚ è€ƒç‚¹ï¼škubectl top --l å‘½ä»¤çš„ä½¿ç”¨\næ²¡å¿…è¦å‚è€ƒç½‘å€ï¼Œä½¿ç”¨-hå¸®åŠ©æ›´æ–¹ä¾¿ã€‚\nkubectl top pod -h\nâ€\nè§£ç­” 1 2 3 4 5 6 7 8 9 10 11 12 13 è€ƒè¯•æ—¶åŠ¡å¿…æ‰§è¡Œï¼Œåˆ‡æ¢é›†ç¾¤ã€‚æ¨¡æ‹Ÿç¯å¢ƒä¸­ä¸éœ€è¦æ‰§è¡Œã€‚ # kubectl config use-context k8s å¼€å§‹æ“ä½œ # æŸ¥çœ‹podåç§° -Aæ˜¯æ‰€æœ‰namespace kubectl top pod -l name=cpu-loader --sort-by=cpu -A # å°†cpuå ç”¨æœ€å¤šçš„podçš„nameå†™å…¥/opt/test1.txtæ–‡ä»¶ echo \u0026#34;æŸ¥å‡ºæ¥çš„Pod Name\u0026#34; \u0026gt; /opt/KUTR000401/KUTR00401.txt æ£€æŸ¥ cat /opt/KUTR000401/KUTR00401.txt 3ã€é…ç½®ç½‘ç»œç­–ç•¥ NetworkPolicy â€\né—®é¢˜ 1 2 3 4 5 6 7 8 9 10 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context hk8s Task åœ¨ç°æœ‰çš„namespace my-appä¸­åˆ›å»ºä¸€ä¸ªåä¸ºallow-port-from-namespaceçš„æ–°NetworkPolicyã€‚ ç¡®ä¿æ–°çš„NetworkPolicyå…è®¸namespace echoä¸­çš„Podsè¿æ¥åˆ°namespace my-appä¸­çš„Podsçš„9000ç«¯å£ã€‚ è¿›ä¸€æ­¥ç¡®ä¿æ–°çš„NetworkPolicyï¼š ä¸å…è®¸å¯¹æ²¡æœ‰åœ¨ç›‘å¬ ç«¯å£9000çš„Podsçš„è®¿é—® ä¸å…è®¸éæ¥è‡ª namespace echoä¸­çš„Podsçš„è®¿é—® åŒé‡å¦å®šå°±æ˜¯è‚¯å®šï¼Œæ‰€ä»¥æœ€åä¸¤å¥è¯çš„æ„æ€å°±æ˜¯ï¼š\nä»…å…è®¸ç«¯å£ä¸º9000çš„podæ–¹æ³•ã€‚\nä»…å…è®¸echoå‘½åç©ºé—´ä¸­çš„podè®¿é—®ã€‚\nè€ƒç‚¹ï¼šNetworkPolicy çš„åˆ›å»º\nè§£ç­” å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œæ‹·è´yamlæ–‡ä»¶å†…å®¹ï¼Œå¹¶ä¿®æ”¹ã€‚\nè¿™é‡Œè¦æ³¨æ„ï¼Œæ¨¡æ‹Ÿé¢˜å’ŒçœŸé¢˜æˆªå›¾é‡Œéƒ½æœ‰æåˆ°echoè¿™ä¸ªnamespaceï¼Œä½†æ˜¯å’ŒçœŸé¢˜çš„æˆªå›¾æ¯”è¾ƒï¼Œä½ ä¼šå‘ç°ï¼Œä¸¤ä¸ªechoå‡ºç°çš„ä½ç½®ä¸åŒï¼Œä¸€ä¸ªä½œä¸ºè®¿é—®è€…ï¼Œä¸€ä¸ªä½œä¸º\nè¢«è®¿é—®è€…ã€‚\næ‰€ä»¥ä¸è¦ææ··äº†ã€‚ä»–ä»¬å…¶å®åªæ˜¯ä¸ªåå­—è€Œå·²ï¼Œå«ä»€ä¹ˆéƒ½æ— æ‰€è°“ï¼Œä½†è¦åˆ†æ¸…è®¿é—®å’Œè¢«è®¿é—®ã€‚\npodSelectorï¼šæ¯ä¸ª NetworkPolicy éƒ½åŒ…æ‹¬ä¸€ä¸ª podSelectorâ€‹ï¼Œ å®ƒå¯¹è¯¥ç­–ç•¥æ‰€é€‚ç”¨çš„ä¸€ç»„ Pod è¿›è¡Œé€‰æ‹©ã€‚ç¤ºä¾‹ä¸­çš„ç­–ç•¥é€‰æ‹©å¸¦æœ‰ \u0026quot; role (ä½œç”¨) =db\u0026quot; æ ‡ç­¾çš„ Podã€‚ ç©ºçš„ podSelectorâ€‹ é€‰æ‹©åå­—ç©ºé—´ä¸‹çš„æ‰€æœ‰ Podã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 å¼€å§‹æ“ä½œ æŸ¥çœ‹æ‰€æœ‰nsçš„æ ‡ç­¾label kubectl get ns --show-labels å¦‚æœè®¿é—®è€…çš„namespaceæ²¡æœ‰æ ‡ç­¾labelï¼Œåˆ™éœ€è¦æ‰‹åŠ¨æ‰“ä¸€ä¸ªã€‚å¦‚æœæœ‰ä¸€ä¸ªç‹¬ç‰¹çš„æ ‡ç­¾labelï¼Œåˆ™ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚ kubectl label ns echo project=echo ç¼–å†™ä¸€ä¸ªyamlæ–‡ä»¶ vim networkpolicy.yaml #æ³¨æ„ :set pasteï¼Œé˜²æ­¢yamlæ–‡ä»¶ç©ºæ ¼é”™åºã€‚ apiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: allow-port-from-namespace namespace: my-app spec: podSelector: matchLabels: {} policyTypes: - Ingress ingress: - from: - namespaceSelector: matchLabels: project: echo ports: - protocol: TCP port: 9000 æ£€æŸ¥\n1 kubectl describe networkpolicy -n my-app 4ã€æš´éœ²æœåŠ¡ service é—®é¢˜ 1 2 3 4 5 6 7 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task è¯·é‡æ–°é…ç½®ç°æœ‰çš„deployment front-end ä»¥åŠæ·»åŠ åä¸ºhttpçš„ç«¯å£è§„èŒƒæ¥å…¬å¼€ç°æœ‰å®¹å™¨ nginx çš„ç«¯å£80/tcpã€‚ åˆ›å»ºä¸€ä¸ªåä¸ºfront-end-svcçš„æ–°serviceï¼Œä»¥å…¬å¼€å®¹å™¨ç«¯å£httpã€‚ é…ç½®æ­¤serviceï¼Œä»¥é€šè¿‡å„ä¸ªPodæ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šçš„ NodePort æ¥å…¬å¼€ä»–ä»¬ã€‚ â€\nè§£ç­” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # kubectl config use-context k8s å¼€å§‹æ“ä½œ æ£€æŸ¥deploymentä¿¡æ¯ï¼Œå¹¶è®°å½•SELECTORçš„Lableæ ‡ç­¾ï¼Œè¿™é‡Œæ˜¯app=front-end kubectl get deployment front-end -o wide å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼ŒæŒ‰ç…§éœ€è¦edit deploymentï¼Œæ·»åŠ ç«¯å£ä¿¡æ¯ kubectl edit deployment front-end #æ³¨æ„ :set pasteï¼Œé˜²æ­¢yamlæ–‡ä»¶ç©ºæ ¼é”™åºã€‚ spec: containers: - image: vicuu/nginx:hello imagePullPolicy: IfNotPresent name: nginx #æ‰¾åˆ°æ­¤ä½ç½®ã€‚ä¸‹æ–‡ä¼šç®€å•è¯´æ˜ä¸€ä¸‹yamlæ–‡ä»¶çš„æ ¼å¼ï¼Œä¸æ‡‚yamlæ ¼å¼çš„ï¼Œå¾€ä¸‹çœ‹ã€‚ ports: #æ·»åŠ è¿™4è¡Œ - name: http containerPort: 80 protocol: TCP æš´éœ²å¯¹åº”ç«¯å£ kubectl expose deployment front-end --type=NodePort --port=80 --target-port=80 --name=front-end-svc #æ³¨æ„è€ƒè¯•ä¸­éœ€è¦åˆ›å»ºçš„æ˜¯NodePortï¼Œè¿˜æ˜¯ClusterIPã€‚å¦‚æœæ˜¯ClusterIPï¼Œåˆ™åº”ä¸º--type=ClusterIP #--portæ˜¯serviceçš„ç«¯å£å·ï¼Œ--target-portæ˜¯deploymenté‡Œpodçš„å®¹å™¨çš„ç«¯å£å·ã€‚ æš´éœ²æœåŠ¡åï¼Œæ£€æŸ¥ä¸€ä¸‹serviceçš„selectoræ ‡ç­¾æ˜¯å¦æ­£ç¡®ï¼Œè¿™ä¸ªè¦ä¸deploymentçš„selectoræ ‡ç­¾ä¸€è‡´çš„ã€‚ kubectl get svc front-end-svc -o wide kubectl get deployment front-end -o wide 5ã€åˆ›å»º Ingress é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 11 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task å¦‚ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„nginx Ingress èµ„æºï¼š åç§°: ping Namespace: ing-internal ä½¿ç”¨æœåŠ¡ç«¯å£ 5678åœ¨è·¯å¾„ /hello ä¸Šå…¬å¼€æœåŠ¡ hello å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥æœåŠ¡ helloçš„å¯ç”¨æ€§ï¼Œè¯¥å‘½ä»¤åº”è¿”å› helloï¼š curl -kL \u0026lt;INTERNAL_IP\u0026gt;/hello è§£ç­” â€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 vim ingress.yaml #æ³¨æ„ :set pasteï¼Œé˜²æ­¢yamlæ–‡ä»¶ç©ºæ ¼é”™åºã€‚ apiVersion: networking.k8s.io/v1 kind: IngressClass metadata: labels: app.kubernetes.io/component: controller name: nginx-example annotations: ingressclass.kubernetes.io/is-default-class: \u0026#34;true\u0026#34; spec: controller: k8s.io/ingress-nginx --- apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: ping namespace: front-end annotations: nginx.ingress.kubernetes.io/rewrite-target: / spec: ingressClassName: nginx-example #è¿™é‡Œè°ƒç”¨ä¸Šé¢æ–°å»ºçš„ingressClassName ä¸ºnginx-example rules: - http: paths: - path: /hello pathType: Prefix backend: service: name: hello port: number: 80 â€\næœ€åcurlæ£€æŸ¥\né€šè¿‡get ingress æŸ¥çœ‹ingress çš„å†…å¤–IPï¼Œç„¶åé€šè¿‡æä¾›çš„ curl æµ‹è¯• ingress æ˜¯å¦æ­£ç¡®ã€‚\nâ€\nå¦ä¸€ç§æ–¹æ³•\n1 kubectl create ingress ping --rule=/hello=hello:5678 --class=nginx --annotation=nginx.ingress.kubernetes.io/rewrite-target=/ -n ing-internal â€\n6ã€æ‰©å®¹ deploymentå‰¯æœ¬æ•°é‡ é—®é¢˜ 1 2 3 4 5 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task å°† deployment presentation æ‰©å±•è‡³ 4ä¸ª pods kubectl scale deployment -h\nè§£ç­” 1 2 3 4 5 6 å…ˆæ£€æŸ¥ä¸€ä¸‹ç°æœ‰çš„podæ•°é‡ï¼ˆå¯ä¸æ£€æŸ¥ï¼‰ kubectl get deployments presentation -o wide kubectl get pod -l app=presentation æ‰©å±•æˆ4ä¸ª kubectl scale deployment presentation --replicas=4 7ã€è°ƒåº¦ pod åˆ°æŒ‡å®šèŠ‚ç‚¹ é—®é¢˜ 1 2 3 4 5 6 7 8 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task æŒ‰å¦‚ä¸‹è¦æ±‚è°ƒåº¦ä¸€ä¸ª podï¼š åç§°ï¼šnginx-kusc00401 Imageï¼šnginx Node selectorï¼šdisk=ssd è€ƒç‚¹ï¼šnodeSelectå±æ€§çš„ä½¿ç”¨\nè§£ç­” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 å¼€å§‹æ“ä½œ å…ˆæ£€æŸ¥ä¸€ä¸ªæ˜¯å¦æœ‰è¿™ä¸ªpodï¼Œåº”è¯¥æ˜¯æ²¡æœ‰åˆ›å»ºçš„ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»º kubectl get pod -A|grep nginx-kusc00401 # ç¡®ä¿nodeæœ‰è¿™ä¸ªlabelsï¼Œè€ƒè¯•æ—¶ï¼Œæ£€æŸ¥ä¸€ä¸‹å°±è¡Œï¼Œåº”è¯¥å·²ç»æå‰è®¾ç½®å¥½äº†labelsã€‚ kubectl get nodes --show-labels|grep \u0026#39;disk=ssd\u0026#39; node02 æ·»åŠ æ ‡ç­¾ kubectl label nodes node02 disk=ssd cat pod_nginx_ssd.yaml apiVersion: v1 kind: Pod metadata: name: nginx labels: env: app spec: containers: - name: nginx image: nginx imagePullPolicy: IfNotPresent nodeSelector: disk: ssd kubectl get pod nginx -o wide 8ã€æŸ¥çœ‹å¯ç”¨èŠ‚ç‚¹æ•°é‡ é—®é¢˜ 1 2 3 4 5 [candidate@node-1] $ kubectl config use-context k8s Task æ£€æŸ¥æœ‰å¤šå°‘ nodes å·²å‡†å¤‡å°±ç»ªï¼ˆä¸åŒ…æ‹¬è¢«æ‰“ä¸Š Taintï¼šNoSchedule çš„èŠ‚ç‚¹ï¼‰ï¼Œ å¹¶å°†æ•°é‡å†™å…¥ /opt/KUSC00402/kusc00402.txt è€ƒç‚¹ï¼šæ£€æŸ¥èŠ‚ç‚¹è§’è‰²æ ‡ç­¾ï¼ŒçŠ¶æ€å±æ€§ï¼Œæ±¡ç‚¹å±æ€§çš„ä½¿ç”¨\nkubectl -h\nè§£ç­” 1 2 3 4 5 6 7 # grepçš„-i æ˜¯å¿½ç•¥å¤§å°å†™ï¼Œgrep -væ˜¯æ’é™¤åœ¨å¤–ï¼Œgrep -cæ˜¯ç»Ÿè®¡æŸ¥å‡ºæ¥çš„æ¡æ•°ã€‚ kubectl describe nodes | grep -i Taints | grep -vc NoSchedule echo \u0026#34;æŸ¥å‡ºæ¥çš„æ•°å­—\u0026#34; \u0026gt; /opt/KUSC00402/kusc00402.txt å…¶å®ä½ ç›´æ¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå°±èƒ½ä¸€çœ¼çœ‹å‡ºæ¥ï¼Œå‡ ä¸ªæ²¡æœ‰çš„ã€‚ kubectl describe nodes | grep -i Taints 9ã€åˆ›å»ºå¤šå®¹å™¨çš„ pod é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task æŒ‰å¦‚ä¸‹è¦æ±‚è°ƒåº¦ä¸€ä¸ªPodï¼š åç§°ï¼škucc8 app containers: 2 container åç§°/imagesï¼š âš« nginx âš« consul è§£ç­” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # kubectl config use-context k8s å¯ä»¥å‚è€ƒä¸Šä¸€é¢˜â€œè°ƒåº¦podåˆ°æŒ‡å®šèŠ‚ç‚¹â€çš„yamlé…ç½®æ–‡ä»¶ã€‚ å¼€å§‹æ“ä½œ vim pod-kucc.yaml #æ³¨æ„ :set pasteï¼Œé˜²æ­¢yamlæ–‡ä»¶ç©ºæ ¼é”™åºã€‚ apiVersion: v1 kind: Pod metadata: name: nginx-consul labels: env: app spec: containers: - name: nginx image: nginx imagePullPolicy: IfNotPresent - name: consul image: consul imagePullPolicy: IfNotPresent kubectl get pod nginx-consul 10ã€åˆ›å»º PV é—®é¢˜ 1 2 3 Task åˆ›å»ºåä¸º app-config çš„ persistent volumeï¼Œå®¹é‡ä¸º 1Giï¼Œè®¿é—®æ¨¡å¼ä¸º ReadWriteManyã€‚ volume ç±»å‹ä¸º hostPathï¼Œä½äº /srv/app-config è€ƒç‚¹ï¼šhostPathç±»å‹çš„pv\nè§£ç­” https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 ç›´æ¥ä»å®˜æ–¹å¤åˆ¶åˆé€‚çš„æ¡ˆä¾‹ï¼Œä¿®æ”¹å‚æ•°ï¼Œç„¶åè®¾ç½® hostPath ä¸º /srv/app-config å³å¯ã€‚ å¼€å§‹æ“ä½œ vim pv.yaml #æ³¨æ„ :set pasteï¼Œé˜²æ­¢yamlæ–‡ä»¶ç©ºæ ¼é”™åºã€‚ [root@bt cka]# cat pv_config_app.yaml apiVersion: v1 kind: PersistentVolume metadata: name: app-config spec: capacity: storage: 1Gi accessModes: - ReadWriteMany hostPath: path: \u0026#34;/srv/app-config\u0026#34; kubectl get pv # RWXæ˜¯ReadWriteManyï¼ŒRWOæ˜¯ReadWriteOnceã€‚ 11ã€åˆ›å»º PVC é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 Task åˆ›å»ºä¸€ä¸ªæ–°çš„PersistentVolumeClaimï¼š åç§°: pv-volume Class: csi-hostpath-sc å®¹é‡: 10Mi åˆ›å»ºä¸€ä¸ªæ–°çš„Podï¼Œæ¥å°†PersistentVolumeClaimä½œä¸ºvolumeè¿›è¡ŒæŒ‚è½½ï¼š åç§°ï¼šweb-server Imageï¼šnginx:1.16 æŒ‚è½½è·¯å¾„ï¼š/usr/share/nginx/html é…ç½®æ–°çš„Podï¼Œä»¥å¯¹volumeå…·æœ‰ReadWriteOnceæƒé™ã€‚ æœ€åï¼Œä½¿ç”¨kubectl editæˆ–kubectl patchå°† PersistentVolumeClaimçš„å®¹é‡æ‰©å±•ä¸º70Miï¼Œå¹¶è®°å½•æ­¤æ›´æ”¹ã€‚ è€ƒç‚¹ï¼špvcçš„åˆ›å»ºclasså±æ€§çš„ä½¿ç”¨ï¼Œâ€“recordè®°å½•å˜æ›´\nè§£ç­” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 æ ¹æ®å®˜æ–¹æ–‡æ¡£å¤åˆ¶ä¸€ä¸ªPVCé…ç½®ï¼Œä¿®æ”¹å‚æ•°ï¼Œä¸ç¡®å®šçš„åœ°æ–¹å°±æ˜¯ç”¨ kubectl çš„ explain å¸®åŠ©ã€‚ å¼€å§‹æ“ä½œ vim pvc.yaml #æ³¨æ„ :set pasteï¼Œé˜²æ­¢yamlæ–‡ä»¶ç©ºæ ¼é”™åºã€‚ [root@bt cka]# cat pvc_storgae.yaml apiVersion: v1 kind: PersistentVolumeClaim metadata: name: pv-volume spec: storageClassName: nfs-client accessModes: - ReadWriteOnce resources: requests: storage: 10Mi åˆ›å»ºPVC kubectl apply -f pvc.yaml æ£€æŸ¥ kubectl get pvc vim pvc-pod.yaml #æ³¨æ„ :set pasteï¼Œé˜²æ­¢yamlæ–‡ä»¶ç©ºæ ¼é”™åº apiVersion: v1 kind: Pod metadata: name: web-server spec: volumes: - name: task-pv-storage #ç»¿è‰²çš„ä¸¤ä¸ªnameè¦ä¸€æ ·ã€‚ persistentVolumeClaim: claimName: pv-volume #è¿™ä¸ªè¦ä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„pvcåå­— containers: - name: nginx image: nginx:1.16 volumeMounts: - mountPath: \u0026#34;/usr/share/nginx/html\u0026#34; name: task-pv-storage #ç»¿è‰²çš„ä¸¤ä¸ªnameè¦ä¸€æ ·ã€‚ åˆ›å»º kubectl apply -f pvc-pod.yaml æ£€æŸ¥ kubectl get pod web-server æ”¹å¤§å°ï¼Œå¹¶è®°å½•è¿‡ç¨‹ã€‚ # å°†storage: 10Miæ”¹ä¸ºstorage: 70Mi ï¼ˆæ¨¡æ‹Ÿç¯å¢ƒé‡Œä¼šæŠ¥é”™ï¼Œä¸‹é¢æœ‰è§£é‡Šã€‚ï¼‰ # æ³¨æ„æ˜¯ä¿®æ”¹ä¸Šé¢çš„spec:é‡Œé¢çš„storage: kubectl edit pvc pv-volume --record #æ¨¡æ‹Ÿç¯å¢ƒæ˜¯nfså­˜å‚¨ï¼Œæ“ä½œæ—¶ï¼Œä¼šæœ‰æŠ¥é”™å¿½ç•¥å³å¯ã€‚è€ƒè¯•æ—¶ç”¨çš„åŠ¨æ€å­˜å‚¨ï¼Œä¸ä¼šæŠ¥é”™çš„ã€‚ æ¨¡æ‹Ÿç¯å¢ƒä½¿ç”¨çš„æ˜¯nfsåšåç«¯å­˜å‚¨ï¼Œæ˜¯ä¸æ”¯æŒåŠ¨æ€æ‰©å®¹pvcçš„ï¼ˆ:wqä¿å­˜é€€å‡ºæ—¶ï¼Œä¼šæŠ¥é”™ï¼‰ã€‚ æ‰€ä»¥æœ€åä¸€æ­¥ä¿®æ”¹ä¸º70Miï¼Œåªæ˜¯æ“ä½œä¸€ä¸‹å³å¯ã€‚æ¢æˆcephåšåç«¯å­˜å‚¨ï¼Œå¯ä»¥ï¼Œä½†æ˜¯é›†ç¾¤èµ„æºå¤ªå°‘ï¼Œæ— æ³•åšcephã€‚ â€\n12ã€æŸ¥çœ‹ pod æ—¥å¿— é—®é¢˜ 1 2 3 4 5 6 [candidate@node-1] $ kubectl config use-context k8s Task ç›‘æ§ pod foo çš„æ—¥å¿—å¹¶ï¼š æå–ä¸é”™è¯¯ RLIMIT_NOFILEç›¸å¯¹åº”çš„æ—¥å¿—è¡Œ å°†è¿™äº›æ—¥å¿—è¡Œå†™å…¥ /opt/KUTR00101/foo è€ƒç‚¹ï¼škubectl logså‘½ä»¤\nè§£ç­” 1 2 3 4 kubectl logs foo | grep \u0026#34;RLIMIT_NOFILE\u0026#34; \u0026gt; /opt/KUTR00101/foo æ£€æŸ¥ cat /opt/KUTR00101/foo 13ã€ä½¿ç”¨ sidecar ä»£ç†å®¹å™¨æ—¥å¿— é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 11 12 [candidate@node-1] $ kubectl config use-context k8s Context å°†ä¸€ä¸ªç°æœ‰çš„ Pod é›†æˆåˆ° Kubernetes çš„å†…ç½®æ—¥å¿—è®°å½•ä½“ç³»ç»“æ„ä¸­ï¼ˆä¾‹å¦‚ kubectl logsï¼‰ã€‚ æ·»åŠ  streaming sidecar å®¹å™¨æ˜¯å®ç°æ­¤è¦æ±‚çš„ä¸€ç§å¥½æ–¹æ³•ã€‚ Task ä½¿ç”¨busybox Imageæ¥å°†åä¸ºsidecarçš„sidecarå®¹å™¨æ·»åŠ åˆ°ç°æœ‰çš„Pod 11-factor-appä¸­ã€‚ æ–°çš„sidecarå®¹å™¨å¿…é¡»è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š /bin/sh -c tail -n+1 -f /var/log/11-factor-app.log ä½¿ç”¨æŒ‚è½½åœ¨/var/logçš„Volumeï¼Œä½¿æ—¥å¿—æ–‡ä»¶11-factor-app.log å¯ç”¨äºsidecar å®¹å™¨ã€‚ é™¤äº†æ·»åŠ æ‰€éœ€è¦çš„volume mountä»¥å¤–ï¼Œè¯·å‹¿æ›´æ”¹ç°æœ‰å®¹å™¨çš„è§„æ ¼ã€‚ è€ƒé¢˜ç¿»è¯‘æˆç™½è¯ï¼Œå°±æ˜¯ï¼š\næ·»åŠ ä¸€ä¸ªåä¸ºsidecar çš„è¾¹è½¦å®¹å™¨(ä½¿ç”¨busybox é•œåƒ)ï¼ŒåŠ åˆ°å·²æœ‰çš„ pod 11-factor-app ä¸­ã€‚\nç¡®ä¿ sidecar å®¹å™¨èƒ½å¤Ÿè¾“å‡º /var/log/11-factor-app.log çš„ä¿¡æ¯ã€‚\nä½¿ç”¨ volume æŒ‚è½½ /var/log ç›®å½•ï¼Œç¡®ä¿ sidecar èƒ½è®¿é—® 11-factor-app.log æ–‡ä»¶\nè€ƒç‚¹ï¼špodä¸¤ä¸ªå®¹å™¨å…±äº«å­˜å‚¨å·\nhttps://kubernetes.io/zh-cn/docs/concepts/cluster-administration/logging/\nè§£ç­” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 é€šè¿‡ kubectl get pod -o yaml çš„æ–¹æ³•å¤‡ä»½åŸå§‹ pod ä¿¡æ¯ï¼Œåˆ é™¤æ—§çš„pod 11-factor-app copy ä¸€ä»½æ–° yaml æ–‡ä»¶ï¼Œæ·»åŠ  ä¸€ä¸ªåç§°ä¸º sidecar çš„å®¹å™¨ æ–°å»º emptyDir çš„å·ï¼Œç¡®ä¿ä¸¤ä¸ªå®¹å™¨éƒ½æŒ‚è½½äº† /var/log ç›®å½• æ–°å»ºå«æœ‰ sidecar çš„ podï¼Œå¹¶é€šè¿‡ kubectl logs éªŒè¯ apiVersion: v1 kind: Pod metadata: name: counter spec: containers: - name: leagcy-app image: busybox args: - /bin/sh - -c - \u0026gt; i=0; while true; do echo \u0026#34;$i: $(date)\u0026#34; \u0026gt;\u0026gt; /var/log/legacy-app.log; i=$((i+1)); sleep 1; done volumeMounts: - name: varlog mountPath: /var/log - name: sidecar image: busybox args: [/bin/sh, -c, \u0026#39;tail -n+1 -F /var/log/legacy-app.log\u0026#39;] volumeMounts: - name: varlog mountPath: /var/log volumes: - name: varlog emptyDir: {} éªŒè¯ï¼š kubectl exec counter-log -c sidecar -- tail -f /var/log/legacy-app.log 14ã€å‡çº§é›†ç¾¤ é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 11 12 Task ç°æœ‰çš„Kubernetes é›†ç¾¤æ­£åœ¨è¿è¡Œç‰ˆæœ¬1.25.1ã€‚ä»…å°†masterèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Kubernetesæ§åˆ¶å¹³é¢å’ŒèŠ‚ç‚¹ç»„ä»¶å‡çº§åˆ°ç‰ˆæœ¬1.25.2ã€‚ ç¡®ä¿åœ¨å‡çº§ä¹‹å‰ drain masterèŠ‚ç‚¹ï¼Œå¹¶åœ¨å‡çº§å uncordon masterèŠ‚ç‚¹ã€‚ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡sshè¿æ¥åˆ°masterèŠ‚ç‚¹ï¼š ssh master01 å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨è¯¥masterèŠ‚ç‚¹ä¸Šè·å–æ›´é«˜æƒé™ï¼š sudo -i å¦å¤–ï¼Œåœ¨ä¸»èŠ‚ç‚¹ä¸Šå‡çº§kubeletå’Œkubectlã€‚ è¯·ä¸è¦å‡çº§å·¥ä½œèŠ‚ç‚¹ï¼Œetcdï¼Œcontainer ç®¡ç†å™¨ï¼ŒCNIæ’ä»¶ï¼Œ DNSæœåŠ¡æˆ–ä»»ä½•å…¶ä»–æ’ä»¶ã€‚ ï¼ˆæ³¨æ„ï¼Œè€ƒè¯•æ•²å‘½ä»¤æ—¶ï¼Œæ³¨æ„è¦å‡çº§çš„ç‰ˆæœ¬ï¼Œæ ¹æ®é¢˜ç›®è¦æ±‚è¾“å…¥å…·ä½“çš„å‡çº§ç‰ˆæœ¬ï¼ï¼ï¼ï¼‰\nè€ƒç‚¹ï¼šå¦‚ä½•ç¦»çº¿ä¸»æœºï¼Œå¹¶å‡çº§æ§åˆ¶é¢æ¿å’Œå‡çº§èŠ‚ç‚¹\nè§£ç­” â€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 1ã€åˆ‡æ¢ç¯å¢ƒ kubectl config use-context mk8s 2ã€é…ç½® #å‡çº§kueadm kubectl cordon master01 kubectl drain mk8s-master-0 --ignore=daemonsets è¿æ¥masteræœºå™¨ ææƒ ssh mk8s-master-0 sudo -i å‡çº§kubeadm apt-get update apt-cache show kubeadm|grep 1.25.2 apt install kubeadm=1.25.2 -y kubeadm upgrade plan #è¿™é‡Œå¯ä»¥å…ˆæŸ¥ä¸‹çš„ï¼šapt-cache show|grep kubeadm #kubeadm upgrade install v1.20.1 #ã€‚ã€‚ã€‚æ·¦ï¼Œè¿™ä¸ªå†™é”™äº†ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚æ˜¯applyï¼Œå¹¶ä¸”è¦åŠ ä¸Š--ectd-ugrade=falseã€‚ã€‚ã€‚ã€‚ã€‚ã€‚é¢˜ç›®è¦æ±‚ä¸å‡çº§ etcdï¼› æ³¨æ„ä¸‹è¿™2ä¸ªç‰ˆæœ¬å·å†™æ³•çš„åŒºåˆ«ã€‚ã€‚ã€‚ã€‚ kubeadm upgrade apply v1.20.1 --etcd-upgrade=false #å‡çº§kubelt å’Œ kubectl apt install kubelet=1.20.1-00 kubectl=1.20.1-00 -y systemctl restart kubelet #è¿™é‡Œè¦é‡å¯ä¸‹kubeltçš„ï¼Œåˆ‡è®°ã€‚ã€‚ã€‚ exit exit kubectl uncordon mk8s-master-0 3ã€éªŒè¯ kubectl get node -owide kubectl --version kubelet --version 15ã€å¤‡ä»½è¿˜åŸ etcd é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 æ­¤é¡¹ç›®æ— éœ€æ›´æ”¹é…ç½®ç¯å¢ƒã€‚ä½†æ˜¯ï¼Œåœ¨æ‰§è¡Œæ­¤é¡¹ç›®ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²è¿”å›åˆå§‹èŠ‚ç‚¹ã€‚ [candidate@master01] $ exit #æ³¨æ„ï¼Œè¿™ä¸ªä¹‹å‰æ˜¯åœ¨master01ä¸Šï¼Œæ‰€ä»¥è¦exité€€åˆ°node01ï¼Œå¦‚æœå·²ç»æ˜¯node01äº†ï¼Œå°±ä¸è¦å†exitäº†ã€‚ Task é¦–å…ˆï¼Œä¸ºè¿è¡Œåœ¨https://11.0.1.111:2379 ä¸Šçš„ç°æœ‰ etcd å®ä¾‹åˆ›å»ºå¿«ç…§å¹¶å°†å¿«ç…§ä¿å­˜åˆ° /var/lib/backup/etcd-snapshot.db ï¼ˆæ³¨æ„ï¼ŒçœŸå®è€ƒè¯•ä¸­ï¼Œè¿™é‡Œå†™çš„æ˜¯https://127.0.0.1:2379ï¼‰ ä¸ºç»™å®šå®ä¾‹åˆ›å»ºå¿«ç…§é¢„è®¡èƒ½åœ¨å‡ ç§’é’Ÿå†…å®Œæˆã€‚ å¦‚æœè¯¥æ“ä½œä¼¼ä¹æŒ‚èµ·ï¼Œåˆ™å‘½ä»¤å¯èƒ½æœ‰é—®é¢˜ã€‚ç”¨ CTRL + C æ¥å–æ¶ˆæ“ä½œï¼Œç„¶åé‡è¯•ã€‚ ç„¶åè¿˜åŸä½äº/data/backup/etcd-snapshot-previous.dbçš„ç°æœ‰å…ˆå‰å¿«ç…§ã€‚ æä¾›äº†ä»¥ä¸‹TLSè¯ä¹¦å’Œå¯†é’¥ï¼Œä»¥é€šè¿‡etcdctlè¿æ¥åˆ°æœåŠ¡å™¨ã€‚ CA è¯ä¹¦: /opt/KUIN00601/ca.crt å®¢æˆ·ç«¯è¯ä¹¦: /opt/KUIN00601/etcd-client.crt å®¢æˆ·ç«¯å¯†é’¥: /opt/KUIN00601/etcd-client.key è€ƒç‚¹ï¼šetcdçš„å¤‡ä»½å’Œè¿˜åŸå‘½ä»¤\nè§£ç­” 1 2 3 4 5 6 7 8 9 # å¤‡ä»½ ETCDCTL_API=3 etcdctl snapshot save /data/backup/etcd-snapshot.db --endpoints=https://127.0.0.1:2379 --cacert=/opt/KUIN00601/ca.crt --cert=/opt/KUIN00601/etcd-client.crt --key=/opt/KUIN00601/etcd-client.key # æ¢å¤ systemctl stop etcd systemctl cat etcd # ç¡®è®¤ä¸‹æ•°æ®ç›®å½•ï¼ˆ--data-dirå€¼ï¼‰ mv /var/lib/etcd /var/lib/etcd.bak ETCDCTL_API=3 etcdctl snapshot restore /data/backup/etcd-snapshot-previous.db --data-dir=/var/lib/etcd chown -R etcd:etcd /var/lib/etcd systemctl start etcd â€\nâ€\n16ã€æ’æŸ¥é›†ç¾¤ä¸­æ•…éšœèŠ‚ç‚¹ é—®é¢˜ 1 2 3 4 5 6 7 åä¸ºnode02çš„Kubernetes worker nodeå¤„äºNotReadyçŠ¶æ€ã€‚ è°ƒæŸ¥å‘ç”Ÿè¿™ç§æƒ…å†µçš„åŸå› ï¼Œå¹¶é‡‡å–ç›¸åº”çš„æªæ–½å°†nodeæ¢å¤ä¸ºReadyçŠ¶æ€ï¼Œç¡®ä¿æ‰€åšçš„ä»»ä½•æ›´æ”¹æ°¸ä¹…ç”Ÿæ•ˆã€‚ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡sshè¿æ¥åˆ°node02èŠ‚ç‚¹ï¼š ssh node02 å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨è¯¥èŠ‚ç‚¹ä¸Šè·å–æ›´é«˜æƒé™ï¼š sudo -i è§£ç­” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 è¿‡ get nodes æŸ¥çœ‹å¼‚å¸¸èŠ‚ç‚¹ï¼Œç™»å½•èŠ‚ç‚¹æŸ¥çœ‹ kubelet ç­‰ç»„ä»¶çš„ status å¹¶åˆ¤æ–­åŸå› ã€‚ çœŸå®è€ƒè¯•æ—¶ï¼Œè¿™ä¸ªå¼‚å¸¸èŠ‚ç‚¹çš„kubeletæœåŠ¡æ²¡æœ‰å¯åŠ¨å¯¼è‡´çš„ï¼Œå°±è¿™ä¹ˆç®€å•ã€‚ æ‰§è¡Œåˆå§‹åŒ–è¿™é“é¢˜çš„è„šæœ¬a.shï¼Œæ¨¡æ‹Ÿnode02å¼‚å¸¸ã€‚ ï¼ˆè€ƒè¯•æ—¶ï¼Œä¸éœ€è¦æ‰§è¡Œçš„ï¼è€ƒè¯•æ—¶åˆ‡åˆ°è¿™é“é¢˜çš„é›†ç¾¤åï¼Œé‚£ä¸ªnodeå°±æ˜¯å¼‚å¸¸çš„ã€‚ï¼‰ 1ã€åˆ‡æ¢ç¯å¢ƒ kubectl config use-context wk8s #è€ƒè¯•æ—¶åˆ‡åˆ°è¿™é“é¢˜çš„é›†ç¾¤åï¼Œé‚£ä¸ª node å°±æ˜¯å¼‚å¸¸çš„ã€‚ çœŸå®è€ƒè¯•æ—¶ï¼Œè¿™ä¸ªå¼‚å¸¸èŠ‚ç‚¹çš„ kubelet æœåŠ¡æ²¡æœ‰å¯åŠ¨å¯¼è‡´çš„ï¼Œå°±è¿™ä¹ˆç®€å•ã€‚ 2ã€é…ç½® kubectl get node #æŸ¥çœ‹Not Readyçš„nodeèŠ‚ç‚¹ ssh wk8s-node-0 sudo -i systemctl status kubelet systemctl start kubelet systemctl enable kubelet exit #é€€å‡ºrootç”¨æˆ· exit #é€€å‡ºæ•…éšœèŠ‚ç‚¹ 3ã€éªŒè¯ kubectl get node #jounarlctl -u kubelet æŸ¥çœ‹kubeletæ—¥å¿— 17ã€èŠ‚ç‚¹ç»´æŠ¤ é—®é¢˜ 1 2 Task å°†åä¸º node02 çš„ node è®¾ç½®ä¸ºä¸å¯ç”¨ï¼Œå¹¶é‡æ–°è°ƒåº¦è¯¥ node ä¸Šæ‰€æœ‰è¿è¡Œçš„ podsã€‚ è€ƒç‚¹ï¼šcordonå’Œdrain å‘½ä»¤çš„ä½¿ç”¨\nè§£ç­” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 1ã€åˆ‡æ¢ç¯å¢ƒ kubectl config use-context ek8s 2ã€é…ç½® kubectl cordon ek8s-node-1 #è®¾ç½®æ¬¡èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦s kubectl drain ek8s-node-1 --ignore-daemonsets #è®¾ç½®æ¬¡èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼Œå¹¶ä¸”æ’ç©ºæ¬¡èŠ‚ç‚¹ #å¦‚æœä¸Šé¢å‘½ä»¤æŠ¥é”™å°±åŠ ä¸Šä¸€ä¸ª --delete-local-data --force kubectl drain ek8s-node-1 --ignore-daemonsets --delete-local-data --force kubectl drain ek8s-node-1 --ignore-daemonsets --delete-emptydir-data --force 3ã€éªŒè¯ kubectl get node ","date":"2023-01-31T18:10:28Z","image":"https://www.ownit.top/title_pic/63.jpg","permalink":"https://www.ownit.top/p/202301311810/","title":"Kubernetesè€ƒè¯•é¢˜ï¼ˆCKAï¼‰"},{"content":"æ¯å‘¨éƒ½æœ‰å…è´¹æ¸¸æˆ - Epic Games è¿‘æœŸçœ‹åˆ°Epicåœ¨é€æ¸¸æˆï¼Œç›®å‰æ¯å‘¨éƒ½ä¼šæœ‰æ´»åŠ¨ç™½å«–ã€‚\nèº«ä¸ºç™½å«–å…šï¼Œè‚¯å®šè¦æ“ä½œä¸€ä¸‹ã€‚\næ¸¸æˆåˆ—è¡¨ï¼šEpic Games Store æ¯å‘¨å…è´¹æ¸¸æˆï¼ˆ331ï¼‰ | indienova GameDB æ¸¸æˆåº“\nå¤§è‡´æ€è·¯ï¼š\n1ã€æ ¹æ®ç½‘ç«™ï¼Œè·å–å¯ â€œÂ ç™½å«–Â â€çš„æ¸¸æˆ\n2ã€å¤„ç†ç›¸å…³ä¿¡æ¯ï¼Œç»„æˆæ–‡æœ¬\n3ã€å‘é€åˆ°å¾®ä¿¡ä¸Šï¼Œè®©æˆ‘ä»¬çŸ¥é“ã€‚\n1ã€æŸ¥è¯¢ç½‘ç«™ ä¸‹é¢ç½‘é¡µï¼Œä¼šå‘å¸ƒæœ€æ–°å…è´¹ï¼Œå¯ç™½å«–çš„æ¸¸æˆã€‚æˆ‘ä»¬çˆ¬å–è¿™äº›ä¿¡æ¯ï¼Œè¿›è¡Œåˆ¤æ–­\næ¸¸æˆåˆ—è¡¨ï¼šEpic Games Store æ¯å‘¨å…è´¹æ¸¸æˆï¼ˆ331ï¼‰ | indienova GameDB æ¸¸æˆåº“\n2ã€ä»£ç ç¼–å†™ 1.æˆ‘ä»¬çˆ¬å–ç½‘é¡µçš„æ•°æ®\n2.è·å–ç½‘é¡µä¸­æ‰€æœ‰æ¸¸æˆçš„ä¿¡æ¯\n3.åˆ¤æ–­æ¸¸æˆä¿¡æ¯æ˜¯æœ€æ–°ç¼–è¾‘çš„\n4.æ±‡æ€»ä¿¡æ¯è¿›è¡Œå‘é€åˆ°å¾®ä¿¡\nç›¸å…³å®ä¾‹ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 # -*- coding: utf-8 -*- # @Time : 2022/12/29 16:33 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : epic_all.py # @Software: PyCharm import json import re import time import requests from bs4 import BeautifulSoup def get_url_info(): url = \u0026#39;https://indienova.com/gamedb/list/121/p/1\u0026#39; headers = { \u0026#39;User-Agent\u0026#39;: \u0026#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.72 Safari/537.36 Edg/90.0.818.41\u0026#39;} res = requests.get(url, headers=headers).text return res def check_epci_info(game_info_list): list_content = [] for i in game_info_list: game_time = i[\u0026#39;game_time\u0026#39;] if \u0026#39;å°æ—¶å‰\u0026#39; in game_time[0]: content = f\u0026#34;ä¸­æ–‡åç§°ï¼š{i[\u0026#39;game_zh\u0026#39;]} \u0026lt;br/\u0026gt;\u0026#34; \\ f\u0026#34;è‹±æ–‡åç§°ï¼š{i[\u0026#39;game_en\u0026#39;]} \u0026lt;br/\u0026gt;\u0026#34; \\ f\u0026#34;é¢†å–æ—¶é—´ï¼š{i[\u0026#39;game_start\u0026#39;]} \u0026lt;br/\u0026gt;\u0026#34; \\ f\u0026#34;å‘å¸ƒæ—¶é—´ï¼š{i[\u0026#39;game_time\u0026#39;]}\u0026lt;br/\u0026gt;\u0026lt;br/\u0026gt;\u0026#34; list_content.append(content) return list_content def parse_web_page(res): soup = BeautifulSoup(res, \u0026#34;html.parser\u0026#34;) res.encode(\u0026#39;UTF-8\u0026#39;).decode(\u0026#39;UTF-8\u0026#39;) div_class = soup.find(name=\u0026#39;div\u0026#39;, attrs={\u0026#34;id\u0026#34;: \u0026#34;portfolioList\u0026#34;}) # print(div_class[0]) game_name = div_class.find_all(name=\u0026#39;div\u0026#39;, attrs={\u0026#34;class\u0026#34;: \u0026#34;col-xs-12 col-sm-6 col-md-4 user-game-list-item\u0026#34;}) list_game = str(game_name).split(\u0026#39;\u0026lt;div class=\u0026#34;col-xs-12 col-sm-6 col-md-4 user-game-list-item\u0026#34;\u0026gt;\u0026#39;) game_info_list = [] for i in list_game[1:]: dict_info = {} # print(\u0026#39;----------------------------------------------------------------------------------\u0026#39;) game = BeautifulSoup(i, \u0026#34;html.parser\u0026#34;) game_all_info = game.find(name=\u0026#39;h4\u0026#39;) game_name_zh = game_all_info.find_all(name=\u0026#39;a\u0026#39;) game_name_en = game_all_info.find_all(name=\u0026#39;small\u0026#39;) game_name_zh = re.findall(r\u0026#39;\u0026gt;(.+?)\u0026lt;\u0026#39;, str(game_name_zh)) game_name_en = re.findall(r\u0026#39;\u0026gt;(.+?)\u0026lt;\u0026#39;, str(game_name_en)) # print(game_name_zh, game_name_en) game_start_end = game.find(name=\u0026#39;p\u0026#39;, attrs={\u0026#34;class\u0026#34;: \u0026#34;intro\u0026#34;}) game_start_end_new = game_start_end.find_all(name=\u0026#39;span\u0026#39;) game_edit_time = game.find(name=\u0026#39;p\u0026#39;, attrs={\u0026#34;class\u0026#34;: \u0026#34;text-date\u0026#34;}) game_edit_time_new = game_edit_time.find_all(name=\u0026#39;small\u0026#39;) game_edit_time_new = str(game_edit_time_new).replace(\u0026#34; \u0026#34;, \u0026#34;\u0026#34;).replace(\u0026#34;\\n\u0026#34;, \u0026#34; \u0026#34;) game_start_end_new = re.findall(r\u0026#39;\u0026gt;(.+?)\u0026lt;\u0026#39;, str(game_start_end_new)) game_edit_time_new = re.findall(r\u0026#39;\u0026gt;(.+?)\u0026lt;\u0026#39;, str(game_edit_time_new)) dict_info[\u0026#34;game_zh\u0026#34;] = game_name_zh dict_info[\u0026#34;game_en\u0026#34;] = game_name_en dict_info[\u0026#34;game_start\u0026#34;] = game_start_end_new dict_info[\u0026#34;game_time\u0026#34;] = game_edit_time_new game_info_list.append(dict_info) # print(game_start_end_new,game_edit_time_new) return game_info_list def send_to_epic_message(list_content): content = \u0026#39;\u0026#39;.join(list_content) + \u0026#39;\\nhttps://indienova.com/gamedb/list/121/p/1\u0026#39; token = \u0026#39;tokenxxxxxxxxxxxxxxxxxxxx\u0026#39; day_time = time.strftime(\u0026#39;%Y-%m-%d\u0026#39;, time.localtime(time.time())) title = f\u0026#39;Epicå…è´¹æ¸¸æˆ-{day_time}\u0026#39; # æ”¹æˆä½ è¦çš„æ ‡é¢˜å†…å®¹ error_time = time.strftime(\u0026#39;%Y-%m-%d %H:%M:%S\u0026#39;, time.localtime(time.time())) # è·å–æ ¼å¼åŒ–çš„æ—¶é—´ url = \u0026#39;http://www.pushplus.plus/send\u0026#39; data = { \u0026#34;token\u0026#34;: token, # å¯†é’¥ \u0026#34;title\u0026#34;: title, # æ ‡é¢˜ \u0026#34;content\u0026#34;: content, # å‘é€çš„ä¿¡æ¯å†…å®¹ï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¯jsonæ•°ç»„ \u0026#34;template\u0026#34;: \u0026#34;markdown\u0026#34; # æ•°æ®ç±»å‹ä¸ºjson } body = json.dumps(data).encode(encoding=\u0026#39;utf-8\u0026#39;) headers = {\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;} request_result = requests.post(url, data=body, headers=headers) # print(request_result) # \u0026lt;Response [200]\u0026gt; if __name__ == \u0026#39;__main__\u0026#39;: res = get_url_info() game_info_list = parse_web_page(res) list_content = check_epci_info(game_info_list) send_to_epic_message(list_content) 3ã€å‘é€å¹³å°ï¼ˆpushplusï¼‰ å¾®ä¿¡å…¬ä¼—å·å…³æ³¨\npushplus(æ¨é€åŠ )-å¾®ä¿¡æ¶ˆæ¯æ¨é€å¹³å°\nè·å–tokenè¿›è¡Œé…ç½®å³å¯ã€‚\n4ã€å®šæ—¶ä»»åŠ¡ æˆ‘ä»¬è¦æŠŠè„šæœ¬éƒ¨ç½²åˆ°Linuxæ“ä½œç¯å¢ƒ ä¸Šã€‚\né¦–å…ˆè®°å¾—å®‰è£…ä¾èµ–ã€‚pip install æ¨¡å—\nå®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©10ç‚¹è¿è¡Œä¸€æ¬¡ã€‚\n1 0 10 * * * /usr/bin/python3 /opt/epic_send.py 5ã€å¢åŠ  å–œåŠ ä¸€ çš„èµ„è®¯é€šçŸ¥ ç½‘ç«™ä¸ºsteam free gameï¼Œsteam free promotion - Steam Stats\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 # -*- coding: utf-8 -*- # @Time : 2022/12/29 15:51 # @Author : å—å®«ä¹˜é£ # @Email : 1794748404@qq.com # @File : epic.py # @Software: PyCharm import json import time import requests from bs4 import BeautifulSoup def get_free(): url = \u0026#39;https://steamstats.cn/xi\u0026#39; headers = { \u0026#39;User-Agent\u0026#39;: \u0026#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.72 Safari/537.36 Edg/90.0.818.41\u0026#39;} r = requests.get(url, headers=headers) r.raise_for_status() r.encoding = r.apparent_encoding soup = BeautifulSoup(r.text, \u0026#34;html.parser\u0026#34;) text = \u0026#34;ä»Šæ—¥å–œåŠ ä¸€ \u0026lt;br\u0026gt;\u0026#34; + \u0026#39;https://steamstats.cn/xi\u0026#39; + \u0026#39;\u0026lt;br\u0026gt;\u0026#39; tbody = soup.find(\u0026#39;tbody\u0026#39;) tr = tbody.find_all(\u0026#39;tr\u0026#39;) i = 1 for tr in tr: td = tr.find_all(\u0026#39;td\u0026#39;) name = td[1].string.strip().replace(\u0026#39;\\n\u0026#39;, \u0026#39;\u0026#39;).replace(\u0026#39;\\r\u0026#39;, \u0026#39;\u0026#39;) gametype = td[2].string.replace(\u0026#34; \u0026#34;, \u0026#34;\u0026#34;).replace(\u0026#39;\\n\u0026#39;, \u0026#39;\u0026#39;).replace(\u0026#39;\\r\u0026#39;, \u0026#39;\u0026#39;) start = td[3].string.replace(\u0026#34; \u0026#34;, \u0026#34;\u0026#34;).replace(\u0026#39;\\n\u0026#39;, \u0026#39;\u0026#39;).replace(\u0026#39;\\r\u0026#39;, \u0026#39;\u0026#39;) end = td[4].string.replace(\u0026#34; \u0026#34;, \u0026#34;\u0026#34;).replace(\u0026#39;\\n\u0026#39;, \u0026#39;\u0026#39;).replace(\u0026#39;\\r\u0026#39;, \u0026#39;\u0026#39;) time = td[5].string.replace(\u0026#34; \u0026#34;, \u0026#34;\u0026#34;).replace(\u0026#39;\\n\u0026#39;, \u0026#39;\u0026#39;).replace(\u0026#39;\\r\u0026#39;, \u0026#39;\u0026#39;) oringin = td[6].find(\u0026#39;span\u0026#39;).string.replace(\u0026#34; \u0026#34;, \u0026#34;\u0026#34;).replace(\u0026#39;\\n\u0026#39;, \u0026#39;\u0026#39;).replace(\u0026#39;\\r\u0026#39;, \u0026#39;\u0026#39;) text = text + \u0026#34;åºå·ï¼š\u0026#34; + str( i) + \u0026#39;\u0026lt;br\u0026gt;\u0026#39; + \u0026#34;æ¸¸æˆåç§°ï¼š\u0026#34; + name + \u0026#39;\u0026lt;br\u0026gt;\u0026#39; + \u0026#34;DLC/gameï¼š\u0026#34; + gametype + \u0026#39;\u0026lt;br\u0026gt;\u0026#39; + \u0026#34;å¼€å§‹æ—¶é—´ï¼š\u0026#34; + start + \u0026#39;\u0026lt;br\u0026gt;\u0026#39; + \u0026#34;ç»“æŸæ—¶é—´ï¼š\u0026#34; + end + \u0026#39;\u0026lt;br\u0026gt;\u0026#39; + \u0026#34;æ˜¯å¦æ°¸ä¹…ï¼š\u0026#34; + time + \u0026#39;\u0026lt;br\u0026gt;\u0026#39; + \u0026#34;å¹³å°ï¼š\u0026#34; + oringin + \u0026#39;\u0026lt;br\u0026gt;\u0026#39; # print(text) i++ return text def send_to_epic_message(text_info): content = \u0026#39;\u0026#39;.join(text_info) token = \u0026#39;xxxxxxxxxxxxxxxxx\u0026#39; day_time = time.strftime(\u0026#39;%Y-%m-%d\u0026#39;, time.localtime(time.time())) title = f\u0026#39;å–œåŠ ä¸€ å…è´¹æ¸¸æˆ-{day_time}\u0026#39; # æ”¹æˆä½ è¦çš„æ ‡é¢˜å†…å®¹ error_time = time.strftime(\u0026#39;%Y-%m-%d %H:%M:%S\u0026#39;, time.localtime(time.time())) # è·å–æ ¼å¼åŒ–çš„æ—¶é—´ url = \u0026#39;http://www.pushplus.plus/send\u0026#39; data = { \u0026#34;token\u0026#34;: token, # å¯†é’¥ \u0026#34;title\u0026#34;: title, # æ ‡é¢˜ \u0026#34;content\u0026#34;: content, # å‘é€çš„ä¿¡æ¯å†…å®¹ï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¯jsonæ•°ç»„ \u0026#34;template\u0026#34;: \u0026#34;markdown\u0026#34; # æ•°æ®ç±»å‹ä¸ºjson } body = json.dumps(data).encode(encoding=\u0026#39;utf-8\u0026#39;) headers = {\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;} request_result = requests.post(url, data=body, headers=headers) if __name__ == \u0026#34;__main__\u0026#34;: game_info = get_free() if len(game_info) \u0026gt; 40: send_to_epic_message(get_free()) å‚è€ƒæ–‡æ¡£ï¼špythonè·å–steam/epicå–œåŠ ä¸€ä¿¡æ¯å¹¶è‡ªåŠ¨å‘é€åˆ°å¾®ä¿¡ - çŸ¥ä¹\n","date":"2022-12-30T14:30:16Z","image":"https://www.ownit.top/title_pic/32.jpg","permalink":"https://www.ownit.top/p/202212301430/","title":"Pythoné€šçŸ¥Epicç™½å«–æ¸¸æˆä¿¡æ¯"},{"content":"K8Séƒ¨ç½²Apolloé…ç½®ä¸­å¿ƒ å‚è€ƒæ–‡æ¡£: https://github.com/apolloconfig/apollo/tree/v1.8.0\n1 2 3 [K8Séƒ¨ç½²apolloé…ç½®ä¸­å¿ƒ](https://www.cnblogs.com/Fengyinyong/p/14903725.html) [apolloå®˜ç½‘æ–‡æ¡£](https://www.apolloconfig.com/#/zh/README) 1ã€é”™è¯¯é—®é¢˜è®°å½• åœ¨k8sé‡Œé¢éƒ¨ç½²æ—¶ä¹Ÿé‡åˆ°äº†åŒæ ·çš„ä¸€äº›é—®é¢˜ï¼Œåœ¨æ­¤è®°å½•ä¸‹ï¼š\næç¤ºexec user process caused \u0026quot;no such file or directory\u0026quot;\nç”±äºå°†Windowsæ–‡ä»¶æ‹·è´åˆ°CentOSé‡Œé¢å¯¼è‡´çš„æ¢è¡Œç¬¦ä¸å¯¹ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯åœ¨CentOSè™šæœºå†…git clone å½“å‰ä»“å‚¨ æ„å»ºçš„dockeré•œåƒå¯åŠ¨å¤±è´¥\nåŒä¸Šä¸€ä¸ªé—®é¢˜ï¼Œä»Windowsæ‹·è´è¿‡å»çš„æ–‡ä»¶æƒé™ä¸æ­£ç¡®å¯¼è‡´çš„shellè„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œè§£å†³æ–¹æ¡ˆåŒä¸Šæˆ–è€…chmod +x ä¸€ä¸ªç¯å¢ƒçš„admin serverç”±äºå¥åº·æ£€æŸ¥ä¸è¿‡å¯¼è‡´ä¸æ–­é‡å¯\næ•°æ®åº“å¸å·å¡«é”™äº†å¯¼è‡´æ— æ³•ç™»å½•æ•°æ®åº“å¼•å‘çš„é—®é¢˜ 2ã€ä»‹ç» Apolloï¼ˆé˜¿æ³¢ç½—ï¼‰æ˜¯æºç¨‹æ¡†æ¶éƒ¨é—¨ç ”å‘çš„åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œèƒ½å¤Ÿé›†ä¸­åŒ–ç®¡ç†åº”ç”¨ä¸åŒç¯å¢ƒã€ä¸åŒé›†ç¾¤çš„é…ç½®ï¼Œé…ç½®ä¿®æ”¹åèƒ½å¤Ÿå®æ—¶æ¨é€åˆ°åº”ç”¨ç«¯ï¼Œå¹¶ä¸”å…·å¤‡è§„èŒƒçš„æƒé™ã€æµç¨‹æ²»ç†ç­‰ç‰¹æ€§ï¼Œé€‚ç”¨äºå¾®æœåŠ¡é…ç½®ç®¡ç†åœºæ™¯ã€‚\næœåŠ¡ç«¯åŸºäºSpring Bootå’ŒSpring Cloudå¼€å‘ï¼Œæ‰“åŒ…åå¯ä»¥ç›´æ¥è¿è¡Œï¼Œä¸éœ€è¦é¢å¤–å®‰è£…Tomcatç­‰åº”ç”¨å®¹å™¨ã€‚\nJavaå®¢æˆ·ç«¯ä¸ä¾èµ–ä»»ä½•æ¡†æ¶ï¼Œèƒ½å¤Ÿè¿è¡Œäºæ‰€æœ‰Javaè¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒæ—¶å¯¹Spring/Spring Bootç¯å¢ƒä¹Ÿæœ‰è¾ƒå¥½çš„æ”¯æŒã€‚\n.Netå®¢æˆ·ç«¯ä¸ä¾èµ–ä»»ä½•æ¡†æ¶ï¼Œèƒ½å¤Ÿè¿è¡Œäºæ‰€æœ‰.Netè¿è¡Œæ—¶ç¯å¢ƒã€‚\nâ€\nè¯´æ˜ï¼šæœ€è¿‘åœ¨ç”¨K8Séƒ¨ç½²å¾®æœåŠ¡ï¼Œè€Œå¾®æœåŠ¡çš„é…ç½®æ–‡ä»¶ä¼—å¤šï¼Œéœ€è¦ä¸€ä¸ªé…ç½®ä¸­å¿ƒæ¥å¤„ç†é…ç½®æ–‡ä»¶ã€‚äºæ˜¯é‡‡ç”¨apolloæ¥ä½œä¸ºé…ç½®ä¸­å¿ƒã€‚æœ¬å®ä¾‹ä»‹ç»äº†å¦‚ä½•é‡‡ç”¨K8Séƒ¨ç½²é«˜å¯ç”¨çš„apolloé›†ç¾¤ã€‚\nâ€\n3ã€ç¯å¢ƒé…ç½® mysql5.7.39\næ³¨æ„ï¼šmysqlçš„ç‰ˆæœ¬ä¸€å®šè¦å¤§äº5.7ï¼Œä¸ç„¶å¯¼å…¥æ•°æ®åº“sqlæ–‡ä»¶ä¼šæŠ¥é”™çš„\nå› ä¸ºå®éªŒæ–¹ä¾¿ï¼Œç»™rootè¿œç¨‹ç™»å½•æƒé™ï¼ˆåˆ‡å¿Œï¼Œç”Ÿäº§ç¯å¢ƒï¼Œç¦ç”¨rootï¼Œå•ç‹¬æ•°æ®åº“é…ç½®å•ç‹¬è´¦å·ï¼‰\næ•°æ®åº“åç§° IP ä½œç”¨ è¿œç¨‹è´¦å· DevApolloConfigDB 192.168.102.20 DEVç¯å¢ƒçš„é…ç½® root ProdApolloConfigDB 192.168.102.20 PROç¯å¢ƒçš„é…ç½® root ApolloPortalDB 192.168.102.20 WEBç•Œé¢ç®¡ç† root â€\nå®‰è£…Apolloç‰ˆæœ¬ï¼š1.8.0ï¼ˆæ³¨æ„ï¼šsqlæ–‡ä»¶å’Œjarç‰ˆæœ¬ä¸€å®šè¦å¯¹åº”ï¼‰\nï¼ˆç›®å‰å®˜æ–¹ç»™4å¥—ç¯å¢ƒéƒ¨ç½²å®‰è£…ï¼Œæˆ‘è¿™è¾¹é‡‡ç”¨PROå’ŒDEVç¯å¢ƒï¼‰\nå·²ç»æ„å»ºæˆåŠŸçš„Kubernetesé›†ç¾¤ï¼Œ\n1 2 3 4 5 [root@bt nginx]# kubectl get node NAME STATUS ROLES AGE VERSION master01 Ready control-plane,master 2d16h v1.23.0 node01 Ready \u0026lt;none\u0026gt; 2d16h v1.23.0 node02 Ready \u0026lt;none\u0026gt; 2d16h v1.23.0 4ã€Apolloå®‰è£… â€\n1ã€å…‹éš†Apolloä»£ç  å®˜æ–¹åœ°å€ï¼šhttps://github.com/apolloconfig/apollo\nåœ¨Centosä¸Šå…‹éš†ï¼ˆå› ä¸ºå­—ç¬¦åŸå› ï¼Œæ‰€ä»¥è¦åœ¨Linuxå…‹éš†ï¼Œåƒä¸‡ä¸è¦winä¸Šä¸‹è½½ä¸Šä¼ ï¼Œå®¹æ˜“å‡ºé—®é¢˜ï¼‰\n1 2 3 4 5 6 7 8 9 10 git clone https://github.com/apolloconfig/apollo.git cd apollo #æŸ¥çœ‹ç‰ˆæœ¬ï¼Œ git tag #åˆ‡æ¢åˆ†æ”¯ git checkout v1.8.0 #åˆ›å»ºæ–°çš„åˆ†æ”¯ï¼Œåˆ‡æ¢ git checkout -b heian 2ã€åˆå§‹åŒ–Mysqlæ•°æ®åº“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 [root@bt db]# pwd /opt/apollo/scripts/apollo-on-kubernetes/db [root@bt db]# ls config-db-dev config-db-prod config-db-test-alpha config-db-test-beta portal-db [root@bt db]# tree . . â”œâ”€â”€ config-db-dev â”‚?? â””â”€â”€ apolloconfigdb.sql â”œâ”€â”€ config-db-prod â”‚?? â””â”€â”€ apolloconfigdb.sql â”œâ”€â”€ config-db-test-alpha â”‚?? â””â”€â”€ apolloconfigdb.sql â”œâ”€â”€ config-db-test-beta â”‚?? â””â”€â”€ apolloconfigdb.sql â””â”€â”€ portal-db â””â”€â”€ apolloportaldb.sql å¤§èƒ†æ‰§è¡Œï¼Œæ•°æ®åº“åç§°å®˜æ–¹å®šä¹‰è¿‡ï¼Œä¸ä¼šå†²çª æ‰§è¡Œdevç¯å¢ƒ cd config-db-dev/ [root@bt config-db-dev]# mysql -uroot -p \u0026lt; apolloconfigdb.sql Enter password: æ‰§è¡Œproç¯å¢ƒ cd config-db-pro/ [root@bt config-db-dev]# mysql -uroot -p \u0026lt; apolloconfigdb.sql Enter password: æ‰§è¡Œportalç¯å¢ƒ cd portal-db/ [root@bt config-db-dev]# mysql -uroot -p \u0026lt; apolloportaldb.sql 3ã€ä¸‹è½½jarç‰ˆæœ¬ â€\nå®˜æ–¹ä¸‹è½½åœ°å€ï¼šhttps://github.com/apolloconfig/apollo/releases/tag/v1.8.0\n1 2 3 4 cd /opt/apollo wget https://github.com/apolloconfig/apollo/releases/download/v1.8.0/apollo-adminservice-1.8.0-github.zip wget https://github.com/apolloconfig/apollo/releases/download/v1.8.0/apollo-configservice-1.8.0-github.zip wget https://github.com/apolloconfig/apollo/releases/download/v1.8.0/apollo-portal-1.8.0-github.zip è¿›è¡Œè§£å‹ï¼Œéœ€è¦å…¶ä¸­çš„jar\n1 2 3 4 5 6 7 8 â€‹ è§£å‹ apollo-portal-1.8.0-github.zip â€‹ è·å– apollo-portal-1.8.0.jar, é‡å‘½åä¸º apollo-portal.jar, æ”¾åˆ° scripts/apollo-on-kubernetes/apollo-portal-server â€‹ è§£å‹ apollo-adminservice-1.8.0-github.zip â€‹ è·å– apollo-adminservice-1.8.0.jar, é‡å‘½åä¸º apollo-adminservice.jar, æ”¾åˆ° scripts/apollo-on-kubernetes/apollo-admin-server â€‹ è§£å‹ apollo-configservice-1.8.0-github.zip â€‹ è·å– apollo-configservice-1.8.0.jar, é‡å‘½åä¸º apollo-configservice.jar, æ”¾åˆ° scripts/apollo-on-kubernetes/apollo-config-se 4ã€æ„å»ºDockeré•œåƒ 1ã€é‡‡ç”¨K8Séƒ¨ç½²apolloæ—¶ï¼Œéœ€è¦ç”¨åˆ°å¤šä¸ªé•œåƒã€‚è¿™äº›é•œåƒï¼Œéœ€è¦è‡ªå·±æ„å»º\n2ã€å¦‚æœéº»çƒ¦ï¼Œå¯ä»¥å»å®˜æ–¹é•œåƒ https://hub.docker.com/u/apolloconfig\n1 2 3 4 5 6 docker pull apolloconfig/apollo-configservice:1.8.0 docker pull apolloconfig/apollo-adminservice:1.8.0 docker pull apolloconfig/apollo-portal:1.8.0 è¿˜éœ€è¦ä¸€ä¸ªalpine-bash-3.8 åšåˆå§‹åŒ–é•œåƒæ“ä½œ docker pull zgadocker/alpine-bash-3.8-image:latest æµ‹è¯•è¿™ä¸ªä¸è¡Œï¼Œå°±æŒ‰ç…§ä¸‹æ–¹è‡ªå·±æ‰“åŒ… alpine-bash-3.8-image 1 2 3 [root@bt apollo-on-kubernetes]# cd alpine-bash-3.8-image [root@bt alpine-bash-3.8-image]# docker build -t harbor.ownit.top/ownit/alpine-bash:3.8 . [root@bt alpine-bash-3.8-image]# docker push harbor.ownit.top/ownit/alpine-bash:3.8 apollo-config-server 1 2 3 [root@bt apollo-on-kubernetes]# cd apollo-config-server [root@bt apollo-config-server]# docker build -t harbor.ownit.top/ownit/apollo-configservice:1.8.0 . [root@bt apollo-config-server]# docker push harbor.ownit.top/ownit/apollo-configservice:1.8.0 apollo-admin-server 1 2 3 [root@bt apollo-on-kubernetes]# cd apollo-admin-server [root@bt apollo-admin-server]# docker build -t harbor.ownit.top/ownit/apollo-adminservice:1.8.0 . [root@bt apollo-admin-server]# docker push harbor.ownit.top/ownit/apollo-adminservice:1.8.0 apollo-portal-server 1 2 3 [root@bt apollo-on-kubernetes]# cd apollo-portal-server [root@bt apollo-portal-server]# docker build -t harbor.ownit.top/ownit/apollo-portal:1.8.0 . [root@bt apollo-portal-server]# docker push harbor.ownit.top/ownit/apollo-portal:1.8.0 éªŒè¯ 5ã€é…ç½®Yamlæ–‡ä»¶ ç¯å¢ƒ æ–‡ä»¶åç§° æ‰§è¡Œé¡ºåº dev service-apollo-config-server-dev.yaml 1 dev service-apollo-admin-server-dev.yaml 2 pro service-apollo-config-server-prod.yaml 3 pro service-apollo-admin-server-prod.yaml 4 portal service-apollo-portal-server.yaml 5 1ã€service-apollo-config-server-dev.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 --- # configmap for apollo-config-server-dev kind: ConfigMap apiVersion: v1 metadata: namespace: sre name: configmap-apollo-config-server-dev data: application-github.properties: | spring.datasource.url = jdbc:mysql://192.168.102.20:3306/DevApolloConfigDB?characterEncoding=utf8\u0026amp;serverTimezone=Asia/Shanghai spring.datasource.username = root spring.datasource.password = 123456 eureka.service.url = http://statefulset-apollo-config-server-dev-0.service-apollo-meta-server-dev:8080/eureka/,http://statefulset-apollo-config-server-dev-1.service-apollo-meta-server-dev:8080/eureka/,http://statefulset-apollo-config-server-dev-2.service-apollo-meta-server-dev:8080/eureka/ --- kind: Service apiVersion: v1 metadata: namespace: sre name: service-apollo-meta-server-dev labels: app: service-apollo-meta-server-dev spec: ports: - protocol: TCP port: 8080 targetPort: 8080 selector: app: pod-apollo-config-server-dev type: ClusterIP clusterIP: None sessionAffinity: ClientIP --- kind: Service apiVersion: v1 metadata: namespace: sre name: service-apollo-config-server-dev labels: app: service-apollo-config-server-dev spec: ports: - protocol: TCP port: 8080 targetPort: 8080 nodePort: 30002 selector: app: pod-apollo-config-server-dev type: NodePort sessionAffinity: ClientIP --- kind: StatefulSet apiVersion: apps/v1 metadata: namespace: sre name: statefulset-apollo-config-server-dev labels: app: statefulset-apollo-config-server-dev spec: serviceName: service-apollo-meta-server-dev replicas: 1 selector: matchLabels: app: pod-apollo-config-server-dev updateStrategy: type: RollingUpdate template: metadata: labels: app: pod-apollo-config-server-dev spec: affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - pod-apollo-config-server-dev topologyKey: kubernetes.io/hostname volumes: - name: volume-configmap-apollo-config-server-dev configMap: name: configmap-apollo-config-server-dev items: - key: application-github.properties path: application-github.properties containers: - image: harbor.ownit.top/ownit/apollo-configservice:1.8.0 securityContext: privileged: true imagePullPolicy: IfNotPresent name: container-apollo-config-server-dev ports: - protocol: TCP containerPort: 8080 volumeMounts: - name: volume-configmap-apollo-config-server-dev mountPath: /apollo-config-server/config/application-github.properties subPath: application-github.properties env: - name: APOLLO_CONFIG_SERVICE_NAME value: \u0026#34;service-apollo-config-server-dev.sre\u0026#34; readinessProbe: tcpSocket: port: 8080 initialDelaySeconds: 10 periodSeconds: 5 livenessProbe: tcpSocket: port: 8080 initialDelaySeconds: 120 periodSeconds: 10 dnsPolicy: ClusterFirst restartPolicy: Always 2ã€service-apollo-admin-server-dev.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 --- # configmap for apollo-admin-server-dev kind: ConfigMap apiVersion: v1 metadata: namespace: sre name: configmap-apollo-admin-server-dev data: application-github.properties: | spring.datasource.url = jdbc:mysql://192.168.102.20:3306/DevApolloConfigDB?characterEncoding=utf8\u0026amp;serverTimezone=Asia/Shanghai spring.datasource.username = root spring.datasource.password = 123456 eureka.service.url = http://statefulset-apollo-config-server-dev-0.service-apollo-meta-server-dev:8080/eureka/,http://statefulset-apollo-config-server-dev-1.service-apollo-meta-server-dev:8080/eureka/,http://statefulset-apollo-config-server-dev-2.service-apollo-meta-server-dev:8080/eureka/ --- kind: Service apiVersion: v1 metadata: namespace: sre name: service-apollo-admin-server-dev labels: app: service-apollo-admin-server-dev spec: ports: - protocol: TCP port: 8090 targetPort: 8090 selector: app: pod-apollo-admin-server-dev type: ClusterIP sessionAffinity: ClientIP --- kind: Deployment apiVersion: apps/v1 metadata: namespace: sre name: deployment-apollo-admin-server-dev labels: app: deployment-apollo-admin-server-dev spec: replicas: 1 selector: matchLabels: app: pod-apollo-admin-server-dev strategy: rollingUpdate: maxSurge: 1 maxUnavailable: 1 type: RollingUpdate template: metadata: labels: app: pod-apollo-admin-server-dev spec: affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - pod-apollo-admin-server-dev topologyKey: kubernetes.io/hostname volumes: - name: volume-configmap-apollo-admin-server-dev configMap: name: configmap-apollo-admin-server-dev items: - key: application-github.properties path: application-github.properties initContainers: - image: harbor.ownit.top/ownit/alpine-bash:3.8 name: check-service-apollo-config-server-dev command: [\u0026#39;bash\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#34;curl --connect-timeout 2 --max-time 5 --retry 60 --retry-delay 1 --retry-max-time 120 service-apollo-config-server-dev.sre:8080\u0026#34;] containers: - image: harbor.ownit.top/ownit/apollo-adminservice:1.8.0 securityContext: privileged: true imagePullPolicy: IfNotPresent name: container-apollo-admin-server-dev ports: - protocol: TCP containerPort: 8090 volumeMounts: - name: volume-configmap-apollo-admin-server-dev mountPath: /apollo-admin-server/config/application-github.properties subPath: application-github.properties env: - name: APOLLO_ADMIN_SERVICE_NAME value: \u0026#34;service-apollo-admin-server-dev.sre\u0026#34; readinessProbe: tcpSocket: port: 8090 initialDelaySeconds: 10 periodSeconds: 5 livenessProbe: tcpSocket: port: 8090 initialDelaySeconds: 120 periodSeconds: 10 dnsPolicy: ClusterFirst restartPolicy: Always 3ã€service-apollo-config-server-prod.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 --- # configmap for apollo-config-server-prod kind: ConfigMap apiVersion: v1 metadata: namespace: sre name: configmap-apollo-config-server-prod data: application-github.properties: | spring.datasource.url = jdbc:mysql://192.168.102.20:3306/ProdApolloConfigDB?characterEncoding=utf8\u0026amp;serverTimezone=Asia/Shanghai spring.datasource.username = root spring.datasource.password = 123456 eureka.service.url = http://statefulset-apollo-config-server-prod-0.service-apollo-meta-server-prod:8080/eureka/,http://statefulset-apollo-config-server-prod-1.service-apollo-meta-server-prod:8080/eureka/,http://statefulset-apollo-config-server-prod-2.service-apollo-meta-server-prod:8080/eureka/ --- kind: Service apiVersion: v1 metadata: namespace: sre name: service-apollo-meta-server-prod labels: app: service-apollo-meta-server-prod spec: ports: - protocol: TCP port: 8080 targetPort: 8080 selector: app: pod-apollo-config-server-prod type: ClusterIP clusterIP: None sessionAffinity: ClientIP --- kind: Service apiVersion: v1 metadata: namespace: sre name: service-apollo-config-server-prod labels: app: service-apollo-config-server-prod spec: ports: - protocol: TCP port: 8080 targetPort: 8080 nodePort: 30005 selector: app: pod-apollo-config-server-prod type: NodePort sessionAffinity: ClientIP --- kind: StatefulSet apiVersion: apps/v1 metadata: namespace: sre name: statefulset-apollo-config-server-prod labels: app: statefulset-apollo-config-server-prod spec: serviceName: service-apollo-meta-server-prod replicas: 1 selector: matchLabels: app: pod-apollo-config-server-prod updateStrategy: type: RollingUpdate template: metadata: labels: app: pod-apollo-config-server-prod spec: affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - pod-apollo-config-server-prod topologyKey: kubernetes.io/hostname volumes: - name: volume-configmap-apollo-config-server-prod configMap: name: configmap-apollo-config-server-prod items: - key: application-github.properties path: application-github.properties containers: - image: harbor.ownit.top/ownit/apollo-configservice:1.8.0 securityContext: privileged: true imagePullPolicy: Always name: container-apollo-config-server-prod ports: - protocol: TCP containerPort: 8080 volumeMounts: - name: volume-configmap-apollo-config-server-prod mountPath: /apollo-config-server/config/application-github.properties subPath: application-github.properties env: - name: APOLLO_CONFIG_SERVICE_NAME value: \u0026#34;service-apollo-config-server-prod.sre\u0026#34; readinessProbe: tcpSocket: port: 8080 initialDelaySeconds: 10 periodSeconds: 5 livenessProbe: tcpSocket: port: 8080 initialDelaySeconds: 120 periodSeconds: 10 dnsPolicy: ClusterFirst restartPolicy: Always 3ã€service-apollo-admin-server-prod.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 --- # configmap for apollo-admin-server-prod kind: ConfigMap apiVersion: v1 metadata: namespace: sre name: configmap-apollo-admin-server-prod data: application-github.properties: | spring.datasource.url = jdbc:mysql://192.168.102.20:3306/ProdApolloConfigDB?characterEncoding=utf8\u0026amp;serverTimezone=Asia/Shanghai spring.datasource.username = root spring.datasource.password = 123456 eureka.service.url = http://statefulset-apollo-config-server-prod-0.service-apollo-meta-server-prod:8080/eureka/,http://statefulset-apollo-config-server-prod-1.service-apollo-meta-server-prod:8080/eureka/,http://statefulset-apollo-config-server-prod-2.service-apollo-meta-server-prod:8080/eureka/ --- kind: Service apiVersion: v1 metadata: namespace: sre name: service-apollo-admin-server-prod labels: app: service-apollo-admin-server-prod spec: ports: - protocol: TCP port: 8090 targetPort: 8090 selector: app: pod-apollo-admin-server-prod type: ClusterIP sessionAffinity: ClientIP --- kind: Deployment apiVersion: apps/v1 metadata: namespace: sre name: deployment-apollo-admin-server-prod labels: app: deployment-apollo-admin-server-prod spec: replicas: 1 selector: matchLabels: app: pod-apollo-admin-server-prod strategy: rollingUpdate: maxSurge: 1 maxUnavailable: 1 type: RollingUpdate template: metadata: labels: app: pod-apollo-admin-server-prod spec: affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - pod-apollo-admin-server-prod topologyKey: kubernetes.io/hostname volumes: - name: volume-configmap-apollo-admin-server-prod configMap: name: configmap-apollo-admin-server-prod items: - key: application-github.properties path: application-github.properties initContainers: - image: harbor.ownit.top/ownit/alpine-bash:3.8 name: check-service-apollo-config-server-prod command: [\u0026#39;bash\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#34;curl --connect-timeout 2 --max-time 5 --retry 50 --retry-delay 1 --retry-max-time 120 service-apollo-config-server-prod.sre:8080\u0026#34;] containers: - image: harbor.ownit.top/ownit/apollo-adminservice:1.8.0 securityContext: privileged: true imagePullPolicy: IfNotPresent name: container-apollo-admin-server-prod ports: - protocol: TCP containerPort: 8090 volumeMounts: - name: volume-configmap-apollo-admin-server-prod mountPath: /apollo-admin-server/config/application-github.properties subPath: application-github.properties env: - name: APOLLO_ADMIN_SERVICE_NAME value: \u0026#34;service-apollo-admin-server-prod.sre\u0026#34; readinessProbe: tcpSocket: port: 8090 initialDelaySeconds: 10 periodSeconds: 5 livenessProbe: tcpSocket: port: 8090 initialDelaySeconds: 120 periodSeconds: 10 dnsPolicy: ClusterFirst restartPolicy: Always 5ã€service-apollo-portal-server.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 --- # ä¸ºå¤–éƒ¨ mysql æœåŠ¡è®¾ç½® service kind: Service apiVersion: v1 metadata: namespace: sre name: service-mysql-for-portal-server labels: app: service-mysql-for-portal-server spec: ports: - protocol: TCP port: 3306 targetPort: 3306 type: ClusterIP sessionAffinity: None --- kind: Endpoints apiVersion: v1 metadata: namespace: sre name: service-mysql-for-portal-server subsets: - addresses: # æ›´æ”¹ä¸ºä½ çš„ mysql addresses, ä¾‹å¦‚ 1.1.1.1 - ip: 192.168.102.20 ports: - protocol: TCP port: 3306 --- # configmap for apollo-portal-server kind: ConfigMap apiVersion: v1 metadata: namespace: sre name: configmap-apollo-portal-server data: application-github.properties: | spring.datasource.url = jdbc:mysql://192.168.102.20:3306/ApolloPortalDB?characterEncoding=utf8 # mysql username spring.datasource.username = root # mysql password spring.datasource.password = 123456 apollo-env.properties: | dev.meta=http://service-apollo-config-server-dev.sre:8080 fat.meta=http://service-apollo-config-server-test-alpha.sre:8080 uat.meta=http://service-apollo-config-server-test-beta.sre:8080 pro.meta=http://service-apollo-config-server-prod.sre:8080 --- kind: Service apiVersion: v1 metadata: namespace: sre name: service-apollo-portal-server labels: app: service-apollo-portal-server spec: ports: - protocol: TCP port: 8070 targetPort: 8070 nodePort: 30001 selector: app: pod-apollo-portal-server type: NodePort # portal session ä¿æŒ sessionAffinity: ClientIP --- kind: Deployment apiVersion: apps/v1 metadata: namespace: sre name: deployment-apollo-portal-server labels: app: deployment-apollo-portal-server spec: # 3 ä¸ªå®ä¾‹ replicas: 1 selector: matchLabels: app: pod-apollo-portal-server strategy: rollingUpdate: maxSurge: 1 maxUnavailable: 1 type: RollingUpdate template: metadata: labels: app: pod-apollo-portal-server spec: affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - pod-apollo-portal-server topologyKey: kubernetes.io/hostname volumes: - name: volume-configmap-apollo-portal-server configMap: name: configmap-apollo-portal-server items: - key: application-github.properties path: application-github.properties - key: apollo-env.properties path: apollo-env.properties initContainers: # ç¡®ä¿ admin-service æ­£å¸¸æä¾›æœåŠ¡ - image: harbor.ownit.top/ownit/alpine-bash:3.8 name: check-service-apollo-admin-server-dev command: [\u0026#39;bash\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#34;curl --connect-timeout 2 --max-time 5 --retry 60 --retry-delay 1 --retry-max-time 120 service-apollo-admin-server-dev.sre:8090\u0026#34;] # - image: harbor.ownit.top/ownit/alpine-bash:3.8 # name: check-service-apollo-admin-server-alpha # command: [\u0026#39;bash\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#34;curl --connect-timeout 2 --max-time 5 --retry 60 --retry-delay 1 --retry-max-time 120 service-apollo-admin-server-test-alpha.sre:8090\u0026#34;] # - image: harbor.ownit.top/ownit/alpine-bash:3.8 # name: check-service-apollo-admin-server-beta # command: [\u0026#39;bash\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#34;curl --connect-timeout 2 --max-time 5 --retry 60 --retry-delay 1 --retry-max-time 120 service-apollo-admin-server-test-beta.sre:8090\u0026#34;] - image: harbor.ownit.top/ownit/alpine-bash:3.8 name: check-service-apollo-admin-server-prod command: [\u0026#39;bash\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#34;curl --connect-timeout 2 --max-time 5 --retry 60 --retry-delay 1 --retry-max-time 120 service-apollo-admin-server-prod.sre:8090\u0026#34;] containers: - image: harbor.ownit.top/ownit/apollo-portal:1.8.0 # æ›´æ”¹ä¸ºä½ çš„ docker registry ä¸‹çš„ image securityContext: privileged: true imagePullPolicy: IfNotPresent name: container-apollo-portal-server ports: - protocol: TCP containerPort: 8070 volumeMounts: - name: volume-configmap-apollo-portal-server mountPath: /apollo-portal-server/config/application-github.properties subPath: application-github.properties - name: volume-configmap-apollo-portal-server mountPath: /apollo-portal-server/config/apollo-env.properties subPath: apollo-env.properties env: - name: APOLLO_PORTAL_SERVICE_NAME value: \u0026#34;service-apollo-portal-server.sre\u0026#34; readinessProbe: tcpSocket: port: 8070 initialDelaySeconds: 10 periodSeconds: 5 livenessProbe: tcpSocket: port: 8070 # 120s å†…, server æœªå¯åŠ¨åˆ™é‡å¯ container initialDelaySeconds: 120 periodSeconds: 15 dnsPolicy: ClusterFirst restartPolicy: Always 6ã€æ‰§è¡ŒYamlæ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 # create namespace kubectl create namespace sre devç¯å¢ƒ kubectl apply -f apollo-env-dev/service-apollo-config-server-dev.yaml --record kubectl apply -f apollo-env-dev/service-apollo-admin-server-dev.yaml --record proç¯å¢ƒ kubectl apply -f apollo-env-prod/service-apollo-config-server-prod.yaml --record kubectl apply -f apollo-env-prod/service-apollo-admin-server-prod.yaml --record 7ã€é…ç½®ingressåŸŸå apollo-ingress.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 --- apiVersion: networking.k8s.io/v1 kind: Ingress metadata: namespace: sre name: service-apollo-portal-server annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/proxy-body-size: \u0026#34;0\u0026#34; nginx.ingress.kubernetes.io/proxy-read-timeout: \u0026#34;600\u0026#34; nginx.ingress.kubernetes.io/proxy-send-timeout: \u0026#34;600\u0026#34; kubernetes.io/tls-acme: \u0026#34;true\u0026#34; cert-manager.io/cluster-issuer: \u0026#34;example-issuer\u0026#34; labels: app: service-apollo-portal-server spec: rules: - host: apollo.ownit.top http: paths: - pathType: Prefix path: / backend: service: name: service-apollo-portal-server port: number: 8070 8ã€é…ç½®nginxä»£ç† â€\nnginxé…ç½®\napollo.ownit.top.conf\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 server { listen 80; server_name apollo.ownit.top; rewrite ^/(.*)$ https://$host/$1 permanent; # IPç™½åå• include /opt/nginx/whitelist/corporation.conf; } server { listen 443 ssl; server_name apollo.ownit.top; # IPç™½åå• include /opt/nginx/whitelist/corporation.conf; #ssl on; ssl_certificate /opt/nginx/ssl/ownit.top.crt; ssl_certificate_key /opt/nginx/ssl/ownit.top.key; include ssl.conf; location / { proxy_pass http://kubernetes-cluster; #è½¬å‘åˆ°k8sçš„ingress 80ç«¯å£ include https_proxy.conf; } access_log /www/wwwlogs/apollo.ownit.top.log; error_log /www/wwwlogs/apollo.ownit.top.error.log; } [root@bt nginx]# nginx -t nginx: the configuration file /www/server/nginx/conf/nginx.conf syntax is ok nginx: configuration file /www/server/nginx/conf/nginx.conf test is successful [root@bt nginx]# nginx -s reload kubernetes-cluster.conf è½¬å‘\n1 2 3 4 5 [root@bt nginx]# cat kubernetes-cluster.conf upstream kubernetes-cluster { server 192.168.102.40 weight=5; keepalive 16; } 9ã€é…ç½®powerdnsåŸŸåè§£æ 10ã€æµ‹è¯•éªŒè¯ https://apollo.ownit.top/\né»˜è®¤è´¦å·/å¯†ç ï¼šapollo / admin\nå¦‚æœæ²¡æœ‰ingressï¼Œåˆ™å¯ä½¿ç”¨nodeportè®¿é—®\nk8sèŠ‚ç‚¹ip+30001 ç«¯å£å³å¯è®¿é—®\nhttp://k8sèŠ‚ç‚¹ip:30001/\n5ã€Apolloé…ç½®ä½¿ç”¨ 1ã€æ·»åŠ è¶…çº§ç®¡ç†å‘˜ç”¨æˆ· 1ã€ç®¡ç†å‘˜ç”¨æˆ·é€‰æ‹© ç®¡ç†å‘˜å·¥å…·-\u0026gt;ç³»ç»Ÿå‚æ•°\n2ã€å¡«å…¥ç³»ç»Ÿå†…ç½®Keyï¼šsuperAdmin å¹¶ç‚¹å‡»æŸ¥è¯¢ï¼Œåœ¨valueéƒ¨åˆ†æ·»åŠ è¦åŠ å…¥äººçš„ç”¨æˆ·id(LDAPç”¨æˆ·IDä¸ºå‡†ï¼Œå¯é€šè¿‡wikiåå°ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢)åä¿å­˜å³å¯\n2ã€æ–°å¢éƒ¨é—¨ï¼šorganizations 1 [{\u0026#34;orgId\u0026#34;:\u0026#34;kaifa\u0026#34;,\u0026#34;orgName\u0026#34;:\u0026#34;å¼€å‘éƒ¨é—¨\u0026#34;},{\u0026#34;orgId\u0026#34;:\u0026#34;yunwei\u0026#34;,\u0026#34;orgName\u0026#34;:\u0026#34;è¿ç»´éƒ¨é—¨\u0026#34;},{\u0026#34;orgId\u0026#34;:\u0026#34;ceshi\u0026#34;,\u0026#34;orgName\u0026#34;:\u0026#34;æµ‹è¯•éƒ¨é—¨\u0026#34;}] 3ã€æ–°å¢ç¯å¢ƒï¼šapollo.portal.envs apollo.portal.envs\n6ã€namespaceç®¡ç† ç§æœ‰namespace 1ã€æ·»åŠ namespace Namespaceä½œä¸ºé…ç½®çš„åˆ†ç±»ï¼Œå¯å½“æˆä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚\nä»¥æ·»åŠ rocketmqé…ç½®ä¸ºä¾‹ï¼Œæ·»åŠ \u0026quot;spring-rocketmqâ€Namespaceé…ç½®rocketmqç›¸å…³ä¿¡æ¯ã€‚\n1ã€æ·»åŠ é¡¹ç›®ç§æœ‰Namespace:spring-rocketmq\nè¿›å…¥é¡¹ç›®é¦–é¡µï¼Œç‚¹å‡»å·¦ä¸‹è„šçš„â€æ·»åŠ Namespaceâ€ï¼Œå…±åŒ…æ‹¬ä¸¤é¡¹:å…³è”å…¬å…±Namespaceå’Œåˆ›å»ºNamespace ,è¿™é‡Œé€‰æ‹©\u0026quot;åˆ›å»ºNamespace\u0026quot;\n2ã€å¡«å†™è¯¦ç»†çš„ä¿¡æ¯\næœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸€ç§æ˜¯publicï¼ˆæ‰€æœ‰é¡¹ç›®çš„ï¼‰ï¼›å¦ä¸€ç§æ˜¯privateï¼ˆå½“å‰é¡¹ç›®çš„ï¼‰ï¼›å¦‚ä¸‹å›¾æ‰€ç¤º\n3ã€æäº¤è¿‡åä¼šè‡ªåŠ¨è·³è½¬åˆ°ä¸‹é¢çš„é¡µé¢ï¼ˆæ“æ§æƒé™ï¼‰\n4ã€ä¸æ“ä½œè¿”å›é¦–é¡µ\n2ã€ä¸ºnamespaceæ“ä½œé…ç½® å¯ä»¥æŒ‰ä¹‹å‰çš„æ–¹æ³•è¿›è¡Œæ“ä½œï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢çš„å†…å®¹è¿›è¡Œæ‰¹é‡æ“ä½œ\nå¦‚ï¼š\n1 2 rocketmq.name-server = 127.0.0.0:9876 rocketmq.producer.group = PID_ACCOUNT å‘å¸ƒ\nâ€\n3ã€è·å–namespaceé‡Œé¢çš„æ•°æ® ä¿®æ”¹ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class GetConfigTest { public static void main(String[] args) { while (true){ try { Thread.sleep(1000); } catch (InterruptedException e) { e.printStackTrace(); } // Config appConfig = ConfigService.getAppConfig(); //è¯»å–æŒ‡å®šçš„namespaceä¸‹çš„é…ç½®ä¿¡æ¯ Config config = ConfigService.getConfig(\u0026#34;spring-rocketmq\u0026#34;); //è·å–é…ç½®ä¿¡æ¯,ç¬¬ä¸€ä¸ªå‚æ•°:é…ç½®çš„keyï¼Œç¬¬äºŒä¸ªå‚æ•°:é»˜è®¤å€¼ String value = config.getProperty(\u0026#34;rocketmq.producer.group\u0026#34;, null); System.out.printf(\u0026#34;ç°åœ¨ï¼š%s, sms.enable: %s%n\u0026#34;, new Date().toString(),value); } } } è¿è¡Œç»“æœ\nå…¬å…±é…ç½® 1ã€æ·»åŠ å…¬å…±çš„namespace åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œæœ‰ä¸€äº›é…ç½®å¯èƒ½æ˜¯é€šç”¨çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠŠè¿™äº›é€šç”¨çš„é…ç½®æ”¾åˆ°å…¬å…±çš„Namespaceä¸­ï¼Œè¿™æ ·å…¶ä»–é¡¹ç›®è¦ä½¿ç”¨æ—¶å¯ä»¥ç›´æ¥æ·»åŠ éœ€è¦çš„Namespace\næ–°å»ºcommon-templateé¡¹ç›® 2ã€æ–°å»ºnamespace\n3ã€æ·»åŠ é…ç½®ä¿¡æ¯\n2ã€å‰å¾€å…¶ä»–çš„é¡¹ç›®å»å…³è”ç¬¬ä¸€æ­¥çš„namespace â€\n3ã€ä¿®æ”¹å…¬å…±é…ç½® ä¿®æ”¹server.servlet.context-pathä¸ºï¼š/account-service\n4ã€ä½¿ç”¨ä»£ç è¯»å–é…ç½®ä¿¡æ¯ æ³¨æ„ï¼šå¦‚æœé¡¹ç›®ä¸ä¸€æ ·çš„è¯ï¼Œå°±éœ€è¦å»å°†ä¹‹å‰åœ¨è¿è¡Œé‡Œé¢çš„ç¯å¢ƒè¿›è¡Œä¿®æ”¹ï¼Œå¦‚ä¸‹\nä¿®æ”¹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class GetConfigTest { public static void main(String[] args) { while (true){ try { Thread.sleep(1000); } catch (InterruptedException e) { e.printStackTrace(); } // Config appConfig = ConfigService.getAppConfig(); //è¯»å–æŒ‡å®šçš„namespaceä¸‹çš„é…ç½®ä¿¡æ¯ Config config = ConfigService.getConfig(\u0026#34;TEST1.spring-boot-http\u0026#34;); //è·å–é…ç½®ä¿¡æ¯,ç¬¬ä¸€ä¸ªå‚æ•°:é…ç½®çš„keyï¼Œç¬¬äºŒä¸ªå‚æ•°:é»˜è®¤å€¼ String value = config.getProperty(\u0026#34;server.servlet.context-path\u0026#34;, null); System.out.printf(\u0026#34;ç°åœ¨ï¼š%s, sms.enable: %s%n\u0026#34;, new Date().toString(),value); } } } ","date":"2022-12-29T10:03:56Z","image":"https://www.ownit.top/title_pic/21.jpg","permalink":"https://www.ownit.top/p/202212291003/","title":"K8Séƒ¨ç½²Apolloé…ç½®ä¸­å¿ƒ"},{"content":"ç¯å¢ƒ æ“ä½œç³»ç»Ÿ ï¼š CentOS7.3.1611_x64\nPython ç‰ˆæœ¬ : 3.6.8\nApolloæºç åœ°å€ï¼š\nGitHub - apolloconfig/apollo: Apollo is a reliable configuration management system suitable for microservice configuration management scenarios.\nè®¿é—®Apolloä½¿ç”¨è¿™ä¸ªåº“ï¼š\nGitHub - filamoon/pyapollo: Python client for Ctrip\u0026rsquo;s Apollo.\nä¸è¦ä½¿ç”¨pypiæä¾›çš„apolloåº“ï¼ˆæ˜¯ä¸€ä¸ªç¼–è¾‘å™¨çš„åº“ï¼‰ã€‚\nå…¶å®çœŸæ­£éœ€è¦çš„ä¹Ÿå°±ä¸€ä¸ªæ–‡ä»¶ï¼ˆpyapollo.pyï¼‰ï¼š\npyExamples/pyapollo.py at master Â· mike-zhang/pyExamples Â· GitHub\nå®‰è£…pyapollos 1 pip install pyapollos æ³¨æ„æ³¨æ„æ³¨æ„ï¼šè¿™ä¸ªpyapolloåº“ä½¿ç”¨æ—¶ä¼šæŠ¥é“¾æ¥è¶…æ—¶ï¼Œæ‰€ä»¥ä¸è¦ä½¿ç”¨äº†Â è¿™é‡Œæ˜¯ä¸€ä¸ªåˆ«äººä¿®æ”¹åçš„åº“,Â githubä¼ é€é—¨ï¼Œç›´æ¥å¤åˆ¶è¿™ä¸ªä»£ç åˆ›å»ºä¸€ä¸ªç±»ä½¿ç”¨å°±å¥½äº†ã€‚\nå‚è€ƒæ–‡æ¡£ï¼šhttps://blog.csdn.net/weixin_44809381/article/details/123072829\nä½¿ç”¨ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import time import pyapollos a = pyapollos.ApolloClient(app_id=\u0026#34;movie-project\u0026#34;, config_server_url=\u0026#34;https://config-server-dev.ownit.top\u0026#34;, cluster=\u0026#39;default\u0026#39;, timeout=10) #å¦‚æœæ˜¯å…³è”ç©ºé—´çš„å€¼ï¼Œå¿…é¡»ä½¿ç”¨namespace ï¼ŒæŒ‡å®šç©ºé—´åç§° c = a.get_value(\u0026#34;ops.appDomain\u0026#34;, namespace=\u0026#34;yunwei.common-public-config\u0026#34;) print(c) #æµ‹è¯•å€¼ var code = \u0026#34;cb224f2d-8ec8-4d66-85cc-072fb64ea58d\u0026#34; ç”Ÿäº§å®æˆ˜å®ä¾‹ é…ç½®ç¯å¢ƒå˜é‡ï¼š\nAPOLLO_CONFIG_URL ä¸º apolloçš„ è·å–å€¼çš„åœ°å€ï¼šconfig-server-dev.ownit.top\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 import os from pyapollo import ApolloClient client = ApolloClient(app_id=\u0026#34;spider-customer\u0026#34;, cluster=\u0026#34;default\u0026#34;, config_server_url=\u0026#39;http://\u0026#39; + os.environ.get(\u0026#39;APOLLO_CONFIG_URL\u0026#39;)) project_name = client.get_value(\u0026#39;project.name\u0026#39;) # æœåŠ¡ server_port = int(client.get_value(\u0026#39;server.port\u0026#39;)) env = client.get_value(\u0026#39;env\u0026#39;) # redis redis_host = client.get_value(\u0026#39;redis.host\u0026#39;) redis_port = int(client.get_value(\u0026#39;redis.port\u0026#39;)) redis_db = int(client.get_value(\u0026#39;redis.db\u0026#39;)) redis_password = client.get_value(\u0026#39;redis.password\u0026#39;) # mysql mysql_host = client.get_value(\u0026#39;mysql.host\u0026#39;) mysql_port = int(client.get_value(\u0026#39;mysql.port\u0026#39;)) mysql_user = client.get_value(\u0026#39;mysql.user\u0026#39;) mysql_password = client.get_value(\u0026#39;mysql.password\u0026#39;) mysql_database = client.get_value(\u0026#39;mysql.database\u0026#39;) # é’‰é’‰æœºå™¨äºº log_robot_token = client.get_value(\u0026#39;log_robot_token\u0026#39;) log_robot_secret = client.get_value(\u0026#39;log_robot_secret\u0026#39;) # oss oss_endpoint = client.get_value(\u0026#39;oss.ossEndpoint\u0026#39;) oss_accessKeyId = client.get_value(\u0026#39;oss.ossAccessKeyId\u0026#39;) oss_accessKeySecret = client.get_value(\u0026#39;oss.ossAccessKeySecret\u0026#39;) oss_bucketName = client.get_value(\u0026#39;oss.bucketName\u0026#39;) äºŒã€è°ƒç”¨APIæ¥å£è·å–é…ç½® 1ï¼Œé€šè¿‡å¸¦ç¼“å­˜çš„Httpæ¥å£ä»Apolloè¯»å–é…ç½® è¯¥æ¥å£ä¼šä»ç¼“å­˜ä¸­è·å–é…ç½®ï¼Œé€‚åˆé¢‘ç‡è¾ƒé«˜çš„é…ç½®æ‹‰å–è¯·æ±‚ï¼Œå¦‚ç®€å•çš„æ¯30ç§’è½®è¯¢ä¸€æ¬¡é…ç½®ã€‚\nç”±äºç¼“å­˜æœ€å¤šä¼šæœ‰ä¸€ç§’çš„å»¶æ—¶ï¼Œæ‰€ä»¥å¦‚æœéœ€è¦é…åˆé…ç½®æ¨é€é€šçŸ¥å®ç°å®æ—¶æ›´æ–°é…ç½®çš„è¯ï¼Œè¯·å‚è€ƒé€šè¿‡ä¸å¸¦ç¼“å­˜çš„Httpæ¥å£ä»Apolloè¯»å–é…ç½®\nHttpæ¥å£è¯´æ˜ URL: {config_server_url}/configfiles/json/{appId}/{clusterName}/{namespaceName}?ip={clientIp}\nMethod: GET\nå‚æ•°è¯´æ˜ï¼š\nå‚æ•°å æ˜¯å¦å¿…é¡» å‚æ•°å€¼ å¤‡æ³¨ config_server_url æ˜¯ Apolloé…ç½®æœåŠ¡çš„åœ°å€ appId æ˜¯ åº”ç”¨çš„appId clusterName æ˜¯ é›†ç¾¤å ä¸€èˆ¬æƒ…å†µä¸‹ä¼ å…¥ default å³å¯ã€‚ å¦‚æœå¸Œæœ›é…ç½®æŒ‰é›†ç¾¤åˆ’åˆ†ï¼Œå¯ä»¥å‚è€ƒé›†ç¾¤ç‹¬ç«‹é…ç½®è¯´æ˜åšç›¸å…³é…ç½®ï¼Œç„¶ååœ¨è¿™é‡Œå¡«å…¥å¯¹åº”çš„é›†ç¾¤åã€‚ namespaceName æ˜¯ Namespaceçš„åå­— å¦‚æœæ²¡æœ‰æ–°å»ºè¿‡Namespaceçš„è¯ï¼Œä¼ å…¥applicationå³å¯ã€‚ å¦‚æœåˆ›å»ºäº†Namespaceï¼Œå¹¶ä¸”éœ€è¦ä½¿ç”¨è¯¥Namespaceçš„é…ç½®ï¼Œåˆ™ä¼ å…¥å¯¹åº”çš„Namespaceåå­—ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºpropertiesç±»å‹çš„namespaceï¼Œåªéœ€è¦ä¼ å…¥namespaceçš„åå­—å³å¯ï¼Œå¦‚applicationã€‚å¯¹äºå…¶å®ƒç±»å‹çš„namespaceï¼Œéœ€è¦ä¼ å…¥namespaceçš„åå­—åŠ ä¸Šåç¼€åï¼Œå¦‚datasources.json ip å¦ åº”ç”¨éƒ¨ç½²çš„æœºå™¨ip è¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œç”¨æ¥å®ç°ç°åº¦å‘å¸ƒã€‚ å¦‚æœä¸æƒ³ä¼ è¿™ä¸ªå‚æ•°ï¼Œè¯·æ³¨æ„URLä¸­ä»?å·å¼€å§‹çš„query parametersæ•´ä¸ªéƒ½ä¸è¦å‡ºç°ã€‚ 2ï¼Œé€šè¿‡ä¸å¸¦ç¼“å­˜çš„Httpæ¥å£ä»Apolloè¯»å–é…ç½® è¯¥æ¥å£ä¼šç›´æ¥ä»æ•°æ®åº“ä¸­è·å–é…ç½®ï¼Œå¯ä»¥é…åˆé…ç½®æ¨é€é€šçŸ¥å®ç°å®æ—¶æ›´æ–°é…ç½®ã€‚\nHttpæ¥å£è¯´æ˜ URL: {config_server_url}/configs/{appId}/{clusterName}/{namespaceName}?releaseKey={releaseKey}\u0026amp;ip={clientIp}\nMethod: GET\nå‚æ•°è¯´æ˜ï¼š\nå‚æ•°å æ˜¯å¦å¿…é¡» å‚æ•°å€¼ å¤‡æ³¨ config_server_url æ˜¯ Apolloé…ç½®æœåŠ¡çš„åœ°å€ appId æ˜¯ åº”ç”¨çš„appId clusterName æ˜¯ é›†ç¾¤å ä¸€èˆ¬æƒ…å†µä¸‹ä¼ å…¥ default å³å¯ã€‚ å¦‚æœå¸Œæœ›é…ç½®æŒ‰é›†ç¾¤åˆ’åˆ†ï¼Œå¯ä»¥å‚è€ƒé›†ç¾¤ç‹¬ç«‹é…ç½®è¯´æ˜åšç›¸å…³é…ç½®ï¼Œç„¶ååœ¨è¿™é‡Œå¡«å…¥å¯¹åº”çš„é›†ç¾¤åã€‚ namespaceName æ˜¯ Namespaceçš„åå­— å¦‚æœæ²¡æœ‰æ–°å»ºè¿‡Namespaceçš„è¯ï¼Œä¼ å…¥applicationå³å¯ã€‚ å¦‚æœåˆ›å»ºäº†Namespaceï¼Œå¹¶ä¸”éœ€è¦ä½¿ç”¨è¯¥Namespaceçš„é…ç½®ï¼Œåˆ™ä¼ å…¥å¯¹åº”çš„Namespaceåå­—ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºpropertiesç±»å‹çš„namespaceï¼Œåªéœ€è¦ä¼ å…¥namespaceçš„åå­—å³å¯ï¼Œå¦‚applicationã€‚å¯¹äºå…¶å®ƒç±»å‹çš„namespaceï¼Œéœ€è¦ä¼ å…¥namespaceçš„åå­—åŠ ä¸Šåç¼€åï¼Œå¦‚datasources.json releaseKey å¦ ä¸Šä¸€æ¬¡çš„releaseKey å°†ä¸Šä¸€æ¬¡è¿”å›å¯¹è±¡ä¸­çš„releaseKeyä¼ å…¥å³å¯ï¼Œç”¨æ¥ç»™æœåŠ¡ç«¯æ¯”è¾ƒç‰ˆæœ¬ï¼Œå¦‚æœç‰ˆæœ¬æ¯”ä¸‹æ¥æ²¡æœ‰å˜åŒ–ï¼Œåˆ™æœåŠ¡ç«¯ç›´æ¥è¿”å›304ä»¥èŠ‚çœæµé‡å’Œè¿ç®— ip å¦ åº”ç”¨éƒ¨ç½²çš„æœºå™¨ip è¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œç”¨æ¥å®ç°ç°åº¦å‘å¸ƒã€‚ ","date":"2022-12-29T09:39:33Z","image":"https://www.ownit.top/title_pic/18.jpg","permalink":"https://www.ownit.top/p/202212290939/","title":"Pythonè®¿é—®Apolloè·å–é…ç½®"},{"content":"ç®€ä»‹ï¼šä½¿ç”¨é˜¿é‡Œäº‘çš„RDSæ•°æ®åº“ï¼Œå¼€å¯DASçš„æ•°æ®åº“æ²»ç†æœåŠ¡ã€‚ä¼šäº§ç”Ÿå¤§é‡çš„å®¡è®¡æ—¥å¿—ã€‚\næˆ‘ä»¬æœ‰2Tçš„å®¡è®¡æ—¥å¿—æ•°æ®ï¼Œä¿ç•™180å¤©ï¼Œæ¯å°æ—¶æ”¶è´¹ç©ºé—´ï¼š0.008å…ƒ/GB/å°æ—¶\nè®¡ç®—ä¸‹æ¥ï¼š2x1024x 24x 30 x 0.008 =11796 å…ƒ\nè§£å†³ï¼šæ‰“ç®—æ•°æ®é‡å­˜å‚¨30å¤©ï¼Œä»¥å‰çš„å®¡è®¡æ—¥å¿—ï¼Œå¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘çš„API è°ƒç”¨ï¼Œä¸‹è½½ï¼Œå½’æ¡£æŠ¥é”™ã€‚å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥åŠæ—¶å®šä½ã€‚ä¿ç•™å‘¨æœŸæ›´é•¿ã€‚è´¹ç”¨æ›´å°‘ã€‚\né˜¿é‡Œäº‘APIæ¥å£ï¼šæŸ¥è¯¢å®ä¾‹çš„SQLå®¡è®¡æ—¥å¿— (aliyun.com)\nç›®å‰ä½¿ç”¨è¿™ä¸ªAPIæ¥å£æ‹‰å–ï¼ŒåŸºæœ¬ç›¸å…³ä¿¡æ¯å·²ç»å­˜åœ¨ã€‚\né«˜çº§ä¸€ç‚¹å¯ä»¥é‡‡ç”¨ ä¸€ä¸‹APIæ‹‰å–æ—¥å¿—\næŒ‰ç…§è®¿é—®æ¥æºç»Ÿè®¡å…¨é‡è¯·æ±‚æ•°æ®çš„APIæ¥å£_æ•°æ®åº“è‡ªæ²»æœåŠ¡-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ\nGetFullRequestStatResultByInstanceId - æŒ‰ç…§SQL IDå¼‚æ­¥ç»Ÿè®¡å…¨é‡è¯·æ±‚æ•°æ® (aliyun.com)\nç¯å¢ƒå‡†å¤‡ 1ã€Python 3.8 çš„ç¯å¢ƒ\n2ã€å®‰è£…é˜¿é‡Œäº‘çš„sdk\nSDK åŒ…åç§°alibabacloud_rds20140815\nSDK ç‰ˆæœ¬2.1.2\nSDK åŒ…ç®¡ç†å¹³å°pypi\nSDK å®‰è£…å‘½ä»¤\n1 pip install alibabacloud_rds20140815==2.1.2 æç¤ºä»“åº“åŒæ­¥å¯èƒ½ä¼šæœ‰å»¶è¿Ÿï¼Œå¦‚æœé‡åˆ°ç‰ˆæœ¬ä¸å­˜åœ¨çš„æƒ…å†µï¼Œè¯·ç¨åå†è¯•æˆ–ä½¿ç”¨ä¸Šä¸€ä¸ªç‰ˆæœ¬\né˜¿é‡Œäº‘ OpenAPI å¼€å‘è€…é—¨æˆ· (aliyun.com)\nåŸºç¡€ä»£ç  æ­¤ä»£ç æ˜¯é˜¿é‡Œäº‘è‡ªåŠ¨ç”Ÿæˆçš„\nä¸€ä¸ªæ‰§è¡Œï¼Œä¸€ä¸ªå¼‚æ­¥æ‰§è¡Œã€‚é€‰æ‹©å…¶ä¸­ä¸€ä¸ªå³å¯ã€‚Â 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 # -*- coding: utf-8 -*- # This file is auto-generated, don\u0026#39;t edit it. Thanks. import sys from typing import List from alibabacloud_rds20140815.client import Client as Rds20140815Client from alibabacloud_tea_openapi import models as open_api_models from alibabacloud_rds20140815 import models as rds_20140815_models from alibabacloud_tea_util import models as util_models from alibabacloud_tea_util.client import Client as UtilClient class Sample: def __init__(self): pass @staticmethod def create_client( access_key_id: str, access_key_secret: str, ) -\u0026gt; Rds20140815Client: \u0026#34;\u0026#34;\u0026#34; ä½¿ç”¨AK\u0026amp;SKåˆå§‹åŒ–è´¦å·Client @param access_key_id: @param access_key_secret: @return: Client @throws Exception \u0026#34;\u0026#34;\u0026#34; config = open_api_models.Config( # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey ID, access_key_id=access_key_id, # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey Secret, access_key_secret=access_key_secret ) # è®¿é—®çš„åŸŸå config.endpoint = f\u0026#39;rds.aliyuncs.com\u0026#39; return Rds20140815Client(config) @staticmethod def main( args: List[str], ) -\u0026gt; None: # å·¥ç¨‹ä»£ç æ³„éœ²å¯èƒ½ä¼šå¯¼è‡´AccessKeyæ³„éœ²ï¼Œå¹¶å¨èƒè´¦å·ä¸‹æ‰€æœ‰èµ„æºçš„å®‰å…¨æ€§ã€‚ä»¥ä¸‹ä»£ç ç¤ºä¾‹ä»…ä¾›å‚è€ƒï¼Œå»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„ STS æ–¹å¼ï¼Œæ›´å¤šé‰´æƒè®¿é—®æ–¹å¼è¯·å‚è§ï¼šhttps://help.aliyun.com/document_detail/378659.html client = Sample.create_client(\u0026#39;accessKeyId\u0026#39;, \u0026#39;accessKeySecret\u0026#39;) describe_sqllog_records_request = rds_20140815_models.DescribeSQLLogRecordsRequest( dbinstance_id=\u0026#39;xxxxxx\u0026#39;, start_time=\u0026#39;2022-11-18T00:00:00Z\u0026#39;, end_time=\u0026#39;2022-11-19T00:00:00Z\u0026#39;, page_size=100, page_number=1 ) runtime = util_models.RuntimeOptions() try: # å¤åˆ¶ä»£ç è¿è¡Œè¯·è‡ªè¡Œæ‰“å° API çš„è¿”å›å€¼ client.describe_sqllog_records_with_options(describe_sqllog_records_request, runtime) except Exception as error: # å¦‚æœ‰éœ€è¦ï¼Œè¯·æ‰“å° error UtilClient.assert_as_string(error.message) @staticmethod async def main_async( args: List[str], ) -\u0026gt; None: # å·¥ç¨‹ä»£ç æ³„éœ²å¯èƒ½ä¼šå¯¼è‡´AccessKeyæ³„éœ²ï¼Œå¹¶å¨èƒè´¦å·ä¸‹æ‰€æœ‰èµ„æºçš„å®‰å…¨æ€§ã€‚ä»¥ä¸‹ä»£ç ç¤ºä¾‹ä»…ä¾›å‚è€ƒï¼Œå»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„ STS æ–¹å¼ï¼Œæ›´å¤šé‰´æƒè®¿é—®æ–¹å¼è¯·å‚è§ï¼šhttps://help.aliyun.com/document_detail/378659.html client = Sample.create_client(\u0026#39;accessKeyId\u0026#39;, \u0026#39;accessKeySecret\u0026#39;) describe_sqllog_records_request = rds_20140815_models.DescribeSQLLogRecordsRequest( dbinstance_id=\u0026#39;xxxxxx\u0026#39;, start_time=\u0026#39;2022-11-18T00:00:00Z\u0026#39;, end_time=\u0026#39;2022-11-19T00:00:00Z\u0026#39;, page_size=100, page_number=1 ) runtime = util_models.RuntimeOptions() try: # å¤åˆ¶ä»£ç è¿è¡Œè¯·è‡ªè¡Œæ‰“å° API çš„è¿”å›å€¼ await client.describe_sqllog_records_with_options_async(describe_sqllog_records_request, runtime) except Exception as error: # å¦‚æœ‰éœ€è¦ï¼Œè¯·æ‰“å° error UtilClient.assert_as_string(error.message) if __name__ == \u0026#39;__main__\u0026#39;: Sample.main(sys.argv[1:]) 2ã€æ ¹æ®å°æ—¶æ‹‰å»ä»£ç  å› ä¸ºæ•°æ®é‡å¾ˆå¤§ï¼Œæˆ‘ä»¬å‡†å¤‡æ ¹æ®Â **å°æ—¶Â ** æ‹‰å»æ—¥å¿—ã€‚\nä»£ç ä»‹ç»ï¼š\næ ¹æ®æ¯å°æ—¶æ‹‰å»æ–‡ä»¶ï¼Œè¿›è¡ŒæŒ‰æ—¶é—´ä¿å­˜ï¼Œæ‹‰å»ä¸€å¤©çš„é‡å®Œæˆå ä¼šé’‰é’‰é€šçŸ¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 import datetime import json import os import sys from time import sleep import requests from alibabacloud_rds20140815.client import Client as Rds20140815Client from alibabacloud_tea_openapi import models as open_api_models from alibabacloud_rds20140815 import models as rds_20140815_models from alibabacloud_tea_util import models as util_models from alibabacloud_tea_util.client import Client as UtilClient import copy class Sample: def __init__(self): pass @staticmethod def create_client( access_key_id: str, access_key_secret: str, ) -\u0026gt; Rds20140815Client: \u0026#34;\u0026#34;\u0026#34; ä½¿ç”¨AK\u0026amp;SKåˆå§‹åŒ–è´¦å·Client @param access_key_id: @param access_key_secret: @return: Client @throws Exception \u0026#34;\u0026#34;\u0026#34; config = open_api_models.Config( # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey ID, access_key_id=access_key_id, # å¿…å¡«ï¼Œæ‚¨çš„ AccessKey Secret, access_key_secret=access_key_secret ) # è®¿é—®çš„åŸŸå config.endpoint = f\u0026#39;rds.aliyuncs.com\u0026#39; return Rds20140815Client(config) @staticmethod def main(page_number=1, startTime=None, endTime=None): # å·¥ç¨‹ä»£ç æ³„éœ²å¯èƒ½ä¼šå¯¼è‡´AccessKeyæ³„éœ²ï¼Œå¹¶å¨èƒè´¦å·ä¸‹æ‰€æœ‰èµ„æºçš„å®‰å…¨æ€§ã€‚ä»¥ä¸‹ä»£ç ç¤ºä¾‹ä»…ä¾›å‚è€ƒï¼Œå»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„ STS æ–¹å¼ï¼Œæ›´å¤šé‰´æƒè®¿é—®æ–¹å¼è¯·å‚è§ï¼šhttps://help.aliyun.com/document_detail/378659.html client = Sample.create_client(\u0026#39;xxxxxxxxxxxxxx\u0026#39;, \u0026#39;xxxxxxxxxxxxxxxxx\u0026#39;) describe_sqllog_records_request = rds_20140815_models.DescribeSQLLogRecordsRequest( #æ•°æ®åº“å®ä¾‹ID dbinstance_id=\u0026#39;rm-xxxxxxxxxxxxxxxxx\u0026#39;, end_time=endTime, start_time=startTime, page_size=100, page_number=page_number ) runtime = util_models.RuntimeOptions() try: # å¤åˆ¶ä»£ç è¿è¡Œè¯·è‡ªè¡Œæ‰“å° API çš„è¿”å›å€¼ data = client.describe_sqllog_records_with_options(describe_sqllog_records_request, runtime) return data except Exception as error: # å¦‚æœ‰éœ€è¦ï¼Œè¯·æ‰“å° error UtilClient.assert_as_string(error.message) def msg(text): json_text = { \u0026#34;msgtype\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;at\u0026#34;: { \u0026#34;atMobiles\u0026#34;: [ \u0026#34;11111\u0026#34; ], \u0026#34;isAtAll\u0026#34;: False }, \u0026#34;text\u0026#34;: { \u0026#34;content\u0026#34;: text } } print(requests.post(api_url, json.dumps(json_text), headers=headers).content) if __name__ == \u0026#39;__main__\u0026#39;: startTime = \u0026#39;2022-11-19T00:00:00Z\u0026#39; for i in range(24): endTime = (datetime.datetime.strptime(startTime, \u0026#34;%Y-%m-%dT%H:%M:%SZ\u0026#34;) + datetime.timedelta( hours=1)).strftime(\u0026#34;%Y-%m-%dT%H:%M:%SZ\u0026#34;) rds_time = datetime.datetime.strptime(startTime, \u0026#34;%Y-%m-%dT%H:%M:%SZ\u0026#34;) rds_time_file_log = rds_time.strftime(\u0026#34;%Y-%m-%d_%H\u0026#34;) # print(rds_time_file) rds_file = rds_time.strftime(\u0026#34;%Y-%m-%d\u0026#34;) # print(rds_time_file) folder = os.path.join(os.path.abspath(os.path.dirname(__file__)), rds_file) print(folder) log_path = os.path.exists(folder) if not log_path: os.makedirs(folder) print(startTime, endTime) rds = Sample.main(startTime=startTime, endTime=endTime) # æ€»æ¡æ•° rds_num = rds.body.total_record_count # é¡µæ•° rds_page = rds.body.page_number # pageçš„numæ•°é‡ pag_num_max = 100 # æ¯é¡µè¿”å›çš„æ•°å€¼ page_record_count = rds.body.page_record_count # æ€»é¡µæ•° page_num_sum = int(rds_num / pag_num_max) + 1 rds_log = rds.body.items.to_map() for i in range(page_num_sum + 1): print(i + 1) num = i + 1 rds_one = Sample.main(page_number=num, startTime=startTime, endTime=endTime) page_record_count_one = rds_one.body.page_record_count if page_record_count_one != 0: rds_log_one = rds_one.body.items.to_map() # è·å–rds çš„çœŸå®æ—¥å¿—æ•°æ® for v in rds_log_one[\u0026#39;SQLRecord\u0026#39;]: with open(folder + \u0026#39;/\u0026#39; + \u0026#39;rds_\u0026#39; + rds_time_file_log + \u0026#39;.log\u0026#39;, \u0026#39;a\u0026#39;, encoding=\u0026#34;utf-8\u0026#34;) as f: f.write(f\u0026#34;{str(v)} \\n\u0026#34;) if (i + 1) % 2000 == 0: sleep(10) f.close() startTime = endTime # å‚æ•°days=1ï¼ˆå¤©+1ï¼‰ å¯ä»¥æ¢æˆ minutes=1ï¼ˆåˆ†é’Ÿ+1ï¼‰ã€seconds=1ï¼ˆç§’+1ï¼‰ token = \u0026#34;xxxxxxxxxxxxxxxxxxxxxxxx\u0026#34; text = \u0026#34;pythonæ‹‰å»æ•°æ®\u0026#34; headers = {\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json;charset=utf-8\u0026#39;} api_url = \u0026#34;https://oapi.dingtalk.com/robot/send?access_token=%s\u0026#34; % token msg(\u0026#39;RDSæ•°æ®æ‹‰å»-å®Œæˆå‘Šè­¦\u0026#39;) ","date":"2022-12-19T10:44:22Z","image":"https://www.ownit.top/title_pic/07.jpg","permalink":"https://www.ownit.top/p/202212191044/","title":"Pythonæœ¬åœ°ä¸‹è½½-å®ä¾‹çš„SQLå®¡è®¡æ—¥å¿—"},{"content":"åœ¨æŸ¥çœ‹gitlab CIä½œä¸šæ—¶ï¼Œå‘ç°æ„å¤–æŠ¥é”™\n1 2 3 4 5 6 é‡æ–°åˆå§‹åŒ–ç°å­˜çš„ Git ç‰ˆæœ¬åº“äº /home/gitlab-runner/builds/nzfEHD8s/0/devops/dig/.git/ fatal: git fetch-pack: expected shallow list fatal: The remote end hung up unexpectedly Cleaning up project directory and file based variables 00:00 ERROR: Job failed: exit status 1 æŠ¥é”™æ—¶ç”±äºgitç‰ˆæœ¬å¼•èµ·çš„ï¼ŒæŸ¥çœ‹gitç‰ˆæœ¬\n1 2 [root@bt dig]# git version git version 1.8.3.1 ä½¿ç”¨yumÂ list | grep gitï¼Œyumé»˜è®¤é˜¿é‡Œäº‘æºé‡Œé¢æœ€æ–°çš„ç‰ˆæœ¬å°±æ˜¯1.18.3Â æˆ‘ä»¬éœ€è¦å‡çº§git çš„ç‰ˆæœ¬\n1ã€å®‰è£…æº 1 yum install http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-2.noarch.rpm 2ã€æ›´æ–°gitè½¯ä»¶ 1 yum install git -y 3ã€æ£€æŸ¥ç‰ˆæœ¬æµ‹è¯•\n1 2 [root@bt dig]# git --version git version 2.31.1 ç‰ˆæœ¬å·²ç»æ›´æ–°æœ€2.31äº†ï¼Œå†æ¬¡æ‰§è¡Œgitlab CIä½œä¸šï¼ŒæŠ¥é”™å·²ç»è§£å†³äº†ã€‚\n","date":"2022-12-01T11:59:37Z","image":"https://www.ownit.top/title_pic/63.jpg","permalink":"https://www.ownit.top/p/202212011159/","title":"Gitå¼•èµ·çš„ gitlab-runner æŠ¥é”™"},{"content":"ç›®å½•\n1ã€Repositories\n1ã€é…ç½®è·¯å¾„\n2ã€æ³¨å†Œå¿«ç…§å­˜å‚¨åº“\n2ã€æŸ¥çœ‹æ³¨å†Œçš„åº“\n3ã€åˆ›å»ºå¿«ç…§\n1ã€ä¸ºå…¨éƒ¨ç´¢å¼•åˆ›å»ºå¿«ç…§\n2ã€ä¸ºæŒ‡å®šç´¢å¼•åˆ›å»ºå¿«ç…§\n4ã€æŸ¥çœ‹å¤‡ä»½å®Œæˆçš„åˆ—è¡¨\n5ã€åˆ é™¤å¿«ç…§\n6ã€ä»å¿«ç…§æ¢å¤\n1ã€æ¢å¤æŒ‡å®šç´¢å¼•\n2ã€æ¢å¤æ‰€æœ‰ç´¢å¼•ï¼ˆé™¤.å¼€å¤´çš„ç³»ç»Ÿç´¢å¼•ï¼‰\n3ã€æ¢å¤æ‰€æœ‰ç´¢å¼•ï¼ˆåŒ…å«.å¼€å¤´çš„ç³»ç»Ÿç´¢å¼•ï¼‰\n4ã€å°†å¿«ç…§æ¢å¤åˆ°Indexing Serviceå®ä¾‹ä¸­ã€‚\n7ã€æŸ¥çœ‹å¿«ç…§æ¢å¤ä¿¡æ¯\n1ã€æŸ¥çœ‹å¿«ç…§ä¸­æŒ‡å®šç´¢å¼•çš„æ¢å¤çŠ¶æ€\n2ã€æŸ¥çœ‹é›†ç¾¤ä¸­çš„æ‰€æœ‰ç´¢å¼•çš„æ¢å¤ä¿¡æ¯\n8ã€åˆ é™¤æ­£åœ¨è¿›è¡Œå¿«ç…§æ¢å¤çš„ç´¢å¼•\n2ã€å¤‡ä»½è„šæœ¬\n1ã€Elasticsearchç´¢å¼•å¤‡ä»½\n2ã€Elasticsearchç´¢å¼•æ¸…ç†\nå¿«ç…§æ˜¯å¢é‡çš„ï¼Œå¯ä»¥åŒ…å«åœ¨å¤šä¸ªESç‰ˆæœ¬ä¸­åˆ›å»ºçš„ç´¢å¼•ã€‚å¦‚æœåœ¨ä¸€ä¸ªå¿«ç…§ä¸­çš„ä»»ä½•ç´¢å¼•æ—¶åœ¨ä¸å…¼å®¹çš„ESç‰ˆæœ¬ä¸­åˆ›å»ºçš„ï¼Œä½ å°†ä¸èƒ½æ¢å¤è¯¥å¿«ç…§ã€‚\nåœ¨å‡çº§å‰å¤‡ä»½æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœå¿«ç…§ä¸­çš„ç´¢å¼•æ˜¯åœ¨ä¸ä½ å‡çº§ç‰ˆæœ¬ä¸å…¼å®¹çš„ESç‰ˆæœ¬ä¸­åˆ›å»ºçš„ï¼Œé‚£ä¹ˆè¿™äº›å¿«ç…§å°†ä¸èƒ½è¢«æ¢å¤ã€‚\nå¦‚æœä½ çš„æƒ…å†µæ˜¯éœ€è¦æ¢å¤ä¸€ä¸ªä¸ä½ å½“å‰è¿è¡Œçš„é›†ç¾¤ç‰ˆæœ¬ä¸å…¼å®¹çš„ç´¢å¼•å¿«ç…§ï¼Œä½ å¯ä»¥å…ˆæ¢å¤åˆ°æœ€æ–°çš„å…¼å®¹ç‰ˆæœ¬ä¸­ï¼Œç„¶ååœ¨å½“å‰ç‰ˆæœ¬ä¸­ä½¿ç”¨ reindex-from-remote é‡å»ºç´¢å¼•ã€‚è¿œç¨‹Reindexingåªèƒ½åœ¨æºç´¢å¼•sourceä¸ºenabledçš„æƒ…å†µä¸‹è¿›è¡Œã€‚è·å–å¹¶é‡å»ºæ•°æ®ç´¢å¼•çš„æ—¶é—´å¯èƒ½æ¯”ç®€å•æ¢å¤å¿«ç…§è¦é•¿çš„å¤šã€‚å¦‚æœä½ çš„æ•°æ®é‡è¾ƒå¤§ï¼Œå»ºè®®å…ˆç”¨ä¸€éƒ¨åˆ†æ•°æ®æµ‹è¯•è¿œç¨‹reindexï¼Œä»¥ä¾¿äº†è§£éœ€è¦èŠ±è´¹çš„æ—¶é—´\n1ã€Repositories å¿…é¡»å…ˆæ³¨å†Œä¸€ä¸ªå¿«ç…§ä»“åº“ï¼Œç„¶åæ‰èƒ½è¿›è¡Œå¿«ç…§å’Œæ¢å¤æ“ä½œã€‚å»ºè®®ä¸ºæ¯ä¸ªä¸»ç‰ˆæœ¬åˆ›å»ºä¸€ä¸ªæ–°å¿«ç…§ä»“åº“ã€‚æœ‰æ•ˆçš„ä»“åº“è®¾ç½®å–å†³äºä»“åº“ç±»å‹ã€‚\nå¦‚æœå¤šä¸ªé›†ç¾¤æ³¨å†ŒåŒä¸€ä¸ªå¿«ç…§ä»“åº“ï¼Œåªæœ‰ä¸€ä¸ªé›†ç¾¤å¯ä»¥å¯¹ä»“åº“è¿›è¡Œå†™è®¿é—®ï¼Œå…¶ä»–æ‰€æœ‰é›†ç¾¤åº”è¯¥è®¾ç½®è¯¥ä»“åº“ä¸º readonly æ¨¡å¼ã€‚\nè·¨ä¸»ç‰ˆæœ¬æ—¶å¿«ç…§æ ¼å¼å¯èƒ½ä¼šæ”¹å˜ï¼Œæ‰€ä»¥ä¸åŒç‰ˆæœ¬çš„é›†ç¾¤å†™åŒä¸€ä¸ªå¿«ç…§ä»“åº“ï¼ŒæŸä¸ªç‰ˆæœ¬å†™çš„å¿«ç…§å¯èƒ½å¯¹å…¶ä»–ç‰ˆæœ¬ä¸å¯è§ï¼Œä»“åº“å¿«ç…§ä¹Ÿå­˜åœ¨é—®é¢˜ã€‚ESä¸æ”¯æŒä»“åº“å¯¹æ‰€æœ‰é›†ç¾¤è®¾ç½®ä¸ºreadonlyï¼Œå…¶ä¸­ä¸€ä¸ªé›†ç¾¤å’Œä¸åŒä¸»ç‰ˆæœ¬çš„å¤šä¸ªé›†ç¾¤ä¸€èµ·å·¥ä½œã€‚\nå…³äºå¤‡ä»½å¯ä»¥åˆ†ä¸ºå¤‡ä»½æ•°æ®ï¼Œå¤‡ä»½é›†ç¾¤é…ç½®ï¼Œå¤‡ä»½å®‰å…¨é…ç½®\nå…³äºè¿˜åŸå¯ä»¥åˆ†ä¸ºè¿˜åŸæ•°æ®ï¼Œè¿˜åŸå®‰å…¨é…ç½®\n1ã€é…ç½®è·¯å¾„ å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼ˆå¦‚æœæ‚¨çš„é›†ç¾¤å¯ç”¨äº†å®‰å…¨åŠŸèƒ½ï¼Œåˆ™åœ¨å¤‡ä»½æ•°æ®æ—¶å¿…é¡»æˆæƒå¿«ç…§APIè°ƒç”¨ï¼‰\nä¿®æ”¹elasticsearch.ymlæ·»åŠ å¿«ç…§å­˜å‚¨ä½ç½®é…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 cat elasticsearch.yml node.name: node-1 discovery.seed_hosts: [\u0026#34;172.18.199.93\u0026#34;] cluster.initial_master_nodes: node-1 network.host: 0.0.0.0 path.data: /data02/elasticsearch/data path.logs: /data02/elasticsearch/logs xpack.security.enabled: true xpack.license.self_generated.type: basic xpack.security.transport.ssl.enabled: true â€‹ xpack.sql.enabled: false http.cors.enabled: true http.cors.allow-credentials: true http.cors.allow-origin: \u0026#34;/.*/\u0026#34; http.cors.allow-headers: WWW-Authenticate,X-Requested-With,X-Auth-Token,Content-Type,Content-Length,Authorization â€‹ # é¿å…å‘ç”ŸOOMï¼Œå‘ç”ŸOOMå¯¹é›†ç¾¤å½±å“å¾ˆå¤§çš„,æ‰åˆ request å’Œ fielddata æ–­è·¯å™¨ä¿è¯ä¸¤è€…ç»„åˆèµ·æ¥ä¸ä¼šä½¿ç”¨è¶…è¿‡å †å†…å­˜çš„ 70%ã€‚ indices.breaker.total.limit: 80% # æœ‰äº†è¿™ä¸ªè®¾ç½®ï¼Œæœ€ä¹…æœªä½¿ç”¨ï¼ˆLRUï¼‰çš„ fielddata ä¼šè¢«å›æ”¶ä¸ºæ–°æ•°æ®è…¾å‡ºç©ºé—´ indices.fielddata.cache.size: 10% # # # fielddata æ–­è·¯å™¨é»˜è®¤è®¾ç½®å †çš„ ä½œä¸º fielddata å¤§å°çš„ä¸Šé™ã€‚ indices.breaker.fielddata.limit: 60% # # #request æ–­è·¯å™¨ä¼°ç®—éœ€è¦å®Œæˆå…¶ä»–è¯·æ±‚éƒ¨åˆ†çš„ç»“æ„å¤§å°ï¼Œä¾‹å¦‚åˆ›å»ºä¸€ä¸ªèšåˆæ¡¶ï¼Œé»˜è®¤é™åˆ¶æ˜¯å †å†…å­˜çš„ 40%ã€‚ indices.breaker.request.limit: 40% # # #æœ€ä¹…æœªä½¿ç”¨ï¼ˆLRUï¼‰çš„ fielddata ä¼šè¢«å›æ”¶ä¸ºæ–°æ•°æ®è…¾å‡ºç©ºé—´ å¿…é¡»è¦æ·»åŠ çš„é…ç½® indices.breaker.total.use_real_memory: false ####å‰¯æœ¬æ•°è®¾ç½®å”¯ä¸€ #ç´¢å¼•è°ƒä¼˜ # indices.memory.index_buffer_size: 20% indices.memory.min_index_buffer_size: 96mb â€‹ # Search pool thread_pool.search.size: 5 â€‹ â€‹ discovery.zen.fd.ping_timeout: 120s discovery.zen.fd.ping_retries: 6 discovery.zen.fd.ping_interval: 30s â€‹ #ä»“åº“ path.repo: [\u0026#34;/data/es_snapshot\u0026#34;] ç»™å¤‡ä»½ç›®å½•æƒé™\n1 chown -R es:es /data/es_snapshot 2ã€æ³¨å†Œå¿«ç…§å­˜å‚¨åº“ å¿«ç…§å¯ä»¥å­˜å‚¨åœ¨æœ¬åœ°æˆ–è¿œç¨‹å­˜å‚¨åº“ä¸­ã€‚è¿œç¨‹å­˜å‚¨åº“å¯ä»¥é©»ç•™åœ¨ Amazon S3ã€HDFSã€Microsoft Azureã€Google Cloud Storage å’Œå­˜å‚¨åº“æ’ä»¶æ”¯æŒçš„å…¶ä»–å¹³å°ä¸Šã€‚\né™¤äº†location å‚æ•°å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡max_snapshot_bytes_per_secå’Œmax_restore_bytes_per_sec æ¥é™åˆ¶å¤‡ä»½å’Œæ¢å¤æ—¶çš„é€Ÿåº¦\næŸ¥çœ‹å¿«ç…§ä»“åº“ã€‚\n1 GET _snapshot 1 2 3 4 5 6 7 curl -XPUT \u0026#39;http://192.168.18.15:9200/_snapshot/backupï¼ˆä»“åº“åç§°ï¼‰\u0026#39; -d \u0026#39;{ \u0026#34;type\u0026#34;: \u0026#34;fs\u0026#34;, \u0026#34;settings\u0026#34;: { \u0026#34;location\u0026#34;: \u0026#34;/data/es_snapshot\u0026#34;, \u0026#34;compress\u0026#34;: true #å‹ç¼© } }\u0026#39; æˆ–è€…åœ¨Kibana consoleä¸­è¾“å…¥å¦‚ä¸‹çš„å‘½ä»¤è¿›è¡Œæ³¨å†Œä¹Ÿå¯ä»¥\n1 2 3 4 5 6 7 PUT _snapshot/backup { \u0026#34;type\u0026#34;: \u0026#34;fs\u0026#34;, \u0026#34;settings\u0026#34;: { \u0026#34;location\u0026#34;: \u0026#34;/data/es_snapshot\u0026#34;, \u0026#34;compress\u0026#34;: true } 2ã€æŸ¥çœ‹æ³¨å†Œçš„åº“ GET _snapshot/\n1 GET _snapshot/ 3ã€åˆ›å»ºå¿«ç…§ è‡ªå»ºElasticsearchä¸­åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼Œç”¨æ¥å¤‡ä»½æ‚¨éœ€è¦è¿ç§»çš„ç´¢å¼•æ•°æ®ã€‚åˆ›å»ºå¿«ç…§æ—¶ï¼Œé»˜è®¤ä¼šå¤‡ä»½æ‰€æœ‰æ‰“å¼€çš„ç´¢å¼•ã€‚å¦‚æœæ‚¨ä¸æƒ³å¤‡ä»½ç³»ç»Ÿç´¢å¼•ï¼Œä¾‹å¦‚ä»¥**.kibana**ã€.securityã€.monitoringç­‰å¼€å¤´çš„ç´¢å¼•ï¼Œå¯åœ¨åˆ›å»ºå¿«ç…§æ—¶æŒ‡å®šéœ€è¦å¤‡ä»½çš„ç´¢å¼•\næ³¨æ„ï¼š å»ºè®®æ‚¨ä¸è¦å¤‡ä»½ç³»ç»Ÿç´¢å¼•ï¼Œå› ä¸ºç³»ç»Ÿç´¢å¼•ä¼šå ç”¨è¾ƒå¤§ç©ºé—´ã€‚\n1ã€ä¸ºå…¨éƒ¨ç´¢å¼•åˆ›å»ºå¿«ç…§ 1 PUT _snapshot/my_backup/snapshot_1 ä»¥ä¸Šå‘½ä»¤ä¼šä¸ºæ‰€æœ‰æ‰“å¼€çš„ç´¢å¼•åˆ›å»ºåç§°ä¸ºsnapshot_1çš„å¿«ç…§ï¼Œå¹¶ä¿å­˜åˆ°my_backupä»“åº“ä¸­ã€‚è¯¥å‘½ä»¤ä¼šç«‹åˆ»è¿”å›ï¼Œå¹¶åœ¨åå°æ‰§è¡Œå¤‡ä»½ä»»åŠ¡ã€‚å¦‚æœæ‚¨å¸Œæœ›ä»»åŠ¡æ‰§è¡Œå®Œæˆåå†è¿”å›ï¼Œå¯é€šè¿‡æ·»åŠ wait_for_completionå®ç°ã€‚è¯¥å‚æ•°ä¼šé˜»å¡è°ƒç”¨ç›´åˆ°å¤‡ä»½å®Œæˆï¼Œå¦‚æœæ˜¯å¤§å‹å¿«ç…§ï¼Œéœ€è¦å¾ˆé•¿æ—¶é—´æ‰èƒ½è¿”å›ã€‚\n1 PUT _snapshot/my_backup/snapshot_1?wait_for_completion=true è¯´æ˜\nä¸€ä¸ªä»“åº“å¯ä»¥åŒ…å«å¤šä¸ªå¿«ç…§ï¼Œæ¯ä¸ªå¿«ç…§ä¸­å¯ä»¥åŒ…å«æ‰€æœ‰ã€éƒ¨åˆ†æˆ–å•ä¸ªç´¢å¼•çš„å¤‡ä»½æ•°æ®ã€‚\nç¬¬ä¸€æ¬¡åˆ›å»ºå¿«ç…§æ—¶ï¼Œç³»ç»Ÿä¼šå¤‡ä»½æ‰€æœ‰çš„æ•°æ®ï¼Œåç»­æ‰€æœ‰çš„å¿«ç…§ä»…å¤‡ä»½å·²å­˜å¿«ç…§å’Œæ–°å¿«ç…§ä¹‹é—´çš„å¢é‡æ•°æ®ã€‚éšç€å¿«ç…§çš„ä¸æ–­è¿›è¡Œï¼Œå¤‡ä»½ä¹Ÿåœ¨å¢é‡çš„æ·»åŠ å’Œåˆ é™¤ã€‚è¿™æ„å‘³ç€åç»­å¤‡ä»½ä¼šç›¸å½“å¿«é€Ÿï¼Œå› ä¸ºå®ƒä»¬åªä¼ è¾“å¾ˆå°çš„æ•°æ®é‡ã€‚\n2ã€ä¸ºæŒ‡å®šç´¢å¼•åˆ›å»ºå¿«ç…§ ç³»ç»Ÿé»˜è®¤ä¼šå¤‡ä»½æ‰€æœ‰æ‰“å¼€çš„ç´¢å¼•ã€‚å¦‚æœæ‚¨åœ¨ä½¿ç”¨Kibanaï¼Œå¹¶ä¸”è€ƒè™‘åˆ°ç£ç›˜ç©ºé—´å¤§å°å› ç´ ï¼Œä¸éœ€è¦æŠŠæ‰€æœ‰è¯Šæ–­ç›¸å…³çš„.kibanaç´¢å¼•éƒ½å¤‡ä»½èµ·æ¥ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨åˆ›å»ºå¿«ç…§æ—¶ï¼ŒæŒ‡å®šéœ€è¦å¤‡ä»½çš„ç´¢å¼•ã€‚\n1 2 3 4 PUT _snapshot/my_backup/snapshot_2 { \u0026#34;indices\u0026#34;: \u0026#34;index_1,index_2\u0026#34; } 4ã€æŸ¥çœ‹å¤‡ä»½å®Œæˆçš„åˆ—è¡¨ 1 2 3 4 5 6 7 8 æŸ¥çœ‹æ‰€æœ‰å¿«ç…§ä¿¡æ¯ GET _snapshot/my_backup/_all æ ¹æ®å¿«ç…§åæŸ¥çœ‹æŒ‡å®šå¿«ç…§çš„ä¿¡æ¯ GET _snapshot/my_backup/snapshot_3 ä½¿ç”¨_status APIæŸ¥çœ‹æŒ‡å®šå¿«ç…§çš„ä¿¡æ¯ GET _snapshot/my_backup/snapshot_3/_status 5ã€åˆ é™¤å¿«ç…§ åˆ é™¤æŒ‡å®šçš„å¿«ç…§ã€‚å¦‚æœè¯¥å¿«ç…§æ­£åœ¨è¿›è¡Œï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç³»ç»Ÿä¼šä¸­æ–­å¿«ç…§è¿›ç¨‹å¹¶åˆ é™¤ä»“åº“ä¸­åˆ›å»ºåˆ°ä¸€åŠçš„å¿«ç…§ã€‚\n1 DELETE _snapshot/my_backup/snapshot_3 æ³¨æ„ åˆ é™¤å¿«ç…§è¯·ä½¿ç”¨DELETE APIï¼Œè€Œä¸èƒ½ä½¿ç”¨å…¶ä»–æœºåˆ¶åˆ é™¤ï¼ˆä¾‹å¦‚æ‰‹åŠ¨åˆ é™¤å¯èƒ½ä¼šé€ æˆå¤‡ä»½ä¸¥é‡æŸåï¼‰ã€‚å› ä¸ºå¿«ç…§æ˜¯å¢é‡çš„ï¼Œå¾ˆå¤šå¿«ç…§å¯èƒ½ä¾èµ–äºä¹‹å‰çš„å¤‡ä»½æ•°æ®ã€‚DELETE APIèƒ½å¤Ÿè¿‡æ»¤å‡ºè¿˜åœ¨è¢«å…¶ä»–å¿«ç…§ä½¿ç”¨çš„æ•°æ®ï¼Œåªåˆ é™¤ä¸å†è¢«ä½¿ç”¨çš„å¤‡ä»½æ•°æ®ã€‚\n6ã€ä»å¿«ç…§æ¢å¤ æ³¨æ„\nå»ºè®®ä¸è¦æ¢å¤.å¼€å¤´çš„ç³»ç»Ÿç´¢å¼•ï¼Œæ­¤æ“ä½œå¯èƒ½ä¼šå¯¼è‡´Kibanaè®¿é—®å¤±è´¥ã€‚\nå¦‚æœé›†ç¾¤ä¸­å­˜åœ¨ä¸å¾…æ¢å¤ç´¢å¼•åŒåçš„ç´¢å¼•ï¼Œéœ€è¦æå‰åˆ é™¤æˆ–è€…å…³é—­è¯¥åŒåç´¢å¼•åå†æ¢å¤ï¼Œå¦åˆ™æ¢å¤å¤±è´¥ã€‚\nå¦‚æœéœ€è¦è·¨åœ°åŸŸæ¢å¤é›†ç¾¤å¿«ç…§ï¼Œéœ€è¦å…ˆå°†åŸåœ°åŸŸOSSä¸­çš„å¿«ç…§æ•°æ®è¿ç§»åˆ°ç›®æ ‡åœ°åŸŸçš„OSSä¸­ï¼Œå†æ¢å¤åˆ°ç›®æ ‡åœ°åŸŸçš„Elasticsearché›†ç¾¤ä¸­ã€‚OSSé—´è¿ç§»çš„å…·ä½“æ“ä½œï¼Œè¯·å‚è§é˜¿é‡Œäº‘OSSä¹‹é—´è¿ç§»æ•™ç¨‹ã€‚\n1ã€æ¢å¤æŒ‡å®šç´¢å¼• å¦‚æœæ‚¨éœ€è¦åœ¨ä¸æ›¿æ¢ç°æœ‰æ•°æ®çš„å‰æä¸‹ï¼Œæ¢å¤æ—§ç‰ˆæœ¬çš„æ•°æ®æ¥éªŒè¯å†…å®¹ï¼Œæˆ–è€…è¿›è¡Œå…¶ä»–å¤„ç†ï¼Œå¯æ¢å¤æŒ‡å®šçš„ç´¢å¼•ï¼Œå¹¶é‡å‘½åè¯¥ç´¢å¼•ã€‚\n1 2 3 4 5 6 POST /_snapshot/my_backup/snapshot_1/_restore { \u0026#34;indices\u0026#34;: \u0026#34;index_1\u0026#34;, \u0026#34;rename_pattern\u0026#34;: \u0026#34;index_(.+)\u0026#34;, \u0026#34;rename_replacement\u0026#34;: \u0026#34;restored_index_$1\u0026#34; } å‚æ•° è¯´æ˜ indices åªæ¢å¤index_1ç´¢å¼•ï¼Œå¿½ç•¥å¿«ç…§ä¸­çš„å…¶ä»–ç´¢å¼•ã€‚ rename_pattern æŸ¥æ‰¾æ­£åœ¨æ¢å¤çš„ç´¢å¼•ï¼Œè¯¥ç´¢å¼•åç§°éœ€è¦ä¸æä¾›çš„æ¨¡æ¿åŒ¹é…ã€‚ rename_replacement é‡å‘½åæŸ¥æ‰¾åˆ°çš„ç´¢å¼•ã€‚ 2ã€æ¢å¤æ‰€æœ‰ç´¢å¼•ï¼ˆé™¤.å¼€å¤´çš„ç³»ç»Ÿç´¢å¼•ï¼‰ 1 2 POST _snapshot/my_backup/snapshot_1/_restore {\u0026#34;indices\u0026#34;:\u0026#34;*,-.monitoring*,-.security*,-.kibana*\u0026#34;,\u0026#34;ignore_unavailable\u0026#34;:\u0026#34;true\u0026#34;} 3ã€æ¢å¤æ‰€æœ‰ç´¢å¼•ï¼ˆåŒ…å«.å¼€å¤´çš„ç³»ç»Ÿç´¢å¼•ï¼‰ 1 POST _snapshot/my_backup/snapshot_1/_restore å‡è®¾snapshot_1ä¸­åŒ…å«5ä¸ªç´¢å¼•ï¼Œé‚£ä¹ˆè¿™5ä¸ªç´¢å¼•éƒ½ä¼šè¢«æ¢å¤åˆ°é›†ç¾¤ä¸­ã€‚\n_restore APIä¼šç«‹åˆ»è¿”å›ï¼Œæ¢å¤è¿›ç¨‹ä¼šåœ¨åå°è¿›è¡Œã€‚å¦‚æœæ‚¨å¸Œæœ›è°ƒç”¨é˜»å¡ç›´åˆ°æ¢å¤å®Œæˆï¼Œå¯ä»¥æ·»åŠ wait_for_completionå‚æ•°ã€‚ 1 POST _snapshot/my_backup/snapshot_1/_restore?wait_for_completion=true 4ã€å°†å¿«ç…§æ¢å¤åˆ°Indexing Serviceå®ä¾‹ä¸­ã€‚ ä¾‹å¦‚å°†my_backupä»“åº“ä¸­ï¼Œsnapshot_1å¿«ç…§ä¸­çš„index_1ç´¢å¼•æ•°æ®æ¢å¤åˆ°Indexing Serviceå®ä¾‹ä¸­ï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚\n** è¯´æ˜** å®é™…ä½¿ç”¨æ—¶ï¼Œæ‚¨éœ€è¦å°†å¯¹åº”ä¿¡æ¯æ›¿æ¢ä¸ºæ‚¨å®é™…çš„ä¿¡æ¯ã€‚\n1 2 3 4 5 6 7 POST /_snapshot/my_backup/snapshot_1/_restore { \u0026#34;indices\u0026#34;: \u0026#34;index_1\u0026#34;, \u0026#34;ignore_index_settings\u0026#34;: [ \u0026#34;index.apack.cube.following_index\u0026#34; ] } 7ã€æŸ¥çœ‹å¿«ç…§æ¢å¤ä¿¡æ¯ æ‚¨å¯ä»¥é€šè¿‡_recovery APIæ¥ç›‘æ§å¿«ç…§æ¢å¤çš„çŠ¶æ€ã€è¿›åº¦ç­‰ä¿¡æ¯ã€‚\n1ã€æŸ¥çœ‹å¿«ç…§ä¸­æŒ‡å®šç´¢å¼•çš„æ¢å¤çŠ¶æ€ 1 GET restored_index_3/_recovery 2ã€æŸ¥çœ‹é›†ç¾¤ä¸­çš„æ‰€æœ‰ç´¢å¼•çš„æ¢å¤ä¿¡æ¯ è¯´æ˜ è·å–çš„æ¢å¤ä¿¡æ¯å¯èƒ½åŒ…å«è·Ÿæ‚¨çš„æ¢å¤è¿›ç¨‹æ— å…³çš„å…¶ä»–åˆ†ç‰‡çš„æ¢å¤ä¿¡æ¯ã€‚\n1 GET /_recovery/ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 { \u0026#34;restored_index_3\u0026#34; : { \u0026#34;shards\u0026#34; : [ { \u0026#34;id\u0026#34; : 0, \u0026#34;type\u0026#34; : \u0026#34;snapshot\u0026#34;, \u0026#34;stage\u0026#34; : \u0026#34;index\u0026#34;, \u0026#34;primary\u0026#34; : true, \u0026#34;start_time\u0026#34; : \u0026#34;2014-02-24T12:15:59.716\u0026#34;, \u0026#34;stop_time\u0026#34; : 0, \u0026#34;total_time_in_millis\u0026#34; : 175576, \u0026#34;source\u0026#34; : { \u0026#34;repository\u0026#34; : \u0026#34;my_backup\u0026#34;, \u0026#34;snapshot\u0026#34; : \u0026#34;snapshot_3\u0026#34;, \u0026#34;index\u0026#34; : \u0026#34;restored_index_3\u0026#34; }, \u0026#34;target\u0026#34; : { \u0026#34;id\u0026#34; : \u0026#34;ryqJ5lO5S4-lSFbGnt****\u0026#34;, \u0026#34;hostname\u0026#34; : \u0026#34;my.fqdn\u0026#34;, \u0026#34;ip\u0026#34; : \u0026#34;10.0.**.**\u0026#34;, \u0026#34;name\u0026#34; : \u0026#34;my_es_node\u0026#34; }, \u0026#34;index\u0026#34; : { \u0026#34;files\u0026#34; : { \u0026#34;total\u0026#34; : 73, \u0026#34;reused\u0026#34; : 0, \u0026#34;recovered\u0026#34; : 69, \u0026#34;percent\u0026#34; : \u0026#34;94.5%\u0026#34; }, \u0026#34;bytes\u0026#34; : { \u0026#34;total\u0026#34; : 79063092, \u0026#34;reused\u0026#34; : 0, \u0026#34;recovered\u0026#34; : 68891939, \u0026#34;percent\u0026#34; : \u0026#34;87.1%\u0026#34; }, \u0026#34;total_time_in_millis\u0026#34; : 0 }, \u0026#34;translog\u0026#34; : { \u0026#34;recovered\u0026#34; : 0, \u0026#34;total_time_in_millis\u0026#34; : 0 }, \u0026#34;start\u0026#34; : { \u0026#34;check_index_time\u0026#34; : 0, \u0026#34;total_time_in_millis\u0026#34; : 0 } } ] } } è¾“å‡ºç»“æœä¼šå±•ç¤ºæ‰€æœ‰æ¢å¤ä¸­çš„ç´¢å¼•ï¼Œå¹¶åˆ—å‡ºè¿™äº›ç´¢å¼•ä¸­çš„æ‰€æœ‰åˆ†ç‰‡ã€‚åŒæ—¶æ¯ä¸ªåˆ†ç‰‡ä¸­ä¼šå±•ç¤ºå¯åŠ¨å’Œåœæ­¢æ—¶é—´ã€æŒç»­æ—¶é—´ã€æ¢å¤ç™¾åˆ†æ¯”ã€ä¼ è¾“å­—èŠ‚æ•°ç­‰ç»Ÿè®¡å€¼ã€‚éƒ¨åˆ†å‚æ•°è¯´æ˜å¦‚ä¸‹ã€‚\nå‚æ•° è¯´æ˜ type æ¢å¤çš„ç±»å‹ã€‚snapshotè¡¨ç¤ºè¿™ä¸ªåˆ†ç‰‡æ˜¯åœ¨ä»ä¸€ä¸ªå¿«ç…§æ¢å¤ã€‚ source å¾…æ¢å¤çš„å¿«ç…§å’Œä»“åº“ã€‚ percent æ¢å¤çš„è¿›åº¦ã€‚**94.5%**è¡¨ç¤ºå¯¹åº”åˆ†ç‰‡å·²ç»æ¢å¤äº†94.5%çš„æ•°æ®ã€‚ 8ã€åˆ é™¤æ­£åœ¨è¿›è¡Œå¿«ç…§æ¢å¤çš„ç´¢å¼• é€šè¿‡DELETEå‘½ä»¤åˆ é™¤æ­£åœ¨æ¢å¤çš„ç´¢å¼•ï¼Œå–æ¶ˆæ¢å¤æ“ä½œã€‚\nâ€‹\n1 DELETE /restored_index_3 2ã€å¤‡ä»½è„šæœ¬ â€‹\n1ã€Elasticsearchç´¢å¼•å¤‡ä»½ 1 2 #Elasticsearchç´¢å¼•å¤‡ä»½ 1 3 * * * /bin/bash -x /opt/shell-code/es_backup.sh \u0026gt; /opt/shell-code/logs/es_backup.log 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 #!/bin/bash #/********************************************************** # * Author : å—å®«ä¹˜é£ # * Email : 1794748404@qq.com # * Last modified : 2022-11-03 23:43 # * Filename : 01_ping_check_isalive.sh # * Description : # * *******************************************************/ #/bin/bash ################################### #æ—¥å¿—çº§åˆ« debug-1, info-2, warn-3, error-4, always-5 LOG_LEVEL=3 user=$(whoami) #æ—¥å¿—æ–‡ä»¶ LOG_FILE=./Elasticsearch.log #è°ƒè¯•æ—¥å¿— function log_debug() { content=\u0026#34;[DEBUG] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $0 $user msg : $@\u0026#34; [ $LOG_LEVEL -le 1 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE } #ä¿¡æ¯æ—¥å¿— function log_info() { content=\u0026#34;[INFO] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $0 $user msg : $@\u0026#34; [ $LOG_LEVEL -le 2 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE } #è­¦å‘Šæ—¥å¿— function log_warn() { content=\u0026#34;[WARN] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $0 $user msg : $@\u0026#34; [ $LOG_LEVEL -le 3 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE } #é”™è¯¯æ—¥å¿— function log_err() { content=\u0026#34;[ERROR] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $0 $user msg : $@\u0026#34; [ $LOG_LEVEL -le 4 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE } #ä¸€ç›´éƒ½ä¼šæ‰“å°çš„æ—¥å¿— function log_always() { content=\u0026#34;[ALWAYS] $(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) $0 $user msg : $@\u0026#34; [ $LOG_LEVEL -le 5 ] \u0026amp;\u0026amp; echo $content \u0026gt;\u0026gt;$LOG_FILE } # æ‰§è¡Œå¿«ç…§å¤‡ä»½ #times=\u0026#34;2022.09.08 2022.09.09 2022.09.10 2022.09.11 2022.09.12 2022.09.13 2022.09.14 2022.09.15 2022.09.16 2022.09.17 2022.09.18 2022.09.19 2022.09.20 2022.09.21 2022.09.22 2022.09.23 2022.09.24 2022.09.25 2022.09.26 2022.09.27 2022.09.28 2022.09.29 2022.09.30 2022.10.01 2022.10.02 2022.10.03 2022.10.04 2022.10.05 2022.10.06 2022.10.07 2022.10.08 2022.10.09 2022.10.10 2022.10.11 2022.10.12 2022.10.13 2022.10.14 2022.10.15 2022.10.16 2022.10.17 2022.10.18 2022.10.19 2022.10.20 2022.10.21 2022.10.22 2022.10.23 2022.10.24 2022.10.25 2022.10.26 2022.10.27 2022.10.28 2022.10.29 2022.10.30 2022.10.31 2022.11.01 2022.11.02 2022.11.03 2022.11.04 2022.11.05 2022.11.06 2022.11.07 2022.11.08 2022.11.09 \u0026#34; time=$(date +\u0026#34;%Y.%m.%d\u0026#34; -d \u0026#34;-1day\u0026#34;) host=\u0026#39;http://elasticsearch-log.prod.server.fjf:9200\u0026#39; username=\u0026#39;elastic\u0026#39; password=\u0026#39;4reQiUCLB7meNU8VoUsm\u0026#39; #ä»“åº“åç§° STORE_NAME=\u0026#34;backup\u0026#34; #curlçš„ç»å¯¹è·¯å¾„ CURL_CMD=\u0026#34;/usr/bin/curl\u0026#34; #å‘Šè­¦ä¿¡æ¯ webhook=\u0026#39;https://oapi.dingtalk.com/robot/send?access_token=810921774dac36151d8939b6ea68c90df667f50e1313xxxxxxxxxxxx\u0026#39; cluster=\u0026#39;ESå¤‡ä»½å‘Šè­¦\u0026#39; function SendMsgToDingding() { curl $webhook -H \u0026#39;Content-Type: application/json\u0026#39; -d \u0026#34; { \u0026#39;msgtype\u0026#39;: \u0026#39;text\u0026#39;, \u0026#39;text\u0026#39;: { \u0026#39;content\u0026#39;: \u0026#39;é›†ç¾¤åç§°ï¼š$cluster\\nå‘Šè­¦ä¿¡æ¯ï¼š $1 å·²ç»å¤‡ä»½å®Œæˆ \\n\u0026#39; }, \u0026#39;at\u0026#39;: { \u0026#39;isAtAll\u0026#39;: true } }\u0026#34; } list_groups=\u0026#34;labor-prod-${time},app-prod-${time},fk-prod-${time}\u0026#34; curl -s -u elastic:4reQixxxxxVoUsm -sXPUT http://exxxxxxxxxxxxxxxxxxxerver.fjf:9200/_snapshot/backup/log_es_${time}?wait_for_completion=true -H \u0026#39;Content-Type: application/json\u0026#39; -d\u0026#39;{ \u0026#34;indices\u0026#34;: \u0026#34;\u0026#39;${list_groups}\u0026#39;\u0026#34; }\u0026#39; if [[ $? -eq 0 ]]; then SendMsgToDingding $list_groups log_always \u0026#34; $list_groups å·²ç»å¤‡ä»½æˆåŠŸ\u0026#34; else log_err \u0026#34;$list_groups å¤‡ä»½å¤±è´¥ï¼Œè¯·æŸ¥çœ‹\u0026#34; fi 2ã€Elasticsearchç´¢å¼•æ¸…ç† 1 2 # Elasticsearchç´¢å¼•æ¸…ç† 1 3 * * * bash /opt/shell-code/es_index.sh 2\u0026gt;\u0026amp;1 \u0026gt; /usr/local/script/es_index.log 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 #author : å—å®«ä¹˜é£ # * Email : 1794748404@qq.com # * Last modified : 2022-11-03 23:43 # * Filename : 01_ping_check_isalive.sh # * Description : # * *******************************************************/ #/bin/bash ################################### #!/bin/bash host=\u0026#39;elasticxxxxxxxxxxxxxxxx.fjf\u0026#39; username=\u0026#39;elastic\u0026#39; password=\u0026#39;4reQiUxxxxxxxxxxxxxx\u0026#39; ########################################### å¦‚ä¸‹ç”¨äºæ¸…ç†æ—§çš„ç´¢å¼•æ•°æ® ########################################## # æ¸…é™¤æ—§ç´¢å¼• function purgeOldIndexes() { for i in $INDEXES; do for index in `curl -u $username:$password -s http://$host:9200/_cat/indices |grep -P \u0026#34;$i\u0026#34; |awk \u0026#39;{print $3}\u0026#39; |sort -r | tail -n +${NUM}` do echo ${index} curl -u $username:$password -s -XDELETE http://$host:9200/${index} done done } # ä¸åŒç´¢å¼•çš„æ—¥å¿—ä¿ç•™æ—¶é•¿è¦æ±‚ä¸åŒï¼Œ NUM=11 INDEXES=\u0026#34;monitoring-es syslog zipkin-prod:dependency zipkin-prod:span \u0026#34; purgeOldIndexes sleep 10 NUM=31 INDEXES=\u0026#34;logstash-fk-prod logstash-_doc logstash-prod \u0026#34; purgeOldIndexes sleep 10 NUM=60 INDEXES=\u0026#34;app-prod fk-prod \u0026#34; purgeOldIndexes sleep 10 NUM=91 INDEXES=\u0026#34;labor-prod\u0026#34; purgeOldIndexes æ–‡æ¡£ï¼šé€šè¿‡OSSå°†è‡ªå»ºElasticsearchæ•°æ®è¿ç§»è‡³é˜¿é‡Œäº‘\nè‡ªåŠ¨å¤‡ä»½ä¸æ¢å¤\næ‰‹åŠ¨å¤‡ä»½ä¸æ¢å¤\nå¤‡ä»½ä½ çš„é›†ç¾¤\nElasticsearchçš„Snapshot and Restoreï¼ˆå¿«ç…§å¤‡ä»½ä¸æ¢å¤ï¼‰\nSnapshot And Restore\nè‡ªåŠ¨å¤‡ä»½ä¸æ¢å¤\n","date":"2022-11-13T09:22:34Z","image":"https://www.ownit.top/title_pic/51.jpg","permalink":"https://www.ownit.top/p/202211130922/","title":"Elasticsearchå¿«ç…§å¤‡ä»½"},{"content":"1ã€Gitlab-runner â€‹GitLab Runneræ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œç”¨äºè¿è¡Œæ‚¨çš„ä½œä¸šå¹¶å°†ç»“æœå‘é€å›GitLabã€‚å®ƒä¸GitLab CIç»“åˆä½¿ç”¨ï¼ŒGitLab CIæ˜¯GitLabéšé™„çš„ç”¨äºåè°ƒä½œä¸šçš„å¼€æºæŒç»­é›†æˆæœåŠ¡ã€‚â€‹\nè¦æ±‚ GitLab Runneræ˜¯ç”¨Goç¼–å†™çš„ï¼Œå¯ä»¥ä½œä¸ºä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶è¿è¡Œï¼Œä¸éœ€è¦ç‰¹å®šäºè¯­è¨€çš„è¦æ±‚ã€‚å®ƒæ—¨åœ¨åœ¨GNU / Linuxï¼ŒmacOSå’ŒWindowsæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œã€‚åªè¦æ‚¨å¯ä»¥åœ¨å…¶ä»–æ“ä½œç³»ç»Ÿä¸Šç¼–è¯‘GoäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…¶ä»–æ“ä½œç³»ç»Ÿå°±å¯èƒ½ä¼šè¿è¡Œã€‚\nå¦‚æœè¦ä½¿ç”¨Dockerï¼Œè¯·å®‰è£…æœ€æ–°ç‰ˆæœ¬ã€‚GitLab Runneréœ€è¦æœ€å°‘çš„Docker v1.13.0ã€‚\nGitLab Runnerç‰ˆæœ¬åº”ä¸GitLabç‰ˆæœ¬åŒæ­¥ã€‚å°½ç®¡è¾ƒæ—§çš„Runnerä»å¯ä»¥ä½¿ç”¨è¾ƒæ–°çš„GitLabç‰ˆæœ¬ï¼Œåä¹‹äº¦ç„¶ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœç‰ˆæœ¬å­˜åœ¨å·®å¼‚ï¼Œåˆ™åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨æˆ–æ— æ³•æ­£å¸¸å·¥ä½œã€‚åœ¨æ¬¡è¦ç‰ˆæœ¬æ›´æ–°ä¹‹é—´å¯ä»¥ä¿è¯å‘åå…¼å®¹æ€§ï¼Œä½†æ˜¯è¯·æ³¨æ„ï¼ŒGitLabçš„æ¬¡è¦ç‰ˆæœ¬æ›´æ–°ä¼šå¼•å…¥æ–°åŠŸèƒ½ï¼Œè¿™äº›æ–°åŠŸèƒ½å°†è¦æ±‚Runneråœ¨åŒä¸€æ¬¡è¦ç‰ˆæœ¬ä¸Šä½¿ç”¨ã€‚\nç‰¹ç‚¹ å…è®¸è¿è¡Œï¼š\nåŒæ—¶æ‰§è¡Œå¤šä¸ªä½œä¸šã€‚\nå¯¹å¤šä¸ªæœåŠ¡å™¨ï¼ˆç”šè‡³æ¯ä¸ªé¡¹ç›®ï¼‰ä½¿ç”¨å¤šä¸ªä»¤ç‰Œã€‚\né™åˆ¶æ¯ä¸ªä»¤ç‰Œçš„å¹¶è¡Œä½œä¸šæ•°ã€‚\nå¯ä»¥è¿è¡Œä½œä¸šï¼š\nåœ¨æœ¬åœ°ã€‚\nä½¿ç”¨Dockerå®¹å™¨ã€‚\nä½¿ç”¨Dockerå®¹å™¨å¹¶é€šè¿‡SSHæ‰§è¡Œä½œä¸šã€‚\nä½¿ç”¨Dockerå®¹å™¨åœ¨ä¸åŒçš„äº‘å’Œè™šæ‹ŸåŒ–ç®¡ç†ç¨‹åºä¸Šè‡ªåŠ¨ç¼©æ”¾ã€‚\nè¿æ¥åˆ°è¿œç¨‹SSHæœåŠ¡å™¨ã€‚\nç”¨Goç¼–å†™å¹¶ä»¥å•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶çš„å½¢å¼åˆ†å‘ï¼Œè€Œæ²¡æœ‰å…¶ä»–è¦æ±‚ã€‚\næ”¯æŒBashï¼ŒWindows Batchå’ŒWindows PowerShellã€‚\nåœ¨GNU / Linuxï¼ŒmacOSå’ŒWindowsï¼ˆå‡ ä¹å¯ä»¥åœ¨ä»»ä½•å¯ä»¥è¿è¡ŒDockerçš„åœ°æ–¹ï¼‰ä¸Šè¿è¡Œã€‚\nå…è®¸è‡ªå®šä¹‰ä½œä¸šè¿è¡Œç¯å¢ƒã€‚\nè‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®ï¼Œæ— éœ€é‡å¯ã€‚\næ˜“äºä½¿ç”¨çš„è®¾ç½®ï¼Œå¹¶æ”¯æŒDockerï¼ŒDocker-SSHï¼ŒParallelsæˆ–SSHè¿è¡Œç¯å¢ƒã€‚\nå¯ç”¨Dockerå®¹å™¨çš„ç¼“å­˜ã€‚\næ˜“äºå®‰è£…ï¼Œå¯ä½œä¸ºGNU / Linuxï¼ŒmacOSå’ŒWindowsçš„æœåŠ¡ã€‚\nåµŒå…¥å¼PrometheusæŒ‡æ ‡HTTPæœåŠ¡å™¨ã€‚\nè£åˆ¤å·¥ä½œè€…ç›‘è§†Prometheusåº¦é‡æ ‡å‡†å’Œå…¶ä»–ç‰¹å®šäºå·¥ä½œçš„æ•°æ®å¹¶å°†å…¶ä¼ é€’ç»™GitLabã€‚\n2ã€GitLab Runnerå®‰è£… å¯ä»¥åœ¨GNU / Linuxï¼ŒmacOSï¼ŒFreeBSDå’ŒWindowsä¸Šâ€‹å®‰è£…å’Œä½¿ç”¨GitLab Runner ã€‚æ‚¨å¯ä»¥ä½¿ç”¨Dockerå®‰è£…å®ƒï¼Œæ‰‹åŠ¨ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨GitLabæä¾›çš„rpm / debè½¯ä»¶åŒ…çš„å­˜å‚¨åº“ã€‚\n1. ä½¿ç”¨GItLabå®˜æ–¹ä»“åº“å®‰è£… é‡ç‚¹æŒæ¡CentOSç³»ç»Ÿçš„å®‰è£…æ–¹å¼\né‡ç‚¹æŒæ¡Ubuntuç³»ç»Ÿçš„å®‰è£…æ–¹å¼\næˆ‘ä»¬æä¾›Debianï¼ŒUbuntuï¼ŒMintï¼ŒRHELï¼ŒFedoraå’ŒCentOSå½“å‰å—æ”¯æŒç‰ˆæœ¬çš„è½¯ä»¶åŒ…ã€‚\nDistribution Version End of Life date Debian stretch approx. 2022 Debian jessie June 2020 Ubuntu bionic April 2023 Ubuntu xenial April 2021 Mint sonya approx. 2021 Mint serena approx. 2021 Mint sarah approx. 2021 RHEL/CentOS 7 June 2024 RHEL/CentOS 6 November 2020 Fedora 29 approx. November 2019 Add GitLabâ€™s official repository: æ·»åŠ å®˜æ–¹ä»“åº“\n1 2 3 4 5 # For Debian/Ubuntu/Mint curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash # For RHEL/CentOS/Fedora curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh | sudo bash Install the latest version of GitLab Runner: å®‰è£…æœ€æ–°ç‰ˆæœ¬\n1 2 3 4 5 # For Debian/Ubuntu/Mint sudo apt-get install gitlab-runner # For RHEL/CentOS/Fedora sudo yum install gitlab-runner To install a specific version of GitLab Runner: å®‰è£…æŒ‡å®šç‰ˆæœ¬\n1 2 3 4 5 6 7 # for DEB based systems apt-cache madison gitlab-runner sudo apt-get install gitlab-runner=10.0.0 # for RPM based systems yum list gitlab-runner --showduplicates | sort -r sudo yum install gitlab-runner-10.0.0-1 æ›´æ–°runner\n1 2 3 4 5 6 7 # For Debian/Ubuntu/Mint sudo apt-get update sudo apt-get install gitlab-runner # For RHEL/CentOS/Fedora sudo yum update sudo yum install gitlab-runner 2. Linuxä¸Šæ‰‹åŠ¨å®‰è£…GitLab Runner å¦‚æœæ‚¨ä¸èƒ½ä½¿ç”¨â€‹deb / rpmå­˜å‚¨åº“å®‰è£…GitLab Runnerï¼Œæˆ–è€…æ‚¨çš„GNU / Linuxæ“ä½œç³»ç»Ÿä¸åœ¨æ”¯æŒçš„ç‰ˆæœ¬ä¸­ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸€ç§æ–¹æ³•æ‰‹åŠ¨å®‰è£…å®ƒï¼Œè¿™æ˜¯æœ€åçš„é€‰æ‹©ã€‚\né€šè¿‡debæˆ–rpmè½¯ä»¶åŒ… ä¸‹è½½è½¯ä»¶åŒ…\nåœ¨â€‹https://gitlab-runner-downloads.s3.amazonaws.com/latest/index.htmlä¸Šæ‰¾åˆ°æœ€æ–°çš„æ–‡ä»¶åå’Œé€‰é¡¹ ã€‚\né€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬å¹¶ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚æ–‡æ¡£æ‰€è¿°ï¼Œè¯¥æ–‡ä»¶ç”¨äºâ€‹ä¸‹è½½ä»»ä½•å…¶ä»–æ ‡è®°çš„ GitLab Runnerå‘è¡Œç‰ˆã€‚\nä¾‹å¦‚ï¼Œå¯¹äºDebianæˆ–Ubuntuï¼š\n1 2 3 4 5 curl -LJO https://gitlab-runner-downloads.s3.amazonaws.com/latest/deb/gitlab-runner_\u0026lt;arch\u0026gt;.deb dpkg -i gitlab-runner_\u0026lt;arch\u0026gt;.deb dpkg -i gitlab-runner_\u0026lt;arch\u0026gt;.deb ä¾‹å¦‚ï¼Œå¯¹äºCentOSæˆ–Red Hat Enterprise Linuxï¼š\nâ€‹\n1 2 3 4 5 curl -LJO https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner_\u0026lt;arch\u0026gt;.rpm rpm -i gitlab-runner_\u0026lt;arch\u0026gt;.rpm rpm -Uvh gitlab-runner_\u0026lt;arch\u0026gt;.rpm ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶(å®˜æ–¹æ¨è) å‚è€ƒåœ°å€ï¼š https://docs.gitlab.com/12.6/runner/install/bleeding-edge.html#download-any-other-tagged-release\nä¸‹è½½æŒ‡å®šç‰ˆæœ¬ï¼š å°†ä¸Šé¢URLä¸­çš„lateståˆ‡æ¢ä¸º v12.6ã€‚\nâ€‹\n1 2 3 4 5 6 7 8 9 10 11 # Linux x86-64 sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64 # Linux x86 sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-386 # Linux arm sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-arm # Linux arm64 sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-arm64 æ·»åŠ æ‰§è¡Œæƒé™\n1 sudo chmod +x /usr/local/bin/gitlab-runner åˆ›å»ºä¸€ä¸ªgitlabç”¨æˆ·\n1 sudo useradd --comment \u0026#39;GitLab Runner\u0026#39; --create-home gitlab-runner --shell /bin/bash å®‰è£…å¹¶ä½œä¸ºæœåŠ¡è¿è¡Œ\n1 2 sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner sudo gitlab-runner start æ›´æ–°\n1 2 3 4 5 6 7 8 9 10 11 #åœæ­¢æœåŠ¡ sudo gitlab-runner stop #ä¸‹è½½æ–°ç‰ˆæœ¬äºŒè¿›åˆ¶åŒ… sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64 #èµ‹äºˆæ‰§è¡Œæƒé™ sudo chmod +x /usr/local/bin/gitlab-runner #å¯åŠ¨æœåŠ¡ sudo gitlab-runner start 3. åœ¨å®¹å™¨ä¸­è¿è¡ŒGitLab Runner 1 docker run --rm -t -id -v ~/data/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner:v12.6.0 3ã€GitLab Runneræ³¨å†Œ **å‚è€ƒé“¾æ¥ï¼š**â€‹ä½¿ç”¨GitLab CIè¿è¡ŒGitLab Runnerå¹¶æ‰§è¡ŒPipeline\nå¤§æ¦‚è¿‡ç¨‹ï¼š è·å–runner token -\u0026gt; è¿›è¡Œæ³¨å†Œ\nGitLabRunner ç±»å‹ shared ï¼š è¿è¡Œæ•´ä¸ªå¹³å°é¡¹ç›®çš„ä½œä¸šï¼ˆgitlabï¼‰\ngroupï¼š è¿è¡Œç‰¹å®šgroupä¸‹çš„æ‰€æœ‰é¡¹ç›®çš„ä½œä¸šï¼ˆgroupï¼‰\nspecific: è¿è¡ŒæŒ‡å®šçš„é¡¹ç›®ä½œä¸šï¼ˆprojectï¼‰\nlockedï¼š æ— æ³•è¿è¡Œé¡¹ç›®ä½œä¸š\npausedï¼š ä¸ä¼šè¿è¡Œä½œä¸š\nè·å–runner token è·å–sharedç±»å‹runnertoken\nè¿›å…¥ç³»ç»Ÿè®¾ç½® -\u0026gt; Runners\nè·å–groupç±»å‹çš„runnertoken\nè¿›å…¥group -\u0026gt; Settings -\u0026gt; CI/CD -\u0026gt; Runners -\u0026gt; Group Runners\nè·å–specificç±»å‹çš„runnertoken\nè¿›å…¥å…·ä½“çš„é¡¹ç›® -\u0026gt; Settings -\u0026gt; CI/CD -\u0026gt; Runners -\u0026gt; Specific Runners\nè¿›è¡Œæ³¨å†Œ æ–¹å¼1ï¼š å¯åŠ¨å®¹å™¨äº¤äº’å¼æ³¨å†Œ 1 docker run --rm -t -i -v ~/data/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner:v12.6.0 register 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Runtime platform arch=amd64 os=linux pid=6 revision=ac8e767a version=12.6.0 Running in system-mode. Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/): #gitlabåœ°å€ http://192.168.1.105 Please enter the gitlab-ci token for this runner: #gitlab-runnerçš„token 4tutaeWWL3srNEcmHs1s Please enter the gitlab-ci description for this runner: #gitlab-runnerçš„æè¿° [00e4f023b5ae]: devops-service-runner Please enter the gitlab-ci tags for this runner (comma separated): #gitlab-runnerçš„ æ ‡ç­¾ build Registering runner... succeeded runner=4tutaeWW Please enter the executor: parallels, virtualbox, docker-ssh+machine, kubernetes, docker+machine, custom, docker, docker-ssh, shell, ssh: #gitlab-runnerçš„è¿è¡Œçš„æ–¹å¼ shell Runner registered successfully. Feel free to start it, but if it\u0026#39;s running already the config should be automatically reloaded! æ–¹å¼2ï¼šç›´æ¥æ³¨å†Œ 1 2 3 4 5 6 7 8 9 10 11 docker run --rm -v ~/data/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner:v12.6.0 register \\ --non-interactive \\ --executor \u0026#34;docker\u0026#34; \\ --docker-image alpine:latest \\ --url \u0026#34;http://192.168.1.200:30088/\u0026#34; \\ --registration-token \u0026#34;JRzzw2j1Ji6aBjwvkxAv\u0026#34; \\ --description \u0026#34;docker-runner\u0026#34; \\ --tag-list \u0026#34;docker,aws\u0026#34; \\ --run-untagged=\u0026#34;true\u0026#34; \\ --locked=\u0026#34;false\u0026#34; \\ --access-level=\u0026#34;not_protected\u0026#34; 1 2 3 4 5 6 7 8 9 10 docker run -it --rm -v ~/data/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner:v12.6.0 register \\ --non-interactive \\ --executor \u0026#34;shell\u0026#34; \\ --url \u0026#34;http://gitlab.devops.com\u0026#34; \\ --registration-token \u0026#34;FZwnmCacrXfk37yZzfNJ\u0026#34; \\ --description \u0026#34;devops-runner\u0026#34; \\ --tag-list \u0026#34;build,deploy\u0026#34; \\ --run-untagged=\u0026#34;true\u0026#34; \\ --locked=\u0026#34;false\u0026#34; \\ --access-level=\u0026#34;not_protected\u0026#34; 1 2 3 4 5 6 7 8 9 10 docker run -itd --rm -v ~/data/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner:v12.6.0 register \\ --non-interactive \\ --executor \u0026#34;shell\u0026#34; \\ --url \u0026#34;http://192.168.1.200:30088/\u0026#34; \\ --registration-token \u0026#34;JRzzw2j1Ji6aBjwvkxAv\u0026#34; \\ --description \u0026#34;devops-runner\u0026#34; \\ --tag-list \u0026#34;build,deploy\u0026#34; \\ --run-untagged=\u0026#34;true\u0026#34; \\ --locked=\u0026#34;false\u0026#34; \\ --access-level=\u0026#34;not_protected\u0026#34; æµ‹è¯•ç¯å¢ƒä½¿ç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #uat dev fat ç¯å¢ƒ gitlab-runner register \\ --non-interactive \\ --executor \u0026#34;shell\u0026#34; \\ --url \u0026#34;http://172.17.20.20:8200/\u0026#34; \\ --registration-token \u0026#34;HH5ey1cfWis5UsByz1hs\u0026#34; \\ --description \u0026#34;devops-runner\u0026#34; \\ --tag-list \u0026#34;dev,fat,uat\u0026#34; \\ --run-untagged=\u0026#34;true\u0026#34; \\ --locked=\u0026#34;false\u0026#34; \\ --access-level=\u0026#34;not_protected\u0026#34; # prod ç¯å¢ƒ gitlab-runner register \\ --non-interactive \\ --executor \u0026#34;shell\u0026#34; \\ --url \u0026#34;https://gitlab.ownit.top/\u0026#34; \\ --registration-token \u0026#34;uExfDik6eNLMzEzpnmD8\u0026#34; \\ --description \u0026#34;prod\u0026#34; \\ --tag-list \u0026#34;prod\u0026#34; \\ --run-untagged=\u0026#34;false\u0026#34; \\ --locked=\u0026#34;false\u0026#34; \\ --access-level=\u0026#34;not_protected\u0026#34; å…¶ä»–å˜é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 -c value, --config value æŒ‡å®šé…ç½®æ–‡ä»¶ --template-config value æŒ‡å®šæ¨¡æ¿é…ç½®æ–‡ä»¶ --tag-list value æŒ‡å®šrunnerçš„æ ‡ç­¾åˆ—è¡¨ï¼Œé€—å·åˆ†éš” -n, --non-interactive æ— äº¤äº’è¿›è¡Œrunneræ³¨å†Œ --leave-runner å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œä¸ç”¨åˆ é™¤runner -r value, --registration-token value runnerçš„æ³¨å†Œtoken --run-untagged æ³¨å†Œè¿è¡ŒæœªåŠ æ ‡ç­¾çš„æ„å»ºï¼Œé»˜è®¤å½“æ ‡ç­¾åˆ—è¡¨ä¸ºç©ºæ—¶å€¼ä¸ºtrue --locked é”å®šrunner é»˜è®¤true --access-level value è®¾ç½®è®¿é—®ç­‰çº§ not_protected or ref_protected; é»˜è®¤ not_protected --maximum-timeout value ä¸ºä½œä¸šè®¾ç½®æœ€å¤§è¿è¡Œè¶…æ—¶æ—¶é—´ é»˜è®¤é›¶ å•ä½ç§’ --paused è®¾ç½®runnerä¸º paused,é»˜è®¤ \u0026#39;false\u0026#39; --name value, --description value Runner åç§° --limit value ç¨‹åºå¤„ç†çš„æœ€å¤§æ„å»ºæ•°é‡default: \u0026#34;0\u0026#34; --output-limit value æœ€å¤§çš„æ„å»ºå¤§å°å•ä½kb default: \u0026#34;0\u0026#34; --request-concurrency value ä½œä¸šè¯·æ±‚çš„æœ€å¤§å¹¶å‘æ•° default: \u0026#34;0\u0026#34; -u value, --url value GitlabCIæœåŠ¡å™¨åœ°å€ -t value, --token value GitlabCIæœåŠ¡å™¨token 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 root@82948f0a37e3:/# gitlab-runner register --help Runtime platform arch=amd64 os=linux pid=168 revision=ac8e767a version=12.6.0 NAME: gitlab-runner register - register a new runner USAGE: gitlab-runner register [command options] [arguments...] OPTIONS: --tls-ca-file value File containing the certificates to verify the peer when using HTTPS [$CI_SERVER_TLS_CA_FILE] --tls-cert-file value File containing certificate for TLS client auth when using HTTPS [$CI_SERVER_TLS_CERT_FILE] --tls-key-file value File containing private key for TLS client auth when using HTTPS [$CI_SERVER_TLS_KEY_FILE] --executor value é€‰æ‹©æ‰§è¡Œå™¨ï¼Œä¾‹å¦‚shellï¼Œdocker --builds-dir value è®¾ç½®æ„å»ºå­˜å‚¨ç›®å½• --cache-dir value è®¾ç½®æ„å»ºç¼“å­˜ç›®å½• --clone-url value è¦†ç›–é»˜è®¤é€šè¿‡gitå…‹éš†çš„URL --env value æ³¨å…¥è‡ªå®šä¹‰ç¯å¢ƒå˜é‡ä»¥æ„å»ºç¯å¢ƒ --pre-clone-script value åœ¨æå–ä»£ç ä¹‹å‰æ‰§è¡Œçš„ç‰¹å®šäºè¿è¡Œç¨‹åºçš„å‘½ä»¤è„šæœ¬ --pre-build-script value ç‰¹å®šäºè¿è¡Œç¨‹åºçš„å‘½ä»¤è„šæœ¬ï¼Œåœ¨æå–ä»£ç ä¹‹åï¼Œåœ¨æ„å»ºæ‰§è¡Œä¹‹å‰æ‰§è¡Œ --post-build-script value ç‰¹å®šäºè¿è¡Œç¨‹åºçš„å‘½ä»¤è„šæœ¬ï¼Œåœ¨æå–ä»£ç åä»¥åŠåœ¨æ„å»ºæ‰§è¡Œåç«‹å³æ‰§è¡Œ --debug-trace-disabled è®¾ç½®ä¸ºtrueæ—¶ï¼ŒRunnerå°†ç¦ç”¨ä½¿ç”¨CI_DEBUG_TRACEåŠŸèƒ½çš„å¯èƒ½æ€§ --shell value é€‰æ‹© bash, cmd or powershell [$RUNNER_SHELL] --custom_build_dir-enabled å¯ç”¨ä½œä¸šç‰¹å®šçš„æ„å»ºç›®å½•[$CUSTOM_BUILD_DIR_ENABLED] --ssh-user value sshç”¨æˆ·åç§° [$SSH_USER] --ssh-password value sshç”¨æˆ·å¯†ç [$SSH_PASSWORD] --ssh-host value sshè¿œç¨‹ä¸»æœº[$SSH_HOST] --ssh-port value sshè¿œç¨‹ä¸»æœºç«¯å£ [$SSH_PORT] --ssh-identity-file value sshè®¤è¯æ–‡ä»¶ [$SSH_IDENTITY_FILE] --docker-host value Dockerä¸»æœºåœ°å€ [$DOCKER_HOST] --docker-cert-path value Dockerè¯ä¹¦è·¯å¾„ [$DOCKER_CERT_PATH] --docker-tlsverify Dockerä½¿ç”¨TLSå¹¶éªŒè¯è¿œç¨‹ [$DOCKER_TLS_VERIFY] --docker-hostname value è‡ªå®šä¹‰å®¹å™¨ä¸»æœºåç§° [$DOCKER_HOSTNAME] --docker-image value å®šä¹‰Dockeré•œåƒ[$DOCKER_IMAGE] --docker-runtime value Docker runtime to be used [$DOCKER_RUNTIME] --docker-memory value å†…å­˜é™åˆ¶ Unit [b, k, m, or g] 4M [$DOCKER_MEMORY] --docker-memory-swap value å†…å­˜é™åˆ¶memory + swapï¼ŒUnit[b, k, m, or g][$DOCKER_MEMORY_SWAP] --docker-memory-reservation value å†…å­˜è½¯é™åˆ¶[$DOCKER_MEMORY_RESERVATION] --docker-cpuset-cpus value cpué™åˆ¶[$DOCKER_CPUSET_CPUS] --docker-cpus value cpuæ•°é‡ [$DOCKER_CPUS] --docker-cpu-shares value CPU shares (default: \u0026#34;0\u0026#34;) [$DOCKER_CPU_SHARES] --docker-dns value A list of DNS servers for the container to use [$DOCKER_DNS] --docker-dns-search value A list of DNS search domains [$DOCKER_DNS_SEARCH] --docker-privileged Give extended privileges to container [$DOCKER_PRIVILEGED] --docker-disable-entrypoint-overwrite Disable the possibility for a container to overwrite the default image entrypoint [$DOCKER_DISABLE_ENTRYPOINT_OVERWRITE] --docker-userns value User namespace to use [$DOCKER_USERNS_MODE] --docker-cap-add value Add Linux capabilities [$DOCKER_CAP_ADD] --docker-cap-drop value Drop Linux capabilities [$DOCKER_CAP_DROP] --docker-oom-kill-disable Do not kill processes in a container if an out-of-memory (OOM) error occurs [$DOCKER_OOM_KILL_DISABLE] --docker-oom-score-adjust value Adjust OOM score (default: \u0026#34;0\u0026#34;) [$DOCKER_OOM_SCORE_ADJUST] --docker-security-opt value Security Options [$DOCKER_SECURITY_OPT] --docker-devices value Add a host device to the container [$DOCKER_DEVICES] --docker-disable-cache Disable all container caching [$DOCKER_DISABLE_CACHE] --docker-volumes value Bind-mount a volume and create it if it doesn\u0026#39;t exist prior to mounting. Can be specified multiple times once per mountpoint, e.g. --docker-volumes \u0026#39;test0:/test0\u0026#39; --docker-volumes \u0026#39;test1:/test1\u0026#39; [$DOCKER_VOLUMES] --docker-volume-driver value Volume driver to be used [$DOCKER_VOLUME_DRIVER] --docker-cache-dir value Directory where to store caches [$DOCKER_CACHE_DIR] --docker-extra-hosts value Add a custom host-to-IP mapping [$DOCKER_EXTRA_HOSTS] --docker-volumes-from value A list of volumes to inherit from another container [$DOCKER_VOLUMES_FROM] --docker-network-mode value Add container to a custom network [$DOCKER_NETWORK_MODE] --docker-links value Add link to another container [$DOCKER_LINKS] --docker-services value Add service that is started with container [$DOCKER_SERVICES] --docker-wait-for-services-timeout value How long to wait for service startup (default: \u0026#34;0\u0026#34;) [$DOCKER_WAIT_FOR_SERVICES_TIMEOUT] --docker-allowed-images value Whitelist allowed images [$DOCKER_ALLOWED_IMAGES] --docker-allowed-services value Whitelist allowed services [$DOCKER_ALLOWED_SERVICES] --docker-pull-policy value Image pull policy: never, if-not-present, always [$DOCKER_PULL_POLICY] --docker-shm-size value Shared memory size for docker images (in bytes) (default: \u0026#34;0\u0026#34;) [$DOCKER_SHM_SIZE] --docker-tmpfs value A toml table/json object with the format key=values. When set this will mount the specified path in the key as a tmpfs volume in the main container, using the options specified as key. For the supported options, see the documentation for the unix \u0026#39;mount\u0026#39; command (default: \u0026#34;{}\u0026#34;) [$DOCKER_TMPFS] --docker-services-tmpfs value A toml table/json object with the format key=values. When set this will mount the specified path in the key as a tmpfs volume in all the service containers, using the options specified as key. For the supported options, see the documentation for the unix \u0026#39;mount\u0026#39; command (default: \u0026#34;{}\u0026#34;) [$DOCKER_SERVICES_TMPFS] --docker-sysctls value Sysctl options, a toml table/json object of key=value. Value is expected to be a string. (default: \u0026#34;{}\u0026#34;) [$DOCKER_SYSCTLS] --docker-helper-image value [ADVANCED] Override the default helper image used to clone repos and upload artifacts [$DOCKER_HELPER_IMAGE] --parallels-base-name value VM name to be used [$PARALLELS_BASE_NAME] --parallels-template-name value VM template to be created [$PARALLELS_TEMPLATE_NAME] --parallels-disable-snapshots Disable snapshoting to speedup VM creation [$PARALLELS_DISABLE_SNAPSHOTS] --parallels-time-server value Timeserver to sync the guests time from. Defaults to time.apple.com [$PARALLELS_TIME_SERVER] --virtualbox-base-name value VM name to be used [$VIRTUALBOX_BASE_NAME] --virtualbox-base-snapshot value Name or UUID of a specific VM snapshot to clone [$VIRTUALBOX_BASE_SNAPSHOT] --virtualbox-disable-snapshots Disable snapshoting to speedup VM creation [$VIRTUALBOX_DISABLE_SNAPSHOTS] --cache-type value Select caching method [$CACHE_TYPE] --cache-path value Name of the path to prepend to the cache URL [$CACHE_PATH] --cache-shared Enable cache sharing between runners. [$CACHE_SHARED] --cache-s3-server-address value A host:port to the used S3-compatible server [$CACHE_S3_SERVER_ADDRESS] --cache-s3-access-key value S3 Access Key [$CACHE_S3_ACCESS_KEY] --cache-s3-secret-key value S3 Secret Key [$CACHE_S3_SECRET_KEY] --cache-s3-bucket-name value Name of the bucket where cache will be stored [$CACHE_S3_BUCKET_NAME] --cache-s3-bucket-location value Name of S3 region [$CACHE_S3_BUCKET_LOCATION] --cache-s3-insecure Use insecure mode (without https) [$CACHE_S3_INSECURE] --cache-gcs-access-id value ID of GCP Service Account used to access the storage [$CACHE_GCS_ACCESS_ID] --cache-gcs-private-key value Private key used to sign GCS requests [$CACHE_GCS_PRIVATE_KEY] --cache-gcs-credentials-file value File with GCP credentials, containing AccessID and PrivateKey [$GOOGLE_APPLICATION_CREDENTIALS] --cache-gcs-bucket-name value Name of the bucket where cache will be stored [$CACHE_GCS_BUCKET_NAME] --machine-idle-nodes value Maximum idle machines (default: \u0026#34;0\u0026#34;) [$MACHINE_IDLE_COUNT] --machine-idle-time value Minimum time after node can be destroyed (default: \u0026#34;0\u0026#34;) [$MACHINE_IDLE_TIME] --machine-max-builds value Maximum number of builds processed by machine (default: \u0026#34;0\u0026#34;) [$MACHINE_MAX_BUILDS] --machine-machine-driver value The driver to use when creating machine [$MACHINE_DRIVER] --machine-machine-name value The template for machine name (needs to include %s) [$MACHINE_NAME] --machine-machine-options value Additional machine creation options [$MACHINE_OPTIONS] --machine-off-peak-periods value Time periods when the scheduler is in the OffPeak mode [$MACHINE_OFF_PEAK_PERIODS] --machine-off-peak-timezone value Timezone for the OffPeak periods (defaults to Local) [$MACHINE_OFF_PEAK_TIMEZONE] --machine-off-peak-idle-count value Maximum idle machines when the scheduler is in the OffPeak mode (default: \u0026#34;0\u0026#34;) [$MACHINE_OFF_PEAK_IDLE_COUNT] --machine-off-peak-idle-time value Minimum time after machine can be destroyed when the scheduler is in the OffPeak mode (default: \u0026#34;0\u0026#34;) [$MACHINE_OFF_PEAK_IDLE_TIME] --kubernetes-host value Optional Kubernetes master host URL (auto-discovery attempted if not specified) [$KUBERNETES_HOST] --kubernetes-cert-file value Optional Kubernetes master auth certificate [$KUBERNETES_CERT_FILE] --kubernetes-key-file value Optional Kubernetes master auth private key [$KUBERNETES_KEY_FILE] --kubernetes-ca-file value Optional Kubernetes master auth ca certificate [$KUBERNETES_CA_FILE] --kubernetes-bearer_token_overwrite_allowed Bool to authorize builds to specify their own bearer token for creation. [$KUBERNETES_BEARER_TOKEN_OVERWRITE_ALLOWED] --kubernetes-bearer_token value Optional Kubernetes service account token used to start build pods. [$KUBERNETES_BEARER_TOKEN] --kubernetes-image value Default docker image to use for builds when none is specified [$KUBERNETES_IMAGE] --kubernetes-namespace value Namespace to run Kubernetes jobs in [$KUBERNETES_NAMESPACE] --kubernetes-namespace_overwrite_allowed value Regex to validate \u0026#39;KUBERNETES_NAMESPACE_OVERWRITE\u0026#39; value [$KUBERNETES_NAMESPACE_OVERWRITE_ALLOWED] --kubernetes-privileged Run all containers with the privileged flag enabled [$KUBERNETES_PRIVILEGED] --kubernetes-cpu-limit value The CPU allocation given to build containers [$KUBERNETES_CPU_LIMIT] --kubernetes-memory-limit value The amount of memory allocated to build containers [$KUBERNETES_MEMORY_LIMIT] --kubernetes-service-cpu-limit value The CPU allocation given to build service containers [$KUBERNETES_SERVICE_CPU_LIMIT] --kubernetes-service-memory-limit value The amount of memory allocated to build service containers [$KUBERNETES_SERVICE_MEMORY_LIMIT] --kubernetes-helper-cpu-limit value The CPU allocation given to build helper containers [$KUBERNETES_HELPER_CPU_LIMIT] --kubernetes-helper-memory-limit value The amount of memory allocated to build helper containers [$KUBERNETES_HELPER_MEMORY_LIMIT] --kubernetes-cpu-request value The CPU allocation requested for build containers [$KUBERNETES_CPU_REQUEST] --kubernetes-memory-request value The amount of memory requested from build containers [$KUBERNETES_MEMORY_REQUEST] --kubernetes-service-cpu-request value The CPU allocation requested for build service containers [$KUBERNETES_SERVICE_CPU_REQUEST] --kubernetes-service-memory-request value The amount of memory requested for build service containers [$KUBERNETES_SERVICE_MEMORY_REQUEST] --kubernetes-helper-cpu-request value The CPU allocation requested for build helper containers [$KUBERNETES_HELPER_CPU_REQUEST] --kubernetes-helper-memory-request value The amount of memory requested for build helper containers [$KUBERNETES_HELPER_MEMORY_REQUEST] --kubernetes-pull-policy value Policy for if/when to pull a container image (never, if-not-present, always). The cluster default will be used if not set [$KUBERNETES_PULL_POLICY] --kubernetes-node-selector value A toml table/json object of key=value. Value is expected to be a string. When set this will create pods on k8s nodes that match all the key=value pairs. (default: \u0026#34;{}\u0026#34;) [$KUBERNETES_NODE_SELECTOR] --kubernetes-node-tolerations value A toml table/json object of key=value:effect. Value and effect are expected to be strings. When set, pods will tolerate the given taints. Only one toleration is supported through environment variable configuration. (default: \u0026#34;{}\u0026#34;) [$KUBERNETES_NODE_TOLERATIONS] --kubernetes-image-pull-secrets value A list of image pull secrets that are used for pulling docker image [$KUBERNETES_IMAGE_PULL_SECRETS] --kubernetes-helper-image value [ADVANCED] Override the default helper image used to clone repos and upload artifacts [$KUBERNETES_HELPER_IMAGE] --kubernetes-terminationGracePeriodSeconds value Duration after the processes running in the pod are sent a termination signal and the time when the processes are forcibly halted with a kill signal. (default: \u0026#34;0\u0026#34;) [$KUBERNETES_TERMINATIONGRACEPERIODSECONDS] --kubernetes-poll-interval value How frequently, in seconds, the runner will poll the Kubernetes pod it has just created to check its status (default: \u0026#34;0\u0026#34;) [$KUBERNETES_POLL_INTERVAL] --kubernetes-poll-timeout value The total amount of time, in seconds, that needs to pass before the runner will timeout attempting to connect to the pod it has just created (useful for queueing more builds that the cluster can handle at a time) (default: \u0026#34;0\u0026#34;) [$KUBERNETES_POLL_TIMEOUT] --kubernetes-pod-labels value A toml table/json object of key-value. Value is expected to be a string. When set, this will create pods with the given pod labels. Environment variables will be substituted for values here. (default: \u0026#34;{}\u0026#34;) --kubernetes-service-account value Executor pods will use this Service Account to talk to kubernetes API [$KUBERNETES_SERVICE_ACCOUNT] --kubernetes-service_account_overwrite_allowed value Regex to validate \u0026#39;KUBERNETES_SERVICE_ACCOUNT\u0026#39; value [$KUBERNETES_SERVICE_ACCOUNT_OVERWRITE_ALLOWED] --kubernetes-pod-annotations value A toml table/json object of key-value. Value is expected to be a string. When set, this will create pods with the given annotations. Can be overwritten in build with KUBERNETES_POD_ANNOTATION_* variables (default: \u0026#34;{}\u0026#34;) --kubernetes-pod_annotations_overwrite_allowed value Regex to validate \u0026#39;KUBERNETES_POD_ANNOTATIONS_*\u0026#39; values [$KUBERNETES_POD_ANNOTATIONS_OVERWRITE_ALLOWED] --kubernetes-pod-security-context-fs-group value A special supplemental group that applies to all containers in a pod [$KUBERNETES_POD_SECURITY_CONTEXT_FS_GROUP] --kubernetes-pod-security-context-run-as-group value The GID to run the entrypoint of the container process [$KUBERNETES_POD_SECURITY_CONTEXT_RUN_AS_GROUP] --kubernetes-pod-security-context-run-as-non-root value Indicates that the container must run as a non-root user [$KUBERNETES_POD_SECURITY_CONTEXT_RUN_AS_NON_ROOT] --kubernetes-pod-security-context-run-as-user value The UID to run the entrypoint of the container process [$KUBERNETES_POD_SECURITY_CONTEXT_RUN_AS_USER] --kubernetes-pod-security-context-supplemental-groups value A list of groups applied to the first process run in each container, in addition to the container\u0026#39;s primary GID --kubernetes-services value Add service that is started with container --custom-config-exec value Executable that allows to inject configuration values to the executor [$CUSTOM_CONFIG_EXEC] --custom-config-args value Arguments for the config executable --custom-config-exec-timeout value Timeout for the config executable (in seconds) [$CUSTOM_CONFIG_EXEC_TIMEOUT] --custom-prepare-exec value Executable that prepares executor [$CUSTOM_PREPARE_EXEC] --custom-prepare-args value Arguments for the prepare executable --custom-prepare-exec-timeout value Timeout for the prepare executable (in seconds) [$CUSTOM_PREPARE_EXEC_TIMEOUT] --custom-run-exec value Executable that runs the job script in executor [$CUSTOM_RUN_EXEC] --custom-run-args value Arguments for the run executable --custom-cleanup-exec value Executable that cleanups after executor run [$CUSTOM_CLEANUP_EXEC] --custom-cleanup-args value Arguments for the cleanup executable --custom-cleanup-exec-timeout value Timeout for the cleanup executable (in seconds) [$CUSTOM_CLEANUP_EXEC_TIMEOUT] --custom-graceful-kill-timeout value Graceful timeout for scripts execution after SIGTERM is sent to the process (in seconds). This limits the time given for scripts to perform the cleanup before exiting [$CUSTOM_GRACEFUL_KILL_TIMEOUT] --custom-force-kill-timeout value Force timeout for scripts execution (in seconds). Counted from the force kill call; if process will be not terminated, Runner will abandon process termination and log an error [$CUSTOM_FORCE_KILL_TIMEOUT] Docker runneræ‰§è¡Œå™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ZeyangdeMacBook-Pro:~ zeyang$ gitlab-runner register Runtime platform arch=amd64 os=darwin pid=92353 revision=ac8e767a version=12.6.0 WARNING: Running in user-mode. WARNING: Use sudo for system-mode: WARNING: $ sudo gitlab-runner... Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/): http://gitlab.devops.com/ Please enter the gitlab-ci token for this runner: RjAoLah8Vp7JCGyNzZwf Please enter the gitlab-ci description for this runner: [ZeyangdeMacBook-Pro.local]: test Please enter the gitlab-ci tags for this runner (comma separated): docker Registering runner... succeeded runner=RjAoLah8 Please enter the executor: virtualbox, docker-ssh, parallels, shell, ssh, kubernetes, custom, docker, docker+machine, docker-ssh+machine: docker Please enter the default Docker image (e.g. ruby:2.6): maven:3.6.3-jdk-8 Runner registered successfully. Feel free to start it, but if it\u0026#39;s running already the config should be automatically reloaded! 4ã€GitLab Runnerå‘½ä»¤ GitLab RunneråŒ…å«ä¸€ç»„å‘½ä»¤ï¼Œå¯ç”¨äºæ³¨å†Œï¼Œç®¡ç†å’Œè¿è¡Œæ„å»ºã€‚\nå¯åŠ¨å‘½ä»¤ 1 2 3 4 gitlab-runner --debug \u0026lt;command\u0026gt; #è°ƒè¯•æ¨¡å¼æ’æŸ¥é”™è¯¯ç‰¹åˆ«æœ‰ç”¨ã€‚ gitlab-runner \u0026lt;command\u0026gt; --help #è·å–å¸®åŠ©ä¿¡æ¯ gitlab-runner run #æ™®é€šç”¨æˆ·æ¨¡å¼ é…ç½®æ–‡ä»¶ä½ç½® ~/.gitlab-runner/config.toml sudo gitlab-runner run # è¶…çº§ç”¨æˆ·æ¨¡å¼ é…ç½®æ–‡ä»¶ä½ç½®/etc/gitlab-runner/config.toml æ³¨å†Œå‘½ä»¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 gitlab-runner register #é»˜è®¤äº¤äº’æ¨¡å¼ä¸‹ä½¿ç”¨ï¼Œéäº¤äº’æ¨¡å¼æ·»åŠ  --non-interactive gitlab-runner list #æ­¤å‘½ä»¤åˆ—å‡ºäº†ä¿å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰è¿è¡Œç¨‹åº gitlab-runner verify #æ­¤å‘½ä»¤æ£€æŸ¥æ³¨å†Œçš„runneræ˜¯å¦å¯ä»¥è¿æ¥ï¼Œä½†ä¸éªŒè¯GitLabæœåŠ¡æ˜¯å¦æ­£åœ¨ä½¿ç”¨runnerã€‚ --delete åˆ é™¤ gitlab-runner unregister #è¯¥å‘½ä»¤ä½¿ç”¨GitLabå–æ¶ˆå·²æ³¨å†Œçš„runnerã€‚ #ä½¿ç”¨ä»¤ç‰Œæ³¨é”€ gitlab-runner unregister --url http://gitlab.example.com/ --token t0k3n #ä½¿ç”¨åç§°æ³¨é”€ï¼ˆåŒååˆ é™¤ç¬¬ä¸€ä¸ªï¼‰ gitlab-runner unregister --name test-runner #æ³¨é”€æ‰€æœ‰ gitlab-runner unregister --all-runners æœåŠ¡ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner # --useræŒ‡å®šå°†ç”¨äºæ‰§è¡Œæ„å»ºçš„ç”¨æˆ· #`--working-directory æŒ‡å®šå°†ä½¿ç”¨**Shell** executor è¿è¡Œæ„å»ºæ—¶æ‰€æœ‰æ•°æ®å°†å­˜å‚¨åœ¨å…¶ä¸­çš„æ ¹ç›®å½• gitlab-runner uninstall #è¯¥å‘½ä»¤åœæ­¢è¿è¡Œå¹¶ä»æœåŠ¡ä¸­å¸è½½GitLab Runnerã€‚ gitlab-runner start #è¯¥å‘½ä»¤å¯åŠ¨GitLab RunneræœåŠ¡ã€‚ gitlab-runner stop #è¯¥å‘½ä»¤åœæ­¢GitLab RunneræœåŠ¡ã€‚ gitlab-runner restart #è¯¥å‘½ä»¤å°†åœæ­¢ï¼Œç„¶åå¯åŠ¨GitLab RunneræœåŠ¡ã€‚ gitlab-runner status #æ­¤å‘½ä»¤æ˜¾ç¤ºGitLab RunneræœåŠ¡çš„çŠ¶æ€ã€‚å½“æœåŠ¡æ­£åœ¨è¿è¡Œæ—¶ï¼Œé€€å‡ºä»£ç ä¸ºé›¶ï¼›è€Œå½“æœåŠ¡æœªè¿è¡Œæ—¶ï¼Œé€€å‡ºä»£ç ä¸ºéé›¶ã€‚ 5ã€è¿è¡Œæµæ°´çº¿ä»»åŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 stages: - build - deploy build: stage: build tags: - build only: - master script: - echo \u0026#34;mvn clean \u0026#34; - echo \u0026#34;mvn install\u0026#34; deploy: stage: deploy tags: - deploy only: - master script: - echo \u0026#34;hello deploy\u0026#34; ","date":"2022-10-31T10:18:30Z","image":"https://www.ownit.top/title_pic/17.jpg","permalink":"https://www.ownit.top/p/202210311018/","title":"GitLabé›†æˆgitlab-runner"},{"content":"Prometheusç›‘æ§Linuxä¸»æœº Prometheus node-exporter ç›‘æ§LinuxæœåŠ¡å™¨\nnode-export ä¸»è¦ç”¨æ¥åšLinuxæœåŠ¡å™¨ç›‘æ§ï¼Œæ¯”å¦‚æœåŠ¡å™¨çš„è¿›ç¨‹æ•°ã€æ¶ˆè€—äº†å¤šå°‘ CPUã€å†…å­˜ï¼Œç£ç›˜ç©ºé—´ï¼Œiopsï¼Œtcpè¿æ¥æ•°ç­‰èµ„æºã€‚\nNode Exporter æ˜¯ç”¨äºæš´éœ² *NIX ä¸»æœºæŒ‡æ ‡çš„ Exporterï¼Œæ¯”å¦‚é‡‡é›† CPUã€å†…å­˜ã€ç£ç›˜ç­‰ä¿¡æ¯ã€‚é‡‡ç”¨ Go ç¼–å†™ï¼Œä¸å­˜åœ¨ä»»ä½•ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œæ‰€ä»¥åªéœ€è¦ä¸‹è½½è§£å‹å³å¯è¿è¡Œã€‚\nExporteræ˜¯Prometheusçš„ä¸€ç±»æ•°æ®é‡‡é›†ç»„ä»¶çš„æ€»ç§°ã€‚å®ƒè´Ÿè´£ä»ç›®æ ‡å¤„æœé›†æ•°æ®ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸ºPrometheusæ”¯æŒçš„æ ¼å¼ã€‚ä¸ä¼ ç»Ÿçš„æ•°æ®é‡‡é›†ç»„ä»¶ä¸åŒçš„æ˜¯ï¼Œå®ƒå¹¶ä¸å‘ä¸­å¤®æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè€Œæ˜¯ç­‰å¾…ä¸­å¤®æœåŠ¡å™¨ä¸»åŠ¨å‰æ¥æŠ“å–ã€‚\nnode-exporterç”¨äºé‡‡é›†æœåŠ¡å™¨å±‚é¢çš„è¿è¡ŒæŒ‡æ ‡ï¼ŒåŒ…æ‹¬æœºå™¨çš„loadavgã€filesystemã€meminfoç­‰åŸºç¡€ç›‘æ§ï¼Œç±»ä¼¼äºä¼ ç»Ÿä¸»æœºç›‘æ§ç»´åº¦çš„zabbix-agent\nnode_exporterï¼šç”¨äºç›‘æ§Linuxç³»ç»Ÿçš„æŒ‡æ ‡é‡‡é›†å™¨ã€‚\nå¸¸ç”¨æŒ‡æ ‡ï¼š\nâ€¢CPU\nâ€¢ å†…å­˜\nâ€¢ ç¡¬ç›˜\nâ€¢ ç½‘ç»œæµé‡\nâ€¢ æ–‡ä»¶æè¿°ç¬¦\nâ€¢ ç³»ç»Ÿè´Ÿè½½\nâ€¢ ç³»ç»ŸæœåŠ¡\næ•°æ®æ¥å£ï¼šhttp://IP:9100/metrics\nä½¿ç”¨æ–‡æ¡£ï¼šhttps://prometheus.io/docs/guides/node-exporter/\nGitHubï¼šGitHub - prometheus/node_exporter: Exporter for machine metrics\nä¸€ã€node-exporter ä½¿ç”¨ â€\n1.1 ä¸‹è½½ node-exporter node-exporter ä¸‹è½½åœ°å€ï¼šhttps://prometheus.io/download/\nnode-expoeter\nnode-exporter å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ä¹Ÿå¯ä»¥æŒ‡å®šå‚æ•°å‘½ä»¤å¯åŠ¨\n1.2 é…ç½®node-exporter è¯¥ metrics æ¥å£æ•°æ®å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Prometheus ç›‘æ§æŒ‡æ ‡æ ¼å¼ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è¯¥ç«¯ç‚¹é…ç½®åˆ° Prometheus ä¸­å³å¯æŠ“å–è¯¥æŒ‡æ ‡æ•°æ®ã€‚ä¸ºäº†äº†è§£ node_exporter å¯é…ç½®çš„å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ./node_exporter \\-h æ¥æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 â˜¸ âœ ./node_exporter -h --web.listen-address=\u0026#34;:9100\u0026#34; # ç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯9100 --web.telemetry-path=\u0026#34;/metrics\u0026#34; # metricsçš„è·¯å¾„ï¼Œé»˜è®¤ä¸º/metrics --web.disable-exporter-metrics # æ˜¯å¦ç¦ç”¨goã€promeé»˜è®¤çš„metrics --web.max-requests=40 # æœ€å¤§å¹¶è¡Œè¯·æ±‚æ•°ï¼Œé»˜è®¤40ï¼Œè®¾ç½®ä¸º0æ—¶ä¸é™åˆ¶ --log.level=\u0026#34;info\u0026#34; # æ—¥å¿—ç­‰çº§: [debug, info, warn, error, fatal] --log.format=logfmt # ç½®æ—¥å¿—æ‰“å°targetå’Œæ ¼å¼: [logfmt, json] --version # ç‰ˆæœ¬å· --collector.{metric-name} # å„ä¸ªmetricå¯¹åº”çš„å‚æ•° ä»¥ä½¿ç”¨ --collectors.enabledå‚æ•°æŒ‡å®šnode_exporteræ”¶é›†çš„åŠŸèƒ½æ¨¡å—,æˆ–è€…ç”¨--no-collectoræŒ‡å®šä¸éœ€è¦çš„æ¨¡å—ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®ã€‚ æœ€é‡è¦çš„å‚æ•°å°±æ˜¯ --collector.ï¼Œé€šè¿‡è¯¥å‚æ•°å¯ä»¥å¯ç”¨æˆ‘ä»¬æ”¶é›†çš„åŠŸèƒ½æ¨¡å—ï¼Œnode_exporter ä¼šé»˜è®¤é‡‡é›†ä¸€äº›æ¨¡å—ï¼Œè¦ç¦ç”¨è¿™äº›é»˜è®¤å¯ç”¨çš„æ”¶é›†å™¨å¯ä»¥é€šè¿‡ --no-collector. æ ‡å¿—æ¥ç¦ç”¨ï¼Œå¦‚æœåªå¯ç”¨æŸäº›ç‰¹å®šçš„æ”¶é›†å™¨ï¼ŒåŸºäºå…ˆä½¿ç”¨ --collector.disable-defaults æ ‡å¿—ç¦ç”¨æ‰€æœ‰é»˜è®¤çš„ï¼Œç„¶ååœ¨é€šè¿‡æŒ‡å®šå…·ä½“çš„æ”¶é›†å™¨ --collector. æ¥è¿›è¡Œå¯ç”¨ã€‚ä¸‹å›¾åˆ—å‡ºäº†é»˜è®¤å¯ç”¨çš„æ”¶é›†å™¨ï¼š\nç›¸å…³æ–‡æ¡£åœ°å€\nâ€\n1.3 ç¼–å†™å¯åŠ¨è„šæœ¬ åˆ›å»ºprometheusç»„å’Œç”¨æˆ·\n1 2 sudo groupadd -r prometheus sudo useradd -r -g prometheus -s /sbin/nologin -M -c \u0026#34;prometheus Daemons\u0026#34; prometheus 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 vim /usr/lib/systemd/system/node_exporter.service [Unit] Description=node_exporter After=network.target #å¯ä»¥åˆ›å»ºç›¸åº”çš„ç”¨æˆ·å’Œç»„ å¯åŠ¨ User=prometheus Group=prometheus [Service] ExecStart=/usr/local/node_exporter/node_exporter\\ --web.listen-address=:9100\\ --collector.systemd\\ --collector.systemd.unit-whitelist=(sshd|nginx).service\\ --collector.processes\\ --collector.tcpstat [Install] WantedBy=multi-user.target 1.4 å¯åŠ¨ node_exporter 1 2 3 systemctl daemon-reload systemctl start process_exporter systemctl enable process_exporter éªŒè¯ç›‘æ§æ•°æ®\n1 curl http://localhost:9100/metrics â€‹\näºŒã€prometheus é…ç½® æ·»åŠ æˆ–ä¿®æ”¹é…ç½®\n1 2 3 4 5 6 7 8 9 10 - job_name: \u0026#39;dev_prometheus\u0026#39; scrape_interval: 10s honor_labels: true metrics_path: \u0026#39;/metrics\u0026#39; static_configs: - targets: [\u0026#39;127.0.0.1:9090\u0026#39;,\u0026#39;127.0.0.1:9100\u0026#39;] labels: {cluster: \u0026#39;dev\u0026#39;,type: \u0026#39;basic\u0026#39;,env: \u0026#39;dev\u0026#39;,job: \u0026#39;prometheus\u0026#39;,export: \u0026#39;node-exporter\u0026#39;} - targets: [\u0026#39;127.0.0.1:9256\u0026#39;] labels: {cluster: \u0026#39;dev\u0026#39;,type: \u0026#39;process\u0026#39;,env: \u0026#39;dev\u0026#39;,job: \u0026#39;prometheus\u0026#39;,export: \u0026#39;process_exporter\u0026#39;} é‡å¯ prometheus æœåŠ¡\n1 curl -X POST http://127.0.0.1:9090/-/reload ä¸‰ã€grafana å‡ºå›¾ process-exporter å¯¹åº”çš„ dashboard ä¸ºï¼šhttps://grafana.com/grafana/dashboards/16098-1-node-exporter-for-prometheus-dashboard-cn-0417-job/\næ•ˆæœå¦‚ä¸‹\nå››ã€å¸¸ç”¨ç›‘æ§è§„åˆ™ Prometheus å‘Šè­¦è§„åˆ™\nå‚è€ƒç½‘ç«™ï¼šhttps://awesome-prometheus-alerts.grep.to/rules\nè¿™ä¸ªç½‘ç«™ä¸Šæœ‰å¥½å¤šå¸¸ç”¨è½¯ä»¶çš„å‘Šè­¦è§„åˆ™ï¼Œä½†æ˜¯æœ‰äº›å¹¶ä¸ä¸€å®šå®ç”¨ï¼Œæœ‰äº›ä½¿ç”¨èµ·æ¥ä¼šæœ‰é”™è¯¯ï¼Œè¿™é‡Œå°±æŠŠè¿™äº›éƒ½ç»™æ’é™¤æ‰ï¼Œåªä¿ç•™èƒ½ä½¿ç”¨çš„\nç»“åˆæ–‡ç« ï¼šhttps://www.cnblogs.com/sanduzxcvbnm/p/13589792.html æ¥ä½¿ç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 groups: - name: ä¸»æœºçŠ¶æ€-ç›‘æ§å‘Šè­¦ rules: - alert: ä¸»æœºçŠ¶æ€ expr: up == 0 for: 1m labels: status: éå¸¸ä¸¥é‡ annotations: summary: \u0026#34;{{$labels.instance}}:æœåŠ¡å™¨å®•æœº\u0026#34; description: \u0026#34;{{$labels.instance}}:æœåŠ¡å™¨å»¶æ—¶è¶…è¿‡5åˆ†é’Ÿ\u0026#34; - alert: CPUä½¿ç”¨æƒ…å†µ expr: 100-(avg(irate(node_cpu_seconds_total{mode=\u0026#34;idle\u0026#34;}[5m])) by(instance)* 100) \u0026gt; 60 for: 1m labels: status: ä¸€èˆ¬å‘Šè­¦ annotations: summary: \u0026#34;{{$labels.mountpoint}} CPUä½¿ç”¨ç‡è¿‡é«˜ï¼\u0026#34; description: \u0026#34;{{$labels.mountpoint }} CPUä½¿ç”¨å¤§äº60%(ç›®å‰ä½¿ç”¨:{{$value}}%)\u0026#34; - alert: å†…å­˜ä½¿ç”¨ expr: 100 -(node_memory_MemTotal_bytes -node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes ) / node_memory_MemTotal_bytes * 100\u0026gt; 80 for: 1m labels: status: ä¸¥é‡å‘Šè­¦ annotations: summary: \u0026#34;{{$labels.mountpoint}} å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼\u0026#34; description: \u0026#34;{{$labels.mountpoint }} å†…å­˜ä½¿ç”¨å¤§äº80%(ç›®å‰ä½¿ç”¨:{{$value}}%)\u0026#34; - alert: IOæ€§èƒ½ expr: 100-(avg(irate(node_disk_io_time_seconds_total[1m])) by(instance)* 100) \u0026lt; 60 for: 1m labels: status: ä¸¥é‡å‘Šè­¦ annotations: summary: \u0026#34;{{$labels.mountpoint}} æµå…¥ç£ç›˜IOä½¿ç”¨ç‡è¿‡é«˜ï¼\u0026#34; description: \u0026#34;{{$labels.mountpoint }} æµå…¥ç£ç›˜IOå¤§äº60%(ç›®å‰ä½¿ç”¨:{{$value}})\u0026#34; - alert: ç½‘ç»œ expr: ((sum(rate (node_network_receive_bytes_total{device!~\u0026#39;tap.*|veth.*|br.*|docker.*|virbr*|lo*\u0026#39;}[5m])) by (instance)) / 100) \u0026gt; 102400 for: 1m labels: status: ä¸¥é‡å‘Šè­¦ annotations: summary: \u0026#34;{{$labels.mountpoint}} æµå…¥ç½‘ç»œå¸¦å®½è¿‡é«˜ï¼\u0026#34; description: \u0026#34;{{$labels.mountpoint }}æµå…¥ç½‘ç»œå¸¦å®½æŒç»­2åˆ†é’Ÿé«˜äº100M. RXå¸¦å®½ä½¿ç”¨ç‡{{$value}}\u0026#34; - alert: ç½‘ç»œ expr: ((sum(rate (node_network_transmit_bytes_total{device!~\u0026#39;tap.*|veth.*|br.*|docker.*|virbr*|lo*\u0026#39;}[5m])) by (instance)) / 100) \u0026gt; 102400 for: 1m labels: status: ä¸¥é‡å‘Šè­¦ annotations: summary: \u0026#34;{{$labels.mountpoint}} æµå‡ºç½‘ç»œå¸¦å®½è¿‡é«˜ï¼\u0026#34; description: \u0026#34;{{$labels.mountpoint }}æµå‡ºç½‘ç»œå¸¦å®½æŒç»­2åˆ†é’Ÿé«˜äº100M. RXå¸¦å®½ä½¿ç”¨ç‡{{$value}}\u0026#34; - alert: TCPä¼šè¯ expr: node_netstat_Tcp_CurrEstab \u0026gt; 1000 for: 1m labels: status: ä¸¥é‡å‘Šè­¦ annotations: summary: \u0026#34;{{$labels.mountpoint}} TCP_ESTABLISHEDè¿‡é«˜ï¼\u0026#34; description: \u0026#34;{{$labels.mountpoint }} TCP_ESTABLISHEDå¤§äº1000%(ç›®å‰ä½¿ç”¨:{{$value}}%)\u0026#34; - alert: ç£ç›˜å®¹é‡ expr: 100-(node_filesystem_free_bytes{fstype=~\u0026#34;ext4|xfs\u0026#34;}/node_filesystem_size_bytes {fstype=~\u0026#34;ext4|xfs\u0026#34;}*100) \u0026gt; 80 for: 1m labels: status: ä¸¥é‡å‘Šè­¦ annotations: summary: \u0026#34;{{$labels.mountpoint}} ç£ç›˜åˆ†åŒºä½¿ç”¨ç‡è¿‡é«˜ï¼\u0026#34; description: \u0026#34;{{$labels.mountpoint }} ç£ç›˜åˆ†åŒºä½¿ç”¨å¤§äº80%(ç›®å‰ä½¿ç”¨:{{$value}}%)\u0026#34; äº”ã€Ansible æ‰¹é‡æ·»åŠ éƒ¨ç½² è¿™é‡Œé‡‡ç”¨ Consul æ³¨å†Œå‘ç°æ–¹å¼ï¼Œç›¸å…³ç±»å®¹å¯ä»¥æŸ¥è¯¢ç½‘ä¸Š\n5.1Consul æ³¨å†Œè„šæœ¬ 1 2 3 4 5 6 7 #!/bin/bash service_name=$1 instance_id=$2 ip=$3 port=$4 curl -X PUT -d \u0026#39;{\u0026#34;id\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$instance_id\u0026#34;\u0026#39;\u0026#34;,\u0026#34;name\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$service_name\u0026#34;\u0026#39;\u0026#34;,\u0026#34;address\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$ip\u0026#34;\u0026#39;\u0026#34;,\u0026#34;port\u0026#34;: \u0026#39;\u0026#34;$port\u0026#34;\u0026#39;,\u0026#34;tags\u0026#34;: [\u0026#34;\u0026#39;\u0026#34;$service_name\u0026#34;\u0026#39;\u0026#34;],\u0026#34;checks\u0026#34;: [{\u0026#34;http\u0026#34;: \u0026#34;http://\u0026#39;\u0026#34;$ip\u0026#34;\u0026#39;:\u0026#39;\u0026#34;$port\u0026#34;\u0026#39;\u0026#34;,\u0026#34;interval\u0026#34;: \u0026#34;5s\u0026#34;}]}\u0026#39; http://10.1.8.202:8500/v1/agent/service/register 5.2 Ansible å‰§æœ¬è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 [root@openvpn node]# cat playbook.yml - hosts: Sm remote_user: root gather_facts: no tasks: - name: æ¨é€é‡‡é›†å™¨å®‰è£…åŒ… unarchive: src=node_exporter-1.2.2.linux-amd64.tar.gz dest=/usr/local/ - name: é‡å‘½å shell: | cd /usr/local/ if [ ! -d node_exporter ];then mv node_exporter-1.2.2.linux-amd64 node_exporter fi - name: æŸ¥è¯¢ä¸»æœºåç§° shell: echo \u0026#34;`hostname`\u0026#34; register: name_host - name: æ¨é€systemæ–‡ä»¶ copy: src=node_exporter.service dest=/usr/lib/systemd/system - name: å¯åŠ¨æœåŠ¡ systemd: name=node_exporter state=started enabled=yes - name: æ¨é€æ³¨å†Œè„šæœ¬ copy: src=consul-register.sh dest=/usr/local/node_exporter - name: æ³¨å†Œå½“å‰èŠ‚ç‚¹ shell: /bin/sh /usr/local/node_exporter/consul-register.sh {{ group_names[0] }} {{ name_host.stdout }} {{ inventory_hostname }} 9100 â€\nå…­ã€æŒ‡æ ‡è‡ªå®šä¹‰ç›‘æ§ 6.1 è‡ªå®šä¹‰ç›‘æ§ node_exporterçš„â€“collector.textfileæ˜¯ä¸€ä¸ªæ”¶é›†å™¨ï¼Œè¿™ä¸ªæ”¶é›†å™¨å¯ä»¥å…è®¸æˆ‘ä»¬æš´éœ²è‡ªå®šä¹‰æŒ‡æ ‡ï¼Œæ¯”å¦‚æŸäº›pushgatewayåŠŸèƒ½ä¸­è‡ªå®šä¹‰çš„æŒ‡æ ‡ï¼Œå°±å¯ä»¥ä½¿ç”¨â€“collector.textfileåŠŸèƒ½æ¥å®ç°ï¼Œè€Œä¸”ï¼Œnode_exporterå®ç°èµ·æ¥æ›´åŠ ä¼˜é›…ã€‚ç”¨node_expoerter ï¼Œç›´æ¥åœ¨ç°åœ¨åŸºç¡€ä¸Šåštextfile collectorå³å¯ã€‚å¦‚æœæœ‰pushgatewayçš„è¯ï¼Œå¯æ˜¯ä½¿ç”¨pushgatewayçš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨textfilecollectorã€‚\nâ€\nnode_exporterçš„collector.textfile åŠŸèƒ½è‡ªå®šä¹‰ç›‘æ§ï¼Œcollector.textæ”¶é›†å™¨é€šè¿‡æ‰«ææŒ‡å®šç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œæå–æ‰€æœ‰æ ¼å¼ä¸ºPrometheusæŒ‡æ ‡çš„å­—ç¬¦ä¸²ï¼Œç„¶åæš´éœ²å®ƒä»¬ä»¥ä¾¿æŠ“å–\nå‚æ•°ï¼šâ€“collector.textfile.directory\n6.2 Textfile Collectorä½¿ç”¨ å› ä¸ºnode_exporterä¹‹å‰å·²ç»å®‰è£…è¿‡ï¼Œå¦‚æœnode_exporterå¯åŠ¨æ—¶æ²¡æœ‰æŒ‡å®šâ€“collector.textfile.directoryå‚æ•°ï¼Œéœ€è¦åœ¨å¯åŠ¨æ–‡ä»¶é‡Œé¢ï¼Œæ·»åŠ ä¸Šå‚æ•°ï¼Œå¹¶ç¡®è®¤æ–‡ä»¶æŒ‡çš„ç›®å½•å­˜åœ¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@openvpn disk]# cat node_exporter.service [Unit] Description=node_exporter After=network.target [Service] ExecStart=/usr/local/node_exporter/node_exporter\\ --web.listen-address=:9100\\ --collector.systemd\\ --collector.systemd.unit-whitelist=(sshd|nginx).service\\ --collector.processes\\ --collector.tcpstat\\ --collector.supervisord\\ --collector.textfile.directory=\u0026#34;/usr/local/node_exporter\u0026#34; #æŒ‡å®šä»¥çš„ç›‘æ§ç›®å½• [Install] WantedBy=multi-user.target 6.3 å¯åŠ¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #å¯åŠ¨ # systemd æ–¹å¼å¯åŠ¨ systemctl daemon-reload systemctl enable node_exporter systemctl start node_exporter systemctl status node_exporter # supervisoræ–¹å¼å¯åŠ¨ supervisorctl update supervisorctl status supervisorctl start node_exporter supervisorctl restart node_exporter â€‹ â€‹ #æ£€æŸ¥æ˜¯å¦å¯åŠ¨æˆåŠŸ ss -untlp |grep 9100 ps -ef |grep node_exporter 6.4 å†™å…¥è‡ªå®šä¹‰æŒ‡æ ‡ å†™å…¥è‡ªå®šä¹‰æŒ‡æ ‡ï¼Œè¿™ä¸ªéœ€è¦è‡ªå·±å¼€å‘è„šæœ¬ï¼Œå°†æ•°æ®å†™å…¥å¯¹åº”çš„æ–‡ä»¶å³å¯ã€‚ä¹Ÿå¯ä»¥åœ¨githubï¼ˆç‚¹æˆ‘ç‚¹æˆ‘â€¦ï¼‰ä¸­çœ‹å®ä¾‹æ–‡ä»¶ï¼Œç†Ÿæ‚‰pythonæˆ–è€…shelléƒ½å¯ä»¥å†™ã€‚\nGitHub ä¸­æœ‰æä¾›æ¨¡æ¿çš„ï¼Œæ¯”å¦‚ directory-size.sh\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # cat directory-size.sh #!/bin/sh # # Expose directory usage metrics, passed as an argument. # # Usage: add this to crontab: # # */5 * * * * prometheus directory-size.sh /var/lib/prometheus | sponge /var/lib/node_exporter/directory_size.prom # # sed pattern taken from https://www.robustperception.io/monitoring-directory-sizes-with-the-textfile-collector/ # # Author: Antoine BeauprÃ© \u0026lt;anarcat@debian.org\u0026gt; echo \u0026#34;# HELP node_directory_size_bytes Disk space used by some directories\u0026#34; echo \u0026#34;# TYPE node_directory_size_bytes gauge\u0026#34; du --block-size=1 --summarize \u0026#34;$@\u0026#34; \\ | sed -ne \u0026#39;s/\\\\/\\\\\\\\/;s/\u0026#34;/\\\\\u0026#34;/g;s/^\\([0-9]\\+\\)\\t\\(.*\\)$/node_directory_size_bytes{directory=\u0026#34;\\2\u0026#34;} \\1/p\u0026#39; æ­¤å¤„æ˜¯æˆ‘ç»™çš„ç®€å•shellè„šæœ¬è·å–æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 [root@openvpn disk]# cat disk_cheak.sh #!/bin/sh system=$(lsblk -fs |grep -w / |awk \u0026#39;{print $1}\u0026#39;) disk=$(lsblk -rfs|grep -E \u0026#39;xfs|f2fs|ntfs\u0026#39;| grep -v $system|awk \u0026#39;{print $5}\u0026#39; |awk -F \u0026#39;%\u0026#39; \u0026#39;{print $1}\u0026#39; |wc -l) theNum=$( df -h |grep /data/plot |wc -l) name=\u0026#34;check_disk_nums\u0026#34; pool_nums=$(tail -n 1 /root/hpool/log/miner.log.log | awk \u0026#39;{print $6}\u0026#39;|cut -d \u0026#39;=\u0026#39; -f 2|awk -F \u0026#39;[ \u0026#34;]\u0026#39; \u0026#39;{print $4,$NF}\u0026#39;|awk \u0026#39;{sub(/^[\\t ]*/,\u0026#34;\u0026#34;);print}\u0026#39;) CPU_sensors=$(sensors | grep \u0026#34;^Package id 0:\u0026#34; | sed \u0026#39;s/Package id 0://\u0026#39; | sed \u0026#39;s/^\\s*.+//\u0026#39; | awk \u0026#39;{print $1}\u0026#39; | sed \u0026#39;s/Â°C//\u0026#39;) echo \u0026#34;check_cpu_sensors $CPU_sensors\u0026#34; \u0026gt; /usr/local/node_exporter/check_cpu_sensors.prom echo \u0026#34;check_pool_nums $pool_nums\u0026#34; \u0026gt; /usr/local/node_exporter/check_pool_nums.prom if [ $disk != $theNum ]; then echo \u0026#34;$name 0\u0026#34; \u0026gt; /usr/local/node_exporter/check_disk_nums.prom else echo \u0026#34;$name $disk\u0026#34; \u0026gt; /usr/local/node_exporter/check_disk_nums.prom fi 6.5 é…ç½®å®šæ—¶ä»»åŠ¡å¯åŠ¨ 1 2 3 4 5 chmod a+x disk_cheak.sh crontab -l #Ansible: check_disk */5 * * * * /bin/bash /usr/local/node_exporter/disk_cheak.sh 6.6 ansibleæ‰¹é‡æ·»åŠ æ‰§è¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 [root@openvpn disk]# cat playbook.yml - hosts: all remote_user: root gather_facts: no tasks: - name: æ¨é€systemæ–‡ä»¶ copy: src=node_exporter.service dest=/usr/lib/systemd/system - name: å¼€æœºå¯åŠ¨æœåŠ¡ systemd: name=node_exporter state=restarted enabled=yes - name: æ¨é€ç£ç›˜è„šæœ¬ copy: src=disk_cheak.sh dest=/usr/local/node_exporter mode=u+x - name: è®¾ç½®å®šæ—¶ä»»åŠ¡ cron: name=\u0026#34;check_disk\u0026#34; minute=\u0026#34;*/5\u0026#34; job=\u0026#34;/bin/bash /usr/local/node_exporter/disk_cheak.sh\u0026#34; state=\u0026#34;present\u0026#34; - name: æ‰§è¡Œè„šæœ¬ shell: /bin/bash /usr/local/node_exporter/disk_cheak.sh æ‰§è¡Œå‘½ä»¤ ansible-playbook playbook.yml -i ./hosts1 -f 10 6.7 éªŒè¯æ•°æ® â€\n","date":"2022-09-22T12:06:49Z","image":"https://www.ownit.top/title_pic/50.jpg","permalink":"https://www.ownit.top/p/202209221206/","title":"Prometheusç›‘æ§Linuxä¸»æœºï¼ˆnode-exporterï¼‰"},{"content":"Prometheusç›‘æ§è¿›ç¨‹ process-exportä¸»è¦ç”¨æ¥åšè¿›ç¨‹ç›‘æ§ï¼Œæ¯”å¦‚æŸä¸ªæœåŠ¡çš„è¿›ç¨‹æ•°ã€æ¶ˆè€—äº†å¤šå°‘CPUã€å†…å­˜ç­‰èµ„æºã€‚\nä¸€ã€process-exporterä½¿ç”¨ â€\n1.1 ä¸‹è½½ process-exporter process-exporter GibHUBåœ°å€\nprocess-exporter ä¸‹è½½åœ°å€\nprocess-exporterå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ä¹Ÿå¯ä»¥æŒ‡å®šé…ç½®æ–‡ä»¶å¯åŠ¨\n1.2 é…ç½® process-exporter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 vim /usr/local/process-exporter/process_name.yaml #å­˜æ”¾è„šæœ¬çš„åœ°æ–¹ process_names: # - name: \u0026#34;{{.Comm}}\u0026#34; # cmdline: # - \u0026#39;.+\u0026#39; - name: \u0026#34;{{.Matches}}\u0026#34; cmdline: - \u0026#39;nginx\u0026#39; #å”¯ä¸€æ ‡è¯† - name: \u0026#34;{{.Matches}}\u0026#34; cmdline: - \u0026#39;/opt/atlassian/confluence/bin/tomcat-juli.jar\u0026#39; - name: \u0026#34;{{.Matches}}\u0026#34; cmdline: - \u0026#39;vsftpd\u0026#39; - name: \u0026#34;{{.Matches}}\u0026#34; cmdline: - \u0026#39;redis-server\u0026#39; ç¤ºä¾‹ï¼š\ncmdline: æ‰€é€‰è¿›ç¨‹çš„å”¯ä¸€æ ‡è¯†ï¼Œps -ef å¯ä»¥æŸ¥è¯¢åˆ°ã€‚å¦‚æœæ”¹è¿›ç¨‹ä¸å­˜åœ¨ï¼Œåˆ™ä¸ä¼šæœ‰è¯¥è¿›ç¨‹çš„æ•°æ®é‡‡é›†åˆ°ã€‚\nä¾‹å¦‚ï¼š\u0026gt; ps -ef | grep redis\nredis 4287 4127 0 Oct31 ? 00:58:12 redis-server *:6379\n{{.Comm}} groupname=â€redis-serverâ€ exeæˆ–è€…shæ–‡ä»¶åç§° {{.ExeBase}} groupname=â€redis-server *:6379â€ / {{.ExeFull}} groupname=â€/usr/bin/redis-server *:6379â€ psä¸­çš„è¿›ç¨‹å®Œæˆä¿¡æ¯ {{.Username}} groupname=â€redisâ€ ä½¿ç”¨è¿›ç¨‹æ‰€å±çš„ç”¨æˆ·è¿›è¡Œåˆ†ç»„ {{.Matches}} groupname=â€map[:redis]â€ è¡¨ç¤ºé…ç½®åˆ°å…³é”®å­—â€œredisâ€ 1.3 ç¼–å†™å¯åŠ¨è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 vim /usr/lib/systemd/system/process_exporter.service [Unit] Description=Prometheus exporter for processors metrics, written in Go with pluggable metric collectors. Documentation=https://github.com/ncabatoff/process-exporter After=network.target [Service] Type=simple User=root WorkingDirectory=/usr/local/process-exporter ExecStart=/usr/local/process-exporter/process-exporter -config.path=/usr/local/process-exporter/process-exporter.yaml Restart=on-failure [Install] WantedBy=multi-user.target 1.4 å¯åŠ¨ procexx-export 1 2 3 systemctl daemon-reload systemctl start process_exporter systemctl enable process_exporter éªŒè¯ç›‘æ§æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 curl http://localhost:9256/metrics #ç›¸å…³æµ‹è¯•çš„æ•°æ® # HELP http_response_size_bytes The HTTP response sizes in bytes. # TYPE http_response_size_bytes summary http_response_size_bytes{handler=\u0026#34;prometheus\u0026#34;,quantile=\u0026#34;0.5\u0026#34;} 2988 http_response_size_bytes{handler=\u0026#34;prometheus\u0026#34;,quantile=\u0026#34;0.9\u0026#34;} 2996 http_response_size_bytes{handler=\u0026#34;prometheus\u0026#34;,quantile=\u0026#34;0.99\u0026#34;} 3006 http_response_size_bytes_sum{handler=\u0026#34;prometheus\u0026#34;} 1.34205181e+08 http_response_size_bytes_count{handler=\u0026#34;prometheus\u0026#34;} 45188 # HELP namedprocess_namegroup_context_switches_total Context switches # TYPE namedprocess_namegroup_context_switches_total counter namedprocess_namegroup_context_switches_total{ctxswitchtype=\u0026#34;nonvoluntary\u0026#34;,groupname=\u0026#34;map[:bladebit]\u0026#34;} 7.7977455e+07 namedprocess_namegroup_context_switches_total{ctxswitchtype=\u0026#34;nonvoluntary\u0026#34;,groupname=\u0026#34;map[:pw_python.py]\u0026#34;} 2.02666e+06 namedprocess_namegroup_context_switches_total{ctxswitchtype=\u0026#34;voluntary\u0026#34;,groupname=\u0026#34;map[:bladebit]\u0026#34;} 3.335109e+06 namedprocess_namegroup_context_switches_total{ctxswitchtype=\u0026#34;voluntary\u0026#34;,groupname=\u0026#34;map[:pw_python.py]\u0026#34;} 8.22652233e+08 # HELP namedprocess_namegroup_cpu_system_seconds_total Cpu system usage in seconds # TYPE namedprocess_namegroup_cpu_system_seconds_total counter namedprocess_namegroup_cpu_system_seconds_total{groupname=\u0026#34;map[:bladebit]\u0026#34;} 94275.01000000017 namedprocess_namegroup_cpu_system_seconds_total{groupname=\u0026#34;map[:pw_python.py]\u0026#34;} 64818.93000000004 # HELP namedprocess_namegroup_cpu_user_seconds_total Cpu user usage in seconds # TYPE namedprocess_namegroup_cpu_user_seconds_total counter namedprocess_namegroup_cpu_user_seconds_total{groupname=\u0026#34;map[:bladebit]\u0026#34;} 2.42621264299998e+07 namedprocess_namegroup_cpu_user_seconds_total{groupname=\u0026#34;map[:pw_python.py]\u0026#34;} 85.29000000000613 # HELP namedprocess_namegroup_major_page_faults_total Major page faults # TYPE namedprocess_namegroup_major_page_faults_total counter namedprocess_namegroup_major_page_faults_total{groupname=\u0026#34;map[:bladebit]\u0026#34;} 18261 namedprocess_namegroup_major_page_faults_total{groupname=\u0026#34;map[:pw_python.py]\u0026#34;} 1236 # HELP namedprocess_namegroup_memory_bytes number of bytes of memory in use # TYPE namedprocess_namegroup_memory_bytes gauge namedprocess_namegroup_memory_bytes{groupname=\u0026#34;map[:bladebit]\u0026#34;,memtype=\u0026#34;resident\u0026#34;} 4.46810939392e+11 namedprocess_namegroup_memory_bytes{groupname=\u0026#34;map[:bladebit]\u0026#34;,memtype=\u0026#34;swapped\u0026#34;} 0 namedprocess_namegroup_memory_bytes{groupname=\u0026#34;map[:bladebit]\u0026#34;,memtype=\u0026#34;virtual\u0026#34;} 4.47847292928e+11 namedprocess_namegroup_memory_bytes{groupname=\u0026#34;map[:pw_python.py]\u0026#34;,memtype=\u0026#34;resident\u0026#34;} 1.2959744e+07 namedprocess_namegroup_memory_bytes{groupname=\u0026#34;map[:pw_python.py]\u0026#34;,memtype=\u0026#34;swapped\u0026#34;} 0 namedprocess_namegroup_memory_bytes{groupname=\u0026#34;map[:pw_python.py]\u0026#34;,memtype=\u0026#34;virtual\u0026#34;} 2.4733696e+08 â€\näºŒã€prometheus é…ç½® æ·»åŠ æˆ–ä¿®æ”¹é…ç½®\n1 2 3 4 5 6 7 8 9 10 - job_name: \u0026#39;dev_prometheus\u0026#39; scrape_interval: 10s honor_labels: true metrics_path: \u0026#39;/metrics\u0026#39; static_configs: - targets: [\u0026#39;127.0.0.1:9090\u0026#39;,\u0026#39;127.0.0.1:9100\u0026#39;] labels: {cluster: \u0026#39;dev\u0026#39;,type: \u0026#39;basic\u0026#39;,env: \u0026#39;dev\u0026#39;,job: \u0026#39;prometheus\u0026#39;,export: \u0026#39;prometheus\u0026#39;} - targets: [\u0026#39;127.0.0.1:9256\u0026#39;] labels: {cluster: \u0026#39;dev\u0026#39;,type: \u0026#39;process\u0026#39;,env: \u0026#39;dev\u0026#39;,job: \u0026#39;prometheus\u0026#39;,export: \u0026#39;process_exporter\u0026#39;} é‡å¯prometheusæœåŠ¡\n1 curl -X POST http://127.0.0.1:9090/-/reload ä¸‰ã€grafanaå‡ºå›¾ process-exporterå¯¹åº”çš„dashboardä¸ºï¼šhttps://grafana.com/grafana/dashboards/249\næ•ˆæœå¦‚ä¸‹\nå››ã€å¸¸ç”¨ç›‘æ§è§„åˆ™ è¿›ç¨‹æ•° 1 2 3 4 5 6 7 alert: è¿›ç¨‹å‘Šè­¦ expr: sum(namedprocess_namegroup_states) by (cluster,job,instance) \u0026gt; 500 for: 20s labels: severity: warning annotations: value: æœåŠ¡å™¨å½“å‰å·²äº§ç”Ÿ {{ $value }} ä¸ªè¿›ç¨‹ï¼Œå¤§äºå‘Šè­¦é˜ˆå€¼ åƒµå°¸è¿›ç¨‹æ•° 1 2 3 4 5 6 7 alert: è¿›ç¨‹å‘Šè­¦ expr: sum by(cluster, job, instance, groupname) (namedprocess_namegroup_states{state=\u0026#34;Zombie\u0026#34;}) \u0026gt; 0 for: 1m labels: severity: warning annotations: value: å½“å‰äº§ç”Ÿ {{ $value }} ä¸ªåƒµå°¸è¿›ç¨‹ è¿›ç¨‹é‡å¯ 1 2 3 4 5 6 7 8 alert: è¿›ç¨‹é‡å¯å‘Šè­¦ expr: ceil(time() - max by(cluster, job, instance, groupname) (namedprocess_namegroup_oldest_start_time_seconds)) \u0026lt; 60 for: 25s labels: label: alert_once severity: warning annotations: value: è¿›ç¨‹ {{ $labels.groupname }} åœ¨ {{ $value }} ç§’å‰å‘ç”Ÿé‡å¯ è¿›ç¨‹é€€å‡º 1 2 3 4 5 6 7 alert: è¿›ç¨‹é€€å‡ºå‘Šè­¦ expr: up{export=\u0026#34;process_exporter\u0026#34;} == 0 or max by(cluster, job, instance, groupname) (delta(namedprocess_namegroup_oldest_start_time_seconds{groupname=~\u0026#34;^map.*\u0026#34;}[10d])) \u0026lt; 0 for: 55s labels: severity: warning annotations: value: è¿›ç¨‹ {{ $labels.export}} å·²é€€å‡º äº”ã€Ansibleæ‰¹é‡æ·»åŠ  è¿™é‡Œé‡‡ç”¨Consulæ³¨å†Œå‘ç°æ–¹å¼ï¼Œç›¸å…³ç±»å®¹å¯ä»¥æŸ¥è¯¢ç½‘ä¸Š\n5.1Consulæ³¨å†Œè„šæœ¬ 1 2 3 4 5 6 7 #!/bin/bash service_name=$1 instance_id=$2 ip=$3 port=$4 curl -X PUT -d \u0026#39;{\u0026#34;id\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$instance_id\u0026#34;\u0026#39;\u0026#34;,\u0026#34;name\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$service_name\u0026#34;\u0026#39;\u0026#34;,\u0026#34;address\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$ip\u0026#34;\u0026#39;\u0026#34;,\u0026#34;port\u0026#34;: \u0026#39;\u0026#34;$port\u0026#34;\u0026#39;,\u0026#34;tags\u0026#34;: [\u0026#34;\u0026#39;\u0026#34;$service_name\u0026#34;\u0026#39;\u0026#34;],\u0026#34;checks\u0026#34;: [{\u0026#34;http\u0026#34;: \u0026#34;http://\u0026#39;\u0026#34;$ip\u0026#34;\u0026#39;:\u0026#39;\u0026#34;$port\u0026#34;\u0026#39;\u0026#34;,\u0026#34;interval\u0026#34;: \u0026#34;5s\u0026#34;}]}\u0026#39; http://10.1.8.202:8500/v1/agent/service/register Ansibleå‰§æœ¬è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 [root@openvpn process]# cat playbook.yml - hosts: Harvester remote_user: root gather_facts: no tasks: - name: æ¨é€é‡‡é›†å™¨å®‰è£…åŒ… unarchive: src=process-exporter.tar.gz dest=/usr/local/ - name: é‡å‘½å shell: | cd /usr/local/ if [ ! -d process-exporter ];then mv process-exporter-0.4.0.linux-amd64 process-exporter fi - name: æŸ¥è¯¢ä¸»æœºåç§° shell: echo \u0026#34;h-`hostname`\u0026#34; register: name_host - name: æ¨é€systemæ–‡ä»¶ copy: src=process_exporter.service dest=/usr/lib/systemd/system - name: å¯åŠ¨æœåŠ¡ systemd: name=process_exporter state=started enabled=yes - name: æ¨é€æ³¨å†Œè„šæœ¬ copy: src=consul-register.sh dest=/usr/local/process-exporter - name: æ³¨å†Œå½“å‰èŠ‚ç‚¹ shell: /bin/sh /usr/local/process-exporter/consul-register.sh {{ group_names[0] }} {{ name_host.stdout }} {{ inventory_hostname }} 9256 â€\n","date":"2022-09-21T14:37:01Z","image":"https://www.ownit.top/title_pic/33.jpg","permalink":"https://www.ownit.top/p/202209211437/","title":"Prometheusç›‘æ§è¿›ç¨‹"},{"content":"ç›‘æ§ç¯å¢ƒï¼šPrometheus\næ•°æ®åº“ï¼šMongoDB 3.4.6 é›†ç¾¤ï¼Œ3ä¸ªèŠ‚ç‚¹\nç›‘æ§å·¥å…·ï¼šmongodb_exporter\n1ã€åˆ›å»ºMongodbç›‘æ§å¯è¯»è´¦å· 1 2 3 4 5 6 7 8 9 10 11 12 mongodb admin åº“ä¸­æ‰§è¡Œ use admin db.createUser({ user: \u0026#34;prometheus\u0026#34;, pwd: \u0026#34;prometheus\u0026#34;, roles: [ { role: \u0026#34;read\u0026#34;, db: \u0026#34;admin\u0026#34; }, { role: \u0026#34;readAnyDatabase\u0026#34;, db: \u0026#34;admin\u0026#34; }, { role: \u0026#34;clusterMonitor\u0026#34;, db: \u0026#34;admin\u0026#34; } ] }); 2ã€ä¸‹è½½MongoDBç›‘æ§è½¯ä»¶ 1 åœ°å€ï¼š https://github.com/percona/mongodb_exporter æˆ‘ä½¿ç”¨çš„ï¼šmongodb_exporter-0.11.2.linux-amd64.tar.gz ç‰ˆæœ¬\n3ã€é…ç½®æ–‡ä»¶ 1 nohup ./mongodb_exporter --mongodb.uri mongodb://root:heian@192.168.82.105:27017/admin --collect.database --collect.collection --collect.topmetrics --collect.indexusage --collect.connpoolstats --suppress.collectshardingstatus \u0026amp; mongodb_exporteræš´éœ²çš„endpointç«¯å£é»˜è®¤ä¸º9216\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 [root@prometheus-server exporter]# ./mongodb_exporter --help usage: mongodb_exporter [\u0026lt;flags\u0026gt;] exports various MongoDB metrics in Prometheus format. Flags: -h, --help Show context-sensitive help (also try --help-long and --help-man). --web.auth-file=WEB.AUTH-FILE Path to YAML file with server_user, server_password keys for HTTP Basic authentication (overrides HTTP_AUTH environment variable). --web.ssl-cert-file=WEB.SSL-CERT-FILE Path to SSL certificate file. --web.ssl-key-file=WEB.SSL-KEY-FILE Path to SSL key file. --web.listen-address=\u0026#34;:9216\u0026#34; Address to listen on for web interface and telemetry. --web.telemetry-path=\u0026#34;/metrics\u0026#34; Path under which to expose metrics. --collect.database Enable collection of Database metrics --collect.collection Enable collection of Collection metrics --collect.topmetrics Enable collection of table top metrics --collect.indexusage Enable collection of per index usage stats --collect.connpoolstats Collect MongoDB connpoolstats --suppress.collectshardingstatus Suppress the collection of Sharding Status --mongodb.uri=[mongodb://][user:pass@]host1[:port1][,host2[:port2],...][/database][?options] MongoDB URI, format --test Check MongoDB connection, print buildInfo() information and exit. --version Show application version. --log.level=\u0026#34;info\u0026#34; Only log messages with the given severity or above. Valid levels: [debug, info, warn, error, fatal] --log.format=\u0026#34;logger:stderr\u0026#34; Set the log target and format. Example: \u0026#34;logger:syslog?appname=bob\u0026amp;local=7\u0026#34; or \u0026#34;logger:stdout?json=true\u0026#34; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 é…ç½®å¯åŠ¨æœåŠ¡ vim /usr/lib/systemd/system/mongodb_exporter.service [Unit] Description=mongodb_exporter Documentation=https://github.com/percona/mongodb_exporter After=network.target [Service] Type=simple User=prometheus Environment=\u0026#34;MONGODB_URI=mongodb://mongodb_exporter:123456@localhost:27017\u0026#34; ExecStart=/usr/local/bin/mongodb_exporter --log.level=error \\ --collect.database \\ --collect.collection \\ --collect.topmetrics \\ --collect.indexusage \\ --collect.connpoolstats Restart=on-failure [Install] WantedBy=multi-user.target 4ã€prometheusé…ç½®åŸºäºæ–‡ä»¶çš„è‡ªåŠ¨å‘ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 - job_name: \u0026#39;mongo_cluster\u0026#39; file_sd_configs: - files: [\u0026#39;/usr/local/prometheus/sd_config/mongo_cluster.yaml\u0026#39;] refresh_interval: 5s root:/usr/local/prometheus# cat /usr/local/prometheus/sd_config/mongo_cluster.yaml - targets: - \u0026#34;192.168.88.140:9216\u0026#34; - \u0026#34;192.168.88.141:9216\u0026#34; - \u0026#34;192.168.88.142:9216\u0026#34; labels: project: mongo unitname: \u0026#34;Mongodb_exporter\u0026#34; service: mongo 5ã€grafanaé…ç½®mongoå±•ç¤ºå›¾ å¯¼å…¥å›¾ï¼š16974\nMongoDBä¿¡æ¯ | Grafana LabsÂ ï¼ˆè¿™ä¸ªæ¨¡æ¿æ˜¯è‡ªå·±ç»˜åˆ¶çš„ï¼Œæœ‰åŸºç¡€çš„å¯ä»¥äºŒæ¬¡å¼€å‘ï¼‰\n","date":"2022-09-16T10:07:26Z","image":"https://www.ownit.top/title_pic/69.jpg","permalink":"https://www.ownit.top/p/202209161007/","title":"Prometheusç›‘æ§MongoDBæ•°æ®åº“"},{"content":"å› ä¸ºä¸šåŠ¡éœ€æ±‚ï¼Œéœ€è¦è¿æ¥æ•°æ®åº“æŸ¥è¯¢æ•°æ®\næ•°æ®åº“ç±»å‹ï¼šmysqlï¼Œmongodb\néœ€æ±‚ï¼šæœ‰ä¸­è¿æœºåˆ¶ï¼Œè¯»å–é…ç½®æ–‡ä»¶ï¼Œå¯å®ä¾‹åŒ–ï¼Œæœ‰æ—¥å¿—è®°å½•\né…ç½®æ–‡ä»¶ dbconfig.conf\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [Mongodbtest] host=192.168.99.42 port=27018 user= password= database=ace_sms [mysql] host=192.168.99.42 port=27018 user= password= database=ace_sms æ—¥å¿—ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 # -*- coding: utf-8 -*- # @Time : 2022/7/12 18:13 # @File : Loggers.py # @Software: PyCharm # åŠ å…¥æ—¥å¿— # è·å–loggerå®ä¾‹ import logging import os import sys logger = logging.getLogger(\u0026#34;baseSpider\u0026#34;) # æŒ‡å®šè¾“å‡ºæ ¼å¼ formatter = logging.Formatter(\u0026#39;%(asctime)s\\ %(filename)s-%(lineno)d\\ %(levelname)s\\ %(message)s\u0026#39;) # æ–‡ä»¶æ—¥å¿— # è·å–å½“å‰æ–‡ä»¶è·¯å¾„ current_path = os.path.abspath(os.path.dirname(__file__)) father_path = os.path.abspath(os.path.dirname(current_path) + os.path.sep + \u0026#34;.\u0026#34;) log_file_path = os.path.join(father_path + \u0026#34;\\logs\\dingding_message.log\u0026#34;) file_handler = logging.FileHandler(log_file_path) file_handler.setFormatter(formatter) # æ§åˆ¶å°æ—¥å¿— console_handler = logging.StreamHandler(sys.stdout) console_handler.setFormatter(formatter) # ä¸ºloggeæ·»åŠ å…·ä½“çš„æ—¥å¿—å¤„ç†å™¨ logger.addHandler(file_handler) logger.addHandler(console_handler) logger.setLevel(logging.INFO) mysqlè¿æ¥ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 # -*- coding: utf-8 -*- # @Time : 2022-07-08 21:32 # @File : MyDB.py # @Software: PyCharm import time import pymysql import configparser import logging import sys from tool.Loggers import logger class mysql: def __init__(self, config_file, db): \u0026#34;\u0026#34;\u0026#34; :param config_file: :param db: \u0026#34;\u0026#34;\u0026#34; # å®ä¾‹åŒ–configparser config = configparser.ConfigParser() # ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–æ•°æ®åº“çš„ç›¸å…³ä¿¡æ¯ config.read(config_file, encoding=\u0026#39;utf-8\u0026#39;) self.host = config[db][\u0026#39;host\u0026#39;] self.port = int(config[db][\u0026#39;port\u0026#39;]) self.user = config[db][\u0026#39;user\u0026#39;] self.password = config[db][\u0026#39;password\u0026#39;] self.database = config[db][\u0026#39;database\u0026#39;] self.db = db self.conn = None self._conn() def _conn(self): try: logger.info(f\u0026#34;è¯»å–ç¯å¢ƒï¼š{self.db}ï¼Œè¿æ¥ä¿¡æ¯ï¼šä¸»æœºipï¼š{self.host},ç«¯å£ï¼š{self.port},ç”¨æˆ·ï¼š{self.user},è¿æ¥æ•°æ®åº“ï¼š{self.database}\u0026#34;) self.conn = pymysql.Connection(host=self.host, user=self.user, password=self.password, database=self.database, port=self.port) logger.info(f\u0026#34;æ•°æ®åº“: {self.database}åˆå§‹åŒ–è¿æ¥æˆåŠŸ\u0026#34;) return True except Exception as e: logger.error(f\u0026#34;æ•°æ®åº“: {self.database}åˆå§‹åŒ–è¿æ¥å¤±è´¥ï¼Œé”™è¯¯ï¼š{e}\u0026#34;) return False def close(self): self.conn.close() logger.info(f\u0026#34;æ•°æ®åº“å…³é—­æˆåŠŸ\u0026#34;) def _reConn(self, num=28800, stime=3): # é‡è¯•è¿æ¥æ€»æ¬¡æ•°ä¸º1å¤©,è¿™é‡Œæ ¹æ®å®é™…æƒ…å†µè‡ªå·±è®¾ç½®,å¦‚æœæœåŠ¡å™¨å®•æœº1å¤©éƒ½æ²¡å‘ç°å°±...... _number = 0 _status = True logger.info(f\u0026#34;æ£€æŸ¥æ•°æ®åº“{self.database}è¿é€šæ€§,è¿æ¥IPï¼š{self.host}\u0026#34;) while _status and _number \u0026lt;= num: try: self.conn.ping() # cping æ ¡éªŒè¿æ¥æ˜¯å¦å¼‚å¸¸ _status = False logger.info(f\u0026#34;æ•°æ®åº“{self.database}è¿æ¥============æ­£å¸¸,è¿æ¥IPï¼š{self.host} \u0026#34;) except: if self._conn() == True: # é‡æ–°è¿æ¥,æˆåŠŸé€€å‡º _status = False break _number += 1 logger.info(f\u0026#34;æ•°æ®åº“{self.database}è¿æ¥============å¤±è´¥,è¿æ¥IPï¼š{self.host} \u0026#34;) time.sleep(stime) # è¿æ¥ä¸æˆåŠŸ,ä¼‘çœ 3ç§’é’Ÿ,ç»§ç»­å¾ªç¯ï¼ŒçŸ¥é“æˆåŠŸæˆ–é‡è¯•æ¬¡æ•°ç»“æŸ def select(self, sql=\u0026#39;\u0026#39;): try: self._reConn() logger.info(\u0026#39;æŸ¥è¯¢çš„è¯­å¥:%s\u0026#39; % sql) # å»ºç«‹æ¸¸æ ‡ db_cursor = self.conn.cursor() db_cursor.execute(sql) result = db_cursor.fetchall() # è¿”å›å€¼å’Œæ•°æ®è¡¨å­—æ®µç»„æˆjsonæ ¼å¼ lists = [] t = 0 for x in result: i = 0 onelist = {} for field in db_cursor.description: onelist[field[0]] = x[i] i = i + 1 lists.append(onelist) logger.info(\u0026#39;ç»„åˆæ•°æ®:%s\u0026#39; % lists) return lists # return result except pymysql.Error as e: logger.error(\u0026#39;æ•°æ®åº“æŸ¥è¯¢æ•°æ®å¤±è´¥ï¼š%s\u0026#39; % e) return False def select_limit(self, sql=\u0026#39;\u0026#39;, offset=0, length=20): sql = \u0026#39;%s limit %d , %d ;\u0026#39; % (sql, offset, length) return self.select(sql) # # æ’å…¥ # def execute_insert(self, query): # print(\u0026#39;query:%s\u0026#39; % query) # try: # # å»ºç«‹æ¸¸æ ‡ # db_cursor = self.dbconn.cursor() # db_cursor.execute(query) # db_cursor.execute(\u0026#39;commit\u0026#39;) # return True # except Exception as e: # print(\u0026#39;æ•°æ®åº“æ’å…¥æ•°æ®å¤±è´¥ï¼š%s\u0026#39; % e) # # äº‹åŠ¡å›æ»š # db_cursor.execute(\u0026#39;rollback\u0026#39;) # db_cursor.close() # exit() MongoDBè¿æ¥ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 # -*- coding: utf-8 -*- # @Time : 2022/7/12 10:44 # @File : MongoDB.py # @Software: PyCharm import configparser import time import pymongo from alarm.tool.Loggers import logger class mongo(object): def __init__(self, config_file, db): \u0026#34;\u0026#34;\u0026#34; :param config_file: é…ç½®æ–‡ä»¶è·¯å¾„ :param db: è·å–é…ç½®çš„ç¯å¢ƒ \u0026#34;\u0026#34;\u0026#34; # å®ä¾‹åŒ–configparser config = configparser.ConfigParser() # ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–æ•°æ®åº“çš„ç›¸å…³ä¿¡æ¯ config.read(config_file, encoding=\u0026#39;utf-8\u0026#39;) self.host = config[db][\u0026#39;host\u0026#39;] self.port = int(config[db][\u0026#39;port\u0026#39;]) self.user = config[db][\u0026#39;user\u0026#39;] self.password = config[db][\u0026#39;password\u0026#39;] self.database = config[db][\u0026#39;database\u0026#39;] self.db = db self.conn = None self._conn() def _conn(self): try: logger.info(f\u0026#34;è¯»å–ç¯å¢ƒï¼š{self.db}ï¼Œè¿æ¥ä¿¡æ¯ï¼šä¸»æœºipï¼š{self.host},ç«¯å£ï¼š{self.port},ç”¨æˆ·ï¼š{self.user},è¿æ¥æ•°æ®åº“ï¼š{self.database}\u0026#34;) # self.conn = pymongo.MongoClient(host=self.host, # port=self.port) self.conn = pymongo.MongoClient(host=self.host, port=self.port) # username=self.user, password=self.password # self.db_conn = self.conn[self.database] # self.db_conn=self.db_conn.authenticate(self.user,self.password) self.conn[self.database].authenticate(self.user, self.password, self.database) self.db_conn = self.conn[self.database] if self.conn.server_info(): logger.info(f\u0026#34;æ•°æ®åº“: {self.database}åˆå§‹åŒ–è¿æ¥æˆåŠŸ\u0026#34;) return True except Exception as e: logger.error(f\u0026#34;æ•°æ®åº“: {self.database}åˆå§‹åŒ–è¿æ¥å¤±è´¥ï¼Œé”™è¯¯ï¼š{e}\u0026#34;) return False # MongoDBæ•°æ®åº“å…³é—­ def close(self): self.conn.close() logger.info(f\u0026#34;æ•°æ®åº“å…³é—­æˆåŠŸ\u0026#34;) # æŸ¥è¯¢è°ƒç”¨çŠ¶æ€ def get_state(self): return self.conn is not None # and self.db_conn is not None def _reConn(self, num=28800, stime=3): # é‡è¯•è¿æ¥æ€»æ¬¡æ•°ä¸º1å¤©,è¿™é‡Œæ ¹æ®å®é™…æƒ…å†µè‡ªå·±è®¾ç½®,å¦‚æœæœåŠ¡å™¨å®•æœº1å¤©éƒ½æ²¡å‘ç°å°±...... _number = 0 _status = True logger.info(f\u0026#34;æ£€æŸ¥æ•°æ®åº“{self.database}è¿é€šæ€§,è¿æ¥IPï¼š{self.host}\u0026#34;) while _status and _number \u0026lt;= num: try: self.conn.server_info() # æ£€æŸ¥æ•°æ®åº“æ˜¯å¦æ­£å¸¸è¿é€š _status = False logger.info(f\u0026#34;æ•°æ®åº“{self.database}è¿æ¥============æ­£å¸¸,è¿æ¥IPï¼š{self.host} \u0026#34;) except: if self._conn() == True: # é‡æ–°è¿æ¥,æˆåŠŸé€€å‡º _status = False break _number += 1 logger.info(f\u0026#34;æ•°æ®åº“{self.database}è¿æ¥============å¤±è´¥,è¿æ¥IPï¼š{self.host} \u0026#34;) time.sleep(stime) # è¿æ¥ä¸æˆåŠŸ,ä¼‘çœ 3ç§’é’Ÿ,ç»§ç»­å¾ªç¯ï¼ŒçŸ¥é“æˆåŠŸæˆ–é‡è¯•æ¬¡æ•°ç»“æŸ def insert_one(self, collection, data): self._reConn() if self.get_state(): ret = self.db_conn[collection].insert_one(data) return ret.inserted_id else: return \u0026#34;\u0026#34; def insert_many(self, collection, data): if self.get_state(): ret = self.db_conn[collection].insert_many(data) return ret.inserted_id else: return \u0026#34;\u0026#34; def update(self, collection, data): # data format: # {key:[old_data,new_data]} data_filter = {} data_revised = {} for key in data.keys(): data_filter[key] = data[key][0] data_revised[key] = data[key][1] if self.get_state(): return self.db_conn[collection].update_many(data_filter, {\u0026#34;$set\u0026#34;: data_revised}).modified_count return 0 def find(self, col, condition, column=None): \u0026#34;\u0026#34;\u0026#34; æŸ¥è¯¢æ•°æ®ä»£ç  :param col: æ•°æ®åº“ä¸­çš„é›†åˆ :param condition: æŸ¥è¯¢æ¡ä»¶,æŸ¥è¯¢æ¡ä»¶å¿…é¡»æ˜¯ä¸ªå­—å…¸ :param column: find çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œå¯ä»¥æŒ‡å®šéœ€è¦è¿”å›çš„é”®ã€‚è¿™ä¸ªç‰¹åˆ«çš„ \u0026#34;$slice\u0026#34; è¿ç®—ç¬¦å¯ä»¥è¿”å›ä¸€ä¸ªæ•°ç»„é”®ä¸­å…ƒç´ çš„å­é›†ã€‚ :return: list è¿”å›æŸ¥è¯¢åˆ°è®°å½•çš„åˆ—è¡¨ \u0026#34;\u0026#34;\u0026#34; # print(col, condition) # data= self.db_conn[\u0026#34;sms_log\u0026#34;] # data=self.db_conn[\u0026#34;sms_log\u0026#34;].find({\u0026#34;status\u0026#34;:\u0026#34;2\u0026#34;,\u0026#34;createTime\u0026#34;:{\u0026#34;$gte\u0026#34;: \u0026#34;2022/07/12 22:18:26\u0026#34;}},{\u0026#34;status\u0026#34;:1,\u0026#34;channelCode\u0026#34;:1,\u0026#34;_id\u0026#34;:0}) # data = self.db_conn[\u0026#34;authCode\u0026#34;].find({\u0026#34;use\u0026#34;: False,\u0026#34;createdTime\u0026#34;: {\u0026#34;$gte\u0026#34;: 1657865035}}) # print(list(data)) self._reConn() if self.get_state(): if column is None: return list(self.db_conn[col].find(condition)) else: return list(self.db_conn[col].find(condition, column)) else: return None def get_last_data(self, col, number=1): if self.get_state(): # last_data = list(self.db_conn[\u0026#34;authCode\u0026#34;].find().sort(\u0026#34;_id\u0026#34;, -1 ).limit(50)) last_data = list(self.db_conn[col].find().sort(\u0026#34;_id\u0026#34;, -1).limit(number)) return last_data def delete(self, col, condition): if self.get_state(): return self.db_conn[col].delete_many(filter=condition).deleted_count return 0 def aggregate(self, col, condition): if self.get_state(): return list(self.db_conn[col].aggregate(condition)) # æ—¶é—´æˆ³è½¬æ¢æ—¶é—´ def timestamp_to_time(timestamp): timeArray = time.localtime(timestamp) # è½¬æ¢ä¸ºå¯ç”¨çš„æ—¶é—´ï¼Œå°±æ˜¯ä¸‹é¢çš„%Y %m %d # day_time = time.strftime(\u0026#34;%Y-%m-%d\u0026#34;, timeArray) # å–ä¸Šé¢çš„timeArrayä¸­çš„å¯¹åº”å€¼0 second_time = time.strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;, timeArray) # è¿™ä¸ªä¸€æ ·çš„ return second_time # è¿”å›ç›¸åº”çš„å€¼ # æ—¶é—´è½¬æ¢æ—¶é—´æˆ³ def time_to_timestamp(time_str): # è½¬æ¢æˆæ—¶é—´æ•°ç»„ timeArray = time.strptime(time_str, \u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) # è½¬æ¢æˆæ—¶é—´æˆ³ timestamp = time.mktime(timeArray) # print(timestamp) return timestamp if __name__ == \u0026#39;__main__\u0026#39;: logger.info(\u0026#34;å¼€å§‹å®ä¾‹åŒ–æ•°æ®åº“å¯¹è±¡ \u0026#34;) config_file = \u0026#39;../config/dbconfig.conf\u0026#39; db = \u0026#39;Devfubaodai\u0026#39; db = mongo(config_file, db) # è·å–æ—¶é—´ data_time = \u0026#39;2022-07-18 00:00:00\u0026#39; timestamp = time_to_timestamp(data_time) # print(timestamp) data = db.get_last_data(\u0026#34;authCode\u0026#34;, 1) last_time_data = data[0][\u0026#34;createdTime\u0026#34;] satrt_time_data = data[0][\u0026#34;createdTime\u0026#34;]-600 print(timestamp_to_time(last_time_data)) print(timestamp_to_time(satrt_time_data)) data = db.find(\u0026#34;authCode\u0026#34;, {\u0026#34;createdTime\u0026#34;: {\u0026#34;$gte\u0026#34;: satrt_time_data, \u0026#34;$lte\u0026#34;: last_time_data}}, {\u0026#34;name\u0026#34;: 1, \u0026#34;use\u0026#34;: 1, \u0026#34;_id\u0026#34;: 0}) num, fail = 0, 0 for i in data: num += 1 print(i) print(num) # logger.info(f\u0026#34;çŸ­ä¿¡---æœ€æ–°50æ¡æ•°æ®ï¼ŒæˆåŠŸä½¿ç”¨æ•°é‡ï¼š{num}ï¼Œæœªä½¿ç”¨çš„æ•°é‡ï¼š{fail}\u0026#34;) db.close() logger.info(\u0026#34;--------------------------------------------------------------------------------------------------\u0026#34;) mianç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 def main(): #mysqld_test() schedule.every(1).minutes.do(mysqld_test) while True: schedule.run_pending() time.sleep(1) if __name__ == \u0026#39;__main__\u0026#39;: res = os.path.abspath(__file__) # è·å–å½“å‰æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ print(res) base_path = os.path.dirname(os.path.dirname(res)) # è·å–å½“å‰æ–‡ä»¶çš„ä¸Šä¸¤çº§ç›®å½• print(base_path) base_path2 = os.path.dirname(res) print(base_path2) sys.path.append(base_path2) sys.path.append(base_path) sys.path.insert(0, base_path) # åŠ å…¥ç¯å¢ƒå˜é‡ # ä»¥ä¸Š5è¡Œä»£ç å¿…é¡»è¦åŠ å…¥åˆ°æ–‡ä»¶çš„æœ€ä¸Šæ–¹ print(sys.path) main() ","date":"2022-07-25T17:44:50Z","image":"https://www.ownit.top/title_pic/19.jpg","permalink":"https://www.ownit.top/p/202207251744/","title":"Pythonå¼€å‘mysqlå’Œmongo è¿æ¥ç±»"},{"content":"\nAlertmanagerå‘Šè­¦ ç³»ç»Ÿæ•´åˆ æµç¨‹ ï¼ˆ1ï¼‰ç›‘æ§ç«¯ï¼Œå¯ä»¥ä½¿ç”¨Python æˆ–è€… shell è¿›è¡Œç›‘æ§ï¼ŒæŠŠ ç›¸å…³çš„jsonæ•°æ®æ¨é€åˆ°Alertmanager\nï¼ˆ2ï¼‰Alertmanagerç«¯ è¿›è¡Œ æ±‡æ€»ï¼Œå‘é€ï¼Œåç»­å¯ä»¥é™é»˜ï¼ŒæŠ‘åˆ¶ç­‰åŠŸèƒ½\nï¼ˆ3ï¼‰æŠŠå‘Šè­¦çš„æ•°æ®å‘é€åˆ°prometheusalertï¼Œè¿›è¡Œé’‰é’‰çš„å‘é€\nç¯å¢ƒ è½¯ä»¶\nprometheusalert å‘Šè­¦ç³»ç»Ÿ ï¼šä¸»è¦æ˜¯æ•°æ®çš„å„ä¸ªæ¸ é“å‘é€\nAlertmanager å‘Šè­¦å¤„ç†ï¼šä¸»è¦æ±‡æ€»æ•°æ®ï¼ŒæŠ‘åˆ¶ï¼Œé™é»˜\næ€è·¯ ç¼–å†™å‘Šè­¦æµ‹è¯•æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨ç”Ÿæˆæ—¶é—´ï¼Œä»…ç”Ÿæˆç›¸å…³çš„å‘Šè­¦æŒ‡æ ‡ï¼Œæ—¶é—´ç¨‹åºä¼šå¸®å¿™ç”Ÿæˆï¼ˆå¾…æµ‹è¯•ï¼‰\næ­¥éª¤ è·å–Alertmanageræ•°æ®æ ¼å¼ æ–¹æ³•ï¼Œé€šè¿‡flask ç¼–å†™æ¥å£ï¼ŒAlertmanageré…ç½®ï¼Œå‘Šè­¦æ—¶å›æŠŠæ•°æ®å‘é€åˆ°æ­¤æ¥å£ ï¼Œè¿›è¡Œå±•ç¤ºæŸ¥çœ‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 from flask import Flask, request import json app = Flask(__name__) @app.route(\u0026#34;/send/\u0026#34;, methods=[\u0026#34;POST\u0026#34;]) def send(): try: data = json.loads(request.data) print(data) alerts = data[\u0026#39;alerts\u0026#39;] for i in alerts: print(\u0026#39;SEND SMS: \u0026#39; + str(i)) except Exception as e: print(e) return \u0026#39;ok\u0026#39; if __name__ == \u0026#39;__main__\u0026#39;: app.run(host=\u0026#39;0.0.0.0\u0026#39;, port=8082) åœ¨Alertmanageré…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 [root@prometheus-server alertmanager-0.24.0.linux-amd64]# cat alertmanager.yml global: resolve_timeout: 5m route: group_by: [\u0026#39;instance\u0026#39;] group_wait: 30s group_interval: 10s repeat_interval: 10m receiver: \u0026#39;web.hook.prometheusalert\u0026#39; receivers: - name: \u0026#39;web.hook.prometheusalert\u0026#39; webhook_configs: - url: http://192.168.96.19:8082/send/ äº§ç”Ÿprometheusçš„æµ‹è¯•æ•°æ®\nå…³é—­å®¢æˆ·ç«¯ï¼Œäº§ç”Ÿå‘Šè­¦Â å‘Šè­¦æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 { \u0026#39;receiver\u0026#39;: \u0026#39;web\\\\.hook\\\\.prometheusalert\u0026#39;, \u0026#39;status\u0026#39;: \u0026#39;firing\u0026#39;, \u0026#39;alerts\u0026#39;: [{ \u0026#39;status\u0026#39;: \u0026#39;firing\u0026#39;, \u0026#39;labels\u0026#39;: { \u0026#39;alertname\u0026#39;: \u0026#39;ä¸»æœºå­˜æ´»çŠ¶æ€è­¦å‘Šï¼\u0026#39;, \u0026#39;cloud\u0026#39;: \u0026#39;ä¹˜é£-Devç¯å¢ƒ\u0026#39;, \u0026#39;instance\u0026#39;: \u0026#39;192.168.82.105:9100\u0026#39;, \u0026#39;job\u0026#39;: \u0026#39;node_exporter\u0026#39;, \u0026#39;severity\u0026#39;: \u0026#39;éå¸¸ä¸¥é‡\u0026#39;, \u0026#39;team\u0026#39;: \u0026#39;ops\u0026#39; }, \u0026#39;annotations\u0026#39;: { \u0026#39;description\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å»¶æ—¶è¶…è¿‡5åˆ†é’Ÿ\u0026#39;, \u0026#39;summary\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å®•æœº\u0026#39; }, \u0026#39;startsAt\u0026#39;: \u0026#39;2022-07-05T05:54:37.452Z\u0026#39;, \u0026#39;endsAt\u0026#39;: \u0026#39;0001-01-01T00:00:00Z\u0026#39;, \u0026#39;generatorURL\u0026#39;: \u0026#39;http://prometheus-server.0101101300.fjf:9090/graph?g0.expr=up+%3D%3D+0\u0026amp;g0.tab=1\u0026#39;, \u0026#39;fingerprint\u0026#39;: \u0026#39;4a890f7c225c3bef\u0026#39; }], \u0026#39;groupLabels\u0026#39;: { \u0026#39;instance\u0026#39;: \u0026#39;192.168.82.105:9100\u0026#39; }, \u0026#39;commonLabels\u0026#39;: { \u0026#39;alertname\u0026#39;: \u0026#39;ä¸»æœºå­˜æ´»çŠ¶æ€è­¦å‘Šï¼\u0026#39;, \u0026#39;cloud\u0026#39;: \u0026#39;ä¹˜é£-Devç¯å¢ƒ\u0026#39;, \u0026#39;instance\u0026#39;: \u0026#39;192.168.82.105:9100\u0026#39;, \u0026#39;job\u0026#39;: \u0026#39;node_exporter\u0026#39;, \u0026#39;severity\u0026#39;: \u0026#39;éå¸¸ä¸¥é‡\u0026#39;, \u0026#39;team\u0026#39;: \u0026#39;ops\u0026#39; }, \u0026#39;commonAnnotations\u0026#39;: { \u0026#39;description\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å»¶æ—¶è¶…è¿‡5åˆ†é’Ÿ\u0026#39;, \u0026#39;summary\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å®•æœº\u0026#39; }, \u0026#39;externalURL\u0026#39;: \u0026#39;http://prometheus-server.0101101300.fjf:9093\u0026#39;, \u0026#39;version\u0026#39;: \u0026#39;4\u0026#39;, \u0026#39;groupKey\u0026#39;: \u0026#39;{}:{instance=\u0026#34;192.168.82.105:9100\u0026#34;}\u0026#39;, \u0026#39;truncatedAlerts\u0026#39;: 0 } æœ‰ç”¨çš„å‘Šè­¦æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 { \u0026#39;status\u0026#39;: \u0026#39;firing\u0026#39;, \u0026#39;labels\u0026#39;: { \u0026#39;alertname\u0026#39;: \u0026#39;ä¸»æœºå­˜æ´»çŠ¶æ€è­¦å‘Šï¼\u0026#39;, \u0026#39;cloud\u0026#39;: \u0026#39;ä¹˜é£-Devç¯å¢ƒ\u0026#39;, \u0026#39;instance\u0026#39;: \u0026#39;192.168.82.105:9100\u0026#39;, \u0026#39;job\u0026#39;: \u0026#39;node_exporter\u0026#39;, \u0026#39;severity\u0026#39;: \u0026#39;éå¸¸ä¸¥é‡\u0026#39;, \u0026#39;team\u0026#39;: \u0026#39;ops\u0026#39; }, \u0026#39;annotations\u0026#39;: { \u0026#39;description\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å»¶æ—¶è¶…è¿‡5åˆ†é’Ÿ\u0026#39;, \u0026#39;summary\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å®•æœº\u0026#39; }, \u0026#39;startsAt\u0026#39;: \u0026#39;2022-07-05T05:54:37.452Z\u0026#39;, \u0026#39;endsAt\u0026#39;: \u0026#39;0001-01-01T00:00:00Z\u0026#39;, \u0026#39;generatorURL\u0026#39;: \u0026#39;http://prometheus-server.0101101300.fjf:9090/graph?g0.expr=up+%3D%3D+0\u0026amp;g0.tab=1\u0026#39;, \u0026#39;fingerprint\u0026#39;: \u0026#39;4a890f7c225c3bef\u0026#39; } æ¢å¤æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 { \u0026#39;receiver\u0026#39;: \u0026#39;web\\\\.hook\\\\.prometheusalert\u0026#39;, \u0026#39;status\u0026#39;: \u0026#39;resolved\u0026#39;, \u0026#39;alerts\u0026#39;: [{ \u0026#39;status\u0026#39;: \u0026#39;resolved\u0026#39;, \u0026#39;labels\u0026#39;: { \u0026#39;alertname\u0026#39;: \u0026#39;ä¸»æœºå­˜æ´»çŠ¶æ€è­¦å‘Šï¼\u0026#39;, \u0026#39;cloud\u0026#39;: \u0026#39;ä¹˜é£-Devç¯å¢ƒ\u0026#39;, \u0026#39;instance\u0026#39;: \u0026#39;192.168.82.105:9100\u0026#39;, \u0026#39;job\u0026#39;: \u0026#39;node_exporter\u0026#39;, \u0026#39;severity\u0026#39;: \u0026#39;éå¸¸ä¸¥é‡\u0026#39;, \u0026#39;team\u0026#39;: \u0026#39;ops\u0026#39; }, \u0026#39;annotations\u0026#39;: { \u0026#39;description\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å»¶æ—¶è¶…è¿‡5åˆ†é’Ÿ\u0026#39;, \u0026#39;summary\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å®•æœº\u0026#39; }, \u0026#39;startsAt\u0026#39;: \u0026#39;2022-07-05T05:54:37.452Z\u0026#39;, \u0026#39;endsAt\u0026#39;: \u0026#39;2022-07-05T05:56:52.452Z\u0026#39;, \u0026#39;generatorURL\u0026#39;: \u0026#39;http://prometheus-server.0101101300.fjf:9090/graph?g0.expr=up+%3D%3D+0\u0026amp;g0.tab=1\u0026#39;, \u0026#39;fingerprint\u0026#39;: \u0026#39;4a890f7c225c3bef\u0026#39; }], \u0026#39;groupLabels\u0026#39;: { \u0026#39;instance\u0026#39;: \u0026#39;192.168.82.105:9100\u0026#39; }, \u0026#39;commonLabels\u0026#39;: { \u0026#39;alertname\u0026#39;: \u0026#39;ä¸»æœºå­˜æ´»çŠ¶æ€è­¦å‘Šï¼\u0026#39;, \u0026#39;cloud\u0026#39;: \u0026#39;ä¹˜é£-Devç¯å¢ƒ\u0026#39;, \u0026#39;instance\u0026#39;: \u0026#39;192.168.82.105:9100\u0026#39;, \u0026#39;job\u0026#39;: \u0026#39;node_exporter\u0026#39;, \u0026#39;severity\u0026#39;: \u0026#39;éå¸¸ä¸¥é‡\u0026#39;, \u0026#39;team\u0026#39;: \u0026#39;ops\u0026#39; }, \u0026#39;commonAnnotations\u0026#39;: { \u0026#39;description\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å»¶æ—¶è¶…è¿‡5åˆ†é’Ÿ\u0026#39;, \u0026#39;summary\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å®•æœº\u0026#39; }, \u0026#39;externalURL\u0026#39;: \u0026#39;http://prometheus-server.0101101300.fjf:9093\u0026#39;, \u0026#39;version\u0026#39;: \u0026#39;4\u0026#39;, \u0026#39;groupKey\u0026#39;: \u0026#39;{}:{instance=\u0026#34;192.168.82.105:9100\u0026#34;}\u0026#39;, \u0026#39;truncatedAlerts\u0026#39;: 0 } æœ‰ç”¨çš„æ¢å¤æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 { \u0026#39;status\u0026#39;: \u0026#39;resolved\u0026#39;, \u0026#39;labels\u0026#39;: { \u0026#39;alertname\u0026#39;: \u0026#39;ä¸»æœºå­˜æ´»çŠ¶æ€è­¦å‘Šï¼\u0026#39;, \u0026#39;cloud\u0026#39;: \u0026#39;ä¹˜é£-Devç¯å¢ƒ\u0026#39;, \u0026#39;instance\u0026#39;: \u0026#39;192.168.82.105:9100\u0026#39;, \u0026#39;job\u0026#39;: \u0026#39;node_exporter\u0026#39;, \u0026#39;severity\u0026#39;: \u0026#39;éå¸¸ä¸¥é‡\u0026#39;, \u0026#39;team\u0026#39;: \u0026#39;ops\u0026#39; }, \u0026#39;annotations\u0026#39;: { \u0026#39;description\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å»¶æ—¶è¶…è¿‡5åˆ†é’Ÿ\u0026#39;, \u0026#39;summary\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å®•æœº\u0026#39; }, \u0026#39;startsAt\u0026#39;: \u0026#39;2022-07-05T05:54:37.452Z\u0026#39;, \u0026#39;endsAt\u0026#39;: \u0026#39;2022-07-05T05:56:52.452Z\u0026#39;, \u0026#39;generatorURL\u0026#39;: \u0026#39;http://prometheus-server.0101101300.fjf:9090/graph?g0.expr=up+%3D%3D+0\u0026amp;g0.tab=1\u0026#39;, \u0026#39;fingerprint\u0026#39;: \u0026#39;4a890f7c225c3bef\u0026#39; } Pythonå‘é€å‘Šè­¦æ•°æ® å‘é€å‘Šè­¦ä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 import json import requests new_packinf = [{ \u0026#39;status\u0026#39;: \u0026#39;firing\u0026#39;, \u0026#39;labels\u0026#39;: { \u0026#39;alertname\u0026#39;: \u0026#39;ä¸»æœºå­˜æ´»çŠ¶æ€è­¦å‘Šï¼\u0026#39;, \u0026#39;cloud\u0026#39;: \u0026#39;ä¹˜é£å°è´·-Devç¯å¢ƒ\u0026#39;, \u0026#39;instance\u0026#39;: \u0026#39;192.168.82.105:9100\u0026#39;, \u0026#39;job\u0026#39;: \u0026#39;node_exporter\u0026#39;, \u0026#39;severity\u0026#39;: \u0026#39;éå¸¸ä¸¥é‡\u0026#39;, \u0026#39;team\u0026#39;: \u0026#39;ops\u0026#39; }, \u0026#39;annotations\u0026#39;: { \u0026#39;description\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å»¶æ—¶è¶…è¿‡5åˆ†é’Ÿ\u0026#39;, \u0026#39;summary\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å®•æœº\u0026#39; }, \u0026#39;startsAt\u0026#39;: \u0026#39;2022-07-05T05:54:37.452Z\u0026#39;, \u0026#39;endsAt\u0026#39;: \u0026#39;0001-01-01T00:00:00Z\u0026#39;, \u0026#39;generatorURL\u0026#39;: \u0026#39;http://prometheus-server.0101101300.fjf:9090/graph?g0.expr=up+%3D%3D+0\u0026amp;g0.tab=1\u0026#39;, \u0026#39;fingerprint\u0026#39;: \u0026#39;4a890f7c225c3bef\u0026#39; }] jsons = json.dumps(new_packinf) url = \u0026#34;http://192.168.82.105:9093/api/v2/alerts\u0026#34; headers = {\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;} responses = requests.post(url=url, headers=headers, data=jsons) print(responses.status_code, responses.url) # print(responses.json()) å‘é€æ¢å¤å‘Šè­¦ä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 import json import requests new_packinf = [{ \u0026#39;status\u0026#39;: \u0026#39;resolved\u0026#39;, \u0026#39;labels\u0026#39;: { \u0026#39;alertname\u0026#39;: \u0026#39;ä¸»æœºå­˜æ´»çŠ¶æ€è­¦å‘Šï¼\u0026#39;, \u0026#39;cloud\u0026#39;: \u0026#39;ä¹˜é£-Devç¯å¢ƒ\u0026#39;, \u0026#39;instance\u0026#39;: \u0026#39;192.168.82.105:9100\u0026#39;, \u0026#39;job\u0026#39;: \u0026#39;node_exporter\u0026#39;, \u0026#39;severity\u0026#39;: \u0026#39;éå¸¸ä¸¥é‡\u0026#39;, \u0026#39;team\u0026#39;: \u0026#39;ops\u0026#39; }, \u0026#39;annotations\u0026#39;: { \u0026#39;description\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å»¶æ—¶è¶…è¿‡5åˆ†é’Ÿ\u0026#39;, \u0026#39;summary\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å®•æœº\u0026#39; }, \u0026#39;startsAt\u0026#39;: \u0026#39;2022-07-05T05:54:37.452Z\u0026#39;, \u0026#39;endsAt\u0026#39;: \u0026#39;2022-07-05T05:56:52.452Z\u0026#39;, \u0026#39;generatorURL\u0026#39;: \u0026#39;http://prometheus-server.0101101300.fjf:9090/graph?g0.expr=up+%3D%3D+0\u0026amp;g0.tab=1\u0026#39;, \u0026#39;fingerprint\u0026#39;: \u0026#39;4a890f7c225c3bef\u0026#39; }] jsons = json.dumps(new_packinf) url = \u0026#34;http://192.168.82.105:9093/api/v2/alerts\u0026#34; headers = {\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;} responses = requests.post(url=url, headers=headers, data=jsons) print(responses.status_code, responses.url) # print(responses.json()) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 import json import requests import time year_time = time.strftime(\u0026#39;%Y-%m-%d\u0026#39;, time.localtime()) now_time = time.strftime(\u0026#39;%H:%M:%S\u0026#39;, time.localtime()) start_time = year_time + \u0026#34;T\u0026#34; + now_time + \u0026#34;.000+08:00\u0026#34; is_end_time = False if is_end_time: print(\u0026#34;å‘Šè­¦æœªè§£å†³\u0026#34;) end_time = \u0026#39;0001-01-01T00:00:00Z\u0026#39; else: print(\u0026#34;å‘Šè­¦å·²ç»è§£å†³\u0026#34;) end_time = start_time new_packinf = [{ \u0026#39;labels\u0026#39;: { \u0026#39;alertname\u0026#39;: \u0026#39;ä¸»æœºå­˜æ´»çŠ¶æ€è­¦å‘Šï¼\u0026#39;, \u0026#39;cloud\u0026#39;: \u0026#39;å°è´·-Devç¯å¢ƒ\u0026#39;, \u0026#39;instance\u0026#39;: \u0026#39;192.168.82.105:9100\u0026#39;, \u0026#39;job\u0026#39;: \u0026#39;node_exporter\u0026#39;, \u0026#39;severity\u0026#39;: \u0026#39;éå¸¸ä¸¥é‡\u0026#39;, \u0026#39;team\u0026#39;: \u0026#39;ops\u0026#39; }, \u0026#39;annotations\u0026#39;: { \u0026#39;description\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å»¶æ—¶è¶…è¿‡5åˆ†é’Ÿ\u0026#39;, \u0026#39;summary\u0026#39;: \u0026#39;192.168.82.105:9100:æœåŠ¡å™¨å®•æœº\u0026#39; }, \u0026#39;endsAt\u0026#39;: end_time, }] jsons = json.dumps(new_packinf) url = \u0026#34;http://192.168.82.105:9093/api/v2/alerts\u0026#34; headers = {\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;} responses = requests.post(url=url, headers=headers, data=jsons) print(responses.status_code, responses.url) # print(responses.json()) é’‰é’‰å‘Šè­¦æ¨¡æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 {{ $var := .externalURL}}{{ range $k,$v:=.alerts }} {{if eq $v.status \u0026#34;resolved\u0026#34;}} #### [Prometheusæ¢å¤ä¿¡æ¯]({{$v.generatorURL}}) ##### \u0026lt;font color=\u0026#34;#02b340\u0026#34;\u0026gt;å‘Šè­¦åç§°\u0026lt;/font\u0026gt;ï¼š[{{$v.labels.alertname}}]({{$var}}) ##### \u0026lt;font color=\u0026#34;#02b340\u0026#34;\u0026gt;å‘Šè­¦çº§åˆ«\u0026lt;/font\u0026gt;ï¼š{{$v.labels.severity}} ##### \u0026lt;font color=\u0026#34;#02b340\u0026#34;\u0026gt;å¼€å§‹æ—¶é—´\u0026lt;/font\u0026gt;ï¼š{{TimeFormat $v.startsAt \u0026#34;2006-01-02 15:04:05\u0026#34;}} ##### \u0026lt;font color=\u0026#34;#02b340\u0026#34;\u0026gt;ç»“æŸæ—¶é—´\u0026lt;/font\u0026gt;ï¼š{{TimeFormat $v.endsAt \u0026#34;2006-01-02 15:04:05\u0026#34;}} ##### \u0026lt;font color=\u0026#34;#02b340\u0026#34;\u0026gt;å®ä¾‹åœ°å€\u0026lt;/font\u0026gt;ï¼š{{$v.labels.instance}} ##### \u0026lt;font color=\u0026#34;#02b340\u0026#34;\u0026gt;ä¸»æœºåç§°\u0026lt;/font\u0026gt;ï¼š{{$v.labels.hostname}} **{{$v.annotations.description}}** {{else}} #### [Prometheuså‘Šè­¦ä¿¡æ¯]({{$v.generatorURL}}) ##### \u0026lt;font color=\u0026#34;#FF0000\u0026#34;\u0026gt;å‘Šè­¦åç§°\u0026lt;/font\u0026gt;ï¼š[{{$v.labels.alertname}}]({{$var}}) ##### \u0026lt;font color=\u0026#34;#FF0000\u0026#34;\u0026gt;å‘Šè­¦çº§åˆ«\u0026lt;/font\u0026gt;ï¼š{{$v.labels.severity}} ##### \u0026lt;font color=\u0026#34;#FF0000\u0026#34;\u0026gt;å¼€å§‹æ—¶é—´\u0026lt;/font\u0026gt;ï¼š{{ TimeFormat $v.startsAt \u0026#34;2006-01-02 15:04:05\u0026#34;}} ##### \u0026lt;font color=\u0026#34;#FF0000\u0026#34;\u0026gt;ç»“æŸæ—¶é—´\u0026lt;/font\u0026gt;ï¼š{{TimeFormat $v.endsAt \u0026#34;2006-01-02 15:04:05\u0026#34;}} ##### \u0026lt;font color=\u0026#34;#FF0000\u0026#34;\u0026gt;å®ä¾‹åœ°å€\u0026lt;/font\u0026gt;ï¼š{{$v.labels.instance}} ##### \u0026lt;font color=\u0026#34;#FF0000\u0026#34;\u0026gt;ä¸»æœºåç§°\u0026lt;/font\u0026gt;ï¼š{{$v.labels.hostname}} **{{$v.annotations.description}}** {{end}} {{ end }} {{ $urimsg:=\u0026#34;\u0026#34;}}{{ range $key,$value:=.commonLabels }}{{$urimsg = print $urimsg $key \u0026#34;%3D%22\u0026#34; $value \u0026#34;%22%2C\u0026#34; }}{{end}}[*** ç‚¹æˆ‘å±è”½è¯¥å‘Šè­¦]({{$var}}/#/silences/new?filter=%7B{{SplitString $urimsg 0 -3}}%7D) ","date":"2022-07-05T14:28:36Z","image":"https://www.ownit.top/title_pic/75.jpg","permalink":"https://www.ownit.top/p/202207051428/","title":"Pythonç¼–å†™å‘Šè­¦ä¿¡æ¯ï¼Œæ•´åˆAlertmanagerå‘Šè­¦"},{"content":"Confluenceç›®å‰ç‰ˆæœ¬ Confluenceçš„æˆæƒä¿¡æ¯\nConfluence 6.9.3\nç‰ˆæƒå£°æ˜ï¼› 2003 - 2018 Atlassian è‚¡ä»½æœ‰é™å…¬å¸\nConfluenceæœ€æ–°ç‰ˆæœ¬ Confluence 7.13.7\nåœ°å€ï¼šhttps://www.atlassian.com/zh/software/confluence/download-archives\nå‡çº§ç‰ˆæœ¬é€‰æ‹© åŸ Confluence 6.9.3 åœ°å€ä¸‹è½½ï¼šhttps://product-downloads.atlassian.com/software/confluence/do\nwnloads/atlassian-confluence-6.9.3-x64.bin\næ–° Confluence 7.13.7 åœ°å€ä¸‹è½½ï¼šhttps://product-downloads.atlassian.com/software/confluence/d\nownloads/atlassian-confluence-7.13.7-x64.bin\næ•°æ®å¤‡ä»½ ç”Ÿäº§ç¯å¢ƒï¼š127.0.0.1\nç¨‹åºç›®å½•ï¼š/opt/atlassian\næ•°æ®ç›®å½•ï¼š/var/atlassian\næ•°æ®åº“ï¼šmysql 5.6\nmysqlæ•°æ®å¤‡ä»½ 1 2 3 cd /opt/mysql_backup mysqldump -uroot -hlocalhost -p confluence \u0026gt; confluence-20220616.sql scp confluence-20220616.sql ç›®æ ‡æœºå™¨ æ•°æ®è¿˜åŸ æ³¨æ„ï¼šæ•°æ®åº“å¿…é¡»ä½¿ç”¨root æ‰è¡Œï¼Œä¸ç„¶ä¼šæŠ¥ æ•°æ®åº“è§¦å‘å™¨å¤±è´¥çš„é”™è¯¯ï¼ˆé”™è¯¯å¦‚ä¸‹å›¾ï¼‰\n1 2 3 4 5 6 [root@localhost ~]# mysql -u root -p mysql\u0026gt; CREATE DATABASE IF NOT EXISTS confluence DEFAULT CHARSET utf8 COLLATE utf8_general_ci; mysql\u0026gt; use confluence; mysql\u0026gt; source /root/confluence-20220616.sql; #æ³¨æ„ï¼Œè¿™é‡Œéœ€è¦å†™å…¥confluence.sqlçš„ ç»å¯¹è·¯å¾„ ä¿®æ”¹Confluenceé…ç½®æ–‡ä»¶ä¸­æ•°æ®åº“è¿æ¥ä¸ºæ–°æ•°æ®åº“\n1 vi /var/atlassian/application-data/confluence/confluence.cfg.xml å¯åŠ¨Conflucence 1 2 3 4 5 6 æˆæƒ chown -R confluence:confluence /opt/atlassian chown -R confluence:confluence /var/atlassian åˆ‡æ¢ç”¨æˆ·å¯åŠ¨ su confluence /opt/atlassian/confluence/bin/startup.sh ç‰ˆæœ¬æ›´æ–°ï¼ˆ 7.13.7ï¼‰ 1 2 3 4 å¼€å§‹å‡çº§ [root@prometheus-server confluence]# ls atlassian-confluence-6.9.3-x64.bin atlassian-confluence-7.13.7-x64.bin [root@prometheus-server confluence]# ./atlassian-confluence-7.13.7-x64.bin è®¿é—®é¡µé¢ï¼ˆkeyå¤±æ•ˆï¼‰ è¿›è¡Œç ´è§£æ¢å¤Â æ³¨æ„ï¼šæ•°æ®åº“å¿…é¡»ä½¿ç”¨root æ‰è¡Œï¼Œä¸ç„¶ä¼šæŠ¥ æ•°æ®åº“è§¦å‘å™¨å¤±è´¥çš„é”™è¯¯\n1 2 3 vim confluence.cfg.xml æŸ¥è¯¢æ–°çš„server.id \u0026lt;property name=\u0026#34;confluence.setup.server.id\u0026#34;\u0026gt;BJ5V-W7UB-4PO5-2J39\u0026lt;/property\u0026gt; å¤‡ä»½jaråŒ…ç ´è§£ 1 2 sz /opt/atlassian/confluence/confluence/WEB-INF/lib/atlassian-extras-decoder-v2- 3.4.1.jar ç ´è§£å®Œæˆçš„åŒ… ä¸Šä¼ åˆ°å…¶ç›¸åº”ç›®å½• è¿›è¡Œé‡å¯Â 1 2 3 [root@prometheus-server ~]# mv atlassian-extras-decoder-v2-3.4.1.jar /opt/atlassian/confluence/confluence/WEB-INF/lib/ mv: overwrite â€˜/opt/atlassian/confluence/confluence/WEB-INF/lib/atlassian-extras-decoder-v2-3.4.1.jarâ€™? y æˆåŠŸæµ‹è¯• æ–°ç‰ˆæµ‹è¯•åœ°å€ï¼ˆhttp://127.0.0.1:8090/ï¼‰ è´¦å·å’Œå¯†ç  åŸæœ‰çš„å³å¯ç™»é™†\n","date":"2022-07-04T10:39:47Z","image":"https://www.ownit.top/title_pic/50.jpg","permalink":"https://www.ownit.top/p/202207041039/","title":"Confluenceå‡çº§æ–¹æ¡ˆ"},{"content":"\nå‰æ–‡ Jenkinså®‰è£…éƒ¨ç½²ä½¿ç”¨_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinså…¥é—¨é…ç½®_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinsé›†æˆSonar Qube_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinsçš„æµæ°´çº¿ï¼ˆPipelineï¼‰\nJenkinsæµæ°´çº¿æ•´åˆé’‰é’‰_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢Kuberneteså®‰è£…Jenkins_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nç›®å½•\n1ã€Kubernetes ç¯å¢ƒå®‰è£… Jenkins\n2ã€Jenkins å®‰è£…æ’ä»¶\n3ã€äº‘é…ç½®\n4ã€Template æ¨¡æ¿é…ç½®\n5ã€Jenkins-slave å¯åŠ¨æµ‹è¯•\n6ã€å®æˆ˜ç¯å¢ƒ\n7ã€è¿è¡Œç»“æœ\n1ã€Kubernetes ç¯å¢ƒå®‰è£… Jenkins https://blog.csdn.net/heian_99/article/details/124985786\n2ã€Jenkins å®‰è£…æ’ä»¶ 1 2 3 4 5 6 7 8 9 10 æ’ä»¶: kubernets pipeline docker pipeline docker Kubernetes Cli Config File Provider Pipeline Utility Steps Jenkinsæºï¼šhttps://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json 3ã€äº‘é…ç½® Dashboard \u0026gt; ç³»ç»Ÿç®¡ç† \u0026gt; èŠ‚ç‚¹ç®¡ç† \u0026gt; configureClouds\nå‚è€ƒï¼šhttps://github.com/jenkinsci/kubernetes-plugin\nè¿™é‡Œæ˜¯é…ç½®è¿æ¥Kubernetesé›†ç¾¤ï¼Œå¯åŠ¨ Jenkins Slave ä»£ç†çš„ç›¸å…³é…ç½®ã€‚\nåç§°ï¼šÂ kubernetes Kubernetes åœ°å€ï¼šÂ kubernetes.default.svc.cluster.localÂ (é»˜è®¤é›†ç¾¤å†…è°ƒç”¨ k8s api åœ°å€) ç¦ç”¨ HTTPS è¯ä¹¦æ£€æŸ¥ï¼šÂ å‹¾é€‰ (ä¸éªŒè¯https) å‡­æ®ï¼šÂ æ–°å¢å‡­æ®â€”\u0026gt;Secret textâ€”\u0026gt;Secret è®¾ç½® kubernetes çš„ Token (è¿›å…¥ k8s dashboard çš„ token ç­‰éƒ½è¡Œ) Jenkinsåœ°å€ï¼šÂ jenkins.mydlqcloud:8080/jenkinsÂ (ç”¨äºä»£ç†ä¸ Jenkins è¿æ¥çš„åœ°å€ï¼Œç”¨çš„æ˜¯ k8s é›†ç¾¤ä¸­ jenkins æœåŠ¡çš„åœ°å€ä¸ºâ€œhttp://jenkinsæœåŠ¡å.jenkinsæ‰€åœ¨namespace:jenkinsç«¯å£å·/jenkinsåç¼€â€) å…¶ä»–ï¼šÂ é»˜è®¤å³å¯ 4ã€Template æ¨¡æ¿é…ç½® è¿™é‡Œé…ç½® Jenkins Slave åœ¨ kubernetes é›†ç¾¤ä¸­å¯åŠ¨çš„ Pod çš„é…ç½®ï¼Œè¿™é‡Œå°†è®¾ç½®å››ä¸ªé•œåƒï¼Œåˆ†åˆ«æ˜¯ï¼š\nJenkins Slaveï¼šÂ ç”¨äºæ‰§è¡Œ Jenkins Job å‘½ä»¤ã€‚ Helm-Kubectlï¼šÂ ç”¨äºæ‰§è¡Œ Helm å‘½ä»¤ã€‚ DockerÂ ç”¨äºç¼–è¯‘ã€æ¨é€ Docker é•œåƒ Mavenï¼šÂ ç”¨äºMavenç¼–è¯‘ã€æ‰“åŒ…ã€‚ è¿™é‡Œå°†è¿™å››ä¸ªé•œåƒèå…¥åˆ°ä¸€ä¸ª Pod ä¹‹ä¸­ï¼Œæ–¹ä¾¿æ‰§è¡Œå„ç§å‘½ä»¤æ¥å®ŒæˆæŒç»­éƒ¨ç½²äº¤äº’è¿‡ç¨‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 [root@master01 Jenkins]# cat maven.yaml apiVersion: v1 kind: PersistentVolumeClaim metadata: name: maven-pvc namespace: jenkins spec: storageClassName: \u0026#34;nfsdata\u0026#34; accessModes: - ReadWriteMany resources: requests: storage: 10Gi 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 Kubernetesåœ°å€ï¼šhttps://kubernetes.default.svc.cluster.local/ Jenkins-masterï¼šhttp://jenkins.jenkins.svc.cluster.local:8080 Jenkins-slaveï¼šjenkins.jenkins.svc.cluster.local:50000 jnlp-slave cnych/jenkins:jnlp6 maven maven:3.8.5-openjdk-8-slim docker registry.cn-shanghai.aliyuncs.com/mydlq/docker:18.06.2-dind helm-kubectl registry.cn-shanghai.aliyuncs.com/mydlq/helm-kubectl:2.13.1 /var/run/docker.sock /usr/bin/docker /etc/docker æ³¨æ„ï¼šdockeréœ€è¦å¡«å†™sleep\n5ã€Jenkins-slave å¯åŠ¨æµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 def label = \u0026#34;jnlp-slave\u0026#34; podTemplate(label: label,cloud: \u0026#39;kubernetes\u0026#39; ){ node (label) { stage(\u0026#39;Gité˜¶æ®µ\u0026#39;){ echo \u0026#34;1ã€å¼€å§‹æ‹‰å–ä»£ç \u0026#34; sh \u0026#34;git version\u0026#34; } stage(\u0026#39;Mavené˜¶æ®µ\u0026#39;){ container(\u0026#39;maven\u0026#39;) { echo \u0026#34;2ã€å¼€å§‹Mavenç¼–è¯‘ã€æ¨é€åˆ°æœ¬åœ°åº“\u0026#34; sh \u0026#34;mvn -version\u0026#34; } } stage(\u0026#39;Dockeré˜¶æ®µ\u0026#39;){ container(\u0026#39;docker\u0026#39;) { echo \u0026#34;3ã€å¼€å§‹è¯»å–Maven pomå˜é‡ï¼Œå¹¶æ‰§è¡ŒDockerç¼–è¯‘ã€æ¨é€ã€åˆ é™¤\u0026#34; sh \u0026#34;docker version\u0026#34; } } stage(\u0026#39;Helmé˜¶æ®µ\u0026#39;){ container(\u0026#39;helm-kubectl\u0026#39;) { echo \u0026#34;4ã€å¼€å§‹æ£€æµ‹Kubectlç¯å¢ƒï¼Œæµ‹è¯•æ‰§è¡ŒHelméƒ¨ç½²ï¼Œä¸æ‰§è¡Œéƒ¨ç½²\u0026#34; sh \u0026#34;helm version\u0026#34; } } } } 6ã€å®æˆ˜ç¯å¢ƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 pipeline { agent { label \u0026#39;jnlp-slave\u0026#39; } // å­˜æ”¾æ‰€æœ‰ä»»åŠ¡çš„åˆé›† stages { stage(\u0026#39;æ‹‰å–Gitä»£ç \u0026#39;) { steps { echo \u0026#39;æ‹‰å–Gitä»£ç \u0026#39; sh \u0026#39;git clone https://gitee.com/chengfeng99/java-demo.git\u0026#39; } } stage(\u0026#39;æ£€æµ‹ä»£ç è´¨é‡\u0026#39;) { steps { echo \u0026#39;æ£€æµ‹ä»£ç è´¨é‡\u0026#39; withSonarQubeEnv(\u0026#39;sonarqube\u0026#39;) { // Will pick the global server connection you have configured // è¿™é‡Œä½¿ç”¨åå­—å«åšmavençš„å®¹å™¨è¿è¡Œ container(\u0026#34;maven\u0026#34;) { sh \u0026#39;\u0026#39;\u0026#39; cd /home/jenkins/agent/workspace/k8s-demo/java-demo mvn sonar:sonar -Dsonar.projectname=${JOB_NAME} -Dsonar.projectKey=${JOB_NAME} -Dsonar.java.binaries=target/ -Dsonar.login=19d0d6b885e18455d257d61da08776bd4e180c04 \u0026#39;\u0026#39;\u0026#39; } } } } stage(\u0026#39;æ„å»ºä»£ç \u0026#39;) { steps { echo \u0026#39;æ„å»ºä»£ç \u0026#39; container(\u0026#39;maven\u0026#39;) { sh \u0026#39;\u0026#39;\u0026#39; cd /home/jenkins/agent/workspace/k8s-demo/java-demo mvn clean package -Dmaven.test.skip=true \u0026#39;\u0026#39;\u0026#39; //æ‰“åŒ…è·³è¿‡æµ‹è¯• } } } stage(\u0026#39;åˆ¶ä½œè‡ªå®šä¹‰é•œåƒå¹¶å‘å¸ƒHarbor\u0026#39;) { steps { echo \u0026#39;åˆ¶ä½œè‡ªå®šä¹‰é•œåƒå¹¶å‘å¸ƒHarbor\u0026#39; } } stage(\u0026#39;åŸºäºHarboréƒ¨ç½²å·¥ç¨‹\u0026#39;) { steps { echo \u0026#39;åŸºäºHarboréƒ¨ç½²å·¥ç¨‹\u0026#39; } } } } 7ã€è¿è¡Œç»“æœ ","date":"2022-05-26T18:26:46Z","image":"https://www.ownit.top/title_pic/70.jpg","permalink":"https://www.ownit.top/p/202205261826/","title":"Jenkinsé›†æˆKubernetesé›†ç¾¤"},{"content":"å‰æ–‡ Jenkinså®‰è£…éƒ¨ç½²ä½¿ç”¨_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinså…¥é—¨é…ç½®_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinsé›†æˆSonar Qube_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinsçš„æµæ°´çº¿ï¼ˆPipelineï¼‰\nJenkinsæµæ°´çº¿æ•´åˆé’‰é’‰_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢Â ç›®å½•\nç¯å¢ƒ\næ€è·¯\n1ã€NFSï¼ˆåŠ¨æ€å­˜å‚¨ï¼‰\n2ã€helmå®‰è£…nfs-client\n3ã€åˆ›å»ºnamespaceÂ 4ã€æŒä¹…åŒ–Jenkinsæ•°æ®\n5ã€åˆ›å»ºservice account\n6ã€å®‰è£…Jenkins\n7ã€æˆæƒå¯¹JenkinsæœåŠ¡çš„è®¿é—®æƒé™\n8ã€æ‰“å¼€æµè§ˆå™¨IP:31400/\nç¯å¢ƒ ç”Ÿäº§å®è·µ-k8så®‰è£…Jenkinså’ŒJenkins Kubernetesæ’ä»¶\nç¯å¢ƒè¦æ±‚ï¼šä½ éœ€è¦ä¸€ä¸ªæ­£å¸¸å¯ä»¥ä½¿ç”¨çš„Kubernetesé›†ç¾¤ï¼Œé›†ç¾¤ä¸­å¯ä»¥ä½¿ç”¨çš„å†…å­˜å¤§äºç­‰äº4Gã€‚\nKubernetesç‰ˆæœ¬1.18\næ€è·¯ Jenkinsæ’ä»¶å¯ä»¥åœ¨Kubernetesé›†ç¾¤ä¸­è¿è¡ŒåŠ¨æ€jenkins-slaveä»£ç†ã€‚\nåŸºäºKubernetesçš„dockerï¼Œè‡ªåŠ¨åŒ–åœ¨Kubernetesä¸­è¿è¡Œçš„Jenkins-slaveä»£ç†çš„ç¼©æ”¾ã€‚\nè¯¥æ’ä»¶ä¸ºæ¯ä¸ªjenkins-slaveä»£ç†åˆ›å»ºKubernetes Podï¼Œå¹¶åœ¨æ¯ä¸ªæ„å»ºååœæ­¢å®ƒã€‚\nåœ¨Kubernetesä¸­jenkins-slaveä»£ç†å¯åŠ¨ï¼Œä¼šè‡ªåŠ¨è¿æ¥åˆ°Jenkinsä¸»æ§åˆ¶å™¨ã€‚ å¯¹äºæŸäº›ç¯å¢ƒå˜é‡ï¼Œä¼šè‡ªåŠ¨æ³¨å…¥ï¼š\nJenkins_URLï¼šJenkins Webç•Œé¢URL\njenkins_secretï¼šèº«ä»½éªŒè¯çš„ç§˜å¯†å¯†é’¥\njenkins_agent_nameï¼šjenkinsä»£ç†çš„åç§°\njenkins_nameï¼šjenkinsä»£ç†çš„åç§°ï¼ˆå·²å¼ƒç”¨ã€‚ä»…ç”¨äºå‘åå…¼å®¹æ€§ï¼‰\nä¸éœ€è¦åœ¨Kuberneteså†…è¿è¡ŒJenkins Controllerã€‚\n1ã€NFSï¼ˆåŠ¨æ€å­˜å‚¨ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #å®‰è£… yum install -y nfs-utils rpcbind mkdir -p /data/nfsdata # ä¿®æ”¹é…ç½® $ vim /etc/exports /data/nfsdata 192.168.31.* (rw,async,no_root_squash) # ä½¿é…ç½®ç”Ÿæ•ˆ $ exportfs -r # æœåŠ¡ç«¯æŸ¥çœ‹ä¸‹æ˜¯å¦ç”Ÿæ•ˆ $ showmount -e localhost Export list for localhost: /data/nfsdata (everyone) 2ã€helmå®‰è£…nfs-client 1 2 stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts helmæ·»åŠ è¿™ä¸ªæº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ä¸‹è½½helmåŒ… helm pull aliyuncs/nfs-client-provisioner è§£å‹ tar -zxvf nfs-client-provisioner-1.2.8.tgz ä¿®å¤values.yaml ä¸‰å¤„ image: repository: quay.io/external_storage/nfs-client-provisioner tag: v3.1.0-k8s1.11 pullPolicy: IfNotPresent nfs: server: 192.168.31.73 path: /data/nfsdata reclaimPolicy: Retain 3ã€åˆ›å»ºnamespaceÂ 1 2 kubectl create namespace jenkins kubectl get namespaces 4ã€æŒä¹…åŒ–Jenkinsæ•°æ® pvc.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: v1 kind: PersistentVolumeClaim metadata: name: jenkins-pvc namespace: jenkins spec: storageClassName: \u0026#34;nfsdata\u0026#34; accessModes: - ReadWriteMany resources: requests: storage: 10Gi é€šè¿‡kubectléƒ¨ç½²volume\n1 kubectl apply -f pvc.yaml 5ã€åˆ›å»ºservice account åˆ›å»ºpodæ—¶ï¼Œå¦‚æœä¸æŒ‡å®šæœåŠ¡è´¦æˆ·ï¼Œåˆ™ä¼šè‡ªåŠ¨ä¸ºå…¶åˆ†é…ä¸€ä¸ªåä¸ºdefaultçš„åŒä¸€namespaceä¸­çš„æœåŠ¡è´¦æˆ·ã€‚ä½†æ˜¯é€šå¸¸åº”ç”¨ç¨‹åºæ—¶å­˜åœ¨æƒé™ä¸è¶³çš„æƒ…å†µï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è‡ªå·±åˆ›å»ºä¸€ä¸ªæœåŠ¡è´¦æˆ·ã€‚\nâ‘ ä¸‹è½½jenkins-sa.yaml\n1 wget https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-sa.yaml â‘¡é€šè¿‡kubectléƒ¨ç½²jenkins-sa.yaml\n1 kubectl apply -f jenkins-sa.yaml æˆ–è€…ä½¿ç”¨ä¸‹é¢çš„æ–‡ä»¶\njenkins-sa.yamlÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 --- apiVersion: v1 kind: ServiceAccount metadata: name: jenkins namespace: jenkins --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \u0026#34;true\u0026#34; labels: kubernetes.io/bootstrapping: rbac-defaults name: jenkins rules: - apiGroups: - \u0026#39;*\u0026#39; resources: - statefulsets - services - replicationcontrollers - replicasets - podtemplates - podsecuritypolicies - pods - pods/log - pods/exec - podpreset - poddisruptionbudget - persistentvolumes - persistentvolumeclaims - jobs - endpoints - deployments - deployments/scale - daemonsets - cronjobs - configmaps - namespaces - events - secrets verbs: - create - get - watch - delete - list - patch - update - apiGroups: - \u0026#34;\u0026#34; resources: - nodes verbs: - get - list - watch - update --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \u0026#34;true\u0026#34; labels: kubernetes.io/bootstrapping: rbac-defaults name: jenkins roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: jenkins subjects: - apiGroup: rbac.authorization.k8s.io kind: Group name: system:serviceaccounts:jenkins 6ã€å®‰è£…Jenkins jenkins-deployment.yamlÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 apiVersion: apps/v1 kind: Deployment metadata: name: jenkins namespace: jenkins spec: replicas: 1 selector: matchLabels: app: jenkins template: metadata: labels: app: jenkins spec: serviceAccountName: jenkins #æŒ‡å®šæˆ‘ä»¬å‰é¢åˆ›å»ºçš„æœåŠ¡è´¦å· containers: - name: jenkins image: registry.cn-hangzhou.aliyuncs.com/s-ops/jenkins:2.346 ports: - containerPort: 8080 - containerPort: 50000 volumeMounts: - name: jenkins-home mountPath: /var/jenkins_home volumes: - name: jenkins-home persistentVolumeClaim: claimName: jenkins-pvc #æŒ‡å®šå‰é¢åˆ›å»ºçš„PVC é€šè¿‡kubectléƒ¨ç½²jenkins-deployment.yaml\n1 kubectl create -f jenkins-deployment.yaml -n jenkins 7ã€æˆæƒå¯¹JenkinsæœåŠ¡çš„è®¿é—®æƒé™ ä¸»è¦ç›®çš„æš´éœ²å¤–éƒ¨è®¿é—®Jenkinsçš„8080ç«¯å£ï¼Œæˆ‘å°†31400å®šä¹‰ä¸º8080çš„æ˜ å°„ç«¯å£ã€‚\njenkins-service.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 kind: Service metadata: name: jenkins namespace: jenkins spec: type: NodePort ports: - name: http port: 8080 targetPort: 8080 nodePort: 31400 - name: agent port: 50000 targetPort: 50000 nodePort: 31401 selector: app: jenkins é€šè¿‡kubectléƒ¨ç½²æœåŠ¡\n1 kubectl create -f jenkins-service.yaml -n jenkins 8ã€æ‰“å¼€æµè§ˆå™¨IP:31400/ æŸ¥çœ‹å¯†ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 kubectl get pod -n jenkins //æŸ¥è¯¢podname kubectl logs podname -n jenkins ************************************************************* Jenkins initial setup is required. An admin user has been created and a password generated. Please use the following password to proceed to installation: cf8d9da9de0346fd90461be366915d76 This may also be found at: /var/jenkins_home/secrets/initialAdminPassword ************************************************************* é€‰æ‹©æ¨èæ’ä»¶å®‰è£…ï¼Œåˆ›å»ºç®¡ç†å‘˜~å®Œæˆï¼\n","date":"2022-05-26T15:48:35Z","image":"https://www.ownit.top/title_pic/20.jpg","permalink":"https://www.ownit.top/p/202205261548/","title":"Kuberneteså®‰è£…Jenkins"},{"content":"å‰æ–‡ Jenkinså®‰è£…éƒ¨ç½²ä½¿ç”¨_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinså…¥é—¨é…ç½®_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinsé›†æˆSonar Qube_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinsçš„æµæ°´çº¿ï¼ˆPipelineï¼‰\nåœ¨ç¨‹åºéƒ¨ç½²æˆåŠŸåï¼Œå¯ä»¥é€šè¿‡é’‰é’‰çš„æœºå™¨äººåŠæ—¶å‘ç¾¤ä¼—å‘é€éƒ¨ç½²çš„æœ€ç»ˆç»“æœé€šçŸ¥\nå®‰è£…æ’ä»¶ é’‰é’‰å†…éƒ¨åˆ›å»ºç¾¤ç»„å¹¶æ„å»ºæœºå™¨äºº\næœ€ç»ˆæˆ–è·å–åˆ°Webhookä¿¡æ¯\n1 https://oapi.dingtalk.com/robot/send?access_token=kej4ehkj34gjhg34jh5bh5jb34hj53b4 ç³»ç»Ÿé…ç½®æ·»åŠ é’‰é’‰é€šçŸ¥\nä»»åŠ¡ä¸­è¿½åŠ æµæ°´çº¿é…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 pipeline { agent any environment{ harborRepo = \u0026#39;heianapp\u0026#39; harborUser = \u0026#39;heian99\u0026#39; harborPasswd = \u0026#39;NG+.mK4M-(s4CYX\u0026#39; } // å­˜æ”¾æ‰€æœ‰ä»»åŠ¡çš„åˆé›† stages { stage(\u0026#39;æ‹‰å–Gitä»£ç \u0026#39;) { steps { echo \u0026#39;æ‹‰å–Gitä»£ç \u0026#39; checkout([$class: \u0026#39;GitSCM\u0026#39;, branches: [[name: \u0026#39;${tag}\u0026#39;]], extensions: [], userRemoteConfigs: [[url: \u0026#39;https://gitee.com/chengfeng99/java-demo.git\u0026#39;]]]) } } stage(\u0026#39;æ£€æµ‹ä»£ç è´¨é‡\u0026#39;) { steps { echo \u0026#39;æ£€æµ‹ä»£ç è´¨é‡\u0026#39; sh \u0026#39;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=${JOB_NAME} -Dsonar.projectKey=${JOB_NAME} -Dsonar.java.binaries=target/ -Dsonar.login=19d0d6b885e18455d257d61da08776bd4e180c04\u0026#39; } } stage(\u0026#39;æ„å»ºä»£ç \u0026#39;) { steps { echo \u0026#39;æ„å»ºä»£ç \u0026#39; sh \u0026#39;/var/jenkins_home/maven/bin/mvn clean package -DskipTests\u0026#39; } } stage(\u0026#39;åˆ¶ä½œè‡ªå®šä¹‰é•œåƒå¹¶å‘å¸ƒHarbor\u0026#39;) { steps { echo \u0026#39;åˆ¶ä½œè‡ªå®šä¹‰é•œåƒå¹¶å‘å¸ƒHarbor\u0026#39; sh \u0026#39;\u0026#39;\u0026#39; cp ./target/*.jar ./docker/demo.jar cd ./docker docker build -t ${JOB_NAME}:${BUILD_NUMBER} . \u0026#39;\u0026#39;\u0026#39; sh \u0026#39;\u0026#39;\u0026#39;docker login -u ${harborUser} -p ${harborPasswd} docker tag ${JOB_NAME}:${BUILD_NUMBER} ${harborUser}/${harborRepo}:${JOB_NAME}_${BUILD_NUMBER} docker push ${harborUser}/${harborRepo}:${JOB_NAME}_${BUILD_NUMBER}\u0026#39;\u0026#39;\u0026#39; } } stage(\u0026#39;åŸºäºHarboréƒ¨ç½²å·¥ç¨‹\u0026#39;) { steps { echo \u0026#39;åŸºäºHarboréƒ¨ç½²å·¥ç¨‹\u0026#39; sshPublisher(publishers: [sshPublisherDesc(configName: \u0026#39;node-Linux32\u0026#39;, transfers: [sshTransfer(cleanRemote: false, excludes: \u0026#39;\u0026#39;, execCommand: \u0026#39;\u0026#39;\u0026#39;cd /opt/java/ echo \u0026#34;æµ‹è¯•æˆåŠŸ\u0026#34; \u0026gt;\u0026gt; log.txt date \u0026gt;\u0026gt; log.txt\u0026#39;\u0026#39;\u0026#39;, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: \u0026#39;[, ]+\u0026#39;, remoteDirectory: \u0026#39;\u0026#39;, remoteDirectorySDF: false, removePrefix: \u0026#39;\u0026#39;, sourceFiles: \u0026#39;target/*.jar,docker/*\u0026#39;)], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)]) } } } post { success { dingtalk ( robot: \u0026#39;Jenkins-DingDing\u0026#39;, type:\u0026#39;MARKDOWN\u0026#39;, title: \u0026#34;success: ${JOB_NAME}\u0026#34;, text: [\u0026#34;- æˆåŠŸæ„å»º:${JOB_NAME}é¡¹ç›®!\\n- ç‰ˆæœ¬:${tag}\\n- æŒç»­æ—¶é—´:${currentBuild.durationString}\\n- ä»»åŠ¡:#${JOB_NAME}\u0026#34;] ) } failure { dingtalk ( robot: \u0026#39;Jenkins-DingDing\u0026#39;, type:\u0026#39;MARKDOWN\u0026#39;, title: \u0026#34;fail: ${JOB_NAME}\u0026#34;, text: [\u0026#34;- å¤±è´¥æ„å»º:${JOB_NAME}é¡¹ç›®!\\n- ç‰ˆæœ¬:${tag}\\n- æŒç»­æ—¶é—´:${currentBuild.durationString}\\n- ä»»åŠ¡:#${JOB_NAME}\u0026#34;] ) } } } æŸ¥çœ‹æ•ˆæœ\n","date":"2022-05-17T10:58:10Z","image":"https://www.ownit.top/title_pic/52.jpg","permalink":"https://www.ownit.top/p/202205171058/","title":"Jenkinsæµæ°´çº¿æ•´åˆé’‰é’‰"},{"content":"ç›®å½• Jenkinså®‰è£…éƒ¨ç½²ä½¿ç”¨_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinså…¥é—¨é…ç½®_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinsé›†æˆSonar Qube_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinsæµæ°´çº¿ Jenkinsæµæ°´çº¿ä»»åŠ¡ä»‹ç» ä¹‹å‰é‡‡ç”¨Jenkinsçš„è‡ªç”±é£æ ¼æ„å»ºçš„é¡¹ç›®ï¼Œæ¯ä¸ªæ­¥éª¤æµç¨‹éƒ½è¦é€šè¿‡ä¸åŒçš„æ–¹å¼è®¾ç½®ï¼Œå¹¶ä¸”æ„å»ºè¿‡ç¨‹ä¸­æ•´ä½“æµç¨‹æ˜¯ä¸å¯è§çš„ï¼Œæ— æ³•ç¡®è®¤æ¯ä¸ªæµç¨‹èŠ±è´¹çš„æ—¶é—´ï¼Œå¹¶ä¸”é—®é¢˜ä¸æ–¹ä¾¿å®šä½é—®é¢˜ã€‚\nJenkinsçš„Pipelineå¯ä»¥è®©é¡¹ç›®çš„å‘å¸ƒæ•´ä½“æµç¨‹å¯è§†åŒ–ï¼Œæ˜ç¡®æ‰§è¡Œçš„é˜¶æ®µï¼Œå¯ä»¥å¿«é€Ÿçš„å®šä½é—®é¢˜ã€‚å¹¶ä¸”æ•´ä¸ªé¡¹ç›®çš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥é€šè¿‡ä¸€ä¸ªJenkinsfileæ–‡ä»¶ç®¡ç†ï¼Œè€Œä¸”Jenkinsfileæ–‡ä»¶æ˜¯å¯ä»¥æ”¾åœ¨é¡¹ç›®ä¸­ç»´æŠ¤ã€‚\næ‰€ä»¥Pipelineç›¸å¯¹è‡ªç”±é£æ ¼æˆ–è€…å…¶ä»–çš„é¡¹ç›®é£æ ¼æ›´å®¹æ˜“æ“ä½œã€‚\nJenkinsæµæ°´çº¿ä»»åŠ¡ æ„å»ºJenkinsæµæ°´çº¿ä»»åŠ¡ æ„å»ºä»»åŠ¡\nç”ŸæˆGroovyè„šæœ¬\nHello Worldè„šæœ¬ç”Ÿæˆ\næ„å»ºåæŸ¥çœ‹è§†å›¾\nGroovyè„šæœ¬ Groovyè„šæœ¬åŸºç¡€è¯­æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // æ‰€æœ‰è„šæœ¬å‘½ä»¤åŒ…å«åœ¨pipeline{}ä¸­ pipeline { // æŒ‡å®šä»»åŠ¡åœ¨å“ªä¸ªèŠ‚ç‚¹æ‰§è¡Œï¼ˆJenkinsæ”¯æŒåˆ†å¸ƒå¼ï¼‰ agent any // é…ç½®å…¨å±€ç¯å¢ƒï¼ŒæŒ‡å®šå˜é‡å=å˜é‡å€¼ä¿¡æ¯ environment{ host = \u0026#39;172.17.1.22\u0026#39; } // å­˜æ”¾æ‰€æœ‰ä»»åŠ¡çš„åˆé›† stages { // å•ä¸ªä»»åŠ¡ stage(\u0026#39;ä»»åŠ¡1\u0026#39;) { // å®ç°ä»»åŠ¡çš„å…·ä½“æµç¨‹ steps { echo \u0026#39;do something\u0026#39; } } // å•ä¸ªä»»åŠ¡ stage(\u0026#39;ä»»åŠ¡2\u0026#39;) { // å®ç°ä»»åŠ¡çš„å…·ä½“æµç¨‹ steps { echo \u0026#39;do something\u0026#39; } } // â€¦â€¦ } } ç¼–å†™ä¾‹å­æµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 pipeline { agent any // å­˜æ”¾æ‰€æœ‰ä»»åŠ¡çš„åˆé›† stages { stage(\u0026#39;æ‹‰å–Gitä»£ç \u0026#39;) { steps { echo \u0026#39;æ‹‰å–Gitä»£ç \u0026#39; } } stage(\u0026#39;æ£€æµ‹ä»£ç è´¨é‡\u0026#39;) { steps { echo \u0026#39;æ£€æµ‹ä»£ç è´¨é‡\u0026#39; } } stage(\u0026#39;æ„å»ºä»£ç \u0026#39;) { steps { echo \u0026#39;æ„å»ºä»£ç \u0026#39; } } stage(\u0026#39;åˆ¶ä½œè‡ªå®šä¹‰é•œåƒå¹¶å‘å¸ƒHarbor\u0026#39;) { steps { echo \u0026#39;åˆ¶ä½œè‡ªå®šä¹‰é•œåƒå¹¶å‘å¸ƒHarbor\u0026#39; } } stage(\u0026#39;åŸºäºHarboréƒ¨ç½²å·¥ç¨‹\u0026#39;) { steps { echo \u0026#39;åŸºäºHarboréƒ¨ç½²å·¥ç¨‹\u0026#39; } } } } é…ç½®Grovvyè„šæœ¬\næŸ¥çœ‹æ•ˆæœ\nPsï¼šæ¶‰åŠåˆ°ç‰¹å®šè„šæœ¬ï¼ŒJenkinsç»™äºˆäº†å……è¶³çš„æç¤ºï¼Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆå‘½ä»¤\nç”Ÿæˆå‘½ä»¤ä½ç½®\nJenkinsfileå®ç° Jenkinsfileæ–¹å¼éœ€è¦å°†è„šæœ¬å†…å®¹ç¼–å†™åˆ°é¡¹ç›®ä¸­çš„Jenkinsfileæ–‡ä»¶ä¸­ï¼Œæ¯æ¬¡æ„å»ºä¼šè‡ªåŠ¨æ‹‰å–é¡¹ç›®å¹¶ä¸”è·å–é¡¹ç›®ä¸­Jenkinsfileæ–‡ä»¶å¯¹é¡¹ç›®è¿›è¡Œæ„å»º\né…ç½®pipeline\nå‡†å¤‡Jenkinsfile\nJenkinsfile Â· å—å®«ä¹˜é£/java-demo - Gitee.com\næµ‹è¯•æ•ˆæœ\nJenkinsæµæ°´çº¿ä»»åŠ¡å®ç° å‚æ•°åŒ–æ„å»º\næ·»åŠ å‚æ•°åŒ–æ„å»ºï¼Œæ–¹ä¾¿é€‰æ‹©ä¸çš„é¡¹ç›®ç‰ˆæœ¬\næ‹‰å–Gitä»£ç \né€šè¿‡æµæ°´çº¿è¯­æ³•ç”ŸæˆCheckoutä»£ç çš„è„šæœ¬\nå°†*/masteræ›´æ”¹ä¸ºæ ‡ç­¾${tag}\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 pipeline { agent any environment{ harborRepo = \u0026#39;heianapp\u0026#39; harborUser = \u0026#39;heian99\u0026#39; harborPasswd = \u0026#39;NG+.mK4M-(s4CYX\u0026#39; } // å­˜æ”¾æ‰€æœ‰ä»»åŠ¡çš„åˆé›† stages { stage(\u0026#39;æ‹‰å–Gitä»£ç \u0026#39;) { steps { echo \u0026#39;æ‹‰å–Gitä»£ç \u0026#39; checkout([$class: \u0026#39;GitSCM\u0026#39;, branches: [[name: \u0026#39;${tag}\u0026#39;]], extensions: [], userRemoteConfigs: [[url: \u0026#39;https://gitee.com/chengfeng99/java-demo.git\u0026#39;]]]) } } stage(\u0026#39;æ£€æµ‹ä»£ç è´¨é‡\u0026#39;) { steps { echo \u0026#39;æ£€æµ‹ä»£ç è´¨é‡\u0026#39; sh \u0026#39;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=${JOB_NAME} -Dsonar.projectKey=${JOB_NAME} -Dsonar.java.binaries=target/ -Dsonar.login=19d0d6b885e18455d257d61da08776bd4e180c04\u0026#39; } } stage(\u0026#39;æ„å»ºä»£ç \u0026#39;) { steps { echo \u0026#39;æ„å»ºä»£ç \u0026#39; sh \u0026#39;/var/jenkins_home/maven/bin/mvn clean package -DskipTests\u0026#39; } } stage(\u0026#39;åˆ¶ä½œè‡ªå®šä¹‰é•œåƒå¹¶å‘å¸ƒHarbor\u0026#39;) { steps { echo \u0026#39;åˆ¶ä½œè‡ªå®šä¹‰é•œåƒå¹¶å‘å¸ƒHarbor\u0026#39; sh \u0026#39;\u0026#39;\u0026#39; cp ./target/*.jar ./docker/demo.jar cd ./docker docker build -t ${JOB_NAME}:${BUILD_NUMBER} . \u0026#39;\u0026#39;\u0026#39; sh \u0026#39;\u0026#39;\u0026#39;docker login -u ${harborUser} -p ${harborPasswd} docker tag ${JOB_NAME}:${BUILD_NUMBER} ${harborUser}/${harborRepo}:${JOB_NAME}_${BUILD_NUMBER} docker push ${harborUser}/${harborRepo}:${JOB_NAME}_${BUILD_NUMBER}\u0026#39;\u0026#39;\u0026#39; } } stage(\u0026#39;åŸºäºHarboréƒ¨ç½²å·¥ç¨‹\u0026#39;) { steps { echo \u0026#39;åŸºäºHarboréƒ¨ç½²å·¥ç¨‹\u0026#39; sshPublisher(publishers: [sshPublisherDesc(configName: \u0026#39;node-Linux32\u0026#39;, transfers: [sshTransfer(cleanRemote: false, excludes: \u0026#39;\u0026#39;, execCommand: \u0026#39;\u0026#39;\u0026#39;cd /opt/java/ echo \u0026#34;æµ‹è¯•æˆåŠŸ\u0026#34; \u0026gt;\u0026gt; log.txt date \u0026gt;\u0026gt; log.txt\u0026#39;\u0026#39;\u0026#39;, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: \u0026#39;[, ]+\u0026#39;, remoteDirectory: \u0026#39;\u0026#39;, remoteDirectorySDF: false, removePrefix: \u0026#39;\u0026#39;, sourceFiles: \u0026#39;target/*.jar,docker/*\u0026#39;)], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)]) } } } } Psï¼šç”±äºé‡‡ç”¨å˜é‡ï¼Œè®°å¾—ä½¿ç”¨åŒå¼•å·\nè¿›è¡Œæ„å»º\nå·²ç»æˆåŠŸ\n","date":"2022-05-17T10:32:21Z","image":"https://www.ownit.top/title_pic/26.jpg","permalink":"https://www.ownit.top/p/202205171032/","title":"Jenkinsçš„æµæ°´çº¿ï¼ˆPipelineï¼‰"},{"content":"å‰æ–‡ç›®å½• Jenkinså®‰è£…éƒ¨ç½²ä½¿ç”¨_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nJenkinså…¥é—¨é…ç½®_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nSonar Qubeä»‹ç» Sonar Qubeæ˜¯ä¸€ä¸ªå¼€æºçš„ä»£ç åˆ†æå¹³å°ï¼Œæ”¯æŒJavaã€Pythonã€PHPã€JavaScriptã€CSSç­‰25ç§ä»¥ä¸Šçš„è¯­è¨€ï¼Œå¯ä»¥æ£€æµ‹å‡ºé‡å¤ä»£ç ã€ä»£ç æ¼æ´ã€ä»£ç è§„èŒƒå’Œå®‰å…¨æ€§æ¼æ´çš„é—®é¢˜ã€‚\nSonar Qubeå¯ä»¥ä¸å¤šç§è½¯ä»¶æ•´åˆè¿›è¡Œä»£ç æ‰«æï¼Œæ¯”å¦‚Mavenï¼ŒGradleï¼ŒGitï¼ŒJenkinsç­‰ï¼Œå¹¶ä¸”ä¼šå°†ä»£ç æ£€æµ‹ç»“æœæ¨é€å›Sonar Qubeå¹¶ä¸”åœ¨ç³»ç»Ÿæä¾›çš„UIç•Œé¢ä¸Šæ˜¾ç¤ºå‡ºæ¥\nSonar Qubeç¯å¢ƒæ­å»º Sonar Qubeå®‰è£…\nSonar Qubeåœ¨7.9ç‰ˆæœ¬ä¸­å·²ç»æ”¾å¼ƒäº†å¯¹MySQLçš„æ”¯æŒï¼Œå¹¶ä¸”å»ºè®®åœ¨å•†ä¸šç¯å¢ƒä¸­é‡‡ç”¨PostgreSQLï¼Œé‚£ä¹ˆå®‰è£…Sonar Qubeæ—¶éœ€è¦ä¾èµ–PostgreSQLã€‚\nå¹¶ä¸”è¿™é‡Œä¼šå®‰è£…Sonar Qubeçš„é•¿æœŸæ”¯æŒç‰ˆæœ¬8.9\næ‹‰å–é•œåƒ 1 2 docker pull postgres docker pull sonarqube:8.9.3-community ç¼–å†™docker-compose.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 version: \u0026#34;3.1\u0026#34; services: db: image: postgres container_name: db ports: - 5432:5432 networks: - sonarnet environment: POSTGRES_USER: sonar POSTGRES_PASSWORD: sonar sonarqube: image: sonarqube:8.9.3-community container_name: sonarqube depends_on: - db ports: - \u0026#34;9000:9000\u0026#34; networks: - sonarnet environment: SONAR_JDBC_URL: jdbc:postgresql://db:5432/sonar SONAR_JDBC_USERNAME: sonar SONAR_JDBC_PASSWORD: sonar networks: sonarnet: driver: bridge å¯åŠ¨å®¹å™¨\n1 docker-compose up -d éœ€è¦è®¾ç½®sysctl.confæ–‡ä»¶ä¿¡æ¯\nè®¾ç½®vm.max_map_count\nå¹¶æ‰§è¡Œå‘½ä»¤åˆ·æ–°\n1 sysctl -p é‡æ–°å¯åŠ¨éœ€è¦ä¸€å®šæ—¶é—´å¯åŠ¨ï¼Œå¯ä»¥å¯ä»¥æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼Œçœ‹åˆ°å¦‚ä¸‹å†…å®¹ä»£è¡¨å¯åŠ¨æˆåŠŸ\nå®¹å™¨æ—¥å¿—\nè®¿é—®Sonar Qubeé¦–é¡µ\nè¿˜éœ€è¦é‡æ–°è®¾ç½®ä¸€æ¬¡å¯†ç  Sonar Qubeé¦–é¡µ\nå®‰è£…ä¸­æ–‡æ’ä»¶\nå®‰è£…æˆåŠŸåéœ€è¦é‡å¯ï¼Œå®‰è£…å¤±è´¥é‡æ–°ç‚¹å‡»installé‡è£…å³å¯ã€‚\nå®‰è£…æˆåŠŸåï¼Œä¼šæŸ¥çœ‹åˆ°é‡å¯æŒ‰é’®ï¼Œç‚¹å‡»å³å¯\né‡å¯åæŸ¥çœ‹æ•ˆæœ\nSonar QubeåŸºæœ¬ä½¿ç”¨ Sonar Qubeçš„ä½¿ç”¨æ–¹å¼å¾ˆå¤šï¼ŒMavenå¯ä»¥æ•´åˆï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨sonar-scannerçš„æ–¹å¼ï¼Œå†æŸ¥çœ‹Sonar Qubeçš„æ£€æµ‹æ•ˆæœ\nMavenå®ç°ä»£ç æ£€æµ‹ ä¿®æ”¹Mavençš„settings.xmlæ–‡ä»¶é…ç½®Sonar Qubeä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 \u0026lt;profile\u0026gt; \u0026lt;id\u0026gt;sonar\u0026lt;/id\u0026gt; \u0026lt;activation\u0026gt; \u0026lt;activeByDefault\u0026gt;true\u0026lt;/activeByDefault\u0026gt; \u0026lt;/activation\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;sonar.login\u0026gt;admin\u0026lt;/sonar.login\u0026gt; \u0026lt;sonar.password\u0026gt;admin123456\u0026lt;/sonar.password\u0026gt; \u0026lt;sonar.host.url\u0026gt;http://172.17.1.22:9000\u0026lt;/sonar.host.url\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;/profile\u0026gt; åœ¨ä»£ç ä½ç½®æ‰§è¡Œå‘½ä»¤ï¼šmvn sonar:sonar\næŸ¥çœ‹Sonar Qubeç•Œé¢æ£€æµ‹ç»“æœ\nSonar-scannerå®ç°ä»£ç æ£€æµ‹ ä¸‹è½½Sonar-scannerï¼šhttps://binaries.sonarsource.com/Distribution/sonar-scanner-cli/\nä¸‹è½½4.6.xç‰ˆæœ¬å³å¯ï¼Œè¦æ±‚Linuxç‰ˆæœ¬\nè§£å‹å¹¶é…ç½®sonaræœåŠ¡ç«¯ä¿¡æ¯\nç”±äºæ˜¯zipå‹ç¼©åŒ…ï¼Œéœ€è¦å®‰è£…unzipè§£å‹æ’ä»¶Â 1 yum -y install unzip è§£å‹å‹ç¼©åŒ…\n1 unzip sonar-scanner-cli/sonar-scanner-cli-4.6.0.2311-linux.zip é…ç½®sonarQubeæœåŠ¡ç«¯åœ°å€ï¼Œä¿®æ”¹confä¸‹çš„sonar-scanner.properties\næ‰§è¡Œå‘½ä»¤æ£€æµ‹ä»£ç \n1 2 # åœ¨é¡¹ç›®æ‰€åœ¨ç›®å½•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ ~/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=demo -Dsonar.projectKey=java -Dsonar.java.binaries=target/ æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯\næŸ¥çœ‹SonarQubeç•Œé¢æ£€æµ‹ç»“æœ\nJenkinsé›†æˆSonar Qube Jenkinsç»§æ‰¿Sonar Qubeå®ç°ä»£ç æ‰«æéœ€è¦å…ˆä¸‹è½½æ•´åˆæ’ä»¶\nJenkinså®‰è£…æ’ä»¶\nJenkinsé…ç½®Sonar Qube\nå¼€å¯Sonar Qubeæƒé™éªŒè¯\nè·å–Sonar Qubeçš„ä»¤ç‰Œ\né…ç½®Jenkinsçš„Sonar Qubeä¿¡æ¯\né…ç½®Sonar-scanner\nå°†Sonar-scaneræ·»åŠ åˆ°Jenkinsæ•°æ®å·ä¸­å¹¶é…ç½®å…¨å±€é…ç½® é…ç½®ä»»åŠ¡çš„Sonar-scanner 1 2 3 4 5 6 7 8 ~/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=demo -Dsonar.projectKey=java -Dsonar.java.binaries=target/ #ä¸»è¦ä¸‹é¢è¿™ä¸ª sonar.projectname=${JOB_NAME} sonar.projectKey=${JOB_NAME} sources=./ sonar.java.binaries=target/ æ„å»ºä»»åŠ¡\nå·²ç»ä¸Šä¼ é•œåƒåŒ…\næ³¨æ„ï¼šæˆ‘è¿™é‡Œä»£ç ç¼–è¯‘è¿™ä¸€å—ï¼Œç¼ºå°‘é‚£ä¸ª åˆ‡æ¢åˆ†æ”¯ç¼–è¯‘ï¼Œå¦‚æœæœ‰éœ€è¦ï¼Œéœ€è¦è‡ªå·±é…ç½®Â ","date":"2022-05-17T10:06:54Z","image":"https://www.ownit.top/title_pic/41.jpg","permalink":"https://www.ownit.top/p/202205171006/","title":"Jenkinsé›†æˆSonar Qube"},{"content":"Jenkinså®‰è£…éƒ¨ç½²ä½¿ç”¨_å—å®«ä¹˜é£çš„åšå®¢-CSDNåšå®¢\nå®‰è£…å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼Œåç»­åœ¨è¿™åŸºç¡€è¿›è¡Œæ„å»º\nç”±äºJenkinséœ€è¦ä»Gitæ‹‰å–ä»£ç ã€éœ€è¦æœ¬åœ°æ„å»ºã€ç”šè‡³éœ€è¦ç›´æ¥å‘å¸ƒè‡ªå®šä¹‰é•œåƒåˆ°Dockerä»“åº“ï¼Œæ‰€ä»¥Jenkinséœ€è¦é…ç½®å¤§é‡å†…å®¹ã€‚\næ„å»ºä»»åŠ¡ å‡†å¤‡å¥½GitLabä»“åº“ä¸­çš„é¡¹ç›®ï¼Œå¹¶ä¸”é€šè¿‡Jenkinsé…ç½®é¡¹ç›®çš„å®ç°å½“å‰é¡¹ç›®çš„DevOpsåŸºæœ¬æµç¨‹ã€‚\næ„å»ºMavenå·¥ç¨‹å‘å¸ƒåˆ°GitLabï¼ˆGiteeã€Githubå‡å¯ï¼‰ java-demo: api-gateway-demo\nJenkinsç‚¹å‡»å·¦ä¾§å¯¼èˆªæ–°å»ºä»»åŠ¡\né€‰æ‹©è‡ªç”±é£æ ¼æ„å»ºä»»åŠ¡\né…ç½®æºç æ‹‰å–åœ°å€ Jenkinséœ€è¦å°†Gitä¸Šå­˜æ”¾çš„æºç å­˜å‚¨åˆ°JenkinsæœåŠ¡æ‰€åœ¨ç£ç›˜çš„æœ¬åœ°\né…ç½®ä»»åŠ¡æºç æ‹‰å–çš„åœ°å€ Jenkinsç«‹å³æ„å»º\nç‚¹å‡»ä»»åŠ¡demoä¸­çš„ç«‹å³æ„å»º\næŸ¥çœ‹æ„å»ºå·¥ç¨‹çš„æ—¥å¿—ï¼Œç‚¹å‡»ä¸Šè¿°çš„ä»»åŠ¡æ¡å³å¯\nå¯ä»¥çœ‹åˆ°æºç å·²ç»æ‹‰å–å¸¦Jenkinsæœ¬åœ°ï¼Œå¯ä»¥æ ¹æ®ç¬¬ä¸‰è¡Œæ—¥å¿—ä¿¡æ¯ï¼ŒæŸ¥çœ‹Jenkinsæœ¬åœ°æ‹‰å–åˆ°çš„æºç ã€‚\næŸ¥çœ‹Jenkinså®¹å™¨ä¸­/var/jenkins_home/workspace/demoçš„æºç \næºç å­˜æ”¾ä½ç½®\né…ç½®Mavenæ„å»ºä»£ç  ä»£ç æ‹‰å–åˆ°Jenkinsæœ¬åœ°åï¼Œéœ€è¦åœ¨Jenkinsä¸­å¯¹ä»£ç è¿›è¡Œæ„å»ºï¼Œè¿™é‡Œéœ€è¦Mavençš„ç¯å¢ƒï¼Œè€ŒMavenéœ€è¦Javaçš„ç¯å¢ƒï¼Œæ¥ä¸‹æ¥éœ€è¦åœ¨Jenkinsä¸­å®‰è£…JDKå’ŒMavenï¼Œå¹¶ä¸”é…ç½®åˆ°JenkinsæœåŠ¡ã€‚\nå‡†å¤‡JDKã€Mavenå‹ç¼©åŒ…é€šè¿‡æ•°æ®å·æ˜ å°„åˆ°Jenkinså®¹å™¨å†…éƒ¨ è§£å‹å‹ç¼©åŒ…ï¼Œå¹¶é…ç½®Mavençš„settings.xml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026lt;!-- é˜¿é‡Œäº‘é•œåƒåœ°å€ --\u0026gt; \u0026lt;mirror\u0026gt; \u0026lt;id\u0026gt;alimaven\u0026lt;/id\u0026gt; \u0026lt;name\u0026gt;aliyun maven\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;http://maven.aliyun.com/nexus/content/groups/public/\u0026lt;/url\u0026gt; \u0026lt;mirrorOf\u0026gt;central\u0026lt;/mirrorOf\u0026gt; \u0026lt;/mirror\u0026gt; \u0026lt;!-- JDK1.8ç¼–è¯‘æ’ä»¶ --\u0026gt; \u0026lt;profile\u0026gt; \u0026lt;id\u0026gt;jdk-1.8\u0026lt;/id\u0026gt; \u0026lt;activation\u0026gt; \u0026lt;activeByDefault\u0026gt;true\u0026lt;/activeByDefault\u0026gt; \u0026lt;jdk\u0026gt;1.8\u0026lt;/jdk\u0026gt; \u0026lt;/activation\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;maven.compiler.source\u0026gt;1.8\u0026lt;/maven.compiler.source\u0026gt; \u0026lt;maven.compiler.target\u0026gt;1.8\u0026lt;/maven.compiler.target\u0026gt; \u0026lt;maven.compiler.compilerVersion\u0026gt;1.8\u0026lt;/maven.compiler.compilerVersion\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;/profile\u0026gt; Jenkinsé…ç½®JDK\u0026amp;Mavenå¹¶ä¿å­˜\né…ç½®Jenkinsä»»åŠ¡æ„å»ºä»£ç \nç«‹å³æ„å»ºæµ‹è¯•ï¼ŒæŸ¥çœ‹targetä¸‹çš„jaråŒ…\njava-demo: api-gateway-demo\né…ç½®Publishå‘å¸ƒ\u0026amp;è¿œç¨‹æ“ä½œ jaråŒ…æ„å»ºå¥½ä¹‹åï¼Œå°±å¯ä»¥æ ¹æ®æƒ…å†µå‘å¸ƒåˆ°æµ‹è¯•æˆ–ç”Ÿäº§ç¯å¢ƒï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°ä¹‹å‰ä¸‹è½½å¥½çš„æ’ä»¶Publish Over SSHã€‚\né…ç½®Publish Over SSHè¿æ¥æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒ Publish Over SSHé…ç½®\né…ç½®ä»»åŠ¡çš„æ„å»ºåæ“ä½œï¼Œå‘å¸ƒjaråŒ…åˆ°ç›®æ ‡æœåŠ¡\nå·²ç»å®Œæˆä¸€æ¬¡ç®€å•çš„æ„å»ºäº¤ä»˜\næŒç»­äº¤ä»˜ã€éƒ¨ç½² ç¨‹åºä»£ç åœ¨ç»è¿‡å¤šæ¬¡é›†æˆæ“ä½œåˆ°è¾¾æœ€ç»ˆå¯ä»¥äº¤ä»˜ï¼ŒæŒç»­äº¤ä»˜æ•´ä½“æµç¨‹å’ŒæŒç»­é›†æˆç±»ä¼¼ï¼Œä¸è¿‡éœ€è¦é€‰å–æŒ‡å®šçš„å‘è¡Œç‰ˆæœ¬\nä¸‹è½½Git Parameteræ’ä»¶ è®¾ç½®é¡¹ç›®å‚æ•°åŒ–æ„å»º\nåŸºäºGitæ ‡ç­¾æ„å»º\nç»™é¡¹ç›®æ·»åŠ tagç‰ˆæœ¬\nä»»åŠ¡æ„å»ºæ—¶ï¼Œé‡‡ç”¨Shellæ–¹å¼æ„å»ºï¼Œæ‹‰å–æŒ‡å®štagç‰ˆæœ¬ä»£ç \nåŸºäºParameteræ„å»ºä»»åŠ¡ï¼Œä»»åŠ¡å‘å¸ƒåˆ°ç›®æ ‡æœåŠ¡å™¨\n","date":"2022-05-17T09:41:41Z","image":"https://www.ownit.top/title_pic/21.jpg","permalink":"https://www.ownit.top/p/202205170941/","title":"Jenkinså…¥é—¨é…ç½®"},{"content":"ä»‹ç» Jenkinsæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¼€æºè½¯ä»¶é¡¹ç›®ï¼Œæ˜¯åŸºäºJavaå¼€å‘çš„ä¸€ç§æŒç»­é›†æˆå·¥å…·ï¼Œç”¨äºç›‘æ§æŒç»­é‡å¤çš„å·¥ä½œï¼Œæ—¨åœ¨æä¾›ä¸€ä¸ªå¼€æ”¾æ˜“ç”¨çš„è½¯ä»¶å¹³å°ï¼Œä½¿è½¯ä»¶çš„æŒç»­é›†æˆå˜æˆå¯èƒ½ã€‚å‰èº«æ˜¯Hudsonæ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„æŒç»­é›†æˆå¼•æ“ã€‚å¯ç”¨äºè‡ªåŠ¨åŒ–å„ç§ä»»åŠ¡ï¼Œå¦‚æ„å»ºï¼Œæµ‹è¯•å’Œéƒ¨ç½²è½¯ä»¶ã€‚Jenkinså¯ä»¥é€šè¿‡æœ¬æœºç³»ç»ŸåŒ…Dockerå®‰è£…ï¼Œç”šè‡³å¯ä»¥é€šè¿‡å®‰è£…Java Runtime Environmentçš„ä»»ä½•æœºå™¨ç‹¬ç«‹è¿è¡Œã€‚\nJenkinsç‰¹ç‚¹ å¼€æºå…è´¹; è·¨å¹³å°ï¼Œæ”¯æŒæ‰€æœ‰çš„å¹³å°; master/slaveæ”¯æŒåˆ†å¸ƒå¼çš„build; webå½¢å¼çš„å¯è§†åŒ–çš„ç®¡ç†é¡µé¢; å®‰è£…é…ç½®è¶…çº§ç®€å•; tipsåŠæ—¶å¿«é€Ÿçš„å¸®åŠ©ï¼› å·²æœ‰çš„200å¤šä¸ªæ’ä»¶ å®‰è£…æ•™ç¨‹ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç¦»çº¿åŒ…æ–¹å¼å®‰è£…ã€‚\nå®˜ç½‘é•œåƒåœ°å€:Â Index of /\nä¸‹è½½åœ°å€ï¼šÂ Jenkins download and deployment\nåä¸ºé•œåƒåœ°å€:Â åä¸ºå¼€æºé•œåƒç«™_è½¯ä»¶å¼€å‘æœåŠ¡_åä¸ºäº‘\nç›´æ¥ä¸‹è½½waråŒ…ï¼Œå¹¶å®‰è£…å¥½jdkä¹‹åï¼Œè¾“å…¥:nohup java -jar jenkins.war --httpPort=8888 \u0026amp;\nè¿›è¡Œå¯åŠ¨ï¼Œç„¶åç½‘é¡µæµè§ˆå™¨è¾“å…¥ ip:8888æ‰“å¼€è®¾ç½®å¥½è´¦å·å¯†ç ä¹‹åç™»å½•å³å¯ï¼Œæ’ä»¶å®‰è£…æ¨èä½¿ç”¨å®˜æ–¹æ¨èã€‚\nDockerå®‰è£… æ‹‰å–Jenkinsé•œåƒ\n1 docker pull jenkins/jenkins ç¼–å†™docker-compose.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 version: \u0026#34;3.1\u0026#34; services: jenkins: image: jenkins/jenkins container_name: jenkins ports: - 8080:8080 - 50000:50000 volumes: - ./data/:/var/jenkins_home/ - /usr/bin/docker:/usr/bin/docker - /var/run/docker.sock:/var/run/docker.sock - /etc/docker/daemon.json:/etc/docker/daemon.json é¦–æ¬¡å¯åŠ¨ä¼šå› ä¸ºæ•°æ®å·dataç›®å½•æ²¡æœ‰æƒé™å¯¼è‡´å¯åŠ¨å¤±è´¥ï¼Œè®¾ç½®dataç›®å½•å†™æƒé™\n1 chmod -R a+w data/Â é‡æ–°å¯åŠ¨Jenkinså®¹å™¨åï¼Œç”±äºJenkinséœ€è¦ä¸‹è½½å¤§é‡å†…å®¹ï¼Œä½†æ˜¯ç”±äºé»˜è®¤ä¸‹è½½åœ°å€ä¸‹è½½é€Ÿåº¦è¾ƒæ…¢ï¼Œéœ€è¦é‡æ–°è®¾ç½®ä¸‹è½½åœ°å€ä¸ºå›½å†…é•œåƒç«™\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # ä¿®æ”¹æ•°æ®å·ä¸­çš„hudson.model.UpdateCenter.xmlæ–‡ä»¶ \u0026lt;?xml version=\u0026#39;1.1\u0026#39; encoding=\u0026#39;UTF-8\u0026#39;?\u0026gt; \u0026lt;sites\u0026gt; \u0026lt;site\u0026gt; \u0026lt;id\u0026gt;default\u0026lt;/id\u0026gt; \u0026lt;url\u0026gt;https://updates.jenkins.io/update-center.json\u0026lt;/url\u0026gt; \u0026lt;/site\u0026gt; \u0026lt;/sites\u0026gt; # å°†ä¸‹è½½åœ°å€æ›¿æ¢ä¸ºhttp://mirror.esuni.jp/jenkins/updates/update-center.json \u0026lt;?xml version=\u0026#39;1.1\u0026#39; encoding=\u0026#39;UTF-8\u0026#39;?\u0026gt; \u0026lt;sites\u0026gt; \u0026lt;site\u0026gt; \u0026lt;id\u0026gt;default\u0026lt;/id\u0026gt; \u0026lt;url\u0026gt;http://mirror.esuni.jp/jenkins/updates/update-center.json\u0026lt;/url\u0026gt; \u0026lt;/site\u0026gt; \u0026lt;/sites\u0026gt; # æ¸…åå¤§å­¦çš„æ’ä»¶æºä¹Ÿå¯ä»¥https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json å†æ¬¡é‡å¯Jenkinså®¹å™¨ï¼Œè®¿é—®Jenkinsï¼ˆéœ€è¦ç¨å¾®ç­‰ä¼šï¼‰\n1 docker-compose restart æŸ¥çœ‹å¯†ç ç™»å½•Jenkinsï¼Œå¹¶ç™»å½•ä¸‹è½½æ’ä»¶\n1 docker exec -it jenkins cat /var/jenkins_home/secrets/initialAdminPassword ","date":"2022-05-16T21:47:34Z","image":"https://www.ownit.top/title_pic/54.jpg","permalink":"https://www.ownit.top/p/202205162147/","title":"Jenkinså®‰è£…éƒ¨ç½²ä½¿ç”¨"},{"content":"ç›®å½•\nç›¸å…³Â æ€è·¯\nä¸»åº“\n1ã€æ£€æŸ¥ä¸»åº“æ˜¯å¦å¼€å¯log-bin\n2ã€å¼€å¯log-bin\n3ã€é‡å¯MySQL\n4ã€æ£€æŸ¥ç”Ÿæˆçš„log-binç›®å½•\n5ã€è¿›å…¥MySQLï¼Œé”è¡¨ï¼Œè®°å½•POSå·\n6ã€å¤‡ä»½mysqlæ–‡ä»¶ï¼Œè§£è¡¨\n7ã€ä¸»åº“ä¼ è¾“mysqlæ–‡ä»¶åˆ°ä»åº“\n8ã€æ·»åŠ iptablesé˜²ç«å¢™è§„åˆ™ï¼ˆipä¸ºä»åº“IPï¼‰\nä»åº“\n1ã€åœæ­¢ä»åº“çš„ä¸šåŠ¡ç¨‹åº\n2ã€åœæ­¢ç¥¨åŠ¡å¼€æœºè‡ªå¯ç¨‹åº\n3ã€æ£€æŸ¥ä¸»åº“æ˜¯å¦å¼€å¯log-bin\n4ã€å¼€å¯log-binï¼Œæ·»åŠ é…ç½®ï¼Œä¿®æ”¹id\n4ã€åœæ­¢mysql ï¼Œå¤‡ä»½ç›®å½•\n5ã€è¦†ç›–mysqlç›®å½•ï¼Œåˆ é™¤auto.cnf\n6ã€å¯åŠ¨mysql\n7ã€å¯åŠ¨ä¸»ä»\nç›¸å…³Â ç›¸å…³åŸç†å¯ä»¥æŸ¥çœ‹æ­¤åšå®¢Â https://blog.csdn.net/heian_99/article/details/106647572http://xn\u0026ndash;mysql-ni1h1kkd34cien8anzj00an2yqrx8k1a1u9c2j7e9svvilaaa\nä»¥ä¸‹ä½œä¸º å®é™…æ“ä½œ\nç¯å¢ƒï¼š\nä¸»åº“ï¼šÂ mysql\nä»åº“ï¼š mysql\næ€è·¯ ï¼ˆ1ï¼‰ä¸»åº“Aæ•°æ®å…¨ï¼Œæ•°æ®åº“Bç©ºçš„\nï¼ˆ2ï¼‰é”è¡¨æ•°æ®åº“Aï¼Œè®°å½•poså·\nï¼ˆ3ï¼‰å¤åˆ¶æ•°æ®åº“Aç›®å½•æ•°æ®ï¼ˆè¿›è¡Œcpå¤‡ä»½ï¼‰ç„¶å è§£é”è¡¨\nï¼ˆ4ï¼‰æŠŠæ•°æ®åº“Aå¤‡ä»½çš„æ•°æ®è¿›è¡Œscp æ•°æ®åº“B\nï¼ˆ5ï¼‰æŠŠæ•°æ®åº“Açš„ç›®å½•ï¼Œè¿›è¡Œè¦†ç›–æ•°æ®åº“Bçš„ç›®å½•ã€‚ï¼ˆæ•°æ®è¦†ç›–ï¼Œç›¸å½“äºå¤‡ä»½æ¢å¤ï¼‰\nï¼ˆ6ï¼‰è¿›è¡Œä¸»å…±åŒæ­¥\n**æ³¨æ„ï¼šæ—¥å¿—æ ¼å¼Â **statementÂ rowÂ mixedÂ å»ºè®®ä½¿ç”¨ mixed\nä¸»åº“ 1ã€æ£€æŸ¥ä¸»åº“æ˜¯å¦å¼€å¯log-bin 1 2 [root@92-69-xy-bak ~]# cat /etc/my.cnf | grep log-bin log-bin=/databak/mysql-bin/mysql-bin 2ã€å¼€å¯log-bin å¦‚æœä¸Šé¢æ²¡æœ‰æ˜¾ç¤ºï¼Œéœ€è¦å¼€å¯log-bin\n1 2 3 4 5 6 å¼€å¯ vim /etc/my.cnf log-bin=/databak/mysql-bin/mysql-bin åˆ›å»ºç›®å½•ï¼Œæˆæƒ mkdir /databak/mysql-bin chown mysql.mysql /databak/mysql-bin -R 3ã€é‡å¯MySQL é‡å¯mysqlæ˜¯å› ä¸ºåˆšå¼€å¯log-binæ—¥å¿—ï¼Œéœ€è¦ç”Ÿæˆæ•°æ®\n1 service mysql restart 4ã€æ£€æŸ¥ç”Ÿæˆçš„log-bin****ç›®å½• 1 ç›®çš„ï¼šæ˜¯å¦å¼€å¯log-binæˆåŠŸï¼Œæ˜¯å¦ç”Ÿæˆæ—¥å¿—æ•°æ® 1 2 3 4 ls /databak/mysql-bin/ ç”Ÿæˆçš„æ•°æ® mysql-bin.000001 mysql-bin.000002 mysql-bin.000003 mysql-bin.index 5ã€è¿›å…¥MySQLï¼Œé”è¡¨ï¼Œè®°å½•POS****å· 1 2 3 4 mysql -ucpms -pudqjHDMkxQfGP4iy FLUSH TABLES WITH READ LOCK; show master status; echo \u0026#34;æ—¥å¿—åå­— åç§»é‡\u0026#34; \u0026gt; /var/lib/mysql/è®°å½•æ–‡ä»¶ 6ã€å¤‡ä»½mysqlæ–‡ä»¶ï¼Œè§£è¡¨ 1 2 3 cp -r /var/lib/mysql /opt/mysql_bak UNLOCK TABLES; 7ã€ä¸»åº“ä¼ è¾“mysql****æ–‡ä»¶åˆ°ä»åº“ 1 2 cd /opt scp -r mysql_bak soft CMS3.10.21 192.168.0.3:/opt 8ã€æ·»åŠ iptablesé˜²ç«å¢™è§„åˆ™ï¼ˆipä¸ºä»åº“IP**ï¼‰** 1 2 3 vim /etc/sysconfig/iptables -A INPUT -s 10.92.69.3 -p tcp --dport 3306 -j ACCEPT /etc/init.d/iptables restart ä»¥ä¸Šæ“ä½œä¸»åº“å®Œæˆ\nä»åº“ 1ã€åœæ­¢ä»åº“çš„ä¸šåŠ¡ç¨‹åº 1 pkill java 2ã€åœæ­¢ç¥¨åŠ¡å¼€æœºè‡ªå¯ç¨‹åº 1 chkconfig --list | grep cms |awk \u0026#39;{print \u0026#34;chkconfig\u0026#34;,$1,\u0026#34;off\u0026#34;}\u0026#39;|bash 3ã€æ£€æŸ¥ä¸»åº“æ˜¯å¦å¼€å¯log-bin 1 2 [root@92-69-xy-bak ~]# cat /etc/my.cnf | grep log-bin log-bin=/databak/mysql-bin/mysql-bin 4ã€å¼€å¯log-binï¼Œæ·»åŠ é…ç½®ï¼Œä¿®æ”¹id å¦‚æœä¸Šé¢æ²¡æœ‰æ˜¾ç¤ºï¼Œéœ€è¦å¼€å¯log-bin\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 å¼€å¯ vim /etc/my.cnf log-bin=/databak/mysql-bin/mysql-bin server-id=2 replicate_ignore_table=CMS.QC_TEMP replicate_ignore_table=CMS.QM_TEMP replicate_ignore_table=CMS.STORE_IN_TEMP replicate_ignore_table=CMS.TEMP_POS_SALE_GOODS_ITEM_COST replicate_ignore_table=CMS.TEMP_POS_REJECT_GOODS_ITEM_COST replicate_ignore_table=CMS.MER_INTERFACE_DAY_STORE_CHECK slave-skip-errors = 1062 åˆ›å»ºç›®å½•ï¼Œæˆæƒ mkdir /databak/mysql-bin chown mysql.mysql /databak/mysql-bin -R 4ã€åœæ­¢mysql ï¼Œå¤‡ä»½ç›®å½• 1 2 3 service mysql stop mv /var/lib/mysql /var/lib/bak_mysql 5ã€è¦†ç›–mysqlç›®å½•ï¼Œåˆ é™¤auto.cnf 1 2 3 cp -r /opt/mysql_bak /var/lib/mysql \\rm /var/lib/mysql/auto.cnf 6ã€å¯åŠ¨mysql 1 service mysql start 7ã€å¯åŠ¨ä¸»ä» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 è¿›å…¥mysql mysql -uroot -p^passswd åœæ­¢slave stop slave; å†™å…¥ é…ç½®ä¿¡æ¯ï¼ˆæ³¨æ„poså·ï¼Œè´¦å·ï¼Œä¸»åº“ip ç«¯å£ï¼‰ change master to master_host=\u0026#39;10.92.69.2\u0026#39;, master_port=3306, master_user=\u0026#39;admin\u0026#39;, master_password=\u0026#39;udq5545adadefiy\u0026#39;, master_log_file=\u0026#39;mysql-bin.000001\u0026#39;, master_log_pos=17503; å¼€å¯ä»åº“ start slave; æŸ¥çœ‹çŠ¶æ€ show slave status\\G ä¸¤ä¸ªyesä¸ºæ­£å¸¸ï¼Œæ£€æŸ¥poså·æ˜¯å¦å·²ç»å’Œä¸»åº“åŒæ­¥ ä»¥ä¸Šæ“ä½œéœ€è°¨æ…ï¼Œå°¤å…¶ä¸»åº“ä¸Šï¼Œè¾“å…¥å‘½ä»¤éœ€ä¸‰æ€ï¼ˆæ–‡æ¡£ä»…ä¾›å‚è€ƒï¼‰\n","date":"2022-05-13T11:40:32Z","image":"https://www.ownit.top/title_pic/02.jpg","permalink":"https://www.ownit.top/p/202205131140/","title":"Mysqlä¸»ä»åŒæ­¥å¤åˆ¶ï¼ˆå¿«é€Ÿæ„å»ºï¼ŒåŸºäºCPæ•°æ®å¤‡ä»½ æ¢å¤ï¼‰"},{"content":"é¦–å…ˆæˆ‘ä»¬æ—¥å¸¸è¿ç»´ä¸­ï¼ŒæœåŠ¡å™¨ä¼šè·‘å¤§é‡çš„ä»»åŠ¡ã€‚\nï¼ˆ1ï¼‰æˆ‘ä»¬å¯ä»¥é€šprometheuså’Œgrafana å±•ç¤ºæ•´ä¸ªæœåŠ¡å™¨çš„cpu å†…å­˜ å’Œç£ç›˜IOçš„è¶‹åŠ¿\nï¼ˆ2ï¼‰å¯ä»¥æ¯å°éƒ¨ç½²ç›¸åº”çš„è„šæœ¬ï¼Œå¯ä»¥å®šä½åˆ°æ¯ä¸ªæ—¶é—´æ®µæ‰§è¡Œçš„ä¸šåŠ¡ï¼Œæ‰€æ¶ˆè€—çš„å„é¡¹èµ„æº\nç»Ÿè®¡å‰åçš„CUPæ¶ˆè€—åº”ç”¨ï¼ˆé™åº ï¼‰ 1 ps aux|head -1 \u0026amp;\u0026amp; ps aux|grep -v PID|sort -rn -k +3|head ç»Ÿè®¡å‰åçš„å†…å­˜æ¶ˆè€—åº”ç”¨ï¼ˆé™åºÂ ï¼‰ 1 ps aux|head -1 \u0026amp;\u0026amp; ps aux|grep -v PID|sort -rn -k +4|head ç»Ÿè®¡å‰åçš„ç£ç›˜IOæ¶ˆè€—åº”ç”¨ï¼ˆé™åºÂ ï¼‰ 1 /usr/sbin/iotop -btoq --iter=1 |awk \u0026#39;NR\u0026gt;3{print}\u0026#39;|sort -rn -k 11 åˆ‡è®°éœ€è¦å®‰è£…iotop\nç»Ÿè®¡ç½‘ç»œçŠ¶æ€æ ‡è¯†ï¼ˆçŠ¶æ€ï¼‰Â 1 netstat -nt | grep -e 127.0.0.1 -e 0.0.0.0 -e ::: -v | awk \u0026#39;/^tcp/ {++state[$NF]} END {for(i in state) print i,\u0026#34;\\t\u0026#34;,state[i]}\u0026#39; ç»Ÿè®¡ç½‘ç»œçŠ¶æ€æ ‡è¯†ï¼ˆIPï¼‰ 1 netstat -n | awk \u0026#39;/^tcp/ {print $0}\u0026#39; | awk \u0026#39;{print $(NF-1),$NF}\u0026#39; | awk -F \u0026#39;:| \u0026#39; \u0026#39;{print $1,$NF}\u0026#39; |awk \u0026#39;BEGIN{print \u0026#34;IP\\t\\tçŠ¶æ€\\tæ¬¡æ•°ç»Ÿè®¡\u0026#34;} {a[$1\u0026#34; \u0026#34;$2]++}END{for(i in a) print(i,a[i])}\u0026#39; |sort -nk 3 è¿æ¥çŠ¶æ€_å­¦ä¹ ç¬”è®°-TCPè¿æ¥çŠ¶æ€è§£æ_å…­ååº¦ç°çš„åšå®¢-CSDNåšå®¢å‰é¢ä¸¤ç¯‡è¯¦ç»†çš„ç»™å¤§å®¶ä»‹ç»è¿‡äº†TCPçš„ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹æµç¨‹(è¯¦è§å­¦ä¹ ç¬”è®°-TCPä¸‰æ¬¡æ¡æ‰‹ï¼Œ å­¦ä¹ ç¬”è®°-TCPå››æ¬¡æŒ¥æ‰‹ )ï¼Œæœ¬æ–‡ä¸»è¦æ˜¯ä»‹ç»åœ¨TCPè¿æ¥è¿‡ç¨‹ä¸­çš„å„ç§çŠ¶æ€å˜åŒ–ã€‚çŠ¶æ€ä»‹ç»CLOSED:è¡¨ç¤ºåˆå§‹çŠ¶æ€ã€‚LISTEN:è¡¨ç¤ºæœåŠ¡å™¨ç«¯çš„æŸä¸ªSOCKETå¤„äºï¼Œå¯ä»¥æ¥å—è¿æ¥äº†ã€‚SYN_RCVD:è¿™ä¸ªçŠ¶æ€è¡¨ç¤ºæ¥å—åˆ°äº†SYNï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªçŠ¶æ€æ˜¯æœåŠ¡å™¨ç«¯çš„SOCKETåœ¨å»ºç«‹TCPè¿æ¥æ—¶çš„ä¼šè¯è¿‡ç¨‹ä¸­çš„ä¸€ä¸ª\u0026hellip;https://blog.csdn.net/weixin_31304599/article/details/112671431?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0.pc_relevant_default\u0026amp;spm=1001.2101.3001.4242.1\u0026amp;utm_relevant_index=3\nç›¸å…³è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #!/bin/bash #æ—¶é—´ time=$(date \u0026#34;+%Y-%m-%d %H:%M:%S\u0026#34;) day=$(date \u0026#34;+%Y-%m-%d\u0026#34;) #é¦–ç”Ÿæˆæ—¥å¿—ç›®å½• mkdir -p /system/log/{cpu,mem,io,net} cpudir=\u0026#39;/system/log/cpu\u0026#39; memdir=\u0026#39;/system/log/mem\u0026#39; iodir=\u0026#39;/system/log/io\u0026#39; netdir=\u0026#39;/system/log/net\u0026#39; #ç»Ÿè®¡å‰10çš„cpu echo \u0026#34;=========================================${time}======================================================\u0026#34; \u0026gt;\u0026gt; ${cpudir}/${day}.log ps aux|head -1 \u0026gt;\u0026gt; ${cpudir}/${day}.log ps aux|grep -v PID|sort -rn -k +3|head \u0026gt;\u0026gt; ${cpudir}/${day}.log #ç»Ÿè®¡å‰10çš„å†…å­˜ echo \u0026#34;=========================================${time}======================================================\u0026#34; \u0026gt;\u0026gt; ${memdir}/${day}.log ps aux|head -1 \u0026gt;\u0026gt; ${memdir}/${day}.log ps aux|grep -v PID|sort -rn -k +4|head \u0026gt;\u0026gt; ${memdir}/${day}.log #ç»Ÿè®¡å‰10çš„ç£ç›˜io echo \u0026#34;=========================================${time}======================================================\u0026#34; \u0026gt;\u0026gt; ${iodir}/${day}.log /usr/sbin/iotop -btoq --iter=1 |head -n 3 \u0026gt;\u0026gt; ${iodir}/${day}.log /usr/sbin/iotop -btoq --iter=1 |awk \u0026#39;NR\u0026gt;3{print}\u0026#39;|sort -rn -k 11 \u0026gt;\u0026gt; ${iodir}/${day}.log #ç»Ÿè®¡æœºå™¨çš„ç½‘ç»œçŠ¶æ€(ip,çŠ¶æ€) echo \u0026#34;=========================================${time}======================================================\u0026#34; \u0026gt;\u0026gt; ${netdir}/${day}.log netstat -nt | grep -e 127.0.0.1 -e 0.0.0.0 -e ::: -v | awk \u0026#39;/^tcp/ {++state[$NF]} END {for(i in state) print i,\u0026#34;\\t\u0026#34;,state[i]}\u0026#39; \u0026gt;\u0026gt; ${netdir}/${day}.log echo -n \u0026#34; \u0026#34; \u0026gt;\u0026gt; ${netdir}/${day}.log netstat -n | awk \u0026#39;/^tcp/ {print $0}\u0026#39; | awk \u0026#39;{print $(NF-1),$NF}\u0026#39; | awk -F \u0026#39;:| \u0026#39; \u0026#39;{print $1,$NF}\u0026#39; |awk \u0026#39;BEGIN{print \u0026#34;IP\\t\\tçŠ¶æ€\\tæ¬¡æ•°ç»Ÿè®¡\u0026#34;} {a[$1\u0026#34; \u0026#34;$2]++}END{for(i in a) print(i,a[i])}\u0026#39; |sort -nk 3 \u0026gt;\u0026gt; ${netdir}/${day}.log #åˆ é™¤è€åŒ–çš„æ–‡ä»¶ï¼ˆä¿ç•™7å¤©ï¼‰ find /system/log/ -type f -mtime +7 -exec rm -f {} \\; è®¾ç½®å®šæ—¶ä»»åŠ¡ 1 2 3 4 5 6 7 8 #æ‹·è´æ–‡ä»¶ ansible hadoop -i ./hadoopip -m copy -a \u0026#34;src=/system/check_system.sh dest=/system/check_system.sh \u0026#34; -f 20 #ç»™æƒé™ ansible hadoop -i ./hadoopip -m shell -a \u0026#34;chmod a+x /system/check_system.sh \u0026#34; -f 20 #å®‰è£…ä¾èµ– ansible hadoop -i ./hadoopip -m shell -a \u0026#34;yum install -y iotop \u0026#34; -f 20 #è®¾ç½®å®šæ—¶ä»»åŠ¡ ansible hadoop -i ./hadoopip -m cron -a \u0026#34;minute=*/5 job=\u0026#39;sh /system/check_system.sh\u0026#39; name=check_system disabled=no\u0026#34; -f 20 è¿è¡Œç»“æœ æ—¥å¿—æ ¼å¼Â ","date":"2022-05-06T17:06:55Z","image":"https://www.ownit.top/title_pic/43.jpg","permalink":"https://www.ownit.top/p/202205061706/","title":"Linuxä»»åŠ¡åˆ†æè„šæœ¬"},{"content":"å‘Šè­¦æ—¥å¿—ç»Ÿè®¡\nå‘Šè­¦å»é‡ç»Ÿè®¡ å‘Šè­¦äººåˆ†ç»„é‚®ä»¶ åŸç†å›¾\næ­¤é¡¹ç›®ä¸»è¦ä½¿ç”¨Djangoå¼€å‘å‘Šè­¦æ¥å£ï¼Œå¯¹æ¥Altermanagerå‘Šè­¦ï¼Œå®ç°å‘Šè­¦äººåˆ†ç»„ï¼Œé‚®ä»¶ç­‰\nå‘Šè­¦ä¿¡æ¯æ—¥å¿—ï¼Œå‘Šè­¦ä¿¡æ¯ç»Ÿè®¡ç­‰ç­‰\nå¼€å‘è¿‡ç¨‹\nmodel\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 from django.db import models # Create your models here. class alerts(models.Model): startsAt = models.DateTimeField(verbose_name=\u0026#39;å‘Šè­¦äº§ç”Ÿæ—¶é—´\u0026#39;) endsAt = models.DateTimeField(verbose_name=\u0026#39;å‘Šè­¦æ¢å¤æ—¶é—´\u0026#39;) instance = models.CharField(max_length=50, verbose_name=\u0026#39;å®ä¾‹\u0026#39;, blank=True) alertname = models.CharField(max_length=100, verbose_name=\u0026#39;å‘Šè­¦åç§°\u0026#39;) status = models.CharField(max_length=20, verbose_name=\u0026#39;çŠ¶æ€\u0026#39;, blank=True) severity = models.CharField(max_length=20, verbose_name=\u0026#39;å‘Šè­¦çº§åˆ«\u0026#39;, blank=True) message = models.CharField(max_length=1000, verbose_name=\u0026#39;å‘Šè­¦ä¿¡æ¯\u0026#39;, blank=True) known = models.BooleanField(default=False, verbose_name=\u0026#39;çŸ¥æ‚‰\u0026#39;) memo = models.CharField(max_length=50, verbose_name=\u0026#39;çŸ¥æ‚‰å¤‡æ³¨\u0026#39;, blank=True) def __str__(self): return self.message class Meta: db_table = \u0026#39;alerts\u0026#39; verbose_name = \u0026#39;å‘Šè­¦æ—¥å¿—\u0026#39; verbose_name_plural = verbose_name # ordering = [\u0026#39;-startsAt\u0026#39;] # æŒ‰æ•…éšœæ—¶é—´å€’æ’ class production(models.Model): startsAt = models.DateTimeField(verbose_name=\u0026#39;å‘Šè­¦äº§ç”Ÿæ—¶é—´\u0026#39;) endsAt = models.DateTimeField(verbose_name=\u0026#39;å‘Šè­¦æ¢å¤æ—¶é—´\u0026#39;) instance = models.CharField(max_length=50, verbose_name=\u0026#39;å®ä¾‹\u0026#39;, blank=True) alertname = models.CharField(max_length=100, verbose_name=\u0026#39;å‘Šè­¦åç§°\u0026#39;) status = models.CharField(max_length=20, verbose_name=\u0026#39;çŠ¶æ€\u0026#39;, blank=True) severity = models.CharField(max_length=20, verbose_name=\u0026#39;å‘Šè­¦çº§åˆ«\u0026#39;, blank=True) message = models.CharField(max_length=1000, verbose_name=\u0026#39;å‘Šè­¦ä¿¡æ¯\u0026#39;, blank=True) known = models.BooleanField(default=False, verbose_name=\u0026#39;çŸ¥æ‚‰\u0026#39;) # memo = models.CharField(max_length=50, verbose_name=\u0026#39;çŸ¥æ‚‰å¤‡æ³¨\u0026#39;, blank=True) def __str__(self): return self.message class Meta: db_table = \u0026#39;production\u0026#39; verbose_name = \u0026#39;å‘Šè­¦ç»Ÿè®¡\u0026#39; verbose_name_plural = verbose_name class alarmuser(models.Model): username = models.CharField(max_length=20, verbose_name=\u0026#39;å‘Šè­¦äºº\u0026#39;, blank=True) useremail = models.EmailField(max_length=20, verbose_name=\u0026#39;å‘Šè­¦é‚®ä»¶\u0026#39;, blank=True) group = models.CharField(max_length=20, verbose_name=\u0026#39;åˆ†ç»„\u0026#39;, blank=True) def __str__(self): return self.username class Meta: db_table = \u0026#39;alarmuser\u0026#39; verbose_name = \u0026#39;å‘Šè­¦äººé…ç½®\u0026#39; verbose_name_plural = verbose_name æ³¨å†Œxadminåå°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 import xadmin from django.contrib import admin from xadmin import views from webhook.models import alerts, production, alarmuser class GlobalSetting: site_title = \u0026#34;é•¿é£ç ´æµª\u0026#34; site_footer = \u0026#34;é•¿é£ç ´æµª\u0026#34; menu_style = \u0026#34;accordion\u0026#34; # è¿™ä¸ªæ˜¯è®¾ç½®èœå•ä¸»é¢˜ enable_themes = True use_bootswatch = True refresh_times = [5, 10, 30, 60] xadmin.site.register(views.CommAdminView, GlobalSetting) class AlertsAdmin(object): \u0026#34;\u0026#34;\u0026#34;xadminçš„å…¨å±€é…ç½®\u0026#34;\u0026#34;\u0026#34; site_title = \u0026#34;é•¿é£ç ´æµª\u0026#34; # è®¾ç½®ç«™ç‚¹æ ‡é¢˜ site_footer = \u0026#34;é•¿é£ç ´æµª\u0026#34; # è®¾ç½®ç«™ç‚¹çš„é¡µè„š menu_style = \u0026#34;accordion\u0026#34; # è®¾ç½®èœå•æŠ˜å  \u0026#39;\u0026#39;\u0026#39;è®¾ç½®åˆ—è¡¨å¯æ˜¾ç¤ºçš„å­—æ®µ\u0026#39;\u0026#39;\u0026#39; list_display = (\u0026#39;startsAt\u0026#39;, \u0026#39;endsAt\u0026#39;, \u0026#39;instance\u0026#39;, \u0026#39;alertname\u0026#39;, \u0026#39;status\u0026#39;, \u0026#39;severity\u0026#39;, \u0026#39;message\u0026#39;, \u0026#39;known\u0026#39;, \u0026#39;memo\u0026#39;,) list_filter = [\u0026#39;status\u0026#39;, \u0026#39;severity\u0026#39;, \u0026#39;startsAt\u0026#39;, \u0026#39;endsAt\u0026#39;] search_fields = [\u0026#39;instance\u0026#39;, \u0026#39;alertname\u0026#39;] # list_per_pageè®¾ç½®æ¯é¡µæ˜¾ç¤ºå¤šå°‘æ¡è®°å½•ï¼Œé»˜è®¤æ˜¯100æ¡ list_per_page = 50 class ProductionAdmin(object): menu_style = \u0026#34;accordion\u0026#34; # è®¾ç½®èœå•æŠ˜å  list_display = (\u0026#39;startsAt\u0026#39;, \u0026#39;endsAt\u0026#39;, \u0026#39;instance\u0026#39;, \u0026#39;alertname\u0026#39;, \u0026#39;status\u0026#39;, \u0026#39;severity\u0026#39;, \u0026#39;message\u0026#39;, \u0026#39;known\u0026#39;,) list_filter = [\u0026#39;status\u0026#39;, \u0026#39;severity\u0026#39;, \u0026#39;startsAt\u0026#39;, \u0026#39;endsAt\u0026#39;] search_fields = [\u0026#39;instance\u0026#39;, \u0026#39;alertname\u0026#39;] # list_per_pageè®¾ç½®æ¯é¡µæ˜¾ç¤ºå¤šå°‘æ¡è®°å½•ï¼Œé»˜è®¤æ˜¯100æ¡ list_per_page = 50 class AlarmuserAdmin(object): list_display = (\u0026#39;username\u0026#39;, \u0026#39;useremail\u0026#39;, \u0026#39;group\u0026#39;) xadmin.site.register(alerts, AlertsAdmin) xadmin.site.register(production, ProductionAdmin) xadmin.site.register(alarmuser, AlarmuserAdmin) viewè§†å›¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 import json import smtplib from email.mime.text import MIMEText import yaml from dateutil import parser from django.http import HttpResponse from webhook.models import alerts as alerts_t, alarmuser from webhook.models import production import datetime from jinja2 import Environment, FileSystemLoader # è·å–htmlç›®å½• class ParseingTemplate: def __init__(self, templatefile): self.templatefile = templatefile def template(self, **kwargs): try: env = Environment(loader=FileSystemLoader(\u0026#39;templates\u0026#39;)) template = env.get_template(self.templatefile) template_content = template.render(kwargs) return template_content except Exception as error: raise error # æ—¶åŒºè½¬æ¢ï¼ˆå¢åŠ å…«ä¸ªå°æ—¶ï¼‰ def time_zone_conversion(utctime): format_time = parser.parse(utctime).strftime(\u0026#39;%Y-%m-%dT%H:%M:%SZ\u0026#39;) time_format = datetime.datetime.strptime(format_time, \u0026#34;%Y-%m-%dT%H:%M:%SZ\u0026#34;) return str(time_format + datetime.timedelta(hours=8)) # è·å–å‘Šè­¦äººçš„åˆ†ç»„å’Œé‚®ä»¶ def get_email(email_name=None, action=0): \u0026#34;\u0026#34;\u0026#34; :param email_name: å‘é€çš„é‚®ä»¶åˆ—è¡¨å :param action: æ“ä½œç±»å‹ï¼Œ0: æŸ¥è¯¢æ”¶ä»¶äººçš„é‚®ä»¶åœ°å€åˆ—è¡¨, 1: æŸ¥è¯¢æ”¶ä»¶äººçš„åˆ—è¡¨åç§°, 2: è·å–é‚®ä»¶è´¦å·ä¿¡æ¯ :return: æ ¹æ®actionçš„å€¼ï¼Œè¿”å›ä¸é€šçš„æ•°æ®ç»“æ„ \u0026#34;\u0026#34;\u0026#34; if action == 0: email = alarmuser.objects.filter(group=email_name) email_lsit = [] for i in email: email_lsit.append(i.useremail) print(\u0026#39;æ˜¾ç¤ºé‚®ä»¶\u0026#39;, email_lsit) return email_lsit elif action == 1: group_list = [] group = alarmuser.objects.values(\u0026#34;group\u0026#34;).distinct() for i in group: group_list.append(i[\u0026#39;group\u0026#39;]) print(\u0026#39;æ˜¾ç¤ºç»„:\u0026#39;, group_list) # è·å–é‚®ä»¶çš„åœ°å€çš„é…ç½® def get_email_conf(file, email_name=None, action=0): \u0026#34;\u0026#34;\u0026#34; :param file: yamlæ ¼å¼çš„æ–‡ä»¶ç±»å‹ :param email_name: å‘é€çš„é‚®ä»¶åˆ—è¡¨å :param action: æ“ä½œç±»å‹ï¼Œ0: æŸ¥è¯¢æ”¶ä»¶äººçš„é‚®ä»¶åœ°å€åˆ—è¡¨, 1: æŸ¥è¯¢æ”¶ä»¶äººçš„åˆ—è¡¨åç§°, 2: è·å–é‚®ä»¶è´¦å·ä¿¡æ¯ :return: æ ¹æ®actionçš„å€¼ï¼Œè¿”å›ä¸é€šçš„æ•°æ®ç»“æ„ \u0026#34;\u0026#34;\u0026#34; try: with open(file, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as fr: read_conf = yaml.safe_load(fr) if action == 0: for email in read_conf[\u0026#39;email\u0026#39;]: if email[\u0026#39;name\u0026#39;] == email_name: return email[\u0026#39;receive_addr\u0026#39;] else: print(\u0026#34;%s does not match for %s\u0026#34; % (email_name, file)) else: print(\u0026#34;No recipient address configured\u0026#34;) elif action == 1: return [items[\u0026#39;name\u0026#39;] for items in read_conf[\u0026#39;email\u0026#39;]] elif action == 2: return read_conf[\u0026#39;send\u0026#39;] except KeyError: print(\u0026#34;%s not exist\u0026#34; % email_name) exit(-1) except FileNotFoundError: print(\u0026#34;%s file not found\u0026#34; % file) exit(-2) except Exception as e: raise e # å‘é€é‚®ä»¶åœ°å€ def sendEmail(title, content, receivers=None): if receivers is None: receivers = [\u0026#39;chenf-o@glodon.com\u0026#39;] send_dict = get_email_conf(\u0026#39;email.yaml\u0026#39;, action=2) mail_host = send_dict[\u0026#39;smtp_host\u0026#39;] mail_user = send_dict[\u0026#39;send_user\u0026#39;] mail_pass = send_dict[\u0026#39;send_pass\u0026#39;] sender = send_dict[\u0026#39;send_addr\u0026#39;] print(mail_host, mail_user, mail_pass, sender) msg = MIMEText(content, \u0026#39;html\u0026#39;, \u0026#39;utf-8\u0026#39;) msg[\u0026#39;From\u0026#39;] = \u0026#34;{}\u0026#34;.format(sender) msg[\u0026#39;To\u0026#39;] = \u0026#34;,\u0026#34;.join(receivers) print(receivers) print(msg[\u0026#39;To\u0026#39;]) msg[\u0026#39;Subject\u0026#39;] = title try: smtpObj = smtplib.SMTP_SSL(mail_host, 465) smtpObj.login(mail_user, mail_pass) smtpObj.sendmail(sender, receivers, msg.as_string()) print(\u0026#39;mail send successful.\u0026#39;) except smtplib.SMTPException as e: print(e) # å…ˆä¿å­˜ï¼Œåå‘é‚®ä»¶ def webhook(request): if request.method == \u0026#34;GET\u0026#34;: # email = get_email(action=1) return HttpResponse(\u0026#39;ç¦æ­¢get\u0026#39;) if request.method == \u0026#39;POST\u0026#39;: try: request_data = request.body print(request_data.decode()) request_dict = json.loads(request_data.decode(\u0026#39;utf-8\u0026#39;)) alerts = request_dict[\u0026#39;alerts\u0026#39;] prometheus_data = json.loads(request.body) for i in alerts: msg = i[\u0026#39;annotations\u0026#39;][\u0026#39;message\u0026#39;] if \u0026#39;message\u0026#39; in i[\u0026#39;annotations\u0026#39;] else \u0026#39;null\u0026#39; if msg == \u0026#39;null\u0026#39; and \u0026#39;summary\u0026#39; in i[\u0026#39;annotations\u0026#39;]: msg = i[\u0026#39;annotations\u0026#39;][\u0026#39;summary\u0026#39;] print(i[\u0026#39;startsAt\u0026#39;][0:19] + i[\u0026#39;status\u0026#39;] + \u0026#34; :\u0026#34; + msg) if msg == \u0026#39;null\u0026#39;: print(i) ints = i[\u0026#39;labels\u0026#39;][\u0026#39;instance\u0026#39;] if \u0026#39;instance\u0026#39; in i[\u0026#39;labels\u0026#39;] else \u0026#39;unknown\u0026#39; print(ints + \u0026#34; --- \u0026#34; + i[\u0026#39;labels\u0026#39;][\u0026#39;alertname\u0026#39;] + \u0026#34; ---- \u0026#34; + i[\u0026#39;labels\u0026#39;][\u0026#39;severity\u0026#39;]) print(i[\u0026#39;endsAt\u0026#39;]) a = alerts_t() a.startsAt = time_zone_conversion(i[\u0026#39;startsAt\u0026#39;]) str = \u0026#39;0001-01-01\u0026#39; print(str in i[\u0026#39;endsAt\u0026#39;]) if (str in i[\u0026#39;endsAt\u0026#39;]): a.endsAt = \u0026#39;0001-01-01 00:00:00\u0026#39; else: a.endsAt = time_zone_conversion(i[\u0026#39;endsAt\u0026#39;]) print(a.endsAt) a.instance = ints a.alertname = i[\u0026#39;labels\u0026#39;][\u0026#39;alertname\u0026#39;] if i[\u0026#39;status\u0026#39;] == \u0026#39;firing\u0026#39;: a.status = \u0026#39;å‘Šè­¦ä¸­\u0026#39; if i[\u0026#39;status\u0026#39;] == \u0026#39;resolved\u0026#39;: a.status = \u0026#39;å·²æ¢å¤\u0026#39; a.known = True a.severity = i[\u0026#39;labels\u0026#39;][\u0026#39;severity\u0026#39;] a.message = msg a.save() startime = time_zone_conversion(i[\u0026#39;startsAt\u0026#39;]) endtime = a.endsAt instances = ints AlarmObject = production.objects.filter(startsAt=startime, endsAt=endtime, instance=instances) print(AlarmObject) if AlarmObject.exists(): pass else: b = production() b.startsAt = time_zone_conversion(i[\u0026#39;startsAt\u0026#39;]) # print(str in i[\u0026#39;endsAt\u0026#39;]) if (str in i[\u0026#39;endsAt\u0026#39;]): b.endsAt = \u0026#39;0001-01-01 00:00:00\u0026#39; else: b.endsAt = time_zone_conversion(i[\u0026#39;endsAt\u0026#39;]) # print(b.endsAt) b.instance = ints b.alertname = i[\u0026#39;labels\u0026#39;][\u0026#39;alertname\u0026#39;] if i[\u0026#39;status\u0026#39;] == \u0026#39;firing\u0026#39;: b.status = \u0026#39;å‘Šè­¦ä¸­\u0026#39; if i[\u0026#39;status\u0026#39;] == \u0026#39;resolved\u0026#39;: b.status = \u0026#39;å·²æ¢å¤\u0026#39; b.known = True b.severity = i[\u0026#39;labels\u0026#39;][\u0026#39;severity\u0026#39;] b.message = msg b.save() print(\u0026#39;æ˜¾ç¤ºa:\u0026#39;, a) # æ—¶é—´è½¬æ¢ï¼Œè½¬æ¢æˆä¸œå…«åŒºæ—¶é—´ for k, v in prometheus_data.items(): if k == \u0026#39;alerts\u0026#39;: for items in v: if items[\u0026#39;status\u0026#39;] == \u0026#39;firing\u0026#39;: items[\u0026#39;startsAt\u0026#39;] = time_zone_conversion(items[\u0026#39;startsAt\u0026#39;]) else: items[\u0026#39;startsAt\u0026#39;] = time_zone_conversion(items[\u0026#39;startsAt\u0026#39;]) items[\u0026#39;endsAt\u0026#39;] = time_zone_conversion(items[\u0026#39;endsAt\u0026#39;]) print(prometheus_data) team_name = prometheus_data[\u0026#34;commonLabels\u0026#34;][\u0026#34;team\u0026#34;] print(team_name) generate_html_template_subj = ParseingTemplate(\u0026#39;email_template_firing.html\u0026#39;) html_template_content = generate_html_template_subj.template( prometheus_monitor_info=prometheus_data ) # è·å–æ”¶ä»¶äººé‚®ä»¶åˆ—è¡¨ email_list = get_email(email_name=team_name, action=0) print(email_list) print(prometheus_data[\u0026#39;commonLabels\u0026#39;][\u0026#39;alertname\u0026#39;]) sendEmail( prometheus_data[\u0026#39;commonLabels\u0026#39;][\u0026#39;alertname\u0026#39;], html_template_content, receivers=email_list ) # return \u0026#34;prometheus monitor\u0026#34; return HttpResponse(1) except Exception as e: print(e) raise e # finally: # return HttpResponse(1) éœ€è¦å®Œæ•´ä»£ç ï¼Œè¯·ç•™è¨€\nç¨åæ•´ç†å®Œæ¯•ä¼ åˆ°githubä¸Š\nGitHub - nangongchengfeng/Alerts\nå±ä¸€æ ·çš„ä»£ç ï¼Œè¯·å¤§ä½¬å¿½ç•¥ã€‚åæœŸä¼šä½¿ç”¨falsk æ›´æ–°\n","date":"2022-04-03T15:44:28Z","image":"https://www.ownit.top/title_pic/65.jpg","permalink":"https://www.ownit.top/p/202204031544/","title":"Djangoå¼€å‘å‘Šè­¦æ¥å£ï¼ˆwebhookï¼‰å¯¹æ¥Altermanagerå‘Šè­¦"},{"content":"1.Adminç»„ä»¶ä½¿ç”¨\nDjangoå†…é›†æˆäº†webç®¡ç†å·¥å…·ï¼ŒDjangoåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œsetting.pyæ–‡ä»¶ï¼Œåˆå§‹åŒ–Djangoå†…ç½®ç»„ä»¶ã€æ³¨å†ŒAPPã€æ·»åŠ ç¯å¢ƒå˜é‡ç­‰\næç®€ç¾åŒ– æ•ˆæœå›¾\nç™»å½•é¡µé¢\nä¸»é¡µé¢\nä½¿ç”¨django-simpleuiæ¨¡å—ï¼›\nç›´æ¥pipå®‰è£…å³å¯ï¼š\n1 pip install django-simpleui ç„¶ååœ¨setting.pyä¸­æ³¨å†Œå³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 INSTALLED_APPS = [ \u0026#39;simpleui\u0026#39;, #ä¸»è¦æ˜¯è¿™ä¸ªç¾åŒ–é¡µé¢çš„ \u0026#39;django.contrib.admin\u0026#39;, \u0026#39;django.contrib.auth\u0026#39;, \u0026#39;django.contrib.contenttypes\u0026#39;, \u0026#39;django.contrib.sessions\u0026#39;, \u0026#39;django.contrib.messages\u0026#39;, \u0026#39;django.contrib.staticfiles\u0026#39;, \u0026#39;blog.apps.BlogConfig\u0026#39;, # æ³¨å†Œappåº”ç”¨ \u0026#39;DjangoUeditor\u0026#39;, # æ³¨å†ŒAPPåº”ç”¨ ] ç„¶åå°±å®Œäº‹äº†ï¼Œæ‰“å¼€adminå³å¯ï¼Œå¦‚ä¸‹ï¼š\n","date":"2022-03-18T21:44:27Z","image":"https://www.ownit.top/title_pic/56.jpg","permalink":"https://www.ownit.top/p/202203182144/","title":"Django adminæç®€ç¾åŒ–"},{"content":"åœºæ™¯ï¼š å…¬å¸ä¸šåŠ¡å˜æ›´ï¼Œéƒ¨åˆ†æœºå™¨éœ€è¦å˜æ›´ï¼Œä¸‹çº¿é‡æ–°è°ƒæ•´ç›¸å…³çš„ä¸šåŠ¡ã€‚\næˆ‘ä»¬æœºå™¨ä¸Šæœ‰zabbixå’Œprometheusç›‘æ§ï¼Œä¸‹çº¿éœ€è¦æ¸…ç©ºè¿™äº›ç›‘æ§ã€‚\nprometheusæ¯”è¾ƒç›‘æ§ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨consulè‡ªåŠ¨æ³¨å†Œã€‚\nzabbix åˆ é™¤ä¸‹çº¿å°±å¾ˆéº»çƒ¦ã€‚ä¸€å°å°±å¯ä»¥æ‰‹åŠ¨åˆ é™¤ï¼Œä½†æ˜¯ä¸Šç™¾å°é‚£ï¼Œä¸€ä¸ªä¸ªæ‰‹åŠ¨å—ï¼Œå¾ˆéº»çƒ¦çš„ã€‚\næ‰€ä»¥ç›´æ¥è€ƒè™‘zabbixçš„APiæ¥æ‰¹é‡åˆ é™¤ä¸»æœº\nä»‹ç» ä»£ç æ”¾åœ¨ä¸‹æ–¹\nä»£ç ä½¿ç”¨çš„æ˜¯python2.0çš„\nå› ä¸ºæˆ‘æ˜¯çº¯å†…ç½‘ç¯å¢ƒéœ€è¦å…ˆåœ¨å¤–ç½‘éƒ¨ç½²å¥½ç¯å¢ƒ ï¼Œç„¶åæ‰“åŒ…ä½¿ç”¨çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 Python3è™šæ‹Ÿç¯å¢ƒåˆ›å»º /usr/local/python3/bin/python3.7 -m venv py3 åŠ è½½è™šæ‹Ÿç¯å¢ƒ source py3/bin/activate å®‰è£…ä¾èµ– pip install -r requirements.txt ç”Ÿæˆä¾èµ– pip freeze \u0026gt; requirements.txt python2 è™šæ‹Ÿç¯å¢ƒ 1.å®‰è£…virtualenv pip install virtualenv 2.åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ virtualenv è™šæ‹Ÿç¯å¢ƒåç§° 3.æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ source è™šæ‹Ÿç¯å¢ƒç›®å½•/bin/activate ï¼ˆ./è™šæ‹Ÿç¯å¢ƒç›®å½•/bin/activateï¼‰ 4.é€€å‡ºè™šæ‹Ÿç¯å¢ƒ deactivate æˆ‘ä»¬é‡‡ç”¨python2.0åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 [root@zabbix zabbix]# virtualenv py2 [root@zabbix zabbix]# ls py2 zbx_tool.py [root@zabbix zabbix]# source py2/ bin/ .gitignore include/ lib/ lib64/ pyvenv.cfg python wheel2 [root@zabbix zabbix]# source py2/bin/activate (py2) [root@zabbix zabbix]# ls py2 zbx_tool.py (py2) [root@zabbix zabbix]# pip install argparse ......... (py2) [root@zabbix zabbix]# ls py2 zbx_tool.py (py2) [root@zabbix zabbix]# python æ‰“åŒ… ä¸Šä¼ è™šæ‹Ÿç¯å¢ƒ tar -zcvf zabbix.tar.gz zabbix ä¸Šä¼ å†…ç½‘ç¯å¢ƒè¿›è¡Œè§£å‹ï¼Œç„¶ååŠ è½½å°±å¯ä»¥ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ\n1 source py2/bin/activate ç”Ÿäº§ç¯å¢ƒå®æˆ˜ åˆ é™¤å•å°ä¸»æœº æ‰¹é‡åˆ é™¤ forå¾ªç¯åˆ é™¤ é¦–å…ˆæ–°å»ºæœ‰ä¸€ä¸ªæ–‡æœ¬ï¼Œç„¶åé€šè¿‡for å¾ªç¯æ‰¹é‡åˆ é™¤\n1 for ip in `cat zabbixip`;do python zbx_tool.py --delete $ip ;done **Â å¼€å§‹**\næ‰¹é‡æ“ä½œ\nä»£ç  é›†åˆè„šæœ¬ï¼ŒåŒ…å«æŸ¥è¯¢ä¸»æœºï¼Œä¸»æœºç»„ï¼Œæ¨¡æ¿ï¼Œæ·»åŠ å¼€å¯ç¦ç”¨åˆ é™¤ä¸»æœºç­‰åŠŸèƒ½\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 #!/usr/bin/env python #-*- coding: utf-8 -*- import json import sys import urllib2 import argparse from urllib2 import URLError reload(sys) sys.setdefaultencoding(\u0026#39;utf-8\u0026#39;) class zabbix_api: def __init__(self): self.url = \u0026#39;http://zabbix.xxx.com/api_jsonrpc.php\u0026#39; self.header = {\u0026#34;Content-Type\u0026#34;:\u0026#34;application/json\u0026#34;} def user_login(self): data = json.dumps({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;user.login\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;user\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;zabbix\u0026#34; }, \u0026#34;id\u0026#34;: 0 }) request = urllib2.Request(self.url, data) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) except URLError as e: print \u0026#34;\\033[041m è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥URL !\\033[0m\u0026#34;,e.code except KeyError as e: print \u0026#34;\\033[041m è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå¯†ç  !\\033[0m\u0026#34;,e else: response = json.loads(result.read()) result.close() #print response[\u0026#39;result\u0026#39;] self.authID = response[\u0026#39;result\u0026#39;] return self.authID def hostid_get_hostname(self, hostId=\u0026#39;\u0026#39;): data = json.dumps({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;host.get\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;output\u0026#34;: \u0026#34;extend\u0026#34;, \u0026#34;filter\u0026#34;: {\u0026#34;hostid\u0026#34;: hostId} }, \u0026#34;auth\u0026#34;: self.user_login(), \u0026#34;id\u0026#34;: 1 }) request = urllib2.Request(self.url, data) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) except URLError as e: if hasattr(e, \u0026#39;reason\u0026#39;): print \u0026#39;We failed to reach a server.\u0026#39; print \u0026#39;Reason: \u0026#39;, e.reason elif hasattr(e, \u0026#39;code\u0026#39;): print \u0026#39;The server could not fulfill the request.\u0026#39; print \u0026#39;Error code: \u0026#39;, e.code else: response = json.loads(result.read()) #print response result.close() if not len(response[\u0026#39;result\u0026#39;]): print \u0026#34;hostId is not exist\u0026#34; return False #print \u0026#34;ä¸»æœºæ•°é‡: \\33[31m%s\\33[0m\u0026#34; % (len(response[\u0026#39;result\u0026#39;])) host_dict=dict() for host in response[\u0026#39;result\u0026#39;]: status = {\u0026#34;0\u0026#34;: \u0026#34;OK\u0026#34;, \u0026#34;1\u0026#34;: \u0026#34;Disabled\u0026#34;} available = {\u0026#34;0\u0026#34;: \u0026#34;Unknown\u0026#34;, \u0026#34;1\u0026#34;: \u0026#34;available\u0026#34;, \u0026#34;2\u0026#34;: \u0026#34;Unavailable\u0026#34;} #if len(hostId) == 0: # print \u0026#34;HostID : %s\\t HostName : %s\\t Status :\\33[32m%s\\33[0m \\t Available :\\33[31m%s\\33[0m\u0026#34; % ( # host[\u0026#39;hostid\u0026#39;], host[\u0026#39;name\u0026#39;], status[host[\u0026#39;status\u0026#39;]], available[host[\u0026#39;available\u0026#39;]]) #else: # print \u0026#34;HostID : %s\\t HostName : %s\\t Status :\\33[32m%s\\33[0m \\t Available :\\33[31m%s\\33[0m\u0026#34; % ( # host[\u0026#39;hostid\u0026#39;], host[\u0026#39;name\u0026#39;], status[host[\u0026#39;status\u0026#39;]], available[host[\u0026#39;available\u0026#39;]]) host_dict[\u0026#39;name\u0026#39;]=host[\u0026#39;name\u0026#39;] host_dict[\u0026#39;status\u0026#39;]=status[host[\u0026#39;status\u0026#39;]] host_dict[\u0026#39;available\u0026#39;]=available[host[\u0026#39;available\u0026#39;]] return host_dict def hostid_get_hostip(self, hostId=\u0026#39;\u0026#39;): data = json.dumps({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;hostinterface.get\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;output\u0026#34;: \u0026#34;extend\u0026#34;, \u0026#34;filter\u0026#34;: {\u0026#34;hostid\u0026#34;: hostId} }, \u0026#34;auth\u0026#34;: self.user_login(), \u0026#34;id\u0026#34;: 1 }) request = urllib2.Request(self.url, data) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) except URLError as e: if hasattr(e, \u0026#39;reason\u0026#39;): print \u0026#39;We failed to reach a server.\u0026#39; print \u0026#39;Reason: \u0026#39;, e.reason elif hasattr(e, \u0026#39;code\u0026#39;): print \u0026#39;The server could not fulfill the request.\u0026#39; print \u0026#39;Error code: \u0026#39;, e.code else: response = json.loads(result.read()) # print response result.close() if not len(response[\u0026#39;result\u0026#39;]): print \u0026#34;\\033[041m hostid \\033[0m is not exist\u0026#34; return False #print \u0026#34;ä¸»æœºæ•°é‡: \\33[31m%s\\33[0m\u0026#34; % (len(response[\u0026#39;result\u0026#39;])) for hostip in response[\u0026#39;result\u0026#39;]: #print hostip #if len(hostip) == 0: # print \u0026#34;HostID : %s\\t HostIp : %s \\t Port : %s \u0026#34; % (hostip[\u0026#39;hostid\u0026#39;], hostip[\u0026#39;ip\u0026#39;], hostip[\u0026#39;port\u0026#39;]) #else: # print \u0026#34;HostID : %s\\t HostIp :\\33[32m%s\\33[0m \\t Port :\\33[31m%s\\33[0m\u0026#34; % ( # hostip[\u0026#39;hostid\u0026#39;], hostip[\u0026#39;ip\u0026#39;], hostip[\u0026#39;port\u0026#39;]) return hostip[\u0026#39;ip\u0026#39;] def host_get(self,hostName=\u0026#39;\u0026#39;): data=json.dumps({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;host.get\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;output\u0026#34;: \u0026#34;extend\u0026#34;, #\u0026#34;filter\u0026#34;:{\u0026#34;host\u0026#34;:\u0026#34;\u0026#34;} \u0026#34;filter\u0026#34;:{\u0026#34;host\u0026#34;:hostName} }, \u0026#34;auth\u0026#34;: self.user_login(), \u0026#34;id\u0026#34;: 1 }) request = urllib2.Request(self.url,data) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) except URLError as e: if hasattr(e, \u0026#39;reason\u0026#39;): print \u0026#39;We failed to reach a server.\u0026#39; print \u0026#39;Reason: \u0026#39;, e.reason elif hasattr(e, \u0026#39;code\u0026#39;): print \u0026#39;The server could not fulfill the request.\u0026#39; print \u0026#39;Error code: \u0026#39;, e.code else: response = json.loads(result.read()) #print reqponse result.close() if not len(response[\u0026#39;result\u0026#39;]): print \u0026#34;\\033[041m %s \\033[0m is not exist\u0026#34; % hostName return False print \u0026#34;ä¸»æœºæ•°é‡: \\033[31m%s\\033[0m\u0026#34;%(len(response[\u0026#39;result\u0026#39;])) for host in response[\u0026#39;result\u0026#39;]: status={\u0026#34;0\u0026#34;:\u0026#34;OK\u0026#34;,\u0026#34;1\u0026#34;:\u0026#34;Disabled\u0026#34;} available={\u0026#34;0\u0026#34;:\u0026#34;Unknown\u0026#34;,\u0026#34;1\u0026#34;:\u0026#34;available\u0026#34;,\u0026#34;2\u0026#34;:\u0026#34;Unavailable\u0026#34;} #print host if len(hostName)==0: print \u0026#34;HostID : %s\\t HostName : %s\\t HostIp : %s\\t Status :%s \\t Available :%s\u0026#34;%(host[\u0026#39;hostid\u0026#39;],host[\u0026#39;name\u0026#39;],self.hostid_get_hostip(hostId=host[\u0026#39;hostid\u0026#39;]),status[host[\u0026#39;status\u0026#39;]],available[host[\u0026#39;available\u0026#39;]]) else: print \u0026#34;HostID : %s\\t HostName : %s\\t HostIp : %s\\t Status :\\033[32m%s\\033[0m \\t Available :\\033[31m%s\\033[0m\u0026#34;%(host[\u0026#39;hostid\u0026#39;],host[\u0026#39;name\u0026#39;],self.hostid_get_hostip(hostId=host[\u0026#39;hostid\u0026#39;]),status[host[\u0026#39;status\u0026#39;]],available[host[\u0026#39;available\u0026#39;]]) return host[\u0026#39;hostid\u0026#39;] def hostip_get(self, hostIp=\u0026#39;\u0026#39;): data = json.dumps({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;hostinterface.get\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;output\u0026#34;: \u0026#34;extend\u0026#34;, \u0026#34;filter\u0026#34;: {\u0026#34;ip\u0026#34;: hostIp} }, \u0026#34;auth\u0026#34;: self.user_login(), \u0026#34;id\u0026#34;: 1 }) request = urllib2.Request(self.url, data) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) except URLError as e: if hasattr(e, \u0026#39;reason\u0026#39;): print \u0026#39;We failed to reach a server.\u0026#39; print \u0026#39;Reason: \u0026#39;, e.reason elif hasattr(e, \u0026#39;code\u0026#39;): print \u0026#39;The server could not fulfill the request.\u0026#39; print \u0026#39;Error code: \u0026#39;, e.code else: response = json.loads(result.read()) # print response result.close() if not len(response[\u0026#39;result\u0026#39;]): print \u0026#34;\\033[041m hostip \\033[0m is not exist\u0026#34; return False print \u0026#34;ä¸»æœºæ•°é‡: \\33[31m%s\\33[0m\u0026#34; % (len(response[\u0026#39;result\u0026#39;])) for hostip in response[\u0026#39;result\u0026#39;]: host = self.hostid_get_hostname(hostip[\u0026#39;hostid\u0026#39;]) if len(hostip) == 0: print \u0026#34;HostID : %s\\t HostName : %s\\t HostIp : %s\\t Status :\\33[32m%s\\33[0m \\t Available :\\33[31m%s\\33[0m\u0026#34;%(hostip[\u0026#39;hostid\u0026#39;],host[\u0026#39;name\u0026#39;],hostip[\u0026#39;ip\u0026#39;],host[\u0026#39;status\u0026#39;],host[\u0026#39;available\u0026#39;]) else: print \u0026#34;HostID : %s\\t HostName : %s\\t HostIp : %s\\t Status :\\33[32m%s\\33[0m \\t Available :\\33[31m%s\\33[0m\u0026#34;%(hostip[\u0026#39;hostid\u0026#39;],host[\u0026#39;name\u0026#39;],hostip[\u0026#39;ip\u0026#39;],host[\u0026#39;status\u0026#39;],host[\u0026#39;available\u0026#39;]) return hostip[\u0026#39;hostid\u0026#39;] def hostgroup_get(self, hostgroupName=\u0026#39;\u0026#39;): data = json.dumps({ \u0026#34;jsonrpc\u0026#34;:\u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;:\u0026#34;hostgroup.get\u0026#34;, \u0026#34;params\u0026#34;:{ \u0026#34;output\u0026#34;: \u0026#34;extend\u0026#34;, \u0026#34;filter\u0026#34;: { \u0026#34;name\u0026#34;: hostgroupName } }, \u0026#34;auth\u0026#34;:self.user_login(), \u0026#34;id\u0026#34;:1, }) request = urllib2.Request(self.url,data) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) except URLError as e: print \u0026#34;Error as \u0026#34;, e else: # result.read() response = json.loads(result.read()) result.close() #print response() if not len(response[\u0026#39;result\u0026#39;]): print \u0026#34;\\033[041m %s \\033[0m is not exist\u0026#34; % hostgroupName return False for group in response[\u0026#39;result\u0026#39;]: if len(hostgroupName)==0: print \u0026#34;hostgroup: \\033[31m%s\\033[0m \\tgroupid : %s\u0026#34; %(group[\u0026#39;name\u0026#39;],group[\u0026#39;groupid\u0026#39;]) else: print \u0026#34;hostgroup: \\033[31m%s\\033[0m\\tgroupid : %s\u0026#34; %(group[\u0026#39;name\u0026#39;],group[\u0026#39;groupid\u0026#39;]) self.hostgroupID = group[\u0026#39;groupid\u0026#39;] return group[\u0026#39;groupid\u0026#39;] def template_get(self,templateName=\u0026#39;\u0026#39;): data = json.dumps({ \u0026#34;jsonrpc\u0026#34;:\u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;template.get\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;output\u0026#34;: \u0026#34;extend\u0026#34;, \u0026#34;filter\u0026#34;: { \u0026#34;name\u0026#34;:templateName } }, \u0026#34;auth\u0026#34;:self.user_login(), \u0026#34;id\u0026#34;:1, }) request = urllib2.Request(self.url, data) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) except URLError as e: print \u0026#34;Error as \u0026#34;, e else: response = json.loads(result.read()) result.close() #print response if not len(response[\u0026#39;result\u0026#39;]): print \u0026#34;\\033[041m %s \\033[0m is not exist\u0026#34; % templateName return False for template in response[\u0026#39;result\u0026#39;]: if len(templateName)==0: print \u0026#34;template : %s \\t id : %s\u0026#34; % (template[\u0026#39;name\u0026#39;], template[\u0026#39;templateid\u0026#39;]) else: self.templateID = response[\u0026#39;result\u0026#39;][0][\u0026#39;templateid\u0026#39;] print \u0026#34;Template Name :%s\u0026#34;%templateName return response[\u0026#39;result\u0026#39;][0][\u0026#39;templateid\u0026#39;] def hostgroup_create(self,hostgroupName): if self.hostgroup_get(hostgroupName): print \u0026#34;hostgroup \\033[42m%s\\033[0m is exist !\u0026#34; % hostgroupName sys.exit(1) data = json.dumps({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;hostgroup.create\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;name\u0026#34;: hostgroupName }, \u0026#34;auth\u0026#34;: self.user_login(), \u0026#34;id\u0026#34;: 1 }) request=urllib2.Request(self.url,data) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) except URLError as e: print \u0026#34;Error as \u0026#34;, e else: response = json.loads(result.read()) result.close() print \u0026#34;æ·»åŠ ä¸»æœºç»„:%s hostgroupID : %s\u0026#34;%(hostgroupName,self.hostgroup_get(hostgroupName)) def host_create(self, hostIp, hostgroupName, templateName, hostName): if self.host_get(hostName) or self.hostip_get(hostIp): print \u0026#34;è¯¥ä¸»æœºå·²ç»æ·»åŠ !\u0026#34; sys.exit(1) group_list=[] template_list=[] for i in hostgroupName.split(\u0026#39;,\u0026#39;): var = {} var[\u0026#39;groupid\u0026#39;] = self.hostgroup_get(i) group_list.append(var) for i in templateName.split(\u0026#39;,\u0026#39;): var={} var[\u0026#39;templateid\u0026#39;]=self.template_get(i) template_list.append(var) data = json.dumps({ \u0026#34;jsonrpc\u0026#34;:\u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;:\u0026#34;host.create\u0026#34;, \u0026#34;params\u0026#34;:{ \u0026#34;host\u0026#34;: hostName, \u0026#34;interfaces\u0026#34;: [ { \u0026#34;type\u0026#34;: 1, \u0026#34;main\u0026#34;: 1, \u0026#34;useip\u0026#34;: 1, \u0026#34;ip\u0026#34;: hostIp, \u0026#34;dns\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;port\u0026#34;: \u0026#34;10050\u0026#34; } ], \u0026#34;groups\u0026#34;: group_list, \u0026#34;templates\u0026#34;: template_list, }, \u0026#34;auth\u0026#34;: self.user_login(), \u0026#34;id\u0026#34;:1 }) request = urllib2.Request(self.url, data) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) response = json.loads(result.read()) result.close() print \u0026#34;add host : %s id :%s\u0026#34; % (hostIp, hostName) except URLError as e: print \u0026#34;Error as \u0026#34;, e except KeyError as e: print \u0026#34;\\033[041m ä¸»æœºæ·»åŠ æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥æ¨¡æ¿æ­£ç¡®æ€§æˆ–ä¸»æœºæ˜¯å¦æ·»åŠ é‡å¤ !\\033[0m\u0026#34;,e print response def host_disable(self,hostip): data=json.dumps({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;host.update\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;hostid\u0026#34;: self.host_get(hostip), \u0026#34;status\u0026#34;: 1 }, \u0026#34;auth\u0026#34;: self.user_login(), \u0026#34;id\u0026#34;: 1 }) request = urllib2.Request(self.url,data) #opener = urllib2.build_opener(urllib2.HTTPBasicAuthHandler(TerminalPassword())) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) #result = opener.open(request) except URLError as e: print \u0026#34;Error as \u0026#34;, e else: response = json.loads(result.read()) result.close() print \u0026#39;------------ä¸»æœºç°åœ¨çŠ¶æ€------------\u0026#39; print self.host_get(hostip) def host_enable(self,hostip): data=json.dumps({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;host.update\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;hostid\u0026#34;: self.host_get(hostip), \u0026#34;status\u0026#34;: 0 }, \u0026#34;auth\u0026#34;: self.user_login(), \u0026#34;id\u0026#34;: 1 }) request = urllib2.Request(self.url,data) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) #result = opener.open(request) except URLError as e: print \u0026#34;Error as \u0026#34;, e else: response = json.loads(result.read()) result.close() print \u0026#39;------------ä¸»æœºç°åœ¨çŠ¶æ€------------\u0026#39; print self.host_get(hostip) def host_delete(self,hostNames): hostid_list=[] for hostName in hostNames.split(\u0026#39;,\u0026#39;): hostid = self.host_get(hostName=hostName) if not hostid: print \u0026#34;ä¸»æœº \\033[041m %s\\033[0m åˆ é™¤å¤±è´¥ !\u0026#34; % hostName sys.exit() hostid_list.append(hostid) data=json.dumps({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;host.delete\u0026#34;, \u0026#34;params\u0026#34;: hostid_list, \u0026#34;auth\u0026#34;: self.user_login(), \u0026#34;id\u0026#34;: 1 }) request = urllib2.Request(self.url,data) for key in self.header: request.add_header(key, self.header[key]) try: result = urllib2.urlopen(request) result.close() print \u0026#34;ä¸»æœº \\033[041m %s\\033[0m å·²ç»åˆ é™¤ !\u0026#34; % hostName except Exception,e: print e if __name__ == \u0026#34;__main__\u0026#34;: zabbix=zabbix_api() parser=argparse.ArgumentParser(description=\u0026#39;zabbix api \u0026#39;,usage=\u0026#39;%(prog)s [options]\u0026#39;) parser.add_argument(\u0026#39;-H\u0026#39;,\u0026#39;--host\u0026#39;,nargs=\u0026#39;?\u0026#39;,dest=\u0026#39;listhost\u0026#39;,default=\u0026#39;host\u0026#39;,help=\u0026#39;æŸ¥è¯¢ä¸»æœº\u0026#39;) parser.add_argument(\u0026#39;-G\u0026#39;,\u0026#39;--group\u0026#39;,nargs=\u0026#39;?\u0026#39;,dest=\u0026#39;listgroup\u0026#39;,default=\u0026#39;group\u0026#39;,help=\u0026#39;æŸ¥è¯¢ä¸»æœºç»„\u0026#39;) parser.add_argument(\u0026#39;-T\u0026#39;,\u0026#39;--template\u0026#39;,nargs=\u0026#39;?\u0026#39;,dest=\u0026#39;listtemp\u0026#39;,default=\u0026#39;template\u0026#39;,help=\u0026#39;æŸ¥è¯¢æ¨¡æ¿ä¿¡æ¯\u0026#39;) parser.add_argument(\u0026#39;-A\u0026#39;,\u0026#39;--add-group\u0026#39;,nargs=1,dest=\u0026#39;addgroup\u0026#39;,help=\u0026#39;æ·»åŠ ä¸»æœºç»„\u0026#39;) parser.add_argument(\u0026#39;-C\u0026#39;,\u0026#39;--add-host\u0026#39;,dest=\u0026#39;addhost\u0026#39;,nargs=4,metavar=(\u0026#39;192.168.2.1\u0026#39;, \u0026#39;groupname\u0026#39;, \u0026#39;Template01,Template02\u0026#39;, \u0026#39;hostName\u0026#39;),help=\u0026#39;æ·»åŠ ä¸»æœº,å¤šä¸ªä¸»æœºç»„æˆ–æ¨¡æ¿ä½¿ç”¨é€—å·\u0026#39;) parser.add_argument(\u0026#39;-d\u0026#39;,\u0026#39;--disable\u0026#39;,dest=\u0026#39;disablehost\u0026#39;,nargs=\u0026#39;+\u0026#39;,metavar=(\u0026#39;sh-aa-01\u0026#39;),help=\u0026#39;ç¦ç”¨ä¸»æœº,å¡«å†™ä¸»æœºåï¼Œå¤šä¸ªä¸»æœºåä¹‹é—´ç”¨é€—å·\u0026#39;) parser.add_argument(\u0026#39;-e\u0026#39;,\u0026#39;--enable\u0026#39;,dest=\u0026#39;enablehost\u0026#39;,nargs=1,metavar=(\u0026#39;sh-aa-01\u0026#39;),help=\u0026#39;å¼€å¯ä¸»æœº\u0026#39;) parser.add_argument(\u0026#39;-D\u0026#39;,\u0026#39;--delete\u0026#39;,dest=\u0026#39;deletehost\u0026#39;,nargs=\u0026#39;+\u0026#39;,metavar=(\u0026#39;sh-aa-01\u0026#39;),help=\u0026#39;åˆ é™¤ä¸»æœº,å¤šä¸ªä¸»æœºä¹‹é—´ç”¨é€—å·\u0026#39;) parser.add_argument(\u0026#39;-v\u0026#39;,\u0026#39;--version\u0026#39;, action=\u0026#39;version\u0026#39;, version=\u0026#39;%(prog)s 1.0\u0026#39;) if len(sys.argv) == 1: #print parser.print_help() #print zabbix.host_get(hostName=\u0026#39;bbb\u0026#39;) #print zabbix.hostip_get(hostIp=\u0026#39;127.0.0.1\u0026#39;) #print zabbix.hostid_get_hostname(hostId=\u0026#39;10108\u0026#39;) #print zabbix.hostid_get_hostid(hostId=\u0026#39;10105\u0026#39;) #print zabbix.hostgroup_get(hostgroupName=\u0026#39;Linux servers\u0026#39;) #print zabbix.hostgroup_get(hostgroupName=\u0026#39;aaa\u0026#39;) # ... print zabbix.host_delete(\u0026#39;hz-aaa-02\u0026#39;) else: args = parser.parse_args() if args.listhost != \u0026#39;host\u0026#39;: if args.listhost: zabbix.host_get(args.listhost) else: zabbix.host_get() if args.listgroup != \u0026#39;group\u0026#39;: if args.listgroup: zabbix.hostgroup_get(args.listgroup) else: zabbix.hostgroup_get() if args.listtemp != \u0026#39;template\u0026#39;: if args.listtemp: zabbix.template_get(args.listtemp) else: zabbix.template_get() if args.addgroup: zabbix.hostgroup_create(args.addgroup[0]) if args.addhost: zabbix.host_create(args.addhost[0], args.addhost[1], args.addhost[2], args.addhost[3]) if args.disablehost: zabbix.host_disable(args.disablehost) if args.deletehost: zabbix.host_delete(args.deletehost[0]) ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 \u0026gt; python zbx_tool.py -h usage: zbx_tool.py [options] zabbix api optional arguments: -h, --help show this help message and exit -H [LISTHOST], --host [LISTHOST] æŸ¥è¯¢ä¸»æœº -G [LISTGROUP], --group [LISTGROUP] æŸ¥è¯¢ä¸»æœºç»„ -T [LISTTEMP], --template [LISTTEMP] æŸ¥è¯¢æ¨¡æ¿ä¿¡æ¯ -A ADDGROUP, --add-group ADDGROUP æ·»åŠ ä¸»æœºç»„ -C 192.168.2.1 groupname Template01,Template02 hostName, --add-host 192.168.2.1 groupname Template01,Template02 hostName æ·»åŠ ä¸»æœº,å¤šä¸ªä¸»æœºç»„æˆ–æ¨¡æ¿ä½¿ç”¨é€—å· -d sh-aa-01 [sh-aa-01 ...], --disable sh-aa-01 [sh-aa-01 ...] ç¦ç”¨ä¸»æœº,å¡«å†™ä¸»æœºåï¼Œå¤šä¸ªä¸»æœºåä¹‹é—´ Â¨é€—å· -e sh-aa-01, --enable sh-aa-01 å¼€å¯ä¸»æœº -D sh-aa-01 [sh-aa-01 ...], --delete sh-aa-01 [sh-aa-01 ...] åˆ é™¤ä¸»æœº,å¤šä¸ªä¸»æœºä¹‹é—´ç”¨é€—å· -v, --version show program\u0026#39;s version number and exit ç›¸å…³åšå®¢\nåˆ©ç”¨zabbix APIæ‰¹é‡æŸ¥è¯¢ä¸»æœºã€æ¨¡æ¿ã€æ·»åŠ åˆ é™¤ä¸»æœº - ä»£ç å…ˆé”‹ç½‘\n","date":"2022-03-16T12:50:02Z","image":"https://www.ownit.top/title_pic/60.jpg","permalink":"https://www.ownit.top/p/202203161250/","title":"Zabbixçš„APIæ‰¹é‡æ·»åŠ ï¼Œåˆ é™¤ä¸»æœºï¼ˆç”Ÿäº§å®æˆ˜ï¼‰"},{"content":" å®¹å™¨æœ¬èº«ç‰¹æ€§ï¼š é‡‡é›†ç›®æ ‡å¤šï¼šå®¹å™¨æœ¬èº«çš„ç‰¹æ€§å¯¼è‡´é‡‡é›†ç›®æ ‡å¤šï¼Œéœ€è¦é‡‡é›†å®¹å™¨å†…æ—¥å¿—ã€å®¹å™¨ stdoutã€‚å¯¹äºå®¹å™¨å†…éƒ¨çš„æ–‡ä»¶æ—¥å¿—é‡‡é›†ï¼Œç°åœ¨å¹¶æ²¡æœ‰ä¸€ä¸ªå¾ˆå¥½çš„å·¥å…·èƒ½å¤Ÿå»åŠ¨æ€å‘ç°é‡‡é›†ã€‚é’ˆå¯¹æ¯ç§æ•°æ®æºéƒ½æœ‰å¯¹åº”çš„é‡‡é›†è½¯ä»¶ï¼Œä½†ç¼ºä¹ä¸€ç«™å¼çš„å·¥å…·ã€‚ å¼¹æ€§ä¼¸ç¼©éš¾ï¼škubernetes æ˜¯åˆ†å¸ƒå¼çš„é›†ç¾¤ï¼ŒæœåŠ¡ã€ç¯å¢ƒçš„å¼¹æ€§ä¼¸ç¼©å¯¹äºæ—¥å¿—é‡‡é›†å¸¦æ¥äº†å¾ˆå¤§çš„å›°éš¾ï¼Œæ— æ³•åƒä¼ ç»Ÿè™šæ‹Ÿæœºç¯å¢ƒä¸‹é‚£æ ·ï¼Œäº‹å…ˆé…ç½®å¥½æ—¥å¿—çš„é‡‡é›†è·¯å¾„ç­‰ä¿¡æ¯ï¼Œé‡‡é›†çš„åŠ¨æ€æ€§ä»¥åŠæ•°æ®å®Œæ•´æ€§æ˜¯éå¸¸å¤§çš„æŒ‘æˆ˜ã€‚ ç°æœ‰æ—¥å¿—å·¥å…·çš„ä¸€äº›ç¼ºé™·ï¼š ç¼ºä¹åŠ¨æ€é…ç½®çš„èƒ½åŠ›ã€‚ç›®å‰çš„é‡‡é›†å·¥å…·éƒ½éœ€è¦äº‹å…ˆæ‰‹åŠ¨é…ç½®å¥½æ—¥å¿—é‡‡é›†æ–¹å¼å’Œè·¯å¾„ç­‰ä¿¡æ¯ï¼Œå› ä¸ºå®ƒæ— æ³•èƒ½å¤Ÿè‡ªåŠ¨æ„ŸçŸ¥åˆ°å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸå˜åŒ–æˆ–è€…åŠ¨æ€æ¼‚ç§»ï¼Œæ‰€ä»¥å®ƒæ— æ³•åŠ¨æ€åœ°å»é…ç½®ã€‚ æ—¥å¿—é‡‡é›†é‡å¤æˆ–ä¸¢å¤±çš„é—®é¢˜ã€‚å› ä¸ºç°åœ¨çš„ä¸€äº›é‡‡é›†å·¥å…·åŸºæœ¬ä¸Šæ˜¯é€šè¿‡ tail çš„æ–¹å¼æ¥è¿›è¡Œæ—¥å¿—é‡‡é›†çš„ï¼Œé‚£ä¹ˆè¿™é‡Œå°±å¯èƒ½å­˜åœ¨ä¸¤ä¸ªæ–¹é¢çš„é—®é¢˜ï¼šä¸€ä¸ªæ˜¯å¯èƒ½å¯¼è‡´æ—¥å¿—ä¸¢å¤±ï¼Œæ¯”å¦‚é‡‡é›†å·¥å…·åœ¨é‡å¯çš„è¿‡ç¨‹ä¸­ï¼Œè€Œåº”ç”¨ä¾ç„¶åœ¨å†™æ—¥å¿—ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½å¯¼è‡´è¿™ä¸ªçª—å£æœŸçš„æ—¥å¿—ä¸¢å¤±ï¼›è€Œå¯¹äºè¿™ç§æƒ…å†µä¸€èˆ¬ä¿å®ˆçš„åšæ³•å°±æ˜¯ï¼Œé»˜è®¤å¾€å‰å¤šé‡‡é›† 1M æ—¥å¿—æˆ– 2M çš„æ—¥å¿—ï¼Œé‚£ä¹ˆè¿™å°±åˆä¼šå¯èƒ½å¼•èµ·æ—¥å¿—é‡‡é›†é‡å¤çš„é—®é¢˜ã€‚ æœªæ˜ç¡®æ ‡è®°æ—¥å¿—æºã€‚å› ä¸ºä¸€ä¸ªåº”ç”¨å¯èƒ½æœ‰å¾ˆå¤šä¸ªå®¹å™¨ï¼Œè¾“å‡ºçš„åº”ç”¨æ—¥å¿—ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬å°†æ‰€æœ‰åº”ç”¨æ—¥å¿—æ”¶é›†åˆ°ç»Ÿä¸€æ—¥å¿—å­˜å‚¨åç«¯æ—¶ï¼Œåœ¨æœç´¢æ—¥å¿—çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±æ— æ³•æ˜ç¡®è¿™æ¡æ—¥å¿—å…·ä½“æ˜¯å“ªä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„å“ªä¸€ä¸ªåº”ç”¨å®¹å™¨äº§ç”Ÿçš„ã€‚ æœ¬æ–‡æ¡£å°†ä»‹ç»ä¸€ç§ Docker æ—¥å¿—æ”¶é›†å·¥å…· log-pilotï¼Œç»“åˆ Elasticsearch å’Œ kibana ç­‰å·¥å…·ï¼Œå½¢æˆä¸€å¥—é€‚ç”¨äº kubernetes ç¯å¢ƒä¸‹çš„ä¸€ç«™å¼æ—¥å¿—è§£å†³æ–¹æ¡ˆã€‚\nGitHub - AliyunContainerService/log-pilot: Collect logs for docker containersCollect logs for docker containers. Contribute to AliyunContainerService/log-pilot development by creating an account on GitHub.https://github.com/AliyunContainerService/log-pilotå®¹å™¨æ—¥å¿—é‡‡é›†åˆ©å™¨Log-Pilot-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒºå®¹å™¨æ—¶ä»£è¶Šæ¥è¶Šå¤šçš„ä¼ ç»Ÿåº”ç”¨å°†ä¼šé€æ¸å®¹å™¨åŒ–ï¼Œè€Œæ—¥å¿—åˆæ˜¯åº”ç”¨çš„ä¸€ä¸ªå…³é”®ç¯èŠ‚ï¼Œé‚£ä¹ˆåœ¨åº”ç”¨å®¹å™¨åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•æ–¹ä¾¿å¿«æ·é«˜æ•ˆåœ°æ¥è‡ªåŠ¨å‘ç°å’Œé‡‡é›†åº”ç”¨çš„æ—¥å¿—ï¼Œå¦‚ä½•ä¸æ—¥å¿—å­˜å‚¨ç³»ç»ŸååŒæ¥é«˜æ•ˆå­˜å‚¨å’Œæœç´¢åº”ç”¨æ—¥å¿—ï¼Œæœ¬æ–‡å°†ä¸»è¦è·Ÿå¤§å®¶åˆ†äº«ä¸‹å¦‚ä½•é€šè¿‡Log-Pilotæ¥é‡‡é›†å®¹å™¨çš„æ ‡å‡†è¾“å‡ºæ—¥å¿—å’Œå®¹å™¨å†…æ–‡ä»¶æ—¥å¿—ã€‚https://developer.aliyun.com/article/674327\nLog-Pilot æ”¯æŒå®¹å™¨äº‹ä»¶ç®¡ç†ï¼Œå®ƒèƒ½å¤ŸåŠ¨æ€åœ°ç›‘å¬å®¹å™¨çš„äº‹ä»¶å˜åŒ–ï¼Œç„¶åä¾æ®å®¹å™¨çš„æ ‡ç­¾æ¥è¿›è¡Œè§£æï¼Œç”Ÿæˆæ—¥å¿—é‡‡é›†é…ç½®æ–‡ä»¶ï¼Œç„¶åäº¤ç”±é‡‡é›†æ’ä»¶æ¥è¿›è¡Œæ—¥å¿—é‡‡é›†ã€‚\nç›¸å…³ç‰¹ç‚¹å’Œä¼˜åŠ¿ï¼Œå¯ä»¥ç‚¹å‡»ä¸Šæ–¹çš„é“¾æ¥å­¦ä¹ ã€‚\næ–¹æ¡ˆ ä»æ—¥å¿—çš„é‡‡é›†æ–¹å¼ä¸Šï¼Œåœ¨æˆ‘çœ‹æ¥æ–¹æ¡ˆå¤§è‡´ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼š\n**ï¼ˆ1ï¼‰POD é‡Œé¢å®‰è£…logging agent**\næ¯ä¸ªpodé‡Œé¢éƒ½è¦å®‰è£…ä¸€ä¸ªagentï¼Œæ— è®ºæ˜¯ä»¥æ”¾åœ¨æœ¬containerè¿˜æ˜¯ä»¥sidecarçš„æ–¹å¼éƒ¨ç½²ï¼Œå¾ˆæ˜æ˜¾ä¼šå ç”¨å¾ˆå¤šèµ„æºï¼ŒåŸºæœ¬ä¸æ¨è\n**ï¼ˆ2ï¼‰åœ¨èŠ‚ç‚¹ä¸Šå®‰è£…logging agentï¼ˆæ¨èï¼‰**\nå…¶å®å®¹å™¨stdout,stderrçš„æ—¥å¿—æœ€ç»ˆä¹Ÿæ˜¯è½åœ¨å®¿ä¸»æœºä¸Šï¼Œè€Œå®¹å™¨å†…çš„è·¯å¾„å¯ä»¥é€šè¿‡é…ç½®volumeMount åœ¨å®¿ä¸»æœºä¸Šé…ç½®æ˜ å°„å³å¯ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼è¿˜æ˜¯æœ€å¯è¡Œçš„\nå½“ç„¶åº”ç”¨è¿˜å¯ä»¥è‡ªå·±é€šè¿‡ä»£ç ç›´æ¥ä¸ŠæŠ¥ç»™æ—¥å¿—æœåŠ¡ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ä¸å¤Ÿé€šç”¨ï¼Œè¿˜å¢åŠ äº†ä¸šåŠ¡ä»£ç çš„å¤æ‚æ€§\nlog-Pilotæ˜¯ä¸€ä¸ªæ™ºèƒ½å®¹å™¨æ—¥å¿—é‡‡é›†å·¥å…·ï¼Œå®ƒä¸ä»…èƒ½å¤Ÿé«˜æ•ˆä¾¿æ·åœ°å°†å®¹å™¨æ—¥å¿—é‡‡é›†è¾“å‡ºåˆ°å¤šç§å­˜å‚¨æ—¥å¿—åç«¯ï¼ŒåŒæ—¶è¿˜èƒ½å¤ŸåŠ¨æ€åœ°å‘ç°å’Œé‡‡é›†å®¹å™¨å†…éƒ¨çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ›´å¤šå’¨è¯¢å¯ä»¥ç§»æ­¥è¿™é‡Œã€‚\nlog-Pilotç›®å‰æ”¯æŒä¸¤ç§å·¥å…·å¯¹æ—¥å¿—è¿›è¡Œæ”¶é›†ï¼ŒFluentd PluginÂ å’ŒÂ Filebeat Pluginã€‚\nLog-Pilotæ”¯æŒå®¹å™¨äº‹ä»¶ç®¡ç†ï¼Œå®ƒèƒ½å¤ŸåŠ¨æ€åœ°ç›‘å¬å®¹å™¨çš„äº‹ä»¶å˜åŒ–ï¼Œç„¶åä¾æ®å®¹å™¨çš„æ ‡ç­¾æ¥è¿›è¡Œè§£æï¼Œç”Ÿæˆæ—¥å¿—é‡‡é›†é…ç½®æ–‡ä»¶ï¼Œç„¶åäº¤ç”±é‡‡é›†æ’ä»¶æ¥è¿›è¡Œæ—¥å¿—é‡‡é›†\nä»¥ä¸‹çš„çš„å®‰è£…é…ç½®ï¼Œæ˜¯åŸºäºä¸Šä¸€ç¯‡çš„EFKçš„é…ç½®ï¼Œåªæ˜¯ä¿®æ”¹æ”¶é›†ç«¯ï¼ˆæœ‰å¿…è¦ï¼Œå¯ä»¥äº†è§£ä¸Šä¸€ç¯‡çš„æ–‡ç« ï¼‰\nKuberneteså®‰è£…EFKæ—¥å¿—æ”¶é›†_å—å®«ä¹˜é£-Linuxè¿ç»´-è™šæ‹ŸåŒ–å®¹å™¨-Pythonç¼–ç¨‹ ownit.top-CSDNåšå®¢\nå‡†å¤‡ å‚è€ƒå®˜æ–¹éƒ¨ç½²æ–‡æ¡£çš„åŸºç¡€ä¸Šä½¿ç”¨æœ¬é¡¹ç›®manifests/efk/éƒ¨ç½²ï¼Œä»¥ä¸‹ä¸ºå‡ ç‚¹ä¸»è¦çš„ä¿®æ”¹ï¼š\nå¢åŠ Â log-Pilot éƒ¨ç½²ä»£ç ï¼ˆè§£å†³ ä¸æ”¯æŒ es7.0 ç‰ˆæœ¬ä»¥ä¸Šçš„ç—›ç‚¹ï¼‰ ä¿®æ”¹å®˜æ–¹dockeré•œåƒï¼Œæ–¹ä¾¿å›½å†…ä¸‹è½½åŠ é€Ÿ ä¿®æ”¹ es-statefulset.yaml æ”¯æŒæ—¥å¿—å­˜å‚¨æŒä¹…åŒ–ç­‰ å¢åŠ è‡ªåŠ¨æ¸…ç†æ—¥å¿— åˆ›å»º Elasticsearch é›†ç¾¤ 1 2 3 4 apiVersion: v1 kind: Namespace metadata: name: logging 1ã€Â es-service.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 kind: Service apiVersion: v1 metadata: name: elasticsearch namespace: logging labels: app: elasticsearch spec: selector: app: elasticsearch clusterIP: None ports: - port: 9200 name: rest - port: 9300 name: inter-node å®šä¹‰äº†ä¸€ä¸ªåä¸º elasticsearch çš„ Serviceï¼ŒæŒ‡å®šæ ‡ç­¾Â app=elasticsearchï¼Œå½“æˆ‘ä»¬å°† Elasticsearch StatefulSet ä¸æ­¤æœåŠ¡å…³è”æ—¶ï¼ŒæœåŠ¡å°†è¿”å›å¸¦æœ‰æ ‡ç­¾Â app=elasticsearchçš„ Elasticsearch Pods çš„ DNS A è®°å½•ï¼Œç„¶åè®¾ç½®Â clusterIP=Noneï¼Œå°†è¯¥æœåŠ¡è®¾ç½®æˆæ— å¤´æœåŠ¡ã€‚æœ€åï¼Œæˆ‘ä»¬åˆ†åˆ«å®šä¹‰ç«¯å£9200ã€9300ï¼Œåˆ†åˆ«ç”¨äºä¸ REST API äº¤äº’ï¼Œä»¥åŠç”¨äºèŠ‚ç‚¹é—´é€šä¿¡ã€‚Â 1 2 3 4 5 [root@master01 efk]# kubectl apply -f es-service.yaml service/elasticsearch-logging created [root@master01 efk]# kubectl get svc -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE elasticsearch-logging ClusterIP None \u0026lt;none\u0026gt; 9200/TCP 15s es-statefulset.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 apiVersion: apps/v1 kind: StatefulSet metadata: name: es namespace: logging spec: serviceName: elasticsearch replicas: 3 selector: matchLabels: app: elasticsearch template: metadata: labels: app: elasticsearch spec: nodeSelector: #è®°å¾—ç»™èŠ‚ç‚¹æŠŠæ ‡ç­¾ï¼Œä¸ç„¶ä¼šæ‰¾åˆ°ä¸ç¬¦åˆçš„èŠ‚ç‚¹ es: log initContainers: - name: increase-vm-max-map image: busybox command: [\u0026#34;sysctl\u0026#34;, \u0026#34;-w\u0026#34;, \u0026#34;vm.max_map_count=262144\u0026#34;] securityContext: privileged: true - name: increase-fd-ulimit image: busybox command: [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;ulimit -n 65536\u0026#34;] securityContext: privileged: true containers: - name: elasticsearch image: docker.elastic.co/elasticsearch/elasticsearch:7.6.2 ports: - name: rest containerPort: 9200 - name: inter containerPort: 9300 resources: limits: cpu: 1000m requests: cpu: 1000m volumeMounts: - name: data mountPath: /usr/share/elasticsearch/data env: - name: cluster.name value: k8s-logs - name: node.name valueFrom: fieldRef: fieldPath: metadata.name - name: cluster.initial_master_nodes value: \u0026#34;es-0,es-1,es-2\u0026#34; - name: discovery.zen.minimum_master_nodes value: \u0026#34;2\u0026#34; - name: discovery.seed_hosts value: \u0026#34;elasticsearch\u0026#34; - name: ES_JAVA_OPTS value: \u0026#34;-Xms512m -Xmx512m\u0026#34; - name: network.host value: \u0026#34;0.0.0.0\u0026#34; volumeClaimTemplates: - metadata: name: data labels: app: elasticsearch spec: accessModes: [ \u0026#34;ReadWriteOnce\u0026#34; ] storageClassName: nfsdata resources: requests: storage: 5Gi Pods éƒ¨ç½²å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯·æ±‚ä¸€ä¸ª REST API æ¥æ£€æŸ¥ Elasticsearch é›†ç¾¤æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°†æœ¬åœ°ç«¯å£9200 è½¬å‘åˆ° Elasticsearch èŠ‚ç‚¹ï¼ˆå¦‚es-0ï¼‰å¯¹åº”çš„ç«¯å£ï¼š\n1 2 3 [root@master01 new]# kubectl port-forward es-0 9200:9200 --namespace=logging Forwarding from 127.0.0.1:9200 -\u0026gt; 9200 Forwarding from [::1]:9200 -\u0026gt; 9200 1 curl http://localhost:9200/_cluster/state?pretty çœ‹åˆ°ä¸Šé¢çš„ä¿¡æ¯å°±è¡¨æ˜æˆ‘ä»¬åä¸º k8s-logs çš„ Elasticsearch é›†ç¾¤æˆåŠŸåˆ›å»ºäº†3ä¸ªèŠ‚ç‚¹ï¼šes-0ï¼Œes-1ï¼Œå’Œes-2ï¼Œå½“å‰ä¸»èŠ‚ç‚¹æ˜¯ es-0\nåˆ›å»º Kibana æœåŠ¡ Elasticsearch é›†ç¾¤å¯åŠ¨æˆåŠŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥æ¥éƒ¨ç½² Kibana æœåŠ¡ï¼Œæ–°å»ºä¸€ä¸ªåä¸º kibana.yaml çš„æ–‡ä»¶ï¼Œå¯¹åº”çš„æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\nkibana.yamlÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 apiVersion: v1 kind: Service metadata: name: kibana namespace: logging labels: app: kibana spec: ports: - port: 5601 type: NodePort selector: app: kibana --- apiVersion: apps/v1 kind: Deployment metadata: name: kibana namespace: logging labels: app: kibana spec: selector: matchLabels: app: kibana template: metadata: labels: app: kibana spec: nodeSelector: es: log containers: - name: kibana image: docker.elastic.co/kibana/kibana:7.6.2 resources: limits: cpu: 1000m requests: cpu: 1000m env: - name: ELASTICSEARCH_HOSTS value: http://elasticsearch:9200 ports: - containerPort: 5601 ä¸Šé¢æˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªèµ„æºå¯¹è±¡ï¼Œä¸€ä¸ª Service å’Œ Deploymentï¼Œä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°† Service è®¾ç½®ä¸ºäº† NodePort ç±»å‹ï¼ŒKibana Pod ä¸­é…ç½®éƒ½æ¯”è¾ƒç®€å•ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ä½¿ç”¨Â ELASTICSEARCH_HOSTSÂ è¿™ä¸ªç¯å¢ƒå˜é‡æ¥è®¾ç½®Elasticsearch é›†ç¾¤çš„ç«¯ç‚¹å’Œç«¯å£ï¼Œç›´æ¥ä½¿ç”¨ Kubernetes DNS å³å¯ï¼Œæ­¤ç«¯ç‚¹å¯¹åº”æœåŠ¡åç§°ä¸º elasticsearchï¼Œç”±äºæ˜¯ä¸€ä¸ª headless serviceï¼Œæ‰€ä»¥è¯¥åŸŸå°†è§£æä¸º3ä¸ª Elasticsearch Pod çš„ IP åœ°å€åˆ—è¡¨ã€‚Â é…ç½®å®Œæˆåï¼Œç›´æ¥ä½¿ç”¨ kubectl å·¥å…·åˆ›å»ºï¼š\n1 2 3 kubectl create -f kibana.yaml service/kibana created deployment.apps/kibana created åˆ›å»ºå®Œæˆåï¼Œå¯ä»¥æŸ¥çœ‹ Kibana Pod çš„è¿è¡ŒçŠ¶æ€\n1 2 3 4 5 6 [root@master01 new]# kubectl get pods --namespace=logging NAME READY STATUS RESTARTS AGE es-0 1/1 Running 0 13m es-1 1/1 Running 0 9m48s es-2 1/1 Running 0 7m46s kibana-8476dc9bbf-6mm6k 1/1 Running 0 3m2s å¦‚æœ Pod å·²ç»æ˜¯ Running çŠ¶æ€äº†ï¼Œè¯æ˜åº”ç”¨å·²ç»éƒ¨ç½²æˆåŠŸäº†ï¼Œç„¶åå¯ä»¥é€šè¿‡ NodePort æ¥è®¿é—® Kibana è¿™ä¸ªæœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€http://\u0026lt;ä»»æ„èŠ‚ç‚¹IP\u0026gt;:31838å³å¯ï¼Œ\nå‡ºç° è¿™ä¸ªä»£è¡¨æˆåŠŸ\néƒ¨ç½² log-Pilot Log-pilotæ˜¯ä¸€ä¸ªæ™ºèƒ½å®¹å™¨æ—¥å¿—é‡‡é›†å·¥å…·ï¼Œå®ƒä¸ä»…èƒ½å¤Ÿé«˜æ•ˆä¾¿æ·åœ°å°†å®¹å™¨æ—¥å¿—é‡‡é›†è¾“å‡ºåˆ°å¤šç§å­˜å‚¨æ—¥å¿—åç«¯ï¼ŒåŒæ—¶è¿˜èƒ½å¤ŸåŠ¨æ€åœ°å‘ç°å’Œé‡‡é›†å®¹å™¨å†…éƒ¨çš„æ—¥å¿—æ–‡ä»¶ã€‚\né’ˆå¯¹å‰é¢æå‡ºçš„æ—¥å¿—é‡‡é›†éš¾é¢˜ï¼ŒLog-piloté€šè¿‡å£°æ˜å¼é…ç½®å®ç°å¼ºå¤§çš„å®¹å™¨äº‹ä»¶ç®¡ç†ï¼Œå¯åŒæ—¶è·å–å®¹å™¨æ ‡å‡†è¾“å‡ºå’Œå†…éƒ¨æ–‡ä»¶æ—¥å¿—ï¼Œè§£å†³äº†åŠ¨æ€ä¼¸ç¼©é—®é¢˜ï¼Œæ­¤å¤–ï¼ŒLog-pilotå…·æœ‰è‡ªåŠ¨å‘ç°æœºåˆ¶ã€CheckPointåŠå¥æŸ„ä¿æŒçš„æœºåˆ¶ã€è‡ªåŠ¨æ—¥å¿—æ•°æ®æ‰“æ ‡ã€æœ‰æ•ˆåº”å¯¹åŠ¨æ€é…ç½®ã€æ—¥å¿—é‡å¤å’Œä¸¢å¤±ä»¥åŠæ—¥å¿—æºæ ‡è®°ç­‰é—®é¢˜ã€‚\næœ¬è´¨\né€šè¿‡å˜é‡å’Œæ¨¡ç‰ˆæ–‡ä»¶ç”Ÿäº§æ—¥å¿—æ”¶é›†é…ç½®æ–‡ä»¶ï¼Œå¯¹æ—¥å¿—è¿›è¡Œé‡‡é›†ã€‚\nå®¹å™¨å†…æ–‡ä»¶æ—¥å¿—è·¯å¾„éœ€è¦é…ç½®emptyDir\nlog-pilot.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 apiVersion: apps/v1 kind: DaemonSet metadata: name: log-pilot labels: app: log-pilot # è®¾ç½®æœŸæœ›éƒ¨ç½²çš„namespaceã€‚ namespace: logging spec: selector: matchLabels: app: log-pilot updateStrategy: type: RollingUpdate template: metadata: labels: app: log-pilot annotations: scheduler.alpha.kubernetes.io/critical-pod: \u0026#39;\u0026#39; spec: # æ˜¯å¦å…è®¸éƒ¨ç½²åˆ°MasterèŠ‚ç‚¹ä¸Štolerationsã€‚ tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule containers: - name: log-pilot # ç‰ˆæœ¬è¯·å‚è€ƒhttps://github.com/AliyunContainerService/log-pilot/releasesã€‚ image: heleicool/log-pilot:7.x-filebeat resources: limits: memory: 500Mi requests: cpu: 200m memory: 200Mi env: - name: \u0026#34;NODE_NAME\u0026#34; valueFrom: fieldRef: fieldPath: spec.nodeName - name: \u0026#34;LOGGING_OUTPUT\u0026#34; value: \u0026#34;elasticsearch\u0026#34; # è¯·ç¡®ä¿é›†ç¾¤åˆ°ESç½‘ç»œå¯è¾¾ã€‚ - name: \u0026#34;ELASTICSEARCH_HOSTS\u0026#34; value: \u0026#34;elasticsearch:9200\u0026#34; # é…ç½®ESè®¿é—®æƒé™ã€‚ # - name: \u0026#34;ELASTICSEARCH_USER\u0026#34; # value: \u0026#34;{es_username}\u0026#34; # - name: \u0026#34;ELASTICSEARCH_PASSWORD\u0026#34; # value: \u0026#34;{es_password}\u0026#34; volumeMounts: - name: sock mountPath: /var/run/docker.sock - name: root mountPath: /host readOnly: true - name: varlib mountPath: /var/lib/filebeat - name: varlog mountPath: /var/log/filebeat - name: localtime mountPath: /etc/localtime readOnly: true livenessProbe: failureThreshold: 3 exec: command: - /pilot/healthz initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 2 securityContext: capabilities: add: - SYS_ADMIN terminationGracePeriodSeconds: 30 volumes: - name: sock hostPath: path: /var/run/docker.sock - name: root hostPath: path: / - name: varlib hostPath: path: /var/lib/filebeat type: DirectoryOrCreate - name: varlog hostPath: path: /var/log/filebeat type: DirectoryOrCreate - name: localtime hostPath: path: /etc/localtime é»˜è®¤é˜¿é‡Œäº‘ä»“åº“åªæ”¯æŒ7.xä»¥ä¸‹ç‰ˆæœ¬esçš„æ•°æ®å†™å…¥ï¼Œä½¿ç”¨å¦‚ä¸‹æ’ä»¶å¯ä»¥å®ç°ã€‚\ngitåœ°å€ï¼šhttps://github.com/40kuai/log-pilot/tree/filebeat7.x\ndockerhubï¼šheleicool/log-pilot:7.x-filebeat\næœåŠ¡æ—¥å¿—é‡‡é›† åˆ›å»ºä¸€ä¸ªæ ‡å‡†çš„ Nginx æœåŠ¡, ä¸»è¦æ˜¯ env æ·»åŠ äº†ä¸¤ç§,ä¸Šé¢æˆ‘ä»¬ä»‹ç»è¿‡\nä¸€ æ˜¯ åŸºäº docker stdout è¾“å‡ºæ—¥å¿— (aliyun_logs_catalina)\näºŒ æ˜¯ åŸºäº ç¨‹åºæŒ‡å®šè¾“å‡ºåˆ°æŒ‡å®šçš„ç›®å½•ä¸­ (aliyun_logs_access)\n( elasticsearch )ç¯å¢ƒå˜é‡ä¸­çš„ nameè¡¨ç¤ºIndexï¼Œè¿™é‡Œname è¡¨ç¤º Indexï¼Œè¿™é‡Œ nameè¡¨ç¤ºIndexï¼Œè¿™é‡Œname å³æ˜¯ catalina å’Œ access, è¿™é‡Œç”¨äº Kibana æŸ¥è¯¢æ—¥å¿—\nnginx.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 apiVersion: apps/v1 kind: Deployment metadata: name: nginx-dm spec: replicas: 3 selector: matchLabels: name: nginx template: metadata: labels: name: nginx spec: tolerations: - key: \u0026#34;node-role.kubernetes.io/master\u0026#34; effect: \u0026#34;NoSchedule\u0026#34; containers: - name: nginx image: nginx:alpine imagePullPolicy: IfNotPresent env: - name: aliyun_logs_nginx-log value: \u0026#34;stdout\u0026#34; - name: aliyun_logs_access value: \u0026#34;/var/log/nginx/*.log\u0026#34; ports: - containerPort: 80 name: http --- apiVersion: v1 kind: Service metadata: name: nginx-svc spec: ports: - port: 80 name: http targetPort: 80 protocol: TCP selector: name: nginx pod.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 [root@master01 new]# cat pod2.yaml apiVersion: v1 kind: Pod metadata: name: counter namespace: logging #å¯ä»¥æ·»åŠ ç©ºé—´åç§°ï¼Œä¹Ÿä¼šæ”¶é›†åˆ°çš„ spec: containers: - name: count image: busybox args: [/bin/sh, -c, \u0026#39;i=0; while true; do echo \u0026#34;$i: $(date)\u0026#34;; i=$((i+1)); sleep 1; done\u0026#39;] env: # 1ã€stdoutä¸ºçº¦å®šå…³é”®å­—ï¼Œè¡¨ç¤ºé‡‡é›†æ ‡å‡†è¾“å‡ºæ—¥å¿—ã€‚ # 2ã€é…ç½®æ ‡å‡†è¾“å‡ºæ—¥å¿—é‡‡é›†åˆ°ESçš„catalinaç´¢å¼•ä¸‹ã€‚ - name: aliyun_logs_catalina value: \u0026#34;stdout\u0026#34; # 1ã€é…ç½®é‡‡é›†å®¹å™¨å†…æ–‡ä»¶æ—¥å¿—ï¼Œæ”¯æŒé€šé…ç¬¦ã€‚ # 2ã€é…ç½®è¯¥æ—¥å¿—é‡‡é›†åˆ°ESçš„accessç´¢å¼•ä¸‹ã€‚ tomcat.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 apiVersion: v1 kind: Pod metadata: name: tomcat spec: containers: - name: tomcat image: \u0026#34;tomcat:7.0\u0026#34; env: # 1ã€stdoutä¸ºçº¦å®šå…³é”®å­—ï¼Œè¡¨ç¤ºé‡‡é›†æ ‡å‡†è¾“å‡ºæ—¥å¿—ã€‚ # 2ã€é…ç½®æ ‡å‡†è¾“å‡ºæ—¥å¿—é‡‡é›†åˆ°ESçš„catalinaç´¢å¼•ä¸‹ã€‚ - name: aliyun_logs_catalina value: \u0026#34;stdout\u0026#34; # 1ã€é…ç½®é‡‡é›†å®¹å™¨å†…æ–‡ä»¶æ—¥å¿—ï¼Œæ”¯æŒé€šé…ç¬¦ã€‚ # 2ã€é…ç½®è¯¥æ—¥å¿—é‡‡é›†åˆ°ESçš„accessç´¢å¼•ä¸‹ã€‚ - name: aliyun_logs_access value: \u0026#34;/usr/local/tomcat/logs/catalina.*.log\u0026#34; # å®¹å™¨å†…æ–‡ä»¶æ—¥å¿—è·¯å¾„éœ€è¦é…ç½®emptyDirã€‚ volumeMounts: - name: tomcat-log mountPath: /usr/local/tomcat/logs volumes: - name: tomcat-log emptyDir: {} k8s éƒ¨ç½² log-pilot æ”¶é›†å®¹å™¨æ ‡å‡†è¾“å‡ºæ—¥å¿—å’ŒæŒ‡å®šè·¯å¾„åº”ç”¨æ—¥å¿— - lixinliang - åšå®¢å›­\n","date":"2022-03-12T19:40:43Z","image":"https://www.ownit.top/title_pic/29.jpg","permalink":"https://www.ownit.top/p/202203121940/","title":"Kubernetesé«˜æ•ˆæ”¶é›†ç”Ÿäº§æ—¥å¿—"},{"content":"Kubernetes ä¸­æ¯”è¾ƒæµè¡Œçš„æ—¥å¿—æ”¶é›†è§£å†³æ–¹æ¡ˆæ˜¯Â Elasticsearchã€FluentdÂ å’ŒÂ Kibanaï¼ˆEFKï¼‰æŠ€æœ¯æ ˆï¼Œä¹Ÿæ˜¯å®˜æ–¹ç°åœ¨æ¯”è¾ƒæ¨èçš„ä¸€ç§æ–¹æ¡ˆã€‚\nåç»­æˆ‘ä¼šæ›´æ–°ä½¿ç”¨Log-Pilot + ES + Kibana æ—¥å¿—æ–¹æ¡ˆ\nElasticsearchÂ æ˜¯ä¸€ä¸ªå®æ—¶çš„ã€åˆ†å¸ƒå¼çš„å¯æ‰©å±•çš„æœç´¢å¼•æ“ï¼Œå…è®¸è¿›è¡Œå…¨æ–‡ã€ç»“æ„åŒ–æœç´¢ï¼Œå®ƒé€šå¸¸ç”¨äºç´¢å¼•å’Œæœç´¢å¤§é‡æ—¥å¿—æ•°æ®ï¼Œä¹Ÿå¯ç”¨äºæœç´¢è®¸å¤šä¸åŒç±»å‹çš„æ–‡æ¡£ã€‚\nElasticsearch é€šå¸¸ä¸Â KibanaÂ ä¸€èµ·éƒ¨ç½²ï¼ŒKibana æ˜¯ Elasticsearch çš„ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æ•°æ®å¯è§†åŒ– Dashboardï¼ŒKibana å…è®¸ä½ é€šè¿‡ web ç•Œé¢æ¥æµè§ˆ Elasticsearch æ—¥å¿—æ•°æ®ã€‚\nFluentdæ˜¯ä¸€ä¸ªæµè¡Œçš„å¼€æºæ•°æ®æ”¶é›†å™¨ï¼Œæˆ‘ä»¬å°†åœ¨ Kubernetes é›†ç¾¤èŠ‚ç‚¹ä¸Šå®‰è£… Fluentdï¼Œé€šè¿‡è·å–å®¹å™¨æ—¥å¿—æ–‡ä»¶ã€è¿‡æ»¤å’Œè½¬æ¢æ—¥å¿—æ•°æ®ï¼Œç„¶åå°†æ•°æ®ä¼ é€’åˆ° Elasticsearch é›†ç¾¤ï¼Œåœ¨è¯¥é›†ç¾¤ä¸­å¯¹å…¶è¿›è¡Œç´¢å¼•å’Œå­˜å‚¨ã€‚\næˆ‘ä»¬å…ˆæ¥é…ç½®å¯åŠ¨ä¸€ä¸ªå¯æ‰©å±•çš„ Elasticsearch é›†ç¾¤ï¼Œç„¶ååœ¨ Kubernetes é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ª Kibana åº”ç”¨ï¼Œæœ€åé€šè¿‡ DaemonSet æ¥è¿è¡Œ Fluentdï¼Œä»¥ä¾¿å®ƒåœ¨æ¯ä¸ª Kubernetes å·¥ä½œèŠ‚ç‚¹ä¸Šéƒ½å¯ä»¥è¿è¡Œä¸€ä¸ª Podã€‚\nå®˜æ–¹æ–‡æ¡£ï¼š\nhttps://github.com/kubernetes/kubernetes/tree/release-1.22/cluster/addons/fluentd-elasticsearch\nå‡†å¤‡ å‚è€ƒå®˜æ–¹éƒ¨ç½²æ–‡æ¡£çš„åŸºç¡€ä¸Šä½¿ç”¨æœ¬é¡¹ç›®manifests/efk/éƒ¨ç½²ï¼Œä»¥ä¸‹ä¸ºå‡ ç‚¹ä¸»è¦çš„ä¿®æ”¹ï¼š\nä¿®æ”¹ fluentd-es-configmap.yaml ä¸­çš„éƒ¨åˆ† journald æ—¥å¿—æºï¼ˆå¢åŠ é›†ç¾¤ç»„ä»¶æœåŠ¡æ—¥å¿—æœé›†ï¼‰ ä¿®æ”¹å®˜æ–¹dockeré•œåƒï¼Œæ–¹ä¾¿å›½å†…ä¸‹è½½åŠ é€Ÿ ä¿®æ”¹ es-statefulset.yaml æ”¯æŒæ—¥å¿—å­˜å‚¨æŒä¹…åŒ–ç­‰ å¢åŠ è‡ªåŠ¨æ¸…ç†æ—¥å¿— åˆ›å»º Elasticsearch é›†ç¾¤ 1 2 3 4 apiVersion: v1 kind: Namespace metadata: name: logging 1ã€Â es-service.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 kind: Service apiVersion: v1 metadata: name: elasticsearch namespace: logging labels: app: elasticsearch spec: selector: app: elasticsearch clusterIP: None ports: - port: 9200 name: rest - port: 9300 name: inter-node å®šä¹‰äº†ä¸€ä¸ªåä¸º elasticsearch çš„ Serviceï¼ŒæŒ‡å®šæ ‡ç­¾Â app=elasticsearchï¼Œå½“æˆ‘ä»¬å°† Elasticsearch StatefulSet ä¸æ­¤æœåŠ¡å…³è”æ—¶ï¼ŒæœåŠ¡å°†è¿”å›å¸¦æœ‰æ ‡ç­¾Â app=elasticsearchçš„ Elasticsearch Pods çš„ DNS A è®°å½•ï¼Œç„¶åè®¾ç½®Â clusterIP=Noneï¼Œå°†è¯¥æœåŠ¡è®¾ç½®æˆæ— å¤´æœåŠ¡ã€‚æœ€åï¼Œæˆ‘ä»¬åˆ†åˆ«å®šä¹‰ç«¯å£9200ã€9300ï¼Œåˆ†åˆ«ç”¨äºä¸ REST API äº¤äº’ï¼Œä»¥åŠç”¨äºèŠ‚ç‚¹é—´é€šä¿¡ã€‚Â 1 2 3 4 5 [root@master01 efk]# kubectl apply -f es-service.yaml service/elasticsearch-logging created [root@master01 efk]# kubectl get svc -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE elasticsearch-logging ClusterIP None \u0026lt;none\u0026gt; 9200/TCP 15s es-statefulset.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 apiVersion: apps/v1 kind: StatefulSet metadata: name: es namespace: logging spec: serviceName: elasticsearch replicas: 3 selector: matchLabels: app: elasticsearch template: metadata: labels: app: elasticsearch spec: nodeSelector: #è®°å¾—ç»™èŠ‚ç‚¹æŠŠæ ‡ç­¾ï¼Œä¸ç„¶ä¼šæ‰¾åˆ°ä¸ç¬¦åˆçš„èŠ‚ç‚¹ es: log initContainers: - name: increase-vm-max-map image: busybox command: [\u0026#34;sysctl\u0026#34;, \u0026#34;-w\u0026#34;, \u0026#34;vm.max_map_count=262144\u0026#34;] securityContext: privileged: true - name: increase-fd-ulimit image: busybox command: [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;ulimit -n 65536\u0026#34;] securityContext: privileged: true containers: - name: elasticsearch image: docker.elastic.co/elasticsearch/elasticsearch:7.6.2 ports: - name: rest containerPort: 9200 - name: inter containerPort: 9300 resources: limits: cpu: 1000m requests: cpu: 1000m volumeMounts: - name: data mountPath: /usr/share/elasticsearch/data env: - name: cluster.name value: k8s-logs - name: node.name valueFrom: fieldRef: fieldPath: metadata.name - name: cluster.initial_master_nodes value: \u0026#34;es-0,es-1,es-2\u0026#34; - name: discovery.zen.minimum_master_nodes value: \u0026#34;2\u0026#34; - name: discovery.seed_hosts value: \u0026#34;elasticsearch\u0026#34; - name: ES_JAVA_OPTS value: \u0026#34;-Xms512m -Xmx512m\u0026#34; - name: network.host value: \u0026#34;0.0.0.0\u0026#34; volumeClaimTemplates: - metadata: name: data labels: app: elasticsearch spec: accessModes: [ \u0026#34;ReadWriteOnce\u0026#34; ] storageClassName: nfsdata resources: requests: storage: 5Gi Pods éƒ¨ç½²å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯·æ±‚ä¸€ä¸ª REST API æ¥æ£€æŸ¥ Elasticsearch é›†ç¾¤æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°†æœ¬åœ°ç«¯å£9200 è½¬å‘åˆ° Elasticsearch èŠ‚ç‚¹ï¼ˆå¦‚es-0ï¼‰å¯¹åº”çš„ç«¯å£ï¼š\n1 2 3 [root@master01 new]# kubectl port-forward es-0 9200:9200 --namespace=logging Forwarding from 127.0.0.1:9200 -\u0026gt; 9200 Forwarding from [::1]:9200 -\u0026gt; 9200 1 curl http://localhost:9200/_cluster/state?pretty çœ‹åˆ°ä¸Šé¢çš„ä¿¡æ¯å°±è¡¨æ˜æˆ‘ä»¬åä¸º k8s-logs çš„ Elasticsearch é›†ç¾¤æˆåŠŸåˆ›å»ºäº†3ä¸ªèŠ‚ç‚¹ï¼šes-0ï¼Œes-1ï¼Œå’Œes-2ï¼Œå½“å‰ä¸»èŠ‚ç‚¹æ˜¯ es-0\nåˆ›å»º Kibana æœåŠ¡ Elasticsearch é›†ç¾¤å¯åŠ¨æˆåŠŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥æ¥éƒ¨ç½² Kibana æœåŠ¡ï¼Œæ–°å»ºä¸€ä¸ªåä¸º kibana.yaml çš„æ–‡ä»¶ï¼Œå¯¹åº”çš„æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\nkibana.yamlÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 apiVersion: v1 kind: Service metadata: name: kibana namespace: logging labels: app: kibana spec: ports: - port: 5601 type: NodePort selector: app: kibana --- apiVersion: apps/v1 kind: Deployment metadata: name: kibana namespace: logging labels: app: kibana spec: selector: matchLabels: app: kibana template: metadata: labels: app: kibana spec: nodeSelector: es: log containers: - name: kibana image: docker.elastic.co/kibana/kibana:7.6.2 resources: limits: cpu: 1000m requests: cpu: 1000m env: - name: ELASTICSEARCH_HOSTS value: http://elasticsearch:9200 ports: - containerPort: 5601 ä¸Šé¢æˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªèµ„æºå¯¹è±¡ï¼Œä¸€ä¸ª Service å’Œ Deploymentï¼Œä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°† Service è®¾ç½®ä¸ºäº† NodePort ç±»å‹ï¼ŒKibana Pod ä¸­é…ç½®éƒ½æ¯”è¾ƒç®€å•ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ä½¿ç”¨Â ELASTICSEARCH_HOSTSÂ è¿™ä¸ªç¯å¢ƒå˜é‡æ¥è®¾ç½®Elasticsearch é›†ç¾¤çš„ç«¯ç‚¹å’Œç«¯å£ï¼Œç›´æ¥ä½¿ç”¨ Kubernetes DNS å³å¯ï¼Œæ­¤ç«¯ç‚¹å¯¹åº”æœåŠ¡åç§°ä¸º elasticsearchï¼Œç”±äºæ˜¯ä¸€ä¸ª headless serviceï¼Œæ‰€ä»¥è¯¥åŸŸå°†è§£æä¸º3ä¸ª Elasticsearch Pod çš„ IP åœ°å€åˆ—è¡¨ã€‚Â é…ç½®å®Œæˆåï¼Œç›´æ¥ä½¿ç”¨ kubectl å·¥å…·åˆ›å»ºï¼š\n1 2 3 kubectl create -f kibana.yaml service/kibana created deployment.apps/kibana created åˆ›å»ºå®Œæˆåï¼Œå¯ä»¥æŸ¥çœ‹ Kibana Pod çš„è¿è¡ŒçŠ¶æ€\n1 2 3 4 5 6 [root@master01 new]# kubectl get pods --namespace=logging NAME READY STATUS RESTARTS AGE es-0 1/1 Running 0 13m es-1 1/1 Running 0 9m48s es-2 1/1 Running 0 7m46s kibana-8476dc9bbf-6mm6k 1/1 Running 0 3m2s å¦‚æœ Pod å·²ç»æ˜¯ Running çŠ¶æ€äº†ï¼Œè¯æ˜åº”ç”¨å·²ç»éƒ¨ç½²æˆåŠŸäº†ï¼Œç„¶åå¯ä»¥é€šè¿‡ NodePort æ¥è®¿é—® Kibana è¿™ä¸ªæœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€http://\u0026lt;ä»»æ„èŠ‚ç‚¹IP\u0026gt;:31838å³å¯ï¼Œ\nå‡ºç° è¿™ä¸ªä»£è¡¨æˆåŠŸ\néƒ¨ç½² Fluentd FluentdÂ æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„æ—¥å¿—èšåˆå™¨ï¼Œæ˜¯ç”¨ Ruby ç¼–å†™çš„ï¼Œå¹¶ä¸”å¯ä»¥å¾ˆå¥½åœ°æ‰©å±•ã€‚å¯¹äºå¤§éƒ¨åˆ†ä¼ä¸šæ¥è¯´ï¼ŒFluentd è¶³å¤Ÿé«˜æ•ˆå¹¶ä¸”æ¶ˆè€—çš„èµ„æºç›¸å¯¹è¾ƒå°‘ï¼Œå¦å¤–ä¸€ä¸ªå·¥å…·Fluent-bitæ›´è½»é‡çº§ï¼Œå ç”¨èµ„æºæ›´å°‘ï¼Œä½†æ˜¯æ’ä»¶ç›¸å¯¹ Fluentd æ¥è¯´ä¸å¤Ÿä¸°å¯Œï¼Œæ‰€ä»¥æ•´ä½“æ¥è¯´ï¼ŒFluentd æ›´åŠ æˆç†Ÿï¼Œä½¿ç”¨æ›´åŠ å¹¿æ³›ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¹ŸåŒæ ·ä½¿ç”¨ Fluentd æ¥ä½œä¸ºæ—¥å¿—æ”¶é›†å·¥å…·ã€‚\nå·¥ä½œåŸç† Fluentd é€šè¿‡ä¸€ç»„ç»™å®šçš„æ•°æ®æºæŠ“å–æ—¥å¿—æ•°æ®ï¼Œå¤„ç†åï¼ˆè½¬æ¢æˆç»“æ„åŒ–çš„æ•°æ®æ ¼å¼ï¼‰å°†å®ƒä»¬è½¬å‘ç»™å…¶ä»–æœåŠ¡ï¼Œæ¯”å¦‚ Elasticsearchã€å¯¹è±¡å­˜å‚¨ç­‰ç­‰ã€‚Fluentd æ”¯æŒè¶…è¿‡300ä¸ªæ—¥å¿—å­˜å‚¨å’Œåˆ†ææœåŠ¡ï¼Œæ‰€ä»¥åœ¨è¿™æ–¹é¢æ˜¯éå¸¸çµæ´»çš„ã€‚ä¸»è¦è¿è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š\né¦–å…ˆ Fluentd ä»å¤šä¸ªæ—¥å¿—æºè·å–æ•°æ® ç»“æ„åŒ–å¹¶ä¸”æ ‡è®°è¿™äº›æ•°æ® ç„¶åæ ¹æ®åŒ¹é…çš„æ ‡ç­¾å°†æ•°æ®å‘é€åˆ°å¤šä¸ªç›®æ ‡æœåŠ¡å» é…ç½® ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬æ˜¯é€šè¿‡ä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥å‘Šè¯‰ Fluentd å¦‚ä½•é‡‡é›†ã€å¤„ç†æ•°æ®çš„\næ—¥å¿—æºé…ç½®\næ¯”å¦‚æˆ‘ä»¬è¿™é‡Œä¸ºäº†æ”¶é›† Kubernetes èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å®¹å™¨æ—¥å¿—ï¼Œå°±éœ€è¦åšå¦‚ä¸‹çš„æ—¥å¿—æºé…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026lt;source\u0026gt; @id fluentd-containers.log @type tail # Fluentd å†…ç½®çš„è¾“å…¥æ–¹å¼ï¼Œå…¶åŸç†æ˜¯ä¸åœåœ°ä»æºæ–‡ä»¶ä¸­è·å–æ–°çš„æ—¥å¿—ã€‚ path /var/log/containers/*.log # æŒ‚è½½çš„æœåŠ¡å™¨Dockerå®¹å™¨æ—¥å¿—åœ°å€ pos_file /var/log/es-containers.log.pos tag raw.kubernetes.* # è®¾ç½®æ—¥å¿—æ ‡ç­¾ read_from_head true \u0026lt;parse\u0026gt; # å¤šè¡Œæ ¼å¼åŒ–æˆJSON @type multi_format # ä½¿ç”¨ multi-format-parser è§£æå™¨æ’ä»¶ \u0026lt;pattern\u0026gt; format json # JSON è§£æå™¨ time_key time # æŒ‡å®šäº‹ä»¶æ—¶é—´çš„æ—¶é—´å­—æ®µ time_format %Y-%m-%dT%H:%M:%S.%NZ # æ—¶é—´æ ¼å¼ \u0026lt;/pattern\u0026gt; \u0026lt;pattern\u0026gt; format /^(?\u0026lt;time\u0026gt;.+) (?\u0026lt;stream\u0026gt;stdout|stderr) [^ ]* (?\u0026lt;log\u0026gt;.*)$/ time_format %Y-%m-%dT%H:%M:%S.%N%:z \u0026lt;/pattern\u0026gt; \u0026lt;/parse\u0026gt; \u0026lt;/source\u0026gt; ä¸Šé¢é…ç½®éƒ¨åˆ†å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š\nidï¼šè¡¨ç¤ºå¼•ç”¨è¯¥æ—¥å¿—æºçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè¯¥æ ‡è¯†å¯ç”¨äºè¿›ä¸€æ­¥è¿‡æ»¤å’Œè·¯ç”±ç»“æ„åŒ–æ—¥å¿—æ•°æ® typeï¼šFluentd å†…ç½®çš„æŒ‡ä»¤ï¼ŒtailÂ è¡¨ç¤º Fluentd ä»ä¸Šæ¬¡è¯»å–çš„ä½ç½®é€šè¿‡ tail ä¸æ–­è·å–æ•°æ®ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯Â httpÂ è¡¨ç¤ºé€šè¿‡ä¸€ä¸ª GET è¯·æ±‚æ¥æ”¶é›†æ•°æ®ã€‚ pathï¼štailÂ ç±»å‹ä¸‹çš„ç‰¹å®šå‚æ•°ï¼Œå‘Šè¯‰ Fluentd é‡‡é›†Â /var/log/containersÂ ç›®å½•ä¸‹çš„æ‰€æœ‰æ—¥å¿—ï¼Œè¿™æ˜¯ docker åœ¨ Kubernetes èŠ‚ç‚¹ä¸Šç”¨æ¥å­˜å‚¨è¿è¡Œå®¹å™¨ stdout è¾“å‡ºæ—¥å¿—æ•°æ®çš„ç›®å½•ã€‚ pos_fileï¼šæ£€æŸ¥ç‚¹ï¼Œå¦‚æœ Fluentd ç¨‹åºé‡æ–°å¯åŠ¨äº†ï¼Œå®ƒå°†ä½¿ç”¨æ­¤æ–‡ä»¶ä¸­çš„ä½ç½®æ¥æ¢å¤æ—¥å¿—æ•°æ®æ”¶é›†ã€‚ tagï¼šç”¨æ¥å°†æ—¥å¿—æºä¸ç›®æ ‡æˆ–è€…è¿‡æ»¤å™¨åŒ¹é…çš„è‡ªå®šä¹‰å­—ç¬¦ä¸²ï¼ŒFluentd åŒ¹é…æº/ç›®æ ‡æ ‡ç­¾æ¥è·¯ç”±æ—¥å¿—æ•°æ®ã€‚ è·¯ç”±é…ç½®\nä¸Šé¢æ˜¯æ—¥å¿—æºçš„é…ç½®ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•å°†æ—¥å¿—æ•°æ®å‘é€åˆ° Elasticsearchï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 \u0026lt;match **\u0026gt; @id elasticsearch @type elasticsearch @log_level info include_tag_key true type_name fluentd host \u0026#34;#{ENV[\u0026#39;OUTPUT_HOST\u0026#39;]}\u0026#34; port \u0026#34;#{ENV[\u0026#39;OUTPUT_PORT\u0026#39;]}\u0026#34; logstash_format true \u0026lt;buffer\u0026gt; @type file path /var/log/fluentd-buffers/kubernetes.system.buffer flush_mode interval retry_type exponential_backoff flush_thread_count 2 flush_interval 5s retry_forever retry_max_interval 30 chunk_limit_size \u0026#34;#{ENV[\u0026#39;OUTPUT_BUFFER_CHUNK_LIMIT\u0026#39;]}\u0026#34; queue_limit_length \u0026#34;#{ENV[\u0026#39;OUTPUT_BUFFER_QUEUE_LIMIT\u0026#39;]}\u0026#34; overflow_action block \u0026lt;/buffer\u0026gt; matchï¼šæ ‡è¯†ä¸€ä¸ªç›®æ ‡æ ‡ç­¾ï¼Œåé¢æ˜¯ä¸€ä¸ªåŒ¹é…æ—¥å¿—æºçš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬è¿™é‡Œæƒ³è¦æ•è·æ‰€æœ‰çš„æ—¥å¿—å¹¶å°†å®ƒä»¬å‘é€ç»™ Elasticsearchï¼Œæ‰€ä»¥éœ€è¦é…ç½®æˆ**ã€‚ idï¼šç›®æ ‡çš„ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ã€‚ typeï¼šæ”¯æŒçš„è¾“å‡ºæ’ä»¶æ ‡è¯†ç¬¦ï¼Œæˆ‘ä»¬è¿™é‡Œè¦è¾“å‡ºåˆ° Elasticsearchï¼Œæ‰€ä»¥é…ç½®æˆ elasticsearchï¼Œè¿™æ˜¯ Fluentd çš„ä¸€ä¸ªå†…ç½®æ’ä»¶ã€‚ log_levelï¼šæŒ‡å®šè¦æ•è·çš„æ—¥å¿—çº§åˆ«ï¼Œæˆ‘ä»¬è¿™é‡Œé…ç½®æˆÂ infoï¼Œè¡¨ç¤ºä»»ä½•è¯¥çº§åˆ«æˆ–è€…è¯¥çº§åˆ«ä»¥ä¸Šï¼ˆINFOã€WARNINGã€ERRORï¼‰çš„æ—¥å¿—éƒ½å°†è¢«è·¯ç”±åˆ° Elsasticsearchã€‚ host/portï¼šå®šä¹‰ Elasticsearch çš„åœ°å€ï¼Œä¹Ÿå¯ä»¥é…ç½®è®¤è¯ä¿¡æ¯ï¼Œæˆ‘ä»¬çš„ Elasticsearch ä¸éœ€è¦è®¤è¯ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥æŒ‡å®š host å’Œ port å³å¯ã€‚ logstash_formatï¼šElasticsearch æœåŠ¡å¯¹æ—¥å¿—æ•°æ®æ„å»ºåå‘ç´¢å¼•è¿›è¡Œæœç´¢ï¼Œå°† logstash_format è®¾ç½®ä¸ºÂ trueï¼ŒFluentd å°†ä¼šä»¥ logstash æ ¼å¼æ¥è½¬å‘ç»“æ„åŒ–çš„æ—¥å¿—æ•°æ®ã€‚ Bufferï¼š Fluentd å…è®¸åœ¨ç›®æ ‡ä¸å¯ç”¨æ—¶è¿›è¡Œç¼“å­˜ï¼Œæ¯”å¦‚ï¼Œå¦‚æœç½‘ç»œå‡ºç°æ•…éšœæˆ–è€… Elasticsearch ä¸å¯ç”¨çš„æ—¶å€™ã€‚ç¼“å†²åŒºé…ç½®ä¹Ÿæœ‰åŠ©äºé™ä½ç£ç›˜çš„ IOã€‚ è¿‡æ»¤\nç”±äº Kubernetes é›†ç¾¤ä¸­åº”ç”¨å¤ªå¤šï¼Œä¹Ÿè¿˜æœ‰å¾ˆå¤šå†å²æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åªå°†æŸäº›åº”ç”¨çš„æ—¥å¿—è¿›è¡Œæ”¶é›†ï¼Œæ¯”å¦‚æˆ‘ä»¬åªé‡‡é›†å…·æœ‰Â logging=trueÂ è¿™ä¸ª Label æ ‡ç­¾çš„ Pod æ—¥å¿—ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨ filterï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # åˆ é™¤æ— ç”¨çš„å±æ€§ \u0026lt;filter kubernetes.**\u0026gt; @type record_transformer remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash \u0026lt;/filter\u0026gt; # åªä¿ç•™å…·æœ‰logging=trueæ ‡ç­¾çš„Podæ—¥å¿— \u0026lt;filter kubernetes.**\u0026gt; @id filter_log @type grep \u0026lt;regexp\u0026gt; key $.kubernetes.labels.logging pattern ^true$ \u0026lt;/regexp\u0026gt; \u0026lt;/filter\u0026gt; å®‰è£… è¦æ”¶é›† Kubernetes é›†ç¾¤çš„æ—¥å¿—ï¼Œç›´æ¥ç”¨ DasemonSet æ§åˆ¶å™¨æ¥éƒ¨ç½² Fluentd åº”ç”¨ï¼Œè¿™æ ·ï¼Œå®ƒå°±å¯ä»¥ä» Kubernetes èŠ‚ç‚¹ä¸Šé‡‡é›†æ—¥å¿—ï¼Œç¡®ä¿åœ¨é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šå§‹ç»ˆè¿è¡Œä¸€ä¸ª Fluentd å®¹å™¨ã€‚å½“ç„¶å¯ä»¥ç›´æ¥ä½¿ç”¨ Helm æ¥è¿›è¡Œä¸€é”®å®‰è£…ï¼Œä¸ºäº†èƒ½å¤Ÿäº†è§£æ›´å¤šå®ç°ç»†èŠ‚ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯é‡‡ç”¨æ‰‹åŠ¨æ–¹æ³•æ¥è¿›è¡Œå®‰è£…ã€‚\né¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ ConfigMap å¯¹è±¡æ¥æŒ‡å®š Fluentd é…ç½®æ–‡ä»¶ï¼Œæ–°å»º fluentd-configmap.yaml æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 kind: ConfigMap apiVersion: v1 metadata: name: fluentd-config namespace: logging data: system.conf: |- \u0026lt;system\u0026gt; root_dir /tmp/fluentd-buffers/ \u0026lt;/system\u0026gt; containers.input.conf: |- \u0026lt;source\u0026gt; @id fluentd-containers.log @type tail # Fluentd å†…ç½®çš„è¾“å…¥æ–¹å¼ï¼Œå…¶åŸç†æ˜¯ä¸åœåœ°ä»æºæ–‡ä»¶ä¸­è·å–æ–°çš„æ—¥å¿—ã€‚ path /var/log/containers/*.log # æŒ‚è½½çš„æœåŠ¡å™¨Dockerå®¹å™¨æ—¥å¿—åœ°å€ pos_file /var/log/es-containers.log.pos tag raw.kubernetes.* # è®¾ç½®æ—¥å¿—æ ‡ç­¾ read_from_head true \u0026lt;parse\u0026gt; # å¤šè¡Œæ ¼å¼åŒ–æˆJSON @type multi_format # ä½¿ç”¨ multi-format-parser è§£æå™¨æ’ä»¶ \u0026lt;pattern\u0026gt; format json # JSONè§£æå™¨ time_key time # æŒ‡å®šäº‹ä»¶æ—¶é—´çš„æ—¶é—´å­—æ®µ time_format %Y-%m-%dT%H:%M:%S.%NZ # æ—¶é—´æ ¼å¼ \u0026lt;/pattern\u0026gt; \u0026lt;pattern\u0026gt; format /^(?\u0026lt;time\u0026gt;.+) (?\u0026lt;stream\u0026gt;stdout|stderr) [^ ]* (?\u0026lt;log\u0026gt;.*)$/ time_format %Y-%m-%dT%H:%M:%S.%N%:z \u0026lt;/pattern\u0026gt; \u0026lt;/parse\u0026gt; \u0026lt;/source\u0026gt; # åœ¨æ—¥å¿—è¾“å‡ºä¸­æ£€æµ‹å¼‚å¸¸ï¼Œå¹¶å°†å…¶ä½œä¸ºä¸€æ¡æ—¥å¿—è½¬å‘ # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions \u0026lt;match raw.kubernetes.**\u0026gt; # åŒ¹é…tagä¸ºraw.kubernetes.**æ—¥å¿—ä¿¡æ¯ @id raw.kubernetes @type detect_exceptions # ä½¿ç”¨detect-exceptionsæ’ä»¶å¤„ç†å¼‚å¸¸æ ˆä¿¡æ¯ remove_tag_prefix raw # ç§»é™¤ raw å‰ç¼€ message log stream stream multiline_flush_interval 5 max_bytes 500000 max_lines 1000 \u0026lt;/match\u0026gt; \u0026lt;filter **\u0026gt; # æ‹¼æ¥æ—¥å¿— @id filter_concat @type concat # Fluentd Filter æ’ä»¶ï¼Œç”¨äºè¿æ¥å¤šä¸ªäº‹ä»¶ä¸­åˆ†éš”çš„å¤šè¡Œæ—¥å¿—ã€‚ key message multiline_end_regexp /\\n$/ # ä»¥æ¢è¡Œç¬¦â€œ\\nâ€æ‹¼æ¥ separator \u0026#34;\u0026#34; \u0026lt;/filter\u0026gt; # æ·»åŠ  Kubernetes metadata æ•°æ® \u0026lt;filter kubernetes.**\u0026gt; @id filter_kubernetes_metadata @type kubernetes_metadata \u0026lt;/filter\u0026gt; # ä¿®å¤ ES ä¸­çš„ JSON å­—æ®µ # æ’ä»¶åœ°å€ï¼šhttps://github.com/repeatedly/fluent-plugin-multi-format-parser \u0026lt;filter kubernetes.**\u0026gt; @id filter_parser @type parser # multi-format-parserå¤šæ ¼å¼è§£æå™¨æ’ä»¶ key_name log # åœ¨è¦è§£æçš„è®°å½•ä¸­æŒ‡å®šå­—æ®µåç§°ã€‚ reserve_data true # åœ¨è§£æç»“æœä¸­ä¿ç•™åŸå§‹é”®å€¼å¯¹ã€‚ remove_key_name_field true # key_name è§£ææˆåŠŸååˆ é™¤å­—æ®µã€‚ \u0026lt;parse\u0026gt; @type multi_format \u0026lt;pattern\u0026gt; format json \u0026lt;/pattern\u0026gt; \u0026lt;pattern\u0026gt; format none \u0026lt;/pattern\u0026gt; \u0026lt;/parse\u0026gt; \u0026lt;/filter\u0026gt; # åˆ é™¤ä¸€äº›å¤šä½™çš„å±æ€§ \u0026lt;filter kubernetes.**\u0026gt; @type record_transformer remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash \u0026lt;/filter\u0026gt; # åªä¿ç•™å…·æœ‰logging=trueæ ‡ç­¾çš„Podæ—¥å¿— \u0026lt;filter kubernetes.**\u0026gt; @id filter_log @type grep \u0026lt;regexp\u0026gt; key $.kubernetes.labels.logging pattern ^true$ \u0026lt;/regexp\u0026gt; \u0026lt;/filter\u0026gt; ###### ç›‘å¬é…ç½®ï¼Œä¸€èˆ¬ç”¨äºæ—¥å¿—èšåˆç”¨ ###### forward.input.conf: |- # ç›‘å¬é€šè¿‡TCPå‘é€çš„æ¶ˆæ¯ \u0026lt;source\u0026gt; @id forward @type forward \u0026lt;/source\u0026gt; output.conf: |- \u0026lt;match **\u0026gt; @id elasticsearch @type elasticsearch @log_level info include_tag_key true host elasticsearch port 9200 logstash_format true logstash_prefix k8s # è®¾ç½® index å‰ç¼€ä¸º k8s request_timeout 30s \u0026lt;buffer\u0026gt; @type file path /var/log/fluentd-buffers/kubernetes.system.buffer flush_mode interval retry_type exponential_backoff flush_thread_count 2 flush_interval 5s retry_forever retry_max_interval 30 chunk_limit_size 2M queue_limit_length 8 overflow_action block \u0026lt;/buffer\u0026gt; \u0026lt;/match\u0026gt; ä¸Šé¢é…ç½®æ–‡ä»¶ä¸­æˆ‘ä»¬åªé…ç½®äº† docker å®¹å™¨æ—¥å¿—ç›®å½•ï¼Œæ”¶é›†åˆ°æ•°æ®ç»è¿‡å¤„ç†åå‘é€åˆ°Â elasticsearch:9200Â æœåŠ¡ã€‚\nç„¶åæ–°å»ºä¸€ä¸ª fluentd-daemonset.yaml çš„æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 apiVersion: v1 kind: ServiceAccount metadata: name: fluentd-es namespace: logging labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \u0026#34;true\u0026#34; addonmanager.kubernetes.io/mode: Reconcile --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: fluentd-es labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \u0026#34;true\u0026#34; addonmanager.kubernetes.io/mode: Reconcile rules: - apiGroups: - \u0026#34;\u0026#34; resources: - \u0026#34;namespaces\u0026#34; - \u0026#34;pods\u0026#34; verbs: - \u0026#34;get\u0026#34; - \u0026#34;watch\u0026#34; - \u0026#34;list\u0026#34; --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: fluentd-es labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \u0026#34;true\u0026#34; addonmanager.kubernetes.io/mode: Reconcile subjects: - kind: ServiceAccount name: fluentd-es namespace: logging apiGroup: \u0026#34;\u0026#34; roleRef: kind: ClusterRole name: fluentd-es apiGroup: \u0026#34;\u0026#34; --- apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-es namespace: logging labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \u0026#34;true\u0026#34; addonmanager.kubernetes.io/mode: Reconcile spec: selector: matchLabels: k8s-app: fluentd-es template: metadata: labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \u0026#34;true\u0026#34; # æ­¤æ³¨é‡Šç¡®ä¿å¦‚æœèŠ‚ç‚¹è¢«é©±é€ï¼Œfluentdä¸ä¼šè¢«é©±é€ï¼Œæ”¯æŒå…³é”®çš„åŸºäº pod æ³¨é‡Šçš„ä¼˜å…ˆçº§æ–¹æ¡ˆã€‚ annotations: scheduler.alpha.kubernetes.io/critical-pod: \u0026#39;\u0026#39; spec: serviceAccountName: fluentd-es containers: - name: fluentd-es image: quay.io/fluentd_elasticsearch/fluentd:v3.0.1 env: - name: FLUENTD_ARGS value: --no-supervisor -q resources: limits: memory: 500Mi requests: cpu: 100m memory: 200Mi volumeMounts: - name: varlog mountPath: /var/log - name: varlibdockercontainers mountPath: /var/lib/docker/containers readOnly: true - name: config-volume mountPath: /etc/fluent/config.d nodeSelector: beta.kubernetes.io/fluentd-ds-ready: \u0026#34;true\u0026#34; tolerations: - operator: Exists terminationGracePeriodSeconds: 30 volumes: - name: varlog hostPath: path: /var/log - name: varlibdockercontainers hostPath: path: /var/lib/docker/containers - name: config-volume configMap: name: fluentd-config æˆ‘ä»¬å°†ä¸Šé¢åˆ›å»ºçš„ fluentd-config è¿™ä¸ª ConfigMap å¯¹è±¡é€šè¿‡ volumes æŒ‚è½½åˆ°äº† Fluentd å®¹å™¨ä¸­ï¼Œå¦å¤–ä¸ºäº†èƒ½å¤Ÿçµæ´»æ§åˆ¶å“ªäº›èŠ‚ç‚¹çš„æ—¥å¿—å¯ä»¥è¢«æ”¶é›†ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ·»åŠ äº†ä¸€ä¸ª nodSelector å±æ€§ï¼š\n1 2 nodeSelector: beta.kubernetes.io/fluentd-ds-ready: \u0026#34;true\u0026#34; æ„æ€å°±æ˜¯è¦æƒ³é‡‡é›†èŠ‚ç‚¹çš„æ—¥å¿—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç»™èŠ‚ç‚¹æ‰“ä¸Šä¸Šé¢çš„æ ‡ç­¾\nå¦‚æœä½ éœ€è¦åœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šé‡‡é›†æ—¥å¿—ï¼Œåˆ™éœ€è¦ç»™å¯¹åº”èŠ‚ç‚¹æ‰“ä¸Šæ ‡ç­¾ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š\nkubectl label nodes nodeå beta.kubernetes.io/fluentd-ds-ready=true\n1 2 3 4 5 6 [root@master01 ~]# kubectl label nodes 172.17.1.32 beta.kubernetes.io/fluentd-ds-ready=true node/172.17.1.32 labeled [root@master01 ~]# kubectl label nodes 172.17.1.30 beta.kubernetes.io/fluentd-ds-ready=true node/172.17.1.30 labeled [root@master01 ~]# kubectl label nodes 172.17.1.31 beta.kubernetes.io/fluentd-ds-ready=true node/172.17.1.31 labeled é»˜è®¤æƒ…å†µä¸‹ master èŠ‚ç‚¹æœ‰æ±¡ç‚¹ï¼Œæ‰€ä»¥å¦‚æœè¦æƒ³ä¹Ÿæ”¶é›† master èŠ‚ç‚¹çš„æ—¥å¿—ï¼Œåˆ™éœ€è¦æ·»åŠ ä¸Šå®¹å¿ï¼š\n1 2 tolerations: - operator: Exists åˆ›å»ºå®Œæˆåï¼ŒæŸ¥çœ‹å¯¹åº”çš„ Pods åˆ—è¡¨ï¼Œæ£€æŸ¥æ˜¯å¦éƒ¨ç½²æˆåŠŸ\nFluentd å¯åŠ¨æˆåŠŸåï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥å‘é€æ—¥å¿—åˆ° ES äº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œæ˜¯è¿‡æ»¤äº†åªé‡‡é›†å…·æœ‰Â logging=trueÂ æ ‡ç­¾çš„ Pod æ—¥å¿—ï¼Œæ‰€ä»¥ç°åœ¨è¿˜æ²¡æœ‰ä»»ä½•æ•°æ®ä¼šè¢«é‡‡é›†ã€‚\nä¸‹é¢æˆ‘ä»¬éƒ¨ç½²ä¸€ä¸ªç®€å•çš„æµ‹è¯•åº”ç”¨ï¼Œ æ–°å»º counter.yaml æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: v1 kind: Pod metadata: name: counter labels: logging: \u0026#34;true\u0026#34; # ä¸€å®šè¦å…·æœ‰è¯¥æ ‡ç­¾æ‰ä¼šè¢«é‡‡é›† spec: containers: - name: count image: busybox args: [/bin/sh, -c, \u0026#39;i=0; while true; do echo \u0026#34;$i: $(date)\u0026#34;; i=$((i+1)); sleep 1; done\u0026#39;] è¯¥ Pod åªæ˜¯ç®€å•å°†æ—¥å¿—ä¿¡æ¯æ‰“å°åˆ°Â stdoutï¼Œæ‰€ä»¥æ­£å¸¸æ¥è¯´ Fluentd ä¼šæ”¶é›†åˆ°è¿™ä¸ªæ—¥å¿—æ•°æ®ï¼Œåœ¨ Kibana ä¸­ä¹Ÿå°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„æ—¥å¿—æ•°æ®äº†ï¼Œä½¿ç”¨ kubectl å·¥å…·åˆ›å»ºè¯¥ Podï¼š\nPod åˆ›å»ºå¹¶è¿è¡Œåï¼Œå›åˆ° Kibana Dashboard é¡µé¢ï¼Œç‚¹å‡»å·¦ä¾§æœ€ä¸‹é¢çš„Â managementÂ å›¾æ ‡ï¼Œç„¶åç‚¹å‡» Kibana ä¸‹é¢çš„Â Index PatternsÂ å¼€å§‹å¯¼å…¥ç´¢å¼•æ•°æ®ï¼š\næ›´è¯¦ç»†ç»†èŠ‚è¯·çœ‹é˜´é˜³åšå®¢\nåœ¨ Kubernetes ä¸Šæ­å»º EFK æ—¥å¿—æ”¶é›†ç³»ç»Ÿ[æ›´æ–°]-é˜³æ˜çš„åšå®¢|Kubernetes|Istio|Prometheus|Python|Golang|äº‘åŸç”Ÿ\n","date":"2022-03-11T11:26:38Z","image":"https://www.ownit.top/title_pic/32.jpg","permalink":"https://www.ownit.top/p/202203111126/","title":"Kuberneteså®‰è£…EFKæ—¥å¿—æ”¶é›†"},{"content":"é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨Kubernetesçš„éƒ½çŸ¥é“ï¼Œetcdæ˜¯k8sçš„æ ¸å¿ƒæ‰€åœ¨ï¼Œä¼šè®°å½•å„ä¸ªpodçš„çŠ¶æ€ä¿¡æ¯ã€‚æ‰€ä»¥é‡è¦æ€§æä¸ºé‡è¦ã€‚\netcdæ˜¯kubernetesé›†ç¾¤æä¸ºé‡è¦çš„ä¸€å—æœåŠ¡ï¼Œå­˜å‚¨äº†kubernetesé›†ç¾¤æ‰€æœ‰çš„æ•°æ®ä¿¡æ¯ï¼Œå¦‚Namespaceã€Podã€Serviceã€è·¯ç”±ç­‰çŠ¶æ€ä¿¡æ¯ã€‚å¦‚æœetcdé›†ç¾¤å‘ç”Ÿç¾éš¾æˆ–è€… etcd é›†ç¾¤æ•°æ®ä¸¢å¤±ï¼Œéƒ½ä¼šå½±å“k8sé›†ç¾¤æ•°æ®çš„æ¢å¤ã€‚å› æ­¤ï¼Œé€šè¿‡å¤‡ä»½etcdæ•°æ®æ¥å®ç°kubernetesé›†ç¾¤çš„ç¾å¤‡ç¯å¢ƒååˆ†é‡è¦ã€‚\næˆ‘ä»¬ä¸€ç‚¹è¦å…»æˆï¼Œé‡è¦çš„ä¸œè¥¿å¤‡ä»½ã€å¤‡ä»½ã€åœ¨å¤‡ä»½çš„ä¹ æƒ¯ã€‚\n1 2 3 4 5 6 7 8 9 ETCDCTL_API=3 /opt/kube/bin/etcdctl --endpoints=\u0026#34;https://172.17.1.20:2379,https://172.17.1.21:2379,https://172.17.1.22:2379\u0026#34; \\ --cacert=/etc/kubernetes/ssl/ca.pem \\ --cert=/etc/kubernetes/ssl/etcd.pem \\ --key=/etc/kubernetes/ssl/etcd-key.pem \\ endpoint status --write-out=table #çŠ¶æ€ ï¼ˆé…åˆæ›¿æ¢æœ€åä¸€è¡Œä½¿ç”¨ï¼‰ member list --write-out=table #åˆ—è¡¨ endpoint health --write-out=table #å¥åº·æ£€æŸ¥ 1 2 3 4 5 6 7 8 [root@master01 ~]# ETCDCTL_API=3 /opt/kube/bin/etcdctl --endpoints=\u0026#34;https://172.17.1.20:2379,https://172.17.1.21:2379,https://172.17.1.22:2379\u0026#34; --cacert=/etc/kubernetes/ssl/ca.pem --cert=/etc/kubernetes/ssl/etcd.pem --key=/etc/kubernetes/ssl/etcd-key.pem endpoint status --write-out=table +--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | https://172.17.1.20:2379 | 20eec45319ea02e1 | 3.4.13 | 4.3 MB | false | false | 5 | 14715 | 14715 | | | https://172.17.1.21:2379 | 395af18f6bbef1a | 3.4.13 | 4.3 MB | false | false | 5 | 14715 | 14715 | | | https://172.17.1.22:2379 | fc24d224af6a71d9 | 3.4.13 | 4.3 MB | true | false | 5 | 14715 | 14715 | | +--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ ä¸€ã€etcdé›†ç¾¤å¤‡ä»½ etcdä¸åŒç‰ˆæœ¬çš„ etcdctl å‘½ä»¤ä¸ä¸€æ ·ï¼Œä½†å¤§è‡´å·®ä¸å¤šï¼Œè¿™é‡Œå¤‡ä»½ä½¿ç”¨ napshot saveè¿›è¡Œå¿«ç…§å¤‡ä»½ã€‚\néœ€è¦æ³¨æ„å‡ ç‚¹ï¼š\nå¤‡ä»½æ“ä½œåœ¨etcdé›†ç¾¤çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œå°±å¯ä»¥ã€‚ è¿™é‡Œä½¿ç”¨çš„æ˜¯etcd v3çš„apiï¼Œå› ä¸ºä» k8s 1.13 å¼€å§‹ï¼Œk8sä¸å†æ”¯æŒ v2 ç‰ˆæœ¬çš„ etcdï¼Œå³k8sçš„é›†ç¾¤æ•°æ®éƒ½å­˜åœ¨äº†v3ç‰ˆæœ¬çš„etcdä¸­ã€‚æ•…å¤‡ä»½çš„æ•°æ®ä¹Ÿåªå¤‡ä»½äº†ä½¿ç”¨v3æ·»åŠ çš„etcdæ•°æ®ï¼Œv2æ·»åŠ çš„etcdæ•°æ®æ˜¯æ²¡æœ‰åšå¤‡ä»½çš„ã€‚ æœ¬æ¡ˆä¾‹ä½¿ç”¨çš„æ˜¯äºŒè¿›åˆ¶éƒ¨ç½²çš„k8s v1.20.2 + Calico å®¹å™¨ç¯å¢ƒï¼ˆä¸‹é¢å‘½ä»¤ä¸­çš„\u0026quot;ETCDCTL_API=3 etcdctl\u0026quot; ç­‰åŒäº \u0026ldquo;etcdctl\u0026rdquo;ï¼‰ 1ï¼‰å¼€å§‹å¤‡ä»½ä¹‹å‰ï¼Œå…ˆæ¥æŸ¥çœ‹ä¸‹etcdæ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 [root@master01 ~]# cat /etc/systemd/system/etcd.service [Unit] Description=Etcd Server After=network.target After=network-online.target Wants=network-online.target Documentation=https://github.com/coreos [Service] Type=notify WorkingDirectory=/var/lib/etcd/ ExecStart=/opt/kube/bin/etcd \\ --name=etcd-172.17.1.20 \\ --cert-file=/etc/kubernetes/ssl/etcd.pem \\ --key-file=/etc/kubernetes/ssl/etcd-key.pem \\ --peer-cert-file=/etc/kubernetes/ssl/etcd.pem \\ --peer-key-file=/etc/kubernetes/ssl/etcd-key.pem \\ --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \\ --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \\ --initial-advertise-peer-urls=https://172.17.1.20:2380 \\ --listen-peer-urls=https://172.17.1.20:2380 \\ --listen-client-urls=https://172.17.1.20:2379,http://127.0.0.1:2379 \\ --advertise-client-urls=https://172.17.1.20:2379 \\ --initial-cluster-token=etcd-cluster-0 \\ --initial-cluster=etcd-172.17.1.20=https://172.17.1.20:2380,etcd-172.17.1.21=https://172.17.1.21:2380,etcd-172.17.1.22=https://172.17.1.22:2380 \\ --initial-cluster-state=new \\ --data-dir=/var/lib/etcd \\ --snapshot-count=50000 \\ --auto-compaction-retention=1 \\ --max-request-bytes=10485760 \\ --auto-compaction-mode=periodic \\ --quota-backend-bytes=8589934592 Restart=always RestartSec=15 LimitNOFILE=65536 OOMScoreAdjust=-999 [root@master01 ~]# tree /var/lib/etcd /var/lib/etcd â””â”€â”€ member â”œâ”€â”€ snap â”‚Â â””â”€â”€ db â””â”€â”€ wal â”œâ”€â”€ 0000000000000000-0000000000000000.wal â””â”€â”€ 0.tmp 3 directories, 3 files 2ï¼‰æ‰§è¡Œetcdé›†ç¾¤æ•°æ®å¤‡ä»½\nåœ¨etcdé›†ç¾¤çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œå¤‡ä»½æ“ä½œï¼Œç„¶åå°†å¤‡ä»½æ–‡ä»¶æ‹·è´åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚\nå…ˆåœ¨etcdé›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºå¤‡ä»½ç›®å½•\n1 mkdir -p /data/etcd_backup_dir åœ¨etcdé›†ç¾¤å…¶ä¸­ä¸ªä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè¿™é‡Œåœ¨k8s-master01ï¼‰ä¸Šæ‰§è¡Œå¤‡ä»½ï¼š\n1 2 3 4 5 6 ETCDCTL_API=3 /opt/kube/bin/etcdctl \\ snapshot save /data/etcd_backup_dir/etcd-snapshot-`date +%Y%m%d`.db \\ --endpoints=https://172.17.1.20:2379 \\ --cacert=/etc/kubernetes/ssl/ca.pem \\ --cert=/etc/kubernetes/ssl/etcd.pem \\ --key=/etc/kubernetes/ssl/etcd-key.pem å°†å¤‡ä»½æ–‡ä»¶æ‹·è´åˆ°å…¶ä»–çš„etcdèŠ‚ç‚¹\n1 2 3 4 5 6 [root@master01 ~]# scp /data/etcd_backup_dir/etcd-snapshot-20220310.db 172.17.1.21:/data/etcd_backup_dir/ etcd-snapshot-20220310.db 100% 4208KB 158.6MB/s 00:00 æ‚¨åœ¨ /var/spool/mail/root ä¸­æœ‰æ–°é‚®ä»¶ [root@master01 ~]# scp /data/etcd_backup_dir/etcd-snapshot-20220310.db 172.17.1.22:/data/etcd_backup_dir/ etcd-snapshot-20220310.db 100% 4208KB 158.3MB/s 00:00 [root@master01 ~]# å¯ä»¥å°†ä¸Šé¢k8s-master01èŠ‚ç‚¹çš„etcdå¤‡ä»½å‘½ä»¤æ”¾åœ¨è„šæœ¬é‡Œï¼Œç»“åˆcrontabè¿›è¡Œå®šæ—¶å¤‡ä»½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@k8s-master01 ~]# cat /data/etcd_backup_dir/etcd_backup.sh #!/usr/bin/bash date; ETCDCTL_API=3 /opt/kube/bin/etcdctl \\ snapshot save /data/etcd_backup_dir/etcd-snapshot-`date +%Y%m%d`.db \\ --endpoints=https://172.17.1.20:2379 \\ --cacert=/etc/kubernetes/ssl/ca.pem \\ --cert=/etc/kubernetes/ssl/etcd.pem \\ --key=/etc/kubernetes/ssl/etcd-key.pem # å¤‡ä»½ä¿ç•™30å¤© find /data/etcd_backup_dir/ -name \u0026#34;*.db\u0026#34; -mtime +30 -exec rm -f {} \\; # åŒæ­¥åˆ°å…¶ä»–ä¸¤ä¸ªetcdèŠ‚ç‚¹ scp /data/etcd_backup_dir/etcd-snapshot-`date +%Y%m%d`.db 172.17.1.21:/data/etcd_backup_dir/ scp /data/etcd_backup_dir/etcd-snapshot-`date +%Y%m%d`.db 172.17.1.22:/data/etcd_backup_dir/ è®¾ç½®crontabå®šæ—¶å¤‡ä»½ä»»åŠ¡ï¼Œæ¯å¤©å‡Œæ™¨5ç‚¹æ‰§è¡Œå¤‡ä»½ï¼š\n1 2 3 4 5 6 [root@master01 ~]# chmod 755 /data/etcd_backup_dir/etcd_backup.sh [root@master01 ~]# crontab -e crontab: installing new crontab [root@master01 ~]# crontab -l */10 * * * * ntpdate time.windows.com 0 5 * * * /bin/bash -x /data/etcd_backup_dir/etcd_backup.sh \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 äºŒã€etcdé›†ç¾¤æ¢å¤ etcdé›†ç¾¤å¤‡ä»½æ“ä½œåªéœ€è¦åœ¨å…¶ä¸­çš„ä¸€ä¸ªetcdèŠ‚ç‚¹ä¸Šå®Œæˆï¼Œç„¶åå°†å¤‡ä»½æ–‡ä»¶æ‹·è´åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚\nä½†etcdé›†ç¾¤æ¢å¤æ“ä½œå¿…é¡»è¦æ‰€æœ‰çš„etcdèŠ‚ç‚¹ä¸Šå®Œæˆï¼\n1ï¼‰æ¨¡æ‹Ÿetcdé›†ç¾¤æ•°æ®ä¸¢å¤±\nåˆ é™¤ä¸‰ä¸ªetcdé›†ç¾¤èŠ‚ç‚¹çš„dataæ•°æ® (æˆ–è€…ç›´æ¥åˆ é™¤dataç›®å½•)\n1 2 3 4 5 6 7 8 9 10 11 [root@master01 ~]# ls /var/lib/etcd/ member [root@master01 ~]# ansible master -m shell -a \u0026#34;mv /var/lib/etcd/member /var/lib/etcd/member_bak\u0026#34; 172.17.1.21 | CHANGED | rc=0 \u0026gt;\u0026gt; 172.17.1.22 | CHANGED | rc=0 \u0026gt;\u0026gt; 172.17.1.20 | CHANGED | rc=0 \u0026gt;\u0026gt; [root@master01 ~]# ls /var/lib/etcd/ member_bak æŸ¥çœ‹k8sé›†ç¾¤çŠ¶æ€ï¼š\nç”±äºæ­¤æ—¶etcdé›†ç¾¤çš„ä¸‰ä¸ªèŠ‚ç‚¹æœåŠ¡è¿˜åœ¨ï¼Œè¿‡ä¸€ä¼šå„¿æŸ¥çœ‹é›†ç¾¤çŠ¶æ€æ¢å¤æ­£å¸¸ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 [root@master01 ~]# kubectl get cs Warning: v1 ComponentStatus is deprecated in v1.19+ NAME STATUS MESSAGE ERROR controller-manager Healthy ok scheduler Healthy ok etcd-1 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;} etcd-0 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;} etcd-2 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;} æ‚¨åœ¨ /var/spool/mail/root ä¸­æœ‰æ–°é‚®ä»¶ [root@master01 ~]# [root@master01 ~]# [root@master01 ~]# ETCDCTL_API=3 /opt/kube/bin/etcdctl --endpoints=\u0026#34;https://172.17.1.20:2379,https://172.17.1.21:2379,https://172.17.1.22:2379\u0026#34; \\ \u0026gt; --cacert=/etc/kubernetes/ssl/ca.pem \\ \u0026gt; --cert=/etc/kubernetes/ssl/etcd.pem \\ \u0026gt; --key=/etc/kubernetes/ssl/etcd-key.pem \\ \u0026gt; endpoint status --write-out=table #çŠ¶æ€ +--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | https://172.17.1.20:2379 | 20eec45319ea02e1 | 3.4.13 | 143 kB | false | false | 7 | 191 | 191 | | | https://172.17.1.21:2379 | 395af18f6bbef1a | 3.4.13 | 143 kB | true | false | 7 | 191 | 191 | | | https://172.17.1.22:2379 | fc24d224af6a71d9 | 3.4.13 | 152 kB | false | false | 7 | 191 | 191 | | +--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ [root@master01 ~]# kubectl get svc,pod -A NAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE default service/kubernetes ClusterIP 10.68.0.1 \u0026lt;none\u0026gt; 443/TCP 18s ä½†æ˜¯ï¼Œk8sé›†ç¾¤æ•°æ®å…¶å®å·²ç»ä¸¢å¤±äº†ã€‚namespaceå‘½åç©ºé—´ä¸‹çš„podç­‰èµ„æºéƒ½æ²¡æœ‰äº†ã€‚æ­¤æ—¶å°±éœ€è¦é€šè¿‡etcdé›†ç¾¤å¤‡ä»½æ–‡ä»¶æ¥æ¢å¤ï¼Œå³é€šè¿‡ä¸Šé¢çš„etcdé›†ç¾¤å¿«ç…§æ–‡ä»¶æ¢å¤ã€‚\n1 2 3 4 5 6 7 8 [root@master01 ~]# kubectl get ns NAME STATUS AGE default Active 2m20s kube-node-lease Active 2m20s kube-public Active 2m20s kube-system Active 2m20s [root@master01 ~]# kubectl get pod -n kube-system No resources found in kube-system namespace. 2ï¼‰etcdé›†ç¾¤æ•°æ®æ¢å¤ï¼Œå³kubernetesé›†ç¾¤æ•°æ®æ¢å¤\nåœ¨etcdæ•°æ®æ¢å¤ä¹‹å‰ï¼Œå…ˆä¾æ¬¡å…³é—­æ‰€æœ‰masterèŠ‚ç‚¹çš„kube-aposerveræœåŠ¡ï¼Œæ‰€æœ‰etcdèŠ‚ç‚¹çš„etcdæœåŠ¡ï¼š\n1 2 3 4 5 6 [root@master01 ~]# ansible master -m shell -a \u0026#34;systemctl stop kube-apiserver \u0026amp;\u0026amp; systemctl stop etcd\u0026#34; 172.17.1.21 | CHANGED | rc=0 \u0026gt;\u0026gt; 172.17.1.22 | CHANGED | rc=0 \u0026gt;\u0026gt; 172.17.1.20 | CHANGED | rc=0 \u0026gt;\u0026gt; **ç‰¹åˆ«æ³¨æ„ï¼š**åœ¨è¿›è¡Œetcdé›†ç¾¤æ•°æ®æ¢å¤ä¹‹å‰ï¼Œä¸€å®šè¦å…ˆå°†æ‰€æœ‰etcdèŠ‚ç‚¹çš„dataå’Œwalæ—§å·¥ä½œç›®å½•åˆ æ‰ï¼Œå¦åˆ™ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¢å¤å¤±è´¥ï¼ˆæ¢å¤å‘½ä»¤æ‰§è¡Œæ—¶æŠ¥é”™æ•°æ®ç›®å½•å·²å­˜åœ¨ï¼‰ã€‚\nåœ¨æ¯ä¸ªetcdèŠ‚ç‚¹æ‰§è¡Œæ¢å¤æ“ä½œï¼š\nmaster01\n1 2 3 4 5 6 7 8 9 10 11 12 [root@master01 ~]# [root@master01 ~]# ETCDCTL_API=3 /opt/kube/bin/etcdctl \\ \u0026gt; --name=etcd-172.17.1.20 \\ \u0026gt; --endpoints=\u0026#34;https://172.17.1.20:2379\u0026#34; \\ \u0026gt; --cacert=/etc/kubernetes/ssl/ca.pem \\ \u0026gt; --cert=/etc/kubernetes/ssl/etcd.pem \\ \u0026gt; --key=/etc/kubernetes/ssl/etcd-key.pem \\ \u0026gt; --initial-cluster-token=etcd-cluster-0 \\ \u0026gt; --initial-advertise-peer-urls=https://172.17.1.20:2380 \\ \u0026gt; --initial-cluster=etcd-172.17.1.20=https://172.17.1.20:2380,etcd-172.17.1.21=https://172.17.1.21:2380,etcd-172.17.1.22=https://172.17.1.22:2380 \\ \u0026gt; --data-dir=/var/lib/etcd \\ \u0026gt; snapshot restore /data/etcd_backup_dir/etcd-snapshot-20220310.db master02\n1 2 3 4 5 6 7 8 9 10 11 ETCDCTL_API=3 /opt/kube/bin/etcdctl \\ --name=etcd-172.17.1.21 \\ --endpoints=\u0026#34;https://172.17.1.21:2379\u0026#34; \\ --cacert=/etc/kubernetes/ssl/ca.pem \\ --cert=/etc/kubernetes/ssl/etcd.pem \\ --key=/etc/kubernetes/ssl/etcd-key.pem \\ --initial-cluster-token=etcd-cluster-0 \\ --initial-advertise-peer-urls=https://172.17.1.21:2380 \\ --initial-cluster=etcd-172.17.1.20=https://172.17.1.20:2380,etcd-172.17.1.21=https://172.17.1.21:2380,etcd-172.17.1.22=https://172.17.1.22:2380 \\ --data-dir=/var/lib/etcd \\ snapshot restore /data/etcd_backup_dir/etcd-snapshot-20220310.db master03\n1 2 3 4 5 6 7 8 9 10 11 ETCDCTL_API=3 /opt/kube/bin/etcdctl \\ --name=etcd-172.17.1.22 \\ --endpoints=\u0026#34;https://172.17.1.22:2379\u0026#34; \\ --cacert=/etc/kubernetes/ssl/ca.pem \\ --cert=/etc/kubernetes/ssl/etcd.pem \\ --key=/etc/kubernetes/ssl/etcd-key.pem \\ --initial-cluster-token=etcd-cluster-0 \\ --initial-advertise-peer-urls=https://172.17.1.22:2380 \\ --initial-cluster=etcd-172.17.1.20=https://172.17.1.20:2380,etcd-172.17.1.21=https://172.17.1.21:2380,etcd-172.17.1.22=https://172.17.1.22:2380 \\ --data-dir=/var/lib/etcd \\ snapshot restore /data/etcd_backup_dir/etcd-snapshot-20220310.db ä¾æ¬¡å¯åŠ¨æ‰€æœ‰etcdèŠ‚ç‚¹çš„etcdæœåŠ¡ï¼š\n1 2 # systemctl start etcd # systemctl status etcd 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 [root@master01 ~]# ansible master -m shell -a \u0026#34;systemctl start etcd\u0026#34; 172.17.1.22 | CHANGED | rc=0 \u0026gt;\u0026gt; 172.17.1.21 | CHANGED | rc=0 \u0026gt;\u0026gt; 172.17.1.20 | CHANGED | rc=0 \u0026gt;\u0026gt; æ‚¨åœ¨ /var/spool/mail/root ä¸­æœ‰æ–°é‚®ä»¶ [root@master01 ~]# ansible master -m shell -a \u0026#34;systemctl status etcd\u0026#34; 172.17.1.21 | CHANGED | rc=0 \u0026gt;\u0026gt; â— etcd.service - Etcd Server Loaded: loaded (/etc/systemd/system/etcd.service; enabled; vendor preset: disabled) Active: active (running) since å›› 2022-03-10 14:43:41 CST; 8s ago Docs: https://github.com/coreos Main PID: 81855 (etcd) Tasks: 13 Memory: 23.4M CGroup: /system.slice/etcd.service â””â”€81855 /opt/kube/bin/etcd --name=etcd-172.17.1.21 --cert-file=/etc/kubernetes/ssl/etcd.pem --key-file=/etc/kubernetes/ssl/etcd-key.pem --peer-cert-file=/etc/kubernetes/ssl/etcd.pem --peer-key-file=/etc/kubernetes/ssl/etcd-key.pem --trusted-ca-file=/etc/kubernetes/ssl/ca.pem --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem --initial-advertise-peer-urls=https://172.17.1.21:2380 --listen-peer-urls=https://172.17.1.21:2380 --listen-client-urls=https://172.17.1.21:2379,http://127.0.0.1:2379 --advertise-client-urls=https://172.17.1.21:2379 --initial-cluster-token=etcd-cluster-0 --initial-cluster=etcd-172.17.1.20=https://172.17.1.20:2380,etcd-172.17.1.21=https://172.17.1.21:2380,etcd-172.17.1.22=https://172.17.1.22:2380 --initial-cluster-state=new --data-dir=/var/lib/etcd --snapshot-count=50000 --auto-compaction-retention=1 --max-request-bytes=10485760 --auto-compaction-mode=periodic --quota-backend-bytes=8589934592 3æœˆ 10 14:43:41 master02 etcd[81855]: published {Name:etcd-172.17.1.21 ClientURLs:[https://172.17.1.21:2379]} to cluster 948e35f16fc80e25 3æœˆ 10 14:43:41 master02 etcd[81855]: ready to serve client requests 3æœˆ 10 14:43:41 master02 etcd[81855]: ready to serve client requests 3æœˆ 10 14:43:41 master02 systemd[1]: Started Etcd Server. 3æœˆ 10 14:43:41 master02 etcd[81855]: serving insecure client requests on 127.0.0.1:2379, this is strongly discouraged! 3æœˆ 10 14:43:41 master02 etcd[81855]: serving client requests on 172.17.1.21:2379 3æœˆ 10 14:43:41 master02 etcd[81855]: set the initial cluster version to 3.4 3æœˆ 10 14:43:41 master02 etcd[81855]: enabled capabilities for version 3.4 3æœˆ 10 14:43:41 master02 etcd[81855]: established a TCP streaming connection with peer 20eec45319ea02e1 (stream Message reader) 3æœˆ 10 14:43:41 master02 etcd[81855]: established a TCP streaming connection with peer 20eec45319ea02e1 (stream MsgApp v2 reader) 172.17.1.22 | CHANGED | rc=0 \u0026gt;\u0026gt; â— etcd.service - Etcd Server Loaded: loaded (/etc/systemd/system/etcd.service; enabled; vendor preset: disabled) Active: active (running) since å›› 2022-03-10 14:43:41 CST; 8s ago Docs: https://github.com/coreos Main PID: 81803 (etcd) Tasks: 13 Memory: 20.7M CGroup: /system.slice/etcd.service â””â”€81803 /opt/kube/bin/etcd --name=etcd-172.17.1.22 --cert-file=/etc/kubernetes/ssl/etcd.pem --key-file=/etc/kubernetes/ssl/etcd-key.pem --peer-cert-file=/etc/kubernetes/ssl/etcd.pem --peer-key-file=/etc/kubernetes/ssl/etcd-key.pem --trusted-ca-file=/etc/kubernetes/ssl/ca.pem --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem --initial-advertise-peer-urls=https://172.17.1.22:2380 --listen-peer-urls=https://172.17.1.22:2380 --listen-client-urls=https://172.17.1.22:2379,http://127.0.0.1:2379 --advertise-client-urls=https://172.17.1.22:2379 --initial-cluster-token=etcd-cluster-0 --initial-cluster=etcd-172.17.1.20=https://172.17.1.20:2380,etcd-172.17.1.21=https://172.17.1.21:2380,etcd-172.17.1.22=https://172.17.1.22:2380 --initial-cluster-state=new --data-dir=/var/lib/etcd --snapshot-count=50000 --auto-compaction-retention=1 --max-request-bytes=10485760 --auto-compaction-mode=periodic --quota-backend-bytes=8589934592 3æœˆ 10 14:43:41 master03 etcd[81803]: ready to serve client requests 3æœˆ 10 14:43:41 master03 etcd[81803]: ready to serve client requests 3æœˆ 10 14:43:41 master03 systemd[1]: Started Etcd Server. 3æœˆ 10 14:43:41 master03 etcd[81803]: serving insecure client requests on 127.0.0.1:2379, this is strongly discouraged! 3æœˆ 10 14:43:41 master03 etcd[81803]: serving client requests on 172.17.1.22:2379 3æœˆ 10 14:43:41 master03 etcd[81803]: setting up the initial cluster version to 3.4 3æœˆ 10 14:43:41 master03 etcd[81803]: set the initial cluster version to 3.4 3æœˆ 10 14:43:41 master03 etcd[81803]: enabled capabilities for version 3.4 3æœˆ 10 14:43:41 master03 etcd[81803]: established a TCP streaming connection with peer 20eec45319ea02e1 (stream Message reader) 3æœˆ 10 14:43:41 master03 etcd[81803]: established a TCP streaming connection with peer 20eec45319ea02e1 (stream MsgApp v2 reader) 172.17.1.20 | CHANGED | rc=0 \u0026gt;\u0026gt; â— etcd.service - Etcd Server Loaded: loaded (/etc/systemd/system/etcd.service; enabled; vendor preset: disabled) Active: active (running) since å›› 2022-03-10 14:43:41 CST; 9s ago Docs: https://github.com/coreos Main PID: 103123 (etcd) Tasks: 13 Memory: 10.7M CGroup: /system.slice/etcd.service â””â”€103123 /opt/kube/bin/etcd --name=etcd-172.17.1.20 --cert-file=/etc/kubernetes/ssl/etcd.pem --key-file=/etc/kubernetes/ssl/etcd-key.pem --peer-cert-file=/etc/kubernetes/ssl/etcd.pem --peer-key-file=/etc/kubernetes/ssl/etcd-key.pem --trusted-ca-file=/etc/kubernetes/ssl/ca.pem --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem --initial-advertise-peer-urls=https://172.17.1.20:2380 --listen-peer-urls=https://172.17.1.20:2380 --listen-client-urls=https://172.17.1.20:2379,http://127.0.0.1:2379 --advertise-client-urls=https://172.17.1.20:2379 --initial-cluster-token=etcd-cluster-0 --initial-cluster=etcd-172.17.1.20=https://172.17.1.20:2380,etcd-172.17.1.21=https://172.17.1.21:2380,etcd-172.17.1.22=https://172.17.1.22:2380 --initial-cluster-state=new --data-dir=/var/lib/etcd --snapshot-count=50000 --auto-compaction-retention=1 --max-request-bytes=10485760 --auto-compaction-mode=periodic --quota-backend-bytes=8589934592 3æœˆ 10 14:43:41 master01 etcd[103123]: serving insecure client requests on 127.0.0.1:2379, this is strongly discouraged! 3æœˆ 10 14:43:41 master01 etcd[103123]: serving client requests on 172.17.1.20:2379 3æœˆ 10 14:43:41 master01 systemd[1]: Started Etcd Server. 3æœˆ 10 14:43:41 master01 etcd[103123]: 20eec45319ea02e1 initialized peer connection; fast-forwarding 8 ticks (election ticks 10) with 2 active peer(s) 3æœˆ 10 14:43:41 master01 etcd[103123]: set the initial cluster version to 3.4 3æœˆ 10 14:43:41 master01 etcd[103123]: enabled capabilities for version 3.4 3æœˆ 10 14:43:41 master01 etcd[103123]: established a TCP streaming connection with peer fc24d224af6a71d9 (stream Message writer) 3æœˆ 10 14:43:41 master01 etcd[103123]: established a TCP streaming connection with peer fc24d224af6a71d9 (stream MsgApp v2 writer) 3æœˆ 10 14:43:41 master01 etcd[103123]: established a TCP streaming connection with peer 395af18f6bbef1a (stream Message writer) 3æœˆ 10 14:43:41 master01 etcd[103123]: established a TCP streaming connection with peer 395af18f6bbef1a (stream MsgApp v2 writer) æ£€æŸ¥ ETCD é›†ç¾¤çŠ¶æ€ï¼ˆå¦‚ä¸‹ï¼Œå‘ç°etcdé›†ç¾¤é‡Œå·²ç»æˆåŠŸé€‰ä¸»äº†ï¼‰\nå†ä¾æ¬¡å¯åŠ¨æ‰€æœ‰masterèŠ‚ç‚¹çš„kube-apiserveræœåŠ¡ï¼š\n1 2 # systemctl start kube-apiserver # systemctl status kube-apiserver 1 2 3 4 5 6 [root@master01 ~]# ansible master -m shell -a \u0026#34;systemctl start kube-apiserver\u0026#34; 172.17.1.22 | CHANGED | rc=0 \u0026gt;\u0026gt; 172.17.1.21 | CHANGED | rc=0 \u0026gt;\u0026gt; 172.17.1.20 | CHANGED | rc=0 \u0026gt;\u0026gt; æŸ¥çœ‹kubernetesé›†ç¾¤çŠ¶æ€ï¼š\n1 2 3 4 5 6 7 8 [root@master01 ~]# kubectl get cs Warning: v1 ComponentStatus is deprecated in v1.19+ NAME STATUS MESSAGE ERROR scheduler Healthy ok controller-manager Healthy ok etcd-1 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;} etcd-2 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;} etcd-0 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;} æŸ¥çœ‹kubernetesçš„èµ„æºæƒ…å†µï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 [root@master01 ~]# kubectl get pod -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system calico-kube-controllers-5677ffd49-t7dbx 1/1 Running 0 3h27m kube-system calico-node-2hrhv 1/1 Running 0 3h27m kube-system calico-node-5kc79 1/1 Running 0 3h27m kube-system calico-node-6v294 1/1 Running 0 3h27m kube-system calico-node-hkm8l 1/1 Running 0 3h27m kube-system calico-node-kkpmd 1/1 Running 0 3h27m kube-system calico-node-tsmwx 1/1 Running 0 3h27m kube-system coredns-5787695b7f-8ql8q 1/1 Running 0 3h27m kube-system metrics-server-8568cf894b-ztcgf 1/1 Running 1 3h27m kube-system node-local-dns-5mbzg 1/1 Running 0 3h27m kube-system node-local-dns-c5d9j 1/1 Running 0 3h27m kube-system node-local-dns-nqnjw 1/1 Running 0 3h27m kube-system node-local-dns-rz565 1/1 Running 0 3h27m kube-system node-local-dns-skmzk 1/1 Running 0 3h27m kube-system node-local-dns-zcncq 1/1 Running 0 3h27m kube-system traefik-79f5f7879c-nwhlq 1/1 Running 0 3h27m åœ¨etcdé›†ç¾¤æ•°æ®æ¢å¤åï¼Œpodå®¹å™¨ä¹Ÿä¼šæ…¢æ…¢æ¢å¤åˆ°runningçŠ¶æ€ã€‚è‡³æ­¤ï¼Œkubernetesæ•´ä¸ªé›†ç¾¤å·²ç»é€šè¿‡etcdå¤‡ä»½æ•°æ®æ¢å¤äº†\nä¸‰ã€æœ€åæ€»ç»“ Kubernetes é›†ç¾¤å¤‡ä»½ä¸»è¦æ˜¯å¤‡ä»½ ETCD é›†ç¾¤ã€‚è€Œæ¢å¤æ—¶ï¼Œä¸»è¦è€ƒè™‘æ¢å¤æ•´ä¸ªé¡ºåºï¼š\nåœæ­¢kube-apiserver --\u0026gt; åœæ­¢ETCD --\u0026gt; æ¢å¤æ•°æ® --\u0026gt; å¯åŠ¨ETCD --\u0026gt; å¯åŠ¨kube-apiserve\nç‰¹åˆ«æ³¨æ„ï¼š\nå¤‡ä»½ETCDé›†ç¾¤æ—¶ï¼Œåªéœ€è¦å¤‡ä»½ä¸€ä¸ªETCDæ•°æ®ï¼Œç„¶ååŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚ æ¢å¤ETCDæ•°æ®æ—¶ï¼Œæ‹¿å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹çš„å¤‡ä»½æ•°æ®æ¢å¤å³å¯ å‚è€ƒ\nK8Sé›†ç¾¤ç¾å¤‡ç¯å¢ƒéƒ¨ç½² - æ•£å°½æµ®å - åšå®¢å›­\nhttps://www.cnblogs.com/kevingrace/p/14616824.html\n","date":"2022-03-10T15:02:58Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/202203101502/","title":"Kubernetesçš„ETCDé›†ç¾¤å¤‡ä»½ã€æ¢å¤"},{"content":"\nåŸå› ï¼šå› ä¸ºçªç„¶æ–­ç”µï¼Œå¯¼è‡´æœºå™¨å…³é—­\nç»“æœï¼šå‘ç°æœ‰ä¸€å°è™šæ‹Ÿæœºæ— æ³•å¯åŠ¨ï¼Œä¸€ç›´æŠ¥é”™Â Unmount and run xfs_repair\nåˆ†æï¼šä¸»æœºå¼‚å¸¸æ‰ç”µåé‡Œé¢çš„è™šæ‹Ÿæœºæ— æ³•å¯åŠ¨ï¼Œä¸»è¦æ˜¯æŸåçš„åˆ†åŒº\nè§£å†³åŠæ³•ï¼š\nåŸå› ï¼šçœ‹å‡ºæ¥åº”è¯¥æ˜¯dm-0åˆ†åŒºæŸåï¼Œä¿®å¤å°±å¯ä»¥äº†\n1ï¼šå¯åŠ¨è™šæ‹ŸæœºEè¿›å…¥å•ç”¨æˆ·æ¨¡å¼\n2ï¼šåœ¨linux16å¼€å¤´çš„å“ªä¸€è¡Œåé¢æ·»åŠ rd.breakï¼Œctrl+xè¿›å…¥æ•‘æ´æ¨¡å¼\n3ï¼šåˆ†ædm-0\n1 ls -l /dev/mapper 4:å¸è½½ç›®å½•\n1 umount /dev/mapper/centos-root 5:ä¿®å¤ç›®å½•\n1 xfs_repair -L /dev/mapper/centos-root 6ï¼šé‡å¯æœºå™¨\n1 init 6 ä¿®å¤å®Œæˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 xfs_repair -h xfs_repair: invalid option -- \u0026#39;h\u0026#39; Usage: xfs_repair [options] device Options: -f The device is a file -L Force log zeroing. Do this as a last resort. -l logdev Specifies the device where the external log resides. -m maxmem Maximum amount of memory to be used in megabytes. -n No modify mode, just checks the filesystem for damage. -P Disables prefetching. -r rtdev Specifies the device where the realtime section resides. -v Verbose output. -c subopts Change filesystem parameters - use xfs_admin. -o subopts Override default behaviour, refer to man page. -t interval Reporting interval in minutes. -d Repair dangerously. -V Reports version and exits. ","date":"2022-03-09T16:39:45Z","image":"https://www.ownit.top/title_pic/32.jpg","permalink":"https://www.ownit.top/p/202203091639/","title":"Linuxè™šæ‹Ÿæœºï¼ˆlvmï¼‰æŠ¥Unmount and run xfs_repair"},{"content":"DNSæœåŠ¡ç®€ä»‹ï¼š DNS(Domain Name Systemâ€“åŸŸåç³»ç»Ÿ),æ˜¯å› ç‰¹ç½‘çš„ä¸€é¡¹æœåŠ¡ã€‚å®ƒä½œä¸ºå°†åŸŸåå’ŒIPåœ°å€ç›¸äº’æ˜ å°„çš„ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œèƒ½å¤Ÿä½¿äººæ›´æ–¹ä¾¿åœ°è®¿é—®äº’è”ç½‘ã€‚æ˜¯ä¸€ä¸ªåº”ç”¨å±‚çš„åè®®DNSä½¿ç”¨TCPå’ŒUDPç«¯å£53ã€‚\nDNSæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“,å‘½åç³»ç»Ÿé‡‡ç”¨å±‚æ¬¡çš„é€»è¾‘ç»“æ„,å¦‚åŒä¸€é¢—å€’ç½®çš„æ ‘,è¿™ä¸ªé€»è¾‘çš„æ ‘å½¢ç»“æ„ç§°ä¸ºåŸŸåç©ºé—´,ç”±äºDNSåˆ’åˆ†äº†åŸŸåç©ºé—´,æ‰€ä»¥å„æœºæ„å¯ä»¥ä½¿ç”¨è‡ªå·±çš„åŸŸåç©ºé—´åˆ›å»ºDNSä¿¡æ¯.\næ³¨:DNSåŸŸåç©ºé—´ä¸­,æ ‘çš„æœ€å¤§æ·±åº¦ä¸å¾—è¶…è¿‡127å±‚,æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹æœ€é•¿å¯ä»¥å­˜å‚¨63ä¸ªå­—ç¬¦.\nä»¥ä¸Šæ˜¯åœ¨å…¬ç½‘ä¸­çš„ä½¿ç”¨\næ›´è¯¦ç»†ä»‹ç»ï¼šDNSæœåŠ¡å™¨æ­å»ºä¸é…ç½® | æ›¹ä¸–å®çš„åšå®¢\nDNSå†…ç½‘ä½¿ç”¨ é¦–å…ˆï¼Œæˆ‘ä»¬çº¯å†…ç½‘ä¸­ï¼Œæ˜¯ä¸èƒ½è¿‡è¿æ¥å¤–ç½‘çš„ç¯å¢ƒçš„ã€‚\nä½†æ˜¯çº¯å†…ç½‘ä¹Ÿä¼šæœ‰è®¸å¤šçš„IPå’ŒæœåŠ¡ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆæ¥åŒºåˆ†ï¼Œæ€»ä¸èƒ½è®°å½•æ‰€æœ‰IPï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå»ºå†…ç½‘çš„DNSï¼Œè¾¾åˆ°å†…ç½‘åŸŸåè§£æçš„æ•ˆæœã€‚\nDNSä½¿ç”¨ä½œç”¨ WHATï¼šDNSï¼ˆåŸŸåç³»ç»Ÿï¼‰è¯´ç™½äº†ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªåŸŸå’ŒIPåœ°å€åšäº†ä¸€ä¸‹ç»‘å®šï¼Œå¦‚ä½ åœ¨é‡Œæœºå™¨é‡Œé¢è¾“å…¥ nslookup \u0026lt;www.qq.com\u0026gt;ï¼Œå‡ºæ¥çš„Addressæ˜¯ä¸€å †IPï¼ŒIPæ˜¯ä¸å®¹æ˜“è®°çš„ï¼Œæ‰€ä»¥DNSè®©IPå’ŒåŸŸååšä¸€ä¸‹ç»‘å®šï¼Œè¿™æ ·ä½ è¾“å…¥åŸŸåå°±å¯ä»¥äº†\nWHYï¼šæˆ‘ä»¬è¦ç”¨ingressï¼Œåœ¨K8Sé‡Œè¦åš7å±‚è°ƒåº¦ï¼Œè€Œä¸”æ— è®ºå¦‚ä½•éƒ½è¦ç”¨åŸŸåï¼ˆå¦‚ä¹‹å‰çš„é‚£ä¸ªç™¾åº¦é¡µé¢çš„åŸŸåï¼Œé‚£ä¸ªæ˜¯hostçš„æ–¹å¼ï¼‰ï¼Œä½†æ˜¯é—®é¢˜æ˜¯æˆ‘ä»¬æ€ä¹ˆç»™K8Sé‡Œçš„å®¹å™¨ç»‘hostï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åšä¸€ä¸ªDNSï¼Œç„¶åå®¹å™¨æœä»æˆ‘ä»¬çš„DNSè§£æè°ƒåº¦\næˆ‘ä»¬ä¼šåœ¨10.4.7.11 å®‰è£…dnsä¸»æœåŠ¡ï¼Œ10.4.7.12ä½œä¸ºå¤‡ç”¨dnsæœåŠ¡\nä¹Ÿå¯ä»¥èµ°ä¸€å±‚keepaliveè™šæ‹ŸIPã€‚\nå¯ä»¥ç®€å•ç†è§£æˆï¼š\n11æœºå™¨ï¼šåå‘ä»£ç†\n12æœºå™¨ï¼šåå‘ä»£ç†\n21æœºå™¨ï¼šä¸»æ§+è¿ç®—èŠ‚ç‚¹ï¼ˆå³æœåŠ¡ç¾¤éƒ½æ˜¯è·‘åœ¨21å’Œ22ä¸Šï¼‰\n22æœºå™¨ï¼šä¸»æ§+è¿ç®—èŠ‚ç‚¹ï¼ˆç”Ÿäº§ä¸Šæˆ‘ä»¬ä¼šæŠŠä¸»æ§å’Œè¿ç®—åˆ†å¼€ï¼‰\n200æœºå™¨ï¼šè¿ç»´ä¸»æœºï¼ˆæ”¾å„ç§æ–‡ä»¶èµ„æºï¼‰\nè¿™æ ·æ§èŠ‚ç‚¹æœ‰ä¸¤ä¸ªï¼Œè¿ç®—èŠ‚ç‚¹æœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å°å‹çš„åˆ†å¸ƒå¼ï¼Œç°åœ¨ä½ å¯èƒ½æ²¡åŠæ³•ç†è§£è¿™äº›å†…å®¹ï¼Œæˆ‘ä»¬æ¥ç€åšä¸‹å»ï¼Œæ…¢æ…¢çš„ï¼Œä½ å°±ç†è§£äº†\nåˆå§‹åŒ– 1 2 3 4 5 6 7 8 9 # æŸ¥çœ‹enforceæ˜¯å¦å…³é—­ï¼Œç¡®ä¿disabledçŠ¶æ€ï¼Œå½“ç„¶å¯èƒ½æ²¡æœ‰è¿™ä¸ªå‘½ä»¤ ~]# getforce # æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ï¼Œç¡®ä¿åœ¨3.8ä»¥ä¸Šç‰ˆæœ¬ ~]# uname -a # å…³é—­firewalld ~]# systemctl stop firewalld # å®‰è£…epelæºåŠç›¸å…³å·¥å…· ~]# yum install epel-release -y ~]# yum install wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils -y uname:æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯\n-a/-allï¼šæ˜¾ç¤ºå…¨éƒ¨ yumï¼šæä¾›äº†æŸ¥æ‰¾ã€å®‰è£…ã€åˆ é™¤æŸä¸€ä¸ªã€ä¸€ç»„ç”šè‡³å…¨éƒ¨è½¯ä»¶åŒ…çš„å‘½ä»¤\ninstallï¼šå®‰è£…\n-yï¼šå½“å®‰è£…è¿‡ç¨‹æç¤ºé€‰æ‹©å…¨éƒ¨ä¸º\u0026quot;yes\u0026quot;\nå®‰è£…æ­¥éª¤Â 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # åœ¨11æœºå™¨ï¼š ~]# yum install bind -y ~]# rpm -qa bind # out: bind-9.11.4-9.P2.el7.x86_64 # é…ç½®ä¸»é…ç½®æ–‡ä»¶ï¼Œ11æœºå™¨ ~]# vi /etc/named.conf listen-on port 53 { 10.4.7.11; }; # åŸæœ¬æ˜¯127.0.0.1 # listen-on-v6 port 53 { ::1; }; # éœ€è¦åˆ æ‰ allow-query { any; }; # åŸæœ¬æ˜¯locall forwarders { 10.4.7.254; }; #å¦å¤–æ·»åŠ çš„ dnssec-enable no; # åŸæœ¬æ˜¯yes dnssec-validation no; # åŸæœ¬æ˜¯yes # æ£€æŸ¥ä¿®æ”¹æƒ…å†µï¼Œæ²¡æœ‰æŠ¥é”™å³å¯ï¼ˆå³æ²¡æœ‰ä¿¡æ¯ï¼‰ ~]# named-checkconf rpmï¼šè½¯ä»¶åŒ…ç®¡ç†å™¨\n-qaï¼šæŸ¥çœ‹å·²å®‰è£…çš„æ‰€æœ‰è½¯ä»¶åŒ… rpmå’Œyumå®‰è£…çš„åŒºåˆ«ï¼šå‰è€…ä¸æ£€æŸ¥ç›¸ä¾æ€§é—®é¢˜ï¼Œåè€…æ£€æŸ¥ï¼ˆå³ç›¸å…³ä¾èµ–åŒ…ï¼‰\nnamed.confæ–‡ä»¶å†…å®¹è§£æï¼š\nlisten-onï¼šç›‘å¬ç«¯å£ï¼Œæ”¹ä¸ºç›‘å¬åœ¨å†…ç½‘ï¼Œè¿™æ ·å…¶å®ƒæœºå™¨ä¹Ÿå¯ä»¥ç”¨\nallow-queryï¼šå“ªäº›å®¢æˆ·ç«¯èƒ½é€šè¿‡è‡ªå»ºçš„DNSæŸ¥\nforwardersï¼šä¸Šçº§DNSæ˜¯ä»€ä¹ˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # 11æœºå™¨ï¼Œç»éªŒï¼šä¸»æœºåŸŸä¸€å®šå¾—è·Ÿä¸šåŠ¡æ˜¯ä¸€ç‚¹å…³ç³»éƒ½æ²¡æœ‰ï¼Œå¦‚host.comï¼Œè€Œä¸šåŠ¡ç”¨çš„æ˜¯od.comï¼Œå› ä¸ºä¸šåŠ¡éšæ—¶å¯èƒ½å˜ # åŒºåŸŸé…ç½®æ–‡ä»¶ï¼ŒåŠ åœ¨æœ€ä¸‹é¢ ~]# vi /etc/named.rfc1912.zones zone \u0026#34;host.com\u0026#34; IN { type master; file \u0026#34;host.com.zone\u0026#34;; allow-update { 10.4.7.11; }; }; zone \u0026#34;od.com\u0026#34; IN { type master; file \u0026#34;od.com.zone\u0026#34;; allow-update { 10.4.7.11; }; }; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 # 11æœºå™¨ï¼š # æ³¨æ„serialè¡Œçš„æ—¶é—´ï¼Œä»£è¡¨ä»Šå¤©çš„æ—¶é—´+ç¬¬ä¸€æ¡è®°å½•ï¼š20200112+01 7-11 ~]# vi /var/named/host.com.zone $ORIGIN host.com. $TTL 600\t; 10 minutes @ IN SOA\tdns.host.com. dnsadmin.host.com. ( 2020011201 ; serial 10800 ; refresh (3 hours) 900 ; retry (15 minutes) 604800 ; expire (1 week) 86400 ; minimum (1 day) ) NS dns.host.com. $TTL 60\t; 1 minute dns A 10.4.7.11 HDSS7-11 A 10.4.7.11 HDSS7-12 A 10.4.7.12 HDSS7-21 A 10.4.7.21 HDSS7-22 A 10.4.7.22 HDSS7-200 A 10.4.7.200 7-11 ~]# vi /var/named/od.com.zone $ORIGIN od.com. $TTL 600\t; 10 minutes @ IN SOA\tdns.od.com. dnsadmin.od.com. ( 2020011201 ; serial 10800 ; refresh (3 hours) 900 ; retry (15 minutes) 604800 ; expire (1 week) 86400 ; minimum (1 day) ) NS dns.od.com. $TTL 60\t; 1 minute dns A 10.4.7.11 # çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰æŠ¥é”™ 7-11 ~]# named-checkconf 7-11 ~]# systemctl start named 7-11 ~]# netstat -luntp|grep 53 TTL 600ï¼šæŒ‡å®šIPåŒ…è¢«è·¯ç”±å™¨ä¸¢å¼ƒä¹‹å‰å…è®¸é€šè¿‡çš„æœ€å¤§ç½‘æ®µæ•°é‡\n10 minutesï¼šè¿‡æœŸæ—¶é—´10åˆ†é’Ÿ SOAï¼šä¸€ä¸ªåŸŸæƒå¨è®°å½•çš„ç›¸å…³ä¿¡æ¯ï¼Œåé¢æœ‰5ç»„å‚æ•°åˆ†åˆ«è®¾å®šäº†è¯¥åŸŸç›¸å…³éƒ¨åˆ†\ndnsadmin.od.com. ä¸€ä¸ªå‡çš„é‚®ç®±\nserialï¼šè®°å½•çš„æ—¶é—´\n$ORIGINï¼šå³ä¸‹åˆ—çš„åŸŸåè‡ªåŠ¨è¡¥å……od.comï¼Œå¦‚dnsï¼Œå¤–é¢çœ‹æ¥æ˜¯dns.od.com\nnetstat -luntpï¼šæ˜¾ç¤º tcp,udp çš„ç«¯å£å’Œè¿›ç¨‹ç­‰ç›¸å…³æƒ…å†µ\n1 2 3 4 5 6 7 8 # 11æœºå™¨ï¼Œæ£€æŸ¥ä¸»æœºåŸŸæ˜¯å¦è§£æ 7-11 ~]# dig -t A hdss7-21.host.com @10.4.7.11 +short # é…ç½®linuxå®¢æˆ·ç«¯å’Œwinå®¢æˆ·ç«¯éƒ½èƒ½ä½¿ç”¨è¿™ä¸ªæœåŠ¡ï¼Œä¿®æ”¹ 7-11 ~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0 DNS1=10.4.7.11 7-11 ~]# systemctl restart network 7-11 ~]# ping www.baidu.com 7-11 ~]# ping hdss7-21.host.com dig -t Aï¼šæŒ‡çš„æ˜¯æ‰¾DNSé‡Œæ ‡è®°ä¸ºAçš„ç›¸å…³è®°å½•ï¼Œè€Œåé¢ä¼šå¸¦ä¸Šç›¸å…³çš„åŸŸï¼Œå¦‚ä¸Šé¢çš„hdss7-21.host.comï¼Œä¸ºä»€ä¹ˆå¤–é¢é…äº†HDSS7-21åé¢è¿˜ä¼šè‡ªåŠ¨æ¥ä¸Š.host.comå°±æ˜¯å› ä¸º$ORIGINï¼Œåé¢åˆ™æ˜¯å¯¹åº”çš„IP\n+shortï¼šè¡¨ç¤ºåªè¿”å›IP 1 2 3 # åœ¨æ‰€æœ‰æœºå™¨æ·»åŠ search... ï¼Œå³å¯ä½¿ç”¨çŸ­åŸŸåï¼ˆæˆ‘çš„æ˜¯è‡ªå¸¦çš„ï¼‰ ~]# vi /etc/resolv.conf ~]# ping hdss7-200 1 2 3 4 5 6 7 8 9 # åœ¨é11æœºå™¨ä¸Šï¼Œå…¨éƒ¨æ”¹æˆ11 ~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0 DNS1=10.4.7.11 ~]# systemctl restart network # è¯•ä¸‹ç½‘ç»œæ˜¯å¦æ­£å¸¸ ~]# ping baidu.com # å…¶å®ƒæœºå™¨å°è¯•ping7-11æœºå™¨ 7-12 ~]# ping hdss7-11.host.com è®©å…¶å®ƒæœºå™¨çš„DNSå…¨éƒ¨æ”¹æˆ11æœºå™¨çš„å¥½å¤„æ˜¯ï¼Œå…¨éƒ¨çš„æœºå™¨è®¿é—®å¤–ç½‘å°±åªæœ‰é€šè¿‡11ç«¯å£ï¼Œæ›´å¥½æ§åˆ¶\n# ä¿®æ”¹windowç½‘ç»œï¼Œå¹¶ping\nåç»­åŸŸåè§£æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 [root@hdss7-11 ~]# cat /var/named/od.com.zone $ORIGIN od.com. $TTL 600\t; 10 minutes @ IN SOA\tdns.od.com. dnsadmin.od.com. ( 2020011523 ; serial #è¿™ä¸ªéœ€è¦æ¯æ¬¡å¢åŠ 1 10800 ; refresh (3 hours) 900 ; retry (15 minutes) 604800 ; expire (1 week) 86400 ; minimum (1 day) ) NS dns.od.com. $TTL 60\t; 1 minute dns A 10.4.7.11 harbor A 10.4.7.200 k8s-yaml A 10.4.7.200 traefik A 10.4.7.10 dashboard A 10.4.7.10 zk1 A 10.4.7.11 zk2 A 10.4.7.12 zk3 A 10.4.7.21 jenkins A 10.4.7.10 gitlab A 10.4.7.200 dubbo-monitor A 10.4.7.10 demo A 10.4.7.10 config A 10.4.7.10 mysql A 10.4.7.11 portal A 10.4.7.10 zk-test A 10.4.7.11 zk-prod A 10.4.7.12 config-test A 10.4.7.10 config-prod A 10.4.7.10 demo-test A 10.4.7.10 demo-prod A 10.4.7.10 blackbox A 10.4.7.10 prometheus A 10.4.7.10 grafana A 10.4.7.10 km A 10.4.7.10 kibana A 10.4.7.10 ","date":"2022-02-09T15:29:30Z","image":"https://www.ownit.top/title_pic/10.jpg","permalink":"https://www.ownit.top/p/202202091529/","title":"å†…ç½‘DNSé‡è¦ä½¿ç”¨ä½œç”¨"},{"content":"æ—¥å¸¸æˆ‘ä»¬ä¼šä½¿ç”¨åˆ°åˆ°å›¾åºŠæ¥å­˜æ”¾å›¾ç‰‡ï¼Œä½†æ˜¯å¤§è‡´æµç¨‹æ˜¯ä»€ä¹ˆæ ·å­çš„æ¥ï¼Ÿï¼Ÿ\nå›¾åºŠåŸç† å®ç°ä¸€ä¸ªHTTPæœåŠ¡å™¨,ç”¨è¿™ä¸ªæœåŠ¡å™¨å­˜å‚¨å›¾ç‰‡,é’ˆå¯¹æ¯ä¸ªå›¾ç‰‡æä¾›ä¸€ä¸ªå”¯ä¸€çš„url,å€ŸåŠ©è¿™ä¸ªurlå°±å¯ä»¥å°†å›¾ç‰‡å±•ç¤ºåˆ°å…¶ä»–ç½‘é¡µä¸Š\nåç«¯ä»£ç å®ç° é¡¹ç›®æ¥å£ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹Ginæ¡†æ¶ postè¯·æ±‚è®¿é—®ï¼Œä¸Šä¼ å›¾ç‰‡ï¼Œåˆ¤æ–­å›¾ç‰‡æ˜¯å¦ç¬¦åˆï¼Œåœ¨ä¸Šä¼ å›¾ç‰‡ï¼Œè¿”å›Urlåœ°å€ï¼Œæµè§ˆå™¨å°±å¯ä»¥æ­£å¸¸è®¿é—®\napp.ini 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 [app] HttpPort = 8000 RuntimeRootPath = runtime/ ImagePrefixUrl = http://127.0.0.1:8000 ImageSavePath = upload/images/ # MB ImageMaxSize = 5 ImageAllowExts = .jpg,.jpeg,.png,.gif LogSavePath = logs/ LogSaveName = log LogFileExt = log TimeFormat = 20060102 app/upload.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 package app import ( \u0026#34;ImagesUpload/pkg/e\u0026#34; \u0026#34;ImagesUpload/pkg/logging\u0026#34; \u0026#34;ImagesUpload/pkg/upload\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;strconv\u0026#34; \u0026#34;time\u0026#34; ) //è·å–ip func GetRequestIP(c *gin.Context) string { reqIP := c.ClientIP() if reqIP == \u0026#34;::1\u0026#34; { reqIP = \u0026#34;127.0.0.1\u0026#34; } return reqIP } func UploadImage(c *gin.Context) { code := e.SUCCESS data := make(map[string]string) t := time.Now() year := t.Year() // type int month := t.Month() // type time.Month file, image, err := c.Request.FormFile(\u0026#34;image\u0026#34;) if err != nil { logging.Warn(err) code = e.ERROR c.JSON(http.StatusOK, gin.H{ \u0026#34;code\u0026#34;: code, \u0026#34;msg\u0026#34;: e.GetMsg(code), \u0026#34;data\u0026#34;: data, }) } if image == nil { code = e.INVALID_PARAMS } else { imageName := upload.GetImageName(image.Filename) fullPath := upload.GetImageFullPath() + strconv.Itoa(year) + strconv.Itoa(int(month)) savePath := upload.GetImagePath() + strconv.Itoa(year) + strconv.Itoa(int(month)) src := fullPath + \u0026#34;/\u0026#34; + imageName fmt.Println(imageName, fullPath, savePath, src) if !upload.CheckImageExt(imageName) || !upload.CheckImageSize(file) { code = e.ERROR_UPLOAD_CHECK_IMAGE_FORMAT fmt.Println(e.GetMsg(code)) } else { err := upload.CheckImage(fullPath) if err != nil { logging.Warn(err) code = e.ERROR_UPLOAD_CHECK_IMAGE_FAIL } else if err := c.SaveUploadedFile(image, src); err != nil { logging.Warn(err) code = e.ERROR_UPLOAD_SAVE_IMAGE_FAIL } else { logging.Info(\u0026#34;è®¿é—®è€…IP:\u0026#34;,GetRequestIP(c),\u0026#34;ä¸Šä¼ åœ°å€è¿æ¥:\u0026#34;,upload.GetImageFullUrl(imageName)) data[\u0026#34;image_url\u0026#34;] = upload.GetImageFullUrl(imageName) data[\u0026#34;image_save_url\u0026#34;] = savePath + \u0026#34;/\u0026#34; + imageName } } } c.JSON(http.StatusOK, gin.H{ \u0026#34;code\u0026#34;: code, \u0026#34;msg\u0026#34;: e.GetMsg(code), \u0026#34;data\u0026#34;: data, }) } pkg pkg/e/code.go 1 2 3 4 5 6 7 8 9 10 11 12 13 package e const ( SUCCESS = 200 ERROR = 500 INVALID_PARAMS = 400 // ä¿å­˜å›¾ç‰‡å¤±è´¥ ERROR_UPLOAD_SAVE_IMAGE_FAIL = 30001 // æ£€æŸ¥å›¾ç‰‡å¤±è´¥ ERROR_UPLOAD_CHECK_IMAGE_FAIL = 30002 // æ ¡éªŒå›¾ç‰‡é”™è¯¯ï¼Œå›¾ç‰‡æ ¼å¼æˆ–å¤§å°æœ‰é—®é¢˜ ERROR_UPLOAD_CHECK_IMAGE_FORMAT = 30003 ) pkg/e/msg.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package e var MsgFlags = map[int]string { SUCCESS: \u0026#34;ok\u0026#34;, ERROR: \u0026#34;fail\u0026#34;, INVALID_PARAMS: \u0026#34;è¯·æ±‚å‚æ•°é”™è¯¯\u0026#34;, // ä¿å­˜å›¾ç‰‡å¤±è´¥ ERROR_UPLOAD_SAVE_IMAGE_FAIL: \u0026#34;ä¿å­˜å›¾ç‰‡å¤±è´¥\u0026#34;, // æ£€æŸ¥å›¾ç‰‡å¤±è´¥ ERROR_UPLOAD_CHECK_IMAGE_FAIL: \u0026#34;æ£€æŸ¥å›¾ç‰‡å¤±è´¥\u0026#34;, // æ ¡éªŒå›¾ç‰‡é”™è¯¯ï¼Œå›¾ç‰‡æ ¼å¼æˆ–å¤§å°æœ‰é—®é¢˜ ERROR_UPLOAD_CHECK_IMAGE_FORMAT: \u0026#34;æ ¡éªŒå›¾ç‰‡é”™è¯¯ï¼Œå›¾ç‰‡æ ¼å¼æˆ–å¤§å°æœ‰é—®é¢˜\u0026#34;, } func GetMsg(code int) string { msg ,ok := MsgFlags[code] if ok{ return msg } return MsgFlags[ERROR] } pkg/file/file.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 package file import ( \u0026#34;io/ioutil\u0026#34; \u0026#34;mime/multipart\u0026#34; \u0026#34;os\u0026#34; \u0026#34;path\u0026#34; ) /* GetSizeï¼šè·å–æ–‡ä»¶å¤§å° GetExtï¼šè·å–æ–‡ä»¶åç¼€ CheckNotExistï¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ CheckPermissionï¼šæ£€æŸ¥æ–‡ä»¶æƒé™ IsNotExistMkDirï¼šå¦‚æœä¸å­˜åœ¨åˆ™æ–°å»ºæ–‡ä»¶å¤¹ MkDirï¼šæ–°å»ºæ–‡ä»¶å¤¹ Openï¼šæ‰“å¼€æ–‡ä»¶ */ //GetSizeï¼šè·å–æ–‡ä»¶å¤§å° func GetSize(f multipart.File) (int, error) { content, err := ioutil.ReadAll(f) return len(content), err } //GetExtï¼šè·å–æ–‡ä»¶åç¼€ func GetExt(fileName string) string { return path.Ext(fileName) } //CheckNotExistï¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ func CheckNotExist(src string) bool { _, err := os.Stat(src) return os.IsNotExist(err) } //CheckPermissionï¼šæ£€æŸ¥æ–‡ä»¶æƒé™ func CheckPermission(src string) bool { _, err := os.Stat(src) return os.IsPermission(err) } //IsNotExistMkDirï¼šå¦‚æœä¸å­˜åœ¨åˆ™æ–°å»ºæ–‡ä»¶å¤¹ func IsNotExistMkDir(src string) error { if notExist := CheckNotExist(src); notExist == true { if err := MkDir(src); err != nil { return err } } return nil } //MkDirï¼šæ–°å»ºæ–‡ä»¶å¤¹ func MkDir(src string) error { err := os.MkdirAll(src, os.ModePerm) if err != nil { return err } return nil } //Openï¼šæ‰“å¼€æ–‡ä»¶ func Open(name string, flag int, perm os.FileMode) (*os.File, error) { f, err := os.OpenFile(name, flag, perm) if err != nil { return nil, err } return f, nil } pkg/logging/file.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package logging import ( \u0026#34;ImagesUpload/pkg/file\u0026#34; \u0026#34;ImagesUpload/setting\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;time\u0026#34; ) func getLogFilePath() string { return fmt.Sprintf(\u0026#34;%s%s\u0026#34;, setting.AppSetting.RuntimeRootPath, setting.AppSetting.LogSavePath) } func getLogFileName() string { return fmt.Sprintf(\u0026#34;%s%s.%s\u0026#34;, setting.AppSetting.LogSaveName, time.Now().Format(setting.AppSetting.TimeFormat), setting.AppSetting.LogFileExt, ) } func openLogFile(fileName, filePath string) (*os.File, error) { dir, err := os.Getwd() if err != nil { return nil, fmt.Errorf(\u0026#34;os.Getwd err: %v\u0026#34;, err) } src := dir + \u0026#34;/\u0026#34; + filePath perm := file.CheckPermission(src) if perm == true { return nil, fmt.Errorf(\u0026#34;file.CheckPermission Permission denied src: %s\u0026#34;, src) } err = file.IsNotExistMkDir(src) if err != nil { return nil, fmt.Errorf(\u0026#34;file.IsNotExistMkDir src: %s, err: %v\u0026#34;, src, err) } f, err := file.Open(src+fileName, os.O_APPEND|os.O_CREATE|os.O_WRONLY, 0644) if err != nil { return nil, fmt.Errorf(\u0026#34;Fail to OpenFile :%v\u0026#34;, err) } return f, nil } pkg/logging/log.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 package logging import ( \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;os\u0026#34; \u0026#34;path/filepath\u0026#34; \u0026#34;runtime\u0026#34; ) type Level int var ( F *os.File DefaultPrefix = \u0026#34;\u0026#34; DefaultCallerDepth = 2 logger *log.Logger logPrefix = \u0026#34;\u0026#34; levelFlags = []string{\u0026#34;DEBUG\u0026#34;, \u0026#34;INFO\u0026#34;, \u0026#34;WARN\u0026#34;, \u0026#34;ERROR\u0026#34;, \u0026#34;FATAL\u0026#34;} ) const ( DEBUG Level = iota INFO WARNING ERROR FATAL ) func Setup() { var err error filePath := getLogFilePath() fileName := getLogFileName() F, err = openLogFile(fileName, filePath) if err != nil { log.Fatalln(err) } logger = log.New(F, DefaultPrefix, log.LstdFlags) } func Debug(v ...interface{}) { setPrefix(DEBUG) logger.Println(v) } func Info(v ...interface{}) { setPrefix(INFO) logger.Println(v) } func Warn(v ...interface{}) { setPrefix(WARNING) logger.Println(v) } func Error(v ...interface{}) { setPrefix(ERROR) logger.Println(v) } func Fatal(v ...interface{}) { setPrefix(FATAL) logger.Fatalln(v) } func setPrefix(level Level) { _, file, line, ok := runtime.Caller(DefaultCallerDepth) if ok { logPrefix = fmt.Sprintf(\u0026#34;[%s][%s:%d]\u0026#34;, levelFlags[level], filepath.Base(file), line) } else { logPrefix = fmt.Sprintf(\u0026#34;[%s]\u0026#34;, levelFlags[level]) } logger.SetPrefix(logPrefix) } pkg/logging/logrus.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 package logging import ( \u0026#34;fmt\u0026#34; \u0026#34;github.com/sirupsen/logrus\u0026#34; ) func Logger() *logrus.Logger { //now := time.Now() //logFilePath := getLogFilePath() //logFileName := getLogFileFullPath() //æ—¥å¿—æ–‡ä»¶ //fileName := path.Join(logFilePath, logFileName) //if _, err := os.Stat(fileName); err != nil { //\tif _, err := os.Create(fileName); err != nil { //\tfmt.Println(err.Error()) //\t} //} //å†™å…¥æ–‡ä»¶ filePath := getLogFilePath() fileName := getLogFileName() F, err := openLogFile(fileName, filePath) if err != nil { fmt.Println(\u0026#34;æ—¥å¿—å†™å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥\u0026#34;) } //å®ä¾‹åŒ– logger := logrus.New() //è®¾ç½®è¾“å‡º logger.Out = F //è®¾ç½®æ—¥å¿—çº§åˆ« logger.SetLevel(logrus.DebugLevel) //è®¾ç½®æ—¥å¿—æ ¼å¼ logger.SetFormatter(\u0026amp;logrus.TextFormatter{ TimestampFormat: \u0026#34;2006-01-02 15:04:05\u0026#34;, }) return logger } pkg/upload/image.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 package upload import ( \u0026#34;ImagesUpload/pkg/file\u0026#34; \u0026#34;ImagesUpload/pkg/logging\u0026#34; \u0026#34;ImagesUpload/pkg/util\u0026#34; \u0026#34;ImagesUpload/setting\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;mime/multipart\u0026#34; \u0026#34;os\u0026#34; \u0026#34;path\u0026#34; \u0026#34;strconv\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;time\u0026#34; ) /* GetImageFullUrlï¼šè·å–å›¾ç‰‡å®Œæ•´è®¿é—® URL GetImageNameï¼šè·å–å›¾ç‰‡åç§° GetImagePathï¼šè·å–å›¾ç‰‡è·¯å¾„ GetImageFullPathï¼šè·å–å›¾ç‰‡å®Œæ•´è·¯å¾„ CheckImageExtï¼šæ£€æŸ¥å›¾ç‰‡åç¼€ CheckImageSizeï¼šæ£€æŸ¥å›¾ç‰‡å¤§å° CheckImageï¼šæ£€æŸ¥å›¾ç‰‡ */ //GetImageFullUrlï¼šè·å–å›¾ç‰‡å®Œæ•´è®¿é—® URL func GetImageFullUrl(name string) string { t := time.Now() year := t.Year() // type int month := t.Month() // type time.Month return setting.AppSetting.ImagePrefixUrl + \u0026#34;/\u0026#34; + GetImagePath() + strconv.Itoa(year) + strconv.Itoa(int(month)) + \u0026#34;/\u0026#34; + name } //GetImageNameï¼šè·å–å›¾ç‰‡åç§° func GetImageName(name string) string { ext := path.Ext(name) fileName := strings.TrimSuffix(name, ext) fileName = util.EncodeMD5(fileName) return fileName + ext } //GetImagePathï¼šè·å–å›¾ç‰‡è·¯å¾„ func GetImagePath() string { return setting.AppSetting.ImageSavePath } //GetImageFullPathï¼šè·å–å›¾ç‰‡å®Œæ•´è·¯å¾„ func GetImageFullPath() string { return setting.AppSetting.RuntimeRootPath + GetImagePath() } //CheckImageExtï¼šæ£€æŸ¥å›¾ç‰‡åç¼€ func CheckImageExt(fileName string) bool { ext := file.GetExt(fileName) for _, allowExt := range setting.AppSetting.ImageAllowExts { if strings.ToUpper(allowExt) == strings.ToUpper(ext) { return true } } return false } //CheckImageSizeï¼šæ£€æŸ¥å›¾ç‰‡å¤§å° func CheckImageSize(f multipart.File) bool { size, err := file.GetSize(f) if err != nil { log.Println(err) logging.Warn(err) return false } return size \u0026lt;= setting.AppSetting.ImageMaxSize } //CheckImageï¼šæ£€æŸ¥å›¾ç‰‡ func CheckImage(src string) error { dir, err := os.Getwd() if err != nil { return fmt.Errorf(\u0026#34;os.Getwd err: %v\u0026#34;, err) } err = file.IsNotExistMkDir(dir + \u0026#34;/\u0026#34; + src) if err != nil { return fmt.Errorf(\u0026#34;file.IsNotExistMkDir err: %v\u0026#34;, err) } perm := file.CheckPermission(src) if perm == true { return fmt.Errorf(\u0026#34;file.CheckPermission Permission denied src: %s\u0026#34;, src) } return nil } pkg/util/md5.go 1 2 3 4 5 6 7 8 9 10 11 12 package util import ( \u0026#34;crypto/md5\u0026#34; \u0026#34;encoding/hex\u0026#34; ) func EncodeMD5(value string) string { m := md5.New() m.Write([]byte(value)) return hex.EncodeToString(m.Sum(nil)) } routers/router.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package routers import ( \u0026#34;ImagesUpload/app\u0026#34; \u0026#34;ImagesUpload/pkg/upload\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;net/http\u0026#34; ) func InitRouter() *gin.Engine { r := gin.New() r.Use(gin.Logger()) r.Use(gin.Recovery()) r.StaticFS(\u0026#34;/upload/images\u0026#34;, http.Dir(upload.GetImageFullPath())) r.POST(\u0026#34;upload\u0026#34;, app.UploadImage) return r } setting/setting.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 package setting import ( \u0026#34;github.com/go-ini/ini\u0026#34; \u0026#34;log\u0026#34; ) type App struct { HttpPort int RuntimeRootPath string ImagePrefixUrl string ImageSavePath string ImageMaxSize int ImageAllowExts []string LogSavePath string LogSaveName string LogFileExt string TimeFormat string } var AppSetting = \u0026amp;App{} func Setup() { Cfg, err := ini.Load(\u0026#34;conf/app.ini\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Fail to parse \u0026#39;conf/app.ini\u0026#39;: %v\u0026#34;, err) } err = Cfg.Section(\u0026#34;app\u0026#34;).MapTo(AppSetting) if err != nil { log.Fatalf(\u0026#34;Cfg.MapTo AppSetting err: %v\u0026#34;, err) } AppSetting.ImageMaxSize = AppSetting.ImageMaxSize * 1024 * 1024 } main.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package main import ( \u0026#34;ImagesUpload/pkg/logging\u0026#34; \u0026#34;ImagesUpload/routers\u0026#34; \u0026#34;ImagesUpload/setting\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; ) func main() { setting.Setup() logging.Setup() router := routers.InitRouter() fmt.Println(\u0026#34;å¯åŠ¨ç«¯å£ï¼š\u0026#34;, setting.AppSetting.HttpPort) s := \u0026amp;http.Server{ Addr: fmt.Sprintf(\u0026#34;:%d\u0026#34;, setting.AppSetting.HttpPort), Handler: router, } if err := s.ListenAndServe(); err != nil { log.Printf(\u0026#34;Listen: %s\\n\u0026#34;, err) } } ","date":"2022-01-12T10:43:15Z","image":"https://www.ownit.top/title_pic/36.jpg","permalink":"https://www.ownit.top/p/202201121043/","title":"Ginç¼–å†™å›¾åºŠåç«¯-ä¸Šä¼ å›¾ç‰‡ä»£ç å®ç°"},{"content":"Gin Ginæ˜¯ä¸€ä¸ªgolangçš„å¾®æ¡†æ¶ï¼Œå°è£…æ¯”è¾ƒä¼˜é›…ï¼ŒAPIå‹å¥½ï¼Œæºç æ³¨é‡Šæ¯”è¾ƒæ˜ç¡®ï¼Œå·²ç»å‘å¸ƒäº†1.0ç‰ˆæœ¬ã€‚å…·æœ‰å¿«é€Ÿçµæ´»ï¼Œå®¹é”™æ–¹ä¾¿ç­‰ç‰¹ç‚¹ã€‚å…¶å®å¯¹äºgolangè€Œè¨€ï¼Œwebæ¡†æ¶çš„ä¾èµ–è¦è¿œæ¯”Pythonï¼ŒJavaä¹‹ç±»çš„è¦å°ã€‚è‡ªèº«çš„net/httpè¶³å¤Ÿç®€å•ï¼Œæ€§èƒ½ä¹Ÿéå¸¸ä¸é”™ã€‚æ¡†æ¶æ›´åƒæ˜¯ä¸€äº›å¸¸ç”¨å‡½æ•°æˆ–è€…å·¥å…·çš„é›†åˆã€‚å€ŸåŠ©æ¡†æ¶å¼€å‘ï¼Œä¸ä»…å¯ä»¥çœå»å¾ˆå¤šå¸¸ç”¨çš„å°è£…å¸¦æ¥çš„æ—¶é—´ï¼Œä¹Ÿæœ‰åŠ©äºå›¢é˜Ÿçš„ç¼–ç é£æ ¼å’Œå½¢æˆè§„èŒƒã€‚\nä¸‹é¢å°±Ginçš„ç”¨æ³•åšä¸€ä¸ªç®€å•çš„ä»‹ç»ã€‚\né¦–å…ˆéœ€è¦å®‰è£…ï¼Œå®‰è£…æ¯”è¾ƒç®€å•ï¼Œä½¿ç”¨go getå³å¯ï¼š\n1 go get gopkg.in/gin-gonic/gin.v1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 import ( \u0026#34;gopkg.in/gin-gonic/gin.v1\u0026#34; \u0026#34;net/http\u0026#34; ) func main(){ router := gin.Default() router.GET(\u0026#34;/\u0026#34;, func(c *gin.Context) { c.String(http.StatusOK, \u0026#34;Hello World\u0026#34;) }) router.Run(\u0026#34;:8000\u0026#34;) } æ—¥å¸¸æˆ‘ä»¬æ˜¯ä½¿ç”¨Ginæ¡†æ¶ç¼–å†™æ¥å£ç­‰ç­‰ï¼Œå¯èƒ½ä¼šä½¿ç”¨åˆ°ä¸€ä¸‹å‡ ç§ç»„ä»¶ã€‚\nZap æ—¥å¿—è®°å½•\nlumberjack æ—¥å¿—åˆ‡å‰²\nini é…ç½®æ–‡ä»¶è¯»å–\ninié…ç½®è¯»å– ä¸‹è½½\n1 go get github.com/go-ini/ini å› ä¸ºé¡¹ç›®ä¸­è¦æ˜¯åˆ°é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨iniæ¨¡å—æ¥å®ç°\né¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªconfig.inié…ç½®æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 port = 9000 release = false [mysql] user = db1 password = db1 host = 10.10.10.6 port = 3306 db = db1 [log] level = debug filename = ./logs/info.log maxsize = 1 max_age = 30 max_backups = 5 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package setting import ( \u0026#34;gopkg.in/ini.v1\u0026#34; ) var Conf = new(AppConfig) // AppConfig åº”ç”¨ç¨‹åºé…ç½® type AppConfig struct { Release bool `ini:\u0026#34;release\u0026#34;` Port int `ini:\u0026#34;port\u0026#34;` *MySQLConfig `ini:\u0026#34;mysql\u0026#34;` *LogConfig `ini:\u0026#34;log\u0026#34;` } // MySQLConfig æ•°æ®åº“é…ç½® type MySQLConfig struct { User string `ini:\u0026#34;user\u0026#34;` Password string `ini:\u0026#34;password\u0026#34;` DB string `ini:\u0026#34;db\u0026#34;` Host string `ini:\u0026#34;host\u0026#34;` Port int `ini:\u0026#34;port\u0026#34;` } type LogConfig struct { Level string `ini:\u0026#34;level\u0026#34;` Filename string `ini:\u0026#34;filename\u0026#34;` MaxSize int `ini:\u0026#34;maxsize\u0026#34;` MaxAge int `ini:\u0026#34;max_age\u0026#34;` MaxBackups int `ini:\u0026#34;max_backups\u0026#34;` } //æŠŠå…ˆå…³åˆå§‹çš„å‚æ•°åŠ è½½åˆ°å…¨å±€å˜é‡ï¼Œç„¶åæ–¹ä¾¿è°ƒç”¨ func Init(file string) error { return ini.MapTo(Conf, file) } çœ‹ä¸€ä¸‹è°ƒç”¨æ–¹å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // ä¼ å…¥é…ç½®æ–‡ä»¶è·¯å¾„ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶, if err := setting.Init(\u0026#34;conf/config.ini\u0026#34;); err != nil { fmt.Printf(\u0026#34;load config from file failed, err:%v\\n\u0026#34;, err) return } fmt.Println(\u0026#34;config.inié…ç½®åŠ è½½æˆåŠŸ\u0026#34;, setting.Conf.Port) // åˆ›å»ºæ•°æ®åº“ // sql: CREATE DATABASE bubble; // è¿æ¥æ•°æ®åº“ err := dao.InitMySQL(setting.Conf.MySQLConfig) if err != nil { fmt.Printf(\u0026#34;init mysql failed, err:%v\\n\u0026#34;, err) return } fmt.Println(\u0026#34;æ•°æ®åº“é…ç½®åˆå§‹åŒ–åŠ è½½æˆåŠŸ\u0026#34;, setting.Conf.MySQLConfig) if err := log.InitLogger(setting.Conf.LogConfig); err != nil { fmt.Printf(\u0026#34;init logger failed, err:%v\\n\u0026#34;, err) return } å·²ç»åŠ è½½å…¨å±€å˜é‡ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨\nmysqlè°ƒç”¨å‚æ•°ï¼Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 func InitMySQL(cfg *setting.MySQLConfig) (err error) { dsn := fmt.Sprintf(\u0026#34;%s:%s@tcp(%s:%d)/%s?charset=utf8mb4\u0026amp;parseTime=True\u0026amp;loc=Local\u0026#34;, cfg.User, cfg.Password, cfg.Host, cfg.Port, cfg.DB) DB, err = gorm.Open(\u0026#34;mysql\u0026#34;, dsn) if err != nil { return } DB.Debug() DB.LogMode(true) DB.SetLogger(\u0026amp;GormLogger{}) return DB.DB().Ping() } Zapå’Œlumberjack Zap æ—¥å¿—è®°å½•\nlumberjack æ—¥å¿—åˆ‡å‰²\n1 2 go get -u go.uber.org/zap go get -u github.com/natefinch/lumberjack å¤§å®¶å¯ä»¥å‚è€ƒ\ngolangå¼€å‘:ç±»åº“ç¯‡(ä¸€) Zapé«˜æ€§èƒ½æ—¥å¿—ç±»åº“çš„ä½¿ç”¨ - é£ç¿”ç å†œ - åšå®¢å›­ä½¿ç”¨zapæ¥æ”¶ginæ¡†æ¶é»˜è®¤çš„æ—¥å¿—å¹¶é…ç½®æ—¥å¿—å½’æ¡£ - å…°ç‰ç£Šçš„ä¸ªäººåšå®¢golangå¼€å‘:ç±»åº“ç¯‡(ä¸€) Zapé«˜æ€§èƒ½æ—¥å¿—ç±»åº“çš„ä½¿ç”¨ - é£ç¿”ç å†œ - åšå®¢å›­\nåœ¨Goè¯­è¨€é¡¹ç›®ä¸­ä½¿ç”¨Zapæ—¥å¿—åº“ - çŸ¥ä¹\næ—¥å¿—æ ¼å¼\n1 2 {\u0026#34;level\u0026#34;:\u0026#34;INFO\u0026#34;,\u0026#34;time\u0026#34;:\u0026#34;2021-12-28T15:34:50.934+0800\u0026#34;,\u0026#34;caller\u0026#34;:\u0026#34;log/logger.go:65\u0026#34;,\u0026#34;msg\u0026#34;:\u0026#34;/\u0026#34;,\u0026#34;status\u0026#34;:200,\u0026#34;method\u0026#34;:\u0026#34;GET\u0026#34;,\u0026#34;path\u0026#34;:\u0026#34;/\u0026#34;,\u0026#34;query\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;ip\u0026#34;:\u0026#34;127.0.0.1\u0026#34;,\u0026#34;user-agent\u0026#34;:\u0026#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36\u0026#34;,\u0026#34;errors\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;cost\u0026#34;:0.0010676} {\u0026#34;level\u0026#34;:\u0026#34;DEBUG\u0026#34;,\u0026#34;time\u0026#34;:\u0026#34;2021-12-28T15:34:51.194+0800\u0026#34;,\u0026#34;caller\u0026#34;:\u0026#34;dao/mysql.go:23\u0026#34;,\u0026#34;msg\u0026#34;:\u0026#34;sql\u0026#34;,\u0026#34;module\u0026#34;:\u0026#34;gorm\u0026#34;,\u0026#34;type\u0026#34;:\u0026#34;sql\u0026#34;,\u0026#34;src\u0026#34;:\u0026#34;D:/æ¡Œé¢/bubble/models/todo.go:24\u0026#34;,\u0026#34;duration\u0026#34;:0.0504676,\u0026#34;sql\u0026#34;:\u0026#34;SELECT * FROM `todos` \u0026#34;,\u0026#34;values\u0026#34;:null,\u0026#34;rows_returned\u0026#34;:3} æˆ‘ä»¬éœ€è¦æŠŠå®ƒé›†æˆåˆ°Ginæ¡†æ¶ä¸­ã€‚\næˆ‘è¿™è¾¹çš„é…ç½®ï¼Œä¹Ÿä¼šè¯»å–iniçš„æ–‡ä»¶ï¼ˆçœ‹ä¸Šé¢çš„ä»£ç ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 [log] level = debug filename = ./logs/info.log maxsize = 1 max_age = 30 max_backups = 5 type LogConfig struct { Level string `ini:\u0026#34;level\u0026#34;` Filename string `ini:\u0026#34;filename\u0026#34;` MaxSize int `ini:\u0026#34;maxsize\u0026#34;` MaxAge int `ini:\u0026#34;max_age\u0026#34;` MaxBackups int `ini:\u0026#34;max_backups\u0026#34;` } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 package log import ( \u0026#34;bubble/setting\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;github.com/natefinch/lumberjack\u0026#34; \u0026#34;go.uber.org/zap\u0026#34; \u0026#34;go.uber.org/zap/zapcore\u0026#34; \u0026#34;net\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;net/http/httputil\u0026#34; \u0026#34;os\u0026#34; \u0026#34;runtime/debug\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;time\u0026#34; ) var Logger *zap.Logger // InitLogger åˆå§‹åŒ–Logger func InitLogger(cfg *setting.LogConfig) (err error) { writeSyncer := getLogWriter(cfg.Filename, cfg.MaxSize, cfg.MaxBackups, cfg.MaxAge) //fmt.Println(cfg.Filename) encoder := getEncoder() var l = new(zapcore.Level) err = l.UnmarshalText([]byte(cfg.Level)) if err != nil { return } core := zapcore.NewCore(encoder, writeSyncer, l) Logger = zap.New(core, zap.AddCaller()) return } func getEncoder() zapcore.Encoder { encoderConfig := zap.NewProductionEncoderConfig() encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder encoderConfig.TimeKey = \u0026#34;time\u0026#34; encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder encoderConfig.EncodeDuration = zapcore.SecondsDurationEncoder encoderConfig.EncodeCaller = zapcore.ShortCallerEncoder return zapcore.NewJSONEncoder(encoderConfig) } func getLogWriter(filename string, maxSize, maxBackup, maxAge int) zapcore.WriteSyncer { lumberJackLogger := \u0026amp;lumberjack.Logger{ Filename: filename, MaxSize: maxSize, MaxBackups: maxBackup, MaxAge: maxAge, } return zapcore.AddSync(lumberJackLogger) } // GinLogger æ¥æ”¶ginæ¡†æ¶é»˜è®¤çš„æ—¥å¿— func GinLogger(logger *zap.Logger) gin.HandlerFunc { return func(c *gin.Context) { start := time.Now() path := c.Request.URL.Path query := c.Request.URL.RawQuery c.Next() cost := time.Since(start) logger.Info(path, zap.Int(\u0026#34;status\u0026#34;, c.Writer.Status()), zap.String(\u0026#34;method\u0026#34;, c.Request.Method), zap.String(\u0026#34;path\u0026#34;, path), zap.String(\u0026#34;query\u0026#34;, query), zap.String(\u0026#34;ip\u0026#34;, c.ClientIP()), zap.String(\u0026#34;user-agent\u0026#34;, c.Request.UserAgent()), zap.String(\u0026#34;errors\u0026#34;, c.Errors.ByType(gin.ErrorTypePrivate).String()), zap.Duration(\u0026#34;cost\u0026#34;, cost), ) } } // GinRecovery recoveræ‰é¡¹ç›®å¯èƒ½å‡ºç°çš„panicï¼Œå¹¶ä½¿ç”¨zapè®°å½•ç›¸å…³æ—¥å¿— func GinRecovery(logger *zap.Logger, stack bool) gin.HandlerFunc { return func(c *gin.Context) { defer func() { if err := recover(); err != nil { // Check for a broken connection, as it is not really a // condition that warrants a panic stack trace. var brokenPipe bool if ne, ok := err.(*net.OpError); ok { if se, ok := ne.Err.(*os.SyscallError); ok { if strings.Contains(strings.ToLower(se.Error()), \u0026#34;broken pipe\u0026#34;) || strings.Contains(strings.ToLower(se.Error()), \u0026#34;connection reset by peer\u0026#34;) { brokenPipe = true } } } httpRequest, _ := httputil.DumpRequest(c.Request, false) if brokenPipe { logger.Error(c.Request.URL.Path, zap.Any(\u0026#34;error\u0026#34;, err), zap.String(\u0026#34;request\u0026#34;, string(httpRequest)), ) // If the connection is dead, we can\u0026#39;t write a status to it. c.Error(err.(error)) // nolint: errcheck c.Abort() return } if stack { logger.Error(\u0026#34;[Recovery from panic]\u0026#34;, zap.Any(\u0026#34;error\u0026#34;, err), zap.String(\u0026#34;request\u0026#34;, string(httpRequest)), zap.String(\u0026#34;stack\u0026#34;, string(debug.Stack())), ) } else { logger.Error(\u0026#34;[Recovery from panic]\u0026#34;, zap.Any(\u0026#34;error\u0026#34;, err), zap.String(\u0026#34;request\u0026#34;, string(httpRequest)), ) } c.AbortWithStatus(http.StatusInternalServerError) } }() c.Next() } } æ³¨å†Œä¸­é—´ä»¶çš„æ“ä½œåœ¨routes.SetupRouter()ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 func SetupRouter() *gin.Engine { if setting.Conf.Release { gin.SetMode(gin.ReleaseMode) } #å¼€å§‹è°ƒç”¨ï¼Œä¸­é—´ä»¶ä½¿ç”¨ r := gin.New() r.Use(log.GinLogger(log.Logger), log.GinRecovery(log.Logger, true)) } mainä¸­è°ƒç”¨\n1 2 log.Logger.Debug(\u0026#34;å¤§å®¶å¥½ï¼Œæ—¥å¿—å±•ç¤º\u0026#34;) defer log.Logger.Sync() 1 {\u0026#34;level\u0026#34;:\u0026#34;DEBUG\u0026#34;,\u0026#34;time\u0026#34;:\u0026#34;2021-12-28T15:34:42.647+0800\u0026#34;,\u0026#34;caller\u0026#34;:\u0026#34;bubble/main.go:39\u0026#34;,\u0026#34;msg\u0026#34;:\u0026#34;å¤§å®¶å¥½ï¼Œæ—¥å¿—å±•ç¤º\u0026#34;} æ—¥å¿—æ ¼å¼å¯ä»¥å®šä¹‰jsonæ ¼å¼ï¼ŒåæœŸå¯ä»¥ç›´æ¥æ¥å…¥elkåˆ†æå±•ç¤ºæ—¥å¿—\nGormçš„sqlæ—¥å¿—è®°å½•åˆ°æ–‡æœ¬ Gorm å»ºç«‹äº†å¯¹ Logger çš„æ”¯æŒï¼Œé»˜è®¤æ¨¡å¼åªä¼šåœ¨é”™è¯¯å‘ç”Ÿçš„æ—¶å€™æ‰“å°æ—¥å¿—ã€‚å¯ä»¥é€šè¿‡gorm SetLogger(log logger)æ–¹æ³• æ”¹å˜gorm æ‰“æ—¥å¿—çš„è¡Œä¸ºã€‚\ngorm ä¸­ loggerçš„æ¥å£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 type logger interface { Print(ctx context.Context, v ...interface{}) } v çš„å€¼ä¸ºï¼š 1ä¸ªå‚æ•°ï¼š levelï¼Œè¡¨ç¤ºè¿™ä¸ªæ˜¯ä¸ªä»€ä¹ˆè¯·æ±‚ï¼Œå¯ä»¥æ˜¯â€œsqlâ€ 2ä¸ªå‚æ•°ï¼šæ‰“å°sqlçš„ä»£ç è¡Œå·ï¼Œå¦‚/Users/yejianfeng/Documents/gopath/src/gorm-log/main.go:50, 3ä¸ªå‚æ•°: æ‰§è¡Œæ—¶é—´æˆ³ 4ä¸ªå‚æ•°: sqlè¯­å¥ 5å‚æ•°ï¼šå¦‚æœæœ‰é¢„å¤„ç†ï¼Œè¯·æ±‚å‚æ•°ï¼Œç¬¬å…­ä¸ªå‚æ•°æ˜¯è¿™ä¸ªsqlå½±å“çš„è¡Œæ•°ã€‚ zaplogé›†æˆç¤ºä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 DB.Debug() DB.LogMode(true) DB.SetLogger(\u0026amp;GormLogger{}) // GormLogger struct type GormLogger struct{} // Print - Log Formatter func (*GormLogger) Print(v ...interface{}) { switch v[0] { case \u0026#34;sql\u0026#34;: log.Debug( \u0026#34;sql\u0026#34;, zap.String(\u0026#34;module\u0026#34;, \u0026#34;gorm\u0026#34;), zap.String(\u0026#34;type\u0026#34;, \u0026#34;sql\u0026#34;), zap.Any(\u0026#34;src\u0026#34;, v[1]), zap.Any(\u0026#34;duration\u0026#34;, v[2]), zap.Any(\u0026#34;sql\u0026#34;, v[3]), zap.Any(\u0026#34;values\u0026#34;, v[4]), zap.Any(\u0026#34;rows_returned\u0026#34;, v[5]), ) case \u0026#34;log\u0026#34;: log.Debug(\u0026#34;log\u0026#34;, zap.Any(\u0026#34;gorm\u0026#34;, v[2])) } } æ—¥å¿—æ ¼å¼ï¼Œsqlè¯­å¥å·²ç»æ‰“å°åˆ°æ—¥å¿—ä¸­\n1 {\u0026#34;level\u0026#34;:\u0026#34;DEBUG\u0026#34;,\u0026#34;time\u0026#34;:\u0026#34;2021-12-28T15:34:51.194+0800\u0026#34;,\u0026#34;caller\u0026#34;:\u0026#34;dao/mysql.go:23\u0026#34;,\u0026#34;msg\u0026#34;:\u0026#34;sql\u0026#34;,\u0026#34;module\u0026#34;:\u0026#34;gorm\u0026#34;,\u0026#34;type\u0026#34;:\u0026#34;sql\u0026#34;,\u0026#34;src\u0026#34;:\u0026#34;D:/æ¡Œé¢/bubble/models/todo.go:24\u0026#34;,\u0026#34;duration\u0026#34;:0.0504676,\u0026#34;sql\u0026#34;:\u0026#34;SELECT * FROM `todos` \u0026#34;,\u0026#34;values\u0026#34;:null,\u0026#34;rows_returned\u0026#34;:3} å‚è€ƒæ–‡æ¡£Â GORMè‡ªå®šä¹‰æ—¥å¿—é…ç½® - è‹å±±è½æš® - åšå®¢å›­\n","date":"2021-12-30T16:43:23Z","image":"https://www.ownit.top/title_pic/12.jpg","permalink":"https://www.ownit.top/p/202112301643/","title":"Ginæ¡†æ¶ç»„åˆï¼ˆZapã€lumberjackã€iniï¼‰ä½¿ç”¨æ‰‹å†Œ"},{"content":"è¿‘æœŸï¼Œå¿«è¦é‚»è¿‘æ˜¥èŠ‚ï¼Œå®‰å…¨æ–¹é¢æ›´åŠ é‡è¦ã€‚\né¦–å…ˆè¦å¯¹æ“ä½œç³»ç»Ÿçš„ç”¨æˆ·åšå®‰å…¨ç›‘æ§ï¼Œé˜²æ­¢æ“ä½œç³»ç»Ÿè´¦å·è¢«çˆ†ç ´æ³„éœ²ï¼Œæˆ‘ä»¬ä¹Ÿè¦ç›‘æ§èµ·æ¥ã€‚\nï¼ˆ1ï¼‰Zabbixè®°å½•æ¯åˆ†é’Ÿæ—¥å¿—ç™»å½•å¤±è´¥çš„æ¬¡æ•°\nï¼ˆ2ï¼‰Zabbixè®°å½•ç™»å½•å¤±è´¥ç”¨æˆ·çš„ä¿¡æ¯ï¼Œæ–¹ä¾¿æŸ¥çœ‹\né¦–å…ˆï¼Œæˆ‘ä»¬æ•´ä¸ªé›†ç¾¤æ—¥å¿—ï¼Œé€šè¿‡rsyslogæœåŠ¡ï¼ŒæŠŠä¸Šåƒå°çš„æ—¥å¿—åŒæ­¥åˆ°ä¸€å°ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç›‘æ§è¿™ä¸ªrsyslogçš„æœåŠ¡ç«¯å°±å¯ä»¥äº†ã€‚Â çœ‹æ•ˆæœå›¾ï¼ˆè¿™æ ·ä¸€æ¥ï¼Œååˆ†æ–¹ä¾¿æŸ¥çœ‹è®°å½•ï¼‰\nï¼ˆ1ï¼‰Â ç™»å½•å¤±è´¥æ¬¡æ•° æ—¥å¿—æ ¼å¼\n1 2021-12-29T15:04:16.264895+08:00 127.0.0.1 [sshd] notice: pam_unix(sshd:auth): authentication failure; logname= uid=0 euid=0 tty=ssh ruser= rhost=172.17.9.200 user=deployer ç¼–å†™ä»£ç çš„è„šæœ¬\n1 2 3 4 5 6 7 8 9 10 11 #!/bin/bash LOG_PATH=\u0026#34;/var/log/secure\u0026#34; mon=$(date +%B) h=$(date +%d) ms=$(date +%H:%M) #è¡¨ç¤ºå­—ç¬¦å¼€å¤´ä¸º0å°±æ›¿æ¢ä¸ºç©º h=${h/#0/\u0026#34;\u0026#34;} k=\u0026#34;T\u0026#34; #æˆ‘è¿™è¾¹æœ‰Tï¼Œæœ‰çš„æ˜¯ç©ºæ ¼ï¼Œæ ¹æ®æ—¶é—´ç¯å¢ƒä½¿ç”¨ count=`grep \u0026#34;$h$k$ms\u0026#34; /var/log/secure | grep -v sudo | grep -c \u0026#34;authentication failure\u0026#34; ` echo $count ä¿®æ”¹zabbixå®¢æˆ·ç«¯é…ç½®\n1 2 #====================æ£€æŸ¥ è´¦å·ç™»å½•å¤±è´¥æ¬¡æ•°====================== UserParameter=check_failed,sh /usr/local/zabbix-v503/scripts/check_failed.sh é‡å¯zabbixå®¢æˆ·ç«¯\nzabbixç•Œé¢é…ç½®\næ£€æŸ¥é…ç½®\nè§¦å‘å™¨\nï¼ˆ2ï¼‰å¤±è´¥æ—¥å¿—è®°å½• ç¼–å†™è„šæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 [root@logserver01 zabbix-v503]# cat scripts/check_failedlog.sh #!/bin/bash LOG_PATH=\u0026#34;/var/log/secure\u0026#34; mon=$(date +%B) h=$(date +%d) #è·å–å‰ä¸€åˆ†é’Ÿçš„çˆ†ç ´æ—¥å¿—è®°å½•çš„æ—¶é—´ æ—¶:åˆ† ms=$(date -d \u0026#34;1 minute ago\u0026#34; +\u0026#34;%H:%M\u0026#34;) #è¡¨ç¤ºå­—ç¬¦å¼€å¤´ä¸º0å°±æ›¿æ¢ä¸ºç©º h=${h/#0/\u0026#34;\u0026#34;} k=\u0026#34;T\u0026#34; grep \u0026#34;$h$k$ms\u0026#34; /var/log/secure | grep -v sudo | grep \u0026#34;authentication failure\u0026#34; \u0026gt;\u0026gt; /usr/local/zabbix-v503/scripts/fail.log å¼€å¯å®šæ—¶ä»»åŠ¡ï¼ˆæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰\n1 2 #-------check_fail_user_log----------------- * * * * * sh /usr/local/zabbix-v503/scripts/check_failedlog.sh å¦‚æœæœ‰ç™»å½•å¤±è´¥çš„ï¼Œä¼šå•ç‹¬è¿‡æ»¤å‡ºæ¥\nzabbixç•Œé¢é…ç½®\n1 log[/usr/local/zabbix-v503/scripts/fail.log,\u0026#34;sshd\u0026#34;,skip,] å·²ç»å®Œæˆç›¸å…³çš„é¡¹ç›®ç±»å®¹ï¼Œå¾ˆå®¹æ˜“ç›‘æ§ã€‚\næ ¹æ®è§¦å‘å™¨ï¼Œå¯ä»¥è®¾ç½®å€¼ï¼Œå¦‚æœæ¯åˆ†é’Ÿçˆ†ç ´ç™»å½•å¤±è´¥10æ¬¡ï¼Œå°±æŠ¥è­¦ï¼Œæœ‰çˆ†ç ´çš„å«Œç–‘\n","date":"2021-12-29T15:28:13Z","image":"https://www.ownit.top/title_pic/73.jpg","permalink":"https://www.ownit.top/p/202112291528/","title":"Zabbixç›‘æ§é›†ç¾¤æ“ä½œç”¨æˆ·â€œç™»å½•å¤±è´¥æ¬¡æ•°â€œå’Œâ€œå¤±è´¥æ—¥å¿—è®°å½•â€œ"},{"content":"ç›¸å…³ä»£ç å·²ç»æ”¾åœ¨githubï¼šhttps://github.com/nangongchengfeng/Go_gin/tree/main/Projects\nGOçš„WEBç¼–ç¨‹ï¼ˆGINå®ç°é‚®ä»¶æ¥å£æŠ¥è­¦ï¼‰ Ginç¼–å†™é‚®ä»¶æ¥å£ï¼ˆæ”¯æŒå¤šäººå‘é€ï¼‰ Ginç¼–å†™é‚®ä»¶å‘Šè­¦æ¥å£ï¼ˆæ·»åŠ ä¼˜åŒ–æ—¥å¿—è®°å½•ï¼‰ ä¸Šé¢3ä¸ªå·²ç»å®ŒæˆåŸºæœ¬åŠŸèƒ½ï¼Œä½†æ˜¯æ‰€æœ‰çš„ä»£ç æ”¾åœ¨ä¸€ä¸ªmainï¼Œé…ç½®ä¹Ÿæ˜¯å†™æ­»ä»£ç é‡Œé¢ï¼Œä¸æ–¹ä¾¿ä¿®æ”¹è°ƒæ•´ã€‚ç°åœ¨åœ¨ä»¥ä¸Šçš„åŸºç¡€ä¸Šæ·»åŠ æ–°çš„åŠŸèƒ½\nï¼ˆ1ï¼‰åŠ å…¥é…ç½®æ–‡ä»¶è¯»å†™ç®¡ç†\nï¼ˆ2ï¼‰é¡¹ç›®æ‹†åˆ†\nå› ä¸ºæ—¥å¸¸èŒƒå›´ï¼Œæˆ‘ä»¬åœ¨æ“ä½œç³»ç»Ÿä¸Šï¼Œéœ€è¦æŠ¥è­¦æ—¶ï¼Œåªèƒ½é‡‡ç”¨mailxæ¥ä½¿ç”¨ã€‚éœ€è¦é…ç½®è´¦å·ï¼Œå¯†ç ï¼Œå’Œé‚®ç®±è®¤è¯ã€‚å¦‚æœéœ€è¦å¤šå°ä½¿ç”¨çš„è¯ï¼Œå²‚ä¸æ˜¯å¾ˆéº»çƒ¦ï¼Œè¦é…ç½®å¤šå°ï¼Œè¿™ä¸ªå¯¼è‡´å¯†ç å¾ˆä¸å®‰å…¨ï¼Œå®¹æ˜“æ³„éœ²ã€‚æ‰€ä»¥ï¼Œä¸ºäº†å®‰å…¨ï¼Œæœ‰æ•ˆï¼Œæ›´æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨æ¥å£å‘é€é‚®ä»¶ã€‚\nï¼ˆ1ï¼‰æ„å»ºæ¥å£\nï¼ˆ2ï¼‰ä¼ å…¥postçš„jsonæƒ…å†µ\nï¼ˆ3ï¼‰æŠŠç›¸åº”jsonè½¬æ¢å­—ç¬¦\nï¼ˆ4ï¼‰å‘é€é‚®ä»¶\nå¼€å§‹ä¸‹é¢é¡¹ç›®è§„åˆ’\nmain.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package main import ( \u0026#34;code/mail_qq/log\u0026#34; \u0026#34;code/mail_qq/routers\u0026#34; \u0026#34;code/mail_qq/setting\u0026#34; \u0026#34;fmt\u0026#34; ) /* æ”¯æŒå¤šäººå‘é€ curl http://10.10.10.3:7070/send -H \u0026#34;Content-Type:application/json\u0026#34; -X POST -d \u0026#39;{\u0026#34;source\u0026#34;:\u0026#34;heian\u0026#34;,\u0026#34;contacts\u0026#34;:[\u0026#34;è´¦å·@mail_qq.com\u0026#34;,\u0026#34;è´¦å·@mail_qq.com\u0026#34;],\u0026#34;subject\u0026#34;:\u0026#34;å¤šäººæµ‹è¯•\u0026#34;,\u0026#34;content\u0026#34;:\u0026#34;ç°åœ¨è¿›è¡Œå¤šäººæµ‹è¯•\u0026#34;}\u0026#39; */ /* zapcore.Coreéœ€è¦ä¸‰ä¸ªé…ç½®â€”â€”Encoderï¼ŒWriteSyncerï¼ŒLogLevel Encoder:ç¼–ç å™¨(å¦‚ä½•å†™å…¥æ—¥å¿—)ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å¼€ç®±å³ç”¨çš„NewJSONEncoder() WriterSyncer ï¼šæŒ‡å®šæ—¥å¿—å°†å†™åˆ°å“ªé‡Œå»ã€‚æˆ‘ä»¬ä½¿ç”¨zapcore.AddSync() Log Levelï¼šå“ªç§çº§åˆ«çš„æ—¥å¿—å°†è¢«å†™å…¥ã€‚ */ //var sugarLogger *zap.SugaredLogger func main() { log.InitLogger() defer log.SugarLogger.Sync() port := setting.GetPort() r := routers.SetupRouter() r.Run(\u0026#34;:\u0026#34; + fmt.Sprint(port)) log.SugarLogger.Infof(\u0026#34;Success! Port is start\u0026#34;) //r.Run(\u0026#34;:8080\u0026#34;) } conf/config.ini 1 2 3 4 5 6 port = 8080 [mail] user = è´¦å·@qq.com password = å¯†ç  host = smtp.qq.com:25 source = heian util/Â GetIP.go å·¥å…·ç±»ï¼Œè·å–å®¢æˆ·ç«¯çš„IP\n1 2 3 4 5 6 7 8 9 10 11 12 package util import \u0026#34;github.com/gin-gonic/gin\u0026#34; //è·å–ip func GetRequestIP(c *gin.Context) string { reqIP := c.ClientIP() if reqIP == \u0026#34;::1\u0026#34; { reqIP = \u0026#34;127.0.0.1\u0026#34; } return reqIP } **Â setting/setting.go** åŠ å…¥é…ç½®æ–‡ä»¶ï¼Œç»™ä»£ç è¿”å›ç›¸åº”çš„å‚æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package setting import ( \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;github.com/go-ini/ini\u0026#34; ) func GetMail() (user, password, host, source string) { //è¯»å–.inié‡Œé¢çš„æ•°æ®åº“é…ç½® config, err := ini.Load(\u0026#34;conf/config.ini\u0026#34;) if err != nil { //å¤±è´¥ fmt.Printf(\u0026#34;Fail to read file: %v\u0026#34;, err) os.Exit(1) } host = config.Section(\u0026#34;mail\u0026#34;).Key(\u0026#34;host\u0026#34;).String() //port = config.Section(\u0026#34;mail\u0026#34;).Key(\u0026#34;port\u0026#34;).String() user = config.Section(\u0026#34;mail\u0026#34;).Key(\u0026#34;user\u0026#34;).String() password = config.Section(\u0026#34;mail\u0026#34;).Key(\u0026#34;password\u0026#34;).String() source = config.Section(\u0026#34;mail\u0026#34;).Key(\u0026#34;source\u0026#34;).String() //fmt.Println(user, password, host, source) return } func GetPort() (prot string) { config, err := ini.Load(\u0026#34;conf/config.ini\u0026#34;) if err != nil { //å¤±è´¥ fmt.Printf(\u0026#34;Fail to read file: %v\u0026#34;, err) os.Exit(1) } prot = config.Section(\u0026#34;\u0026#34;).Key(\u0026#34;port\u0026#34;).String() return } log/Â log.go æ—¥å¿—åˆ‡å‰²å’Œåˆ†å‰²ç±»ï¼Œä¸»è¦è®°å½•æ—¥å¿—\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package log import ( \u0026#34;github.com/natefinch/lumberjack\u0026#34; \u0026#34;go.uber.org/zap\u0026#34; \u0026#34;go.uber.org/zap/zapcore\u0026#34; ) var SugarLogger *zap.SugaredLogger func InitLogger() { writeSyncer := getLogWriter() encoder := getEncoder() core := zapcore.NewCore(encoder, writeSyncer, zapcore.DebugLevel) logger := zap.New(core, zap.AddCaller()) SugarLogger = logger.Sugar() } func getEncoder() zapcore.Encoder { encoderConfig := zap.NewProductionEncoderConfig() encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder return zapcore.NewConsoleEncoder(encoderConfig) } func getLogWriter() zapcore.WriteSyncer { /* Lumberjack Loggeré‡‡ç”¨ä»¥ä¸‹å±æ€§ä½œä¸ºè¾“å…¥: Filename: æ—¥å¿—æ–‡ä»¶çš„ä½ç½® MaxSizeï¼šåœ¨è¿›è¡Œåˆ‡å‰²ä¹‹å‰ï¼Œæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°ï¼ˆä»¥MBä¸ºå•ä½ï¼‰ MaxBackupsï¼šä¿ç•™æ—§æ–‡ä»¶çš„æœ€å¤§ä¸ªæ•° MaxAgesï¼šä¿ç•™æ—§æ–‡ä»¶çš„æœ€å¤§å¤©æ•° Compressï¼šæ˜¯å¦å‹ç¼©/å½’æ¡£æ—§æ–‡ä»¶ */ lumberJackLogger := \u0026amp;lumberjack.Logger{ Filename: \u0026#34;./logs/info.log\u0026#34;, MaxSize: 10, MaxBackups: 5, MaxAge: 30, Compress: false, } return zapcore.AddSync(lumberJackLogger) } routers/router.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package routers import ( \u0026#34;code/mail_qq/app\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; ) func SetupRouter() *gin.Engine { r := gin.Default() //v1 v1Group := r.Group(\u0026#34;v1\u0026#34;) { //å¾…åŠäº‹é¡¹ //æ·»åŠ  v1Group.POST(\u0026#34;/send\u0026#34;, app.PostMail) } return r } app/Â send.go å‘é€é‚®ä»¶çš„ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 package app import ( \u0026#34;code/mail_qq/log\u0026#34; \u0026#34;code/mail_qq/setting\u0026#34; \u0026#34;code/mail_qq/util\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;net/smtp\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; ) //var sugarLogger *zap.SugaredLogger // å®šä¹‰æ¥æ”¶æ•°æ®çš„ç»“æ„ä½“ type User struct { // binding:\u0026#34;required\u0026#34;ä¿®é¥°çš„å­—æ®µï¼Œè‹¥æ¥æ”¶ä¸ºç©ºå€¼ï¼Œåˆ™æŠ¥é”™ï¼Œæ˜¯å¿…é¡»å­—æ®µ Source string `form:\u0026#34;source\u0026#34; json:\u0026#34;source\u0026#34; uri:\u0026#34;source\u0026#34; xml:\u0026#34;source\u0026#34; binding:\u0026#34;required\u0026#34;` Contacts []string `form:\u0026#34;contacts\u0026#34; json:\u0026#34;contacts\u0026#34; uri:\u0026#34;contacts\u0026#34; xml:\u0026#34;contacts\u0026#34; binding:\u0026#34;required\u0026#34;` Subject string `form:\u0026#34;subject\u0026#34; json:\u0026#34;subject\u0026#34; uri:\u0026#34;subject\u0026#34; xml:\u0026#34;subject\u0026#34; binding:\u0026#34;required\u0026#34;` Content string `form:\u0026#34;content\u0026#34; json:\u0026#34;content\u0026#34; uri:\u0026#34;content\u0026#34; xml:\u0026#34;content\u0026#34; binding:\u0026#34;required\u0026#34;` } func SendToMail(user, sendUserName, password, host, to, subject, body, mailtype string) error { hp := strings.Split(host, \u0026#34;:\u0026#34;) //fmt.Println(hp) auth := smtp.PlainAuth(\u0026#34;\u0026#34;, user, password, hp[0]) var content_type string if mailtype == \u0026#34;html\u0026#34; { content_type = \u0026#34;Content-Type: text/\u0026#34; + mailtype + \u0026#34;; charset=UTF-8\u0026#34; } else { content_type = \u0026#34;Content-Type: text/plain\u0026#34; + \u0026#34;; charset=UTF-8\u0026#34; } msg := []byte(\u0026#34;To: \u0026#34; + to + \u0026#34;\\r\\nFrom: \u0026#34; + sendUserName + \u0026#34;\u0026lt;\u0026#34; + user + \u0026#34;\u0026gt;\u0026#34; + \u0026#34;\\r\\nSubject: \u0026#34; + subject + \u0026#34;\\r\\n\u0026#34; + content_type + \u0026#34;\\r\\n\\r\\n\u0026#34; + body) send_to := strings.Split(to, \u0026#34;;\u0026#34;) err := smtp.SendMail(host, auth, user, send_to, msg) //fmt.Println(err) return err } func PostMail(c *gin.Context) { c_ip := util.GetRequestIP(c) fmt.Println(c_ip) log.SugarLogger.Debugf(\u0026#34;è°ƒç”¨ PostMail æ¥å£Apiï¼Œè°ƒç”¨è€…IPï¼š %s \u0026#34;, c_ip) å£°æ˜æ¥æ”¶çš„å˜é‡ var json User å°†requestçš„bodyä¸­çš„æ•°æ®ï¼Œè‡ªåŠ¨æŒ‰ç…§jsonæ ¼å¼è§£æåˆ°ç»“æ„ä½“ // if err := c.ShouldBindJSON(\u0026amp;json); err != nil { //\t// è¿”å›é”™è¯¯ä¿¡æ¯ //\t// gin.Hå°è£…äº†ç”Ÿæˆjsonæ•°æ®çš„å·¥å…· c.JSON(http.StatusBadRequest, gin.H{\u0026#34;error\u0026#34;: err.Error()}) log.SugarLogger.Errorf(\u0026#34;Error: %s\u0026#34;, err.Error()) return } //fmt.Println(json.Content, json.Contacts) //c.JSON(http.StatusOK, gin.H{\u0026#34;status\u0026#34;: \u0026amp;json}) //sugarLogger.Infof(\u0026#34;info: %s\u0026#34;, json) sources := json.Source user, password, host, source := setting.GetMail() if sources != source { fmt.Println(\u0026#34;Send mail error!,source è®¤è¯å¤±è´¥\u0026#34;) log.SugarLogger.Errorf(\u0026#34;Send mail error!,source è®¤è¯å¤±è´¥\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,source è®¤è¯å¤±è´¥\u0026#34;, }) return } //println(json.Contacts) to := json.Contacts if to[0] == \u0026#34;\u0026#34; { fmt.Println(\u0026#34;Send mail error!,å‘é€äººä¸ºç©º\u0026#34;) log.SugarLogger.Errorf(\u0026#34;Send mail error!,å‘é€äººä¸ºç©º\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,å‘é€äººä¸ºç©º\u0026#34;, }) return } subject := json.Subject if strings.TrimSpace(subject) == \u0026#34;\u0026#34; { fmt.Println(\u0026#34;Send mail error!æ ‡é¢˜ä¸ºç©º\u0026#34;) log.SugarLogger.Errorf(\u0026#34;Send mail error!æ ‡é¢˜ä¸ºç©º\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,æ ‡é¢˜ä¸ºç©º\u0026#34;, }) return } body := ` \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;iso-8859-15\u0026#34;\u0026gt; \u0026lt;title\u0026gt;MMOGA POWER\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; ` + fmt.Sprintf(json.Content) + `\u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt;` sendUserName := \u0026#34;å‘Šè­¦å¹³å°\u0026#34; //å‘é€é‚®ä»¶çš„äººåç§° fmt.Println(\u0026#34;send email\u0026#34;) for _, s := range to { //fmt.Println(i, s) err := SendToMail(user, sendUserName, password, host, s, subject, body, \u0026#34;html\u0026#34;) //log.Printf(\u0026#34;æ¥æ”¶äººï¼š\u0026#34;, s+\u0026#34;\\n\u0026#34;+\u0026#34;æ ‡é¢˜:\u0026#34;, json.Subject+\u0026#34;\\n\u0026#34;, \u0026#34;å‘é€å†…å®¹ï¼š\u0026#34;, json.Content+\u0026#34;\\n\u0026#34;) fmt.Printf(\u0026#34;æ¥æ”¶äºº:%s \\n æ ‡é¢˜: %s \\n å†…å®¹: %s \\n\u0026#34;, s, json.Subject, json.Content) log.SugarLogger.Infof(\u0026#34;æ¥æ”¶äºº: %s ,æ ‡é¢˜: %s, å†…å®¹: %s\u0026#34;, s, json.Subject, json.Content) fmt.Println(err) if err != nil { fmt.Println(\u0026#34;Send mail error!\\n\u0026#34;) log.SugarLogger.Errorf(\u0026#34;Error è°ƒç”¨è€…IP: %s ,Send mail error! !\u0026#34;, c_ip) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error! !\\n\u0026#34;, }) //fmt.Println(err) } else { fmt.Println(\u0026#34;Send mail success!\\n\u0026#34;) log.SugarLogger.Infof(\u0026#34;success è°ƒç”¨è€…IP: %s ,Send mail success! !\u0026#34;, c_ip) c.JSON(http.StatusOK, gin.H{ \u0026#34;success\u0026#34;: \u0026#34;Send mail success! !\\n\u0026#34;, }) } } } åŠŸèƒ½å®ç°\næ—¥å¿—è®°å½•\n","date":"2021-12-25T14:13:07Z","image":"https://www.ownit.top/title_pic/71.jpg","permalink":"https://www.ownit.top/p/202112251413/","title":"Ginç¼–å†™é‚®ä»¶å‘Šè­¦æ¥å£ï¼ˆæ·»åŠ é…ç½®ï¼Œé¡¹ç›®æ‹†åˆ†ï¼‰"},{"content":"æ ¹æ®æˆ‘å¼€å‘çš„é‚®ä»¶æ¥å£ä¸Šè°ƒç”¨æ“ä½œï¼Œè§¦å‘å‘Šè­¦\nGOçš„WEBç¼–ç¨‹ï¼ˆGINå®ç°é‚®ä»¶æ¥å£æŠ¥è­¦ï¼‰ Ginç¼–å†™é‚®ä»¶æ¥å£ï¼ˆæ”¯æŒå¤šäººå‘é€ï¼‰ Ginç¼–å†™é‚®ä»¶å‘Šè­¦æ¥å£ï¼ˆæ·»åŠ ä¼˜åŒ–æ—¥å¿—è®°å½•ï¼‰ é¦–å…ˆï¼Œæˆ‘ä»¬Linuxæ“ä½œç³»ç»Ÿå¯ä»¥åˆ›å»ºå¤šä¸ªç”¨æˆ·è´¦å·ã€‚\nä½†æ˜¯ä¸ºäº†ç³»ç»Ÿå®‰å…¨è€ƒè™‘ï¼Œæˆ‘ä»¬ä¼šç»™è´¦å·å¯†ç è®¾ç½®æœ‰æ•ˆæœŸå’Œå¤æ‚éš¾åº¦ï¼Œé˜²æ­¢éæ³•æ“ä½œçˆ†ç ´æˆ‘ä»¬çš„æœºå™¨ã€‚\nä½†æ˜¯æ¯æ¬¡ä¿®æ”¹å®Œï¼Œåˆ°è§„å®šæ—¶é—´éœ€è¦ä¿®æ”¹è´¦å·å¯†ç ï¼Œè¿™ä¸ªæ¯æ¬¡äººå·¥æ¥çœ‹ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥åšä¸ªè´¦å·å¯†ç åˆ°æœŸçš„è­¦å‘Šã€‚å½“å¯†ç å¿«è¦è¿‡æœŸæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å‘é‚®ä»¶å‘Šè­¦ã€‚\nè´¦å·å¯†ç è¿‡æœŸè®¾ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 function Check_Password_Policy(){ #æŸ¥çœ‹ç³»ç»Ÿè´¦æˆ·ç­–ç•¥:å¯†ç å¤±æ•ˆæ—¶é—´90å¤©ã€å¯†ç åˆ°æœŸæé†’æ—¶é—´14å¤© echo \u0026#34;========æ­£åœ¨æ£€æŸ¥è´¦æˆ·å¯†ç å¤±æ•ˆæ—¶é—´========\u0026#34; Check_Pass_Poli=`grep -E \u0026#34;^PASS_MAX_DAYS|^PASS_WARN_AGE\u0026#34; /etc/login.defs | wc -l` cp /etc/login.defs{,_bak$Date_Time} if [ $Check_Pass_Poli -lt 2 ];then echo -e \u0026#34;\\033[31;40må½“å‰ç³»ç»Ÿæœªå¯¹è´¦æˆ·å¯†ç è¿›è¡Œå¤±æ•ˆæ—¶é—´è®¾ç½®ã€å¯†ç åˆ°æœŸæé†’è®¾ç½®\\033[0m\u0026#34; sed -i \u0026#39;$iPASS_MAX_DAYS 90\u0026#39; /etc/login.defs \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32;40m ä¿®æ”¹æˆåŠŸ \\033[0m\u0026#34; || echo -e \u0026#34;\\033[31;40m ä¿®æ”¹å¤±è´¥ \\033[0m\u0026#34; sed -i \u0026#39;$iPASS_WARN_AGE 14\u0026#39; /etc/login.defs \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32;40m ä¿®æ”¹æˆåŠŸ \\033[0m\u0026#34; || echo -e \u0026#34;\\033[31;40m ä¿®æ”¹å¤±è´¥ \\033[0m\u0026#34; else PAMAX=`grep -E \u0026#34;^PASS_MAX_DAYS\u0026#34; /etc/login.defs | awk -F\u0026#34; \u0026#34; \u0026#39;{ print $2 }\u0026#39;` PAWARN=`grep -E \u0026#34;^PASS_WARN_AGE\u0026#34; /etc/login.defs | awk -F\u0026#34; \u0026#34; \u0026#39;{ print $2 }\u0026#39;` if [ $PAMAX -le 90 ];then echo -e \u0026#34;\\033[32;40må¯†ç å¤±æ•ˆæ—¶é—´ä¸º$PAMAXå¤©ï¼Œç¬¦åˆæ ‡å‡†\\033[0m\u0026#34;; else echo -e \u0026#34;\\033[31;40må¯†ç å¤±æ•ˆæ—¶é—´ä¸º$PAMAXå¤©ï¼Œä¸ç¬¦åˆæ ‡å‡†\\033[0m\u0026#34;; sed -i \u0026#39;s/^PASS_MAX_DAYS.*/PASS_MAX_DAYS 90/\u0026#39; /etc/login.defs \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32;40m ä¿®æ”¹æˆåŠŸ \\033[0m\u0026#34; || echo -e \u0026#34;\\033[31;40m ä¿®æ”¹å¤±è´¥ \\033[0m\u0026#34; fi if [ $PAWARN -ge 14 ];then echo -e \u0026#34;\\033[32;40må¯†ç åˆ°æœŸæé†’æ—¶é—´ä¸º$PAWARNå¤©ï¼Œç¬¦åˆæ ‡å‡†\\033[0m\u0026#34;; else echo -e \u0026#34;\\033[31;40må¯†ç åˆ°æœŸæé†’æ—¶é—´ä¸º$PAWARNå¤©ï¼Œä¸ç¬¦åˆæ ‡å‡†\\033[0m\u0026#34;; sed -i \u0026#39;s/^PASS_WARN_AGE.*/PASS_WARN_AGE 14/\u0026#39; /etc/login.defs \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32;40m ä¿®æ”¹æˆåŠŸ \\033[0m\u0026#34; || echo -e \u0026#34;\\033[31;40m ä¿®æ”¹å¤±è´¥ \\033[0m\u0026#34; fi fi #chage --warndays 14 root \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32;40m ä¿®æ”¹æˆåŠŸ \\033[0m\u0026#34; || echo -e \u0026#34;\\033[31;40m ä¿®æ”¹å¤±è´¥ \\033[0m\u0026#34; #chage --maxdays 90 root \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32;40m ä¿®æ”¹æˆåŠŸ \\033[0m\u0026#34; || echo -e \u0026#34;\\033[31;40m ä¿®æ”¹å¤±è´¥ \\033[0m\u0026#34; } å¯†ç å¤æ‚åº¦è®¾ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 function Check_User_Policy(){ #æŸ¥çœ‹ç³»ç»Ÿè´¦æˆ·ç­–ç•¥:å¯†ç æœ€å°é•¿åº¦12ä½ã€å¯†ç å¤æ‚åº¦ä¸ºå¤§å°å†™è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ echo \u0026#34;========æ­£åœ¨æ£€æŸ¥è´¦æˆ·å¯†ç ç­–ç•¥========\u0026#34; Check_User_Poli=`grep -E \u0026#34;^minlen|^minclass\u0026#34; /etc/security/pwquality.conf |wc -l` cp /etc/security/pwquality.conf{,_bak$Date_Time} if [ $Check_User_Poli -lt 2 ];then echo -e \u0026#34;\\033[31;40må½“å‰ç³»ç»Ÿæœªå¯¹è´¦æˆ·å¯†ç å¤æ‚åº¦åŠå¯†ç æœ€å°é•¿åº¦è®¾ç½®\\033[0m\u0026#34; sed -i \u0026#39;$iminlen = 12\u0026#39; /etc/security/pwquality.conf \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32;40m ä¿®æ”¹æˆåŠŸ \\033[0m\u0026#34; || echo -e \u0026#34;\\033[31;40m ä¿®æ”¹å¤±è´¥ \\033[0m\u0026#34; sed -i \u0026#39;$iminclass = 4\u0026#39; /etc/security/pwquality.conf \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32;40m ä¿®æ”¹æˆåŠŸ \\033[0m\u0026#34; || echo -e \u0026#34;\\033[31;40m ä¿®æ”¹å¤±è´¥ \\033[0m\u0026#34; else PACLS=`grep -E \u0026#34;^minclass\u0026#34; /etc/security/pwquality.conf | awk -F\u0026#34;=| \u0026#34; \u0026#39;{ print $NF }\u0026#39;` PALEN=`grep -E \u0026#34;^minlen\u0026#34; /etc/security/pwquality.conf | awk -F\u0026#34;=| \u0026#34; \u0026#39;{ print $NF }\u0026#39;` if [ $PACLS -eq 4 ];then echo -e \u0026#34;\\033[32;40må¯†ç è´Ÿè´£åº¦ä¸º$PACLSç§ç±»å‹ï¼Œç¬¦åˆæ ‡å‡†\\033[0m\u0026#34;; else echo -e \u0026#34;\\033[31;40må¯†ç è´Ÿè´£åº¦ä¸º$PACLSç§ç±»å‹ï¼Œä¸ç¬¦åˆæ ‡å‡†\\033[0m\u0026#34;; sed -i \u0026#39;s/^minclass.*/minclass = 4/\u0026#39; /etc/login.defs \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32;40m ä¿®æ”¹æˆåŠŸ \\033[0m\u0026#34; || echo -e \u0026#34;\\033[31;40m ä¿®æ”¹å¤±è´¥ \\033[0m\u0026#34; fi if [ $PALEN -ge 12 ];then echo -e \u0026#34;\\033[32;40må¯†ç é•¿åº¦ä¸º$PALENä½ï¼Œç¬¦åˆæ ‡å‡†\\033[0m\u0026#34;; else echo -e \u0026#34;\\033[31;40må¯†ç é•¿åº¦ä¸º$PALENä½ï¼Œä¸ç¬¦åˆæ ‡å‡†\\033[0m\u0026#34;; sed -i \u0026#39;s/^minlen.*/minlen = 12/\u0026#39; /etc/login.defs \u0026amp;\u0026amp; echo -e \u0026#34;\\033[32;40m ä¿®æ”¹æˆåŠŸ \\033[0m\u0026#34; || echo -e \u0026#34;\\033[31;40m ä¿®æ”¹å¤±è´¥ \\033[0m\u0026#34; fi fi } ç”¨æˆ·è®¤è¯å¤±è´¥æ¬¡æ•°è®¾ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 function Check_Auth_Failed(){ echo \u0026#34;========æ­£åœ¨æ£€æŸ¥ç”¨æˆ·ç™»é™†è®¤è¯å¤±è´¥æ¬¡æ•°========\u0026#34; Check_Auth_Failsystem=`grep pam_faillock.so /etc/pam.d/system-auth | wc -l` Check_Auth_Failpasswd=`grep pam_faillock.so /etc/pam.d/password-auth | wc -l` cp /etc/pam.d/system-auth{,_bak$Date_Time} cp /etc/pam.d/password-auth{,_bak$Date_Time} if [ $Check_Auth_Failsystem -ge 3 ];then if [ $Check_Auth_Failpasswd -ge 3 ];then echo -e \u0026#34;\\033[32;40m ç”¨æˆ·ç™»é™†è¿ç»­è®¤è¯å¤±è´¥é”å®šç­–ç•¥è®¾ç½®æˆåŠŸï¼Œç¬¦åˆæ ‡å‡† \\033[0m\u0026#34; else echo -e \u0026#34;\\033[31;40m ç”¨æˆ·ç™»é™†è¿ç»­è®¤è¯å¤±è´¥é”å®šç­–ç•¥è®¾ç½®ä¸å®Œå…¨ï¼Œä¸ç¬¦åˆæ ‡å‡† \\033[0m\u0026#34; fi else echo -e \u0026#34;\\033[31;40m ç”¨æˆ·ç™»é™†è¿ç»­è®¤è¯å¤±è´¥é”å®šç­–ç•¥è®¾ç½®ä¸æ­£ç¡®ï¼Œä¸ç¬¦åˆæ ‡å‡† \\033[0m\u0026#34; sed -i \u0026#39;/auth required pam_env.so/i auth required pam_faillock.so preauth audit silent deny=5 unlock_time=900\u0026#39; /etc/pam.d/system-auth sed -i \u0026#39;/auth required pam_deny.so/a auth [default=die] pam_faillock.so authfail audit deny=5 unlock_time=900\u0026#39; /etc/pam.d/system-auth sed -i \u0026#39;/account required pam_unix.so/i account required pam_faillock.so\u0026#39; /etc/pam.d/system-auth sed -i \u0026#39;/auth required pam_env.so/i auth required pam_faillock.so preauth audit silent deny=5 unlock_time=900\u0026#39; /etc/pam.d/password-auth sed -i \u0026#39;/auth required pam_deny.so/a auth [default=die] pam_faillock.so authfail audit deny=5 unlock_time=900\u0026#39; /etc/pam.d/password-auth sed -i \u0026#39;/account required pam_unix.so/i account required pam_faillock.so\u0026#39; /etc/pam.d/password-auth fi } è´¦å·å¯†ç è¿‡æœŸè®¾ç½® è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼Œå¯ä»¥æ¯å¤©è‡ªå·±æ‰§è¡Œåˆ¤æ–­ï¼Œå¦‚æœå¿«åˆ°æœŸä¼šå‘é‚®ä»¶å‘Šè­¦ï¼ŒåŠæ—¶ä¿®æ”¹ï¼Œé˜²æ­¢è¿‡æœŸå¯¼è‡´crontabä»»åŠ¡ä¸å¯ä½¿ç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 #!/bin/bash #å®šä¹‰æ—¶é—´å˜é‡ï¼Œç”¨äºå‘Šè­¦å‘é€ check_time=`date +\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;` #æ—¥å¿—ä½ç½® log=${HOME}/user-info.log user_name=`whoami` end_year=` chage -l ${user_name} | head -2| tail -1 | awk -F: \u0026#39;{print $2}\u0026#39;| awk -F\u0026#39;,\u0026#39; \u0026#39;{print $2}\u0026#39;| awk \u0026#39;{print $1}\u0026#39;` if [ \u0026#34;${end_year}\u0026#34; == \u0026#34;\u0026#34; ];then echo \u0026#34;99999\u0026#34; exit 0 fi end_mounth=`chage -l ${user_name} | head -2| tail -1 | awk -F: \u0026#39;{print $2}\u0026#39;| awk -F\u0026#39;,\u0026#39; \u0026#39;{print $1}\u0026#39;| awk \u0026#39;{print $1}\u0026#39;` case ${end_mounth} in \u0026#39;Jan\u0026#39;) end_mounth=1;; \u0026#39;Feb\u0026#39;) end_mounth=2;; \u0026#39;Mar\u0026#39;) end_mounth=3;; \u0026#39;Apr\u0026#39;) end_mounth=4;; \u0026#39;May\u0026#39;) end_mounth=5;; \u0026#39;Jun\u0026#39;) end_mounth=6;; \u0026#39;Jul\u0026#39;) end_mounth=7;; \u0026#39;Aug\u0026#39;) end_mounth=8;; \u0026#39;Sep\u0026#39;) end_mounth=9;; \u0026#39;Oct\u0026#39;) end_mounth=10;; \u0026#39;Nov\u0026#39;) end_mounth=11;; \u0026#39;Dec\u0026#39;) end_mounth=12;; esac end_day=`chage -l ${user_name} | head -2| tail -1 | awk -F: \u0026#39;{print $2}\u0026#39;| awk -F\u0026#39;,\u0026#39; \u0026#39;{print $1}\u0026#39;| awk \u0026#39;{print $2}\u0026#39;` end_date_s=`/bin/date -d \u0026#34;${end_year}\u0026#34;-\u0026#34;${end_mounth}\u0026#34;-\u0026#34;${end_day}\u0026#34; +%s` star_date_s=`/bin/date +%s` let diffday=(${end_date_s}-${star_date_s})/86400 echo ${diffday} #è¿‡æœŸæ—¶é—´åˆ¤æ–­ï¼Œå¦‚æœå°äº15å¤©ï¼Œå¼€å§‹å‘é‚®ä»¶ if [ ${diffday} -gt 15 ] then curl http://mail.ownit.top/send -H \u0026#34;Content-Type:application/json\u0026#34; -X POST -d \u0026#39;{\u0026#34;source\u0026#34; : \u0026#34;game\u0026#34;,\u0026#34;contacts\u0026#34; : [\u0026#34;1794748404@qq.com\u0026#34;],\u0026#34;subject\u0026#34; : \u0026#34;\u0026#39;\u0026#34; ${user_name} è´¦å·è¿‡æœŸè­¦å‘Š\u0026#34;\u0026#39;\u0026#34;,\u0026#34;content\u0026#34; : \u0026#34;\u0026#39;\u0026#34; ${user_name} è´¦å·è¿‡æœŸè­¦å‘Š \u0026lt;br\u0026gt; ${user_name} å³å°†åœ¨ ${diffday} åè¿‡æœŸï¼Œè¯·åŠæ—¶ä¿®æ”¹ \u0026lt;br\u0026gt; æ³¨æ„: è´¦å·å¯†ç è¿‡æœŸå,ç”¨æˆ·çš„Crontabä¸­çš„æ‰§è¡Œä»»åŠ¡ä¼šå¤±æ•ˆ \u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026#34;\u0026#39;\u0026#34;}\u0026#39; echo \u0026#34; time: $check_time è´¦å· ${user_name} å³å°† åœ¨ ${diffday} å¤©å å¯†ç è¿‡æœŸ \u0026#34; \u0026gt;\u0026gt; ${log} else echo \u0026#34; time: $check_time è´¦å· ${user_name} è¿˜æœ‰ ${diffday} å¤©ä½¿ç”¨æœŸ \u0026#34; \u0026gt;\u0026gt; ${log} fi ","date":"2021-12-23T15:39:37Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/202112231539/","title":"Linuxæ“ä½œç³»ç»Ÿè´¦å·å¯†ç å¤±æ•ˆæ£€æµ‹"},{"content":"GOçš„WEBç¼–ç¨‹ï¼ˆGINå®ç°é‚®ä»¶æ¥å£æŠ¥è­¦ï¼‰ Ginç¼–å†™é‚®ä»¶æ¥å£ï¼ˆæ”¯æŒå¤šäººå‘é€ï¼‰ è¿™ä¸ªä»£ç åŸºäºä¸Šé¢ä¸¤ä¸ªå·²ç»å®Œæˆçš„åŠŸèƒ½ä¸Šå®ç°ã€‚\nå®ç°ä¸‹é¢åŠŸèƒ½\næ—¥å¿—åˆ†å‰²\næ—¥å¿—è®°å½•\næ•ˆæœå›¾\nå› ä¸ºæ—¥å¸¸èŒƒå›´ï¼Œæˆ‘ä»¬åœ¨æ“ä½œç³»ç»Ÿä¸Šï¼Œéœ€è¦æŠ¥è­¦æ—¶ï¼Œåªèƒ½é‡‡ç”¨mailxæ¥ä½¿ç”¨ã€‚éœ€è¦é…ç½®è´¦å·ï¼Œå¯†ç ï¼Œå’Œé‚®ç®±è®¤è¯ã€‚å¦‚æœéœ€è¦å¤šå°ä½¿ç”¨çš„è¯ï¼Œå²‚ä¸æ˜¯å¾ˆéº»çƒ¦ï¼Œè¦é…ç½®å¤šå°ï¼Œè¿™ä¸ªå¯¼è‡´å¯†ç å¾ˆä¸å®‰å…¨ï¼Œå®¹æ˜“æ³„éœ²ã€‚æ‰€ä»¥ï¼Œä¸ºäº†å®‰å…¨ï¼Œæœ‰æ•ˆï¼Œæ›´æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨æ¥å£å‘é€é‚®ä»¶ã€‚\nï¼ˆ1ï¼‰æ„å»ºæ¥å£\nï¼ˆ2ï¼‰ä¼ å…¥postçš„jsonæƒ…å†µ\nï¼ˆ3ï¼‰æŠŠç›¸åº”jsonè½¬æ¢å­—ç¬¦\nï¼ˆ4ï¼‰å‘é€é‚®ä»¶\nä»£ç æ”¾åœ¨ä¸€ä¸ªmainã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;net/smtp\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;github.com/natefinch/lumberjack\u0026#34; \u0026#34;go.uber.org/zap\u0026#34; \u0026#34;go.uber.org/zap/zapcore\u0026#34; ) /* æ”¯æŒå¤šäººå‘é€ curl http://10.10.10.3:7070/send -H \u0026#34;Content-Type:application/json\u0026#34; -X POST -d \u0026#39;{\u0026#34;source\u0026#34;:\u0026#34;heian\u0026#34;,\u0026#34;contacts\u0026#34;:[\u0026#34;è´¦å·@qq.com\u0026#34;,\u0026#34;è´¦å·@qq.com\u0026#34;],\u0026#34;subject\u0026#34;:\u0026#34;å¤šäººæµ‹è¯•\u0026#34;,\u0026#34;content\u0026#34;:\u0026#34;ç°åœ¨è¿›è¡Œå¤šäººæµ‹è¯•\u0026#34;}\u0026#39; */ /* zapcore.Coreéœ€è¦ä¸‰ä¸ªé…ç½®â€”â€”Encoderï¼ŒWriteSyncerï¼ŒLogLevel Encoder:ç¼–ç å™¨(å¦‚ä½•å†™å…¥æ—¥å¿—)ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å¼€ç®±å³ç”¨çš„NewJSONEncoder() WriterSyncer ï¼šæŒ‡å®šæ—¥å¿—å°†å†™åˆ°å“ªé‡Œå»ã€‚æˆ‘ä»¬ä½¿ç”¨zapcore.AddSync() Log Levelï¼šå“ªç§çº§åˆ«çš„æ—¥å¿—å°†è¢«å†™å…¥ã€‚ */ var sugarLogger *zap.SugaredLogger func InitLogger() { writeSyncer := getLogWriter() encoder := getEncoder() core := zapcore.NewCore(encoder, writeSyncer, zapcore.DebugLevel) logger := zap.New(core, zap.AddCaller()) sugarLogger = logger.Sugar() } func getEncoder() zapcore.Encoder { encoderConfig := zap.NewProductionEncoderConfig() encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder return zapcore.NewConsoleEncoder(encoderConfig) } func getLogWriter() zapcore.WriteSyncer { /* Lumberjack Loggeré‡‡ç”¨ä»¥ä¸‹å±æ€§ä½œä¸ºè¾“å…¥: Filename: æ—¥å¿—æ–‡ä»¶çš„ä½ç½® MaxSizeï¼šåœ¨è¿›è¡Œåˆ‡å‰²ä¹‹å‰ï¼Œæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°ï¼ˆä»¥MBä¸ºå•ä½ï¼‰ MaxBackupsï¼šä¿ç•™æ—§æ–‡ä»¶çš„æœ€å¤§ä¸ªæ•° MaxAgesï¼šä¿ç•™æ—§æ–‡ä»¶çš„æœ€å¤§å¤©æ•° Compressï¼šæ˜¯å¦å‹ç¼©/å½’æ¡£æ—§æ–‡ä»¶ */ lumberJackLogger := \u0026amp;lumberjack.Logger{ Filename: \u0026#34;./logs/info.log\u0026#34;, MaxSize: 10, MaxBackups: 5, MaxAge: 30, Compress: false, } return zapcore.AddSync(lumberJackLogger) } // å®šä¹‰æ¥æ”¶æ•°æ®çš„ç»“æ„ä½“ type User struct { // binding:\u0026#34;required\u0026#34;ä¿®é¥°çš„å­—æ®µï¼Œè‹¥æ¥æ”¶ä¸ºç©ºå€¼ï¼Œåˆ™æŠ¥é”™ï¼Œæ˜¯å¿…é¡»å­—æ®µ Source string `form:\u0026#34;source\u0026#34; json:\u0026#34;source\u0026#34; uri:\u0026#34;source\u0026#34; xml:\u0026#34;source\u0026#34; binding:\u0026#34;required\u0026#34;` Contacts []string `form:\u0026#34;contacts\u0026#34; json:\u0026#34;contacts\u0026#34; uri:\u0026#34;contacts\u0026#34; xml:\u0026#34;contacts\u0026#34; binding:\u0026#34;required\u0026#34;` Subject string `form:\u0026#34;subject\u0026#34; json:\u0026#34;subject\u0026#34; uri:\u0026#34;subject\u0026#34; xml:\u0026#34;subject\u0026#34; binding:\u0026#34;required\u0026#34;` Content string `form:\u0026#34;content\u0026#34; json:\u0026#34;content\u0026#34; uri:\u0026#34;content\u0026#34; xml:\u0026#34;content\u0026#34; binding:\u0026#34;required\u0026#34;` } func SendToMail(user, sendUserName, password, host, to, subject, body, mailtype string) error { hp := strings.Split(host, \u0026#34;:\u0026#34;) //fmt.Println(hp) auth := smtp.PlainAuth(\u0026#34;\u0026#34;, user, password, hp[0]) var content_type string if mailtype == \u0026#34;html\u0026#34; { content_type = \u0026#34;Content-Type: text/\u0026#34; + mailtype + \u0026#34;; charset=UTF-8\u0026#34; } else { content_type = \u0026#34;Content-Type: text/plain\u0026#34; + \u0026#34;; charset=UTF-8\u0026#34; } msg := []byte(\u0026#34;To: \u0026#34; + to + \u0026#34;\\r\\nFrom: \u0026#34; + sendUserName + \u0026#34;\u0026lt;\u0026#34; + user + \u0026#34;\u0026gt;\u0026#34; + \u0026#34;\\r\\nSubject: \u0026#34; + subject + \u0026#34;\\r\\n\u0026#34; + content_type + \u0026#34;\\r\\n\\r\\n\u0026#34; + body) send_to := strings.Split(to, \u0026#34;;\u0026#34;) err := smtp.SendMail(host, auth, user, send_to, msg) //fmt.Println(err) return err } //è·å–ip func GetRequestIP(c *gin.Context) string { reqIP := c.ClientIP() if reqIP == \u0026#34;::1\u0026#34; { reqIP = \u0026#34;127.0.0.1\u0026#34; } return reqIP } func PostMail(c *gin.Context) { c_ip := GetRequestIP(c) //fmt.Println(c_ip) sugarLogger.Debugf(\u0026#34;è°ƒç”¨ PostMail æ¥å£Apiï¼Œè°ƒç”¨è€…IPï¼š %s \u0026#34;, c_ip) å£°æ˜æ¥æ”¶çš„å˜é‡ var json User å°†requestçš„bodyä¸­çš„æ•°æ®ï¼Œè‡ªåŠ¨æŒ‰ç…§jsonæ ¼å¼è§£æåˆ°ç»“æ„ä½“ // if err := c.ShouldBindJSON(\u0026amp;json); err != nil { //\t// è¿”å›é”™è¯¯ä¿¡æ¯ //\t// gin.Hå°è£…äº†ç”Ÿæˆjsonæ•°æ®çš„å·¥å…· c.JSON(http.StatusBadRequest, gin.H{\u0026#34;error\u0026#34;: err.Error()}) sugarLogger.Errorf(\u0026#34;Error: %s\u0026#34;, err.Error()) return } //fmt.Println(json.Content, json.Contacts) //c.JSON(http.StatusOK, gin.H{\u0026#34;status\u0026#34;: \u0026amp;json}) sugarLogger.Infof(\u0026#34;info: %s\u0026#34;, json) user := \u0026#34;è´¦å·@qq.com\u0026#34; password := \u0026#34;å¯†ç \u0026#34; host := \u0026#34;smtp.qq.com:25\u0026#34; source := json.Source if source != \u0026#34;heian\u0026#34; { fmt.Println(\u0026#34;Send mail error!,source è®¤è¯å¤±è´¥\u0026#34;) sugarLogger.Errorf(\u0026#34;Send mail error!,source è®¤è¯å¤±è´¥\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,source è®¤è¯å¤±è´¥\u0026#34;, }) return } //println(json.Contacts) to := json.Contacts if to[0] == \u0026#34;\u0026#34; { fmt.Println(\u0026#34;Send mail error!,å‘é€äººä¸ºç©º\u0026#34;) sugarLogger.Errorf(\u0026#34;Send mail error!,å‘é€äººä¸ºç©º\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,å‘é€äººä¸ºç©º\u0026#34;, }) return } subject := json.Subject if strings.TrimSpace(subject) == \u0026#34;\u0026#34; { fmt.Println(\u0026#34;Send mail error!æ ‡é¢˜ä¸ºç©º\u0026#34;) sugarLogger.Errorf(\u0026#34;Send mail error!æ ‡é¢˜ä¸ºç©º\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,æ ‡é¢˜ä¸ºç©º\u0026#34;, }) return } body := ` \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;iso-8859-15\u0026#34;\u0026gt; \u0026lt;title\u0026gt;MMOGA POWER\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; ` + fmt.Sprintf(json.Content) + `\u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt;` sendUserName := \u0026#34;å‘Šè­¦å¹³å°\u0026#34; //å‘é€é‚®ä»¶çš„äººåç§° fmt.Println(\u0026#34;send email\u0026#34;) for _, s := range to { //fmt.Println(i, s) err := SendToMail(user, sendUserName, password, host, s, subject, body, \u0026#34;html\u0026#34;) //log.Printf(\u0026#34;æ¥æ”¶äººï¼š\u0026#34;, s+\u0026#34;\\n\u0026#34;+\u0026#34;æ ‡é¢˜:\u0026#34;, json.Subject+\u0026#34;\\n\u0026#34;, \u0026#34;å‘é€å†…å®¹ï¼š\u0026#34;, json.Content+\u0026#34;\\n\u0026#34;) fmt.Printf(\u0026#34;æ¥æ”¶äºº:%s \\n æ ‡é¢˜: %s \\n å†…å®¹: %s \\n\u0026#34;, s, json.Subject, json.Content) sugarLogger.Infof(\u0026#34;æ¥æ”¶äºº: %s ,æ ‡é¢˜: %s, å†…å®¹: %s\u0026#34;, s, json.Subject, json.Content) if err != nil { fmt.Println(\u0026#34;Send mail error!\\n\u0026#34;) sugarLogger.Errorf(\u0026#34;Error è°ƒç”¨è€…IP: %s ,Send mail error! !\u0026#34;, c_ip) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error! !\\n\u0026#34;, }) //fmt.Println(err) } else { fmt.Println(\u0026#34;Send mail success!\\n\u0026#34;) sugarLogger.Infof(\u0026#34;success è°ƒç”¨è€…IP: %s ,Send mail success! !\u0026#34;, c_ip) c.JSON(http.StatusOK, gin.H{ \u0026#34;success\u0026#34;: \u0026#34;Send mail success! !\\n\u0026#34;, }) } } } func main() { // 1.åˆ›å»ºè·¯ç”± // é»˜è®¤ä½¿ç”¨äº†2ä¸ªä¸­é—´ä»¶Logger(), Recovery() InitLogger() defer sugarLogger.Sync() r := gin.Default() // JSONç»‘å®š r.POST(\u0026#34;send\u0026#34;, PostMail) sugarLogger.Infof(\u0026#34;Success! Port is start\u0026#34;) r.Run(\u0026#34;:7070\u0026#34;) } ","date":"2021-12-17T18:31:58Z","image":"https://www.ownit.top/title_pic/74.jpg","permalink":"https://www.ownit.top/p/202112171831/","title":"Ginç¼–å†™é‚®ä»¶å‘Šè­¦æ¥å£ï¼ˆæ·»åŠ ä¼˜åŒ–æ—¥å¿—è®°å½•ï¼‰"},{"content":"GOçš„WEBç¼–ç¨‹ï¼ˆGINå®ç°é‚®ä»¶æ¥å£æŠ¥è­¦ï¼‰ ä¸Šé¢å§åŸºæœ¬åŠŸèƒ½å®ç°ï¼Œä½†æ˜¯ä¸æ”¯æŒå¤šäººå‘é€ã€‚\nä¸‹é¢åšä¸ªå°æ”¹åŠ¨ï¼Œæ”¯æŒå¤šäººå‘é€\nå› ä¸ºæ—¥å¸¸èŒƒå›´ï¼Œæˆ‘ä»¬åœ¨æ“ä½œç³»ç»Ÿä¸Šï¼Œéœ€è¦æŠ¥è­¦æ—¶ï¼Œåªèƒ½é‡‡ç”¨mailxæ¥ä½¿ç”¨ã€‚éœ€è¦é…ç½®è´¦å·ï¼Œå¯†ç ï¼Œå’Œé‚®ç®±è®¤è¯ã€‚å¦‚æœéœ€è¦å¤šå°ä½¿ç”¨çš„è¯ï¼Œå²‚ä¸æ˜¯å¾ˆéº»çƒ¦ï¼Œè¦é…ç½®å¤šå°ï¼Œè¿™ä¸ªå¯¼è‡´å¯†ç å¾ˆä¸å®‰å…¨ï¼Œå®¹æ˜“æ³„éœ²ã€‚æ‰€ä»¥ï¼Œä¸ºäº†å®‰å…¨ï¼Œæœ‰æ•ˆï¼Œæ›´æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨æ¥å£å‘é€é‚®ä»¶ã€‚\nï¼ˆ1ï¼‰æ„å»ºæ¥å£\nï¼ˆ2ï¼‰ä¼ å…¥postçš„jsonæƒ…å†µ\nï¼ˆ3ï¼‰æŠŠç›¸åº”jsonè½¬æ¢å­—ç¬¦\nï¼ˆ4ï¼‰å‘é€é‚®ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;net/smtp\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; ) /* æ”¯æŒå¤šäººå‘é€ curl http://10.10.10.3:7070/send -H \u0026#34;Content-Type:application/json\u0026#34; -X POST -d \u0026#39;{\u0026#34;source\u0026#34;:\u0026#34;heian\u0026#34;,\u0026#34;contacts\u0026#34;:[\u0026#34;è´¦å·@qq.com\u0026#34;,\u0026#34;è´¦å·@qq.com\u0026#34;],\u0026#34;subject\u0026#34;:\u0026#34;å¤šäººæµ‹è¯•\u0026#34;,\u0026#34;content\u0026#34;:\u0026#34;ç°åœ¨è¿›è¡Œå¤šäººæµ‹è¯•\u0026#34;}\u0026#39; */ // å®šä¹‰æ¥æ”¶æ•°æ®çš„ç»“æ„ä½“ type User struct { // binding:\u0026#34;required\u0026#34;ä¿®é¥°çš„å­—æ®µï¼Œè‹¥æ¥æ”¶ä¸ºç©ºå€¼ï¼Œåˆ™æŠ¥é”™ï¼Œæ˜¯å¿…é¡»å­—æ®µ Source string `form:\u0026#34;source\u0026#34; json:\u0026#34;source\u0026#34; uri:\u0026#34;source\u0026#34; xml:\u0026#34;source\u0026#34; binding:\u0026#34;required\u0026#34;` Contacts []string `form:\u0026#34;contacts\u0026#34; json:\u0026#34;contacts\u0026#34; uri:\u0026#34;contacts\u0026#34; xml:\u0026#34;contacts\u0026#34; binding:\u0026#34;required\u0026#34;` Subject string `form:\u0026#34;subject\u0026#34; json:\u0026#34;subject\u0026#34; uri:\u0026#34;subject\u0026#34; xml:\u0026#34;subject\u0026#34; binding:\u0026#34;required\u0026#34;` Content string `form:\u0026#34;content\u0026#34; json:\u0026#34;content\u0026#34; uri:\u0026#34;content\u0026#34; xml:\u0026#34;content\u0026#34; binding:\u0026#34;required\u0026#34;` } func SendToMail(user, sendUserName, password, host, to, subject, body, mailtype string) error { hp := strings.Split(host, \u0026#34;:\u0026#34;) //fmt.Println(hp) auth := smtp.PlainAuth(\u0026#34;\u0026#34;, user, password, hp[0]) var content_type string if mailtype == \u0026#34;html\u0026#34; { content_type = \u0026#34;Content-Type: text/\u0026#34; + mailtype + \u0026#34;; charset=UTF-8\u0026#34; } else { content_type = \u0026#34;Content-Type: text/plain\u0026#34; + \u0026#34;; charset=UTF-8\u0026#34; } msg := []byte(\u0026#34;To: \u0026#34; + to + \u0026#34;\\r\\nFrom: \u0026#34; + sendUserName + \u0026#34;\u0026lt;\u0026#34; + user + \u0026#34;\u0026gt;\u0026#34; + \u0026#34;\\r\\nSubject: \u0026#34; + subject + \u0026#34;\\r\\n\u0026#34; + content_type + \u0026#34;\\r\\n\\r\\n\u0026#34; + body) send_to := strings.Split(to, \u0026#34;;\u0026#34;) err := smtp.SendMail(host, auth, user, send_to, msg) //fmt.Println(err) return err } func PostMail(c *gin.Context) { å£°æ˜æ¥æ”¶çš„å˜é‡ var json User å°†requestçš„bodyä¸­çš„æ•°æ®ï¼Œè‡ªåŠ¨æŒ‰ç…§jsonæ ¼å¼è§£æåˆ°ç»“æ„ä½“ // if err := c.ShouldBindJSON(\u0026amp;json); err != nil { //\t// è¿”å›é”™è¯¯ä¿¡æ¯ //\t// gin.Hå°è£…äº†ç”Ÿæˆjsonæ•°æ®çš„å·¥å…· c.JSON(http.StatusBadRequest, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } //fmt.Println(json.Content, json.Contacts) //c.JSON(http.StatusOK, gin.H{\u0026#34;status\u0026#34;: \u0026amp;json}) user := \u0026#34;è´¦å·@qq.com\u0026#34; password := \u0026#34;å¯†ç \u0026#34; host := \u0026#34;smtp.qq.com:25\u0026#34; source := json.Source if source != \u0026#34;heian\u0026#34; { fmt.Println(\u0026#34;Send mail error!,source è®¤è¯å¤±è´¥\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,source è®¤è¯å¤±è´¥\u0026#34;, }) return } //println(json.Contacts) to := json.Contacts if to[0] == \u0026#34;\u0026#34; { fmt.Println(\u0026#34;Send mail error!,å‘é€äººä¸ºç©º\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,å‘é€äººä¸ºç©º\u0026#34;, }) return } subject := json.Subject if strings.TrimSpace(subject) == \u0026#34;\u0026#34; { fmt.Println(\u0026#34;Send mail error!æ ‡é¢˜ä¸ºç©º\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,æ ‡é¢˜ä¸ºç©º\u0026#34;, }) return } body := ` \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;iso-8859-15\u0026#34;\u0026gt; \u0026lt;title\u0026gt;MMOGA POWER\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; ` + fmt.Sprintf(json.Content) + `\u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt;` sendUserName := \u0026#34;å‘Šè­¦å¹³å°\u0026#34; //å‘é€é‚®ä»¶çš„äººåç§° fmt.Println(\u0026#34;send email\u0026#34;) for _, s := range to { //fmt.Println(i, s) err := SendToMail(user, sendUserName, password, host, s, subject, body, \u0026#34;html\u0026#34;) //log.Printf(\u0026#34;æ¥æ”¶äººï¼š\u0026#34;, s+\u0026#34;\\n\u0026#34;+\u0026#34;æ ‡é¢˜:\u0026#34;, json.Subject+\u0026#34;\\n\u0026#34;, \u0026#34;å‘é€å†…å®¹ï¼š\u0026#34;, json.Content+\u0026#34;\\n\u0026#34;) fmt.Printf(\u0026#34;æ¥æ”¶äºº:%s \\n æ ‡é¢˜: %s \\n å†…å®¹: %s \\n\u0026#34;, s, json.Subject, json.Content) if err != nil { fmt.Println(\u0026#34;Send mail error!\\n\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error! !\\n\u0026#34;, }) //fmt.Println(err) } else { fmt.Println(\u0026#34;Send mail success!\\n\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;success\u0026#34;: \u0026#34;Send mail success! !\\n\u0026#34;, }) } } } func main() { // 1.åˆ›å»ºè·¯ç”± // é»˜è®¤ä½¿ç”¨äº†2ä¸ªä¸­é—´ä»¶Logger(), Recovery() r := gin.Default() // JSONç»‘å®š r.POST(\u0026#34;send\u0026#34;, PostMail) r.Run(\u0026#34;:7070\u0026#34;) } ","date":"2021-12-13T19:36:02Z","image":"https://www.ownit.top/title_pic/32.jpg","permalink":"https://www.ownit.top/p/202112131936/","title":"Ginç¼–å†™é‚®ä»¶æ¥å£ï¼ˆæ”¯æŒå¤šäººå‘é€ï¼‰"},{"content":"ä¸ºä»€ä¹ˆè¦å†™è¿™ä¸ªé‚®ä»¶å‘Šè­¦æ¥å£ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ\nå› ä¸ºæ—¥å¸¸èŒƒå›´ï¼Œæˆ‘ä»¬åœ¨æ“ä½œç³»ç»Ÿä¸Šï¼Œéœ€è¦æŠ¥è­¦æ—¶ï¼Œåªèƒ½é‡‡ç”¨mailxæ¥ä½¿ç”¨ã€‚éœ€è¦é…ç½®è´¦å·ï¼Œå¯†ç ï¼Œå’Œé‚®ç®±è®¤è¯ã€‚å¦‚æœéœ€è¦å¤šå°ä½¿ç”¨çš„è¯ï¼Œå²‚ä¸æ˜¯å¾ˆéº»çƒ¦ï¼Œè¦é…ç½®å¤šå°ï¼Œè¿™ä¸ªå¯¼è‡´å¯†ç å¾ˆä¸å®‰å…¨ï¼Œå®¹æ˜“æ³„éœ²ã€‚æ‰€ä»¥ï¼Œä¸ºäº†å®‰å…¨ï¼Œæœ‰æ•ˆï¼Œæ›´æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨æ¥å£å‘é€é‚®ä»¶ã€‚\nï¼ˆ1ï¼‰æ„å»ºæ¥å£\nï¼ˆ2ï¼‰ä¼ å…¥postçš„jsonæƒ…å†µ\nï¼ˆ3ï¼‰æŠŠç›¸åº”jsonè½¬æ¢å­—ç¬¦\nï¼ˆ4ï¼‰å‘é€é‚®ä»¶\n**Â è°ƒç”¨æ–¹å¼ï¼ˆå·²åšè„±æ•ï¼‰**\n1 curl http://mawnit.top/send -H \u0026#34;Content-Type:application/json\u0026#34; -X POST -d \u0026#39;{\u0026#34;source\u0026#34;:\u0026#34;heiassns\u0026#34;,\u0026#34;contacts\u0026#34;:\u0026#34;17947@qq.com\u0026#34;,\u0026#34;subject\u0026#34;:\u0026#34;geian\u0026#34;,\u0026#34;content\u0026#34;:\u0026#34;ç²¾ç¡®å—,æˆ‘å¾ˆå¥½\u0026#34;} \u0026#39; ä»£ç å¾ˆç®€å•ï¼Œå®ç°åŸºæœ¬åŠŸèƒ½\nè‡ªå®šä¹‰æ ‡é¢˜ï¼Œå†…å®¹ï¼Œå‘é€äººï¼ˆåªæ”¯æŒå•ä¸ªï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;net/smtp\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; ) // å®šä¹‰æ¥æ”¶æ•°æ®çš„ç»“æ„ä½“ type User struct { // binding:\u0026#34;required\u0026#34;ä¿®é¥°çš„å­—æ®µï¼Œè‹¥æ¥æ”¶ä¸ºç©ºå€¼ï¼Œåˆ™æŠ¥é”™ï¼Œæ˜¯å¿…é¡»å­—æ®µ Source string `form:\u0026#34;source\u0026#34; json:\u0026#34;source\u0026#34; uri:\u0026#34;source\u0026#34; xml:\u0026#34;source\u0026#34; binding:\u0026#34;required\u0026#34;` Contacts string `form:\u0026#34;contacts\u0026#34; json:\u0026#34;contacts\u0026#34; uri:\u0026#34;contacts\u0026#34; xml:\u0026#34;contacts\u0026#34; binding:\u0026#34;required\u0026#34;` Subject string `form:\u0026#34;subject\u0026#34; json:\u0026#34;subject\u0026#34; uri:\u0026#34;subject\u0026#34; xml:\u0026#34;subject\u0026#34; binding:\u0026#34;required\u0026#34;` Content string `form:\u0026#34;content\u0026#34; json:\u0026#34;content\u0026#34; uri:\u0026#34;content\u0026#34; xml:\u0026#34;content\u0026#34; binding:\u0026#34;required\u0026#34;` } func SendToMail(user, sendUserName, password, host, to, subject, body, mailtype string) error { hp := strings.Split(host, \u0026#34;:\u0026#34;) fmt.Println(hp) auth := smtp.PlainAuth(\u0026#34;\u0026#34;, user, password, hp[0]) var content_type string if mailtype == \u0026#34;html\u0026#34; { content_type = \u0026#34;Content-Type: text/\u0026#34; + mailtype + \u0026#34;; charset=UTF-8\u0026#34; } else { content_type = \u0026#34;Content-Type: text/plain\u0026#34; + \u0026#34;; charset=UTF-8\u0026#34; } msg := []byte(\u0026#34;To: \u0026#34; + to + \u0026#34;\\r\\nFrom: \u0026#34; + sendUserName + \u0026#34;\u0026lt;\u0026#34; + user + \u0026#34;\u0026gt;\u0026#34; + \u0026#34;\\r\\nSubject: \u0026#34; + subject + \u0026#34;\\r\\n\u0026#34; + content_type + \u0026#34;\\r\\n\\r\\n\u0026#34; + body) send_to := strings.Split(to, \u0026#34;;\u0026#34;) err := smtp.SendMail(host, auth, user, send_to, msg) fmt.Println(err) return err } func main() { // 1.åˆ›å»ºè·¯ç”± // é»˜è®¤ä½¿ç”¨äº†2ä¸ªä¸­é—´ä»¶Logger(), Recovery() r := gin.Default() // JSONç»‘å®š r.POST(\u0026#34;send\u0026#34;, func(c *gin.Context) { å£°æ˜æ¥æ”¶çš„å˜é‡ var json User å°†requestçš„bodyä¸­çš„æ•°æ®ï¼Œè‡ªåŠ¨æŒ‰ç…§jsonæ ¼å¼è§£æåˆ°ç»“æ„ä½“ // if err := c.ShouldBindJSON(\u0026amp;json); err != nil { //\t// è¿”å›é”™è¯¯ä¿¡æ¯ //\t// gin.Hå°è£…äº†ç”Ÿæˆjsonæ•°æ®çš„å·¥å…· c.JSON(http.StatusBadRequest, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } //fmt.Println(json.Content, json.Contacts) //c.JSON(http.StatusOK, gin.H{\u0026#34;status\u0026#34;: \u0026amp;json}) user := \u0026#34;å‘ä»¶äººé‚®ç®±\u0026#34; password := \u0026#34;å¯†ç \u0026#34; host := \u0026#34;smtp.qq.com:25\u0026#34; source := json.Source if source != \u0026#34;heian\u0026#34; { fmt.Println(\u0026#34;Send mail error!,source è®¤è¯å¤±è´¥\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,source è®¤è¯å¤±è´¥\u0026#34;, }) return } to := json.Contacts if strings.TrimSpace(to) == \u0026#34;\u0026#34; { fmt.Println(\u0026#34;Send mail error!,å‘é€äººä¸ºç©º\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,å‘é€äººä¸ºç©º\u0026#34;, }) return } subject := json.Subject if strings.TrimSpace(subject) == \u0026#34;\u0026#34; { fmt.Println(\u0026#34;Send mail error!æ ‡é¢˜ä¸ºç©º\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error!,æ ‡é¢˜ä¸ºç©º\u0026#34;, }) return } body := ` \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;iso-8859-15\u0026#34;\u0026gt; \u0026lt;title\u0026gt;MMOGA POWER\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; ` + fmt.Sprintf(json.Content) + `\u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt;` //log.Printf(\u0026#34;æ¥æ”¶äººï¼š\u0026#34;, json.Contacts+\u0026#34;\\n\u0026#34;+\u0026#34;æ ‡é¢˜:\u0026#34;, json.Subject+\u0026#34;\\n\u0026#34;, \u0026#34;å‘é€å†…å®¹ï¼š\u0026#34;, json.Content+\u0026#34;\\n\u0026#34;) fmt.Printf(\u0026#34;æ¥æ”¶äºº:%s \\n æ ‡é¢˜: %s \\n å†…å®¹: %s \\n\u0026#34;, json.Contacts, json.Subject, json.Content) sendUserName := \u0026#34;å‘Šè­¦å¹³å°\u0026#34; //å‘é€é‚®ä»¶çš„äººåç§° fmt.Println(\u0026#34;send email\u0026#34;) err := SendToMail(user, sendUserName, password, host, to, subject, body, \u0026#34;html\u0026#34;) if err != nil { fmt.Println(\u0026#34;Send mail error!\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;Send mail error! !\u0026#34;, }) //fmt.Println(err) } else { fmt.Println(\u0026#34;Send mail success!\u0026#34;) c.JSON(http.StatusOK, gin.H{ \u0026#34;success\u0026#34;: \u0026#34;Send mail success! !\u0026#34;, }) } }) r.Run(\u0026#34;:7070\u0026#34;) } åç»­æ…¢æ…¢æ”¹è¿›ï¼ŒæŠŠç›¸åº”çš„å‘é€ä¿¡æ¯ï¼Œä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œæ”¯æŒå¤šäººå‘é€ï¼Œæ”¯æŒæ–‡ä»¶å‘é€ï¼Œç­‰ç­‰\n","date":"2021-12-10T11:12:36Z","image":"https://www.ownit.top/title_pic/59.jpg","permalink":"https://www.ownit.top/p/202112101112/","title":"GOçš„WEBç¼–ç¨‹ï¼ˆGINå®ç°é‚®ä»¶æ¥å£æŠ¥è­¦ï¼‰"},{"content":"\nTCPæ‰«æå¢å¼ºå™¨ TCPæ‰«æå¢å¼ºå™¨å®ç°åŸç†ï¼Œä¸»è¦æ˜¯ä½¿ç”¨TCPä¸‰æ¬¡æ¡æ‰‹åŸç†\nTCPæ˜¯æ¯”æˆ‘ä»¬ä»‹ç»çš„è¦å¤æ‚çš„å¤šï¼Œä½†æ˜¯æˆ‘ä»¬åªä»‹ç»ä¸€ç‚¹åŸºç¡€çŸ¥è¯†ã€‚TCPçš„æ¡æ‰‹æœ‰ä¸‰ä¸ªè¿‡ç¨‹ã€‚\né¦–å…ˆï¼Œå®¢æˆ·ç«¯å‘é€ä¸€ä¸ª syn çš„åŒ…ï¼Œè¡¨ç¤ºå»ºç«‹å›è¯çš„å¼€å§‹ã€‚å¦‚æœå®¢æˆ·ç«¯æ”¶åˆ°è¶…æ—¶ï¼Œè¯´æ˜ç«¯å£å¯èƒ½åœ¨é˜²ç«å¢™åé¢ï¼Œæˆ–è€…æ²¡æœ‰å¯ç”¨æœåŠ¡å™¨\nç¬¬äºŒï¼Œå¦‚æœæœåŠ¡ç«¯åº”ç­” syn-ack åŒ…ï¼Œæ„å‘³ç€è¿™ä¸ªç«¯å£æ˜¯æ‰“å¼€çš„ï¼Œå¦åˆ™ä¼šè¿”å› rst åŒ…ã€‚æœ€åï¼Œå®¢æˆ·ç«¯éœ€è¦å¦å¤–å‘é€ä¸€ä¸ª ack åŒ…ã€‚ä»è¿™æ—¶èµ·ï¼Œè¿æ¥å°±å·²ç»å»ºç«‹ã€‚\næˆ‘ä»¬TCPæ‰«æå™¨ç¬¬ä¸€æ­¥å…ˆå®ç°å•ä¸ªç«¯å£çš„æµ‹è¯•ã€‚ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„ net.Dial å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šåè®®å’Œæµ‹è¯•åœ°å€ï¼ˆå¸¦ç«¯å£å·ï¼‰ã€‚\nç‰ˆæœ¬ä¸€ï¼ˆå•ç«¯å£ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;net\u0026#34; ) func main() { _, err := net.Dial(\u0026#34;tcp\u0026#34;, \u0026#34;www.baidu.com:80\u0026#34;) if err == nil { fmt.Println(\u0026#34;Connection successful\u0026#34;) } else { fmt.Println(err) } } ç‰ˆæœ¬äºŒï¼ˆå¤šç«¯å£ï¼‰ ä¸ºäº†ä¸ä¸€ä¸ªä¸€ä¸ªåœ°æµ‹è¯•æ¯ä¸ªç«¯å£ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªç®€å•çš„å¾ªç¯æ¥ç®€åŒ–æ•´ä¸ªæµ‹è¯•è¿‡ç¨‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;net\u0026#34; ) func main() { for port := 80; port \u0026lt; 100; port++ { conn, err := net.Dial(\u0026#34;tcp\u0026#34;, fmt.Sprintf(\u0026#34;www.baidu.com:%d\u0026#34;, port)) if err == nil { conn.Close() fmt.Println(\u0026#34;Connection successful\u0026#34;) } else { fmt.Println(err) } } } è¿™ç§å¤„ç†æ–¹å¼æœ‰ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œæåº¦çš„æ…¢ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸¤ä¸ªæ“ä½œæ¥å¤„ç†ä¸€ä¸‹ï¼šå¹¶è¡Œçš„æ‰§è¡ŒåŠä¸ºæ¯ä¸ªè¿æ¥æ·»åŠ è¶…æ—¶æ§åˆ¶ã€‚\næˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•å®ç°å¹¶è¡Œã€‚ç¬¬ä¸€æ­¥å…ˆæŠŠæ‰«æåŠŸèƒ½æ‹†åˆ†ä¸ºä¸€ä¸ªç‹¬ç«‹å‡½æ•°ã€‚è¿™æ ·ä¼šä½¿æˆ‘ä»¬çš„ä»£ç çœ‹èµ·æ¥æ¸…æ™°ã€‚\nç‰ˆæœ¬ä¸‰ï¼ˆå¹¶å‘æ‰§è¡Œï¼‰ æˆ‘ä»¬ä¼šå¼•å…¥ä¸€ä¸ªæ–°çš„æ–¹æ³• WaitGroup ï¼Œè¯¦ç»†ç”¨æ³•ä¿¡æ¯å¯ä»¥å‚è€ƒæ ‡å‡†åº“æ–‡æ¡£ã€‚åœ¨ä¸»å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‹†åˆ†ä¸ºåç¨‹å»æ‰§è¡Œï¼Œç„¶åç­‰å¾…æ‰§è¡Œç»“æŸ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;net\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) func isOpen(host string, port int) bool { time.Sleep(time.Millisecond * 3) conn, err := net.Dial(\u0026#34;tcp\u0026#34;, fmt.Sprintf(\u0026#34;%s:%d\u0026#34;, host, port)) if err == nil { _ = conn.Close() return true } return false } func main() { ports := []int{} wg := \u0026amp;sync.WaitGroup{} for port := 1; port \u0026lt; 50000; port++ { wg.Add(1) port := port go func() { opened := isOpen(\u0026#34;www.baidu.com\u0026#34;, port) if opened { ports = append(ports, port) } wg.Done() }() } wg.Wait() fmt.Printf(\u0026#34;opened ports: %v\\n\u0026#34;, ports) } ç‰ˆæœ¬å››ï¼ˆç­‰å¾…è¶…æ—¶ï¼‰ æˆ‘ä»¬çš„ä»£ç å·²ç»æ‰§è¡Œçš„å¾ˆå¿«äº†ï¼Œä½†æ˜¯ç”±äºè¶…æ—¶çš„åŸå› ï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾…å¾ˆä¹…æ‰èƒ½æ”¶åˆ°è¿”å›çš„é”™è¯¯ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥å‡è®¾å¦‚æœæˆ‘ä»¬200æ¯«ç§’å†…æ²¡æœ‰æ”¶åˆ°æœåŠ¡å™¨çš„å›åº”ï¼Œå°±ä¸å†ç»§ç»­ç­‰å¾…ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;net\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) func isOpen(host string, port int, timeout time.Duration) bool { time.Sleep(time.Millisecond * 1) conn, err := net.DialTimeout(\u0026#34;tcp\u0026#34;, fmt.Sprintf(\u0026#34;%s:%d\u0026#34;, host, port), timeout) if err == nil { _ = conn.Close() return true } return false } func main() { ports := []int{} wg := \u0026amp;sync.WaitGroup{} timeout := time.Millisecond * 200 for port := 1; port \u0026lt; 100; port++ { wg.Add(1) go func(p int) { opened := isOpen(\u0026#34;www.baidu.com\u0026#34;, p, timeout) if opened { ports = append(ports, p) } wg.Done() }(port) } wg.Wait() fmt.Printf(\u0026#34;opened ports: %v\\n\u0026#34;, ports) } ç‰ˆæœ¬äº”ï¼ˆæ·»åŠ é”ï¼‰ ä¸ºä»€ä¹ˆè¦æ·»åŠ é”ï¼Œå› ä¸ºå¹¶å‘æ‰§è¡Œçš„è¯ï¼Œåœ¨å¾€portsæ•°ç»„å†™çš„è¯ï¼Œä¼šæœ‰å½±å“ã€‚\nç°åœ¨è¿™ä¸ªç¨‹åºä¼šæœ‰ç«äº‰æ¡ä»¶ã€‚åœ¨åªæ‰«æå°‘æ•°ç«¯å£æ—¶ï¼Œé€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œå¯èƒ½ä¸ä¼šå‡ºç°ï¼Œä½†ç¡®å®å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ mutex æ¥ä¿®å¤å®ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) var wg sync.WaitGroup var mutex sync.Mutex func isOpen(host string, port int, timeout time.Duration) bool { time.Sleep(time.Millisecond * 1) conn, err := net.DialTimeout(\u0026#34;tcp\u0026#34;, fmt.Sprintf(\u0026#34;%s:%d\u0026#34;, host, port), timeout) if err == nil { _ = conn.Close() return true } return false } func main() { startTime := time.Now() ports := []int{} timeout := time.Millisecond * 500 for port := 1; port \u0026lt;= 65000; port++ { go func(p int) { opened := isOpen(\u0026#34;www.baidu.com\u0026#34;, p, timeout) if opened { mutex.Lock() ports = append(ports, p) log.Printf(\u0026#34;ç«¯å£: %d å·²ç»å¼€é€š\u0026#34;, p) mutex.Unlock() } }(port) } time.Since(startTime) cost := int(time.Since(startTime) / time.Second) fmt.Printf(\u0026#34;opened ports: %v\\n\u0026#34;, ports) fmt.Printf(\u0026#34;ä»£ç è¿è¡Œæ—¶é•¿: %d S\u0026#34;, cost) } ç‰ˆæœ¬å…­ï¼ˆå¹¶å‘æ§åˆ¶ï¼‰ ä¸ºä»€ä¹ˆå¹¶å‘æ§åˆ¶ï¼Œä¸æ§åˆ¶çš„è¯ï¼Œåœ¨è¿è¡Œæ—¶ä¼šå¡ï¼Œæœ‰æ—¶é—´ä¼šå¯¼è‡´ç«äº‰æ¡ä»¶ã€‚ä¼šå½±å“æ¥å£ï¼Œä¸ºäº†æ•°å€¼çš„å‡†ç¡®æ€§ï¼Œæœ‰å¿…è¦æ§åˆ¶ä¸€ä¸‹å¹¶å‘æ•°é‡\nè¿™é‡Œé¢å¹¶å‘æ§åˆ¶ï¼Œæˆ‘é‡‡ç”¨channelï¼Œæœ‰å…´è¶£å¯ä»¥è°·æ­Œä¸€ä¸‹ã€‚\ngolimit.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 package golimit type GoLimit struct { ch chan int } func NewGoLimit(max int) *GoLimit { return \u0026amp;GoLimit{ch: make(chan int, max)} } func (g *GoLimit) Add() { g.ch \u0026lt;- 1 } func (g *GoLimit) Done() { \u0026lt;-g.ch } tcp.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 package main import ( \u0026#34;code/Projects/tcp_Scanning/golimit\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) var wg sync.WaitGroup var mutex sync.Mutex func isOpen(host string, port int, timeout time.Duration) bool { time.Sleep(time.Millisecond * 1) conn, err := net.DialTimeout(\u0026#34;tcp\u0026#34;, fmt.Sprintf(\u0026#34;%s:%d\u0026#34;, host, port), timeout) if err == nil { _ = conn.Close() return true } return false } func main() { startTime := time.Now() ports := []int{} timeout := time.Millisecond * 500 g := golimit.NewGoLimit(2000) for port := 1; port \u0026lt;= 65000; port++ { g.Add() go func(g *golimit.GoLimit, p int) { opened := isOpen(\u0026#34;10.10.10.1\u0026#34;, p, timeout) if opened { mutex.Lock() ports = append(ports, p) log.Printf(\u0026#34;ç«¯å£: %d å·²ç»å¼€é€š\u0026#34;, p) mutex.Unlock() } g.Done() }(g, port) } time.Since(startTime) cost := int(time.Since(startTime) / time.Second) fmt.Printf(\u0026#34;opened ports: %v\\n\u0026#34;, ports) fmt.Printf(\u0026#34;ä»£ç è¿è¡Œæ—¶é•¿: %d S\u0026#34;, cost) } ç‰ˆæœ¬ä¸ƒï¼ˆå‚æ•°å®šåˆ¶ï¼‰ æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªç®€å•çš„ç«¯å£æ‰«æå™¨ã€‚ä½†æœ‰äº›ä¸å¥½çš„æ˜¯ï¼Œä¸èƒ½å¾ˆæ–¹ä¾¿çš„ä¿®æ”¹åŸŸååœ°å€ä»¥åŠç«¯å£å·èŒƒå›´ï¼Œæˆ‘ä»¬å¿…é¡»è¦é‡æ–°ç¼–è¯‘ä»£ç æ‰å¯ä»¥ã€‚Goè¿˜æœ‰ä¸€ä¸ªå¾ˆä¸é”™çš„åŒ…å«åš flag ã€‚\nflag åŒ…å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç¼–å†™å‘½ä»¤è¡Œç¨‹åºã€‚æˆ‘ä»¬å¯ä»¥é…ç½®æ¯ä¸ªå­—ç¬¦ä¸²æˆ–æ•°å­—ã€‚æˆ‘ä»¬ä¸ºä¸»æœºååŠè¦æµ‹è¯•çš„ç«¯å£èŒƒå›´å’Œè¿æ¥è¶…æ—¶æ·»åŠ å‚æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 package main import ( \u0026#34;code/Projects/tcp_Scanning/golimit\u0026#34; \u0026#34;flag\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) var wg sync.WaitGroup var mutex sync.Mutex func isOpen(host string, port int, timeout time.Duration) bool { time.Sleep(time.Millisecond * 1) conn, err := net.DialTimeout(\u0026#34;tcp\u0026#34;, fmt.Sprintf(\u0026#34;%s:%d\u0026#34;, host, port), timeout) if err == nil { _ = conn.Close() return true } return false } func main() { startTime := time.Now() hostname := flag.String(\u0026#34;hostname\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;hostname to test\u0026#34;) startPort := flag.Int(\u0026#34;start-port\u0026#34;, 80, \u0026#34;the port on which the scanning starts\u0026#34;) endPort := flag.Int(\u0026#34;end-port\u0026#34;, 100, \u0026#34;the port from which the scanning ends\u0026#34;) timeout := flag.Duration(\u0026#34;timeout\u0026#34;, time.Millisecond*200, \u0026#34;timeout\u0026#34;) golimits := flag.Int(\u0026#34;golimit\u0026#34;, 1000, \u0026#34;the Program Concurrency\u0026#34;) flag.Parse() ports := []int{} //timeout := time.Millisecond * 500 g := golimit.NewGoLimit(*golimits) for port := *startPort; port \u0026lt;= *endPort; port++ { g.Add() go func(g *golimit.GoLimit, p int) { opened := isOpen(*hostname, p, *timeout) if opened { mutex.Lock() ports = append(ports, p) log.Printf(\u0026#34;ç«¯å£: %d å·²ç»å¼€é€š\u0026#34;, p) mutex.Unlock() } g.Done() }(g, port) } time.Since(startTime) cost := int(time.Since(startTime) / time.Second) fmt.Printf(\u0026#34;opened ports: %v\\n\u0026#34;, ports) fmt.Printf(\u0026#34;ä»£ç è¿è¡Œæ—¶é•¿: %d S\u0026#34;, cost) } å¦‚æœæˆ‘ä»¬æƒ³è¦æ˜¾ç¤ºå¦‚ä½•ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ª -h å‚æ•°ï¼Œæ¥æ˜¾ç¤ºä½¿ç”¨è¯´æ˜ã€‚æ•´ä¸ªé¡¹ç›®ä¸åˆ°50è¡Œçš„ä»£ç ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ°äº†å¹¶è¡Œã€flag åŠ net åŒ…ã€‚\né€Ÿåº¦æµ‹è¯•è¿˜ä¸é”™ï¼Œ\nå¹¶å‘ 2000ï¼Œæ‰«æ65000ç«¯å£ï¼Œåªéœ€è¦16sï¼Œè€Œä¸”å¾ˆå‡†ç¡®ã€‚\nå¦‚æœè®¾ç½®4000çš„å¹¶å‘ï¼Œæ‰«æå‡ºæ¥çš„ç»“æœå¯èƒ½ç¼ºå°‘ï¼Œåªéœ€è¦8S ã€‚\nå¤§å®¶å¯ä»¥å¤šè¯•è¯•ã€‚\n","date":"2021-12-02T17:25:11Z","image":"https://www.ownit.top/title_pic/12.jpg","permalink":"https://www.ownit.top/p/202112021725/","title":"TCPæ‰«æå¢å¼ºå™¨å®ç°65000ç«¯å£ï¼Œ10Så®Œæˆï¼Œå¿«å‡†ç‹ ï¼ˆGoè¯­è¨€ç¼–ç¨‹ï¼‰"},{"content":"Goè¯­è¨€çš„åç¨‹ä¼šå¹¶å‘ï¼Œæ‰§è¡Œï¼Œå¯ä»¥å¤§å¤§æé«˜æ•ˆç‡ã€‚\nåˆ—å¦‚ï¼Œæˆ‘ä»¬é€šè¿‡ ping æ¥æ£€æµ‹ç½‘ç»œçš„ä¸»æœºçš„è¯ã€‚\nå¦‚æœä½¿ç”¨shellçš„è¯ï¼Œä¼šæ£€æŸ¥ä¸€ä¸ªIPï¼Œåœ¨æ£€æŸ¥ä¸‹ä¸€ä¸ªIPï¼Œé€Ÿåº¦å¾ˆæ…¢ã€‚\nå¦‚æœæˆ‘ä»¬ä½¿ç”¨Python çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹ã€‚\næˆ‘ä»¬è¿™é‡Œä½¿ç”¨Goçš„åç¨‹æ¥æ“ä½œï¼Œé€Ÿåº¦æ˜¯åˆšåˆšçš„ã€‚\nä¸€ä¸ªç½‘æ®µï¼Œ10Sä¸­ï¼Œç›¸å½“äºï¼Œä¸€ç§’é’Ÿå¤„ç†25ä¸ªå·¦å³çš„IPï¼Œå› ä¸ºpingæ£€æŸ¥ï¼Œæœ‰å»¶æ—¶æ€§Â æ­¤è„šæœ¬ï¼Œåªèƒ½åœ¨Linuxä¸Šæ‰§è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;os/exec\u0026#34; \u0026#34;strconv\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) var wg sync.WaitGroup func main() { start := time.Now() ip := \u0026#34;10.10.10.\u0026#34; wg.Add(254) for i := 1; i \u0026lt;= 254; i++ { //fmt.Println(ip + strconv.Itoa(i)) true_ip := ip + strconv.Itoa(i) go ping(true_ip) } wg.Wait() cost := time.Since(start) fmt.Println(\u0026#34;æ‰§è¡Œæ—¶é—´:\u0026#34;, cost) } func ping(ip string) { var beaf = \u0026#34;false\u0026#34; Command := fmt.Sprintf(\u0026#34;ping -c 1 %s \u0026gt; /dev/null \u0026amp;\u0026amp; echo true || echo false\u0026#34;, ip) output, err := exec.Command(\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, Command).Output() if err != nil { fmt.Println(err) return } real_ip := strings.TrimSpace(string(output)) if real_ip == beaf { fmt.Printf(\u0026#34;IP: %s å¤±è´¥\\n\u0026#34;, ip) } else { fmt.Printf(\u0026#34;IP: %s æˆåŠŸ pingé€š\\n\u0026#34;, ip) } wg.Done() } ä¸å¾—ä¸è¯´ï¼ŒGOè¯­è¨€çš„å¹¶å‘ï¼Œæ˜¯çœŸçš„é¦™å•Šï¼Œ\n","date":"2021-11-30T11:17:32Z","image":"https://www.ownit.top/title_pic/41.jpg","permalink":"https://www.ownit.top/p/202111301117/","title":"golangçš„pingæ£€æµ‹ä¸»æœºå­˜æ´»"},{"content":"\nRsyslogåŒæ­¥é›†ç¾¤æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€ ä¸Šç¯‡æ–‡ä»¶ï¼Œä¸»è¦æ˜¯æŠŠé›†ç¾¤æœåŠ¡å™¨çŠ¶æ€åŒæ­¥åˆ°ä¸€å°æœºå™¨ä¸Šï¼Œç„¶åé€šè¿‡grepï¼Œawk ä»€ä¹ˆçš„æ¯”è¾ƒæ–¹ä¾¿ã€‚ä½†æ˜¯è€ƒè™‘åˆ°æ›´ç®€å•ï¼Œæ–¹ä¾¿çš„æ“ä½œï¼Œé‚£å°±æ˜¯æ¥å…¥elkæ—¥å¿—ç®¡ç†å¹³å°\næ¥æ¥ï¼Œå¤§è‡´æ€è·¯å¾ˆç®€å•\nï¼ˆ1ï¼‰æœ‰ä¸ªå®Œæˆçš„elké›†ç¾¤\nï¼ˆ2ï¼‰ä½¿ç”¨filebeatæ”¶é›†æ±‡æ€»çš„tcp.logï¼ˆåªè¦ä¸€ä¸ªfilebeatå°±å¯ä»¥ï¼‰\nï¼ˆ3ï¼‰æŠŠfilebeatæ•°æ®å‘é€åˆ°logstashä¸­ï¼Œè¿›è¡Œæ—¥å¿—åˆ‡å‰²è½¬æ¢ï¼ˆé ï¼Œæ­£åˆ™å¾ˆéš¾å—ï¼‰\nï¼ˆ4ï¼‰æŠŠlogstashçš„æ•°æ®å­˜å‚¨åˆ°es\nï¼ˆ5ï¼‰kibanaå±•ç¤ºesä¸­çš„æ•°æ®æ—¥å¿—\nï¼ˆ1ï¼‰filebeatæ”¶é›†tcp.log æ¥æ¥ï¼Œçœ‹é…ç½®ï¼Œå¾ˆç®€å•\né…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 [root@logserver01 filebeat]# cat tcp_listen.yml #=========================== Filebeat inputs ============================= filebeat.inputs: - type: log enabled: true tail_files: true paths: - /var/log/history/tcp.log #=========================== Filebeat outppp_id: messuts ============================= output.logstash: hosts: [\u0026#34;127.0.0.1:5516\u0026#34;] å¯åŠ¨å‘½ä»¤ 1 nohup /usr/local/filebeat/filebeat -e -c /usr/local/filebeat/tcp_listen.yml -path.data=/usr/local/filebeat/tcp_listen \u0026amp; ï¼ˆ2ï¼‰logstashæ”¶é›†æ¸…æ´—æ—¥å¿— æ¸…æ´—æ—¥å¿—ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦grokæ­£åˆ™æ¥å®ç°\ngrokæ­£åˆ™\nhttp://grokdebug.herokuapp.com/\n1 2021-11-22T10:51:41+08:00 172.17.42.101 storm-42-101 [storm] info: 172.21.5.22 ESTABLISHED 1 grokçš„æ­£åˆ™ 1 ^(?\u0026lt;atime\u0026gt;\\d+-\\d+-\\d+)(?:[^\\d]+)(?\u0026lt;hhmmss\u0026gt;\\d+:\\d+:\\d+)(?:[^\\d]+\\d+:\\d+)(?:\\s+)(?\u0026lt;hostip\u0026gt;\\d+\\.\\d+\\.\\d+\\.\\d+)(?:\\s)(?\u0026lt;hostname\u0026gt;[^ ]+)(?:\\s+)(?\u0026lt;hostuser\u0026gt;[^ ]+)(?:\\s+)(?\u0026lt;names\u0026gt;[^ ]+)(?:\\s)%{HOSTNAME:connect_IP}(?:\\s)(?\u0026lt;connect_state\u0026gt;[^ ]+)(?:\\s)%{HOSTNAME:connect_num} é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 [root@logserver01 config]# cat tcp_listen.conf input { beats { port =\u0026gt; 5516 type =\u0026gt; syslog } } filter { grok { match =\u0026gt; { \u0026#34;message\u0026#34; =\u0026gt; \u0026#34;^(?\u0026lt;atime\u0026gt;\\d+-\\d+-\\d+)(?:[^\\d]+)(?\u0026lt;hhmmss\u0026gt;\\d+:\\d+:\\d+)(?:[^\\d]+\\d+:\\d+)(?:\\s+)(?\u0026lt;hostip\u0026gt;\\d+\\.\\d+\\.\\d+\\.\\d+)(?:\\s)(?\u0026lt;hostname\u0026gt;[^ ]+)(?:\\s+)(?\u0026lt;hostuser\u0026gt;[^ ]+)(?:\\s+)(?\u0026lt;names\u0026gt;[^ ]+)(?:\\s)%{HOSTNAME:connect_IP}(?:\\s)(?\u0026lt;connect_state\u0026gt;[^ ]+)(?:\\s)%{HOSTNAME:connect_num}\u0026#34; } overwrite =\u0026gt; [\u0026#34;message\u0026#34;] } mutate { split =\u0026gt; [\u0026#34;type\u0026#34;,\u0026#34;,\u0026#34;] } mutate{remove_field =\u0026gt; [ \u0026#34;tags\u0026#34;,\u0026#34;agent\u0026#34;,\u0026#34;host\u0026#34;,\u0026#34;log\u0026#34;,\u0026#34;ecs\u0026#34;,\u0026#34;type\u0026#34; ]} ruby { code =\u0026gt; \u0026#34;event.set(\u0026#39;index_date\u0026#39;, event.get(\u0026#39;@timestamp\u0026#39;).time.localtime + 8*60*60)\u0026#34; } mutate { convert =\u0026gt; [\u0026#34;index_date\u0026#34;, \u0026#34;string\u0026#34;] gsub =\u0026gt; [\u0026#34;index_date\u0026#34;, \u0026#34;-\\d{2}T([\\S\\s]*?)Z\u0026#34;, \u0026#34;\u0026#34;] gsub =\u0026gt; [\u0026#34;index_date\u0026#34;, \u0026#34;-\u0026#34;, \u0026#34;.\u0026#34;] } date { match =\u0026gt; [\u0026#34;time\u0026#34;, \u0026#34;yyyy-MM-dd HH:mm:ss,SSS\u0026#34;, \u0026#34;UNIX\u0026#34;] target =\u0026gt; \u0026#34;@timestamp\u0026#34; locale =\u0026gt; \u0026#34;cn\u0026#34; } } output { stdout { # codec=\u0026gt; rubydebug } elasticsearch { hosts =\u0026gt; [\u0026#34;http://127.0.0.1:9200\u0026#34;] index =\u0026gt; \u0026#34;tcp_listen_%{index_date}\u0026#34; } } å¯åŠ¨å‘½ä»¤ 1 nohup /usr/local/logstash/bin/logstash -f /usr/local/logstash/config/tcp_listen.conf --path.data=/usr/local/logstash/data/tcp_listen \u0026amp; ï¼ˆ3ï¼‰kibanaå±•ç¤ºæ•°æ® åˆ›å»ºç´¢å¼• æŸ¥çœ‹æ•°æ® è„šæœ¬ä¸º15åˆ†é’Ÿæ‹‰å»ä¸€æ¬¡æ•°æ®çš„ã€‚æ‰€æœ‰åœ¨kibanaå±•ç¤ºä¹Ÿæ˜¯å’Œè„šæœ¬æ—¶é—´åŒæ­¥çš„Â ","date":"2021-11-22T15:36:12Z","image":"https://www.ownit.top/title_pic/46.jpg","permalink":"https://www.ownit.top/p/202111221536/","title":"é›†ç¾¤æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€æ¥å…¥ELKï¼ˆå¯è§†åŒ–æ“ä½œï¼‰"},{"content":"ç›®å‰é›†ç¾¤æœºå™¨æ¯”è¾ƒå¤šï¼Œå› ä¸ºä¸‹è½½ä¸šåŠ¡æ¯”è¾ƒå¤šï¼Œç½‘ç»œçŠ¶æ€ä¸å¥½ç›‘æ§ï¼Œæ¶‰åŠçš„çŠ¶æ€æ¯”è¾ƒå¤šã€‚æœ‰å‡ æ¬¡å‡ºé—®é¢˜ï¼Œå¯¹æ–¹çš„é”…ï¼Œè¿˜è¦æ‰”ç»™æˆ‘ä»¬ã€‚æœ‰å¿…è¦åšä¸€ä¸‹ç›‘æ§ã€‚é˜²æ­¢èƒŒé”…\nç›®å‰ä¸šåŠ¡æ–¹å¼æ˜¯æŠŠæ—¥å¿—å†™å…¥æœ¬åœ°ï¼Œåˆ°æ—¶é—´é‚£å°æœ‰é—®é¢˜ï¼Œå†å»åˆ†æé‚£ä¸€å°ã€‚\næˆ‘ä¸€çœ‹ï¼Œè¿™è¿˜çš„è¡Œå—ã€‚å¦‚æœå‡ºé—®é¢˜ä¸šåŠ¡é‡å¤§ï¼Œåˆ†æåŠå¤©èƒ½ç´¯æ­»äººï¼Œå¤ªç´¯äº†ï¼Œä¸å¤ªå»ºè®®ã€‚\nçœ‹æ¥çš„æ‹¿å‡ºæ¥çœ‹å®¶æœ¬é¢†ï¼Œå¥½æ­¹ä¹Ÿæ˜¯ç®¡ç†è¿‡ä¸ŠKå°æœºå™¨çš„èœé¸¡ï¼Œè¿˜æ˜¯æœ‰ç‚¹æ–¹æ³•çš„ã€‚\nï¼ˆ1ï¼‰ä½¿ç”¨è„šæœ¬åˆ†ææœ¬åœ°ç½‘ç»œçš„é—®é¢˜\nï¼ˆ2ï¼‰å†™å…¥rsyslog\nï¼ˆ3ï¼‰ä½¿ç”¨rsyslogçš„åŒæ­¥ï¼ŒæŠŠæ—¥å¿—æ¥å…¥ä¸€å°æœºå™¨\nï¼ˆ4ï¼‰ç„¶åæŠŠæ•°æ®æ¥å…¥elkï¼Œä½¿ç”¨å¯è§†åŒ–ç•Œé¢æ“ä½œï¼ˆé€¼æ ¼æ˜¯å¦ä¸€ä¸‹ä¸Šæ¥äº†ï¼‰\n1ã€åˆ†æç½‘ç»œçš„è„šæœ¬ 1 2 3 4 5 6 7 [heian@game ~]$ netstat -n | awk \u0026#39;/^tcp/ {print $0}\u0026#39; | awk \u0026#39;{print $(NF-1),$NF}\u0026#39; | awk -F \u0026#39;:| \u0026#39; \u0026#39;{print $1,$NF}\u0026#39; |awk \u0026#39;{a[$1\u0026#34; \u0026#34;$2]++}END{for(i in a)print i,a[i]}\u0026#39; |sort -nk 3 10.10.10.3 ESTABLISHED 1 127.0.0.1 ESTABLISHED 6 172.18.0.2 ESTABLISHED 1 192.168.1.100 ESTABLISHED 6 192.168.1.15 ESTABLISHED 6 192.168.1.210 ESTABLISHED 1 è„šæœ¬å®ç°ï¼ŒæŠŠæ•°æ®å†™å…¥rsyslog\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [root@game heian]# cat tcp_listen.sh #!/bin/bash date_time=`date +\u0026#34;%Y%m%d%H%M\u0026#34;` today=`date +\u0026#34;%Y-%m-%d\u0026#34;` date_hour=`date +\u0026#34;%Y-%m-%d_%H\u0026#34;` log_dir=\u0026#34;/app/bighead/scripts/monitorNetstat_log\u0026#34; log_path=$log_dir/$today/${date_hour}.log #æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º [ ! -d $log_dir/$today ] \u0026amp;\u0026amp; mkdir -p $log_dir/$today #è·å–æ•°æ® netstat -n | awk \u0026#39;/^tcp/ {print $0}\u0026#39; | awk \u0026#39;{print $(NF-1),$NF}\u0026#39; | awk -F \u0026#39;:| \u0026#39; \u0026#39;{print $1,$NF}\u0026#39; |awk -v date_time=$date_time \u0026#39;{a[$1\u0026#34; \u0026#34;$2]++}END{for(i in a)print date_time,i,a[i]}\u0026#39; |sort -nk 4 \u0026gt;\u0026gt; $log_path tcp_listen2=$(netstat -n | awk \u0026#39;/^tcp/ {print $0}\u0026#39; | awk \u0026#39;{print $(NF-1),$NF}\u0026#39; | awk -F \u0026#39;:| \u0026#39; \u0026#39;{print $1,$NF}\u0026#39; |awk \u0026#39;{a[$1\u0026#34; \u0026#34;$2]++}END{for(i in a)print i,a[i]}\u0026#39; |sort -nk 3) #å†™å…¥æœ¬åœ°æ–‡ä»¶ while read tcp do echo \u0026#34;$tcp\u0026#34; logger -p local5.info \u0026#34;$tcp\u0026#34; done \u0026lt;\u0026lt;\u0026lt; \u0026#34;$tcp_listen2\u0026#34; #åˆ é™¤5å¤©å‰çš„æ–‡ä»¶å¤¹ [ -d $log_dir ] \u0026amp;\u0026amp; find $log_dir -type d -mtime +5 | xargs rm -rf æ­¤è„šæœ¬ä¼šæŠŠæ•°æ®åœ¨æœ¬åœ°ä¿å­˜ä¸€ä»½ï¼Œä¹Ÿä¼šæŠŠæ•°æ®å†™å…¥rsyslog\nä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œé˜²æ­¢rsyslogæœåŠ¡å™¨å®•æœºï¼Œæ•°æ®ä¸¢å¤±å–½ï¼ˆåˆ«è¯´ï¼Œè€ƒè™‘å…¨é¢ç‚¹ï¼‰\n2ã€åˆ†å‘è„šæœ¬ï¼Œæ‰§è¡Œå®šæ—¶ä»»åŠ¡ æŠŠè¿™ä¸ªè„šæœ¬åˆ†å‘åˆ°é›†ç¾¤æœºå™¨ä¸Šï¼Œè®¾ç½®å®šæ—¶ä»»åŠ¡ï¼Œ10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œä¼šåŒæ­¥ä¸€æ¬¡ç½‘ç»œçŠ¶æ€ã€‚\nè‡³äºåˆ†å‘ï¼Œå’Œæ‰§è¡Œå‘½ä»¤åˆ›å»ºï¼Œansibleå–½ï¼Œè‡ªå·±å†™äº†å‘½ä»¤ï¼Œä¸€ä¸ªcopy ä¸€ä¸ªcron ä¸¤ä¸ªå‘½ä»¤æå®š\n1 2 3 4 5 #å¤§è‡´è¿™æ ¼å¼ ansible p3 -m copy -a \u0026#34;src=/root/node_monitor dest=/root\u0026#34; ansible p3 -m shell -a \u0026#34;chmod a+x /root/node_monitor/*\u0026#34; -f 10 ansible p3 -m cron -a \u0026#34;minute=* hour=* day=* month=* weekday=* name=\u0026#39;chia\u0026#39; job=\u0026#39;/usr/bin/python3 /root/node_monitor/node_monitor.py\u0026#39; user=\u0026#39;root\u0026#39; state=\u0026#39;present\u0026#39;\u0026#34; 3ã€åŒæ­¥é›†ç¾¤ç½‘ç»œçŠ¶æ€åˆ°rsyslog rsyslog æœåŠ¡å™¨é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 [root@jenkins ~]# cat /etc/rsyslog.conf $ModLoad imuxsock # provides support for local system logging (e.g. via logger command) $ModLoad imklog # provides kernel logging support (previously done by rklogd) $ModLoad imudp $UDPServerRun 514 $ModLoad imtcp $InputTCPServerRun 514 $template myFormat,\u0026#34;%timestamp:::date-rfc3339% %fromhost-ip% %HOSTNAME% [%programname%] %syslogseverity-text%:%msg%\\n\u0026#34; $ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat $IncludeConfig /etc/rsyslog.d/*.conf *.info;mail.none;authpriv.none;cron.none /var/log/messages;myFormat authpriv.* /var/log/secure;myFormat mail.* -/var/log/maillog cron.* /var/log/cron *.emerg :omusrmsg:* uucp,news.crit /var/log/spooler local7.* /var/log/boot.log local5.* /var/log/history/tcp.log;myFormat #å°†localç±»å‹5çš„æ—¥å¿—å­˜æ”¾åˆ° /var/log/history/tcp.logä¸‹ ä½¿ç”¨myFormatæ¨¡æ¿ rsyslog å®¢æˆ·ç«¯é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [heian@game ~]$ cat /etc/rsyslog.conf | grep -Ev \u0026#34;^$|^#\u0026#34; $ModLoad imuxsock # provides support for local system logging (e.g. via logger command) $ModLoad imjournal # provides access to the systemd journal $WorkDirectory /var/lib/rsyslog $ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat $IncludeConfig /etc/rsyslog.d/*.conf $OmitLocalLogging on $IMJournalStateFile imjournal.state *.info;mail.none;authpriv.none;cron.none /var/log/messages authpriv.* /var/log/secure mail.* -/var/log/maillog cron.* /var/log/cron *.emerg :omusrmsg:* uucp,news.crit /var/log/spooler local7.* /var/log/boot.log *.* @@192.168.1.210 #ä¸»è¦æ˜¯æœ€åä¸€è¡Œå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šï¼Œæ³¨æ„ é…ç½®æ–‡ä»¶åï¼Œè®°å¾—é‡å¯å®¢æˆ·ç«¯å•Š\n4ã€æŸ¥çœ‹æ—¥å¿— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@jenkins history]# pwd /var/log/history [root@jenkins history]# ls tcp.log [root@jenkins history]# cat tcp.log |wc -l 28 [root@jenkins history]# tail -f tcp.log 2021-11-19T16:32:21+08:00 192.168.1.100 game [heian] info: 172.18.0.2 ESTABLISHED 1 2021-11-19T16:32:21+08:00 192.168.1.100 game [heian] info: 192.168.1.100 ESTABLISHED 6 2021-11-19T16:32:21+08:00 192.168.1.100 game [heian] info: 192.168.1.15 ESTABLISHED 6 2021-11-19T16:32:21+08:00 192.168.1.100 game [heian] info: 192.168.1.210 ESTABLISHED 1 2021-11-19T16:32:40+08:00 192.168.1.100 game [heian] info: 10.10.10.3 ESTABLISHED 1 2021-11-19T16:32:40+08:00 192.168.1.100 game [heian] info: 127.0.0.1 ESTABLISHED 6 2021-11-19T16:32:40+08:00 192.168.1.100 game [heian] info: 172.18.0.2 ESTABLISHED 1 2021-11-19T16:32:40+08:00 192.168.1.100 game [heian] info: 192.168.1.100 ESTABLISHED 6 2021-11-19T16:32:40+08:00 192.168.1.100 game [heian] info: 192.168.1.15 ESTABLISHED 6 2021-11-19T16:32:40+08:00 192.168.1.100 game [heian] info: 192.168.1.210 ESTABLISHED 1 é›†ç¾¤çš„æ•°æ®å·²ç»åŒæ­¥è¿‡æ¥ï¼Œåé¢ç›´æ¥æ¥å…¥elkå°±å¯ä»¥äº†ã€‚\nRsyslogåŒæ­¥é›†ç¾¤æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€ é›†ç¾¤æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€æ¥å…¥ELKï¼ˆå¯è§†åŒ–æ“ä½œï¼‰ ","date":"2021-11-19T23:13:08Z","image":"https://www.ownit.top/title_pic/15.jpg","permalink":"https://www.ownit.top/p/202111192313/","title":"RsyslogåŒæ­¥é›†ç¾¤æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€"},{"content":"åç»­è¡¥å……\n1 2 3 4 sed -n \u0026#39;/2021-02-13 21:00:00/,/2021-02-13 22:00:00/p\u0026#39; /usr/local/apache-tomcat-6.0.45/logs/crm.log \u0026gt; /opt/crm-`date +%Y-%m-%d-%H-%M`.log æˆªå–æŸä¸ªæ—¶é—´æ®µåˆ°æŸä¸ªæ—¶é—´æ®µçš„æ—¥å¿— sed -n \u0026#39;/2021-01-18 21:10:00/,$p\u0026#39; /usr/local/apache-tomcat-6.0.45/logs/crm.log \u0026gt; /opt/crm-`date +%Y-%m-%d-%H-%M`.logÂ æˆªå–æŸä¸ªæ—¶é—´æ®µåˆ°ç°åœ¨çš„ ","date":"2021-11-03T16:53:26Z","image":"https://www.ownit.top/title_pic/60.jpg","permalink":"https://www.ownit.top/p/202111031653/","title":"æˆªå–æ—¥å¿—èŒƒå›´ï¼ˆsedï¼‰"},{"content":"åœ¨å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨mysqlçš„ä¸»ä»ï¼Œæ¥å»æŠ¥æ•°æ®çš„å®‰å…¨æ€§ã€‚\né¦–å…ˆç›®å‰ä¸»æµçš„å¤‡ä»½å·¥ä½œmysqldumpå’ŒXtrabackupï¼Œéƒ½å¯ä»¥å®ç°æ•°æ®åº“çš„å¤‡ä»½ã€‚\nå…³äºé‚£ä¸ªç”¨æ¥å¤‡ä»½æ•°æ®ï¼Œæ¥åšmysqlä¸»ä»ï¼Œæ¯«æ— ç–‘é—®å°±æ˜¯Â Xtrabackupäº†ã€‚\né¦–å…ˆMySQLåšä¸»ä»æ—¶ï¼Œéœ€è¦ä½¿ç”¨åˆ°binlogæ—¥å¿— å’Œ poså·ï¼Œå…³é”®å°±æ˜¯è¿™ä¸ªposã€‚\nå¦‚æœæ˜¯mysqldumpæ¥å¤‡ä»½ï¼Œéœ€è¦è¿›è¡Œé”è¡¨æ‰è¡Œï¼Œå¦‚æœæ˜¯Xtrabackup å®Œå…¨å¯ä»¥åœ¨ä»»åŠ¡è¿è¡Œä¸­ï¼Œè¿›è¡Œå¤‡ä»½ï¼Œå®Œå…¨ä¸éœ€è¦é”è¡¨ï¼Œæ›´ä¸ä¼šå½±å“ä¸šåŠ¡ã€‚æ‰€ä»¥æˆ‘ä»¬é¦–é€‰å°±æ˜¯Xtrabackup\nç›¸å…³åŸç†ï¼Œå¯ä»¥è¿›è¡Œè°·æ­Œã€‚\nåœ¨è¿™ä¸ªåªæš‚æ—¶å…ˆå…³æ­¥éª¤\nMysqlæ—¥å¿—é€‰æ‹© ï¼ˆ1ï¼‰mysqlçš„binlogæ—¥å¿—æ ¼å¼ mysqlçš„binlogæœ‰3ç§æ—¥å¿—æ ¼å¼ã€‚\nmysqlÂ binlogæ—¥å¿—æœ‰ä¸‰ç§æ ¼å¼ï¼Œåˆ†åˆ«ä¸ºStatement,MiXED,ä»¥åŠROWï¼\næŸ¥çœ‹binlogçš„æ ¼å¼çš„è„šæœ¬ï¼š\nï¼ˆ2ï¼‰binlog çš„ä¸åŒæ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼ŸÂ 1.Statementï¼šæ¯ä¸€æ¡ä¼šä¿®æ”¹æ•°æ®çš„sqléƒ½ä¼šè®°å½•åœ¨binlogä¸­ã€‚\nä¼˜ç‚¹ï¼šä¸éœ€è¦è®°å½•æ¯ä¸€è¡Œçš„å˜åŒ–ï¼Œå‡å°‘äº†binlogæ—¥å¿—é‡ï¼ŒèŠ‚çº¦äº†IOï¼Œæé«˜æ€§èƒ½ã€‚(ç›¸æ¯”rowèƒ½èŠ‚çº¦å¤šå°‘æ€§èƒ½ä¸æ—¥å¿—é‡ï¼Œè¿™ä¸ªå–å†³äºåº”ç”¨çš„SQLæƒ…å†µï¼Œæ­£å¸¸åŒä¸€æ¡è®°å½•ä¿®æ”¹æˆ–è€…æ’å…¥rowæ ¼å¼æ‰€äº§ç”Ÿçš„æ—¥å¿—é‡è¿˜å°äºStatementäº§ç”Ÿçš„æ—¥å¿—é‡ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å¦‚æœå¸¦æ¡ä»¶çš„updateæ“ä½œï¼Œä»¥åŠæ•´è¡¨åˆ é™¤ï¼Œalterè¡¨ç­‰æ“ä½œï¼ŒROWæ ¼å¼ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—ï¼Œå› æ­¤åœ¨è€ƒè™‘æ˜¯å¦ä½¿ç”¨ROWæ ¼å¼æ—¥å¿—æ—¶åº”è¯¥è·Ÿæ®åº”ç”¨çš„å®é™…æƒ…å†µï¼Œå…¶æ‰€äº§ç”Ÿçš„æ—¥å¿—é‡ä¼šå¢åŠ å¤šå°‘ï¼Œä»¥åŠå¸¦æ¥çš„IOæ€§èƒ½é—®é¢˜ã€‚)\nç¼ºç‚¹ï¼šç”±äºè®°å½•çš„åªæ˜¯æ‰§è¡Œè¯­å¥ï¼Œä¸ºäº†è¿™äº›è¯­å¥èƒ½åœ¨slaveä¸Šæ­£ç¡®è¿è¡Œï¼Œå› æ­¤è¿˜å¿…é¡»è®°å½•æ¯æ¡è¯­å¥åœ¨æ‰§è¡Œçš„æ—¶å€™çš„ä¸€äº›ç›¸å…³ä¿¡æ¯ï¼Œä»¥ä¿è¯æ‰€æœ‰è¯­å¥èƒ½åœ¨slaveå¾—åˆ°å’Œåœ¨masterç«¯æ‰§è¡Œæ—¶å€™ç›¸åŒçš„ç»“æœã€‚å¦å¤–mysql çš„å¤åˆ¶,åƒä¸€äº›ç‰¹å®šå‡½æ•°åŠŸèƒ½ï¼Œslaveå¯ä¸masterä¸Šè¦ä¿æŒä¸€è‡´ä¼šæœ‰å¾ˆå¤šç›¸å…³é—®é¢˜(å¦‚sleep()å‡½æ•°ï¼Œ last_insert_id()ï¼Œä»¥åŠuser-defined functions(udf)ä¼šå‡ºç°é—®é¢˜).\n2.Row:ä¸è®°å½•sqlè¯­å¥ä¸Šä¸‹æ–‡ç›¸å…³ä¿¡æ¯ï¼Œä»…ä¿å­˜å“ªæ¡è®°å½•è¢«ä¿®æ”¹ã€‚\nä¼˜ç‚¹ï¼šÂ binlogä¸­å¯ä»¥ä¸è®°å½•æ‰§è¡Œçš„sqlè¯­å¥çš„ä¸Šä¸‹æ–‡ç›¸å…³çš„ä¿¡æ¯ï¼Œä»…éœ€è¦è®°å½•é‚£ä¸€æ¡è®°å½•è¢«ä¿®æ”¹æˆä»€ä¹ˆäº†ã€‚æ‰€ä»¥rowlevelçš„æ—¥å¿—å†…å®¹ä¼šéå¸¸æ¸…æ¥šçš„è®°å½•ä¸‹æ¯ä¸€è¡Œæ•°æ®ä¿®æ”¹çš„ç»†èŠ‚ã€‚è€Œä¸”ä¸ä¼šå‡ºç°æŸäº›ç‰¹å®šæƒ…å†µä¸‹çš„å­˜å‚¨è¿‡ç¨‹ï¼Œæˆ–functionï¼Œä»¥åŠtriggerçš„è°ƒç”¨å’Œè§¦å‘æ— æ³•è¢«æ­£ç¡®å¤åˆ¶çš„é—®é¢˜\nç¼ºç‚¹:æ‰€æœ‰çš„æ‰§è¡Œçš„è¯­å¥å½“è®°å½•åˆ°æ—¥å¿—ä¸­çš„æ—¶å€™ï¼Œéƒ½å°†ä»¥æ¯è¡Œè®°å½•çš„ä¿®æ”¹æ¥è®°å½•ï¼Œè¿™æ ·å¯èƒ½ä¼šäº§ç”Ÿå¤§é‡çš„æ—¥å¿—å†…å®¹,æ¯”å¦‚ä¸€æ¡updateè¯­å¥ï¼Œä¿®æ”¹å¤šæ¡è®°å½•ï¼Œåˆ™binlogä¸­æ¯ä¸€æ¡ä¿®æ”¹éƒ½ä¼šæœ‰è®°å½•ï¼Œè¿™æ ·é€ æˆbinlogæ—¥å¿—é‡ä¼šå¾ˆå¤§ï¼Œç‰¹åˆ«æ˜¯å½“æ‰§è¡Œalter tableä¹‹ç±»çš„è¯­å¥çš„æ—¶å€™ï¼Œç”±äºè¡¨ç»“æ„ä¿®æ”¹ï¼Œæ¯æ¡è®°å½•éƒ½å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆè¯¥è¡¨æ¯ä¸€æ¡è®°å½•éƒ½ä¼šè®°å½•åˆ°æ—¥å¿—ä¸­ã€‚\n3.Mixedlevel:Â æ˜¯ä»¥ä¸Šä¸¤ç§levelçš„æ··åˆä½¿ç”¨ï¼Œä¸€èˆ¬çš„è¯­å¥ä¿®æ”¹ä½¿ç”¨statmentæ ¼å¼ä¿å­˜binlogï¼Œå¦‚ä¸€äº›å‡½æ•°ï¼Œstatementæ— æ³•å®Œæˆä¸»ä»å¤åˆ¶çš„æ“ä½œï¼Œåˆ™é‡‡ç”¨rowæ ¼å¼ä¿å­˜binlog,MySQLä¼šæ ¹æ®æ‰§è¡Œçš„æ¯ä¸€æ¡å…·ä½“çš„sqlè¯­å¥æ¥åŒºåˆ†å¯¹å¾…è®°å½•çš„æ—¥å¿—å½¢å¼ï¼Œä¹Ÿå°±æ˜¯åœ¨Statementå’ŒRowä¹‹é—´é€‰æ‹©ä¸€ç§.æ–°ç‰ˆæœ¬çš„MySQLä¸­é˜Ÿrow levelæ¨¡å¼ä¹Ÿè¢«åšäº†ä¼˜åŒ–ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ä¿®æ”¹éƒ½ä¼šä»¥row levelæ¥è®°å½•ï¼Œåƒé‡åˆ°è¡¨ç»“æ„å˜æ›´çš„æ—¶å€™å°±ä¼šä»¥statementæ¨¡å¼æ¥è®°å½•ã€‚è‡³äºupdateæˆ–è€…deleteç­‰ä¿®æ”¹æ•°æ®çš„è¯­å¥ï¼Œè¿˜æ˜¯ä¼šè®°å½•æ‰€æœ‰è¡Œçš„å˜æ›´ã€‚\nï¼ˆ3ï¼‰BinlogåŸºæœ¬é…åˆ¶ä¸æ ¼å¼è®¾å®š 1.åŸºæœ¬é…åˆ¶\nMysql BInlogæ—¥å¿—æ ¼å¼å¯ä»¥é€šè¿‡mysqlçš„my.cnfæ–‡ä»¶çš„å±æ€§binlog_formatæŒ‡å®šã€‚å¦‚ä»¥ä¸‹ï¼š\nbinlog_format = MIXEDÂ //binlogæ—¥å¿—æ ¼å¼\nlog_bin =ç›®å½•/mysql-bin.logÂ //binlogæ—¥å¿—å\nexpire_logs_days = 7Â //binlogè¿‡æœŸæ¸…ç†æ—¶é—´\nmax_binlog_size 100mÂ //binlogæ¯ä¸ªæ—¥å¿—æ–‡ä»¶å¤§å°\n2.Binlogæ—¥å¿—æ ¼å¼é€‰æ‹©\nMysqlé»˜è®¤æ˜¯ä½¿ç”¨Statementæ—¥å¿—æ ¼å¼ï¼Œæ¨èä½¿ç”¨MIXED.\nç”±äºä¸€äº›ç‰¹æ®Šä½¿ç”¨ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ROWEDï¼Œå¦‚è‡ªå·±é€šè¿‡binlogæ—¥å¿—æ¥åŒæ­¥æ•°æ®çš„ä¿®æ”¹ï¼Œè¿™æ ·ä¼šèŠ‚çœå¾ˆå¤šç›¸å…³æ“ä½œã€‚å¯¹äºbinlogæ•°æ®å¤„ç†ä¼šå˜å¾—éå¸¸è½»æ¾,ç›¸å¯¹mixedï¼Œè§£æä¹Ÿä¼šå¾ˆè½»æ¾(å½“ç„¶å‰ææ˜¯å¢åŠ çš„æ—¥å¿—é‡æ‰€å¸¦æ¥çš„IOå¼€é”€åœ¨å®¹å¿çš„èŒƒå›´å†…å³å¯)ã€‚Â 1 2 3 4 5 6 7 1.å…ˆä¿®æ”¹ä»åº“çš„binlogæ ¼å¼ set global binlog_format=MIXED; 2.å†ä¿®æ”¹ä¸»åº“çš„binlogæ ¼å¼ set global binlog_format=MIXED; 3.ä¿®æ”¹ä¸»åº“çš„my.cnf(é¿å…é‡å¯å¤±æ•ˆ) binlog_format=MIXED 4.é‡å¯stop slaveï¼Œstart slave 2ã€ä¸»å¤‡åº“å‡å®‰è£…Xtrabackupå¼€æºå·¥å…·åœ¨çº¿çƒ­å¤‡ä»½æ­å»ºå¤‡åº“ 1 2 3 4 5 6 7 #ä¸‹è½½å·¥å…·åŒ…percona-xtrabackup-2.4.14-Linux-x86_64.libgcrypt183.tar.gz tar -xf percona-xtrabackup-2.4.14-Linux-x86_64.libgcrypt183.tar.gz mv percona-xtrabackup-2.4.14-Linux-x86_64 xtrabackup mv xtrabackup/ /usr/local/ echo \u0026#34;export PATH=$PATH:/usr/local/xtrabackup/bin\u0026#34; \u0026gt;\u0026gt; /etc/profile source /etc/profile 3ã€ä¸»åº“åœ¨çº¿å¤‡ä»½(ä¸å½±å“ä¸šåŠ¡) 1 2 3 4 5 6 7 8 9 10 11 12 13 innobackupex --user=\u0026#39;root\u0026#39; --password=\u0026#39;xxxxxx\u0026#39; --slave-info /data1/backup/20210927 --no-timestamp --socket=/tmp/mysql.sock #ä»¥ä¸‹æ˜¯è¾“å‡ºç»“æœ: xtrabackup: recognized server arguments: --server-id=1 --log_bin=binlog --datadir=/data1/mysql/data/ --tmpdir=/tmp xtrabackup: recognized client arguments: --server-id=1 --log_bin=binlog --datadir=/data1/mysql/data/ --tmpdir=/tmp 200615 16:26:27 innobackupex: Starting the backup operation IMPORTANT: Please check that the backup run completes successfully. At the end of a successful backup run innobackupex prints \u0026#34;completed OK!\u0026#34;. .......... xtrabackup: Transaction log of lsn (5055292518) to (5055292527) was copied. 200615 16:26:30 completed OK! 4ã€æ£€æŸ¥å…¨å¤‡çš„POS 1 2 cat /data/backup/20200615/xtrabackup_binlog_info binlog.000002 184668420 5ã€å°†å¤‡ä»½æ–‡ä»¶å‹ç¼©ä¼ è¾“åˆ°å¤‡æœºä¸Š 1 2 3 cd /data1/backup/ tar -zcf 20210927.tar.gz 20210927 scp 20210927.tar.gz dam@dam02:/home/dam/ 6ã€åœæ­¢å¤‡åº“,å°†åŸæ¥çš„å¤‡åº“datadirçš„è·¯å¾„é‡å‘½åå¹¶åˆ›å»ºæ–°çš„æ•°æ®dataç›®å½• 1 2 3 4 /etc/init.d/mysqld stop cd /data1/mysql mv data data3 mkdir data 7ã€è§£å‹ç¼©å¤‡ä»½æ–‡ä»¶å¹¶æ¢å¤æ•°æ®åˆ°æ–°çš„dataç›®å½• 1 2 3 4 5 6 7 8 9 tar -xf 20210927.tar.gz -C /data1/mysql/ #æ•°æ®ä¸€è‡´æ€§æ¢å¤ innobackupex --apply-log /data1/mysql/20210927 #æ•°æ®copyåˆ°dirç›®å½• innobackupex --copy-back /data1/mysql/20210927 chown -R mysql.mysql /data1/mysql/data chmod -R 775 /data1/mysql/data 8ã€é‡å¯å¤‡æœº228çš„mysql 1 2 /etc/init.d/mysqld stop /etc/init.d/mysqld start 9ã€é…ç½®ä¸»ä»åŒæ­¥ 1 2 3 4 5 6 7 8 9 10 11 12 #227ä¸»æœºåˆ›å»ºåŒæ­¥ç”¨æˆ·: create USER \u0026#39;xxxx\u0026#39;@\u0026#39;172.17.8.%\u0026#39; IDENTIFIED WITH mysql_native_password BY \u0026#39;xxxxxx\u0026#39;; grant replication slave on *.* to \u0026#39;syncuser\u0026#39;@\u0026#39;172.17.8.%\u0026#39;; flush privileges; #228é…ç½®å¤‡æœºï¼š reset slave all; stop slave; change master to master_host=\u0026#39;172.17.8.227\u0026#39;,master_port=3306,master_user=\u0026#39;syncuser\u0026#39;,master_password=\u0026#39;xxxxx\u0026#39;,master_log_file=\u0026#39;binlog.000002\u0026#39;,master_log_pos=184668420; start slave; show slave status\\G; show master status\\G; 10ã€ä¸ºè§£å†³msyqlä¸»ä»å»¶è¿Ÿé—®é¢˜è¿›è¡Œçš„ç›¸å…³è°ƒä¼˜ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #ä¸»ä»å¹¶è¡Œå¤åˆ¶å‚æ•°ï¼š vim my.cnf master_info_repository=TABLE #masterä¿¡æ¯æ”¾åˆ°è¡¨é‡Œ relay_log_info_repository=TABLE #relayæ—¥å¿—ä¿¡æ¯æ”¾åˆ°è¡¨é‡Œ slave_parallel_type = LOGICAL_CLOCK #åŸºäºç»„æäº¤çš„å¹¶è¡Œå¤åˆ¶æ–¹å¼ slave_parallel_workers=8 #sqlå¹¶è¡Œé‡ slave_preserve_commit_order=ON #relayé¡ºåºä¸masterå¹¶è¡Œé¡ºåºä¿æŒä¸€è‡´ relay_log_recovery=ON #å®•æœºæ—¶é‡æ–°ä»masterè·å–æ—¥å¿—ï¼Œä¿è¯relayå®Œæ•´æ€§ replicate-wild-ignore-table=scheduler.tb_qa% #ä¸åŒæ­¥scheduler.tb_qaå¼€å¤´çš„è¡¨ replicate-wild-ignore-table=scheduler.tb_qc% #ä¸åŒæ­¥scheduler.tb_qcå¼€å¤´çš„è¡¨\tstop slave; set global master_info_repository=\u0026#39;table\u0026#39;; set global relay_log_info_repository=\u0026#39;table\u0026#39;; set global slave_parallel_type=\u0026#39;logical_clock\u0026#39;; set global slave_parallel_workers=8; set global slave_preserve_commit_order=\u0026#39;on\u0026#39;; set global relay_log_recovery=\u0026#39;on\u0026#39;; start slave; ","date":"2021-11-01T12:01:06Z","image":"https://www.ownit.top/title_pic/38.jpg","permalink":"https://www.ownit.top/p/202111011201/","title":"Xtrabackupå·¥å…·è¿›è¡Œåœ¨çº¿ä¸»ä»æ­å»º"},{"content":"è¿‘æœŸå› ä¸ºä¸šåŠ¡ç³»ç»Ÿç­‰ä¿ï¼Œå‘ç°sshæœ‰å¥½å¤šçš„æ¼æ´ï¼Œéœ€è¦æ›´æ–°å‡çº§ã€‚\nè´Ÿè´£çš„æœåŠ¡å™¨æœ‰ç‚¹å¤šï¼Œä¸èƒ½å•ä¸ªæ‰‹åŠ¨ç¼–è¯‘ï¼Œæ‰€ä»¥é‡‡ç”¨ ansible + è„šæœ¬æ–¹å¼æ‰¹é‡ç¼–è¯‘å®‰è£…\nç›¸å…³ä¸‹è½½è½¯ä»¶åœ°å€ï¼šhttps://download.csdn.net/download/heian_99/35589407\næœ¬æ¬¡å‡çº§ä¸»è¦è§£å†³ä¸Šæ¬¡å‡çº§é€ æˆçš„éšæ‚£ï¼Œå¹¶æ·»åŠ 12222ç«¯å£ï¼Œ\néšæ‚£ï¼š\nï¼ˆ1ï¼‰sshdæ— æ³•å¼€æœºè‡ªå¯ ä¸»æœºé‡å¯åï¼Œsshdæ— æ³•èµ·æ¥ï¼Œéœ€è¦ä»–ä»¬æ‰‹åŠ¨é‡å¯ ï¼ˆ2ï¼‰sshçš„é…ç½®æ–‡ä»¶ç›®å½•ä¸å¯¹ ï¼Œæ²¡åŠæ³•ç»Ÿä¸€ç®¡ç† ï¼ˆ3ï¼‰sshdæ— æ³•å¼€æœºè‡ªå¯ï¼Œå¯¼è‡´rc-local.service æ— æ³•è‡ªå¯, å†æ¬¡å‡çº§åŸºç¡€ä¸Š\nï¼ˆ1ï¼‰æ·»åŠ ssh_banner_change éšè—ç‰ˆæœ¬ä¿¡æ¯\nï¼ˆ2ï¼‰ç¼–è¯‘æ˜¯ä¿®æ”¹ç‰ˆæœ¬å·ï¼Œç¦æ­¢telnetæ˜¾ç¤ºç‰ˆæœ¬å·\nï¼ˆ3ï¼‰ç¦æ­¢rootçš„å¯†ç ç™»å½•\nç«¯å£æ·»åŠ \nï¼ˆæ³¨ï¼šé›†ç¾¤æœ‰äº›ä¸šåŠ¡æ˜¯éœ€è¦22ç«¯å£ï¼Œæš‚æ—¶ä¸èƒ½ç›´æ¥å»æ‰22ç«¯å£ï¼‰\néšè—æ•ˆæœ\nsshup.sh\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 #!/bin/bash # ä½œè€…ï¼šå—å®«ä¹˜é£ # ä½œç”¨ï¼šå‡çº§ssh åˆ° OpenSSH_8.6p1 ç‰ˆæœ¬ï¼Œå¹¶æ·»åŠ 12222ç«¯å£ #æ—¥æœŸå’Œå‡çº§è¿‡ç¨‹ä¸­æ­¥éª¤ log=\u0026#34;/opt/backup/update_log\u0026#34; datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) hostname=`hostname` echo \u0026#34;==========ä¸»æœºåï¼š${hostname} å¼€å§‹å‡çº§==============\u0026#34; \u0026gt;\u0026gt;${log} yum -y install openssl-devel zlib-devel gcc gcc-c++ pam-devel perl #æ­¥éª¤ ï¼šå¤‡ä»½ è§£å‹ ç¼–è¯‘ é‡å¯ #å¤‡ä»½ï¼Œä¸»è¦æ˜¯/etc/ssh ç›®å½• å’Œ å…ˆå…³å‡çº§çš„åŒ… backup=/opt/backup/update_2021_11_01 mkdir -p ${backup} echo \u0026#34;${backup} åˆ›å»ºæˆåŠŸ\u0026#34; \u0026gt;\u0026gt;${log} #å¤‡ä»½æ–‡ä»¶ ä¸»è¦æ˜¯ç§»é™¤ echo \u0026#34;=======time: ${datetime}=======å¼€å§‹å¤‡ä»½æ–‡ä»¶==============\u0026#34; \u0026gt;\u0026gt;${log} mv /etc/ssh ${backup} mv /usr/sbin/sshd ${backup} mv /usr/bin/ssh ${backup}/ssh_bak mv /usr/bin/ssh-keygen ${backup} datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) echo \u0026#34;${datetime} /etc/ssh å¤‡ä»½æˆåŠŸ\u0026#34; \u0026gt;\u0026gt;${log} echo \u0026#34;${datetime} /usr/sbin/sshd å¤‡ä»½æˆåŠŸ\u0026#34; \u0026gt;\u0026gt;${log} echo \u0026#34;${datetime} /usr/bin/ssh å¤‡ä»½æˆåŠŸ\u0026#34; \u0026gt;\u0026gt;${log} echo \u0026#34;${datetime} /usr/bin/ssh-keygen å¤‡ä»½æˆåŠŸ\u0026#34; \u0026gt;\u0026gt;${log} FILE=/lib/systemd/system/sshd.service if [ -f \u0026#34;$FILE\u0026#34; ]; then rm -rf /lib/systemd/system/sshd.service echo \u0026#34;sshd.service å·²æ¸…é™¤\u0026#34; \u0026gt;\u0026gt;${log} fi datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) echo \u0026#34;=======time: ${datetime}=======å¤‡ä»½ç¨‹åºç¼–è¯‘æ–‡ä»¶==============\u0026#34; \u0026gt;\u0026gt;${log} mv /usr/local/src/openssh* ${backup} mv /usr/local/src/openssl* ${backup} mv /usr/local/src/zlib* ${backup} datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) echo \u0026#34;=======time: ${datetime}=======å¼€å§‹è§£å‹æ–‡ä»¶==============\u0026#34; \u0026gt;\u0026gt;${log} #è§£å‹ cd /opt/backup/ssh_tar tar xf openssh-8.6p1.tar.gz -C /usr/local/src/ tar xf openssl-1.1.1i.tar.gz -C /usr/local/src/ tar xf zlib-1.2.11.tar.gz -C /usr/local/src/ datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) echo \u0026#34;=======time: ${datetime}=======å¼€å§‹ç¼–è¯‘zlib==============\u0026#34; \u0026gt;\u0026gt;${log} #ç§»é™¤ mv /usr/local/zlib ${backup} cd /usr/local/src/zlib-1.2.11/ ./configure --prefix=/usr/local/zlib \u0026amp;\u0026amp; make -j 4 \u0026amp;\u0026amp; make install datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) echo \u0026#34;=======time: ${datetime}=======å¼€å§‹ç¼–è¯‘openssl==============\u0026#34; \u0026gt;\u0026gt;${log} #openssl mv /usr/local/ssl ${backup} cd /usr/local/src/openssl-1.1.1i/ ./config --prefix=/usr/local/ssl -d shared make -j 4 \u0026amp;\u0026amp; make install echo \u0026#39;/usr/local/ssl/lib\u0026#39; \u0026gt;\u0026gt;/etc/ld.so.conf ldconfig -v datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) echo \u0026#34;=======time: ${datetime}=======å¼€å§‹ç¼–è¯‘openssh==============\u0026#34; \u0026gt;\u0026gt;${log} #openssh mv /usr/local/openssh ${backup} cd /usr/local/src/openssh-8.6p1/ sed -i \u0026#39;s/OpenSSH_8.6/Prohibit_detection/g\u0026#39; /usr/local/src/openssh-8.6p1/version.h ./configure --prefix=/usr/local/openssh --sysconfdir=/etc/ssh --with-pam --with-ssl-dir=/usr/local/ssl --with-zlib=/usr/local/zlib make -j 4 \u0026amp;\u0026amp; make install echo \u0026#39;Version is empty\u0026#39;\u0026gt;\u0026gt; /etc/ssh_banner_change echo \u0026#39;Banner /etc/ssh_banner_change\u0026#39; \u0026gt;\u0026gt; /etc/ssh/sshd_config echo \u0026#39;Port 22\u0026#39; \u0026gt;\u0026gt;/etc/ssh/sshd_config echo \u0026#39;Port 12222\u0026#39; \u0026gt;\u0026gt;/etc/ssh/sshd_config echo \u0026#39;PermitRootLogin without-password\u0026#39; \u0026gt;\u0026gt;/etc/ssh/sshd_config echo \u0026#39;PubkeyAuthentication yes\u0026#39; \u0026gt;\u0026gt;/etc/ssh/sshd_config echo \u0026#39;PasswordAuthentication yes\u0026#39; \u0026gt;\u0026gt;/etc/ssh/sshd_config echo \u0026#39;UsePAM yes\u0026#39; \u0026gt;\u0026gt;/etc/ssh/sshd_config echo \u0026#39;KexAlgorithms curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group14-sha1\u0026#39; \u0026gt;\u0026gt;/etc/ssh/sshd_config datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) echo \u0026#34;=======time: ${datetime}=======å¼€å§‹å†™å…¥pam_sshd==============\u0026#34; \u0026gt;\u0026gt;${log} cp /etc/pam.d/sshd ${backup}/pam_sshd if [ ! -e /etc/pam.d/sshd ]; then cat \u0026gt;/etc/pam.d/sshd \u0026lt;\u0026lt;EOF #%PAM-1.0 auth required pam_sepermit.so auth substack password-auth auth include postlogin # Used with polkit to reauthorize users in remote sessions -auth optional pam_reauthorize.so prepare account required pam_nologin.so account include password-auth password include password-auth # pam_selinux.so close should be the first session rule session required pam_selinux.so close session required pam_loginuid.so # pam_selinux.so open should only be followed by sessions to be executed in the user context session required pam_selinux.so open env_params session required pam_namespace.so session optional pam_keyinit.so force revoke session include password-auth session include postlogin # Used with polkit to reauthorize users in remote sessions -session optional pam_reauthorize.so prepare EOF chmod 644 /etc/pam.d/sshd else cp -pf /etc/pam.d/{login,sshd} fi datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) echo \u0026#34;=======time: ${datetime}=======å¼€å§‹è¦†ç›–sshdï¼Œsshï¼Œssh-keygen==============\u0026#34; \u0026gt;\u0026gt;${log} cp -rf /usr/local/openssh/sbin/sshd /usr/sbin/sshd cp -rf /usr/local/openssh/bin/ssh /usr/bin/ssh cp -rf /usr/local/openssh/bin/ssh-keygen /usr/bin/ssh-keygen chmod 755 /usr/sbin/sshd chmod 755 /usr/bin/ssh chmod 755 /usr/bin/ssh-keygen datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) echo \u0026#34;=======time: ${datetime}=======è®¾ç½®å¼€æœºè‡ªå¯sshd==============\u0026#34; \u0026gt;\u0026gt;${log} \\cp /usr/local/src/openssh-8.6p1/contrib/redhat/sshd.init /etc/init.d/sshd chmod u+x /etc/init.d/sshd systemctl daemon-reload /etc/init.d/sshd restart chkconfig --add sshd chkconfig sshd on chkconfig --list sshd datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) echo \u0026#34;=======time: ${datetime}=======sshdå‡çº§æˆåŠŸ==============\u0026#34; \u0026gt;\u0026gt;${log} echo -e \u0026#34;æœ¬æ¬¡å‡çº§ä½¿ç”¨: $SECONDS seconds\u0026#34; datetime=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) echo \u0026#34;=======time: ${datetime}=======æœ¬æ¬¡å‡çº§ä½¿ç”¨: ${SECONDS} seconds ==============\u0026#34; \u0026gt;\u0026gt;${log} é…åˆansible æ‰¹é‡å‡çº§\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 [heian@zabbix ssh]$ cat ssh-update.yml - hosts: test remote_user: heian gather_facts: false become: yes become_user: root become_method: sudo vars: - ssh_tar: /opt/backup/ssh_tar tasks: - name: åˆ›å»ºssh_tarç›®å½• file: path: \u0026#34;{{ssh_tar}}\u0026#34; state: directory mode: \u0026#39;0755\u0026#39; - name: åˆ†å‘ç¼–è¯‘åŒ… copy: src: \u0026#34;{{ item }}\u0026#34; dest: \u0026#34;{{ ssh_tar }}\u0026#34; mode: 0755 with_items: - /home/heian/ssh/openssh-8.6p1.tar.gz - /home/heian/ssh/openssl-1.1.1i.tar.gz - /home/heian/ssh/zlib-1.2.11.tar.gz - /home/heian/ssh/sshup.sh - name: æ‰§è¡Œsshdå‡çº§è„šæœ¬ shell: sh /opt/backup/ssh_tar/sshup.sh - name: æŸ¥çœ‹å‡çº§ç»“æœ shell: cat /opt/backup/update_log register: ssh_log - name: Debug number debug: msg: \u0026#34; IP : {{ inventory_hostname }} å‡çº§ç»“æœ : {{ ssh_log.stdout }} \u0026#34; å‚è€ƒæ–‡æ¡£ï¼šCentOS7.xå‡çº§openssh8.4p1è¯¦è§£ - chillax1314 - åšå®¢å›­\n","date":"2021-10-30T14:55:04Z","image":"https://www.ownit.top/title_pic/47.jpg","permalink":"https://www.ownit.top/p/202110301455/","title":"openssh-8.6p1æ‰¹é‡ç¼–è¯‘å®‰è£…å‡çº§"},{"content":"ä¸šåŠ¡è¦æ±‚ï¼Œè¿‘æœŸé›†ç¾¤è¦ä½¿ç”¨zookeeperé›†ç¾¤ï¼Œå‡†å¤‡åœ¨Kuberneteså®ç°ã€‚\næ–¹æ³•ä¸€ï¼š ä½¿ç”¨pvå’Œpvc æ¥æŒ‚è½½\nè¿™ä¸ªåŒæ—¶åˆ›å»ºpvå’Œpvc\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 [root@k8s-master k8s-yaml]# cat zookeeper-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: zk-01 labels: name: zk-cluster type: nfs spec: nfs: path: /home/installapp/nfs/data/zk-01 server: 192.168.1.210 accessModes: - \u0026#34;ReadWriteOnce\u0026#34; capacity: storage: 1Gi persistentVolumeReclaimPolicy: Recycle --- apiVersion: v1 kind: PersistentVolume metadata: name: zk-02 labels: name: zk-cluster type: nfs spec: nfs: path: /home/installapp/nfs/data/zk-02 server: 192.168.1.210 accessModes: - \u0026#34;ReadWriteOnce\u0026#34; capacity: storage: 1Gi persistentVolumeReclaimPolicy: Recycle --- apiVersion: v1 kind: PersistentVolume metadata: name: zk-03 labels: name: zk-cluster type: nfs spec: nfs: path: /home/installapp/nfs/data/zk-03 server: 192.168.1.210 accessModes: - \u0026#34;ReadWriteOnce\u0026#34; capacity: storage: 1Gi persistentVolumeReclaimPolicy: Recycle 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 [root@k8s-master k8s-yaml]# cat statefulset-zk.yaml apiVersion: v1 kind: Service metadata: name: zk-hs labels: app: zk spec: ports: - port: 2888 name: server - port: 3888 name: leader-election clusterIP: None selector: app: zk --- apiVersion: v1 kind: Service metadata: name: zk-cs labels: app: zk spec: ports: - port: 2181 name: client selector: app: zk --- apiVersion: policy/v1beta1 kind: PodDisruptionBudget metadata: name: zk-pdb spec: selector: matchLabels: app: zk maxUnavailable: 1 --- apiVersion: apps/v1 kind: StatefulSet metadata: name: zk spec: selector: matchLabels: app: zk serviceName: zk-hs replicas: 3 updateStrategy: type: RollingUpdate podManagementPolicy: OrderedReady template: metadata: labels: app: zk spec: affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: \u0026#34;app\u0026#34; operator: In values: - zk topologyKey: \u0026#34;kubernetes.io/hostname\u0026#34; containers: - name: kubernetes-zookeeper imagePullPolicy: IfNotPresent image: k8s.gcr.io/kubernetes-zookeeper:1.0-3.4.10 resources: requests: memory: \u0026#34;1Gi\u0026#34; cpu: \u0026#34;0.5\u0026#34; ports: - containerPort: 2181 name: client - containerPort: 2888 name: server - containerPort: 3888 name: leader-election command: - sh - -c - \u0026#34;start-zookeeper \\ --servers=3 \\ --data_dir=/var/lib/zookeeper/data \\ --data_log_dir=/var/lib/zookeeper/data/log \\ --conf_dir=/opt/zookeeper/conf \\ --client_port=2181 \\ --election_port=3888 \\ --server_port=2888 \\ --tick_time=2000 \\ --init_limit=10 \\ --sync_limit=5 \\ --heap=512M \\ --max_client_cnxns=60 \\ --snap_retain_count=3 \\ --purge_interval=12 \\ --max_session_timeout=40000 \\ --min_session_timeout=4000 \\ --log_level=INFO\u0026#34; readinessProbe: exec: command: - sh - -c - \u0026#34;zookeeper-ready 2181\u0026#34; initialDelaySeconds: 10 timeoutSeconds: 5 livenessProbe: exec: command: - sh - -c - \u0026#34;zookeeper-ready 2181\u0026#34; initialDelaySeconds: 10 timeoutSeconds: 5 volumeMounts: - name: datadir mountPath: /var/lib/zookeeper securityContext: # runAsUser: 1000 fsGroup: 1000 volumeClaimTemplates: - metadata: name: datadir spec: accessModes: [ \u0026#34;ReadWriteOnce\u0026#34; ] resources: requests: storage: 1Gi æ–¹æ³•äºŒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 apiVersion: v1 kind: Service metadata: name: zk-hs namespace: uat labels: app: zk spec: ports: - port: 2888 name: server - port: 3888 name: leader-election clusterIP: None selector: app: zk --- apiVersion: v1 kind: Service metadata: name: zk-cs namespace: uat labels: app: zk spec: ports: - port: 2181 name: client selector: app: zk --- apiVersion: policy/v1beta1 kind: PodDisruptionBudget metadata: name: zk-pdb namespace: uat spec: selector: matchLabels: app: zk maxUnavailable: 1 --- apiVersion: apps/v1 kind: StatefulSet metadata: name: zk namespace: uat spec: selector: matchLabels: app: zk serviceName: zk-hs replicas: 3 updateStrategy: type: RollingUpdate podManagementPolicy: OrderedReady template: metadata: labels: app: zk spec: nodeSelector: env: uat containers: - name: kubernetes-zookeeper imagePullPolicy: IfNotPresent image: k8s.gcr.io/kubernetes-zookeeper:1.0-3.4.10 resources: requests: memory: \u0026#34;1Gi\u0026#34; cpu: \u0026#34;0.5\u0026#34; ports: - containerPort: 2181 name: client - containerPort: 2888 name: server - containerPort: 3888 name: leader-election command: - sh - -c - \u0026#34;start-zookeeper \\ --servers=3 \\ --data_dir=/var/lib/zookeeper/data/${HOSTNAME} \\ --data_log_dir=/var/lib/zookeeper/data/${HOSTNAME}/log \\ --conf_dir=/opt/zookeeper/conf \\ --client_port=2181 \\ --election_port=3888 \\ --server_port=2888 \\ --tick_time=2000 \\ --init_limit=10 \\ --sync_limit=5 \\ --heap=512M \\ --max_client_cnxns=60 \\ --snap_retain_count=3 \\ --purge_interval=12 \\ --max_session_timeout=40000 \\ --min_session_timeout=4000 \\ --log_level=INFO\u0026#34; readinessProbe: exec: command: - sh - -c - \u0026#34;zookeeper-ready 2181\u0026#34; initialDelaySeconds: 10 timeoutSeconds: 5 livenessProbe: exec: command: - sh - -c - \u0026#34;zookeeper-ready 2181\u0026#34; initialDelaySeconds: 10 timeoutSeconds: 5 volumeMounts: - name: datadir mountPath: /var/lib/zookeeper - name: host-time mountPath: /etc/localtime # securityContext: # runAsUser: 0 # fsGroup: 0 volumes: - name: datadir hostPath: path: /store/logs/uat/zk type: DirectoryOrCreate - name: host-time hostPath: path: /etc/localtime ","date":"2021-10-14T18:07:59Z","image":"https://www.ownit.top/title_pic/65.jpg","permalink":"https://www.ownit.top/p/202110141807/","title":"Kuberneteså®‰è£…zookeeperé›†ç¾¤"},{"content":"èƒŒæ™¯ç¯å¢ƒï¼š\nå¼€å‘é¢‘ç¹æŸ¥çœ‹æ—¥å¿—ï¼Œç™»å½•æœåŠ¡å™¨å¯¼å‡ºæ—¥å¿—æ¯”è¾ƒè€—è´¹æ—¶é—´ï¼Œæ­å»ºä¸€æ¬¾è½»é‡åˆç®€å•çš„æ—¥å¿—æŸ¥è¯¢å·¥å…·ä¾›å¼€\nå‘æŸ¥è¯¢å®¹å™¨æ—¥å¿—ã€‚\næ–¹æ¡ˆé€‰å‹ï¼š\nï¼ˆ1ï¼‰ELKï¼ˆEFKï¼‰é€‚ç”¨äºæ—¥å¿—ä½“ç³»æ¯”è¾ƒå¤§çš„åœºæ™¯ï¼Œä¸”æ¯”è¾ƒæ¶ˆè€—æœåŠ¡å™¨èµ„æºã€‚\nï¼ˆ2ï¼‰Loki\u0026mdash;-\u0026gt;è½»é‡çº§ï¼ˆç‰¹ç‚¹ï¼šç®€æ´æ˜äº†ï¼Œå®‰è£…éƒ¨ç½²ç®€å•ï¼‰\u0026mdash;\u0026ndash;\u0026gt;é€‚ç”¨äºå½“å‰ç¯å¢ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 #1.å®‰è£…helm é¦–å…ˆå®‰è£…helmç®¡ç†å·¥å…·ï¼ˆå®˜ç½‘ï¼‰ï¼šhttps://helm.sh/docs/intro/install/ [root@k8s-node01 ~]# wget https://get.helm.sh/helm-v3.3.3-linux-amd64.tar.gz [root@k8s-node01 ~]# tar xf helm-v3.3.3-linux-amd64.tar.gz [root@k8s-node01 ~]# mv linux-amd64/helm /usr/local/bin/helm [root@k8s-node01 ~]# helm version version.BuildInfo{Version:\u0026#34;v3.3.3\u0026#34;, GitCommit:\u0026#34;55e3ca022e40fe200fbc855938995f40b2a68ce0\u0026#34;, GitTreeState:\u0026#34;clean\u0026#34;, GoVersion:\u0026#34;go1.14.9\u0026#34;} [root@k8s-node01 ~]# mkdir loki [root@k8s-node01 ~]# ls anaconda-ks.cfg helm-v3.3.3-linux-amd64.tar.gz linux-amd64 loki thirdservice [root@k8s-node01 ~]# cd loki/ [root@k8s-node01 loki]# helm repo add loki https://grafana.github.io/loki/charts \u0026amp;\u0026amp; helm repo update [root@k8s-node01 loki]# helm pull loki/loki-stack [root@k8s-node01 loki]# tar xf loki-stack-2.1.2.tgz [root@k8s-node01 loki]# helm install loki -n loki loki-stack/ #åˆ›å»ºgrafanaæ–‡ä»¶ [root@k8s-node01 loki]# cat grangfan.yaml apiVersion: apps/v1 kind: Deployment metadata: name: grafana labels: app: grafana spec: replicas: 1 selector: matchLabels: app: grafana template: metadata: labels: app: grafana spec: containers: - name: grafana image: grafana/grafana:latest volumeMounts: - name: timezone mountPath: /etc/localtime volumes: - name: timezone hostPath: path: /usr/share/zoneinfo/Asia/Shanghai --- apiVersion: v1 kind: Service metadata: name: grafana-svc #namespace: test spec: ports: - port: 3000 targetPort: 3000 nodePort: 3303 type: NodePort selector: app: grafana æµè§ˆå™¨è®¿é—® IP:3003 è´¦å·å¯†ç ï¼šadmin admin\næ•°æ®æºé…ç½®\nloki:3100Â å®¹å™¨æ—¥å¿—æŸ¥è¯¢Â ä¾æ¬¡ç‚¹å‡»å®æ—¶æŸ¥çœ‹å®¹å™¨æ—¥å¿—Â æ•ˆæœå›¾\n","date":"2021-10-12T17:58:22Z","image":"https://www.ownit.top/title_pic/40.jpg","permalink":"https://www.ownit.top/p/202110121758/","title":"Kubernetesæ”¶é›†podçš„æ—¥å¿—"},{"content":"**ï¼ï¼ï¼ä¸­æ–‡ç¤¾åŒºä¸­è¯´çš„config.jsonçš„æ–¹å¼å·²ç»æ‰“ç®—è¢«åºŸå¼ƒäº†ï¼Œæ‰€ä»¥ç°åœ¨æœ€å¥½é€šè¿‡minioå®¢æˆ·ç«¯çš„æ–¹å¼è¿›è¡Œå¤„ç†äº†**\nÂ·Â åœ¨ç›®æ ‡mysqlåˆ›å»ºæ•°æ®åº“miniodbï¼ˆè¦ç”¨é»˜è®¤å­—ç¬¦é›†ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼‰\nÂ·Â åœ¨minio clientçš„å¯æ‰§è¡Œç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹æ˜¯å¦å·²ç»å­˜åœ¨é…ç½®\n1 mc --insecure admin config get minio notify_mysql æ·»åŠ Mysqlé€šçŸ¥é…ç½®\n1 mc admin config set minio notify_mysql:mysql table=\u0026#34;minio_log\u0026#34; dsn_string=\u0026#34;minio:minio@tcp(192.168.1.200:3306)/minio\u0026#34; æ­¥éª¤ï¼šå…ˆåˆ›å»ºminioçš„æ•°æ®åº“ï¼Œç¼–ç é»˜è®¤ä¸€ä¸‹ï¼Œåœ¨æ‰§è¡Œè¿™æ¡å‘½ä»¤ï¼Œä½†æ˜¯ä¼šæŠ¥é”™ã€‚\nå‘ç°æŠ¥é”™ï¼Œé”™è¯¯å¦‚ä¸‹ï¼š\n1 Error: Error 1071: Specified key was too long; max key length is 3072 bytes è§£å†³åŠæ³•ï¼šæ‰‹åŠ¨åˆ›å»ºè®°å½•è¡¨å°±å¯ä»¥äº†\n1 2 3 4 CREATE TABLE `minio_log` ( `key_name` varchar(1000) DEFAULT NULL, `value` longtext ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4; å…³è”eventäº‹ä»¶\n1 2 3 4 mc event add minio/k8s/ arn:minio:sqs::mysql:mysql æŸ¥çœ‹ mc event list minio/k8s/ é‡å¯serveræœåŠ¡ï¼Œç›´æ¥å‘½ä»¤é‡å¯\n1 mc admin service restart minio/k8s/ ","date":"2021-09-22T15:59:58Z","image":"https://www.ownit.top/title_pic/34.jpg","permalink":"https://www.ownit.top/p/202109221559/","title":"Minio--Mysqlå­˜å‚¨æ¡¶é€šçŸ¥é…ç½®"},{"content":"é›†ç¾¤å†…éƒ¨æ„å»ºä¸€å¥—Kubernetesé›†ç¾¤ï¼Œçº¯å†…ç½‘æ²¡æœ‰å…¬ç½‘ç¯å¢ƒï¼Œæ— æ³•æ‹‰å–é•œåƒï¼Œä¸æ˜¯å¾ˆæ–¹ä¾¿\nå‰æœŸåšæ³•ï¼Œæœ¬åœ°æ‹‰å»é•œåƒï¼Œä¿å­˜ï¼Œä¸Šä¼ å†…ç½‘ï¼ŒåŠ è½½ã€‚è¿™ä¸ªæ˜¯é’ˆå¯¹æ¯å°æœºå™¨çš„æ­¥éª¤ã€‚\næ­¥éª¤æ¯”è¾ƒç¹çï¼Œå’Œæœºæ¢°åŒ–ã€‚\næ‰€ä»¥å‡†å¤‡åœ¨å†…éƒ¨æ„å»ºharborï¼Œèµ°åŸŸåç»‘å®šã€‚dockeråŠ è½½é…ç½®ï¼ŒåæœŸå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚\n1ã€ç¯å¢ƒ Docker version 20.10.7\ndocker-compose version 1.29.2\nharbor-offline-installer-v2.3.1.tgz\nå†…ç½‘å®‰è£…ï¼Œæˆ‘é€‰æ‹©ç¦»çº¿ç‰ˆæœ¬çš„\nRelease v2.3.2 Â· goharbor/harbor Â· GitHub\n2ã€ç”Ÿæˆhttpsè¯ä¹¦ docker å’Œ docker-compose å·²ç»å®‰è£…å¥½ä¸‹è¿›è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 cd /opt/cert #è¾“å…¥å¯†ç  openssl genrsa -des3 -out server.pass.key 2048 #å»é™¤å¯†ç  openssl rsa -in server.pass.key -out server.key #ç”ŸæˆåŸŸåè¯ä¹¦ openssl req -new -key server.key -out server.csr -subj \u0026#34;/C=CN/ST=Jiangsu/L=Nanjing/O=Company/OU=group/CN=hub.docker.com\u0026#34; #ç”Ÿæˆæ—¶é—´å¤šä¹… openssl x509 -req -days 3650 -in server.csr -signkey server.key -out server.crt #ç”Ÿæˆpemçš„ï¼ˆå¯ä»¥è·³è¿‡ï¼‰ openssl x509 -in server.crt -out server.pem -outform PEM 3ã€å®‰è£…harbor è§£å‹æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 #å¤åˆ¶æ–°çš„é…ç½® [root@hdpv3test08 harbor]# cat harbor.yml # Configuration file of Harbor # The IP address or hostname to access admin UI and registry service. # DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients. hostname: hub.docker.com # http related config http: # port for http, default is 80. If https enabled, this port will redirect to https port port: 80 # https related config https: # https port for harbor, default is 443 port: 443 # The path of cert and key files for nginx certificate: /opt/cert/server.crt private_key: /opt/cert/server.key # # Uncomment following will enable tls communication between all harbor components # internal_tls: # # set enabled to true means internal tls is enabled # enabled: true # # put your cert and key files on dir # dir: /etc/harbor/tls/internal # Uncomment external_url if you want to enable external proxy # And when it enabled the hostname will no longer used # external_url: https://reg.mydomain.com:8433 # The initial password of Harbor admin # It only works in first time to install harbor # Remember Change the admin password from UI after launching Harbor. harbor_admin_password: Harbor12345 # Harbor DB configuration database: # The password for the root user of Harbor DB. Change this before any production use. password: root123 # The maximum number of connections in the idle connection pool. If it \u0026lt;=0, no idle connections are retained. max_idle_conns: 100 # The maximum number of open connections to the database. If it \u0026lt;= 0, then there is no limit on the number of open connections. # Note: the default number of connections is 1024 for postgres of harbor. max_open_conns: 900 # The default data volume data_volume: /data/service/harbor # Harbor Storage settings by default is using /data dir on local filesystem # Uncomment storage_service setting If you want to using external storage # storage_service: # # ca_bundle is the path to the custom root ca certificate, which will be injected into the truststore # # of registry\u0026#39;s and chart repository\u0026#39;s containers. This is usually needed when the user hosts a internal storage with self signed certificate. # ca_bundle: # # storage backend, default is filesystem, options include filesystem, azure, gcs, s3, swift and oss # # for more info about this configuration please refer https://docs.docker.com/registry/configuration/ # filesystem: # maxthreads: 100 # # set disable to true when you want to disable registry redirect # redirect: # disabled: false # Trivy configuration # # Trivy DB contains vulnerability information from NVD, Red Hat, and many other upstream vulnerability databases. # It is downloaded by Trivy from the GitHub release page https://github.com/aquasecurity/trivy-db/releases and cached # in the local file system. In addition, the database contains the update timestamp so Trivy can detect whether it # should download a newer version from the Internet or use the cached one. Currently, the database is updated every # 12 hours and published as a new release to GitHub. trivy: # ignoreUnfixed The flag to display only fixed vulnerabilities ignore_unfixed: false # skipUpdate The flag to enable or disable Trivy DB downloads from GitHub # # You might want to enable this flag in test or CI/CD environments to avoid GitHub rate limiting issues. # If the flag is enabled you have to download the `trivy-offline.tar.gz` archive manually, extract `trivy.db` and # `metadata.json` files and mount them in the `/home/scanner/.cache/trivy/db` path. skip_update: false # # insecure The flag to skip verifying registry certificate insecure: false # github_token The GitHub access token to download Trivy DB # # Anonymous downloads from GitHub are subject to the limit of 60 requests per hour. Normally such rate limit is enough # for production operations. If, for any reason, it\u0026#39;s not enough, you could increase the rate limit to 5000 # requests per hour by specifying the GitHub access token. For more details on GitHub rate limiting please consult # https://developer.github.com/v3/#rate-limiting # # You can create a GitHub token by following the instructions in # https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line # # github_token: xxx jobservice: # Maximum number of job workers in job service max_job_workers: 10 notification: # Maximum retry count for webhook job webhook_job_max_retry: 10 chart: # Change the value of absolute_url to enabled can enable absolute url in chart absolute_url: disabled # Log configurations log: # options are debug, info, warning, error, fatal level: info # configs for logs in local storage local: # Log files are rotated log_rotate_count times before being removed. If count is 0, old versions are removed rather than rotated. rotate_count: 50 # Log files are rotated only if they grow bigger than log_rotate_size bytes. If size is followed by k, the size is assumed to be in kilobytes. # If the M is used, the size is in megabytes, and if G is used, the size is in gigabytes. So size 100, size 100k, size 100M and size 100G # are all valid. rotate_size: 200M # The directory on your host that store log location: /var/log/harbor # Uncomment following lines to enable external syslog endpoint. # external_endpoint: # # protocol used to transmit log to external endpoint, options is tcp or udp # protocol: tcp # # The host of external endpoint # host: localhost # # Port of external endpoint # port: 5140 #This attribute is for migrator to detect the version of the .cfg file, DO NOT MODIFY! _version: 2.3.0 # Uncomment external_database if using external database. # external_database: # harbor: # host: harbor_db_host # port: harbor_db_port # db_name: harbor_db_name # username: harbor_db_username # password: harbor_db_password # ssl_mode: disable # max_idle_conns: 2 # max_open_conns: 0 # notary_signer: # host: notary_signer_db_host # port: notary_signer_db_port # db_name: notary_signer_db_name # username: notary_signer_db_username # password: notary_signer_db_password # ssl_mode: disable # notary_server: # host: notary_server_db_host # port: notary_server_db_port # db_name: notary_server_db_name # username: notary_server_db_username # password: notary_server_db_password # ssl_mode: disable # Uncomment external_redis if using external Redis server # external_redis: # # support redis, redis+sentinel # # host for redis: \u0026lt;host_redis\u0026gt;:\u0026lt;port_redis\u0026gt; # # host for redis+sentinel: # # \u0026lt;host_sentinel1\u0026gt;:\u0026lt;port_sentinel1\u0026gt;,\u0026lt;host_sentinel2\u0026gt;:\u0026lt;port_sentinel2\u0026gt;,\u0026lt;host_sentinel3\u0026gt;:\u0026lt;port_sentinel3\u0026gt; # host: redis:6379 # password: # # sentinel_master_set must be set to support redis+sentinel # #sentinel_master_set: # # db_index 0 is for core, it\u0026#39;s unchangeable # registry_db_index: 1 # jobservice_db_index: 2 # chartmuseum_db_index: 3 # trivy_db_index: 5 # idle_timeout_seconds: 30 # Uncomment uaa for trusting the certificate of uaa instance that is hosted via self-signed cert. # uaa: # ca_file: /path/to/ca # Global proxy # Config http proxy for components, e.g. http://my.proxy.com:3128 # Components doesn\u0026#39;t need to connect to each others via http proxy. # Remove component from `components` array if want disable proxy # for it. If you want use proxy for replication, MUST enable proxy # for core and jobservice, and set `http_proxy` and `https_proxy`. # Add domain to the `no_proxy` field, when you want disable proxy # for some special registry. proxy: http_proxy: https_proxy: no_proxy: components: - core - jobservice - trivy # metric: # enabled: false # port: 9090 # path: /metrics å®‰è£…\n1 2 ./prepare ./install.sh --with-notary --with-trivy --with-chartmuseum å®‰è£…å®Œå°±æˆåŠŸ\n4ã€é…ç½®æœ¬åœ°åŸŸå ç”±äºæ˜¯å†…ç½‘ï¼Œæˆ‘ä»¬éœ€è¦å†™å…¥hostsæ–‡ä»¶ï¼Œé…ç½®æœ¬åœ°åŸŸå\n1 2 3 4 [root@hdpv3test08 harbor]# cat /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 172.17.9.47 hub.docker.com 5ã€é…ç½®docker ç»™dockæ·»åŠ ä»“åº“ï¼Œæˆ‘ä»¬è‡ªå»ºçš„ï¼Œéœ€è¦æ·»åŠ åˆ°é…ç½®é‡Œé¢\n1 2 3 4 5 [root@hdpv3test08 harbor]# cat /etc/docker/daemon.json { \u0026#34;insecure-registries\u0026#34;:[\u0026#34;hub.docker.com\u0026#34;] } [ å¡«åŠ å®Œéœ€è¦é‡å¯ï¼Œä½†æ˜¯ç”±äºå·²ç»å®¹å™¨ï¼Œé‡å¯ä¼šç…§æˆå½±å“ï¼Œæˆ‘ä»¬å¯ä»¥çƒ­åŠ è½½\nçƒ­åŠ è½½\n1 2 3 4 [root@hdpv3test08 harbor]# ps -ef | grep docker root 81995 1 0 9æœˆ15 ? 00:04:03 /usr/bin/dockerd [root@hdpv3test08 harbor]# kill -HUP 81995 è¿™ä¸ªå°±æ˜¯çƒ­åŠ è½½ 6ã€æµ‹è¯• 1 docker login hub.docker.com -u admin -p Harbor12345 ","date":"2021-09-16T14:18:55Z","image":"https://www.ownit.top/title_pic/66.jpg","permalink":"https://www.ownit.top/p/202109161418/","title":"ä¼ä¸šçº§-çº¯å†…ç½‘æ„å»ºHarbor ï¼ˆHTTPSè®¤è¯ï¼‰"},{"content":"é”™è¯¯ ä»Šå¤©ä¸çŸ¥é“æ€ä¹ˆå›äº‹ï¼Œä¸€å°æœºå™¨çš„calico-nodeæŠ¥é”™ï¼Œä¹Ÿå°±æ˜¯æ— æ³•åˆå§‹åŒ–æ­£å¸¸\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 45s default-scheduler Successfully assigned kube-system/calico-node-pkbkv to k8s-node2 Normal Started 45s kubelet Started container install-cni Normal Pulled 45s kubelet Container image \u0026#34;docker.io/calico/cni:v3.20.0\u0026#34; already present on machine Normal Started 45s kubelet Started container upgrade-ipam Normal Pulled 45s kubelet Container image \u0026#34;docker.io/calico/cni:v3.20.0\u0026#34; already present on machine Normal Created 45s kubelet Created container install-cni Normal Created 45s kubelet Created container upgrade-ipam Normal Started 44s kubelet Started container flexvol-driver Normal Pulled 44s kubelet Container image \u0026#34;docker.io/calico/pod2daemon-flexvol:v3.20.0\u0026#34; already present on machine Normal Created 44s kubelet Created container flexvol-driver Normal Pulled 43s kubelet Container image \u0026#34;docker.io/calico/node:v3.20.0\u0026#34; already present on machine Normal Created 43s kubelet Created container calico-node Normal Started 43s kubelet Started container calico-node Warning Unhealthy 40s kubelet Readiness probe failed: calico/node is not ready: BIRD is not ready: Error querying BIRD: unable to connect to BIRDv4 socket: dial unix /var/run/calico/bird.ctl: connect: connection refused Warning Unhealthy 30s kubelet Readiness probe failed: 2021-09-15 02:36:49.282 [INFO][417] confd/health.go 180: Number of node(s) with BGP peering established = 0 calico/node is not ready: BIRD is not ready: BGP not established with 172.17.6.120,172.17.6.121,172.17.6.122 Warning Unhealthy 20s kubelet Readiness probe failed: 2021-09-15 02:36:59.282 [INFO][497] confd/health.go 180: Number of node(s) with BGP peering established = 0 calico/node is not ready: BIRD is not ready: BGP not established with 172.17.6.120,172.17.6.121,172.17.6.122 Warning Unhealthy 10s kubelet Readiness probe failed: 2021-09-15 02:37:09.280 [INFO][567] confd/health.go 180: Number of node(s) with BGP peering established = 0 calico/node is not ready: BIRD is not ready: BGP not established with 172.17.6.120,172.17.6.121,172.17.6.122 è§£å†³åŠæ³• 1 2 3 4 5 Remove interfaces related to docker and flannel: ip link For each interface for docker or flannel, do the following ifconfig \u0026lt;name of interface from ip link\u0026gt; down ip link delete \u0026lt;name of interface from ip link\u0026gt; ç§»é™¤è¿™å°ä¸»æœºå¤šä½™çš„dockerç½‘å¡å’Œcalico\nç„¶åä»é‡æ–°åˆ é™¤è¿™ä¸ªé”™è¯¯podçš„ï¼Œå°±ä¼šæ¢å¤æ­£å¸¸\n","date":"2021-09-15T10:56:40Z","image":"https://www.ownit.top/title_pic/12.jpg","permalink":"https://www.ownit.top/p/202109151056/","title":"calico-node æŠ¥é”™calico/node is not ready- BIRD is not ready- BGP not established with"},{"content":"prometheusæŠ¥è­¦è§„åˆ™ï¼Œæ˜¯ç”±promsqlè¯­å¥ç¼–å†™ç»„åˆçš„ï¼Œä½†æ˜¯æœ‰æ—¶è¯­å¥ä¼šå¾ˆé•¿ï¼Œæˆ‘ä»¬çœ‹è¿˜å¥½ï¼Œä½†æ˜¯æœ‰æ—¶é—´ä¸šåŠ¡ç»„é‚£è¾¹ä¹Ÿä¼šä½¿ç”¨promsqlæ¥çœ‹ä¸»æœºåé«˜çš„æŒ‡æ ‡ï¼Œè¿™è¾¹åªèƒ½è®¾ç½®åˆ«åï¼Œæ–¹ä¾¿ä»–ä»¬ä½¿ç”¨ã€‚\nåˆ«åè®¾ç½®ï¼š\nå¾ˆç®€å•ï¼Œä¹Ÿæ˜¯å’ŒæŠ¥è­¦è§„åˆ™ä¸€æ ·ï¼Œä½†æ˜¯è¯­æ³•å¯èƒ½ä¸ä¸€æ ·\nç¤ºä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@hdpv3test08 rules]# cat prometheus_rules_name.yml groups: - name: alive rules: - record: node:ping:total expr: up - name: cpu rules: - record: node:cpu_usage:ratio #åˆ«çš„æ–‡ä»¶ä½¿ç”¨ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ª expr: ((100 - (avg by(instance,ip,hostname) (irate(node_cpu_seconds_total{mode=\u0026#34;idle\u0026#34;}[5m])) * 100))) - name: mem rules: - record: node:memory_usage:ratio expr: (100 -(node_memory_MemTotal_bytes -node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes ) / node_memory_MemTotal_bytes * 100 ) node:cpu_usage:ratio å°±æ˜¯æŸ¥çœ‹cpuä½¿ç”¨ç‡çš„æŒ‡æ ‡\nä¸‹é¢ä¸¤å¼ å›¾å°±æ˜¯åŒºåˆ«\næˆ‘ä»¬æ­£å¸¸ä½¿ç”¨ï¼Œå°±æ˜¯ç›´æ¥é‡‡ç”¨è¿™ä¸ªåˆ«åæŒ‡æ ‡äº†\nä¸šåŠ¡ç»„ä½¿ç”¨\nprometheusæ”¯æŒpromsqlè¯­æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç›¸å…³è¯­å¥ï¼Œå¾ˆå¿«å®šä½åˆ°é›†ç¾¤ï¼Œèµ„æºä½¿ç”¨æƒ…å†µ\nå¦‚ï¼šé«˜CPU é«˜å†…å­˜ï¼Œå‡ºå…¥æµé‡å¤§ï¼Œ tcpè¿æ¥æ•°å¤šç­‰ç­‰ä¸€äº›åˆ—é—®é¢˜ã€‚\nä¸»æœºé‡å¯\ndelta(node_boot_time_seconds[5m]) != 0\næ–‡ä»¶åªè¯»å¼‚å¸¸\nnode_filesystem_readonly == 1\nCPU****ä½¿ç”¨ç‡\n((100 - (avg by(instance,ip,hostname) (irate(node_cpu_seconds_total{mode=\u0026ldquo;idle\u0026rdquo;}[5m])) * 100)))\nå†…å­˜ä½¿ç”¨ç‡\n(100 -(node_memory_MemTotal_bytes -node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes ) / node_memory_MemTotal_bytes * 100 )\nIO****æ€§èƒ½\n100-(avg(irate(node_disk_io_time_seconds_total[5m])) by(instance,hostname)* 100) \u0026lt; 40\nç£ç›˜ä½¿ç”¨ç‡\n100-(node_filesystem_free_bytes{fstype=~\u0026ldquo;ext4|xfs\u0026rdquo;}/node_filesystem_size_bytes {fstype=~\u0026ldquo;ext4|xfs\u0026rdquo;}*100) \u0026gt; 80\nä¸»æœºç½‘ç»œIOé€Ÿç‡\nå…¥é€Ÿç‡(MiB/s)\nirate(node_network_receive_bytes_total{}[5m]) / 1024 / 1024\nå‡ºé€Ÿç‡(MiB/s)\nirate(node_network_transmit_bytes_total{}[5m]) / 1024 / 1024\nä¸»æœºç£ç›˜IO\nå†™é€Ÿç‡(MiB/s)\nirate(node_disk_written_bytes_total{}[5m]) / 1024 / 1024\nè¯»é€Ÿç‡(MiB/s)\nirate(node_disk_read_bytes_total{}[5m]) / 1024 / 1024\nTCP****è¿æ¥æ•°\nnode_netstat_Tcp_CurrEstab\n","date":"2021-09-12T13:02:43Z","image":"https://www.ownit.top/title_pic/04.jpg","permalink":"https://www.ownit.top/p/202109121302/","title":"PrometheusæŠ¥è­¦è§„åˆ™åˆ«åè®¾ç½®"},{"content":"ä»¥ä¸‹æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­prometheus.rules.ymlå‘Šè­¦è§„åˆ™ç”¨ä¾‹\nprometheusé»˜è®¤çš„instanceæ˜¯ip:portæ ¼å¼çš„ï¼Œæ— æ³•çŸ¥é“ä¸»æœºåã€‚\næ–¹æ³•ä¸€ï¼šnode_uname_infoè·å– å‚è€ƒé“¾æ¥ï¼šhttps://blog.csdn.net/CHEndorid/article/details/106820612\nä¸»æœºåï¼ˆnodenameï¼‰åœ¨æŒ‡æ ‡node_uname_infoä¸­ï¼Œä¸”node_uname_infoçš„å€¼æ°å·§ä¸º1ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨PromQLä¸­é€šè¿‡node_uname_infoæå–ï¼Œåªéœ€è¦åœ¨åŸæœ‰PromQLåæ·»åŠ \n1 * on(instance) group_left(nodename) (node_uname_info) è¿™æ ·ï¼Œåœ¨prometheuså‘Šè­¦çš„labelsä¸­ï¼Œå°±å¯ä»¥é€šè¿‡nodenameè·å–ä¸»æœºåäº†\nç‰¹åˆ«çš„ï¼Œup==0çš„å€¼æ˜¯0ï¼Œåšä¹˜æ³•æ˜¯ä¸ä¼šå¾—åˆ°ç»“æœçš„\nç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 - alert: cpuä½¿ç”¨ç‡è¿‡é«˜å‘Šè­¦ expr: (100 - (avg(irate(node_cpu_seconds_total{mode=\u0026#34;idle\u0026#34;}[5m])) by(instance)* 100))* on(instance) group_left(nodename) (node_uname_info) \u0026gt; 85 for: 5m labels: region: æˆéƒ½ annotations: summary: \u0026#34;{{$labels.instance}}ï¼ˆ{{$labels.nodename}}ï¼‰CPUä½¿ç”¨ç‡è¿‡é«˜ï¼\u0026#34; description: \u0026#39;æœåŠ¡å™¨{{$labels.instance}}ï¼ˆ{{$labels.nodename}}ï¼‰CPUä½¿ç”¨ç‡è¶…è¿‡85%(ç›®å‰ä½¿ç”¨:{{printf \u0026#34;%.2f\u0026#34; $value}}%)\u0026#39; æ–¹æ³•äºŒï¼šrelabel_configså¢åŠ ä¸»æœºåæ ‡ç­¾ æ­¤æ–¹æ³•ï¼Œå¯ä»¥é€‚åº”æ‰€æœ‰æŠ¥è­¦çš„è§„åˆ™\nåœ¨ prometheuså¢åŠ ä¸»æœºé…ç½®æ˜¯ï¼Œæ·»åŠ é…ç½®å³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 - job_name: \u0026#39;hadoop-test-exporter\u0026#39; consul_sd_configs: - server: \u0026#39;localhost:8500\u0026#39; services: [hadoop-test-exporter] relabel_configs: #æŠŠ__meta_consul_service_id æ˜ å°„ä¸»æœºå - source_labels: [__meta_consul_service_id] separator: ; regex: (.*) target_label: hostname replacement: $1 action: replace - source_labels: [__meta_consul_service_address] #æ˜ å°„ä¸»æœºIP separator: ; regex: (.*) target_label: ip replacement: $1 action: replace - source_labels: [\u0026#39;__meta_consul_tags\u0026#39;] #æ ¹æ®tagæ¥åŒ¹é…åˆ†ç»„ regex: \u0026#39;^.*,hadoop-test,.*$\u0026#39; action: keep ","date":"2021-09-12T12:51:59Z","image":"https://www.ownit.top/title_pic/04.jpg","permalink":"https://www.ownit.top/p/202109121251/","title":"Prometheusç›‘æ§ï¼Œç”Ÿäº§å¯ç”¨å‘Šè­¦è§„åˆ™ï¼ˆå¯è·å–ä¸»æœºåï¼‰"},{"content":"å‰æ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/heian_99/article/details/119874180\néœ€æ±‚ï¼šprometheusç›‘æ§å¤šå°ä¸»æœºæ—¶ï¼ŒåŸºäºè‡ªåŠ¨å‘ç°consulæ¨¡å—ï¼Œä¸»æœºå®‰è£…é‡‡é›†å™¨æ³¨å†Œåˆ°é‚£å°consulï¼Œconsulè¯†åˆ«åˆ°ã€‚promethuesè·å–consulåœ°å€ä¸Šçš„ç›‘æ§ä¸»æœºåˆ—è¡¨ï¼Œå®ç°å¤šå°ä¸»æœºè‡ªåŠ¨å‘ç°ã€‚\næ€è·¯ï¼š\nwebæœºå™¨å®‰è£…node_exporteré‡‡é›†å™¨\n2.æ³¨å†Œnode_exporterä¸ºç³»ç»ŸæœåŠ¡\n3.ä½¿ç”¨curl -x PUT \u0026hellip; æ³¨å†Œåˆ°consulæœºå™¨ä¸­\n4.consulç›‘æ§åˆ°åï¼Œprometheusé…ç½®consulåœ°å€ã€‚\n1-3æ­¥éƒ½å¯ç”¨ansibleæ‰¹é‡å®Œæˆã€‚ node_exoporterè½¯ä»¶åŒ… ï¼ŒsystemæœåŠ¡é…ç½®æ–‡ä»¶ï¼Œæ³¨å†Œè„šæœ¬ï¼Œæ³¨å†Œæ¥å£\nå¦‚æœæœ‰å¯†ç éªŒè¯è¿˜éœ€è¦ä¸€ä¸ªconfig.yml\nconsul-register.sh æ³¨å†Œè„šæœ¬(ä¼ å‚æ–¹å¼æ³¨å†Œ)ï¼š\n1 2 3 4 5 6 7 #!/bin/bash service_name=$1 instance_id=$2 ip=$3 port=$4 curl -X PUT -d \u0026#39;{\u0026#34;id\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$instance_id\u0026#34;\u0026#39;\u0026#34;,\u0026#34;name\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$service_name\u0026#34;\u0026#39;\u0026#34;,\u0026#34;address\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$ip\u0026#34;\u0026#39;\u0026#34;,\u0026#34;port\u0026#34;: \u0026#39;\u0026#34;$port\u0026#34;\u0026#39;,\u0026#34;tags\u0026#34;: [\u0026#34;\u0026#39;\u0026#34;$service_name\u0026#34;\u0026#39;\u0026#34;],\u0026#34;checks\u0026#34;: [{\u0026#34;http\u0026#34;: \u0026#34;http://\u0026#39;\u0026#34;$ip\u0026#34;\u0026#39;:\u0026#39;\u0026#34;$port\u0026#34;\u0026#39;\u0026#34;,\u0026#34;interval\u0026#34;: \u0026#34;5s\u0026#34;}]}\u0026#39; http://10.10.10.27:8500/v1/agent/service/register node_exporter.service node_exporterç³»ç»ŸæœåŠ¡é…ç½®æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [heian@zabbix ~]$ cat node_exporter.service [Unit] Description=node_exporter After=network.target [Service] ExecStart=/usr/local/node_exporter/node_exporter\\ --web.listen-address=:9100\\ --collector.systemd\\ --collector.systemd.unit-whitelist=(sshd|nginx).service\\ --collector.processes\\ --collector.tcpstat\\ --collector.supervisord [Install] WantedBy=multi-user.target --collector.systemd --collector.systemd.unit-include=(docker|portal|sshd).service é…ç½®çš„æ„æ€æ˜¯åªæ”¶é›†docker,portal,sshdæœåŠ¡çš„æ•°æ® --web.config=/usr/local/jiankong/node_exporter/config.yml å¦‚æœæœ‰å¯†ç éªŒè¯æ¥å£éœ€è¦æŒ‡å®šè¿™ä¸ªconfig.ymlï¼Œé‡Œé¢ä¿å­˜çš„ç”¨æˆ·åå’Œå¯†ç ã€‚éœ€è¦æŠŠè¿™æ¡é…åœ¨å¯åŠ¨execstartè¡Œçš„node_proteråã€‚ ansible-playbook 1 2 3 4 cat hosts [blog] 10.10.10.15 name=nginx 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 cat playbook.yml - hosts: blog remote_user: heian become: yes become_user: root become_method: sudo gather_facts: no tasks: - name: æ¨é€é‡‡é›†å™¨å®‰è£…åŒ… unarchive: src=node_exporter-1.2.2.linux-amd64.tar.gz dest=/usr/local/ - name: é‡å‘½å shell: | cd /usr/local/ if [ ! -d node_exporter ];then mv node_exporter-1.2.2.linux-amd64 node_exporter fi - name: æ¨é€systemæ–‡ä»¶ copy: src=node_exporter.service dest=/usr/lib/systemd/system - name: å¯åŠ¨æœåŠ¡ systemd: name=node_exporter state=started enabled=yes - name: æ¨é€æ³¨å†Œè„šæœ¬ copy: src=consul-register.sh dest=/usr/local/node_exporter - name: æ³¨å†Œå½“å‰èŠ‚ç‚¹ shell: /bin/sh /usr/local/node_exporter/consul-register.sh {{ group_names[0] }} {{ name }} {{ inventory_hostname }} 9100 {{ group_names[0] }} \u0026ndash;ansibleå†…ç½®å˜é‡ ä»£è¡¨hostsä¸­è‡ªå®šä¹‰ç»„åï¼Œæ•°ç»„å½¢å¼ï¼Œ[0]å–ç¬¬ä¸€ä¸ª\n{{ name }} \u0026ndash; hostsæ–‡ä»¶ä¸­å®šä¹‰ä¸»æœºçš„åå­—ï¼Œå¦‚name=web1\n{{ inventory_hostname }} å½“å‰æ‰§è¡Œä¸»æœºçš„ip\næ‰§è¡Œï¼š\nçœ‹ä¸€ä¸‹consulä¸­ï¼ŒæœåŠ¡å·²ç»æ³¨å†Œè¿›æ¥äº†Â prometheusè‡ªåŠ¨å‘ç° å‚è€ƒæ–‡æ¡£åœ°å€ï¼šhttps://www.jianshu.com/p/f243a3aec18e\n","date":"2021-08-23T19:25:59Z","image":"https://www.ownit.top/title_pic/65.jpg","permalink":"https://www.ownit.top/p/202108231925/","title":"Ansibleæ‰¹é‡éƒ¨ç½²å®¢æˆ·ç«¯å¹¶æ³¨å†Œconsulè‡ªåŠ¨å‘ç°"},{"content":" ä¸€ã€ ç®€ä»‹ prometheusé…ç½®æ–‡ä»¶ prometheus.yml é‡Œé…ç½®éœ€è¦ç›‘å¬çš„æœåŠ¡æ—¶ï¼Œæ˜¯æŒ‰æœåŠ¡åå†™æ­»çš„ï¼Œå¦‚æœåé¢å¢åŠ äº†èŠ‚ç‚¹æˆ–è€…ç»„ä»¶ä¿¡æ¯ï¼Œå°±å¾—æ‰‹åŠ¨ä¿®æ”¹æ­¤é…ç½®ï¼Œå¹¶é‡å¯ promethuesï¼›é‚£ä¹ˆèƒ½å¦åŠ¨æ€çš„ç›‘å¬å¾®æœåŠ¡å‘¢ï¼ŸPrometheus æä¾›äº†å¤šç§åŠ¨æ€æœåŠ¡å‘ç°çš„åŠŸèƒ½ï¼Œè¿™é‡Œä»¥ consul ä¸ºä¾‹ã€‚\näºŒã€å¼•å…¥ consul çš„å¥½å¤„ åœ¨æ²¡æœ‰ä½¿ç”¨ consul æœåŠ¡è‡ªåŠ¨å‘ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦é¢‘ç¹å¯¹ Prometheus é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œæ— ç–‘ç»™è¿ç»´äººå‘˜å¸¦æ¥å¾ˆå¤§çš„è´Ÿæ‹…ã€‚å¼•å…¥consulä¹‹åï¼Œåªéœ€è¦åœ¨consulä¸­ç»´æŠ¤ç›‘æ§ç»„ä»¶é…ç½®ï¼Œprometheuså°±èƒ½å¤ŸåŠ¨æ€å‘ç°é…ç½®äº†ã€‚\nä¸‰ã€Prometheus æ”¯æŒçš„å¤šç§æœåŠ¡å‘ç°æœºåˆ¶ 1 2 3 4 5 6 7 8 9 #Prometheusæ•°æ®æºçš„é…ç½®ä¸»è¦åˆ†ä¸ºé™æ€é…ç½®å’ŒåŠ¨æ€å‘ç°, å¸¸ç”¨çš„ä¸ºä»¥ä¸‹å‡ ç±»: 1ï¼‰static_configs: #é™æ€æœåŠ¡å‘ç° 2ï¼‰file_sd_configs: #æ–‡ä»¶æœåŠ¡å‘ç° 3ï¼‰dns_sd_configs: DNS #æœåŠ¡å‘ç° 4ï¼‰kubernetes_sd_configs: #Kubernetes æœåŠ¡å‘ç° 5ï¼‰consul_sd_configs: Consul #æœåŠ¡å‘ç° ... #åœ¨ç›‘æ§kubernetesçš„åº”ç”¨åœºæ™¯ä¸­ï¼Œé¢‘ç¹æ›´æ–°çš„podï¼Œsvcï¼Œç­‰ç­‰èµ„æºé…ç½®åº”è¯¥æ˜¯æœ€èƒ½ä½“ç°Prometheusç›‘æ§ç›®æ ‡è‡ªåŠ¨å‘ç°æœåŠ¡çš„å¥½å¤„ å››ã€å®‰è£…å•èŠ‚ç‚¹consul ä¸‹è½½consulæ–‡ä»¶\nhttps://www.consul.io/downloads\n1 2 3 4 5 6 7 8 9 10 11 è§£å‹ ç§»åŠ¨ ç»™æƒé™ æŸ¥çœ‹ç‰ˆ consul --version Consul v1.10.1 Revision db839f18b Protocol 2 spoken by default, understands 2 to 3 (agent will automatically use protocol \u0026gt;2 when speaking to compatible agents) æ•°æ®æŒä¹…åŒ–\n1 mkdir -p /app/consul/data å¯åŠ¨å‘½ä»¤\n1 2 å¯åŠ¨å‘½ä»¤ nohup consul agent -server -data-dir=/app/consul/data -node=agent-one -bind=172.17.9.47 -bootstrap-expect=1 -client=0.0.0.0 -ui \u0026gt; /app/consul/consul.log 2\u0026gt;\u0026amp;1 \u0026amp; ç®€å•å•æœºç‰ˆå·²ç»å®Œæˆã€‚\nå¤æ‚ç‚¹çš„æœ‰é›†ç¾¤ç‰ˆï¼Œè´¦å·å£ä»¤è®¤è¯ç­‰ç­‰ï¼Œç›¸å…³å‚è€ƒæ–‡æ¡£\nhttps://www.k8stech.net/post/prom-discovery-consul/\nå¤§ä½¬ç‰ˆæœ¬è®²è§£çœŸçš„æ˜¯å¥½\näº”ã€æ³¨å†Œä¸»æœºåˆ°consul ç”±äºæœºå™¨æ¯”è¾ƒå¤šï¼Œéœ€è¦æ‰¹é‡æ·»åŠ \nconsulä¸»è¦æ˜¯æ·»åŠ å’Œåˆ é™¤å‘½ä»¤ï¼Œéƒ½æ˜¯ä½¿ç”¨æ¥å£è°ƒç”¨\n1 2 3 4 5 6 åˆ é™¤ curl -X PUT http://172.17.9.47:8500/v1/agent/service/deregister/dam02 æ·»åŠ  curl -X PUT -d \u0026#39;{\u0026#34;id\u0026#34;: \u0026#34;\u0026#39;${host_name}\u0026#39;\u0026#34;,\u0026#34;name\u0026#34;: \u0026#34;node-exporter\u0026#34;,\u0026#34;address\u0026#34;: \u0026#34;\u0026#39;${host_addr}\u0026#39;\u0026#34;,\u0026#34;port\u0026#34;:9100,\u0026#34;tags\u0026#34;: [\u0026#34;dam\u0026#34;],\u0026#34;checks\u0026#34;: [{\u0026#34;http\u0026#34;: \u0026#34;http://\u0026#39;${host_addr}\u0026#39;:9100/\u0026#34;,\u0026#34;interval\u0026#34;: \u0026#34;5s\u0026#34;}]}\u0026#39; http://172.17.9.47:8500/v1/agent/service/register æ‰¹é‡æ·»åŠ å¯ä»¥ä½¿ç”¨ä¸‹é¢è„šæœ¬\n1 2 3 4 hostsæ–‡ä»¶æ ¼å¼ dam01 172.17.8.227 dam02 172.17.8.228 1 2 3 4 5 6 $ cat registry.sh # è„šæœ¬å†…å®¹å¦‚ä¸‹ #!/bin/bash while read host_name host_addr do curl -X PUT -d \u0026#39;{\u0026#34;id\u0026#34;: \u0026#34;\u0026#39;${host_name}\u0026#39;\u0026#34;,\u0026#34;name\u0026#34;: \u0026#34;node-exporter\u0026#34;,\u0026#34;address\u0026#34;: \u0026#34;\u0026#39;${host_addr}\u0026#39;\u0026#34;,\u0026#34;port\u0026#34;:9100,\u0026#34;tags\u0026#34;: [\u0026#34;dam\u0026#34;],\u0026#34;checks\u0026#34;: [{\u0026#34;http\u0026#34;: \u0026#34;http://\u0026#39;${host_addr}\u0026#39;:9100/\u0026#34;,\u0026#34;interval\u0026#34;: \u0026#34;15s\u0026#34;}]}\u0026#39; http://172.17.9.47:8500/v1/agent/service/register done \u0026lt; hosts æ‰§è¡Œè¿™ä¸ªè„šæœ¬ï¼Œå°±å¯ä»¥æ‰¹é‡æ·»åŠ ä¸»æœºåˆ°consulé‡Œé¢å»ã€‚\nå…­ã€é…ç½®prometheusè‡ªåŠ¨å‘ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 cat /usr/local/prometheus/prometheus.yml #ç±»ä¼¼ä¸‹é¢æ ¼å¼ è¿™ä¸ªserverä¸ºconsulçš„åœ°å€ï¼Œæ ¹æ®æ ‡ç­¾åŒ¹é…ç»„ - job_name: \u0026#39;dam-exporter\u0026#39; consul_sd_configs: - server: \u0026#39;localhost:8500\u0026#39; services: [dam-exporter] #å¤æ‚ä¸€ç‚¹ï¼Œéœ€è¦æ­£åˆ™è¡¨è¾¾å¼ - job_name: dam-exporter honor_labels: true metrics_path: /metrics scheme: http consul_sd_configs: - server: 172.17.9.47:8500 services: [dam-exporter] relabel_configs: - source_labels: [\u0026#39;__meta_consul_tags\u0026#39;] target_label: \u0026#39;product\u0026#39; - source_labels: [\u0026#39;__meta_consul_dc\u0026#39;] target_label: \u0026#39;idc\u0026#39; - source_labels: [\u0026#39;product\u0026#39;] regex: \u0026#34;,dam-exporter,\u0026#34; action: keep é‡å¯prometheuså°±è‡ªåŠ¨å‘ç°æˆåŠŸï¼Œå¹¶ä¸”å¯ä»¥é‡‡é›†æ•°æ®ã€‚\n","date":"2021-08-23T17:49:43Z","image":"https://www.ownit.top/title_pic/73.jpg","permalink":"https://www.ownit.top/p/202108231749/","title":"PrometheusåŸºäºconsulä¸­å¿ƒè‡ªåŠ¨å‘ç°æ³¨å†Œç›‘æ§"},{"content":"å‰æï¼š è¿‘æœŸä¸šåŠ¡åšäº†é›†ç¾¤çš„æµé‡æ±‡æ€»ï¼Œæ•´ä½“æ²¡æœ‰é—®é¢˜ã€‚åé¢æ…¢æ…¢ä¼˜åŒ–ä¸€äº›å‚æ•°é¡¹ã€‚ä½†æ˜¯è¿™ä¸¤å¤©å‘ç°ï¼Œé›†ç¾¤æµé‡æ•°æ®å¢å¤§ï¼Œä¸šåŠ¡æ­£å¸¸ã€‚\né—®é¢˜ï¼š zabbixå’Œprometheus ç›‘æ§ç½‘å¡ï¼Œæµé‡å¼‚å¸¸å¢å¤§ï¼Œè¶…å‡ºé™åˆ¶ï¼Œæ¯æ¬¡2åˆ†é’Ÿï¼Œå¶å°”æ€§è§¦å‘\nçœ‹å›¾ï¼Œè¿™ä¸ªå’Œ7æœˆå¯¹æ¯”ï¼Œç®€ä»‹ç¿»äº†å‡ å€ï¼Œä½†æ˜¯ä¸šåŠ¡æ²¡æœ‰å¢é•¿ï¼Œè¿™å°±å¾ˆå¥‡æ€ªäº†\nä¸Šé¢ä»‹ç»ç›¸å…³æˆªå›¾ã€‚\nè§£å†³ï¼š é¦–å…ˆä»¥ä¸ºä¸šåŠ¡å¯¼è‡´ç½‘å¡è¿‡å¤§åŠ è½½ï¼Œå¯¼è‡´æµé‡å¢å¤§ï¼Œæˆ‘ä»¬ä½¿ç”¨Â ifstat-1.1.tar.gzÂ å·¥å…·è®°å½•æ¯ä¸€ç§’çš„ç½‘å¡é€Ÿåº¦ï¼Œè®°å½•ä¸€æ™šä¸Šå†çœ‹ã€‚\nåˆ†æä¸Šå›¾ï¼Œè™½ç„¶æµé‡æœ‰è¶…è¿‡100Mçš„ï¼Œä½†æ˜¯ç½‘å¡æ˜¯èƒ½å¤Ÿæ”¯æ’‘çš„ã€‚æ²¡æœ‰zabbixå’Œprometheusæ˜¾ç¤ºçš„é‚£ä¹ˆææ€–ã€‚\næ€è€ƒ æˆ‘å’Œå¤§ä½¬åˆ†äº¤æµä¸€ä¸‹ã€‚è¯´æ˜¯zabbixçš„å•ä½è½¬æ¢ï¼Œè¦åŠ 8å€ï¼Œæˆ‘ä¹Ÿæ˜¯æ·»åŠ äº†çš„\nå—¯ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚æ­£å¸¸\nå¤§ä½¬å»ºè®®è®©æˆ‘ä½¿ç”¨snmpç›‘æ§å¯¹æ¯”ä¸€ä¸‹ï¼Œæ€è·¯ä¸é”™ï¼Œå¯ä»¥æã€‚ç›´æ¥éƒ¨ç½²ä¸Šå»å¯¹æ¯”äº†\nåˆ†æ snmpå¯¹æ¯”ä¸€ä¸‹\nzabbixçš„ï¼ˆè¿˜æ˜¯è¿™ä¹ˆé«˜ï¼‰\nsnmpçš„ï¼ˆè¿™ä¸ªæ˜¯æ­£å¸¸çš„ï¼‰\nå¾ˆæ˜æ˜¾ï¼Œè¿™æ˜¯snmpæ˜¯å‡†ç¡®çš„ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆä¼šè¿™æ ·\nç»“æœï¼š é¦–å…ˆï¼Œä¸šåŠ¡æ­£å¸¸ï¼ŒæœåŠ¡å™¨æ­£å¸¸ï¼Œç°åœ¨å°±æ˜¯zabbixä¸æ­£å¸¸ï¼Œæ€€ç–‘æ˜¯zabbixçš„é—®é¢˜\nå›æƒ³ä¸€ä¸‹ï¼Œåœ¨æ•°æ®é‡å¢åŠ å‰åšäº†ä»€ä¹ˆæ“ä½œã€‚\nä¹‹å‰ï¼Œæˆ‘å½“æ—¶å¢åŠ ä¸€æ‰¹ç›‘æ§æŒ‡æ ‡ï¼Œå› ä¸ºç›‘æ§ç‚¹æ¯”è¾ƒé‡è¦ï¼Œæ‰€æœ‰è®¾ç½®æŠ“å–æ—¶é—´ä¸º10sã€‚è°çŸ¥é“è¿™ä¸ª10så°±æ˜¯ç½ªé­ç¥¸é¦–ã€‚é›†ç¾¤å†…éƒ¨æœºå™¨è¾ƒå¤šï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ•°æ®ç§¯å‹ã€‚\nåç»­ å–æ¶ˆå…³è”æ¨¡æ¿ï¼Œç›‘æ§æ•´ä½“æµé‡ï¼Œç¡®å®šæ— è™šå‡æµé‡\nè°ƒæ•´ç›‘æ§é¡¹çš„æŠ“å–æŒ‡æ ‡ä¸ºï¼š1mÂ å†æ¬¡å…³è”æ¨¡æ¿æ­£å¸¸\n","date":"2021-08-20T16:01:39Z","image":"https://www.ownit.top/title_pic/53.jpg","permalink":"https://www.ownit.top/p/202108201601/","title":"Zabbixç›‘æ§æµé‡å¼‚å¸¸ï¼ˆå¶å°”è¶…å‡ºäº¤æ¢æœºé™åˆ¶ï¼‰"},{"content":"é—®é¢˜éœ€æ±‚ å…¬å¸æœ‰å°ä¸šåŠ¡æœåŠ¡å™¨ï¼Œä¸Šé¢æœ‰å¤šä¸ªç”¨æˆ·ï¼Œä½†æ˜¯è¿™å°æœºå™¨æ— æ³•ä½¿ç”¨scp ï¼Œsftp ï¼Œå’Œftpç­‰ä¼ è¾“å·¥å…·ï¼ˆå› ä¸ºå®‰å…¨é—®é¢˜ï¼Œä¸èƒ½å¯¹å¤–å…¬å¼€ä¼ è¾“æ•°æ®æ¸ é“ï¼‰\nä½†æ˜¯ï¼Œè¿™äº›åŠŸèƒ½ç¦ç”¨åï¼Œæ€ä¹ˆå¾€ä¸Šé¢ä¼ è¾“æ–‡ä»¶ï¼Œå¶å°”æœ‰äº›ç”¨æˆ·éœ€è¦å¾€ä¸Šé¢ä¼ ç¨‹åºï¼Œè¿™ä¸ªå°±æ˜¯å¾ˆå¤´ç–¼çš„é—®é¢˜ã€‚\nè§£å†³æ–¹æ¡ˆï¼š é‡‡ç”¨vsftpå·¥å…·ï¼Œæ„å»ºæœ¬æœºç”¨æˆ·ç™»å½•ï¼Œä½¿ç”¨ç™½åå•ï¼Œå¯¹ç‰¹å®šç”¨æˆ·ä½¿ç”¨ï¼Œè¿è¡Œä¸Šä¼ ï¼Œä¸èƒ½ä¸‹è½½\nå®ç°æ–¹æ³•ï¼š ç¯å¢ƒæ˜¯çº¯å†…ç½‘ï¼šé¦–å…ˆæ‰¾vsftpå®‰è£…åŒ…\n1 2 3 4 yum install yum-utils -y #ä¸‹è½½rpmåŒ…çš„å·¥å…· yumdownloader vsftpd --resolve --destdir=/root/rpm #ä½¿ç”¨è¿™ä¸ªä¸‹è½½vsftpåŒ…å’Œä¾èµ– ä¸‹è½½å®Œæˆï¼Œä¸Šä¼ æœåŠ¡å™¨ç›´æ¥å®‰è£…\n1 rpm -ivh vsftpd-3.0.2-29.el7_9.x86_64.rpm 1 2 3 4 ä¸»é…ç½®æ–‡ä»¶ï¼š/etc/vsftpd/vsftpd.conf é…ç½®æ–‡ä»¶ç›®å½•ï¼š/etc/vsftpd/*.conf æœåŠ¡å¯åŠ¨è„šæœ¬ï¼š/etc/rc.d/init.d/vsftpd ç”¨æˆ·è®¤è¯é…ç½®æ–‡ä»¶ï¼š/etc/pam.d/vsftpd é…ç½®å‚æ•°\nå¸¸ç”¨é…ç½®å‚æ•°éƒ½ä¸ºä¸»é…ç½®æ–‡ä»¶ï¼Œ/etc/vsftpd/vsftpd.conf çš„å¸¸ç”¨é…ç½®ã€‚\né€šç”¨åŸºç¡€é…ç½®\n1 2 3 4 5 6 7 8 9 listen=[YES|NO] #æ˜¯å¦ä»¥ç‹¬ç«‹è¿è¡Œçš„æ–¹å¼ç›‘å¬æœåŠ¡ listen_address=IPåœ°å€ #è®¾ç½®è¦ç›‘å¬çš„ IP åœ°å€ listen_port=21 #è®¾ç½® FTP æœåŠ¡çš„ç›‘å¬ç«¯å£ download_enableï¼[YES|NO] #æ˜¯å¦å…è®¸ä¸‹è½½æ–‡ä»¶ max_clients=0 #æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°ï¼Œ0 ä¸ºä¸é™åˆ¶ max_per_ip=0 #åŒä¸€ IP åœ°å€çš„æœ€å¤§è¿æ¥æ•°ï¼Œ0 ä¸ºä¸é™åˆ¶ chown_uploads=[YES|NO] #æ˜¯å¦å…è®¸æ”¹å˜ä¸Šä¼ æ–‡ä»¶çš„å±ä¸» chown_username=whoever #æ”¹å˜ä¸Šä¼ æ–‡ä»¶çš„å±ä¸»ä¸º whoever pam_service_name=vsftpd #è®© vsftpd ä½¿ç”¨ pam å®Œæˆç”¨æˆ·è®¤è¯ï¼Œä½¿ç”¨çš„æ–‡ä»¶ä¸º/etc/pam.d/vsftpd ç³»ç»Ÿç”¨æˆ·çš„é…ç½®\n1 2 3 4 5 6 7 8 9 10 11 anonymous_enable=NO #ç¦æ­¢åŒ¿åè®¿é—®æ¨¡å¼ local_enable=[YES|NO] #æ˜¯å¦å…è®¸æœ¬åœ°ç”¨æˆ·ç™»å½• FTP write_enable=[YES|NO] #æ˜¯å¦å¼€æ”¾æœ¬åœ°ç”¨æˆ·çš„å…¶ä»–å†™å…¥æƒé™ local_umask=022 #æœ¬åœ°ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶çš„ umask å€¼ local_root=/var/ftp #æœ¬åœ°ç”¨æˆ·çš„ FTP æ ¹ç›®å½• local_max_rate=0 #æœ¬åœ°ç”¨æˆ·æœ€å¤§ä¼ è¾“é€Ÿç‡ï¼ˆå­—èŠ‚/ç§’ï¼‰ï¼Œ0 ä¸ºä¸é™åˆ¶ userlist_enable=[YES|NO] #å¼€å¯ç”¨æˆ·ä½œç”¨åå•æ–‡ä»¶åŠŸèƒ½ userlist_deny=[YES|NO] #å¯ç”¨ç¦æ­¢ç”¨æˆ·åå•ï¼Œåå•æ–‡ä»¶ä¸º ftpusers å’Œ/etc/vsftpd/user_list chroot_local_user=[YES|NO] #æ˜¯å¦å°†ç”¨æˆ·æƒé™ç¦é”¢åœ¨ FTP å®¶ç›®å½•ä¸­ï¼Œä»¥ç¡®ä¿å®‰å…¨ chroot_list_enable=[YES|NO] #ç¦é”¢æ–‡ä»¶ä¸­æŒ‡å®šçš„ FTP æœ¬åœ°ç”¨æˆ·äºå…¶å®¶ç›®å½•ä¸­ chroot_list_file=/etc/vsftpd/chroot_list #æŒ‡å®šç¦é”¢æ–‡ä»¶ä½ç½®ï¼Œéœ€è¦å’Œ chroot_list_enable ä¸€åŒ vsftpé…ç½® æˆ‘è¿™è¾¹ä¸ºäº†å®ç°å¯¹åº”åŠŸèƒ½ï¼Œé…ç½®å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 anonymous_enable=NO #ç¦æ­¢åŒ¿åç”¨æˆ·ç™»å½• local_enable=YES #æœ¬åœ°ç”¨æˆ· write_enable=YES download_enable=NO local_umask=022 chroot_list_enable=YES chroot_local_user=yes #å›ºå®šä¼ è¾“æ–‡ä»¶åœ¨å®¶ç›®å½• allow_writeable_chroot=YES userlist_enable=YES userlist_deny=NO userlist_file=/etc/vsftpd/user_list #ç™»å½•ç™½åå• dirmessage_enable=YES connect_from_port_20=YES listen=NO listen_ipv6=YES pam_service_name=vsftpd userlist_enable=YES tcp_wrappers=YES xferlog_enable=YES xferlog_std_format=YES /etc/vsftpd/user_list è¿™ä¸ªæ–‡ä»¶é‡Œé¢å†™å…¥å…è®¸ç™»å½•çš„ç”¨æˆ·å³å¯\nï¼ˆ1ï¼‰å…è®¸ç‰¹å®šç”¨æˆ·ç™»å½•\nï¼ˆ2ï¼‰å…è®¸ä¸Šä¼ ï¼Œç¦æ­¢ä¸‹è½½\nï¼ˆ3ï¼‰ç¦æ­¢è·³è½¬ç›®å½•ï¼Œåªå…è®¸è‡ªå·±å®¶ç›®å½•\nå‚è€ƒåœ°å€ï¼š\nhttps://zhuanlan.zhihu.com/p/354583347\nhttps://blog.csdn.net/weixin_30514745/article/details/98155033\nhttps://www.huaweicloud.com/articles/2cc1b07fa2841e3874e7b4f430b038af.html\n","date":"2021-08-10T21:58:25Z","image":"https://www.ownit.top/title_pic/16.jpg","permalink":"https://www.ownit.top/p/202108102158/","title":"vsftpç¦æ­¢ä¸‹è½½ï¼Œå…è®¸ä¸Šä¼ æ–‡ä»¶"},{"content":"ç›®å½•\nä¼ä¸šçº¯å†…ç½‘äºŒè¿›åˆ¶å®Œç¾éƒ¨ç½²Dockerï¼ˆ20.10.7ç‰ˆæœ¬ï¼‰\nDockerä¸‹è½½\nä¸Šä¼ è§£å‹\nsystemdç®¡ç†docker\næ™®é€šç”¨æˆ·ç®¡ç†Docker\nè‡ªå®šä¹‰ç½‘æ®µ\næ›´æ”¹å­˜å‚¨è·¯å¾„\nå¦‚æœæœ‰æ•°æ®\næ— æ•°æ®\nå¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨\ndockerå‘½ä»¤è¡¥å…¨æ–¹æ³•\n1.å¤åˆ¶æ–‡ä»¶\n2.å®‰è£…bash-completionÂ 3.åˆ·æ–°ç”Ÿæ•ˆ\n4ã€æµ‹è¯•\nä¼ä¸šçº¯å†…ç½‘äºŒè¿›åˆ¶å®Œç¾éƒ¨ç½²Dockerï¼ˆ20.10.7ç‰ˆæœ¬ï¼‰ è¿‘æœŸç”±äºå…¬å¸ä¸šåŠ¡éœ€æ±‚ï¼Œéœ€è¦ä½¿ç”¨åˆ°Dockerã€‚\nå¹³å¸¸æœ‰ç½‘ç¯å¢ƒï¼Œç›´æ¥yumå¯ä»¥å®‰è£…å®Œæˆã€‚ä½†æ˜¯ç”±äºæœåŠ¡å™¨åœ¨çº¯å†…ç½‘ç¯å¢ƒï¼Œæ— æ³•è®¿é—®å…¬ç½‘ï¼Œæ‰€æœ‰æ— æ³•åœ¨çº¿ç›´æ¥å®‰è£…Dockerï¼Œéœ€è¦å¦æƒ³æ–¹æ³•å®Œæˆéƒ¨ç½²å®‰è£…ã€‚\nï¼ˆ1ï¼‰æ‰¾ä¸€å°æœ‰ç½‘æœºå™¨ï¼Œä½¿ç”¨yumï¼ˆyumdownloaderï¼‰æŠŠdockeråŒ…å’Œä¾èµ–ä¸‹è½½ä¸‹æ¥ï¼Œä¸Šä¼ åœ¨å®‰è£…Â ï¼ˆ2ï¼‰äºŒè¿›åˆ¶å®‰è£…Dockerï¼ˆæ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯èƒ½æ›´å¥½ç†è§£å’Œç®¡ç†Dockerï¼Œæˆ‘é€‰æ‹©åè€…ï¼‰\nDockerä¸‹è½½ Dockerç‰ˆæœ¬ï¼š20.10.7\nDockerç‰ˆæœ¬ä¸‹è½½åœ°å€ï¼šhttps://download.docker.com/linux/static/stable/x86_64/\nä¸Šä¼ è§£å‹ 1 2 tar zxvf docker-20.10.7.tgz mv docker/* /usr/bin systemdç®¡ç†docker 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 cat \u0026gt; /usr/lib/systemd/system/docker.service \u0026lt;\u0026lt; EOF [Unit] Description=Docker Application Container Engine Documentation=https://docs.docker.com After=network-online.target firewalld.service Wants=network-online.target Requires=docker.socket [Service] Type=notify ExecStart=/usr/bin/dockerd ExecReload=/bin/kill -s HUP $MAINPID TimeoutSec=0 RestartSec=2 Restart=always StartLimitBurst=3 StartLimitInterval=60s LimitNOFILE=infinity LimitNPROC=infinity LimitCORE=infinity TasksMax=infinity Delegate=yes KillMode=process OOMScoreAdjust=-500 [Install] WantedBy=multi-user.target EOF 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 cat \u0026gt; /usr/lib/systemd/system/docker.socket \u0026lt;\u0026lt; EOF [Unit] Description=Docker Socket for the API [Socket] ListenStream=/var/run/docker.sock SocketMode=0660 SocketUser=root SocketGroup=docker [Install] WantedBy=sockets.target EOF æ™®é€šç”¨æˆ·ç®¡ç†Docker 1 2 3 4 groupadd docker #æ·»åŠ dockerç»„ï¼ŒäºŒè¿›åˆ¶ä¸ä¼šè‡ªåŠ¨æ·»åŠ çš„ï¼Œyumä¼š usermod -a -G docker user1 #æŠŠè¦ç®¡ç†çš„ç”¨æˆ·æ·»åŠ åˆ°ç»„é‡Œé¢å°±è¡Œ è¿™æ ·åœ¨dockerç»„çš„ç”¨æˆ·ï¼Œä¹Ÿæœ‰æƒé™ç®¡ç†dockerï¼Œè¿™è¾¹æ˜¯å› ä¸ºåœ¨docker.sockå®šä¹‰äº†ä»¥dockerç»„å¯åŠ¨\nè‡ªå®šä¹‰ç½‘æ®µ 1 2 3 4 5 6 7 mkdir /etc/docker cat \u0026gt; /etc/docker/daemon.json \u0026lt;\u0026lt; EOF { \u0026#34;bip\u0026#34;:\u0026#34;10.10.10.1/24\u0026#34; } EOF çº¯å†…ç½‘Docker-hubæ— æ³•ä½¿ç”¨ï¼Œè¿™é‡Œå°±å®šä¹‰ç½‘æ®µï¼Œå¯ç”¨åˆå§‹å°±ä¼šç›´æ¥å®šä¹‰ç½‘æ®µ\næ›´æ”¹å­˜å‚¨è·¯å¾„ dockerçš„é»˜è®¤è·¯å¾„æ˜¯/var/lib/docker\nä½†æ˜¯æœ‰æ—¶é—´è¿™ä¸ªç©ºé—´å¾ˆå°ï¼Œæˆ‘ä»¬éœ€è¦æŠŠç›®å½•è¿ç§»åˆ°è¶³å¤Ÿå¤§çš„ç£ç›˜ä¸‹\nå¦‚æœæœ‰æ•°æ® 1 2 3 4 5 6 systemctl stop docker mkdir /data/service/docker -p mv /var/lib/docker/* /data/service/docker/ #è¿ç§»æ•°æ® vim /usr/lib/systemd/system/docker.service ExecStart=/usr/bin/dockerd --graph /data/service/docker æ— æ•°æ® 1 2 3 4 mkdir /data/service/docker -p vim /usr/lib/systemd/system/docker.service ExecStart=/usr/bin/dockerd --graph /data/service/docker å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨ 1 2 3 systemctl daemon-reload systemctl start docker systemctl enable docker dockerå‘½ä»¤è¡¥å…¨æ–¹æ³• 1.å¤åˆ¶æ–‡ä»¶ é€šè¿‡yumå®‰è£…ç›¸åŒç‰ˆæœ¬çš„dockerã€‚å°† /usr/share/bash-completion/completions/docker æ–‡ä»¶æ‹·è´åˆ°äºŒè¿›åˆ¶å®‰è£…çš„dockeræœåŠ¡å™¨ä¸Šçš„ /usr/share/bash-completion/completions/ ç›®å½•ä¸‹\n2.å®‰è£…bash-completionÂ 1 yum install -y bash-completion 3.åˆ·æ–°ç”Ÿæ•ˆ 1 2 source /usr/share/bash-completion/completions/docker source /usr/share/bash-completion/bash_completion 4ã€æµ‹è¯• 1 2 3 4 5 6 7 [root@localhost ~]# docker attach context exec import logout port rm service system version build cp export info logs ps rmi stack tag volume builder create help inspect network pull run start top wait commit diff history kill node push save stats trust config engine image load pause rename search stop unpause container events images login plugin restart secret swarm update ","date":"2021-08-03T21:43:26Z","image":"https://www.ownit.top/title_pic/77.jpg","permalink":"https://www.ownit.top/p/202108032143/","title":"ä¼ä¸šçº¯å†…ç½‘äºŒè¿›åˆ¶å®Œç¾éƒ¨ç½²Dockerï¼ˆ20.10.7ç‰ˆæœ¬ï¼‰"},{"content":"å¸ƒç½²å®Œmetircs-serveråï¼Œä½†æ˜¯è®¿é—®ä¼šæŠ¥é”™ï¼Œæ­¤å¤„æœ‰ä¸¤ä¸ªå‘\n1ã€APIèšåˆåŠŸèƒ½ é€šè¿‡äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²å®ŒæˆÂ kubernetesÂ åï¼Œéƒ¨ç½²Â Metrics ServerÂ åï¼ŒæŸ¥çœ‹æ—¥å¿—å‡ºç°ä¸‹é¢é”™è¯¯ä¿¡æ¯ï¼š\n1 2 3 4 5 6 E1231 10:33:31.978715 1 configmap_cafile_content.go:243] key failed with: missing content for CA bundle \u0026#34;client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file\u0026#34; E1231 10:34:22.710836 1 configmap_cafile_content.go:243] kube-system/extension-apiserver-authentication failed with: missing content for CA bundle \u0026#34;client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file\u0026#34; E1231 10:34:31.978769 1 configmap_cafile_content.go:243] key failed with: missing content for CA bundle \u0026#34;client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file\u0026#34; æ ¹æ®é”™è¯¯æ—¥å¿—ä¿¡æ¯ï¼Œå¯ä»¥çŸ¥é“æ˜¯ç¼ºå°‘è®¤è¯çš„è¯ä¹¦æ–‡ä»¶ï¼Œå¯¼è‡´ä¸èƒ½è®¿é—®Â kube-apiserverÂ è€Œå‡ºç°çš„é—®é¢˜ã€‚\nå‡ºç°è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸º kube-apiserver æ²¡æœ‰å¼€å¯Â APIÂ èšåˆåŠŸèƒ½ã€‚æ‰€ä»¥éœ€è¦é…ç½®Â kube-apiserverÂ å‚æ•°ï¼Œå¼€å¯èšåˆåŠŸèƒ½å³å¯ã€‚\nä¸ºäº†èƒ½å¤Ÿå°†ç”¨æˆ·è‡ªå®šä¹‰çš„ API æ³¨å†Œåˆ°Â MasterÂ çš„Â API ServerÂ ä¸­ï¼Œé¦–å…ˆéœ€è¦åœ¨ Master èŠ‚ç‚¹æ‰€åœ¨æœåŠ¡å™¨ï¼Œé…ç½®Â kube-apiserverÂ åº”ç”¨çš„å¯åŠ¨å‚æ•°æ¥å¯ç”¨Â API èšåˆÂ åŠŸèƒ½ï¼Œå‚æ•°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 --runtime-config=api/all=true --requestheader-allowed-names=aggregator --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-client-ca-file=/etc/kubernetes/pki/ca.pem --proxy-client-cert-file=/etc/kubernetes/pki/proxy-client.pem --proxy-client-key-file=/etc/kubernetes/pki/proxy-client-key.pem å¦‚æœÂ kube-apiserverÂ æ‰€åœ¨çš„ä¸»æœºä¸Šæ²¡æœ‰è¿è¡ŒÂ kube-proxyï¼Œå³æ— æ³•é€šè¿‡æœåŠ¡çš„Â ClusterIPÂ è¿›è¡Œè®¿é—®ï¼Œé‚£ä¹ˆè¿˜éœ€è¦è®¾ç½®ä»¥ä¸‹å¯åŠ¨å‚æ•°ï¼š\n1 --enable-aggregator-routing=true åœ¨è®¾ç½®å®Œæˆé‡å¯Â kube-apiserverÂ æœåŠ¡ï¼Œå°±å¯ç”¨Â API èšåˆÂ åŠŸèƒ½äº†ã€‚\n1 systemctl daemon-reload \u0026amp;\u0026amp; systemctl restart kube-apiserver å¼€å¯APIèšåˆåŠŸèƒ½ æŒ‰ç…§ä¸Šé¢çš„è§£å†³é—®é¢˜æ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å¯ API èšåˆåŠŸèƒ½ï¼Œç„¶åé‡å¯ Metrics Server æœåŠ¡ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š\nå®‰è£… cfssl å·¥å…·\n1 2 3 4 5 6 7 8 ## ä¸‹è½½ä¸‰ä¸ªç»„ä»¶ $ wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O cfssl $ wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O cfssljson $ wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O cfssl-certinfo ## å¤åˆ¶åˆ° bin ç›®å½•ä¸‹ $ chmod +x ./cfssl* $ mv ./cfssl* /usr/local/bin/ åˆ›å»º cfssl é…ç½®æ–‡ä»¶ åˆ›å»º proxy-client-csr.json æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 { \u0026#34;CN\u0026#34;: \u0026#34;aggregator\u0026#34;, \u0026#34;hosts\u0026#34;: [], \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;BeiJing\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;BeiJing\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;system:masters\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;System\u0026#34; } ] } ç”Ÿæˆè¯ä¹¦å’Œç§˜é’¥ï¼š\n1 cfssl gencert -profile=kubernetes -ca=/etc/kubernetes/pki/ca.pem -ca-key=/etc/kubernetes/pki/ca-key.pem proxy-client-csr.json | cfssljson -bare kube-proxy 1 2 3 4 5 6 ls -l -rw-r--r-- 1 root root 1017 12æœˆ 31 11:20 proxy-client.csr -rw-r--r-- 1 root root 236 12æœˆ 31 11:07 proxy-client-csr.json -rw------- 1 root root 1675 12æœˆ 31 11:20 proxy-client-key.pem -rw-r--r-- 1 root root 1411 12æœˆ 31 11:20 proxy-client.pem å°†è¯ä¹¦è®¿é—®æŒ‡å®šçš„ç›®å½•ä¸‹ï¼Œè¿™é‡Œæˆ‘å°†å…¶æ”¾åˆ° /etc/kubernetes/pki ä¸‹ï¼š\n1 cp * /etc/kubernetes/pki/ ä¿®æ”¹ kube-apiserver å‚æ•°\n1 2 3 4 5 6 7 8 --runtime-config=api/all=true \\ --requestheader-allowed-names=aggregator \\ --requestheader-group-headers=X-Remote-Group \\ --requestheader-username-headers=X-Remote-User \\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\ --requestheader-client-ca-file=/etc/kubernetes/pki/ca.pem \\ --proxy-client-cert-file=/etc/kubernetes/pki/proxy-client.pem \\ --proxy-client-key-file=/etc/kubernetes/pki/proxy-client-key.pem \\ 1 2 3 4 5 6 7 8 9 10 11 å‚æ•°è¯´æ˜ï¼š â€“requestheader-client-ca-fileï¼š å®¢æˆ·ç«¯ CA è¯ä¹¦ã€‚ â€“requestheader-allowed-namesï¼š å…è®¸è®¿é—®çš„å®¢æˆ·ç«¯ common names åˆ—è¡¨ï¼Œé€šè¿‡ header ä¸­ â€“requestheader-username-headers å‚æ•°æŒ‡å®šçš„å­—æ®µè·å–ã€‚å®¢æˆ·ç«¯ common names çš„åç§°éœ€è¦åœ¨ client-ca-file ä¸­è¿›è¡Œè®¾ç½®ï¼Œå°†å…¶è®¾ç½®ä¸ºç©ºå€¼æ—¶ï¼Œè¡¨ç¤ºä»»æ„å®¢æˆ·ç«¯éƒ½å¯è®¿é—®ã€‚ â€“requestheader-username-headersï¼š å‚æ•°æŒ‡å®šçš„å­—æ®µè·å–ã€‚ â€“requestheader-extra-headers-prefixï¼š è¯·æ±‚å¤´ä¸­éœ€è¦æ£€æŸ¥çš„å‰ç¼€åã€‚ â€“requestheader-group-headers è¯·æ±‚å¤´ä¸­éœ€è¦æ£€æŸ¥çš„ç»„åã€‚ â€“requestheader-username-headers è¯·æ±‚å¤´ä¸­éœ€è¦æ£€æŸ¥çš„ç”¨æˆ·åã€‚ â€“proxy-client-cert-fileï¼š åœ¨è¯·æ±‚æœŸé—´éªŒè¯ Aggregator çš„å®¢æˆ·ç«¯ CA è¯ä¹¦ã€‚ â€“proxy-client-key-fileï¼š åœ¨è¯·æ±‚æœŸé—´éªŒè¯ Aggregator çš„å®¢æˆ·ç«¯ç§é’¥ã€‚ â€“requestheader-allowed-namesï¼š å…è®¸è®¿é—®çš„å®¢æˆ·ç«¯ common names åˆ—è¡¨ï¼Œé€šè¿‡ header ä¸­ â€“requestheader-username-headers å‚æ•°æŒ‡å®šçš„å­—æ®µè·å–ã€‚å®¢æˆ·ç«¯ common names çš„åç§°éœ€è¦åœ¨ client-ca-file ä¸­è¿›è¡Œè®¾ç½®ï¼Œå°†å…¶è®¾ç½®ä¸ºç©ºå€¼æ—¶ï¼Œè¡¨ç¤ºä»»æ„å®¢æˆ·ç«¯éƒ½å¯è®¿é—®ã€‚ é‡å¯ kube-apiserver ç»„ä»¶\n1 systemctl daemon-reload \u0026amp;\u0026amp; systemctl restart kube-apiserver 2ã€ç”¨æˆ·æ— æƒé™è®¿é—®èµ„æºpod æŠ¥é”™\n1 2 3 4 ^C[root@k8s-master cfg]# kubectl top pod -A Error from server (Forbidden): pods.metrics.k8s.io is forbidden: User \u0026#34;system:kube-proxy\u0026#34; cannot list resource \u0026#34;pods\u0026#34; in API group \u0026#34;metrics.k8s.io\u0026#34; at the cluster scope [root@k8s-master cfg]# kubectl top pod Error from server (Forbidden): pods.metrics.k8s.io is forbidden: User \u0026#34;system:kube-proxy\u0026#34; cannot list resource \u0026#34;pods\u0026#34; in API group \u0026#34;metrics.k8s.io\u0026#34; in the namespace \u0026#34;default\u0026#34; æŠ¥é”™æç¤ºä¸ºRBACæƒé™é—®é¢˜ï¼Œç»™kubernetesç”¨æˆ·æˆæƒå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 kind: Role apiVersion: rbac.authorization.k8s.io/v1 metadata: namespace: default name: metrics-reader rules: - apiGroups: [\u0026#34;metrics.k8s.io\u0026#34;] resources: [\u0026#34;pods\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;list\u0026#34;] - apiGroups: [\u0026#34;metrics.k8s.io\u0026#34;] resources: [\u0026#34;nodes\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;list\u0026#34;] --- kind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: read-pods namespace: default subjects: - kind: User name: system:kube-proxy #ç”¨æˆ·åç§° apiGroup: rbac.authorization.k8s.io roleRef: kind: Role name: metrics-reader apiGroup: rbac.authorization.k8s.io --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: metrics-reader rules: - apiGroups: [\u0026#34;metrics.k8s.io\u0026#34;] resources: [\u0026#34;pods\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;list\u0026#34;] - apiGroups: [\u0026#34;metrics.k8s.io\u0026#34;] resources: [\u0026#34;nodes\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;list\u0026#34;] --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRoleBinding metadata: name: metrics roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: metrics-reader subjects: - kind: User name: system:kube-proxy #ç”¨æˆ·åç§° apiGroup: rbac.authorization.k8s.io é—®é¢˜å°±è§£å†³\n","date":"2021-08-01T23:23:37Z","image":"https://www.ownit.top/title_pic/41.jpg","permalink":"https://www.ownit.top/p/202108012323/","title":"è§£å†³äºŒè¿›åˆ¶K8Så¸ƒç½²çš„metrics-serveræŸ¥çœ‹é›†ç¾¤èµ„æºæŠ¥é”™æƒé™é—®é¢˜"},{"content":"æœ€è¿‘å…¬å¸æœåŠ¡å™¨çš„ä¸€ä¸ªç£ç›˜å‡ºç°Read Onlyï¼Œå¯¼è‡´æ•°æ®ä¸å¯å†™ï¼Œä½†æ­¤æœåŠ¡å™¨å®‰è£…çš„zabbixç›‘æ§å¹¶æœªæŠ¥è­¦ï¼Œæ‰€ä»¥é’ˆå¯¹æ­¤æƒ…å†µï¼Œæ–°å¢äº†ç›‘æ§ç³»ç»Ÿç£ç›˜è¯»å†™çŠ¶æ€çš„ç›‘æ§ã€‚\nä¸‹é¢æ˜¯æ•ˆæœå›¾\nå¦‚æœè¿”å›å€¼0ä»£è¡¨ç£ç›˜éƒ½æ˜¯rwçŠ¶æ€å¯ä»¥æ­£å¸¸è¯»å†™ï¼Œè¿”å›å€¼1çš„è¯ï¼Œä»£è¡¨ç£ç›˜æ˜¯roçŠ¶æ€ï¼Œä¼šæŠ¥è­¦ã€‚\nå¦‚ä½•å®ç°ï¼š\nç›®æ ‡ ä½¿ç”¨zabbixç›‘æ§ç£ç›˜roæŒ‡æ ‡ï¼Œå¦‚æœå‘ç°roæ¨¡å¼ï¼ŒåŠæ—¶æŠ¥è­¦\n1 mount | grep -v \u0026#39;/sys/fs/cgroup\u0026#39; |awk \u0026#39;{print $NF}\u0026#39; |cut -c 2-3 |awk \u0026#39;{if($1~/ro/) {print 1}}\u0026#39;|wc -l|awk \u0026#39;{if($1\u0026lt;=0) {print 0 } else {print 1}}\u0026#39; ä½¿ç”¨è¿™ä¸ªç›‘æ§æ‰€æœ‰ç£ç›˜ï¼Œåˆ¤æ–­æ˜¯å¦åªè¯»æ¨¡å¼\nä¿®æ”¹zabbix_agentd.confæ–‡ä»¶ æ·»åŠ \n1 UserParameter=check_disk_status,/bin/mount | grep -v \u0026#39;/sys/fs/cgroup\u0026#39; |awk \u0026#39;{print $NF}\u0026#39; |cut -c 2-3 |awk \u0026#39;{if($1~/ro/) {print 1}}\u0026#39;|wc -l|awk \u0026#39;{if($1\u0026lt;=0) {print 0 } else {print 1}}\u0026#39; é‡å¯zabbixå®¢æˆ·ç«¯ 1 sh startup_zabbix_agentd.sh restart zabbixæœåŠ¡ç«¯æ·»åŠ ç›‘æ§é¡¹ zabbixæœåŠ¡ç«¯æ·»åŠ è§¦å‘å™¨ è¿™ä¸ªè§¦å‘å™¨æ˜¯æœ€è¿‘3æ¬¡æ£€æµ‹éƒ½å‡ºç°roçŠ¶æ€ï¼Œå°±ä¼šæŠ¥è­¦ã€‚\næµ‹è¯• ","date":"2021-08-01T12:34:05Z","image":"https://www.ownit.top/title_pic/68.jpg","permalink":"https://www.ownit.top/p/202108011234/","title":"zabbixä¼ä¸šåº”ç”¨ä¹‹ç›‘æ§ç£ç›˜è¯»å†™çŠ¶æ€"},{"content":"ä»Šå¤©æœºå™¨é‡å¯ï¼Œä½†æ˜¯ä»¥å‰åŠ çš„è‡ªå¯ä»»åŠ¡çš„è„šæœ¬æ²¡æœ‰æ‰§è¡Œ\nåŸå› ï¼š\nåœ¨centos7ä¸­,/etc/rc.d/rc.localæ–‡ä»¶çš„æƒé™è¢«é™ä½äº†,æ²¡æœ‰æ‰§è¡Œæƒé™,éœ€è¦ç»™å®ƒæ·»åŠ å¯æ‰§è¡Œæƒé™ã€‚\n1 chmod +x /etc/rc.d/rc.local ç„¶åå°±å¯ä»¥åœ¨é‡Œé¢æ·»åŠ ä½ è¦å¼€æœºè‡ªå¯çš„å‘½ä»¤äº†\n1 vi /etc/rc.d/rc.local ","date":"2021-07-26T16:39:52Z","image":"https://www.ownit.top/title_pic/34.jpg","permalink":"https://www.ownit.top/p/202107261639/","title":"Centos7 è‡ªå¯æ²¡æœ‰èµ·ä½œç”¨ï¼Ÿï¼Ÿï¼ˆrc.localï¼‰"},{"content":"ä»€ä¹ˆæ˜¯Portainer Portaineræ˜¯Dockerçš„å›¾å½¢åŒ–ç®¡ç†å·¥å…·ï¼Œæä¾›çŠ¶æ€æ˜¾ç¤ºé¢æ¿ã€åº”ç”¨æ¨¡æ¿å¿«é€Ÿéƒ¨ç½²ã€å®¹å™¨é•œåƒç½‘ç»œæ•°æ®å·çš„åŸºæœ¬æ“ä½œï¼ˆåŒ…æ‹¬ä¸Šä¼ ä¸‹è½½é•œåƒï¼Œåˆ›å»ºå®¹å™¨ç­‰æ“ä½œï¼‰ã€äº‹ä»¶æ—¥å¿—æ˜¾ç¤ºã€å®¹å™¨æ§åˆ¶å°æ“ä½œã€Swarmé›†ç¾¤å’ŒæœåŠ¡ç­‰é›†ä¸­ç®¡ç†å’Œæ“ä½œã€ç™»å½•ç”¨æˆ·ç®¡ç†å’Œæ§åˆ¶ç­‰åŠŸèƒ½ã€‚åŠŸèƒ½ååˆ†å…¨é¢ï¼ŒåŸºæœ¬èƒ½æ»¡è¶³ä¸­å°å‹å•ä½å¯¹å®¹å™¨ç®¡ç†çš„å…¨éƒ¨éœ€æ±‚ã€‚\næ±‰åŒ–ç•Œé¢ å®‰è£…Docker å¦‚æœå·²ç»å®‰è£…äº†Dockerç¯å¢ƒç›´æ¥è·³è¿‡æœ¬æ­¥éª¤å³å¯\n1 2 3 4 5 6 7 8 9 10 11 #CentOS 6 rpm -iUvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm yum update -y yum -y install docker-io service docker start chkconfig docker on #CentOS 7ã€Debianã€Ubuntu curl -sSL https://get.docker.com/ | sh systemctl start docker systemctl enable docker.service å®‰è£…Portainerç‰ˆæœ¬ï¼šÂ portainer-ce:2.0.1\næ±‰åŒ–åœ°å€ï¼šhttps://github.com/eysp/public/releases\næ­¤ç‰ˆæœ¬å·²ç»æµ‹è¯•ï¼Œæš‚æ— bugï¼Œå¯ä»¥æ­£å¸¸æ±‰åŒ–æ˜¾ç¤ºï¼Œæ¨è\nPortainerä¸­æ–‡æ±‰åŒ– 1 2 docker volume create portainer_data docker run -d -p 8000:8000 -p 9000:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce:2.0.1 è¿›å…¥è¿™ä¸ªç›®å½•æŠŠæ±‰åŒ–çš„æ–‡ä»¶å…¨éƒ¨è§£å‹è¦†ç›–åˆ°ï¼šÂ publicÂ ç›®å½•ä¸‹\n","date":"2021-07-25T23:24:21Z","image":"https://www.ownit.top/title_pic/23.jpg","permalink":"https://www.ownit.top/p/202107252324/","title":"Dockeré›†ç¾¤å¯è§†åŒ–ç®¡ç†å¹³å°ï¼ˆPortainerï¼‰"},{"content":"åœ¨Pythonä¸­å®ç°æ–‡ä»¶çš„è¯»å†™æ“ä½œå…¶å®éå¸¸ç®€å•ï¼Œé€šè¿‡Pythonå†…ç½®çš„openå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šæ–‡ä»¶åã€æ“ä½œæ¨¡å¼ã€ç¼–ç ä¿¡æ¯ç­‰æ¥è·å¾—æ“ä½œæ–‡ä»¶çš„å¯¹è±¡ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œäº†ã€‚è¿™é‡Œæ‰€è¯´çš„æ“ä½œæ¨¡å¼æ˜¯æŒ‡è¦æ‰“å¼€ä»€ä¹ˆæ ·çš„æ–‡ä»¶ï¼ˆå­—ç¬¦æ–‡ä»¶è¿˜æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ä»¥åŠåšä»€ä¹ˆæ ·çš„æ“ä½œï¼ˆè¯»ã€å†™è¿˜æ˜¯è¿½åŠ ï¼‰ï¼Œå…·ä½“çš„å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚\næ“ä½œæ¨¡å¼ å…·ä½“å«ä¹‰ 'r' è¯»å– ï¼ˆé»˜è®¤ï¼‰ 'w' å†™å…¥ï¼ˆä¼šå…ˆæˆªæ–­ä¹‹å‰çš„å†…å®¹ï¼‰ 'x' å†™å…¥ï¼Œå¦‚æœæ–‡ä»¶å·²ç»å­˜åœ¨ä¼šäº§ç”Ÿå¼‚å¸¸ 'a' è¿½åŠ ï¼Œå°†å†…å®¹å†™å…¥åˆ°å·²æœ‰æ–‡ä»¶çš„æœ«å°¾ 'b' äºŒè¿›åˆ¶æ¨¡å¼ 't' æ–‡æœ¬æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ '+' æ›´æ–°ï¼ˆæ—¢å¯ä»¥è¯»åˆå¯ä»¥å†™ï¼‰ Pythonæ–‡ä»¶å¤„ç†ï¼Œæ­£ç¡®æ ¼å¼ï¼Œé˜²æ­¢æœ‰å¼‚å¸¸ï¼Œæˆ‘ä»¬éœ€è¦åŠ ä¸ŠtryÂ except\næ ‡å‡†æ ¼å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 def main(): f = None try: f = open(\u0026#39;æ–‡ä»¶.txt\u0026#39;, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) print(f.read()) except FileNotFoundError: print(\u0026#39;æ— æ³•æ‰“å¼€æŒ‡å®šçš„æ–‡ä»¶!\u0026#39;) except LookupError: print(\u0026#39;æŒ‡å®šäº†æœªçŸ¥çš„ç¼–ç !\u0026#39;) except UnicodeDecodeError: print(\u0026#39;è¯»å–æ–‡ä»¶æ—¶è§£ç é”™è¯¯!\u0026#39;) finally: if f: f.close() if __name__ == \u0026#39;__main__\u0026#39;: main() åœ¨Pythonä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†é‚£äº›åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°çŠ¶å†µçš„ä»£ç æ”¾åœ¨tryä»£ç å—ä¸­ï¼Œåœ¨tryä»£ç å—çš„åé¢å¯ä»¥è·Ÿä¸Šä¸€ä¸ªæˆ–å¤šä¸ªexceptæ¥æ•è·å¯èƒ½å‡ºç°çš„å¼‚å¸¸çŠ¶å†µã€‚ä¾‹å¦‚åœ¨ä¸Šé¢è¯»å–æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œæ–‡ä»¶æ‰¾ä¸åˆ°ä¼šå¼•å‘FileNotFoundErrorï¼ŒæŒ‡å®šäº†æœªçŸ¥çš„ç¼–ç ä¼šå¼•å‘LookupErrorï¼Œè€Œå¦‚æœè¯»å–æ–‡ä»¶æ—¶æ— æ³•æŒ‰æŒ‡å®šæ–¹å¼è§£ç ä¼šå¼•å‘UnicodeDecodeErrorï¼Œæˆ‘ä»¬åœ¨tryåé¢è·Ÿä¸Šäº†ä¸‰ä¸ªexceptåˆ†åˆ«å¤„ç†è¿™ä¸‰ç§ä¸åŒçš„å¼‚å¸¸çŠ¶å†µã€‚æœ€åæˆ‘ä»¬ä½¿ç”¨finallyä»£ç å—æ¥å…³é—­æ‰“å¼€çš„æ–‡ä»¶ï¼Œé‡Šæ”¾æ‰ç¨‹åºä¸­è·å–çš„å¤–éƒ¨èµ„æºï¼Œç”±äºfinallyå—çš„ä»£ç ä¸è®ºç¨‹åºæ­£å¸¸è¿˜æ˜¯å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œåˆ°ï¼ˆç”šè‡³æ˜¯è°ƒç”¨äº†sysæ¨¡å—çš„exitå‡½æ•°é€€å‡ºPythonç¯å¢ƒï¼Œfinallyå—éƒ½ä¼šè¢«æ‰§è¡Œï¼Œå› ä¸ºexitå‡½æ•°å®è´¨ä¸Šæ˜¯å¼•å‘äº†SystemExitå¼‚å¸¸ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬é€šå¸¸æŠŠfinallyå—ç§°ä¸ºâ€œæ€»æ˜¯æ‰§è¡Œä»£ç å—â€ï¼Œå®ƒæœ€é€‚åˆç”¨æ¥åšé‡Šæ”¾å¤–éƒ¨èµ„æºçš„æ“ä½œã€‚å¦‚æœä¸æ„¿æ„åœ¨finallyä»£ç å—ä¸­å…³é—­æ–‡ä»¶å¯¹è±¡é‡Šæ”¾èµ„æºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡è¯­æ³•ï¼Œé€šè¿‡withå…³é”®å­—æŒ‡å®šæ–‡ä»¶å¯¹è±¡çš„ä¸Šä¸‹æ–‡ç¯å¢ƒå¹¶åœ¨ç¦»å¼€ä¸Šä¸‹æ–‡ç¯å¢ƒæ—¶è‡ªåŠ¨é‡Šæ”¾æ–‡ä»¶èµ„æºï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚\né™¤äº†ä½¿ç”¨æ–‡ä»¶å¯¹è±¡çš„readæ–¹æ³•è¯»å–æ–‡ä»¶ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨for-inå¾ªç¯é€è¡Œè¯»å–æˆ–è€…ç”¨readlinesæ–¹æ³•å°†æ–‡ä»¶æŒ‰è¡Œè¯»å–åˆ°ä¸€ä¸ªåˆ—è¡¨å®¹å™¨ä¸­ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import time def main(): # ä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶å†…å®¹ with open(\u0026#39;æ–‡ä»¶.txt\u0026#39;, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: print(f.read()) # é€šè¿‡for-inå¾ªç¯é€è¡Œè¯»å– with open(\u0026#39;æ–‡ä»¶.txt\u0026#39;, mode=\u0026#39;r\u0026#39;) as f: for line in f: print(line, end=\u0026#39;\u0026#39;) time.sleep(0.5) print() # è¯»å–æ–‡ä»¶æŒ‰è¡Œè¯»å–åˆ°åˆ—è¡¨ä¸­ with open(\u0026#39;æ–‡ä»¶.txt\u0026#39;) as f: lines = f.readlines() print(lines) if __name__ == \u0026#39;__main__\u0026#39;: main() é€šè¿‡ä¸Šé¢çš„è®²è§£ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•å°†æ–‡æœ¬æ•°æ®å’ŒäºŒè¿›åˆ¶æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå¸Œæœ›æŠŠä¸€ä¸ªåˆ—è¡¨æˆ–è€…ä¸€ä¸ªå­—å…¸ä¸­çš„æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶ä¸­åˆè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å°†æ•°æ®ä»¥JSONæ ¼å¼è¿›è¡Œä¿å­˜ã€‚JSONæ˜¯â€œJavaScript Object Notationâ€çš„ç¼©å†™ï¼Œå®ƒæœ¬æ¥æ˜¯JavaScriptè¯­è¨€ä¸­åˆ›å»ºå¯¹è±¡çš„ä¸€ç§å­—é¢é‡è¯­æ³•ï¼Œç°åœ¨å·²ç»è¢«å¹¿æ³›çš„åº”ç”¨äºè·¨å¹³å°è·¨è¯­è¨€çš„æ•°æ®äº¤æ¢ï¼ŒåŸå› å¾ˆç®€å•ï¼Œå› ä¸ºJSONä¹Ÿæ˜¯çº¯æ–‡æœ¬ï¼Œä»»ä½•ç³»ç»Ÿä»»ä½•ç¼–ç¨‹è¯­è¨€å¤„ç†çº¯æ–‡æœ¬éƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ç›®å‰JSONåŸºæœ¬ä¸Šå·²ç»å–ä»£äº†XMLä½œä¸ºå¼‚æ„ç³»ç»Ÿé—´äº¤æ¢æ•°æ®çš„äº‹å®æ ‡å‡†ã€‚å…³äºJSONçš„çŸ¥è¯†ï¼Œæ›´å¤šçš„å¯ä»¥å‚è€ƒJSONçš„å®˜æ–¹ç½‘ç«™ï¼Œä»è¿™ä¸ªç½‘ç«™ä¹Ÿå¯ä»¥äº†è§£åˆ°æ¯ç§è¯­è¨€å¤„ç†JSONæ•°æ®æ ¼å¼å¯ä»¥ä½¿ç”¨çš„å·¥å…·æˆ–ä¸‰æ–¹åº“ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªJSONçš„ç®€å•ä¾‹å­ã€‚\nä¸Šé¢çš„JSONè·ŸPythonä¸­çš„å­—å…¸å…¶å®æ˜¯ä¸€æ ·ä¸€æ ·çš„ï¼Œäº‹å®ä¸ŠJSONçš„æ•°æ®ç±»å‹å’ŒPythonçš„æ•°æ®ç±»å‹æ˜¯å¾ˆå®¹æ˜“æ‰¾åˆ°å¯¹åº”å…³ç³»çš„ï¼Œå¦‚ä¸‹é¢ä¸¤å¼ è¡¨æ‰€ç¤ºã€‚\nJSON Python object dict array list string str number (int / real) int / float true / false True / False null None 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import json def main(): mydict = { \u0026#39;name\u0026#39;: \u0026#39;å°é£\u0026#39;, \u0026#39;age\u0026#39;: 20, \u0026#39;qq\u0026#39;: 95849158, \u0026#39;friends\u0026#39;: [\u0026#39;å¼ ä¸‰\u0026#39;, \u0026#39;æå››\u0026#39;], \u0026#39;cars\u0026#39;: [ {\u0026#39;brand\u0026#39;: \u0026#39;BYD\u0026#39;, \u0026#39;max_speed\u0026#39;: 180}, {\u0026#39;brand\u0026#39;: \u0026#39;Audi\u0026#39;, \u0026#39;max_speed\u0026#39;: 280}, {\u0026#39;brand\u0026#39;: \u0026#39;Benz\u0026#39;, \u0026#39;max_speed\u0026#39;: 320} ] } try: with open(\u0026#39;data.json\u0026#39;, \u0026#39;w\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as fs: json.dump(mydict, fs) except IOError as e: print(e) print(\u0026#39;ä¿å­˜æ•°æ®å®Œæˆ!\u0026#39;) if __name__ == \u0026#39;__main__\u0026#39;: main() jsonæ¨¡å—ä¸»è¦æœ‰å››ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š\ndumpÂ - å°†Pythonå¯¹è±¡æŒ‰ç…§JSONæ ¼å¼åºåˆ—åŒ–åˆ°æ–‡ä»¶ä¸­ dumpsÂ - å°†Pythonå¯¹è±¡å¤„ç†æˆJSONæ ¼å¼çš„å­—ç¬¦ä¸² loadÂ - å°†æ–‡ä»¶ä¸­çš„JSONæ•°æ®ååºåˆ—åŒ–æˆå¯¹è±¡ loadsÂ - å°†å­—ç¬¦ä¸²çš„å†…å®¹ååºåˆ—åŒ–æˆPythonå¯¹è±¡ ","date":"2021-07-21T15:00:49Z","image":"https://www.ownit.top/title_pic/09.jpg","permalink":"https://www.ownit.top/p/202107211500/","title":"Pythonæ–‡ä»¶å¤„ç†"},{"content":"zabbixè°ƒç”¨apiæŸ¥è¯¢æœºå™¨èµ„æºåˆ©ç”¨ç‡ï¼Œå¯¼å‡ºexeclè¡¨æ ¼\nèƒŒæ™¯ï¼šå¹³å¸¸æˆ‘ä»¬å·¥ä½œä¸­ï¼Œéœ€è¦çŸ¥é“æœºå™¨çš„èµ„æºåˆ©ç”¨ç‡å¤šå°‘ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æŸ¥çœ‹ï¼Œä½†æ˜¯æœ‰1000å¤šå°æ”¹æ€ä¹ˆåŠï¼Ÿ\næ–¹æ¡ˆï¼šæˆ‘ä»¬æœºå™¨å¦‚æœæ˜¯zabbixç›‘æ§çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨zabbixçš„apiï¼Œæ¥è·å–æ‰€æœ‰ä¸»æœºçš„ç›¸å…³ä¿¡æ¯ï¼Œç”Ÿæˆexeclè¡¨æ ¼å¹¶ä¸”å¯¼å‡º\næˆ‘ä»¬å¯ä»¥è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼Œæ¯å‘¨å®šæ—¶å¯¼å‡ºï¼ŒæŸ¥çœ‹é›†ç¾¤æœåŠ¡å™¨çš„åˆ©ç”¨ç‡ã€‚Â githubåœ°å€ï¼šhttps://github.com/nangongchengfeng/zabbix-api.git\n1 2 3 4 5 6 if host[\u0026#39;Number of CPUs\u0026#39;] == \u0026#34;0\u0026#34;: HostItemValues.append(\u0026#34;å·²åœç”¨\u0026#34;) if float(host[\u0026#39;Load average (15m avg)\u0026#39;]) \u0026gt;= 10 or float(round(float(host[\u0026#39;CPU utilization\u0026#39;]), 2)) \u0026gt;= 20 : HostItemValues.append(\u0026#34;å¦\u0026#34;) else: HostItemValues.append(\u0026#34;æ˜¯\u0026#34;) æœ€åé¢æ·»åŠ æ˜¯å¦ä½è´Ÿè½½æœºå™¨\nåˆ¤æ–­æ¡ä»¶ï¼šCPUå¹³å‡è´Ÿè½½/15min \u0026gt;= 10 or CPUä½¿ç”¨ç‡ \u0026gt;=20\nZabbix-api_v1 Zabbix-api_v1ç‰ˆæœ¬æ˜¯åˆçº§ç‰ˆæœ¬ï¼Œéœ€è¦Pythonç¯å¢ƒä¸‹æ“ä½œ\nZabbix-api_v2 Zabbix-api_v2ç‰ˆæœ¬å¯ä»¥æ‰“åŒ…æˆexeç¨‹åºï¼Œå¯ä»¥æ–¹ä¾¿æ‰§è¡Œï¼Œä¸éœ€è¦ä¾èµ–\nè¿™é‡Œæˆ‘è´´ç‰ˆæœ¬2çš„ä»£ç ï¼Œå¯ä»¥ç”Ÿæˆexe\nmain.py 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 #! /usr/bin/env python import configparser import os,sys import time from GetItems import Zabbix from SaveToExcel import WriteExcel import datetime path = os.path.dirname(os.path.abspath(__file__)) sys.intern(path) if __name__ == \u0026#34;__main__\u0026#34;: print(\u0026#34;start\u0026#34;.center(60,\u0026#34;*\u0026#34;)) print(\u0026#34;zabbixç»Ÿè®¡æœºå™¨èµ„æºä½¿ç”¨æƒ…å†µ\u0026#34;.center(60)) config = configparser.ConfigParser() config.read(os.path.join(os.getcwd(), \u0026#39;config.ini\u0026#39;), encoding=\u0026#39;utf-8\u0026#39;) # å®ä¾‹åŒ–ä¸€ä¸ªzabbixå¯¹è±¡ #apiè°ƒç”¨åœ°å€ zabbix_api=\u0026#39;http://10.190.5.237/api_jsonrpc.php\u0026#39; zabbix_user=input(\u0026#34;è¯·è¾“å…¥æ‚¨zabbixçš„è´¦å·ï¼š\u0026#34;) zabbix_passwd=input(\u0026#39;è¯·è¾“å…¥æ‚¨zabbixçš„å¯†ç ï¼š\u0026#39;) file_name=\u0026#39;æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µåˆ†æ\u0026#39; zabbix = Zabbix( zabbix_api, zabbix_user, zabbix_passwd ) starttime = datetime.datetime.now() # è°ƒç”¨GetItemValueæ–¹æ³•è·å–æ¯å°ç›‘æ§ä¸»æœºçš„ç›‘æ§æ•°æ® zabbix_data = zabbix.GetItemValue() if len(zabbix_data) == 2: print(zabbix_data[\u0026#39;errmsg\u0026#39;]) print(\u0026#34;end\u0026#34;.center(60, \u0026#34;*\u0026#34;)) else: date_time = time.strftime(\u0026#39;%Y-%m-%d_%H-%M\u0026#39;) #print(zabbix_data) file_name = os.path.join(os.getcwd(), file_name + date_time + \u0026#39;.xlsx\u0026#39;) WriteExcel(file_name, zabbix_data) endtime = datetime.datetime.now() run_time=endtime - starttime print(f\u0026#34;ç¨‹åºè¿è¡Œï¼š{run_time.seconds} s ç”Ÿæˆæ–‡ä»¶ï¼š{file_name}\u0026#34;) print(\u0026#34;end\u0026#34;.center(60, \u0026#34;*\u0026#34;)) GetItems.py åœ¨è¿™é‡Œå¯ä»¥å®šåˆ¶å€¼ã€‚åˆ‡è®°ï¼Œè¿™é‡Œä»£ç åªé€‚åˆæˆ‘çš„ç¯å¢ƒï¼Œæœ‰äº›å€¼ä¸ºç‰¹å®šå€¼ï¼Œå¦‚æœ‰éœ€è¦ï¼Œéœ€è¦æ›´æ”¹å€¼\nåˆ—å¦‚ï¼š\n\u0026ldquo;io.usedgen[*]\u0026rdquo;, # æ ¹ç›®å½•ä½¿ç”¨ç‡ç›‘æ§\n\u0026ldquo;disk_capacity.[disk_all_Usage]\u0026rdquo;,#æœåŠ¡å™¨æ€»ä½¿ç”¨ç‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 #! /usr/bin/env python # _*_ coding: utf-8 _*_ # @Desc :è°ƒç”¨zabbix apiæ¥å£ï¼Œè·å–ç›‘æ§æ•°æ®ï¼Œzabbix-ç‰ˆæœ¬ä¸º5.0ä»¥ä¸Š import requests import json import re class Zabbix(object): def __init__(self, ApiUrl, User, Pwd): self.ApiUrl = ApiUrl self.User = User self.Pwd = Pwd self.__Headers = { \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json-rpc\u0026#39;, \u0026#39;User-Agent\u0026#39;: \u0026#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.106 Safari/537.36\u0026#39; } self.Message = { 1001: {\u0026#34;errcode\u0026#34;: \u0026#34;1001\u0026#34;, \u0026#34;errmsg\u0026#34;: \u0026#34;è¯·æ±‚è·¯å¾„é”™è¯¯ï¼Œè¯·æ£€æŸ¥APIæ¥å£è·¯å¾„æ˜¯å¦æ­£ç¡®.\u0026#34;}, 1002: {\u0026#34;errcode\u0026#34;: \u0026#34;1002\u0026#34;, \u0026#34;errmsg\u0026#34;: \u0026#34;Login name or password is incorrect.\u0026#34;}, 1003: {\u0026#34;errcode\u0026#34;: \u0026#34;1003\u0026#34;, \u0026#34;errmsg\u0026#34;: \u0026#34;æœªè·å–åˆ°ç›‘æ§ä¸»æœºï¼Œè¯·æ£€æŸ¥serverç«¯æ˜¯å¦ç›‘æ§æœ‰ä¸»æœº.\u0026#34;}, 1004: {\u0026#34;errcode\u0026#34;: \u0026#34;1004\u0026#34;, \u0026#34;errmsg\u0026#34;: \u0026#34;æœªçŸ¥é”™è¯¯.\u0026#34;}, } def __Login(self): \u0026#39;\u0026#39;\u0026#39; ç™»é™†zabbixï¼Œè·å–è®¤è¯çš„ç§˜é’¥ Returns: è¿”å›è®¤è¯ç§˜é’¥ \u0026#39;\u0026#39;\u0026#39; # ç™»é™†zabbix,æ¥å£çš„è¯·æ±‚æ•°æ® LoginApiData = { \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;user.login\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;user\u0026#34;: self.User, \u0026#34;password\u0026#34;: self.Pwd }, \u0026#34;id\u0026#34;: 1 } # å‘ç™»é™†æ¥å£å‘é€postè¯·æ±‚ï¼Œè·å–result LoginRet = requests.post(url=self.ApiUrl, data=json.dumps(LoginApiData), headers=self.__Headers) # åˆ¤æ–­è¯·æ±‚æ˜¯å¦ä¸º200 if LoginRet.status_code is not 200: return 1001 else: # å¦‚æœæ˜¯200çŠ¶æ€ï¼Œåˆ™è¿›è¡Œæ•°æ®æ ¼å¼åŒ– try: LoginRet = LoginRet.json() except: return 1001 # å¦‚æœresultåœ¨è¿”å›æ•°æ®ä¸­ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¯·æ±‚æˆåŠŸï¼Œåˆ™è·å–è®¤è¯key if \u0026#39;result\u0026#39; in LoginRet: Result = LoginRet[\u0026#39;result\u0026#39;] return Result # å¦åˆ™è¿”å›ç”¨æˆ·æˆ–å¯†ç é”™è¯¯ else: return 1002 def __GetMonitorHost(self): # è°ƒç”¨ç™»é™†å‡½æ•°ï¼Œè·å–authï¼Œå¹¶åˆ¤æ–­æ˜¯å¦ç™»é™†æˆåŠŸ Auth = self.__Login() if Auth == 1001: return 1001 elif Auth == 1002: return 1002 else: HostApiData = { \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;host.get\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;output\u0026#34;: [\u0026#34;hostid\u0026#34;, \u0026#34;host\u0026#34;, \u0026#34;name\u0026#34;], \u0026#34;selectInterfaces\u0026#34;: [\u0026#34;interfaces\u0026#34;, \u0026#34;ip\u0026#34;], }, \u0026#34;auth\u0026#34;: Auth, \u0026#34;id\u0026#34;: 1 } # å‘host.getæ¥å£å‘èµ·è¯·æ±‚ï¼Œè·å–æ‰€æœ‰ç›‘æ§ä¸»æœº HostRet = requests.post(url=self.ApiUrl, data=json.dumps(HostApiData), headers=self.__Headers).json() if \u0026#39;result\u0026#39; in HostRet: if len(HostRet[\u0026#39;result\u0026#39;]) != 0: # å¾ªç¯å¤„ç†æ¯ä¸€æ¡è®°å½•ï¼Œè¿›è¡Œç»“æ„åŒ–,æœ€ç»ˆå°†æ‰€æœ‰ä¸»æœºåŠ å…¥åˆ°all_hostå­—å…¸ä¸­ Allhost = {} for host in HostRet[\u0026#39;result\u0026#39;]: # host = {\u0026#39;hostid\u0026#39;: \u0026#39;10331\u0026#39;, \u0026#39;host\u0026#39;: \u0026#39;172.24.125.24\u0026#39;, \u0026#39;name\u0026#39;: \u0026#39;TBDSæµ‹è¯•ç‰ˆ172.24.125.24\u0026#39;, \u0026#39;interfaces\u0026#39;: [{\u0026#39;ip\u0026#39;: \u0026#39;172.24.125.24\u0026#39;}]} # è¿›è¡Œç»“æ„åŒ–ï¼Œæå–éœ€è¦çš„ä¿¡æ¯ HostInfo = {\u0026#39;host\u0026#39;: host[\u0026#39;host\u0026#39;], \u0026#39;hostid\u0026#39;: host[\u0026#39;hostid\u0026#39;], \u0026#39;ip\u0026#39;: host[\u0026#39;interfaces\u0026#39;][0][\u0026#39;ip\u0026#39;], \u0026#39;name\u0026#39;: host[\u0026#39;name\u0026#39;]} # host_info = {\u0026#39;host\u0026#39;: \u0026#39;172.24.125.24\u0026#39;, \u0026#39;hostid\u0026#39;: \u0026#39;10331\u0026#39;, \u0026#39;ip\u0026#39;: \u0026#39;172.24.125.24\u0026#39;, \u0026#39;name\u0026#39;: \u0026#39;TBDSæµ‹è¯•ç‰ˆ172.24.125.24\u0026#39;} # åŠ å…¥åˆ°all_hostä¸­ Allhost[host[\u0026#39;hostid\u0026#39;]] = HostInfo #print(Allhost)ä¸»æœºç»“æ„åŒ–åˆ—è¡¨ return {\u0026#34;Auth\u0026#34;:Auth, \u0026#34;Allhost\u0026#34;:Allhost} else: return 1003 else: return 1001 def GetItemValue(self): \u0026#39;\u0026#39;\u0026#39; # è°ƒç”¨item.getæ¥å£ï¼Œè·å–ç›‘æ§é¡¹ï¼ˆç›‘æ§é¡¹ä¸­å¸¦æœ‰æ¯ä¸ªç›‘æ§é¡¹çš„æœ€æ–°ç›‘æ§æ•°æ®ï¼‰ æ¥å£è¯´æ˜æ–‡æ¡£ï¼šhttps://www.zabbix.com/documentation/4.0/zh/manual/api/reference/item/get Returns: è¿”å›æ‰€æœ‰ç›‘æ§ä¸»æœºç›‘æ§ä¿¡æ¯ï¼Œ \u0026#39;\u0026#39;\u0026#39; # è·å–æ‰€æœ‰çš„ä¸»æœº HostRet = self.__GetMonitorHost() # åˆ¤æ–­HostRetæ˜¯å¦æœ‰ä¸»æœºå’Œè®¤è¯keyå­˜åœ¨ï¼Œè¿™é‡Œå¦‚æœæ˜¯ç±»å‹å¦‚æœæ˜¯å­—æ®µï¼Œé‚£è¾¹è¡¨ç¤ºä¸€å®šè·å–åˆ°çš„æœ‰ä¸»æœºä¿¡æ¯ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰è·å–åˆ°å€¼ if type(HostRet) is dict: # é¦–å…ˆæ‹¿åˆ°è®¤è¯æ–‡ä»¶å’Œæ‰€æœ‰ä¸»æœºä¿¡æ¯ Auth, AllHost = HostRet[\u0026#39;Auth\u0026#39;], HostRet[\u0026#39;Allhost\u0026#39;] # å®šä¹‰ä¸€ä¸ªæ–°çš„allhostï¼Œå­˜æ”¾æ‰€æœ‰ä¸»æœºæ–°çš„ä¿¡æ¯ NewAllHost = {} # å¾ªç¯å‘æ¯ä¸ªä¸»æœºå‘èµ·è¯·æ±‚ï¼Œè·å–ç›‘æ§é¡¹çš„å€¼ for k in AllHost: ItemData = { \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;item.get\u0026#34;, \u0026#34;params\u0026#34;: { \u0026#34;output\u0026#34;: [\u0026#34;extend\u0026#34;, \u0026#34;name\u0026#34;, \u0026#34;key_\u0026#34;, \u0026#34;lastvalue\u0026#34;], \u0026#34;hostids\u0026#34;: str(k), \u0026#34;search\u0026#34;: { \u0026#34;key_\u0026#34;: [ \u0026#34;system.hostname\u0026#34;, # ä¸»æœºå \u0026#34;system.uptime\u0026#34;, # ç³»ç»Ÿå¼€æœºæ—¶é•¿ \u0026#34;io.usedgen[*]\u0026#34;, # æ ¹ç›®å½•ä½¿ç”¨ç‡ç›‘æ§ \u0026#34;disk_capacity.[disk_all_Usage]\u0026#34;,#æœåŠ¡å™¨æ€»ä½¿ç”¨ç‡ \u0026#34;system.cpu.util\u0026#34;, # cpuä½¿ç”¨ç‡ \u0026#34;system.cpu.num\u0026#34;, # cpuæ ¸æ•° \u0026#34;system.cpu.load\u0026#34;, # cpuå¹³å‡è´Ÿè½½ \u0026#34;system.cpu.util[,idle]\u0026#34;, # cpuç©ºé—²æ—¶é—´ \u0026#34;vm.memory.utilization\u0026#34;, # å†…å­˜ä½¿ç”¨ç‡ \u0026#34;vm.memory.size[total]\u0026#34;, # å†…å­˜æ€»å¤§å° \u0026#34;vm.memory.size[available]\u0026#34;, # å¯ç”¨å†…å­˜ \u0026#34;net.if.in\u0026#34;, # ç½‘å¡æ¯ç§’æµå…¥çš„æ¯”ç‰¹(bit)æ•° \u0026#34;net.if.out\u0026#34; # ç½‘å¡æ¯ç§’æµå‡ºçš„æ¯”ç‰¹(bit)æ•° ] }, \u0026#34;searchByAny\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;sortfield\u0026#34;: \u0026#34;name\u0026#34; }, \u0026#34;auth\u0026#34;: Auth, \u0026#34;id\u0026#34;: 1 } # å‘æ¯ä¸€å°ä¸»æœºå‘èµ·è¯·æ±‚ï¼Œè·å–ç›‘æ§é¡¹ Ret = requests.post(url=self.ApiUrl, data=json.dumps(ItemData), headers=self.__Headers).json() #print(Ret) if \u0026#39;result\u0026#39; in Ret: # åˆ¤æ–­æ¯å°ä¸»æœºæ˜¯å¦æœ‰è·å–åˆ°ç›‘æ§é¡¹ï¼Œå¦‚æœä¸ç­‰äº0è¡¨ç¤ºè·å–åˆ°æœ‰ç›‘æ§é¡¹ if len(Ret[\u0026#39;result\u0026#39;]) != 0: # ä»æ‰€æœ‰ä¸»æœºä¿¡æ¯ä¸­å–å‡ºç›®å‰è·å–ä¿¡æ¯çš„è¿™å°ä¸»æœºä¿¡æ¯å­˜åœ¨host_infoä¸­ HostInfo = AllHost[k] #{\u0026#39;host\u0026#39;: \u0026#39;Zabbix server\u0026#39;, \u0026#39;hostid\u0026#39;: \u0026#39;10084\u0026#39;, \u0026#39;ip\u0026#39;: \u0026#39;127.0.0.1\u0026#39;, \u0026#39;name\u0026#39;: \u0026#39;Zabbix server\u0026#39;} # å¾ªç¯å¤„ç†æ¯ä¸€å°ä¸»æœºçš„æ‰€æœ‰ç›‘æ§é¡¹ #print(HostInfo) for host in Ret[\u0026#39;result\u0026#39;]: #print(str(host.values())) # åŒ¹é…æ‰€æœ‰åˆ†åŒºæŒ‚è½½ç›®å½•ä½¿ç”¨ç‡çš„æ­£åˆ™è¡¨è¾¾å¼ DiskUtilization = re.findall(r\u0026#39;æ ¹ç›®å½•ä½¿ç”¨ç‡ç›‘æ§\u0026#39;, str(host.values())) #print(DiskUtilization) if len(DiskUtilization) == 1: #å¦‚æœåŒ¹é…åˆ°äº†åˆ†åŒºç›®å½•ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] # åŒ¹é…ç½‘å¡è¿›å‡ºæµé‡çš„æ­£åˆ™è¡¨è¾¾å¼ NetworkBits = re.findall(r\u0026#39;Interface.*: Bits [a-z]{4,8}\u0026#39;, str(host.values())) #print(host.values()) if len(NetworkBits) == 1: HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;System name\u0026#39; in host.values(): # åŒ¹é…ä¸»æœºåï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;System uptime\u0026#39; in host.values(): # åŒ¹é…ç³»ç»Ÿå¼€æœºè¿è¡Œæ—¶é•¿ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;Number of CPUs\u0026#39; in host.values(): # åŒ¹é…CPUæ ¸æ•°ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;Total memory\u0026#39; in host.values(): # åŒ¹é…å†…å­˜æ€»å¤§å°ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;/: Total space\u0026#39; in host.values(): # åŒ¹é…æ ¹ç›®å½•æ€»é‡ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;/: Used space\u0026#39; in host.values(): # åŒ¹é…æ ¹ç›®å½•ä½¿ç”¨é‡ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;/: Space utilization\u0026#39; in host.values(): # åŒ¹é…æ ¹ç›®å½•ä½¿ç”¨é‡ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;Load average (1m avg)\u0026#39; in host.values(): # åŒ¹é…CPUå¹³å‡1åˆ†é’Ÿè´Ÿè½½ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;Load average (5m avg)\u0026#39; in host.values(): # åŒ¹é…CPUå¹³å‡5åˆ†é’Ÿè´Ÿè½½ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;Load average (15m avg)\u0026#39; in host.values(): # åŒ¹é…CPUå¹³å‡15åˆ†é’Ÿè´Ÿè½½ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;idle time\u0026#39; in host.values(): # åŒ¹é…CPUç©ºé—²æ—¶é—´ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;CPU utilization\u0026#39; in host.values(): # åŒ¹é…CPUä½¿ç”¨ç‡ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;Memory utilization\u0026#39; in host.values(): # åŒ¹é…å†…å­˜ä½¿ç”¨ç‡ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;Available memory\u0026#39; in host.values(): # åŒ¹é…å¯ç”¨å†…å­˜å¤§å°ï¼Œè¿›è¡Œä¿å­˜ HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] elif \u0026#39;æœåŠ¡å™¨ç¡¬ç›˜æ€»ä½¿ç”¨ç‡\u0026#39; in host.values(): HostInfo[host[\u0026#39;name\u0026#39;]] = host[\u0026#39;lastvalue\u0026#39;] #print(HostInfo) NewAllHost[HostInfo[\u0026#39;hostid\u0026#39;]] = HostInfo #print(NewAllHost) else: return {\u0026#34;errcode\u0026#34;: \u0026#34;1001\u0026#34;, \u0026#34;errmess\u0026#34;: \u0026#34;Login name or password is incorrect.\u0026#34;} return NewAllHost #print(NewAllHost) elif HostRet == 1001: return self.Message[1001] elif HostRet == 1002: return self.Message[1002] elif HostRet == 1003: return self.Message[1003] else: return self.Message[1004] SaveToExcel.py 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 #! /usr/bin/env python # _*_ coding: utf-8 _*_ import re from openpyxl import Workbook from openpyxl.styles import Font, Alignment, Side, Border, PatternFill def WriteExcel(FilaPath, ZabbixData): WorkBook = Workbook() Sheet = WorkBook.active Sheet.title = \u0026#39;æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ\u0026#39; # é™¤å» : \u0026#39;æ ¹ç›®å½•æ€»é‡/G\u0026#39;,\u0026#39;æ ¹ç›®å½•ä½¿ç”¨é‡/G\u0026#39;, TableTitle = [\u0026#39;IP\u0026#39;,\u0026#39;ä¸»æœºå\u0026#39;,\u0026#39;è¿è¡Œæ—¶é•¿/å¤©\u0026#39;,\u0026#39;CPU/æ ¸\u0026#39;,\u0026#39;å†…å­˜/GB\u0026#39;,\u0026#39;æ ¹ç›®å½•ä½¿ç”¨ç‡/%\u0026#39;,\u0026#39;CPUå¹³å‡è´Ÿè½½/1min\u0026#39;,\u0026#39;CPUå¹³å‡è´Ÿè½½/5min\u0026#39;,\u0026#39;CPUå¹³å‡è´Ÿè½½/15min\u0026#39;,\u0026#39;CPUç©ºé—²æ—¶é—´\u0026#39;,\u0026#39;CPUä½¿ç”¨ç‡/%\u0026#39;,\u0026#39;å†…å­˜ä½¿ç”¨ç‡/%\u0026#39;,\u0026#39;å¯ç”¨å†…å­˜/G\u0026#39;,\u0026#39;ç£ç›˜ä½¿ç”¨ç‡/%\u0026#39;,\u0026#39;ä½è´Ÿè½½ï¼ˆæ˜¯/å¦ï¼‰\u0026#39;] TitleColumn = {} #å­˜æ”¾æ¯ä¸ªtitleå€¼æ‰€å¯¹åº”çš„åˆ—{\u0026#39;IP\u0026#39;: \u0026#39;A\u0026#39;, \u0026#39;ä¸»æœºå\u0026#39;: \u0026#39;B\u0026#39;, \u0026#39;è¿è¡Œæ—¶é•¿\u0026#39;: \u0026#39;C\u0026#39;, \u0026#39;CPU/æ ¸\u0026#39;: \u0026#39;D\u0026#39;, \u0026#39;å†…å­˜/GB\u0026#39;: \u0026#39;E\u0026#39;, \u0026#39;æ ¹ç›®å½•æ€»é‡\u0026#39;: \u0026#39;F\u0026#39;,...} AllHostItemValues = [] #å­˜æ”¾æ‰€æœ‰ä¸»æœºçš„ç›‘æ§é¡¹å€¼ åˆ—è¡¨ä¿¡æ¯ã€‚ # ç»´æŠ¤è¡¨å¤´ï¼Œå†™å…¥è¡¨å¤´æ•°æ® for row in range(len(TableTitle)): Col = row + 1 Column = Sheet.cell(row=1, column=Col) #è·å–å•å…ƒæ ¼çš„ä½ç½® Column.value = TableTitle[row] #å†™å…¥æ•°æ® TitleCol = Column.coordinate.strip(\u0026#39;1\u0026#39;) #è·å–Titleæ‰€åœ¨çš„åˆ— TitleColumn[TableTitle[row]] = TitleCol #åŠ å…¥åˆ°TitleColumn # æ•´ç†Zabbix ç›‘æ§æ•°æ®é€è¡Œå†™å…¥åˆ°è¡¨æ ¼ä¸­ #print(ZabbixData) for host in ZabbixData.values(): # 1.é¦–å…ˆè¦å¯¹åˆ†åŒºç›®å½•ä½¿ç”¨ç‡è¿›è¡Œä¸€ä¸ªæ•´åˆï¼Œå°†é™¤/ç›®å½•å¤–çš„åˆ†åŒºç›®å½•ä½¿ç”¨ç‡æ•´åˆä¸ºä¸€ä¸ªå€¼ DiskItems = \u0026#39;\u0026#39; #å®šä¹‰ä¸€ä¸ªç©ºå€¼ï¼Œç”¨äºå­˜æ”¾é™¤æ ¹ç›®å½•ç©ºé—´ä½¿ç”¨ç‡å¤–æ‰€æœ‰çš„åˆ†åŒºç›®å½•ä½¿ç”¨ç‡ DelItems = [] #å®šä¹‰ä¸€ä¸ªç©ºåˆ—è¡¨ï¼Œç”¨äºå­˜æ”¾é™¤æ ¹ç›®å½•ç©ºé—´ä½¿ç”¨ç‡å¤–æ‰€æœ‰çš„åˆ†åŒºç›®å½•ä½¿ç”¨ç‡çš„é”®å€¼ for item in host: DiskItem = re.findall(r\u0026#39;^/[a-z0-9]{1,50}: Space utilization\u0026#39;, item) if len(DiskItem) == 1: DiskItem = DiskItem[0] #è·å–ç›‘æ§é¡¹çš„åå­— /boot: Space utilization NewDiskItem = DiskItem.strip(\u0026#39;Space utilization\u0026#39;) # å°†åå­—æ ¼å¼åŒ–ï¼Œ/boot: Space utilization æ ¼å¼åŒ–ä¸ºï¼š/boot: DiskItemValue = str(round(float(host[item]), 2)) + \u0026#39;%\u0026#39; # å–å‡ºå¯¹åº”ç›‘æ§é¡¹çš„å€¼ï¼Œå¹¶æ ¼å¼åŒ–ä¿ç•™ä¸¤ä½å°æ•° # å°†æ‰€æœ‰åˆ†åŒºç›®å½•ä½¿ç”¨ç‡ç»„åˆä¸ºä¸€ä¸ªæ•´çš„ç£ç›˜ä½¿ç”¨ç‡ if DiskItems == \u0026#39;\u0026#39;: DiskItemData = str(NewDiskItem) + \u0026#39; \u0026#39; + str(DiskItemValue) else: DiskItemData = \u0026#39;\\n\u0026#39; + str(NewDiskItem) + \u0026#39; \u0026#39; + str(DiskItemValue) DiskItems += DiskItemData # å°†å¤„ç†å®Œçš„ç£ç›˜ä½¿ç”¨ç‡åŠ å…¥åˆ°DelItemsåˆ—è¡¨ä¸­ï¼Œä¾›åç»­åˆ é™¤ä½¿ç”¨ DelItems.append(DiskItem) #print(host) # 2.å°†å·²ç»æ•´åˆè¿‡çš„åˆ†åŒºç›®å½•ä½¿ç”¨ç‡ç›‘æ§é¡¹åœ¨åŸæ¥çš„ä¸»æœºç›‘æ§é¡¹ä¸­åˆ é™¤ for delitem in DelItems: host.pop(delitem) # 3.å°†æ•´åˆå¥½çš„åˆ†åŒºç›®å½•ä½¿ç”¨ç‡ï¼Œé‡æ–°åŠ å…¥åˆ°ä¸»æœºç›‘æ§é¡¹çš„å­—å…¸ä¸­ host[\u0026#39;Disk utilization\u0026#39;] = DiskItems #print(host) # 4.å°†æ¯å°ä¸»æœºç›‘æ§é¡¹çš„å€¼å–å‡ºæ¥ç»„æˆä¸€ä¸ªåˆ—è¡¨ # æœ€ç»ˆå¾—åˆ°ä¸€æ¡ä¸€æ¡è¿™æ ·çš„æ•°æ®ï¼š #\u0026#39;IP\u0026#39;,\u0026#39;ä¸»æœºå\u0026#39;,\u0026#39;è¿è¡Œæ—¶é•¿/å¤©\u0026#39;,\u0026#39;CPU/æ ¸\u0026#39;,\u0026#39;å†…å­˜/GB\u0026#39;,\u0026#39;æ ¹ç›®å½•ä½¿ç”¨ç‡/%\u0026#39;,\u0026#39;CPUå¹³å‡è´Ÿè½½/1min\u0026#39;,\u0026#39;CPUå¹³å‡è´Ÿè½½/5min\u0026#39;,\u0026#39;CPUå¹³å‡è´Ÿè½½/15min\u0026#39;,\u0026#39;CPUç©ºé—²æ—¶é—´\u0026#39;,\u0026#39;CPUä½¿ç”¨ç‡/%\u0026#39;,\u0026#39;å†…å­˜ä½¿ç”¨ç‡/%\u0026#39;,\u0026#39;å¯ç”¨å†…å­˜/G\u0026#39;,\u0026#39;ç£ç›˜ä½¿ç”¨ç‡/%\u0026#39; # [\u0026#39;172.24.125.12\u0026#39;, \u0026#39;tbds-172-24-125-12\u0026#39;, \u0026#39;245.87d\u0026#39;, \u0026#39;16\u0026#39;, 64, \u0026#39;50G\u0026#39;, 7.43, \u0026#39;14.87%\u0026#39;, \u0026#39;0.1\u0026#39;, \u0026#39;0.18\u0026#39;, \u0026#39;0.32\u0026#39;, 97.79, \u0026#39;2.21%\u0026#39;, \u0026#39;35.52%\u0026#39;, 40.45, \u0026#39;/boot: 14.23%\\n/data: 6.24%\\n/home: 0.03%\u0026#39;] #print(host[\u0026#39;System uptime\u0026#39;]) if \u0026#39;System uptime\u0026#39; in host: HostItemValues = [] #å®šä¹‰ä¸€ä¸ªç©ºåˆ—è¡¨ï¼Œç”¨äºå­˜æ”¾ä¸»æœºçš„ç›‘æ§é¡¹çš„å€¼ HostItemValues.append(host[\u0026#39;ip\u0026#39;]) HostItemValues.append(host[\u0026#39;name\u0026#39;]) try: HostItemValues.append(str(round(int(host[\u0026#39;System uptime\u0026#39;]) / 24 / 60 / 60, 2)) + \u0026#39;d\u0026#39;) # é¦–å…ˆå°†è¿è¡Œæ—¶é•¿æ¢ç®—ä¸ºå¤©æ•°ï¼Œç„¶åå†åŠ å…¥åˆ°åˆ—è¡¨ä¸­ except IndexError as e: print(\u0026#34;IndexError Details : \u0026#34; + str(e)) pass HostItemValues.append(host[\u0026#39;Number of CPUs\u0026#39;]) TotalMemory = int(int(host[\u0026#39;Total memory\u0026#39;]) / 1024 / 1024 / 1024) if TotalMemory == 7: TotalMemory = 8 elif TotalMemory == 15: TotalMemory = 16 elif TotalMemory == 31: TotalMemory = 32 elif TotalMemory == 62: TotalMemory = 64 elif TotalMemory == 251: TotalMemory = 256 elif TotalMemory == 503: TotalMemory = 512 HostItemValues.append(TotalMemory) # å†…å­˜æ€»å¤§å° #HostItemValues.append(str(round(int(host[\u0026#39;/: Total space\u0026#39;]) / 1024 / 1024 / 1024)) + \u0026#39;G\u0026#39;) # æ ¹ç›®å½•æ€»å…±å¤§å° #HostItemValues.append(str(round(int(host[\u0026#39;/: Used space\u0026#39;]) / 1024 / 1024 / 1024, 2)) + \u0026#39;G\u0026#39;) # æ ¹ç›®å½•ä½¿ç”¨é‡ HostItemValues.append(str(round(float(host[\u0026#39;æ ¹ç›®å½•ä½¿ç”¨ç‡ç›‘æ§\u0026#39;]), 2)) + \u0026#39;%\u0026#39;) # æ ¹ç›®å½•ä½¿ç”¨ç‡ HostItemValues.append(host[\u0026#39;Load average (1m avg)\u0026#39;]) HostItemValues.append(host[\u0026#39;Load average (5m avg)\u0026#39;]) HostItemValues.append(host[\u0026#39;Load average (15m avg)\u0026#39;]) HostItemValues.append(round(float(host[\u0026#39;idle time\u0026#39;]), 2)) # CPUç©ºé—²æ—¶é—´ HostItemValues.append(str(round(float(host[\u0026#39;CPU utilization\u0026#39;]), 2)) + \u0026#39;%\u0026#39;) # CPUä½¿ç”¨ç‡ HostItemValues.append(str(round(float(host[\u0026#39;Memory utilization\u0026#39;]), 2)) + \u0026#39;%\u0026#39;) # å†…å­˜ä½¿ç”¨ç‡ HostItemValues.append(str(round(int(host[\u0026#39;Available memory\u0026#39;]) / 1024 / 1024 / 1024, 2)) + \u0026#39;G\u0026#39;) # å¯ç”¨å†…å­˜ HostItemValues.append(host[\u0026#39;æœåŠ¡å™¨ç¡¬ç›˜æ€»ä½¿ç”¨ç‡\u0026#39;]) # ç£ç›˜ä½¿ç”¨ç‡ if host[\u0026#39;Number of CPUs\u0026#39;] == \u0026#34;0\u0026#34;: HostItemValues.append(\u0026#34;å·²åœç”¨\u0026#34;) #print(type(float(host[\u0026#39;Load average (15m avg)\u0026#39;])),type(float(round(float(host[\u0026#39;CPU utilization\u0026#39;]), 2)))) if float(host[\u0026#39;Load average (15m avg)\u0026#39;]) \u0026gt;= 10 or float(round(float(host[\u0026#39;CPU utilization\u0026#39;]), 2)) \u0026gt;= 20 : #print(\u0026#34;è´Ÿè½½: æ˜¯\u0026#34; + host[\u0026#39;Load average (15m avg)\u0026#39;]) #print(\u0026#34;cpu: æ˜¯\u0026#34; + str(round(float(host[\u0026#39;CPU utilization\u0026#39;]), 2))) HostItemValues.append(\u0026#34;å¦\u0026#34;) else: #print(\u0026#34;è´Ÿè½½: å¦\u0026#34; + host[\u0026#39;Load average (15m avg)\u0026#39;]) # print(\u0026#34;cpu: å¦\u0026#34; + str(round(float(host[\u0026#39;CPU utilization\u0026#39;]), 2))) HostItemValues.append(\u0026#34;æ˜¯\u0026#34;) # å°†æ¯ä¸€å°ä¸»æœºçš„æ‰€æœ‰ç›‘æ§é¡¹ä¿¡æ¯æ·»åŠ åˆ°AllHostItemsåˆ—è¡¨ä¸­ AllHostItemValues.append(HostItemValues) #print(AllHostItemValues) # å°†æ‰€æœ‰ä¿¡æ¯å†™å…¥åˆ°è¡¨æ ¼ä¸­ for HostValue in range(len(AllHostItemValues)): Sheet.append(AllHostItemValues[HostValue]) #print(HostValue) ############ è®¾ç½®å•å…ƒæ ¼æ ·å¼ ############ # å­—ä½“æ ·å¼ TitleFont = Font(name=\u0026#34;å®‹ä½“\u0026#34;, size=12, bold=True, italic=False, color=\u0026#34;000000\u0026#34;) TableFont = Font(name=\u0026#34;å®‹ä½“\u0026#34;, size=11, bold=False, italic=False, color=\u0026#34;000000\u0026#34;) # å¯¹é½æ ·å¼ alignment = Alignment(horizontal=\u0026#34;center\u0026#34;, vertical=\u0026#34;center\u0026#34;, text_rotation=0, wrap_text=True) # è¾¹æ¡†æ ·å¼ side1 = Side(style=\u0026#39;thin\u0026#39;, color=\u0026#39;000000\u0026#39;) border = Border(left=side1, right=side1, top=side1, bottom=side1) # å¡«å……æ ·å¼ pattern_fill = PatternFill(fill_type=\u0026#39;solid\u0026#39;, fgColor=\u0026#39;99ccff\u0026#39;) # è®¾ç½®åˆ—å®½ column_width = {\u0026#39;A\u0026#39;: 15, \u0026#39;B\u0026#39;: 30, \u0026#39;C\u0026#39;: 14, \u0026#39;D\u0026#39;: 10, \u0026#39;E\u0026#39;: 10, \u0026#39;F\u0026#39;: 16, \u0026#39;G\u0026#39;: 18, \u0026#39;H\u0026#39;: 18, \u0026#39;I\u0026#39;: 22, \u0026#39;J\u0026#39;: 22, \u0026#39;K\u0026#39;: 23, \u0026#39;L\u0026#39;: 15, \u0026#39;M\u0026#39;: 16, \u0026#39;N\u0026#39;: 16, \u0026#39;O\u0026#39;: 14, \u0026#39;P\u0026#39;: 16} for i in column_width: Sheet.column_dimensions[i].width = column_width[i] # è®¾ç½®é¦–è¡Œçš„é«˜åº¦ Sheet.row_dimensions[1].height = 38 # å†»ç»“çª—å£ Sheet.freeze_panes = \u0026#39;A2\u0026#39; # æ·»åŠ ç­›é€‰å™¨ Sheet.auto_filter.ref = Sheet.dimensions # è®¾ç½®å•å…ƒæ ¼å­—ä½“åŠæ ·å¼ for row in Sheet.rows: for cell in row: if cell.coordinate.endswith(\u0026#39;1\u0026#39;) and len(cell.coordinate) == 2: cell.alignment = alignment #è®¾ç½®å¯¹é½æ ·å¼ cell.font = TitleFont #è®¾ç½®å­—ä½“ cell.border = border #è®¾ç½®è¾¹æ¡†æ ·å¼ cell.fill = pattern_fill #è®¾ç½®å¡«å……æ ·å¼ else: cell.font = TableFont cell.alignment = alignment cell.border = border WorkBook.save(filename=FilaPath) å¤šæ–‡ä»¶æ‰“åŒ…ã€‚è¿™è¾¹ç™¾åº¦ä¸€ä¸‹ï¼Œå¾ˆç®€å•çš„\n","date":"2021-07-19T21:19:19Z","image":"https://www.ownit.top/title_pic/52.jpg","permalink":"https://www.ownit.top/p/202107192119/","title":"zabbix-apiæŸ¥è¯¢æœºå™¨èµ„æºåˆ©ç”¨ç‡ï¼Œå¯¼å‡ºexeclè¡¨æ ¼"},{"content":"Pythonå®ç°æŸ¥è¯¢å‰ªè´´æ¿è‡ªåŠ¨åŒ¹é…ä¿¡æ¯ å‰æï¼šä¸šåŠ¡IPå¤ªå¤šï¼Œæ¯ä¸ªæœ‰ä¸åŒçš„ä¸»æœºåå’Œä¸åŒçš„åŠŸèƒ½ã€‚\nä¸æƒ³æ¯æ¬¡éƒ½è¦å»æŸ¥execlï¼Œæƒ³æ›´æ–¹ä¾¿ç‚¹ï¼Œæ›´å¿«ä¸€ç‚¹ã€‚\né€šä¿—ç‚¹æ€è·¯ï¼šç‚¹å‡»exeï¼ŒPython è‡ªåŠ¨ç›‘æ§å‰ªè´´æ¿çš„å†…å®¹ï¼Œç„¶åæ­£åˆ™å–å‡ºIPï¼Œæ¥ç€æ ¹æ®IPå¯¹æ¯”ä¸šåŠ¡æ–‡æ¡£ï¼Œè·å–ç›¸åº”çš„ä¿¡æ¯ï¼Œç„¶åæŠŠæŸ¥è¯¢å‡ºæ¥çš„å†…å®¹ï¼Œå¼¹å‡ºæç¤ºï¼ŒæŠŠæŸ¥è¯¢å‡ºçš„å†…å®¹å†™å…¥å‰ªè´´æ¿ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 \u0026#39;\u0026#39;\u0026#39; åŠŸèƒ½ä½œç”¨ï¼šå¯¹æ¯”å‰ªè´´æ¿ç±»å®¹ \u0026#39;\u0026#39;\u0026#39; import win32clipboard as w import win32con import xlrd from tkinter import messagebox import win32api, win32con import pyperclip import re import sys import os # print(__file__) path = os.path.dirname(os.path.abspath(__file__)) sys.intern(path) # print(path) # è·å–å‰ªè´´æ¿ä¸­çš„å†…å®¹ def getText(): w.OpenClipboard() d = w.GetClipboardData(win32con.CF_TEXT) w.CloseClipboard() return (d).decode(\u0026#39;GBK\u0026#39;) # è®¾ç½®å‰ªè´´æ¿çš„ç±»å®¹ def set_text(aString): w.OpenClipboard() w.EmptyClipboard() w.SetClipboardData(win32con.CF_TEXT, aString) w.CloseClipboard() # ç”Ÿæˆèµ„æºæ–‡ä»¶ç›®å½•è®¿é—®è·¯å¾„ def resource_path(relative_path): if getattr(sys, \u0026#39;frozen\u0026#39;, False): # æ˜¯å¦Bundle Resource base_path = sys._MEIPASS else: base_path = os.path.abspath(\u0026#34;.\u0026#34;) return os.path.join(base_path, relative_path) # è·å–å‰ªè´´æ¿ä¸­çš„ip,å¹¶åˆ¤æ–­æ˜¯å¦æ­£å¸¸ def get_ip(ss_ip): ipList = re.findall(r\u0026#39;[0-9]+(?:\\.[0-9]+){3}\u0026#39;, ss_ip) # print(ipList) if ipList: return ipList else: win32api.MessageBox(0, \u0026#34;è¯·æ‚¨æ£€æŸ¥å¤åˆ¶æ˜¯å¦å¸¦æœ‰IPï¼Œè¯·é‡æ–°æµ‹è¯•\u0026#34;, \u0026#34;æé†’\u0026#34;, win32con.MB_OK) sys.exit(0) # è·å–xlsä¸­çš„æ•°æ®ï¼Œå’Œä¹‹å‰å‰ªè´´æ¿çš„æ•°æ®å¯¹æ¯” def host(ss_ip): # è·å–execlçš„å†…å®¹ï¼Œè¿™è¾¹æ˜¯æ ¹æ®ä¸šåŠ¡æ¥åˆ†æ filename = resource_path(os.path.join(\u0026#34;res\u0026#34;, \u0026#34;hosts.xls\u0026#34;)) # print(filename) # execl_hosts = \u0026#39;./hosts.xls\u0026#39; data1 = xlrd.open_workbook(filename) page = data1.sheet_by_index(2) nrows1 = page.nrows ncols1 = page.ncols # è·å–ip host_ip = page.col_values(10) app = page.col_values(1) # åŠŸèƒ½é›†ç¾¤ purpose = page.col_values(2) # ç”¨é€” hostname = page.col_values(11) # ä¸»æœºåç§° # print(host_ip) # å¼€å§‹å¯¹æ¯”æ•°æ® start = 0 count = 1 # print(ss_ip) if str(ss_ip[0]) not in host_ip: win32api.MessageBox(0, f\u0026#34;æš‚æ— è®¾å¤‡{ss_ip[0]}çš„ä¿¡æ¯\u0026#34;, \u0026#34;æœªçŸ¥è®¾å¤‡\u0026#34;, win32con.MB_OK) sys.exit(0) for k, item in enumerate(host_ip, start): # print(k,item,ss_ip[0]) if str(ss_ip[0]) == str(item): # print(\u0026#34;æ­£å¸¸:\u0026#34; + item, k) win32api.MessageBox(0, f\u0026#34;\\t\\tæ³¨æ„\\n ä¸»æœºipï¼š{item} ä¸»æœºåç§°ï¼š{hostname[k]} \\n åŠŸèƒ½é›†ç¾¤ï¼š{app[k]} ä¸»æœºç”¨é€”ï¼š{purpose[k]}\u0026#34;, \u0026#34;å‘ç°è®¾å¤‡\u0026#34;, win32con.MB_OK) pyperclip.copy(f\u0026#34;ä¸»æœºipï¼š{item} ä¸»æœºåç§°ï¼š{hostname[k]} \\n åŠŸèƒ½é›†ç¾¤ï¼š{app[k]} ä¸»æœºç”¨é€”ï¼š{purpose[k]}\u0026#34;) sys.exit(0) count = count + 1 def main(): ss_ip = getText() one_ip = get_ip(ss_ip) host(one_ip) if __name__ == \u0026#39;__main__\u0026#39;: main() æµ‹è¯•æ•ˆæœï¼š\næ‰“åŒ…èµ„æºç”Ÿæˆexe Pythonæ‰“åŒ….exeçš„æ–¹æ³•å¤§è‡´æœ‰å››ç§ï¼špy2exe, pyinstaller,cx_Freezeå’Œnuitkaã€‚å…¶ä¸­æœ€å¸¸ç”¨çš„æ˜¯pyinstallerã€‚Pyinstalleræœ¬èº«ä¸æ˜¯pythonåº“ï¼Œä½†ä¾æ—§å¯ä»¥å®‰è£…pythonåº“å®‰è£…æ–¹å¼å®‰è£…ï¼Œç”Ÿæˆçš„.exeå¯ä»¥è·¨å¤šå¹³å°ä½¿ç”¨ï¼Œä¹Ÿèƒ½æŒ‡å®šå›¾æ ‡ã€‚\næˆ‘ä»¬éœ€è¦æŠŠä½¿ç”¨åˆ°çš„èµ„æºæ–‡ä»¶éƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œã€‚æœ¬æ–‡åœ¨å½“å‰ç›®å½•ä¸‹æ–°å»ºäº†ä¸€ä¸ªåä¸ºresçš„å­æ–‡ä»¶å¤¹æ¥å­˜æ”¾èµ„æºæ–‡ä»¶ï¼Œæœ¬æ–‡å‡è®¾reså†…çš„èµ„æºæ–‡ä»¶ä¸ºhosts.xls\nä¿®æ”¹å®Œ.pyæ–‡ä»¶åå¯ä»¥å…ˆè¿è¡Œä¸€ä¸‹ï¼Œä¿è¯æ— è¯¯ã€‚ç„¶åé€šè¿‡cmdæŒ‡ä»¤ï¼š\n1 pyi-makespec -F beloved.py ç”Ÿæˆ.specæ–‡ä»¶ã€‚å¦‚æœè¦æ·»åŠ Iconç­‰å¯ä»¥åœ¨è¿™é‡Œå°±ä½¿ç”¨pyi-makespec --icon abc.jpg -F beloved.pyè¯­å¥ç”Ÿæˆspecæ–‡ä»¶ã€‚\næ¥ä¸‹æ¥ï¼Œä¿®æ”¹.specæ–‡ä»¶ï¼š\nä¿®æ”¹å‰datas=[]ï¼Œæœ¬æ–‡è¿™é‡ŒæŠŠå®ƒæ”¹æˆä¸Šå›¾æ‰€ç¤ºï¼Œæ„æ€æ˜¯\nå°†beloved.pyå½“å‰ç›®å½•ä¸‹çš„resç›®å½•ï¼ˆåŠå…¶ç›®å½•ä¸­çš„æ–‡ä»¶ï¼‰åŠ å…¥ç›®æ ‡exeä¸­ï¼Œåœ¨è¿è¡Œæ—¶æ”¾åœ¨é›¶æ—¶æ–‡ä»¶çš„æ ¹ç›®å½•ä¸‹ï¼Œåç§°ä¸ºresã€‚\nç”Ÿæˆ.exeæ–‡ä»¶ä»¥åŠå…¶ä»–ç›¸å…³æ–‡ä»¶ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æ”¾å¿ƒçš„ç”Ÿæˆ.exeæ–‡ä»¶äº†ã€‚æ‰§è¡ŒcmdæŒ‡ä»¤\n1 pyinstaller -F beloved.spec .exeæ–‡ä»¶ç”Ÿæˆåœ¨å­æ–‡ä»¶dictä¸­ã€‚åˆ°æ­¤ä¾¿å¯ä»¥æŠŠ.exeå‘ç»™å…¶ä»–ç”µè„‘ç«¯è¿è¡Œäº†ã€‚.exeè¿è¡Œæ¯”è¾ƒæ…¢ï¼Œå»ºè®®å¤šç­‰å¾…ï¼Œåªè¦æ²¡å‡ºç°é”™è¯¯æç¤ºå°±OKã€‚\nå‚è€ƒåœ°å€ï¼šhttps://blog.csdn.net/qq_44685030/article/details/105096338\n","date":"2021-07-08T18:20:52Z","image":"https://www.ownit.top/title_pic/06.jpg","permalink":"https://www.ownit.top/p/202107081820/","title":"Pythonå®ç°æŸ¥è¯¢å‰ªè´´æ¿è‡ªåŠ¨åŒ¹é…ä¿¡æ¯"},{"content":"ç®€ä»‹ å†™è¿‡shellè„šæœ¬çš„äººéƒ½çŸ¥é“ï¼Œå³ä¾¿å‡ºç°ä¸€äº›ç®€å•çš„è¯­æ³•é”™è¯¯ï¼Œè¿è¡Œçš„æ—¶å€™ä¹Ÿå¯èƒ½æ²¡æœ‰åŠæ³•å‘ç°ã€‚æœ‰äº›çœ‹ä¼¼è¿è¡Œæ­£ç¡®çš„è„šæœ¬ï¼Œå®é™…ä¸Šå¯èƒ½åœ¨æŸäº›åˆ†æ”¯ï¼ŒæŸäº›åœºæ™¯ä¸‹ä»ç„¶å‡ºç°é”™è¯¯ï¼Œè€Œæœ‰çš„å†™æ³•å¯èƒ½è¿è¡Œæ­£å¸¸ï¼Œä½†æ˜¯å´ä¸ç¬¦åˆPOSIXæ ‡å‡†ï¼Œä¸å…·å¤‡å¯ç§»æ¤æ€§ã€‚\nè¯šç„¶ï¼Œshellè„šæœ¬æ˜¯è§£é‡Šè¿è¡Œï¼Œæ²¡æœ‰åŠæ³•å‘C/C++é‚£æ ·ä¸¥æ ¼æ£€æŸ¥ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¯ä»¥å€ŸåŠ©ä¸€äº›å·¥å…·å¸®åŠ©æˆ‘ä»¬æå‰å‘ç°ä¸€äº›é”™è¯¯ã€‚\nshellcheck githubåœ°å€ï¼šhttps://github.com/koalaman/shellcheck\nshellcheck æ˜¯ä¸€æ¬¾å®ç”¨çš„ shellè„šæœ¬é™æ€æ£€æŸ¥å·¥å…·ã€‚\né¦–å…ˆï¼Œå¯ä»¥å¸®åŠ©ä½ æå‰å‘ç°å¹¶ä¿®å¤ç®€å•çš„è¯­æ³•é”™è¯¯ï¼ŒèŠ‚çº¦æ—¶é—´ã€‚æ¯æ¬¡éƒ½éœ€è¦è¿è¡Œæ‰å‘ç°å†™é”™äº†ä¸€ä¸ªå°åœ°æ–¹ï¼Œç¡®å®éå¸¸æµªè´¹æ—¶é—´ã€‚\nå…¶æ¬¡ï¼Œå¯ä»¥é’ˆå¯¹ä½ å½“å‰ä¸å¤Ÿå®Œå–„ä¸å¤Ÿå¥å£®çš„å†™æ³•ï¼Œæä¾›å»ºè®®ï¼Œå¸®åŠ©ä½ æå‰ç»•å¼€ä¸€äº›å‘ï¼Œé¿å…ç­‰é—®é¢˜çœŸçš„å‘ç”Ÿäº†æ‰å»è°ƒè¯•å¤„ç†ã€‚\nåœ¨å…¶ä»‹ç»ä¸­ï¼Œç›®æ ‡æ˜¯é’ˆå¯¹æ‰€æœ‰ç”¨æˆ·çš„ï¼Œä»åˆå­¦è€…åˆ°é«˜æ‰‹ï¼Œéƒ½ç”¨å¾—ä¸Š\næŒ‡å‡ºå¹¶æ¾„æ¸…å…¸å‹çš„åˆå­¦è€…çš„è¯­æ³•é—®é¢˜ï¼Œé‚£é€šå¸¸ä¼šshellæä¾›ç¥ç§˜çš„é”™è¯¯æ¶ˆæ¯ã€‚ æŒ‡å‡ºå¹¶æ¾„æ¸…å…¸å‹çš„ä¸­çº§çš„è¯­ä¹‰é—®é¢˜ï¼Œè¿™äº›é—®é¢˜ä¼šå¯¼è‡´shellå‡ºç°å¥‡æ€ªä¸”åç›´è§‰çš„è¡Œä¸ºã€‚ æŒ‡å‡ºå¯èƒ½å¯¼è‡´é«˜çº§ç”¨æˆ·çš„è„šæœ¬ä¸­ï¼Œå¯èƒ½åœ¨æœªæ¥æŸç§æƒ…å†µä¸‹å¤±è´¥çš„é™·é˜±ã€‚ åœ¨çº¿ä½¿ç”¨ éå¸¸ç®€å•ï¼Œåœ¨ç½‘é¡µÂ https://www.shellcheck.netÂ ä¸Šï¼Œè´´å…¥ä½ çš„è„šæœ¬ï¼Œè¿è¡Œæ£€æŸ¥å³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #!/bin/sh for n in {1..$RANDOM} do str=\u0026#34;\u0026#34; if (( n % 3 == 0 )) then str=\u0026#34;fizz\u0026#34; fi if [ $[n%5] == 0 ] then str=\u0026#34;$strbuzz\u0026#34; fi if [[ ! $str ]] then str=\u0026#34;$n\u0026#34; fi echo \u0026#34;$str\u0026#34; done shell\nå®ƒä¼šç»™å‡ºé”™è¯¯æç¤ºæˆ–è€…å»ºè®®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 $ shellcheck myscript Line 2: for n in {1..$RANDOM} ^-- SC3009: In POSIX sh, brace expansion is undefined. ^-- SC3028: In POSIX sh, RANDOM is undefined. Line 5: if (( n % 3 == 0 )) ^-- SC3006: In POSIX sh, standalone ((..)) is undefined. Line 9: if [ $[n%5] == 0 ] ^-- SC3007: In POSIX sh, $[..] in place of $((..)) is undefined. ^-- SC2007: Use $((..)) instead of deprecated $[..] ^-- SC3014: In POSIX sh, == in place of = is undefined. Line 11: str=\u0026#34;$strbuzz\u0026#34; ^-- SC2154: strbuzz is referenced but not assigned. Line 13: if [[ ! $str ]] ^-- SC3010: In POSIX sh, [[ ]] is undefined. $ æ¯ä¸ªå¯èƒ½çš„é”™è¯¯éƒ½æç¤ºäº†ã€‚æ–°æ‰‹å†™shellå‡ºç°è«åçš„æŠ¥é”™æ—¶ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨å¥¥ã€‚å½“ç„¶ä¾‹å­ä¸­å¾ˆå¤šå¹¶ä¸æ˜¯çœŸçš„é”™è¯¯ï¼Œè€Œæ˜¯æŸç§å†™æ³•ä¸ç¬¦åˆPOSIXæ ‡å‡†ï¼Œè¿™ç§æƒ…å†µä¹Ÿåº”è¯¥é¿å…ã€‚\nå®‰è£…æ–¹å¼ åœ¨å¤§å¤šæ•°å‘è¡Œç‰ˆçš„åŒ…ç®¡ç†ä¸­ï¼Œå·²ç»æœ‰shellcheckäº†ï¼Œå¦‚åœ¨åŸºäºdebiançš„æœºå™¨ä¸Š\n1 apt-get install shellcheck å…¶ä»–ç³»ç»Ÿçš„å…·ä½“å®‰è£…æ–¹å¼ï¼Œå¯ä»¥æŸ¥é˜… shellcheck çš„githubé¦–é¡µä»‹ç»\nå½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©è‡ªè¡Œä»æºç å®‰è£…ã€‚\næˆ‘é€‰æ‹©çš„å°±æ˜¯äºŒè¿›åˆ¶å®‰è£…ï¼Œç›´æ¥æ”¾åœ¨/usr/bin/ç›®å½•ä¸‹ï¼Œç»™æƒé™å°±å¯ä»¥äº†\nä¸‹è½½ï¼šhttps://download.csdn.net/download/heian_99/19597695\ngithubï¼šhttps://github.com/koalaman/shellcheck/releases/download/stable/shellcheck-stable.linux.x86_64.tar.xz\næµ‹è¯•\n1 2 3 4 5 6 7 8 #!/bin/bash if[ $# -eq 0 ] then echo \u0026#34;no para\u0026#34; else echo \u0026#34;$# para\u0026#34; fi exit 0 ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 [root@redhat heian]# sh test.sh test.sh:è¡Œ2: if[ 0 -eq 0 ]: æœªæ‰¾åˆ°å‘½ä»¤ test.sh:è¡Œ3: æœªé¢„æœŸçš„ç¬¦å· `then\u0026#39; é™„è¿‘æœ‰è¯­æ³•é”™è¯¯ test.sh:è¡Œ3: `then\u0026#39; [root@redhat heian]# shellcheck test.sh In test.sh line 2: if[ $# -eq 0 ] ^-- SC1069: You need a space before the [. For more information: https://www.shellcheck.net/wiki/SC1069 -- You need a space before the [. ç›¸å…³çš„æŠ¥é”™å·²ç»ç»™äº†è§£å†³çš„åŠæ³•ï¼Œä¹Ÿå¯ä»¥æ ¹æ®è¿æ¥å»æŸ¥è¯¢æ›´è¯¦ç»†çš„åŸå› ã€‚\né—®é¢˜åˆ—è¡¨ é‚£ä¹ˆshellcheckå…·ä½“ä¼šæ£€æŸ¥ä¸€äº›ä»€ä¹ˆé—®é¢˜å‘¢ï¼Œä»¥ä¸‹ç»™å‡ºä¸€ä¸ªä¸å®Œæ•´çš„é—®é¢˜æ£€æŸ¥åˆ—è¡¨ã€‚\nå¯ä»¥çœ‹ä¸‹ï¼Œä½ æ˜¯å¦éƒ½èƒ½æ„è¯†åˆ°è¿™æ ·çš„å†™æ³•æ—¶æœ‰é”™è¯¯æˆ–éšæ‚£çš„ã€‚\nå¦‚æœå‘ç°æœ‰è‡ªå·±ä¸çŸ¥é“çš„æˆ–è‡ªå·±å®¹æ˜“é”™æ¼çš„ï¼Œé‚£ä¹ˆä¹Ÿè®¸ä½ ä¹Ÿåº”è¯¥èŠ±ç‚¹æ—¶é—´ï¼Œè£…ä¸Šshellcheckã€‚\nå¼•å·é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 echo $1 # Unquoted variables #å˜é‡æœªåŠ å¼•å· find . -name *.ogg # Unquoted find/grep patterns #find/grep çš„åŒ¹é…æ¨¡å¼æœªåŠ å¼•å· rm \u0026#34;~/my file.txt\u0026#34; # Quoted tilde expansion #å¼•å·ä¸­çš„æ³¢æµªç¬¦æ‰©å±• v=\u0026#39;--verbose=\u0026#34;true\u0026#34;\u0026#39;; cmd $v # Literal quotes in variables # å˜é‡ä¸­çš„å­—é¢å¼•å· for f in \u0026#34;*.ogg\u0026#34; # Incorrectly quoted \u0026#39;for\u0026#39; loops # é”™è¯¯çš„forå¾ªç¯ touch $@ # Unquoted $@ # $@æœªåŠ å¼•å· echo \u0026#39;Don\u0026#39;t forget to restart!\u0026#39; # Singlequote closed by apostrophe # å•å¼•å·è¢«æ’‡å·æ„å¤–å…³é—­äº† echo \u0026#39;Don\\\u0026#39;t try this at home\u0026#39; # Attempting to escape \u0026#39; in \u0026#39;\u0026#39; #è¯•å›¾åœ¨å•å¼•å·æ‹¬èµ·æ¥çš„éƒ¨åˆ†ä¸­åŠ ä¸Šä¸€ä¸ªå•å¼•å· echo \u0026#39;Path is $PATH\u0026#39; # Variables in single quotes # å°†å˜é‡ç”¨å•å¼•å·æ‹¬èµ·æ¥ trap \u0026#34;echo Took ${SECONDS}s\u0026#34; 0 # Prematurely expanded trap #è¿‡æ—©æ‰©å±•é™·é˜± æ¡ä»¶åˆ¤æ–­ ShellCheck å¯ä»¥è¯†åˆ«å¤§å¤šæ•°ä¸æ­£ç¡®çš„æ¡ä»¶åˆ¤æ–­è¯­å¥\n1 2 3 4 5 6 7 8 9 10 11 [[ n != 0 ]] # Constant test expressions # å¸¸é‡æµ‹è¯•è¡¨è¾¾å¼ [[ -e *.mpg ]] # Existence checks of globs # å¯¹æ–‡ä»¶æ˜¯å¦å­˜åœ¨è¿›è¡Œæ£€æŸ¥æ—¶ï¼Œä½¿ç”¨é€šé…ç¬¦ [[ $foo==0 ]] # Always true due to missing spaces #ç”±äºç¼ºä¹ç©ºæ ¼ï¼Œç»“æœæ€»æ˜¯ä¸ºçœŸ [[ -n \u0026#34;$foo \u0026#34; ]] # Always true due to literals #ç”±äºå­—é¢å€¼å­˜åœ¨ï¼Œç»“æœæ€»æ˜¯ä¸ºçœŸ [[ $foo =~ \u0026#34;fo+\u0026#34; ]] # Quoted regex in =~ # åœ¨ =~ ä¸­ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ [ foo =~ re ] # Unsupported [ ] operators # ä¸æ”¯æŒçš„[]è¿ç®—ç¬¦ [ $1 -eq \u0026#34;shellcheck\u0026#34; ] # Numerical comparison of strings # æ¯”è¾ƒæ•°å­—å’Œå­—ç¬¦ä¸² [ $n \u0026amp;\u0026amp; $m ] # \u0026amp;\u0026amp; in [ .. ] # åœ¨[]ä¸­ä½¿ç”¨\u0026amp;\u0026amp;è¿ç®—ç¬¦ [ grep -q foo file ] # Command without $(..) #å‘½ä»¤ç¼ºå°‘äº†$(..) [[ \u0026#34;$$file\u0026#34; == *.jpg ]] # Comparisons that can\u0026#39;t succeed #æ— æ³•æˆåŠŸçš„æ¯”è¾ƒ (( 1 -lt 2 )) # Using test operators in ((..)) #åœ¨((..))ä¸­ä½¿ç”¨æ¯”è¾ƒ å¸¸è§çš„å¯¹å‘½ä»¤çš„é”™è¯¯ä½¿ç”¨ ShellCheck å¯ä»¥è¯†åˆ«å¯¹ä¸€äº›å‘½ä»¤çš„é”™è¯¯ä½¿ç”¨\n1 2 3 4 5 6 7 8 9 10 11 grep \u0026#39;*foo*\u0026#39; file # Globs in regex contexts #åœ¨grepçš„æ­£åˆ™è¡¨è¾¾å¼ä¸­å‰åä½¿ç”¨é€šé…ç¬¦ find . -exec foo {} \u0026amp;\u0026amp; bar {} \\; # Prematurely terminated find -exec # ä½¿find -exec è¿‡æ—©ç»“æŸ sudo echo \u0026#39;Var=42\u0026#39; \u0026gt; /etc/profile # Redirecting sudo # é‡å®šå‘sudo time --format=%s sleep 10 # Passing time(1) flags to time builtin # å°†time(1)çš„æ ‡å¿—ä¼ é€’ç»™å†…å»ºçš„time while read h; do ssh \u0026#34;$h\u0026#34; uptime # Commands eating while loop input # ä¸€ä¸ªè·å–è¾“å…¥çš„whileå¾ªç¯ä¸­ï¼Œä½¿ç”¨åŒæ ·ä¼šè·å–è¾“å…¥çš„å‘½ä»¤ alias archive=\u0026#39;mv $1 /backup\u0026#39; # Defining aliases with arguments # å®šä¹‰ä½¿ç”¨å‚æ•°çš„alias tr -cd \u0026#39;[a-zA-Z0-9]\u0026#39; # [] around ranges in tr # åœ¨trçš„å‚æ•°èŒƒå›´å¤–ä½¿ç”¨[] exec foo; echo \u0026#34;Done!\u0026#34; # Misused \u0026#39;exec\u0026#39; # é”™è¯¯åœ°ä½¿ç”¨exec find -name \\*.bak -o -name \\*~ -delete # Implicit precedence in find # åœ¨findä¸­çš„éšå¼ä¼˜å…ˆçº§ # find . -exec foo \u0026gt; bar \\; # Redirections in find #findä¸­çš„é‡å®šå‘ f() { whoami; }; sudo f # External use of internal functions #åœ¨å¤–éƒ¨ä½¿ç”¨å†…éƒ¨å‡½æ•° åˆå­¦è€…çš„å¸¸è§é”™è¯¯ ShellCheck è¯†åˆ«å¾ˆå¤šåˆå­¦è€…çš„è¯­æ³•é”™è¯¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 var = 42 # Spaces around = in assignments #ç­‰å·ä¸¤è¾¹çš„ç©ºæ ¼ $foo=42 # $ in assignments # å¯¹å˜é‡èµ‹å€¼æ—¶ä½¿ç”¨äº†$ for $var in *; do ... # $ in for loop variables # åœ¨å¾ªç¯å˜é‡å¤„ä½¿ç”¨$ var$n=\u0026#34;Hello\u0026#34; # Wrong indirect assignment #é”™è¯¯çš„å˜é‡ echo ${var$n} # Wrong indirect reference #é”™è¯¯çš„å¼•ç”¨ var=(1, 2, 3) # Comma separated arrays #é€—å·åˆ†å‰²æ•°ç»„ array=( [index] = value ) # Incorrect index initialization #é”™è¯¯çš„ç´¢å¼•åˆå§‹åŒ– echo $var[14] # Missing {} in array references #å¼•ç”¨æ•°ç»„ç¼ºå°‘{} echo \u0026#34;Argument 10 is $10\u0026#34; # Positional parameter misreference #é”™è¯¯çš„ä½ç½®å‚æ•°å¼•ç”¨ if $(myfunction); then ..; fi # Wrapping commands in $() #åœ¨å‘½ä»¤å¤–åŠ ä¸Š$() else if othercondition; then .. # Using \u0026#39;else if\u0026#39; #ä½¿ç”¨else if f; f() { echo \u0026#34;hello world; } # Using function before definition åœ¨å‡½æ•°å®šä¹‰ä¹‹å‰ä½¿ç”¨å‡½æ•° [ false ] # \u0026#39;false\u0026#39; being true # æ­¤å¤„falseä¸ºtrue if ( -f file ) # Using (..) instead of test #ä½¿ç”¨()å–ä»£æµ‹è¯•æ¡ä»¶ æ•°æ®å’Œæ‹¼å†™é”™è¯¯ ShellCheck å¯ä»¥è¯†åˆ«ä¸€äº›æ•°æ®å’Œæ‹¼å†™é”™è¯¯\n1 2 3 4 5 6 7 8 9 10 args=\u0026#34;$@\u0026#34; # Assigning arrays to strings # å°†æ•°ç»„èµ‹å€¼ç»™å­—ç¬¦ä¸² files=(foo bar); echo \u0026#34;$files\u0026#34; # Referencing arrays as strings # æŠŠæ•°å­—å½“æˆå­—ç¬¦ä¸²å¼•ç”¨ declare -A arr=(foo bar) # Associative arrays without index # ä¸å¸¦ç´¢å¼•ç»„åˆæ•°ç»„ printf \u0026#34;%s\\n\u0026#34; \u0026#34;Arguments: $@.\u0026#34; # Concatenating strings and arrays # è¿æ¥å­—ç¬¦ä¸²å’Œæ•°ç»„ [[ $# \u0026gt; 2 ]] # Comparing numbers as strings # æŠŠæ•°å­—å½“æˆå­—ç¬¦ä¸²æ¯”è¾ƒ var=World; echo \u0026#34;Hello \u0026#34; var # Unused lowercase variables # æœªä½¿ç”¨çš„å°å†™å˜é‡ echo \u0026#34;Hello $name\u0026#34; # Unassigned lowercase variables # æœªèµ‹å€¼çš„å°å†™å˜é‡ cmd | read bar; echo $bar # Assignments in subshells # åœ¨subshellsä¸­è¿›è¡Œèµ‹å€¼ cat foo | cp bar # Piping to commands that don\u0026#39;t read # é€šè¿‡ç®¡é“ä¼ é€’æ•°æ®ç»™ä¸€ä¸ªä¸ä¼šåšè¯»å–çš„ç¨‹åº printf \u0026#39;%s: %s\\n\u0026#39; foo # Mismatches in printf argument count # pirintfå‚æ•°æ•°é‡ä¸åŒ¹é… å…¶ä»–æ‚ä¸ƒæ‚å…«çš„é—®é¢˜ ShellCheck å¯ä»¥è¯†åˆ«åˆ°ä¸€äº›å…¶ä»–é—®é¢˜\n1 2 3 4 5 6 7 8 9 10 11 PS1=\u0026#39;\\e[0;32m\\$\\e[0m \u0026#39; # PS1 colors not in \\[..\\] # PS1 çš„é¢œè‰²ä¸åœ¨\\[..\\] ä¸­ PATH=\u0026#34;$PATH:~/bin\u0026#34; # Literal tilde in $PATH # $PATHä¸­çš„æ³¢æµªå· rm â€œfileâ€ # Unicode quotes #Unicode å¼•å· echo \u0026#34;Hello world\u0026#34; # Carriage return / DOS line endings # ä¼ è¾“è¿”å›DOSè¡Œç»“æŸç¬¦/ echo hello \\ # Trailing spaces after \\ # \\åé¢çš„è¡Œå°¾ç©ºæ ¼ var=42 echo $var # Expansion of inlined environment # å±•å¼€å†…è”ç¯å¢ƒå˜é‡ #!/bin/bash -x -e # Common shebang errors # shebang å‘½ä»¤é”™è¯¯ echo $((n/180*100)) # Unnecessary loss of precision # ä¸å¿…è¦çš„ç²¾åº¦ä¸¢å¤± ls *[:digit:].txt # Bad character class globs # ä¸å¥½çš„é€šé…ç¬¦ sed \u0026#39;s/foo/bar/\u0026#39; file \u0026gt; file # Redirecting to input # é‡å®šå‘åˆ°è¾“å…¥ while getopts \u0026#34;a\u0026#34; f; do case $f in \u0026#34;b\u0026#34;) # Unhandled getopts flags # æœªå¤„ç†çš„getoptsæ ‡å¿— æ€»ç»“ ä»¥ä¸Šå°±æ˜¯shellcheckçš„ä»‹ç»äº†ï¼Œä¸»è¦æ¥è‡ªå…¶github çš„readme ï¼Œæºç åœ¨Â githubÂ https://github.com/koalaman/shellcheck\nç®€å•å®ç”¨ï¼Œåªè¦é…ç½®å¥½äº†ï¼Œå°±å¯ä»¥æŒç»­ä¸ºä½ æä¾›å¸®åŠ©ã€‚è€Œä¸”è¿™ä¸ªæ˜¯å»ºè®®æ€§çš„ï¼Œå¯ä»¥è‡ªå·±æ ¹æ®å®é™…æƒ…å†µå†³å®šæ˜¯å¦é‡‡çº³ã€‚å³ç”¨å³å¼ƒçš„ä¸´æ—¶è„šæœ¬ï¼Œé‚£å…¼å®¹æ€§ç­‰å°±ä¸ç”¨å¤ªcareã€‚é•¿æœŸä½¿ç”¨çš„ï¼Œå°±è¿˜æ˜¯å®Œå–„ä¸€ä¸‹æ¯”è¾ƒç¨³å¦¥ã€‚\nå‚è€ƒåšå®¢ï¼šhttps://blog.csdn.net/whatday/article/details/105070638\nå¾®ä¿¡ï¼šhttps://mp.weixin.qq.com/s/jPZocFgl5OiDochx7rvI6w\n","date":"2021-06-12T21:33:26Z","image":"https://www.ownit.top/title_pic/46.jpg","permalink":"https://www.ownit.top/p/202106122133/","title":"å†ä¹Ÿä¸ç”¨æ‹…å¿ƒShellè„šæœ¬å‡ºé”™-ShellCheck"},{"content":"Shellå¸®ä½ æŒç®¡ä¸Šåƒå°æœåŠ¡ï¼ˆå¤šçº¿ç¨‹ï¼‰ æ—¥å¸¸æœåŠ¡å™¨è¿ç»´æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šæ‰¹é‡ç®¡ç†å¤šå°æœåŠ¡å™¨ã€‚\nè„šæœ¬ï¼Œæ‰¹é‡åŒ–ï¼Œä½¿æˆ‘ä»¬å·¥ä½œä¸­å¿…ä¸å¯å°‘çš„ã€‚\né¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€å°å ¡å’æœºï¼Œè´Ÿè´£å…ç§˜é’¥çš„ç™»å½•å’Œåˆ†å‘ä»»åŠ¡ç­‰ç­‰\nå ¡å’æœºåˆ°ä¸»æœº\néœ€è¦ä¸€å¥—ssh-keygenæ¥ç®¡ç†\nauthorized_keysï¼šÂ æˆæƒå¯†é’¥Â id_rsaÂ ï¼šç§é’¥Â id_rsa.pubÂ ï¼šå…¬é’¥Â known_hostsï¼šè¿æ¥è¿‡æœºå™¨è®°å½•ä¿¡æ¯ï¼Œä¸éœ€è¦å±äºâ€œyesâ€Â è¿™äº›éƒ½æ˜¯å‰é¢åŸºç¡€ç¯å¢ƒå’Œå·¥ä½œã€‚\né»˜è®¤è„šæœ¬ è¿™ä¸ªè„šæœ¬æ˜¯æœ€åˆå§‹åŒ–çš„ï¼Œå¯ä»¥è¿œç¨‹è¿‡å»æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶æ‰“å°ç»“æœ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #/bin/bash START_TIME=`date +%s` for i in `cat /opt/wei/pam_ip.txt` #ipå­˜æ”¾çš„æ–‡ä»¶ do cc=\u0026#34;ssh deployer@$i \\\u0026#34;sudo cat /etc/ssh/sshd_config | grep -Ev \u0026#39;^#\u0026#39; | grep UsePAM\\\u0026#34; \u0026#34; kk=`echo $cc|bash` if [ ! -n \u0026#34;$kk\u0026#34; ]; then echo \u0026#34;IP: $i UsePAM no seting\u0026#34; sudo echo \u0026#34;IP: $i UsePAM no seting\u0026#34; \u0026gt;\u0026gt; /opt/wei/pam_no.txt else echo \u0026#34;IP: $i $kk\u0026#34; sudo echo \u0026#34;IP: $i $kk\u0026#34; \u0026gt;\u0026gt; /opt/wei/pam_yes.txt fi done END_TIME=`date +%s` EXECUTING_TIME=`expr $END_TIME - $START_TIME` echo \u0026#34;================end=====================\u0026#34; echo \u0026#34;ç¨‹åºè¿è¡Œæ—¶é•¿ï¼š$EXECUTING_TIME S\u0026#34; è„šæœ¬ä¼˜åŒ–ï¼ˆåŠ å…¥çº¿ç¨‹æ¦‚å¿µï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #/bin/bash START_TIME=`date +%s` for i in `cat /opt/wei/pam_ip.txt` do { cc=\u0026#34;ssh deployer@$i \\\u0026#34;sudo cat /etc/ssh/sshd_config | grep -Ev \u0026#39;^#\u0026#39; | grep UsePAM\\\u0026#34; \u0026#34; kk=`echo $cc|bash` if [ ! -n \u0026#34;$kk\u0026#34; ]; then echo \u0026#34;IP: $i UsePAM no seting\u0026#34; sudo echo \u0026#34;IP: $i UsePAM no seting\u0026#34; \u0026gt;\u0026gt; /opt/wei/pam_no.txt else echo \u0026#34;IP: $i $kk\u0026#34; sudo echo \u0026#34;IP: $i $kk\u0026#34; \u0026gt;\u0026gt; /opt/we/pam_yes.txt fi }\u0026amp; done wait END_TIME=`date +%s` EXECUTING_TIME=`expr $END_TIME - $START_TIME` echo \u0026#34;================end=====================\u0026#34; echo \u0026#34;ç¨‹åºè¿è¡Œï¼š$EXECUTING_TIME S\u0026#34; ä½¿ç”¨**\u0026rsquo;\u0026amp;\u0026rsquo;+wait** å®ç°**â€œå¤šè¿›ç¨‹â€**å®ç°\nè¿è¡Œå¾ˆå¿«ï¼Œè€Œä¸”å¾ˆä¸è€å®ï¼ˆé¡ºåºéƒ½ä¹±äº†,å¤§æ¦‚æ˜¯å› ä¸ºexprè¿ç®—æ‰€èŠ±æ—¶é—´ä¸åŒï¼‰\nè§£æï¼šè¿™ä¸€ä¸ªè„šæœ¬çš„å˜åŒ–æ˜¯åœ¨å‘½ä»¤åé¢å¢åŠ äº†\u0026amp;æ ‡è®°ï¼Œæ„æ€æ˜¯å°†è¿›ç¨‹æ‰”åˆ°åå°ã€‚åœ¨shellä¸­ï¼Œåå°å‘½ä»¤ä¹‹é—´æ˜¯ä¸åŒºåˆ†å…ˆæ¥ååˆ°å…³ç³»çš„ã€‚æ‰€ä»¥å„åå°å­è¿›ç¨‹ä¼šæŠ¢å¤ºèµ„æºè¿›è¡Œè¿ç®—ã€‚\nwaitå‘½ä»¤ï¼š\nwait [n]\nn è¡¨ç¤ºå½“å‰shellä¸­æŸä¸ªæ‰§è¡Œçš„åå°å‘½ä»¤çš„pidï¼Œwaitå‘½ä»¤ä¼šç­‰å¾…è¯¥åå°è¿›ç¨‹æ‰§è¡Œå®Œæ¯•æ‰å…è®¸ä¸‹ä¸€ä¸ªshellè¯­å¥æ‰§è¡Œï¼›å¦‚æœæ²¡æŒ‡å®šåˆ™ä»£è¡¨å½“å‰shellåå°æ‰§è¡Œçš„è¯­å¥ï¼Œwaitä¼šç­‰å¾…åˆ°æ‰€æœ‰çš„åå°ç¨‹åºæ‰§è¡Œå®Œæ¯•ä¸ºæ­¢ã€‚\nå¦‚æœæ²¡æœ‰waitï¼Œåé¢çš„shellè¯­å¥æ˜¯ä¸ä¼šç­‰å¾…åå°è¿›ç¨‹çš„ï¼Œä¸€äº›å¯¹å‰é¢åå°è¿›ç¨‹æœ‰ä¾èµ–å…³ç³»çš„å‘½ä»¤æ‰§è¡Œå°±ä¸æ­£ç¡®äº†\nè‡ªå®šä¹‰çº¿ç¨‹æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 #!/bin/bash Nproc=20 #æœ€å¤§å¹¶å‘è¿›ç¨‹æ•° function PushQue { #å°†PIDå€¼è¿½åŠ åˆ°é˜Ÿåˆ—ä¸­ Que=\u0026#34;$Que $1\u0026#34; Nrun=$(($Nrun+1)) } function GenQue { #æ›´æ–°é˜Ÿåˆ—ä¿¡æ¯ï¼Œå…ˆæ¸…ç©ºé˜Ÿåˆ—ä¿¡æ¯ï¼Œç„¶åæ£€ç´¢ç”Ÿæˆæ–°çš„é˜Ÿåˆ—ä¿¡æ¯ OldQue=$Que Que=\u0026#34;\u0026#34;; Nrun=0 for PID in $OldQue; do if [[ -d /proc/$PID ]]; then PushQue $PID fi done } function ChkQue { #æ£€æŸ¥é˜Ÿåˆ—ä¿¡æ¯ï¼Œå¦‚æœæœ‰å·²ç»ç»“æŸäº†çš„è¿›ç¨‹çš„PIDï¼Œé‚£ä¹ˆæ›´æ–°é˜Ÿåˆ—ä¿¡æ¯ OldQue=$Que for PID in $OldQue; do if [[ ! -d /proc/$PID ]]; then GenQue; break fi done } for i in `cat /opt/wei/pam_ip.txt` do { cc=\u0026#34;ssh deployer@$i \\\u0026#34;sudo cat /etc/ssh/sshd_config | grep -Ev \u0026#39;^#\u0026#39; | grep UsePAM\\\u0026#34; \u0026#34; kk=`echo $cc|bash` if [ ! -n \u0026#34;$kk\u0026#34; ]; then echo \u0026#34;IP: $i UsePAM no seting\u0026#34; sudo echo \u0026#34;IP: $i UsePAM no seting\u0026#34; \u0026gt;\u0026gt; /opt/wei/pam_no.txt else echo \u0026#34;IP: $i $kk\u0026#34; sudo echo \u0026#34;IP: $i $kk\u0026#34; \u0026gt;\u0026gt; /opt/wei/pam_yes.txt fi }\u0026amp; sleep 0.1 #è€ƒè™‘æœ‰åºï¼Œå¼€å¯è¿™ä¸ªå‚æ•°ï¼Œé€Ÿåº¦ä¼˜å…ˆï¼Œåˆ™æ³¨é‡Šæ‰ PID=$! PushQue $PID while [[ $Nrun -ge $Nproc ]]; do # å¦‚æœNrunå¤§äºNprocï¼Œå°±ä¸€ç›´ChkQue ChkQue sleep 0.1 done done wait echo -e \u0026#34;time-consuming: $SECONDS seconds\u0026#34; #æ˜¾ç¤ºè„šæœ¬æ‰§è¡Œè€—æ—¶#!/bin/bash ä½¿ç”¨æ¨¡æ‹Ÿé˜Ÿåˆ—æ¥æ§åˆ¶è¿›ç¨‹æ•°é‡\nè¦æ§åˆ¶åå°åŒä¸€æ—¶åˆ»çš„è¿›ç¨‹æ•°é‡ï¼Œéœ€è¦åœ¨åŸæœ‰å¾ªç¯çš„åŸºç¡€ä¸Šå¢åŠ ç®¡ç†æœºåˆ¶ã€‚\nä¸€ä¸ªæ–¹æ³•æ˜¯ä»¥forå¾ªç¯çš„å­è¿›ç¨‹PIDåšä¸ºé˜Ÿåˆ—å…ƒç´ ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªé™å®šæœ€å¤§è¿›ç¨‹æ•°çš„é˜Ÿåˆ—ï¼ˆåªæ˜¯ä¸€ä¸ªé•¿åº¦å›ºå®šçš„æ•°ç»„ï¼Œå¹¶ä¸æ˜¯çœŸå®çš„é˜Ÿåˆ—ï¼‰ã€‚é˜Ÿåˆ—çš„åˆå§‹é•¿åº¦ä¸º0ï¼Œå¾ªç¯æ¯åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œå°±è®©é˜Ÿåˆ—é•¿åº¦+1ã€‚å½“é˜Ÿåˆ—é•¿åº¦åˆ°è¾¾è®¾ç½®çš„å¹¶å‘è¿›ç¨‹é™åˆ¶æ•°ä¹‹åï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—é•¿åº¦è¿˜æ˜¯ç­‰äºé™åˆ¶å€¼ï¼Œé‚£ä¹ˆä¸åšæ“ä½œï¼Œç»§ç»­è½®è¯¢ï¼›å¦‚æœæ£€æµ‹åˆ°æœ‰å¹¶å‘è¿›ç¨‹æ‰§è¡Œç»“æŸäº†ï¼Œé‚£ä¹ˆé˜Ÿåˆ—é•¿åº¦-1ï¼Œè½®è¯¢æ£€æµ‹åˆ°é˜Ÿåˆ—é•¿åº¦å°äºé™åˆ¶å€¼åï¼Œä¼šå¯åŠ¨ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„è¿›ç¨‹ï¼Œç›´è‡³æ‰€æœ‰ç­‰å¾…æ‰§è¡Œçš„å¹¶å‘è¿›ç¨‹å…¨éƒ¨æ‰§è¡Œå®Œã€‚\nå®šä¹‰20çº¿ç¨‹ï¼Œé€Ÿåº¦ä»åŸæ¥çš„311Sï¼Œé™åˆ°40Sï¼Œå¤§å¤§æé«˜æ•ˆç‡\n","date":"2021-06-09T20:42:08Z","image":"https://www.ownit.top/title_pic/20.jpg","permalink":"https://www.ownit.top/p/202106092042/","title":"Shellå¸®ä½ æŒç®¡ä¸Šåƒå°æœåŠ¡ï¼ˆå¤šçº¿ç¨‹ï¼‰"},{"content":"åšå®¢ï¼šhttps://ownit.top/ Centos7è„šæœ¬è‡ªåŠ¨å®‰è£…å¹¶æ³¨å†ŒzabbixæœåŠ¡ç«¯ æ­¤è„šæœ¬å¯ä»¥è‡ªåŠ¨å®‰è£…zabbixå®¢æˆ·ç«¯å¹¶ä¸”é…ç½®ï¼ˆæ³¨æ„ä¿®æ”¹ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 #zabbix-agent4.0.4 #centos7ç³»åˆ—å®‰è£…zabbixç›‘æ§ #è·å–å½±é™¢IP #ifconfig -a|grep inet|grep -v 127.0.0.1|grep -v inet6|awk \u0026#39;{print $2}\u0026#39;|tr -d \u0026#34;addr:\u0026#34; #é¦–å…ˆipè·å–è¦æµ‹è¯•ä¸€ä¸‹ï¼ŒåŒipï¼Œå¤šipéƒ½ä¼šæœ‰å½±å“ localname=`hostname` conf=\u0026#34;/etc/init.d/zabbix-agent\u0026#34; installzabbix(){ if [[ -f $conf ]]; then echo \u0026#34;zabbix_agentd already install\u0026#34; else /etc/init.d/zabbix_agentd stop rm -rf /etc/init.d/zabbix_agentd rm -rf /usr/local/zabbix yum -y install https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/4.2/rhel/7/x86_64/zabbix-agent-4.2.8-1.el7.x86_64.rpm #delconf sed -i \u0026#39;/^Server/d\u0026#39; /etc/zabbix/zabbix_agentd.conf sed -i \u0026#39;/^Hostname/d\u0026#39; /etc/zabbix/zabbix_agentd.conf sed -i \u0026#39;/^HostMetadata/d\u0026#39; /etc/zabbix/zabbix_agentd.conf #addconf echo \u0026#34;Server=10.10.10.1\u0026#34; \u0026gt;\u0026gt; /etc/zabbix/zabbix_agentd.conf echo \u0026#34;ServerActive=10.10.10.1\u0026#34; \u0026gt;\u0026gt; /etc/zabbix/zabbix_agentd.conf echo \u0026#34;HostMetadata=ownit\u0026#34; \u0026gt;\u0026gt; /etc/zabbix/zabbix_agentd.conf echo Hostname=$localname \u0026gt;\u0026gt; /etc/zabbix/zabbix_agentd.conf fi } installzabbix average(){ #è´Ÿè½½ç›‘æ§average echo \u0026#34;UserParameter=average[*],uptime|awk \u0026#39;{print \\$NF}\u0026#39;\u0026#34; \u0026gt; /etc/zabbix/zabbix_agentd.d/average.conf } average restzabbix(){ chkconfig zabbix-agent on systemctl restart zabbix-agent.service } restzabbix zabbixçš„åŸºæœ¬é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #zabbix-agentè¿è¡Œçš„pid PidFile=/var/run/zabbix/zabbix_agentd.pid #zabbix-agetè¿è¡Œçš„æ—¥å¿— LogFile=/var/log/zabbix/zabbix_agentd.log #zabbix-agentè¿è¡Œçš„æ—¥å¿—å¤§å°ï¼Œå½“è®¾ç½®ä¸º0æ—¶ï¼Œè¡¨ç¤ºä¸è¿›è¡Œæ—¥å¿—è½®è¯¢ LogFileSize=0 #zabbix-agentçš„ç›®å½•è·¯å¾„æˆ–æ‰©å±•é…ç½®æ–‡ä»¶è·¯å¾„ Include=/etc/zabbix/zabbix_agentd.d/*.conf #zabbix serverçš„ipåœ°å€ï¼Œå¤šä¸ªipä½¿ç”¨é€—å·åˆ†éš” Server=10.150.11.205,10.50.11.205 #zabbix ä¸»åŠ¨ç›‘æ§serverçš„ipåœ°å€ï¼Œä½¿ç”¨é€—å·åˆ†éš”å¤šIPï¼Œå¦‚æœæ³¨é‡Šè¿™ä¸ªé€‰é¡¹ï¼Œé‚£ä¹ˆå½“å‰æœåŠ¡å™¨çš„ä¸»åŠ¨ç›‘æ§å°±è¢«ç¦ç”¨äº† ServerActive=10.150.11.205,10.50.11.205 #zabbix-agentçš„æ•°æ®æºï¼Œä»…ç”¨äºä¸»æœºè‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½ HostMetadata=ownit #zabbix-agentçš„ä¸»æœºåï¼Œå¿…é¡»å”¯ä¸€ï¼ŒåŒºåˆ†å¤§å°å†™ã€‚Hostnameå¿…é¡»å’Œzabbix webä¸Šé…ç½®çš„ä¸€ç›´ï¼Œå¦åˆ™zabbixä¸»åŠ¨ç›‘æ§æ— æ³•æ­£å¸¸å·¥ä½œ Hostname=10.10.3.240 #zabbix-agentæ˜¯å¦å¯ç”¨ç”¨æˆ·è‡ªå®šä¹‰ç›‘æ§è„šæœ¬ï¼Œ1å¯ç”¨ï¼Œ0ä¸å¯ç”¨ UnsafeUserParameters=1 ZabbixæœåŠ¡ç«¯é…ç½® ","date":"2021-05-22T15:52:23Z","image":"https://www.ownit.top/title_pic/12.jpg","permalink":"https://www.ownit.top/p/202105221552/","title":"è‡ªåŠ¨å®‰è£…Zabbix-agent è‡ªåŠ¨æ³¨å†Œ"},{"content":"1ã€å‘å„ä¸»æœºåˆ†å‘ç§˜é’¥ æ–¹æ³•ä¸€\n1 2 3 4 5 6 7 8 9 10 --- - name: é…ç½®sshå…ç§˜é’¥è¿æ¥ hosts: new gather_facts: false connection: local #æœ¬åœ°è¿æ¥ tasks: - name: configure ssh connection shell: | ssh-keyscan {{inventory_hostname}} \u0026gt;\u0026gt;~/.ssh/known_hosts sshpass -p\u0026#39;å¯†ç \u0026#39; ssh-copy-id root@{{inventory_hostname}} æ–¹æ³•äºŒÂ 1 2 3 4 5 6 7 8 9 --- - name: configure ssh connection hosts: new gather_facts: false tasks: - authorized_key: key: \u0026#34;{{lookup(\u0026#39;file\u0026#39;,\u0026#39;~/.ssh/id_rsa.pub\u0026#39;)}}\u0026#34; state: present user: root æ‰§è¡Œè¯¥playbookï¼Œä¸»æœºåŠ ä¸Šäº†-ké€‰é¡¹ï¼Œå®ƒä¼šæç¤ºç”¨æˆ·è¾“å…¥sshè¿æ¥å¯†ç ã€‚å¦‚æœæ‰€æœ‰ç›®æ ‡ä¸»æœºçš„å¯†ç éƒ½ç›¸åŒï¼Œåˆ™åªéœ€è¾“å…¥ä¸€æ¬¡å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 $ ansible-playbook -k anth_key.yml SSH password: PLAY [configure ssh connection] *********** TASK [authorized_key] ********************* changed: [192.168.200.34] changed: [192.168.200.35] ...... 2ã€å¾ªç¯åˆ›å»ºæ–‡ä»¶ æ–¹æ³•ä¸€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 --- - name: play1 hosts: localhost gather_facts: false tasks: - name: create /tmp/test1 file: path: /tmp/test1 state: directory - name: create /tmp/test2 file: path: /tmp/test2 state: directory æ–¹æ³•äºŒ\n1 2 3 4 5 6 7 8 9 10 11 12 --- - name: play1 hosts: localhost gather_facts: false tasks: - name: create directories file: path: \u0026#34;{{item}}\u0026#34; state: directory loop: - /tmp/test1 - /tmp/test2 3ã€è®¾ç½®å¤šä¸ªä¸»æœºå 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 --- - name: set hostname hosts: new gather_facts: false vars: hostnames: - host: 192.168.200.34 name: new1 - host: 192.168.200.35 name: new2 tasks: - name: set hostname hostname: name: \u0026#34;{{item.name}}\u0026#34; when: item.host == inventory_hostname loop: \u0026#34;{{hostnames}}\u0026#34; 4ã€ä¸»æœºä¹‹é—´ç›¸äº’æ·»åŠ DNS 1 2 3 4 5 6 7 8 9 10 11 --- - name: add DNS for each hosts: new gather_facts: true tasks: - name: add DNS lineinfile: path: \u0026#34;/etc/hosts\u0026#34; line: \u0026#34;{{item}} {{hostvars[item].ansible_hostname}}\u0026#34; when: item != inventory_hostname loop: \u0026#34;{{ play_hosts }}\u0026#34; 5ã€æ·»åŠ yumæº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 --- - name: config yum repo and install software hosts: new gather_facts: false tasks: - name: backup origin yum repos shell: cmd: \u0026#34;mkdir bak; mv *.repo bak\u0026#34; chdir: /etc/yum.repos.d creates: /etc/yum.repos.d/bak - name: add os repo and epel repo yum_repository: name: \u0026#34;{{item.name}}\u0026#34; description: \u0026#34;{{item.name}} repo\u0026#34; baseurl: \u0026#34;{{item.baseurl}}\u0026#34; file: \u0026#34;{{item.name}}\u0026#34; enabled: 1 gpgcheck: 0 reposdir: /etc/yum.repos.d loop: - name: os baseurl: \u0026#34;https://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/os/$basearch\u0026#34; - name: epel baseurl: \u0026#34;https://mirrors.tuna.tsinghua.edu.cn/epel/$releasever/$basearch\u0026#34; - name: install pkgs yum: name: lrzsz,vim,dos2unix,wget,curl state: present 6ã€æ—¶é—´åŒæ­¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 --- - name: sync time hosts: new gather_facts: false tasks: - name: install and sync time block: - name: install ntpdate yum: name: ntpdate state: present - name: ntpdate to sync time shell: | ntpdate ntp1.aliyun.com hwclock -w - name: date_show shell: | date +%F-%T 7ã€å…³é—­selinux 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 --- - name: disable selinux hosts: new gather_facts: false tasks: - block: - name: disable on the fly shell: setenforce 0 - name: disable forever in config lineinfile: path: /etc/selinux/config line: \u0026#34;SELINUX=disabled\u0026#34; regexp: \u0026#39;^SELINUX=\u0026#39; ignore_errors: true 8ã€é…ç½®é˜²ç«å¢™ æ–¹æ³•ä¸€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 --- - name: set firewall hosts: new gather_facts: false tasks: - name: set iptables rule shell: | # å¤‡ä»½å·²æœ‰è§„åˆ™ iptables-save \u0026gt; /tmp/iptables.bak$(date +\u0026#34;%F-%T\u0026#34;) # ç»™å®ƒä¸‰æ¿æ–§ iptables -X iptables -F iptables -Z # æ”¾è¡Œloç½‘å¡å’Œå…è®¸ping iptables -A INPUT -i lo -j ACCEPT iptables -A INPUT -p icmp -j ACCEPT # æ”¾è¡Œå…³è”å’Œå·²å»ºç«‹è¿æ¥çš„åŒ…ï¼Œæ”¾è¡Œ22ã€443ã€80ç«¯å£ iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT iptables -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT iptables -A INPUT -p tcp -m tcp --dport 443 -j ACCEPT iptables -A INPUT -p tcp -m tcp --dport 80 -j ACCEPT # é…ç½®filterè¡¨çš„ä¸‰é“¾é»˜è®¤è§„åˆ™ï¼ŒINPUTé“¾ä¸¢å¼ƒæ‰€æœ‰åŒ… iptables -P INPUT DROP iptables -P FORWARD DROP iptables -P OUTPUT ACCEPT æ–¹æ³•äºŒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 --- - name: set firewall hosts: new gather_facts: false vars: allowed_tcp_ports: [22,80,443] default_policies: INPUT: DROP FORWARD: DROP OUTPUT: ACCEPT user_iptables_rule: - iptables -A INPUT -p tcp -m tcp --dport 8000 -j ACCEPT - iptables -A INPUT -p tcp -m tcp --dport 8080 -j ACCEPT tasks: - block: - name: backup and empty rules shell: | # å¤‡ä»½å·²æœ‰è§„åˆ™ï¼Œå¹¶æ¸…ç©ºè§„åˆ™ç­‰ iptables-save \u0026gt; /tmp/iptables.bak$(date +\u0026#34;%F-%T\u0026#34;) iptables -X iptables -F iptables -Z - name: green light for lo interface and icmp protocol shell: | # æ”¾è¡Œloæ¥å£ã€pingå’Œå·²å»ºç«‹è¿æ¥çš„åŒ… iptables -A INPUT -i lo -j ACCEPT iptables -A INPUT -p icmp -j ACCEPT iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT # æ”¾è¡Œç”¨æˆ·æŒ‡å®šçš„tcpç«¯å£åˆ—è¡¨ - name: allow for given tcp port shell: iptables -A INPUT -p tcp -m tcp --dport {{item}} -j ACCEPT loop: \u0026#34;{{ allowed_tcp_ports | default([]) }}\u0026#34; # æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„iptableså‘½ä»¤ - name: execute user iptables command shell: \u0026#34;{{item}}\u0026#34; loop: \u0026#34;{{user_iptables_rule | default([]) }}\u0026#34; # è®¾ç½®filterè¡¨ä¸‰é“¾çš„é»˜è®¤è§„åˆ™ - name: default policies for filter table shell: iptables -P {{item.key}} {{item.value}} loop: \u0026#34;{{ query(\u0026#39;dict\u0026#39;, default_policies | default({})) }}\u0026#34; 9ã€è¿œç¨‹ä¿®æ”¹sshdé…ç½®æ–‡ä»¶å¹¶é‡å¯ é‡‡ç”¨lineinfileæ¨¡å—å»ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè¦ä¿®æ”¹çš„å†…å®¹åªæœ‰ä¸¤é¡¹ï¼š 1.å°†PermitRootLoginæŒ‡ä»¤è®¾ç½®ä¸ºnoï¼Œç¦æ­¢rootç”¨æˆ·ç›´æ¥ç™»å½• 2.å°†PasswordAuthenticationæŒ‡ä»¤è®¾ç½®ä¸ºnoï¼Œä¸å…è®¸ä½¿ç”¨å¯†ç è®¤è¯çš„æ–¹å¼ç™»å½•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 --- - name: modify sshd_config hosts: new gather_facts: false tasks: # 1. å¤‡ä»½/etc/ssh/sshd_configæ–‡ä»¶ - name: backup sshd config shell: /usr/bin/cp -f {{path}} {{path}}.bak vars: - path: /etc/ssh/sshd_config # 2. è®¾ç½®PermitRootLogin no - name: disable root login lineinfile: path: \u0026#34;/etc/ssh/sshd_config\u0026#34; line: \u0026#34;PermitRootLogin no\u0026#34; insertafter: \u0026#34;^#PermitRootLogin\u0026#34; regexp: \u0026#34;^PermitRootLogin\u0026#34; notify: \u0026#34;restart sshd\u0026#34; # 3. è®¾ç½®PasswordAuthentication no - name: disable password auth lineinfile: path: \u0026#34;/etc/ssh/sshd_config\u0026#34; line: \u0026#34;PasswordAuthentication no\u0026#34; regexp: \u0026#34;^PasswordAuthentication yes\u0026#34; notify: \u0026#34;restart sshd\u0026#34; handlers: - name: \u0026#34;restart sshd\u0026#34; service: name: sshd state: restarted é€šè¿‡ä¸€ä¸ªå…¥å£æ–‡ä»¶å¼•å…¥æ‰€æœ‰è¿™äº›ä»»åŠ¡æ–‡ä»¶å°†å®ƒä»¬ç»„ç»‡èµ·æ¥ã€‚å‡è®¾å…¥å£æ–‡ä»¶åä¸ºmain.yamlï¼Œå…¶å†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 --- - import_playbook: \u0026#34;init_server/sshkey.yaml\u0026#34; - import_playbook: \u0026#34;init_server/hostname.yaml\u0026#34; - import_playbook: \u0026#34;init_server/add_dns.yaml\u0026#34; - import_playbook: \u0026#34;init_server/add_repos.yaml\u0026#34; - import_playbook: \u0026#34;init_server/synctime.yaml\u0026#34; - import_playbook: \u0026#34;init_server/disable_selinux.yaml\u0026#34; - import_playbook: \u0026#34;init_server/iptables.yaml\u0026#34; - import_playbook: \u0026#34;init_server/sshd_config.yaml\u0026#34; ","date":"2021-05-05T00:07:08Z","image":"https://www.ownit.top/title_pic/56.jpg","permalink":"https://www.ownit.top/p/202105050007/","title":"Ansibleå°å®ä¾‹"},{"content":"Shellç›‘æ§å…¬ç½‘IP-å˜åŒ–é‚®ä»¶æŠ¥è­¦\nå…¬å¸ç”¨çš„ç½‘çº¿IPï¼Œä½†æ˜¯æœ‰æ—¶IPä¼šæ”¹å˜ï¼Œå¯¼è‡´éƒ¨åˆ†ä¸šåŠ¡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬åˆä¸èƒ½åŠæ—¶å‘ç°ï¼Œä¼šé€ æˆä¸€å®šçš„å½±å“ã€‚\nç°åœ¨ä½¿ç”¨shellç›‘æ§å…¬ç½‘çš„IPï¼Œå¦‚å‘ç”Ÿå˜åŒ–ï¼Œç«‹å³é‚®ä»¶æŠ¥è­¦ã€‚\nä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ centosé‚®ä»¶æŠ¥è­¦å¯ä»¥å‚è€ƒè¿™ä¸ªï¼Œé»˜è®¤æ˜¯mailx\nè„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 #!/bin/bash dirfile=\u0026#39;/home/ip_change\u0026#39; new_ip=`curl icanhazip.com` #è·å–æ–°å…¬ç½‘ip mail_user=1794@qq.com #æ¥æ”¶æ”¶é‚®ä»¶é‚®ç®± mail_subject=\u0026#34;IPå·²ç»å‘ç”Ÿå˜åŒ–ï¼ŒåŠæ—¶å¤„ç†\u0026#34; #é‚®ä»¶ä¸»é¢˜ log=\u0026#34;/var/log/tool.log\u0026#34; datetime=`date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;` #åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ if [ ! -f \u0026#34;$dirfile\u0026#34; ]; then touch \u0026#34;$file\u0026#34; echo \u0026#34;1.1.1.1\u0026#34; \u0026gt; $dirfile fi #åˆ¤æ–­new_ipæ˜¯å¦è·å– if [ ! -n \u0026#34;$new_ip\u0026#34; ]; then echo \u0026#34;$datetime å…¬ç½‘IPè·å–å¤±è´¥ï¼Œæ£€æŸ¥\u0026#39;curl icanhazip.com\u0026#39; \u0026#34; \u0026gt;\u0026gt; $log exit 1 fi old_ip=`cat $dirfile` #æŸ¥çœ‹æ—§ip # åˆ¤æ–­ä¸¤ä¸ªIPæ˜¯å¦ç›¸ç­‰ å‘é‚®ä»¶ if [ \u0026#34;$new_ip\u0026#34; = \u0026#34;$old_ip\u0026#34; ]; then echo \u0026#34;$datetime IPæ­£å¸¸ - true \u0026#34; \u0026gt;\u0026gt; $log else echo $new_ip \u0026gt; $dirfile echo \u0026#34;IPå·²ç»å‘ç”Ÿå˜åŒ–, æ–°IP: $new_ip æ—§IPï¼š $old_ip !!! \u0026#34; | mail -s \u0026#34;$mail_subject\u0026#34; \u0026#34;$mail_user\u0026#34; echo \u0026#34;$datetime IPå·²ç»å‘ç”Ÿå˜åŒ– - error æ–°IP ï¼š$new_ip æ—§IPï¼š $old_ip\u0026#34; \u0026gt;\u0026gt; $log fi ","date":"2021-05-01T13:58:35Z","image":"https://www.ownit.top/title_pic/06.jpg","permalink":"https://www.ownit.top/p/202105011358/","title":"Shellç›‘æ§å…¬ç½‘IP-å˜åŒ–é‚®ä»¶æŠ¥è­¦"},{"content":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸€ï¼ˆwordpressåŸºç¡€ç‰ˆï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹ŸäºŒï¼ˆwordpressé«˜å¯ç”¨ï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸‰ï¼ˆwordpresså¥åº·æ£€æŸ¥å’ŒæœåŠ¡è´¨é‡QoSï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿå››ï¼ˆwordpresså‡çº§æ›´æ–°ï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿäº”ï¼ˆwordpressçš„HPAè‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿå…­ï¼ˆwordpressçš„è´¦å·ä¿¡æ¯åŠ å¯†ï¼‰ æºç åœ°å€ï¼šhttps://github.com/nangongchengfeng/Kubernetes/tree/main/wordpress-example\nKuberneteså®æˆ˜æ¨¡æ‹Ÿå…­ï¼Œå·²ç»æ„å»ºwordpressçš„è´¦å·ä¿¡æ¯åŠ å¯†ï¼Œå’Œæ—¶é—´æ ¡å‡†ã€‚\nç‰ˆæœ¬6 æ€è·¯ï¼šæƒ³mysqlå’Œwordpressçš„æ•°æ®æŒä¹…åŒ–ï¼Œæ€»ä¸èƒ½æŠŠæ•°æ®æ”¾åˆ°å®¹å™¨ä¸­ï¼Œå¦‚æœå®¹å™¨é‡å¯æˆ–è€…åˆ é™¤ï¼Œé‚£ä¹ˆæ•°æ®å°†éƒ½ä¼šæ¶ˆå¤±çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬é‡‡ç”¨nfså®è·µï¼ˆå…¶å®åç«¯å­˜å‚¨ä½¿ç”¨cephæ¯”è¾ƒå¥½ï¼Œå®‰å…¨æ€§å’Œé«˜å¯ç”¨ã€‚è¿™è¾¹æ–¹ä¾¿æ¼”ç¤ºé‡‡ç”¨nfsï¼‰\nNFS 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #å®‰è£… yum install -y nfs-utils rpcbind mkdir -p /data/nfsdata # ä¿®æ”¹é…ç½® $ vim /etc/exports /data/nfsdata 192.168.31.* (rw,async,no_root_squash) # ä½¿é…ç½®ç”Ÿæ•ˆ $ exportfs -r # æœåŠ¡ç«¯æŸ¥çœ‹ä¸‹æ˜¯å¦ç”Ÿæ•ˆ $ showmount -e localhost Export list for localhost: /data/nfsdata (everyone) helmå®‰è£…nfs-client 1 2 stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts helmæ·»åŠ è¿™ä¸ªæº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ä¸‹è½½helmåŒ… helm pull aliyuncs/nfs-client-provisioner è§£å‹ tar -zxvf nfs-client-provisioner-1.2.8.tgz ä¿®å¤values.yaml ä¸‰å¤„ image: repository: quay.io/external_storage/nfs-client-provisioner tag: v3.1.0-k8s1.11 pullPolicy: IfNotPresent nfs: server: 192.168.31.73 path: /data/nfsdata reclaimPolicy: Retain 1 2 3 4 5 å®‰è£… helm install nfs-client-provisioner -n nfs . å¸è½½ helm uninstall -n nfs nfs-client-provisioner mysqlæ•°æ®æŒä¹…åŒ– mysql-nfs.yaml.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: PersistentVolumeClaim metadata: name: mysql-nfs namespace: kube-example labels: app: mysql spec: storageClassName: \u0026#34;nfs-client\u0026#34; #å­˜å‚¨åç«¯ accessModes: - ReadWriteOnce #å…è®¸ä¸€ä¸ªå®¹å™¨è¿æ¥ï¼Œè¯»å†™ resources: requests: storage: 1G #å­˜å‚¨é‡ mysql.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 apiVersion: v1 kind: Service metadata: name: wordpress-mysql namespace: kube-example labels: app: wordpress spec: selector: app: wordpress tier: mysql ports: - port: 3306 targetPort: dbport --- apiVersion: apps/v1 kind: Deployment metadata: name: wordpress-mysql namespace: kube-example labels: app: wordpress tier: mysql spec: replicas: 1 template: metadata: name: wordpress-mysql labels: app: wordpress tier: mysql spec: containers: - name: mysql image: mysql:5.6 args: - --character-set-server=utf8mb4 - --collation-server=utf8mb4_unicode_ci volumeMounts: - mountPath: /var/lib/mysql name: mysql-nfs ports: - containerPort: 3306 name: dbport env: - name: MYSQL_ROOT_PASSWORD valueFrom: secretKeyRef: key: MYSQL_ROOT_PASSWORD name: db.conf - name: MYSQL_DATABASE valueFrom: secretKeyRef: key: MYSQL_DATABASE name: db.conf - name: MYSQL_USER valueFrom: secretKeyRef: key: WORDPRESS_DB_USER name: db.conf - name: MYSQL_PASSWORD valueFrom: secretKeyRef: key: WORDPRESS_DB_PASSWORD name: db.conf imagePullPolicy: IfNotPresent resources: limits: cpu: 1000m memory: 400Mi requests: cpu: 1000m memory: 400Mi startupProbe: #é¦–æ¬¡å¯åŠ¨æ¢æµ‹ï¼ˆå¦‚æœæ²¡æœ‰æˆåŠŸï¼Œä¸ä¼šè¿è¡Œä¸‹é¢livenessProbeï¼‰ tcpSocket: port: 3306 failureThreshold: 2 #æ¢æµ‹æˆåŠŸåï¼Œæœ€å°‘è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1ã€‚ initialDelaySeconds: 20 # å®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’ timeoutSeconds: 10 # æ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’ã€‚ periodSeconds: 10 # æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’ã€‚ restartPolicy: Always volumes: - name: mysql-nfs persistentVolumeClaim: claimName: mysql-nfs selector: matchLabels: app: wordpress tier: mysql wordpressæ•°æ®æŒä¹…åŒ– wordpress-nfs.yaml ä½†æ˜¯ç”±äº Wordpress åº”ç”¨æ˜¯å¤šä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥éœ€è¦åŒæ—¶åœ¨å¤šä¸ªèŠ‚ç‚¹è¿›è¡Œè¯»å†™ï¼Œä¹Ÿå°±æ˜¯Â accessModesÂ éœ€è¦Â ReadWriteManyÂ æ¨¡å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: PersistentVolumeClaim metadata: name: wordpress-nfs namespace: kube-example labels: app: wordpress spec: storageClassName: \u0026#34;nfs-client\u0026#34; accessModes: - ReadWriteMany resources: requests: storage: 2G wordpress.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 apiVersion: v1 kind: Service metadata: name: wordpress namespace: kube-example spec: selector: app: wordpress tier: frontend ports: - port: 80 name: web targetPort: wdport type: ClusterIP --- apiVersion: apps/v1 kind: Deployment metadata: name: wordpress namespace: kube-example labels: app: wordpress tier: frontend spec: selector: matchLabels: app: wordpress tier: frontend replicas: 3 #å¤šå‰¯æœ¬+podçš„åäº²åˆåŠ›å¯ä»¥å®ç°podçš„é«˜å¯ç”¨ template: metadata: name: wordpress labels: app: wordpress tier: frontend spec: containers: - name: wordpress image: wordpress:5.3.2-apache ports: - containerPort: 80 name: wdport #pvcæŒ‚è½½åˆ°å®¹å™¨ç›®å½• volumeMounts: - mountPath: /var/www/html name: wordpress-nfs env: - name: WORDPRESS_DB_HOST valueFrom: secretKeyRef: key: WORDPRESS_DB_HOST name: db.conf - name: WORDPRESS_DB_USER valueFrom: secretKeyRef: key: WORDPRESS_DB_USER name: db.conf - name: WORDPRESS_DB_PASSWORD valueFrom: secretKeyRef: key: WORDPRESS_DB_PASSWORD name: db.conf imagePullPolicy: IfNotPresent resources: limits: cpu: 800m memory: 150Mi requests: cpu: 800m memory: 150Mi startupProbe: #é¦–æ¬¡å¯åŠ¨æ¢æµ‹ï¼ˆå¦‚æœæ²¡æœ‰æˆåŠŸï¼Œä¸ä¼šè¿è¡Œä¸‹é¢livenessProbeï¼‰ httpGet: port: 80 failureThreshold: 2 #æ¢æµ‹æˆåŠŸåï¼Œæœ€å°‘è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1ã€‚ initialDelaySeconds: 20 # å®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’ timeoutSeconds: 10 # æ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’ã€‚ periodSeconds: 5 # æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’ã€‚ readinessProbe: # ï¼ˆå°±ç»ªæ£€æŸ¥ï¼‰ # å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œkubernetesä¼šæŠŠPodä»service endpointsä¸­å‰”é™¤ tcpSocket: port: 80 initialDelaySeconds: 10 timeoutSeconds: 5 failureThreshold: 5 periodSeconds: 5 successThreshold: 3 affinity: podAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: topologyKey: kubernetes.io/hostname labelSelector: matchExpressions: - key: app operator: In values: - wordpress restartPolicy: Always #æŒ‚è½½çš„pvc volumes: - name: wordpress-nfs persistentVolumeClaim: claimName: wordpress-nfs æµ‹è¯• ç°åœ¨åˆ é™¤æˆ–è€…é‡å¯podçš„æ•°æ®éƒ½ä¸ä¼šä¸¢å¤±ï¼Œæˆ‘ä»¬å·²ç»æŠŠæ•°æ®æ”¾åœ¨å›ºå®šçš„èŠ‚ç‚¹ï¼Œé€šè¿‡ç½‘ç»œè¿›è¡Œè®¿é—®\nä½†æ˜¯ï¼ŒNFSåªé€‚åˆæµ‹è¯•ç¯å¢ƒï¼Œæˆ–è€…æ•°æ®ä¸é‡è¦çš„å‰æä¸‹ã€‚å¦‚æœæ•°æ®é‡è¦ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨cephæ¥ä½œä¸ºKubernetesçš„å­˜å‚¨åç«¯\nå¥½äº†ï¼Œæˆ‘ä»¬wordpressæ¨¡æ‹Ÿæ¥è¿‘å°¾å£°ï¼Œä½†æ˜¯æˆ‘è¿™äº›åªå®Œæˆä¸€ç‰ˆï¼Œç”Ÿäº§ç¯å¢ƒè¿œè¿œæ¯”è¿™å¤æ‚å’Œå®‰å…¨ï¼Œæˆ‘ä»¬åæœŸå¯ä»¥ä¸æ–­æ…¢æ…¢çš„å®Œå–„\n","date":"2021-04-08T00:01:28Z","image":"https://www.ownit.top/title_pic/12.jpg","permalink":"https://www.ownit.top/p/202104080001/","title":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸ƒï¼ˆwordpressçš„æ•°æ®æŒä¹…åŒ–ï¼‰"},{"content":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸€ï¼ˆwordpressåŸºç¡€ç‰ˆï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹ŸäºŒï¼ˆwordpressé«˜å¯ç”¨ï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸‰ï¼ˆwordpresså¥åº·æ£€æŸ¥å’ŒæœåŠ¡è´¨é‡QoSï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿå››ï¼ˆwordpresså‡çº§æ›´æ–°ï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿäº”ï¼ˆwordpressçš„HPAè‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰ æºç åœ°å€ï¼šhttps://github.com/nangongchengfeng/Kubernetes/tree/main/wordpress-example\nKuberneteså®æˆ˜æ¨¡æ‹Ÿäº”ï¼Œå·²ç»æ„å»ºwordpressçš„HPAè‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œå¯ä»¥é¢å¯¹ä¸šåŠ¡å¹¶å‘\nç‰ˆæœ¬6 æ€è·¯ï¼šæƒ³mysqlå’Œwordpressï¼Œäº¤äº’è¿æ¥æ—¶ï¼Œéœ€è¦è´¦å·å’Œå¯†ç ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æ˜æ–‡æ˜¾ç¤ºï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨secretsåŠ å¯†ï¼Œç„¶åæŒ‚è½½åˆ°envç¯å¢ƒä¸­ã€‚\nå®‰å…¨æ€§è¿™ä¸ªå’Œå…·ä½“çš„ä¸šåŠ¡åº”ç”¨æœ‰å…³ç³»ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„ Wordpress ä¹Ÿå°±æ˜¯æ•°æ®åº“çš„å¯†ç å±äºæ¯”è¾ƒç§å¯†çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Kubernetes ä¸­çš„ Secret èµ„æºå¯¹è±¡æ¥å­˜å‚¨æ¯”è¾ƒç§å¯†çš„ä¿¡æ¯\nsecrets db-secrets.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: v1 data: WORDPRESS_DB_HOST: d29yZHByZXNzLW15c3FsOjMzMDY= WORDPRESS_DB_PASSWORD: d29yZHByZXNz WORDPRESS_DB_USER: d29yZHByZXNz MYSQL_ROOT_PASSWORD: cm9vdFBhc3NXMHJk MYSQL_DATABASE: d29yZHByZXNz kind: Secret metadata: name: db.conf namespace: kube-example type: Opaque è¿™è¾¹å½“æ—¶é‡è§ä¸€ä¸ªé—®é¢˜Â https://blog.csdn.net/heian_99/article/details/115486589Â å·²ç»è§£å†³ï¼Œå¯ä»¥å‚ç…§è¿™ä¸ªã€‚\nç„¶åå°†Deployment èµ„æºå¯¹è±¡ä¸­çš„æ•°æ®åº“å¯†ç ç¯å¢ƒå˜é‡é€šè¿‡ Secret å¯¹è±¡è¯»å–\nmysql.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 apiVersion: v1 kind: Service metadata: name: wordpress-mysql namespace: kube-example labels: app: wordpress spec: selector: app: wordpress tier: mysql ports: - port: 3306 targetPort: dbport --- apiVersion: apps/v1 kind: Deployment metadata: name: wordpress-mysql namespace: kube-example labels: app: wordpress tier: mysql spec: replicas: 1 template: metadata: name: wordpress-mysql labels: app: wordpress tier: mysql spec: containers: - name: mysql image: mysql:5.7 args: - --default_authentication_plugin=mysql_native_password - --character-set-server=utf8mb4 - --collation-server=utf8mb4_unicode_ci ports: - containerPort: 3306 name: dbport #ç¯å¢ƒæ³¨å…¥ env: - name: MYSQL_ROOT_PASSWORD valueFrom: secretKeyRef: key: MYSQL_ROOT_PASSWORD name: db.conf - name: MYSQL_DATABASE valueFrom: secretKeyRef: key: MYSQL_DATABASE name: db.conf - name: MYSQL_USER valueFrom: secretKeyRef: key: WORDPRESS_DB_USER name: db.conf - name: MYSQL_PASSWORD valueFrom: secretKeyRef: key: WORDPRESS_DB_PASSWORD name: db.conf imagePullPolicy: IfNotPresent resources: limits: cpu: 1000m memory: 400Mi requests: cpu: 1000m memory: 400Mi startupProbe: #é¦–æ¬¡å¯åŠ¨æ¢æµ‹ï¼ˆå¦‚æœæ²¡æœ‰æˆåŠŸï¼Œä¸ä¼šè¿è¡Œä¸‹é¢livenessProbeï¼‰ tcpSocket: port: 3306 failureThreshold: 2 #æ¢æµ‹æˆåŠŸåï¼Œæœ€å°‘è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1ã€‚ initialDelaySeconds: 20 # å®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’ timeoutSeconds: 10 # æ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’ã€‚ periodSeconds: 10 # æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’ã€‚ restartPolicy: Always selector: matchLabels: app: wordpress tier: mysql wordpress.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 apiVersion: v1 kind: Service metadata: name: wordpress namespace: kube-example spec: selector: app: wordpress tier: frontend ports: - port: 80 name: web targetPort: wdport type: ClusterIP --- apiVersion: apps/v1 kind: Deployment metadata: name: wordpress namespace: kube-example labels: app: wordpress tier: frontend spec: selector: matchLabels: app: wordpress tier: frontend replicas: 3 #å¤šå‰¯æœ¬+podçš„åäº²åˆåŠ›å¯ä»¥å®ç°podçš„é«˜å¯ç”¨ template: metadata: name: wordpress labels: app: wordpress tier: frontend spec: containers: - name: wordpress image: wordpress:5.3.2-apache ports: - containerPort: 80 name: wdport # ç¯å¢ƒæ³¨å…¥ env: - name: WORDPRESS_DB_HOST valueFrom: secretKeyRef: key: WORDPRESS_DB_HOST name: db.conf - name: WORDPRESS_DB_USER valueFrom: secretKeyRef: key: WORDPRESS_DB_USER name: db.conf - name: WORDPRESS_DB_PASSWORD valueFrom: secretKeyRef: key: WORDPRESS_DB_PASSWORD name: db.conf imagePullPolicy: IfNotPresent resources: limits: cpu: 800m memory: 150Mi requests: cpu: 800m memory: 150Mi startupProbe: #é¦–æ¬¡å¯åŠ¨æ¢æµ‹ï¼ˆå¦‚æœæ²¡æœ‰æˆåŠŸï¼Œä¸ä¼šè¿è¡Œä¸‹é¢livenessProbeï¼‰ httpGet: port: 80 failureThreshold: 2 #æ¢æµ‹æˆåŠŸåï¼Œæœ€å°‘è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1ã€‚ initialDelaySeconds: 20 # å®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’ timeoutSeconds: 10 # æ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’ã€‚ periodSeconds: 5 # æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’ã€‚ readinessProbe: # ï¼ˆå°±ç»ªæ£€æŸ¥ï¼‰ # å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œkubernetesä¼šæŠŠPodä»service endpointsä¸­å‰”é™¤ tcpSocket: port: 80 initialDelaySeconds: 10 timeoutSeconds: 5 failureThreshold: 5 periodSeconds: 5 successThreshold: 3 affinity: podAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: topologyKey: kubernetes.io/hostname labelSelector: matchExpressions: - key: app operator: In values: - wordpress restartPolicy: Always è¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šåœ¨ YAML æ–‡ä»¶ä¸­çœ‹åˆ°æ˜æ–‡çš„æ•°æ®åº“å¯†ç äº†ï¼Œå½“ç„¶å®‰å…¨æ€§éƒ½æ˜¯ç›¸å¯¹çš„ï¼ŒSecret èµ„æºå¯¹è±¡ä¹Ÿåªæ˜¯ç®€å•çš„å°†å¯†ç åšäº†ä¸€æ¬¡ Base64 ç¼–ç è€Œå·²ï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šåœºæ™¯å®‰å…¨æ€§è¦æ±‚éå¸¸é«˜çš„åº”ç”¨ï¼Œå°±éœ€è¦ä½¿ç”¨å…¶ä»–åŠŸèƒ½æ›´åŠ å¼ºå¤§çš„å¯†ç ç³»ç»Ÿæ¥è¿›è¡Œç®¡ç†äº†ï¼Œæ¯”å¦‚Â Vaultã€‚\næˆ‘ä»¬çš„é…ç½®ä¹Ÿè®©Secretç®¡ç†ï¼Œä¹Ÿæ–¹ä¾¿ä¿®æ”¹å’Œé…ç½®\n","date":"2021-04-07T16:57:04Z","image":"https://www.ownit.top/title_pic/58.jpg","permalink":"https://www.ownit.top/p/202104071657/","title":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿå…­ï¼ˆwordpressçš„è´¦å·ä¿¡æ¯åŠ å¯†ï¼‰"},{"content":"é”™è¯¯é—®é¢˜ åŸå› ï¼šæŠŠMySQLçš„ç”¨æˆ·å¯†ç é…ç½®æˆsecretsï¼Œç„¶åæŒ‚è½½mysqlï¼Œmysqlä¼šä¸€ç›´æŠ¥é”™ï¼Œæ— æ³•å®Œæˆåˆå§‹\n1 2 3 4 5 6 7 8 9 Version: \u0026#39;5.7.33\u0026#39; socket: \u0026#39;/var/run/mysqld/mysqld.sock\u0026#39; port: 0 MySQL Community Server (GPL) 2021-04-07 15:06:32+08:00 [Note] [Entrypoint]: Temporary server started. Warning: Unable to load \u0026#39;/usr/share/zoneinfo/iso3166.tab\u0026#39; as time zone. Skipping it. Warning: Unable to load \u0026#39;/usr/share/zoneinfo/leap-seconds.list\u0026#39; as time zone. Skipping it. 2021-04-07T07:06:58.526144Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 24159ms. The settings might not be optimal. (flushed=200 and evicted=0, during the time.) Warning: Unable to load \u0026#39;/usr/share/zoneinfo/zone.tab\u0026#39; as time zone. Skipping it. Warning: Unable to load \u0026#39;/usr/share/zoneinfo/zone1970.tab\u0026#39; as time zone. Skipping it. 2021-04-07 15:06:58+08:00 [Note] [Entrypoint]: Creating database wordpress mysql: [ERROR] unknown option \u0026#39;--\u0026#34;\u0026#39; è§£å†³é—®é¢˜ é—®é¢˜æ˜¯æˆ‘ä½¿ç”¨è¯¥echo 'secret' | base64å‘½ä»¤åˆ›å»ºäº†æˆ‘çš„æœºå¯†ï¼Œè€Œechoå‘½ä»¤è‡ªåŠ¨æ’å…¥äº†ç»“å°¾çš„æ¢è¡Œç¬¦ã€‚\nä½¿ç”¨echo \\-n 'secret'Â | base64ä»£æ›¿ã€‚âœ”ï¸\nå› æ­¤æˆ‘æ²¡æœ‰æ³¨æ„åˆ°æ—¥å¿—è¾“å‡ºä¸­æœ‰æ¢è¡Œç¬¦ã€‚å¸Œæœ›è¿™å¯ä»¥å¸®åŠ©ä¸€äº›ä¹Ÿä½¿ç”¨echoå‘½ä»¤å¯¹base64è¿›è¡Œç¼–ç çš„äººã€‚\nå‚è€ƒæ–‡ç« ï¼šÂ https://stackoverflow.com/questions/62985541/mysql-unknown-option-in-kubernetes#\n","date":"2021-04-07T15:28:32Z","image":"https://www.ownit.top/title_pic/49.jpg","permalink":"https://www.ownit.top/p/202104071528/","title":"mysql-unknown-option-in-kubernetesé”™è¯¯"},{"content":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸€ï¼ˆwordpressåŸºç¡€ç‰ˆï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹ŸäºŒï¼ˆwordpressé«˜å¯ç”¨ï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸‰ï¼ˆwordpresså¥åº·æ£€æŸ¥å’ŒæœåŠ¡è´¨é‡QoSï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿå››ï¼ˆwordpresså‡çº§æ›´æ–°ï¼‰ æºç åœ°å€ï¼šhttps://github.com/nangongchengfeng/Kubernetes/tree/main/wordpress-example\nKuberneteså®æˆ˜æ¨¡æ‹Ÿå››ï¼Œå·²ç»æ„å»ºwordpressçš„æ›´æ–°å‡çº§ç­–ç•¥ï¼Œç¡®ä¿åæœŸå‡çº§æ—¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿç¨³å®šçš„æä¾›ä¸šåŠ¡ï¼Œä¸è¢«å‡çº§å¸¦æ¥å½±å“\nç‰ˆæœ¬5 æ€è·¯ï¼šç±»ä¼¼wordpressæ˜¯é™æ€æœåŠ¡ï¼Œå½“æ•°æ®è®¿é—®è¿‡å¤§æ—¶ï¼Œå†…å­˜å’Œcpuéƒ½ä¼šä¸Šå‡ï¼Œè¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æé«˜podçš„æ•°é‡ï¼Œæ¥åˆ†è§£å‹åŠ›ã€‚æˆ‘ä»¬æœ‰ä¸å¯èƒ½å®æ—¶ç›‘æ§æ•°æ®ï¼Œæ‰‹åŠ¨æ‰©ç¼©å®¹ã€æ‰€æœ‰æˆ‘ä»¬é‡‡ç”¨HPAçš„è‡ªåŠ¨æ‰©ç¼©å®¹æ¥å®ç°åŠ¨æ€æ§åˆ¶ã€‚\nHPAæ˜¯kubernetesé‡Œé¢podå¼¹æ€§ä¼¸ç¼©çš„å®ç°,å®ƒèƒ½æ ¹æ®è®¾ç½®çš„ç›‘æ§é˜€å€¼è¿›è¡Œpodçš„å¼¹æ€§æ‰©ç¼©å®¹ï¼Œç›®å‰é»˜è®¤HPAåªèƒ½æ”¯æŒcpuå’Œå†…å­˜çš„é˜€å€¼æ£€æµ‹æ‰©ç¼©å®¹ï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡custom metric api è°ƒç”¨prometheuså®ç°è‡ªå®šä¹‰metric æ¥æ›´åŠ çµæ´»çš„ç›‘æ§æŒ‡æ ‡å®ç°å¼¹æ€§ä¼¸ç¼©ã€‚ä½†hpaä¸èƒ½ç”¨äºä¼¸ç¼©ä¸€äº›æ— æ³•è¿›è¡Œç¼©æ”¾çš„æ§åˆ¶å™¨å¦‚DaemonSetã€‚è¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯resource metric api.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 apiVersion: autoscaling/v2beta2 kind: HorizontalPodAutoscaler metadata: name: php-apache namespace: default spec: # HPAçš„ä¼¸ç¼©å¯¹è±¡æè¿°ï¼ŒHPAä¼šåŠ¨æ€ä¿®æ”¹è¯¥å¯¹è±¡çš„podæ•°é‡ scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: php-apache # HPAçš„æœ€å°podæ•°é‡å’Œæœ€å¤§podæ•°é‡ minReplicas: 1 maxReplicas: 10 # ç›‘æ§çš„æŒ‡æ ‡æ•°ç»„ï¼Œæ”¯æŒå¤šç§ç±»å‹çš„æŒ‡æ ‡å…±å­˜ metrics: # Objectç±»å‹çš„æŒ‡æ ‡ - type: Object object: metric: # æŒ‡æ ‡åç§° name: requests-per-second # ç›‘æ§æŒ‡æ ‡çš„å¯¹è±¡æè¿°ï¼ŒæŒ‡æ ‡æ•°æ®æ¥æºäºè¯¥å¯¹è±¡ describedObject: apiVersion: networking.k8s.io/v1beta1 kind: Ingress name: main-route # Valueç±»å‹çš„ç›®æ ‡å€¼ï¼ŒObjectç±»å‹çš„æŒ‡æ ‡åªæ”¯æŒValueå’ŒAverageValueç±»å‹çš„ç›®æ ‡å€¼ target: type: Value value: 10k # Resourceç±»å‹çš„æŒ‡æ ‡ - type: Resource resource: name: cpu # Utilizationç±»å‹çš„ç›®æ ‡å€¼ï¼ŒResourceç±»å‹çš„æŒ‡æ ‡åªæ”¯æŒUtilizationå’ŒAverageValueç±»å‹çš„ç›®æ ‡å€¼ target: type: Utilization averageUtilization: 50 # Podsç±»å‹çš„æŒ‡æ ‡ - type: Pods pods: metric: name: packets-per-second # AverageValueç±»å‹çš„ç›®æ ‡å€¼ï¼ŒPodsæŒ‡æ ‡ç±»å‹ä¸‹åªæ”¯æŒAverageValueç±»å‹çš„ç›®æ ‡å€¼ target: type: AverageValue averageValue: 1k # Externalç±»å‹çš„æŒ‡æ ‡ - type: External external: metric: name: queue_messages_ready # è¯¥å­—æ®µä¸ç¬¬ä¸‰æ–¹çš„æŒ‡æ ‡æ ‡ç­¾ç›¸å…³è”ï¼Œï¼ˆæ­¤å¤„å®˜æ–¹æ–‡æ¡£æœ‰é—®é¢˜ï¼Œæ­£ç¡®çš„å†™æ³•å¦‚ä¸‹ï¼‰ selector: matchLabels: env: \u0026#34;stage\u0026#34; app: \u0026#34;myapp\u0026#34; # ExternalæŒ‡æ ‡ç±»å‹ä¸‹åªæ”¯æŒValueå’ŒAverageValueç±»å‹çš„ç›®æ ‡å€¼ target: type: AverageValue averageValue: 30 autoscaling/v1ç‰ˆæœ¬å°†metricså­—æ®µæ”¾åœ¨äº†annotationä¸­è¿›è¡Œå¤„ç†ã€‚\ntargetå…±æœ‰3ç§ç±»å‹ï¼šUtilizationã€Valueã€AverageValueã€‚Utilizationè¡¨ç¤ºå¹³å‡ä½¿ç”¨ç‡ï¼›Valueè¡¨ç¤ºè£¸å€¼ï¼›AverageValueè¡¨ç¤ºå¹³å‡å€¼ã€‚\nmetricsä¸­çš„typeå­—æ®µæœ‰å››ç§ç±»å‹çš„å€¼ï¼šObjectã€Podsã€Resourceã€Externalã€‚\nResourceæŒ‡çš„æ˜¯å½“å‰ä¼¸ç¼©å¯¹è±¡ä¸‹çš„podçš„cpuå’ŒmemoryæŒ‡æ ‡ï¼Œåªæ”¯æŒUtilizationå’ŒAverageValueç±»å‹çš„ç›®æ ‡å€¼ã€‚\nObjectæŒ‡çš„æ˜¯æŒ‡å®šk8så†…éƒ¨å¯¹è±¡çš„æŒ‡æ ‡ï¼Œæ•°æ®éœ€è¦ç¬¬ä¸‰æ–¹adapteræä¾›ï¼Œåªæ”¯æŒValueå’ŒAverageValueç±»å‹çš„ç›®æ ‡å€¼ã€‚\nPodsæŒ‡çš„æ˜¯ä¼¸ç¼©å¯¹è±¡ï¼ˆstatefulSetã€replicaControllerã€replicaSetï¼‰åº•ä¸‹çš„Podsçš„æŒ‡æ ‡ï¼Œæ•°æ®éœ€è¦ç¬¬ä¸‰æ–¹çš„adapteræä¾›ï¼Œå¹¶ä¸”åªå…è®¸AverageValueç±»å‹çš„ç›®æ ‡å€¼ã€‚\nExternalæŒ‡çš„æ˜¯k8så¤–éƒ¨çš„æŒ‡æ ‡ï¼Œæ•°æ®åŒæ ·éœ€è¦ç¬¬ä¸‰æ–¹çš„adapteræä¾›ï¼Œåªæ”¯æŒValueå’ŒAverageValueç±»å‹çš„ç›®æ ‡å€¼ã€‚ HPAåŠ¨æ€ä¼¸ç¼©çš„åŸç†\nHPAåœ¨k8sä¸­ä¹Ÿç”±ä¸€ä¸ªcontrolleræ§åˆ¶ï¼Œcontrollerä¼šé—´éš”å¾ªç¯HPAï¼Œæ£€æŸ¥æ¯ä¸ªHPAä¸­ç›‘æ§çš„æŒ‡æ ‡æ˜¯å¦è§¦å‘ä¼¸ç¼©æ¡ä»¶ï¼Œé»˜è®¤çš„é—´éš”æ—¶é—´ä¸º15sã€‚ä¸€æ—¦è§¦å‘ä¼¸ç¼©æ¡ä»¶ï¼Œcontrollerä¼šå‘k8så‘é€è¯·æ±‚ï¼Œä¿®æ”¹ä¼¸ç¼©å¯¹è±¡ï¼ˆstatefulSetã€replicaControllerã€replicaSetï¼‰å­å¯¹è±¡scaleä¸­æ§åˆ¶podæ•°é‡çš„å­—æ®µã€‚k8så“åº”è¯·æ±‚ï¼Œä¿®æ”¹scaleç»“æ„ä½“ï¼Œç„¶åä¼šåˆ·æ–°ä¸€æ¬¡ä¼¸ç¼©å¯¹è±¡çš„podæ•°é‡ã€‚ä¼¸ç¼©å¯¹è±¡è¢«ä¿®æ”¹åï¼Œè‡ªç„¶ä¼šé€šè¿‡list/watchæœºåˆ¶å¢åŠ æˆ–å‡å°‘podæ•°é‡ï¼Œè¾¾åˆ°åŠ¨æ€ä¼¸ç¼©çš„ç›®çš„ã€‚ HPAä¼¸ç¼©è¿‡ç¨‹å™è¿°\nHPAçš„ä¼¸ç¼©ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š åˆ¤æ–­å½“å‰podæ•°é‡æ˜¯å¦åœ¨HPAè®¾å®šçš„podæ•°é‡åŒºé—´ä¸­ï¼Œå¦‚æœä¸åœ¨ï¼Œè¿‡å°è¿”å›æœ€å°å€¼ï¼Œè¿‡å¤§è¿”å›æœ€å¤§å€¼ï¼Œç»“æŸä¼¸ç¼©ã€‚ åˆ¤æ–­æŒ‡æ ‡çš„ç±»å‹ï¼Œå¹¶å‘api serverå‘é€å¯¹åº”çš„è¯·æ±‚ï¼Œæ‹¿åˆ°è®¾å®šçš„ç›‘æ§æŒ‡æ ‡ã€‚ä¸€èˆ¬æ¥è¯´æŒ‡æ ‡ä¼šæ ¹æ®é¢„å…ˆè®¾å®šçš„æŒ‡æ ‡ä»ä»¥ä¸‹ä¸‰ä¸ªaggregated APIsä¸­è·å–ï¼šmetrics.k8s.ioã€custom.metrics.k8s.ioã€Â external.metrics.k8s.ioã€‚å…¶ä¸­metrics.k8s.ioä¸€èˆ¬ç”±k8sè‡ªå¸¦çš„metrics-serveræ¥æä¾›ï¼Œä¸»è¦æ˜¯cpuï¼Œmemoryä½¿ç”¨ç‡æŒ‡æ ‡ï¼Œå¦å¤–ä¸¤ç§éœ€è¦ç¬¬ä¸‰æ–¹çš„adapteræ¥æä¾›ã€‚custom.metrics.k8s.ioæä¾›è‡ªå®šä¹‰æŒ‡æ ‡æ•°æ®ï¼Œä¸€èˆ¬è·Ÿk8sé›†ç¾¤æœ‰å…³ï¼Œæ¯”å¦‚è·Ÿç‰¹å®šçš„podç›¸å…³ã€‚external.metrics.k8s.ioåŒæ ·æä¾›è‡ªå®šä¹‰æŒ‡æ ‡æ•°æ®ï¼Œä½†ä¸€èˆ¬è·Ÿk8sé›†ç¾¤æ— å…³ã€‚è®¸å¤šçŸ¥åçš„ç¬¬ä¸‰æ–¹ç›‘æ§å¹³å°æä¾›äº†adapterå®ç°äº†ä¸Šè¿°apiï¼ˆå¦‚prometheusï¼‰ï¼Œå¯ä»¥å°†ç›‘æ§å’Œadapterä¸€åŒéƒ¨ç½²åœ¨k8sé›†ç¾¤ä¸­æä¾›æœåŠ¡ï¼Œç”šè‡³èƒ½å¤Ÿæ›¿æ¢åŸæ¥çš„metrics-serveræ¥æä¾›ä¸Šè¿°ä¸‰ç±»apiæŒ‡æ ‡ï¼Œè¾¾åˆ°æ·±åº¦å®šåˆ¶ç›‘æ§æ•°æ®çš„ç›®çš„ã€‚ æ ¹æ®è·å¾—çš„æŒ‡æ ‡ï¼Œåº”ç”¨ç›¸åº”çš„ç®—æ³•ç®—å‡ºä¸€ä¸ªä¼¸ç¼©ç³»æ•°ï¼Œå¹¶ä¹˜ä»¥ç›®å‰podæ•°é‡è·å¾—æœŸæœ›podæ•°é‡ã€‚ç³»æ•°æ˜¯æŒ‡æ ‡çš„æœŸæœ›å€¼ä¸ç›®å‰å€¼çš„æ¯”å€¼ï¼Œå¦‚æœå¤§äº1è¡¨ç¤ºæ‰©å®¹ï¼Œå°äº1è¡¨ç¤ºç¼©å®¹ã€‚æŒ‡æ ‡æ•°å€¼æœ‰å¹³å‡å€¼ï¼ˆAverageValueï¼‰ã€å¹³å‡ä½¿ç”¨ç‡ï¼ˆUtilizationï¼‰ã€è£¸å€¼ï¼ˆValueï¼‰ä¸‰ç§ç±»å‹ï¼Œæ¯ç§ç±»å‹çš„æ•°å€¼éƒ½æœ‰å¯¹åº”çš„ç®—æ³•ã€‚ä»¥ä¸‹å‡ ç‚¹å€¼å¾—æ³¨æ„ï¼šå¦‚æœç³»æ•°æœ‰å°æ•°ç‚¹ï¼Œç»Ÿä¸€è¿›ä¸€ï¼›ç³»æ•°å¦‚æœæœªè¾¾åˆ°æŸä¸ªå®¹å¿å€¼ï¼ŒHPAè®¤ä¸ºå˜åŒ–å¤ªå°ï¼Œä¼šå¿½ç•¥è¿™æ¬¡å˜åŒ–ï¼Œå®¹å¿å€¼é»˜è®¤ä¸º0.1ã€‚\nHPAæ‰©å®¹ç®—æ³•æ˜¯ä¸€ä¸ªéå¸¸ä¿å®ˆçš„ç®—æ³•ã€‚å¦‚æœå‡ºç°è·å–ä¸åˆ°æŒ‡æ ‡çš„æƒ…å†µï¼Œæ‰©å®¹æ—¶ç®—æœ€å°å€¼ï¼Œç¼©å®¹æ—¶ç®—æœ€å¤§å€¼ï¼›å¦‚æœéœ€è¦è®¡ç®—å¹³å‡å€¼ï¼Œå‡ºç°podæ²¡å‡†å¤‡å¥½çš„æƒ…å†µï¼Œå¹³å‡æ•°çš„åˆ†æ¯ä¸è®¡å…¥è¯¥podã€‚\nä¸€ä¸ªHPAæ”¯æŒå¤šä¸ªæŒ‡æ ‡çš„ç›‘æ§ï¼ŒHPAä¼šå¾ªç¯è·å–æ‰€æœ‰çš„æŒ‡æ ‡ï¼Œå¹¶è®¡ç®—æœŸæœ›çš„podæ•°é‡ï¼Œå¹¶ä»æœŸæœ›ç»“æœä¸­è·å¾—æœ€å¤§çš„podæ•°é‡ä½œä¸ºæœ€ç»ˆçš„ä¼¸ç¼©çš„podæ•°é‡ã€‚ä¸€ä¸ªä¼¸ç¼©å¯¹è±¡åœ¨k8sä¸­å…è®¸å¯¹åº”å¤šä¸ªHPAï¼Œä½†æ˜¯åªæ˜¯k8sä¸ä¼šæŠ¥é”™è€Œå·²ï¼Œäº‹å®ä¸ŠHPAå½¼æ­¤ä¸çŸ¥é“è‡ªå·±ç›‘æ§çš„æ˜¯åŒä¸€ä¸ªä¼¸ç¼©å¯¹è±¡ï¼Œåœ¨è¿™ä¸ªä¼¸ç¼©å¯¹è±¡ä¸­çš„podä¼šè¢«å¤šä¸ªHPAæ— æ„ä¹‰åœ°æ¥å›ä¿®æ”¹podæ•°é‡ï¼Œç»™ç³»ç»Ÿå¢åŠ æ¶ˆè€—ï¼Œå¦‚æœæƒ³è¦æŒ‡å®šå¤šä¸ªç›‘æ§æŒ‡æ ‡ï¼Œå¯ä»¥å¦‚ä¸Šè¿°æ‰€è¯´ï¼Œåœ¨ä¸€ä¸ªHPAä¸­æ·»åŠ å¤šä¸ªç›‘æ§æŒ‡æ ‡ã€‚ æ£€æŸ¥æœ€ç»ˆçš„podæ•°é‡æ˜¯å¦åœ¨HPAè®¾å®šçš„podæ•°é‡èŒƒå›´çš„åŒºé—´ï¼Œå¦‚æœè¶…è¿‡æœ€å¤§å€¼æˆ–ä¸è¶³æœ€å°å€¼éƒ½ä¼šä¿®æ”¹ä¸ºæœ€å¤§å€¼æˆ–æœ€å°å€¼ã€‚ç„¶åå‘k8så‘å‡ºè¯·æ±‚ï¼Œä¿®æ”¹ä¼¸ç¼©å¯¹è±¡çš„å­å¯¹è±¡scaleçš„podæ•°é‡ï¼Œç»“æŸä¸€ä¸ªHPAçš„æ£€æŸ¥ï¼Œè·å–ä¸‹ä¸€ä¸ªHPAï¼Œå®Œæˆä¸€ä¸ªä¼¸ç¼©æµç¨‹ã€‚ å‚ç…§åšå®¢:https://www.cnblogs.com/yuhaohao/p/14109787.html\nhttps://zhuanlan.zhihu.com/p/89453704\nHPA ç°åœ¨åº”ç”¨æ˜¯å›ºå®šçš„3ä¸ªå‰¯æœ¬ï¼Œä½†æ˜¯å¾€å¾€åœ¨ç”Ÿäº§ç¯å¢ƒæµé‡æ˜¯ä¸å¯æ§çš„ï¼Œå¾ˆæœ‰å¯èƒ½ä¸€æ¬¡æ´»åŠ¨å°±ä¼šæœ‰å¤§é‡çš„æµé‡ï¼Œ3ä¸ªå‰¯æœ¬å¾ˆæœ‰å¯èƒ½æŠ—ä¸ä½å¤§é‡çš„ç”¨æˆ·è¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¸Œæœ›èƒ½å¤Ÿè‡ªåŠ¨å¯¹ Pod è¿›è¡Œä¼¸ç¼©ï¼Œç›´æ¥ä½¿ç”¨å‰é¢æˆ‘ä»¬å­¦ä¹ çš„ HPA è¿™ä¸ªèµ„æºå¯¹è±¡å°±å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚äº†ã€‚\nç›´æ¥ä½¿ç”¨kubectl autoscaleå‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªÂ HPAÂ å¯¹è±¡\n1 2 3 4 5 [root@k8s-master1 ~]# kubectl autoscale deployment wordpress --namespace kube-example --cpu-percent=60 --min=3 --max=6 # cpuè¶…è¿‡60%ä¼šæ‰©å®¹å‰¯æœ¬ horizontalpodautoscaler.autoscaling/wordpress autoscaled [root@k8s-master1 ~]# kubectl get hpa -n kube-example NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE wordpress Deployment/wordpress 1%/60% 3 6 4 20s hpa.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: autoscaling/v1 kind: HorizontalPodAutoscaler metadata: name: wordpress namespace: kube-example spec: maxReplicas: 6 minReplicas: 3 scaleTargetRef: # ç›®æ ‡ä½œç”¨å¯¹è±¡ apiVersion: apps/v1 kind: Deployment name: wordpress targetCPUUtilizationPercentage: 60 #è¯¥ä½¿ç”¨ç‡åŸºäºPodè®¾ç½®çš„CPU Requestå€¼è¿›è¡Œè®¡ç®— scaleTargetRefï¼šç›®æ ‡ä½œç”¨å¯¹è±¡ï¼Œå¯ä»¥æ˜¯Deploymentã€ReplicationControlleræˆ–ReplicaSetã€‚\ntargetCPUUtilizationPercentageï¼šæœŸæœ›æ¯ä¸ªPodçš„CPUä½¿ç”¨ç‡éƒ½ä¸º50%ï¼Œè¯¥ä½¿ç”¨ç‡åŸºäºPodè®¾ç½®çš„CPU Requestå€¼è¿›è¡Œè®¡ç®—ï¼Œä¾‹å¦‚è¯¥å€¼ä¸º200mï¼Œé‚£ä¹ˆç³»ç»Ÿå°†ç»´æŒPodçš„å®é™…CPUä½¿ç”¨å€¼ä¸º100mã€‚\nminReplicaså’ŒmaxReplicasï¼šPodå‰¯æœ¬æ•°é‡çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼Œç³»ç»Ÿå°†åœ¨è¿™ä¸ªèŒƒå›´å†…è¿›è¡Œè‡ªåŠ¨æ‰©ç¼©å®¹æ“ä½œï¼Œ å¹¶ç»´æŒæ¯ä¸ªPodçš„CPUä½¿ç”¨ç‡ä¸º50%ã€‚\nä¸ºäº†ä½¿ç”¨autoscaling/v1ç‰ˆæœ¬çš„HorizontalPodAutoscalerï¼Œéœ€è¦é¢„å…ˆå®‰è£…Heapsterç»„ä»¶æˆ–Metrics Serverï¼Œç”¨äºé‡‡é›†Podçš„CPUä½¿ç”¨ç‡ã€‚\næ­¤å‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ªå…³è”èµ„æº wordpress çš„ HPAï¼Œæœ€å°çš„ Pod å‰¯æœ¬æ•°ä¸º3ï¼Œæœ€å¤§ä¸º6ã€‚HPA ä¼šæ ¹æ®è®¾å®šçš„ cpu ä½¿ç”¨ç‡ï¼ˆ60%ï¼‰åŠ¨æ€çš„å¢åŠ æˆ–è€…å‡å°‘ Pod æ•°é‡ã€‚åŒæ ·ï¼Œä½¿ç”¨ä¸Šé¢çš„ Fortio å·¥å…·æ¥è¿›è¡Œå‹æµ‹ä¸€æ¬¡ï¼Œçœ‹ä¸‹èƒ½å¦è¿›è¡Œè‡ªåŠ¨çš„æ‰©ç¼©å®¹ï¼š\næµ‹è¯• 1 fortio load -a -c 8 -qps 1000 -t 60s \u0026#34;http://wordpress.heian.com/\u0026#34; åœ¨å‹æµ‹çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° HPA çš„çŠ¶æ€å˜åŒ–ä»¥åŠ Pod æ•°é‡ä¹Ÿå˜æˆäº†6ä¸ªï¼š\nå½“å‹æµ‹åœæ­¢ä»¥åæ­£å¸¸5åˆ†é’Ÿåå°±ä¼šè‡ªåŠ¨è¿›è¡Œç¼©å®¹ï¼Œå˜æˆæœ€å°çš„3ä¸ª Pod å‰¯æœ¬ã€‚Â é—®é¢˜ ï¼ˆ1ï¼‰æ•°æ®æŒä¹…åŒ–\nï¼ˆ2ï¼‰mysqlè´¦å·å¯†ç æ³¨å…¥ç­‰\n","date":"2021-04-07T11:17:25Z","image":"https://www.ownit.top/title_pic/46.jpg","permalink":"https://www.ownit.top/p/202104071117/","title":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿäº”ï¼ˆwordpressçš„HPAè‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰"},{"content":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸€ï¼ˆwordpressåŸºç¡€ç‰ˆï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹ŸäºŒï¼ˆwordpressé«˜å¯ç”¨ï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸‰ï¼ˆwordpresså¥åº·æ£€æŸ¥å’ŒæœåŠ¡è´¨é‡QoSï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿå››ï¼ˆwordpresså‡çº§æ›´æ–°ï¼‰ æºç åœ°å€ï¼šhttps://github.com/nangongchengfeng/Kubernetes/tree/main/wordpress-example\nKuberneteså®æˆ˜æ¨¡æ‹Ÿä¸‰ï¼Œå·²ç»æ„å»ºwordpressçš„å¥åº·æ£€æŸ¥å’ŒæœåŠ¡è´¨é‡ï¼Œå¯¹åæœŸçš„ç¨³å®šè¿è¡Œæœ‰ä¸€å®šçš„å¸®åŠ©\nï¼ˆ1ï¼‰startupProbeï¼Œé¦–æ¬¡å¯åŠ¨æ¢æµ‹ï¼Œå¦‚æœæ²¡æœ‰æˆåŠŸï¼Œä¸ä¼šè¿è¡Œä¸‹é¢çš„æ£€æµ‹ã€‚é…ç½®æœ‰restartPolicyï¼šAlways ä¼šè‡ªåŠ¨çš„é‡å¯\nï¼ˆ2ï¼‰å¥åº·æ£€æŸ¥ï¼Œé‡‡å–readinessProbeæ–¹å¼ï¼Œå¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œkubernetesä¼šæŠŠPodä»service endpointsä¸­å‰”é™¤ï¼Œä¸åœ¨æä¾›æµé‡ï¼Œé”™è¯¯ç°åœºä¿ç•™ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜\nï¼ˆ3ï¼‰fortio å‹æµ‹ï¼Œæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒï¼Œç¡®å®šresourcesçš„æ•°å€¼ã€‚é‡‡ç”¨Guaranteed(æœ‰ä¿è¯çš„)ï¼Œé˜²æ­¢å®¿ä¸»æœºèµ„æºä¸å¤Ÿè¢«ä¼˜å…ˆé©±é€\nç‰ˆæœ¬4 æ€è·¯ï¼šç±»ä¼¼wordpressæ˜¯é™æ€æœåŠ¡ï¼ŒåæœŸå¯èƒ½æœ‰ç‰ˆæœ¬çš„å˜æ›´ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æ›´æ–°å’Œå‡çº§podï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¼˜åŒ–å‡çº§æ›´æ–°æ“ä½œ\nKuberneteså®˜æ–¹æ¨èä½¿ç”¨Deploymentæ¥å–ä»£Rep\nlication Controller(rc) ï¼Œä¸¤è€…é—´ä¸»è¦ç›¸åŒç‚¹åŒ…æ‹¬ç¡®ä¿å¤„åœ¨æœåŠ¡çŠ¶æ€çš„Podæ•°é‡(replicas)èƒ½æ»¡è¶³å…ˆå‰æ‰€è®¾å®šçš„å€¼ä»¥åŠæ”¯æ´æ»šåŠ¨å‡çº§(Rolling update)ï¼Œå‰è€…é¢å¤–æ”¯æŒå›æ»š(Roll back)çš„æœºåˆ¶ï¼Œå› æ­¤æ¥ä¸‹æ¥ä¼šä»‹ç»å¦‚ä½•åˆ©ç”¨Deploymentæ¥è¿›è¡Œæ»šåŠ¨å‡çº§ã€‚\n**å›¾ä¸­å¯ä»¥çœ‹åˆ°ä¸€ä¸ªDeploymentæŒç®¡ä¸€æˆ–å¤šä¸ªReplica Set ï¼Œè€Œä¸€ä¸ªReplica SetæŒç®¡ä¸€æˆ–å¤šä¸ªPodÂ **\nç‰ˆæœ¬å‡çº§ 1 2 3 4 5 6 7 strategy: type: RollingUpdate rollingUpdate: maxSurge: 2 maxUnavailable: 2 minReadySeconds: 5 revisionHistoryLimit: 10 # æœ€å¤šä¿ç•™10ä¸ªå‡çº§å‰¯æœ¬ï¼Œä¾¿äºå›æ»š minReadySeconds:\nKubernetesåœ¨ç­‰å¾…è®¾ç½®çš„æ—¶é—´åæ‰è¿›è¡Œå‡çº§Â (å®¹å™¨å†…åº”ç”¨çš„å¯åŠ¨æ—¶é—´, podå˜ä¸ºrunçŠ¶æ€, ä¼šåœ¨minReadySecondsåç»§ç»­æ›´æ–°ä¸‹ä¸€ä¸ªpod.)\nå¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼ŒKubernetesä¼šå‡è®¾è¯¥å®¹å™¨å¯åŠ¨èµ·æ¥åå°±æä¾›æœåŠ¡äº†\nå¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼Œåœ¨æŸäº›æç«¯æƒ…å†µä¸‹å¯èƒ½ä¼šé€ æˆæœåŠ¡ä¸æ­£å¸¸è¿è¡Œ\nmaxSurge:\nå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šå¯ä»¥æ¯”åŸå…ˆè®¾ç½®å¤šå‡ºçš„PODæ•°é‡\nä¾‹å¦‚ï¼šmaxSurage=1ï¼Œreplicas=5,åˆ™è¡¨ç¤ºKubernetesä¼šå…ˆå¯åŠ¨1ä¸€ä¸ªæ–°çš„Podåæ‰åˆ æ‰ä¸€ä¸ªæ—§çš„PODï¼Œæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰5+1ä¸ªPODã€‚\nmaxUnavaible:\nå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šæœ‰å¤šå°‘ä¸ªPODå¤„äºæ— æ³•æä¾›æœåŠ¡çš„çŠ¶æ€\nå½“maxSurgeä¸ä¸º0æ—¶ï¼Œè¯¥å€¼ä¹Ÿä¸èƒ½ä¸º0\nä¾‹å¦‚ï¼šmaxUnavaible=1ï¼Œåˆ™è¡¨ç¤ºKubernetesæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰1ä¸ªPODå¤„äºæ— æ³•æœåŠ¡çš„çŠ¶æ€ã€‚\nDeployment æ§åˆ¶å™¨é»˜è®¤çš„å°±æ˜¯æ»šåŠ¨æ›´æ–°çš„æ›´æ–°ç­–ç•¥ï¼Œè¯¥ç­–ç•¥å¯ä»¥åœ¨ä»»ä½•æ—¶é—´ç‚¹æ›´æ–°åº”ç”¨çš„æ—¶å€™ä¿è¯æŸäº›å®ä¾‹ä¾ç„¶å¯ä»¥æ­£å¸¸è¿è¡Œæ¥é˜²æ­¢åº”ç”¨ down æ‰ï¼Œå½“æ–°éƒ¨ç½²çš„ Pod å¯åŠ¨å¹¶å¯ä»¥å¤„ç†æµé‡ä¹‹åï¼Œæ‰ä¼šå»æ€æ‰æ—§çš„ Podã€‚åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æˆ‘ä»¬è¿˜å¯ä»¥æŒ‡å®š Kubernetes åœ¨æ›´æ–°æœŸé—´å¦‚ä½•å¤„ç†å¤šä¸ªå‰¯æœ¬çš„åˆ‡æ¢æ–¹å¼ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª3å‰¯æœ¬çš„åº”ç”¨ï¼Œåœ¨æ›´æ–°çš„è¿‡ç¨‹ä¸­æ˜¯å¦åº”è¯¥ç«‹å³åˆ›å»ºè¿™3ä¸ªæ–°çš„ Pod å¹¶ç­‰å¾…ä»–ä»¬å…¨éƒ¨å¯åŠ¨ï¼Œæˆ–è€…æ€æ‰ä¸€ä¸ªä¹‹å¤–çš„æ‰€æœ‰æ—§çš„ Podï¼Œæˆ–è€…è¿˜æ˜¯è¦ä¸€ä¸ªä¸€ä¸ªçš„ Pod è¿›è¡Œæ›¿æ¢ï¼Ÿ\nå¦‚æœæˆ‘ä»¬ä»æ—§ç‰ˆæœ¬åˆ°æ–°ç‰ˆæœ¬è¿›è¡Œæ»šåŠ¨æ›´æ–°ï¼Œåªæ˜¯ç®€å•çš„é€šè¿‡è¾“å‡ºæ˜¾ç¤ºæ¥åˆ¤æ–­å“ªäº› Pod æ˜¯å­˜æ´»å¹¶å‡†å¤‡å°±ç»ªçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ»šåŠ¨æ›´æ–°çš„è¡Œä¸ºçœ‹ä¸Šå»è‚¯å®šå°±æ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ˜¯å¾€å¾€å®é™…æƒ…å†µå°±æ˜¯ä»æ—§ç‰ˆæœ¬åˆ°æ–°ç‰ˆæœ¬çš„åˆ‡æ¢çš„è¿‡ç¨‹å¹¶ä¸æ€»æ˜¯ååˆ†é¡ºç•…çš„ï¼Œåº”ç”¨ç¨‹åºå¾ˆæœ‰å¯èƒ½ä¼šä¸¢å¼ƒæ‰æŸäº›å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨ Wordpress åº”ç”¨ä¸­æ·»åŠ ä¸Šå¦‚ä¸‹çš„æ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼Œéšä¾¿æ›´æ”¹ä»¥ä¸‹ Pod Template ä¸­çš„å‚æ•°ï¼Œæ¯”å¦‚å®¹å™¨åæ›´æ”¹ä¸º blogï¼š\nè¿™é‡Œä¿®æ”¹wordpress.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 apiVersion: v1 kind: Service metadata: name: wordpress namespace: kube-example spec: selector: app: wordpress tier: frontend ports: - port: 80 name: web targetPort: wdport type: ClusterIP --- apiVersion: apps/v1 kind: Deployment metadata: name: wordpress namespace: kube-example labels: app: wordpress tier: frontend spec: selector: matchLabels: app: wordpress tier: frontend replicas: 4 #å¤šå‰¯æœ¬+podçš„åäº²åˆåŠ›å¯ä»¥å®ç°podçš„é«˜å¯ç”¨ strategy: # æ»šåŠ¨æ›´æ–°çš„æ›´æ–°ç­–ç•¥ type: RollingUpdate rollingUpdate: maxSurge: 1 # è¡¨ç¤ºKubernetesä¼šå…ˆå¯åŠ¨1ä¸€ä¸ªæ–°çš„Podåæ‰åˆ æ‰ä¸€ä¸ªæ—§çš„PODï¼Œæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰5+1ä¸ªPODã€‚ maxUnavailable: 1 # è¡¨ç¤ºKubernetesæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰1ä¸ªPODå¤„äºæ— æ³•æœåŠ¡çš„çŠ¶æ€ã€‚ minReadySeconds: 5 # å®¹å™¨å†…åº”ç”¨çš„å¯åŠ¨æ—¶é—´, podå˜ä¸ºrunçŠ¶æ€, ä¼šåœ¨minReadySecondsåç»§ç»­æ›´æ–°ä¸‹ä¸€ä¸ªpod. revisionHistoryLimit: 10 # æœ€å¤šä¿ç•™10ä¸ªå‡çº§å‰¯æœ¬ï¼Œä¾¿äºå›æ»š template: metadata: name: wordpress labels: app: wordpress tier: frontend spec: containers: - name: wordpress image: wordpress:5.3.2-apache ports: - containerPort: 80 name: wdport env: - name: WORDPRESS_DB_HOST value: wordpress-mysql:3306 - name: WORDPRESS_DB_USER value: wordpress - name: WORDPRESS_DB_PASSWORD value: wordpress imagePullPolicy: IfNotPresent resources: limits: cpu: 800m memory: 150Mi requests: cpu: 800m memory: 150Mi startupProbe: #é¦–æ¬¡å¯åŠ¨æ¢æµ‹ï¼ˆå¦‚æœæ²¡æœ‰æˆåŠŸï¼Œä¸ä¼šè¿è¡Œä¸‹é¢livenessProbeï¼‰ httpGet: port: 80 failureThreshold: 2 #æ¢æµ‹æˆåŠŸåï¼Œæœ€å°‘è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1ã€‚ initialDelaySeconds: 20 # å®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’ timeoutSeconds: 10 # æ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’ã€‚ periodSeconds: 5 # æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’ã€‚ readinessProbe: # ï¼ˆå°±ç»ªæ£€æŸ¥ï¼‰ # å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œkubernetesä¼šæŠŠPodä»service endpointsä¸­å‰”é™¤ tcpSocket: port: 80 initialDelaySeconds: 10 timeoutSeconds: 5 failureThreshold: 5 periodSeconds: 5 successThreshold: 3 affinity: podAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: topologyKey: kubernetes.io/hostname labelSelector: matchExpressions: - key: app operator: In values: - wordpress restartPolicy: Always æµ‹è¯• è¿è¡Œæ—¶å‹æµ‹\næ›´æ–°æ—¶å‹æµ‹ï¼ˆæ˜¾ç¤º500ï¼‰\né—®é¢˜åˆ†æ ä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥çœ‹å‡ºæœ‰éƒ¨åˆ†è¯·æ±‚å¤„ç†å¤±è´¥äº†ï¼ˆ502ï¼‰ï¼Œè¦å¼„æ¸…æ¥šå¤±è´¥çš„åŸå› å°±éœ€è¦å¼„æ˜ç™½å½“åº”ç”¨åœ¨æ»šåŠ¨æ›´æ–°æœŸé—´é‡æ–°è·¯ç”±æµé‡æ—¶ï¼Œä»æ—§çš„ Pod å®ä¾‹åˆ°æ–°çš„å®ä¾‹ç©¶ç«Ÿä¼šå‘ç”Ÿä»€ä¹ˆï¼Œé¦–å…ˆè®©æˆ‘ä»¬å…ˆçœ‹çœ‹ Kubernetes æ˜¯å¦‚ä½•ç®¡ç†å·¥ä½œè´Ÿè½½è¿æ¥çš„ã€‚\nå¤±è´¥åŸå› \næˆ‘ä»¬è¿™é‡Œé€šè¿‡ NodePort å»è®¿é—®åº”ç”¨ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯é€šè¿‡æ¯ä¸ªèŠ‚ç‚¹ä¸Šé¢çš„Â kube-proxyÂ é€šè¿‡æ›´æ–° iptables è§„åˆ™æ¥å®ç°çš„ã€‚\nKubernetes ä¼šæ ¹æ® Pods çš„çŠ¶æ€å»æ›´æ–° Endpoints å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯ Endpoints ä¸­åŒ…å«çš„éƒ½æ˜¯å‡†å¤‡å¥½å¤„ç†è¯·æ±‚çš„ Podã€‚ä¸€æ—¦æ–°çš„ Pod å¤„äºæ´»åŠ¨çŠ¶æ€å¹¶å‡†å¤‡å°±ç»ªåï¼ŒKubernetes å°±å°†ä¼šåœæ­¢å°±çš„ Podï¼Œä»è€Œå°† Pod çš„çŠ¶æ€æ›´æ–°ä¸ºÂ â€œTerminatingâ€ï¼Œç„¶åä» Endpoints å¯¹è±¡ä¸­ç§»é™¤ï¼Œå¹¶ä¸”å‘é€ä¸€ä¸ªÂ SIGTERMÂ ä¿¡å·ç»™ Pod çš„ä¸»è¿›ç¨‹ã€‚SIGTERMÂ ä¿¡å·å°±ä¼šè®©å®¹å™¨ä»¥æ­£å¸¸çš„æ–¹å¼å…³é—­ï¼Œå¹¶ä¸”ä¸æ¥å—ä»»ä½•æ–°çš„è¿æ¥ã€‚Pod ä» Endpoints å¯¹è±¡ä¸­è¢«ç§»é™¤åï¼Œå‰é¢çš„è´Ÿè½½å‡è¡¡å™¨å°±ä¼šå°†æµé‡è·¯ç”±åˆ°å…¶ä»–ï¼ˆæ–°çš„ï¼‰Pod ä¸­å»ã€‚å› ä¸ºåœ¨è´Ÿè½½å‡è¡¡å™¨æ³¨æ„åˆ°å˜æ›´å¹¶æ›´æ–°å…¶é…ç½®ä¹‹å‰ï¼Œç»ˆæ­¢ä¿¡å·å°±ä¼šå»åœç”¨ Podï¼Œè€Œè¿™ä¸ªé‡æ–°é…ç½®è¿‡ç¨‹åˆæ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼Œå¹¶ä¸èƒ½ä¿è¯æ­£ç¡®çš„é¡ºåºï¼Œæ‰€ä»¥å°±å¯èƒ½å¯¼è‡´å¾ˆå°‘çš„è¯·æ±‚ä¼šè¢«è·¯ç”±åˆ°å·²ç»ç»ˆæ­¢çš„ Pod ä¸Šå»äº†ï¼Œä¹Ÿå°±å‡ºç°äº†ä¸Šé¢æˆ‘ä»¬è¯´çš„æƒ…å†µã€‚\né—®é¢˜è§£å†³ é‚£ä¹ˆå¦‚ä½•å¢å¼ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»¥å®ç°çœŸæ­£çš„é›¶å®•æœºè¿ç§»æ›´æ–°å‘¢ï¼Ÿ\né¦–å…ˆï¼Œè¦å®ç°è¿™ä¸ªç›®æ ‡çš„å…ˆå†³æ¡ä»¶æ˜¯æˆ‘ä»¬çš„å®¹å™¨è¦æ­£ç¡®å¤„ç†ç»ˆæ­¢ä¿¡å·ï¼Œåœ¨Â SIGTERMÂ ä¿¡å·ä¸Šå®ç°ä¼˜é›…å…³é—­ã€‚ä¸‹ä¸€æ­¥éœ€è¦æ·»åŠ Â readinessÂ å¯è¯»æ¢é’ˆï¼Œæ¥æ£€æŸ¥æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ˜¯å¦å·²ç»å‡†å¤‡å¥½æ¥å¤„ç†æµé‡äº†ã€‚ä¸ºäº†è§£å†³ Pod åœæ­¢çš„æ—¶å€™ä¸ä¼šé˜»å¡å¹¶ç­‰åˆ°è´Ÿè½½å‡è¡¡å™¨é‡æ–°é…ç½®çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨Â preStopÂ è¿™ä¸ªç”Ÿå‘½å‘¨æœŸçš„é’©å­ï¼Œåœ¨å®¹å™¨ç»ˆæ­¢ä¹‹å‰è°ƒç”¨è¯¥é’©å­ã€‚\nç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°æ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥å¿…é¡»åœ¨å°†æœ€ç»ˆåœæ­¢ä¿¡å·å‘é€åˆ°å®¹å™¨ä¹‹å‰å®Œæˆï¼Œåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨è¯¥é’©å­ç®€å•çš„ç­‰å¾…ï¼Œç„¶åÂ SIGTERMÂ ä¿¡å·å°†åœæ­¢åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚åŒæ—¶ï¼ŒKubernetes å°†ä» Endpoints å¯¹è±¡ä¸­åˆ é™¤è¯¥ Podï¼Œæ‰€ä»¥è¯¥ Pod å°†ä¼šä»æˆ‘ä»¬çš„è´Ÿè½½å‡è¡¡å™¨ä¸­æ’é™¤ï¼ŒåŸºæœ¬ä¸Šæ¥è¯´æˆ‘ä»¬çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ç­‰å¾…çš„æ—¶é—´å¯ä»¥ç¡®ä¿åœ¨åº”ç”¨ç¨‹åºåœæ­¢ä¹‹å‰é‡æ–°é…ç½®è´Ÿè½½å‡è¡¡å™¨\nlifecycle\nåˆ›å»ºèµ„æºå¯¹è±¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨lifecycleæ¥ç®¡ç†å®¹ å™¨åœ¨è¿è¡Œå‰å’Œå…³é—­å‰çš„ä¸€äº›åŠ¨ä½œã€‚\nlifecycleæœ‰ä¸¤ç§å›è°ƒå‡½æ•°:\nPostStart: å®¹å™¨åˆ›å»ºæˆåŠŸåï¼Œè¿è¡Œå‰çš„ä»»åŠ¡ï¼Œç”¨äºèµ„æºéƒ¨ç½²ã€ç¯å¢ƒå‡†å¤‡ç­‰ã€‚\nPreStop: åœ¨å®¹å™¨è¢«ç»ˆæ­¢å‰çš„ä»»åŠ¡ï¼Œç”¨äºä¼˜é›…å…³é—­åº”ç”¨ç¨‹åºã€é€šçŸ¥å…¶ä»–ç³»ç»Ÿç­‰ç­‰ã€‚\næˆ‘ä»¬è¿™é‡Œä½¿ç”¨Â preStopÂ è®¾ç½®äº†ä¸€ä¸ª 20s çš„å®½é™æœŸï¼ŒPod åœ¨çœŸæ­£é”€æ¯å‰ä¼šå…ˆ sleep ç­‰å¾… 20sï¼Œè¿™å°±ç›¸å½“äºç•™äº†æ—¶é—´ç»™ Endpoints æ§åˆ¶å™¨å’Œ kube-proxy æ›´æ–°å» Endpoints å¯¹è±¡å’Œè½¬å‘è§„åˆ™ï¼Œè¿™æ®µæ—¶é—´ Pod è™½ç„¶å¤„äº Terminating çŠ¶æ€ï¼Œå³ä¾¿åœ¨è½¬å‘è§„åˆ™æ›´æ–°å®Œå…¨ä¹‹å‰æœ‰è¯·æ±‚è¢«è½¬å‘åˆ°è¿™ä¸ª Terminating çš„ Podï¼Œä¾ç„¶å¯ä»¥è¢«æ­£å¸¸å¤„ç†ï¼Œå› ä¸ºå®ƒè¿˜åœ¨ sleepï¼Œæ²¡æœ‰è¢«çœŸæ­£é”€æ¯ã€‚\nç°åœ¨ï¼Œå½“æˆ‘ä»¬å»æŸ¥çœ‹æ»šåŠ¨æ›´æ–°æœŸé—´çš„ Pod è¡Œä¸ºæ—¶ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°æ­£åœ¨ç»ˆæ­¢çš„ Pod å¤„äºÂ TerminatingÂ çŠ¶æ€ï¼Œä½†æ˜¯åœ¨ç­‰å¾…æ—¶é—´ç»“æŸä¹‹å‰ä¸ä¼šå…³é—­çš„ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨Â FortioÂ é‡æ–°æµ‹è¯•ä¸‹ï¼Œåˆ™ä¼šçœ‹åˆ°é›¶å¤±è´¥è¯·æ±‚çš„ç†æƒ³çŠ¶æ€ã€‚\n1 2 3 4 lifecycle: preStop: # åœ¨å®¹å™¨è¢«ç»ˆæ­¢å‰çš„ä»»åŠ¡ï¼Œç”¨äºä¼˜é›…å…³é—­åº”ç”¨ç¨‹åº exec: command: [\u0026#34;/bin/bash\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;sleep 20\u0026#34;] #ç¡çœ 20sï¼Œä¼˜é›…å…³é—­ å®Œæ•´wordpress.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 apiVersion: v1 kind: Service metadata: name: wordpress namespace: kube-example spec: selector: app: wordpress tier: frontend ports: - port: 80 name: web targetPort: wdport type: ClusterIP --- apiVersion: apps/v1 kind: Deployment metadata: name: wordpress namespace: kube-example labels: app: wordpress tier: frontend spec: selector: matchLabels: app: wordpress tier: frontend replicas: 4 #å¤šå‰¯æœ¬+podçš„åäº²åˆåŠ›å¯ä»¥å®ç°podçš„é«˜å¯ç”¨ strategy: # æ»šåŠ¨æ›´æ–°çš„æ›´æ–°ç­–ç•¥ type: RollingUpdate rollingUpdate: maxSurge: 1 # è¡¨ç¤ºKubernetesä¼šå…ˆå¯åŠ¨1ä¸€ä¸ªæ–°çš„Podåæ‰åˆ æ‰ä¸€ä¸ªæ—§çš„PODï¼Œæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰5+1ä¸ªPODã€‚ maxUnavailable: 1 # è¡¨ç¤ºKubernetesæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰1ä¸ªPODå¤„äºæ— æ³•æœåŠ¡çš„çŠ¶æ€ã€‚ minReadySeconds: 5 # å®¹å™¨å†…åº”ç”¨çš„å¯åŠ¨æ—¶é—´, podå˜ä¸ºrunçŠ¶æ€, ä¼šåœ¨minReadySecondsåç»§ç»­æ›´æ–°ä¸‹ä¸€ä¸ªpod. revisionHistoryLimit: 10 # æœ€å¤šä¿ç•™10ä¸ªå‡çº§å‰¯æœ¬ï¼Œä¾¿äºå›æ»š template: metadata: name: wordpress labels: app: wordpress tier: frontend spec: containers: - name: blog image: wordpress:5.3.2-apache ports: - containerPort: 80 name: wdport env: - name: WORDPRESS_DB_HOST value: wordpress-mysql:3306 - name: WORDPRESS_DB_USER value: wordpress - name: WORDPRESS_DB_PASSWORD value: wordpress imagePullPolicy: IfNotPresent resources: limits: cpu: 800m memory: 150Mi requests: cpu: 800m memory: 150Mi startupProbe: #é¦–æ¬¡å¯åŠ¨æ¢æµ‹ï¼ˆå¦‚æœæ²¡æœ‰æˆåŠŸï¼Œä¸ä¼šè¿è¡Œä¸‹é¢livenessProbeï¼‰ httpGet: port: 80 failureThreshold: 2 #æ¢æµ‹æˆåŠŸåï¼Œæœ€å°‘è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1ã€‚ initialDelaySeconds: 20 # å®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’ timeoutSeconds: 10 # æ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’ã€‚ periodSeconds: 5 # æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’ã€‚ readinessProbe: # ï¼ˆå°±ç»ªæ£€æŸ¥ï¼‰ # å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œkubernetesä¼šæŠŠPodä»service endpointsä¸­å‰”é™¤ tcpSocket: port: 80 initialDelaySeconds: 10 timeoutSeconds: 5 failureThreshold: 5 periodSeconds: 5 successThreshold: 3 lifecycle: preStop: # åœ¨å®¹å™¨è¢«ç»ˆæ­¢å‰çš„ä»»åŠ¡ï¼Œç”¨äºä¼˜é›…å…³é—­åº”ç”¨ç¨‹åº exec: command: [\u0026#34;/bin/bash\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;sleep 20\u0026#34;] #ç¡çœ 20sï¼Œä¼˜é›…å…³é—­ affinity: podAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: topologyKey: kubernetes.io/hostname labelSelector: matchExpressions: - key: app operator: In values: - wordpress restartPolicy: Always å†æ¬¡æµ‹è¯•\nç‰ˆæœ¬å›æ»š åšå®¢å‚ç…§ï¼šhttps://www.ipcpu.com/2017/09/kubernetes-rolling-update/\næŸ¥è¯¢å‡çº§çŠ¶æ€ã€æš‚åœå’Œæ¢å¤\n1 2 3 4 5 6 #@æŸ¥è¯¢å‡çº§çŠ¶å†µ $ kubectl rollout status deployment \u0026lt;deployment\u0026gt; #@æš‚åœæ»šåŠ¨å‡çº§ $ kubectl rollout pause deployment \u0026lt;deployment\u0026gt; #@æ¢å¤æ»šåŠ¨å‡çº§ $ kubectl rollout resume deployment \u0026lt;deployment\u0026gt; æ“ä½œéƒ½åŠ äº†â€“record çš„å‚æ•°ï¼Œé€™å‚æ•°ä¸»è¦æ˜¯å‘ŠçŸ¥ Kubernetes è®°å½•æ­¤æ¬¡ä¸‹è¾¾çš„æŒ‡ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹\n1 2 3 4 5 6 7 8 9 [root@k8s-master1 v4]# kubectl rollout history deployment -n kube-example wordpress deployment.apps/wordpress REVISION CHANGE-CAUSE 1 \u0026lt;none\u0026gt; 2 \u0026lt;none\u0026gt; 3 \u0026lt;none\u0026gt; 4 \u0026lt;none\u0026gt; 5 \u0026lt;none\u0026gt; 6 \u0026lt;none\u0026gt; è¿™äº›ä¸ªè®°å½•èƒ½ä¿å­˜å¤šå°‘ä¸ªå‘¢ï¼Ÿé»˜è®¤æ˜¯å…¨éƒ¨ä¿å­˜çš„ã€‚å¯ä»¥é€šè¿‡è®¾ç½®.spec.revisionHistoryLimit æ¥å†³å®šè®°å½•çš„ä¸ªæ•°ï¼Œä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒè®°å½•10ä¸ªå·¦å³å°±å·®ä¸å¤šäº†ã€‚è¦ä¸ç„¶å¯èƒ½ä¼šè¢«åˆ·å±ã€‚\n1 2 minReadySeconds: 5 revisionHistoryLimit: 10 å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæ¥å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬æˆ–è€…ç‰¹å®šç‰ˆæœ¬\n1 2 3 4 5 6 # to previous revision $ kubectl rollout undo deployment \u0026lt;deployment\u0026gt; # to specific revision $ kubectl rollout undo deployment \u0026lt;deployment\u0026gt; --to-revision=\u0026lt;revision\u0026gt; # exmaple $ kubectl rollout undo deployment buniess --to-revision=3 é—®é¢˜ ï¼ˆ1ï¼‰è‡ªåŠ¨æ‰©ç¼©å®¹\nï¼ˆ2ï¼‰æ•°æ®æŒä¹…åŒ–\nï¼ˆ3ï¼‰mysqlè´¦å·å¯†ç æ³¨å…¥ç­‰\næœŸå¾…ä¸‹ä¸ªç‰ˆæœ¬æ›´åŠ ä¼˜åŒ–å®Œç¾\n","date":"2021-04-06T21:35:06Z","image":"https://www.ownit.top/title_pic/31.jpg","permalink":"https://www.ownit.top/p/202104062135/","title":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿå››ï¼ˆwordpresså‡çº§æ›´æ–°ï¼‰"},{"content":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸€ï¼ˆwordpressåŸºç¡€ç‰ˆï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹ŸäºŒï¼ˆwordpressé«˜å¯ç”¨ï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸‰ï¼ˆwordpresså¥åº·æ£€æŸ¥å’ŒæœåŠ¡è´¨é‡QoSï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿå››ï¼ˆwordpresså‡çº§æ›´æ–°ï¼‰ æºç åœ°å€ï¼šhttps://github.com/nangongchengfeng/Kubernetes/tree/main/wordpress-example\nKuberneteså®æˆ˜æ¨¡æ‹ŸäºŒï¼Œå·²ç»ä¼˜åŒ–æ¶æ„ï¼Œå·²ç»é‡‡å–åˆ†ç¦»ï¼Œå¯ä»¥å®ç°é«˜å¯ç”¨ï¼Œå¹¶ä¼˜åŒ–è½¯ç­–ç•¥ï¼Œé˜²æ­¢å•ç‚¹æ•…éšœ\næ¥ä¸‹æ¥ï¼Œæ…¢æ…¢å®ç°å¥åº·æ£€æŸ¥å’ŒæœåŠ¡è´¨é‡\nç‰ˆæœ¬3 æ€è·¯ï¼šåˆ†åˆ«å¯¹2ä¸ªpodçš„è¿›è¡Œç«¯å£æ£€æŸ¥ï¼Œåˆ¤æ–­podæ˜¯å¦æ­£å¸¸å’Œæµé‡æä¾›ï¼Œæµ‹è¯•æ€§èƒ½ï¼Œè®¾ç½®èµ„æºé™åˆ¶\nå¥åº·æ£€æŸ¥ï¼šä¸»è¦æ£€æŸ¥podæä¾›æ­£å¸¸æœåŠ¡\nèµ„æºé™åˆ¶ï¼šåæœŸå¯ä»¥æ ¹æ®è¿™ä¸ªè®¾ç½®HPAã€‚é˜²æ­¢å®¿ä¸»èµ„æºä¸è¶³ï¼Œè¢«é©±é€\n1ã€Podçš„å¥åº·æ£€æŸ¥ï¼Œä¹Ÿå«åšæ¢é’ˆï¼Œæ¢é’ˆçš„ç§ç±»æœ‰ä¸¤ç§ã€‚\n1ï¼‰ã€livenessProbeï¼Œå¥åº·çŠ¶æ€æ£€æŸ¥ï¼Œå‘¨æœŸæ€§æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜æ´»ï¼Œæ£€æŸ¥ç»“æœå¤±è´¥ï¼Œå°†é‡å¯å®¹å™¨ã€‚\n2ï¼‰ã€readinessProbeï¼Œå¯ç”¨æ€§æ£€æŸ¥ï¼Œå‘¨æœŸæ€§æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œä¸å¯ç”¨å°†ä»serviceçš„endpointsä¸­ç§»é™¤ã€‚\nlivenessProbe (å­˜æ´»æ£€æŸ¥ï¼‰ # å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå°†æ€æ­»å®¹å™¨ï¼Œæ ¹æ®Podçš„restartPolicyæ¥æ“ä½œ\nreadinessProbeï¼ˆå°±ç»ªæ£€æŸ¥ï¼‰ # å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œkubernetesä¼šæŠŠPodä»service endpointsä¸­å‰”é™¤\n2ã€æ¢é’ˆçš„æ£€æµ‹æ–¹æ³•ã€‚\n1ï¼‰ã€execï¼Œæ‰§è¡Œä¸€æ®µå‘½ä»¤ã€‚\n2ï¼‰ã€httpGetï¼Œæ£€æµ‹æŸä¸ªhttpè¯·æ±‚çš„è¿”å›çŠ¶æ€ç ã€‚\n3ï¼‰ã€tcpSocketï¼Œæµ‹è¯•æŸä¸ªç«¯å£æ˜¯å¦èƒ½å¤Ÿè¿æ¥ã€‚\n3ã€startupProbeæ£€æµ‹\nåˆ¤æ–­å®¹å™¨å†…çš„åº”ç”¨ç¨‹åºæ˜¯å¦å·²å¯åŠ¨ã€‚å¦‚æœæä¾›äº†å¯åŠ¨æ¢æµ‹ï¼Œåˆ™ç¦ç”¨æ‰€æœ‰å…¶ä»–æ¢æµ‹ï¼Œç›´åˆ°å®ƒæˆåŠŸä¸ºæ­¢ã€‚å¦‚æœå¯åŠ¨æ¢æµ‹å¤±è´¥ï¼Œkubeletå°†æ€æ­»å®¹å™¨ï¼Œå®¹å™¨å°†æœä»å…¶é‡å¯ç­–ç•¥ã€‚å¦‚æœå®¹å™¨æ²¡æœ‰æä¾›å¯åŠ¨æ¢æµ‹ï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸ºæˆåŠŸã€‚\næ³¨æ„ï¼šä¸è¦å°†startupProbeå’ŒreadinessProbeæ··æ·†ã€‚\né…ç½®Probe Probeä¸­æœ‰å¾ˆå¤šç²¾ç¡®å’Œè¯¦ç»†çš„é…ç½®ï¼Œé€šè¿‡å®ƒä»¬ä½ èƒ½å‡†ç¡®çš„æ§åˆ¶livenesså’Œreadinessæ£€æŸ¥ï¼š\ninitialDelaySecondsï¼šå®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’ã€‚\nperiodSecondsï¼šæ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’ã€‚\ntimeoutSecondsï¼šæ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’ã€‚\nsuccessThresholdï¼šæ¢æµ‹å¤±è´¥åï¼Œæœ€å°‘è¿ç»­æ¢æµ‹æˆåŠŸå¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºæˆåŠŸã€‚é»˜è®¤æ˜¯1ã€‚å¯¹äºlivenesså¿…é¡»æ˜¯1ã€‚æœ€å°å€¼æ˜¯1ã€‚\nfailureThresholdï¼šæ¢æµ‹æˆåŠŸåï¼Œæœ€å°‘è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1ã€‚\nHTTP probeä¸­å¯ä»¥ç»™Â httpGetè®¾ç½®å…¶ä»–é…ç½®é¡¹ï¼š\nhostï¼šè¿æ¥çš„ä¸»æœºåï¼Œé»˜è®¤è¿æ¥åˆ°podçš„IPã€‚ä½ å¯èƒ½æƒ³åœ¨http headerä¸­è®¾ç½®â€Hostâ€è€Œä¸æ˜¯ä½¿ç”¨IPã€‚\nschemeï¼šè¿æ¥ä½¿ç”¨çš„schemaï¼Œé»˜è®¤HTTPã€‚\npath: è®¿é—®çš„HTTP serverçš„pathã€‚\nhttpHeadersï¼šè‡ªå®šä¹‰è¯·æ±‚çš„headerã€‚HTTPè¿è¡Œé‡å¤çš„headerã€‚\nportï¼šè®¿é—®çš„å®¹å™¨çš„ç«¯å£åå­—æˆ–è€…ç«¯å£å·ã€‚ç«¯å£å·å¿…é¡»ä»‹äº1å’Œ65525ä¹‹é—´ã€‚\nå‘½åç©ºé—´ï¼š(namespace.yaml) 1 2 3 4 apiVersion: v1 kind: Namespace metadata: name: kube-example mysqlèµ„æºæ¸…å• mysql.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 apiVersion: v1 kind: Service metadata: name: wordpress-mysql namespace: kube-example labels: app: wordpress spec: selector: app: wordpress tier: mysql ports: - port: 3306 targetPort: dbport --- apiVersion: apps/v1 kind: Deployment metadata: name: wordpress-mysql namespace: kube-example labels: app: wordpress tier: mysql spec: replicas: 1 template: metadata: name: wordpress-mysql labels: app: wordpress tier: mysql spec: containers: - name: mysql image: mysql:5.7 args: - --default_authentication_plugin=mysql_native_password - --character-set-server=utf8mb4 - --collation-server=utf8mb4_unicode_ci ports: - containerPort: 3306 name: dbport env: - name: MYSQL_ROOT_PASSWORD value: rootPassW0rd - name: MYSQL_DATABASE value: wordpress - name: MYSQL_USER value: wordpress - name: MYSQL_PASSWORD value: wordpress imagePullPolicy: IfNotPresent startupProbe: #é¦–æ¬¡å¯åŠ¨æ¢æµ‹ï¼ˆå¦‚æœæ²¡æœ‰æˆåŠŸï¼Œä¸ä¼šè¿è¡Œä¸‹é¢livenessProbeï¼‰ tcpSocket: port: 3306 failureThreshold: 2 #æ¢æµ‹æˆåŠŸåï¼Œæœ€å°‘è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1ã€‚ initialDelaySeconds: 20 # å®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’ timeoutSeconds: 10 # æ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’ã€‚ periodSeconds: 10 # æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’ã€‚ restartPolicy: Always selector: matchLabels: app: wordpress tier: mysql å› ä¸ºè¿™ä¸ªæ˜¯æ¨¡æ‹Ÿç¯å¢ƒï¼Œç°åœ¨æ•°æ®æ²¡æœ‰æŒç»­åŒ–ï¼Œå¦‚æœåŠ ä¸Šä¸‹é¢çš„æ£€æµ‹ï¼Œå¦‚æœpodçš„æœ‰é—®é¢˜ï¼Œç›´æ¥é‡å¯ï¼Œæ•°æ®éƒ½ä¼šä¸¢å¤±ï¼Œè¿™ä¸ªåæœŸæ•°æ®æŒä¹…åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸Šé¢\n1 2 3 4 5 6 7 8 livenessProbe: tcpSocket: port: 3306 # è®¿é—®çš„å®¹å™¨çš„ç«¯å£åå­—æˆ–è€…ç«¯å£å· initialDelaySeconds: 10 timeoutSeconds: 5 failureThreshold: 5 periodSeconds: 5 successThreshold: 3 #æ¢æµ‹å¤±è´¥åï¼Œæœ€å°‘è¿ç»­æ¢æµ‹æˆåŠŸå¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºæˆåŠŸã€‚é»˜è®¤æ˜¯1ã€‚å¯¹äºlivenesså¿…é¡»æ˜¯1ã€‚æœ€å°å€¼æ˜¯1ã€‚ Wordpress æ¸…å• wordpress.yaml\næˆ‘ä»¬çš„åº”ç”¨ç°åœ¨è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„åŠŸèƒ½æ²¡æœ‰æä¾›ï¼Œé‚£å°±æ˜¯å¥åº·æ£€æŸ¥ï¼Œæˆ‘ä»¬çŸ¥é“å¥åº·æ£€æŸ¥æ˜¯æé«˜åº”ç”¨å¥å£®æ€§éå¸¸é‡è¦çš„æ‰‹æ®µï¼Œå½“æˆ‘ä»¬æ£€æµ‹åˆ°åº”ç”¨ä¸å¥åº·çš„æ—¶å€™æˆ‘ä»¬å¸Œæœ›å¯ä»¥è‡ªåŠ¨é‡å¯å®¹å™¨ï¼Œå½“åº”ç”¨è¿˜æ²¡æœ‰å‡†å¤‡å¥½çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿå¸Œæœ›æš‚æ—¶ä¸è¦å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ æˆ‘ä»¬å‰é¢ç»å¸¸æåˆ°çš„Â liveness probeÂ å’ŒÂ rediness probeÂ ä¸¤ä¸ªå¥åº·æ£€æµ‹æ¢é’ˆï¼Œæ£€æŸ¥æ¢é’ˆçš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬è¿™é‡Œå½“ç„¶å¯ä»¥è®¤ä¸ºå¦‚æœå®¹å™¨çš„ 80 ç«¯å£å¯ä»¥æˆåŠŸè®¿é—®é‚£ä¹ˆå°±æ˜¯å¥åº·çš„ï¼Œå¯¹äºä¸€èˆ¬çš„åº”ç”¨æä¾›ä¸€ä¸ªå¥åº·æ£€æŸ¥çš„ URL ä¼šæ›´å¥½ï¼Œè¿™é‡Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„å¯è¯»æ€§æ¢é’ˆï¼Œä¸ºä»€ä¹ˆä¸æ·»åŠ å­˜æ´»æ€§æ¢é’ˆå‘¢ï¼Ÿè¿™é‡Œå…¶å®æ˜¯è€ƒè™‘åˆ°çº¿ä¸Šé”™è¯¯æ’æŸ¥çš„ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå½“æˆ‘ä»¬çš„åº”ç”¨å‡ºç°äº†é—®é¢˜ï¼Œç„¶åå°±è‡ªåŠ¨é‡å¯å»æ©ç›–é”™è¯¯çš„è¯ï¼Œå¯èƒ½è¿™ä¸ªé”™è¯¯å°±ä¼šè¢«æ°¸è¿œå¿½ç•¥æ‰äº†ï¼Œæ‰€ä»¥å…¶å®è¿™æ˜¯ä¸€ä¸ªæŠ˜è¡·çš„åšæ³•ï¼Œä¸ä½¿ç”¨å­˜æ´»æ€§æ¢é’ˆï¼Œè€Œæ˜¯ç»“åˆç›‘æ§æŠ¥è­¦ï¼Œä¿ç•™é”™è¯¯ç°åœºï¼Œæ–¹ä¾¿é”™è¯¯æ’æŸ¥ï¼Œä½†æ˜¯å¯è¯»å†™æ¢é’ˆæ˜¯ä¸€å®šéœ€è¦æ·»åŠ çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 apiVersion: v1 kind: Service metadata: name: wordpress namespace: kube-example spec: selector: app: wordpress tier: frontend ports: - port: 80 name: web targetPort: wdport type: ClusterIP --- apiVersion: apps/v1 kind: Deployment metadata: name: wordpress namespace: kube-example labels: app: wordpress tier: frontend spec: selector: matchLabels: app: wordpress tier: frontend replicas: 4 #å¤šå‰¯æœ¬+podçš„åäº²åˆåŠ›å¯ä»¥å®ç°podçš„é«˜å¯ç”¨ template: metadata: name: wordpress labels: app: wordpress tier: frontend spec: containers: - name: wordpress image: wordpress:5.3.2-apache ports: - containerPort: 80 name: wdport env: - name: WORDPRESS_DB_HOST value: wordpress-mysql:3306 - name: WORDPRESS_DB_USER value: wordpress - name: WORDPRESS_DB_PASSWORD value: wordpress imagePullPolicy: IfNotPresent startupProbe: #é¦–æ¬¡å¯åŠ¨æ¢æµ‹ï¼ˆå¦‚æœæ²¡æœ‰æˆåŠŸï¼Œä¸ä¼šè¿è¡Œä¸‹é¢livenessProbeï¼‰ httpGet: port: 80 failureThreshold: 2 #æ¢æµ‹æˆåŠŸåï¼Œæœ€å°‘è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1ã€‚ initialDelaySeconds: 10 # å®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’ timeoutSeconds: 10 # æ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’ã€‚ periodSeconds: 5 # æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’ã€‚ readinessProbe: # ï¼ˆå°±ç»ªæ£€æŸ¥ï¼‰ # å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œkubernetesä¼šæŠŠPodä»service endpointsä¸­å‰”é™¤ httpGet: port: 80 initialDelaySeconds: 10 timeoutSeconds: 5 failureThreshold: 5 periodSeconds: 5 successThreshold: 3 affinity: podAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: topologyKey: kubernetes.io/hostname labelSelector: matchExpressions: - key: app operator: In values: - wordpress restartPolicy: Always ä¸Šé¢ä¸ºä»€ä¹ˆä¸ç”¨livenessProbeæ£€æµ‹ï¼Œé¦–å…ˆå¦‚æœlivenessProbeæ£€æµ‹å¤±è´¥ï¼Œä¼šç›´æ¥é‡å¯podçš„ï¼Œä¼šæ¯åé”™è¯¯çš„ä¿¡æ¯ï¼Œä¸æ–¹ä¾¿æˆ‘ä»¬æ’æŸ¥é—®é¢˜ã€‚æˆ‘ä»¬æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œå¦‚æœä¸€ä¸ªå‡ºé—®é¢˜ï¼Œå…¶ä½™ä¼šæ­£å¸¸å·¥ä½œ\n1 2 3 4 5 6 7 livenessProbe: #(å­˜æ´»æ£€æŸ¥ï¼‰ # å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå°†æ€æ­»å®¹å™¨ï¼Œæ ¹æ®Podçš„restartPolicyæ¥æ“ä½œ httpGet: port: 80 initialDelaySeconds: 15 timeoutSeconds: 5 periodSeconds: 5 failureThreshold: 5 PDBç­–ç•¥ pdb.yaml\n1 2 3 4 5 6 7 8 9 10 11 apiVersion: policy/v1beta1 kind: PodDisruptionBudget metadata: name: wordpress-pdb namespace: kube-example spec: maxUnavailable: 1 selector: matchLabels: app: wordpress tier: frontend æœåŠ¡è´¨é‡ QoS QoSÂ æ˜¯Â Quality of ServiceÂ çš„ç¼©å†™ï¼Œå³æœåŠ¡è´¨é‡ã€‚ä¸ºäº†å®ç°èµ„æºè¢«æœ‰æ•ˆè°ƒåº¦å’Œåˆ†é…çš„åŒæ—¶æé«˜èµ„æºåˆ©ç”¨ç‡ï¼ŒKubernetes é’ˆå¯¹ä¸åŒæœåŠ¡è´¨é‡çš„é¢„æœŸï¼Œé€šè¿‡Â QoSÂ æ¥å¯¹ Pod è¿›è¡ŒæœåŠ¡è´¨é‡ç®¡ç†ã€‚å¯¹äºä¸€ä¸ª Pod æ¥è¯´ï¼ŒæœåŠ¡è´¨é‡ä½“ç°åœ¨ä¸¤ä¸ªå…·ä½“çš„æŒ‡æ ‡ï¼šCPU å’Œå†…å­˜ã€‚å½“èŠ‚ç‚¹ä¸Šå†…å­˜èµ„æºç´§å¼ æ—¶ï¼ŒKubernetes ä¼šæ ¹æ®é¢„å…ˆè®¾ç½®çš„ä¸åŒÂ QoSÂ ç±»åˆ«è¿›è¡Œç›¸åº”å¤„ç†ã€‚\nQoSÂ ä¸»è¦åˆ†ä¸ºÂ Guaranteedã€BurstableÂ å’ŒÂ Best-Effortä¸‰ç±»ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½ã€‚æˆ‘ä»¬å…ˆåˆ†åˆ«æ¥ä»‹ç»ä¸‹è¿™ä¸‰ç§æœåŠ¡ç±»å‹çš„å®šä¹‰ã€‚\nGuaranteed(æœ‰ä¿è¯çš„)\nå±äºè¯¥çº§åˆ«çš„ Pod æœ‰ä»¥ä¸‹ä¸¤ç§ï¼š\nPod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½ä¸”ä»…è®¾ç½®äº† CPU å’Œå†…å­˜çš„Â limits Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½è®¾ç½®äº† CPU å’Œå†…å­˜çš„ requests å’Œ limits ï¼Œä¸”å•ä¸ªå®¹å™¨å†…çš„requests==limitsï¼ˆrequestsä¸ç­‰äº0ï¼‰ Burstable(ä¸ç¨³å®šçš„)\nPod ä¸­åªè¦æœ‰ä¸€ä¸ªå®¹å™¨çš„ requests å’Œ limits çš„è®¾ç½®ä¸ç›¸åŒï¼Œé‚£ä¹ˆè¯¥ Pod çš„ QoS å³ä¸º Burstableã€‚\nBest-Effort(å°½æœ€å¤§åŠªåŠ›)\nå¦‚æœ Pod ä¸­æ‰€æœ‰å®¹å™¨çš„ resources å‡æœªè®¾ç½® requests ä¸ limitsï¼Œè¯¥ Pod çš„ QoS å³ä¸º Best-Effortã€‚\nfortio éƒ¨ç½² 1 2 3 4 wget https://github.com/fortio/fortio/releases/download/v1.4.4/fortio-1.4.4-1.x86_64.rpm rpm -ivh fortio-1.4.4-1.x86_64.rpm nohup fortio server \u0026amp; tail -f nohup.out å¼€å§‹æµ‹å‹\nå‘½ä»¤è¡Œ\nfortio load -c 5 -n 20 -qps 0 http://www.baidu.com\n#å‘½ä»¤è§£é‡Šå¦‚ä¸‹ï¼š\n-c è¡¨ç¤ºå¹¶å‘æ•°\n-n ä¸€å…±å¤šå°‘è¯·æ±‚\n-qps æ¯ç§’æŸ¥è¯¢æ•°ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶\nWebæ§åˆ¶å°\nweb æ§åˆ¶å°æ–¹å¼å°±æ˜¯æä¾›ç»™ä¹ æƒ¯ä½¿ç”¨ web ç•Œé¢æ“ä½œçš„åŒå­¦ä¸€ä¸ªé€”å¾„æ¥ä½¿ç”¨ Fortioã€‚å› ä¸ºæ˜¯åŸºäº web æ–¹å¼ï¼Œæ‰€ä»¥å°±éœ€è¦é¦–å…ˆå¯åŠ¨ä¸€ä¸ª web serverï¼Œè¿™æ ·å®¢æˆ·ç«¯æµè§ˆå™¨æ‰å¯ä»¥è®¿é—®åˆ° web server æä¾›çš„æ“ä½œç•Œé¢è¿›è¡Œè´Ÿè½½å‹æµ‹ã€‚é»˜è®¤æƒ…å†µ fortio server ä¼šå¯åŠ¨ 8080 ç«¯å£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\næ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥ http://IP:8080/fortioï¼Œè®¿é—® Fortio serverï¼š\næ ¹æ®å®ç°ç”Ÿæˆç¯å¢ƒè®¿é—®äººæ•°å’Œæ¬¡æ•°æ¨¡æ‹Ÿ\næµ‹è¯•å‰\næµ‹è¯•å\nèµ„æºé™åˆ¶ é‡‡ç”¨Guaranteed(æœ‰ä¿è¯çš„)ï¼Œé˜²æ­¢å®¿ä¸»æœºèµ„æºä¸å¤Ÿè¢«ä¼˜å…ˆé©±é€\nwordpress\n1 2 3 4 5 6 7 resources: limits: cpu: 800m memory: 150Mi requests: cpu: 800m memory: 150Mi mysql\n1 2 3 4 5 6 7 resources: limits: cpu: 1000m memory: 400Mi requests: cpu: 1000m memory: 400Mi æ­¤ç‰ˆæœ¬å®ç°å¥åº·æ£€æŸ¥å’ŒæœåŠ¡è´¨é‡QoS\né—®é¢˜ ï¼ˆ1ï¼‰è‡ªåŠ¨æ‰©ç¼©å®¹\nï¼ˆ2ï¼‰æ»šåŠ¨æ›´æ–°ç­–ç•¥\nï¼ˆ3ï¼‰æ•°æ®æŒä¹…åŒ–\nï¼ˆ4ï¼‰mysqlè´¦å·å¯†ç æ³¨å…¥ç­‰\nè¿™äº›ä¸€äº›åˆ—é—®é¢˜ï¼Œéƒ½ä¼šåœ¨åé¢çš„ç‰ˆæœ¬æ¶æ„ä¸­ä¼˜åŒ–\n","date":"2021-04-05T01:05:46Z","image":"https://www.ownit.top/title_pic/04.jpg","permalink":"https://www.ownit.top/p/202104050105/","title":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸‰ï¼ˆwordpresså¥åº·æ£€æŸ¥å’ŒæœåŠ¡è´¨é‡QoSï¼‰"},{"content":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸€ï¼ˆwordpressåŸºç¡€ç‰ˆï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹ŸäºŒï¼ˆwordpressé«˜å¯ç”¨ï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸‰ï¼ˆwordpresså¥åº·æ£€æŸ¥å’ŒæœåŠ¡è´¨é‡QoSï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿå››ï¼ˆwordpresså‡çº§æ›´æ–°ï¼‰ æºç åœ°å€ï¼šhttps://github.com/nangongchengfeng/Kubernetes/tree/main/wordpress-example\nä¸Šä¸€ç¯‡æ–‡ä»¶æˆ‘ä»¬ä½¿ç”¨podçš„æ„å»ºä¸¤ä¸ªå®¹å™¨ï¼Œä½†æ˜¯é—®é¢˜ä¹Ÿæ˜¯ä¸€å¤§å †ï¼Œæ ¹æœ¬ä¸é€‚åˆç”Ÿäº§æ–¹é¢ã€‚\næ‰€ä»¥æˆ‘ä»¬æ…¢æ…¢è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œä¼˜åŒ–æ¶æ„ã€‚\nç‰ˆæœ¬2 æ€è·¯ï¼šå°† Pod ä¸­çš„ä¸¤ä¸ªå®¹å™¨è¿›è¡Œæ‹†åˆ†ï¼Œå°† Wordpress å’Œ MySQL åˆ†åˆ«éƒ¨ç½²\nWordpress ç”¨å¤šä¸ªå‰¯æœ¬è¿›è¡Œéƒ¨ç½²å°±å¯ä»¥å®ç°åº”ç”¨çš„é«˜å¯ç”¨äº†\nç”±äº MySQL æ˜¯æœ‰çŠ¶æ€åº”ç”¨ï¼Œä¸€èˆ¬æ¥è¯´éœ€è¦ç”¨ StatefulSet æ¥è¿›è¡Œç®¡ç†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œéƒ¨ç½²çš„ MySQL å¹¶ä¸æ˜¯é›†ç¾¤æ¨¡å¼ï¼Œè€Œæ˜¯å•å‰¯æœ¬çš„ï¼Œæ‰€ä»¥ç”¨ Deployment ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚å¦‚æœç”Ÿäº§ç¯å¢ƒçš„è¯ï¼Œä¸€èˆ¬éƒ½æ˜¯é›†ç¾¤çš„ï¼Œåˆ†åˆ«åœ¨å®¿ä¸»æœºä¸Šéƒ¨ç½²ã€‚\nmysqlèµ„æºæ¸…å• mysql.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 apiVersion: v1 kind: Service metadata: name: wordpress-mysql namespace: kube-example labels: app: wordpress spec: selector: app: wordpress tier: mysql ports: - port: 3306 targetPort: dbport --- apiVersion: apps/v1 kind: Deployment metadata: name: wordpress-mysql namespace: kube-example labels: app: wordpress tier: mysql spec: replicas: 1 template: metadata: name: wordpress-mysql labels: app: wordpress tier: mysql spec: containers: - name: mysql image: mysql:5.7 args: - --default_authentication_plugin=mysql_native_password - --character-set-server=utf8mb4 - --collation-server=utf8mb4_unicode_ci ports: - containerPort: 3306 name: dbport env: - name: MYSQL_ROOT_PASSWORD value: rootPassW0rd - name: MYSQL_DATABASE value: wordpress - name: MYSQL_USER value: wordpress - name: MYSQL_PASSWORD value: wordpress imagePullPolicy: IfNotPresent restartPolicy: Always selector: matchLabels: app: wordpress tier: mysql è¿™é‡Œç»™ MySQL åº”ç”¨æ·»åŠ äº†ä¸€ä¸ª Service å¯¹è±¡ï¼Œæ˜¯å› ä¸º Wordpress åº”ç”¨éœ€è¦æ¥è¿æ¥æ•°æ®åº“ï¼Œä¹‹å‰åœ¨åŒä¸€ä¸ª Pod ä¸­ç”¨Â localhostÂ å³å¯ï¼Œç°åœ¨éœ€è¦é€šè¿‡ Service çš„ DNS å½¢å¼çš„åŸŸåè¿›è¡Œè¿æ¥ã€‚ç›´æ¥åˆ›å»ºä¸Šé¢èµ„æºå¯¹è±¡\n1 2 3 # kubectl apply -f mysql.yaml service/wordpress-mysql created deployment.apps/wordpress-mysql created Wordpress æ¸…å• wordpress.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 apiVersion: v1 kind: Service metadata: name: wordpress namespace: kube-example spec: selector: app: wordpress tier: frontend ports: - port: 80 name: web targetPort: wdport type: NodePort --- apiVersion: apps/v1 kind: Deployment metadata: name: wordpress namespace: kube-example labels: app: wordpress tier: frontend spec: selector: matchLabels: app: wordpress tier: frontend replicas: 4 template: metadata: name: wordpress labels: app: wordpress tier: frontend spec: containers: - name: wordpress image: wordpress:5.3.2-apache ports: - containerPort: 80 name: wdport env: - name: WORDPRESS_DB_HOST value: wordpress-mysql:3306 - name: WORDPRESS_DB_USER value: wordpress - name: WORDPRESS_DB_PASSWORD value: wordpress imagePullPolicy: IfNotPresent restartPolicy: Always æ³¨æ„è¿™é‡Œçš„ç¯å¢ƒå˜é‡Â WORDPRESS_DB_HOSTÂ çš„å€¼å°†ä¹‹å‰çš„Â localhostÂ åœ°å€æ›´æ”¹æˆäº†ä¸Šé¢ MySQL æœåŠ¡çš„ DNS åœ°å€ï¼Œå®Œæ•´çš„åŸŸååº”è¯¥æ˜¯Â wordpress-mysql.kube-example.svc.cluster.local:3306ï¼Œç”±äºè¿™ä¸¤ä¸ªåº”è¯¥éƒ½å¤„äºåŒä¸€ä¸ªå‘½åç©ºé—´ï¼Œæ‰€ä»¥ç›´æ¥ç®€å†™æˆÂ wordpress-mysql:3306Â ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n1 2 3 4 5 6 7 8 9 [root@k8s-master1 v2]# kubectl apply -f wordpress.yaml service/wordpress created deployment.apps/wordpress created [root@k8s-master1 v2]# kubectl get pods -l app=wordpress -n kube-example NAME READY STATUS RESTARTS AGE wordpress-ddb4ff6cf-g2xf8 1/1 Running 0 9s wordpress-ddb4ff6cf-jjt5k 1/1 Running 0 9s wordpress-ddb4ff6cf-zmbc4 1/1 Running 0 9s wordpress-mysql-d9b4b8985-bqv2b 1/1 Running 0 32s æµ‹è¯• å¯ä»¥çœ‹åˆ°éƒ½å·²ç»æ˜¯Â RunningÂ çŠ¶æ€äº†ï¼Œç„¶åæˆ‘ä»¬éœ€è¦æ€ä¹ˆæ¥éªŒè¯å‘¢ï¼Ÿæ˜¯ä¸æ˜¯æˆ‘ä»¬èƒ½æƒ³åˆ°çš„å°±æ˜¯å»è®¿é—®ä¸‹æˆ‘ä»¬çš„ Wordpress æœåŠ¡å°±å¯ä»¥äº†ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨çš„ä¸€ä¸ª NodePort ç±»å‹çš„ Service æ¥æš´éœ²æœåŠ¡ï¼š\n1 2 3 4 5 6 7 8 [root@k8s-master1 v2]# kubectl get svc,ep -n kube-example NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/wordpress NodePort 10.0.0.49 \u0026lt;none\u0026gt; 80:30455/TCP 92s service/wordpress-mysql ClusterIP 10.0.0.142 \u0026lt;none\u0026gt; 3306/TCP 115s NAME ENDPOINTS AGE endpoints/wordpress 10.244.0.5:80,10.244.1.135:80,10.244.1.136:80 92s endpoints/wordpress-mysql 10.244.1.134:3306 115s å¯ä»¥çœ‹åˆ° wordpress æœåŠ¡äº§ç”Ÿäº†ä¸€ä¸ª 30455çš„ç«¯å£ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡Â http://\u0026lt;ä»»æ„èŠ‚ç‚¹çš„NodeIP\u0026gt;:30012Â è®¿é—®æˆ‘ä»¬çš„åº”ç”¨äº†ï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œå¦‚æœçœ‹åˆ° wordpress è·³è½¬åˆ°äº†å®‰è£…é¡µé¢ï¼Œè¯æ˜æˆ‘ä»¬çš„å®‰è£…æ˜¯æ­£ç¡®çš„ï¼Œå¦‚æœæ²¡æœ‰å‡ºç°é¢„æœŸçš„æ•ˆæœï¼Œé‚£ä¹ˆå°±éœ€è¦å»æŸ¥çœ‹ä¸‹ Pod çš„æ—¥å¿—æ¥æ’æŸ¥é—®é¢˜äº†ï¼Œæ ¹æ®é¡µé¢æç¤ºï¼Œå¡«ä¸Šå¯¹åº”çš„ä¿¡æ¯ï¼Œç‚¹å‡»â€œå®‰è£…â€å³å¯ï¼Œæœ€ç»ˆå®‰è£…æˆåŠŸå\né¿å…å•ç‚¹æ•…éšœ ä¸ºä»€ä¹ˆä¼šæœ‰å•ç‚¹æ•…éšœçš„é—®é¢˜å‘¢ï¼Ÿ\næˆ‘ä»¬ä¸æ˜¯éƒ¨ç½²äº†å¤šä¸ªå‰¯æœ¬çš„ Wordpress åº”ç”¨å—ï¼Ÿ\nå½“æˆ‘ä»¬è®¾ç½®Â replicas=1Â çš„æ—¶å€™è‚¯å®šä¼šå­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå¦‚æœå¤§äº 1 ä½†æ˜¯æ‰€æœ‰å‰¯æœ¬éƒ½è°ƒåº¦åˆ°äº†åŒä¸€ä¸ªèŠ‚ç‚¹çš„æ˜¯ä¸æ˜¯åŒæ ·å°±ä¼šå­˜åœ¨å•ç‚¹é—®é¢˜äº†\nè¿™ä¸ªèŠ‚ç‚¹æŒ‚äº†æ‰€æœ‰å‰¯æœ¬å°±éƒ½æŒ‚äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä»…éœ€è¦è®¾ç½®å¤šä¸ªå‰¯æœ¬æ•°é‡ï¼Œè¿˜éœ€è¦è®©è¿™äº›å‰¯æœ¬è°ƒåº¦åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œæ¥æ‰“æ•£é¿å…å•ç‚¹æ•…éšœ\nPod åäº²å’Œæ€§æ¥å®ç°äº†ï¼Œæˆ‘ä»¬å¯ä»¥é˜²æ­¢å•ç‚¹æ•…éšœå‡ºç°ã€‚\nä½†æ˜¯è¦è€ƒè™‘è¦ç”¨å¼±ç­–ç•¥è¿˜æ˜¯ç¡¬ç­–ç•¥\næˆ‘ä»¬é¦–å…ˆå¼±çš„ï¼Œå¦‚æœç¡¬ç­–ç•¥ï¼Œå¦‚æœèŠ‚ç‚¹æœ‰é—®é¢˜ï¼Œpodå°±ä¸ä¼šè¢«åˆ›å»º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 apiVersion: v1 kind: Service metadata: name: wordpress namespace: kube-example spec: selector: app: wordpress tier: frontend ports: - port: 80 name: web targetPort: wdport type: ClusterIP --- apiVersion: apps/v1 kind: Deployment metadata: name: wordpress namespace: kube-example labels: app: wordpress tier: frontend spec: selector: matchLabels: app: wordpress tier: frontend replicas: 4 #å¤šå‰¯æœ¬+podçš„åäº²åˆåŠ›å¯ä»¥å®ç°podçš„é«˜å¯ç”¨ template: metadata: name: wordpress labels: app: wordpress tier: frontend spec: containers: - name: wordpress image: wordpress:5.3.2-apache ports: - containerPort: 80 name: wdport env: - name: WORDPRESS_DB_HOST value: wordpress-mysql:3306 - name: WORDPRESS_DB_USER value: wordpress - name: WORDPRESS_DB_PASSWORD value: wordpress imagePullPolicy: IfNotPresent affinity: #podçš„åäº²å’ŒåŠ› podAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: topologyKey: kubernetes.io/hostname labelSelector: matchExpressions: - key: app operator: In values: - wordpress restartPolicy: Always PDBç­–ç•¥ PDBèƒ½å¤Ÿé™åˆ¶åŒæ—¶ä¸­æ–­çš„podçš„æ•°é‡,ä»¥ä¿è¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§\næœ‰äº›æ—¶å€™çº¿ä¸Šçš„æŸäº›èŠ‚ç‚¹éœ€è¦åšä¸€äº›ç»´æŠ¤æ“ä½œï¼Œæ¯”å¦‚è¦å‡çº§å†…æ ¸ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦å°†è¦ç»´æŠ¤çš„èŠ‚ç‚¹è¿›è¡Œé©±é€æ“ä½œï¼Œé©±é€èŠ‚ç‚¹é¦–å…ˆæ˜¯å°†èŠ‚ç‚¹è®¾ç½®ä¸ºä¸å¯è°ƒåº¦ï¼Œè¿™æ ·å¯ä»¥é¿å…æœ‰æ–°çš„ Pod è°ƒåº¦ä¸Šæ¥ï¼Œç„¶åå°†è¯¥èŠ‚ç‚¹ä¸Šçš„ Pod å…¨éƒ¨åˆ é™¤ï¼ŒReplicaSet æ§åˆ¶å™¨æ£€æµ‹åˆ° Pod æ•°é‡å‡å°‘äº†å°±ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ Podï¼Œè°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šé¢çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å…ˆåˆ é™¤ï¼Œå†åˆ›å»ºï¼Œå¹¶éæ˜¯æ»šåŠ¨æ›´æ–°ï¼Œå› æ­¤æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰å‰¯æœ¬éƒ½åœ¨è¢«é©±é€çš„èŠ‚ç‚¹ä¸Šï¼Œåˆ™å¯èƒ½å¯¼è‡´è¯¥æœåŠ¡ä¸å¯ç”¨ã€‚\nå¦‚æœæœåŠ¡æœ¬èº«å­˜åœ¨å•ç‚¹æ•…éšœï¼Œæ‰€æœ‰å‰¯æœ¬éƒ½åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œé©±é€çš„æ—¶å€™è‚¯å®šå°±ä¼šé€ æˆæœåŠ¡ä¸å¯ç”¨äº†ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬ä½¿ç”¨ä¸Šé¢çš„åäº²å’Œæ€§å’Œå¤šå‰¯æœ¬å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬çš„æœåŠ¡æœ¬èº«å°±è¢«æ‰“æ•£åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œè¿™äº›èŠ‚ç‚¹å¦‚æœéƒ½è¢«åŒæ—¶é©±é€çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæœåŠ¡çš„æ‰€æœ‰å®ä¾‹éƒ½ä¼šè¢«åŒæ—¶åˆ é™¤ï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿä¼šé€ æˆæœåŠ¡ä¸å¯ç”¨äº†ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½® PDBï¼ˆPodDisruptionBudgetï¼‰å¯¹è±¡æ¥é¿å…æ‰€æœ‰å‰¯æœ¬åŒæ—¶è¢«åˆ é™¤ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥è®¾ç½®åœ¨é©±é€çš„æ—¶å€™ wordpress åº”ç”¨æœ€å¤šåªæœ‰ä¸€ä¸ªå‰¯æœ¬ä¸å¯ç”¨ï¼Œå…¶å®å°±ç›¸å½“äºé€ä¸ªåˆ é™¤å¹¶åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šé‡å»º\npdb.yaml\n1 2 3 4 5 6 7 8 9 10 11 apiVersion: policy/v1beta1 kind: PodDisruptionBudget metadata: name: wordpress-pdb namespace: kube-example spec: maxUnavailable: 1 selector: matchLabels: app: wordpress tier: frontend 1 2 3 4 5 [root@k8s-master1 v2]# kubectl apply -f pdb.yaml poddisruptionbudget.policy/wordpress-pdb created [root@k8s-master1 v2]# kubectl get pdb -n kube-example NAME MIN AVAILABLE MAX UNAVAILABLE ALLOWED DISRUPTIONS AGE wordpress-pdb N/A 1 1 15s PDB çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼šhttps://kubernetes.io/docs/tasks/run-application/configure-pdb/ã€‚\næ­¤ç‰ˆæœ¬å®ç°é«˜å¯ç”¨ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€äº›é—®é¢˜\né—®é¢˜ ï¼ˆ1ï¼‰podçš„å¥åº·æ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›ï¼Œpodé¢åº¦é‡å¯ç­–ç•¥éƒ½æ— æ³•æ‰§è¡Œ\nï¼ˆ2ï¼‰å†…å­˜ï¼Œcpuç­‰èµ„æºé™åˆ¶ï¼ŒæœåŠ¡è´¨é‡Qos\nï¼ˆ3ï¼‰æ•°æ®æŒä¹…åŒ–\nï¼ˆ4ï¼‰mysqlè´¦å·å¯†ç æ³¨å…¥ç­‰\nè¿™äº›ä¸€äº›åˆ—é—®é¢˜ï¼Œéƒ½ä¼šåœ¨åé¢çš„ç‰ˆæœ¬æ¶æ„ä¸­ä¼˜åŒ–\n","date":"2021-04-03T23:50:52Z","image":"https://www.ownit.top/title_pic/10.jpg","permalink":"https://www.ownit.top/p/202104032350/","title":"Kuberneteså®æˆ˜æ¨¡æ‹ŸäºŒï¼ˆwordpressé«˜å¯ç”¨ï¼‰"},{"content":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸€ï¼ˆwordpressåŸºç¡€ç‰ˆï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹ŸäºŒï¼ˆwordpressé«˜å¯ç”¨ï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸‰ï¼ˆwordpresså¥åº·æ£€æŸ¥å’ŒæœåŠ¡è´¨é‡QoSï¼‰ Kuberneteså®æˆ˜æ¨¡æ‹Ÿå››ï¼ˆwordpresså‡çº§æ›´æ–°ï¼‰ Kubernetesæ˜¯ç°åœ¨æ¯”è¾ƒæµè¡Œçš„å®¹å™¨åŒ–è½¯ä»¶ã€‚æˆ‘ä»¬æ—¥å¸¸ä¹Ÿæ¯”è¾ƒä½¿ç”¨çš„å¤šï¼Œæˆ‘ä»¬éƒ½æ˜¯æ…¢æ…¢çš„ä»é™Œç”Ÿåˆ°ç†Ÿæ‚‰çš„è¿›é˜¶ï¼Œåªæœ‰ä¸æ–­çš„å­¦ä¹ ï¼Œæ‰èƒ½æœ‰æ”¶è·ã€‚\nKubernetesä¸“æ ï¼šhttps://blog.csdn.net/heian_99/category_9652886.html\nKuberneteså®˜ç½‘åœ°å€ï¼šhttps://kubernetes.io/\nè¿™ä¸ªä¸“æ ï¼Œæ¨¡æ‹ŸKubernetesçš„æ—¥å¸¸å‘å¸ƒæµç¨‹ã€‚\næºç åœ°å€ï¼šhttps://github.com/nangongchengfeng/Kubernetes/tree/main/wordpress-example\né‡Œé¢åŒ…å«å¤šä¸ªç‰ˆæœ¬ï¼Œç°åœ¨æ˜¯æ¼”ç¤ºv1ç‰ˆæœ¬ã€‚\nç¯å¢ƒ Kubernetesï¼šv1.18.3\ndockerï¼š19.03.9\nmysqlï¼š5.7\nwordpressï¼š5.3.2-apache\nç‰ˆæœ¬1 æ€è·¯ï¼šç”±äºwordpresså’Œmysqléœ€è¦è¿›è¡Œäº¤äº’ã€‚ç‰ˆæœ¬1å°±æŠŠwordpresså’Œmysqlé›†æˆåˆ°ä¸€ä¸ªpodè¿è¡Œï¼Œæµ‹è¯•è®¿é—®æ•ˆæœ\nåŸç† WordpressÂ Wordpress æ˜¯ä¸€ä¸ªåŸºäº PHP å’Œ MySQL çš„æµè¡Œçš„å¼€æºå†…å®¹ç®¡ç†ç³»ç»Ÿï¼Œæ‹¥æœ‰ä¸°å¯Œçš„æ’ä»¶å’Œæ¨¡æ¿ç³»ç»Ÿã€‚ä¸€ä¸ªèƒ½å¤Ÿè§£æ PHP çš„ç¨‹åºå’Œ MySQL æ•°æ®åº“ã€‚å®˜æ–¹æä¾›äº†é•œåƒÂ https://hub.docker.com/_/wordpress\nå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—ç¯å¢ƒå˜é‡å»æŒ‡å®š MySQL æ•°æ®åº“çš„é…ç½®ï¼Œåªéœ€è¦å°†è¿™äº›å‚æ•°é…ç½®ä¸Šç›´æ¥è¿è¡Œå³å¯ã€‚\næˆ‘ä»¬çŸ¥é“ Wordpress åº”ç”¨æœ¬èº«ä¼šé¢‘ç¹çš„å’Œ MySQL æ•°æ®åº“è¿›è¡Œäº¤äº’ï¼Œè¿™ç§æƒ…å†µä¸‹å¦‚æœå°†äºŒè€…ç”¨å®¹å™¨éƒ¨ç½²åœ¨åŒä¸€ä¸ª Pod ä¸‹é¢æ˜¯ä¸æ˜¯è¦é«˜æ•ˆå¾ˆå¤š\nå› ä¸ºä¸€ä¸ª Pod ä¸‹é¢çš„æ‰€æœ‰å®¹å™¨æ˜¯å…±äº«åŒä¸€ä¸ª network namespace çš„ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨\nå‘½åç©ºé—´ï¼š(namespace.yaml) 1 2 3 4 apiVersion: v1 kind: Namespace metadata: name: kube-example åº”ç”¨æ¸…å•ï¼šï¼ˆdeployment.yamlï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 apiVersion: apps/v1 kind: Deployment metadata: name: wordpress namespace: kube-example labels: app: wordpress spec: selector: matchLabels: app: wordpress template: metadata: labels: app: wordpress spec: containers: - name: wordpress image: wordpress:5.3.2-apache ports: - containerPort: 80 name: wdport env: - name: WORDPRESS_DB_HOST value: localhost:3306 - name: WORDPRESS_DB_USER value: wordpress - name: WORDPRESS_DB_PASSWORD value: wordpress - name: mysql image: mysql:5.7 imagePullPolicy: IfNotPresent args: # æ–°ç‰ˆæœ¬é•œåƒæœ‰æ›´æ–°ï¼Œéœ€è¦ä½¿ç”¨ä¸‹é¢çš„è®¤è¯æ’ä»¶ç¯å¢ƒå˜é‡é…ç½®æ‰ä¼šç”Ÿæ•ˆ - --default_authentication_plugin=mysql_native_password - --character-set-server=utf8mb4 - --collation-server=utf8mb4_unicode_ci ports: - containerPort: 3306 name: dbport env: - name: MYSQL_ROOT_PASSWORD value: rootPassW0rd - name: MYSQL_DATABASE value: wordpress - name: MYSQL_USER value: wordpress - name: MYSQL_PASSWORD value: wordpress ç”±äºæˆ‘ä»¬è¿™é‡Œ MySQL å’Œ Wordpress åœ¨åŒä¸€ä¸ª Pod ä¸‹é¢ï¼Œæ‰€ä»¥åœ¨ Wordpress ä¸­æˆ‘ä»¬æŒ‡å®šæ•°æ®åº“åœ°å€çš„æ—¶å€™æ˜¯ç”¨çš„Â localhost:3306ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå®¹å™¨å·²ç»å…±äº«åŒä¸€ä¸ª network namespace äº†ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œç„¶åå¦‚æœæˆ‘ä»¬è¦æƒ³æŠŠè¿™ä¸ªæœåŠ¡æš´éœ²ç»™å¤–éƒ¨ç”¨æˆ·è¿˜å¾—åˆ›å»ºä¸€ä¸ª Service æˆ–è€… Ingress å¯¹è±¡\nNodePort ç±»å‹çš„ Serviceï¼š(service.yaml) 1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: v1 kind: Service metadata: name: wordpress namespace: kube-example spec: selector: app: wordpress type: NodePort ports: - name: web port: 80 targetPort: wdport å› ä¸ºåªéœ€è¦æš´éœ² Wordpress è¿™ä¸ªåº”ç”¨ï¼Œæ‰€ä»¥åªåŒ¹é…äº†ä¸€ä¸ªåä¸ºÂ wdportÂ çš„ç«¯å£ï¼Œç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºä¸Šé¢çš„å‡ ä¸ªèµ„æºå¯¹è±¡\n1 2 3 kubectl apply -f namespace.yaml kubectl apply -f deployment.yaml kubectl apply -f service.yaml æ¥ä¸‹æ¥å°±æ˜¯ç­‰å¾…æ‹‰å–é•œåƒï¼Œå¯åŠ¨ Pod:\n1 2 3 4 5 6 $ kubectl get pods -n kube-example NAME READY STATUS RESTARTS AGE wordpress-77dcdb64c6-zdlb8 2/2 Running 0 12m $ kubectl get svc -n kube-example NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE wordpress NodePort 10.106.237.157 \u0026lt;none\u0026gt; 80:30892/TCP 2m2s æµ‹è¯• å½“ Pod å¯åŠ¨å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä¸Šé¢çš„Â http://\u0026lt;ä»»æ„èŠ‚ç‚¹IP\u0026gt;:30892Â è¿™ä¸ª NodePort ç«¯å£æ¥è®¿é—®åº”ç”¨äº†\nå®‰è£…ç•Œé¢\né—®é¢˜ ï¼ˆ1ï¼‰podä¸­æ²¡æœ‰å…ˆåé¡ºåº\nï¼ˆ2ï¼‰å•èŠ‚ç‚¹é—®é¢˜ï¼Œæ²¡æœ‰é«˜å¯ç”¨\nï¼ˆ3ï¼‰Wordpress æ˜¯æ— çŠ¶æ€æœåŠ¡å™¨ï¼Œå¦‚æœå¢åŠ èŠ‚ç‚¹ï¼Œmysqlä¹Ÿä¼šå¢åŠ ï¼Œæ•°æ®ä¸ç‹¬ç«‹\nï¼ˆ4ï¼‰æ•°æ®æ²¡æœ‰æŒä¹…åŒ–\nç­‰ç­‰ä¸€äº›åˆ—çš„é—®é¢˜ã€‚\næ­¤ç‰ˆæœ¬1ï¼Œä¸ºæœ€ç®€å•çš„é—®é¢˜ï¼Œæˆ‘ä»¬å°†åœ¨æ­¤ç‰ˆæœ¬ä¸Šæ”¹è¿›æ¶æ„ï¼Œä¸æ–­çš„ä¼˜åŒ–\n","date":"2021-04-03T23:47:45Z","image":"https://www.ownit.top/title_pic/65.jpg","permalink":"https://www.ownit.top/p/202104032347/","title":"Kuberneteså®æˆ˜æ¨¡æ‹Ÿä¸€ï¼ˆwordpressåŸºç¡€ç‰ˆï¼‰"},{"content":"ç¯å¢ƒ Rook Ceph éœ€è¦ä½¿ç”¨ RBD å†…æ ¸æ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡ŒÂ modprobe rbdÂ æ¥æµ‹è¯• Kubernetes èŠ‚ç‚¹æ˜¯å¦æœ‰è¯¥æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦æ›´æ–°ä¸‹å†…æ ¸ç‰ˆæœ¬ã€‚\nå¦å¤–éœ€è¦åœ¨èŠ‚ç‚¹ä¸Šå®‰è£…Â lvm2Â è½¯ä»¶åŒ…ï¼š\n1 2 3 4 5 # Centos sudo yum install -y lvm2 # Ubuntu sudo apt-get install -y lvm2 å®‰è£… æˆ‘ä»¬è¿™é‡Œéƒ¨ç½²æœ€æ–°çš„ release-1.2 ç‰ˆæœ¬çš„ Rookï¼Œéƒ¨ç½²æ¸…å•æ–‡ä»¶åœ°å€ï¼šhttps://github.com/rook/rook/tree/release-1.2/cluster/examples/kubernetes/cephã€‚\nä»ä¸Šé¢é“¾æ¥ä¸­ä¸‹è½½ common.yaml ä¸ operator.yaml ä¸¤ä¸ªèµ„æºæ¸…å•æ–‡ä»¶ï¼šhttps://github.com/nangongchengfeng/Kubernetes/tree/main/Cephï¼ˆè¿™ä¸ªæ˜¯å·²ç»æ•´åˆå¥½çš„ï¼Œæ–¹ä¾¿æµ‹è¯•ï¼‰\n1 2 3 4 # ä¼šå®‰è£…crdã€rbacç›¸å…³èµ„æºå¯¹è±¡ $ kubectl apply -f common.yaml # å®‰è£… rook operator $ kubectl apply -f operator.yaml åœ¨ç»§ç»­æ“ä½œä¹‹å‰ï¼ŒéªŒè¯Â rook-ceph-operatorÂ æ˜¯å¦å¤„äºâ€œRunningâ€çŠ¶æ€ï¼šÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 [root@k8s-master1 ~]# [root@k8s-master1 ~]# kubectl get pod -n rook-ceph NAME READY STATUS RESTARTS AGE csi-cephfsplugin-79wcl 3/3 Running 0 7h28m csi-cephfsplugin-jmrgs 3/3 Running 0 7h28m csi-cephfsplugin-provisioner-85979bcd-cfgqx 4/4 Running 22 7h28m csi-cephfsplugin-provisioner-85979bcd-pzjsr 4/4 Running 10 7h28m csi-rbdplugin-j26wk 3/3 Running 0 7h28m csi-rbdplugin-pdbjl 3/3 Running 0 7h28m csi-rbdplugin-provisioner-66f64ff49c-qwhh9 5/5 Running 18 7h28m csi-rbdplugin-provisioner-66f64ff49c-sq57h 5/5 Running 37 7h28m rook-ceph-crashcollector-k8s-node1-fcb4cfc96-4fn26 1/1 Running 0 7h26m rook-ceph-crashcollector-k8s-node2-d97b797b5-mnc2b 1/1 Running 0 7h26m rook-ceph-mgr-a-5dcbf79d8b-n9j68 1/1 Running 0 4h49m rook-ceph-mon-a-75978c9d5b-vhmkx 1/1 Running 1 7h27m rook-ceph-mon-b-7955589ff4-fhbb5 1/1 Running 0 7h26m rook-ceph-operator-658dfb6cc4-9z5lw 1/1 Running 13 7h29m rook-ceph-osd-0-546d474d95-wkn4k 1/1 Running 0 7h26m rook-ceph-osd-1-5c7cc4b9d6-g4g7t 1/1 Running 0 7h26m rook-ceph-osd-prepare-k8s-node1-6nttm 0/1 Completed 0 140m rook-ceph-osd-prepare-k8s-node2-jmddp 0/1 Completed 0 140m rook-ceph-tools-f56f69476-8mnjf 1/1 Running 0 7h16m rook-discover-bgcth 1/1 Running 0 7h29m rook-discover-km45k 1/1 Running 0 7h29m æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Operator è¿è¡ŒæˆåŠŸåï¼Œè¿˜ä¼šæœ‰ä¸€ä¸ª DaemonSet æ§åˆ¶å™¨è¿è¡Œå¾— rook-discover åº”ç”¨ï¼Œå½“Â Rook OperatorÂ å¤„äº Running çŠ¶æ€ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»º Ceph é›†ç¾¤äº†ã€‚ä¸ºäº†ä½¿é›†ç¾¤åœ¨é‡å¯åä¸å—å½±å“ï¼Œè¯·ç¡®ä¿è®¾ç½®çš„Â dataDirHostPathÂ å±æ€§å€¼ä¸ºæœ‰æ•ˆå¾—ä¸»æœºè·¯å¾„ã€‚æ›´å¤šç›¸å…³è®¾ç½®ï¼Œå¯ä»¥æŸ¥çœ‹é›†ç¾¤é…ç½®ç›¸å…³æ–‡æ¡£ã€‚\nåˆ›å»ºå¦‚ä¸‹çš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š(cluster.yaml)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 apiVersion: ceph.rook.io/v1 kind: CephCluster metadata: name: rook-ceph namespace: rook-ceph spec: cephVersion: # æœ€æ–°å¾— ceph é•œåƒ, å¯ä»¥æŸ¥çœ‹ https://hub.docker.com/r/ceph/ceph/tags image: ceph/ceph:v14.2.5 dataDirHostPath: /var/lib/rook # ä¸»æœºæœ‰æ•ˆç›®å½• mon: count: 3 dashboard: enabled: true storage: useAllNodes: true useAllDevices: false # é‡è¦: Directories åº”è¯¥åªåœ¨é¢„ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ directories: - path: /data/rook å…¶ä¸­æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µï¼š\ndataDirHostPathï¼šå®¿ä¸»æœºä¸Šçš„ç›®å½•ï¼Œç”¨äºæ¯ä¸ªæœåŠ¡å­˜å‚¨é…ç½®å’Œæ•°æ®ã€‚å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºè¯¥ç›®å½•ã€‚ç”±äºæ­¤ç›®å½•åœ¨ä¸»æœºä¸Šä¿ç•™ï¼Œå› æ­¤åœ¨åˆ é™¤ Pod åå°†ä¿ç•™è¯¥ç›®å½•ï¼Œå¦å¤–ä¸å¾—ä½¿ç”¨ä»¥ä¸‹è·¯å¾„åŠå…¶ä»»ä½•å­è·¯å¾„ï¼š/etc/cephã€/rookÂ æˆ–Â /var/log/cephã€‚ useAllNodesï¼šç”¨äºè¡¨ç¤ºæ˜¯å¦ä½¿ç”¨é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œå­˜å‚¨ï¼Œå¦‚æœåœ¨Â nodesÂ å­—æ®µä¸‹æŒ‡å®šäº†å„ä¸ªèŠ‚ç‚¹ï¼Œåˆ™å¿…é¡»å°†useAllNodesè®¾ç½®ä¸º falseã€‚\nuseAllDevicesï¼šè¡¨ç¤º OSD æ˜¯å¦è‡ªåŠ¨ä½¿ç”¨èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰è®¾å¤‡ï¼Œä¸€èˆ¬è®¾ç½®ä¸º falseï¼Œè¿™æ ·å¯æ§æ€§è¾ƒé«˜\ndirectoriesï¼šä¸€èˆ¬æ¥è¯´åº”è¯¥ä½¿ç”¨ä¸€å—è£¸ç›˜æ¥åšå­˜å‚¨ï¼Œæœ‰æ—¶ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œä½¿ç”¨ä¸€ä¸ªç›®å½•ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå½“ç„¶ç”Ÿæˆç¯å¢ƒä¸æ¨èä½¿ç”¨ç›®å½•ã€‚\né™¤äº†ä¸Šé¢è¿™äº›å­—æ®µå±æ€§ä¹‹å¤–è¿˜æœ‰å¾ˆå¤šå…¶ä»–å¯ä»¥ç»†ç²’åº¦æ§åˆ¶å¾—å‚æ•°ï¼Œå¯ä»¥æŸ¥çœ‹é›†ç¾¤é…ç½®ç›¸å…³æ–‡æ¡£ã€‚\nç°åœ¨ç›´æ¥åˆ›å»ºä¸Šé¢çš„Â CephClusterÂ å¯¹è±¡å³å¯ï¼š\n1 2 $ kubectl apply -f cluster.yaml cephcluster.ceph.rook.io/rook-ceph created åˆ›å»ºå®Œæˆåï¼ŒRook Operator å°±ä¼šæ ¹æ®æˆ‘\néªŒè¯ è¦éªŒè¯é›†ç¾¤æ˜¯å¦å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Â Rook å·¥å…·ç®±Â æ¥è¿è¡ŒÂ ceph statusÂ å‘½ä»¤æŸ¥çœ‹ã€‚\nRook å·¥å…·ç®±æ˜¯ä¸€ä¸ªç”¨äºè°ƒè¯•å’Œæµ‹è¯• Rook çš„å¸¸ç”¨å·¥å…·å®¹å™¨ï¼Œè¯¥å·¥å…·åŸºäº CentOS é•œåƒï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ yum æ¥è½»æ¾å®‰è£…æ›´å¤šçš„å·¥å…·åŒ…ã€‚æˆ‘ä»¬è¿™é‡Œç”¨ Deployment æ§åˆ¶å™¨æ¥éƒ¨ç½² Rook å·¥å…·ç®±ï¼Œéƒ¨ç½²çš„èµ„æºæ¸…å•æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼šï¼ˆtoolbox.yamlï¼‰\nä»¬çš„æè¿°ä¿¡æ¯å»è‡ªåŠ¨åˆ›å»º Ceph é›†ç¾¤äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 apiVersion: apps/v1 kind: Deployment metadata: name: rook-ceph-tools namespace: rook-ceph labels: app: rook-ceph-tools spec: replicas: 1 selector: matchLabels: app: rook-ceph-tools template: metadata: labels: app: rook-ceph-tools spec: dnsPolicy: ClusterFirstWithHostNet containers: - name: rook-ceph-tools image: rook/ceph:v1.2.1 command: [\u0026#34;/tini\u0026#34;] args: [\u0026#34;-g\u0026#34;, \u0026#34;--\u0026#34;, \u0026#34;/usr/local/bin/toolbox.sh\u0026#34;] imagePullPolicy: IfNotPresent env: - name: ROOK_ADMIN_SECRET valueFrom: secretKeyRef: name: rook-ceph-mon key: admin-secret securityContext: privileged: true volumeMounts: - mountPath: /dev name: dev - mountPath: /sys/bus name: sysbus - mountPath: /lib/modules name: libmodules - name: mon-endpoint-volume mountPath: /etc/rook # å¦‚æœè®¾ç½® hostNetwork: false, \u0026#34;rbd map\u0026#34; å‘½ä»¤ä¼šè¢« hang ä½, å‚è€ƒ https://github.com/rook/rook/issues/2021 hostNetwork: true volumes: - name: dev hostPath: path: /dev - name: sysbus hostPath: path: /sys/bus - name: libmodules hostPath: path: /lib/modules - name: mon-endpoint-volume configMap: name: rook-ceph-mon-endpoints items: - key: data path: mon-endpoints ç„¶åç›´æ¥åˆ›å»ºè¿™ä¸ª Podï¼š\n1 2 $ kubectl apply -f toolbox.yaml deployment.apps/rook-ceph-tools created ä¸€æ—¦ toolbox çš„ Pod è¿è¡ŒæˆåŠŸåï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›å…¥åˆ°å·¥å…·ç®±å†…éƒ¨è¿›è¡Œæ“ä½œï¼š\n1 $ kubectl -n rook-ceph exec -it $(kubectl -n rook-ceph get pod -l \u0026#34;app=rook-ceph-tools\u0026#34; -o jsonpath=\u0026#39;{.items[0].metadata.name}\u0026#39;) bash å·¥å…·ç®±ä¸­çš„æ‰€æœ‰å¯ç”¨å·¥å…·å‘½ä»¤å‡å·²å‡†å¤‡å°±ç»ªï¼Œå¯æ»¡è¶³æ‚¨çš„æ•…éšœæ’é™¤éœ€æ±‚ã€‚ä¾‹å¦‚ï¼š\n1 2 3 4 ceph status ceph osd status ceph df rados df æ¯”å¦‚ç°åœ¨æˆ‘ä»¬è¦æŸ¥çœ‹é›†ç¾¤çš„çŠ¶æ€ï¼Œéœ€è¦æ»¡è¶³ä¸‹é¢çš„æ¡ä»¶æ‰è®¤ä¸ºæ˜¯å¥åº·çš„ï¼š\næ‰€æœ‰ mons åº”è¯¥è¾¾åˆ°æ³•å®šæ•°é‡ mgr åº”è¯¥æ˜¯æ¿€æ´»çŠ¶æ€ è‡³å°‘æœ‰ä¸€ä¸ª OSD å¤„äºæ¿€æ´»çŠ¶æ€ å¦‚æœä¸æ˜¯ HEALTH_OK çŠ¶æ€ï¼Œåˆ™åº”è¯¥æŸ¥çœ‹å‘Šè­¦æˆ–è€…é”™è¯¯ä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ ceph status ceph status cluster: id: dae083e6-8487-447b-b6ae-9eb321818439 health: HEALTH_OK services: mon: 3 daemons, quorum a,b,c (age 15m) mgr: a(active, since 2m) osd: 31 osds: 2 up (since 6m), 2 in (since 6m) data: pools: 0 pools, 0 pgs objects: 0 objects, 0 B usage: 79 GiB used, 314 GiB / 393 GiB avail pgs: å¦‚æœç¾¤é›†è¿è¡Œä¸æ­£å¸¸ï¼Œå¯ä»¥æŸ¥çœ‹Â Ceph å¸¸è§é—®é¢˜ä»¥äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯å’Œå¯èƒ½çš„è§£å†³æ–¹æ¡ˆã€‚\nDashboard Ceph æœ‰ä¸€ä¸ª Dashboard å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢æŸ¥çœ‹é›†ç¾¤çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬æ€»ä½“è¿è¡ŒçŠ¶æ€ï¼Œmgrã€osd å’Œå…¶ä»– Ceph è¿›ç¨‹çš„çŠ¶æ€ï¼ŒæŸ¥çœ‹æ± å’Œ PG çŠ¶æ€ï¼Œä»¥åŠæ˜¾ç¤ºå®ˆæŠ¤è¿›ç¨‹çš„æ—¥å¿—ç­‰ç­‰ã€‚\næˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢çš„ cluster CRD å¯¹è±¡ä¸­å¼€å¯ dashboardï¼Œè®¾ç½®dashboard.enable=trueå³å¯ï¼Œè¿™æ · Rook Operator å°±ä¼šå¯ç”¨ ceph-mgr dashboard æ¨¡å—ï¼Œå¹¶å°†åˆ›å»ºä¸€ä¸ª Kubernetes Service æ¥æš´éœ²è¯¥æœåŠ¡ï¼Œå°†å¯ç”¨ç«¯å£ 7000 è¿›è¡Œ https è®¿é—®ï¼Œå¦‚æœ Ceph é›†ç¾¤éƒ¨ç½²æˆåŠŸäº†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æŸ¥çœ‹ Dashboard çš„ Serviceï¼š\n1 2 3 4 $ kubectl get svc -n rook-ceph NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE rook-ceph-mgr ClusterIP 10.99.87.1 \u0026lt;none\u0026gt; 9283/TCP 3m6s rook-ceph-mgr-dashboard ClusterIP 10.111.195.180 \u0026lt;none\u0026gt; 7000/TCP 3m29s è¿™é‡Œçš„ rook-ceph-mgr æœåŠ¡ç”¨äºæŠ¥å‘Š Prometheus metrics æŒ‡æ ‡æ•°æ®çš„ï¼Œè€Œåé¢çš„çš„ rook-ceph-mgr-dashboard æœåŠ¡å°±æ˜¯æˆ‘ä»¬çš„ Dashboard æœåŠ¡ï¼Œå¦‚æœåœ¨é›†ç¾¤å†…éƒ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡ DNS åç§°Â http://rook-ceph-mgr-dashboard.rook-ceph:7000æˆ–è€… CluterIPÂ http://10.111.195.180:7000Â æ¥è¿›è¡Œè®¿é—®ï¼Œä½†æ˜¯å¦‚æœè¦åœ¨é›†ç¾¤å¤–éƒ¨è¿›è¡Œè®¿é—®çš„è¯ï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡ Ingress æˆ–è€… NodePort ç±»å‹çš„ Service æ¥æš´éœ²äº†ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•æˆ‘ä»¬è¿™é‡Œåˆ›å»ºä¸€ä¸ªæ–°çš„ NodePort ç±»å‹çš„æœåŠ¡æ¥è®¿é—® Dashboardï¼Œèµ„æºæ¸…å•å¦‚ä¸‹æ‰€ç¤ºï¼šï¼ˆdashboard-external.yamlï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 kind: Service metadata: name: rook-ceph-mgr-dashboard-external namespace: rook-ceph labels: app: rook-ceph-mgr rook_cluster: rook-ceph spec: ports: - name: dashboard port: 7000 protocol: TCP targetPort: 7000 selector: app: rook-ceph-mgr rook_cluster: rook-ceph type: NodePort åŒæ ·ç›´æ¥åˆ›å»ºå³å¯ï¼š\n1 $ kubectl apply -f dashboard-external.yaml åˆ›å»ºå®Œæˆåæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åˆ°æ–°åˆ›å»ºçš„ rook-ceph-mgr-dashboard-external è¿™ä¸ª Service æœåŠ¡ï¼š\n1 2 3 4 5 $ kubectl get svc -n rook-ceph NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE rook-ceph-mgr ClusterIP 10.96.49.29 \u0026lt;none\u0026gt; 9283/TCP 23m rook-ceph-mgr-dashboard ClusterIP 10.109.8.98 \u0026lt;none\u0026gt; 7000/TCP 23m rook-ceph-mgr-dashboard-external NodePort 10.109.53.223 \u0026lt;none\u0026gt; 7000:31361/TCP 14s ç°åœ¨æˆ‘ä»¬éœ€è¦é€šè¿‡Â http://\u0026lt;NodeIp\u0026gt;:31361Â å°±å¯ä»¥è®¿é—®åˆ° Dashboard äº†ã€‚\nä½†æ˜¯åœ¨è®¿é—®çš„æ—¶å€™éœ€è¦æˆ‘ä»¬ç™»å½•æ‰èƒ½å¤Ÿè®¿é—®ï¼ŒRook åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ· adminï¼Œå¹¶åœ¨è¿è¡Œ Rook çš„å‘½åç©ºé—´ä¸­ç”Ÿæˆäº†ä¸€ä¸ªåä¸ºÂ rook-ceph-dashboard-admin-passwordÂ çš„ Secretï¼Œè¦è·å–å¯†ç ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\n1 2 $ kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=\u0026#34;{[\u0026#39;data\u0026#39;][\u0026#39;password\u0026#39;]}\u0026#34; | base64 --decode \u0026amp;\u0026amp; echo xxxxï¼ˆç™»å½•å¯†ç ï¼‰ ç”¨ä¸Šé¢è·å¾—çš„å¯†ç å’Œç”¨æˆ·å admin å°±å¯ä»¥ç™»å½• Dashboard äº†ï¼Œåœ¨ Dashboard ä¸Šé¢å¯ä»¥æŸ¥çœ‹åˆ°æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼š\nä½¿ç”¨ ç°åœ¨æˆ‘ä»¬çš„ Ceph é›†ç¾¤æ­å»ºæˆåŠŸäº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥ä½¿ç”¨å­˜å‚¨äº†ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºå­˜å‚¨æ± ï¼Œå¯ä»¥ç”¨ CRD æ¥å®šä¹‰ Poolã€‚Rook æä¾›äº†ä¸¤ç§æœºåˆ¶æ¥ç»´æŒ OSDï¼š\nå‰¯æœ¬ï¼šç¼ºçœé€‰é¡¹ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½ä¼šæ ¹æ®Â spec.replicated.sizeÂ åœ¨å¤šä¸ªç£ç›˜ä¸Šè¿›è¡Œå¤åˆ¶ã€‚å»ºè®®éç”Ÿäº§ç¯å¢ƒè‡³å°‘ 2 ä¸ªå‰¯æœ¬ï¼Œç”Ÿäº§ç¯å¢ƒè‡³å°‘ 3 ä¸ªã€‚ Erasure Codeï¼šæ˜¯ä¸€ç§è¾ƒä¸ºèŠ‚çº¦çš„æ–¹å¼ã€‚EC æŠŠæ•°æ®æ‹†åˆ† n æ®µï¼ˆspec.erasureCoded.dataChunksï¼‰ï¼Œå†åŠ å…¥ k ä¸ªä»£ç æ®µï¼ˆspec.erasureCoded.codingChunksï¼‰ï¼Œç”¨åˆ†å¸ƒçš„æ–¹å¼æŠŠÂ n+kÂ æ®µæ•°æ®ä¿å­˜åœ¨ç£ç›˜ä¸Šã€‚è¿™ç§æƒ…å†µä¸‹ Ceph èƒ½å¤Ÿéš”ç¦» k ä¸ª OSD çš„æŸå¤±ã€‚ æˆ‘ä»¬è¿™é‡Œä½¿ç”¨å‰¯æœ¬çš„æ–¹å¼ï¼Œåˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºçš„ RBD ç±»å‹çš„å­˜å‚¨æ± ï¼š(pool.yaml)\n1 2 3 4 5 6 7 8 9 apiVersion: ceph.rook.io/v1 kind: CephBlockPool metadata: name: k8s-test-pool # operatorä¼šç›‘å¬å¹¶åˆ›å»ºä¸€ä¸ªpoolï¼Œæ‰§è¡Œå®Œåç•Œé¢ä¸Šä¹Ÿèƒ½çœ‹åˆ°å¯¹åº”çš„pool namespace: rook-ceph spec: failureDomain: host # æ•°æ®å—çš„æ•…éšœåŸŸ: å€¼ä¸ºhostæ—¶ï¼Œæ¯ä¸ªæ•°æ®å—å°†æ”¾ç½®åœ¨ä¸åŒçš„ä¸»æœºä¸Š;å€¼ä¸ºosdæ—¶ï¼Œæ¯ä¸ªæ•°æ®å—å°†æ”¾ç½®åœ¨ä¸åŒçš„osdä¸Š replicated: size: 3 # æ± ä¸­æ•°æ®çš„å‰¯æœ¬æ•°,1å°±æ˜¯ä¸ä¿å­˜ä»»ä½•å‰¯æœ¬ ç›´æ¥åˆ›å»ºä¸Šé¢çš„èµ„æºå¯¹è±¡ï¼š\n1 2 $ kubectl apply -f pool.yaml cephblockpool.ceph.rook.io/k8s-test-pool created å­˜å‚¨æ± åˆ›å»ºå®Œæˆåæˆ‘ä»¬åœ¨ Dashboard ä¸Šé¢çš„ç¡®å¯ä»¥çœ‹åˆ°æ–°å¢äº†ä¸€ä¸ª poolï¼Œä½†æ˜¯ä¼šå‘ç°é›†ç¾¤å¥åº·çŠ¶æ€å˜æˆäº†Â WARNï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åˆ°æœ‰å¦‚ä¸‹æ—¥å¿—å‡ºç°ï¼š\n1 Health check update: too few PGs per OSD (6 \u0026lt; min 30) (TOO_FEW_PGS) è¿™æ˜¯å› ä¸ºæ¯ä¸ª osd ä¸Šçš„ pg æ•°é‡å°äºæœ€å°çš„æ•°ç›®30ä¸ªã€‚pgs ä¸º8ï¼Œå› ä¸ºæ˜¯3å‰¯æœ¬çš„é…ç½®ï¼Œæ‰€ä»¥å½“æœ‰4ä¸ª osd çš„æ—¶å€™ï¼Œæ¯ä¸ª osd ä¸Šå‡åˆ†äº†8/4 *3=6ä¸ªpgsï¼Œä¹Ÿå°±æ˜¯å‡ºç°äº†å¦‚ä¸Šçš„é”™è¯¯å°äºæœ€å°é…ç½®30ä¸ªï¼Œé›†ç¾¤è¿™ç§çŠ¶æ€å¦‚æœè¿›è¡Œæ•°æ®çš„å­˜å‚¨å’Œæ“ä½œï¼Œé›†ç¾¤ä¼šå¡æ­»ï¼Œæ— æ³•å“åº”ioï¼ŒåŒæ—¶ä¼šå¯¼è‡´å¤§é¢ç§¯çš„ osd downã€‚\næˆ‘ä»¬å¯ä»¥è¿›å…¥ toolbox çš„å®¹å™¨ä¸­æŸ¥çœ‹ä¸Šé¢å­˜å‚¨çš„ pg æ•°é‡ï¼š\n1 2 $ ceph osd pool get k8s-test-pool pg_num pg_num: 8 æˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ  pg_num æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 $ ceph osd pool set k8s-test-pool pg_num 64 set pool 1 pg_num to 64 $ ceph -s cluster: id: 7851387c-5d18-489a-8c04-b699fb9764c0 health: HEALTH_OK services: mon: 3 daemons, quorum a,b,c (age 33m) mgr: a(active, since 32m) osd: 4 osds: 4 up (since 32m), 4 in (since 32m) data: pools: 1 pools, 64 pgs objects: 0 objects, 0 B usage: 182 GiB used, 605 GiB / 787 GiB avail pgs: 64 active+clean è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æŸ¥çœ‹å°±å¯ä»¥çœ‹åˆ°ç°åœ¨å°±æ˜¯å¥åº·çŠ¶æ€äº†ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¿™é‡Œçš„ pool ä¸Šæ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥ä¿®æ”¹ pg å½±å“å¹¶ä¸å¤§ï¼Œä½†æ˜¯å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒé‡æ–°ä¿®æ”¹ pg æ•°ï¼Œä¼šå¯¹ç”Ÿäº§ç¯å¢ƒäº§ç”Ÿè¾ƒå¤§å½±å“ã€‚å› ä¸º pg æ•°å˜äº†ï¼Œå°±ä¼šå¯¼è‡´æ•´ä¸ªé›†ç¾¤çš„æ•°æ®é‡æ–°å‡è¡¡å’Œè¿ç§»ï¼Œæ•°æ®è¶Šå¤§å“åº” io çš„æ—¶é—´ä¼šè¶Šé•¿ã€‚æ‰€ä»¥ï¼Œæœ€å¥½åœ¨ä¸€å¼€å§‹å°±è®¾ç½®å¥½ pg æ•°ã€‚\nç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ª StorageClass æ¥è¿›è¡ŒåŠ¨æ€å­˜å‚¨é…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª Ceph çš„å—å­˜å‚¨çš„ StorageClassï¼š(storageclass.yaml)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: rook-ceph-block provisioner: rook-ceph.rbd.csi.ceph.com parameters: # clusterID æ˜¯ rook é›†ç¾¤è¿è¡Œçš„å‘½åç©ºé—´ clusterID: rook-ceph # æŒ‡å®šå­˜å‚¨æ±  pool: k8s-test-pool # RBD image (å®é™…çš„å­˜å‚¨ä»‹è´¨) æ ¼å¼. é»˜è®¤ä¸º \u0026#34;2\u0026#34;. imageFormat: \u0026#34;2\u0026#34; # RBD image ç‰¹æ€§. CSI RBD ç°åœ¨åªæ”¯æŒ `layering` . imageFeatures: layering # Ceph ç®¡ç†å‘˜è®¤è¯ä¿¡æ¯ï¼Œè¿™äº›éƒ½æ˜¯åœ¨ clusterID å‘½åç©ºé—´ä¸‹é¢è‡ªåŠ¨ç”Ÿæˆçš„ csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph # æŒ‡å®š volume çš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼ï¼Œå¦‚æœä¸æŒ‡å®š, csi-provisioner ä¼šé»˜è®¤è®¾ç½®ä¸º `ext4` csi.storage.k8s.io/fstype: ext4 # uncomment the following to use rbd-nbd as mounter on supported nodes # **IMPORTANT**: If you are using rbd-nbd as the mounter, during upgrade you will be hit a ceph-csi # issue that causes the mount to be disconnected. You will need to follow special upgrade steps # to restart your application pods. Therefore, this option is not recommended. #mounter: rbd-nbd reclaimPolicy: Delete ç›´æ¥åˆ›å»ºä¸Šé¢çš„ StorageClass èµ„æºå¯¹è±¡ï¼š\n1 2 3 4 5 $ kubectl apply -f storageclass.yaml storageclass.storage.k8s.io/rook-ceph-block created $ kubectl get storageclass NAME PROVISIONER AGE rook-ceph-block rook-ceph.rbd.csi.ceph.com 35s ç„¶ååˆ›å»ºä¸€ä¸ª PVC æ¥ä½¿ç”¨ä¸Šé¢çš„ StorageClass å¯¹è±¡ï¼š(pvc.yaml)\n1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: v1 kind: PersistentVolumeClaim metadata: name: mysql-pv-claim labels: app: wordpress spec: storageClassName: rook-ceph-block accessModes: - ReadWriteOnce resources: requests: storage: 20Gi åŒæ ·ç›´æ¥åˆ›å»ºä¸Šé¢çš„ PVC èµ„æºå¯¹è±¡ï¼š\n1 2 3 4 5 $ kubectl apply -f pvc.yaml persistentvolumeclaim/mysql-pv-claim created $ kubectl get pvc -l app=wordpress NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE mysql-pv-claim Bound pvc-1eab82e3-d214-4d8e-8fcc-ed379c24e0e3 20Gi RWO rook-ceph-block 32m åˆ›å»ºå®Œæˆåæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ PVC å¯¹è±¡å·²ç»æ˜¯ Bound çŠ¶æ€äº†ï¼Œè‡ªåŠ¨åˆ›å»ºäº†å¯¹åº”çš„ PVï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ª PVC å¯¹è±¡æ¥åšæ•°æ®æŒä¹…åŒ–æ“ä½œäº†ã€‚\nè¿™ä¸ªæ—¶å€™å¯èƒ½é›†ç¾¤è¿˜ä¼šå‡ºç°å¦‚ä¸‹çš„å¥åº·æç¤ºï¼š\n1 2 3 4 5 6 7 $ ceph health detail HEALTH_WARN application not enabled on 1 pool(s) POOL_APP_NOT_ENABLED application not enabled on 1 pool(s) application not enabled on pool \u0026#39;k8s-test-pool\u0026#39; use \u0026#39;ceph osd pool application enable \u0026lt;pool-name\u0026gt; \u0026lt;app-name\u0026gt;\u0026#39;, where \u0026lt;app-name\u0026gt; is \u0026#39;cephfs\u0026#39;, \u0026#39;rbd\u0026#39;, \u0026#39;rgw\u0026#39;, or freeform for custom applications. $ ceph osd pool application enable k8s-test-pool k8srbd enabled application \u0026#39;k8srbd\u0026#39; on pool \u0026#39;k8s-test-pool\u0026#39; æ ¹æ®æç¤ºå¯ç”¨ä¸€ä¸ª application å³å¯ã€‚\nåœ¨å®˜æ–¹ä»“åº“Â cluster/examples/kubernetesÂ ç›®å½•ä¸‹ï¼Œå®˜æ–¹ç»™äº†ä¸ª wordpress çš„ä¾‹å­ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œæµ‹è¯•å³å¯ï¼š\n1 2 $ kubectl apply -f mysql.yaml $ kubectl apply -f wordpress.yaml å®˜æ–¹çš„è¿™ä¸ªç¤ºä¾‹é‡Œé¢çš„ wordpress ç”¨çš„ Loadbalancer ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹æˆ NodePortï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 $ kubectl get pvc -l app=wordpress NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE mysql-pv-claim Bound pvc-1eab82e3-d214-4d8e-8fcc-ed379c24e0e3 20Gi RWO rook-ceph-block 12h wp-pv-claim Bound pvc-237932ed-5ca7-468c-bd16-220ebb2a1ce3 20Gi RWO rook-ceph-block 25s $ kubectl get pods -l app=wordpress NAME READY STATUS RESTARTS AGE wordpress-5b886cf59b-4xwn8 1/1 Running 0 24m wordpress-mysql-b9ddd6d4c-qhjd4 1/1 Running 0 24m $ kubectl get svc -l app=wordpress NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE wordpress NodePort 10.106.253.225 \u0026lt;none\u0026gt; 80:30307/TCP 80s wordpress-mysql ClusterIP None \u0026lt;none\u0026gt; 3306/TCP 87s å½“åº”ç”¨éƒ½å¤„äº Running çŠ¶æ€åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Â http://\u0026lt;ä»»æ„èŠ‚ç‚¹IP\u0026gt;:30307Â å»è®¿é—® wordpress åº”ç”¨ï¼š\næ¯”å¦‚æˆ‘ä»¬åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­æ›´æ”¹ä¸‹å†…å®¹ï¼Œç„¶åæˆ‘ä»¬å°†åº”ç”¨ Pod å…¨éƒ¨åˆ é™¤é‡å»ºï¼š\n1 2 3 4 5 6 7 $ kubectl delete pod wordpress-mysql-b9ddd6d4c-qhjd4 wordpress-5b886cf59b-4xwn8 pod \u0026#34;wordpress-mysql-b9ddd6d4c-qhjd4\u0026#34; deleted pod \u0026#34;wordpress-5b886cf59b-4xwn8\u0026#34; deleted $ kubectl get pods -l app=wordpress NAME READY STATUS RESTARTS AGE wordpress-5b886cf59b-kwxk4 1/1 Running 0 2m52s wordpress-mysql-b9ddd6d4c-kkcr7 1/1 Running 0 2m52s å½“ Pod é‡å»ºå®Œæˆåå†æ¬¡è®¿é—® wordpress åº”ç”¨çš„ä¸»é¡µæˆ‘ä»¬å¯ä»¥å‘ç°ä¹‹å‰æˆ‘ä»¬æ·»åŠ çš„æ•°æ®ä»ç„¶å­˜åœ¨ï¼Œè¿™å°±è¯æ˜æˆ‘ä»¬çš„æ•°æ®æŒä¹…åŒ–æ˜¯æ­£ç¡®çš„ã€‚\nåŸæ–‡åœ°å€ï¼šhttps://www.qikqiak.com/k8strain/storage/ceph/\n","date":"2021-04-02T18:01:08Z","image":"https://www.ownit.top/title_pic/20.jpg","permalink":"https://www.ownit.top/p/202104021801/","title":"Rookéƒ¨ç½²æµ‹è¯•Cephå’Œwordpresså®æˆ˜åº”ç”¨"},{"content":"Kubernetes 1.18.3 éƒ¨ç½² Traefik2.2 Traefikçš„ä¸­é—´ä»¶ï¼Œç°åº¦å‘å¸ƒï¼Œæµé‡å¤åˆ¶åŸºäºä¸Šç¯‡æ–‡ç« ç¯å¢ƒã€‚\n1.éƒ¨ç½²whoamiÂ åº”ç”¨å’ŒSVC 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 apiVersion: v1 kind: Service metadata: name: whoami spec: ports: - protocol: TCP name: web port: 80 selector: app: whoami --- kind: Deployment apiVersion: apps/v1 metadata: name: whoami labels: app: whoami spec: replicas: 2 selector: matchLabels: app: whoami template: metadata: labels: app: whoami spec: containers: - name: whoami image: containous/whoami ports: - name: web containerPort: 80 2.éƒ¨ç½²Â IngressRoute å¯¹è±¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: simpleingressroute spec: entryPoints: - web routes: - match: Host(`who.heian.com`) \u0026amp;\u0026amp; PathPrefix(`/notls`) kind: Rule services: - name: whoami port: 80 3.é…ç½® HTTPS è·¯ç”± 1 2 3 4 5 6 7 8 [root@k8s-master1 who]# openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \u0026#34;/CN=who.heian.com\u0026#34; Generating a 2048 bit RSA private key ..........................................................................+++ ..........+++ writing new private key to \u0026#39;tls.key\u0026#39; ----- [root@k8s-master1 who]# kubectl create secret tls who-tls --cert=tls.crt --key=tls.key secret/who-tls created åˆ›å»ºä¸€ä¸ª HTTPS è®¿é—®åº”ç”¨çš„ IngressRoute å¯¹è±¡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 apiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: ingressroutetls spec: entryPoints: - websecure routes: - match: Host(`who.heian.com`) \u0026amp;\u0026amp; PathPrefix(`/tls`) kind: Rule services: - name: whoami port: 80 tls: secretName: who-tls 4 .Â ä¸­é—´ä»¶ ä¸­é—´ä»¶æ˜¯ Traefik2.0 ä¸­ä¸€ä¸ªéå¸¸æœ‰ç‰¹è‰²çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„å„ç§éœ€æ±‚å»é€‰æ‹©ä¸åŒçš„ä¸­é—´ä»¶æ¥æ»¡è¶³æœåŠ¡ï¼ŒTraefik å®˜æ–¹å·²ç»å†…ç½®äº†è®¸å¤šä¸åŒåŠŸèƒ½çš„ä¸­é—´ä»¶ï¼Œå…¶ä¸­ä¸€äº›å¯ä»¥ä¿®æ”¹è¯·æ±‚ï¼Œå¤´ä¿¡æ¯ï¼Œä¸€äº›è´Ÿè´£é‡å®šå‘ï¼Œä¸€äº›æ·»åŠ èº«ä»½éªŒè¯ç­‰ç­‰ï¼Œè€Œä¸”ä¸­é—´ä»¶è¿˜å¯ä»¥é€šè¿‡é“¾å¼ç»„åˆçš„æ–¹å¼æ¥é€‚ç”¨å„ç§æƒ…å†µã€‚\nåŒæ ·æ¯”å¦‚ä¸Šé¢æˆ‘ä»¬å®šä¹‰çš„ whoami è¿™ä¸ªåº”ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Â https://who.heian.com/tlsÂ æ¥è®¿é—®åˆ°åº”ç”¨ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ç”¨Â httpÂ æ¥è®¿é—®çš„è¯å‘¢å°±ä¸è¡Œäº†ï¼Œå°±ä¼š404äº†ï¼Œå› ä¸ºæˆ‘ä»¬æ ¹æœ¬å°±æ²¡æœ‰ç®€å•80ç«¯å£è¿™ä¸ªå…¥å£ç‚¹ï¼Œ\næ‰€ä»¥è¦æƒ³é€šè¿‡Â httpÂ æ¥è®¿é—®åº”ç”¨çš„è¯è‡ªç„¶æˆ‘ä»¬éœ€è¦ç›‘å¬ä¸‹Â webÂ è¿™ä¸ªå…¥å£ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: ingressroutetls-http spec: entryPoints: - web routes: - match: Host(`who.heian.com`) \u0026amp;\u0026amp; PathPrefix(`/tls`) kind: Rule services: - name: whoami port: 80 æ³¨æ„è¿™é‡Œæˆ‘ä»¬åˆ›å»ºçš„ IngressRoute çš„ entryPoints æ˜¯Â webï¼Œç„¶ååˆ›å»ºè¿™ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ http è®¿é—®åˆ°è¿™ä¸ªåº”ç”¨äº†ã€‚\nä½†æ˜¯æˆ‘ä»¬å¦‚æœåªå¸Œæœ›ç”¨æˆ·é€šè¿‡ https æ¥è®¿é—®åº”ç”¨çš„è¯å‘¢ï¼ŸæŒ‰ç…§ä»¥å‰çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥è®© http å¼ºåˆ¶è·³è½¬åˆ° https æœåŠ¡å»ï¼Œå¯¹çš„ï¼Œåœ¨ Traefik ä¸­ä¹Ÿæ˜¯å¯ä»¥é…ç½®å¼ºåˆ¶è·³è½¬çš„ï¼Œåªæ˜¯è¿™ä¸ªåŠŸèƒ½ç°åœ¨æ˜¯é€šè¿‡ä¸­é—´ä»¶æ¥æä¾›çš„äº†ã€‚\nå¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨Â redirectSchemeÂ ä¸­é—´ä»¶æ¥åˆ›å»ºæä¾›å¼ºåˆ¶è·³è½¬æœåŠ¡ï¼š\n1 2 3 4 5 6 7 apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: redirect-https spec: redirectScheme: scheme: https ç„¶åå°†è¿™ä¸ªä¸­é—´ä»¶é™„åŠ åˆ° http çš„æœåŠ¡ä¸Šé¢å»ï¼Œå› ä¸º https çš„ä¸éœ€è¦è·³è½¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 apiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: ingressroutetls-http spec: entryPoints: - web routes: - match: Host(`who.heian.com`) \u0026amp;\u0026amp; PathPrefix(`/tls`) kind: Rule services: - name: whoami port: 80 middlewares: - name: redirect-https è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†å»è®¿é—® http æœåŠ¡å¯ä»¥å‘ç°å°±ä¼šè‡ªåŠ¨è·³è½¬åˆ° https å»äº†ã€‚å…³äºæ›´å¤šä¸­é—´ä»¶çš„ç”¨æ³•å¯ä»¥æŸ¥çœ‹æ–‡æ¡£Â Traefik Docsã€‚\n5. ç°åº¦å‘å¸ƒ Traefik2.0 çš„ä¸€ä¸ªæ›´å¼ºå¤§çš„åŠŸèƒ½å°±æ˜¯ç°åº¦å‘å¸ƒï¼Œç°åº¦å‘å¸ƒæˆ‘ä»¬æœ‰æ—¶å€™ä¹Ÿä¼šç§°ä¸ºé‡‘ä¸é›€å‘å¸ƒï¼ˆCanaryï¼‰ï¼Œä¸»è¦å°±æ˜¯è®©ä¸€éƒ¨åˆ†æµ‹è¯•çš„æœåŠ¡ä¹Ÿå‚ä¸åˆ°çº¿ä¸Šå»ï¼Œç»è¿‡æµ‹è¯•è§‚å¯Ÿçœ‹æ˜¯å¦ç¬¦å·ä¸Šçº¿è¦æ±‚ã€‚\næ¯”å¦‚ç°åœ¨æˆ‘ä»¬æœ‰ä¸¤ä¸ªåä¸ºÂ appv1Â å’ŒÂ appv2Â çš„æœåŠ¡ï¼Œæˆ‘ä»¬å¸Œæœ›é€šè¿‡ Traefik æ¥æ§åˆ¶æˆ‘ä»¬çš„æµé‡ï¼Œå°† 3â„4 çš„æµé‡è·¯ç”±åˆ° appv1ï¼ŒÂ¼ çš„æµé‡è·¯ç”±åˆ° appv2 å»ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥åˆ©ç”¨ Traefik2.0 ä¸­æä¾›çš„**å¸¦æƒé‡çš„è½®è¯¢ï¼ˆWRRï¼‰**æ¥å®ç°è¯¥åŠŸèƒ½\né¦–å…ˆåœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²ä¸Šé¢çš„ä¸¤ä¸ªæœåŠ¡ã€‚\nä¸ºäº†å¯¹æ¯”ç»“æœæˆ‘ä»¬è¿™é‡Œæä¾›çš„ä¸¤ä¸ªæœåŠ¡ä¸€ä¸ªæ˜¯ heian99/myapp:v2ï¼Œä¸€ä¸ªæ˜¯heian99/myapp:v1ï¼Œæ–¹ä¾¿æµ‹è¯•ã€‚\nappv1 æœåŠ¡çš„èµ„æºæ¸…å•å¦‚ä¸‹æ‰€ç¤ºï¼šï¼ˆappv1.yamlï¼‰heian99/myapp:v1\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 apiVersion: apps/v1 kind: Deployment metadata: name: appv1 spec: selector: matchLabels: app: appv1 template: metadata: labels: use: test app: appv1 spec: containers: - name: myappv1 image: heian99/myapp:v1 ports: - containerPort: 80 name: portv1 --- apiVersion: v1 kind: Service metadata: name: appv1 spec: selector: app: appv1 ports: - name: http port: 80 targetPort: portv1 appv2 æœåŠ¡çš„èµ„æºæ¸…å•å¦‚ä¸‹æ‰€ç¤ºï¼šï¼ˆappv2.yamlï¼‰heian99/myapp:v2\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 apiVersion: apps/v1 kind: Deployment metadata: name: appv2 spec: selector: matchLabels: app: appv2 template: metadata: labels: use: test app: appv2 spec: containers: - name: myappv2 image: heian99/myapp:v2 ports: - containerPort: 80 name: portv2 --- apiVersion: v1 kind: Service metadata: name: appv2 spec: selector: app: appv2 ports: - name: http port: 80 targetPort: portv2 ç›´æ¥åˆ›å»ºä¸Šé¢ä¸¤ä¸ªæœåŠ¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 [root@k8s-master1 test]# kubectl apply -f . deployment.apps/appv1 created service/appv1 created deployment.apps/appv2 created service/appv2 created [root@k8s-master1 test]# kubectl get pods -l use=test NAME READY STATUS RESTARTS AGE appv1-597bbc966f-chwpj 1/1 Running 0 69s appv2-5f5489b4c5-7gsnd 1/1 Running 0 69s åœ¨ Traefik2.1 ä¸­æ–°å¢äº†ä¸€ä¸ªÂ TraefikServiceÂ çš„ CRD èµ„æºï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨è¿™ä¸ªå¯¹è±¡æ¥é…ç½® WRRï¼Œä¹‹å‰çš„ç‰ˆæœ¬éœ€è¦é€šè¿‡ File Providerï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œæ–°å»ºä¸€ä¸ªæè¿° WRR çš„èµ„æºæ¸…å•ï¼š(wrr.yaml)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: traefik.containo.us/v1alpha1 kind: TraefikService metadata: name: app-wrr spec: weighted: services: - name: appv1 weight: 3 # å®šä¹‰æƒé‡ port: 80 kind: Service # å¯é€‰ï¼Œé»˜è®¤å°±æ˜¯ Service - name: appv2 weight: 1 port: 80 ç„¶åä¸ºæˆ‘ä»¬çš„ç°åº¦å‘å¸ƒçš„æœåŠ¡åˆ›å»ºä¸€ä¸ª IngressRoute èµ„æºå¯¹è±¡ï¼š(ingressroute.yaml)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: wrringressroute namespace: default spec: entryPoints: - web routes: - match: Host(`app.heian.com`) kind: Rule services: - name: app-wrr kind: TraefikService ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ç°åœ¨æˆ‘ä»¬é…ç½®çš„ Service ä¸å†æ˜¯ç›´æ¥çš„ Kubernetes å¯¹è±¡äº†ï¼Œè€Œæ˜¯ä¸Šé¢æˆ‘ä»¬å®šä¹‰çš„ TraefikService å¯¹è±¡ï¼Œç›´æ¥åˆ›å»ºä¸Šé¢çš„ä¸¤ä¸ªèµ„æºå¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯¹åŸŸåÂ app.heian.comÂ åšä¸Šè§£æï¼Œå»æµè§ˆå™¨ä¸­è¿ç»­è®¿é—® 4 æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ° appv1 è¿™åº”ç”¨ä¼šæ”¶åˆ° 3 æ¬¡è¯·æ±‚ï¼Œè€Œ appv2 è¿™ä¸ªåº”ç”¨åªæ”¶åˆ° 1 æ¬¡è¯·æ±‚ï¼Œç¬¦åˆä¸Šé¢æˆ‘ä»¬çš„Â 3:1Â çš„æƒé‡é…ç½®ã€‚\n6. æµé‡å¤åˆ¶ é™¤äº†ç°åº¦å‘å¸ƒä¹‹å¤–ï¼ŒTraefik 2.0 è¿˜å¼•å…¥äº†æµé‡é•œåƒæœåŠ¡ï¼Œæ˜¯ä¸€ç§å¯ä»¥å°†æµå…¥æµé‡å¤åˆ¶å¹¶åŒæ—¶å°†å…¶å‘é€ç»™å…¶ä»–æœåŠ¡çš„æ–¹æ³•ï¼Œé•œåƒæœåŠ¡å¯ä»¥è·å¾—ç»™å®šç™¾åˆ†æ¯”çš„è¯·æ±‚åŒæ—¶ä¹Ÿä¼šå¿½ç•¥è¿™éƒ¨åˆ†è¯·æ±‚çš„å“åº”ã€‚\nåŒæ ·çš„åœ¨ 2.0 ä¸­åªèƒ½é€šè¿‡ FileProvider è¿›è¡Œé…ç½®ï¼Œåœ¨ 2.1 ç‰ˆæœ¬ä¸­æˆ‘ä»¬å·²ç»å¯ä»¥é€šè¿‡Â TraefikServiceÂ èµ„æºå¯¹è±¡æ¥è¿›è¡Œé…ç½®äº†ï¼Œç°åœ¨æˆ‘ä»¬éƒ¨ç½²ä¸¤ä¸ª whoami çš„æœåŠ¡ï¼Œèµ„æºæ¸…å•æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 apiVersion: v1 kind: Service metadata: name: v1 spec: ports: - protocol: TCP name: web port: 80 selector: app: v1 --- kind: Deployment apiVersion: apps/v1 metadata: name: v1 labels: app: v1 spec: selector: matchLabels: app: v1 template: metadata: labels: app: v1 spec: containers: - name: v1 image: heian99/myapp:v1 ports: - name: web containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: v2 spec: ports: - protocol: TCP name: web port: 80 selector: app: v2 --- kind: Deployment apiVersion: apps/v1 metadata: name: v2 labels: app: v2 spec: selector: matchLabels: app: v2 template: metadata: labels: app: v2 spec: containers: - name: v2 image: heian99/myapp:v2 ports: - name: web containerPort: 80 ç°åœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª IngressRoute å¯¹è±¡ï¼Œå°†æœåŠ¡ v1 çš„æµé‡å¤åˆ¶ 50% åˆ°æœåŠ¡ v2ï¼Œå¦‚ä¸‹èµ„æºå¯¹è±¡æ‰€ç¤ºï¼š(mirror-ingress-route.yaml)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 apiVersion: traefik.containo.us/v1alpha1 kind: TraefikService metadata: name: app-mirror spec: mirroring: name: v1 # å‘é€ 100% çš„è¯·æ±‚åˆ° K8S çš„ Service \u0026#34;v1\u0026#34; port: 80 mirrors: - name: v2 # ç„¶åå¤åˆ¶ 50% çš„è¯·æ±‚åˆ° v2 percent: 50 port: 80 --- apiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: mirror-ingress-route namespace: default spec: entryPoints: - web routes: - match: Host(`mirror.heian.com`) kind: Rule services: - name: app-mirror kind: TraefikService # ä½¿ç”¨å£°æ˜çš„ TraefikService æœåŠ¡ï¼Œè€Œä¸æ˜¯ K8S çš„ Service è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­å»è¿ç»­è®¿é—®4æ¬¡Â mirror.heian.comÂ å¯ä»¥å‘ç°æœ‰ä¸€åŠçš„è¯·æ±‚ä¹Ÿå‡ºç°åœ¨äº†Â v2Â è¿™ä¸ªæœåŠ¡ä¸­ï¼š\n","date":"2021-03-29T20:31:53Z","image":"https://www.ownit.top/title_pic/34.jpg","permalink":"https://www.ownit.top/p/202103292031/","title":"Traefikçš„ä¸­é—´ä»¶ï¼Œç°åº¦å‘å¸ƒï¼Œæµé‡å¤åˆ¶"},{"content":"Kubernetes 1.18.3 éƒ¨ç½² Traefik2.0 Centos 3.10.0-693.el7.x86_64\nKubernetes 1.18.3\nTraefik 2.2\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@k8s-master1 traefik]# kubectl get cs NAME STATUS MESSAGE ERROR controller-manager Healthy ok scheduler Healthy ok etcd-0 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;} etcd-2 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;} etcd-1 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;} [root@k8s-master1 traefik]# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master Ready \u0026lt;none\u0026gt; 6d1h v1.18.3 k8s-node1 Ready \u0026lt;none\u0026gt; 6d v1.18.3 k8s-node2 Ready \u0026lt;none\u0026gt; 6d v1.18.3 [root@k8s-master1 traefik]# uname -a Linux k8s-master1 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux Traefik 2.0 å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.traefik.io/v2.0/\n1.Traefik ä»‹ç» traefik æ˜¯ä¸€æ¬¾åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡æœåŠ¡ï¼Œä½¿ç”¨ golang å®ç°çš„ã€‚å’Œ nginx æœ€å¤§çš„ä¸åŒæ˜¯ï¼Œå®ƒæ”¯æŒè‡ªåŠ¨åŒ–æ›´æ–°åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡é…ç½®ã€‚åœ¨å¾®æœåŠ¡æ¶æ„è¶Šæ¥è¶Šæµè¡Œçš„ä»Šå¤©ï¼Œä¸€ä¸ªä¸šåŠ¡æ¨ä¸å¾—æœ‰å¥½å‡ ä¸ªæ•°æ®åº“ã€åå°æœåŠ¡å’Œ webappï¼Œå¼€å‘å›¢é˜Ÿæ‹¥æœ‰ä¸€æ¬¾ â€œæ™ºèƒ½â€ çš„åå‘ä»£ç†æœåŠ¡ï¼Œä¸ºä»–ä»¬ç®€åŒ–æœåŠ¡é…ç½®ã€‚traefik å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œè¯ç”Ÿçš„ã€‚\nTraefik 2.2æ–°å¢çš„åŠŸèƒ½å¦‚ä¸‹ï¼š\n1. æ”¯æŒäº†udp\n2. traefik2.2 æ”¯æŒä½¿ç”¨K/Vå­˜å‚¨åšä¸ºåŠ¨æ€é…ç½®çš„æºï¼Œåˆ†åˆ«æ˜¯ consul, etcd, Redis, zookeeper\n3. èƒ½å¤Ÿä½¿ç”¨kubernetes CRDè‡ªå®šä¹‰èµ„æºå®šä¹‰UDPè´Ÿè½½å¹³è¡¡ IngressRouteUDPã€‚\n4. èƒ½å¤Ÿä½¿ç”¨ rancherï¼Œ consul catalogï¼Œ dockerå’Œ marathonä¸­çš„æ ‡ç­¾å®šä¹‰UDPçš„è´Ÿè½½å¹³è¡¡\n5. å¢åŠ äº†å¯¹ingressæ³¨è§£çš„ä¸»æŒ\n6. å°†TLSå­˜å‚¨åŠŸèƒ½ TLSStoresæ·»åŠ åˆ°Kubernetes CRDä¸­ï¼Œä½¿kubernetesç”¨æˆ·æ— éœ€ä½¿ç”¨é…ç½®æ–‡ä»¶å’Œå®‰è£…è¯ä¹¦å³å¯æä¾›é»˜è®¤è¯ä¹¦ã€‚\n7. åœ¨æ—¥å¿—ä¸­å¢åŠ äº†httpçš„è¯·æ±‚æ–¹å¼,æ˜¯httpè¿˜æ˜¯https\n8. å› ä¸ºTLSçš„é…ç½®å¯èƒ½ä¼šå½±å“CPUçš„ä½¿ç”¨ç‡ï¼Œå› æ­¤å¢åŠ äº† TLS versionå’Œ TLS cipherä½¿ç”¨çš„æŒ‡æ ‡ä¿¡æ¯\n9. å½“å‰çš„WRRç®—æ³•å¯¹äºæƒé‡ä¸å¹³è¡¡ç«¯ç‚¹å­˜åœ¨ä¸¥é‡çš„åå·®é—®é¢˜ï¼Œå°†EDFè°ƒåº¦ç®—æ³•ç”¨äºWeightedRoundRobinï¼Œ Envoyä¹Ÿæ˜¯ä½¿ç”¨äº† EOFè°ƒåº¦ç®—æ³•\n10. æ”¯æŒè¯·æ±‚ä¸»ä½“ç”¨äºæµé‡é•œåƒ\n11. å¢åŠ äº† ElasticAPMä½œä¸ºtraefikçš„tracingç³»ç»Ÿã€‚\n12. Traefikçš„Dashboardå¢åŠ äº†UDPçš„é¡µé¢\n13. Traefikä¹Ÿå¢åŠ äº†é»‘æš—ä¸»é¢˜\n2.éƒ¨ç½² Traefik 2.0 åœ¨ traefik v2.0 ç‰ˆæœ¬åï¼Œå¼€å§‹ä½¿ç”¨ CRDï¼ˆCustom Resource Definitionï¼‰æ¥å®Œæˆè·¯ç”±é…ç½®ç­‰ï¼Œæ‰€ä»¥éœ€è¦æå‰åˆ›å»º CRD èµ„æºã€‚\nä¸‹é¢è¿›è¡Œå®‰è£…è¿‡ç¨‹ã€‚\næ³¨ï¼šæˆ‘ä»¬è¿™é‡Œæ˜¯å°†traefikéƒ¨ç½²åœ¨ingress-traefikå‘½åç©ºé—´ï¼Œå¦‚æœä½ éœ€è¦éƒ¨ç½²åœ¨å…¶ä»–å‘½åç©ºé—´ï¼Œéœ€è¦æ›´æ”¹èµ„æºæ¸…å•ï¼Œå¦‚æœä½ æ˜¯éƒ¨ç½²åœ¨å’Œæˆ‘åŒæ ·çš„å‘½ä»¤ç©ºé—´ä¸­ï¼Œä½ éœ€è¦åˆ›å»ºè¯¥å‘½åç©ºé—´ã€‚\nåˆ›å»ºå‘½åç©ºé—´ï¼š\n1 kubectl create ns ingress-traefik åˆ›å»ºCRDèµ„æº\nTraefik 2.0ç‰ˆæœ¬åå¼€å§‹ä½¿ç”¨CRDæ¥å¯¹èµ„æºè¿›è¡Œç®¡ç†é…ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºCRDèµ„æºã€‚\ntraefik-crd.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 ## IngressRoute apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: ingressroutes.traefik.containo.us spec: scope: Namespaced group: traefik.containo.us version: v1alpha1 names: kind: IngressRoute plural: ingressroutes singular: ingressroute --- ## IngressRouteTCP apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: ingressroutetcps.traefik.containo.us spec: scope: Namespaced group: traefik.containo.us version: v1alpha1 names: kind: IngressRouteTCP plural: ingressroutetcps singular: ingressroutetcp --- ## Middleware apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: middlewares.traefik.containo.us spec: scope: Namespaced group: traefik.containo.us version: v1alpha1 names: kind: Middleware plural: middlewares singular: middleware --- apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: tlsoptions.traefik.containo.us spec: scope: Namespaced group: traefik.containo.us version: v1alpha1 names: kind: TLSOption plural: tlsoptions singular: tlsoption --- ## TraefikService apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: traefikservices.traefik.containo.us spec: scope: Namespaced group: traefik.containo.us version: v1alpha1 names: kind: TraefikService plural: traefikservices singular: traefikservice --- ## TraefikTLSStore apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: tlsstores.traefik.containo.us spec: scope: Namespaced group: traefik.containo.us version: v1alpha1 names: kind: TLSStore plural: tlsstores singular: tlsstore --- ## IngressRouteUDP apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: ingressrouteudps.traefik.containo.us spec: scope: Namespaced group: traefik.containo.us version: v1alpha1 names: kind: IngressRouteUDP plural: ingressrouteudps singular: ingressrouteudp éƒ¨ç½² CRD èµ„æº\n1 kubectl apply -f traefik-crd.yaml åˆ›å»º RBAC æƒé™\nKubernetes åœ¨ 1.6 ä»¥åçš„ç‰ˆæœ¬ä¸­å¼•å…¥äº†åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ç­–ç•¥ï¼Œæ–¹ä¾¿å¯¹ Kubernetes èµ„æºå’Œ API è¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚Traefik éœ€è¦ä¸€å®šçš„æƒé™ï¼Œæ‰€ä»¥è¿™é‡Œæå‰åˆ›å»ºå¥½ Traefik ServiceAccount å¹¶åˆ†é…ä¸€å®šçš„æƒé™ã€‚\ntraefik-rbac.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 apiVersion: v1 kind: ServiceAccount metadata: namespace: ingress-traefik name: traefik-ingress-controller --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: traefik-ingress-controller rules: - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;services\u0026#34;,\u0026#34;endpoints\u0026#34;,\u0026#34;secrets\u0026#34;] verbs: [\u0026#34;get\u0026#34;,\u0026#34;list\u0026#34;,\u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;extensions\u0026#34;] resources: [\u0026#34;ingresses\u0026#34;] verbs: [\u0026#34;get\u0026#34;,\u0026#34;list\u0026#34;,\u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;extensions\u0026#34;] resources: [\u0026#34;ingresses/status\u0026#34;] verbs: [\u0026#34;update\u0026#34;] - apiGroups: [\u0026#34;traefik.containo.us\u0026#34;] resources: [\u0026#34;middlewares\u0026#34;] verbs: [\u0026#34;get\u0026#34;,\u0026#34;list\u0026#34;,\u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;traefik.containo.us\u0026#34;] resources: [\u0026#34;ingressroutes\u0026#34;,\u0026#34;traefikservices\u0026#34;] verbs: [\u0026#34;get\u0026#34;,\u0026#34;list\u0026#34;,\u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;traefik.containo.us\u0026#34;] resources: [\u0026#34;ingressroutetcps\u0026#34;,\u0026#34;ingressrouteudps\u0026#34;] verbs: [\u0026#34;get\u0026#34;,\u0026#34;list\u0026#34;,\u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;traefik.containo.us\u0026#34;] resources: [\u0026#34;tlsoptions\u0026#34;,\u0026#34;tlsstores\u0026#34;] verbs: [\u0026#34;get\u0026#34;,\u0026#34;list\u0026#34;,\u0026#34;watch\u0026#34;] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: traefik-ingress-controller roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: traefik-ingress-controller subjects: - kind: ServiceAccount name: traefik-ingress-controller namespace: ingress-traefik éƒ¨ç½² Traefik RBAC èµ„æº\n1 kubectl apply -f traefik-rbac.yaml åˆ›å»º Traefik é…ç½®æ–‡ä»¶\nç”±äº Traefik é…ç½®å¾ˆå¤šï¼Œä½¿ç”¨ CLI å®šä¹‰æ“ä½œè¿‡äºç¹çï¼Œå°½é‡ä½¿ç”¨å°†å…¶é…ç½®é€‰é¡¹æ”¾åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œç„¶åå­˜å…¥ ConfigMapï¼Œå°†å…¶æŒ‚å…¥ traefik ä¸­ã€‚\ntraefik-config.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 kind: ConfigMap apiVersion: v1 metadata: name: traefik-config namespace: ingress-traefik data: traefik.yaml: |- serversTransport: insecureSkipVerify: true api: insecure: true dashboard: true debug: true metrics: prometheus: \u0026#34;\u0026#34; entryPoints: web: address: \u0026#34;:80\u0026#34; websecure: address: \u0026#34;:443\u0026#34; providers: kubernetesCRD: \u0026#34;\u0026#34; kubernetesingress: \u0026#34;\u0026#34; log: filePath: \u0026#34;\u0026#34; level: error format: json accessLog: filePath: \u0026#34;\u0026#34; format: json bufferingSize: 0 filters: retryAttempts: true minDuration: 20 fields: defaultMode: keep names: ClientUsername: drop headers: defaultMode: keep names: User-Agent: redact Authorization: drop Content-Type: keep éƒ¨ç½² Traefik ConfigMap èµ„æº\n1 kubectl apply -f traefik-config.yaml -n kube-system è®¾ç½®Labelæ ‡ç­¾\nç”±äºä½¿ç”¨çš„Kubernetes DeamonSetæ–¹å¼éƒ¨ç½²Traefikï¼Œæ‰€ä»¥éœ€è¦æå‰ç»™èŠ‚ç‚¹è®¾ç½®Labelï¼Œå½“ç¨‹åºéƒ¨ç½²Podä¼šè‡ªåŠ¨è°ƒåº¦åˆ°è®¾ç½® Labelçš„nodeèŠ‚ç‚¹ä¸Šã€‚\nèŠ‚ç‚¹è®¾ç½® Label æ ‡ç­¾ 1 kubectl label nodes k8s-node-1 IngressProxy=true éªŒè¯æ˜¯å¦æˆåŠŸ\n1 2 3 4 5 [root@k8s-master1 traefik]# kubectl get node --show-labels NAME STATUS ROLES AGE VERSION LABELS k8s-master Ready \u0026lt;none\u0026gt; 6d1h v1.18.3 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master,kubernetes.io/os=linux k8s-node1 Ready \u0026lt;none\u0026gt; 6d1h v1.18.3 IngressProxy=true,beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node1,kubernetes.io/os=linux k8s-node2 Ready \u0026lt;none\u0026gt; 6d v1.18.3 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,ingress=true,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node2,kubernetes.io/os=linux èŠ‚ç‚¹åˆ é™¤Labelæ ‡ç­¾\n1 kubectl label nodes k8s-node-1 IngressProxy- Kubernetes éƒ¨ç½² Traefik\næŒ‰ç…§ä»¥å‰Traefik1.7éƒ¨ç½²æ–¹å¼ï¼Œä½¿ç”¨DaemonSetç±»å‹éƒ¨ç½²ï¼Œä»¥ä¾¿äºåœ¨å¤šæœåŠ¡å™¨é—´æ‰©å±•ï¼Œä½¿ç”¨ hostport æ–¹å¼å ç”¨æœåŠ¡å™¨ 80ã€443 ç«¯å£ï¼Œæ–¹ä¾¿æµé‡è¿›å…¥ã€‚\ntraefik-deploy.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 apiVersion: v1 kind: Service metadata: name: traefik namespace: ingress-traefik spec: ports: - name: web port: 80 - name: websecure port: 443 - name: admin port: 8080 selector: app: traefik --- apiVersion: apps/v1 kind: DaemonSet metadata: name: traefik-ingress-controller namespace: ingress-traefik labels: app: traefik spec: selector: matchLabels: app: traefik template: metadata: name: traefik labels: app: traefik spec: serviceAccountName: traefik-ingress-controller terminationGracePeriodSeconds: 1 containers: - image: traefik:2.2.0 name: traefik-ingress-lb ports: - name: web containerPort: 80 hostPort: 80 #hostPortæ–¹å¼ï¼Œå°†ç«¯å£æš´éœ²åˆ°é›†ç¾¤èŠ‚ç‚¹ - name: websecure containerPort: 443 hostPort: 443 #hostPortæ–¹å¼ï¼Œå°†ç«¯å£æš´éœ²åˆ°é›†ç¾¤èŠ‚ç‚¹ - name: admin containerPort: 8080 resources: limits: cpu: 2000m memory: 1024Mi requests: cpu: 1000m memory: 1024Mi securityContext: capabilities: drop: - ALL add: - NET_BIND_SERVICE args: - --configfile=/config/traefik.yaml volumeMounts: - mountPath: \u0026#34;/config\u0026#34; name: \u0026#34;config\u0026#34; volumes: - name: config configMap: name: traefik-config tolerations: #è®¾ç½®å®¹å¿æ‰€æœ‰æ±¡ç‚¹ï¼Œé˜²æ­¢èŠ‚ç‚¹è¢«è®¾ç½®æ±¡ç‚¹ - operator: \u0026#34;Exists\u0026#34; nodeSelector: #è®¾ç½®nodeç­›é€‰å™¨ï¼Œåœ¨ç‰¹å®šlabelçš„èŠ‚ç‚¹ä¸Šå¯åŠ¨ IngressProxy: \u0026#34;true\u0026#34; éƒ¨ç½² Traefik\n1 kubectl apply -f traefik-deploy.yaml 3.Traefik è·¯ç”±è§„åˆ™åŸºç¡€é…ç½® é…ç½® HTTP è·¯ç”±è§„åˆ™ ï¼ˆTraefik Dashboard ä¸ºä¾‹ï¼‰\nTraefik åº”ç”¨å·²ç»éƒ¨ç½²å®Œæˆï¼Œä½†æ˜¯æƒ³è®©å¤–éƒ¨è®¿é—® Kubernetes å†…éƒ¨æœåŠ¡ï¼Œè¿˜éœ€è¦é…ç½®è·¯ç”±è§„åˆ™ï¼Œè¿™é‡Œå¼€å¯äº† Traefik Dashboard é…ç½®ï¼Œæ‰€ä»¥é¦–å…ˆé…ç½® Traefik Dashboard çœ‹æ¿çš„è·¯ç”±è§„åˆ™ï¼Œä½¿å¤–éƒ¨èƒ½å¤Ÿè®¿é—® Traefik Dashboardã€‚\ntraefik-dashboard-route.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: traefik-dashboard-route namespace: ingress-traefik spec: entryPoints: - web routes: - match: Host(`traefik.example.cn`) kind: Rule services: - name: traefik port: 8080 éƒ¨ç½²Traefik Dashboard è·¯ç”±è§„åˆ™å¯¹è±¡\n1 kubectl apply -f traefik-dashboard-route.yaml 1 2 æ¥ä¸‹æ¥é…ç½®dnsmasqï¼Œå®¢æˆ·ç«¯æƒ³é€šè¿‡åŸŸåè®¿é—®æœåŠ¡ï¼Œå¿…é¡»è¦è¿›è¡ŒDNSè§£æï¼Œæˆ‘ä½¿ç”¨çš„æœ¬åœ° DNS æœåŠ¡å™¨è¿›è¡ŒåŸŸåè§£æï¼Œå°† Traefik æŒ‡å®šèŠ‚ç‚¹çš„ IP å’Œè‡ªå®šä¹‰ åŸŸå ç»‘å®šï¼Œé‡å¯dnsmasqæœåŠ¡å³å¯ã€‚ æ‰“å¼€ä»»æ„æµè§ˆå™¨è¾“å…¥åœ°å€ï¼šhttp://traefik.example.cnè¿›è¡Œè®¿é—®ï¼Œæ­¤å¤„æ²¡æœ‰é…ç½®éªŒè¯ç™»å½•ï¼Œå¦‚æœæƒ³é…ç½®éªŒè¯ç™»å½•ï¼Œä½¿ç”¨middlewareå³å¯ã€‚ 4. é…ç½® HTTPS è·¯ç”±è§„åˆ™ï¼ˆKubernetes Dashboardï¼‰ è¿™é‡Œæˆ‘ä»¬åˆ›å»º Kubernetes çš„ Dashboardï¼Œå®ƒæ˜¯ åŸºäº Https åè®®æ–¹å¼è®¿é—®ï¼Œç”±äºå®ƒæ˜¯éœ€è¦ä½¿ç”¨ Https è¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é…ç½® Https çš„è·¯ç”±è§„åˆ™å¹¶æŒ‡å®šè¯ä¹¦ã€‚\næµ‹è¯•åŸŸåï¼škuboard.heian.comÂ ï¼ˆå†…ç½‘å»ºç«‹çš„ï¼‰\nåˆ›å»ºè¯ä¹¦æ–‡ä»¶\n1 2 3 4 5 # åˆ›å»ºè‡ªç­¾åè¯ä¹¦ openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \u0026#34;/CN=kuboard.heian.com\u0026#34; # å°†è¯ä¹¦å­˜å‚¨åˆ°Kubernetes Secretä¸­ï¼Œæ–°å»ºçš„k8dash-sa-tlså¿…é¡»ä¸k8dash-routeä¸­çš„tls: secretNameä¸€è‡´ã€‚ kubectl create secret tls k8dash-sa-tls --key=tls.key --cert=tls.crt -n kube-system k8dash-route.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: k8dash-sa-route namespace: kube-system spec: entryPoints: - websecure tls: secretName: k8dash-sa-tls routes: - match: Host(`kuboard.heian.com`) kind: Rule services: # æ­¤å¤„çš„servicesæ˜¯Kubernetesä¸­çš„svc name ä¸ ç«¯å£ å¯ä»¥ä½¿ç”¨kubectl get svc --namespace=kube-systemè·å– - name: kuboard port: 80 æ‰“å¼€ä»»æ„æµè§ˆå™¨è¾“å…¥åœ°å€ï¼šhttps://kuboard.heian.comè¿›è¡Œè®¿é—®Â ","date":"2021-03-29T17:15:18Z","image":"https://www.ownit.top/title_pic/29.jpg","permalink":"https://www.ownit.top/p/202103291715/","title":"Kubernetes 1.18.3 éƒ¨ç½² Traefik2.2"},{"content":"uberneteséƒ¨ç½²metrics-serveråæ‰§è¡Œkubectl top podæˆ–kubectl top nodeæŠ¥é”™\nError from server (ServiceUnavailable): the server is currently unable to handle the request (get pods.metrics.k8s.io)\nä¸€ã€é—®é¢˜æ£€æŸ¥æ­¥éª¤ï¼š\n1.1ã€æŸ¥çœ‹metrics-serveræœåŠ¡æ—¥å¿—\n1 Cluster doesn\u0026#39;t provide requestheader-client-ca-file in configmap/extension-apiserver-authentication in kube-system, so request-header client certificate authentication won\u0026#39;t work. æ£€æŸ¥å‘ç°æ˜¯ç”±äºè°ƒç”¨metrics-serveræ— æƒé™ï¼Œè¿”å›äº†http 403é”™è¯¯\n1.2ã€æ£€æŸ¥æ˜¯å¦é…ç½®äº†ä»¥ä¸‹å‚æ•°\n1 2 3 4 5 args: - --cert-dir=/tmp - --secure-port=4443 - --kubelet-insecure-tls=true - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,externalDNS 1.3ã€é—®é¢˜æ€»ç»“ï¼š\nmetrics-serveræœåŠ¡é…ç½®æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æœåŠ¡ä¾ç„¶æŠ¥é”™ Error from server (ServiceUnavailable): the server is currently unable to handle the request (get pods.metrics.k8s.io)ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è§£å†³é—®é¢˜\n1ã€æˆæƒé›†ç¾¤è§’è‰²ç»™ç”¨æˆ·system:anonymous\n1 kubectl create clusterrolebinding system:anonymous --clusterrole=cluster-admin --user=system:anonymous 2ã€åˆ›å»ºsystem:metrics-serverè§’è‰²å¹¶æˆæƒ\näºŒã€é—®é¢˜è§£å†³(åˆ›å»ºsystem:metrics-serverè§’è‰²å¹¶æˆæƒ)\né…ç½®metrics-serverè¯ä¹¦\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # vim metrics-server-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;system:metrics-server\u0026#34;, \u0026#34;hosts\u0026#34;: [], \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;BeiJing\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;BeiJing\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;k8s\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;system\u0026#34; } ] } 1 cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes metrics-server-csr.json | cfssljson -bare metrics-server é…ç½®metrics-serverÂ RBACæˆæƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 cat \u0026gt; auth-metrics-server.yaml \u0026lt;\u0026lt; EOF --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: system:auth-metrics-server-reader labels: rbac.authorization.k8s.io/aggregate-to-view: \u0026#34;true\u0026#34; rbac.authorization.k8s.io/aggregate-to-edit: \u0026#34;true\u0026#34; rbac.authorization.k8s.io/aggregate-to-admin: \u0026#34;true\u0026#34; rules: - apiGroups: [\u0026#34;metrics.k8s.io\u0026#34;] resources: [\u0026#34;pods\u0026#34;, \u0026#34;nodes\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: metrics-server:system:auth-metrics-server roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:auth-metrics-server-reader subjects: - kind: User name: system:metrics-server namespace: kube-system EOF kube-apiserveræ·»åŠ metrics-serveréœ€è¦çš„é…ç½®\n1 2 3 4 5 6 7 --requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\ --requestheader-allowed-names=aggregator,metrics-server \\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\ --requestheader-group-headers=X-Remote-Group \\ --requestheader-username-headers=X-Remote-User \\ --proxy-client-cert-file=/opt/kubernetes/ssl/metrics-server.pem \\ --proxy-client-key-file=/opt/kubernetes/ssl/metrics-server-key.pem æ£€æŸ¥æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è·å–åˆ°ç›‘æ§ä¿¡æ¯\n","date":"2021-03-23T19:16:02Z","image":"https://www.ownit.top/title_pic/04.jpg","permalink":"https://www.ownit.top/p/202103231916/","title":"äºŒè¿›åˆ¶éƒ¨ç½²Kuberneteså®‰è£…metrics-serveré‡åˆ°çš„é—®é¢˜"},{"content":"1ã€ä»€ä¹ˆæ˜¯ingress ngressï¼ˆåœ¨kubernetes v1.1æ—¶æ·»åŠ ï¼‰æš´éœ²ä»é›†ç¾¤å¤–åˆ°é›†ç¾¤å†…æœåŠ¡çš„HTTPæˆ–HTTPSè·¯ç”±ã€‚å®šä¹‰åœ¨ingressèµ„æºä¸Šçš„è§„åˆ™æ§åˆ¶æµé‡çš„è·¯ç”±ã€‚\n1 2 3 4 5 internet | [ Ingress ] --|-----|-- [ Services ] ä¸€ä¸ªingresså¯ä»¥é…ç½®ç”¨äºæä¾›å¤–éƒ¨å¯è®¿é—®çš„æœåŠ¡urlã€è´Ÿè½½å‡è¡¡æµé‡ã€SSLç»ˆç«¯å’Œæä¾›è™šæ‹Ÿä¸»æœºåé…ç½®ã€‚ingress controllerè´Ÿè´£å®ç°ï¼ˆé€šå¸¸ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨(loadbalancer)ï¼‰å…¥å£ï¼ˆingressï¼‰ã€‚ä½†æ˜¯å®ƒä¹Ÿå¯ä»¥é…ç½®ä½ çš„è¾¹ç¼˜è·¯ç”±å™¨æˆ–é¢å¤–çš„å‰ç«¯æ¥å¸®åŠ©å¤„ç†æµé‡ã€‚\ningressä¸æš´éœ²ä»»ä½•ç«¯å£æˆ–åè®®ã€‚å°†HTTPå’ŒHTTPSä¹‹å¤–çš„æœåŠ¡å…¬å¼€åˆ°å› ç‰¹ç½‘é€šå¸¸ä½¿ç”¨ç±»å‹æ˜¯NodePortæˆ–loadbalanceçš„serviceã€‚\n2ã€IngressåŒºåˆ« å·®åˆ«ï¼šhttps://github.com/nginxinc/kubernetes-ingress/blob/master/docs/nginx-ingress-controllers.md\nIngress-nginx Ingress-nginxï¼škuberneteså®˜æ–¹ç»´æŠ¤çš„ingress\nIngress-nginxçš„å®˜æ–¹æ–‡æ¡£ï¼šhttps://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#rewrite\nIngress-nginx Githubï¼šhttps://github.com/kubernetes/ingress-nginx\nNginx-ingress Nginx-ingressï¼šnginxå®˜æ–¹ç»´æŠ¤çš„ingress\nNginx-ingressçš„å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.nginx.com/nginx-ingress-controller/configuration/ingress-resources/advanced-configuration-with-annotations/\nNginx-ingress Githubï¼šhttps://github.com/nginxinc/kubernetes-ingress/blob/master/docs/nginx-ingress-controllers.md\nç±»ä¼¼çš„è¿˜æœ‰ï¼šTraefikã€HAProxyã€Istio\n3ã€Ingress-nginxéƒ¨ç½² ï¼ˆ1ï¼‰yamléƒ¨ç½²Ingress-nginx\nï¼ˆ2ï¼‰helméƒ¨ç½²Ingress-nginx\nIngress-nginxçš„é«˜çº§ä»‹ç»ï¼Œæˆ‘è¿™è¾¹ä»¥Kubernetesçš„é‚£ä¸ªæ’ä»¶ä¸ºä¸»ã€‚\n4ã€Ingress-nginxåˆ›å»ºæµç¨‹ ï¼ˆ1ï¼‰é¦–å…ˆåˆ›å»ºpod\nï¼ˆ2ï¼‰åˆ›å»ºservice\nï¼ˆ3ï¼‰åˆ›å»ºingress-nginx\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 kubectl create ns heian #åˆ›å»ºå‘½åç©ºé—´åï¼Œè¿è¡Œä¸‹é¢yamlï¼Œå°±å¯ä»¥å®ç°ä¸Šé¢ä¸‰ä¸ªæ­¥éª¤çš„å·¥ä½œ --- apiVersion: apps/v1 kind: Deployment metadata: namespace: heian name: ingress-heian annotations: k8s.kuboard.cn/workload: ingress-heian deployment.kubernetes.io/revision: \u0026#39;1\u0026#39; k8s.kuboard.cn/service: ClusterIP k8s.kuboard.cn/ingress: \u0026#39;true\u0026#39; labels: app: ingress-heian spec: selector: matchLabels: app: ingress-heian revisionHistoryLimit: 10 template: metadata: labels: app: ingress-heian spec: affinity: {} securityContext: seLinuxOptions: {} imagePullSecrets: [] restartPolicy: Always initContainers: [] containers: - image: \u0026#39;wangyanglinux/myapp:v1\u0026#39; imagePullPolicy: IfNotPresent name: ingress-heian volumeMounts: - name: tz-config mountPath: /usr/share/zoneinfo/Asia/Shanghai - name: tz-config mountPath: /etc/localtime - name: timezone mountPath: /etc/timezone resources: limits: cpu: 100m memory: 100Mi requests: cpu: 10m memory: 10Mi env: - name: TZ value: Asia/Shanghai - name: LANG value: C.UTF-8 lifecycle: {} ports: - name: web containerPort: 80 protocol: TCP terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumes: - name: tz-config hostPath: path: /usr/share/zoneinfo/Asia/Shanghai type: \u0026#39;\u0026#39; - name: timezone hostPath: path: /etc/timezone type: \u0026#39;\u0026#39; dnsPolicy: ClusterFirst dnsConfig: options: [] schedulerName: default-scheduler terminationGracePeriodSeconds: 30 progressDeadlineSeconds: 600 strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 0 maxSurge: 1 replicas: 1 --- apiVersion: v1 kind: Service metadata: namespace: heian name: ingress-heian annotations: k8s.kuboard.cn/workload: ingress-heian labels: app: ingress-heian spec: selector: app: ingress-heian type: ClusterIP ports: - port: 80 targetPort: 80 protocol: TCP name: ingress-web-1 nodePort: 0 sessionAffinity: None --- apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: namespace: heian name: ingress-heian annotations: k8s.kuboard.cn/workload: ingress-heian labels: app: ingress-heian spec: rules: - host: ingress.heian.com http: paths: - path: / backend: serviceName: ingress-heian servicePort: 80 æ•ˆæœæˆªå›¾ï¼š\n5ã€Ingress-nginxçš„åŸŸåé‡å®šå‘ï¼ˆRedirectï¼‰ annotationså£°æ˜\n1 2 3 #é‡å®šå‘ï¼Œå°±æ˜¯è¿™ä¸€å¥ ï¼Œç°åœ¨è®¿é—®è¿™ä¸ªåŸŸåï¼Œä¼šé‡å®šå‘åˆ°æˆ‘çš„åšå®¢åœ°å€ annotations: nginx.ingress.kubernetes.io/permanent-redirect: \u0026#39;https://blog.csdn.net/heian_99\u0026#39; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 --- apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: annotations: nginx.ingress.kubernetes.io/permanent-redirect: \u0026#39;https://blog.csdn.net/heian_99\u0026#39; name: ingress-heian namespace: heian spec: rules: - host: ingress.heian.com http: paths: - backend: serviceName: ingress-heian servicePort: 80 path: / pathType: ImplementationSpecific è¿™ä¸ªæ˜¯ingress-nginxé‡Œé¢nginxçš„é…ç½®\n6ã€Ingress-nginxçš„å‰åç«¯åˆ†ç¦»ï¼ˆRewriteï¼‰ 1 2 annotations: nginx.ingress.kubernetes.io/rewrite-target: /$2 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 --- apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: annotations: nginx.ingress.kubernetes.io/rewrite-target: /$2 name: ingress-heian namespace: heian spec: rules: - host: ingress.heian.com http: paths: - backend: serviceName: ingress-heian servicePort: 80 path: /something(/|$)(.*) pathType: ImplementationSpecific 7ã€Ingress-nginxçš„SSLé…ç½® å®˜ç½‘ï¼šhttps://kubernetes.github.io/ingress-nginx/user-guide/tls/\nåˆ›å»ºè‡ªå»ºè¯ä¹¦ï¼ˆä¸»ï¼šæµè§ˆå™¨ä¸è®¤å¯çš„ï¼‰\nIngress-nginxé…ç½®äº†SSLï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ°httpsçš„ç½‘é¡µçš„\n1 2 3 openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.cert -subj \u0026#34;/CN=ingress.heian.com/O=ingress.heian.com\u0026#34; kubectl create secret tls ca-ceart --key tls.key --cert tls.cert -n heian 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 --- apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: annotations: nginx.ingress.kubernetes.io/rewrite-target: /$2 name: ingress-heian namespace: heian spec: rules: - host: ingress.heian.com http: paths: - backend: serviceName: ingress-heian servicePort: 80 path: /something(/|$)(.*) pathType: ImplementationSpecific tls: - hosts: - ingress.heian.com secretName: ca-ceart 1 2 3 4 tls: - hosts: - ingress.heian.com secretName: ca-ceart ç¦ç”¨httpså¼ºåˆ¶è·³è½¬\n1 2 annotations: nginx.ingress.kubernetes.io/ssl-redirect: \u0026#34;false\u0026#34; è®¾ç½®é»˜è®¤è¯ä¹¦ï¼š--default-ssl-certificate=default/foo-tls\næ›´æ”¹çš„ingress-controllerçš„å¯åŠ¨å‚æ•°\n8ã€Ingress-nginxçš„é»‘ç™½åå• Annotationsï¼šåªå¯¹æŒ‡å®šçš„ingressç”Ÿæ•ˆ\nConfigMapï¼šå…¨å±€ç”Ÿæ•ˆ\né»‘åå•å¯ä»¥ä½¿ç”¨ConfigMapå»é…ç½®ï¼Œç™½åå•å»ºè®®ä½¿ç”¨Annotationså»é…ç½®ã€‚\nï¼ˆ1ï¼‰ã€ç™½åå• æ·»åŠ ç™½åå•çš„æ–¹å¼å¯ä»¥ç›´æ¥å†™annotationï¼Œä¹Ÿå¯ä»¥é…ç½®åœ¨ConfigMapä¸­ã€‚ å†™åœ¨annotationä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 --- apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: annotations: nginx.ingress.kubernetes.io/whitelist-source-range: 192.168.0.100 name: ingress-heian namespace: heian spec: rules: - host: ingress.heian.com http: paths: - backend: serviceName: ingress-heian servicePort: 80 path: / pathType: ImplementationSpecific ä¹Ÿå¯ä»¥å†™å›ºå®šIPï¼Œä¹Ÿå¯ä»¥å†™ç½‘æ®µã€‚ é…ç½®åˆ°ConfigMapä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: ConfigMap metadata: labels: helm.sh/chart: ingress-nginx-2.1.0 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 0.32.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginx data: whitelist-source-range: 10.1.10.0/24 ï¼ˆ2ï¼‰ã€é»‘åå• é»‘åå•å°±åªèƒ½é€šè¿‡ConfigMapæ¥é…ç½® ConfigMapé…ç½®å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 apiVersion: v1 kind: ConfigMap metadata: labels: helm.sh/chart: ingress-nginx-2.1.0 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 0.32.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginx data: whitelist-source-range: 10.1.10.0/24 block-cidrs: 10.1.10.100 annotationé…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 --- apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/server-snippet: |- deny 192.168.0.1; deny 192.168.0.100; allow all; creationTimestamp: null name: ingress-heian spec: rules: - host: ingress.heian.com http: paths: - backend: serviceName: ingress-heian servicePort: 80 path: / pathType: ImplementationSpecific status: loadBalancer: {} 9ã€Ingress-nginxçš„åŒ¹é…è¯·æ±‚å¤´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 --- apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/server-snippet: |- set $agentflag 0; if ($http_user_agent ~* \u0026#34;(iPhone)\u0026#34; ){ set $agentflag 1; } if ( $agentflag = 1 ) { return 301 https://m.heian.com; } creationTimestamp: null name: ingress-heian spec: rules: - host: ingress.heian.com http: paths: - backend: serviceName: ingress-heian servicePort: 80 path: / pathType: ImplementationSpecific status: loadBalancer: {} 10ã€Ingress-nginxçš„é€Ÿç‡é™åˆ¶ 1 2 3 4 5 6 7 8 9 10 é™é€ŸÂ¶ è¿™äº›æ³¨é‡Šå®šä¹‰äº†å¯¹è¿æ¥å’Œä¼ è¾“é€Ÿç‡çš„é™åˆ¶ã€‚è¿™äº›å¯ä»¥ç”¨æ¥å‡è½»DDoSæ”»å‡»ã€‚ nginx.ingress.kubernetes.io/limit-connectionsï¼šå•ä¸ªIPåœ°å€å…è®¸çš„å¹¶å‘è¿æ¥æ•°ã€‚è¶…å‡ºæ­¤é™åˆ¶æ—¶ï¼Œå°†è¿”å›503é”™è¯¯ã€‚ nginx.ingress.kubernetes.io/limit-rpsï¼šæ¯ç§’ä»ç»™å®šIPæ¥å—çš„è¯·æ±‚æ•°ã€‚çªå‘é™åˆ¶è®¾ç½®ä¸ºæ­¤é™åˆ¶ä¹˜ä»¥çªå‘ä¹˜æ•°ï¼Œé»˜è®¤ä¹˜æ•°ä¸º5ã€‚å½“å®¢æˆ·ç«¯è¶…è¿‡æ­¤é™åˆ¶æ—¶ï¼Œå°† è¿”å›limit-req-status-codeé»˜è®¤å€¼ï¼š 503ã€‚ nginx.ingress.kubernetes.io/limit-rpmï¼šæ¯åˆ†é’Ÿä»ç»™å®šIPæ¥å—çš„è¯·æ±‚æ•°ã€‚çªå‘é™åˆ¶è®¾ç½®ä¸ºæ­¤é™åˆ¶ä¹˜ä»¥çªå‘ä¹˜æ•°ï¼Œé»˜è®¤ä¹˜æ•°ä¸º5ã€‚å½“å®¢æˆ·ç«¯è¶…è¿‡æ­¤é™åˆ¶æ—¶ï¼Œå°† è¿”å›limit-req-status-codeé»˜è®¤å€¼ï¼š 503ã€‚ nginx.ingress.kubernetes.io/limit-burst-multiplierï¼šçªå‘å¤§å°é™åˆ¶é€Ÿç‡çš„å€æ•°ã€‚é»˜è®¤çš„è„‰å†²ä¸²ä¹˜æ•°ä¸º5ï¼Œæ­¤æ³¨é‡Šå°†è¦†ç›–é»˜è®¤çš„ä¹˜æ•°ã€‚å½“å®¢æˆ·ç«¯è¶…è¿‡æ­¤é™åˆ¶æ—¶ï¼Œå°† è¿”å›limit-req-status-codeé»˜è®¤å€¼ï¼š 503ã€‚ nginx.ingress.kubernetes.io/limit-rate-afterï¼šæœ€åˆçš„åƒå­—èŠ‚æ•°ï¼Œåœ¨æ­¤ä¹‹åï¼Œå¯¹ç»™å®šè¿æ¥çš„å“åº”çš„è¿›ä¸€æ­¥ä¼ è¾“å°†å—åˆ°é€Ÿç‡çš„é™åˆ¶ã€‚å¿…é¡»åœ¨å¯ç”¨ä»£ç†ç¼“å†²çš„æƒ…å†µä¸‹ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚ nginx.ingress.kubernetes.io/limit-rateï¼šæ¯ç§’å…è®¸å‘é€åˆ°ç»™å®šè¿æ¥çš„åƒå­—èŠ‚æ•°ã€‚é›¶å€¼ç¦ç”¨é€Ÿç‡é™åˆ¶ã€‚å¿…é¡»åœ¨å¯ç”¨ä»£ç†ç¼“å†²çš„æƒ…å†µä¸‹ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚ nginx.ingress.kubernetes.io/limit-whitelistï¼šå®¢æˆ·ç«¯IPæºèŒƒå›´è¦ä»é€Ÿç‡é™åˆ¶ä¸­æ’é™¤ã€‚è¯¥å€¼æ˜¯é€—å·åˆ†éš”çš„CIDRåˆ—è¡¨ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: name: ingress-nginx annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; nginx.ingress.kubernetes.io/limit-rate: 100K nginx.ingress.kubernetes.io/limit-whitelist: 10.1.10.100 nginx.ingress.kubernetes.io/limit-rps: 1 nginx.ingress.kubernetes.io/limit-rpm: 30 spec: rules: - host: iphone.coolops.cn http: paths: - path: backend: serviceName: ng-svc servicePort: 80 nginx.ingress.kubernetes.io/limit-rateï¼šé™åˆ¶å®¢æˆ·ç«¯æ¯ç§’ä¼ è¾“çš„å­—èŠ‚æ•° nginx.ingress.kubernetes.io/limit-whitelistï¼šç™½åå•ä¸­çš„IPä¸é™é€Ÿ nginx.ingress.kubernetes.io/limit-rpsï¼šå•ä¸ªIPæ¯ç§’çš„è¿æ¥æ•° nginx.ingress.kubernetes.io/limit-rpmï¼šå•ä¸ªIPæ¯åˆ†é’Ÿçš„è¿æ¥æ•° 11ã€Ingress-nginxçš„åŸºæœ¬è®¤è¯ æœ‰äº›è®¿é—®æ˜¯éœ€è¦è®¤è¯è®¿é—®çš„ï¼Œæ¯”å¦‚dubbo-adminï¼Œæˆ‘ä»¬åœ¨è®¿é—®çš„æ—¶å€™ä¼šå…ˆå«ä½ è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚ingress nginxä¹Ÿå¯ä»¥å®ç°è¿™ç§ã€‚\nï¼ˆ1ï¼‰ã€åˆ›å»ºå¯†ç ï¼Œæˆ‘è¿™é‡Œç”¨httpçš„å‘½ä»¤å·¥å…·æ¥ç”Ÿæˆ 1 2 3 4 5 6 7 8 9 [root@k8s-master01 ingress]# htpasswd -c auth heian New password: Re-type new password: Adding password for user heian [root@k8s-master01 ingress]# ls auth tls.cert tls.key [root@k8s-master01 ingress]# cat auth heian:$apr1$8LffOJL7$ZIGV4XRNSuginqO5GMxAZ. [root@k8s-master01 ingress]# ï¼ˆ2ï¼‰ã€åˆ›å»ºsecret 1 2 [root@k8s-master01 ingress]# kubectl create secret generic basic-auth --from-file=auth -n heian secret/basic-auth created ï¼ˆ3ï¼‰ã€é…ç½®Ingress 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 --- apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/auth-realm: Need to longin nginx.ingress.kubernetes.io/auth-secret: basic-auth nginx.ingress.kubernetes.io/auth-type: basic creationTimestamp: null name: ingress-heian spec: rules: - host: ingress.heian.com http: paths: - backend: serviceName: ingress-heian servicePort: 80 path: / pathType: ImplementationSpecific status: loadBalancer: {} 12ã€Ingress-nginxå®ç°ç°åº¦é‡‘ä¸é›€å‘å¸ƒ Nginx Annotations æ”¯æŒä»¥ä¸‹ 4 ç§ Canary è§„åˆ™ï¼š\nnginx.ingress.kubernetes.io/canary-by-headerï¼šåŸºäº Request Header çš„æµé‡åˆ‡åˆ†ï¼Œé€‚ç”¨äºç°åº¦å‘å¸ƒä»¥åŠ A/B æµ‹è¯•ã€‚å½“ Request Header è®¾ç½®ä¸º alwaysæ—¶ï¼Œè¯·æ±‚å°†ä¼šè¢«ä¸€ç›´å‘é€åˆ° Canary ç‰ˆæœ¬ï¼›å½“ Request Header è®¾ç½®ä¸º neveræ—¶ï¼Œè¯·æ±‚ä¸ä¼šè¢«å‘é€åˆ° Canary å…¥å£ï¼›å¯¹äºä»»ä½•å…¶ä»– Header å€¼ï¼Œå°†å¿½ç•¥ Headerï¼Œå¹¶é€šè¿‡ä¼˜å…ˆçº§å°†è¯·æ±‚ä¸å…¶ä»–é‡‘ä¸é›€è§„åˆ™è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒã€‚ nginx.ingress.kubernetes.io/canary-by-header-valueï¼šè¦åŒ¹é…çš„ Request Header çš„å€¼ï¼Œç”¨äºé€šçŸ¥ Ingress å°†è¯·æ±‚è·¯ç”±åˆ° Canary Ingress ä¸­æŒ‡å®šçš„æœåŠ¡ã€‚å½“ Request Header è®¾ç½®ä¸ºæ­¤å€¼æ—¶ï¼Œå®ƒå°†è¢«è·¯ç”±åˆ° Canary å…¥å£ã€‚è¯¥è§„åˆ™å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ Request Header çš„å€¼ï¼Œå¿…é¡»ä¸ä¸Šä¸€ä¸ª annotation (å³ï¼šcanary-by-headerï¼‰ä¸€èµ·ä½¿ç”¨ã€‚ nginx.ingress.kubernetes.io/canary-weightï¼šåŸºäºæœåŠ¡æƒé‡çš„æµé‡åˆ‡åˆ†ï¼Œé€‚ç”¨äºè“ç»¿éƒ¨ç½²ï¼Œæƒé‡èŒƒå›´ 0 - 100 æŒ‰ç™¾åˆ†æ¯”å°†è¯·æ±‚è·¯ç”±åˆ° Canary Ingress ä¸­æŒ‡å®šçš„æœåŠ¡ã€‚æƒé‡ä¸º 0 æ„å‘³ç€è¯¥é‡‘ä¸é›€è§„åˆ™ä¸ä¼šå‘ Canary å…¥å£çš„æœåŠ¡å‘é€ä»»ä½•è¯·æ±‚ã€‚æƒé‡ä¸º 100 æ„å‘³ç€æ‰€æœ‰è¯·æ±‚éƒ½å°†è¢«å‘é€åˆ° Canary å…¥å£ã€‚ nginx.ingress.kubernetes.io/canary-by-cookieï¼šåŸºäº Cookie çš„æµé‡åˆ‡åˆ†ï¼Œé€‚ç”¨äºç°åº¦å‘å¸ƒä¸ A/B æµ‹è¯•ã€‚ç”¨äºé€šçŸ¥ Ingress å°†è¯·æ±‚è·¯ç”±åˆ° Canary Ingress ä¸­æŒ‡å®šçš„æœåŠ¡çš„cookieã€‚å½“ cookie å€¼è®¾ç½®ä¸º alwaysæ—¶ï¼Œå®ƒå°†è¢«è·¯ç”±åˆ° Canary å…¥å£ï¼›å½“ cookie å€¼è®¾ç½®ä¸º neveræ—¶ï¼Œè¯·æ±‚ä¸ä¼šè¢«å‘é€åˆ° Canary å…¥å£ï¼›å¯¹äºä»»ä½•å…¶ä»–å€¼ï¼Œå°†å¿½ç•¥ cookie å¹¶å°†è¯·æ±‚ä¸å…¶ä»–é‡‘ä¸é›€è§„åˆ™è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒã€‚ å®šä¹‰ä¸¤ä¸ªç‰ˆæœ¬çš„ä»£ç ã€‚ åˆ›å»ºä¸¤ä¸ªåŒåŸŸåçš„ingress\nv2ç‰ˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: annotations: nginx.ingress.kubernetes.io/canary: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/canary-by-header: heian nginx.ingress.kubernetes.io/canary-by-header-value: v2 nginx.ingress.kubernetes.io/canary-weight: \u0026#34;50\u0026#34; name: ingress-heian2 namespace: heian spec: rules: - host: ingress.heian.com http: paths: - backend: serviceName: ingress-heian2 servicePort: 80 path: / pathType: ImplementationSpecific 13ã€Ingress-nginxè‡ªå®šä¹‰é”™è¯¯é¡µé¢ githubåœ°å€ï¼šhttps://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/customization/custom-errors/custom-default-backend.yaml\n1 kubectl apply -f error.yaml -n heian ä¿®æ”¹dsé…ç½®æ–‡ä»¶ï¼Œæ·»åŠ è¿™ä¸ª\n1 - --default-backend-service=heian/nginx-errors éªŒè¯\næ‰§è¡ŒÂ kubectl get pod \\-n ingress-nginxÂ æŸ¥çœ‹podæ˜¯å¦å·²ç»é‡å¯è¿‡ï¼Œ å¦‚æœæ²¡æœ‰è‡ªåŠ¨é‡å¯ï¼Œéœ€è¦æ€æ‰podã€‚\næ‰“å¼€ä¸€ä¸ªä¸å­˜åœ¨çš„é“¾æ¥ï¼Œ æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤ºçš„æ˜¯å®šä¹‰çš„é”™è¯¯é¡µé¢ã€‚\néƒ¨åˆ†æµè§ˆå™¨ä¸æ”¯æŒé¡µé¢æ˜¾ç¤ºï¼Œå¦‚è°·æ­Œæµè§ˆå™¨ä¼šæ˜¾ç¤ºâ€œæ— æ³•æ˜¾ç¤ºæ­¤ç½‘ç«™â€\n","date":"2021-03-20T17:38:51Z","image":"https://www.ownit.top/title_pic/18.jpg","permalink":"https://www.ownit.top/p/202103201738/","title":"Kubernetes Ingress-nginxé«˜çº§ç”¨æ³•"},{"content":"prometheusé»‘ç›’æµ‹è¯• è¿™æ¬¡ä½¿ç”¨åŸºäºé»‘ç›’æµ‹è¯•ä¸Šé¢ã€‚ç”¨æ¥æ”¶é›†ç›‘æ§blackboxçš„æ•°æ®\nhttps://github.com/prometheus/blackbox_exporter\nhttps://github.com/prometheus/blackbox_exporter/blob/master/blackbox.yml\nhttps://grafana.com/grafana/dashboards/5345\n1ã€åˆ›å»ºsecrets å®˜ç½‘åœ°å€ï¼šhttps://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/additional-scrape-config.md\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 cat prometheus-additional.yaml - job_name: \u0026#39;blackbox\u0026#39; metrics_path: /probe params: module: [http_2xx] # Look for a HTTP 200 response. static_configs: - targets: - http://www.baidu.com\t# è¿™é‡Œæˆ‘ä»¬ç›‘æ§ç™¾åº¦ç½‘ç«™æµ‹è¯• relabel_configs: - source_labels: [__address__] target_label: __param_target - source_labels: [__param_target] target_label: instance - target_label: __address__ replacement: blackbox-exporter:9115 # The blackbox exporter\u0026#39;s real hostname:port. 1 2 3 kubectl create secret generic additional-scrape-configs --from-file=prometheus-additional.yaml --dry-run -oyaml \u0026gt; additional-scrape-configs.yaml kubectl apply -f additional-scrape-configs.yaml -n monitoring 2ã€ä¿®æ”¹Prometheusçš„CRD 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 [root@k8s-master01 manifests]# vim prometheus-prometheus.yaml apiVersion: monitoring.coreos.com/v1 kind: Prometheus metadata: labels: prometheus: k8s spec: alerting: alertmanagers: - name: alertmanager-main namespace: monitoring port: web image: quay.io/prometheus/prometheus:v2.15.2 nodeSelector: kubernetes.io/os: linux podMonitorNamespaceSelector: {} podMonitorSelector: {} replicas: 1 resources: requests: memory: 700Mi ruleSelector: matchLabels: prometheus: k8s role: alert-rules securityContext: fsGroup: 2000 runAsNonRoot: true runAsUser: 1000 serviceAccountName: prometheus-k8s serviceMonitorNamespaceSelector: {} serviceMonitorSelector: {} version: v2.15.2 additionalScrapeConfigs: name: additional-scrape-configs key: prometheus-additional.yaml [root@k8s-master01 manifests]# kubectl replace -f prometheus-prometheus.yaml prometheus.monitoring.coreos.com/k8s replaced 3ã€Prometheusæµ‹è¯•éªŒè¯ ","date":"2021-03-18T22:21:16Z","image":"https://www.ownit.top/title_pic/43.jpg","permalink":"https://www.ownit.top/p/202103182221/","title":"Prometheus_additionalä¼ ç»Ÿé…ç½®"},{"content":"ç™½ç›’ç›‘æ§ï¼šç›‘æ§ä¸€äº›å†…éƒ¨çš„æ•°æ®ï¼Œtopicçš„ç›‘æ§æ•°æ®ï¼ŒRedis keyçš„å¤§å°ã€‚å†…éƒ¨æš´éœ²çš„æŒ‡æ ‡è¢«ç§°ä¸ºç™½ç›’ç›‘æ§ã€‚æ¯”è¾ƒå…³æ³¨çš„æ˜¯åŸå› ã€‚\né»‘ç›’ç›‘æ§ï¼šç«™åœ¨ç”¨æˆ·çš„è§’åº¦çœ‹åˆ°çš„ä¸œè¥¿ã€‚ç½‘ç«™ä¸èƒ½æ‰“å¼€ï¼Œç½‘ç«™æ‰“å¼€çš„æ¯”è¾ƒæ…¢ã€‚æ¯”è¾ƒå…³æ³¨ç°è±¡ï¼Œè¡¨ç¤ºæ­£åœ¨å‘ç”Ÿçš„é—®é¢˜ï¼Œæ­£åœ¨å‘ç”Ÿçš„å‘Šè­¦ã€‚\ngithubæ–‡æ¡£ï¼šhttps://github.com/prometheus/blackbox_exporter\nå…³äºéƒ¨ç½²ï¼Œå·²ç»åšæˆyamlæ ¼å¼ï¼Œä¸€é”®éƒ¨ç½²ä¸Šå»å°±å¯ä»¥äº†\nåˆ›å»ºcomfingmapÂ -\u0026ndash;ã€‹ æŒ‚è½½åˆ°deploymentsÂ --ã€‹æš´éœ²serviceæœåŠ¡ä½¿ç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 [root@k8s-master01 config]# cat exe.yaml apiVersion: apps/v1 kind: Deployment metadata: labels: app: blackbox-exporter name: blackbox-exporter namespace: monitoring spec: progressDeadlineSeconds: 600 replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: app: blackbox-exporter strategy: rollingUpdate: maxSurge: 1 maxUnavailable: 0 type: RollingUpdate template: metadata: creationTimestamp: null labels: app: blackbox-exporter spec: containers: - args: - --config.file=/mnt/blackbox.yml env: - name: TZ value: Asia/Shanghai - name: LANG value: C.UTF-8 image: prom/blackbox-exporter:master imagePullPolicy: IfNotPresent lifecycle: {} name: blackbox-exporter ports: - containerPort: 9115 name: web protocol: TCP resources: limits: cpu: 324m memory: 443Mi requests: cpu: 10m memory: 10Mi securityContext: allowPrivilegeEscalation: false privileged: false readOnlyRootFilesystem: false runAsNonRoot: false terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumeMounts: - mountPath: /usr/share/zoneinfo/Asia/Shanghai name: tz-config - mountPath: /etc/localtime name: tz-config - mountPath: /etc/timezone name: timezone - mountPath: /mnt name: config dnsPolicy: ClusterFirst restartPolicy: Always schedulerName: default-scheduler securityContext: {} terminationGracePeriodSeconds: 30 volumes: - hostPath: path: /usr/share/zoneinfo/Asia/Shanghai type: \u0026#34;\u0026#34; name: tz-config - hostPath: path: /etc/timezone type: \u0026#34;\u0026#34; name: timezone - configMap: defaultMode: 420 name: blackbox-conf name: config --- apiVersion: v1 data: blackbox.yml: |- modules: http_2xx: prober: http http_post_2xx: prober: http http: method: POST tcp_connect: prober: tcp pop3s_banner: prober: tcp tcp: query_response: - expect: \u0026#34;^+OK\u0026#34; tls: true tls_config: insecure_skip_verify: false ssh_banner: prober: tcp tcp: query_response: - expect: \u0026#34;^SSH-2.0-\u0026#34; irc_banner: prober: tcp tcp: query_response: - send: \u0026#34;NICK prober\u0026#34; - send: \u0026#34;USER prober prober prober :prober\u0026#34; - expect: \u0026#34;PING :([^ ]+)\u0026#34; send: \u0026#34;PONG ${1}\u0026#34; - expect: \u0026#34;^:[^ ]+ 001\u0026#34; icmp: prober: icmp kind: ConfigMap metadata: name: blackbox-conf namespace: monitoring --- apiVersion: v1 kind: Service metadata: labels: app: blackbox-exporter name: blackbox-exporter namespace: monitoring spec: ports: - name: container-1-web-1 port: 9115 protocol: TCP targetPort: 9115 selector: app: blackbox-exporter sessionAffinity: None type: ClusterIP æµ‹è¯•éªŒè¯\n1 curl http://10.96.203.216:9115/probe?target=www.baidu.com\u0026amp;module=http_2xx 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 [root@k8s-master01 config]# curl http://10.96.203.216:9115/probe?target=www.baidu.com\u0026amp;module=http_2xx [1] 4221 #è·å–baidu.comçš„ç›¸å…³ä¿¡æ¯ [root@k8s-master01 config]# # HELP probe_dns_lookup_time_seconds Returns the time taken for probe dns lookup in seconds # TYPE probe_dns_lookup_time_seconds gauge probe_dns_lookup_time_seconds 0.338946599 # HELP probe_duration_seconds Returns how long the probe took to complete in seconds # TYPE probe_duration_seconds gauge probe_duration_seconds 0.682111152 # HELP probe_failed_due_to_regex Indicates if probe failed due to regex # TYPE probe_failed_due_to_regex gauge probe_failed_due_to_regex 0 # HELP probe_http_content_length Length of http content response # TYPE probe_http_content_length gauge probe_http_content_length -1 # HELP probe_http_duration_seconds Duration of http request by phase, summed over all redirects # TYPE probe_http_duration_seconds gauge probe_http_duration_seconds{phase=\u0026#34;connect\u0026#34;} 0.00913168 probe_http_duration_seconds{phase=\u0026#34;processing\u0026#34;} 0.008949937 probe_http_duration_seconds{phase=\u0026#34;resolve\u0026#34;} 0.338946599 probe_http_duration_seconds{phase=\u0026#34;tls\u0026#34;} 0 probe_http_duration_seconds{phase=\u0026#34;transfer\u0026#34;} 0.324605594 # HELP probe_http_redirects The number of redirects # TYPE probe_http_redirects gauge probe_http_redirects 0 # HELP probe_http_ssl Indicates if SSL was used for the final redirect # TYPE probe_http_ssl gauge probe_http_ssl 0 # HELP probe_http_status_code Response HTTP status code # TYPE probe_http_status_code gauge probe_http_status_code 200 # HELP probe_http_uncompressed_body_length Length of uncompressed response body # TYPE probe_http_uncompressed_body_length gauge probe_http_uncompressed_body_length 297140 # HELP probe_http_version Returns the version of HTTP of the probe response # TYPE probe_http_version gauge probe_http_version 1.1 # HELP probe_ip_addr_hash Specifies the hash of IP address. It\u0026#39;s useful to detect if the IP address changes. # TYPE probe_ip_addr_hash gauge probe_ip_addr_hash 2.882632397e+09 # HELP probe_ip_protocol Specifies whether probe ip protocol is IP4 or IP6 # TYPE probe_ip_protocol gauge probe_ip_protocol 4 # HELP probe_success Displays whether or not the probe was a success # TYPE probe_success gauge probe_success 1 ","date":"2021-03-18T18:01:08Z","image":"https://www.ownit.top/title_pic/45.jpg","permalink":"https://www.ownit.top/p/202103181801/","title":"prometheusé»‘ç›’æµ‹è¯•"},{"content":"æˆ‘å‰é¢ä½¿ç”¨Kubernetesæ„å»ºprometheusç›‘æ§ï¼Œæ²¡æœ‰ä»€ä¹ˆå¤§é—®é¢˜ï¼Œä½†æ˜¯monitoring/kube-controller-manager/0 (0/0 up)ï¼Œè¿™ä¸ªæ²¡æœ‰æ•°å€¼ã€‚\nä¸€èˆ¬å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œéƒ½æ˜¯Kuberneteséƒ¨ç½²æ—¶ï¼Œæ²¡æœ‰å¯¹åº”çš„æ ‡ç­¾ï¼Œå¯¼è‡´æ— æ³•æ‰¾åˆ°èµ„æº\né—®é¢˜ é—®é¢˜ä¸€ï¼šipåœ°å€ æ­£å¸¸å¼€å¯çš„ï¼Œä½†æ˜¯è¿™ä¸ªç›‘å¬ç«¯å£æ˜¯127.0.0.1çš„ï¼Œæ™®ç½—ç±³ä¿®æ–¯æ— æ³•ç›´æ¥è®¿é—®\n1 2 3 [root@k8s-master01 jiankong]# netstat -lntp | grep control tcp 0 0 127.0.0.1:10257 0.0.0.0:* LISTEN 112736/kube-control tcp6 0 0 :::10252 :::* LISTEN 112736/kube-control é—®é¢˜äºŒï¼šSVCæ²¡æœ‰æ ‡ç­¾èµ„æº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 [root@k8s-master01 jiankong]# kubectl get servicemonitors.monitoring.coreos.com -n monitoring kube-controller-manager -oyaml apiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: annotations: .............................. sourceLabels: - __name__ - action: drop regex: etcd_(debugging|disk|request|server).* sourceLabels: - __name__ port: http-metrics jobLabel: k8s-app namespaceSelector: matchNames: - kube-system selector: matchLabels: k8s-app: kube-controller-manager #é€šè¿‡è¿™ä¸ªæ ‡ç­¾åŒ¹é…kube-controller-manager [root@k8s-master01 jiankong]# kubectl get svc -n kube-system -l k8s-app= kube-controller-manager error: name cannot be provided when a selector is specified #è¿™è¾¹åœ¨kube-systemæ²¡æœ‰è¿™ä¸ªæ ‡ç­¾çš„svcï¼Œæ‰€ä»¥æ— æ³•åŒ¹é…åˆ° è§£å†³ï¼š 1ã€ä¿®æ”¹ç›‘å¬åœ°å€ 1 2 3 vim /etc/kubernetes/manifests/kube-controller-manager.yaml - --bind-address=0.0.0.0 å¼€0.0.0.0ï¼Œæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºKubernetesé€šä¿¡éœ€è¦è¯ä¹¦ï¼Œæ˜¯åŒå‘çš„ã€‚\n2ã€æ·»åŠ svc epæ ‡ç­¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 apiVersion: v1 kind: Service metadata: labels: k8s-app: kube-controller-manager name: kube-controller-manage-monitor namespace: kube-system spec: ports: - name: http-metrics port: 10252 protocol: TCP targetPort: 10252 sessionAffinity: None type: ClusterIP apiVersion: v1 kind: Endpoints metadata: labels: k8s-app: kube-controller-manager name: kube-controller-manage-monitor namespace: kube-system subsets: - addresses: - ip: 192.168.0.100 ports: - name: http-metrics port: 10252 protocol: TCP 3ã€æµ‹è¯• ","date":"2021-03-18T12:32:12Z","image":"https://www.ownit.top/title_pic/16.jpg","permalink":"https://www.ownit.top/p/202103181232/","title":"è§£å†³prometheusç›‘æ§monitoring/kube-controller-manager/0 (0/0 up)çš„é—®é¢˜"},{"content":"Kubernetesç”¨operatoréƒ¨ç½²prometheus ä¸Šé¢é‡‡ç”¨Kuberneteséƒ¨ç½²prometheus\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨prometheusæ¥ç›‘æ§è‡ªå¸¦metricsæ¥å£çš„åº”ç”¨ã€‚\netcdæ˜¯Kubernetesçš„æ•°æ®åº“ï¼Œè‡ªå¸¦æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨etcdä½œä¸ºå®ä¾‹æ¥çœ‹çœ‹æ€ä¹ˆæ“ä½œã€‚\nä¸€ã€ç›‘æ§etcdé›†ç¾¤ 1.1ã€æŸ¥çœ‹æ¥å£ä¿¡æ¯ äºŒè¿›åˆ¶å’Œkubeadmå®‰è£…æ–¹å¼ä¸åŒï¼Œä»–ä»¬etcdçš„å­˜æ”¾è¯ä¹¦ä½ç½®ä¹Ÿä¸åŒ\näºŒè¿›åˆ¶\n1 2 3 [root@k8s-master01 ~]# curl --cert /etc/etcd/ssl/etcd.pem --key /etc/etcd/ssl/etcd-key.pem https://192.168.1.201:2379/metrics -k # è¿™æ ·ä¹Ÿè¡Œ curl -L http://localhost:2379/metrics kubeadm\n1 2 3 4 5 [root@k8s-master01 ~]# find / -name \u0026#34;etcd\u0026#34; /etc/kubernetes/pki/etcd curl --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key https://localhost:2379/metrics -k 1.2ã€åˆ›å»ºserviceå’ŒEndpoints åˆ›å»ºepå’Œsvcä»£ç†å¤–éƒ¨çš„etcdæœåŠ¡ï¼Œå…¶ä»–è‡ªå¸¦metricsæ¥å£çš„æœåŠ¡ä¹Ÿæ˜¯å¦‚æ­¤ï¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 apiVersion: v1 kind: Endpoints metadata: labels: app: etcd-k8s name: etcd-k8s namespace: kube-system #æ³¨æ„å‘½åç©ºé—´ subsets: - addresses: # etcdèŠ‚ç‚¹å¯¹åº”çš„ä¸»æœºipï¼Œæœ‰å‡ å°å°±å†™å‡ å° - ip: 192.168.0.100 ports: - name: etcd-port port: 2379 # etcdç«¯å£ protocol: TCP --- apiVersion: v1 kind: Service metadata: labels: app: etcd-k8s name: etcd-k8s namespace: kube-system spec: ports: - name: etcd-port port: 2379 protocol: TCP targetPort: 2379 type: ClusterIP 1.3ã€æµ‹è¯•æ˜¯å¦ä»£ç†æˆåŠŸ 1 2 3 4 5 6 7 #å†æ¬¡curlï¼ŒæŠŠIPæ¢æˆsvcçš„IPæµ‹è¯•ï¼Œè¾“å‡ºç›¸åŒå†…å®¹å³åˆ›å»ºæˆåŠŸ [root@k8s-master01 ~]# kubectl get svc -n kube-system etcd-k8s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE etcd-ep ClusterIP 10.103.53.103 \u0026lt;none\u0026gt; 2379/TCP 8m54s # å†æ¬¡è¯·æ±‚æ¥å£ [root@k8s-master01 ~]#curl --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key https://10.96.156.166:2379/metrics -k æœ‰ä¸Šé¢æµ‹è¯•æ•°å€¼ï¼Œä»£è¡¨æ¥å£å·²ç»æš´éœ²å‡ºæ¥ï¼Œç°åœ¨åŒ…è¯ä¹¦æŒ‚è½½ä¸Šå»ã€‚\n1.4ã€åˆ›å»ºsecret 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # 1ã€è¿™é‡Œæˆ‘ä»¬k8s-master01èŠ‚ç‚¹è¿›è¡Œåˆ›å»º,caä¸ºk8scaè¯ä¹¦ï¼Œå‰©ä¸‹2ä¸ªä¸ºetcdè¯ä¹¦ï¼Œè¿™æ˜¯æˆ‘è¯ä¹¦æ‰€åœ¨ä½ç½® cert-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd.pem\u0026#39; key-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-key.pem\u0026#39; trusted-ca-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-ca.pem\u0026#39; # 2ã€æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªsecretï¼Œè®©prometheus podèŠ‚ç‚¹æŒ‚è½½ kubectl create secret generic etcd-ssl --from-file=/etc/kubernetes/pki/etcd/etcd-ca.pem --from-file=/etc/kubernetes/pki/etcd/etcd.pem --from-file=/etc/kubernetes/pki/etcd/etcd-key.pem -n monitoring # 3ã€åˆ›å»ºå®Œæˆåå¯ä»¥æ£€æŸ¥ä¸€ä¸‹ [root@k8s-master01 prometheus-down]# kubectl describe secrets -n monitoring etcd-ssl Name: etcd-ssl Namespace: monitoring Labels: \u0026lt;none\u0026gt; Annotations: \u0026lt;none\u0026gt; Type: Opaque Data ==== etcd-ca.pem: 1367 bytes etcd-key.pem: 1679 bytes etcd.pem: 1509 bytes 1.5ã€ç¼–è¾‘prometheusï¼ŒæŠŠè¯ä¹¦æŒ‚è½½è¿›å» 1 2 3 4 5 6 7 8 9 10 11 12 13 # 1ã€é€šè¿‡editç›´æ¥ç¼–è¾‘prometheus æˆ–è€…ä¿®æ”¹yamlæ–‡ä»¶ [root@k8s-master01 ~]# kubectl edit prometheus k8s -n monitoring # åœ¨replicasåº•ä¸‹åŠ ä¸Šsecretåç§° replicas:2 secrets: - etcd-ssl #æ·»åŠ secretåç§° # è¿›å…¥å®¹å™¨æŸ¥çœ‹ï¼Œå°±å¯ä»¥çœ‹åˆ°è¯ä¹¦æŒ‚è½½è¿›å»äº† [root@k8s-master01 prometheus-down]# kubectl exec -it -n monitoring prometheus-k8s-0 /bin/sh # æŸ¥çœ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ /prometheus $ ls /etc/prometheus/secrets/etcd-ssl/ etcd-ca.pem etcd-key.pem etcd.pem 1.6ã€åˆ›å»ºServiceMonitor 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 [root@k8s-master01 ~]# cat etcd-servicemonitor.yaml apiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: name: etcd-k8s namespace: monitoring labels: app: etcd-k8s spec: jobLabel: app endpoints: - interval: 30s port: etcd-port # è¿™ä¸ªportå¯¹åº” Service.spec.ports.name scheme: https tlsConfig: caFile: /etc/prometheus/secrets/etcd-ssl/etcd-ca.pem #è¯ä¹¦è·¯å¾„ (åœ¨prometheus podé‡Œè·¯å¾„) certFile: /etc/prometheus/secrets/etcd-ssl/etcd.pem keyFile: /etc/prometheus/secrets/etcd-ssl/etcd-key.pem insecureSkipVerify: true # å…³é—­è¯ä¹¦æ ¡éªŒ selector: matchLabels: app: etcd-k8s # è·Ÿscvçš„lablesä¿æŒä¸€è‡´ namespaceSelector: matchNames: - kube-system # è·Ÿsvcæ‰€åœ¨namespaceä¿æŒä¸€è‡´ # åŒ¹é…Kube-systemè¿™ä¸ªå‘½åç©ºé—´ä¸‹é¢å…·æœ‰app=etcd-k8sè¿™ä¸ªlabelæ ‡ç­¾çš„Serveï¼Œjob labelç”¨äºæ£€ç´¢jobä»»åŠ¡åç§°çš„æ ‡ç­¾ã€‚ç”±äºè¯ä¹¦serverNameå’Œetcdä¸­ç­¾å‘çš„è¯ä¹¦å¯èƒ½ä¸åŒ¹é…ï¼Œæ‰€ä»¥æ·»åŠ äº†insecureSkipVerify=trueå°†ä¸å†å¯¹æœåŠ¡ç«¯çš„è¯ä¹¦è¿›è¡Œæ ¡éªŒ 1.7ã€é¡µé¢æŸ¥çœ‹etcdèŠ‚ç‚¹éƒ½è·å–åˆ°æ•°æ® æ­¤å¤„æ•°æ®è·å–æœ‰ç‚¹æ…¢ï¼Œéœ€è¦ç­‰å¾…ä¸€ä¸‹\n1.8ã€grafanaæ¨¡æ¿å¯¼å…¥ æ•°æ®é‡‡é›†å®Œæˆåï¼Œæ¥ä¸‹æ¥å¯ä»¥åœ¨grafanaä¸­å¯¼å…¥dashboard\n# æ‰“å¼€å®˜ç½‘æ¥çš„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç‚¹å‡»ä¸‹è½½JSOæ–‡ä»¶\ngrafanaå®˜ç½‘ï¼šhttps://grafana.com/grafana/dashboards/3070\nä¸­æ–‡ç‰ˆETCDé›†ç¾¤æ’ä»¶ï¼šhttps://grafana.com/grafana/dashboards/9733\nå·²ç»æˆåŠŸ\n","date":"2021-03-18T11:37:38Z","image":"https://www.ownit.top/title_pic/14.jpg","permalink":"https://www.ownit.top/p/202103181137/","title":"Kubernetesç›‘æ§etcdé›†ç¾¤ï¼ˆè‡ªå¸¦metricsæ¥å£ï¼‰"},{"content":"Operator æ¨¡å¼ Operator æ˜¯ Kubernetes çš„æ‰©å±•è½¯ä»¶ï¼Œå®ƒåˆ©ç”¨Â å®šåˆ¶èµ„æºÂ ç®¡ç†åº”ç”¨åŠå…¶ç»„ä»¶ã€‚ Operator éµå¾ª Kubernetes çš„ç†å¿µï¼Œç‰¹åˆ«æ˜¯åœ¨æ§åˆ¶å™¨Â æ–¹é¢ã€‚\nOperatorçš„åœºæ™¯å°±æ˜¯ä¸“é—¨ç»™æœ‰çŠ¶æ€åº”ç”¨è€Œè®¾è®¡çš„ã€‚\nä¸ºä»€ä¹ˆåªç»™æœ‰çŠ¶æ€åº”ç”¨ï¼Ÿ\nå› ä¸ºæ— çŠ¶æ€åº”ç”¨ç®€å•å•Šï¼Œæ²¡æœ‰æœåŠ¡é—´çš„äº¤äº’ï¼Œè¦å†å¼€ä¸€å®¶ç«é”…åº—ï¼Œè·Ÿk8sè¯´ä¸€å£°ï¼Œå¼€ä¸€å®¶ä¸€æ ·çš„å°±å¯ä»¥äº†ã€‚\næœ‰çŠ¶æ€ä¸ä¸€æ ·ï¼Œä½ å¼€äº†ä¸€å®¶ç«é”…åº—ä»¥åï¼Œå®¢æˆ·çš„ä¿¡æ¯æ€ä¹ˆåŒæ­¥ï¼Œå°±æ¶‰åŠåˆ°ä¸åˆ«çš„ç«é”…åº—äº¤æ¶‰çš„é—®é¢˜ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å†™ä¸ªåˆ«çš„ç¨‹åºåšè¿™ä¸ªæ•°æ®åŒæ­¥çš„æ“ä½œã€‚\nä½†æ˜¯operatoråšçš„äº‹æƒ…å°±æ˜¯èƒ½è‡ªåŠ¨è¯†åˆ«åˆ°ç«é”…åº—å®¢æˆ·ä¿¡æ¯çš„ä¸å¯¹ç§°ï¼Œä¸»åŠ¨åŒæ­¥ï¼Œä½ åªç”¨å‘Šè¯‰operatoræˆ‘è¦å†å¼€ä¸€å®¶è¿é”ç«é”…åº—å°±å¥½äº†ã€‚\nKubernetes ä¸Šçš„ OperatorÂ Kubernetes ä¸ºè‡ªåŠ¨åŒ–è€Œç”Ÿã€‚æ— éœ€ä»»ä½•ä¿®æ”¹ï¼Œä½ å³å¯ä»¥ä» Kubernetes æ ¸å¿ƒä¸­è·å¾—è®¸å¤šå†…ç½®çš„è‡ªåŠ¨åŒ–åŠŸèƒ½ã€‚ ä½ å¯ä»¥ä½¿ç”¨ Kubernetes è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œè¿è¡Œå·¥ä½œè´Ÿè½½ï¼ŒÂ ç”šè‡³Â å¯ä»¥è‡ªåŠ¨åŒ– Kubernetes è‡ªèº«ã€‚\nKubernetesÂ æ§åˆ¶å™¨Â ä½¿ä½ æ— éœ€ä¿®æ”¹ Kubernetes è‡ªèº«çš„ä»£ç ï¼Œå³å¯ä»¥æ‰©å±•é›†ç¾¤çš„è¡Œä¸ºã€‚ Operator æ˜¯ Kubernetes API çš„å®¢æˆ·ç«¯ï¼Œå……å½“Â å®šåˆ¶èµ„æºÂ çš„æ§åˆ¶å™¨\nå®˜ç½‘æ–‡æ¡£ï¼šhttps://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/\néƒ¨ç½²prometheus 1.1ã€ä¸‹è½½ 1 git clone -b release-0.7 --single-branch https://github.com/coreos/kube-prometheus.git 1.2ã€å®‰è£…operator 1 2 3 4 5 6 7 [root@k8s-master01 ~]# cd /root/kube-prometheus/manifests/setup [root@k8s-master01 setup]# kubectl create -f . # æŸ¥çœ‹æ˜¯å¦Running [root@k8s-master01 ~]# kubectl get pod -n monitoring NAME READY STATUS RESTARTS AGE prometheus-operator-848d669f6d-bz2tc 2/2 Running 0 4m16s 1.3ã€å®‰è£…Prometheus 1 2 [root@k8s-master01 ~]# cd /root/kube-prometheus/manifests [root@k8s-master01 manifests]# kubectl create -f . 1.4ã€åˆ›å»ºingress 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 [root@k8s-master01 manifests]# cat svc-ingress.yal apiVersion: extensions/v1beta1 kind: Ingress metadata: name: prom-ingresses namespace: monitoring spec: rules: - host: alert.test.com http: paths: - backend: serviceName: alertmanager-main servicePort: 9093 path: / - host: grafana.test.com http: paths: - backend: serviceName: grafana servicePort: 3000 path: / - host: prom.test.com http: paths: - backend: serviceName: prometheus-k8s servicePort: 9090 path: / [root@k8s-master01 manifests]# kubectl get ingress -n monitoring NAME CLASS HOSTS ADDRESS PORTS AGE prom-ingresses \u0026lt;none\u0026gt; alert.test.com,grafana.test.com,prom.test.com 10.96.107.62 80 23h alert.test.comï¼ˆæŠ¥è­¦ï¼‰ prom.test.comï¼ˆæ™®ç½—ç±³ä¿®æ–¯ï¼‰ grafana.test.comï¼ˆå›¾å½¢å±•ç¤ºï¼‰ ","date":"2021-03-17T22:51:35Z","image":"https://www.ownit.top/title_pic/50.jpg","permalink":"https://www.ownit.top/p/202103172251/","title":"Kubernetesç”¨operatoréƒ¨ç½²prometheus"},{"content":"æ—¥å¸¸å·¥ä½œä¸­ï¼Œæˆ‘ä»¬æœ‰æ—¶ä¼šå¯¹ä¸€äº›æ¯”è¾ƒä½çš„ç»„ä»¶åšå‡çº§ã€‚\nç‰ˆæœ¬çš„å‡çº§ï¼Œå¯ä»¥è§£å†³ä¸€ä¸‹bugå’Œæ¼æ´ï¼Œç¨³å®šç³»ç»Ÿçš„æ€§èƒ½ã€‚\nè¿™æ¬¡æˆ‘å‡çº§å¯¹corednså‡çº§ã€‚\ncorednsä¸»è¦æ˜¯Kubernetesä¸­å¯¹åŸŸåå’Œipè§£æï¼Œå¯ä»¥ä½œä¸ºå†…ç½‘çš„dnsè§£ææœåŠ¡å™¨ã€‚\nä¸€ã€æŸ¥çœ‹å½“å‰corednsç‰ˆæœ¬ 1 2 3 4 5 6 7 [root@k8s-master01 ~]# kubectl get pod -n kube-system coredns-7ff77c879f-h2jw9 -oyaml | grep image f:image: {} f:imagePullPolicy: {} image: registry.aliyuncs.com/google_containers/coredns:1.6.7 imagePullPolicy: IfNotPresent image: registry.aliyuncs.com/google_containers/coredns:1.6.7 imageID: docker-pullable://registry.aliyuncs.com/google_containers/coredns@sha256:695a5e109604331f843d2c435f488bf3f239a88aec49112d452c1cbf87e88405 äºŒã€å‡çº§ 2.1ã€æŸ¥è¯¢æœ€æ–°ç‰ˆcorednsçš„ç‰ˆæœ¬ 1 2 3 4 5 6 # corednså®˜ç½‘ï¼šhttps://github.com/coredns/coredns # è€ç‰ˆæœ¬ç”¨ï¼škube-dns # æ–°ç‰ˆçš„éƒ½ç”¨ï¼šcoredns # éƒ¨ç½²æ–‡æ¡£ï¼šhttps://github.com/coredns/deployment/tree/master/kubernetes æœ€æ–°ç‰ˆåœ°å€ï¼šhttps://github.com/coredns/deployment/blob/master/kubernetes/coredns.yaml.sed\nç°åœ¨æœ€æ–°ç‰ˆæ˜¯1.8.3\n2.2ã€å¤‡ä»½åŸæ¥çš„cmã€deployã€clusterroleã€clusterrolebinding åˆ‡è®°ï¼šæ—¥å¸¸æˆ‘ä»¬åšä»»ä½•æ“ä½œï¼ˆå‡çº§ï¼Œåˆ é™¤ï¼Œä¿®æ”¹ï¼‰ï¼Œä¸€å®šè¦å¤‡ä»½ï¼Œé˜²æ­¢é”™è¯¯æ“ä½œï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œæˆ–è€…åŠŸèƒ½æ— æ³•ä½¿ç”¨\nå¤‡ä»½å¥½å¤„ï¼Œå¯ä»¥ç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œå¦‚æœå‡ºç°åŠŸèƒ½ä¸èƒ½ä½¿ç”¨ï¼Œå¯ä»¥ç«‹åˆ»å›æ»šï¼Œä¸é•¿æ—¶é—´å½±å“ä¸šåŠ¡\n1 2 3 4 5 mkdir coredns \u0026amp;\u0026amp; cd coredns kubectl get cm -n kube-system coredns -oyaml \u0026gt; coredns-config.yaml kubectl get deploy -n kube-system coredns -oyaml \u0026gt; coredns-controllers.yaml kubectl get clusterrole system:coredns -oyaml \u0026gt; coredns-clusterrole.yaml kubectl get clusterrolebinding system:coredns -oyaml \u0026gt; coredns-clusterrolebinding.yaml 2.3ã€å‡çº§coredns ä¸‹è½½åœ°å€ï¼šgit clone https://github.com/coredns/deployment.git\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # 1ã€ä¸‹è½½æ–‡ä»¶ git clone https://github.com/coredns/deployment.git # 2ã€å‡çº§ cd deployment/kubernetes/ ./deploy.sh -s | kubectl apply -f - [root@k8s-master01 ~]# cd deployment/kubernetes/ [root@k8s-master01 kubernetes]# ./deploy.sh -s | kubectl apply -f - Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply serviceaccount/coredns configured Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply clusterrole.rbac.authorization.k8s.io/system:coredns configured Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply clusterrolebinding.rbac.authorization.k8s.io/system:coredns configured Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply configmap/coredns configured Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply deployment.apps/coredns configured Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply service/kube-dns configured å·²ç»å‡çº§æˆåŠŸ\n","date":"2021-03-17T21:39:04Z","image":"https://www.ownit.top/title_pic/32.jpg","permalink":"https://www.ownit.top/p/202103172139/","title":"Kuberneteså‡çº§coredns1.8.3"},{"content":"é—®é¢˜ï¼šKuberneteså®‰è£…æ™®ç½—ç±³ä¿®æ–¯ï¼Œå…¶ä¸­kube-state-metrics å®¹å™¨ä¸€ç›´æŠ¥é”™\nç¯å¢ƒï¼šKubernetes 1.18\n1 2 3 4 5 6 7 [root@k8s-master01 manifests]# kubectl logs -f kube-state-metrics-bdb8874fd-tnrrg -n monitoring -c kube-state-metrics I0316 13:12:52.295699 1 main.go:86] Using default collectors I0316 13:12:52.295788 1 main.go:98] Using all namespace I0316 13:12:52.295798 1 main.go:139] metric white-blacklisting: blacklisting the following items: W0316 13:12:52.295807 1 client_config.go:543] Neither --kubeconfig nor --master was specified. Using the inClusterConfig. This might not work. I0316 13:12:52.297186 1 main.go:184] Testing communication with server F0316 13:13:22.298801 1 main.go:147] Failed to create client: error while trying to communicate with apiserver: Get https://10.96.0.1:443/version?timeout=32s: dial tcp 10.96.0.1:443: i/o timeout åˆ†æï¼š\né¦–å…ˆï¼Œè¿™ä¸ªkube-state-metrics-bdb8874fd-tnrrg ä¸­æœ‰ä¸‰ä¸ªå®¹å™¨ã€‚é—®é¢˜å‡ºç°åœ¨kube-state-metricsã€‚å¯¼è‡´å®¹å™¨ä¸æ–­çš„é‡å¯\nçœ‹é—®é¢˜ï¼Œæ˜¯æ— æ³•è¿æ¥åˆ°10.96.0.1:443è¿™ä¸ªipå’Œç«¯å£ä¸Šã€‚\n1 2 3 4 5 [root@k8s-master01 ~]# kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE csi-metrics-cephfsplugin ClusterIP 10.96.218.238 \u0026lt;none\u0026gt; 8080/TCP 21h kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 83d nginx ClusterIP 10.96.215.251 \u0026lt;none\u0026gt; 80/TCP 16d ç”±svcå¯è§ï¼Œè¿™ä¸ªæ˜¯Kubernetesçš„æ ¸å¿ƒipå’Œç«¯å£ã€‚ä½†æ˜¯ä»–é‚£è¾¹æ˜¾ç¤ºæ— æ³•è¿æ¥ã€‚\næµ‹è¯•ä¸€ä¸‹\nè¿™ä¸ªç«¯å£æ˜¯é€šçš„ï¼Œä½†æ˜¯æ— æ³•è¿æ¥ã€‚æŠ¥é”™æ˜¾ç¤ºioçº¿ç¨‹å»¶æ—¶ã€‚\nè§£å†³ï¼š\nkube-state-metricsåŸæœ¬å®‰è£…åœ¨k8s-node02ä¸Šã€‚è¿™è¾¹åˆ é™¤ï¼Œè¿˜æ˜¯ä»é‡å»ºk8s-node02.\nåˆ†æä¸€ä¸‹node02çš„cpuæœ‰ç‚¹é«˜ï¼Œæˆ‘ç›´æ¥æŒ‡å®šåˆ°k8s-node01ä¸Šã€‚\nç„¶åæµ‹è¯•ï¼Œæ²¡æœ‰æ˜¾ç¤ºioå»¶æ—¶æŠ¥é”™\n","date":"2021-03-16T21:36:32Z","image":"https://www.ownit.top/title_pic/46.jpg","permalink":"https://www.ownit.top/p/202103162136/","title":"Failed to create client- error while trying to communicate with apiserver- æŠ¥é”™è§£å†³"},{"content":"é¦–å…ˆä»‹ç»ä¸€ä¸‹bitnami\n_BitNami_æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œè¯¥é¡¹ç›®äº§ç”Ÿçš„å¼€æºè½¯ä»¶åŒ…æ‹¬å®‰è£… Webåº”ç”¨ç¨‹åºå’Œè§£å†³æ–¹æ¡ˆå †æ ˆï¼Œä»¥åŠè™šæ‹Ÿè®¾å¤‡ï¼ˆé€šä¿—æ˜“æ‡‚çš„è¯´ï¼šå°±æ˜¯å°è£…å¥½å„ç§åº”ç”¨åŒ…ï¼Œæä¾›äººä»¬ä½¿ç”¨ã€‚ï¼‰\næˆ‘ä»¬å¹³æ—¶è¦éƒ¨ç½²ä¸€å¥—é«˜å¯ç”¨é›†ç¾¤ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯æ‰¾åˆ°æ¨¡æ¿ï¼Œæ²¡å¿…è¦é‡å¤é€ è½®å­ã€‚BitNamiå°±æ˜¯æä¾›è½®å­çš„ã€‚\nbitnamiå®˜æ–¹åœ°å€ï¼š https://bitnami.com/\nè¿™æ¬¡æˆ‘ä»¬åˆ›å»ºéƒ¨ç½²zookeeperå’Œkafkaé›†ç¾¤ï¼Œé‡‡å–bitnamiæä¾›helmä»“åº“ï¼Œè¿›è¡Œå®‰è£…å’Œéƒ¨ç½²ã€‚\nä¸æ‡‚Helmçš„å¯ä»¥çœ‹çœ‹Â Helméƒ¨ç½²RabbitMQé›†ç¾¤ï¼Œæä¾›å‚è€ƒ\néƒ¨ç½²å®‰è£…æ–‡æ¡£ï¼šhttps://docs.bitnami.com/tutorials/deploy-scalable-kafka-zookeeper-cluster-kubernetes\nhelmæ·»åŠ _BitNamiä»“åº“_ 1 helm repo add bitnami https://charts.bitnami.com/bitnami éƒ¨ç½²zookeeperé›†ç¾¤ 1 2 3 4 helm install zookeeper bitnami/zookeeper --set replicaCount=3 --set auth.enabled=false --set allowAnonymousLogin=true éƒ¨ç½²kafkaé›†ç¾¤ 1 2 3 4 helm install kafka bitnami/kafka --set zookeeper.enabled=false --set replicaCount=3 --set externalZookeeper.servers=ZOOKEEPER-SERVICE-NAME æŸ¥çœ‹kafkaé›†ç¾¤ï¼Œè¿æ¥zookeeper\næ‰©å®¹å’Œç¼©å®¹ ä¿®æ”¹ä¸‹é¢è¿™ä¸ªå‚æ•°ï¼Œé‡æ–°è¿è¡Œã€‚\n1 --set replicaCount=7 å¦‚æœé‡åˆ°æ‹‰å»é•œåƒå¤±è´¥ï¼Œè¿™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹çš„é•œåƒæº\nhttps://www.daocloud.io/mirror\n1 curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://f1361db2.m.daocloud.io 1 2 3 4 [root@k8s-master01 kafka]# cat /etc/docker/daemon.json { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;http://f1361db2.m.daocloud.io\u0026#34;] } ","date":"2021-03-15T16:57:54Z","image":"https://www.ownit.top/title_pic/75.jpg","permalink":"https://www.ownit.top/p/202103151657/","title":"Helmï¼ˆbitnamiï¼‰éƒ¨ç½²zookeeperå’Œkafkaé›†ç¾¤"},{"content":"HelmÂ å¸®åŠ©æ‚¨ç®¡ç† Kubernetes åº”ç”¨ç¨‹åºâ€”â€”Helm Charts å¸®åŠ©æ‚¨å®šä¹‰ã€å®‰è£…å’Œå‡çº§æœ€å¤æ‚çš„ Kubernetes åº”ç”¨ç¨‹åºã€‚\nHelm å¯ä»¥ä½¿ç”¨ Charts å¯åŠ¨ Kubernetes é›†ç¾¤ï¼Œæä¾›å¯ç”¨çš„å·¥ä½œæµï¼š\nä¸€ä¸ª Redis é›†ç¾¤\nä¸€ä¸ª Postgres æ•°æ®åº“\nä¸€ä¸ª HAProxy è¾¹ç•Œè´Ÿè½½å‡è¡¡\nç‰¹æ€§ï¼š\næŸ¥æ‰¾å¹¶ä½¿ç”¨æµè¡Œçš„è½¯ä»¶ï¼Œå°†å…¶æ‰“åŒ…ä¸º Helm Chartsï¼Œä»¥ä¾¿åœ¨ Kubernetes ä¸­è¿è¡Œ ä»¥ Helm Charts çš„å½¢å¼å…±äº«æ‚¨è‡ªå·±çš„åº”ç”¨ç¨‹åº ä¸ºæ‚¨çš„ Kubernetes åº”ç”¨ç¨‹åºåˆ›å»ºå¯å¤åˆ¶çš„æ„å»º æ™ºèƒ½åœ°ç®¡ç†æ‚¨çš„ Kubernetes æ¸…å•æ–‡ä»¶ ç®¡ç† Helm åŒ…çš„å‘è¡Œç‰ˆ helmçš„å®‰è£… å®˜æ–¹æ–‡æ¡£ï¼šhttps://helm.sh/docs/intro/install/\nç‰ˆæœ¬ä¸‹è½½åœ°å€ï¼šhttps://github.com/helm/helm/releases\n1 2 3 4 5 6 7 tar -zxvf helm-v3.0.0-linux-amd64.tar.gz mv linux-amd64/helm /usr/local/bin/helm å·²ç»å®‰è£…å®Œæˆ [root@k8s-master01 ~]# helm version version.BuildInfo{Version:\u0026#34;v3.5.3\u0026#34;, GitCommit:\u0026#34;041ce5a2c17a58be0fcd5f5e16fb3e7e95fea622\u0026#34;, GitTreeState:\u0026#34;dirty\u0026#34;, GoVersion:\u0026#34;go1.15.8\u0026#34;} è‡³äºæ€ä¹ˆæ·»åŠ ä»“åº“ï¼Œå¯ä»¥ç™¾åº¦\n1 2 3 4 5 [root@k8s-master01 ~]# helm repo list NAME URL aliyuncs https://apphub.aliyuncs.com stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts ingress-nginx\thttps://kubernetes.github.io/ingress-nginx æŸ¥çœ‹å¯ä½¿ç”¨tabbitmq-haçš„ç‰ˆæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 [root@k8s-master01 ~]# helm search repo rabbitmq-ha NAME CHART VERSION\tAPP VERSION\tDESCRIPTION aliyuncs/rabbitmq-ha\t1.39.0 3.8.0 Highly available RabbitMQ cluster, the open sou... stable/rabbitmq-ha 1.0.0 3.7.3 Highly available RabbitMQ cluster, the open sou... [root@k8s-master01 ~]# helm search repo rabbitmq-ha --versions NAME CHART VERSION\tAPP VERSION\tDESCRIPTION aliyuncs/rabbitmq-ha\t1.39.0 3.8.0 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.38.2 3.8.0 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.38.1 3.8.0 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.36.4 3.8.0 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.36.3 3.8.0 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.36.0 3.8.0 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.34.1 3.7.19 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.34.0 3.7.19 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.33.0 3.7.15 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.32.4 3.7.15 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.32.3 3.7.15 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.32.2 3.7.15 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.32.0 3.7.15 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.31.0 3.7.15 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.30.0 3.7.15 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.29.1 3.7.15 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.29.0 3.7.15 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.28.0 3.7.15 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.27.2 3.7.15 Highly available RabbitMQ cluster, the open sou... aliyuncs/rabbitmq-ha\t1.27.1 3.7.12 Highly available RabbitMQ cluster, the open sou... stable/rabbitmq-ha 1.0.0 3.7.3 Highly available RabbitMQ cluster, the open sou... stable/rabbitmq-ha 0.1.1 3.7.0 Highly available RabbitMQ cluster, the open sou... æ‹‰å»æŒ‡å®šç‰ˆæœ¬çš„é…ç½® 1 2 3 [root@k8s-master01 ~]# helm pull aliyuncs/rabbitmq-ha --version=1.33.0 [root@k8s-master01 ~]# ls helm old rabbitmq-cluster rabbitmq-ha-1.33.0.tgz #è¿™ä¸ªå°±åªæ‹‰å»çš„æ–‡ä»¶ï¼Œå¯ä»¥è§£å‹ æŸ¥è¯¢é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 [root@k8s-master01 ~]# tar -xf rabbitmq-ha-1.33.0.tgz [root@k8s-master01 ~]# ls helm old rabbitmq-cluster rabbitmq-ha rabbitmq-ha-1.33.0.tgz [root@k8s-master01 ~]# tree rabbitmq-ha rabbitmq-ha â”œâ”€â”€ Chart.yaml â”œâ”€â”€ OWNERS â”œâ”€â”€ README.md â”œâ”€â”€ templates â”‚Â â”œâ”€â”€ alerts.yaml â”‚Â â”œâ”€â”€ configmap.yaml â”‚Â â”œâ”€â”€ _helpers.tpl â”‚Â â”œâ”€â”€ ingress.yaml â”‚Â â”œâ”€â”€ NOTES.txt â”‚Â â”œâ”€â”€ pdb.yaml â”‚Â â”œâ”€â”€ rolebinding.yaml â”‚Â â”œâ”€â”€ role.yaml â”‚Â â”œâ”€â”€ secret.yaml â”‚Â â”œâ”€â”€ serviceaccount.yaml â”‚Â â”œâ”€â”€ service-discovery.yaml â”‚Â â”œâ”€â”€ servicemonitor.yaml â”‚Â â”œâ”€â”€ service.yaml â”‚Â â””â”€â”€ statefulset.yaml â””â”€â”€ values.yaml 1 directory, 18 files å‚è€ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 â”œâ”€â”€ charts # ä¾èµ–æ–‡ä»¶ â”œâ”€â”€ Chart.yaml # è¿™ä¸ªchartçš„ç‰ˆæœ¬ä¿¡æ¯ â”œâ”€â”€ templates #æ¨¡æ¿ â”‚ â”œâ”€â”€ deployment.yaml â”‚ â”œâ”€â”€ _helpers.tpl # è‡ªå®šä¹‰çš„æ¨¡æ¿æˆ–è€…å‡½æ•° â”‚ â”œâ”€â”€ ingress.yaml â”‚ â”œâ”€â”€ NOTES.txt #è¿™ä¸ªchartçš„ä¿¡æ¯ â”‚ â”œâ”€â”€ serviceaccount.yaml â”‚ â”œâ”€â”€ service.yaml â”‚ â””â”€â”€ tests â”‚ â””â”€â”€ test-connection.yaml â””â”€â”€ values.yaml #é…ç½®å…¨å±€å˜é‡æˆ–è€…ä¸€äº›å‚æ•° åˆ›å»ºnamespaces helmæŒ‡å®šnamespacesï¼Œå¦‚æœæ²¡æœ‰namespacesç©ºé—´ï¼Œå°±ä¼šæŠ¥é”™ã€‚éœ€è¦æå‰åˆ›å»º\n1 2 [root@k8s-master01 ~]# helm create rabbitmq-cluster Creating rabbitmq-cluster è¿è¡Œrabbitmqé›†ç¾¤ é•œåƒé…ç½®æ–¹é¢ï¼Œå¯ä»¥ä¿®æ”¹values.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 [root@k8s-master01 rabbitmq-ha]# pwd /root/rabbitmq-ha [root@k8s-master01 rabbitmq-ha]# ls Chart.yaml OWNERS README.md templates values.yaml [root@k8s-master01 rabbitmq-ha]# helm install rabbitmq --namespace rabbitmq-cluster --set ingress.enabled=true,ingress.hostName=rabbitmq.akiraka.net --set rabbitmqUsername=aka,rabbitmqPassword=rabbitmq,managementPassword=rabbitmq,rabbitmqErlangCookie=secretcookie . NAME: rabbitmq LAST DEPLOYED: Sun Mar 14 17:25:11 2021 NAMESPACE: rabbitmq-cluster STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: ** Please be patient while the chart is being deployed ** Credentials: Username : aka Password : $(kubectl get secret --namespace rabbitmq-cluster rabbitmq-rabbitmq-ha -o jsonpath=\u0026#34;{.data.rabbitmq-password}\u0026#34; | base64 --decode) Management username : management Management password : $(kubectl get secret --namespace rabbitmq-cluster rabbitmq-rabbitmq-ha -o jsonpath=\u0026#34;{.data.rabbitmq-management-password}\u0026#34; | base64 --decode) ErLang Cookie : $(kubectl get secret --namespace rabbitmq-cluster rabbitmq-rabbitmq-ha -o jsonpath=\u0026#34;{.data.rabbitmq-erlang-cookie}\u0026#34; | base64 --decode) RabbitMQ can be accessed within the cluster on port 5672 at rabbitmq-rabbitmq-ha.rabbitmq-cluster.svc.cluster.local To access the cluster externally execute the following commands: export POD_NAME=$(kubectl get pods --namespace rabbitmq-cluster -l \u0026#34;app=rabbitmq-ha\u0026#34; -o jsonpath=\u0026#34;{.items[0].metadata.name}\u0026#34;) kubectl port-forward $POD_NAME --namespace rabbitmq-cluster 5672:5672 15672:15672 To Access the RabbitMQ AMQP port: amqp://127.0.0.1:5672/ To Access the RabbitMQ Management interface: URL : http://127.0.0.1:15672 [root@k8s-master01 rabbitmq-ha]# æŸ¥çœ‹é›†ç¾¤ å·²ç»æ­£å¸¸è¿è¡Œèµ·æ¥äº†\n1 2 3 4 5 6 7 8 9 10 11 12 [root@k8s-master01 rabbitmq-ha]# kubectl get svc,pod,ingress -n rabbitmq-cluster NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/rabbitmq-rabbitmq-ha ClusterIP None \u0026lt;none\u0026gt; 15672/TCP,5672/TCP,4369/TCP 7m23s service/rabbitmq-rabbitmq-ha-discovery ClusterIP None \u0026lt;none\u0026gt; 15672/TCP,5672/TCP,4369/TCP 7m23s NAME READY STATUS RESTARTS AGE pod/rabbitmq-rabbitmq-ha-0 1/1 Running 0 7m23s pod/rabbitmq-rabbitmq-ha-1 1/1 Running 0 6m56s pod/rabbitmq-rabbitmq-ha-2 1/1 Running 0 6m34s NAME CLASS HOSTS ADDRESS PORTS AGE ingress.extensions/rabbitmq-rabbitmq-ha \u0026lt;none\u0026gt; rabbitmq.akiraka.net 10.96.107.62 80 7m23s å¾ˆæ–¹ä¾¿çš„ï¼Œå‡ ä¸ªå‘½ä»¤å°±å®Œæˆé›†ç¾¤çš„éƒ¨ç½²\nè¡¥å…… 1 2 helm install helm-test2 --set fullnameOverride=aaaaaaa --dry-run . è¿™ä¸ªæ˜¯æ¨¡æ‹Ÿè¿è¡Œï¼Œæ‡‚çš„äººéƒ½æ‡‚ï¼ˆå¸¦å€¼ï¼‰ 1 2 3 åˆ é™¤helm uninstall rabbitmq-cluster -n public-service # helm v3 --keep-history helm delete/del NAME --purge å‡çº§helm upgrade rabbitmq-cluster -n public-service . å¸è½½ä¿ç•™å†å²è®°å½•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 [root@k8s-master01 rabbitmq-ha]# helm uninstall rabbitmq -n rabbitmq-cluster --keep-history release \u0026#34;rabbitmq\u0026#34; uninstalled [root@k8s-master01 rabbitmq-ha]# helm list -n rabbitmq-cluster NAME\tNAMESPACE\tREVISION\tUPDATED\tSTATUS\tCHART\tAPP VERSION [root@k8s-master01 rabbitmq-ha]# helm list NAME\tNAMESPACE\tREVISION\tUPDATED\tSTATUS\tCHART\tAPP VERSION [root@k8s-master01 rabbitmq-ha]# helm ls NAME\tNAMESPACE\tREVISION\tUPDATED\tSTATUS\tCHART\tAPP VERSION [root@k8s-master01 rabbitmq-ha]# helm status rabbitmq -n rabbitmq-cluster NAME: rabbitmq LAST DEPLOYED: Sun Mar 14 17:25:11 2021 NAMESPACE: rabbitmq-cluster STATUS: uninstalled REVISION: 1 TEST SUITE: None NOTES: ** Please be patient while the chart is being deployed ** Credentials: Username : aka Password : $(kubectl get secret --namespace rabbitmq-cluster rabbitmq-rabbitmq-ha -o jsonpath=\u0026#34;{.data.rabbitmq-password}\u0026#34; | base64 --decode) Management username : management Management password : $(kubectl get secret --namespace rabbitmq-cluster rabbitmq-rabbitmq-ha -o jsonpath=\u0026#34;{.data.rabbitmq-management-password}\u0026#34; | base64 --decode) ErLang Cookie : $(kubectl get secret --namespace rabbitmq-cluster rabbitmq-rabbitmq-ha -o jsonpath=\u0026#34;{.data.rabbitmq-erlang-cookie}\u0026#34; | base64 --decode) RabbitMQ can be accessed within the cluster on port 5672 at rabbitmq-rabbitmq-ha.rabbitmq-cluster.svc.cluster.local To access the cluster externally execute the following commands: export POD_NAME=$(kubectl get pods --namespace rabbitmq-cluster -l \u0026#34;app=rabbitmq-ha\u0026#34; -o jsonpath=\u0026#34;{.items[0].metadata.name}\u0026#34;) kubectl port-forward $POD_NAME --namespace rabbitmq-cluster 5672:5672 15672:15672 To Access the RabbitMQ AMQP port: amqp://127.0.0.1:5672/ To Access the RabbitMQ Management interface: URL : http://127.0.0.1:15672 ","date":"2021-03-14T17:37:25Z","image":"https://www.ownit.top/title_pic/71.jpg","permalink":"https://www.ownit.top/p/202103141737/","title":"Helméƒ¨ç½²RabbitMQé›†ç¾¤"},{"content":"RabbitMQæ˜¯å®ç°äº†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼ˆäº¦ç§°é¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼‰\nå¯ä¼¸ç¼©æ€§ï¼šé›†ç¾¤æœåŠ¡\næ¶ˆæ¯æŒä¹…åŒ–ï¼šä»å†…å­˜æŒä¹…åŒ–æ¶ˆæ¯åˆ°ç¡¬ç›˜ï¼Œå†ä»ç¡¬ç›˜åŠ è½½åˆ°å†…å­˜Â å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨åˆ°Rabbitmqï¼Œæœ‰å•èŠ‚ç‚¹ï¼Œæœ‰é›†ç¾¤çš„ã€‚\né€šè¿‡è¯¥Kubernetesæ¥å®‰è£…RabbitMQï¼Œé€šè¿‡æ’ã€rabbitmq_management,rabbitmq_peer_discovery_k8sã€‘æ¥è‡ªåŠ¨å‘ç°æ³¨å†Œé›†ç¾¤ï¼š\nRabbitMQé€šè¿‡StatefulSetæ¥éƒ¨ç½²ï¼Œå¯ä»¥é€šè¿‡åŸŸåæ¥è®¿é—®ï¼Œæ–¹ä¾¿å¤„ç†\nï¼ˆ1ï¼‰ç¯å¢ƒ éœ€è¦Kubernetesé›†ç¾¤\nä¸‹è½½éƒ¨ç½²æ–‡ä»¶\n1 ä¸‹è½½åœ°å€ï¼šhttps://github.com/dotbalo/k8s/tree/master/k8s-rabbitmq-cluster ï¼ˆ2ï¼‰åˆ›å»ºå‘½åç©ºé—´ 1 kubectl create ns public-service å¦‚æœä¸ä½¿ç”¨public-serviceï¼Œéœ€è¦æ›´æ”¹æ‰€æœ‰yamlæ–‡ä»¶çš„public-serviceä¸ºä½ namespaceã€‚\n1 sed -i \u0026#34;s#public-service#YOUR_NAMESPACE#g\u0026#34; *.yaml ï¼ˆ3ï¼‰ä¿®æ”¹é…ç½®æ–‡ä»¶ 1 2 3 åœ¨rabbitmq-configmap.yamlé…ç½®ï¼Œæ·»åŠ è¿™ä¸¤ä¸ªå­—æ®µï¼Œè§£å†³å¯†ç ä¸ç”Ÿæ•ˆçš„é—®é¢˜ default_pass = RABBITMQ_PASS default_user = RABBITMQ_USER è¿™è¾¹PVæ˜¯ä½¿ç”¨nfsçš„ã€‚æµ‹è¯•ç¯å¢ƒï¼Œè¿™è¾¹æˆ‘æ˜¯æ‰‹åŠ¨åˆ›å»ºçš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ’ä»¶ï¼Œè‡ªåŠ¨åˆ›å»ºï¼Œå¹¶å›æ”¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 [root@k8s-master01 k8s-rabbitmq-cluster]# cat rabbitmq-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: pv-rmq-1 spec: capacity: storage: 1Gi accessModes: - ReadWriteMany volumeMode: Filesystem persistentVolumeReclaimPolicy: Recycle storageClassName: \u0026#34;rmq-storage-class\u0026#34; nfs: # real share directory path: /ifs/kubernetts/rabbitmq-cluster-0 # nfs real ip server: 192.168.0.109 --- apiVersion: v1 kind: PersistentVolume metadata: name: pv-rmq-2 spec: capacity: storage: 1Gi accessModes: - ReadWriteMany volumeMode: Filesystem persistentVolumeReclaimPolicy: Recycle storageClassName: \u0026#34;rmq-storage-class\u0026#34; nfs: # real share directory path: /ifs/kubernetts/rabbitmq-cluster-1 # nfs real ip server: 192.168.0.109 --- apiVersion: v1 kind: PersistentVolume metadata: name: pv-rmq-3 spec: capacity: storage: 1Gi accessModes: - ReadWriteMany volumeMode: Filesystem persistentVolumeReclaimPolicy: Recycle storageClassName: \u0026#34;rmq-storage-class\u0026#34; nfs: # real share directory path: /ifs/kubernetts/rabbitmq-cluster-2 # nfs real ip server: 192.168.0.109 ï¼ˆ4ï¼‰åˆ›å»ºé›†ç¾¤ 1 2 3 4 5 6 7 8 9 10 11 12 [root@k8s-master01 k8s-rabbitmq-cluster]# kubectl apply -f . statefulset.apps/rmq-cluster created configmap/rmq-cluster-config created persistentvolume/pv-rmq-1 created persistentvolume/pv-rmq-2 created persistentvolume/pv-rmq-3 created serviceaccount/rmq-cluster created role.rbac.authorization.k8s.io/rmq-cluster created rolebinding.rbac.authorization.k8s.io/rmq-cluster created secret/rmq-cluster-secret created service/rmq-cluster created service/rmq-cluster-balancer created æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼Œæ˜¾ç¤ºè¿™ä¸ªå°±æ˜¯æ­£å¸¸çš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 kubectl logs -f rmq-cluster-0 -n public-service \u0026#39;/etc/rabbitmq/rabbitmq.conf\u0026#39; -\u0026gt; \u0026#39;/var/lib/rabbitmq/rabbitmq.conf\u0026#39; 2021-03-11 02:24:03.469 [info] \u0026lt;0.9.0\u0026gt; Feature flags: list of feature flags found: 2021-03-11 02:24:03.469 [info] \u0026lt;0.9.0\u0026gt; Feature flags: feature flag states written to ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ 2021-03-11 02:24:04.273 [info] \u0026lt;0.692.0\u0026gt; Statistics database started. 2021-03-11 02:24:04.274 [info] \u0026lt;0.691.0\u0026gt; Starting worker pool \u0026#39;management_worker_pool\u0026#39; with 3 processes in it completed with 5 plugins. 2021-03-11 02:24:04.411 [info] \u0026lt;0.9.0\u0026gt; Server startup complete; 5 plugins started. * rabbitmq_management * rabbitmq_management_agent * rabbitmq_web_dispatch * rabbitmq_peer_discovery_k8s * rabbitmq_peer_discovery_common 2021-03-11 02:24:23.135 [info] \u0026lt;0.434.0\u0026gt; node \u0026#39;rabbit@rmq-cluster-1.rmq-cluster.public-service.svc.cluster.local\u0026#39; up 2021-03-11 02:24:23.904 [info] \u0026lt;0.434.0\u0026gt; rabbit on node \u0026#39;rabbit@rmq-cluster-1.rmq-cluster.public-service.svc.cluster.local\u0026#39; up 2021-03-11 02:24:44.524 [info] \u0026lt;0.434.0\u0026gt; node \u0026#39;rabbit@rmq-cluster-2.rmq-cluster.public-service.svc.cluster.local\u0026#39; up 2021-03-11 02:24:45.477 [info] \u0026lt;0.434.0\u0026gt; rabbit on node \u0026#39;rabbit@rmq-cluster-2.rmq-cluster.public-service.svc.cluster.local\u0026#39; up åˆ›å»ºèµ„æºå¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 [root@k8s-master01 ~]# kubectl get pod,sts,svc,ep,pv,pvc -n public-service NAME READY STATUS RESTARTS AGE pod/rmq-cluster-0 1/1 Running 0 8m10s pod/rmq-cluster-1 1/1 Running 0 7m34s pod/rmq-cluster-2 1/1 Running 0 7m18s NAME READY AGE statefulset.apps/rmq-cluster 3/3 8m11s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/rmq-cluster ClusterIP None \u0026lt;none\u0026gt; 5672/TCP 8m11s service/rmq-cluster-balancer NodePort 10.96.58.102 \u0026lt;none\u0026gt; 15672:31824/TCP,5672:31993/TCP 8m11s NAME ENDPOINTS AGE endpoints/rmq-cluster 10.244.32.129:5672,10.244.58.225:5672,10.244.85.246:5672 8m11s endpoints/rmq-cluster-balancer 10.244.32.129:5672,10.244.58.225:5672,10.244.85.246:5672 + 3 more... 8m11s NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE persistentvolume/pv-rmq-1 1Gi RWX Recycle Bound public-service/rabbitmq-storage-rmq-cluster-2 rmq-storage-class 8m11s persistentvolume/pv-rmq-2 1Gi RWX Recycle Bound public-service/rabbitmq-storage-rmq-cluster-1 rmq-storage-class 8m11s persistentvolume/pv-rmq-3 1Gi RWX Recycle Bound public-service/rabbitmq-storage-rmq-cluster-0 rmq-storage-class 8m11s persistentvolume/pv0001 2Gi RWO Recycle Bound default/test-pvc2 slow 9d NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE persistentvolumeclaim/rabbitmq-storage-rmq-cluster-0 Bound pv-rmq-3 1Gi RWX rmq-storage-class 8m11s persistentvolumeclaim/rabbitmq-storage-rmq-cluster-1 Bound pv-rmq-2 1Gi RWX rmq-storage-class 7m34s persistentvolumeclaim/rabbitmq-storage-rmq-cluster-2 Bound pv-rmq-1 1Gi RWX rmq-storage-class 7m18s [root@k8s-master01 ~]# ï¼ˆ5ï¼‰éªŒè¯é›†ç¾¤ å¯ä»¥é€šè¿‡svcçš„nodeportç«¯å£æš´éœ²ï¼Œæˆ–è€…ingressæ¥è®¿é—®rabbitmqå¯è§†åŒ–ç•Œé¢\n1 2 3 default_user = RABBITMQ_USER #è´¦å· default_pass = RABBITMQ_PASS #å¯†ç  ï¼ˆ6ï¼‰é›†ç¾¤æ‰©å®¹ï¼Œç¼©å®¹ æ‰©å®¹ï¼Œå¦‚æœä½¿ç”¨çš„pvï¼Œå»ºè®®æŸ¥çœ‹pvæ˜¯å¦å¤Ÿï¼Œä¸ç„¶çŠ¶æ€ä¸€ç›´æ˜¯pending\n1 2 3 kubectl scale statefulset -n public-service --replicas=4 rmq-cluster --replicas=4 æ”¹è¿™ä¸ªå€¼ï¼Œå°±å¯ä»¥ç”¨æ¥æ‰©å®¹å’Œç¼©å®¹ https://github.com/dotbalo/k8s/tree/master/k8s-rabbitmq-cluster\n","date":"2021-03-11T10:58:13Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/202103111058/","title":"Kubernetesé€šè¿‡æ’ä»¶ï¼Œè‡ªåŠ¨å‘ç°æ³¨å†ŒRabbitmqé›†ç¾¤"},{"content":"é€šè¿‡operatoréƒ¨ç½²redisé›†ç¾¤ operatoréƒ¨ç½²æœ‰çŠ¶æ€çš„åº”ç”¨ä¼šç®€å•å¾ˆå¤š\ngithubæ–‡æ¡£ï¼šhttps://github.com/ucloud/redis-cluster-operator#deploy-redis-cluster-operator\nRedis Cluster Operatoråœ¨Kubernetesä¸Šç®¡ç†Redis-Clusteré›†ç¾¤\næ¯ä¸ªä¸»èŠ‚ç‚¹åŠå…¶ä»èŠ‚ç‚¹éƒ½ç”±statefulSetç®¡ç†ï¼Œä¸ºæ¯ä¸ªstatefulSetåˆ›å»ºæ— å¤´svcï¼Œå¹¶ä¸ºæ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºclusterIPæœåŠ¡ã€‚\næ¯ä¸ªæœ‰çŠ¶æ€é›†éƒ½ä½¿ç”¨PodAntiAffinityæ¥ç¡®ä¿ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹åˆ†æ•£åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šã€‚åŒæ—¶ï¼Œå½“æ“ä½œå‘˜åœ¨æ¯ä¸ªæœ‰çŠ¶æ€é›†ä¸­é€‰æ‹©ä¸»èŠ‚ç‚¹æ—¶ï¼Œå®ƒä¼šä¼˜å…ˆé€‰æ‹©å…·æœ‰ä¸åŒk8sèŠ‚ç‚¹çš„å®¹å™¨ä½œä¸ºä¸»èŠ‚ç‚¹ã€‚\nï¼ˆ1ï¼‰ä¸‹è½½redis-cluster-operator 1 git clone https://github.com/ucloud/redis-cluster-operator.git åœ¨åç§°ç©ºé—´ï¼šredis-clusterä¸‹éƒ¨ç½²Redisé›†ç¾¤ï¼Œæ³¨æ„ä¿®æ”¹yamlæ–‡ä»¶çš„namespaceå‚æ•°\nåˆ›å»ºåç§°ç©ºé—´Namespaceï¼šredis-cluster\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@k8s-master01 redis-cluster-operator-master]# kubectl create ns redis-cluster namespace/redis-node created [root@k8s-master01 redis-cluster-operator-master]# kubectl get ns NAME STATUS AGE default Active 76d ingress-nginx Active 9d kube-node-lease Active 76d kube-public Active 76d kube-system Active 76d kube-users Active 2d21h kubernetes-dashboard Active 45h redis-cluster Active 11s rook-ceph Active 33h [root@k8s-master01 redis-cluster-op ï¼ˆ2ï¼‰åˆ›å»ºè‡ªå®šä¹‰èµ„æºï¼ˆCRDï¼‰ 1 2 3 [root@k8s-master01 redis]# kubectl apply -f deploy/crds/ customresourcedefinition.apiextensions.k8s.io/distributedredisclusters.redis.kun created customresourcedefinition.apiextensions.k8s.io/redisclusterbackups.redis.kun created ï¼ˆ3ï¼‰åˆ›å»ºoperator 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 [root@k8s-master01 redis]# kubectl create -f deploy/service_account.yaml serviceaccount/redis-cluster-operator created [root@k8s-master01 redis]# kubectl create -f deploy/cluster/cluster_role.yaml clusterrole.rbac.authorization.k8s.io/redis-cluster-operator created [root@k8s-master01 redis]# kubectl create -f deploy/cluster/cluster_role_binding.yaml clusterrolebinding.rbac.authorization.k8s.io/redis-cluster-operator created [root@k8s-master01 redis]# kubectl create -f deploy/cluster/operator.yaml deployment.apps/redis-cluster-operator created configmap/redis-admin created [root@k8s-master01 redis]# kubectl get deployment NAME READY UP-TO-DATE AVAILABLE AGE metrics-metrics-server 1/1 1 1 10d redis-cluster-operator 1/1 1 1 12s // cluster-scoped å‘½ä»¤ $ kubectl create -f deploy/service_account.yaml $ kubectl create -f deploy/cluster/cluster_role.yaml $ kubectl create -f deploy/cluster/cluster_role_binding.yaml $ kubectl create -f deploy/cluster/operator.yaml ï¼ˆ4ï¼‰éƒ¨ç½²æ ·æœ¬Redisé›†ç¾¤ æ³¨æ„ï¼šåªæœ‰ä½¿ç”¨æŒä¹…æ€§å­˜å‚¨ï¼ˆpvcï¼‰çš„redisé›†ç¾¤åœ¨æ„å¤–åˆ é™¤æˆ–æ»šåŠ¨æ›´æ–°åæ‰èƒ½æ¢å¤ã€‚å³ä½¿æ‚¨ä¸ä½¿ç”¨æŒä¹…æ€§ï¼ˆå¦‚rdbæˆ–aofï¼‰ï¼Œä¹Ÿéœ€è¦å°†pvcè®¾ç½®ä¸ºredisã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: redis.kun/v1alpha1 kind: DistributedRedisCluster metadata: annotations: # if your operator run as cluster-scoped, add this annotations redis.kun/scope: cluster-scoped name: example-distributedrediscluster spec: image: redis:5.0.4-alpine masterSize: 3 clusterReplicas: 1 resources: limits: cpu: 200m memory: 200Mi requests: cpu: 200m memory: 100Mi å› ä¸ºä½¿ç”¨æ ·æœ¬ï¼Œæ²¡æœ‰èµ„æºé™åˆ¶ï¼Œä¼šå› ä¸ºå†…å­˜ä¸è¶³å¯¼è‡´åˆå§‹åŒ–å¤±è´¥ï¼Œé™åˆ¶ä½¿ç”¨è¿™ä¸ªæµ‹è¯•\n1 kubectl create -f deploy/example/custom-resources.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 [root@k8s-master01 redis]# kubectl get pod,svc NAME READY STATUS RESTARTS AGE pod/drc-example-distributedrediscluster-0-0 1/1 Running 0 6m39s pod/drc-example-distributedrediscluster-0-1 1/1 Running 0 6m2s pod/drc-example-distributedrediscluster-1-0 1/1 Running 0 6m39s pod/drc-example-distributedrediscluster-1-1 1/1 Running 0 6m7s pod/drc-example-distributedrediscluster-2-0 1/1 Running 0 6m39s pod/drc-example-distributedrediscluster-2-1 1/1 Running 0 6m6s pod/metrics-metrics-server-6c7745d876-cw72h 1/1 Running 0 8h pod/redis-cluster-operator-7f6cf86475-dhttx 1/1 Running 0 11m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/example-distributedrediscluster ClusterIP 10.96.104.199 \u0026lt;none\u0026gt; 6379/TCP,16379/TCP 6m38s service/example-distributedrediscluster-0 ClusterIP None \u0026lt;none\u0026gt; 6379/TCP,16379/TCP 6m38s service/example-distributedrediscluster-1 ClusterIP None \u0026lt;none\u0026gt; 6379/TCP,16379/TCP 6m38s service/example-distributedrediscluster-2 ClusterIP None \u0026lt;none\u0026gt; 6379/TCP,16379/TCP 6m38s service/kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 76d service/metrics-metrics-server ClusterIP 10.96.86.164 \u0026lt;none\u0026gt; 443/TCP 10d service/nginx ClusterIP 10.96.215.251 \u0026lt;none\u0026gt; 80/TCP 9d service/redis-cluster-operator-metrics ClusterIP 10.96.58.127 \u0026lt;none\u0026gt; 8383/TCP,8686/TCP 11m [root@k8s-master01 redis]# åˆ›å»ºæŒ‡å®šå‘½åç©ºé—´å’ŒåŠ¨æ€å­˜å‚¨çš„ï¼Œæˆ‘è¿™ä¸ªæ²¡æœ‰æ„å»ºåŠ¨æ€å­˜å‚¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 cat redis-cluster.yaml apiVersion: redis.kun/v1alpha1 kind: DistributedRedisCluster metadata: annotations: # if your operator run as cluster-scoped, add this annotations redis.kun/scope: cluster-scoped name: example-distributedrediscluster namespace: redis-cluster spec: image: redis:5.0.4-alpine imagePullPolicy: IfNotPresent masterSize: 3\t#masterèŠ‚ç‚¹æ•°é‡ clusterReplicas: 1\t#æ¯ä¸ªmasterèŠ‚ç‚¹çš„ä»èŠ‚ç‚¹æ•°é‡ serviceName: redis-svc # resources config resources: limits: cpu: 300m memory: 200Mi requests: cpu: 200m memory: 150Mi # pv storage storage: type: persistent-claim size: 2Gi class: nfs-storage deleteClaim: true ]# kubectl apply -f redis-cluster.yaml ï¼ˆ5ï¼‰éªŒè¯é›†ç¾¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 [root@k8s-master01 redis]# kubectl exec -it drc-example-distributedrediscluster-0-0 -- sh /data # redis-cli -c -h redis-svc Could not connect to Redis at redis-svc:6379: Name does not resolve not connected\u0026gt; /data # redis-cli -c -h example-distributedrediscluster example-distributedrediscluster:6379\u0026gt; cluster info cluster_state:ok cluster_slots_assigned:16384 cluster_slots_ok:16384 cluster_slots_pfail:0 cluster_slots_fail:0 cluster_known_nodes:6 cluster_size:3 cluster_current_epoch:5 cluster_my_epoch:0 cluster_stats_messages_ping_sent:511 cluster_stats_messages_pong_sent:485 cluster_stats_messages_meet_sent:1 cluster_stats_messages_sent:997 cluster_stats_messages_ping_received:481 cluster_stats_messages_pong_received:512 cluster_stats_messages_meet_received:4 cluster_stats_messages_received:997 example-distributedrediscluster:6379\u0026gt; set a b -\u0026gt; Redirected to slot [15495] located at 10.244.58.209:6379 OK 10.244.58.209:6379\u0026gt; ï¼ˆ6ï¼‰æ‰©å±•Redisé›†ç¾¤ å¢åŠ masterSizeè§¦å‘æ”¾å¤§ã€‚ï¼ˆæ³¨æ„ï¼šè¿™ä¸ªä¹Ÿç›´æ¥å¯ä»¥ä½¿ç”¨editä¿®æ”¹ã€‚ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: redis.kun/v1alpha1 kind: DistributedRedisCluster metadata: annotations: # if your operator run as cluster-scoped, add this annotations redis.kun/scope: cluster-scoped name: example-distributedrediscluster spec: # Increase the masterSize to trigger the scaling. masterSize: 4 ClusterReplicas: 1 image: redis:5.0.4-alpine ï¼ˆ7ï¼‰ç¼©å‡Redisé›†ç¾¤ å‡å°masterSizeè§¦å‘ç¼©å°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: redis.kun/v1alpha1 kind: DistributedRedisCluster metadata: annotations: # if your operator run as cluster-scoped, add this annotations redis.kun/scope: cluster-scoped name: example-distributedrediscluster spec: # Increase the masterSize to trigger the scaling. masterSize: 3 ClusterReplicas: 1 image: redis:5.0.4-alpine ï¼ˆ8ï¼‰åˆ é™¤redisé›†ç¾¤ 1 2 3 4 5 6 7 8 9 ]# cd redis-cluster-operator/ ]# kubectl delete -f redis-cluster.yaml ]# cd cluster/ ]# kubectl delete -f operator.yaml ]# kubectl delete -f cluster_role_binding.yaml ]# kubectl delete -f cluster_role.yaml ]# kubectl delete -f service_account.yaml ]# kubectl delete -f deploy/crds/ ]# kubectl delete -f ns-redis-cluster.yaml githubæ–‡æ¡£ï¼šhttps://github.com/ucloud/redis-cluster-operator#deploy-redis-cluster-operator\n","date":"2021-03-09T21:43:40Z","image":"https://www.ownit.top/title_pic/32.jpg","permalink":"https://www.ownit.top/p/202103092143/","title":"Kubernetesä½¿ç”¨operatorå®‰è£…Redisé›†ç¾¤"},{"content":"Kubernetesé›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬æ—¶å¸¸è¦éƒ¨ç½²ä¸­é—´ä»¶ï¼Œnginxï¼Œredisç­‰ç­‰\né¦–å…ˆï¼Œè¿™äº›ä¸­é—´ä»¶è¦å®¹å™¨åŒ–ï¼Œæ‰å¯ä»¥éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ä¸­ã€‚\nï¼ˆ1ï¼‰ä¸€èˆ¬æˆ‘ä»¬åˆ°dockerhubå®˜æ–¹ï¼Œå¯»æ‰¾é•œåƒÂ https://hub.docker.com/search?q=redis\u0026type=image\nï¼ˆ2ï¼‰æˆ‘ä»¬å¯ä»¥è‡ªå·±å®šåˆ¶ï¼Œï¼Œå…¬å¸éœ€è¦çš„docker é•œåƒ\néƒ¨ç½²å•ä¸ªRedis\nï¼ˆ1ï¼‰é¦–å…ˆä¸‹è½½redisçš„é•œåƒï¼ˆç‰ˆæœ¬ï¼šï¼‰ 1 docker pull redis:5.0.4-alpine ï¼ˆ2ï¼‰ç¼–å†™configmap å› ä¸ºéœ€è¦æŒ‡å®šå‘½åç©ºé—´ redis-node\n1 kubectl create cm redis-node 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 apiVersion: v1 data: redis.conf: |- #heian bind 0.0.0.0 protected-mode yes port 6379 tcp-backlog 511 timeout 0 tcp-keepalive 300 daemonize no supervised no pidfile /var/run/redis_6379.pid loglevel notice logfile /var/log/redis.log databases 16 save 900 1 save 300 10 save 60 10000 stop-writes-on-bgsave-error yes rdbcompression yes rdbchecksum yes dbfilename dump.rdb dir /data slave-serve-stale-data yes slave-read-only yes repl-diskless-sync no repl-diskless-sync-delay 5 repl-disable-tcp-nodelay no slave-priority 100 appendonly no appendfilename \u0026#34;appendonly.aof\u0026#34; appendfsync everysec no-appendfsync-on-rewrite no auto-aof-rewrite-percentage 100 auto-aof-rewrite-min-size 64mb aof-load-truncated yes lua-time-limit 5000 slowlog-log-slower-than 10000 slowlog-max-len 128 latency-monitor-threshold 0 notify-keyspace-events \u0026#34;\u0026#34; hash-max-ziplist-entries 512 hash-max-ziplist-value 64 list-max-ziplist-size -2 list-compress-depth 0 set-max-intset-entries 512 zset-max-ziplist-entries 128 zset-max-ziplist-value 64 hll-sparse-max-bytes 3000 activerehashing yes client-output-buffer-limit normal 0 0 0 client-output-buffer-limit slave 256mb 64mb 60 client-output-buffer-limit pubsub 32mb 8mb 60 hz 10 aof-rewrite-incremental-fsync yes kind: ConfigMap metadata: name: redis-conf namespace: redis-node (3)ç¼–å†™å•ä¸ªredisçš„yamlæ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 apiVersion: apps/v1 kind: Deployment metadata: labels: app: redis-single-node name: redis-single-node namespace: redis-node spec: progressDeadlineSeconds: 600 replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: app: redis-single-node strategy: rollingUpdate: maxSurge: 1 maxUnavailable: 0 type: RollingUpdate template: metadata: labels: app: redis-single-node spec: containers: - command: - sh - -c - redis-server \u0026#34;/mnt/redis.conf\u0026#34; env: - name: TZ value: Asia/Shanghai - name: LANG value: C.UTF-8 image: redis:5.0.4-alpine imagePullPolicy: IfNotPresent lifecycle: {} livenessProbe: failureThreshold: 2 initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 tcpSocket: port: 6379 timeoutSeconds: 2 name: redis-single-node ports: - containerPort: 6379 name: web protocol: TCP readinessProbe: failureThreshold: 2 initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 tcpSocket: port: 6379 timeoutSeconds: 2 resources: limits: cpu: 100m memory: 339Mi requests: cpu: 10m memory: 10Mi securityContext: privileged: false runAsNonRoot: false terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumeMounts: - mountPath: /usr/share/zoneinfo/Asia/Shanghai name: tz-config - mountPath: /etc/localtime name: tz-config - mountPath: /etc/timezone name: timezone - mountPath: /mnt name: redis-conf readOnly: true dnsPolicy: ClusterFirst restartPolicy: Always schedulerName: default-scheduler securityContext: {} terminationGracePeriodSeconds: 30 tolerations: - effect: NoExecute key: node.kubernetes.io/unreachable operator: Exists tolerationSeconds: 30 - effect: NoExecute key: node.kubernetes.io/not-ready operator: Exists tolerationSeconds: 30 volumes: - hostPath: path: /usr/share/zoneinfo/Asia/Shanghai type: \u0026#34;\u0026#34; name: tz-config - hostPath: path: /etc/timezone type: \u0026#34;\u0026#34; name: timezone - configMap: defaultMode: 420 name: redis-conf name: redis-conf å› ä¸ºä¿®æ”¹configmapï¼Œä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œéœ€è¦åˆ é™¤å®¹å™¨æ‰ä¼šé‡æ–°åŠ è½½ã€‚æˆ‘è¿™è¾¹å°è¯•æŒ‚è½½configmapä¸ºæ–‡ä»¶ï¼ŒæŒ‡å®šå¯åŠ¨é…ç½®æ–‡ä»¶\n(4)æš´éœ²ç«¯å£ï¼Œservice è¿™è¾¹æˆ‘åšäº†serviceæš´éœ²ã€‚ç”¨çš„ClusterIPï¼Œæ¥ä¸‹æ¥å¯ä»¥é€šè¿‡ingressåŒ…è¿™ä¸ªipé€šè¿‡åŸŸåæ˜ å°„å‡ºå»\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 apiVersion: v1 kind: Service metadata: labels: app: redis-single-node spec: ports: - name: redis-port port: 6379 protocol: TCP targetPort: 6379 selector: app: redis-single-node sessionAffinity: None type: ClusterIP ","date":"2021-03-09T10:36:44Z","image":"https://www.ownit.top/title_pic/07.jpg","permalink":"https://www.ownit.top/p/202103091036/","title":"Kuberneteséƒ¨ç½²å•Redis"},{"content":"Rookï¼š\nä¸€ä¸ªè‡ªæˆ‘ç®¡ç†çš„åˆ†å¸ƒå¼å­˜å‚¨ç¼–æ’ç³»ç»Ÿï¼Œå®ƒæœ¬èº«å¹¶ä¸æ˜¯å­˜å‚¨ç³»ç»Ÿï¼Œåœ¨å­˜å‚¨å’Œk8sä¹‹å‰æ­å»ºäº†ä¸€ä¸ªæ¡¥æ¢ï¼Œå­˜å‚¨ç³»ç»Ÿçš„æ­å»ºæˆ–è€…ç»´æŠ¤å˜å¾—ç‰¹åˆ«ç®€å•ï¼ŒRookæ”¯æŒCSIï¼ŒCSIåšä¸€äº›PVCçš„å¿«ç…§ã€PVCæ‰©å®¹ç­‰æ“ä½œã€‚\nRookæ˜¯ä¸“ç”¨äºCloud-Nativeç¯å¢ƒçš„æ–‡ä»¶ã€å—ã€å¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚å®ƒå®ç°äº†ä¸€ä¸ªè‡ªæˆ‘ç®¡ç†çš„ã€è‡ªæˆ‘æ‰©å®¹çš„ã€è‡ªæˆ‘ä¿®å¤çš„åˆ†å¸ƒå¼å­˜å‚¨æœåŠ¡ã€‚\nRookæ”¯æŒè‡ªåŠ¨éƒ¨ç½²ã€å¯åŠ¨ã€é…ç½®ã€åˆ†é…ï¼ˆprovisioningï¼‰ã€æ‰©å®¹/ç¼©å®¹ã€å‡çº§ã€è¿ç§»ã€ç¾éš¾æ¢å¤ã€ç›‘æ§ï¼Œä»¥åŠèµ„æºç®¡ç†ã€‚ ä¸ºäº†å®ç°æ‰€æœ‰è¿™äº›åŠŸèƒ½ï¼ŒRookä¾èµ–åº•å±‚çš„å®¹å™¨ç¼–æ’å¹³å°ã€‚\nç›®å‰Rookä»ç„¶å¤„äºAlphaç‰ˆæœ¬ï¼ŒåˆæœŸä¸“æ³¨äºKubernetes+Cephã€‚Cephæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œæ”¯æŒæ–‡ä»¶ã€å—ã€å¯¹è±¡å­˜å‚¨ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¢«å¹¿æ³›åº”ç”¨ã€‚\nOperatorï¼šä¸»è¦ç”¨äºæœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œæˆ–è€…ç”¨äºæ¯”è¾ƒå¤æ‚åº”ç”¨çš„ç®¡ç†ã€‚\nHelmï¼šä¸»è¦ç”¨äºæ— çŠ¶æ€çš„æœåŠ¡ï¼Œé…ç½®åˆ†ç¦»ã€‚Â Rookï¼š\nAgentï¼šåœ¨æ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç”¨äºé…ç½®ä¸€ä¸ªFlexVolumeæ’ä»¶ï¼Œå’Œk8sçš„å­˜å‚¨å·è¿›è¡Œé›†æˆã€‚æŒ‚è½½ç½‘ç»œå­˜å‚¨ã€åŠ è½½å­˜å‚¨å·ã€æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿã€‚\nDiscoverï¼šä¸»è¦ç”¨äºæ£€æµ‹é“¾æ¥åˆ°å­˜å‚¨èŠ‚ç‚¹ä¸Šçš„å­˜å‚¨è®¾å¤‡ã€‚\nCephï¼š\nOSDï¼šç›´æ¥è¿æ¥æ¯ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹çš„ç‰©ç†ç£ç›˜æˆ–è€…æ˜¯ç›®å½•ã€‚é›†ç¾¤çš„å‰¯æœ¬æ•°ã€é«˜å¯ç”¨æ€§å’Œå®¹é”™æ€§ã€‚\nMONï¼šé›†ç¾¤ç›‘æ§ï¼Œæ‰€æœ‰é›†ç¾¤çš„èŠ‚ç‚¹éƒ½ä¼šå‘Monæ±‡æŠ¥ã€‚ä»–è®°å½•äº†é›†ç¾¤çš„æ‹“æ‰‘ä»¥åŠæ•°æ®å­˜å‚¨ä½ç½®çš„ä¿¡æ¯ã€‚\nMDSï¼šå…ƒæ•°æ®æœåŠ¡å™¨ï¼Œè´Ÿè´£è·Ÿè¸ªæ–‡ä»¶å±‚æ¬¡ç»“æ„å¹¶å­˜å‚¨cephå…ƒæ•°æ®ã€‚\nRGWï¼šrestful APIæ¥å£ã€‚\nMGRï¼šæä¾›é¢å¤–çš„ç›‘æ§å’Œç•Œé¢ã€‚\nRook å®˜æ–¹æ–‡æ¡£:https://rook.io/docs/rook/v1.5/ceph-quickstart.html\nç¯å¢ƒéƒ¨ç½²\n1 2 3 4 5 6 git clone --single-branch --branch v1.5.8 https://github.com/rook/rook.git cd rook/cluster/examples/kubernetes/ceph kubectl create -f crds.yaml -f common.yaml -f operator.yaml ä¿®æ”¹cluster.yamlæ–‡ä»¶ kubectl create -f cluster.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 vim cluster.yaml storage: # cluster level storage configuration and selection useAllNodes: false #æ‰€æœ‰ç»“èŠ‚ä¸ºå­˜å‚¨èŠ‚ç‚¹ï¼Œæ”¹ä¸ºfalse useAllDevices: false #ä½¿ç”¨æ‰€æœ‰çš„ç£ç›˜ æ”¹ä¸ºfalse nodes: - name: \u0026#34;k8s-node02\u0026#34; devices: # specific devices to use for storage can be specified for each node - name: \u0026#34;sdb\u0026#34; #k8s-node02æ–°åŠ çš„è£¸ç›˜ - name: \u0026#34;k8s-node01\u0026#34; directories: - path: \u0026#34;/data/ceph\u0026#34; rookçš„dashboardï¼šÂ https://rook.io/docs/rook/v1.5/ceph-dashboard.html\n1 2 3 4 kubectl -n rook-ceph get service NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE rook-ceph-mgr ClusterIP 10.108.111.192 \u0026lt;none\u0026gt; 9283/TCP 3h rook-ceph-mgr-dashboard ClusterIP 10.110.113.240 \u0026lt;none\u0026gt; 8443/TCP 3h ç¬¬ä¸€é¡¹æœåŠ¡ç”¨äºæŠ¥å‘ŠPrometheusæŒ‡æ ‡ï¼Œè€Œåä¸€é¡¹æœåŠ¡ç”¨äºä»ªè¡¨æ¿ã€‚å¦‚æœæ‚¨åœ¨é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¸Šï¼Œåˆ™å¯ä»¥é€šè¿‡ä½¿ç”¨æœåŠ¡çš„DNSåç§°https://rook-ceph-mgr-dashboard-https:8443æˆ–é€šè¿‡è¿æ¥åˆ°é›†ç¾¤IPï¼ˆåœ¨æœ¬ç¤ºä¾‹ä¸­ä¸ºï¼‰æ¥è¿æ¥åˆ°ä»ªè¡¨æ¿https://10.110.113.240:8443ã€‚æˆ–è€…ä½¿ç”¨NodePortæš´éœ²ç«¯å£ä½¿ç”¨\næŸ¥è¯¢å¯†ç \n1 kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=\u0026#34;{[\u0026#39;data\u0026#39;][\u0026#39;password\u0026#39;]}\u0026#34; | base64 --decode \u0026amp;\u0026amp; echo ","date":"2021-03-08T22:05:09Z","image":"https://www.ownit.top/title_pic/65.jpg","permalink":"https://www.ownit.top/p/202103082205/","title":"Kubernetesæ­å»ºRooK+Ceph"},{"content":"ä¸€ã€ä»€ä¹ˆæ˜¯Qos 1 2 QoSç±»æ˜¯Kubernetesç”¨æ¥å†³å®šPodçš„è°ƒåº¦å’Œé©±é€çš„ç­–ç•¥ æœ¬æ–‡ä»‹ç»æ€æ ·é…ç½®Podè®©å…¶è·å¾—ç‰¹å®šçš„æœåŠ¡è´¨é‡ï¼ˆQoSï¼‰ç±» äºŒã€QoSçº§åˆ« 2.1ã€QoSçº§åˆ«\nGuaranteedï¼šPODä¸­æ‰€æœ‰å®¹å™¨éƒ½å¿…é¡»ç»Ÿä¸€è®¾ç½®äº†limitsï¼Œå¹¶ä¸”è®¾ç½®å‚æ•°éƒ½ä¸€è‡´ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå®¹å™¨è¦è®¾ç½®requestsï¼Œé‚£ä¹ˆæ‰€æœ‰å®¹å™¨éƒ½è¦è®¾ç½®ï¼Œå¹¶è®¾ç½®å‚æ•°åŒlimitsä¸€è‡´ Burstableï¼šPODä¸­åªè¦æœ‰ä¸€ä¸ªå®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨requestså’Œlimitsçš„è®¾ç½®åŒå…¶ä»–å®¹å™¨è®¾ç½®çš„ä¸ä¸€è‡´ BestEffortï¼šPODä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½æ²¡æœ‰æŒ‡å®šCPUå’Œå†…å­˜çš„requestså’Œlimits åˆ é™¤ç­–ç•¥ï¼šå…ˆåˆ é™¤æœåŠ¡è´¨é‡ä¸ºBestEffortï¼Œç„¶ååœ¨åˆ é™¤Burstableï¼ŒGuaranteedæœ€åè¢«åˆ é™¤\nä¸‰ã€ä¸¾ä¾‹è¯´æ˜ 3.0ã€åˆ›å»ºå‘½åç©ºé—´\nåˆ›å»ºä¸€ä¸ªå‘½åç©ºé—´ï¼Œä»¥ä¾¿å°†æœ¬ç»ƒä¹ æ‰€åˆ›å»ºçš„èµ„æºä¸é›†ç¾¤çš„å…¶ä½™èµ„æºç›¸éš”ç¦»\n1 kubectl create namespace qos-example åˆ›å»ºä¸€ä¸ª QoS ç±»ä¸º Guaranteed çš„ Pod å¯¹äº QoS ç±»ä¸º Guaranteed çš„ Podï¼š\nPod ä¸­çš„æ¯ä¸ªå®¹å™¨ï¼ŒåŒ…å«åˆå§‹åŒ–å®¹å™¨ï¼Œå¿…é¡»æŒ‡å®šå†…å­˜è¯·æ±‚å’Œå†…å­˜é™åˆ¶ï¼Œå¹¶ä¸”ä¸¤è€…è¦ç›¸ç­‰ã€‚ Pod ä¸­çš„æ¯ä¸ªå®¹å™¨ï¼ŒåŒ…å«åˆå§‹åŒ–å®¹å™¨ï¼Œå¿…é¡»æŒ‡å®š CPU è¯·æ±‚å’Œ CPU é™åˆ¶ï¼Œå¹¶ä¸”ä¸¤è€…è¦ç›¸ç­‰ã€‚ ä¸‹é¢æ˜¯åŒ…å«ä¸€ä¸ªå®¹å™¨çš„ Pod é…ç½®æ–‡ä»¶ã€‚ å®¹å™¨è®¾ç½®äº†å†…å­˜è¯·æ±‚å’Œå†…å­˜é™åˆ¶ï¼Œå€¼éƒ½æ˜¯ 200 MiBã€‚ å®¹å™¨è®¾ç½®äº† CPU è¯·æ±‚å’Œ CPU é™åˆ¶ï¼Œå€¼éƒ½æ˜¯ 700 milliCPUï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 apiVersion: v1 kind: Pod metadata: name: qos-demo namespace: qos-example spec: containers: - name: qos-demo-ctr image: nginx resources: limits: memory: \u0026#34;200Mi\u0026#34; cpu: \u0026#34;700m\u0026#34; requests: memory: \u0026#34;200Mi\u0026#34; cpu: \u0026#34;700m\u0026#34; ç»“æœè¡¨æ˜ Kubernetes ä¸º Pod é…ç½®çš„ QoS ç±»ä¸º Guaranteedã€‚ ç»“æœä¹Ÿç¡®è®¤äº† Pod å®¹å™¨è®¾ç½®äº†ä¸å†…å­˜é™åˆ¶åŒ¹é…çš„å†…å­˜è¯·æ±‚ï¼Œè®¾ç½®äº†ä¸ CPU é™åˆ¶åŒ¹é…çš„ CPU è¯·æ±‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 root@k8s-master01 ~]# kubectl get pod qos-demo --namespace=qos-example --output=yaml spec: containers: - image: nginx:1.15.2 imagePullPolicy: IfNotPresent name: qos-demo-ctr resources: limits: cpu: 700m memory: 200Mi requests: cpu: 700m memory: 200Mi ............ status: qosClass: Guaranteed # 4ã€åˆ é™¤Pod [root@k8s-master01 ~]# kubectl delete pod qos-demo --namespace=qos-example pod \u0026#34;qos-demo\u0026#34; deleted è¯´æ˜ï¼šÂ å¦‚æœå®¹å™¨æŒ‡å®šäº†è‡ªå·±çš„å†…å­˜é™åˆ¶ï¼Œä½†æ²¡æœ‰æŒ‡å®šå†…å­˜è¯·æ±‚ï¼ŒKubernetes ä¼šè‡ªåŠ¨ä¸ºå®ƒæŒ‡å®šä¸å†…å­˜é™åˆ¶åŒ¹é…çš„å†…å­˜è¯·æ±‚ã€‚ åŒæ ·ï¼Œå¦‚æœå®¹å™¨æŒ‡å®šäº†è‡ªå·±çš„ CPU é™åˆ¶ï¼Œä½†æ²¡æœ‰æŒ‡å®š CPU è¯·æ±‚ï¼ŒKubernetes ä¼šè‡ªåŠ¨ä¸ºå®ƒæŒ‡å®šä¸ CPU é™åˆ¶åŒ¹é…çš„ CPU è¯·æ±‚\n3.2ã€åˆ›å»ºä¸€ä¸ª QoS ç±»ä¸º Burstable çš„ Pod\nå¦‚æœæ»¡è¶³ä¸‹é¢æ¡ä»¶ï¼Œå°†ä¼šæŒ‡å®š Pod çš„ QoS ç±»ä¸º Burstableï¼š\nPod ä¸ç¬¦åˆ Guaranteed QoS ç±»çš„æ ‡å‡†ã€‚ Pod ä¸­è‡³å°‘ä¸€ä¸ªå®¹å™¨å…·æœ‰å†…å­˜æˆ– CPU è¯·æ±‚ã€‚ ä¸‹é¢æ˜¯åŒ…å«ä¸€ä¸ªå®¹å™¨çš„ Pod é…ç½®æ–‡ä»¶ã€‚ å®¹å™¨è®¾ç½®äº†å†…å­˜é™åˆ¶ 200 MiB å’Œå†…å­˜è¯·æ±‚ 100 MiBã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 apiVersion: v1 kind: Pod metadata: name: qos-demo-2 namespace: qos-example spec: containers: - name: qos-demo-2-ctr image: nginx resources: limits: memory: \u0026#34;200Mi\u0026#34; requests: memory: \u0026#34;100Mi\u0026#34; # ç»“æœè¡¨æ˜ Kubernetes ä¸º Pod é…ç½®çš„ QoS ç±»ä¸º Guaranteedã€‚ ç»“æœä¹Ÿç¡®è®¤äº† Pod å®¹å™¨è®¾ç½®äº†ä¸å†…å­˜é™åˆ¶åŒ¹é…çš„å†…å­˜è¯·æ±‚ï¼Œè®¾ç½®äº†ä¸ CPU é™åˆ¶åŒ¹é…çš„ CPU è¯·æ±‚ã€‚ spec: containers: ... resources: limits: cpu: 700m memory: 200Mi requests: cpu: 700m memory: 200Mi ...... status: qosClass: Guaranteed 3.3ã€åˆ›å»ºä¸€ä¸ª QoS ç±»ä¸º BestEffort çš„ Pod\nå¯¹äº QoS ç±»ä¸º BestEffort çš„ Podï¼ŒPod ä¸­çš„å®¹å™¨å¿…é¡»æ²¡æœ‰è®¾ç½®å†…å­˜å’Œ CPU é™åˆ¶æˆ–è¯·æ±‚ ä¸‹é¢æ˜¯åŒ…å«ä¸€ä¸ªå®¹å™¨çš„ Pod é…ç½®æ–‡ä»¶ã€‚ å®¹å™¨æ²¡æœ‰è®¾ç½®å†…å­˜å’Œ CPU é™åˆ¶æˆ–è¯·æ±‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 kind: Pod metadata: name: qos-demo-3 namespace: qos-example spec: containers: - name: qos-demo-3-ctr image: nginx # ç»“æœè¡¨æ˜ Kubernetes ä¸º Pod é…ç½®çš„ QoS ç±»ä¸º BestEffortã€‚ spec: containers: ... resources: {} ... status: qosClass: BestEffort 3.4ã€åˆ›å»ºåŒ…å«ä¸¤ä¸ªå®¹å™¨çš„ Pod\nä¸‹é¢æ˜¯åŒ…å«ä¸¤ä¸ªå®¹å™¨çš„ Pod é…ç½®æ–‡ä»¶ã€‚ ä¸€ä¸ªå®¹å™¨æŒ‡å®šäº†å†…å­˜è¯·æ±‚ 200 MiBã€‚ å¦å¤–ä¸€ä¸ªå®¹å™¨æ²¡æœ‰æŒ‡å®šä»»ä½•è¯·æ±‚å’Œé™åˆ¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 apiVersion: v1 kind: Pod metadata: name: qos-demo-4 namespace: qos-example spec: containers: - name: qos-demo-4-ctr-1 image: nginx resources: requests: memory: \u0026#34;200Mi\u0026#34; - name: qos-demo-4-ctr-2 image: redis # ç»“æœè¡¨æ˜ spec: containers: ... name: qos-demo-4-ctr-1 resources: requests: memory: 200Mi ... name: qos-demo-4-ctr-2 resources: {} ... status: qosClass: Burstable æ³¨æ„æ­¤ Pod æ»¡è¶³ Burstable QoS ç±»çš„æ ‡å‡†ã€‚ ä¹Ÿå°±æ˜¯è¯´å®ƒä¸æ»¡è¶³ Guaranteed QoS ç±»æ ‡å‡†ï¼Œå› ä¸ºå®ƒçš„ä¸€ä¸ªå®¹å™¨è®¾æœ‰å†…å­˜è¯·æ±‚ã€‚\nåŸæ–‡åœ°å€ï¼šhttps://kubernetes.io/zh/docs/tasks/configure-pod-container/quality-service-pod/\n","date":"2021-03-07T17:40:02Z","image":"https://www.ownit.top/title_pic/46.jpg","permalink":"https://www.ownit.top/p/202103071740/","title":"Kubernetesçš„æœåŠ¡è´¨é‡ï¼ˆQoSï¼‰"},{"content":"ä¸€ã€ä»€ä¹ˆæ˜¯K8Sä¹‹å‡†å…¥æ§åˆ¶ 1 å°±æ˜¯åœ¨åˆ›å»ºèµ„æºç»è¿‡èº«ä»½éªŒè¯ä¹‹åï¼Œkube-apiserveråœ¨æ•°æ®å†™å…¥etcdä¹‹å‰åšä¸€æ¬¡æ‹¦æˆªï¼Œç„¶åå¯¹èµ„æºè¿›è¡Œæ›´æ”¹ã€åˆ¤æ–­æ­£ç¡®æ€§ç­‰æ“ä½œã€‚ ä¸€ä¸ªÂ LimitRangeï¼ˆé™åˆ¶èŒƒå›´ï¼‰Â å¯¹è±¡æä¾›çš„é™åˆ¶èƒ½å¤Ÿåšåˆ°ï¼š\nåœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸­å®æ–½å¯¹æ¯ä¸ª Pod æˆ– Container æœ€å°å’Œæœ€å¤§çš„èµ„æºä½¿ç”¨é‡çš„é™åˆ¶ã€‚ åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸­å®æ–½å¯¹æ¯ä¸ª PersistentVolumeClaim èƒ½ç”³è¯·çš„æœ€å°å’Œæœ€å¤§çš„å­˜å‚¨ç©ºé—´å¤§å°çš„é™åˆ¶ã€‚ åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸­å®æ–½å¯¹ä¸€ç§èµ„æºçš„ç”³è¯·å€¼å’Œé™åˆ¶å€¼çš„æ¯”å€¼çš„æ§åˆ¶ã€‚ è®¾ç½®ä¸€ä¸ªå‘½åç©ºé—´ä¸­å¯¹è®¡ç®—èµ„æºçš„é»˜è®¤ç”³è¯·/é™åˆ¶å€¼ï¼Œå¹¶ä¸”è‡ªåŠ¨çš„åœ¨è¿è¡Œæ—¶æ³¨å…¥åˆ°å¤šä¸ª Container ä¸­ã€‚ äºŒã€å¯ç”¨ LimitRang å¯¹ LimitRange çš„æ”¯æŒè‡ª Kubernetes 1.10 ç‰ˆæœ¬é»˜è®¤å¯ç”¨ã€‚ LimitRange æ”¯æŒåœ¨å¾ˆå¤š Kubernetes å‘è¡Œç‰ˆæœ¬ä¸­ä¹Ÿæ˜¯é»˜è®¤å¯ç”¨çš„ã€‚ LimitRange çš„åç§°å¿…é¡»æ˜¯åˆæ³•çš„Â DNS å­åŸŸåã€‚ ä¸‰ã€é™åˆ¶èŒƒå›´æ€»è§ˆ ç®¡ç†å‘˜åœ¨ä¸€ä¸ªå‘½åç©ºé—´å†…åˆ›å»ºä¸€ä¸ªÂ LimitRangeÂ å¯¹è±¡ã€‚ ç”¨æˆ·åœ¨å‘½åç©ºé—´å†…åˆ›å»º Pod ï¼ŒContainer å’Œ PersistentVolumeClaim ç­‰èµ„æºã€‚ LimitRangerÂ å‡†å…¥æ§åˆ¶å™¨å¯¹æ‰€æœ‰æ²¡æœ‰è®¾ç½®è®¡ç®—èµ„æºéœ€æ±‚çš„ Pod å’Œ Container è®¾ç½®é»˜è®¤å€¼ä¸é™åˆ¶å€¼ï¼Œ å¹¶è·Ÿè¸ªå…¶ä½¿ç”¨é‡ä»¥ä¿è¯æ²¡æœ‰è¶…å‡ºå‘½åç©ºé—´ä¸­å­˜åœ¨çš„ä»»æ„ LimitRange å¯¹è±¡ä¸­çš„æœ€å°ã€æœ€å¤§èµ„æºä½¿ç”¨é‡ä»¥åŠä½¿ç”¨é‡æ¯”å€¼ã€‚ è‹¥åˆ›å»ºæˆ–æ›´æ–°èµ„æºï¼ˆPodã€ Containerã€PersistentVolumeClaimï¼‰è¿åäº† LimitRange çš„çº¦æŸï¼Œ å‘ API æœåŠ¡å™¨çš„è¯·æ±‚ä¼šå¤±è´¥ï¼Œå¹¶è¿”å› HTTP çŠ¶æ€ç Â 403 FORBIDDENÂ ä¸æè¿°å“ªä¸€é¡¹çº¦æŸè¢«è¿åçš„æ¶ˆæ¯ã€‚ è‹¥å‘½åç©ºé—´ä¸­çš„ LimitRange å¯ç”¨äº†å¯¹Â cpuÂ å’ŒÂ memoryÂ çš„é™åˆ¶ï¼Œ ç”¨æˆ·å¿…é¡»æŒ‡å®šè¿™äº›å€¼çš„éœ€æ±‚ä½¿ç”¨é‡ä¸é™åˆ¶ä½¿ç”¨é‡ã€‚å¦åˆ™ï¼Œç³»ç»Ÿå°†ä¼šæ‹’ç»åˆ›å»º Podã€‚ LimitRange çš„éªŒè¯ä»…åœ¨ Pod å‡†å…¥é˜¶æ®µè¿›è¡Œï¼Œä¸å¯¹æ­£åœ¨è¿è¡Œçš„ Pod è¿›è¡ŒéªŒè¯ã€‚ èƒ½å¤Ÿä½¿ç”¨é™åˆ¶èŒƒå›´åˆ›å»ºçš„ç­–ç•¥ç¤ºä¾‹æœ‰ï¼š\nåœ¨ä¸€ä¸ªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œ8 GiB å†…å­˜ä¸16ä¸ªæ ¸çš„é›†ç¾¤ä¸­ï¼Œé™åˆ¶ä¸€ä¸ªå‘½åç©ºé—´çš„ Pod ç”³è¯· 100m å•ä½ï¼Œæœ€å¤§ 500m å•ä½çš„ CPUï¼Œä»¥åŠç”³è¯· 200Miï¼Œæœ€å¤§ 600Mi çš„å†…å­˜ã€‚ ä¸º spec ä¸­æ²¡æœ‰ cpu å’Œå†…å­˜éœ€æ±‚å€¼çš„ Container å®šä¹‰é»˜è®¤ CPU é™åˆ¶å€¼ä¸éœ€æ±‚å€¼ 150mï¼Œå†…å­˜é»˜è®¤éœ€æ±‚å€¼ 300Miã€‚ åœ¨å‘½åç©ºé—´çš„æ€»é™åˆ¶å€¼å°äº Pod æˆ– Container çš„é™åˆ¶å€¼çš„æ€»å’Œçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šäº§ç”Ÿèµ„æºç«äº‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†ä¸ä¼šåˆ›å»º Container æˆ– Podã€‚\nç«äº‰å’Œå¯¹ LimitRange çš„æ”¹å˜éƒ½ä¸ä¼šå½±å“ä»»ä½•å·²ç»åˆ›å»ºäº†çš„èµ„æº\nå››ã€é…ç½®LimitRangeï¼ˆå¯¹Podè¿›è¡Œé…ç½®ã€é™é¢ï¼‰ 4.1ã€é…ç½® CPU æœ€å°å’Œæœ€å¤§çº¦æŸ\n1 2 3 # åˆ›å»ºä¸€ä¸ªå‘½åç©ºé—´ï¼Œä»¥ä¾¿æœ¬ç»ƒä¹ ä¸­åˆ›å»ºçš„èµ„æºå’Œé›†ç¾¤çš„å…¶ä½™èµ„æºç›¸éš”ç¦» [root@k8s-master01 ~]# kubectl create namespace constraints-cpu-example namespace/constraints-cpu-example created 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 # 1ã€LimitRange çš„é…ç½®æ–‡ä»¶ [root@k8s-master01 ~]# cat cpu-constraints.yaml apiVersion: v1 kind: LimitRange metadata: name: cpu-min-max-demo-lr spec: limits: - max: cpu: \u0026#34;800m\u0026#34; min: cpu: \u0026#34;200m\u0026#34; type: Container # 2ã€åˆ›å»º LimitRange: [root@k8s-master01 ~]# kubectl apply -f cpu-constraints.yaml -n constraints-cpu-example limitrange/cpu-min-max-demo-lr created # 3ã€æŸ¥çœ‹ç»“æœ # è¾“å‡ºç»“æœæ˜¾ç¤º CPU çš„æœ€å°å’Œæœ€å¤§é™åˆ¶ç¬¦åˆé¢„æœŸã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡ä½ åœ¨ LimitRange çš„é…ç½®æ–‡ä»¶ä¸­ä½ æ²¡æœ‰å£°æ˜é»˜è®¤å€¼ï¼Œé»˜è®¤å€¼ä¹Ÿä¼šè¢«è‡ªåŠ¨åˆ›å»ºã€‚ [root@k8s-master01 ~]# kubectl get limitrange cpu-min-max-demo-lr --output=yaml --namespace=constraints-cpu-example # åªåˆ—å‡ºå…³é”®çš„ spec: limits: - default: cpu: 800m defaultRequest: cpu: 800m max: cpu: 800m min: cpu: 200m type: Container ç°åœ¨ä¸ç®¡ä»€ä¹ˆæ—¶å€™åœ¨ constraints-cpu-example å‘½åç©ºé—´ä¸­åˆ›å»ºå®¹å™¨ï¼ŒKubernetes éƒ½ä¼šæ‰§è¡Œä¸‹é¢è¿™äº›æ­¥éª¤ï¼š\nå¦‚æœå®¹å™¨æ²¡æœ‰å£°æ˜è‡ªå·±çš„ CPU è¯·æ±‚å’Œé™åˆ¶ï¼Œå°†ä¸ºå®¹å™¨æŒ‡å®šé»˜è®¤ CPU è¯·æ±‚å’Œé™åˆ¶ã€‚ æ ¸æŸ¥å®¹å™¨å£°æ˜çš„ CPU è¯·æ±‚ç¡®ä¿å…¶å¤§äºæˆ–è€…ç­‰äº 200 millicpuã€‚ æ ¸æŸ¥å®¹å™¨å£°æ˜çš„ CPU é™åˆ¶ç¡®ä¿å…¶å°äºæˆ–è€…ç­‰äº 800 millicpuã€‚ æµç¨‹å°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªnamespace=constraints-cpu-exampleçš„åç§°ç©ºé—´ï¼Œç„¶ååœ¨è¿™ä¸ªåç§°ç©ºé—´åˆ›å»ºäº†ä¸€ä¸ªLimitRangeã€‚ç„¶åç°åœ¨ä¸ç®¡ä»€ä¹ˆæ—¶å€™åœ¨ constraints-cpu-example å‘½åç©ºé—´ä¸­åˆ›å»ºå®¹å™¨ï¼ŒKubernetes éƒ½ä¼šæ‰§è¡Œä¸Šé¢é‚£äº›æ­¥éª¤ï¼æˆ‘ä»¬åˆ›å»ºçš„LimitRangeå¯¹è¿™ä¸ªnamespace=constraints-cpu-exampleçš„åç§°ç©ºé—´é‡Œé¢èµ·ä½è°ƒPodéƒ½èµ·äº†é™åˆ¶çš„ä½œç”¨\n4.2ã€é…ç½®å‘½åç©ºé—´çš„æœ€å°å’Œæœ€å¤§å†…å­˜çº¦æŸ\nLimitRange çš„é…ç½®æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 apiVersion: v1 kind: LimitRange metadata: name: mem-min-max-demo-lr spec: limits: - max: memory: 1Gi min: memory: 500Mi type: Container # è¾“å‡ºæ˜¾ç¤ºé¢„æœŸçš„æœ€å°å’Œæœ€å¤§å†…å­˜çº¦æŸã€‚ ä½†è¯·æ³¨æ„ï¼Œå³ä½¿ä½ æ²¡æœ‰åœ¨ LimitRange çš„é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šé»˜è®¤å€¼ï¼Œä¹Ÿä¼šè‡ªåŠ¨åˆ›å»ºå®ƒä»¬ã€‚ limits: - default: memory: 1Gi defaultRequest: memory: 1Gi max: memory: 1Gi min: memory: 500Mi type: Container ç°åœ¨ï¼Œåªè¦åœ¨ constraints-mem-example å‘½åç©ºé—´ä¸­åˆ›å»ºå®¹å™¨ï¼ŒKubernetes å°±ä¼šæ‰§è¡Œä¸‹é¢çš„æ­¥éª¤ï¼š\nå¦‚æœ Container æœªæŒ‡å®šè‡ªå·±çš„å†…å­˜è¯·æ±‚å’Œé™åˆ¶ï¼Œå°†ä¸ºå®ƒæŒ‡å®šé»˜è®¤çš„å†…å­˜è¯·æ±‚å’Œé™åˆ¶ã€‚ éªŒè¯ Container çš„å†…å­˜è¯·æ±‚æ˜¯å¦å¤§äºæˆ–ç­‰äº500 MiBã€‚ éªŒè¯ Container çš„å†…å­˜é™åˆ¶æ˜¯å¦å°äºæˆ–ç­‰äº1 GiBã€‚ 4.3ã€é…ç½® CPU æœ€å°å’Œæœ€å¤§çº¦æŸ\nLimitRange çš„é…ç½®æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 apiVersion: v1 kind: LimitRange metadata: name: cpu-min-max-demo-lr spec: limits: - max: cpu: \u0026#34;800m\u0026#34; min: cpu: \u0026#34;200m\u0026#34; type: Container # è¾“å‡ºç»“æœæ˜¾ç¤º CPU çš„æœ€å°å’Œæœ€å¤§é™åˆ¶ç¬¦åˆé¢„æœŸã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡ä½ åœ¨ LimitRange çš„é…ç½®æ–‡ä»¶ä¸­ä½ æ²¡æœ‰å£°æ˜é»˜è®¤å€¼ï¼Œé»˜è®¤å€¼ä¹Ÿä¼šè¢«è‡ªåŠ¨åˆ›å»ºã€‚ limits: - default: cpu: 800m defaultRequest: cpu: 800m max: cpu: 800m min: cpu: 200m type: Container åœ¨ä¸ç®¡ä»€ä¹ˆæ—¶å€™åœ¨ constraints-cpu-example å‘½åç©ºé—´ä¸­åˆ›å»ºå®¹å™¨ï¼ŒKubernetes éƒ½ä¼šæ‰§è¡Œä¸‹é¢è¿™äº›æ­¥éª¤ï¼š\nå¦‚æœå®¹å™¨æ²¡æœ‰å£°æ˜è‡ªå·±çš„ CPU è¯·æ±‚å’Œé™åˆ¶ï¼Œå°†ä¸ºå®¹å™¨æŒ‡å®šé»˜è®¤ CPU è¯·æ±‚å’Œé™åˆ¶ã€‚ æ ¸æŸ¥å®¹å™¨å£°æ˜çš„ CPU è¯·æ±‚ç¡®ä¿å…¶å¤§äºæˆ–è€…ç­‰äº 200 millicpuã€‚ æ ¸æŸ¥å®¹å™¨å£°æ˜çš„ CPU é™åˆ¶ç¡®ä¿å…¶å°äºæˆ–è€…ç­‰äº 800 millicpuã€‚ è¯´æ˜ï¼šÂ å½“åˆ›å»º LimitRange å¯¹è±¡æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥å£°æ˜å¤§é¡µé¢å’Œ GPU çš„é™åˆ¶ã€‚ å½“è¿™äº›èµ„æºåŒæ—¶å£°æ˜äº† \u0026lsquo;default\u0026rsquo; å’Œ \u0026lsquo;defaultRequest\u0026rsquo; å‚æ•°æ—¶ï¼Œä¸¤ä¸ªå‚æ•°å€¼å¿…é¡»ç›¸åŒã€‚\näº”ã€ResourceQuotï¼ˆå¯¹åç§°ç©ºé—´è¿›è¡Œé…ç½®ã€é™é¢ï¼‰ 5.1ã€é…ç½®å†…å­˜å’Œ CPU é…é¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 # 1ã€åˆ›å»ºå‘½åç©ºé—´ï¼Œä»¥ä¾¿æœ¬ç»ƒä¹ ä¸­åˆ›å»ºçš„èµ„æºå’Œé›†ç¾¤çš„å…¶ä½™éƒ¨åˆ†ç›¸éš”ç¦»ã€‚ [root@k8s-master01 ~]# kubectl create namespace quota-mem-cpu-example namespace/quota-mem-cpu-example created # 2ã€åˆ›å»º ResourceQuota [root@k8s-master01 ~]# vim quota-mem-cpu.yaml apiVersion: v1 kind: ResourceQuota metadata: name: mem-cpu-demo spec: hard: requests.cpu: \u0026#34;1\u0026#34; requests.memory: 1Gi limits.cpu: \u0026#34;2\u0026#34; limits.memory: 2Gi # 3ã€åˆ›å»º ResourceQuota [root@k8s-master01 ~]# kubectl apply -f quota-mem-cpu.yaml -n quota-mem-cpu-example resourcequota/mem-cpu-demo created # 4ã€æŸ¥çœ‹ ResourceQuota è¯¦æƒ…ï¼š [root@k8s-master01 ~]# kubectl get resourcequota mem-cpu-demo --namespace=quota-mem-cpu-example --output=yaml # è·Ÿæˆ‘ä»¬é…ç½®çš„ä¸€æ · spec: hard: limits.cpu: \u0026#34;2\u0026#34; limits.memory: 2Gi requests.cpu: \u0026#34;1\u0026#34; requests.memory: 1Gi ResourceQuota åœ¨ quota-mem-cpu-example å‘½åç©ºé—´ä¸­è®¾ç½®äº†å¦‚ä¸‹è¦æ±‚ï¼š\næ¯ä¸ªå®¹å™¨å¿…é¡»æœ‰å†…å­˜è¯·æ±‚å’Œé™åˆ¶ï¼Œä»¥åŠ CPU è¯·æ±‚å’Œé™åˆ¶ã€‚ æ‰€æœ‰å®¹å™¨çš„å†…å­˜è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡1 GiBã€‚ æ‰€æœ‰å®¹å™¨çš„å†…å­˜é™åˆ¶æ€»å’Œä¸èƒ½è¶…è¿‡2 GiBã€‚ æ‰€æœ‰å®¹å™¨çš„ CPU è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡1 cpuã€‚ æ‰€æœ‰å®¹å™¨çš„ CPU é™åˆ¶æ€»å’Œä¸èƒ½è¶…è¿‡2 cpuã€‚ ä¹Ÿå°±æ˜¯åœ¨åç§°ç©ºé—´ quota-mem-cpu-exampleç§åˆ›å»ºPodï¼Œå¿…é¡»éµå®ˆæˆ‘ä»¬åœ¨ä¸Šé¢å®šä¹‰çš„è¦æ±‚\n5.1.1ã€åˆ›å»º Pod\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 cat \u0026gt; quota-mem-cpu-pod.yaml \u0026lt;\u0026lt; EFO apiVersion: v1 kind: Pod metadata: name: quota-mem-cpu-demo spec: containers: - name: quota-mem-cpu-demo-ctr image: nginx resources: limits: memory: \u0026#34;800Mi\u0026#34; cpu: \u0026#34;800m\u0026#34; requests: memory: \u0026#34;600Mi\u0026#34; cpu: \u0026#34;400m\u0026#34; EFO # create Pod kubectl apply -f quota-mem-cpu-pod.yaml --namespace=quota-mem-cpu-example # æŸ¥çœ‹é…é¢ï¼Œèƒ½çœ‹åˆ°ç”¨äº†å¤šå°‘ [root@k8s-master01 ~]# kubectl get resourcequota mem-cpu-demo --namespace=quota-mem-cpu-example --output=yaml spec: hard: limits.cpu: \u0026#34;2\u0026#34; limits.memory: 2Gi requests.cpu: \u0026#34;1\u0026#34; requests.memory: 1Gi status: hard: limits.cpu: \u0026#34;2\u0026#34; limits.memory: 2Gi requests.cpu: \u0026#34;1\u0026#34; requests.memory: 1Gi used: limits.cpu: 800m limits.memory: 800Mi requests.cpu: 400m requests.memory: 600Mi 5.1.2ã€å°è¯•åˆ›å»ºç¬¬äºŒä¸ª Pod\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 [root@k8s-master01 ~]# cat quota-mem-cpu-pod-2.yaml apiVersion: v1 kind: Pod metadata: name: quota-mem-cpu-demo-2 spec: containers: - name: quota-mem-cpu-demo-2-ctr image: redis resources: limits: memory: \u0026#34;1Gi\u0026#34; cpu: \u0026#34;800m\u0026#34; requests: memory: \u0026#34;700Mi\u0026#34; cpu: \u0026#34;400m\u0026#34; # å°è¯•åˆ›å»º [root@k8s-master01 ~]# kubectl apply -f quota-mem-cpu-pod-2.yaml --namespace=quota-mem-cpu-example Error from server (Forbidden): error when creating \u0026#34;quota-mem-cpu-pod-2.yaml\u0026#34;: pods \u0026#34;quota-mem-cpu-demo-2\u0026#34; is forbidden: exceeded quota: mem-cpu-demo, requested: requests.memory=700Mi, used: requests.memory=600Mi, limited: requests.memory=1Gi # ç¬¬äºŒä¸ª Pod ä¸èƒ½è¢«åˆ›å»ºæˆåŠŸã€‚è¾“å‡ºç»“æœæ˜¾ç¤ºåˆ›å»ºç¬¬äºŒä¸ª Pod ä¼šå¯¼è‡´å†…å­˜è¯·æ±‚æ€»é‡è¶…è¿‡å†…å­˜è¯·æ±‚é…é¢ã€‚ # åˆ é™¤ä½ çš„å‘½åç©ºé—´ï¼š kubectl delete namespace quota-mem-cpu-example 5.2ã€é…ç½®å‘½åç©ºé—´ä¸‹ Pod é…é¢\nå¦‚ä½•é…ç½®ä¸€ä¸ªå‘½åç©ºé—´ä¸‹å¯è¿è¡Œçš„ Pod ä¸ªæ•°é…é¢ï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 # 1ã€åˆ›å»ºä¸€ä¸ªå‘½åç©ºé—´ kubectl create namespace quota-pod-example # 2ã€åˆ›å»º ResourceQuotaï¼ŒæŒ‡å®šæ”¹nsåªå¯ä»¥åˆ›å»º2ä¸ªpod apiVersion: v1 kind: ResourceQuota metadata: name: pod-demo spec: hard: pods: \u0026#34;2\u0026#34; # 3ã€apply ResourceQuota kubectl apply -f quota-pod.yaml --namespace=quota-pod-example # 4ã€æŸ¥çœ‹èµ„æºé…é¢çš„è¯¦ç»†ä¿¡æ¯ï¼š kubectl get resourcequota pod-demo --namespace=quota-pod-example --output=yaml # 5ã€åˆ›å»ºDeploymentï¼Œä¸”replicasæ˜¯3ï¼Œé‚£ä¹ˆè‚¯å®šåªæœ‰2ä¸ªPodèƒ½æ­£å¸¸è¿è¡Œï¼è‡ªå·±å»è¯•è¯•å§ apiVersion: apps/v1 kind: Deployment metadata: name: pod-quota-demo spec: selector: matchLabels: purpose: quota-demo replicas: 3 template: metadata: labels: purpose: quota-demo spec: containers: - name: pod-quota-demo image: nginx ä¸­æ–‡å®˜ç½‘æ–‡æ¡£ï¼šhttps://kubernetes.io/zh/docs/concepts/policy/limit-range/\n","date":"2021-03-07T13:37:09Z","image":"https://www.ownit.top/title_pic/52.jpg","permalink":"https://www.ownit.top/p/202103071337/","title":"Kuberneteså‡†å…¥æ§åˆ¶"},{"content":"Ratelæ˜¯æœ‰æœå®½å¼€å‘ä¸€ä¸ªç±»ä¼¼Kubernetes-**Dashboardï¼Œ**åŠŸèƒ½æ­£åœ¨æ…¢æ…¢å®Œå–„\ndotbalo (dotbalo)æœå®½github\nratelåœ°å€ï¼šhttps://github.com/dotbalo/ratel-doc\n1 2 3 4 5 6 7 Ratelæ˜¯ä¸€ä¸ªKubernetesèµ„æºå¹³å°ï¼ŒåŸºäºç®¡ç†Kubernetesçš„èµ„æºå¼€å‘ï¼Œ å¯ä»¥ç®¡ç†Kubernetesçš„Deploymentã€DaemonSetã€StatefulSetã€Serviceã€Ingressã€Podsã€Nodesã€‚ ä¹Ÿå¯ä»¥ç®¡ç†Kubernetesçš„Roleã€ClusterRoleã€Rolebindingã€ClusterRoleBindingã€Secretã€ConfigMapã€PVã€PVCç­‰ã€‚ ç«‹å¿—äºåŸºäºå›¾å½¢ç•Œé¢ç®¡ç†æ‰€æœ‰çš„Kubernetesçš„èµ„æºã€‚ ä¸€ã€å®‰è£…Ratel 1.1ã€å®‰è£…è¯´æ˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 é›†ç¾¤å®‰è£…é…ç½®éœ€è¦ä¸¤ç±»æ–‡ä»¶: servers.yamlå’Œé›†ç¾¤ç®¡ç†çš„kubeconfigæ–‡ä»¶ servers.yamlæ˜¯ratelçš„é…ç½®æ–‡ä»¶, æ ¼å¼å¦‚ä¸‹: - serverName: \u0026#39;xiqu\u0026#39; serverAddress: \u0026#39;https://1.1.1.1:8443\u0026#39; #serverAdminUser: \u0026#39;xxx\u0026#39; #serverAdminPassword: \u0026#39;xxx#\u0026#39; serverAdminToken: \u0026#39;null\u0026#39; serverDashboardUrl: \u0026#34;https://k8s.xxx.com.cn/#\u0026#34; production: \u0026#39;false\u0026#39; kubeConfigPath: \u0026#34;/mnt/xxx.config\u0026#34; harborConfig: \u0026#34;HarborUrl, HarborUsername, HarborPassword, HarborEmail\u0026#34; å…¶ä¸­ç®¡ç†çš„æ–¹å¼æœ‰ä¸¤ç§(Tokenæš‚ä¸æ”¯æŒ): è´¦å·å¯†ç å’Œkubeconfigå½¢å¼, åªéœ€é…ç½®ä¸€ç§å³å¯, kubeconfigä¼˜å…ˆçº§é«˜ å‚æ•°è§£æ: serverName: é›†ç¾¤åˆ«å serverAddress: Kubernetes APIServeråœ°å€ serverAdminUser: Kubernetesç®¡ç†å‘˜è´¦å·(éœ€è¦é…ç½®basic auth) serverAdminPassword: Kubernetesç®¡ç†å‘˜å¯†ç  serverAdminToken: Kubernetesç®¡ç†å‘˜Token // æš‚ä¸æ”¯æŒ serverDashboardUrl: Kuberneteså®˜æ–¹dashboardåœ°å€ï¼Œ1.xç‰ˆæœ¬éœ€è¦æ·»åŠ /#!ï¼Œ2.xéœ€è¦æ·»åŠ /# kubeConfigPath: Kubernetes kube.configè·¯å¾„(ç»å¯¹è·¯å¾„) harborConfig: å¯¹äºå¤šé›†ç¾¤ç®¡ç†çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå­˜åœ¨ä¸åŒçš„harborä»“åº“ï¼Œé…ç½®æ­¤å‚æ•°å¯ä»¥åœ¨æ‹·è´èµ„æºçš„æ—¶å€™è‡ªåŠ¨æ›¿æ¢harboré…ç½® kubeConfigPath é€šè¿‡secretæŒ‚è½½åˆ°å®¹å™¨çš„/mntç›®å½•æˆ–è€…å…¶ä»–ç›®å½• æœ¬æ–‡æ¡£æ˜¯å°†Ratelå®‰è£…åœ¨Kubernetesé›†ç¾¤ï¼Œå¦‚æœæ²¡æœ‰Kubernetesé›†ç¾¤ï¼Œå¯ä»¥å‚è€ƒæœ¬äººå†™çš„å¦ä¸€ç¯‡æ–‡ç« ï¼ŒCentOS 8äºŒè¿›åˆ¶é«˜å¯ç”¨å®‰è£…Kubernetesé›†ç¾¤: https://www.cnblogs.com/dukuan/p/11780729.html 1.2 åˆ›å»ºSecret 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 å‡è®¾é…ç½®ä¸¤ä¸ªé›†ç¾¤ï¼Œå¯¹åº”çš„kubeconfigæ˜¯test1.configå’Œtest2.config ratelé…ç½®æ–‡ä»¶servers.yamlå†…å®¹å¦‚ä¸‹: - serverName: \u0026#39;test1\u0026#39; serverAddress: \u0026#39;https://1.1.1.1:8443\u0026#39; #serverAdminUser: \u0026#39;xxx\u0026#39; #serverAdminPassword: \u0026#39;xxx#\u0026#39; serverAdminToken: \u0026#39;null\u0026#39; serverDashboardUrl: \u0026#34;https://k8s.test1.com.cn/#\u0026#34; production: \u0026#39;false\u0026#39; kubeConfigPath: \u0026#34;/mnt/test1.config\u0026#34; harborConfig: \u0026#34;HarborUrl, HarborUsername, HarborPassword, HarborEmail\u0026#34; - serverName: \u0026#39;test2\u0026#39; serverAddress: \u0026#39;https://1.1.1.2:8443\u0026#39; #serverAdminUser: \u0026#39;xxx\u0026#39; #serverAdminPassword: \u0026#39;xxx#\u0026#39; serverAdminToken: \u0026#39;null\u0026#39; serverDashboardUrl: \u0026#34;https://k8s.test2.com.cn/#!\u0026#34; production: \u0026#39;false\u0026#39; kubeConfigPath: \u0026#34;/mnt/test2.config\u0026#34; harborConfig: \u0026#34;HarborUrl, HarborUsername, HarborPassword, HarborEmail\u0026#34; åˆ›å»ºSecret: kubectl create secret generic ratel-config --from-file=test1.config --from-file=test2.config --from-file=servers.yaml -n kube-system #test1.configæ˜¯masterçš„æƒé™é…ç½® cp /root/.kube/config test1.config æˆ‘çš„é…ç½® - serverName: \u0026#39;test1\u0026#39; serverAddress: \u0026#39;https://192.168.0.100:6443\u0026#39; #serverAdminUser: \u0026#39;xxx\u0026#39; #serverAdminPassword: \u0026#39;xxx#\u0026#39; serverAdminToken: \u0026#39;null\u0026#39; serverDashboardUrl: \u0026#34;http://krm.test.com/#\u0026#34; production: \u0026#39;false\u0026#39; kubeConfigPath: \u0026#34;/mnt/test1.config\u0026#34; kubectl create secret generic ratel-config --from-file=test1.config --from-file=servers.yaml -n kube-system 1.3 åˆ›å»ºRBAC 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 åˆ›å»ºæƒé™ç®¡ç†namespace kubectl create ns kube-users ç„¶åæ·»åŠ å¦‚ä¸‹çš„ClusterroleBinding vim ratel-rbac.yaml apiVersion: v1 items: - apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \u0026#34;true\u0026#34; labels: kubernetes.io/bootstrapping: rbac-defaults rbac.authorization.k8s.io/aggregate-to-edit: \u0026#34;true\u0026#34; name: ratel-namespace-readonly rules: - apiGroups: - \u0026#34;\u0026#34; resources: - namespaces verbs: - get - list - watch - apiGroups: - metrics.k8s.io resources: - pods verbs: - get - list - watch - apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: ratel-pod-delete rules: - apiGroups: - \u0026#34;\u0026#34; resources: - pods verbs: - get - list - delete - apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: ratel-pod-exec rules: - apiGroups: - \u0026#34;\u0026#34; resources: - pods - pods/log verbs: - get - list - apiGroups: - \u0026#34;\u0026#34; resources: - pods/exec verbs: - create - apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \u0026#34;true\u0026#34; name: ratel-resource-edit rules: - apiGroups: - \u0026#34;\u0026#34; resources: - configmaps - persistentvolumeclaims - services - services/proxy verbs: - patch - update - apiGroups: - apps resources: - daemonsets - deployments - deployments/rollback - deployments/scale - statefulsets - statefulsets/scale verbs: - patch - update - apiGroups: - autoscaling resources: - horizontalpodautoscalers verbs: - patch - update - apiGroups: - batch resources: - cronjobs - jobs verbs: - patch - update - apiGroups: - extensions resources: - daemonsets - deployments - deployments/rollback - deployments/scale - ingresses verbs: - patch - update - apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: ratel-resource-readonly rules: - apiGroups: - \u0026#34;\u0026#34; resources: - configmaps - endpoints - persistentvolumeclaims - pods - replicationcontrollers - replicationcontrollers/scale - serviceaccounts - services verbs: - get - list - watch - apiGroups: - \u0026#34;\u0026#34; resources: - bindings - events - limitranges - namespaces/status - pods/log - pods/status - replicationcontrollers/status - resourcequotas - resourcequotas/status verbs: - get - list - watch - apiGroups: - \u0026#34;\u0026#34; resources: - namespaces verbs: - get - list - watch - apiGroups: - apps resources: - controllerrevisions - daemonsets - deployments - deployments/scale - replicasets - replicasets/scale - statefulsets - statefulsets/scale verbs: - get - list - watch - apiGroups: - autoscaling resources: - horizontalpodautoscalers verbs: - get - list - watch - apiGroups: - batch resources: - cronjobs - jobs verbs: - get - list - watch - apiGroups: - extensions resources: - daemonsets - deployments - deployments/scale - ingresses - networkpolicies - replicasets - replicasets/scale - replicationcontrollers/scale verbs: - get - list - watch - apiGroups: - policy resources: - poddisruptionbudgets verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - networkpolicies verbs: - get - list - watch - apiGroups: - metrics.k8s.io resources: - pods verbs: - get - list - watch kind: List metadata: resourceVersion: \u0026#34;\u0026#34; selfLink: \u0026#34;\u0026#34; 1 kubectl create -f ratel-rbac.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 vim ratel-rbac-binding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: ratel-namespace-readonly-sa roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: ratel-namespace-readonly subjects: - apiGroup: rbac.authorization.k8s.io kind: Group name: system:serviceaccounts:kube-users kubectl create -f ratel-rbac-binding.yaml 1.4 éƒ¨ç½²ratel 1 ratelçš„éƒ¨ç½²æ–‡ä»¶å†…å®¹å¦‚ä¸‹: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 apiVersion: apps/v1 kind: Deployment metadata: labels: app: ratel name: ratel namespace: kube-system spec: replicas: 1 selector: matchLabels: app: ratel strategy: rollingUpdate: maxSurge: 1 maxUnavailable: 0 type: RollingUpdate template: metadata: creationTimestamp: null labels: app: ratel spec: containers: - command: - sh - -c - ./ratel -c /mnt/servers.yaml env: - name: TZ value: Asia/Shanghai - name: LANG value: C.UTF-8 - name: ProRunMode value: prod - name: ADMIN_USERNAME value: admin - name: ADMIN_PASSWORD value: password image: registry.cn-beijing.aliyuncs.com/dotbalo/ratel:latest imagePullPolicy: Always livenessProbe: failureThreshold: 2 initialDelaySeconds: 10 periodSeconds: 60 successThreshold: 1 tcpSocket: port: 8888 timeoutSeconds: 2 name: ratel ports: - containerPort: 8888 name: web protocol: TCP readinessProbe: failureThreshold: 2 initialDelaySeconds: 10 periodSeconds: 60 successThreshold: 1 tcpSocket: port: 8888 timeoutSeconds: 2 resources: limits: cpu: 500m memory: 512Mi requests: cpu: 500m memory: 512Mi volumeMounts: - mountPath: /mnt name: ratel-config dnsPolicy: ClusterFirst # imagePullSecrets: # - name: myregistrykey restartPolicy: Always schedulerName: default-scheduler securityContext: {} terminationGracePeriodSeconds: 30 volumes: - name: ratel-config secret: defaultMode: 420 secretName: ratel-config éœ€è¦æ›´æ”¹çš„å†…å®¹å¦‚ä¸‹: ProRunMode: åŒºåˆ«åœ¨äºdevæ¨¡å¼æ‰“å°çš„æ˜¯debugæ—¥å¿—, å…¶ä»–æ¨¡å¼æ˜¯infoçº§åˆ«çš„æ—¥å¿—, å®é™…ä½¿ç”¨æ—¶åº”è¯¥é…ç½®ä¸ºédev ADMIN_USERNAME: ratelè‡ªå·±çš„ç®¡ç†å‘˜è´¦å· ADMIN_PASSWORD: ratelè‡ªå·±çš„ç®¡ç†å‘˜å¯†ç  å®é™…ä½¿ç”¨æ—¶è´¦å·å¯†ç åº”æ»¡è¶³å¤æ‚æ€§è¦æ±‚,å› ä¸ºratelå¯ä»¥ç›´æ¥æ“ä½œæ‰€æœ‰é…ç½®çš„èµ„æºã€‚ å…¶ä»–æ— éœ€é…ç½®, ç«¯å£é…ç½®æš‚ä¸æ”¯æŒã€‚ 1.5 Serviceå’ŒIngressé…ç½® æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å®‰è£…ingress controllerï¼Œéœ€è¦æŠŠtype: ClusterIPæ”¹æˆtype: NodePortï¼Œç„¶åé€šè¿‡ä¸»æœºIP+Portè¿›è¡Œè®¿é—®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 åˆ›å»ºratel Serviceçš„æ–‡ä»¶å¦‚ä¸‹: apiVersion: v1 kind: Service metadata: labels: app: ratel name: ratel namespace: kube-system spec: ports: - name: container-1-web-1 port: 8888 protocol: TCP targetPort: 8888 selector: app: ratel type: ClusterIP åˆ›å»ºratel Ingress: apiVersion: extensions/v1beta1 kind: Ingress metadata: name: ratel namespace: kube-system labels: app: ratel spec: rules: - host: krm.test.com http: paths: - backend: serviceName: ratel servicePort: 8888 path: / 1.6 è®¿é—®ratel æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å®‰è£…ingress controllerï¼Œéœ€è¦æŠŠtype: ClusterIPæ”¹æˆtype: NodePortï¼Œç„¶åé€šè¿‡ä¸»æœºIP+Portè¿›è¡Œè®¿é—®\n1 é€šè¿‡Ingressé…ç½®çš„krm.test.com/ratelè®¿é—®ï¼Œratelç™»å½•é¡µå¦‚ä¸‹: ","date":"2021-03-07T10:18:07Z","image":"https://www.ownit.top/title_pic/10.jpg","permalink":"https://www.ownit.top/p/202103071018/","title":"Kuberneteså®‰è£…Ratel"},{"content":"ç”±äºä¸€äº›åŸå› ,åœ¨å›½å†…æ— æ³•è®¿é—®gcr.ioä¸Šçš„é•œåƒ,åœ¨å®‰è£…kubernetesæ—¶ç»å¸¸è®¿é—®é˜¿é‡Œäº‘çš„åœ°å€ã€‚é¢ç»“åˆå®é™…ç»éªŒ,åˆ—ä¸¾å‡ºå‡ ç§å¸¸ç”¨çš„åŠæ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼\nä¸€ã€ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒåœ°å€ 1 2 åœ°å€ä¸€ï¼šregistry.aliyuncs.com/google_containers åœ°å€äºŒï¼šregistry.cn-hangzhou.aliyuncs.com/google_containers äºŒã€ä½¿ç”¨dockerhubä¸‹çš„mirrorgooglecontainers â€‹ è¿™ä¸ªåŸŸåä¸‹åŒæ­¥äº†å¾ˆå¤šè°·æ­Œé•œåƒ,æ¯”å¦‚è¯´è¦ä¸‹è½½gcr.io/google_containers/coredns:1.7.0,\nå¯ä»¥ä½¿ç”¨docker pull mirrorgooglecontainers/coredns:1.7.0æ¥è¿›è¡Œä¸‹è½½,ä¸‹è½½ä»¥åå¯¹é•œåƒé‡æ–°æ‰“æ ‡ç­¾:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # 1ã€å…ˆpullä¸‹æ¥ [root@k8s-master01 Ratel]# docker pull mirrorgooglecontainers/kube-proxy-amd64:v1.11.3 v1.11.3: Pulling from mirrorgooglecontainers/kube-proxy-amd64 06545d1c6152: Pull complete d5f5a75f5817: Pull complete c21dcda023ab: Pull complete Digest: sha256:cd0c257e3f4a79a0ae7964b3429c491e9d43bf1bb015618a4c311165d3915b7b Status: Downloaded newer image for mirrorgooglecontainers/kube-proxy-amd64:v1.11.3 docker.io/mirrorgooglecontainers/kube-proxy-amd64:v1.11.3 # 2ã€é‡æ–°æ‰“æ ‡ç­¾ [root@k8s-master01 Ratel]# docker tag docker.io/mirrorgooglecontainers/kube-proxy-amd64:v1.11.3 k8s.gcr.io/kube-proxy-amd64:v1.11.3 # 3ã€æŸ¥çœ‹é•œåƒï¼Œç„¶åå°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªé•œåƒäº† [root@k8s-master01 Ratel]# docker images | grep k8s.gcr.io/kube-proxy-amd64 k8s.gcr.io/kube-proxy-amd64 v1.11.3 be5a6e1ecfa6 2 years ago 97.8MB ä¸‰ã€ä½¿ç”¨å›½å†…ä½œè€…åˆ¶ä½œçš„gcr.ioé•œåƒå®‰è£…å·¥å…· 1 é¡¹ç›®åœ°å€: https://github.com/zhangguanzhang/gcr.io 3.0ã€ä½¿ç”¨searchå‘½ä»¤çš„æ—¶å€™,å¦‚æœæ²¡æœ‰å®‰è£…jqåˆ™ä¼šæç¤ºå®‰è£…jq.jqåœ¨centosä¸‹å®‰è£…æ–¹æ³•:\nå®‰è£…EPELæºï¼š 1 [root@k8s-master01 ~]# yum install epel-release å®‰è£…å®ŒEPELæºåï¼Œå¯ä»¥æŸ¥çœ‹ä¸‹jqåŒ…æ˜¯å¦å­˜åœ¨ï¼š 1 [root@k8s-master01 ~]# yum list jq å®‰è£…jqï¼š 1 [root@k8s-master01 ~]# yum install jq -y 3.1ã€æŸ¥è¯¢namespace\n1 2 3 4 5 6 7 8 9 10 [root@k8s-master01 ~]# curl -s https://zhangguanzhang.github.io/bash/pull.sh | bash -s search gcr.io cloud-builders cloud-datalab cloudsql-docker distroless google-appengine google-samples google_containers google_samples heptio-images 3.2ã€æŸ¥è¯¢æŸä¸€åç§°ç©ºé—´ä¸‹é•œåƒåˆ—è¡¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 [root@k8s-master01 ~]# curl -s https://zhangguanzhang.github.io/bash/pull.sh | bash -s search gcr.io/google_containers # gcr.io/google_containers ---\u0026gt; namespace â€”â€”â€”â€”â€”â€”\u0026gt; æ ¹æ®ä¸Šé¢æŸ¥è¯¢å‡ºæ¥çš„namespaceæŸ¥ addon-builder addon-resizer-amd64 addon-resizer-arm addon-resizer-arm64 addon-resizer-ppc64le addon-resizer-s390x addon-resizer aggregator alpine-iptables-amd64 alpine-iptables-arm alpine-iptables-arm64 3.3ã€æŸ¥è¯¢æŸä¸€é•œåƒçš„ç‰ˆæœ¬æ‰€æœ‰ç‰ˆæœ¬tag\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@k8s-master01 ~]# curl -s https://zhangguanzhang.github.io/bash/pull.sh | bash -s search gcr.io/google_containers/coredns # åœ¨namespaceåé¢æœç´¢imageçš„ç‰ˆæœ¬tag 1.0.1 1.0.1__amd64_linux 1.0.1__arm64_linux 1.0.1__arm_linux 1.0.1__ppc64le_linux 1.0.1__s390x_linux 1.0.6 1.0.6__amd64_linux 1.0.6__arm64_linux 1.0.6__arm_linux 1.0.6__ppc64le_linux 1.0.6__s390x_linux 1.1.3 1.1.3__amd64_linux 3.4 ä¸‹è½½é•œåƒ\n1 curl -s https://zhangguanzhang.github.io/bash/pull.sh | bash -s gcr.io/google_containers/coredns:1.7.0 åŸæ–‡åœ°å€ï¼šhttps://www.cnblogs.com/tylerzhou/p/10971341.html\n","date":"2021-03-06T22:46:41Z","image":"https://www.ownit.top/title_pic/13.jpg","permalink":"https://www.ownit.top/p/202103062246/","title":"Dockeræ— æ³•è®¿é—®gcr.ioçš„å‡ ç§è§£å†³åŠæ³•"},{"content":"ä¸€ã€ä»€ä¹ˆæ˜¯RBACï¼Ÿ Role-based access control(RBAC)åŸºäºä¼ä¸šå†…ä¸ªäººç”¨æˆ·å±äºè§’è‰²æ¥è®¿é—®è®¡ç®—å’Œç½‘ç»œçš„å¸¸è§„è®¿é—®æ§åˆ¶æ–¹æ³•ã€‚\nç®€å•ç†è§£ä¸ºæƒé™ä¸è§’è‰²å…³è”ï¼Œç”¨æˆ·é€šè¿‡æˆä¸ºè§’è‰²çš„æˆå‘˜æ¥å¾—åˆ°è§’è‰²çš„æƒé™ã€‚K8Sçš„RBACä½¿ç”¨rbac.authorization.k8s.io/v1 APIç»„é©±åŠ¨è®¤è¯å†³ç­–ï¼Œå‡†è®¸ç®¡ç†å‘˜é€šè¿‡APIåŠ¨æ€é…ç½®ç­–ç•¥ã€‚ä¸ºäº†å¯ç”¨RBACï¼Œéœ€è¦åœ¨apiserverå¯åŠ¨å‚æ•°æ·»åŠ \u0026ndash;authorization-mode=RBACã€‚ç›®å‰æ”¯æŒRBAC,ABAC(åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶)ï¼ŒNodeï¼ˆé»˜è®¤nodeå’Œapiserverå°±æ˜¯é‡‡ç”¨è¿™ç§æ¨¡å¼ï¼‰,Webhookã€‚\näºŒã€RBACåˆ†ç±»ä»‹ç»ï¼ˆAPI å¯¹è±¡ï¼‰ 2.1ã€RBACæœ‰4ç§é¡¶çº§èµ„æº\nRole ClusterRole RoleBinding ClusterRoleBinding 2.2ã€èµ„æºä»‹ç»\nRoleï¼šè§’è‰²ï¼ŒåŒ…å«ä¸€ç»„æƒé™çš„è§„åˆ™ã€‚æ²¡æœ‰æ‹’ç»è§„åˆ™ï¼Œåªæ˜¯é™„åŠ å…è®¸ã€‚Namespaceéš”ç¦»ï¼Œåªä½œç”¨äºå‘½åç©ºé—´å†…ï¼\nClusterRoleï¼šé›†ç¾¤è§’è‰²ï¼Œå’ŒRoleä¸€æ ·ã€‚å’ŒRoleçš„åŒºåˆ«ï¼ŒRoleæ˜¯åªä½œç”¨äºå‘½åç©ºé—´å†…ï¼ŒClusterRoleä½œç”¨äºæ•´ä¸ªé›†ç¾¤ï¼\nRoleBindingï¼šä½œç”¨äºå‘½ä»¤ç©ºé—´å†…ï¼Œå°†ClusterRoleæˆ–è€…Roleç»‘å®šåˆ°Userã€Groupã€ServiceAccountï¼\nClusterRoleBindingï¼šä½œç”¨äºæ•´ä¸ªé›†ç¾¤ã€‚\nä¸­æ–‡å®˜æ–¹æ–‡æ¡£ï¼šhttps://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/\nä¸‰ã€ç¤ºä¾‹ 3.1ã€Role ç¤ºä¾‹\nRole æ€»æ˜¯ç”¨æ¥åœ¨æŸä¸ªåå­—ç©ºé—´å†…è®¾ç½®è®¿é—®æƒé™ï¼›åœ¨ä½ åˆ›å»º Role æ—¶ï¼Œä½ å¿…é¡»æŒ‡å®šè¯¥ Role æ‰€å±çš„åå­—ç©ºé—´\n1 2 3 4 5 6 7 8 9 apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: namespace: default name: pod-reader rules: - apiGroups: [\u0026#34;\u0026#34;] # \u0026#34;\u0026#34; æ ‡æ˜ core API ç»„ resources: [\u0026#34;pods\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;list\u0026#34;] 3.2ã€ClusterRole ç¤ºä¾‹\nClusterRole æœ‰è‹¥å¹²ç”¨æ³•ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥ï¼š\nå®šä¹‰å¯¹æŸåå­—ç©ºé—´åŸŸå¯¹è±¡çš„è®¿é—®æƒé™ï¼Œå¹¶å°†åœ¨å„ä¸ªåå­—ç©ºé—´å†…å®Œæˆæˆæƒï¼› ä¸ºåå­—ç©ºé—´ä½œç”¨åŸŸçš„å¯¹è±¡è®¾ç½®è®¿é—®æƒé™ï¼Œå¹¶è·¨æ‰€æœ‰åå­—ç©ºé—´æ‰§è¡Œæˆæƒï¼› ä¸ºé›†ç¾¤ä½œç”¨åŸŸçš„èµ„æºå®šä¹‰è®¿é—®æƒé™ã€‚ 1 2 3 4 5 6 7 8 9 10 apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: # \u0026#34;namespace\u0026#34; è¢«å¿½ç•¥ï¼Œå› ä¸º ClusterRoles ä¸å—åå­—ç©ºé—´é™åˆ¶ name: secret-reader rules: - apiGroups: [\u0026#34;\u0026#34;] # åœ¨ HTTP å±‚é¢ï¼Œç”¨æ¥è®¿é—® Secret å¯¹è±¡çš„èµ„æºçš„åç§°ä¸º \u0026#34;secrets\u0026#34; resources: [\u0026#34;secrets\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;list\u0026#34;] 3.3ã€RoleBinding ç¤ºä¾‹\nä¸‹é¢çš„ä¾‹å­ä¸­çš„ RoleBinding å°† \u0026ldquo;pod-reader\u0026rdquo; Role æˆäºˆåœ¨ \u0026ldquo;default\u0026rdquo; åå­—ç©ºé—´ä¸­çš„ç”¨æˆ· \u0026ldquo;jane\u0026rdquo;ã€‚ è¿™æ ·ï¼Œç”¨æˆ· \u0026ldquo;jane\u0026rdquo; å°±å…·æœ‰äº†è¯»å– \u0026ldquo;default\u0026rdquo; åå­—ç©ºé—´ä¸­ pods çš„æƒé™ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 apiVersion: rbac.authorization.k8s.io/v1 # æ­¤è§’è‰²ç»‘å®šå…è®¸ \u0026#34;jane\u0026#34; è¯»å– \u0026#34;default\u0026#34; åå­—ç©ºé—´ä¸­çš„ Pods kind: RoleBinding metadata: name: read-pods namespace: default subjects: # ä½ å¯ä»¥æŒ‡å®šä¸æ­¢ä¸€ä¸ªâ€œsubjectï¼ˆä¸»ä½“ï¼‰â€ - kind: User # è¿™é‡Œå¯ä»¥æ˜¯User,Group,ServiceAccount name: jane # \u0026#34;name\u0026#34; æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ apiGroup: rbac.authorization.k8s.io roleRef: # \u0026#34;roleRef\u0026#34; æŒ‡å®šä¸æŸ Role æˆ– ClusterRole çš„ç»‘å®šå…³ç³» kind: Role # æ­¤å­—æ®µå¿…é¡»æ˜¯ Role æˆ– ClusterRole name: pod-reader # æ­¤å­—æ®µå¿…é¡»ä¸ä½ è¦ç»‘å®šçš„ Role æˆ– ClusterRole çš„åç§°åŒ¹é… apiGroup: rbac.authorization.k8s.io 3.3.1ã€RoleBinding å¼•ç”¨ ClusterRole\nRoleBinding ä¹Ÿå¯ä»¥å¼•ç”¨ ClusterRoleï¼Œä»¥å°†å¯¹åº” ClusterRole ä¸­å®šä¹‰çš„è®¿é—®æƒé™æˆäºˆ RoleBinding æ‰€åœ¨åå­—ç©ºé—´çš„èµ„æºã€‚è¿™ç§å¼•ç”¨ä½¿å¾—ä½ å¯ä»¥è·¨æ•´ä¸ªé›†ç¾¤å®šä¹‰ä¸€ç»„é€šç”¨çš„è§’è‰²ï¼Œ ä¹‹ååœ¨å¤šä¸ªåå­—ç©ºé—´ä¸­å¤ç”¨ï¼\nä¸‹é¢çš„ä¾‹å­ä¸­çš„ RoleBindingï¼Œå°†\u0026quot;secret-reader\u0026quot; ClusterRoleæˆäºˆåœ¨\u0026quot;development\u0026quot; namespaceä¸­çš„ç”¨æˆ·\u0026quot;dave\u0026quot;ã€‚è¿™æ ·ï¼Œç”¨æˆ· \u0026ldquo;dave\u0026rdquo; å°±å…·æœ‰äº†è¯»å– \u0026ldquo;development\u0026rdquo; åå­—ç©ºé—´ä¸­ pods çš„æƒé™ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: rbac.authorization.k8s.io/v1 # æ­¤è§’è‰²ç»‘å®šä½¿å¾—ç”¨æˆ· \u0026#34;dave\u0026#34; èƒ½å¤Ÿè¯»å– \u0026#34;default\u0026#34; åå­—ç©ºé—´ä¸­çš„ Secrets # ä½ éœ€è¦ä¸€ä¸ªåä¸º \u0026#34;secret-reader\u0026#34; çš„ ClusterRole kind: RoleBinding metadata: name: read-secrets # RoleBinding çš„åå­—ç©ºé—´å†³å®šäº†è®¿é—®æƒé™çš„æˆäºˆèŒƒå›´ã€‚ # è¿™é‡Œä»…æˆæƒåœ¨ \u0026#34;development\u0026#34; åå­—ç©ºé—´å†…çš„è®¿é—®æƒé™ã€‚ namespace: development subjects: - kind: User name: dave # \u0026#39;name\u0026#39; æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ apiGroup: rbac.authorization.k8s.io roleRef: kind: ClusterRole name: secret-reader apiGroup: rbac.authorization.k8s.io 3.4ã€ClusterRoleBinding ç¤ºä¾‹\nè¦è·¨æ•´ä¸ªé›†ç¾¤å®Œæˆè®¿é—®æƒé™çš„æˆäºˆï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ª ClusterRoleBindingã€‚ ä¸‹é¢çš„ ClusterRoleBinding å…è®¸ \u0026ldquo;manager\u0026rdquo; ç»„å†…çš„æ‰€æœ‰ç”¨æˆ·è®¿é—®ä»»ä½•åå­—ç©ºé—´ä¸­çš„ Secretsã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: rbac.authorization.k8s.io/v1 # æ­¤é›†ç¾¤è§’è‰²ç»‘å®šå…è®¸ â€œmanagerâ€ ç»„ä¸­çš„ä»»ä½•äººè®¿é—®ä»»ä½•åå­—ç©ºé—´ä¸­çš„ secrets kind: ClusterRoleBinding metadata: name: read-secrets-global subjects: - kind: Group name: manager # \u0026#39;name\u0026#39; æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ apiGroup: rbac.authorization.k8s.io roleRef: kind: ClusterRole name: secret-reader apiGroup: rbac.authorization.k8s.io æ³¨æ„ï¼š\nâ€‹ åˆ›å»ºäº†ç»‘å®šä¹‹åï¼Œä½ ä¸èƒ½å†ä¿®æ”¹ç»‘å®šå¯¹è±¡æ‰€å¼•ç”¨çš„ Role æˆ– ClusterRoleã€‚ è¯•å›¾æ”¹å˜ç»‘å®šå¯¹è±¡çš„Â roleRefÂ å°†å¯¼è‡´åˆæ³•æ€§æ£€æŸ¥é”™è¯¯ã€‚ å¦‚æœä½ æƒ³è¦æ”¹å˜ç°æœ‰ç»‘å®šå¯¹è±¡ä¸­Â roleRefÂ å­—æ®µçš„å†…å®¹ï¼Œå¿…é¡»åˆ é™¤é‡æ–°åˆ›å»ºç»‘å®šå¯¹è±¡ã€‚\nè¿™ç§é™åˆ¶æœ‰ä¸¤ä¸ªä¸»è¦åŸå› ï¼š\né’ˆå¯¹ä¸åŒè§’è‰²çš„ç»‘å®šæ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ç»‘å®šã€‚è¦æ±‚é€šè¿‡åˆ é™¤/é‡å»ºç»‘å®šæ¥æ›´æ”¹Â roleRef, è¿™æ ·å¯ä»¥ç¡®ä¿è¦èµ‹äºˆç»‘å®šçš„æ‰€æœ‰ä¸»ä½“ä¼šè¢«æˆäºˆæ–°çš„è§’è‰²ï¼ˆè€Œä¸æ˜¯åœ¨å…è®¸ä¿®æ”¹Â roleRefÂ çš„æƒ…å†µä¸‹å¯¼è‡´æ‰€æœ‰ç°æœ‰ä¸»ä½“èƒƒé•œéªŒè¯å³è¢«æˆäºˆæ–°è§’è‰²å¯¹åº”çš„æƒé™ï¼‰ã€‚ å°†Â roleRefÂ è®¾ç½®ä¸ºä¸å¯ä»¥æ”¹å˜ï¼Œè¿™ä½¿å¾—å¯ä»¥ä¸ºç”¨æˆ·æˆäºˆå¯¹ç°æœ‰ç»‘å®šå¯¹è±¡çš„Â updateÂ æƒé™ï¼Œ è¿™æ ·å¯ä»¥è®©ä»–ä»¬ç®¡ç†ä¸»ä½“åˆ—è¡¨ï¼ŒåŒæ—¶ä¸èƒ½æ›´æ”¹è¢«æˆäºˆè¿™äº›ä¸»ä½“çš„è§’è‰²ã€‚ å‘½ä»¤Â kubectl auth reconcileÂ å¯ä»¥åˆ›å»ºæˆ–è€…æ›´æ–°åŒ…å« RBAC å¯¹è±¡çš„æ¸…å•æ–‡ä»¶ï¼Œ å¹¶ä¸”åœ¨å¿…è¦çš„æƒ…å†µä¸‹åˆ é™¤å’Œé‡æ–°åˆ›å»ºç»‘å®šå¯¹è±¡ï¼Œä»¥æ”¹å˜æ‰€å¼•ç”¨çš„è§’è‰²\n3.5ã€èšåˆçš„ ClusterRole\nä¸‹é¢æ˜¯ä¸€ä¸ªèšåˆ ClusterRole çš„ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: monitoring aggregationRule: clusterRoleSelectors: - matchLabels: rbac.example.com/aggregate-to-monitoring: \u0026#34;true\u0026#34; rules: [] # æ§åˆ¶é¢è‡ªåŠ¨å¡«å……è¿™é‡Œçš„è§„åˆ™ ------- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: monitoring-endpoints labels: rbac.example.com/aggregate-to-monitoring: \u0026#34;true\u0026#34; # å½“ä½ åˆ›å»º \u0026#34;monitoring-endpoints\u0026#34; ClusterRole æ—¶ï¼Œ # ä¸‹é¢çš„è§„åˆ™ä¼šè¢«æ·»åŠ åˆ° \u0026#34;monitoring\u0026#34; ClusterRole ä¸­ rules: - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;services\u0026#34;, \u0026#34;endpoints\u0026#34;, \u0026#34;pods\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] ä¸‹é¢çš„ ClusterRoles è®©é»˜è®¤è§’è‰² \u0026ldquo;admin\u0026rdquo; å’Œ \u0026ldquo;edit\u0026rdquo; æ‹¥æœ‰ç®¡ç†è‡ªå®šä¹‰èµ„æº \u0026ldquo;CronTabs\u0026rdquo; çš„æƒé™ï¼Œ \u0026ldquo;view\u0026rdquo; è§’è‰²å¯¹ CronTab èµ„æºæ‹¥æœ‰è¯»æ“ä½œæƒé™ã€‚ ä½ å¯ä»¥å‡å®š CronTab å¯¹è±¡åœ¨ API æœåŠ¡å™¨æ‰€çœ‹åˆ°çš„ URL ä¸­è¢«å‘½åä¸ºÂ \u0026quot;crontabs\u0026quot;ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: aggregate-cron-tabs-edit labels: # æ·»åŠ ä»¥ä¸‹æƒé™åˆ°é»˜è®¤è§’è‰² \u0026#34;admin\u0026#34; å’Œ \u0026#34;edit\u0026#34; ä¸­ rbac.authorization.k8s.io/aggregate-to-admin: \u0026#34;true\u0026#34; rbac.authorization.k8s.io/aggregate-to-edit: \u0026#34;true\u0026#34; rules: - apiGroups: [\u0026#34;stable.example.com\u0026#34;] resources: [\u0026#34;crontabs\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;create\u0026#34;, \u0026#34;update\u0026#34;, \u0026#34;patch\u0026#34;, \u0026#34;delete\u0026#34;] --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: aggregate-cron-tabs-view labels: # æ·»åŠ ä»¥ä¸‹æƒé™åˆ° \u0026#34;view\u0026#34; é»˜è®¤è§’è‰²ä¸­ rbac.authorization.k8s.io/aggregate-to-view: \u0026#34;true\u0026#34; rules: - apiGroups: [\u0026#34;stable.example.com\u0026#34;] resources: [\u0026#34;crontabs\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] ","date":"2021-03-06T22:16:21Z","image":"https://www.ownit.top/title_pic/15.jpg","permalink":"https://www.ownit.top/p/202103062216/","title":"Kubernetesè®¤è¯ä¹‹RBAC"},{"content":"æ— èŠï¼Œè¿‘æœŸç—´è¿·ç¼–ç¨‹ï¼Œæ²¡äº‹å°±å†™å†™shellå’ŒPythonä»£ç ç»ƒç»ƒæ‰‹ã€‚\nè¿™æ¬¡å†™äº†ä¸ªè‡ªåŠ¨å®‰è£…saltstackçš„shellä»£ç èœå•\nåŠŸèƒ½æ¯”è¾ƒlowï¼Œç›¸å¯¹æ¯”è¾ƒçœäº‹ã€‚å¤šå°ä¸»æœºå®‰è£…æ–¹ä¾¿ã€‚ä»…ä¾›å‚è€ƒï¼Œå¤§ä½¬å‹¿å–·\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 #!/bin/bash #é¢œè‰²æ§åˆ¶ red=\u0026#39;\\033[1;31m\u0026#39; black=\u0026#39;\\033[0m\u0026#39; Orange=\u0026#39;\\033[35m\u0026#39; background=\u0026#39;\\033[0m\u0026#39; minion_file=\u0026#39;/etc/salt/minion\u0026#39; datetime=`date +\u0026#34;%F %T\u0026#34;` #åˆ¤æ–­è½¯ä»¶æ˜¯å¦å®‰è£… function if_installed(){ salt_name=$1 salt_status=`rpm -qa | grep $salt_name` if [ ! -n \u0026#34;$salt_status\u0026#34; ];then echo \u0026#34;$salt_nameæ²¡æœ‰å®‰è£…\u0026#34; return 2 else echo \u0026#34;$salt_nameå·²ç»å®‰è£…\u0026#34; echo $salt_status fi } #å®‰è£…masterç»„ä»¶ function install_master(){ salt_name=$1 if_installed $salt_name if [ $? -eq 2 ];then yum install -y https://repo.saltstack.com/yum/redhat/salt-repo-latest-2.el7.noarch.rpm sed -i \u0026#34;s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\u0026#34; /etc/yum.repos.d/salt-latest.repo yum install -y $salt_name systemctl enable $salt_name systemctl start $salt_name\techo \u0026#34;s$salt_nameå·²ç»å®‰è£…\u0026#34; fi } #4)salt-minioné…ç½® function salt-minion(){ read -p \u0026#34;è¯·è¾“salt-masterçš„IP:\u0026#34; master_ip if [ ! -n \u0026#34;$master_ip\u0026#34; ];then echo \u0026#34;æœªè·å–salt-masterçš„IPï¼Œæ— æ³•é…ç½®salt-minion\u0026#34; else if [ -f \u0026#34;$minion_file\u0026#34; ]; then num1=`grep -vE \u0026#39;^#|^$\u0026#39; $minion_file | grep master |wc -l ` old_ip=`grep -vE \u0026#39;^#|^$\u0026#39; $minion_file | grep master | awk -F \u0026#34;:\u0026#34; \u0026#39;{print $2}\u0026#39;` if [ $num1 -eq 0 ];then sed -i \u0026#34;17i master: $master_ip\u0026#34; $minion_file echo \u0026#34;salt-minioné…ç½®salt-masterçš„IPä¸ºï¼š$master_ip\u0026#34; else sed -i \u0026#34;s/$old_ip/$master_ip/\u0026#34; $minion_file echo \u0026#34;salt-minioné…ç½®salt-masterçš„IPä¸ºï¼š$master_ip\u0026#34; fi else echo \u0026#34;$minion_fileæ–‡ä»¶ä¸å­˜åœ¨\u0026#34; fi fi } #åˆ é™¤è½¯ä»¶ function salt_remove(){ salt_name=$1 salt_status=`rpm -qa | grep $salt_name` if [ ! -n \u0026#34;$salt_status\u0026#34; ];then echo \u0026#34;$salt_nameæ²¡æœ‰å®‰è£…\u0026#34; else rpm -qa | grep $salt_name | xargs rpm -e if [ $? -eq 0 ];then echo \u0026#34;$salt_nameå·²ç»å¸è½½\u0026#34; fi fi } #é‡å¯æœåŠ¡ function salt_restart(){ salt_name=$1 if_installed $salt_name if [ $? -eq 2 ];then echo \u0026#34;\u0026#34; else systemctl restart $salt_name echo \u0026#34;$salt_nameå·²ç»é‡å¯\u0026#34; fi } #èœå• function menu() { echo -e \u0026#34; $datetime\u0026#34; cat \u0026lt;\u0026lt;EOF -------------------------------------------- `echo -e \u0026#34; $black SaltStackèœå•ä¸»é¡µ$background\u0026#34;` `echo -e \u0026#34;$Orange 1)å®‰è£…slat-master $background\u0026#34;` `echo -e \u0026#34;$Orange 2)å®‰è£…salt-minion$background\u0026#34;` `echo -e \u0026#34;$Orange 3)æ˜¯å¦è½¯ä»¶å®‰è£…æŸ¥è¯¢$background\u0026#34;` `echo -e \u0026#34;$Orange 4)salt-minioné…ç½®$background\u0026#34;` `echo -e \u0026#34;$Orange 5)å¸è½½slat-master$background\u0026#34;` `echo -e \u0026#34;$Orange 6)å¸è½½slat-minion$background\u0026#34;` `echo -e \u0026#34;$Orange 7)é‡å¯slat-master$background\u0026#34;` `echo -e \u0026#34;$Orange 8)é‡å¯slat-minion$background\u0026#34;` `echo -e \u0026#34;$Orange Q)é€€å‡º$background\u0026#34;` -------------------------------------------- EOF read -p \u0026#34;è¯·è¾“å…¥å¯¹åº”åºåˆ—å·ï¼š\u0026#34; num1 case $num1 in 1) install_master salt-master menu ;; 2) install_master salt-minion menu ;; 3) if_installed salt-master if_installed salt-minion menu ;; 4) salt-minion menu ;; 5) salt_remove salt-master menu ;; 6) salt_remove salt-minion menu ;; 7) salt_restart salt-master menu ;; 8) salt_restart salt-minion menu ;; Q|q) exit 0 ;; *) echo -e \u0026#34;\\033[31m errï¼šè¯·è¾“å…¥æ­£ç¡®çš„ç¼–å·\\033[0m\u0026#34; menu esac } menu ","date":"2021-02-27T18:39:16Z","image":"https://www.ownit.top/title_pic/30.jpg","permalink":"https://www.ownit.top/p/202102271839/","title":"SaltStackè„šæœ¬å®‰è£…"},{"content":"æ­¤è„šæœ¬é€‚åˆRedhatç³»åˆ—\ncentosç³»åˆ—ï¼Œå†…å­˜ç¼“å­˜è®¡æ•°ä½ç½®ä¸åŒï¼Œå¯èƒ½ä¸å‡†ç¡®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 #!/bin/bash ##ç³»ç»Ÿä¿¡æ¯## sys_check(){ os_type=`uname` echo \u0026#34;æ“ä½œç³»ç»Ÿç±»å‹æ˜¯:$os_type\u0026#34; os_banben=`cat /etc/redhat-release` echo \u0026#34;æ“ä½œç³»ç»Ÿç‰ˆæœ¬å·æ˜¯:$os_banben\u0026#34; os_neihe=`uname -r` echo \u0026#34;æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ˜¯:$os_neihe\u0026#34; os_time=`date +%F_%T` echo \u0026#34;æ“ä½œç³»ç»Ÿå½“å‰æ—¶é—´æ˜¯:$os_time\u0026#34; os_uptime=`uptime | awk \u0026#39;{print $3}\u0026#39;|awk -F , \u0026#39;{print $1}\u0026#39;` echo \u0026#34;æ“ä½œç³»ç»Ÿæœ€åé‡å¯æ—¶é—´ä¸º:$os_uptime\u0026#34; os_hostname=`hostname` echo \u0026#34;æ“ä½œç³»ç»Ÿä¸»æœºåç§°ä¸º:$os_hostname\u0026#34; } ##ç½‘ç»œä¿¡æ¯## net_check(){ net_ip=`/sbin/ifconfig -a|grep inet|grep -v 127.0.0.1|grep -v inet6|awk \u0026#39;{print $2}\u0026#39;|tr -d \u0026#34;addr:\u0026#34;` echo \u0026#34;æ“ä½œç³»ç»Ÿçš„ipæ˜¯:$net_ip\u0026#34; ping -c1 www.baidu.com \u0026gt;/dev/null if [ $? -eq 0 ];then echo \u0026#34;å¤–ç½‘å¯ä»¥è¿é€š\u0026#34; else echo \u0026#34;å¤–ç½‘è¿ä¸é€šï¼Œè¯·æ£€æŸ¥\u0026#34; fi } cpu_check(){ physical_id=`cat /proc/cpuinfo | grep \u0026#34;physical id\u0026#34;|sort|uniq|wc -l` echo \u0026#34;æ“ä½œç³»ç»Ÿcpuç‰©ç†ä¸ªæ•°æ˜¯:$physical_id\u0026#34; cpu_core=`cat /proc/cpuinfo | grep \u0026#34;cpu cores\u0026#34;|sort|uniq|awk -F \u0026#39;:\u0026#39; \u0026#39;{print $2}\u0026#39;` echo \u0026#34;æ“ä½œç³»ç»Ÿçš„cpuæ ¸å¿ƒæ•°æ˜¯:$cpu_core\u0026#34; cpu_type=`cat /proc/cpuinfo | grep \u0026#34;model name\u0026#34;|sort|uniq|awk -F \u0026#39;:\u0026#39; \u0026#39;{print $2}\u0026#39;` echo \u0026#34;æ“ä½œç³»ç»Ÿçš„cpuå‹å·æ˜¯:$cpu_type\u0026#34; free_total=`free -m | grep Mem|awk \u0026#39;{printf $2}\u0026#39;` echo \u0026#34;æ“ä½œç³»ç»Ÿçš„å†…å­˜æ€»å¤§å°ä¸º:$free_total M\u0026#34; free_used=`free -m | grep Mem|awk \u0026#39;{printf $3}\u0026#39;` echo \u0026#34;æ“ä½œç³»ç»Ÿå·²ä½¿ç”¨å†…å­˜ä¸º:$free_used M\u0026#34; free_shengyu=`free -m | grep Mem|awk \u0026#39;{printf $4}\u0026#39;` echo \u0026#34;æ“ä½œç³»ç»Ÿå‰©ä½™å†…å­˜ä¸º:$free_shengyu M\u0026#34; used_baifen=`echo \u0026#34;scale=2;$free_used/$free_total*100\u0026#34;|bc` echo \u0026#34;å·²ä½¿ç”¨å†…å­˜ç™¾åˆ†æ¯”æ˜¯:$used_baifen\u0026#34;% shengyu_baifen=`echo \u0026#34;scale=2;$free_shengyu/$free_total*100\u0026#34;|bc` echo \u0026#34;æœªä½¿ç”¨å†…å­˜ç™¾åˆ†æ¯”æ˜¯:$shengyu_baifen\u0026#34;% } disk_check(){ disk_size=`lsblk | grep -w sda |awk \u0026#39;{print $4}\u0026#39;` echo \u0026#34;ç£ç›˜æ€»é‡ä¸º:$disk_size\u0026#34; a=($(df -m | grep -v \u0026#34;tmpfs\u0026#34; | egrep -A 1 \u0026#34;mapper|sd\u0026#34; | awk \u0026#39;NF\u0026gt;1{print $(NF-2)}\u0026#39;)) sum=0 for i in ${a[*]} do let sum=sum+$i done shengfree=$[$sum/1024] echo \u0026#34;å‰©ä½™ç£ç›˜æ€»é‡ä¸º:$shengfree\u0026#34; G } sys_check net_check cpu_check disk_check ","date":"2021-02-25T14:11:07Z","image":"https://www.ownit.top/title_pic/15.jpg","permalink":"https://www.ownit.top/p/202102251411/","title":"Redhatæœºå™¨å·¡æ£€è„šæœ¬"},{"content":"æ•°æ®åº“å¤‡ä»½è„šæœ¬\næŒ‰ç…§æ—¶é—´æ¥åˆ›å»ºç›®å½•å¤‡ä»½æ•°æ®ï¼Œéœ€è¦é…åˆcrontab\n1 00 1 * * * root /etc/mysqldumpjumpser.sh æ¯å¤©æ—©ä¸Šå‡Œæ™¨1ç‚¹å¤‡ä»½æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #!/bin/bash USER=jumpserver PASS=jumpserver DBDIR=/databak/Data_Backup #DAY=`date +%Y%m%d` #å¹´æœˆ MONTH=`date +%Y%m` #æ—¥æœŸæ—¶é—´ DT=`date \u0026#39;+%Y%m%d%H%M\u0026#39;` #ä¸»æœºip DBIP=`cat /etc/sysconfig/network-scripts/ifcfg-eth0 | grep IPADDR | awk -F \u0026#39;\u0026#34;\u0026#39; \u0026#39;{print $2}\u0026#39;` #åˆ›å»ºå¤‡ä»½ç›®å½• mkdir -p $DBDIR/$DBIP/$MONTH å¤‡ä»½æ•°æ®åº“ for dbname in jumpserver do mysqldump -u$USER -p$PASS -R --single-transaction $dbname 2\u0026gt;\u0026gt;$DBDIR/$DBIP/$MONTH/error-$DT.log |gzip \u0026gt; $DBDIR/$DBIP/$MONTH/$dbname-$DBIP-$DT.sql.gz # ç”Ÿæˆmd5sumæ–‡ä»¶ md5sum $DBDIR/$DBIP/$MONTH/$dbname-$DBIP-$DT.sql.gz \u0026gt; $DBDIR/$DBIP/$MONTH/$dbname-$DBIP-$DT.sql.gz.MD5 done # check and delete old datafile. #åˆ é™¤è¶…è¿‡30å¤©çš„æ–‡ä»¶ï¼Œå¹¶åˆ é™¤ç›®å½• del_backup_dir=/databak/Data_Backup/$DBIP cd $del_backup_dir if [ $? = 0 ]; then find ./ -type f -mtime +30 -exec rm -rf {} \\; \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 find -depth -type d -empty -exec rmdir {} \\; fi #å‹ç¼©å¤‡ä»½ #mysqldump -uroot -proot --databases abc 2\u0026gt;/dev/null |gzip \u0026gt;/abc.sql.gz #è¿˜åŸ #gunzip -c abc.sql.gz |mysql -uroot -proot abc æ¯æœˆå¤‡ä»½çš„æ•°æ®ä¼šæ”¾åˆ°ä¸€ä¸ªç›®å½•ï¼Œååˆ†ä¹±ï¼Œä¸å®¹æ˜“çœ‹ï¼Œè¿™è¾¹æ”¹è¿›ä¸€ä¸‹\næ²¡æœ‰å¤šå¤§çš„æ”¹å˜ï¼Œå°±æ˜¯åŠ äº†DAY=`date -d \u0026lsquo;-1 days\u0026rsquo; +%d` ï¼šæ˜¾ç¤ºä¸Šä¸€å¤©çš„æ—¥æœŸï¼Œæˆ‘ä»¬crontabæ˜¯å‡Œæ™¨1ç‚¹å¤‡ä»½ï¼Œä¹Ÿå°±æ˜¯å¤‡ä»½ä¸Šä¸€å¤©çš„æ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #!/bin/bash USER=jumpserver PASS=jumpserver DBDIR=/databak/Data_Backup DAY=`date -d \u0026#39;-1 days\u0026#39; +%d` MONTH=`date +%Y%m` DT=`date \u0026#39;+%Y%m%d%H%M\u0026#39;` DBIP=`cat /etc/sysconfig/network-scripts/ifcfg-eth0 | grep IP | awk -F \u0026#39;\u0026#34;\u0026#39; \u0026#39;{print $2}\u0026#39;` mkdir -p $DBDIR/$DBIP/$MONTH/$DAY for dbname in jumpserver do mysqldump -u$USER -p$PASS -R --single-transaction $dbname 2\u0026gt;\u0026gt;$DBDIR/$DBIP/$MONTH/$DAY/error-$DT.log |gzip \u0026gt; $DBDIR/$DBIP/$MONTH/$DAY/$dbname-$DBIP-$DT.sql.gz # ç”Ÿæˆmd5sumæ–‡ä»¶ md5sum $DBDIR/$DBIP/$MONTH/$DAY/$dbname-$DBIP-$DT.sql.gz \u0026gt; $DBDIR/$DBIP/$MONTH/$DAY/$dbname-$DBIP-$DT.sql.gz.MD5 done # check and delete old datafile. del_backup_dir=/databak/Data_Backup/$DBIP cd $del_backup_dir if [ $? = 0 ]; then find ./ -type f -mtime +30 -exec rm -rf {} \\; \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 find -depth -type d -empty -exec rmdir {} \\; fi #å‹ç¼©å¤‡ä»½ #mysqldump -uroot -proot --databases abc 2\u0026gt;/dev/null |gzip \u0026gt;/abc.sql.gz #è¿˜åŸ #gunzip -c abc.sql.gz |mysql -uroot -proot abc ä»¥æ—¥æœŸç›®å½•åˆ†ç±»ï¼Œå¯ä»¥æ›´æ–¹ä¾¿çš„æ¸…æ¥š\n","date":"2021-02-25T14:07:58Z","image":"https://www.ownit.top/title_pic/13.jpg","permalink":"https://www.ownit.top/p/202102251407/","title":"Mysqlæ•°æ®åº“å¤‡ä»½è„šæœ¬"},{"content":"rsync 1.1 rsyncæ˜¯ä»€ä¹ˆ\nrsyncæ˜¯ä¸€æ¬¾å¼€æºçš„ï¼Œå¿«é€Ÿçš„ã€å¤šåŠŸèƒ½çš„ã€å¯å®ç°å…¨é‡åŠå¢é‡çš„æœ¬åœ°æˆ–è¿œç¨‹æ•°æ®åŒæ­¥å¤‡ä»½çš„ä¼˜ç§€å·¥å…·åŒæ­¥å¤‡ä»½çš„ä¼˜ç§€å·¥å…·\n1.2 rsyncçš„ç‰¹æ€§å¦‚ä¸‹ï¼š\næ”¯æŒæ‹·è´ç‰¹æ®Šæ–‡ä»¶å¦‚é“¾æ¥æ–‡ä»¶ï¼Œè®¾å¤‡ç­‰ å¯ä»¥æœ‰æ’é™¤æŒ‡å®šæ–‡ä»¶æˆ–ç›®å½•åŒæ­¥çš„åŠŸèƒ½ï¼Œç›¸å½“äºæ‰“åŒ…å‘½ä»¤tarçš„æ’é™¤åŠŸèƒ½ã€‚ å¯ä»¥åšåˆ°ä¿æŒåŸæ–‡ä»¶æˆ–ç›®å½•ç­‰æƒé™ï¼Œæ—¶é—´ï¼Œè½¯ç¡¬é“¾æ¥ï¼Œå±ä¸»ï¼Œå±ç»„ç­‰æ‰€æœ‰å±æ€§å‡ä¸æ”¹å˜ â€“p å¯å®ç°å¢é‡åŒæ­¥ï¼Œå³åªåŒæ­¥å‘ç”Ÿå˜åŒ–çš„æ•°æ®ï¼Œå› æ­¤æ•°æ®ä¼ è¾“æ•ˆç‡å¾ˆé«˜ å¯ä»¥ä½¿ç”¨rcp,rsh,sshç­‰æ–¹å¼æ¥é…ç½®ä¼ è¾“æ–‡ä»¶ï¼ˆrsyncæœ¬èº«ä¸å¯¹æ•°æ®åŠ å¯†ï¼‰ å¯ä»¥é€šè¿‡socketï¼ˆå®ˆæŠ¤è¿›ç¨‹æ–¹å¼ï¼‰ä¼ è¾“æ–‡ä»¶å’Œæ•°æ®ï¼ˆæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼‰ æ”¯æŒåŒ¿åæˆ–è®¤è¯ï¼ˆæ— éœ€ç³»ç»Ÿç”¨æˆ·ï¼‰çš„è¿›ç¨‹æ¨¡å¼ä¼ è¾“ï¼Œå¯å®ç°æ–¹ä¾¿å®‰å…¨çš„è¿›è¡Œæ•°æ®å¤‡ä»½åŠé•œåƒ rsyncä¹Ÿç›¸å½“äºlså‘½ä»¤ 1.3 rsyncçš„ä¼ä¸šå·¥ä½œåœºæ™¯è¯´æ˜\nä¸¤å°æœåŠ¡å™¨ä¹‹é—´æ•°æ®åŒæ­¥ï¼ˆå®šæ—¶ä»»åŠ¡+rsyncï¼‰ å®æ—¶åŒæ­¥ï¼ˆè§£å†³å­˜å‚¨æœåŠ¡å™¨çš„å•ç‚¹é—®é¢˜ï¼‰ Rsync+Inotify-toolsä¸Rsync+sersyncè¿™ä¸¤ç§æ¶æ„æœ‰ä»€ä¹ˆåŒºåˆ« 1ï¼Rsync+Inotify-tools ï¼ˆ1ï¼‰ï¼šInotify-toolsåªèƒ½è®°å½•ä¸‹è¢«ç›‘å¬çš„ç›®å½•å‘ç”Ÿäº†å˜åŒ–ï¼ˆåŒ…æ‹¬å¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ï¼‰ï¼Œå¹¶æ²¡æœ‰æŠŠå…·ä½“æ˜¯å“ªä¸ªæ–‡ä»¶æˆ–è€…å“ªä¸ªç›®å½•å‘ç”Ÿäº†å˜åŒ–è®°å½•ä¸‹æ¥ï¼›\nï¼ˆ2ï¼‰ï¼šrsyncåœ¨åŒæ­¥çš„æ—¶å€™ï¼Œå¹¶ä¸çŸ¥é“å…·ä½“æ˜¯å“ªä¸ªæ–‡ä»¶æˆ–è€…å“ªä¸ªç›®å½•å‘ç”Ÿäº†å˜åŒ–ï¼Œæ¯æ¬¡éƒ½æ˜¯å¯¹æ•´ä¸ªç›®å½•è¿›è¡ŒåŒæ­¥ï¼Œå½“æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œæ•´ä¸ªç›®å½•åŒæ­¥éå¸¸è€—æ—¶ï¼ˆrsyncè¦å¯¹æ•´ä¸ªç›®å½•éå†æŸ¥æ‰¾å¯¹æ¯”æ–‡ä»¶ï¼‰ï¼Œå› æ­¤ï¼Œæ•ˆç‡å¾ˆä½ã€‚\n2ï¼Rsync+sersync ï¼ˆ1ï¼‰sersyncå¯ä»¥è®°å½•ä¸‹è¢«ç›‘å¬ç›®å½•ä¸­å‘ç”Ÿå˜åŒ–çš„ï¼ˆåŒ…æ‹¬å¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ï¼‰å…·ä½“æŸä¸€ä¸ªæ–‡ä»¶æˆ–æŸä¸€ä¸ªç›®å½•çš„åå­—ï¼›\nï¼ˆ2ï¼‰rsyncåœ¨åŒæ­¥çš„æ—¶å€™ï¼ŒåªåŒæ­¥å‘ç”Ÿå˜åŒ–çš„è¿™ä¸ªæ–‡ä»¶æˆ–è€…è¿™ä¸ªç›®å½•ï¼ˆæ¯æ¬¡å‘ç”Ÿå˜åŒ–çš„æ•°æ®ç›¸å¯¹æ•´ä¸ªåŒæ­¥ç›®å½•æ•°æ®æ¥è¯´æ˜¯å¾ˆå°çš„ï¼Œrsyncåœ¨éå†æŸ¥æ‰¾æ¯”å¯¹æ–‡ä»¶æ—¶ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼‰ï¼Œå› æ­¤ï¼Œæ•ˆç‡å¾ˆé«˜ã€‚\nåŒæ­¥è¿‡ç¨‹ï¼š 1.Â åœ¨åŒæ­¥æœåŠ¡å™¨ä¸Šå¼€å¯sersyncæœåŠ¡ï¼Œsersyncè´Ÿè´£ç›‘æ§é…ç½®è·¯å¾„ä¸­çš„æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶å˜åŒ–ï¼›\n2.Â è°ƒç”¨rsyncå‘½ä»¤æŠŠæ›´æ–°çš„æ–‡ä»¶åŒæ­¥åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼›\n3.Â éœ€è¦åœ¨ä¸»æœåŠ¡å™¨é…ç½®sersyncï¼Œåœ¨åŒæ­¥ç›®æ ‡æœåŠ¡å™¨é…ç½®rsync serverï¼ˆæ³¨æ„ï¼šæ˜¯rsyncæœåŠ¡ï¼‰\nåŒæ­¥è¿‡ç¨‹å’ŒåŸç†ï¼š 1.Â ç”¨æˆ·å®æ—¶çš„å¾€sersyncæœåŠ¡å™¨ä¸Šå†™å…¥æ›´æ–°æ–‡ä»¶æ•°æ®ï¼›\n2.Â æ­¤æ—¶éœ€è¦åœ¨åŒæ­¥ä¸»æœåŠ¡å™¨ä¸Šé…ç½®sersyncæœåŠ¡ï¼›\n3.Â åœ¨å¦ä¸€å°æœåŠ¡å™¨å¼€å¯rsyncå®ˆæŠ¤è¿›ç¨‹æœåŠ¡ï¼Œä»¥åŒæ­¥æ‹‰å–æ¥è‡ªsersyncæœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼›\né€šè¿‡rsyncçš„å®ˆæŠ¤è¿›ç¨‹æœåŠ¡åå¯ä»¥å‘ç°ï¼Œå®é™…ä¸Šsersyncå°±æ˜¯ç›‘æ§æœ¬åœ°çš„æ•°æ®å†™å…¥æˆ–æ›´æ–°äº‹ä»¶ï¼›ç„¶åï¼Œåœ¨è°ƒç”¨rsyncå®¢æˆ·ç«¯çš„å‘½ä»¤ï¼Œå°†å†™å…¥æˆ–æ›´æ–°äº‹ä»¶å¯¹åº”çš„æ–‡ä»¶é€šè¿‡rsyncæ¨é€åˆ°ç›®æ ‡æœåŠ¡å™¨\nå°ç»“ï¼šå½“åŒæ­¥çš„ç›®å½•æ•°æ®é‡ä¸å¤§æ—¶ï¼Œå»ºè®®ä½¿ç”¨Rsync+Inotify-toolsï¼›å½“æ•°æ®é‡å¾ˆå¤§ï¼ˆå‡ ç™¾Gç”šè‡³1Tä»¥ä¸Šï¼‰ã€æ–‡ä»¶å¾ˆå¤šæ—¶ï¼Œå»ºè®®ä½¿ç”¨Rsync+sersyncã€‚\nä¸‰ã€é…ç½®æ“ä½œ **ä¸€å°è£…rsyncæœåŠ¡ **192.168.0.10\n**ä¸€å°è£…sersyncÂ **192.168.0.20\nå¯¹20ç½‘ç«™æ ¹ç›®å½•çš„/backupç›®å½•å¤‡ä»½åˆ°10çš„/backup\n**RsyncæœåŠ¡å™¨ï¼ˆå¤‡ä»½ç«¯ç£ç›˜å¤§ä¸“é—¨ç”¨æ¥å­˜å‚¨æ•°æ®Â ,ç›®æ ‡æœºå™¨ï¼‰ï¼š**192.168.0.10\n**SersyncæœåŠ¡å™¨ï¼ˆæ•°æ®æºã€éƒ¨ç½²çš„é¡¹ç›®ï¼Œä»£ç ç­‰ã€‘,æºæœºå™¨ ï¼‰ï¼šÂ **192.168.0.20\nï¼ˆ1ï¼‰ã€ä½¿ç”¨rsyncå¤‡ä»½æ•°æ® ç³»ç»Ÿç”¨æˆ· ä¸¤å°æœåŠ¡å™¨éƒ½éœ€è¦å®‰è£…rsync\n1 yum -y install xinetd rsync 20éœ€è¦å®‰è£…sersync\nåŸç†ï¼š10 ä¸Š ä½¿ç”¨ç³»ç»Ÿé…ç½®æ–‡ä»¶ vimÂ /etc/rsyncd.conf æ¥å¤‡ä»½æ•°æ®ï¼Œåˆ›å»ºå¤‡ä»½è´¦æˆ·ï¼Œæœ€åæŠŠrsyncä»¥deamonæ–¹å¼è¿è¡Œ\n**Â vimÂ /etc/rsyncd.confÂ rsyncd.confé…ç½®æ–‡ä»¶**\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #!/bin/bash uid = root gid = root use chroot = no disable = no fake super = yes max connections = 200 timeout = 300 pid file=/var/run/rsyncd.pid lock file=/var/run/rsync.lock log file = /var/log/rsyncd.log [backup] path = /backup ignore errors read only = false list = false hosts allow = 192.168.0.0/24 host deny = 0.0.0.0/0 auth users = rsync_backup secrets file = /etc/rsync.password [root@backup ~]# useradd -M -s /sbin/nologin rsync #å¯ä»¥ä½¿ç”¨rsyncï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯root [root@backup backup]# mkdir /backup/ åˆ›å»ºå¤‡ä»½çš„ç›®å½• åˆ›å»ºå¯†ç æ–‡ä»¶\n1 2 3 [root@backup ~]# echo \u0026#39;rsync_backup:123456\u0026#39; \u0026gt;/etc/rsync.password [root@backup ~]# cat /etc/rsync.password rsync_backup:123456 ä¿®æ”¹æƒé™\n1 2 3 [root@backup ~]# chmod 600 /etc/rsync.password [root@backup ~]# ll /etc/rsync.password -rw-------. 1 root root 20 Jul 24 04:27 /etc/rsync.password å¯åŠ¨rsyncæœåŠ¡\n1 [root@backup ~]# rsync -â€“daemon åŠ å…¥å¼€æœºè‡ªå¯åŠ¨\n1 2 3 4 5 6 7 8 [root@backup ~]# vim /etc/rc.local # rsync server progress /usr/bin/rsync --daemon 1.5.7 ç¬¬å…­ä¸ªé‡Œç¨‹ç¢‘-æ£€æŸ¥ rsyncçš„ç«¯å£å·ä¸º873 [root@backup ~]# ss -tlunp|grep rsync tcp LISTEN 0 5 :::873 :::* users:((\u0026#34;rsync\u0026#34;,2452,5)) tcp LISTEN 0 5 *:873 *:* users:((\u0026#34;rsync\u0026#34;,2452,4)) é‡å¯rsync\n1 2 3 4 5 6 7 8 9 10 11 12 [root@rsync-client-sersync ~]# ps -ef | grep rsync root 1287 1 0 22:52 ? 00:00:00 rsync --daemon root 1294 1248 0 22:52 pts/0 00:00:00 grep --color=auto rsync [root@rsync-client-sersync ~]# kill -9 1287 [root@rsync-client-sersync ~]# ps -ef | grep rsync root 1298 1248 0 22:53 pts/0 00:00:00 grep --color=auto rsync [root@rsync-client-sersync ~]# rsync --daemon [root@rsync-client-sersync ~]# ps -ef | grep rsync root 1300 1 0 22:53 ? 00:00:00 rsync --daemon root 1302 1248 0 22:53 pts/0 00:00:00 grep --color=auto rsync é‡å¯ï¼Œå°±æ˜¯æ€æ‰rsyncçš„è¿›ç¨‹ï¼Œé‡æ–°rsync --daemon åœ¨å®¢æˆ·ç«¯è¿›è¡Œæµ‹è¯•ï¼ˆ20ï¼‰\n1 2 3 4 5 6 7 8 [root@rsync-client-sersync ~]# rsync -avz /etc/hosts rsync_backup@192.168.0.10::backup Password: sending incremental file list hosts sent 140 bytes received 43 bytes 33.27 bytes/sec total size is 158 speedup is 0.86 æˆåŠŸçš„å°†hostsæ–‡ä»¶æ¨å‘æœåŠ¡å™¨ç«¯çš„/backupç›®å½•ä¸­ å®¢æˆ·ç«¯æ·»åŠ å¯†ç \n1 2 3 4 [root@nfs01 tmp]# echo \u0026#39;123456\u0026#39; \u0026gt;/etc/rsync.password å°†å¯†ç é‡å®šå‘åˆ°/etc/rsync.passwordæ–‡ä»¶ [root@nfs01 tmp]# cat /etc/rsync.password æŸ¥çœ‹ 123456 [root@nfs01 tmp]# chmod 600 /etc/rsync.password ç»™/etc/rsync.passwordæ–‡ä»¶600çš„æƒé™ 1 rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password æŒ‡å®šå¯†ç æ–‡ä»¶ å®ä¾‹ï¼šæ’é™¤æ–‡ä»¶\n1 2 3 4 5 [root@backup tmp]# rsync -a â€“-exclude=/etc/hosts /etc/services 172.16.1.31:/tmp/ â€“-exclude=/etc/hosts æ’é™¤/etc/servicesä¸­çš„/etc/hostsæ–‡ä»¶ --bwlimit=RATE limt socket I/O bandwidth ä¼ è¾“çš„æ—¶å€™é™é€Ÿ --delete è®©æºç›®å½•å’Œç›®æ ‡ç›®å½•ä¸€æ¨¡ä¸€æ ·ï¼ˆå³ï¼šæˆ‘æœ‰ä»€ä¹ˆä½ å°±æœ‰ä»€ä¹ˆï¼Œæˆ‘æ²¡ä»€ä¹ˆä½ å°±æ²¡æœ‰ä»€ä¹ˆï¼‰ å®ä¾‹ï¼šæ— å·®å¼‚åŒæ­¥ 1 2 3 [root@backup tmp]# rsync -a --delete /tmp/ 172.16.1.31:/tmp/ root@172.16.1.31\u0026#39;s password: --delete æœ¬åœ°æœ‰ä»€ä¹ˆï¼Œè¿œç«¯å°±æœ‰ä»€ä¹ˆ æœ¬åœ°æ²¡æœ‰ä»€ä¹ˆï¼Œè¿œç«¯å°±æ²¡æœ‰ä»€ä¹ˆ æœ¬åœ°æœ‰è¿œç«¯æ²¡æœ‰ï¼Œå°±ä¼šåˆ é™¤è¿œ ï¼ˆ2ï¼‰ã€ä½¿ç”¨sersyncå®æ—¶ç›‘æ§æ¨é€ 1**ã€ä¸‹è½½sersync**\nåœ¨google codeä¸‹è½½sersyncçš„å¯æ‰§è¡Œæ–‡ä»¶ç‰ˆæœ¬ï¼Œé‡Œé¢æœ‰é…ç½®æ–‡ä»¶ä¸å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™ç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 mkdir -p /applition/tools cd /applition/tools wgethttps://sersync.googlecode.com/files/sersync2.5.4_64bit_binary_stable_final.tar.gz ã€æœ‰æ—¶ä¸‹è½½å¤±è´¥ï¼Œæ‰€æœ‰è¦æœ¬åœ°ç•™å­˜æ‰è¡Œã€‘ [root@web ~]# tar fxzsersync2.5.4_64bit_binary_stable_final.tar.gz -C /usr/local/ [root@web ~]# cd /usr/local/ [root@cache local]# mv GNU-Linux-x86 sersync [root@cache local]# treesersync/ sersync/ â”œâ”€â”€ confxml.xml # é…ç½®æ–‡ä»¶ â””â”€â”€ sersync2 # äºŒè¿›åˆ¶æ–‡ä»¶ã€å¯åŠ¨sersyncä½¿ç”¨ã€‘ 0 directories, 2 files 2**ã€é…ç½®sersync**\n1 2 3 4 5 6 [root@cache local]# cp sersync/confxml.xmlsersync/confxml.xml.$(date +%F) [root@cache local]# ll sersync/confxml.xml -rwxr-xr-x. 1 root root 2214Oct 26 2011 sersync/confxml.xml [root@cache local]# llsersync/confxml.xml* -rwxr-xr-x. 1 root root 2214Oct 26 2011 sersync/confxml.xml -rwxr-xr-x. 1 root root 2214Jun 5 06:38sersync/confxml.xml.2015-06-05 æ›´æ”¹ä¼˜åŒ–sersyncé…ç½®æ–‡ä»¶ï¼š\n1 2 3 4 5 \u0026lt;localpathwatch=\u0026#34;/opt/tongbu\u0026#34;\u0026gt; # å®šä¹‰æœ¬åœ°è¦åŒæ­¥çš„ç›®å½• \u0026lt;remote ip=\u0026#34;127.0.0.1\u0026#34;name=\u0026#34;tongbu1\u0026#34;/\u0026gt; \u0026lt;!--\u0026lt;remoteip=\u0026#34;192.168.8.39\u0026#34; name=\u0026#34;tongbu\u0026#34;/\u0026gt;--\u0026gt; # åŒæ­¥åˆ°å“ªå°æœºå™¨ä¸Š tongbuæ¨¡å—rsyncç«¯æ¨¡å—åå­— \u0026lt;!--\u0026lt;remoteip=\u0026#34;192.168.8.40\u0026#34; name=\u0026#34;tongbu\u0026#34;/\u0026gt;--\u0026gt; # åŒæ­¥åˆ°å“ªå°æœºå™¨ä¸Š tongbuæ¨¡å— \u0026lt;/localpath\u0026gt; b**ï¼‰ä¿®æ”¹31\u0026ndash;34è¡Œï¼Œè®¤è¯éƒ¨åˆ†ã€rsyncå¯†ç è®¤è¯ã€‘**\n1 2 3 4 5 6 7 8 9 10 \u0026lt;rsync\u0026gt; \u0026lt;commonParamsparams=\u0026#34;-artuz\u0026#34;/\u0026gt; \u0026lt;auth start=\u0026#34;false\u0026#34;users=\u0026#34;root\u0026#34; passwordfile=\u0026#34;/etc/rsync.pas\u0026#34;/\u0026gt; \u0026lt;userDefinedPortstart=\u0026#34;false\u0026#34; port=\u0026#34;874\u0026#34;/\u0026gt;\u0026lt;!-- port=874 --\u0026gt; \u0026lt;timeoutstart=\u0026#34;false\u0026#34; time=\u0026#34;100\u0026#34;/\u0026gt;\u0026lt;!-- timeout=100 --\u0026gt; \u0026lt;sshstart=\u0026#34;false\u0026#34;/\u0026gt; \u0026lt;/rsync\u0026gt; # ***ä¿®æ”¹å†…å®¹ä¸º rsyncçš„å¯†ç æ–‡ä»¶ä»¥åŠ åŒæ­¥æ‰€ä½¿ç”¨çš„è´¦å·ç±»ä¼¼ï¼š rsync -avzP /data/www/rsync_backup@172.16.1.25::www/ --password-file=/etc/rsync.password 1 2 \u0026lt;failLog path=\u0026#34;/usr/local/sersync/logs/rsync_fail_log.sh\u0026#34;timeToExecute=\u0026#34;60\u0026#34;/\u0026gt;\u0026lt;!--default every 60mins execute once--\u0026gt; # å½“åŒæ­¥å¤±è´¥åï¼Œæ—¥å¿—è®°å½•åˆ°/usr/local/sersync/logs/rsync_fail_log.shæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”æ¯60åˆ†é’Ÿå¯¹å¤±è´¥çš„logè¿›è¡Œé‡æ–°åŒæ­¥ ä¿®æ”¹åçš„å®Œæ•´é…ç½®æ–‡ä»¶ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;ISO-8859-1\u0026#34;?\u0026gt; \u0026lt;head version=\u0026#34;2.5\u0026#34;\u0026gt; \u0026lt;host hostip=\u0026#34;localhost\u0026#34; port=\u0026#34;8008\u0026#34;\u0026gt;\u0026lt;/host\u0026gt; \u0026lt;debug start=\u0026#34;false\u0026#34;/\u0026gt; \u0026lt;fileSystem xfs=\u0026#34;false\u0026#34;/\u0026gt; \u0026lt;filter start=\u0026#34;false\u0026#34;\u0026gt; \u0026lt;exclude expression=\u0026#34;(.*)\\.svn\u0026#34;\u0026gt;\u0026lt;/exclude\u0026gt; \u0026lt;exclude expression=\u0026#34;(.*)\\.gz\u0026#34;\u0026gt;\u0026lt;/exclude\u0026gt; \u0026lt;exclude expression=\u0026#34;^info/*\u0026#34;\u0026gt;\u0026lt;/exclude\u0026gt; \u0026lt;exclude expression=\u0026#34;^static/*\u0026#34;\u0026gt;\u0026lt;/exclude\u0026gt; \u0026lt;/filter\u0026gt; \u0026lt;inotify\u0026gt; \u0026lt;delete start=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;createFolder start=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;createFile start=\u0026#34;false\u0026#34;/\u0026gt; \u0026lt;closeWrite start=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;moveFrom start=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;moveTo start=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;attrib start=\u0026#34;false\u0026#34;/\u0026gt; \u0026lt;modify start=\u0026#34;false\u0026#34;/\u0026gt; \u0026lt;/inotify\u0026gt; \u0026lt;sersync\u0026gt; \u0026lt;localpath watch=\u0026#34;/etc/openvpn\u0026#34;\u0026gt; \u0026lt;remote ip=\u0026#34;192.168.0.10\u0026#34; name=\u0026#34;openvpn\u0026#34;/\u0026gt; \u0026lt;!--\u0026lt;remote ip=\u0026#34;192.168.8.39\u0026#34; name=\u0026#34;tongbu\u0026#34;/\u0026gt;--\u0026gt; \u0026lt;!--\u0026lt;remote ip=\u0026#34;192.168.8.40\u0026#34; name=\u0026#34;tongbu\u0026#34;/\u0026gt;--\u0026gt; \u0026lt;/localpath\u0026gt; \u0026lt;rsync\u0026gt; \u0026lt;commonParams params=\u0026#34;-artuz\u0026#34;/\u0026gt; \u0026lt;auth start=\u0026#34;true\u0026#34; users=\u0026#34;rsync_backup\u0026#34; passwordfile=\u0026#34;/etc/rsync.password\u0026#34;/\u0026gt; \u0026lt;userDefinedPort start=\u0026#34;false\u0026#34; port=\u0026#34;874\u0026#34;/\u0026gt;\u0026lt;!-- port=874 --\u0026gt; \u0026lt;timeout start=\u0026#34;start\u0026#34; time=\u0026#34;100\u0026#34;/\u0026gt;\u0026lt;!-- timeout=100 --\u0026gt; \u0026lt;ssh start=\u0026#34;false\u0026#34;/\u0026gt; \u0026lt;/rsync\u0026gt; \u0026lt;failLog path=\u0026#34;/tmp/rsync_fail_log.sh\u0026#34; timeToExecute=\u0026#34;60\u0026#34;/\u0026gt;\u0026lt;!--default every 60mins execute once--\u0026gt; \u0026lt;crontab start=\u0026#34;false\u0026#34; schedule=\u0026#34;600\u0026#34;\u0026gt;\u0026lt;!--600mins--\u0026gt; \u0026lt;crontabfilter start=\u0026#34;false\u0026#34;\u0026gt; \u0026lt;exclude expression=\u0026#34;*.php\u0026#34;\u0026gt;\u0026lt;/exclude\u0026gt; \u0026lt;exclude expression=\u0026#34;info/*\u0026#34;\u0026gt;\u0026lt;/exclude\u0026gt; \u0026lt;/crontabfilter\u0026gt; \u0026lt;/crontab\u0026gt; \u0026lt;plugin start=\u0026#34;false\u0026#34; name=\u0026#34;command\u0026#34;/\u0026gt; \u0026lt;/sersync\u0026gt; \u0026lt;plugin name=\u0026#34;command\u0026#34;\u0026gt; \u0026lt;param prefix=\u0026#34;/bin/sh\u0026#34; suffix=\u0026#34;\u0026#34; ignoreError=\u0026#34;true\u0026#34;/\u0026gt;\t\u0026lt;!--prefix /opt/tongbu/mmm.sh suffix--\u0026gt; \u0026lt;filter start=\u0026#34;false\u0026#34;\u0026gt; \u0026lt;include expression=\u0026#34;(.*)\\.php\u0026#34;/\u0026gt; \u0026lt;include expression=\u0026#34;(.*)\\.sh\u0026#34;/\u0026gt; \u0026lt;/filter\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;plugin name=\u0026#34;socket\u0026#34;\u0026gt; \u0026lt;localpath watch=\u0026#34;/opt/tongbu\u0026#34;\u0026gt; \u0026lt;deshost ip=\u0026#34;192.168.138.20\u0026#34; port=\u0026#34;8009\u0026#34;/\u0026gt; \u0026lt;/localpath\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;plugin name=\u0026#34;refreshCDN\u0026#34;\u0026gt; \u0026lt;localpath watch=\u0026#34;/data0/htdocs/cms.xoyo.com/site/\u0026#34;\u0026gt; \u0026lt;cdninfo domainname=\u0026#34;ccms.chinacache.com\u0026#34; port=\u0026#34;80\u0026#34; username=\u0026#34;xxxx\u0026#34; passwd=\u0026#34;xxxx\u0026#34;/\u0026gt; \u0026lt;sendurl base=\u0026#34;http://pic.xoyo.com/cms\u0026#34;/\u0026gt; \u0026lt;regexurl regex=\u0026#34;false\u0026#34; match=\u0026#34;cms.xoyo.com/site([/a-zA-Z0-9]*).xoyo.com/images\u0026#34;/\u0026gt; \u0026lt;/localpath\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/head\u0026gt; 3**ã€å¼€å¯sersyncå®ˆæŠ¤è¿›ç¨‹åŒæ­¥æ•°æ®**\n1 2 3 4 5 [root@web ~]# /usr/local/sersync/sersync2 -d -r -o /usr/local/sersync/confxml.xml é…ç½®sersyncç¯å¢ƒå˜é‡ [root@web ~]# echo\u0026#34;PATH=$PATH:/usr/local/sersync/\u0026#34;\u0026gt;\u0026gt;/etc/profile [root@web ~]# source /etc/profile [root@web ~]# sersync2 å¯åŠ¨å‘½ä»¤åè¿”å›ç»“æœå¦‚ä¸‹ä¸ºæ­£å¸¸ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 set the system param executeï¼šecho50000000 \u0026gt; /proc/sys/fs/inotify/max_user_watches executeï¼šecho 327679\u0026gt; /proc/sys/fs/inotify/max_queued_events parse the command param option: -d run as a daemon option: -r rsync all the local files to the remoteservers before the sersync work option: -o config xml nameï¼š /usr/local/sersync/confxml.xml daemon thread num: 10 parse xml config file host ip : localhost host port: 8008 daemon startï¼Œsersync runbehind the console use rsync password-file : user is rsync_backup passwordfile is /etc/rsync.password config xml parse success please set /etc/rsyncd.confmax connections=0 Manually sersync working thread 12 = 1(primary thread) + 1(fail retry thread) + 10(daemon sub threads) Max threads numbers is: 32 = 12(Thread pool nums) +20(Sub threads) please according your cpu ï¼Œuse -n paramto adjust the cpu rate chmod: cannot access`/usr/local/sersync/logs/rsync_fail_log.sh\u0026#39;: No such file or directory ------------------------------------------ rsync the directory recursivlyto the remote servers once working please wait... execute command: cd /backup\u0026amp;\u0026amp; rsync -artuz -R --delete ./ --timeout=100 rsync_backup@192.168.0.10::www--password-file=/etc/rsync.password \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 run the sersync: watch path is: /data/www å¦‚æœä½ ä¸Šé¢çš„é…ç½®å’ŒéªŒè¯éƒ½æ²¡é—®é¢˜ï¼Œå¯ä»¥ä¸‹é¢çš„é…ç½®äº†ã€‚è®¾ç½®å¼€æœºè‡ªå¯åŠ¨\n1 2 3 4 5 #vi /etc/rc.d/rc.local /usr/local/sersync/sersync2 -d -r -o /usr/local/sersync/confxml.xml ï¼ƒè®¾ç½®å¼€æœºè‡ªåŠ¨è¿è¡Œè„šæœ¬ # chmod +x /etc/rc.d/rc.local æ·»åŠ è„šæœ¬ç›‘æ§sersyncæ˜¯å¦æ­£å¸¸\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 cd /root touch check_sersync.sh chmod 755 check.sersync.sh vim check_sersync.sh #!/bin/sh sersync=\u0026#34;/usr/local/sersync/sersync2\u0026#34; confxml=\u0026#34;/usr/local/sersync/confxml.xml\u0026#34; status=$(ps aux |grep \u0026#39;sersync2\u0026#39;|grep -v \u0026#39;grep\u0026#39;|wc -l) if [ $status -eq 0 ]; then $sersync -d -r -o $confxml \u0026amp; else exit 0; fi check_sersync.sh 1 2 3 #vi /etc/crontab */5 * * * * root /root/check_sersync.sh \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 #æ¯éš”5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡è„šæœ¬ æ³¨æ„ï¼š\n1ã€æ‰‹åŠ¨æ‰§è¡Œcheck_sersync.shæ£€æµ‹sersyncæ˜¯å¦è¿è¡Œæ­£å¸¸ã€‚\n2ã€å¦‚æœç€æ€¥æµ‹è¯•ï¼Œä¸ç”¨ç­‰é‡å¯æœåŠ¡å™¨åæ‰§è¡Œï¼Œå…ˆæ‰§è¡Œã€€1\n/usr/local/sersync/sersync2\u0026nbsp;-d\u0026nbsp;-r\u0026nbsp;-o\u0026nbsp;\u0026nbsp;/usr/local/sersync/confxml.xml\n3ã€åœ¨æºæœåŠ¡å™¨æŒ‡å®šç›®å½•ä¸‹å¯¹æ–‡ä»¶æ–‡ä»¶å¤¹åšå‡ºæ›´æ”¹ï¼ŒæŸ¥çœ‹ç›®æ ‡æœåŠ¡å™¨åŒæ­¥ç›®å½•ä¸‹æ˜¯å¦åŒæ­¥æˆåŠŸã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 1 -v, --verbose è¯¦ç»†æ¨¡å¼è¾“å‡º 2 3 -q, --quiet ç²¾ç®€è¾“å‡ºæ¨¡å¼ 4 5 -c, --checksum æ‰“å¼€æ ¡éªŒå¼€å…³ï¼Œå¼ºåˆ¶å¯¹æ–‡ä»¶ä¼ è¾“è¿›è¡Œæ ¡éªŒ 6 7 -a, --archive å½’æ¡£æ¨¡å¼ï¼Œè¡¨ç¤ºä»¥é€’å½’æ–¹å¼ä¼ è¾“æ–‡ä»¶ï¼Œå¹¶ä¿æŒæ‰€æœ‰æ–‡ä»¶å±æ€§ï¼Œç­‰äº-rlptgoD 8 9 -r, --recursive å¯¹å­ç›®å½•ä»¥é€’å½’æ¨¡å¼å¤„ç† 10 11 -R, --relative ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä¿¡æ¯ 12 13 -b, --backup åˆ›å»ºå¤‡ä»½ï¼Œä¹Ÿå°±æ˜¯å¯¹äºç›®çš„å·²ç»å­˜åœ¨æœ‰åŒæ ·çš„æ–‡ä»¶åæ—¶ï¼Œå°†è€çš„æ–‡ä»¶é‡æ–°å‘½åä¸º~filenameã€‚å¯ä»¥ä½¿ç”¨--suffixé€‰é¡¹æ¥æŒ‡å®šä¸åŒçš„å¤‡ä»½æ–‡ä»¶å‰ç¼€ã€‚ 14 15 --backup-dir å°†å¤‡ä»½æ–‡ä»¶(å¦‚~filename)å­˜æ”¾åœ¨åœ¨ç›®å½•ä¸‹ã€‚ 16 17 -suffix=SUFFIX å®šä¹‰å¤‡ä»½æ–‡ä»¶å‰ç¼€ 18 19 -u, --update ä»…ä»…è¿›è¡Œæ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è·³è¿‡æ‰€æœ‰å·²ç»å­˜åœ¨äºDSTï¼Œå¹¶ä¸”æ–‡ä»¶æ—¶é—´æ™šäºè¦å¤‡ä»½çš„æ–‡ä»¶ã€‚(ä¸è¦†ç›–æ›´æ–°çš„æ–‡ä»¶) 20 21 -l, --links ä¿ç•™è½¯é“¾ç»“ 22 23 -L, --copy-links æƒ³å¯¹å¾…å¸¸è§„æ–‡ä»¶ä¸€æ ·å¤„ç†è½¯é“¾ç»“ 24 25 --copy-unsafe-links ä»…ä»…æ‹·è´æŒ‡å‘SRCè·¯å¾„ç›®å½•æ ‘ä»¥å¤–çš„é“¾ç»“ 26 27 --safe-links å¿½ç•¥æŒ‡å‘SRCè·¯å¾„ç›®å½•æ ‘ä»¥å¤–çš„é“¾ç»“ 28 29 -H, --hard-links ä¿ç•™ç¡¬é“¾ç»“ 30 31 -p, --perms ä¿æŒæ–‡ä»¶æƒé™ 32 33 -o, --owner ä¿æŒæ–‡ä»¶å±ä¸»ä¿¡æ¯ 34 35 -g, --group ä¿æŒæ–‡ä»¶å±ç»„ä¿¡æ¯ 36 37 -D, --devices ä¿æŒè®¾å¤‡æ–‡ä»¶ä¿¡æ¯ 38 39 -t, --times ä¿æŒæ–‡ä»¶æ—¶é—´ä¿¡æ¯ 40 41 -S, --sparse å¯¹ç¨€ç–æ–‡ä»¶è¿›è¡Œç‰¹æ®Šå¤„ç†ä»¥èŠ‚çœDSTçš„ç©ºé—´ 42 43 -n, --dry-runç°å®å“ªäº›æ–‡ä»¶å°†è¢«ä¼ è¾“ 44 45 -W, --whole-file æ‹·è´æ–‡ä»¶ï¼Œä¸è¿›è¡Œå¢é‡æ£€æµ‹ 46 47 -x, --one-file-system ä¸è¦è·¨è¶Šæ–‡ä»¶ç³»ç»Ÿè¾¹ç•Œ 48 49 -B, --block-size=SIZE æ£€éªŒç®—æ³•ä½¿ç”¨çš„å—å°ºå¯¸ï¼Œé»˜è®¤æ˜¯700å­—èŠ‚ 50 51 -e, --rsh=COMMAND æŒ‡å®šä½¿ç”¨rshã€sshæ–¹å¼è¿›è¡Œæ•°æ®åŒæ­¥ 52 53 --rsync-path=PATH æŒ‡å®šè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„rsyncå‘½ä»¤æ‰€åœ¨è·¯å¾„ä¿¡æ¯ 54 55 -C, --cvs-exclude ä½¿ç”¨å’ŒCVSä¸€æ ·çš„æ–¹æ³•è‡ªåŠ¨å¿½ç•¥æ–‡ä»¶ï¼Œç”¨æ¥æ’é™¤é‚£äº›ä¸å¸Œæœ›ä¼ è¾“çš„æ–‡ä»¶ 56 57 --existing ä»…ä»…æ›´æ–°é‚£äº›å·²ç»å­˜åœ¨äºDSTçš„æ–‡ä»¶ï¼Œè€Œä¸å¤‡ä»½é‚£äº›æ–°åˆ›å»ºçš„æ–‡ä»¶ 58 59 --delete åˆ é™¤é‚£äº›DSTä¸­SRCæ²¡æœ‰çš„æ–‡ä»¶ 60 61 --delete-excluded åŒæ ·åˆ é™¤æ¥æ”¶ç«¯é‚£äº›è¢«è¯¥é€‰é¡¹æŒ‡å®šæ’é™¤çš„æ–‡ä»¶ 62 63 --delete-after ä¼ è¾“ç»“æŸä»¥åå†åˆ é™¤ 64 65 --ignore-errors åŠæ—¶å‡ºç°IOé”™è¯¯ä¹Ÿè¿›è¡Œåˆ é™¤ 66 67 --max-delete=NUM æœ€å¤šåˆ é™¤NUMä¸ªæ–‡ä»¶ 68 69 --partial ä¿ç•™é‚£äº›å› æ•…æ²¡æœ‰å®Œå…¨ä¼ è¾“çš„æ–‡ä»¶ï¼Œä»¥æ˜¯åŠ å¿«éšåçš„å†æ¬¡ä¼ è¾“ 70 71 --force å¼ºåˆ¶åˆ é™¤ç›®å½•ï¼Œå³ä½¿ä¸ä¸ºç©º 72 73 --numeric-ids ä¸å°†æ•°å­—çš„ç”¨æˆ·å’Œç»„IDåŒ¹é…ä¸ºç”¨æˆ·åå’Œç»„å 74 75 --timeout=TIME IPè¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºç§’ 76 77 -I, --ignore-times ä¸è·³è¿‡é‚£äº›æœ‰åŒæ ·çš„æ—¶é—´å’Œé•¿åº¦çš„æ–‡ä»¶ 78 79 --size-only å½“å†³å®šæ˜¯å¦è¦å¤‡ä»½æ–‡ä»¶æ—¶ï¼Œä»…ä»…å¯Ÿçœ‹æ–‡ä»¶å¤§å°è€Œä¸è€ƒè™‘æ–‡ä»¶æ—¶é—´ 80 81 --modify-window=NUM å†³å®šæ–‡ä»¶æ˜¯å¦æ—¶é—´ç›¸åŒæ—¶ä½¿ç”¨çš„æ—¶é—´æˆ³çª—å£ï¼Œé»˜è®¤ä¸º0 82 83 -T --temp-dir=DIR åœ¨DIRä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶ 84 85 --compare-dest=DIR åŒæ ·æ¯”è¾ƒDIRä¸­çš„æ–‡ä»¶æ¥å†³å®šæ˜¯å¦éœ€è¦å¤‡ä»½ 86 87 -P ç­‰åŒäº --partial 88 89 --progress æ˜¾ç¤ºå¤‡ä»½è¿‡ç¨‹ 90 91 -z, --compress å¯¹å¤‡ä»½çš„æ–‡ä»¶åœ¨ä¼ è¾“æ—¶è¿›è¡Œå‹ç¼©å¤„ç† 92 93 --exclude=PATTERN æŒ‡å®šæ’é™¤ä¸éœ€è¦ä¼ è¾“çš„æ–‡ä»¶æ¨¡å¼ 94 95 --include=PATTERN æŒ‡å®šä¸æ’é™¤è€Œéœ€è¦ä¼ è¾“çš„æ–‡ä»¶æ¨¡å¼ 96 97 --exclude-from=FILE æ’é™¤FILEä¸­æŒ‡å®šæ¨¡å¼çš„æ–‡ä»¶ 98 99 --include-from=FILE ä¸æ’é™¤FILEæŒ‡å®šæ¨¡å¼åŒ¹é…çš„æ–‡ä»¶ 100 101 --version æ‰“å°ç‰ˆæœ¬ä¿¡æ¯ 102 103 --address ç»‘å®šåˆ°ç‰¹å®šçš„åœ°å€ 104 105 --config=FILE æŒ‡å®šå…¶ä»–çš„é…ç½®æ–‡ä»¶ï¼Œä¸ä½¿ç”¨é»˜è®¤çš„rsyncd.confæ–‡ä»¶ 106 107 --port=PORT æŒ‡å®šå…¶ä»–çš„rsyncæœåŠ¡ç«¯å£ 108 109 --blocking-io å¯¹è¿œç¨‹shellä½¿ç”¨é˜»å¡IO 110 111 -stats ç»™å‡ºæŸäº›æ–‡ä»¶çš„ä¼ è¾“çŠ¶æ€ 112 113 --progress åœ¨ä¼ è¾“æ—¶ç°å®ä¼ è¾“è¿‡ç¨‹ 114 115 --log-format=formAT æŒ‡å®šæ—¥å¿—æ–‡ä»¶æ ¼å¼ 116 117 --password-file=FILE ä»FILEä¸­å¾—åˆ°å¯†ç  118 119 --bwlimit=KBPS é™åˆ¶I/Oå¸¦å®½ï¼ŒKBytes per second 120 121 -h, --help æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ rsyncè¯¦ç»†å‚æ•° å‚è€ƒåœ°å€ï¼š\nhttps://blog.51cto.com/liubao0312/1677586\nhttps://blog.csdn.net/ljx1528/article/details/105348259\nhttps://www.cnblogs.com/lei0213/p/8598072.html\n","date":"2021-01-29T23:09:59Z","image":"https://www.ownit.top/title_pic/51.jpg","permalink":"https://www.ownit.top/p/202101292309/","title":"sersync+rsyncåŸç†åŠéƒ¨ç½²"},{"content":"Linuxç³»ç»Ÿä¸‹å¯é€šè¿‡historyå‘½ä»¤æŸ¥çœ‹ç”¨æˆ·æ‰€æœ‰çš„å†å²æ“ä½œè®°å½•ï¼Œåœ¨å®‰å…¨åº”æ€¥å“åº”ä¸­èµ·ç€éå¸¸é‡è¦çš„ä½œç”¨ï¼Œä½†åœ¨æœªè¿›è¡Œé™„åŠ é…ç½®æƒ…å†µä¸‹ï¼Œhistoryå‘½ä»¤åªèƒ½æŸ¥çœ‹ç”¨æˆ·å†å²æ“ä½œè®°å½•ï¼Œå¹¶ä¸èƒ½åŒºåˆ†ç”¨æˆ·ä»¥åŠæ“ä½œæ—¶é—´ï¼Œä¸ä¾¿äºå®¡è®¡åˆ†æã€‚\nå½“ç„¶ï¼Œä¸€äº›ä¸å¥½çš„æ“ä½œä¹ æƒ¯ä¹Ÿå¯èƒ½é€šè¿‡å‘½ä»¤å†å²æ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»å¦‚ä½•è®©historyæ—¥å¿—è®°å½•æ›´ç»†åŒ–ï¼Œæ›´ä¾¿äºæˆ‘ä»¬å®¡è®¡åˆ†æã€‚\nHistory é€šè¿‡è®¾ç½®export HISTTIMEFORMAT=\u0026rsquo;%F %T \u0026lsquo;ï¼Œè®©å†å²è®°å½•ä¸­å¸¦ä¸Šå‘½ä»¤æ‰§è¡Œæ—¶é—´ã€‚\næ³¨æ„â€%Tâ€å’Œåé¢çš„â€â€™â€ä¹‹é—´æœ‰ç©ºæ ¼ï¼Œä¸ç„¶æŸ¥çœ‹å†å²è®°å½•çš„æ—¶å€™ï¼Œæ—¶é—´å’Œå‘½ä»¤ä¹‹é—´æ²¡æœ‰åˆ†å‰²ã€‚\nè¦ä¸€åŠ³æ°¸é€¸ï¼Œè¿™ä¸ªé…ç½®å¯ä»¥å†™åœ¨/etc/profileä¸­ï¼Œå½“ç„¶å¦‚æœè¦å¯¹æŒ‡å®šç”¨æˆ·åšé…ç½®ï¼Œè¿™ä¸ªé…ç½®å¯ä»¥å†™åœ¨/home/$USER/.bash_profileä¸­ã€‚\næœ¬æ–‡å°†ä»¥/etc/profileä¸ºä¾‹è¿›è¡Œæ¼”ç¤ºã€‚\n1 2 3 4 5 6 vim /etc/profile export HISTTIMEFORMAT=\u0026#39;%F %T \u0026#39; source /etc/profile è¦ä½¿é…ç½®ç«‹å³ç”Ÿæ•ˆè¯·æ‰§è¡Œsource /etc/profileï¼Œæˆ‘ä»¬å†æŸ¥çœ‹historyè®°å½•ï¼Œå¯ä»¥çœ‹åˆ°è®°å½•ä¸­å¸¦ä¸Šäº†å‘½ä»¤æ‰§è¡Œæ—¶é—´ã€‚ å¦‚æœæƒ³è¦å®ç°æ›´ç»†åŒ–çš„è®°å½•ï¼Œæ¯”å¦‚ç™»é™†è¿‡ç³»ç»Ÿçš„ç”¨æˆ·ã€IPåœ°å€ã€æ“ä½œå‘½ä»¤ä»¥åŠæ“ä½œæ—¶é—´ä¸€ä¸€å¯¹åº”ï¼Œå¯ä»¥é€šè¿‡åœ¨/etc/profileé‡Œé¢åŠ å…¥ä»¥ä¸‹ä»£ç å®ç°\n1 2 3 4 USER_IP=`who -u am i 2\u0026gt;/dev/null| awk \u0026#39;{print $NF}\u0026#39;|sed -e \u0026#39;s/[()]//g\u0026#39;` export HISTTIMEFORMAT=\u0026#34;[%F %T][`whoami`][${USER_IP}] \u0026#34; ä¿®æ”¹/etc/profileå¹¶åŠ è½½åï¼Œhistoryè®°å½•å¦‚ä¸‹ï¼Œæ—¶é—´ã€IPã€ç”¨æˆ·åŠæ‰§è¡Œçš„å‘½ä»¤éƒ½ä¸€ä¸€å¯¹åº”ã€‚ é€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³æ—¥å¸¸çš„å®¡è®¡å·¥ä½œäº†ï¼Œä½†äº†è§£ç³»ç»Ÿçš„æœ‹å‹åº”è¯¥å¾ˆå®¹æ˜“çœ‹å‡ºæ¥ï¼Œè¿™ç§æ–¹æ³•åªæ˜¯è®¾ç½®äº†ç¯å¢ƒå˜é‡ï¼Œæ”»å‡»è€…unsetæ‰è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œæˆ–è€…ç›´æ¥åˆ é™¤å‘½ä»¤å†å²ï¼Œå¯¹äºå®‰å…¨åº”æ€¥æ¥è¯´ï¼Œè¿™æ— ç–‘æ˜¯ä¸€ä¸ªç¾éš¾ã€‚\né’ˆå¯¹è¿™æ ·çš„é—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•åº”å¯¹ï¼Œé€šè¿‡ä¿®æ”¹bashæºç ï¼Œè®©historyè®°å½•é€šè¿‡syslogå‘é€åˆ°è¿œç¨‹logserverä¸­ï¼Œå¤§å¤§å¢åŠ äº†æ”»å‡»è€…å¯¹historyè®°å½•å®Œæ•´æ€§ç ´åçš„éš¾åº¦ã€‚\nhistoryé«˜çº§ç”¨æ³•\nä¸Šé¢æ˜¯è®°å½•Historyçš„æ–¹æ³•ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å†™å…¥æ–‡ä»¶ï¼Œæ›´åŠ æ–¹ä¾¿çš„è®°å½•å’Œå®¡è®¡å‘½ä»¤\n1 2 3 4 5 #histroy HISTSIZE=409600 export HISTTIMEFORMAT=\u0026#34;[%F %T]\u0026#34; export HISTORY_FILE=/var/log/.audit.log export PROMPT_COMMAND=\u0026#39;{ thisHistID=`history 1|awk \u0026#34;{print \\\\$1}\u0026#34;`;lastCommand=`history 1| awk \u0026#34;{\\\\$1=\\\u0026#34;\\\u0026#34; ;print}\u0026#34;`;user=`id -un`;whoStr=(`who -u am i`);realUser=${whoStr[0]};logMonth=${whoStr[2]};logDay=${whoStr[3]};logTime=${whoStr[4]};pid=${whoStr[6]};ip=${whoStr[7]};if [ ${thisHistID}x != ${lastHistID}x ];then echo -E `date \u0026#34;+%Y/%m/%d %H:%M:%S\u0026#34;` $user\\($realUser\\)@$ip[PID:$pid][LOGIN:$logMonth $logDay $logTime] --- $lastCommand ;lastHistID=$thisHistID;fi; } \u0026gt;\u0026gt; $HISTORY_FILE\u0026#39; è¿™ä¸ªå‘½ä»¤ä¼šåœ¨ç”Ÿæˆ**/var/log/.audit.log æ–‡ä»¶Â **è¿™é‡Œé¢è®°å½•çš„æ˜¯å‘½ä»¤\nè¿™æ ·æ›´ä¸ºç›´è§‚çš„åˆ†æå’Œå®¡è®¡\n","date":"2021-01-22T10:31:21Z","image":"https://www.ownit.top/title_pic/19.jpg","permalink":"https://www.ownit.top/p/202101221031/","title":"è°åŠ¨äº†æˆ‘çš„ä¸»æœº?ï¼ˆ Historyï¼‰"},{"content":"ç›®å½•\n1. å®‰è£…dockerä¸docker-compose\n2. ç¯å¢ƒæ¡ä»¶\n3. åˆ›å»ºä¸»ä»é…ç½®æ–‡ä»¶\n4. åˆ›å»ºdocker-compose.ymlæ–‡ä»¶\n5. docker-composeå¯åŠ¨mysqlå®¹å™¨\n6. é”€æ¯ä¸¤ä¸ªå®¹å™¨\n7. é‡å»ºMySQLå®¹å™¨\nç»å¸¸æ‹‰å»æ•°æ®åº“åšæµ‹è¯•ï¼Œè¿˜éœ€è¦ä¸»ä»ï¼Œæ¯æ¬¡ç¯å¢ƒè¿˜è¦è¿˜åŸï¼Œç»å¸¸é‡å¤æ¯”è¾ƒéº»çƒ¦ã€‚\nç°åœ¨é‡‡ç”¨dockerå’Œdocker-composeä¸€é”®æ„å»ºé›†æˆç¯å¢ƒï¼Œæ–¹ä¾¿æµ‹è¯•ã€‚\n1. å®‰è£…dockerä¸docker-compose 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # å¸è½½è€ç‰ˆæœ¬docker [root@docker ~]# yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine [root@docker ~]# yum -y install epel-release wget [root@docker ~]# wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo [root@docker ~]# sed -i \u0026#39;s#download.docker.com#mirrors.tuna.tsinghua.edu.cn/docker-ce#g\u0026#39; /etc/yum.repos.d/docker-ce.repo [root@docker ~]# yum -y install docker-ce # å¯åŠ¨å¹¶é…ç½®é•œåƒåŠ é€Ÿ [root@docker ~]# systemctl start docker.service \u0026amp;\u0026amp; systemctl enable docker.service [root@docker ~]# cat /etc/docker/daemon.json { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;https://99dxqyb6.mirror.aliyuncs.com\u0026#34;] } [root@docker ~]# systemctl restart docker.service å®‰è£…docker-compose 1 2 3 [root@docker ~]# curl -L \u0026#34;https://github.com/docker/compose/releases/download/1.25.3/docker-compose-$(uname -s)-$(uname -m)\u0026#34; -o /usr/local/bin/docker-compose [root@docker ~]# chmod +x /usr/local/bin/docker-compose [root@docker ~]# ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose 2. ç¯å¢ƒæ¡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 [root@docker ~]# docker pull mysql:5.7 [root@Master new_date]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE docker.io/mysql 5.7 cc8775c0fe94 6 days ago 449 MB [root@docker ~]# mkdir -p /data/mysql/master/{conf,data} [root@docker ~]# mkdir -p /data/mysql/slave/conf [root@docker ~]# mkdir -p /data/mysql/{init-db-m,init-db-s} [root@docker ~]# chown -R mysql.mysql /data/mysql # ä¸»åº“çš„åˆ›å»ºç”¨æˆ·SQLè„šæœ¬ [root@docker ~]# cat /data/mysql/init-db-m/create_user_1.sql grant all on *.* to \u0026#39;dumpuser\u0026#39;@\u0026#39;%\u0026#39; identified by \u0026#39;123456\u0026#39;; grant replication slave on *.* to \u0026#39;repl\u0026#39;@\u0026#39;%\u0026#39; identified by \u0026#39;123456\u0026#39;; # ä»åº“è¿œç¨‹å¤‡ä»½ä¸»åº“åŠåˆ›å»ºä¸»ä»é€šé“Bashè„šæœ¬ [root@docker ~]# cat /data/mysql/init-db-s/dump-repl_1.sh #!/bin/bash while ! mysql -uping -p123456 -hmysql_m_compose -P3306 -e \u0026#34;select 1\u0026#34; do sleep 1 done sleep 3 mysqldump -udumpuser -p123456 -hmysql_m_compose -P3306 --single-transaction --default-character-set=utf8mb4 --set-gtid-purged=on --master-data=2 --flush-logs --hex-blob --triggers --routines --events --all-databases \u0026gt; /tmp/full.sql mysql -uroot -p123456 -e \u0026#34;reset master;\u0026#34; mysql -uroot -p123456 -e \u0026#34;source /tmp/full.sql;\u0026#34; mysql -uroot -p123456 -e \u0026#34;CHANGE MASTER TO MASTER_HOST=\u0026#39;mysql_m_compose\u0026#39;,MASTER_USER=\u0026#39;repl\u0026#39;,MASTER_PASSWORD=\u0026#39;123456\u0026#39;,MASTER_PORT=3306,MASTER_CONNECT_RETRY=10,MASTER_AUTO_POSITION=1;\u0026#34; mysql -uroot -p123456 -e \u0026#34;start slave;\u0026#34; 3. åˆ›å»ºä¸»ä»é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 # mysql_m_composeèŠ‚ç‚¹ [root@docker ~]# cat /data/mysql/master/conf/my.cnf [mysqld] server_id = 33060000 port = 3306 log_timestamps=SYSTEM max_allowed_packet = 16M read_only = 0 character_set_server = utf8mb4 secure_file_priv = \u0026#34;\u0026#34; max_connect_errors = 100000 interactive_timeout = 1800 wait_timeout = 1800 # BINLOG log_bin = mysql-bin binlog_format = row log_slave_updates = 1 max_binlog_size = 200M relay_log = relay-bin sync_binlog = 1 # GTID gtid_mode = ON enforce_gtid_consistency = 1 binlog_gtid_simple_recovery = 1 # ENGINE default_storage_engine = InnoDB innodb_flush_log_at_trx_commit=1 # ---------------------------------------------------------------------------------------------------------------------- # mysql_s_composeèŠ‚ç‚¹ [root@docker ~]# cat /data/mysql/slave/conf/my.cnf [mysqld] server_id = 33060001 port = 3306 log_timestamps=SYSTEM max_allowed_packet = 16M read_only = 0 character_set_server = utf8mb4 secure_file_priv = \u0026#34;\u0026#34; max_connect_errors = 100000 interactive_timeout = 1800 wait_timeout = 1800 # BINLOG log_bin = mysql-bin binlog_format = row log_slave_updates = 1 max_binlog_size = 200M relay_log = relay-bin sync_binlog = 1 # GTID gtid_mode = ON enforce_gtid_consistency = 1 binlog_gtid_simple_recovery = 1 # ENGINE default_storage_engine = InnoDB innodb_flush_log_at_trx_commit=1 4. åˆ›å»ºdocker-compose.ymlæ–‡ä»¶ å°†init_sqlä¸‹çš„æ–‡ä»¶æ˜ å°„åˆ°/docker-entrypoint-initdb.dç›®å½•ä¸‹(æ³¨ï¼š/docker-entrypoint-initdb.dä¸‹ä»¥sqlæˆ–shç»“å°¾çš„æ–‡ä»¶ä¼šåœ¨æ•°æ®åº“åˆå§‹åŒ–å®Œæˆåè‡ªåŠ¨æ‰§è¡Œ) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 [root@docker ~]# cat /data/mysql/docker-compose.yml version: \u0026#39;3\u0026#39; services: mysql_m_compose: image: mysql:5.7.30 container_name: mysql_m restart: always ports: - 33061:3306 environment: - MYSQL_USER=ping - MYSQL_PASSWORD=123456 - MYSQL_ROOT_PASSWORD=123456 volumes: - ./master/conf/my.cnf:/etc/my.cnf - ./master/data:/var/lib/mysql - ./init-db-m:/docker-entrypoint-initdb.d mysql_s_compose: image: mysql:5.7.30 container_name: mysql_s restart: always ports: - 33062:3306 depends_on: - mysql_m_compose environment: - MYSQL_ROOT_PASSWORD=123456 volumes: - ./slave/conf/my.cnf:/etc/my.cnf - ./init-db-s:/docker-entrypoint-initdb.d 5. docker-composeå¯åŠ¨mysqlå®¹å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 [root@docker mysql]# docker-compose up -d Creating network \u0026#34;mysql_default\u0026#34; with the default driver Creating mysql_m ... done Creating mysql_s ... done [root@docker ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 35cc9c6fbf52 mysql:5.7.30 \u0026#34;docker-entrypoint.sâ€¦\u0026#34; 6 minutes ago Up 6 minutes 33060/tcp, 0.0.0.0:33062-\u0026gt;3306/tcp mysql_s 53a04e176ecc mysql:5.7.30 \u0026#34;docker-entrypoint.sâ€¦\u0026#34; 6 minutes ago Up 6 minutes 33060/tcp, 0.0.0.0:33061-\u0026gt;3306/tcp mysql_m # æ£€æŸ¥ä¸»ä»å¤åˆ¶å…³ç³» # ä¸»åº“ mysql\u0026gt; CREATE DATABASE`db` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci; mysql_m\u0026gt; use db Database changed mysql_m\u0026gt; create table t1(id int,name varchar(32)); Query OK, 0 rows affected (0.01 sec) mysql_m\u0026gt; insert into t1 values(1,\u0026#39;aa\u0026#39;),(2,\u0026#39;bb\u0026#39;),(3,\u0026#39;cc\u0026#39;); Query OK, 3 rows affected (0.01 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql_m\u0026gt; select * from db.t1; +------+------+ | id | name | +------+------+ | 1 | aa | | 2 | bb | | 3 | cc | +------+------+ 3 rows in set (0.00 sec) # ä»åº“ mysql_s\u0026gt; select * from db.t1; +------+------+ | id | name | +------+------+ | 1 | aa | | 2 | bb | | 3 | cc | +------+------+ 3 rows in set (0.00 sec) # æŸ¥çœ‹ä¸»ä»å¤åˆ¶çŠ¶æ€ä¿¡æ¯ mysql\u0026gt; show slave status\\G *************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: mysql_m_compose Master_User: repl Master_Port: 3306 Connect_Retry: 10 Master_Log_File: mysql-bin.000004 Read_Master_Log_Pos: 845 Relay_Log_File: relay-bin.000004 Relay_Log_Pos: 1018 Relay_Master_Log_File: mysql-bin.000004 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 845 Relay_Log_Space: 1219 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0 Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 33060000 Master_UUID: f28ef661-597b-11eb-beb8-0242ac120002 Master_Info_File: /var/lib/mysql/master.info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: f28ef661-597b-11eb-beb8-0242ac120002:10-12 Executed_Gtid_Set: f28ef661-597b-11eb-beb8-0242ac120002:1-12 Auto_Position: 1 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec) 6. é”€æ¯ä¸¤ä¸ªå®¹å™¨ 1 2 3 4 5 6 7 8 9 [root@Master mysql]# ls docker-compose.yml init-db-m init-db-s master slave [root@Master mysql]# docker-compose down Stopping mysql_s ... done Stopping mysql_m ... Stopping mysql_m ... done Removing mysql_s ... done Removing mysql_m ... done Removing network mysql_default 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 [root@Master mysql]# ll -sh /data/mysql/master/data/ æ€»ç”¨é‡ 188M 4.0K -rw-r----- 1 polkitd ssh_keys 56 1æœˆ 18 18:57 auto.cnf 4.0K -rw------- 1 polkitd ssh_keys 1.7K 1æœˆ 18 18:57 ca-key.pem 4.0K -rw-r--r-- 1 polkitd ssh_keys 1.1K 1æœˆ 18 18:57 ca.pem 4.0K -rw-r--r-- 1 polkitd ssh_keys 1.1K 1æœˆ 18 18:57 client-cert.pem 4.0K -rw------- 1 polkitd ssh_keys 1.7K 1æœˆ 18 18:57 client-key.pem 0 drwxr-x--- 2 polkitd ssh_keys 48 1æœˆ 18 19:09 db 4.0K -rw-r----- 1 polkitd ssh_keys 1.4K 1æœˆ 18 18:57 ib_buffer_pool 76M -rw-r----- 1 polkitd ssh_keys 76M 1æœˆ 18 19:34 ibdata1 48M -rw-r----- 1 polkitd ssh_keys 48M 1æœˆ 18 19:34 ib_logfile0 48M -rw-r----- 1 polkitd ssh_keys 48M 1æœˆ 18 18:57 ib_logfile1 12M -rw-r----- 1 polkitd ssh_keys 12M 1æœˆ 18 19:34 ibtmp1 4.0K drwxr-x--- 2 polkitd ssh_keys 4.0K 1æœˆ 18 18:57 mysql 4.0K -rw-r----- 1 polkitd ssh_keys 177 1æœˆ 18 18:57 mysql-bin.000001 3.0M -rw-r----- 1 polkitd ssh_keys 3.0M 1æœˆ 18 18:57 mysql-bin.000002 4.0K -rw-r----- 1 polkitd ssh_keys 241 1æœˆ 18 18:57 mysql-bin.000003 4.0K -rw-r----- 1 polkitd ssh_keys 845 1æœˆ 18 19:34 mysql-bin.000004 4.0K -rw-r----- 1 polkitd ssh_keys 241 1æœˆ 18 19:34 mysql-bin.000005 4.0K -rw-r----- 1 polkitd ssh_keys 194 1æœˆ 18 19:34 mysql-bin.000006 4.0K -rw-r----- 1 polkitd ssh_keys 114 1æœˆ 18 19:34 mysql-bin.index 12K drwxr-x--- 2 polkitd ssh_keys 8.0K 1æœˆ 18 18:57 performance_schema 4.0K -rw------- 1 polkitd ssh_keys 1.7K 1æœˆ 18 18:57 private_key.pem 4.0K -rw-r--r-- 1 polkitd ssh_keys 452 1æœˆ 18 18:57 public_key.pem 4.0K -rw-r--r-- 1 polkitd ssh_keys 1.1K 1æœˆ 18 18:57 server-cert.pem 4.0K -rw------- 1 polkitd ssh_keys 1.7K 1æœˆ 18 18:57 server-key.pem 12K drwxr-x--- 2 polkitd ssh_keys 8.0K 1æœˆ 18 18:57 sys 7. é‡å»ºMySQLå®¹å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 [root@docker mysql]# docker-compose up -d Creating network \u0026#34;mysql_default\u0026#34; with the default driver Creating mysql_m ... done Creating mysql_s ... done [root@docker mysql]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 7cd912fa9721 mysql:5.7.30 \u0026#34;docker-entrypoint.sâ€¦\u0026#34; 8 seconds ago Up 8 seconds 33060/tcp, 0.0.0.0:33062-\u0026gt;3306/tcp mysql_s d9e3514a1e19 mysql:5.7.30 \u0026#34;docker-entrypoint.sâ€¦\u0026#34; 9 seconds ago Up 8 seconds 33060/tcp, 0.0.0.0:33061-\u0026gt;3306/tcp mysql_m # ä¸»åº“ mysql_m\u0026gt; select * from db.t1; +------+------+ | id | name | +------+------+ | 1 | aa | | 2 | bb | | 3 | cc | +------+------+ 3 rows in set (0.00 sec) # ä»åº“ mysql_s\u0026gt; select * from db.t1; +------+------+ | id | name | +------+------+ | 1 | aa | | 2 | bb | | 3 | cc | +------+------+ 3 rows in set (0.01 sec) mysql_s\u0026gt; show slave status\\G *************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: mysql_m_compose Master_User: repl Master_Port: 3306 Connect_Retry: 10 Master_Log_File: mysql-bin.000006 Read_Master_Log_Pos: 194 Relay_Log_File: relay-bin.000004 Relay_Log_Pos: 367 Relay_Master_Log_File: mysql-bin.000006 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 194 Relay_Log_Space: 568 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0 Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 33060000 Master_UUID: f93b936b-9b6b-11ea-9bda-0242c0a82002 Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: f93b936b-9b6b-11ea-9bda-0242c0a82002:1-12 Auto_Position: 1 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec) ","date":"2021-01-18T19:52:48Z","image":"https://www.ownit.top/title_pic/58.jpg","permalink":"https://www.ownit.top/p/202101181952/","title":"MySQLå®¹å™¨éƒ¨ç½²åŠæ•°æ®æŒä¹…åŒ–ï¼ˆä¸»ä»å¤åˆ¶ï¼‰"},{"content":"å½“MySQLä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œæ€ä¹ˆè§£å†³ï¼Ÿï¼Ÿï¼Ÿ ä¸Šé¢æ˜¯é‡‡ç”¨mysqldbcompareå·¥å…·ï¼Œå¯¹æ¯”æ•°æ®åº“çš„ä¿¡æ¯æ˜¯å¦ä¸€è‡´ã€‚\npercona-toolkit percona-toolkitå®˜ç½‘ï¼šhttps://www.percona.com/doc/percona-toolkit/LATEST/installation.html\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨percona-toolkitå·¥å…·åšæ ¡éªŒï¼Œè€Œè¯¥å·¥å…·åŒ…å«\n1. pt-table-checksum è´Ÿè´£æ£€æµ‹MySQLä¸»ä»æ•°æ®ä¸€è‡´æ€§\n2. pt-table-syncè´Ÿè´£æŒ¡ä½ä»æ•°æ®ä¸ä¸€è‡´æ—¶ä¿®å¤æ•°æ®ï¼Œè®©ä»–ä»¬ä¿å­˜æ•°æ®çš„ä¸€è‡´æ€§\n3. pt-heartbeat è´Ÿè´£ç›‘æ§MySQLä¸»ä»åŒæ­¥å»¶è¿Ÿ\nä¸€è‡´æ€§æ ¡éªŒæ€è·¯ï¼š\n1ã€ç¡®å®šæ ¡éªŒçš„ä¸»åº“ï¼Œæ ¹æ®éœ€è¦æ ¡éªŒçš„è¡¨ï¼Œåˆ†æ®µè·å–æ•°æ®\n2ã€ä¸ä»åº“è¿›è¡Œæ ¡éªŒï¼ˆæ ¹æ®idï¼‰\n3ã€æ ¡éªŒçš„è¿‡ç¨‹å‘ç°æ•°æ®ä¸ä¸€è‡´çš„æ—¶å€™\n4ã€åœ¨ä¸»åº“åˆ›å»ºä¸€ä¸ªè¡¨ è®°å½•æ ¡éªŒä¸ä¸€è‡´çš„æ•°æ®\n5ã€æ¢å¤åªéœ€è¦è¯»å–è¿™ä¸ªè¡¨\nå·¥å…·ä¸‹è½½ï¼šhttps://downloads.percona.com/downloads/percona-toolkit/percona-toolkit-3.3.0/binary/redhat/7/x86_64/percona-toolkit-3.3.0-1.el7.x86_64.rpm\nå®‰è£…percona-toolkit 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 édockerå®¹å™¨å®‰è£… yum install perl-IO-Socket-SSL perl-DBD-MySQL perl-Time-HiRes perl perl-DBI -y wget https://downloads.percona.com/downloads/percona-toolkit/percona-toolkit-3.3.0/binary/redhat/7/x86_64/percona-toolkit-3.3.0-1.el7.x86_64.rpm yum install percona-toolkit-3.3.0-1.el7.x86_64.rpm yum list | grep percona-toolkit -y [root@Master new_date]# yum list | grep percona percona-toolkit.x86_64 3.3.0-1.el7 installed dockerå®¹å™¨ä¸­å®‰è£… apt-get update apt-get install percona-toolkit pt-table-checksum --help pt-table-checksumä½¿ç”¨ pt-table-checksum [options] [dsn] pt-table-checksumï¼šåœ¨ä¸»ï¼ˆmasterï¼‰ä¸Šé€šè¿‡æ‰§è¡Œæ ¡éªŒçš„æŸ¥è¯¢å¯¹å¤åˆ¶çš„ä¸€è‡´æ€§è¿›è¡Œæ£€æŸ¥ï¼Œå¯¹æ¯”ä¸»ä»çš„æ ¡éªŒå€¼ï¼Œä»è€Œäº§ç”Ÿç»“æœã€‚DSNæŒ‡å‘çš„æ˜¯ä¸»çš„åœ°å€ï¼Œè¯¥å·¥å…·çš„é€€å‡ºçŠ¶æ€ä¸ä¸ºé›¶ï¼Œå¦‚æœå‘ç°æœ‰ä»»ä½•å·®åˆ«ï¼Œæˆ–è€…å¦‚æœå‡ºç°ä»»ä½•è­¦å‘Šæˆ–é”™è¯¯ï¼Œæ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹å®˜æ–¹èµ„æ–™ã€‚ 1ã€å‡†å¤‡å®æˆ˜æ¨¡æ‹Ÿä¸€ä¸‹æ•°æ®çš„ä¸ä¸€è‡´ï¼Œé¦–å…ˆåœ¨ä¸»åº“ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œåˆ›å»ºæ•°æ®è¡¨ï¼Œç„¶åæ·»åŠ ä¸€äº›æ•°æ® ç¯å¢ƒå·²ç»å‡†å¤‡å¥½\næœ‰éœ€è¦çš„å¯ä»¥å‚è€ƒ\nè¿™è¾¹æˆ‘æ‰ç”¨dockeræ¥æ¨¡æ‹Ÿï¼Œç¯å¢ƒå¾ˆå¿«æ„å»ºå®Œæˆæ¥æ¼”ç¤ºã€‚\nä¸‹é¢æ˜¯é“¾æ¥ï¼Œå¯ä»¥å‚è€ƒ\nDockerå®‰è£…MySQLé›†ç¾¤ã€è¯»å†™åˆ†ç¦»ã€‘ 2ã€ä¸»åº“ä¸­è¿›è¡Œæ£€æµ‹æ•°æ®æ˜¯å¦ä¸€è‡´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 create database mytest; use mytest; create table user( id int auto_increment not null primary key, name varchar(20) )engine=InnoDB charset=utf8; show tables; insert into user values (1,\u0026#39;aa\u0026#39;); insert into user values (2,\u0026#39;bb\u0026#39;); insert into user values (3,\u0026#39;cc\u0026#39;); select * from user; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 æ³¨æ„å¸¸ç”¨çš„å‚æ•°è§£é‡Šï¼š --nocheck-replication-filters ï¼šä¸æ£€æŸ¥å¤åˆ¶è¿‡æ»¤å™¨ï¼Œå»ºè®®å¯ç”¨ã€‚åé¢å¯ä»¥ç”¨--databasesæ¥æŒ‡å®šéœ€è¦æ£€æŸ¥çš„æ•°æ®åº“ã€‚ --no-check-binlog-format : ä¸æ£€æŸ¥å¤åˆ¶çš„binlogæ¨¡å¼ï¼Œè¦æ˜¯binlogæ¨¡å¼æ˜¯ROWï¼Œåˆ™ä¼šæŠ¥é”™ã€‚ --replicate-check-only :åªæ˜¾ç¤ºä¸åŒæ­¥çš„ä¿¡æ¯ã€‚ --replicate= ï¼šæŠŠchecksumçš„ä¿¡æ¯å†™å…¥åˆ°æŒ‡å®šè¡¨ä¸­ï¼Œå»ºè®®ç›´æ¥å†™åˆ°è¢«æ£€æŸ¥çš„æ•°æ®åº“å½“ä¸­ã€‚ --databases= ï¼šæŒ‡å®šéœ€è¦è¢«æ£€æŸ¥çš„æ•°æ®åº“ï¼Œå¤šä¸ªåˆ™ç”¨é€—å·éš”å¼€ã€‚ --tables= ï¼šæŒ‡å®šéœ€è¦è¢«æ£€æŸ¥çš„è¡¨ï¼Œå¤šä¸ªç”¨é€—å·éš”å¼€ --host | h= ï¼šMasterçš„åœ°å€ --user | u= ï¼šç”¨æˆ·å --passwork | p=ï¼šå¯†ç  --Port | P= ï¼šç«¯å£ æ£€æµ‹ root@71399784f284:/# pt-table-checksum --nocheck-replication-filters --replicate=check_data.checksums --databases=mytest --tables=user --user=root --password=123456 Checking if all tables can be checksummed ... Starting checksum ... Replica 00847056d2fa has binlog_format ROW which could cause pt-table-checksum to break replication. Please read \u0026#34;Replicas using row-based replication\u0026#34; in the LIMITATIONS section of the tool\u0026#39;s documentation. If you understand the risks, specify --no-check-binlog-format to disable this check. 1)ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯ä¸»è¦æ˜¯å› ä¸ºï¼Œæ£€æµ‹ä¸»åº“ä¸ä»åº“çš„binlogæ—¥å¿—çš„æ¨¡å¼ - é€šå¸¸æ¥è¯´å¯ä»¥ä¸ç”¨æ”¹binlogæ·»åŠ  --no-check-binlog-format è·³è¿‡æ£€æµ‹,ä½†æ˜¯å¯èƒ½ä¹Ÿä¼šå‡ºç°å¦‚ä¸‹çš„é—®é¢˜ root@71399784f284:/# pt-table-checksum --nocheck-replication-filters --replicate=check_data.checksums --databases=mytest --no-check-binlog-format --tables=user --user=root --password=123456 Diffs cannot be detected because no slaves were found. Please read the â€”recursion-method documentation for information. 2)é—®é¢˜åŸå› æ˜¯æ²¡æœ‰æ‰¾åˆ°ä»åº“çš„åœ°å€ï¼ŒMySQLåœ¨åšä¸»ä»çš„æ—¶å€™å¯èƒ½ä¼šå› ä¸ºç¯å¢ƒé…ç½®ç­‰å› ç´ ï¼Œè®©pt-table-checksumæ²¡æœ‰å¾ˆå¥½åœ°æ‰¾åˆ°ä»åº“çš„åœ°å€ æ£€æµ‹çš„æ–¹å¼ï¼š 1. æ˜¯å¦æ˜¯æŒ‡å®šåœ¨ä¸»åº“è¿è¡Œè¿›è¡Œæ ¡éªŒ 2. å°±æ˜¯é…ç½®--recursion-methodå‚æ•°ï¼Œç„¶ååœ¨ä»åº“ä¸­æŒ‡å®šå¥½å¯¹åº”çš„åœ°å€ æ­£ç¡®æƒ…å†µä¸‹ï¼š root@71399784f284:/# pt-table-checksum --nocheck-replication-filters --replicate=check_data.checksums --databases=mytest --no-check-binlog-format --tables=user --user=root --password=123456 Checking if all tables can be checksummed ... Starting checksum ... TS ERRORS DIFFS ROWS DIFF_ROWS CHUNKS SKIPPED TIME TABLE 05-14T09:48:45 0 0 3 0 1 0 0.030 mytest.user è¡¥å……ï¼ˆpt-mysql-summaryï¼‰ pt-summary #æ˜¾ç¤ºå’Œç³»ç»Ÿç›¸å…³çš„åŸºæœ¬ä¿¡æ¯ï¼š\n1 [root@master ~]# pt-summary pt-mysql-summary #æŸ¥çœ‹mysqlçš„å„ä¸ªç»Ÿè®¡ä¿¡æ¯ï¼š\n1 pt-mysql-summary --host=192.168.0.10 --port=3307 --user=root --password=root --all-databases pt-slave-find #æŸ¥æ‰¾å’Œæ˜¾ç¤ºæŒ‡å®šçš„Master æœ‰å¤šå°‘ä¸ªSlaveï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 [root@Master ~]# pt-slave-find --host=192.168.0.10 --port=3307 --user=root --password=root 192.168.0.10:3307 Version 5.7.32-log Server ID 1 Uptime 36:46 (started 2021-01-18T11:10:35) Replication Is not a slave, has 1 slaves connected, is not read_only Filters binlog_do_db=CMS,CRM Binary logging ROW Slave status Slave mode STRICT Auto-increment increment 1, offset 1 InnoDB version 5.7.32 pt-table-syncå·¥å…·æ¢å¤æ•°æ® æ‰‹å†Œåœ°å€ï¼šhttps://www.percona.com/doc/percona-toolkit/LATEST/pt-table-sync.html\n1ã€åœ¨ä»æ•°æ®åº“ä¸­äººä¸ºæ·»åŠ ä¸¤æ¡æ•°æ®ï¼Œä»è€Œè®©ä¸»ä»æ•°æ®ä¸ä¸€è‡´\n2ã€ä¸»åº“ä¸­è¿›è¡Œæ£€æµ‹æ•°æ®ä¸€è‡´æ€§é—®é¢˜\n3ã€ä¸»åº“æ‰“å°æ¢å¤æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 pt-table-sync --replicate=rep_test.checksums h=172.17.0.2,u=root,p=123456 h=172.17.0.3,u=slave_check,p=123456 --print pt-table-sync --replicate=rep_test.checksums h=172.17.0.2,u=root,p=123456 h=172.17.0.3,u=slave_check,p=123456 --execute æˆ–è€… pt-table-sync --sync-to-master h=172.17.0.3,u=slave_check,p=123456,P=3306 --databases=mytest --print pt-table-sync --sync-to-master h=172.17.0.3,u=slave_check,p=123456,P=3306 --databases=mytest --execute --replicate= ï¼šæŒ‡å®šé€šè¿‡pt-table-checksumå¾—åˆ°çš„è¡¨ï¼Œè¿™2ä¸ªå·¥å…·å·®ä¸å¤šéƒ½ä¼šä¸€ç›´ç”¨ã€‚ --databases= : æŒ‡å®šæ‰§è¡ŒåŒæ­¥çš„æ•°æ®åº“ï¼Œå¤šä¸ªç”¨é€—å·éš”å¼€ã€‚ --tables= ï¼šæŒ‡å®šæ‰§è¡ŒåŒæ­¥çš„è¡¨ï¼Œå¤šä¸ªç”¨é€—å·éš”å¼€ã€‚ --sync-to-master ï¼šæŒ‡å®šä¸€ä¸ªDSNï¼Œå³ä»çš„IPï¼Œä»–ä¼šé€šè¿‡show processlistæˆ–show slave status å»è‡ªåŠ¨çš„æ‰¾ä¸»ã€‚ h=127.0.0.1 ï¼šæœåŠ¡å™¨åœ°å€ï¼Œå‘½ä»¤é‡Œæœ‰2ä¸ªipï¼Œç¬¬ä¸€æ¬¡å‡ºç°çš„æ˜¯Masterçš„åœ°å€ï¼Œç¬¬2æ¬¡æ˜¯Slaveçš„åœ°å€ã€‚ u=root ï¼šå¸å·ã€‚ p=123456 ï¼šå¯†ç ã€‚ --print ï¼šæ‰“å°ï¼Œä½†ä¸æ‰§è¡Œå‘½ä»¤ã€‚ --execute ï¼šæ‰§è¡Œå‘½ä»¤ã€‚ 4ã€ä¸»åº“æ‰§è¡Œæ•°æ®æ¢å¤Â ï¼Œä»åº“ä¸­æŸ¥çœ‹æ•°æ®å‘ç°å·²ç»æ¢å¤ã€‚\nä¸Šé¢æ“ä½œæ˜¯æ‰‹åŠ¨æ‰§è¡Œçš„æ•°æ®æ£€æµ‹ä¸æ•°æ®æ¢å¤ï¼Œä½†å®é™…å·¥ä½œä¸­æ˜¯ä¸å¯èƒ½æ¯å¤©æ‰‹åŠ¨è¿™æ ·è¿›è¡Œæ“ä½œçš„ï¼Œé‚£ä¹ˆæ€ä¹ˆåšå‘¢ï¼Ÿ\næ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªshellè„šæœ¬æ¥å®šæ—¶æ‰§è¡Œæ£€æµ‹ä¸æ¢å¤æ“ä½œï¼Œè¿™æ ·å°±å¯ä»¥çœæ‰ä¸å°‘éº»çƒ¦ã€‚Â 1 2 3 4 5 6 7 8 9 10 11 12 13 vi /home/pt-check-sync.sh #!/bin/bash NUM=`pt-table-checksum --tables=user --databases=mytest --user=root --password=\u0026#39;123456\u0026#39; --replicate=check_data.checksums --no-check-binlog-format --recursion-method dsn=t=mytest.dsns,h=172.17.0.3,u=slave_check,p=123456,P=3306 | awk \u0026#39;NR\u0026gt;1{sum+=$3}END{print sum}\u0026#39;` if [ $NUM -eq 0 ] ; then echo \u0026#34;Data is ok!\u0026#34; else echo \u0026#34;Data is error!\u0026#34; pt-table-sync --sync-to-master h=172.17.0.3,u=slave_check,p=123456,P=3306 --databases=mytest --print pt-table-sync --sync-to-master h=172.17.0.3,u=slave_check,p=123456,P=3306 --databases=mytest --execute fi æ‰§è¡Œsh pt-check-sync.shæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥å†™å®šæ—¶å™¨æ‰§è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 apt-get update apt-get install -y --no-install-recommends cron chmod +x ./docker-entrypoint.sh # ä¿å­˜ç¯å¢ƒå˜é‡ï¼Œå¼€å¯crontabæœåŠ¡ env \u0026gt;\u0026gt; /etc/default/locale /etc/init.d/cron start crontab -e 20 23 * * * /home/pt-check-sync.sh è¡¨ç¤ºæ¯å¤©æ™šä¸Š23:20è¿è¡Œè¿™ä¸ªè„šæœ¬ ","date":"2021-01-18T12:33:38Z","image":"https://www.ownit.top/title_pic/19.jpg","permalink":"https://www.ownit.top/p/202101181233/","title":"å½“MySQLä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œæ€ä¹ˆè§£å†³ï¼Ÿï¼Ÿï¼Ÿï¼ˆ2ï¼‰"},{"content":"å½“MySQLä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œæ€ä¹ˆè§£å†³ï¼Ÿï¼Ÿï¼Ÿ åœ¨ä½¿ç”¨mysql replicationæ—¶ï¼Œæœ‰æ—¶å€™ä¼šæ‹…å¿ƒï¼Œå¦‚æœä¸»åº“å’Œå¤‡åº“çš„æ•°æ®ä¸ä¸€è‡´ï¼Œæ€ä¹ˆåŠï¼Ÿä»¥å‰æ˜¯é‡æ–°åœæ‰ä»åº“ï¼Œé‡æ–°åšä¸»ä»ï¼Œä½†æ˜¯è€—è´¹æ—¶é—´å¤ªå¤š\næœ€è¿‘æ‰¾åˆ°äº†ä¸€ä¸ªmysqlçš„å·¥å…·ï¼Œmysqldbcompareï¼Œå¯ä»¥å®ç°å¯¹å¤šåº“æ•°æ®çš„å¯¹æ¯”ã€‚\nä¸‹é¢MySQLä¸»ä»åŸç† ä¸€ã€ä¸»ä»å¤åˆ¶\nMySQLæ•°æ®åº“å¤åˆ¶æ“ä½œå¤§è‡´å¯ä»¥åˆ†æˆä¸‰ä¸ªæ­¥éª¤ï¼š\n1. ä¸»æœåŠ¡å™¨å°†æ•°æ®çš„æ”¹å˜è®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinary logï¼‰ä¸­ã€‚\n2. ä»æœåŠ¡å™¨å°†ä¸»æœåŠ¡å™¨çš„binary log events å¤åˆ¶åˆ°å®ƒçš„ä¸­ç»§æ—¥å¿—ï¼ˆrelay logï¼‰ä¸­ã€‚\n3. ä»æœåŠ¡å™¨é‡åšä¸­ç»§æ—¥å¿—ä¸­çš„äº‹ä»¶ï¼Œå°†æ•°æ®çš„æ”¹å˜ä¸ä»æœåŠ¡å™¨ä¿æŒåŒæ­¥ã€‚\né¦–å…ˆï¼Œä¸»æœåŠ¡å™¨ä¼šè®°å½•äºŒè¿›åˆ¶æ—¥å¿—ï¼Œæ¯ä¸ªäº‹åŠ¡æ›´æ–°æ•°æ®å®Œæˆä¹‹å‰ï¼Œä¸»æœåŠ¡å™¨å°†è¿™äº›æ“ä½œçš„ä¿¡æ¯è®°å½•åœ¨äºŒè¿›åˆ¶æ—¥å¿—é‡Œé¢åœ¨äº‹ä»¶å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—å®Œæˆåä¸»æœåŠ¡å™¨é€šçŸ¥ å­˜å‚¨å¼•æ“æäº¤äº‹åŠ¡ã€‚\nå‡†å¤‡ï¼š äº†è§£binlogæ—¥å¿—ï¼ŒMySQLç”¨æˆ·-æƒé™ mysqlæœåŠ¡å™¨é…ç½®å¤åˆ¶ä¸éš¾ï¼Œä½†æ˜¯å› ä¸ºåœºæ™¯ä¸åŒå¯èƒ½ä¼šå­˜åœ¨ä¸€å®šçš„å·®å¼‚åŒ–ï¼Œæ€»çš„æ¥è¯´åˆ†ä¸ºä¸€ä¸‹å‡ æ­¥ï¼š\n1. åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºå¤åˆ¶è´¦å·ã€‚\n2. é€šçŸ¥å¤‡åº“è¿æ¥åˆ°ä¸»åº“å¹¶ä»ä¸»åº“å¤åˆ¶æ•°æ®ã€‚\näºŒã€ä¸»ä»ä¸€è‡´æ€§é—®é¢˜æ ¡éªŒ\nåœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œå¤‡åº“å’Œä¸»åº“çš„æ•°æ®åº”è¯¥æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚ä½†äº‹å®ä¸Šå¤‡åº“å¯èƒ½å‘ç”Ÿé”™è¯¯å¹¶å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚å³ä½¿æ²¡æœ‰æ˜æ˜¾çš„é”™è¯¯ï¼Œå¤‡åº“åŒæ ·å¯èƒ½å› ä¸ºMySQLè‡ªèº«çš„ç‰¹æ€§å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œä¾‹å¦‚MySQLçš„Bugæ„Ÿã€ç½‘ç»œä¸­æ–­ã€æœåŠ¡å™¨å´©æºƒï¼Œéæ­£å¸¸å…³é—­æˆ–è€…å…¶ä»–ä¸€äº›é”™è¯¯ã€‚ æŒ‰ç…§æˆ‘ä»¬çš„ç»éªŒæ¥çœ‹ï¼Œä¸»å¤‡ä¸€è‡´åº”è¯¥æ˜¯ä¸€ç§è§„èŒƒï¼Œè€Œä¸æ˜¯ä¾‹å¤–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ£€æŸ¥ä½ çš„ä¸»å¤‡åº“ä¸€è‡´æ€§åº”è¯¥æ˜¯ä¸€ä¸ªæ—¥å¸¸å·¥ä½œï¼Œç‰¹åˆ«æ˜¯å½“ä½¿ç”¨å¤‡åº“æ¥åšå¤‡ä»½æ—¶å°¤ä¸ºé‡è¦ï¼Œå› ä¸ºè‚¯å®šä¸å¸Œæœ›ä»ä¸€ä¸ªå·²ç»æŸåçš„å¤‡åº“é‡Œè·å¾—å¤‡ä»½æ•°æ®ã€‚\näº§ç”ŸåŸå› ï¼š\n1ã€ç½‘ç»œä¸­æ–­\n2ã€æœåŠ¡å™¨äº§ç”Ÿäº†é—®é¢˜\n3ã€mysqlè‡ªå¸¦bug\n4ã€ä»åº“è¿›è¡Œäº†éæ­£å½“çš„æ“ä½œï¼ˆæ¯”å¦‚ä»åº“è¿›è¡Œäº†æ·»åŠ ï¼Œåˆ é™¤ï¼Œä¿®æ”¹ï¼Œä¸»åº“å°±ä¼šæ–­å¼€ï¼‰\nç¯å¢ƒæ„å»º è¿™è¾¹æˆ‘æ‰ç”¨dockeræ¥æ¨¡æ‹Ÿï¼Œç¯å¢ƒå¾ˆå¿«æ„å»ºå®Œæˆæ¥æ¼”ç¤ºã€‚\nä¸‹é¢æ˜¯é“¾æ¥ï¼Œå¯ä»¥å‚è€ƒ\nDockerå®‰è£…MySQLé›†ç¾¤ã€è¯»å†™åˆ†ç¦»ã€‘ MySQLï¼š5.7\nç¯å¢ƒä»¥åŠæ„å»ºå®Œæˆï¼Œä¸‹é¢å¼€å§‹è¯•éªŒå§ã€‚\nå®‰è£…å·¥å…·ï¼š 1 2 3 4 5 [root@db03 ~]# wget https://downloads.mysql.com/archives/get/p/30/file/mysql-utilities-1.6.5-1.el7.noarch.rpm [root@db03 ~]# wget https://downloads.mysql.com/archives/get/p/29/file/mysql-connector-python-2.1.7-1.el7.x86_64.rpm [root@db03 ~]# yum -y localinstall mysql-connector-python-2.1.7-1.el7.x86_64.rpm [root@db03 ~]# yum -y localinstall mysql-utilities-1.6.5-1.el7.noarch.rpm æ£€æŸ¥ä¸¤ä¸ªå®ä¾‹çš„æ•°æ®ï¼š\nå¯ä»¥çœ‹åˆ°msterå’Œsalveréƒ½æœ‰CMSåº“ï¼Œå¯ä»¥åŒæ­¥æ•°æ®ã€‚\nç°åœ¨æ•°æ®éƒ½æ˜¯ä¸€è‡´çš„ã€‚ç°åœ¨å¯¹æ¯”çœ‹ä¸€ä¸‹ã€‚\nmysqldbcompareçš„è¯­æ³•å¦‚ä¸‹ï¼š\n1 $Â mysqldbcompare --server1=user:pass@host:port:socket --server2=user:pass@host:port:socket db1:db2 ä»¥ä¸Šå‚æ•°ä¸­ï¼š\n--server1ï¼šMySQLæœåŠ¡å™¨1é…ç½®ã€‚ --server2ï¼šMySQLæœåŠ¡å™¨2é…ç½®ã€‚å¦‚æœæ˜¯åŒä¸€æœåŠ¡å™¨ï¼Œ--server2å¯ä»¥çœç•¥ã€‚ db1:db2ï¼šè¦æ¯”è¾ƒçš„ä¸¤ä¸ªæ•°æ®åº“ã€‚å¦‚æœæ¯”è¾ƒä¸åŒæœåŠ¡å™¨ä¸Šçš„åŒåæ•°æ®åº“ï¼Œå¯ä»¥çœç•¥:db2ã€‚ --allï¼šæ¯”è¾ƒæ‰€æœ‰ä¸¤æœåŠ¡å™¨ä¸Šæ‰€æœ‰çš„åŒåæ•°æ®åº“ã€‚--excludeæ’é™¤æ— éœ€æ¯”è¾ƒçš„æ•°æ®åº“ã€‚ --run-all-testsï¼šè¿è¡Œå®Œæ•´æ¯”è¾ƒï¼Œé‡åˆ°ç¬¬ä¸€æ¬¡å·®å¼‚æ—¶ä¸åœæ­¢ã€‚ --changes-for=ï¼šä¿®æ”¹å¯¹è±¡ã€‚ä¾‹å¦‚--changes-for=server2ï¼Œé‚£ä¹ˆå¯¹æ¯”ä»¥sever1ä¸ºä¸»ï¼Œç”Ÿæˆçš„å·®å¼‚çš„ä¿®æ”¹ä¹Ÿæ˜¯é’ˆå¯¹server2çš„å¯¹è±¡çš„ä¿®æ”¹ã€‚ -d DIFFTYPE,--difftype=DIFFTYPEï¼šå·®å¼‚çš„ä¿¡æ¯æ˜¾ç¤ºçš„æ–¹å¼ï¼Œæœ‰[unified|context|differ|sql]ï¼Œé»˜è®¤æ˜¯unifiedã€‚å¦‚æœä½¿ç”¨sqlï¼Œé‚£ä¹ˆå°±ç›´æ¥ç”Ÿæˆå·®å¼‚çš„SQLï¼Œè¿™æ ·éå¸¸æ–¹ä¾¿ã€‚ --show-reverseï¼šåœ¨ç”Ÿæˆçš„å·®å¼‚ä¿®æ”¹é‡Œé¢ï¼ŒåŒæ—¶ä¼šåŒ…å«server2å’Œserver1çš„ä¿®æ”¹ã€‚ --skip-table-optionsï¼šä¿æŒè¡¨çš„é€‰é¡¹ä¸å˜ï¼Œå³å¯¹æ¯”çš„å·®å¼‚é‡Œé¢ä¸åŒ…æ‹¬è¡¨åã€AUTO_INCREMENTã€ENGINEã€CHARSETç­‰å·®å¼‚ã€‚ --skip-diffï¼šè·³è¿‡å¯¹è±¡å®šä¹‰æ¯”è¾ƒæ£€æŸ¥ã€‚æ‰€è°“å¯¹è±¡å®šä¹‰ï¼Œå°±æ˜¯CREATEè¯­å¥()é‡Œé¢çš„éƒ¨åˆ†ï¼Œ--skip-table-optionsæ˜¯()å¤–é¢çš„éƒ¨åˆ†ã€‚ --skip-object-compareï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ˆæ£€æŸ¥ä¸¤ä¸ªæ•°æ®åº“ä¸­ç›¸äº’ç¼ºå¤±çš„å¯¹è±¡ï¼Œå†å¯¹éƒ½å­˜åœ¨å¯¹è±¡é—´çš„å·®å¼‚ã€‚è¿™ä¸ªå‚æ•°çš„ä½œç”¨å°±æ˜¯ï¼Œè·³è¿‡ç¬¬ä¸€æ­¥ï¼Œä¸æ£€æŸ¥ç›¸äº’ç¼ºå¤±çš„å¯¹è±¡ã€‚ --skip-checksum-tableï¼šæ•°æ®ä¸€è‡´æ€§éªŒè¯æ—¶è·³è¿‡CHECKSUM TABLEã€‚ --skip-data-checkï¼šè·³è¿‡æ•°æ®ä¸€è‡´æ€§éªŒè¯ã€‚ --skip-row-countï¼šè·³è¿‡å­—æ®µæ•°é‡æ£€æŸ¥ã€‚ 1 mysqldbcompare --server1=root:root@127.0.0.1:3307 --server2=root:root@127.0.0.1:3316 --changes-for=server2 --difftype=sql --run-all-tests --all \u0026gt; mysqldbcompare_diff_2.sql æ£€æŸ¥æ²¡æœ‰é”™è¯¯\nåœæ‰ä¸»ä»åŒæ­¥ ä»åº“æ‰§è¡Œ\n1 stop slave; ä¿®æ”¹ä¸»åº“æ•°æ® çœ‹è¿™è¾¹å·²ç»å¯¹æ¯”å‡ºä¿®æ”¹çš„å­—æ®µäº†\n1 UPDATE `CMS`.`CI_CHANNEL` SET `SHORT_NAME` = \u0026#39;welcome heian\u0026#39;, `UPDATE_TIME` = \u0026#39;2021-01-14 15:36:59\u0026#39; WHERE `ID` = \u0026#39;1\u0026#39; æˆ‘å·²ç»åœ¨ä»åº“æ‰§è¡Œè¿™æ¡è¯­å¥\nåˆ é™¤å¤§é‡çš„æ•°æ®åšå¯¹æ¯”\næ•°æ®å°±å¯ä»¥æ¢å¤äº†\n","date":"2021-01-17T23:46:12Z","image":"https://www.ownit.top/title_pic/53.jpg","permalink":"https://www.ownit.top/p/202101172346/","title":"å½“MySQLä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œæ€ä¹ˆè§£å†³ï¼Ÿï¼Ÿï¼Ÿ"},{"content":"ç›®å½•\n1ã€é¡¹ç›®è¿ç§»åˆ°k8så¹³å°çš„æ€æ ·çš„æµç¨‹\n2ã€KubernetesåŸºæœ¬æ¦‚å¿µ\n3ã€æ„å»ºé¡¹ç›®é•œåƒ\n4ã€éƒ¨ç½²é¡¹ç›®é•œåƒåˆ°Kuberneteså¹³å°\n1ã€é¡¹ç›®è¿ç§»åˆ°k8så¹³å°çš„æ€æ ·çš„æµç¨‹ 2ã€KubernetesåŸºæœ¬æ¦‚å¿µ ï¬ Pod â€¢ æœ€å°éƒ¨ç½²å•å…ƒ â€¢ ä¸€ç»„å®¹å™¨çš„é›†åˆ â€¢ ä¸€ä¸ªPodä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ â€¢ Podæ˜¯çŸ­æš‚çš„\nï¬ Controllers â€¢ Deployment ï¼š æ— çŠ¶æ€åº”ç”¨éƒ¨ç½² â€¢ StatefulSet ï¼š æœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½² â€¢ DaemonSet ï¼š ç¡®ä¿æ‰€æœ‰Nodeè¿è¡ŒåŒä¸€ä¸ªPod â€¢ Job ï¼š ä¸€æ¬¡æ€§ä»»åŠ¡ â€¢ Cronjob ï¼š å®šæ—¶ä»»åŠ¡\næ›´é«˜çº§å±‚æ¬¡å¯¹è±¡ï¼Œéƒ¨ç½²å’Œç®¡ç†Pod\nï¬ Service â€¢ é˜²æ­¢Podå¤±è” â€¢ å®šä¹‰ä¸€ç»„Podçš„è®¿é—®ç­–ç•¥\nï¬ Label ï¼š æ ‡ç­¾ï¼Œé™„åŠ åˆ°æŸä¸ªèµ„æºä¸Šï¼Œç”¨äºå…³è”å¯¹è±¡ã€æŸ¥è¯¢å’Œç­›é€‰\nï¬ Namespaces ï¼š å‘½åç©ºé—´ï¼Œå°†å¯¹è±¡é€»è¾‘ä¸Šéš”ç¦»\n3ã€æ„å»ºé¡¹ç›®é•œåƒ 1ã€å‡†å¤‡JaråŒ… 2ã€åˆ¶ä½œé•œåƒ è§£å‹æ–‡ä»¶\n1 yum install -y unzip \u0026amp;\u0026amp; unzip tomcat-java-demo-master.zip æŠŠè¿™ä¸ªsqlæ–‡ä»¶å¯¼å…¥mysqlã€‚\nåœ¨Node1ä¸Šä¸‹è½½mysql:5.6çš„é•œåƒã€‚\n1 2 3 4 5 6 docker run -p 3306:3306 --name mysql-master \\ -v /mydata/mysql/master/log:/var/log/mysql \\ -v /mydata/mysql/master/data:/var/lib/mysql \\ -v /mydata/mysql/master/conf:/etc/mysql \\ -e MYSQL_ROOT_PASSWORD=root \\ -d mysql:5.6 æ¥ä¸‹å¯¼å…¥sqlæ•°æ®ã€‚\nå¯ä»¥ä½¿ç”¨å·¥å…·å¯¼å…¥æ–¹ä¾¿ã€‚\nä¿®æ”¹ä»£ç é‡Œçš„é…ç½®æ–‡ä»¶\nå®‰è£…JDkå’ŒMavenç¯å¢ƒ\n1 yum install -y java-1.8.0-openjdk maven ä¿®æ”¹mavenæº\n1 2 3 4 5 6 7 8 9 vim /etc/maven/settings.xml \u0026lt;mirror\u0026gt; \u0026lt;id\u0026gt;alimaven\u0026lt;/id\u0026gt; \u0026lt;name\u0026gt;aliyun maven\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;http://maven.aliyun.com/nexus/content/groups/public/\u0026lt;/url\u0026gt; \u0026lt;mirrorOf\u0026gt;central\u0026lt;/mirrorOf\u0026gt; \u0026lt;/mirror\u0026gt; ç¼–è¯‘æºç  ã€æ¼«é•¿çš„ç­‰å¾…ã€‘\n1 mvn clean package -D maven.test.skip=true å‡†å¤‡ä½¿ç”¨DockerFileæ–‡ä»¶æ¥æ„å»ºé•œåƒã€‚\n1 2 3 4 FROM lizhenliang/tomcat LABEL maintainer www.ctnrs.com RUN rm -rf /usr/local/tomcat/webapps/* ADD target/*.war /usr/local/tomcat/webapps/ROOT.war æ„å»ºé•œåƒ\n1 docker build -t lizhenliang/java-demo -f Dockerfile . å·²ç»æˆåŠŸ\nå†™ymalæ–‡ä»¶ã€ç”Ÿæˆæ¨¡æ¿ï¼Œåœ¨ä¿®æ”¹ã€‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 kubectl create deployment java-demo --image=lizhenliang/java-demo --dry-run -o yaml #å†…å®¹ apiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: java-demo name: java-demo spec: replicas: 1 selector: matchLabels: app: java-demo strategy: {} template: metadata: creationTimestamp: null labels: app: java-demo spec: containers: - image: lizhenliang/java-demo name: java-demo resources: {} status: {} é‡å®šå‘ï¼Œç”Ÿæˆæœ¬åœ°çš„yaml\n1 kubectl create deployment java-demo --image=lizhenliang/java-demo --dry-run -o yaml \u0026gt; deploy.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 [root@master ~]# cat deploy.yaml apiVersion: apps/v1 kind: Deployment metadata: labels: app: java-demo name: java-demo spec: replicas: 2 selector: matchLabels: app: java-demo template: metadata: creationTimestamp: null labels: app: java-demo spec: containers: - image: lizhenliang/java-demo name: java-demo è¿è¡Œ\n1 kubectl apply -f deploy.yaml 1 kubectl get pods 4ã€éƒ¨ç½²é¡¹ç›®é•œåƒåˆ°Kuberneteså¹³å° ","date":"2020-12-25T10:13:24Z","image":"https://www.ownit.top/title_pic/58.jpg","permalink":"https://www.ownit.top/p/202012251013/","title":"åœ¨Kubernetesï¼ˆk8sï¼‰ä¸­éƒ¨ç½²Javaåº”ç”¨"},{"content":" å—å®«ä¹˜é£ï¼šæˆ‘åœ¨å­¦Pythonå“¦\nPythonï¼šä½ ä¸å†™Pythoné¡¹ç›®ï¼Œæ˜¯ä¸ä¼šæœ‰è¿›æ­¥çš„ï¼Œå¹´è½»äººï¼Œè€—å­å°¾æ±å§\nå—å®«ä¹˜é£ï¼šæˆ‘è¦è¿›æ­¥ï¼Œè¦å­¦ä¹ ï¼Œå¼€å§‹é¡¹ç›®\nPythonï¼šæ¥éª—ï¼Œæ¥å·è¢­ã€‚å¾ˆå¿«å•Šï¼å¹´è½»äººï¼Œä¸è®²ç å¾·\nå­¦äº†ä¸€ç‚¹æ—¶é—´Pythonï¼Œä¸ºäº†å·©å›ºåŸºç¡€ï¼Œæ‹¿ä¸€ä¸ªç®€å•çš„é¡¹ç›®ç»ƒæ‰‹ã€‚\nATM+è´­ç‰©è½¦åŠŸèƒ½ï¼ˆpsï¼šå¾ˆç®€å•ï¼Œå¤§ä½¬ä¸è¦å˜²ç¬‘å“ˆï¼‰ é¡¹ç›®éœ€æ±‚ï¼š 1 2 3 4 5 6 7 8 9 10 1.é¢åº¦15000æˆ–è‡ªå®šä¹‰ --\u0026gt; æ³¨å†ŒåŠŸèƒ½ 2.å®ç°è´­ç‰©å•†åŸï¼Œä¹°ä¸œè¥¿åŠ å…¥è´­ç‰©è½¦ï¼Œè°ƒç”¨ä¿¡ç”¨å¡æ¥å£ç»“è´¦ --\u0026gt; è´­ç‰©åŠŸèƒ½ã€æ”¯ä»˜åŠŸèƒ½ 3.å¯ä»¥æç°ï¼Œæ‰‹ç»­è´¹5% --\u0026gt; æç°åŠŸèƒ½ 4.æ”¯æŒå¤šè´¦æˆ·ç™»å½• --\u0026gt; ç™»å½•åŠŸèƒ½ 5.æ”¯æŒè´¦æˆ·é—´è½¬è´¦ --\u0026gt; è½¬è´¦åŠŸèƒ½ 6.è®°å½•æ—¥å¸¸æ¶ˆè´¹ --\u0026gt; è®°å½•æµæ°´åŠŸèƒ½ 7.æä¾›è¿˜æ¬¾æ¥å£ --\u0026gt; è¿˜æ¬¾åŠŸèƒ½ 8.ATMè®°å½•æ“ä½œæ—¥å¿— --\u0026gt; è®°å½•æ—¥å¿—åŠŸèƒ½ 9.æä¾›ç®¡ç†æ¥å£ï¼ŒåŒ…æ‹¬æ·»åŠ è´¦æˆ·ã€ç”¨æˆ·é¢åº¦ï¼Œå†»ç»“è´¦æˆ·ç­‰ã€‚ã€‚ã€‚ ---\u0026gt; ç®¡ç†å‘˜åŠŸèƒ½ 10.ç”¨æˆ·è®¤è¯ç”¨è£…é¥°å™¨ --\u0026gt; ç™»å½•è®¤è¯è£…é¥°å™¨ \u0026ldquo;ç”¨æˆ·è§†å›¾å±‚\u0026rdquo; å±•ç¤ºç»™ç”¨æˆ·é€‰æ‹©çš„åŠŸèƒ½ 1 2 3 4 5 6 7 8 9 10 11 12 user 1ã€æ³¨å†ŒåŠŸèƒ½ 2ã€ç™»å½•åŠŸèƒ½ 3ã€æŸ¥çœ‹ä½™é¢ 4ã€æç°åŠŸèƒ½ 5ã€è¿˜æ¬¾åŠŸèƒ½ 6ã€è½¬è´¦åŠŸèƒ½ 7ã€æŸ¥çœ‹æµæ°´ 8ã€è´­ç‰©åŠŸèƒ½ 9ã€æŸ¥çœ‹è´­ç‰©è½¦ 10ã€ç®¡ç†å‘˜åŠŸèƒ½ admin\n1 2 3 4 5 1ã€æ·»åŠ è´¦å· 2ã€ä¿®æ”¹é¢åº¦ 3ã€å†»ç»“è´¦å· 4ã€è§£å†»è´¦å· 5ã€è¿”å›ä¸Šä¸€å±‚ æ¶æ„æµç¨‹å›¾ é‡‡å–MVCçš„æ¶æ„æ–¹å¼\nå„å±‚åˆ†å¼€ï¼Œç¼–å†™æ¥å£\nä¸‰å±‚æ¶æ„ï¼š\n1 2 3 1ã€æŠŠæ¯ä¸ªåŠŸèƒ½éƒ½åˆ†å±‚ä¸‰éƒ¨åˆ†ï¼Œé€»è¾‘æ¸…æ™° 2ã€å¦‚æœç”¨æˆ·æ›´æ¢ä¸åŒçš„ç”¨æˆ·ç•Œé¢æˆ–ä¸åŒçš„æ•°æ®åº“å­˜å‚¨æœºåˆ¶ï¼Œä¸ä¼šå½±å“æ¥å£å±‚çš„æ ¸å¿ƒé€»è¾‘ä»£ç ï¼Œæ‰©å±•æ€§å¼ºã€‚ 3ï¼‰å¯ä»¥åœ¨æ¥å£å±‚ï¼Œå‡†ç¡®çš„è®°å½•æ—¥å¿—ä¸æµæ°´ã€‚ ä¸‰å±‚æ¶æ„æ„å»ºÂ é¡¹ç›®ä»£ç ï¼šhttps://wwx.lanzoux.com/i1vhGixijzi å¯åŠ¨ç•Œé¢ start.pyï¼ˆç¨‹åºçš„å…¥å£ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026#39;\u0026#39;\u0026#39; ç¨‹åºå…¥å£ \u0026#39;\u0026#39;\u0026#39; import os import sys from core import src # æ·»åŠ è§£é‡Šå™¨çš„ç¯å¢ƒå˜é‡ sys.path.append( os.path.dirname(__file__) ) # å¼€å§‹æ‰§è¡Œé¡¹ç›®main if __name__ == \u0026#34;__main__\u0026#34;: src.run() conf setting.pyï¼ˆlogæ—¥å¿—çš„é…ç½®æ–‡ä»¶ï¼Œé¡¹ç›®çš„ç¯å¢ƒé…ç½®ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 \u0026#39;\u0026#39;\u0026#39; é…ç½®æ–‡ä»¶è®¾ç½® \u0026#39;\u0026#39;\u0026#39; import os BASE=os.path.dirname(os.path.dirname(__file__)) # print(BASE) #è·å–user_dateæ–‡ä»¶å¤¹è·¯å¾„ USER_DATE=os.path.join(BASE,\u0026#39;db\u0026#39;,\u0026#39;user_date\u0026#39;) # print(USER_DATE) \u0026#34;\u0026#34;\u0026#34; æ—¥å¿—é…ç½®å­—å…¸LOGGING_DIC \u0026#34;\u0026#34;\u0026#34; # 1ã€å®šä¹‰ä¸‰ç§æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œæ—¥å¿—ä¸­å¯èƒ½ç”¨åˆ°çš„æ ¼å¼åŒ–ä¸²å¦‚ä¸‹ # %(name)s Loggerçš„åå­— # %(levelno)s æ•°å­—å½¢å¼çš„æ—¥å¿—çº§åˆ« # %(levelname)s æ–‡æœ¬å½¢å¼çš„æ—¥å¿—çº§åˆ« # %(pathname)s è°ƒç”¨æ—¥å¿—è¾“å‡ºå‡½æ•°çš„æ¨¡å—çš„å®Œæ•´è·¯å¾„åï¼Œå¯èƒ½æ²¡æœ‰ # %(filename)s è°ƒç”¨æ—¥å¿—è¾“å‡ºå‡½æ•°çš„æ¨¡å—çš„æ–‡ä»¶å # %(module)s è°ƒç”¨æ—¥å¿—è¾“å‡ºå‡½æ•°çš„æ¨¡å—å # %(funcName)s è°ƒç”¨æ—¥å¿—è¾“å‡ºå‡½æ•°çš„å‡½æ•°å # %(lineno)d è°ƒç”¨æ—¥å¿—è¾“å‡ºå‡½æ•°çš„è¯­å¥æ‰€åœ¨çš„ä»£ç è¡Œ # %(created)f å½“å‰æ—¶é—´ï¼Œç”¨UNIXæ ‡å‡†çš„è¡¨ç¤ºæ—¶é—´çš„æµ® ç‚¹æ•°è¡¨ç¤º # %(relativeCreated)d è¾“å‡ºæ—¥å¿—ä¿¡æ¯æ—¶çš„ï¼Œè‡ªLoggeråˆ›å»ºä»¥ æ¥çš„æ¯«ç§’æ•° # %(asctime)s å­—ç¬¦ä¸²å½¢å¼çš„å½“å‰æ—¶é—´ã€‚é»˜è®¤æ ¼å¼æ˜¯ â€œ2003-07-08 16:49:45,896â€ã€‚é€—å·åé¢çš„æ˜¯æ¯«ç§’ # %(thread)d çº¿ç¨‹IDã€‚å¯èƒ½æ²¡æœ‰ # %(threadName)s çº¿ç¨‹åã€‚å¯èƒ½æ²¡æœ‰ # %(process)d è¿›ç¨‹IDã€‚å¯èƒ½æ²¡æœ‰ # %(message)sç”¨æˆ·è¾“å‡ºçš„æ¶ˆæ¯ import os BASE_PATH=os.path.dirname(os.path.dirname(__file__)) a1_path=os.path.join(BASE_PATH,\u0026#39;log\u0026#39;,\u0026#39;a1.log\u0026#39;) a2_path=os.path.join(BASE_PATH,\u0026#39;log\u0026#39;,\u0026#39;a2.log\u0026#39;) # print(a1_path+\u0026#39;\\n\u0026#39;+a2_path) # 2ã€å¼ºè°ƒï¼šå…¶ä¸­çš„%(name)sä¸ºgetloggeræ—¶æŒ‡å®šçš„åå­— standard_format = \u0026#39;%(asctime)s - %(threadName)s:%(thread)d - æ—¥å¿—åå­—:%(name)s - %(filename)s:%(lineno)d -\u0026#39; \\ \u0026#39;%(levelname)s - %(message)s\u0026#39; simple_format = \u0026#39;[%(levelname)s][%(asctime)s][%(filename)s:%(lineno)d]%(message)s\u0026#39; test_format = \u0026#39;%(asctime)s] %(message)s\u0026#39; # 3ã€æ—¥å¿—é…ç½®å­—å…¸ LOGGING_DIC = { \u0026#39;version\u0026#39;: 1, \u0026#39;disable_existing_loggers\u0026#39;: False, \u0026#39;formatters\u0026#39;: { \u0026#39;standard\u0026#39;: { \u0026#39;format\u0026#39;: standard_format }, \u0026#39;simple\u0026#39;: { \u0026#39;format\u0026#39;: simple_format }, \u0026#39;test\u0026#39;: { \u0026#39;format\u0026#39;: test_format }, }, \u0026#39;filters\u0026#39;: {}, # handlersæ˜¯æ—¥å¿—çš„æ¥æ”¶è€…ï¼Œä¸åŒçš„handlerä¼šå°†æ—¥å¿—è¾“å‡ºåˆ°ä¸åŒçš„ä½ç½® \u0026#39;handlers\u0026#39;: { #æ‰“å°åˆ°ç»ˆç«¯çš„æ—¥å¿— \u0026#39;console\u0026#39;: { \u0026#39;level\u0026#39;: \u0026#39;DEBUG\u0026#39;, \u0026#39;class\u0026#39;: \u0026#39;logging.StreamHandler\u0026#39;, # æ‰“å°åˆ°å±å¹• \u0026#39;formatter\u0026#39;: \u0026#39;simple\u0026#39; }, \u0026#39;default\u0026#39;: { \u0026#39;level\u0026#39;: \u0026#39;DEBUG\u0026#39;, \u0026#39;class\u0026#39;: \u0026#39;logging.handlers.RotatingFileHandler\u0026#39;, # ä¿å­˜åˆ°æ–‡ä»¶ # \u0026#39;maxBytes\u0026#39;: 1024*1024*5, # æ—¥å¿—å¤§å° 5M \u0026#39;maxBytes\u0026#39;: 1024*1024*5, \u0026#39;backupCount\u0026#39;: 5, \u0026#39;filename\u0026#39;: a1_path, # os.path.join(os.path.dirname(os.path.dirname(__file__)),\u0026#39;log\u0026#39;,\u0026#39;a2.log\u0026#39;) \u0026#39;encoding\u0026#39;: \u0026#39;utf-8\u0026#39;, \u0026#39;formatter\u0026#39;: \u0026#39;standard\u0026#39;, }, #æ‰“å°åˆ°æ–‡ä»¶çš„æ—¥å¿—,æ”¶é›†infoåŠä»¥ä¸Šçš„æ—¥å¿— \u0026#39;other\u0026#39;: { \u0026#39;level\u0026#39;: \u0026#39;DEBUG\u0026#39;, \u0026#39;class\u0026#39;: \u0026#39;logging.FileHandler\u0026#39;, # ä¿å­˜åˆ°æ–‡ä»¶ \u0026#39;filename\u0026#39;: a1_path, # os.path.join(os.path.dirname(os.path.dirname(__file__)),\u0026#39;log\u0026#39;,\u0026#39;a2.log\u0026#39;) \u0026#39;encoding\u0026#39;: \u0026#39;utf-8\u0026#39;, \u0026#39;formatter\u0026#39;: \u0026#39;standard\u0026#39;, }, }, # loggersæ˜¯æ—¥å¿—çš„äº§ç”Ÿè€…ï¼Œäº§ç”Ÿçš„æ—¥å¿—ä¼šä¼ é€’ç»™handlerç„¶åæ§åˆ¶è¾“å‡º \u0026#39;loggers\u0026#39;: { #logging.getLogger(__name__)æ‹¿åˆ°çš„loggeré…ç½® \u0026#39;kkk\u0026#39;: { \u0026#39;handlers\u0026#39;: [\u0026#39;console\u0026#39;,\u0026#39;other\u0026#39;], # è¿™é‡ŒæŠŠä¸Šé¢å®šä¹‰çš„ä¸¤ä¸ªhandleréƒ½åŠ ä¸Šï¼Œå³logæ•°æ®æ—¢å†™å…¥æ–‡ä»¶åˆæ‰“å°åˆ°å±å¹• \u0026#39;level\u0026#39;: \u0026#39;DEBUG\u0026#39;, # loggers(ç¬¬ä¸€å±‚æ—¥å¿—çº§åˆ«å…³é™åˆ¶)---\u0026gt;handlers(ç¬¬äºŒå±‚æ—¥å¿—çº§åˆ«å…³å¡é™åˆ¶) \u0026#39;propagate\u0026#39;: False, # é»˜è®¤ä¸ºTrueï¼Œå‘ä¸Šï¼ˆæ›´é«˜levelçš„loggerï¼‰ä¼ é€’ï¼Œé€šå¸¸è®¾ç½®ä¸ºFalseå³å¯ï¼Œå¦åˆ™ä¼šä¸€ä»½æ—¥å¿—å‘ä¸Šå±‚å±‚ä¼ é€’ }, \u0026#39;ç»ˆç«¯æç¤º\u0026#39;: { \u0026#39;handlers\u0026#39;: [\u0026#39;console\u0026#39;,], # è¿™é‡ŒæŠŠä¸Šé¢å®šä¹‰çš„ä¸¤ä¸ªhandleréƒ½åŠ ä¸Šï¼Œå³logæ•°æ®æ—¢å†™å…¥æ–‡ä»¶åˆæ‰“å°åˆ°å±å¹• \u0026#39;level\u0026#39;: \u0026#39;DEBUG\u0026#39;, # loggers(ç¬¬ä¸€å±‚æ—¥å¿—çº§åˆ«å…³é™åˆ¶)---\u0026gt;handlers(ç¬¬äºŒå±‚æ—¥å¿—çº§åˆ«å…³å¡é™åˆ¶) \u0026#39;propagate\u0026#39;: False, # é»˜è®¤ä¸ºTrueï¼Œå‘ä¸Šï¼ˆæ›´é«˜levelçš„loggerï¼‰ä¼ é€’ï¼Œé€šå¸¸è®¾ç½®ä¸ºFalseå³å¯ï¼Œå¦åˆ™ä¼šä¸€ä»½æ—¥å¿—å‘ä¸Šå±‚å±‚ä¼ é€’ }, \u0026#39;\u0026#39;: { \u0026#39;handlers\u0026#39;: [\u0026#39;default\u0026#39;, ], # è¿™é‡ŒæŠŠä¸Šé¢å®šä¹‰çš„ä¸¤ä¸ªhandleréƒ½åŠ ä¸Šï¼Œå³logæ•°æ®æ—¢å†™å…¥æ–‡ä»¶åˆæ‰“å°åˆ°å±å¹• \u0026#39;level\u0026#39;: \u0026#39;DEBUG\u0026#39;, # loggers(ç¬¬ä¸€å±‚æ—¥å¿—çº§åˆ«å…³é™åˆ¶)---\u0026gt;handlers(ç¬¬äºŒå±‚æ—¥å¿—çº§åˆ«å…³å¡é™åˆ¶) \u0026#39;propagate\u0026#39;: False, # é»˜è®¤ä¸ºTrueï¼Œå‘ä¸Šï¼ˆæ›´é«˜levelçš„loggerï¼‰ä¼ é€’ï¼Œé€šå¸¸è®¾ç½®ä¸ºFalseå³å¯ï¼Œå¦åˆ™ä¼šä¸€ä»½æ—¥å¿—å‘ä¸Šå±‚å±‚ä¼ é€’ }, }, } core admin.pyï¼ˆadminç”¨æˆ·è§†å›¾ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 from core import src from interface import admin_interface def add_user(): src.register() def change_balance(): while True: # è¾“å…¥ä¿®æ”¹ä¿®æ”¹ç”¨æˆ·å change_user = input(\u0026#39;è¯·è¾“å…¥éœ€è¦ä¿®æ”¹é¢åº¦çš„ç”¨æˆ·ï¼š\u0026#39;).strip() change_money = input(\u0026#39;è¯·è¾“å…¥éœ€è¦ä¿®æ”¹çš„ç”¨æˆ·é¢åº¦ï¼š\u0026#39;).strip() if not change_money.isdigit(): continue if int(change_money) \u0026gt;= 0: flag, msg = admin_interface.change_balance_interafce(change_user, change_money) if flag: print(msg) else: print(msg) else: print(\u0026#39;è¾“å…¥çš„é¢åº¦ä¸æ­£ç¡®\u0026#39;) def disable_user(): # è¾“å…¥è¦å†»ç»“çš„ç”¨æˆ· while True: dis_user = input(\u0026#39;è¯·è¾“å…¥è¦å†»ç»“çš„ç”¨æˆ·ï¼š\u0026#39;).strip() flag, msg = admin_interface.disable_user_interface(dis_user) if flag: print(msg) break else: print(msg) def enable_user(): # è¾“å…¥è¦è§£å†»å†»ç»“çš„ç”¨æˆ· while True: dis_user = input(\u0026#39;è¯·è¾“å…¥è¦è§£å†»å†»ç»“çš„ç”¨æˆ·ï¼š\u0026#39;).strip() flag, msg = admin_interface.enable_user_interface(dis_user) if flag: print(msg) break else: print(msg) def lsat_men(): from core import src src.run() func_dic = { \u0026#39;1\u0026#39;: add_user, \u0026#39;2\u0026#39;: change_balance, \u0026#39;3\u0026#39;: disable_user, \u0026#39;4\u0026#39;: enable_user, \u0026#39;5\u0026#39;: lsat_men, } def admin_run(): while True: print(\u0026#39;\u0026#39;\u0026#39; 1ã€æ·»åŠ è´¦å· 2ã€ä¿®æ”¹é¢åº¦ 3ã€å†»ç»“è´¦å· 4ã€è§£å†»è´¦å· 5ã€è¿”å›ä¸Šä¸€å±‚ \u0026#39;\u0026#39;\u0026#39;) choice = input(\u0026#39;è¯·è¾“å…¥ç®¡ç†å‘˜åŠŸèƒ½ç¼–å·ï¼š\u0026#39;).strip() if choice not in func_dic: print(\u0026#34;è¯·è¾“å…¥æ­£ç¡®çš„åŠŸèƒ½ç¼–å·\u0026#34;) continue func_dic.get(choice)() # if __name__ == \u0026#39;__main__\u0026#39;: # admin() src.pyï¼ˆç”¨æˆ·çš„è§†å›¾ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 \u0026#39;\u0026#39;\u0026#39; ç”¨æˆ·è§†å›¾å±‚ \u0026#39;\u0026#39;\u0026#39; from interface import user_interface, bank_interface, shop_interface from lib import common from core import admin # 1ã€æ³¨å†ŒåŠŸèƒ½ \u0026#39;\u0026#39;\u0026#39;def register(): while True: # 1 è®©ç”¨æˆ·è¾“å…¥ç”¨æˆ·åç§°å’Œå¯†ç è¿›è¡Œæ ¡éªŒ username = input(\u0026#39;è¯·è¾“å…¥ç”¨æˆ·ï¼š\u0026#39;).strip() if username.strip()==\u0026#39;\u0026#39;: print(\u0026#34;è¯·è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·å\u0026#34;) continue user_path = os.path.join(setting.USER_DATE, f\u0026#34;{username}.json\u0026#34;) if os.path.exists(user_path): print(f\u0026#34;æ‚¨è¾“å…¥çš„ç”¨æˆ·åï¼š{username}å·²ç»å­˜åœ¨\u0026#34;) continue password = input(\u0026#34;è¯·è¾“å…¥å¯†ç ï¼š\u0026#34;).strip() re_password = input(\u0026#34;è¯·ç¡®è®¤å¯†ç ï¼š\u0026#34;).strip() # åˆ¤æ–­å¯†ç æ˜¯å¦ä¸€è‡´ if password == re_password: # 2 æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦å­˜åœ¨ # 3 å¦‚ç”¨æˆ·å­˜åœ¨ï¼Œåˆ™è®©ç”¨æˆ·é‡æ–°è¾“å…¥ # 4 å¦‚ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ™ä¿å­˜ç”¨æˆ·æ•°æ® # 4.1 ç»„ç»‡ç”¨æˆ·çš„æ•°æ®çš„å­—å…¸ä¿¡æ¯ user_dic = { \u0026#39;username\u0026#39;: username, \u0026#39;password\u0026#39;: password, \u0026#39;balance\u0026#39;: 15000, # ç”¨äºè®°å½•ç”¨æˆ·çš„æµæ°´ç±»è¡¨ \u0026#39;flow\u0026#39;: [], # ç”¨äºè®°å½•ç”¨æˆ·è´­ç‰©è½¦ \u0026#39;shop_car\u0026#39;: [], # locaked :ç”¨äºè®°å½•ç”¨æˆ·æ˜¯å¦å†»ç»“ # falseï¼šæœªå†»ç»“ Trueï¼šå·²ç»è¢«å†»ç»“ \u0026#39;locaked\u0026#39;: False } # ç”¨æˆ·æ•°æ®tank.json user_path = os.path.join(setting.USER_DATE, f\u0026#34;{username}.json\u0026#34;) with open(user_path, \u0026#39;w\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: json.dump(user_dic, f) else: print(\u0026#39;æ‚¨çš„ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´,è¯·é‡æ–°è¾“å…¥\u0026#39;)\u0026#39;\u0026#39;\u0026#39; login_user = None # åˆ†å±‚ç‰ˆ def register(): while True: # 1 è®©ç”¨æˆ·è¾“å…¥ç”¨æˆ·åç§°å’Œå¯†ç è¿›è¡Œæ ¡éªŒ username = input(\u0026#39;è¯·è¾“å…¥ç”¨æˆ·ï¼š\u0026#39;).strip() if username.strip() == \u0026#39;\u0026#39;: print(\u0026#34;è¯·è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·å\u0026#34;) continue password = input(\u0026#34;è¯·è¾“å…¥å¯†ç ï¼š\u0026#34;).strip() re_password = input(\u0026#34;è¯·ç¡®è®¤å¯†ç ï¼š\u0026#34;).strip() # åˆ¤æ–­å¯†ç æ˜¯å¦ä¸€è‡´ if password == re_password: # 2 è°ƒç”¨æ¥å£å±‚çš„æ³¨å†Œç»“æœã€‚å°†ç”¨æˆ·åå’Œå¯†ç ä¼ åˆ°æ¥å£å±‚ # (True, ç”¨æˆ·æ³¨å†ŒæˆåŠŸ)ï¼Œ (False, æ³¨å†Œå¤±è´¥) flag, msg = user_interface.register_interface( username, password ) # 3) æ ¹æ®flagåˆ¤æ–­ç”¨æˆ·æ³¨å†Œæ˜¯å¦æˆåŠŸï¼Œflagæ§åˆ¶breakçš„ç»“æŸ if flag: print(msg) break else: print(msg) else: print(\u0026#39;æ‚¨çš„ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´,è¯·é‡æ–°è¾“å…¥\u0026#39;) # 2ã€ç™»å½•åŠŸèƒ½ def login(): # ç™»å½•è§†å›¾å±‚ while True: username = input(\u0026#39;è¯·è¾“å…¥ç”¨æˆ·åï¼š\u0026#39;).strip() password = input(\u0026#39;è¯·è¾“å…¥ç”¨æˆ·åå¯†ç ï¼š\u0026#39;).strip() flag, msg = user_interface.longin_interface(username, password) if flag: global login_user login_user = username print(msg) break else: print(msg) # 3ã€æŸ¥çœ‹ä½™é¢ @common.login_auth def check_balance(): # ç›´æ¥è°ƒç”¨æŸ¥çœ‹ç”¨æˆ·æ¥å£ï¼Œè·å–ç”¨ä½™é¢ balance = user_interface.check_balance_interface(login_user) print(f\u0026#39;ç”¨æˆ·ï¼š{login_user}è´¦å·ä½™é¢ä¸ºï¼š{balance}\u0026#39;) # 4ã€æç°åŠŸèƒ½ @common.login_auth def withdraw(): while True: # è®©ç”¨æˆ·è¾“å…¥ä½“ç°é‡‘é¢ input_money = input(\u0026#39;è¯·è¾“å…¥æç°é‡‘é¢ï¼š\u0026#39;).strip() # åˆ¤æ–­ç”¨æˆ·è¾“å…¥çš„é‡‘é¢æ˜¯å¦æ˜¯æ•°å­— if not input_money.isdigit(): print(\u0026#39;è¯·é‡æ–°è¾“å…¥ï¼š\u0026#39;) continue # ç”¨æˆ·æç°ï¼Œå°†é‡‘é¢æäº¤æ¥å£å¤„ç† flag, msg = bank_interface.withdraw_interface(login_user, int(input_money)) if flag: print(msg) break else: print(msg) # 5ã€è¿˜æ¬¾åŠŸèƒ½ @common.login_auth def repay(): while True: # è®©ç”¨æˆ·è¾“å…¥ä½“ç°é‡‘é¢ repay_money = input(\u0026#39;è¯·è¾“å…¥è¿˜æ¬¾é‡‘é¢ï¼š\u0026#39;).strip() # åˆ¤æ–­ç”¨æˆ·è¾“å…¥çš„é‡‘é¢æ˜¯å¦æ˜¯æ•°å­— if not repay_money.isdigit(): print(\u0026#39;è¯·é‡æ–°è¾“å…¥\u0026#39;) continue # ç”¨æˆ·æç°ï¼Œå°†é‡‘é¢æäº¤æ¥å£å¤„ç† if int(repay_money) \u0026gt; 0: flag, msg = bank_interface.repay_interface(login_user, int(repay_money)) if flag: print(msg) break else: print(\u0026#39;ä¸èƒ½è¾“å…¥å°äº0çš„æ•°å­—\u0026#39;) # 6ã€è½¬è´¦åŠŸèƒ½ @common.login_auth def transfer(): \u0026#39;\u0026#39;\u0026#39; æ¥æ”¶ç”¨æˆ·çš„è½¬è´¦é‡‘é¢ æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„è½¬è´¦ç›®æ ‡ :return: \u0026#39;\u0026#39;\u0026#39; while True: user_money = input(\u0026#39;è¯·è¾“å…¥è½¬è´¦ç›®æ ‡ç”¨æˆ·ï¼š\u0026#39;).strip() money = input(\u0026#39;è¯·è¾“å…¥è½¬è´¦é‡‘é¢ï¼š\u0026#39;).strip() if not money.isdigit(): print(\u0026#39;è¯·è¾“å…¥æ­£ç¡®çš„é‡‘é¢ï¼\u0026#39;) continue money = int(money) if money \u0026gt; 0: # è½¬è´¦æ¥å£ flag, msg = bank_interface.transfer_interface(login_user, user_money, money) if flag: print(msg) break else: print(msg) else: print(\u0026#39;è¯·è¾“å…¥æ­£ç¡®çš„é‡‘é¢ï¼\u0026#39;) # 7ã€æŸ¥çœ‹æµæ°´ @common.login_auth def check_flow(): # ç›´æ¥è°ƒç”¨æŸ¥çœ‹æµæ°´çš„åˆ—è¡¨ flow_list = bank_interface.check_flow_interface(login_user) if flow_list: for flow in flow_list: print(flow) else: print(\u0026#39;å½“å‰ç”¨æˆ·æ²¡æœ‰æµæ°´è®°å½•\u0026#39;) # 8ã€è´­ç‰©åŠŸèƒ½ @common.login_auth def shopping(): \u0026#39;\u0026#39;\u0026#39; { \u0026#39;0\u0026#39;:{\u0026#39;name\u0026#39;:\u0026#39;åŒ…å­\u0026#39;,\u0026#39;price\u0026#39;:30}, \u0026#39;0\u0026#39;: {\u0026#39;name\u0026#39;: \u0026#39;åŒ…å­\u0026#39;, \u0026#39;price\u0026#39;: 30}, \u0026#39;0\u0026#39;: {\u0026#39;name\u0026#39;: \u0026#39;åŒ…å­\u0026#39;, \u0026#39;price\u0026#39;: 30}, } :return: \u0026#39;\u0026#39;\u0026#39; shop_list = [ [\u0026#39;åŒ…å­\u0026#39;, 30], [\u0026#39;è¡£æœ\u0026#39;, 150], [\u0026#39;å®‰å…¨å¥—\u0026#39;, 25], [\u0026#39;æƒ…è¶£å†…è¡£\u0026#39;, 520], [\u0026#39;cosplay\u0026#39;, 250], ] shopping_car = {} while True: # å…ˆæ‰“å°å•†å“çš„ä¿¡æ¯ï¼Œè®©ç”¨æˆ·é€‰æ‹© print(\u0026#39;===================æ¬¢è¿æ¥åˆ°æƒ…è¶£å•†åŸ================\u0026#39;) for index, shop in enumerate(shop_list): shop_name, shop_price = shop print(f\u0026#39;å•†å“ç¼–å·ï¼š{index}, å•†å“åç§°ï¼š{shop_name},å•†å“å•ä»·ï¼š{shop_price}\u0026#39;) print(\u0026#39;========================end======================\u0026#39;) shop_choice = input(\u0026#34;è¯·è¾“å…¥ä½ è¦é€‰è´­çš„å•†å“ç¼–å·(æ˜¯å¦ç»“è´¦y or n)ï¼š\u0026#34;).strip() if shop_choice.upper() == \u0026#39;Y\u0026#39;: if not shopping_car: print(\u0026#39;è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œä¸èƒ½æ”¯ä»˜ï¼Œè¯·é‡æ–°è¾“å…¥\u0026#39;) continue # è°ƒç”¨æ”¯ä»˜æ¥å£è¿›è¡Œæ”¯ä»˜ flag,msg=shop_interface.shopping_interface(login_user,shopping_car) if flag: print(msg) break else: print(msg) elif shop_choice.upper() == \u0026#39;N\u0026#39;: # åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æ·»åŠ è¿‡è´­ç‰©è½¦ if not shopping_car: print(\u0026#39;è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œä¸èƒ½æ·»åŠ ï¼Œè¯·é‡æ–°è¾“å…¥\u0026#39;) continue flag,msg=shop_interface.add_shop_car_interface(login_user,shopping_car) if flag: print(msg) break if not shop_choice.isdigit(): print(\u0026#39;è¯·è¾“å…¥æ­£ç¡®çš„ç¼–å·ï¼\u0026#39;) continue shop_choice = int(shop_choice) if shop_choice not in range(len(shop_list)): print(\u0026#39;è¯·è¾“å…¥æ­£ç¡®çš„ç¼–å·ï¼\u0026#39;) continue shop_name, shop_price = shop_list[shop_choice] if shop_name in shopping_car: shopping_car[shop_name][1] += 1 else: shopping_car[shop_name] = [shop_price, 1] print(\u0026#34;å½“å‰è´­ç‰©è½¦ï¼š\u0026#34;,shopping_car) # 9ã€æŸ¥çœ‹è´­ç‰©è½¦ @common.login_auth def check_shop_car(): shop_list = shop_interface.check_shop_car_interface(login_user) if shop_list: for shop_name,print_number in shop_list.items(): print(f\u0026#39;å•†å“ï¼š[{shop_name}],æ•°é‡ï¼š[{print_number[1]}]\u0026#39;) else: print(\u0026#39;å½“å‰ç”¨æˆ·æ²¡æœ‰æµæ°´è®°å½•\u0026#39;) @common.login_auth def admin_spuer(): admin.admin_run() # åˆ›å»ºå‡½æ•°åŠŸèƒ½å­—å…¸ func_dic = { \u0026#39;1\u0026#39;: register, \u0026#39;2\u0026#39;: login, \u0026#39;3\u0026#39;: check_balance, \u0026#39;4\u0026#39;: withdraw, \u0026#39;5\u0026#39;: repay, \u0026#39;6\u0026#39;: transfer, \u0026#39;7\u0026#39;: check_flow, \u0026#39;8\u0026#39;: shopping, \u0026#39;9\u0026#39;: check_shop_car, \u0026#39;10\u0026#39;: admin_spuer, } def run(): while True: print(\u0026#39;\u0026#39;\u0026#39; ==========ATM+è´­ç‰©è½¦========== 1ã€æ³¨å†ŒåŠŸèƒ½ 2ã€ç™»å½•åŠŸèƒ½ 3ã€æŸ¥çœ‹ä½™é¢ 4ã€æç°åŠŸèƒ½ 5ã€è¿˜æ¬¾åŠŸèƒ½ 6ã€è½¬è´¦åŠŸèƒ½ 7ã€æŸ¥çœ‹æµæ°´ 8ã€è´­ç‰©åŠŸèƒ½ 9ã€æŸ¥çœ‹è´­ç‰©è½¦ 10ã€ç®¡ç†å‘˜åŠŸèƒ½ ========== end ========== \u0026#39;\u0026#39;\u0026#39;) choice = input(\u0026#34;è¯·è¾“å…¥åŠŸèƒ½ç¼–å·ï¼š\u0026#34;).strip() if choice not in func_dic: print(\u0026#34;è¯·è¾“å…¥æ­£ç¡®çš„åŠŸèƒ½ç¼–å·\u0026#34;) continue func_dic.get(choice)() db user_date (ç”¨æˆ·å­˜æ”¾jsonçš„ç›®å½•) q.json ï¼ˆç”¨æˆ·æ•°æ®çš„å­˜æ”¾æ–‡ä»¶ï¼Œå­—å…¸å½¢å¼ï¼‰ 1 {\u0026#34;username\u0026#34;: \u0026#34;q\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;099b3b060154898840f0ebdfb46ec78f\u0026#34;, \u0026#34;balance\u0026#34;: 14375.0, \u0026#34;flow\u0026#34;: [\u0026#34;ç”¨æˆ·[q] æç°é‡‘é¢ [500],æ‰‹ç»­è´¹ä¸ºï¼š[25.0]\u0026#34;, \u0026#34;ç”¨æˆ·ï¼š[q]ç»™ç”¨æˆ·[w] è½¬è´¦ï¼š[100] å…ƒ æˆåŠŸ\u0026#34;], \u0026#34;shop_car\u0026#34;: {}, \u0026#34;locked\u0026#34;: false} jsonæ ¼å¼\n1 2 3 4 5 6 7 8 { \u0026#34;username\u0026#34;: \u0026#34;q\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;099b3b060154898840f0ebdfb46ec78f\u0026#34;, \u0026#34;balance\u0026#34;: 14375.0, \u0026#34;flow\u0026#34;: [\u0026#34;ç”¨æˆ·[q] æç°é‡‘é¢ [500],æ‰‹ç»­è´¹ä¸ºï¼š[25.0]\u0026#34;, \u0026#34;ç”¨æˆ·ï¼š[q]ç»™ç”¨æˆ·[w] è½¬è´¦ï¼š[100] å…ƒ æˆåŠŸ\u0026#34;], \u0026#34;shop_car\u0026#34;: {}, \u0026#34;locked\u0026#34;: false } db_hander.pyï¼ˆå¯¹æ•°æ®å¤„ç†ï¼Œç›¸å½“äºmysqlæ¥å£å¤„ç†ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 \u0026#39;\u0026#39;\u0026#39; æ•°æ®å¤„ç†å±‚ ä¸“é—¨ç”¨æˆ·å¤„ç†æ•°æ®çš„ \u0026#39;\u0026#39;\u0026#39; import json import os from conf import setting # åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»æ³¨å†Œ def user_select(username): # 1) æ¥æ”¶æ¥å£å±‚ä¼ è¿‡æ¥çš„usernameç”¨æˆ·åï¼Œæ‹¼æ¥ç”¨æˆ·jsonæ–‡ä»¶è·¯å¾„ user_path = os.path.join( setting.USER_DATE, f\u0026#39;{username}.json\u0026#39; ) # 2ï¼‰æ ¡éªŒç”¨æˆ·jsonæ–‡ä»¶æ˜¯å¦å­˜åœ¨ if os.path.exists(user_path): # 3) æ‰“å¼€æ•°æ®ï¼Œå¹¶è¿”å›ç»™æ¥å£å±‚ with open(user_path, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: user_dic = json.load(f) return user_dic # 3) ä¸returnï¼Œé»˜è®¤return None # ä¿å­˜æ•°æ®å¤„ç† def user_save(user_dic): user_path = os.path.join(setting.USER_DATE, f\u0026#34;{user_dic[\u0026#39;username\u0026#39;]}.json\u0026#34;) with open(user_path, \u0026#39;w\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: json.dump(user_dic, f, ensure_ascii=False) interface admin_interface.pyï¼ˆadminçš„ä¸šåŠ¡æ¥å£å¤„ç†ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 from db import db_hander from lib import common user_logger=common.get_log(\u0026#39;admin\u0026#39;) # ä¿®æ”¹é¢åº¦æ¥å£ def change_balance_interafce(change_user, change_money): user_dic = db_hander.user_select(change_user) if user_dic: user_dic[\u0026#39;balance\u0026#39;] = int(change_money) db_hander.user_save(user_dic) msg=f\u0026#39;[{change_user}]çš„é¢åº¦ä¿®æ”¹{change_money}æˆåŠŸ\u0026#39; user_logger.info(msg) return True, msg return False, \u0026#39;ä¿®æ”¹é¢åº¦ç”¨æˆ·ä¸å­˜åœ¨\u0026#39; def disable_user_interface(dis_user): user_dic = db_hander.user_select(dis_user) if user_dic: user_dic[\u0026#39;locked\u0026#39;] = True db_hander.user_save(user_dic) msg = f\u0026#39;[{dis_user}]çš„å†»ç»“æˆåŠŸ\u0026#39; user_logger.info(msg) return True, msg else: return False, \u0026#39;å†»ç»“ç”¨æˆ·ä¸å­˜åœ¨\u0026#39; # è§£å†»ç”¨æˆ·çš„æ¥å£ def enable_user_interface(dis_user): user_dic = db_hander.user_select(dis_user) if user_dic: if user_dic[\u0026#39;locked\u0026#39;]: user_dic[\u0026#39;locked\u0026#39;] = False db_hander.user_save(user_dic) msg = f\u0026#39;[{dis_user}]çš„å†»ç»“æˆåŠŸ\u0026#39; user_logger.info(msg) return True, msg return False,f\u0026#39;ç”¨æˆ·ï¼š{dis_user}å¤„äºæ­£å¸¸çŠ¶æ€\u0026#39; else: return False, \u0026#39;å†»ç»“ç”¨æˆ·ä¸å­˜åœ¨\u0026#39; bank_interface.pyï¼ˆé“¶è¡Œä¸šåŠ¡å¤„ç†æ¥å£ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 \u0026#39;\u0026#39;\u0026#39; é“¶è¡Œç›¸å…³çš„ä¸šåŠ¡ \u0026#39;\u0026#39;\u0026#39; from db import db_hander from lib import common user_logger=common.get_log(\u0026#39;bank\u0026#39;) # ç”¨æˆ·çš„æç°é‡‘é¢æ¥å£ def withdraw_interface(login_user, input_money): # å…ˆè·å–ç”¨æˆ·å­—å…¸ user_dic = db_hander.user_select(login_user) # è·å–é“¶è¡Œçš„é‡‘é¢ balance = int(user_dic.get(\u0026#39;balance\u0026#39;)) # æœ¬é‡‘+ æ‰‹ç»­è´¹ money = int(input_money) * 1.05 repair = round(money - input_money, 2) # åˆ¤æ–­ç”¨æˆ·é‡‘é¢æ˜¯å¦è¶³å¤Ÿ if balance \u0026gt;= money: # ä¿®æ”¹ç”¨æˆ·å­—å…¸çš„é‡‘é¢ balance -= money user_dic[\u0026#39;balance\u0026#39;] = balance flow = f\u0026#39;ç”¨æˆ·[{login_user}] æç°é‡‘é¢ [{input_money}],æ‰‹ç»­è´¹ä¸ºï¼š[{repair}]\u0026#39; user_dic[\u0026#39;flow\u0026#39;].append(flow) # åœ¨ä¿å­˜æ•°æ® db_hander.user_save(user_dic) msg=f\u0026#39;ç”¨æˆ·[{login_user}] æç°é‡‘é¢ [{input_money}],æ‰‹ç»­è´¹ä¸ºï¼š[{repair}]\u0026#39; user_logger.info(msg) return True, msg return False, \u0026#39;æç°é‡‘é¢ä¸è¶³ï¼Œè¯·é‡æ–°è¾“å…¥\u0026#39; # è¿˜æ¬¾æ¥å£ def repay_interface(login_user, repay_money): # å…ˆè·å–ç”¨æˆ·å­—å…¸ user_dic = db_hander.user_select(login_user) # è·å–é“¶è¡Œçš„é‡‘é¢ balance = int(user_dic.get(\u0026#39;balance\u0026#39;)) # æœ¬é‡‘+ æ‰‹ç»­è´¹ money = int(repay_money) # repair = round(money - repay_money, 2) # ä¿®æ”¹ç”¨æˆ·å­—å…¸çš„é‡‘é¢ balance += money user_dic[\u0026#39;balance\u0026#39;] = balance # åœ¨ä¿å­˜æ•°æ® flow = f\u0026#39;ç”¨æˆ·ï¼š[{login_user}] è¿˜æ¬¾é‡‘é¢ ï¼š[{repay_money}]æˆåŠŸ]\u0026#39; user_dic[\u0026#39;flow\u0026#39;].append(flow) db_hander.user_save(user_dic) msg = f\u0026#39;ç”¨æˆ·ï¼š[{login_user}] è¿˜æ¬¾é‡‘é¢ ï¼š[{repay_money}]æˆåŠŸ]\u0026#39; user_logger.info(msg) return True, msg # è½¬è´¦æ¥å£ def transfer_interface(login_user, user_money, money): # å…ˆè·å–ç”¨æˆ·å­—å…¸ login_user_dic = db_hander.user_select(login_user) user_money_dic = db_hander.user_select(user_money) # åˆ¤æ–­ç›®æ ‡ç”¨æˆ·æ˜¯å¦å­˜åœ¨ if not user_money_dic: return False, \u0026#39;ç›®æ ‡ç”¨æˆ·ä¸å­˜åœ¨\u0026#39; if login_user == user_money: return False, \u0026#39;ä¸èƒ½ç»™è‡ªå·±è½¬è´¦\u0026#39; if login_user_dic[\u0026#39;balance\u0026#39;] \u0026gt;= money: login_user_dic[\u0026#39;balance\u0026#39;] -= money user_money_dic[\u0026#39;balance\u0026#39;] += money flow1 = f\u0026#39;ç”¨æˆ·ï¼š[{login_user}]ç»™ç”¨æˆ·[{user_money}] è½¬è´¦ï¼š[{money}] å…ƒ æˆåŠŸ\u0026#39; login_user_dic[\u0026#39;flow\u0026#39;].append(flow1) flow2 = f\u0026#39;ç”¨æˆ·ï¼š[{user_money}]æ¥å—ç”¨æˆ·[{login_user}] è½¬è´¦ï¼š[{money}] å…ƒ æˆåŠŸ\u0026#39; user_money_dic[\u0026#39;flow\u0026#39;].append(flow2) db_hander.user_save(login_user_dic) db_hander.user_save(user_money_dic) msg = f\u0026#39;ç”¨æˆ·ï¼š[{login_user}]ç»™ç”¨æˆ·[{user_money}] è½¬è´¦ï¼š[{money}] å…ƒ æˆåŠŸ\u0026#39; user_logger.info(msg) return True, msg msg = f\u0026#39;ç”¨æˆ·ï¼š[{login_user}]é“¶è¡Œä½™é¢ä¸è¶³\u0026#39; user_logger.info(msg) return False, msg # æµæ°´æ¥å£åˆ—è¡¨æŸ¥è¯¢ def check_flow_interface(login_user): # å…ˆè·å–ç”¨æˆ·å­—å…¸ login_user_dic = db_hander.user_select(login_user) flow_list = login_user_dic[\u0026#39;flow\u0026#39;] return flow_list # æ”¯ä»˜æ¥å£ def pay_interface(login_user, cost): user_dic = db_hander.user_select(login_user) if user_dic.get(\u0026#39;balance\u0026#39;) \u0026gt;= cost: user_dic[\u0026#39;balance\u0026#39;] -= cost flow = f\u0026#39;ç”¨æˆ·ï¼š{login_user}æ¶ˆè´¹é‡‘é¢ï¼š{cost}\u0026#39; user_dic[\u0026#39;flow\u0026#39;].append(flow) db_hander.user_save(user_dic) user_logger.info(flow) return True return False shop_interface.pyï¼ˆè´­ç‰©ä¸šåŠ¡æ¥å£å¤„ç†ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 \u0026#39;\u0026#39;\u0026#39; è´­ç‰©å•†åŸæ¥å£ \u0026#39;\u0026#39;\u0026#39; from interface import bank_interface from db import db_hander from lib import common shop_logger = common.get_log(log_type=\u0026#39;shop\u0026#39;) # å•†å“å‡†å¤‡ç»“ç®—æ¥å£ def shopping_interface(login_user, shopping_car): # è®¡ç®—å•†å“æ€»ä»· cost = 0 for shop_price in shopping_car.values(): price, number = shop_price cost += (price * number) # é€»è¾‘æ ¡éªŒæˆåŠŸï¼Œè°ƒç”¨é“¶è¡Œçš„æ”¯ä»˜æ¥å£ flag = bank_interface.pay_interface(login_user, cost) if flag: msg = f\u0026#39;ç”¨æˆ·:[{login_user}]æ”¯ä»˜ [{cost}$] æˆåŠŸ, å‡†å¤‡å‘è´§!\u0026#39; shop_logger.info(msg) return True, msg return False, \u0026#39;æ”¯ä»˜å¤±è´¥ï¼Œé‡‘é¢ä¸è¶³\u0026#39; # å•†å“æ·»åŠ è´­ç‰©è½¦åŠŸèƒ½ def add_shop_car_interface(login_user, shopping_car): # è·å–å½“å‰ç”¨æˆ·çš„è´­ç‰©è½¦ user_dic = db_hander.user_select(login_user) #åŸæ¥ç”¨æˆ·çš„å­—å…¸çš„å•†åŸåˆ—è¡¨ shop_car = user_dic.get(\u0026#39;shop_car\u0026#39;) for shop_name, price_number in shopping_car.items(): number = price_number[1] if shop_name in shop_car: user_dic[\u0026#39;shop_car\u0026#39;][shop_name][1] += number else: user_dic[\u0026#39;shop_car\u0026#39;].update( {shop_name: price_number} ) db_hander.user_save(user_dic) return True, \u0026#39;æ·»åŠ è´­ç‰©è½¦æˆåŠŸ\u0026#39; # æŸ¥çœ‹è´­ç‰©è½¦æ¥å£ def check_shop_car_interface(login_user): # è·å–å½“å‰ç”¨æˆ·çš„è´­ç‰©è½¦ user_dic = db_hander.user_select(login_user) shop_list = user_dic[\u0026#39;shop_car\u0026#39;] return shop_list user_interface.pyï¼ˆç”¨æˆ·ä¸šåŠ¡æ¥å£å¤„ç†ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 \u0026#39;\u0026#39;\u0026#39; ç”¨æˆ·ç›¸å…³çš„æ¥å£ \u0026#39;\u0026#39;\u0026#39; import os import json from db import db_hander from lib import common user_logger=common.get_log(\u0026#39;user\u0026#39;) # ç”¨æˆ·æ³¨å†Œ def register_interface(username, password, balance=15000): # 2ï¼‰æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦å­˜åœ¨ # 2.1) è°ƒç”¨ æ•°æ®å¤„ç†å±‚ ä¸­çš„ selectå‡½æ•°ï¼Œä¼šè¿”å› ç”¨æˆ·å­—å…¸ æˆ– None user_dic = db_hander.user_select(username) # {user: user, pwd: pwd...} or None # è‹¥ç”¨æˆ·å­˜åœ¨ï¼Œåˆ™returnï¼Œå‘Šè¯‰ç”¨æˆ·é‡æ–°è¾“å…¥ if user_dic: # return (False, \u0026#39;ç”¨æˆ·åå·²å­˜åœ¨!\u0026#39;) return False, \u0026#39;ç”¨æˆ·åå·²å­˜åœ¨!\u0026#39; # 3ï¼‰è‹¥ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ™ä¿å­˜ç”¨æˆ·æ•°æ® # åšå¯†ç åŠ å¯† password = common.salt(username, password) # 3.1) ç»„ç»‡ç”¨æˆ·çš„æ•°æ®çš„å­—å…¸ä¿¡æ¯ user_dic = { \u0026#39;username\u0026#39;: username, \u0026#39;password\u0026#39;: password, \u0026#39;balance\u0026#39;: balance, # ç”¨äºè®°å½•ç”¨æˆ·æµæ°´çš„åˆ—è¡¨ \u0026#39;flow\u0026#39;: [], # ç”¨äºè®°å½•ç”¨æˆ·è´­ç‰©è½¦ \u0026#39;shop_car\u0026#39;: {}, # lockedï¼šç”¨äºè®°å½•ç”¨æˆ·æ˜¯å¦è¢«å†»ç»“ # False: æœªå†»ç»“ True: å·²è¢«å†»ç»“ \u0026#39;locked\u0026#39;: False } # 3.2ï¼‰ä¿å­˜æ•°æ® db_hander.user_save(user_dic) msg=f\u0026#39;{username} æ³¨å†ŒæˆåŠŸ!\u0026#39; user_logger.info(msg) return True, msg # ç™»å½•æ¥å£ def longin_interface(username, password): # å…ˆæŸ¥çœ‹ç”¨æˆ·æ˜¯å¦å­˜åœ¨ user_dic = db_hander.user_select(username) password_md5 = common.salt(username, password) if user_dic: print(user_dic.get(\u0026#39;locked\u0026#39;)) if user_dic.get(\u0026#39;locked\u0026#39;): return False, f\u0026#39;ç”¨æˆ·ï¼š[{username}]å·²ç»è¢«å†»ç»“\u0026#39; if password_md5 == user_dic[\u0026#39;password\u0026#39;]: msg=f\u0026#39;ç”¨æˆ·ï¼š[{username}] ç™»å½•æˆåŠŸ \u0026#39; user_logger.info(msg) return True,msg else: msg = f\u0026#39;ç”¨æˆ·ï¼š[{username}]å¯†ç é”™è¯¯\u0026#39; user_logger.warning(msg) return False, msg msg = f\u0026#39;ç”¨æˆ·[{username}]ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥\u0026#39; user_logger.info(msg) return False, msg # æŸ¥çœ‹ç”¨æˆ·ä½™é¢æ¥å£ def check_balance_interface(login_user): user_dic = db_hander.user_select(login_user) return user_dic.get(\u0026#39;balance\u0026#39;) lib common.pyï¼ˆå…¬ç”¨ç±»ï¼Œç›MD5åŠ å¯†ï¼Œç™»å½•è£…é¥°å™¨ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 import hashlib from core import src from conf import setting import logging.config # ç›åŠ å¯†ï¼Œé€šåå­—åŠ å¯† å¯†ç  def salt(username, password): password_ms5= hashlib.md5() password_ms5.update((username+password).encode(\u0026#39;utf-8\u0026#39;)) res = password_ms5.hexdigest() return res # ç™»å½•è®¤è¯è£…é¥°å™¨ def login_auth(func): def inner(*args, **kwargs): if src.login_user: res = func(*args, **kwargs) return res else: print(\u0026#39;æœªå‡ºç¤ºè¯æ˜ï¼Œæ— æ³•äº«å—æœåŠ¡\u0026#39;) src.login() return inner # æ·»åŠ æ—¥å¿—åŠŸèƒ½(æ—¥å¿—åŠŸèƒ½åœ¨æ¥å£å±‚ä½¿ç”¨) def get_log(log_type): \u0026#39;\u0026#39;\u0026#39; :param log_type: useræ—¥å¿— bankæ—¥å¿— è´­ç‰©å•†åŸæ—¥å¿— :return: \u0026#39;\u0026#39;\u0026#39; # 1ã€åŠ è½½æ—¥å¿—é…ç½®ä¿¡æ¯ logging.config.dictConfig( setting.LOGGING_DIC ) # è·å–æ—¥å¿—å¯¹è±¡ logger = logging.getLogger(log_type) return logger logï¼ˆæ—¥å¿—æ–‡ä»¶è®°å½•ï¼‰ a1.log 1 2 3 2020-11-29 23:03:52,782 - MainThread:13396 - æ—¥å¿—åå­—:user - user_interface.py:58 -INFO - ç”¨æˆ·ï¼š[q]ç™»å½•æˆåŠŸï¼ 2020-11-29 23:04:11,089 - MainThread:13396 - æ—¥å¿—åå­—:user - user_interface.py:58 -INFO - ç”¨æˆ·ï¼š[w]ç™»å½•æˆåŠŸï¼ 2020-11-29 23:04:15,584 - MainThread:13396 - æ—¥å¿—åå­—:user - user_interface.py:69 -INFO - ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥ æ•´ä½“é¡¹ç›®æ¶æ„ä¸é”™ï¼Œå¯ä»¥å¾ˆæ¸…æ¥šäº†è§£åˆ°ä¸‰å±‚æ¶æ„çš„æ„å»º\nç”¨æˆ·ç‚¹å‡»ï¼šç”¨æˆ·è§†å›¾å±‚â€”â€”â€”â€”â€”â€”â€”â€”ã€‹ä¸šåŠ¡æ¥å£å¤„ç†â€”â€”â€”â€”â€”â€”â€”â€”ã€‹æ•°æ®åº“æ•°æ®å¤„ç†\næ•°æ®è¿”å›ç”¨æˆ·ï¼šæ•°æ®å¤„ç†å®Œæ•°æ®â€”â€”â€”â€”â€”â€”â€”â€”ã€‹ä¸šåŠ¡æ¥å£å¤„ç†â€”â€”â€”â€”â€”â€”â€”â€”ã€‹ç”¨æˆ·è§†å›¾å±‚\n","date":"2020-11-30T21:07:54Z","image":"https://www.ownit.top/title_pic/76.jpg","permalink":"https://www.ownit.top/p/202011302107/","title":"Pythonæ„å»ºç®€å•çš„ATM+è´­ç‰©åŠŸèƒ½é¡¹ç›®"},{"content":"1ã€ åŸºæœ¬ç¯å¢ƒé…ç½® 1ã€Kubectl debug è®¾ç½®ä¸€ä¸ªä¸´æ—¶å®¹å™¨\n2ã€Sidecar\n3ã€Volumeï¼šæ›´æ”¹ç›®å½•æƒé™ï¼ŒfsGroup\n4ã€ConfigMapå’ŒSecret\nK8Så®˜ç½‘ï¼šhttps://kubernetes.io/docs/setup/\næœ€æ–°ç‰ˆé«˜å¯ç”¨å®‰è£…ï¼šhttps://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/\nä¸»æœºå\nIPåœ°å€\nè¯´æ˜\nk8s-master01 ~ 03\n192.168.0.106 ~ 20\nmasterèŠ‚ç‚¹ * 3\nk8s-master-lb\n192.168.0.200\nkeepalivedè™šæ‹ŸIP\nk8s-node01 ~ 02\n192.168.0.108 ~ 22\nworkerèŠ‚ç‚¹ * 2\nVIPï¼ˆè™šæ‹ŸIPï¼‰ä¸è¦å’Œå…¬å¸å†…ç½‘IPé‡å¤ï¼Œé¦–å…ˆå»pingä¸€ä¸‹ï¼Œä¸é€šæ‰å¯ç”¨ã€‚VIPéœ€è¦å’Œä¸»æœºåœ¨åŒä¸€ä¸ªå±€åŸŸç½‘å†…ï¼\næ‰€æœ‰èŠ‚ç‚¹é…ç½®hostsï¼Œä¿®æ”¹/etc/hostså¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 [root@k8s-master01 ~]# cat /etc/hosts 192.168.0.100 k8s-master01 192.168.0.106 k8s-master02 192.168.0.107 k8s-master03 192.168.0.200 k8s-master-lb 192.168.0.108 k8s-node01 192.168.0.109 k8s-node02 æ‰€æœ‰èŠ‚ç‚¹å…³é—­é˜²ç«å¢™ã€selinuxã€dnsmasqã€swapã€‚æœåŠ¡å™¨é…ç½®å¦‚ä¸‹\n1 2 3 4 5 systemctl disable --now firewalld systemctl disable --now dnsmasq #systemctl disable --now NetworkManager #CentOS8æ— éœ€å…³é—­ setenforce 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [root@k8s-master01 ~]# cat !$ cat /etc/sysconfig/selinux SELINUX=disabled swapoff -a \u0026amp;\u0026amp; sysctl -w vm.swappiness=0 [root@k8s-master01 ~]# vi /etc/fstab [root@k8s-master01 ~]# cat /etc/fstab # # /etc/fstab # Created by anaconda on Fri Nov 1 23:02:53 2019 # # Accessible filesystems, by reference, are maintained under \u0026#39;/dev/disk/\u0026#39;. # See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info. # # After editing this file, run \u0026#39;systemctl daemon-reload\u0026#39; to update systemd # units generated from this file. # /dev/mapper/cl-root / xfs defaults 0 0 UUID=6897cd7b-9b3a-42b0-a827-57991141b297 /boot ext4 defaults 1 2 #/dev/mapper/cl-swap swap swap defaults 0 0 å®‰è£…ntpdateï¼ˆCentOS 7 æ— éœ€å®‰è£…ï¼Œè‡ªå¸¦ntpdateå‘½ä»¤ï¼‰\næ‰€æœ‰èŠ‚ç‚¹åŒæ­¥æ—¶é—´ã€‚æ—¶é—´åŒæ­¥é…ç½®å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime echo \u0026#39;Asia/Shanghai\u0026#39; \u0026gt;/etc/timezone ntpdate time2.aliyun.com # åŠ å…¥åˆ°crontab */5 * * * * ntpdate time2.aliyun.com # åŠ å…¥åˆ°å¼€æœºè‡ªåŠ¨åŒæ­¥ï¼Œ/etc/rc.local ntpdate time2.aliyun.com æ‰€æœ‰èŠ‚ç‚¹é…ç½®limitï¼š\n1 ulimit -SHn 65535 Master01èŠ‚ç‚¹å…å¯†é’¥ç™»å½•å…¶ä»–èŠ‚ç‚¹ï¼Œå®‰è£…è¿‡ç¨‹ä¸­ç”Ÿæˆé…ç½®æ–‡ä»¶å’Œè¯ä¹¦å‡åœ¨Master01ä¸Šæ“ä½œï¼Œé›†ç¾¤ç®¡ç†ä¹Ÿåœ¨Master01ä¸Šæ“ä½œï¼Œé˜¿é‡Œäº‘æˆ–è€…AWSä¸Šéœ€è¦å•ç‹¬ä¸€å°kubectlæœåŠ¡å™¨ã€‚å¯†é’¥é…ç½®å¦‚ä¸‹ï¼š\n1 2 3 ssh-keygen -t rsa for i in k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02;do ssh-copy-id -i .ssh/id_rsa.pub $i;done åœ¨æºç ä¸­çš„repoç›®å½•é…ç½®ä½¿ç”¨çš„æ˜¯å›½å†…ä»“åº“æºï¼Œå°†å…¶å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼š\n1 2 git clone https://github.com/dotbalo/k8s-ha-install.git 2ã€CentOS 7å®‰è£…yumæºå¦‚ä¸‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo yum install -y yum-utils device-mapper-persistent-data lvm2 yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/ enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF sed -i -e \u0026#39;/mirrors.cloud.aliyuncs.com/d\u0026#39; -e \u0026#39;/mirrors.aliyuncs.com/d\u0026#39; /etc/yum.repos.d/CentOS-Base.repo æ‰€æœ‰èŠ‚ç‚¹å‡çº§ç³»ç»Ÿå¹¶é‡å¯ï¼Œæ­¤å¤„å‡çº§æ²¡æœ‰å‡çº§å†…æ ¸ï¼Œä¸‹èŠ‚ä¼šå•ç‹¬å‡çº§å†…æ ¸ï¼š\n1 2 3 yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 -y yum update -y --exclude=kernel* \u0026amp;\u0026amp; reboot #CentOS7éœ€è¦å‡çº§ï¼Œ8ä¸éœ€è¦ 3ã€å†…æ ¸é…ç½®\nï¼ˆå¦‚æœå†…æ ¸è¾¾åˆ°ï¼Œå¯ä»¥ä¸ç”¨è·³è¿‡æ­¤æ­¥éª¤ï¼‰\nCentOS7 éœ€è¦å‡çº§å†…æ ¸è‡³4.18+\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å®‰è£…æœ€æ–°ç‰ˆå†…æ ¸ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm æŸ¥çœ‹æœ€æ–°ç‰ˆå†…æ ¸yum --disablerepo=\u0026#34;*\u0026#34; --enablerepo=\u0026#34;elrepo-kernel\u0026#34; list available [root@k8s-node01 ~]# yum --disablerepo=\u0026#34;*\u0026#34; --enablerepo=\u0026#34;elrepo-kernel\u0026#34; list available å®‰è£…æœ€æ–°ç‰ˆï¼š yum --enablerepo=elrepo-kernel install kernel-ml kernel-ml-devel â€“y å®‰è£…å®Œæˆåreboot æ›´æ”¹å†…æ ¸é¡ºåºï¼š grub2-set-default 0 \u0026amp;\u0026amp; grub2-mkconfig -o /etc/grub2.cfg \u0026amp;\u0026amp; grubby --args=\u0026#34;user_namespace.enable=1\u0026#34; --update-kernel=\u0026#34;$(grubby --default-kernel)\u0026#34; \u0026amp;\u0026amp; reboot å¼€æœºåæŸ¥çœ‹å†…æ ¸ [appadmin@k8s-node01 ~]$ uname -a Linux k8s-node01 5.7.7-1.el7.elrepo.x86_64 #1 SMP Wed Jul 1 11:53:16 EDT 2020 x86_64 x86_64 x86_64 GNU/Linux æœ¬æ‰€æœ‰èŠ‚ç‚¹å®‰è£…ipvsadmï¼š\n1 yum install ipvsadm ipset sysstat conntrack libseccomp -y æ‰€æœ‰èŠ‚ç‚¹é…ç½®ipvsæ¨¡å—ï¼Œåœ¨å†…æ ¸4.19+ç‰ˆæœ¬nf_conntrack_ipv4å·²ç»æ”¹ä¸ºnf_conntrackï¼Œæœ¬ä¾‹å®‰è£…çš„å†…æ ¸ä¸º4.18ï¼Œä½¿ç”¨nf_conntrack_ipv4å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack_ipv4 cat /etc/modules-load.d/ipvs.conf ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh nf_conntrack_ipv4 ip_tables ip_set xt_set ipt_set ipt_rpfilter ipt_REJECT ipip ç„¶åæ‰§è¡Œsystemctl enable --now systemd-modules-load.serviceå³å¯ æ£€æŸ¥æ˜¯å¦åŠ è½½ï¼š\n1 2 3 4 5 [root@k8s-master01 ~]# lsmod | grep -e ip_vs -e nf_conntrack_ipv4 nf_conntrack_ipv4 16384 23 nf_defrag_ipv4 16384 1 nf_conntrack_ipv4 nf_conntrack 135168 10 xt_conntrack,nf_conntrack_ipv6,nf_conntrack_ipv4,nf_nat,nf_nat_ipv6,ipt_MASQUERADE,nf_nat_ipv4,xt_nat,nf_conntrack_netlink,ip_vs å¼€å¯ä¸€äº›k8sé›†ç¾¤ä¸­å¿…é¡»çš„å†…æ ¸å‚æ•°ï¼Œæ‰€æœ‰èŠ‚ç‚¹é…ç½®k8så†…æ ¸ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/sysctl.d/k8s.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-iptables = 1 fs.may_detach_mounts = 1 vm.overcommit_memory=1 vm.panic_on_oom=0 fs.inotify.max_user_watches=89100 fs.file-max=52706963 fs.nr_open=52706963 net.netfilter.nf_conntrack_max=2310720 net.ipv4.tcp_keepalive_time = 600 net.ipv4.tcp_keepalive_probes = 3 net.ipv4.tcp_keepalive_intvl =15 net.ipv4.tcp_max_tw_buckets = 36000 net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_max_orphans = 327680 net.ipv4.tcp_orphan_retries = 3 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.ip_conntrack_max = 65536 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.tcp_timestamps = 0 net.core.somaxconn = 16384 EOF sysctl --system æ‰€æœ‰èŠ‚ç‚¹é…ç½®å®Œå†…æ ¸åï¼Œé‡å¯æœåŠ¡å™¨ï¼Œä¿è¯é‡å¯åå†…æ ¸ä¾æ—§åŠ è½½\n1 2 reboot lsmod | grep --color=auto -e ip_vs -e nf_conntrack 4ã€åŸºæœ¬ç»„ä»¶å®‰è£… æœ¬èŠ‚ä¸»è¦å®‰è£…çš„æ˜¯é›†ç¾¤ä¸­ç”¨åˆ°çš„å„ç§ç»„ä»¶ï¼Œæ¯”å¦‚Docker-ceã€Kuberneteså„ç»„ä»¶ç­‰ã€‚\n4.1å®‰è£…Dockerç»„ä»¶ æŸ¥çœ‹å¯ç”¨docker-ceç‰ˆæœ¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 yum list docker-ce.x86_64 --showduplicates | sort -r [root@k8s-master01 k8s-ha-install]# wget https://download.docker.com/linux/centos/7/x86_64/edge/Packages/containerd.io-1.2.13-3.2.el7.x86_64.rpm [root@k8s-master01 k8s-ha-install]# yum install containerd.io-1.2.13-3.2.el7.x86_64.rpm -y å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„Dockerï¼š yum -y install docker-ce-17.09.1.ce-1.el7.centos å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„Docker yum install docker-ce â€“y [root@k8s-master01 ~]# docker -v Docker version 19.03.13, build 4484c46d9d æ¸©é¦¨æç¤ºï¼š\nç”±äºæ–°ç‰ˆkubeletå»ºè®®ä½¿ç”¨systemdï¼Œæ‰€ä»¥å¯ä»¥æŠŠdockerçš„CgroupDriveræ”¹æˆsystemd\n1 2 3 4 5 6 cat \u0026gt; /etc/docker/daemon.json \u0026lt;\u0026lt;EOF { \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;] } EOF 4.2å®‰è£…k8sç»„ä»¶ï¼š 1 2 3 4 5 6 7 yum list kubeadm.x86_64 --showduplicates | sort -r æ‰€æœ‰èŠ‚ç‚¹å®‰è£…æœ€æ–°ç‰ˆæœ¬kubeadmï¼š yum install kubeadm -y æ‰€æœ‰èŠ‚ç‚¹å®‰è£…æŒ‡å®šç‰ˆæœ¬k8sç»„ä»¶ï¼š yum install -y kubeadm-1.18.5-0.x86_64 kubelet-1.18.5-0.x86_64 kubectl-1.18.5-0.x86_64 4.3å¯åŠ¨Dockerå’ŒKubernetes æ‰€æœ‰èŠ‚ç‚¹è®¾ç½®å¼€æœºè‡ªå¯åŠ¨Dockerï¼š\n1 2 systemctl daemon-reload \u0026amp;\u0026amp; systemctl enable --now docker é»˜è®¤é…ç½®çš„pauseé•œåƒä½¿ç”¨gcr.ioä»“åº“ï¼Œå›½å†…å¯èƒ½æ— æ³•è®¿é—®ï¼Œæ‰€ä»¥è¿™é‡Œé…ç½®Kubeletä½¿ç”¨é˜¿é‡Œäº‘çš„pauseé•œåƒï¼š\n1 2 3 4 cat \u0026gt;/etc/sysconfig/kubelet\u0026lt;\u0026lt;EOF KUBELET_EXTRA_ARGS=\u0026#34;--cgroup-driver=$DOCKER_CGROUPS --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1\u0026#34; EOF è®¾ç½®Kubeletå¼€æœºè‡ªå¯åŠ¨ï¼š\n1 2 systemctl daemon-reload systemctl enable --now kubelet 5ã€é«˜å¯ç”¨ç»„ä»¶å®‰è£… 5.1æ‰€æœ‰MasterèŠ‚ç‚¹é€šè¿‡yumå®‰è£…HAProxyå’ŒKeepAlived 1 yum install keepalived haproxy -y æ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®HAProxyï¼ˆè¯¦ç»†é…ç½®å‚è€ƒHAProxyæ–‡æ¡£ï¼Œæ‰€æœ‰MasterèŠ‚ç‚¹çš„HAProxyé…ç½®ç›¸åŒï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 [root@k8s-master01 etc]# mkdir /etc/haproxy [root@k8s-master01 etc]# vim /etc/haproxy/haproxy.cfg global maxconn 2000 ulimit-n 16384 log 127.0.0.1 local0 err stats timeout 30s defaults log global mode http option httplog timeout connect 5000 timeout client 50000 timeout server 50000 timeout http-request 15s timeout http-keep-alive 15s frontend monitor-in bind *:33305 mode http option httplog monitor-uri /monitor frontend k8s-master bind 0.0.0.0:16443 bind 127.0.0.1:16443 mode tcp option tcplog tcp-request inspect-delay 5s default_backend k8s-master backend k8s-master mode tcp option tcplog option tcp-check balance roundrobin default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100 server k8s-master01\t192.168.0.100:6443 check server k8s-master02\t192.168.0.106:6443 check server k8s-master03\t192.168.0.107:6443 check 5.2Master01èŠ‚ç‚¹çš„é…ç½®ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 [root@k8s-master01 etc]# mkdir /etc/keepalived [root@k8s-master01 ~]# vim /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL } vrrp_script chk_apiserver { script \u0026#34;/etc/keepalived/check_apiserver.sh\u0026#34; interval 2 weight -5 fall 3 rise 2 } vrrp_instance VI_1 { state MASTER interface ens33 mcast_src_ip 192.168.0.100 virtual_router_id 51 priority 100 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.0.200 } # track_script { # chk_apiserver # } } 5.3Master02èŠ‚ç‚¹çš„é…ç½®ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 [root@k8s-master02 etc]# mkdir /etc/keepalived [root@k8s-master02 ~]# vim /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL } vrrp_script chk_apiserver { script \u0026#34;/etc/keepalived/check_apiserver.sh\u0026#34; interval 2 weight -5 fall 3 rise 2 } vrrp_instance VI_1 { state BACKUP interface ens33 mcast_src_ip 192.168.0.106 virtual_router_id 51 priority 101 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.0.200 } # track_script { # chk_apiserver # } } 5.4Master03èŠ‚ç‚¹çš„é…ç½®ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 [root@k8s-master03 etc]# mkdir /etc/keepalived [root@k8s-master03 ~]# vim /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL } vrrp_script chk_apiserver { script \u0026#34;/etc/keepalived/check_apiserver.sh\u0026#34; interval 2 weight -5 fall 3 rise 2 } vrrp_instance VI_1 { state BACKUP interface ens33 mcast_src_ip 192.168.0.1067 virtual_router_id 51 priority 101 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.0.200 } # track_script { # chk_apiserver # } } 5.5æ³¨æ„ä¸Šè¿°çš„å¥åº·æ£€æŸ¥æ˜¯å…³é—­çš„ï¼Œé›†ç¾¤å»ºç«‹å®Œæˆåå†å¼€å¯ï¼š 1 2 3 # track_script { # chk_apiserver # } 5.6é…ç½®KeepAlivedå¥åº·æ£€æŸ¥æ–‡ä»¶ï¼ˆæ‰€æœ‰MasterèŠ‚ç‚¹ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 [root@k8s-master01 keepalived]# cat /etc/keepalived/check_apiserver.sh #!/bin/bash err=0 for k in $(seq 1 5) do check_code=$(pgrep kube-apiserver) if [[ $check_code == \u0026#34;\u0026#34; ]]; then err=$(expr $err + 1) sleep 5 continue else err=0 break fi done if [[ $err != \u0026#34;0\u0026#34; ]]; then echo \u0026#34;systemctl stop keepalived\u0026#34; /usr/bin/systemctl stop keepalived exit 1 else exit 0 fi 5.7å¯åŠ¨haproxyå’Œkeepalivedï¼ˆæ‰€æœ‰MasterèŠ‚ç‚¹ï¼‰ 1 2 3 [root@k8s-master01 keepalived]# systemctl enable --now haproxy [root@k8s-master01 keepalived]# systemctl enable --now keepalived 5.8é…ç½®K8Sç»„ä»¶ https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/\nå„MasterèŠ‚ç‚¹çš„kubeadm-config.yamlé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š\nMaster01ï¼š\ndaocloud.io/daocloud\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 apiVersion: kubeadm.k8s.io/v1beta2 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: 7t2weq.bjbawausm0jaxury ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 192.168.0.100 bindPort: 6443 nodeRegistration: criSocket: /var/run/dockershim.sock name: k8s-master01 taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiServer: certSANs: - 192.168.0.200 timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controlPlaneEndpoint: 192.168.0.200:16443 controllerManager: {} dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers kind: ClusterConfiguration kubernetesVersion: v1.18.5 networking: dnsDomain: cluster.local podSubnet: 172.168.0.0/16 serviceSubnet: 10.96.0.0/12 scheduler: {} ============================================== #å¦‚æœè¿™ä¸ªé•œåƒåœ°å€æ— æ³•ä¸‹è½½ï¼Œå¯ä»¥æ›¿æ¢ï¼šdaocloud.io/daocloud ä¸‹è½½ imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers kubernetesVersion: v1.18.5 #æ³¨æ„å®‰è£…çš„Kubernetesçš„ç‰ˆæœ¬ æ›´æ–°kubeadmæ–‡ä»¶ï¼Œå¦‚æœä½ ä½¿ç”¨é«˜ç‰ˆæœ¬çš„ï¼Œå¯ä»¥ä½¿ç”¨è¿™æ¡å‘½ä»¤ç”Ÿæˆé«˜ç‰ˆæœ¬çš„yamlæ–‡ä»¶\n1 2 kubeadm config migrate --old-config kubeadm-config.yaml --new-config new.yaml æ‰€æœ‰MasterèŠ‚ç‚¹æå‰ä¸‹è½½é•œåƒï¼Œå¯ä»¥èŠ‚çœåˆå§‹åŒ–æ—¶é—´ï¼š\n1 2 3 4 kubeadmconfig images pull --config /root/kubeadm-config.yaml - æ‰€æœ‰èŠ‚ç‚¹è®¾ç½®å¼€æœºè‡ªå¯åŠ¨kubelet systemctl enable --now kubelet Master01èŠ‚ç‚¹åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–ä»¥åä¼šåœ¨/etc/kubernetesç›®å½•ä¸‹ç”Ÿæˆå¯¹åº”çš„è¯ä¹¦å’Œé…ç½®æ–‡ä»¶ï¼Œä¹‹åå…¶ä»–MasterèŠ‚ç‚¹åŠ å…¥Master01å³å¯ï¼š\n1 kubeadminit --config /root/kubeadm-config.yaml --upload-certs 1 2 3 ä¸ç”¨é…ç½®æ–‡ä»¶åˆå§‹åŒ–ï¼š kubeadm init --control-plane-endpoint \u0026#34;LOAD_BALANCER_DNS:LOAD_BALANCER_PORT\u0026#34; --upload-certs å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œé‡ç½®åå†æ¬¡åˆå§‹åŒ–ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š\n1 kubeadm reset åˆå§‹åŒ–æˆåŠŸä»¥åï¼Œä¼šäº§ç”ŸTokenå€¼ï¼Œç”¨äºå…¶ä»–èŠ‚ç‚¹åŠ å…¥æ—¶ä½¿ç”¨ï¼Œå› æ­¤è¦è®°å½•ä¸‹åˆå§‹åŒ–æˆåŠŸç”Ÿæˆçš„tokenå€¼ï¼ˆä»¤ç‰Œå€¼ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run \u0026#34;kubectl apply -f [podnetwork].yaml\u0026#34; with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ You can now join any number of the control-plane node running the following command on each as root: kubeadm join 192.168.0.200:16443 --token 5joxsb.zo1vh747wljgzrlt \\ --discovery-token-ca-cert-hash sha256:86ee9b6a65c6d8641507e9e56e66dad47cfa15b41b52a11e175c5f9588a485b8 \\ --control-plane --certificate-key bc4726d06255be0cd54592e29068e32c5a49eb8fd30a691342412cf79b3d47c7 Please note that the certificate-key gives access to cluster sensitive data, keep it secret! As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use \u0026#34;kubeadm init phase upload-certs --upload-certs\u0026#34; to reload certs afterward. Then you can join any number of worker nodes by running the following on each as root: kubeadm join 192.168.0.200:16443 --token 5joxsb.zo1vh747wljgzrlt \\ --discovery-token-ca-cert-hash sha256:86ee9b6a65c6d8641507e9e56e66dad47cfa15b41b52a11e175c5f9588a485b8 5.9æ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®ç¯å¢ƒå˜é‡ï¼Œç”¨äºè®¿é—®Kubernetesé›†ç¾¤ï¼š 1 2 3 4 cat \u0026lt;\u0026lt;EOF \u0026gt;\u0026gt; /root/.bashrc export KUBECONFIG=/etc/kubernetes/admin.conf EOF source /root/.bashrc æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ï¼š\n1 2 3 4 5 [root@k8s-master01 ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master01 NotReady master 14m v1.12.3 é‡‡ç”¨åˆå§‹åŒ–å®‰è£…æ–¹å¼ï¼Œæ‰€æœ‰çš„ç³»ç»Ÿç»„ä»¶å‡ä»¥å®¹å™¨çš„æ–¹å¼è¿è¡Œå¹¶ä¸”åœ¨kube-systemå‘½åç©ºé—´å†…ï¼Œæ­¤æ—¶å¯ä»¥æŸ¥çœ‹PodçŠ¶æ€ï¼š\n1 2 3 4 5 6 7 8 9 10 11 [root@k8s-master01 ~]# kubectl get pods -n kube-system -o wide NAME READY STATUS RESTARTS AGE IP NODE coredns-777d78ff6f-kstsz 0/1 Pending 0 14m \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; coredns-777d78ff6f-rlfr5 0/1 Pending 0 14m \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; etcd-k8s-master01 1/1 Running 0 14m 192.168.0.100 k8s-master01 kube-apiserver-k8s-master01 1/1 Running 0 13m 192.168.0.100 k8s-master01 kube-controller-manager-k8s-master01 1/1 Running 0 13m 192.168.0.100 k8s-master01 kube-proxy-8d4qc 1/1 Running 0 14m 192.168.0.100 k8s-master01 kube-scheduler-k8s-master01 1/1 Running 0 13m 192.168.0.100 k8s-master01 6ã€Calicoç»„ä»¶çš„å®‰è£… æ³¨æ„ï¼šå¦‚æœå›½å†…ç”¨æˆ·ä¸‹è½½Calicoè¾ƒæ…¢ï¼Œæ‰€æœ‰èŠ‚ç‚¹å¯ä»¥é…ç½®åŠ é€Ÿå™¨(å¦‚æœè¯¥æ–‡ä»¶æœ‰å…¶ä»–é…ç½®ï¼Œåˆ«å¿˜äº†åŠ ä¸Šå»)\n1 2 3 4 5 6 7 8 9 10 11 vim /etc/docker/daemon.json { \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;], \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;https://registry.docker-cn.com\u0026#34;, \u0026#34;http://hub-mirror.c.163.com\u0026#34;, \u0026#34;https://docker.mirrors.ustc.edu.cn\u0026#34; ] } systemctl daemon-reload systemctl restart docker 1 2 3 4 5 6 7 8 9 Calicoï¼šhttps://www.projectcalico.org/ https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises curl https://docs.projectcalico.org/manifests/calico.yaml -O - name: CALICO_IPV4POOL_CIDR value: \u0026#34;172.168.0.0/16\u0026#34; kubectl apply -f calico.yaml 7ã€é«˜å¯ç”¨Master 1 2 3 4 5 6 7 8 9 10 11 [root@k8s-master01 ~]# kubectl get secret -n kube-system [root@k8s-master01 ~]# kubectl get secret -n kube-system bootstrap-token-7t2weq -oyaml Tokenè¿‡æœŸåç”Ÿæˆæ–°çš„tokenï¼š NodeèŠ‚ç‚¹ç”Ÿæˆ kubeadm token create --print-join-command Masteréœ€è¦ç”Ÿæˆ--certificate-key kubeadm init phase upload-certs --upload-certs 1 2 3 kubeadm join 192.168.0.200:16443 --token 9zp1xe.h5kpi1b9kd5blk76 --discovery-token-ca-cert-hash sha256:6ba6e5205ac27e39e03d3b89a639ef70f6503fb877b1cf8a332b399549471740 \\ --control-plane --certificate-key 309f945f612dd7f0d830b11868edd5135e6cf358ed503107eb645dc8d7c84405 8ã€NodeèŠ‚ç‚¹çš„é…ç½® NodeèŠ‚ç‚¹ä¸Šä¸»è¦éƒ¨ç½²å…¬å¸çš„ä¸€äº›ä¸šåŠ¡åº”ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒä¸­ä¸å»ºè®®MasterèŠ‚ç‚¹éƒ¨ç½²ç³»ç»Ÿç»„ä»¶ä¹‹å¤–çš„å…¶ä»–Podï¼Œæµ‹è¯•ç¯å¢ƒå¯ä»¥å…è®¸MasterèŠ‚ç‚¹éƒ¨ç½²Podä»¥èŠ‚çœç³»ç»Ÿèµ„æºã€‚\n1 2 kubeadm join 192.168.0.200:16443 --token 9zp1xe.h5kpi1b9kd5blk76 --discovery-token-ca-cert-hash sha256:6ba6e5205ac27e39e03d3b89a639ef70f6503fb877b1cf8a332b399549471740 9ã€ Metricséƒ¨ç½² åœ¨æ–°ç‰ˆçš„Kubernetesä¸­ç³»ç»Ÿèµ„æºçš„é‡‡é›†å‡ä½¿ç”¨Metrics-serverï¼Œå¯ä»¥é€šè¿‡Metricsé‡‡é›†èŠ‚ç‚¹å’ŒPodçš„å†…å­˜ã€ç£ç›˜ã€CPUå’Œç½‘ç»œçš„ä½¿ç”¨ç‡ã€‚\nHeapsteræ›´æ”¹metricsçš„éƒ¨ç½²æ–‡ä»¶è¯ä¹¦ï¼Œå°†metrics-server-3.6.1/metrics-server-deployment.yamlçš„front-proxy-ca.pemæ”¹ä¸ºfront-proxy-ca.crt\n1 2 3 4 5 å°†Master01èŠ‚ç‚¹çš„front-proxy-ca.crtå¤åˆ¶åˆ°æ‰€æœ‰NodeèŠ‚ç‚¹ scp /etc/kubernetes/pki/front-proxy-ca.crt k8s-node01:/etc/kubernetes/pki/front-proxy-ca.crt scp /etc/kubernetes/pki/front-proxy-ca.crt k8s-node(å…¶ä»–èŠ‚ç‚¹è‡ªè¡Œæ‹·è´):/etc/kubernetes/pki/front-proxy-ca.crt å®‰è£…metrics server kubectl create -f metrics-server-3.6.1/ 10ã€Dashboardéƒ¨ç½² å®˜æ–¹GitHubï¼šhttps://github.com/kubernetes/dashboard\nDashboardç”¨äºå±•ç¤ºé›†ç¾¤ä¸­çš„å„ç±»èµ„æºï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡Dashboardå®æ—¶æŸ¥çœ‹Podçš„æ—¥å¿—å’Œåœ¨å®¹å™¨ä¸­æ‰§è¡Œä¸€äº›å‘½ä»¤ç­‰ã€‚\nå¯ä»¥åœ¨å®˜æ–¹dashboardæŸ¥çœ‹åˆ°æœ€æ–°ç‰ˆdashboard\n1 2 3 4 5 6 kubectl apply â€“f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.4/aio/deploy/recommended.yaml [root@k8s-master01 ]# kubectl get svc -n kubernetes-dashboard [root@k8s-master01]# kubectl edit svc kubernetes-dashboard -n !$ åœ¨è°·æ­Œæµè§ˆå™¨ï¼ˆChromeï¼‰å¯åŠ¨æ–‡ä»¶ä¸­åŠ å…¥å¯åŠ¨å‚æ•°ï¼Œç”¨äºè§£å†³æ— æ³•è®¿é—®Dashboardçš„é—®é¢˜\n--test-type--ignore-certificate-errors\nè®¿é—®Dashboardï¼šhttps://192.168.0.200:30000ï¼Œé€‰æ‹©ç™»å½•æ–¹å¼ä¸ºä»¤ç‰Œï¼ˆå³tokenæ–¹å¼ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 vim admin.yaml apiVersion: v1 kind: ServiceAccount metadata: name: admin-user namespace: kube-system --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: admin-user annotations: rbac.authorization.kubernetes.io/autoupdate: \u0026#34;true\u0026#34; roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin subjects: - kind: ServiceAccount name: admin-user namespace: kube-system kubectl apply -f admin.yaml kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk \u0026#39;{print $1}\u0026#39;) å°†tokenå€¼è¾“å…¥åˆ°ä»¤ç‰Œåï¼Œå•å‡»ç™»å½•å³å¯è®¿é—®Dashboard\n1 2 3 4 5 6 7 8 å°†Kube-proxyæ”¹ä¸ºipvsæ¨¡å¼ï¼Œå› ä¸ºåœ¨åˆå§‹åŒ–é›†ç¾¤çš„æ—¶å€™æ³¨é‡Šäº†ipvsé…ç½®ï¼Œæ‰€ä»¥éœ€è¦è‡ªè¡Œä¿®æ”¹ä¸€ä¸‹ï¼š kubectl edit cm kube-proxy -n kube-system mode: â€œipvsâ€ æ›´æ–°Kube-Proxyçš„Podï¼š kubectl patch daemonset kube-proxy -p \u0026#34;{\\\u0026#34;spec\\\u0026#34;:{\\\u0026#34;template\\\u0026#34;:{\\\u0026#34;metadata\\\u0026#34;:{\\\u0026#34;annotations\\\u0026#34;:{\\\u0026#34;date\\\u0026#34;:\\\u0026#34;`date +\u0026#39;%s\u0026#39;`\\\u0026#34;}}}}}\u0026#34; -n kube-system éªŒè¯Kube-Proxyæ¨¡å¼ [root@k8s-master01 1.1.1]# curl 127.0.0.1:10249/proxyMode ipvs 1 2 3 4 5 6 7 [root@k8s-master01 ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master01 Ready master 5h50m v1.18.5 k8s-master02 Ready master 5h31m v1.18.5 k8s-master03 Ready master 5h30m v1.18.5 k8s-node01 Ready \u0026lt;none\u0026gt; 5h26m v1.18.5 k8s-node02 Ready \u0026lt;none\u0026gt; 5h26m v1.18.5 ","date":"2020-11-27T19:10:39Z","image":"https://www.ownit.top/title_pic/18.jpg","permalink":"https://www.ownit.top/p/202011271910/","title":"kubeadmé«˜å¯ç”¨å®‰è£…k8sé›†ç¾¤1.18.5"},{"content":"1ã€å¯è¿­ä»£å¯¹è±¡ 1)ã€å¯è¿­ä»£å¯¹è±¡å®šä¹‰ å¯¹äºè¿­ä»£å™¨æ¥è¯´ï¼Œæˆ‘ä»¬æ›´ç†Ÿæ‚‰çš„åº”è¯¥æ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Œä¹‹å‰æ— è®ºæ˜¯æºç è¿˜æ˜¯è®²è¯¾ä¸­æˆ–å¤šæˆ–å°‘æˆ‘ä»¬æåˆ°è¿‡å¯è¿­ä»£å¯¹è±¡è¿™ä¸ªè¯ã€‚ä¹‹å‰ä¸ºäº†ä¾¿äºå¤§å®¶ç†è§£å¯è¿­ä»£å¯¹è±¡ï¼Œå¯èƒ½è§£é‡Šçš„ä¸æ˜¯å¾ˆæ­£ç¡®ï¼Œæ‰€ä»¥ä»Šå¤©æˆ‘ä»¬æ­£å¼çš„èŠä¸€èŠä»€ä¹ˆæ˜¯å¯è¿­ä»£å¯¹è±¡ã€‚ä»å­—é¢æ„æ€æ¥è¯´ï¼Œæˆ‘ä»¬å…ˆå¯¹å…¶è¿›è¡Œæ‹†è§£ï¼šä»€ä¹ˆæ˜¯å¯¹è±¡ï¼ŸPythonä¸­ä¸€åˆ‡çš†å¯¹è±¡ï¼Œä¹‹å‰æˆ‘ä»¬è®²è¿‡çš„ä¸€ä¸ªå˜é‡ï¼Œä¸€ä¸ªåˆ—è¡¨ï¼Œä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ–‡ä»¶å¥æŸ„ï¼Œå‡½æ•°åç­‰ç­‰éƒ½å¯ç§°ä½œä¸€ä¸ªå¯¹è±¡ï¼Œå…¶å®ä¸€ä¸ªå¯¹è±¡å°±æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œå°±æ˜¯ä¸€ä¸ªå®å®åœ¨åœ¨çš„ä¸œè¥¿ã€‚é‚£ä¹ˆä»€ä¹ˆå«è¿­ä»£ï¼Ÿå…¶å®æˆ‘ä»¬åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ç»å¸¸é‡åˆ°è¿­ä»£è¿™ä¸ªè¯å„¿ï¼Œæ›´æ–°è¿­ä»£ç­‰ç­‰ï¼Œè¿­ä»£å°±æ˜¯ä¸€ä¸ªé‡å¤çš„è¿‡ç¨‹ï¼Œä½†æ˜¯ä¸èƒ½æ˜¯å•çº¯çš„é‡å¤ï¼ˆå¦‚æœåªæ˜¯å•çº¯çš„é‡å¤é‚£ä¹ˆä»–ä¸å¾ªç¯æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼‰æ¯æ¬¡é‡å¤éƒ½æ˜¯åŸºäºä¸Šä¸€æ¬¡çš„ç»“æœè€Œæ¥ã€‚æ¯”å¦‚ä½ çˆ¹ç”Ÿä½ ï¼Œä½ ç”Ÿä½ çˆ¹ï¼Œå“¦ä¸å¯¹ï¼Œä½ ç”Ÿä½ å„¿å­ï¼Œä½ å„¿å­ç”Ÿä½ å­™å­ç­‰ç­‰ï¼Œæ¯ä¸€ä»£éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼›è¿˜æœ‰ä½ ä½¿ç”¨è¿‡å¾—appï¼Œå¾®ä¿¡ï¼ŒæŠ–éŸ³ç­‰ï¼Œéš”ä¸€æ®µæ—¶é—´å°±ä¼šåŸºäºä¸Šä¸€æ¬¡åšä¸€äº›æ›´æ–°ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯è¿­ä»£ã€‚å¯è¿­ä»£å¯¹è±¡ä»å­—é¢æ„æ€æ¥è¯´å°±æ˜¯ä¸€ä¸ªå¯ä»¥é‡å¤å–å€¼çš„å®å®åœ¨åœ¨çš„ä¸œè¥¿ã€‚\nstrÂ listÂ tupleÂ dicÂ setÂ range æ–‡ä»¶å¥æŸ„ç­‰ï¼Œé‚£ä¹ˆintï¼Œboolè¿™äº›ä¸ºä»€ä¹ˆä¸èƒ½ç§°ä¸ºå¯è¿­ä»£å¯¹è±¡å‘¢ï¼Ÿè™½ç„¶åœ¨å­—é¢æ„æ€è¿™äº›çœ‹ç€ä¸ç¬¦åˆï¼Œä½†æ˜¯æˆ‘ä»¬è¦æœ‰ä¸€å®šçš„åˆ¤æ–­æ ‡å‡†æˆ–è€…è§„åˆ™å»åˆ¤æ–­è¯¥å¯¹è±¡æ˜¯ä¸æ˜¯å¯è¿­ä»£å¯¹è±¡ã€‚\nåœ¨pythonä¸­ï¼Œä½†å‡¡å†…éƒ¨å«æœ‰__iter__æ–¹æ³•çš„å¯¹è±¡ï¼Œéƒ½æ˜¯å¯è¿­ä»£å¯¹è±¡\n2ã€Â æŸ¥çœ‹å¯¹è±¡å†…éƒ¨æ–¹æ³• è¯¥å¯¹è±¡å†…éƒ¨å«æœ‰ä»€ä¹ˆæ–¹æ³•é™¤äº†çœ‹æºç è¿˜æœ‰ä»€ä¹ˆå…¶ä»–çš„è§£å†³æ–¹å¼ä¹ˆï¼Ÿå½“ç„¶æœ‰äº†ï¼Œ å¯ä»¥é€šè¿‡dir() å»åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡å…·æœ‰ä»€ä¹ˆæ–¹æ³•\n1 2 s1 = \u0026#39;heian\u0026#39; print(dir(s1)) dir()ä¼šè¿”å›ä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨ä¸­å«æœ‰è¯¥å¯¹è±¡çš„ä»¥å­—ç¬¦ä¸²çš„å½¢å¼æ‰€æœ‰æ–¹æ³•åã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­pythonä¸­çš„ä¸€ä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯å¯è¿­ä»£å¯¹è±¡äº†ï¼š\n1 2 3 4 s1 = \u0026#39;heian\u0026#39; i = 100 print(\u0026#39;__iter__\u0026#39; in dir(i)) # False print(\u0026#39;__iter__\u0026#39; in dir(s1)) # True 3ã€åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥è¿­ä»£ 1 2 3 name = [1,2,3,4] print(dir(name)) print(\u0026#39;__iter__\u0026#39; in dir(name)) 4ã€å°ç»“ï¼š å­—é¢æ„æ€ï¼šå¾ªç¯æ›´æ–°çš„ä¸€ä¸ªå®å®åœ¨åœ¨çš„å€¼\nå†…éƒ¨æ„æ€ï¼šå†…éƒ¨å«æœ‰â€œ__iter__()â€æ–¹æ³•çš„å¯¹è±¡ï¼Œå¯è¿­ä»£å¯¹è±¡\nåˆ¤æ–­æ–¹æ³•ï¼š\u0026rsquo;__iter__\u0026rsquo; in dir(å¯¹è±¡)\nstr list tuple dict set range\n5ã€è¿­ä»£å¯¹è±¡ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\n1.å­˜å‚¨çš„æ•°æ®ç›´æ¥èƒ½æ˜¾ç¤ºï¼Œæ¯”è¾ƒç›´è§‚\n2.æ‹¥æœ‰çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œæ“ä½œæ–¹ä¾¿\nç¼ºç‚¹ï¼š\n1.å ç”¨å†…å­˜\n2.ä¸èƒ½ç›´æ¥é€šè¿‡forå¾ªç¯ï¼Œä¸èƒ½ç›´æ¥å–å€¼ï¼ˆç´¢å¼•å’Œkeyé™¤å¤–ï¼‰\nforå¾ªç¯åœ¨åº•å±‚åšäº†ä¸€ä¸ªå°å°çš„è½¬åŒ–ï¼Œå°±æ˜¯å…ˆå°†å¯è¿­ä»£å¯¹è±¡è½¬åŒ–æˆè¿­ä»£å™¨ï¼Œç„¶ååœ¨è¿›è¡Œå–å€¼çš„ã€‚\n**Â 2ã€è¿­ä»£å™¨** 1ã€è¿­ä»£å™¨çš„å®šä¹‰ ä»å­—é¢æ„æ€æ¥è¯´è¿­ä»£å™¨ï¼Œæ˜¯ä¸€ä¸ªå¯ä»¥è¿­ä»£å–å€¼çš„å·¥å…·ï¼Œå™¨ï¼šåœ¨è¿™é‡Œå½“åšå·¥å…·æ¯”è¾ƒåˆé€‚ã€‚\nä»ä¸“ä¸šè§’åº¦æ¥è¯´ï¼šè¿­ä»£å™¨æ˜¯è¿™æ ·çš„å¯¹è±¡ï¼šå®ç°äº†æ— å‚æ•°çš„__next__æ–¹æ³•ï¼Œè¿”å›åºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰å…ƒç´ äº†ï¼Œé‚£ä¹ˆæŠ›å‡ºStopIterationå¼‚å¸¸.pythonä¸­çš„è¿­ä»£å™¨è¿˜å®ç°äº†__iter__æ–¹æ³•ï¼Œå› æ­¤è¿­ä»£å™¨ä¹Ÿå¯ä»¥è¿­ä»£ã€‚ å‡ºè‡ªã€Šæµç•…çš„pythonã€‹\né‚£ä¹ˆå¯¹äºä¸Šé¢çš„è§£é‡Šæœ‰ä¸€äº›è¶…å‰ï¼Œå’Œéš¾ä»¥ç†è§£ï¼Œä¸ç”¨è¿‡äºçº ç»“ï¼Œæˆ‘ä»¬ç®€å•æ¥è¯´ï¼šåœ¨pythonä¸­ï¼Œå†…éƒ¨å«æœ‰\u0026rsquo;__Iter__\u0026lsquo;æ–¹æ³•å¹¶ä¸”å«æœ‰\u0026rsquo;__next__\u0026lsquo;æ–¹æ³•çš„å¯¹è±¡å°±æ˜¯è¿­ä»£å™¨ã€‚\n2ã€å¦‚ä½•åˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦æ˜¯è¿­ä»£å™¨ 1 2 with open(\u0026#39;heian\u0026#39;,mode=\u0026#39;w\u0026#39;,encoding=\u0026#39;utf-8\u0026#39;) as f: print(\u0026#39;__iter__\u0026#39; in dir(f) and \u0026#39;__next__\u0026#39; in dir(f)) 3ã€å¯è¿­ä»£å¯¹è±¡å¦‚ä½•è½¬åŒ–æˆè¿­ä»£å™¨ 1 2 3 4 l1 = [1, 2, 3, 4, 5, 6] obj = l1.__iter__() # æˆ–è€… iter(l1)print(obj) # \u0026lt;list_iterator object at 0x000002057FE1A3C8\u0026gt; **ã€€4ã€Â è¿­ä»£å™¨å–å€¼ï¼š** å¯è¿­ä»£å¯¹è±¡æ˜¯ä¸å¯ä»¥ä¸€ç›´è¿­ä»£å–å€¼çš„ï¼ˆé™¤å»ç”¨ç´¢å¼•ï¼Œåˆ‡ç‰‡ä»¥åŠKeyï¼‰ï¼Œä½†æ˜¯è½¬åŒ–æˆè¿­ä»£å™¨å°±å¯ä»¥äº†ï¼Œè¿­ä»£å™¨æ˜¯åˆ©ç”¨__next__()è¿›è¡Œå–å€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 l1 = [1, 2, 3,] obj = l1.__iter__() # æˆ–è€… iter(l1) # print(obj) # \u0026lt;list_iterator object at 0x000002057FE1A3C8\u0026gt; ret = obj.__next__() print(ret) ret = obj.__next__() print(ret) ret = obj.__next__() print(ret) ret = obj.__next__() # StopIteration print(ret) # è¿­ä»£å™¨åˆ©ç”¨nextå–å€¼ï¼šä¸€ä¸ªnextå–å¯¹åº”çš„ä¸€ä¸ªå€¼ï¼Œå¦‚æœè¿­ä»£å™¨é‡Œé¢çš„å€¼å–å®Œäº†ï¼Œè¿˜è¦nextï¼Œ # é‚£ä¹ˆå°±æŠ¥StopIterationçš„é”™è¯¯ã€‚ 5ã€whileæ¨¡æ‹Ÿforçš„å†…éƒ¨å¾ªç¯æœºåˆ¶ 1 2 3 4 5 6 7 8 9 10 l1 = [1, 2, 3, 4, 5, 6] # 1 å°†å¯è¿­ä»£å¯¹è±¡è½¬åŒ–æˆè¿­ä»£å™¨ obj = iter(l1) # 2,åˆ©ç”¨whileå¾ªç¯ï¼Œnextè¿›è¡Œå–å€¼ while 1: # 3,åˆ©ç”¨å¼‚å¸¸å¤„ç†ç»ˆæ­¢å¾ªç¯ try: print(next(obj)) except StopIteration: break 6ã€è¿­ä»£å™¨çš„ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\n1.èŠ‚çœå†…å­˜\n2.æƒ°æ€§æœºåˆ¶ã€‚ nextä¸€æ¬¡ï¼Œå–ä¸€ä¸ªå€¼ï¼Œç»ä¸è¿‡å¤šå–å€¼ã€‚â€‹\nç¼ºç‚¹ï¼š\n1.é€Ÿåº¦æ…¢\n2.ä¸èµ°å›å¤´è·¯\n1 2 3 4 5 6 7 8 l1 = [1, 2, 3, 4, 5, 6] obj = iter(l1) for i in range(2): print(next(obj)) for i in range(2): print(next(obj)) 3ã€å¯è¿­ä»£å¯¹è±¡ä¸è¿­ä»£å™¨å¯¹æ¯” å¯è¿­ä»£å¯¹è±¡ï¼š\næ˜¯ä¸€ä¸ªç§æœ‰çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œæ“ä½œçµæ´»ï¼ˆæ¯”å¦‚åˆ—è¡¨ï¼Œå­—å…¸çš„å¢åˆ æ”¹æŸ¥ï¼Œå­—ç¬¦ä¸²çš„å¸¸ç”¨æ“ä½œæ–¹æ³•ç­‰ï¼‰,æ¯”è¾ƒç›´è§‚ï¼Œä½†æ˜¯å ç”¨å†…å­˜ï¼Œè€Œä¸”ä¸èƒ½ç›´æ¥é€šè¿‡å¾ªç¯è¿­ä»£å–å€¼çš„è¿™ä¹ˆä¸€ä¸ªæ•°æ®é›†ã€‚\n**Â åº”ç”¨**ï¼šå½“ä½ ä¾§é‡äºå¯¹äºæ•°æ®å¯ä»¥çµæ´»å¤„ç†ï¼Œå¹¶ä¸”å†…å­˜ç©ºé—´è¶³å¤Ÿï¼Œå°†æ•°æ®é›†è®¾ç½®ä¸ºå¯è¿­ä»£å¯¹è±¡æ˜¯æ˜ç¡®çš„é€‰æ‹©ã€‚\n**Â è¿­ä»£å™¨ï¼š**\næ˜¯ä¸€ä¸ªéå¸¸èŠ‚çœå†…å­˜ï¼Œå¯ä»¥è®°å½•å–å€¼ä½ç½®ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡å¾ªç¯+nextæ–¹æ³•å–å€¼ï¼Œä½†æ˜¯ä¸ç›´è§‚ï¼Œæ“ä½œæ–¹æ³•æ¯”è¾ƒå•ä¸€çš„æ•°æ®é›†ã€‚\nåº”ç”¨ï¼šå½“ä½ çš„æ•°æ®é‡è¿‡å¤§ï¼Œå¤§åˆ°è¶³ä»¥æ’‘çˆ†ä½ çš„å†…å­˜æˆ–è€…ä½ ä»¥èŠ‚çœå†…å­˜ä¸ºé¦–é€‰å› ç´ æ—¶ï¼Œå°†æ•°æ®é›†è®¾ç½®ä¸ºè¿­ä»£å™¨æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ï¼ˆå¯å‚è€ƒä¸ºä»€ä¹ˆpythonæŠŠæ–‡ä»¶å¥æŸ„è®¾ç½®æˆè¿­ä»£å™¨ï¼‰ã€‚\n","date":"2020-11-15T23:53:21Z","image":"https://www.ownit.top/title_pic/22.jpg","permalink":"https://www.ownit.top/p/202011152353/","title":"Pythonè¿­ä»£å¯¹è±¡å’Œè¿­ä»£å™¨"},{"content":"ä¼ä¸šå¾®ä¿¡æœºå™¨äººå‘Šè­¦ ä¼ä¸šå¾®ä¿¡ç¾¤èŠé‡Œé¢å¢åŠ æœºå™¨äººï¼Œæœºå™¨äººä¼šæä¾›å‘é€ä¿¡æ¯çš„URL\npython è„šæœ¬è¿›è¡Œå®ç°çš„\n1ã€åˆ›å»ºä¼ä¸šå¾®ä¿¡æœºå™¨äºº æ²¡æœ‰ä¼ä¸šå¾®ä¿¡çš„å¯ä»¥è‡ªå·±åœ¨ä¼ä¸šå¾®ä¿¡å®˜ç½‘ç”³è¯·æ³¨å†Œä¸ªä¼ä¸šï¼Œåˆ›å»ºä¼ä¸šå¾®ä¿¡ç¾¤è‡³å°‘ 3 ä¸ªäººä»¥ä¸Š\nè¿™ä¸ª webhook åé¢éœ€è¦ä½¿ç”¨åˆ°\n2ã€é…ç½® zabbix server 2.1ï¼šé…ç½®è„šæœ¬æ‰§è¡Œç›®å½•\nå®šä¹‰è„šæœ¬ç›®å½•ï¼Œæˆ‘è¿™é‡Œå°±é€‰æ‹©äº†é»˜è®¤çš„ç›®å½•\n1 2 [root@zabbix-master ~]# grep -Ev \u0026#39;^$|#\u0026#39; /etc/zabbix/zabbix_server.conf | grep ^A AlertScriptsPath=/usr/lib/zabbix/alertscripts 2.2ï¼šåˆ›å»ºè„šæœ¬\nè¿›å…¥è¯¥å®šä¹‰çš„è„šæœ¬å­˜æ”¾è·¯å¾„ä¸‹åˆ›å»ºç”¨æ¥æ¨é€å‘Šè­¦æ¶ˆæ¯çš„è„šæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 [root@zabbix-master ~]# [root@zabbix-master ~]# cd /usr/lib/zabbix/alertscripts [root@zabbix-master alertscripts]# vim wechat.py #!/usr/bin/python # -*- coding: utf-8 -*- import requests import json import sys import os headers = {\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json;charset=utf-8\u0026#39;} api_url = \u0026#34;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=36d51b45-162f6c9d13909\u0026#34; #è¿™å°±æ˜¯å…ˆå‰çš„webhookåœ°å€ def msg(text): json_text= { \u0026#34;msgtype\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: { \u0026#34;content\u0026#34;: text }, } print requests.post(api_url,json.dumps(json_text),headers=headers).content if __name__ == \u0026#39;__main__\u0026#39;: text = sys.argv[1] msg(text) ~ 2.3ï¼šèµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™\n1 2 3 4 [root@zabbix-master alertscripts]# chmod +x wechat.py [root@zabbix-master alertscripts]# python wechat.py ä½ å¥½ {\u0026#34;errcode\u0026#34;:0,\u0026#34;errmsg\u0026#34;:\u0026#34;ok\u0026#34;} [root@zabbix-master alertscripts]# 3ã€zabbix Web é¡µé¢é…ç½® 3.1ï¼šåˆ›å»ºæŠ¥è­¦åª’ä»‹\nç®¡ç†\u0026ndash;\u0026gt; æŠ¥è­¦åª’ä»‹ç±»å‹\u0026ndash;\u0026gt; åˆ›å»ºåª’ä»‹ç±»å‹\næ–°å»ºä¸€ä¸ªä¼ä¸šå¾®ä¿¡çš„æŠ¥è­¦ï¼Œè„šæœ¬åç§°å°±æ˜¯æˆ‘ä»¬è„šæœ¬å wechat.py\n3.2ï¼šåˆ›å»ºåŠ¨ä½œ\né»˜è®¤æ ‡é¢˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 æ•…éšœ{TRIGGER.STATUS},æœåŠ¡å™¨:{HOSTNAME1}å‘ç”Ÿ: {TRIGGER.NAME}æ•…éšœ! æ•…éšœ{TRIGGER.STATUS},æœåŠ¡å™¨:{HOSTNAME1}å‘ç”Ÿ: {TRIGGER.NAME}æ•…éšœ! å‘Šè­¦ä¸»æœº:{HOSTNAME1} å‘Šè­¦åœ°å€ï¼š{HOST.IP} å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME} å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY} å‘Šè­¦ä¿¡æ¯: {TRIGGER.NAME} å‘Šè­¦é¡¹ç›®:{TRIGGER.KEY1} é—®é¢˜è¯¦æƒ…:{ITEM.NAME}:{ITEM.VALUE} å½“å‰çŠ¶æ€:{TRIGGER.STATUS}:{ITEM.VALUE1} äº‹ä»¶ID:{EVENT.ID} æ¢å¤æ“ä½œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 æ¢å¤{TRIGGER.STATUS}, æœåŠ¡å™¨:{HOSTNAME1}: {TRIGGER.NAME}å·²æ¢å¤! æ¢å¤{TRIGGER.STATUS}, æœåŠ¡å™¨:{HOSTNAME1}: {TRIGGER.NAME}å·²æ¢å¤! å‘Šè­¦ä¸»æœº:{HOSTNAME1} å‘Šè­¦åœ°å€ï¼š{HOST.IP} å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME} å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY} å‘Šè­¦ä¿¡æ¯: {TRIGGER.NAME} å‘Šè­¦é¡¹ç›®:{TRIGGER.KEY1} é—®é¢˜è¯¦æƒ…:{ITEM.NAME}:{ITEM.VALUE} å½“å‰çŠ¶æ€:{TRIGGER.STATUS}:{ITEM.VALUE1} äº‹ä»¶ID:{EVENT.ID} 4ã€æµ‹è¯•å‘é€å‘Šè­¦ ","date":"2020-10-30T18:22:15Z","image":"https://www.ownit.top/title_pic/18.jpg","permalink":"https://www.ownit.top/p/202010301822/","title":"Zabbixé…ç½®ä¼ä¸šå¾®ä¿¡ç¾¤(æœºå™¨äºº)è­¦å‘Š"},{"content":"ç›®å½•\n1.é…ç½® yum æº\n2.è®¾å®š runlevel 3\n3.ç²¾ç®€å¼€æœºå¯åŠ¨æœåŠ¡\n4.é…ç½® sudo æˆæƒç®¡ç†\n5.ssh æœåŠ¡\n6.ä¿®æ”¹ linux é»˜è®¤å­—ç¬¦é›†\n7.æœåŠ¡å™¨æ—¶é—´åŒæ­¥\n8.åŠ å¤§æœåŠ¡å™¨æ–‡ä»¶æè¿°ç¬¦\n9.æ¸…ç† clientmqueue åƒåœ¾æ–‡ä»¶é˜²æ­¢ inode è¢«å æ»¡\n10.è°ƒæ•´å†…æ ¸ä¼˜åŒ–\n11.grep è®¾ç½®é«˜äº®æ˜¾ç¤º\nUlimitç®¡ç†ç³»ç»Ÿèµ„æº\nlinux ä¸Šä¼ ä¸‹è½½å°å·¥å…·\ntcp/ip è°ƒä¼˜\nä¼˜åŒ–æ€»ç»“\n1.é…ç½® yum æº 1ã€æ·»åŠ æ™®é€šç”¨æˆ·ï¼Œä½¿ç”¨æ™®é€šç”¨æˆ· su - root ç™»é™†åˆ° root\n2ã€è®¾ç½®æ›´æ–°æº\nLinux ä¸‹æ–¹ä¾¿å®‰è£…è½¯ä»¶çš„ä¼˜ç§€å·¥å…·å«åš yum å·¥å…·ï¼Œlinux çš„äºŒè¿›åˆ¶è½¯ä»¶åŒ…ä¸€èˆ¬æ˜¯ rpm åŒ…ï¼Œç±»ä¼¼windows ä¸‹çš„ exe ç¨‹åºã€‚\né€šè¿‡ yum å·¥å…·å®‰è£…è½¯ä»¶ï¼Œé»˜è®¤è·å– rpm åŒ…çš„è½¯ä»¶é…ç½®æ˜¯ä»å›½å¤– centos å®˜æ–¹æºä¸‹è½½ã€‚\nå› æ­¤ï¼Œæˆ‘ä»¬ yum å®‰è£…è½¯ä»¶é€Ÿåº¦ä¼šæ¯”è¾ƒæ…¢ï¼Œå› æ­¤éœ€è¦æŠŠé»˜è®¤è·å– rpm åŒ…çš„é…ç½®ä»å›½å¤–å®˜æ–¹æºæ”¹ä¸ºå›½å†…ã€‚\n1 2 3 4 5 6 7 8 centos 5.8 64 ä½ yum æº http://mirrors.sohu.com/help/CentOS-Base-sohu.repo centos 6.4 64 ä½ yum æº http://mirrors.163.com/.help/CentOS6-Base-163.repo cd /etc/yum.repos.d/ //è¿›å…¥ yum æº7 /bin/mv CentOS-Base.repo CentOS-Base.repo.ori //å¤‡ä»½ yum æº wget http://mirrors.sohu.com/help/CentOS-Base-sohu.repo //ä¸‹è½½ soho æº /bin/mv CentOS-Base-sohu.repo CentOS-Base.repo è¯´æ˜ï¼šæˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„æ˜¯äº’è”ç½‘ä¸Šçš„é—¨æˆ·ç½‘ç«™æä¾›çš„ yum æºï¼Œå°†æ¥æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠ iso é•œåƒæˆ–å…‰ç›˜é…\nç½®æˆ yum æºï¼Œä½ è¿˜å¯ä»¥è‡ªå·±é…ç½®ä¸€ä¸ªåƒé—¨æˆ·ç½‘ç«™æä¾›çš„è¿™ç§ yum æº\né…ç½®å…¬ç½‘ yum æºåŠåˆ¶ä½œ rpm åŒ…ã€‚\n3ã€ä½¿ç”¨ yum upgrade ç›¸å½“äº windows ä¸‹çš„æ‰“è¡¥ä¸ï¼Œè¿™ä¸ªåŠŸèƒ½å°±ç”¨åˆ°äº† yum æºï¼Œé€Ÿåº¦ä¼šæ¯”è¾ƒå¿«\n4ã€å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…\n1 yum -y install lrzsz ä¸€ã€å…³é—­ selinux\nç”±äºå®‰è£…æœåŠ¡ã€è½¯ä»¶ä¸­ï¼Œç»å¸¸å’Œ selinux å†²çªï¼Œåœ¨å›½å†…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéƒ½æ˜¯å…³æ‰ selinuxã€‚\n1 2 3 4 5 6 vi /etc/selinux/config //é…ç½®æ–‡ä»¶ é»˜è®¤æ˜¯ enforcing å¯ç”¨çŠ¶æ€ disabled æ˜¯å®Œå…¨å…³é—­çŠ¶æ€ permissive æ˜¯æ‰“å°è­¦å‘Šï¼Œselinu ä¸ç”Ÿæ•ˆ è¿™ç§ä¿®æ”¹åªèƒ½é‡å¯ç”Ÿæ•ˆ gentenforce 0 ä¸´æ—¶å…³é—­ selinuxï¼Œä½¿ç”¨ gentenforce æŸ¥çœ‹å½“å‰ selinux çŠ¶æ€ 2.è®¾å®š runlevel 3\n1 2 runlevel æŸ¥çœ‹å½“å‰ç³»ç»Ÿè¿è¡Œçº§åˆ« vi /etc/inittab //è¿è¡Œçº§åˆ«é…ç½®æ–‡ä»¶ 3.ç²¾ç®€å¼€æœºå¯åŠ¨æœåŠ¡\n1ã€å¯ä»¥ä½¿ç”¨ setup-system services é‡Œé¢è°ƒæ•´ï¼Œè¿™æ ·è°ƒæ•´èµ·æ¥æ•ˆç‡ä½\n2ã€æˆ–è€… ntsysv è°ƒå‡ºæ¥\n3ã€ä½¿ç”¨è„šæœ¬ä¸€ä»¶å…³é—­\n1 2 3 4 5 6 7 8 9 10 #LANG=en #æ˜¾ç¤ºå‡ºæ‰€æœ‰æœåŠ¡çš„æ‰€æœ‰è¿è¡Œçº§åˆ«çš„å¯åŠ¨çŠ¶æ€ 8 chkconfig --list #åœæ­¢æ‰€æœ‰åœ¨è¿è¡Œçº§åˆ« 3 ä¸Šå¼€æœºå¯åŠ¨çš„æœåŠ¡ for oldboy in `chkconfig --list|grep3:on |awk \u0026#39;{print $1}\u0026#39;`;do chkconfig --level 3 $oldboyoff;done #åœ¨å¼€å¯å¸¸ç”¨çš„æœåŠ¡ï¼Œcrond,network,rsyslog,sshd for oldboy in crond network rsyslogsshd;do chkconfig --level 3 $oldboy on;done #æ˜¾ç¤ºå‡ºæ‰€æœ‰ 3 è¿è¡Œçº§åˆ«ä¸‹çš„æ‰€æœ‰æœåŠ¡(æ ¹æ®éœ€æ±‚å†³å®šå“ªä¸ªæœåŠ¡å¯åŠ¨) chkconfig --list |grep3:on åˆšè£…å®Œçš„æ“ä½œç³»ç»Ÿï¼Œåªéœ€è¦å¼€å¯å‡ ä¸ªæœåŠ¡ï¼Œå‰©ä¸‹çš„ä»¥åç”¨åˆ°å†å¼€ï¼Œè¿™æ ·å®‰å…¨ï¼Œéµå¾ªæœ€å°åŒ–åŸåˆ™ï¼Œæ²¡\nç”¨çš„ä¸å¯åŠ¨ã€‚\ncrond å®šæ—¶ä»»åŠ¡ network ç½‘ç»œæœåŠ¡ sshd è¿œç¨‹æœåŠ¡ syslog æ—¥å¿—æœåŠ¡ 4.é…ç½® sudo æˆæƒç®¡ç† ä¸ºä»€ä¹ˆä½¿ç”¨ sudoï¼Œå¦‚æœæ™®é€šç”¨æˆ·ä½¿ç”¨ su - root åˆ‡æ¢åˆ°ç®¡ç†å‘˜ã€‚è¿›è¡Œéæ³•æ“ä½œï¼Œæ¯”å¦‚ passwd root\nä¿®æ”¹ root å¯†ç ã€‚é‚£ä¹ˆç³»ç»Ÿå…¶ä»–ç”¨æˆ·å°†æ— æ³•è®¿é—®ç³»ç»Ÿã€‚è¿™ä¸ªæ™®é€šç®¡ç†å‘˜è¯´ç™½äº†ï¼Œå·²ç»â€åŠŸé«˜ç›–ä¸»â€œ\n1ã€åœ¨ root æƒé™ä¸‹æ‰§è¡Œ visudo åœ¨ 98 è¡Œä¿®æ”¹ã€‚å‘½ä»¤ä½¿ç”¨é€—å·éš”å¼€ï¼Œä½¿ç”¨å…¨è·¯å¾„ã€‚\n1 2 3 4 5 # user MACHINE= COMMANDS root ALL =ï¼ˆALLï¼‰ ALL ç”¨æˆ· æœºå™¨=ï¼ˆæˆæƒå“ªä¸ªè§’è‰²çš„æƒé™ï¼‰ /usr/sbin/useradd,/usr/sbin/passwd å¦‚æœä¸æˆæƒï¼Œé»˜è®¤æ˜¯ä¸èƒ½æ‰§è¡Œ useradd å‘½ä»¤çš„ #su - liuyalei //åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ· liuyalei$sudo /usr/sbin/useradd test //åˆ›å»º test ç”¨æˆ· æ³¨æ„ï¼Œ\nå‰é¢è¦åŠ ä¸Š sudoï¼Œæ‰“ä¸ªæ¯”æ–¹å°±æ˜¯ä¸€æŠŠé’¥åŒ™å¼€ä¸€æŠŠé”ã€‚ç¬¬ä¸€æ¬¡æ‰§è¡Œ sudo éœ€è¦è¾“å…¥æ™®é€šç”¨æˆ·å¯†ç ï¼Œé˜²\næ­¢è¢«éæ³•åˆ©ç”¨ã€‚ä¸‹æ¬¡ 5 åˆ†é’Ÿå†…ä¸éœ€è¦è¾“å…¥å¯†ç \nå¦‚æœä½ æ˜¯è¿ç»´ç»ç†ï¼Œå¸¦ä¸€ä¸ªå°å¼Ÿï¼Œä¸ä¼šå§æ•´ä¸ª root çš„æƒé™éƒ½ç»™ä»–ï¼Œåªç»™ä»–ä¸€äº›æ™®é€šæƒé™ã€‚ç›®çš„ï¼šæ—¢\nèƒ½è®©èœçš„è¿ç»´å¹²æ´»ï¼Œåˆä¸èƒ½å¨èƒç³»ç»Ÿå®‰å…¨\nå¦‚æœä½ æ˜¯å°å¼Ÿï¼Œä½ çš„è¿ç»´ç»å†è¦æŠŠè‡ªå·±çš„è´¦æˆ·æå‡æˆ rootï¼Œé‚£ä¹ˆç›´æ¥å¤åˆ¶ï¼ŒæŠŠ root æ”¹æˆç»ç†è´¦å·\nå³å¯ã€‚ä¸‹æ¬¡ç»ç†ç›´æ¥ä½¿ç”¨ sudo su - root å°±èƒ½åˆ‡åˆ° root æƒé™ä¸‹\nboss ALL =ï¼ˆALLï¼‰ ALL\nè¿™æ ·åšï¼Œboss æ—¢æœ‰äº† root æƒé™è¿˜ä¸çŸ¥é“ root çš„å¯†ç ï¼Œä½†æ˜¯æ¯æ¬¡åˆ‡åˆ° rootï¼Œéƒ½è¦è¾“å…¥ boss æ™®é€šç”¨\næˆ·å¯†ç ï¼Œå¤ªç¹çäº†ï¼Œå¯ä»¥åœ¨ visudo ä¸­æ”¹æˆå¦‚ä¸‹ï¼Œè¿™æ ·å°±ä¸ç”¨è¾“å…¥å¯†ç äº†ï¼Œä½†æ˜¯ä¸å®‰å…¨ã€‚\n1 boss ALL =ï¼ˆALLï¼‰ NOPASSWDï¼š ALL su å‘½ä»¤æ€»ç»“\næ™®é€šç”¨æˆ·åˆ‡æ¢åˆ° rootï¼Œä½¿ç”¨ su - æˆ–è€… su - root éœ€è¦è¾“å…¥ root å¯†ç \nè¶…çº§ç”¨æˆ·åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ·ä¸éœ€è¦å¯†ç ã€‚ä½†æ˜¯ centos5.8 ä¼šæœ‰ç¯å¢ƒå˜é‡é—®é¢˜ï¼Œéœ€è¦ç»™æ™®é€šç”¨æˆ·ä¿®æ”¹ç¯\nå¢ƒå˜é‡\nsu ä¼˜ç‚¹æ˜¯ç»™ç®¡ç†æœåŠ¡å™¨å¸¦æ¥æ–¹ä¾¿ï¼Œä½†æ˜¯ä»–çš„ç¼ºç‚¹å°±æ˜¯å¤§å®¶éƒ½çŸ¥é“ root çš„å¯†ç ï¼Œè€Œä¸”è¿˜èƒ½æ”¹æ‰ root\nçš„å¯†ç ã€‚åœ¨ä¸€å®šç¨‹åº¦ä¸Šï¼Œå¯¹æœåŠ¡å™¨å¸¦æ¥äº†å¾ˆå¤§çš„å®‰å…¨éšæ‚£ã€‚åœ¨å·¥ä½œç”¨å‡ ä¹æœ‰ä¸€åŠçš„é—®é¢˜æ¥è‡ªäºå†…éƒ¨\n5.ssh æœåŠ¡ linux é»˜è®¤ç®¡ç†å‘˜ rootï¼Œport ç«¯å£å·æ˜¯ 22ï¼Œä¸ºäº†å®‰å…¨ï¼Œæˆ‘ä»¬è¦æ”¹æ‰é»˜è®¤çš„ç®¡ç†å‘˜å’Œç«¯å£\né…ç½®æ–‡ä»¶/etc/ssh/sshd_config\n1 2 3 4 5 6 7 8 9 10 [root@oldboy ~]# vi /etc/ssh/sshd_config æ·»åŠ å¦‚ä¸‹å†…å®¹ä¿å­˜ã€‚ 52113#â†’ssh è¿æ¥é»˜è®¤çš„ç«¯å£ï¼Œè°éƒ½çŸ¥é“ï¼Œå¿…é¡»è¦æ”¹ã€‚ PermitRootLogin no#â†’root ç”¨æˆ·é»‘å®¢éƒ½çŸ¥é“çš„ï¼Œç¦æ­¢å®ƒè¿œç¨‹ç™»é™†ã€‚ PermitEmptyPasswords no #â†’ç¦æ­¢ç©ºå¯†ç ç™»é™† UseDNSno#â†’ä¸ä½¿ç”¨ DNS GSSAPIAuthentication no é‡å¯ sshd æœåŠ¡ # /etc/init.d/sshd restart æ³¨æ„ï¼šyumï¼Œrpm å®‰è£…çš„è½¯ä»¶ï¼Œå¯åŠ¨ç¨‹åºä¸€èˆ¬éƒ½åœ¨/etc/init.d\n6.ä¿®æ”¹ linux é»˜è®¤å­—ç¬¦é›† 1 2 3 4 [root@eric6 ~]# cat /etc/sysconfig/i18n //æŸ¥çœ‹ linux é»˜è®¤çš„å­—ç¬¦é›†ï¼Œé»˜è®¤æ˜¯ UTF-8 LANG=\u0026#34;zh_CN.UTF-8\u0026#34; cp /etc/sysconfig/i18n /etc/sysconfig/i18n.ori //å¤‡ä»½é»˜è®¤å­—ç¬¦é›† echo \u0026#39;LANG=\u0026#34;ZH_CN.GB18030\u0026#34;\u0026#39; \u0026gt;/etc/sysconfig/i18n //ä¿®æ”¹å­—ç¬¦é›†ä¸º GB18030 ä»€ä¹ˆæ˜¯å­—ç¬¦é›†ï¼Ÿ\nç®€å•çš„è¯´å°±æ˜¯ä¸€å¥—æ–‡å­—ç¬¦å·åŠå…¶ç¼–ç ã€‚å¸¸ç”¨çš„å­—ç¬¦é›†æœ‰ï¼š\nGBK å®šé•¿ åŒå­—èŠ‚ ä¸æ˜¯å›½é™…æ ‡å‡†ï¼Œæ”¯æŒçš„ç³»ç»Ÿä¸å°‘\nUTF-8 éå®šé•¿ 1-4 å­—èŠ‚ å¹¿æ³›æ”¯æŒï¼ŒMYSQL ä¹Ÿä½¿ç”¨ UTF-8\nè¿™ä¸ªä¸ä¸€å®šè¦ä¿®æ”¹ï¼Œæœ‰çš„å…¬å¸ä½¿ç”¨çš„å°±æ˜¯ UTF-8ï¼Œå› ä¸º linux å¯¹ä¸­æ–‡æ”¯æŒä¸å¥½\n7.æœåŠ¡å™¨æ—¶é—´åŒæ­¥ å¦‚æœæ—¶é—´ä¸åŒæ­¥ï¼Œç»å¸¸å¸¦æ¥ä¸šåŠ¡ä¸æ­£å¸¸ã€‚å¦‚æœå…¬å¸è§„æ¨¡å°ï¼Œå¯ä»¥ä½¿ç”¨è”ç½‘æ‰‹åŠ¨åŒæ­¥ï¼Œå¦‚æœæœåŠ¡å™¨å¤šï¼Œ\nå¯ä»¥åœ¨å…¬å¸å†…éƒ¨æ­å»º ntp serverã€‚è¿˜æœ‰ä¸€ç§å¯èƒ½æ˜¯å…¬å¸æœåŠ¡å™¨ä¸å‡ºå¤–ç½‘ï¼Œæ¯”å¦‚å†…éƒ¨æ•°æ®åº“æœåŠ¡å™¨ã€‚\nå¯ä»¥åœ¨å†…ç½‘æ­å»ºä¸¤å°æ—¶é—´æœåŠ¡å™¨ï¼Œå› ä¸ºä¸€å°å¯èƒ½ down æ‰ï¼Œæ­å»ºä¸¤å°å¯ä»¥åšåˆ°å†—ä½™çš„ç›®çš„ï¼ˆ50 å°-100\nå°ä»¥ä¸Šåœ¨ç”¨ï¼‰ã€‚\næ‰‹åŠ¨åŒæ­¥æ–¹æ³•ï¼š\n1 2 3 4 5 /sbin/ntpdate time.nist.gov //å¿…é¡»è¦è”ç½‘ /usr/sbin/ntpdate time.nist.gov //6.4 åœ¨/usr/sbin ä¸‹ è‡ªåŠ¨åŒæ­¥æ–¹æ³•ï¼ˆæ¯äº”åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼‰ï¼š echo \u0026#39;#time sync by oldboy at 2010-2-1\u0026#39; \u0026gt;\u0026gt;/var/spool/cron/root echo \u0026#39;*/5 * * * * /usr/sbin/ntpdate time.nist.gov \u0026gt;/dev/null 2\u0026gt;\u0026amp;1\u0026#39; \u0026gt;\u0026gt;/var/spool/cron/root 8.åŠ å¤§æœåŠ¡å™¨æ–‡ä»¶æè¿°ç¬¦ æœ€ç®€å•çš„è¯´ï¼Œåœ¨ unix/liux é‡Œé¢ï¼Œä½ çš„æœåŠ¡åªè¦å¼€å¯ä¸€ä¸ªè¿›ç¨‹ï¼Œå°±è¦å ç”¨æ–‡ä»¶æè¿°ç¬¦çš„ã€‚liunx é»˜è®¤æ˜¯ 1024ï¼Œå¦‚æœæè¿°ç¬¦å°‘äº†ï¼Œä½ çš„è®¿é—®é‡å¤šäº†ï¼Œä½ çš„æœåŠ¡å™¨æ”¯æ’‘ä¸äº†ï¼Œæ‰€ä»¥è¦æŠŠæè¿°ç¬¦åŠ å¤§ã€‚\n1 2 #echo \u0026#39;* - nofile 65535 \u0026#39; \u0026gt;\u0026gt;/etc/security/limits.conf #ulimit -n //æŸ¥çœ‹å½“å‰æ–‡ä»¶æè¿°ç¬¦æ•°é‡ æœ‰çš„æ—¶å€™ï¼Œä½ çš„æœåŠ¡å™¨ç¡¬ç›˜/å†…å­˜æ²¡é‚£ä¹ˆå¤§ï¼Œå¦‚æœæ–‡ä»¶æè¿°ç¬¦è¿‡å¤§ï¼Œè®¿é—®é‡è¿‡æ¥ï¼Œæœ‰å¯èƒ½æŠŠæœåŠ¡å™¨æå®ã€‚ä½†æ˜¯ç½‘å‹ä»¬é€šå¸¸éƒ½æ”¹æˆ 65535\n9.æ¸…ç† clientmqueue åƒåœ¾æ–‡ä»¶é˜²æ­¢ inode è¢«å æ»¡ 1 #find /var/spool/clientmqueue/ -type -f |xargs rm -f 10.è°ƒæ•´å†…æ ¸ä¼˜åŒ– æ‰€è°“å†…æ ¸ä¼˜åŒ–ï¼Œä¸»è¦æ˜¯åœ¨ linux ä¸­é’ˆå¯¹ä¸šåŠ¡æœåŠ¡åº”ç”¨è€Œè¿›è¡Œçš„ç³»ç»Ÿå†…æ ¸å‚æ•°ä¼˜åŒ–ï¼Œä¼˜åŒ–å¹¶æ— ç‰¹æ®Šçš„æ ‡å‡†ï¼Œä¸‹é¢ä»¥å¸¸è§ç”Ÿäº§ç¯å¢ƒ linux çš„å†…æ ¸ä¼˜åŒ–ä¸ºä¾‹è®²è§£ï¼Œä»…ä¾›å¤§å®¶å‚è€ƒï¼š\nå†…æ ¸è°ƒä¼˜\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 #vi /etc/sysctl.cof net.ipv4.tcp_fin_timeout = 2 net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_tw_recycle = 1 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_keepalive_time = 600 net.ipv4.ip_local_port_range = 4000 65000 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.tcp_max_tw_buckets = 36000 net.ipv4.route.gc_timeout = 100 net.ipv4.tcp_syn_retries = 1 net.ipv4.tcp_synack_retries = 1 net.core.somaxconn = 16384 12 net.core.netdev_max_backlog = 16384 net.ipv4.tcp_max_orphans = 16384 #ä»¥ä¸‹å‚æ•°æ˜¯å¯¹ iptables é˜²ç«å¢™çš„ä¼˜åŒ–ï¼Œé˜²ç«å¢™ä¸å¼€ä¼šæç¤ºï¼Œå¯ä»¥å¿½ç•¥ä¸ç†\n1 2 3 4 5 6 net.ipv4.ip_conntrack_max = 25000000 net.ipv4.netfilter.ip_conntrack_max=25000000 net.ipv4.netfilter.ip_conntrack_tcp_timeout_established=180 net.ipv4.netfilter.ip_conntrack_tcp_timeout_time_wait=120 net.ipv4.netfilter.ip_conntrack_tcp_timeout_close_wait=60 net.ipv4.netfilter.ip_conntrack_tcp_timeout_fin_wait=120 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 [root@eric6 ~]# sysctl -p //ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ net.ipv4.ip_forward = 0 net.ipv4.conf.default.rp_filter = 1 net.ipv4.conf.default.accept_source_route = 0 kernel.sysrq = 0 kernel.core_uses_pid = 1 net.ipv4.tcp_syncookies = 1 error: \u0026#34;net.bridge.bridge-nf-call-ip6tables\u0026#34; is an unknown key error: \u0026#34;net.bridge.bridge-nf-call-iptables\u0026#34; is an unknown key error: \u0026#34;net.bridge.bridge-nf-call-arptables\u0026#34; is an unknown key kernel.msgmnb = 65536 kernel.msgmax = 65536 kernel.shmmax = 68719476736 kernel.shmall = 4294967296 net.ipv4.tcp_fin_timeout = 2 net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_tw_recycle = 1 13 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_keepalive_time = 600 net.ipv4.ip_local_port_range = 4000 65000 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.tcp_max_tw_buckets = 36000 net.ipv4.route.gc_timeout = 100 net.ipv4.tcp_syn_retries = 1 net.ipv4.tcp_synack_retries = 1 net.core.somaxconn = 16384 net.core.netdev_max_backlog = 16384 net.ipv4.tcp_max_orphans = 16384 error: \u0026#34;net.ipv4.ip_conntrack_max\u0026#34; is an unknown key error: \u0026#34;net.ipv4.netfilter.ip_conntrack_max\u0026#34; is an unknown key error: \u0026#34;net.ipv4.netfilter.ip_conntrack_tcp_timeout_established\u0026#34; is an unknown key error: \u0026#34;net.ipv4.netfilter.ip_conntrack_tcp_timeout_time_wait\u0026#34; is an unknown key error: \u0026#34;net.ipv4.netfilter.ip_conntrack_tcp_timeout_close_wait\u0026#34; is an unknown key error: \u0026#34;net.ipv4.netfilter.ip_conntrack_tcp_timeout_fin_wait\u0026#34; is an unknown key é˜²ç«å¢™æœªå¼€å¯æŠ¥é”™ï¼Œä¸ç”¨ç®¡,5.8 çš„è¯ï¼Œä¸ä¼šæŠ¥é”™\n11.grep è®¾ç½®é«˜äº®æ˜¾ç¤º 1 2 3 [root@eric ~]# vi /etc/profile alias grep=\u0026#39;grep --color=auto\u0026#39; [root@eric ~]# source /etc/profile Ulimitç®¡ç†ç³»ç»Ÿèµ„æº å…·ä½“çš„ options å«ä¹‰ä»¥åŠç®€å•ç¤ºä¾‹å¯ä»¥å‚è€ƒä»¥ä¸‹è¡¨æ ¼ã€‚\nlinux ä¸Šä¼ ä¸‹è½½å°å·¥å…· 1 yum install lrzsz -y tcp/ip è°ƒä¼˜ sysctl å˜é‡ä¿®æ”¹æ–¹æ³•ï¼šsysctl â€“a\nä½¿ç”¨ sysctl å‘½ä»¤ä¿®æ”¹ç³»ç»Ÿå˜é‡ï¼Œå’Œé€šè¿‡ç¼–è¾‘ sysctl.conf æ–‡ä»¶æ¥ä¿®æ”¹ç³»ç»Ÿå˜é‡ä¸¤ç§ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„\nå˜é‡éƒ½å¯ä»¥åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹è®¾å®šã€‚\næ³¨ï¼šsysctl å˜é‡çš„è®¾ç½®é€šå¸¸æ˜¯å­—ç¬¦ä¸²ã€æ•°å­—æˆ–è€…å¸ƒå°”å‹ã€‚ (å¸ƒå°”å‹ç”¨ 1 æ¥è¡¨ç¤º\u0026rsquo;yes\u0026rsquo;ï¼Œç”¨ 0 æ¥è¡¨ç¤º\u0026rsquo;no\u0026rsquo;)ã€‚\n1 2 3 4 5 6 7 8 9 10 [root@localhost ~]#sysctl -w net.ipv4.tcp_keepalive_time=30 [root@localhost ~]#sysctl -w net.ipv4.tcp_keepalive_probes=2 [root@localhost ~]#sysctl -w net.ipv4.tcp_keepalive_intvl=2 [root@localhost~]# sysctl -a | grep keepalive net.ipv4.tcp_keepalive_time= 30 net.ipv4.tcp_keepalive_probes= 2 net.ipv4.tcp_keepalive_intvl= 2 æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä½¿å˜åŠ¨ç«‹å³ç”Ÿæ•ˆï¼š [root@localhost ~]# sysctl centos 6.4 å®‰è£…è½¯ä»¶åŒ…ï¼š\nè½¯ä»¶è‡ªå®šä¹‰-åŸºæœ¬\næ€§èƒ½å·¥å…·\nè°ƒè¯•å·¥å…·å…¼å®¹ç¨‹åºåº“Â å¼€å‘å·¥å…·\næœåŠ¡å™¨\u0026mdash;-ç³»ç»Ÿç®¡ç†å·¥å…·\nç³»ç»Ÿç®¡ç†\u0026mdash;snmp/ç³»ç»Ÿç®¡ç†\nä¼˜åŒ–æ€»ç»“\n01ï¼‰æ·»åŠ æ™®é€šç”¨æˆ·ï¼Œé€šè¿‡ sudo æˆæƒç®¡ç† 02ï¼‰å®šæ—¶è‡ªåŠ¨æ›´æ–°æœåŠ¡å™¨æ—¶é—´ 03ï¼‰é…ç½® yum æ›´æ–°æº 04ï¼‰å…³é—­ selinux å’Œ iptables 05ï¼‰è°ƒæ•´æ–‡ä»¶æè¿°ç¬¦æ•°é‡ 06ï¼‰å®šæ—¶è‡ªåŠ¨æ¸…ç†/var/spool/clientmquene/ç›®å½•åƒåœ¾æ–‡ä»¶ï¼Œé˜²æ­¢ inodes èŠ‚ç‚¹è¢«å æ»¡ 07ï¼‰ç²¾ç®€å¼€æœºè‡ªåŠ¨å¯åŠ¨æœåŠ¡ï¼ˆsshdï¼Œcrondï¼Œnetworkï¼Œsyslogï¼‰ 08ï¼‰å†…æ ¸å‚æ•°ä¼˜åŒ–/etc/sysctl.configï¼Œsysctl -p ç”Ÿæ•ˆ 09ï¼‰æ›´æ”¹é»˜è®¤ ssh æœåŠ¡ç«¯å£ï¼ŒåŠç¦æ­¢ root ç”¨æˆ·è¿œç¨‹ç™»é™† 10ï¼‰æ›´æ”¹å­—ç¬¦é›†ï¼Œæ”¯æŒä¸­æ–‡ 11ï¼‰é”å®šå…³é”®ç³»ç»Ÿæ–‡ä»¶ 1 2 3 4 5 chattr +i /etc/passwd chattr +i /etc/inittab chattr +i /etc/group chattr +i /etc/shadow chattr +i /etc/gshadow 12ï¼‰æ¸…ç©º/etc/issueï¼Œå»é™¤ç³»ç»ŸåŠå†…æ ¸ç‰ˆæœ¬ç™»é™†å‰çš„å±å¹•æ˜¾ç¤º 13ï¼‰æ›´æ”¹ç³»ç»Ÿç™»å½•åçš„ä¿¡æ¯ /etc/motd ","date":"2020-09-19T21:55:05Z","image":"https://www.ownit.top/title_pic/12.jpg","permalink":"https://www.ownit.top/p/202009192155/","title":"Linux å®‰è£…ååŸºæœ¬ä¼˜åŒ–æ“ä½œ"},{"content":"ä¸Šä¸€ç« èŠ‚ï¼Œè®²äº†è‡ªå·±æ‚²å‰§çš„åˆ åº“äº‹ä»¶ã€‚\nåŸå› æ€»ç»“ï¼š\nï¼ˆ1ï¼‰æ‰‹è´±\nï¼ˆ2ï¼‰è¿˜æ˜¯æ‰‹è´±\nï¼ˆ3ï¼‰ä¸è¿‡å¤§è„‘\nï¼ˆ4ï¼‰Linuxæ²¡æœ‰å›æ”¶ç«™åŠŸèƒ½\nä¿—è¯è¯´ï¼Œåƒä¸€å ‘é•¿ä¸€æ™ºã€‚æ¥ä¸‹æ¥å°±æ˜¯æˆ‘çš„è§£å†³æ–¹æ¡ˆã€‚\nç»™Linuxæ·»åŠ ä¸€ä¸ªå›æ”¶ç«™çš„åŠŸèƒ½ï¼Œè¿™æ˜¯ä¸æ˜¯å¾ˆé«˜å¤§ä¸Šå•Š\nè¿™ä¸‹å°±ä¸æ€•æ‰‹è´±åˆ åº“äº†\næ‰‹è¯¯ã€åˆ åº“ã€‘ == è·‘è·¯ï¼Œä¸å­˜åœ¨çš„ â€”â€”åˆ ç“¦è¾›æ ¼ åˆ é™¤æ˜¯å±é™©ç³»æ•°å¾ˆé«˜çš„æ“ä½œï¼Œä¸€æ—¦è¯¯åˆ å¯èƒ½ä¼šé€ æˆéš¾ä»¥ä¼°è®¡çš„æŸå¤±ã€‚\nåœ¨ Linux ç³»ç»Ÿä¸­è¿™ç§å±é™©å°¤ä¸ºæ˜æ˜¾ï¼Œä¸€æ¡ç®€å•çš„è¯­å¥ï¼šrm â€“rf /* å°±ä¼šæŠŠæ•´ä¸ªç³»ç»Ÿå…¨éƒ¨åˆ é™¤ï¼Œè€Œ Linux å¹¶ä¸ä¼šå› ä¸ºè¿™æ¡è¯­å¥çš„ä¸åˆç†è€Œæ‹’ç»æ‰§è¡Œã€‚\nè¿™æ—¶ï¼Œæœ‰ä¸ªåƒWindowsçš„é‚£æ ·çš„å›æ”¶ç«™æ˜¯å¤šä¹ˆçš„é‡è¦å•Šã€‚ä¸‹é¢å¯ä»¥ä½¿ç”¨ä»£ç å®ç°\nrmå‘½ä»¤ä¿®æ”¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 vim /etc/bashrc alias rm=delete #å‘½ä»¤åˆ«åï¼Œé€šè¿‡deleteæ¥å®ç°rmæ”¹ä¸ºmv alias r=delete alias rl=\u0026#39;ls /trash\u0026#39; #rl å‘½ä»¤æ˜¾ç¤ºå›æ”¶ç«™ä¸­çš„æ–‡ä»¶ alias ur=undelfile #ur å‘½ä»¤æ‰¾å›å›æ”¶ç«™çš„æ–‡ä»¶ undelfile() { mv /trash/$@ ./ } delete() { if [ ! -d \u0026#34;/trash/\u0026#34; ];then mkdir /trash fi \\mv --backup=numbered $@ /trash/ } cleartrash() { read -p \u0026#34;clear sure?[n]\u0026#34; confirm [ $confirm == \u0026#39;y\u0026#39; ] || [ $confirm == \u0026#39;Y\u0026#39; ] \u0026amp;\u0026amp; /bin/rm -rf /trash/* } æ·»åŠ å®Œæ¯•åä¿å­˜ï¼Œæ‰§è¡Œsourceå‘½ä»¤ç”Ÿæ•ˆ\n1 source /etc/bashrc ä½¿ç”¨æ–¹æ³• ä»¥ä½¿ç”¨rmï¼ˆåˆ é™¤ï¼‰ï¼Œurï¼ˆæ’¤é”€ï¼‰ï¼Œrlï¼ˆåˆ—å‡ºå›æ”¶ç«™ï¼‰ï¼Œcleartrashï¼ˆæ¸…ç©ºå›æ”¶ç«™ï¼‰å‘½ä»¤äº†ã€‚\nåˆ é™¤ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œhellworldä¸‹é¢çš„æ–‡ä»¶å‡è¢«ç§»åˆ°å›æ”¶ç«™ä¸­\n1 rm helloworld/ æˆ–è€… r helloworld/ æˆ–è€… delete helloworld/ åˆ é™¤ä¸€ä¸ªæ–‡ä»¶\n1 rm 123.txt æˆ–è€… r 123.txt æˆ–è€… delete 123.txt åˆ—å‡ºå›æ”¶ç«™ä¿¡æ¯\nè¦æŸ¥çœ‹å›æ”¶ç«™å†…å®¹è¯¦ç»†ä¿¡æ¯ï¼Œåªè¦åŠ ä¸ªå‚æ•°å°±å¥½\næ’¤é”€123.txt\n1 ur 123.txt æˆ–è€… undelfile 123.txt æ’¤é”€helloworldæ–‡ä»¶å¤¹\n1 ur helloworld æˆ–è€… undelfile helloworld æ¸…ç©ºå›æ”¶ç«™\n1 2 3 [root@Master ~]# cleartrash #ä¼šå¼¹å‡ºæ˜¯å¦æ¸…ç©º clear sure?[n]y [root@Master ~]# åˆ åº“ï¼Œæˆ‘å®³æ€•åˆ åº“å— ","date":"2020-07-27T23:14:37Z","image":"https://www.ownit.top/title_pic/55.jpg","permalink":"https://www.ownit.top/p/202007272314/","title":"æ‰‹è¯¯ã€åˆ åº“ã€‘ == è·‘è·¯ï¼Œä¸å­˜åœ¨çš„    Linuxå›æ”¶ç«™"},{"content":"æ•°æ®å¤‡ä»½æ˜¯å®¹ç¾çš„åŸºç¡€ï¼Œæ˜¯æŒ‡ä¸ºé˜²æ­¢ç³»ç»Ÿå‡ºç°æ“ä½œå¤±è¯¯æˆ–ç³»ç»Ÿæ•…éšœå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œè€Œå°†å…¨éƒ¨æˆ–éƒ¨åˆ†æ•°æ®é›†åˆä»åº”ç”¨ä¸»æœºçš„ç¡¬ç›˜æˆ–é˜µåˆ—å¤åˆ¶åˆ°å…¶å®ƒçš„å­˜å‚¨ä»‹è´¨çš„è¿‡ç¨‹ã€‚ä¼ ç»Ÿçš„æ•°æ®å¤‡ä»½ä¸»è¦æ˜¯é‡‡ç”¨å†…ç½®æˆ–å¤–ç½®çš„ç£å¸¦æœºè¿›è¡Œå†·å¤‡ä»½ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼åªèƒ½é˜²æ­¢æ“ä½œå¤±è¯¯ç­‰äººä¸ºæ•…éšœï¼Œè€Œä¸”å…¶æ¢å¤æ—¶é—´ä¹Ÿå¾ˆé•¿ã€‚éšç€æŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œæ•°æ®çš„æµ·é‡å¢åŠ ï¼Œä¸å°‘çš„ä¼ä¸šå¼€å§‹é‡‡ç”¨ç½‘ç»œå¤‡ä»½ã€‚ç½‘ç»œå¤‡ä»½ä¸€èˆ¬é€šè¿‡ä¸“ä¸šçš„æ•°æ®å­˜å‚¨ç®¡ç†è½¯ä»¶ç»“åˆç›¸åº”çš„ç¡¬ä»¶å’Œå­˜å‚¨è®¾å¤‡æ¥å®ç°ã€‚\nå®ç°åŸºç¡€æ¶æ„å›¾\n1ã€åŸºæœ¬å¤‡ä»½è¦æ±‚ å·²çŸ¥3å°æœåŠ¡å™¨ä¸»æœºååˆ†åˆ«ä¸ºweb01ï¼Œbackupã€nfs01ï¼Œä¸»æœºä¿¡æ¯è§ä¸‹è¡¨ï¼š\nè¦æ±‚ï¼š\næ¯å¤©æ™šä¸Š00ç‚¹æ•´åœ¨WebæœåŠ¡å™¨ä¸Šæ‰“åŒ…å¤‡ä»½ç³»ç»Ÿé…ç½®æ–‡ä»¶ã€ç½‘ç«™ç¨‹åºç›®å½•åŠè®¿é—®æ—¥å¿—ï¼Œ\né€šè¿‡rsyncå‘½ä»¤æ¨é€å¤‡ä»½æœåŠ¡å™¨backupä¸Šå¤‡ä»½ä¿ç•™\nï¼ˆå¤‡ä»½æ€è·¯å¯ä»¥æ˜¯å…ˆåœ¨æœ¬åœ°æŒ‰æ—¥æœŸæ‰“åŒ…ï¼Œç„¶åå†æ¨åˆ°å¤‡ä»½æœåŠ¡å™¨backupä¸Šï¼‰\nå…·ä½“è¦æ±‚å¦‚ä¸‹ï¼š\n1ï¼‰WebæœåŠ¡å™¨å’Œå¤‡ä»½æœåŠ¡å™¨çš„å¤‡ä»½ç›®å½•å¿…é¡»éƒ½ä¸º/backup\n2ï¼‰è¦å¤‡ä»½çš„ç³»ç»Ÿé…ç½®æ–‡ä»¶åŒ…æ‹¬ä½†ä¸é™äºï¼š\na.å®šæ—¶ä»»åŠ¡æœåŠ¡çš„é…ç½®æ–‡ä»¶ï¼ˆvar/spool/cron/rootï¼‰ã€‚.\nb.å¼€æœºè‡ªå¯åŠ¨çš„é…ç½®æ–‡ä»¶ï¼ˆ/etc/rc.localï¼‰\nc.æ—¥å¸¸è„šæœ¬çš„ç›®å½•ï¼ˆ/server/scriptsï¼‰\nd.é˜²ç«å¢™iptablesçš„é…ç½®æ–‡ä»¶ï¼ˆ/etc/sysconfig/iptablesï¼‰ã€‚.\ne.è‡ªå·±æ€è€ƒä¸‹è¿˜æœ‰ä»€ä¹ˆéœ€è¦å¤‡ä»½å‘¢ï¼Ÿ\n3ï¼‰WebæœåŠ¡å™¨ç«™ç‚¹ç›®å½•å‡å®šä¸ºï¼ˆvar/htm/wwwï¼‰.\n4ï¼‰WebæœåŠ¡å™¨Aè®¿é—®æ—¥å¿—è·¯å¾„å‡å®šä¸ºï¼ˆ/app/logsï¼‰.\n5ï¼‰WebæœåŠ¡å™¨ä¿ç•™æ‰“åŒ…åçš„7å¤©çš„å¤‡ä»½æ•°æ®å³å¯ï¼ˆæœ¬åœ°ç•™å­˜ä¸èƒ½å¤šäº7å¤©ï¼Œå› ä¸ºå¤ªå¤šç¡¬ç›˜ä¼šæ»¡ï¼‰\n6ï¼‰å¤‡ä»½æœåŠ¡å™¨ä¸Šï¼Œä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½æ•°æ®ï¼ŒåŒæ—¶ä¿ç•™6ä¸ªæœˆå†…æ¯å‘¨ä¸€çš„æ‰€æœ‰æ•°æ®å‰¯æœ¬ã€‚\n7ï¼‰å¤‡ä»½æœåŠ¡å™¨ä¸Šè¦æŒ‰ç…§å¤‡ä»½æ•°æ®æœåŠ¡å™¨çš„å†…ç½‘IPä¸ºç›®å½•ä¿å­˜å¤‡ä»½ï¼Œå¤‡ä»½çš„æ–‡ä»¶æŒ‰ç…§æ—¶é—´åå­—ä¿å­˜ã€‚\n8ï¼‰éœ€è¦ç¡®ä¿å¤‡ä»½çš„æ•°æ®å°½é‡å®Œæ•´æ€§ï¼Œåœ¨å¤‡ä»½æœåŠ¡å™¨ä¸Šå¯¹å¤‡ä»½çš„æ•°æ®è¿›è¡Œæ£€æŸ¥ï¼ŒæŠŠå¤‡ä»½çš„æˆåŠŸåŠå¤±è´¥ç»“æœä¿¡æ¯å‘ç»™ç³»ç»Ÿç®¡ç†å‘˜é‚®ç®±ä¸­\næ•°æ®å¤‡ä»½é¡¹ç›®å®æˆ˜ï¼š\nè§£é¢˜æ€è·¯\n1ã€æ­å»ºbackupæœåŠ¡å™¨\naã€resyncæœåŠ¡å™¨\n2ã€æ­å»ºweb01æœåŠ¡å™¨\naã€éªŒè¯rsyncæœåŠ¡å™¨èƒ½å¦æ¨é€æˆåŠŸ\nbã€å¼€å‘è„šæœ¬å®ç°æ‰“åŒ…ï¼Œå¤‡ä»½ï¼Œæ¨é€ï¼Œæ ¡æ£€ï¼Œåˆ é™¤\ncã€é…ç½®å®šæ—¶ä»»åŠ¡æ¯å¤©0ç‚¹å®šæ—¶æ¨é€\n3ã€backupæœåŠ¡å™¨\naã€å¼€å‘è„šæœ¬å®ç°æ ¡æ£€ï¼Œåˆ é™¤ã€æŠ¥è­¦\nbã€é…ç½®å®šæ—¶ä»»åŠ¡æ¯å¤©6ç‚¹å®šæ—¶æ‰§è¡Œ\n4ã€åŒç†æ­å»ºå­˜å‚¨nfs01æœåŠ¡å™¨\n2ã€é¡¹ç›®å®æ–½ é…ç½®æ‰€æœ‰hostsæœåŠ¡å™¨ 1 2 3 4 5 cat \u0026gt;\u0026gt; /etc/hosts \u0026lt;\u0026lt;EOF 192.168.116.129 web 192.168.116.130 backup 192.168.116.131 nfs EOF backupæœåŠ¡å™¨å®‰è£…rsync 1 yum install -y rsync 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 [root@backup ~]# useradd -s /sbin/nologin -M rsync [root@backup ~]# id rsync uid=1001(rsync) gid=1001(rsync) ç»„=1001(rsync) [root@backup ~]# vim /etc/rsyncd.conf port=873 uid = rsync gid = rsync use chroot = no max connections = 200 timeout = 300 motd file = /var/rsyncd/rsync.motd pid file = /var/run/rsyncd.pid lock file = /var/run/rsync.lock log file = /var/log/rsyncd.log dont compress = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2 [backup] path = /backup/ ignore errorsread only = false write only = false list = falsehosts allow = 192.168.116.0/24 hosts deny = 0.0.0.0/32 auth users = rsync_backup secrets file = /etc/rsyncd.passwd 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 ######### å…¨å±€é…ç½®å‚æ•° ########## port=888 # æŒ‡å®šrsyncç«¯å£ã€‚é»˜è®¤873 uid = rsync # rsyncæœåŠ¡çš„è¿è¡Œç”¨æˆ·ï¼Œé»˜è®¤æ˜¯nobodyï¼Œæ–‡ä»¶ä¼ è¾“æˆåŠŸåå±ä¸»å°†æ˜¯è¿™ä¸ªuid gid = rsync # rsyncæœåŠ¡çš„è¿è¡Œç»„ï¼Œé»˜è®¤æ˜¯nobodyï¼Œæ–‡ä»¶ä¼ è¾“æˆåŠŸåå±ç»„å°†æ˜¯è¿™ä¸ªgid use chroot = no # rsync daemonåœ¨ä¼ è¾“å‰æ˜¯å¦åˆ‡æ¢åˆ°æŒ‡å®šçš„pathç›®å½•ä¸‹ï¼Œå¹¶å°†å…¶ç›‘ç¦åœ¨å†… max connections = 200 # æŒ‡å®šæœ€å¤§è¿æ¥æ•°é‡ï¼Œ0è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ timeout = 300 # ç¡®ä¿rsyncæœåŠ¡å™¨ä¸ä¼šæ°¸è¿œç­‰å¾…ä¸€ä¸ªå´©æºƒçš„å®¢æˆ·ç«¯ï¼Œ0è¡¨ç¤ºæ°¸è¿œç­‰å¾… motd file = /var/rsyncd/rsync.motd # å®¢æˆ·ç«¯è¿æ¥è¿‡æ¥æ˜¾ç¤ºçš„æ¶ˆæ¯ pid file = /var/run/rsyncd.pid # æŒ‡å®šrsync daemonçš„pidæ–‡ä»¶ lock file = /var/run/rsync.lock # æŒ‡å®šé”æ–‡ä»¶ log file = /var/log/rsyncd.log # æŒ‡å®šrsyncçš„æ—¥å¿—æ–‡ä»¶ï¼Œè€Œä¸æŠŠæ—¥å¿—å‘é€ç»™syslog dont compress = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2 # æŒ‡å®šå“ªäº›æ–‡ä»¶ä¸ç”¨è¿›è¡Œå‹ç¼©ä¼ è¾“ ###########ä¸‹é¢æŒ‡å®šæ¨¡å—ï¼Œå¹¶è®¾å®šæ¨¡å—é…ç½®å‚æ•°ï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªæ¨¡å—########### [longshuai] # æ¨¡å—ID path = /longshuai/ # æŒ‡å®šè¯¥æ¨¡å—çš„è·¯å¾„ï¼Œè¯¥å‚æ•°å¿…é¡»æŒ‡å®šã€‚å¯åŠ¨rsyncæœåŠ¡å‰è¯¥ç›®å½•å¿…é¡»å­˜åœ¨ã€‚rsyncè¯·æ±‚è®¿é—®æ¨¡å—æœ¬è´¨å°±æ˜¯è®¿é—®è¯¥è·¯å¾„ã€‚ ignore errors # å¿½ç•¥æŸäº›IOé”™è¯¯ä¿¡æ¯ read only = false # æŒ‡å®šè¯¥æ¨¡å—æ˜¯å¦å¯è¯»å†™ï¼Œå³èƒ½å¦ä¸Šä¼ æ–‡ä»¶ï¼Œfalseè¡¨ç¤ºå¯è¯»å†™ï¼Œtrueè¡¨ç¤ºå¯è¯»ä¸å¯å†™ã€‚æ‰€æœ‰æ¨¡å—é»˜è®¤ä¸å¯ä¸Šä¼  write only = false # æŒ‡å®šè¯¥æ¨¡å¼æ˜¯å¦æ”¯æŒä¸‹è½½ï¼Œè®¾ç½®ä¸ºtrueè¡¨ç¤ºå®¢æˆ·ç«¯ä¸èƒ½ä¸‹è½½ã€‚æ‰€æœ‰æ¨¡å—é»˜è®¤å¯ä¸‹è½½ list = false # å®¢æˆ·ç«¯è¯·æ±‚æ˜¾ç¤ºæ¨¡å—åˆ—è¡¨æ—¶ï¼Œè¯¥æ¨¡å—æ˜¯å¦æ˜¾ç¤ºå‡ºæ¥ï¼Œè®¾ç½®ä¸ºfalseåˆ™è¯¥æ¨¡å—ä¸ºéšè—æ¨¡å—ã€‚é»˜è®¤true hosts allow = 10.0.0.0/24 # æŒ‡å®šå…è®¸è¿æ¥åˆ°è¯¥æ¨¡å—çš„æœºå™¨ï¼Œå¤šä¸ªipç”¨ç©ºæ ¼éš”å¼€æˆ–è€…è®¾ç½®åŒºé—´ hosts deny = 0.0.0.0/32 # æŒ‡å®šä¸å…è®¸è¿æ¥åˆ°è¯¥æ¨¡å—çš„æœºå™¨ auth users = rsync_backup # æŒ‡å®šè¿æ¥åˆ°è¯¥æ¨¡å—çš„ç”¨æˆ·åˆ—è¡¨ï¼Œåªæœ‰åˆ—è¡¨é‡Œçš„ç”¨æˆ·æ‰èƒ½è¿æ¥åˆ°æ¨¡å—ï¼Œç”¨æˆ·åå’Œå¯¹åº”å¯†ç ä¿å­˜åœ¨secrts fileä¸­ï¼Œ # è¿™é‡Œä½¿ç”¨çš„ä¸æ˜¯ç³»ç»Ÿç”¨æˆ·ï¼Œè€Œæ˜¯è™šæ‹Ÿç”¨æˆ·ã€‚ä¸è®¾ç½®æ—¶ï¼Œé»˜è®¤æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½è¿æ¥ï¼Œä½†ä½¿ç”¨çš„æ˜¯åŒ¿åè¿æ¥ secrets file = /etc/rsyncd.passwd # ä¿å­˜auth usersç”¨æˆ·åˆ—è¡¨çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œæ¯è¡ŒåŒ…å«ä¸€ä¸ªusername:passwdã€‚ç”±äº\u0026#34;strict modes\u0026#34; # é»˜è®¤ä¸ºtrueï¼Œæ‰€ä»¥æ­¤æ–‡ä»¶è¦æ±‚érsync daemonç”¨æˆ·ä¸å¯è¯»å†™ã€‚åªæœ‰å¯ç”¨äº†auth usersè¯¥é€‰é¡¹æ‰æœ‰æ•ˆã€‚ [xiaofang] # ä»¥ä¸‹å®šä¹‰çš„æ˜¯ç¬¬äºŒä¸ªæ¨¡å— path=/xiaofang/ read only = false ignore errors comment = anyone can access æˆæƒ\n1 2 3 4 [root@backup ~]# mkdir -p /backup [root@backup ~]# chown -R rsync.rsync /backup/ [root@backup ~]# ls -ld /backup/ drwxr-xr-x 2 rsync rsync 6 6æœˆ 17 10:39 /backup/ é…ç½®å¯†ç \n1 2 3 4 5 6 7 8 â€‹ [root@backup ~]# touch /etc/rsyncd.passwd [root@backup ~]# echo \u0026#34;rsync_backup:root\u0026#34; \u0026gt; /etc/rsyncd.passwd [root@backup ~]# chmod 600 /etc/rsyncd.passwd [root@backup ~]# ls -ld /etc/rsyncd.passwd -rw------- 1 root root 18 6æœˆ 17 10:42 /etc/rsyncd.passwd â€‹ é‡å¯çœ‹æ˜¯å¦æˆåŠŸ\n1 2 3 4 [root@backup ~]# rsync --daemon [root@backup ~]# ss -lntup | grep rsync tcp LISTEN 0 5 *:873 *:* users:((\u0026#34;rsync\u0026#34;,pid=2280,fd=4)) tcp LISTEN 0 5 :::873 :::* users:((\u0026#34;rsync\u0026#34;,pid=2280,fd=5)) å¼€æœºè‡ªå¯åŠ¨\n1 2 3 4 5 [root@backup ~]# which rsync /usr/bin/rsync [root@backup ~]# echo \u0026#34;/usr/bin/rsync --daemon\u0026#34; \u0026gt;\u0026gt; /etc/rc.local [root@backup ~]# tail -1 /etc/rc.local /usr/bin/rsync --daemon webæœåŠ¡å™¨æµ‹è¯• rsyncæœåŠ¡å™¨æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚\nä¸‹é¢æµ‹è¯•ï¼Œæ˜¾ç¤ºæˆåŠŸ\n1 2 3 4 5 6 7 8 9 [root@web backup]# echo \u0026#34;root\u0026#34; \u0026gt;\u0026gt; /etc/rsync.password [root@web backup]# chmod 600 /etc/rsync.password [root@web backup]# rsync -avz /backup/ rsync://rsync_backup@192.168.116.130/backup --password-file=/etc/rsy nc.password sending incremental file list rsync: chgrp \u0026#34;.\u0026#34; (in backup) failed: Operation not permitted (1) ./ mysql-5.7.28-linux-glibc2.12-x86_64.tar.gz å¦ä¸€ç§ä¼ è¾“æ–¹æ³•Â 1 rsync -avz /backup/ rsync_backup@192.168.116.130::backup --password-file=/etc/rsync.password webæœåŠ¡å™¨ï¼Œåˆ›å»ºæ¨¡æ‹Ÿæ•°æ®\n1 2 3 4 5 6 [root@web backup]# [root@web backup]# mkdir /var/html/www -p [root@web backup]# cd /var/html/www/ [root@web www]# touch {1..10} [root@web www]# mkdir -p /app/logs [root@web www]# touch /app/logs/{a..g} å¤‡ä»½è„šæœ¬å­˜æ”¾ç›®å½•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 [root@web www]# mkdir -p /server/scripts vim /server/scripts/bak.sh #!/bin/sh export PATH=/sbin:/bin:/usr/sbin:/usr/bin IP=$(ifconfig ens33|awk -F \u0026#34;[ :]+\u0026#34; \u0026#39;NR==2{print $3}\u0026#39;) BakPath=/backup mkdir $BakPath/$IP -p if [ $(date +%w) -eq 2 ];then date=\u0026#34;$(date +%F -d \u0026#34;-1day\u0026#34;)_week1\u0026#34; else date=\u0026#34;$(date +%F -d \u0026#34;-1day\u0026#34;)\u0026#34; fi cd / \u0026amp;\u0026amp;\\ tar zcfh $BakPath/$IP/sys_config_${date}.tar.gz var/spool/cron etc/rc.local server/scripts \u0026amp;\u0026amp;\\ tar zcfh $BakPath/$IP/webdata_${date}.tar.gz var/html/www/ \u0026amp;\u0026amp;\\ tar zcf $BakPath/$IP/access_log_${date}.tar.gz app/logs \u0026amp;\u0026amp;\\ find $BakPath -type f -name \u0026#34;*.tar.gz\u0026#34;|xargs md5sum \u0026gt;$BakPath/$IP/flag_${date} ###bak data rsync -az $BakPath/ rsync_backup@192.168.116.130::backup --password-file=/etc/rsync.password ###del data 7 days ago. find $BakPath -type f -mtime +7|xargs rm -f æ•°æ®æ ¡æ£€MD5sum\nå®šæ—¶ä»»åŠ¡\n1 2 #backup 00 00 * * * /bin/sh /server/scripts/bak.sh \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 BackupæœåŠ¡å™¨æ ¡æ£€ï¼Œåˆ é™¤ï¼ŒæŠ¥è­¦ backupå¤‡ä»½æ¨é€ç±»å®¹\né‚®ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 yum install mailx -y vim /etc/mail.rc #è®¾ç½®å‘ä»¶äººåç§° set from=32915245@qq.com #è®¾ç½®é‚®ä»¶æœåŠ¡å™¨ set smtp=smtp.qq.com #å¡«å†™è‡ªå·±é‚®ç®±åœ°å€ set smtp-auth-user=3291245@qq.com #è¾“å…¥é‚®ç®±éªŒè¯ç  set smtp-auth-password=wrgcmeapjw #smtpçš„è®¤è¯æ–¹å¼ï¼Œé»˜è®¤æ˜¯login set smtp-auth=login æµ‹è¯•ã€å·²ç»å®Œæˆã€‘\n1 echo \u0026#34;admin ,æ–‡ä»¶å†…å®¹\u0026#34; | mail -s \u0026#34;æ ‡é¢˜\u0026#34; ä½ çš„qq@qq.com æ£€éªŒæ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 vim /server/scripts/checkbak.sh #!/bin/sh export LANG=en find /backup/ -name \u0026#34;flag_$(date +%F -d \u0026#34;-1day\u0026#34;)*\u0026#34;|xargs md5sum -c \u0026amp;\u0026gt;\u0026gt;/tmp/mail_$(date +%F).log if [ $(date +%w) -eq 2 ];then date=\u0026#34;$(date +%F -d \u0026#34;-1day\u0026#34;)_week1\u0026#34; else date=\u0026#34;$(date +%F -d \u0026#34;-1day\u0026#34;)\u0026#34; fi find /backup/ -type f -name \u0026#34;*.tar.gz\u0026#34; -a ! -name \u0026#34;*week1*\u0026#34; -mtime +1|xargs rm -f mail -s \u0026#34;backup `date`\u0026#34; 1794748404@qq.com \u0026lt;/tmp/mail_$(date +%F).log \\cp /tmp/mail_$(date +%F).log /tmp/mail_$(date +%F).log.ori \u0026gt;/tmp/mail_$(date +%F).log å®šæ—¶ä»»åŠ¡\n1 2 #backup 00 06 * * * /bin/sh /server/scripts/checkbak.sh \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 æ­£ç¡®\né”™è¯¯\nç„¶åå¯ä»¥æŠŠè„šæœ¬ä½¿ç”¨ansibleæ‰¹é‡å‘å¸ƒå„ä¸ªä¸»æœºï¼Œç„¶åå°±å¯ä»¥å¤§è§„æ¨¡é›†ç¾¤å¤‡ä»½\n","date":"2020-07-25T17:59:29Z","image":"https://www.ownit.top/title_pic/39.jpg","permalink":"https://www.ownit.top/p/202007251759/","title":"å¤§è§„æ¨¡é›†ç¾¤å…¨ç½‘æ•°æ®å¤‡ä»½è§£å†³æ–¹æ¡ˆ"},{"content":"Nginxé…ç½®é˜²ç›—é“¾ 1.ä»€ä¹ˆæ˜¯èµ„æºç›—é“¾ ç®€å•åœ°è¯´ï¼Œå°±æ˜¯æŸäº›ä¸æ³•ç½‘ç«™æœªç»è®¸å¯ï¼Œé€šè¿‡åœ¨å…¶è‡ªèº«ç½‘ç«™ç¨‹åºé‡Œéæ³•è°ƒç”¨å…¶ä»–ç½‘ç«™çš„èµ„æºï¼Œç„¶ååœ¨è‡ªå·±çš„ç½‘ç«™ä¸Šæ˜¾ç¤ºè¿™äº›è°ƒç”¨çš„èµ„æºï¼Œè¾¾åˆ°å¡«å……è‡ªèº«ç½‘ç«™çš„æ•ˆæœã€‚è¿™ä¸€ä¸¾åŠ¨ä¸ä»…æµªè´¹äº†è°ƒç”¨èµ„æºç½‘ç«™çš„ç½‘ç»œæµé‡ï¼Œè¿˜é€ æˆå…¶ä»–ç½‘ç«™çš„å¸¦å®½åŠæœåŠ¡å‹åŠ›åƒç´§ï¼Œç”šè‡³å®•æœºã€‚\n**Â 2.ç½‘ç«™èµ„æºè¢«ç›—é“¾å¸¦æ¥çš„é—®é¢˜** è‹¥ç½‘ç«™å›¾ç‰‡åŠç›¸å…³èµ„æºè¢«ç›—é“¾ï¼Œæœ€ç›´æ¥çš„å½±å“å°±æ˜¯ç½‘ç»œå¸¦å®½å ç”¨åŠ å¤§äº†ï¼Œå¸¦å®½è´¹ç”¨å¤šäº†ï¼Œç½‘ç»œæµé‡ä¹Ÿå¯èƒ½å¿½é«˜å¿½ä½ï¼ŒNagios/Zabbixç­‰æŠ¥è­¦æœåŠ¡é¢‘ç¹æŠ¥è­¦\næœ€ä¸¥é‡çš„æƒ…å†µå°±æ˜¯ç½‘ç«™çš„èµ„æºè¢«éæ³•ä½¿ç”¨ï¼Œä½¿ç½‘ç«™å¸¦å®½æˆæœ¬åŠ å¤§å’ŒæœåŠ¡å™¨å‹åŠ›åŠ å¤§ï¼Œè¿™æœ‰å¯èƒ½å¯¼è‡´æ•°ä¸‡å…ƒçš„æŸå¤±ï¼Œä¸”ç½‘ç«™çš„æ­£å¸¸ç”¨æˆ·è®¿é—®ä¹Ÿä¼šå—åˆ°å½±å“\n3.ä¼ä¸šçœŸå®æ¡ˆä¾‹ï¼šç½‘ç«™èµ„æºè¢«ç›—é“¾ï¼Œå‡ºç°ä¸¥é‡é—®é¢˜ æŸæ—¥ï¼Œæ¥åˆ°ä»äº‹è¿ç»´å·¥ä½œçš„æœ‹å‹çš„ç´§æ€¥æ±‚åŠ©ï¼Œå…¶å…¬å¸çš„CDNæºç«™ï¼Œæºç«™çš„æµé‡æ²¡æœ‰å˜åŠ¨ï¼Œä½†CDNåŠ é€Ÿé‚£è¾¹çš„æµé‡æ— æ•…è¶…äº†å¥½å‡ ä¸ªGBï¼Œä¸çŸ¥é“æ€ä¹ˆå¤„ç†ã€‚\nè¯¥æ•…éšœçš„å½±å“ï¼šç”±äºæ˜¯è´­ä¹°çš„CDNç½‘ç«™åŠ é€ŸæœåŠ¡ï¼Œå› æ­¤è™½ç„¶æµé‡å¤šäº†å‡ ä¸ªGBï¼Œä½†æ˜¯ä¸šåŠ¡æœªå—å½±å“ã€‚åªæ˜¯ï¼Œè¿™ä¹ˆå¤§çš„å¼‚å¸¸æµé‡ï¼ŒæŒç»­ä¸‹å»å¯ç›´æ¥å¯¼è‡´å…¬å¸æ— æ•…æŸå¤±æ•°ä¸‡å…ƒã€‚è§£å†³è¿™ä¸ªé—®é¢˜å¯ä½“ç°è¿ç»´çš„ä»·å€¼ã€‚\n4.å¸¸è§é˜²ç›—é“¾è§£å†³æ–¹æ¡ˆçš„åŸºæœ¬åŸç† ï¼ˆ1ï¼‰æ ¹æ®HTTP refererå®ç°é˜²ç›—é“¾ åœ¨HTTPåè®®ä¸­ï¼Œæœ‰ä¸€ä¸ªè¡¨å¤´å­—æ®µå«refererï¼Œä½¿ç”¨URLæ ¼å¼æ¥è¡¨ç¤ºæ˜¯å“ªé‡Œçš„é“¾æ¥ç”¨äº†å½“å‰ç½‘é¡µçš„èµ„æºã€‚é€šè¿‡refererå¯ä»¥æ£€æµ‹è®¿é—®çš„æ¥æºç½‘é¡µï¼Œå¦‚æœæ˜¯èµ„æºæ–‡ä»¶ï¼Œå¯ä»¥è·Ÿè¸ªåˆ°æ˜¾ç¤ºå®ƒçš„ç½‘é¡µåœ°å€ï¼Œä¸€æ—¦æ£€æµ‹å‡ºæ¥æºä¸æ˜¯æœ¬ç«™ï¼Œé©¬ä¸Šè¿›è¡Œé˜»æ­¢æˆ–è¿”å›æŒ‡å®šçš„é¡µé¢ã€‚\nHTTP refereræ˜¯headerçš„ä¸€éƒ¨åˆ†ï¼Œå½“æµè§ˆå™¨å‘WebæœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œä¸€èˆ¬ä¼šå¸¦ä¸Šrefererï¼Œå‘Šè¯‰æœåŠ¡å™¨æˆ‘æ˜¯ä»å“ªä¸ªé¡µé¢é“¾æ¥è¿‡æ¥çš„ï¼ŒæœåŠ¡å™¨å€Ÿæ­¤è·å¾—ä¸€äº›ä¿¡æ¯ç”¨äºå¤„ç†ã€‚Apacheã€Nginxã€Lighttpdä¸‰è€…éƒ½æ”¯æŒæ ¹æ®HTTP refererå®ç°é˜²ç›—é“¾ï¼Œrefereræ˜¯ç›®å‰ç½‘ç«™å›¾ç‰‡ã€é™„ä»¶ã€htmlç­‰æœ€å¸¸ç”¨çš„é˜²ç›—é“¾æ‰‹æ®µ\nï¼ˆ2ï¼‰æ ¹æ®cookieé˜²ç›—é“¾ å¯¹äºä¸€äº›ç‰¹æ®Šçš„ä¸šåŠ¡æ•°æ®ï¼Œä¾‹å¦‚æµåª’ä½“åº”ç”¨é€šè¿‡ActiveXæ˜¾ç¤ºçš„å†…å®¹ï¼ˆä¾‹å¦‚ï¼ŒFlashã€Windows Mediaè§†é¢‘ã€æµåª’ä½“çš„RTSPåè®®ç­‰ï¼‰ï¼Œå› ä¸ºå®ƒä»¬ä¸å‘æœåŠ¡å™¨æä¾›referer headerï¼Œæ‰€ä»¥è‹¥é‡‡ç”¨ä¸Šè¿°çš„refererçš„é˜²ç›—é“¾æ‰‹æ®µï¼Œå°±è¾¾ä¸åˆ°æƒ³è¦çš„æ•ˆæœã€‚\nå¯¹äºFlashã€Windows Mediaè§†é¢‘è¿™ç§å ç”¨æµé‡è¾ƒå¤§çš„ä¸šåŠ¡æ•°æ®ï¼Œé˜²ç›—é“¾æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œæ­¤æ—¶å¯ä»¥é‡‡ç”¨CookieæŠ€æœ¯ï¼Œè§£å†³Flashã€Windows Mediaè§†é¢‘ç­‰çš„é˜²ç›—é“¾é—®é¢˜ã€‚\nä¾‹å¦‚ï¼šActiveXæ’ä»¶ä¸ä¼ é€’refererï¼Œä½†ä¼šä¼ é€’Cookieï¼Œå¯ä»¥åœ¨æ˜¾ç¤ºActiveXçš„é¡µé¢çš„\u0026lt;head\u0026gt;\u0026lt;/head\u0026gt;æ ‡ç­¾å†…åµŒå…¥ä¸€æ®µJavaScriptä»£ç ï¼Œè®¾ç½®â€œCookieï¼šCache=avâ€å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 \u0026lt;script\u0026gt; document.cookie=\u0026#34;Cache=avï¼› domain=domain.comï¼› path=/\u0026#34;ï¼› \u0026lt;/script\u0026gt; ç„¶åå°±å¯ä»¥é€šè¿‡å„ç§æ‰‹æ®µæ¥åˆ¤æ–­è¿™ä¸ªCookieçš„å­˜åœ¨ï¼Œä»¥åŠéªŒè¯å…¶å€¼çš„æ“ä½œäº†ã€‚\næ ¹æ®Cookieæ¥é˜²ç›—é“¾çš„æŠ€æœ¯éæœ¬ä¹¦çš„å†…å®¹ï¼Œè¯»è€…äº†è§£å³å¯ï¼Œå¦‚æœä¼ä¸šç¡®å®æœ‰éœ€è¦ï¼Œå¯ä»¥é˜…è¯»å…¶ä»–ä¹¦ç±æˆ–è¿›å…¥äº¤æµç¾¤è·å–è¿™éƒ¨åˆ†çš„çŸ¥è¯†ã€‚\nï¼ˆ3ï¼‰é€šè¿‡åŠ å¯†å˜æ¢è®¿é—®è·¯å¾„å®ç°é˜²ç›—é“¾ æ­¤ç§æ–¹æ³•æ¯”è¾ƒé€‚åˆè§†é¢‘åŠä¸‹è½½ç±»ä¸šåŠ¡æ•°æ®çš„ç½‘ç«™ã€‚ä¾‹å¦‚ï¼šLighttpdæœ‰ç±»ä¼¼çš„æ’ä»¶mod_secdownloadæ¥å®ç°æ­¤åŠŸèƒ½ã€‚å…ˆåœ¨æœåŠ¡å™¨ç«¯é…ç½®æ­¤æ¨¡å—ï¼Œè®¾ç½®ä¸€ä¸ªå›ºå®šç”¨äºåŠ å¯†çš„å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚oldboyï¼Œç„¶åè®¾ç½®ä¸€ä¸ªurlå‰ç¼€ï¼Œæ¯”å¦‚/mp4/ï¼Œå†è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚1å°æ—¶ï¼Œç„¶åå†™ä¸€æ®µPHPä»£ç ï¼Œåˆ©ç”¨åŠ å¯†å­—ç¬¦ä¸²å’Œç³»ç»Ÿæ—¶é—´ç­‰é€šè¿‡md5ç®—æ³•ç”Ÿæˆä¸€ä¸ªåŠ å¯†å­—ç¬¦ä¸²ã€‚æœ€ç»ˆè·å–åˆ°çš„æ–‡ä»¶çš„URLé“¾æ¥ä¸­ä¼šå¸¦æœ‰ä¸€ä¸ªæ—¶é—´æˆ³å’Œä¸€ä¸ªåŠ å¯†å­—ç¬¦çš„md5æ•°å€¼ï¼Œåœ¨è®¿é—®æ—¶ç³»ç»Ÿä¼šå¯¹è¿™ä¸¤ä¸ªæ•°æ®è¿›è¡ŒéªŒè¯ã€‚å¦‚æœæ—¶é—´ä¸åœ¨é¢„æœŸçš„æ—¶é—´æ®µå†…ï¼ˆå¦‚1å°æ—¶å†…ï¼‰åˆ™å¤±æ•ˆï¼›å¦‚æœæ—¶é—´æˆ³ç¬¦åˆæ¡ä»¶ï¼Œä½†æ˜¯åŠ å¯†çš„å­—ç¬¦ä¸²ä¸ç¬¦åˆæ¡ä»¶ä¹Ÿä¼šå¤±æ•ˆï¼Œä»è€Œè¾¾åˆ°é˜²ç›—é“¾çš„æ•ˆæœã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 \u0026lt;php $secret = \u0026#34;oldboy\u0026#34;ï¼› // åŠ å¯†å­—ç¬¦ä¸²ï¼Œå¿…é¡»å’Œ lighttpd.confé‡Œçš„ä¿æŒä¸€è‡´ $uri_prefix = \u0026#34;/mp4/\u0026#34;ï¼› // è™šæ‹Ÿçš„è·¯å¾„ã€å‰ç¼€ï¼Œå¿…é¡»å’Œ lighttpd.confé‡Œçš„ä¿æŒä¸€è‡´ $file = \u0026#34;/test.mp4\u0026#34;ï¼› // å®é™…æ–‡ä»¶åï¼Œå¿…é¡»åŠ  \u0026#34;/\u0026#34;æ–œæ  $timestamp = timeï¼ˆï¼‰ï¼› // current timestamp $t_hex = sprintfï¼ˆ \u0026#34;%08x\u0026#34;ï¼Œ $timestampï¼‰ï¼› $m = md5ï¼ˆ $secret.$file.$t_hexï¼‰ï¼› printfï¼ˆ \u0026#39;%s\u0026#39;ï¼Œ $uri_prefixï¼Œ $mï¼Œ $t_hexï¼Œ $fileï¼Œ $fileï¼‰ï¼› //ç”Ÿæˆ urlåœ°å€ä¸² \u0026gt; Nginx WebæœåŠ¡å®ç°é˜²ç›—é“¾å®æˆ˜ åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œåªéœ€è¦è¿›è¡Œç®€å•çš„é…ç½®ï¼Œå³å¯å®ç°é˜²ç›—é“¾å¤„ç†\nåˆ©ç”¨refererï¼Œå¹¶ä¸”é’ˆå¯¹æ‰©å±•årewriteé‡å®šå‘\nç¬¬ä¸€æ­¥\nç¬¬äºŒæ­¥\nç¬¬ä¸‰æ­¥\nç›¸å…³é…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 é…ç½®å‰ location ~ .*\\.(gif|jpg|jpeg|png|bmp|swf)$ { expires 30d; error_log off; access_log /dev/null; } é…ç½®å location ~ .*\\.(gif|jpg|jpeg|png|bmp|swf)$ { valid_referers *.heian99.top heian99.top; if ($invalid_referer) { rewrite ^/ https://ftp.bmp.ovh/imgs/2020/06/75d45131a596abbd.jpg; #return 404; } expires 30d; } æ•ˆæœå›¾\næ‰“å¼€è¿™ä¸ªå›¾ç‰‡ï¼Œæ”¾åˆ°åˆ«çš„æµè§ˆå™¨æŸ¥çœ‹\nå°±ä¼šå˜æˆä¸‹é¢è¿™ä¸ªå›¾ç‰‡äº†\n","date":"2020-07-13T10:34:13Z","image":"https://www.ownit.top/title_pic/17.jpg","permalink":"https://www.ownit.top/p/202007131034/","title":"å®å¡”Nginxé…ç½®é˜²ç›—é“¾"},{"content":"ç›®å½•\n1ã€ç¯å¢ƒè¦æ±‚\n2ã€æ¶æ„å·¥ä½œåŸç†\n2.1æ¶æ„ä»‹ç»:\n2.2 MHAè½¯ä»¶æ„æˆ\n3ã€Mysqlç¯å¢ƒæ­å»º\n3.1ç¯å¢ƒå‡†å¤‡ï¼ˆä¸»ä»éƒ½éœ€è¦ä¸‹é¢æ­¥éª¤ï¼‰\n3.2ç”¨æˆ·çš„åˆ›å»ºå¤„ç†åŸå§‹ç¯å¢ƒ\n3.3è§£å‹æ–‡ä»¶ï¼Œæ›´æ”¹æ–‡ä»¶ç›®å½•\n3.4è®¾ç½®ç¯å¢ƒå˜é‡\n3.5ç¯å¢ƒç›®å½•è§„åˆ’\n3.6my.cnfé…ç½®æ–‡ä»¶\n3.7mysqlæ•°æ®åº“åˆå§‹åŒ–\n3.8å¯åŠ¨æ•°æ®åº“2ç§æ–¹å¼\n1. sys-v\n2. systemd\n3.9ä¿®æ”¹æ•°æ®åº“çš„å¯†ç \n4ã€mysqlä¸»ä»é…ç½®\n1ã€ä¸»åº“åˆ›å»ºç”¨æˆ·ï¼ˆdb01ï¼‰\n2ã€ä»åº“å¼€å¯è¿æ¥ï¼ˆdb02ï¼‰\n5ã€MHAç¯å¢ƒæ­å»º\n5.1é…ç½®å…³é”®ç¨‹åºè½¯è¿æ¥\n5.2é…ç½®å„ä¸ªèŠ‚ç‚¹äº’ä¿¡\n5.3å®‰è£…MHAè½¯ä»¶\n1ã€æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Nodeè½¯ä»¶ä¾èµ–åŒ…\n2ã€åœ¨db01ä¸»åº“ä¸­åˆ›å»ºmhaéœ€è¦çš„ç”¨æˆ·\n3ã€Managerè½¯ä»¶å®‰è£…ï¼ˆdb02ï¼‰\n5.4é…ç½®æ–‡ä»¶å‡†å¤‡ï¼ˆdb02ï¼‰\n5.5çŠ¶æ€æ£€æŸ¥\näº’ä¿¡æ£€æŸ¥\nä¸»ä»çŠ¶æ€æ£€æŸ¥\n5.6å¼€å¯HMAï¼ˆdb02ï¼‰\nå¼€å¯\næ£€æµ‹MHAçŠ¶æ€\n6ã€MHA çš„vipåŠŸèƒ½\nå‚æ•°\nä¿®æ”¹è„šæœ¬å†…å®¹\næ›´æ”¹manageré…ç½®æ–‡ä»¶ï¼š\nä¸»åº“ä¸Šï¼Œæ‰‹å·¥ç”Ÿæˆç¬¬ä¸€ä¸ªvipåœ°å€\né‡å¯mha\n7ã€Â binlog serverï¼ˆdb02ï¼‰\nå‚æ•°ï¼š\nåˆ›å»ºå¿…è¦ç›®å½•\næ‹‰å–ä¸»åº“binlogæ—¥å¿—\né‡å¯MHA\n8ã€é‚®ä»¶æé†’\n1. å‚æ•°\n2. å‡†å¤‡é‚®ä»¶è„šæœ¬\n3. ä¿®æ”¹manageré…ç½®æ–‡ä»¶ï¼Œè°ƒç”¨é‚®ä»¶è„šæœ¬\né‡å¯MHA\n9ã€æµ‹è¯•MHA\nå…³é—­ä¸»åº“,çœ‹è­¦å‘Šé‚®ä»¶ 1ã€ç¯å¢ƒè¦æ±‚ MHAå®æ–½æ–‡æ¡£ï¼šÂ MHAå®æ–½æ–‡æ¡£.pdf-ç¾¤é›†æœåŠ¡æ–‡æ¡£ç±»èµ„æº-CSDNä¸‹è½½\nMHAå®æ–½è½¯ä»¶é›†åˆï¼šÂ MHAå®æ–½æ–‡æ¡£.zip-ç¾¤é›†æœåŠ¡æ–‡æ¡£ç±»èµ„æº-CSDNä¸‹è½½ï¼ˆåŒ…å«æ‰€ç”¨åˆ°çš„è½¯ä»¶ï¼‰\n****ç³»ç»Ÿï¼š****CentOS Linux release 7.4.1708 (Core)\nMyssqlï¼š5****.7.20****\n****MHAï¼š****mha4mysql-manager-0.56-0.el6.noarch\n****Â mha4mysql-node-0.56-0.el6.noarch****\nä¸»æœº\nIP\nç«¯å£\nä¸»åº“ï¼ˆdb01ï¼‰\n172.17.1.145\n3306\nä»åº“ï¼ˆdb02ï¼‰\n172.17.1.146\n3306\nè™šæ‹Ÿipï¼ˆvrrpæ¼‚ç§»ï¼‰\n172.17.1.100\n2ã€æ¶æ„å·¥ä½œåŸç† ä¸»åº“å®•æœºå¤„ç†è¿‡ç¨‹\n1. ç›‘æ§èŠ‚ç‚¹ (é€šè¿‡é…ç½®æ–‡ä»¶è·å–æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯)\nç³»ç»Ÿ,ç½‘ç»œ,SSHè¿æ¥æ€§\nä¸»ä»çŠ¶æ€,é‡ç‚¹æ˜¯ä¸»åº“\n2. é€‰ä¸»\n(1) å¦‚æœåˆ¤æ–­ä»åº“(positionæˆ–è€…GTID),æ•°æ®æœ‰å·®å¼‚,æœ€æ¥è¿‘äºMasterçš„slave,æˆä¸ºå¤‡é€‰ä¸»\n(2) å¦‚æœåˆ¤æ–­ä»åº“(positionæˆ–è€…GTID),æ•°æ®ä¸€è‡´,æŒ‰ç…§é…ç½®æ–‡ä»¶é¡ºåº,é€‰ä¸».\n(3) å¦‚æœè®¾å®šæœ‰æƒé‡(candidate_master=1),æŒ‰ç…§æƒé‡å¼ºåˆ¶æŒ‡å®šå¤‡é€‰ä¸».\n1. é»˜è®¤æƒ…å†µä¸‹å¦‚æœä¸€ä¸ªslaveè½åmaster 100Mçš„relay logsçš„è¯ï¼Œå³ä½¿æœ‰æƒé‡,ä¹Ÿä¼šå¤±æ•ˆ.\n2. å¦‚æœcheck_repl_delay=0çš„åŒ–,å³ä½¿è½åå¾ˆå¤šæ—¥å¿—,ä¹Ÿå¼ºåˆ¶é€‰æ‹©å…¶ä¸ºå¤‡é€‰ä¸»\n3. æ•°æ®è¡¥å¿\n(1) å½“SSHèƒ½è¿æ¥,ä»åº“å¯¹æ¯”ä¸»åº“GTID æˆ–è€…positionå·,ç«‹å³å°†äºŒè¿›åˆ¶æ—¥å¿—ä¿å­˜è‡³å„ä¸ªä»èŠ‚ç‚¹å¹¶ä¸”åº”ç”¨(save_binary_logs )\n(2) å½“SSHä¸èƒ½è¿æ¥, å¯¹æ¯”ä»åº“ä¹‹é—´çš„relaylogçš„å·®å¼‚(apply_diff_relay_logs)\n4. Failover\nå°†å¤‡é€‰ä¸»è¿›è¡Œèº«ä»½åˆ‡æ¢,å¯¹å¤–æä¾›æœåŠ¡\nå…¶ä½™ä»åº“å’Œæ–°ä¸»åº“ç¡®è®¤æ–°çš„ä¸»ä»å…³ç³»\n5. åº”ç”¨é€æ˜(VIP)\n6. æ•…éšœåˆ‡æ¢é€šçŸ¥(send_reprt)\n7. äºŒæ¬¡æ•°æ®è¡¥å¿(binlog_server)\n2**.1æ¶æ„ä»‹ç»:****** 1ä¸»1ä»ï¼Œmasterï¼šdb01 slaveï¼šdb02 ï¼‰ï¼š\nMHA é«˜å¯ç”¨æ–¹æ¡ˆè½¯ä»¶æ„æˆ\nManagerè½¯ä»¶ï¼šé€‰æ‹©ä¸€ä¸ªä»èŠ‚ç‚¹å®‰è£…\nNodeè½¯ä»¶ï¼šæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦å®‰è£…\n2**.2 MHAè½¯ä»¶æ„æˆ****** anagerå·¥å…·åŒ…ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå·¥å…·ï¼š\nmasterha_manger å¯åŠ¨MHA\nmasterha_check_ssh æ£€æŸ¥MHAçš„SSHé…ç½®çŠ¶å†µ\nmasterha_check_repl æ£€æŸ¥MySQLå¤åˆ¶çŠ¶å†µ\nmasterha_master_monitor æ£€æµ‹masteræ˜¯å¦å®•æœº\nmasterha_check_status æ£€æµ‹å½“å‰MHAè¿è¡ŒçŠ¶æ€\nmasterha_master_switch æ§åˆ¶æ•…éšœè½¬ç§»ï¼ˆè‡ªåŠ¨æˆ–è€…æ‰‹åŠ¨ï¼‰\nmasterha_conf_host æ·»åŠ æˆ–åˆ é™¤é…ç½®çš„serverä¿¡æ¯\nNodeå·¥å…·åŒ…ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå·¥å…·ï¼š\nè¿™äº›å·¥å…·é€šå¸¸ç”±MHA Managerçš„è„šæœ¬è§¦å‘ï¼Œæ— éœ€äººä¸ºæ“ä½œ\nsave_binary_logs ä¿å­˜å’Œå¤åˆ¶masterçš„äºŒè¿›åˆ¶æ—¥å¿—\napply_diff_relay_logs è¯†åˆ«å·®å¼‚çš„ä¸­ç»§æ—¥å¿—äº‹ä»¶å¹¶å°†å…¶å·®å¼‚çš„äº‹ä»¶åº”ç”¨äºå…¶ä»–çš„\npurge_relay_logs æ¸…é™¤ä¸­ç»§æ—¥å¿—ï¼ˆä¸ä¼šé˜»å¡SQLçº¿ç¨‹ï¼‰\n3ã€Mysqlç¯å¢ƒæ­å»º 3**.**1ç¯å¢ƒå‡†å¤‡ï¼ˆä¸»ä»éƒ½éœ€è¦ä¸‹é¢æ­¥éª¤ï¼‰ åˆ›å»ºç›®å½•ï¼Œä¸Šä¼ æ‰€éœ€è¦çš„æ–‡ä»¶ï¼ˆä¸»ä»éƒ½éœ€è¦ä¸Šä¼ ï¼‰\n1 2 3 [root@db01 ~]# mkdir -p /tools/mysql [root@db01 ~]# cd /tools/mysql [root@db01 mysql]# scp * root@172.17.1.146:/tools/mysql/ 3**.2ç”¨æˆ·çš„åˆ›å»ºå¤„ç†åŸå§‹ç¯å¢ƒ****** 1 2 3 4 [root@db01 ~]# rpm -qa |grep mariadb [root@db01 ~]# yum remove mariadb-libs-5.5.56-2.el7.x86_64 -y æ·»åŠ mysqlç”¨æˆ· [root@db01 ~]# useradd -s /sbin/nologin mysql 3.3è§£å‹æ–‡ä»¶ï¼Œæ›´æ”¹æ–‡ä»¶ç›®å½•**** 1 2 3 4 5 6 å­˜æ”¾mysqlç¨‹åºç›®å½• [root@db01 mysql]# mkdir -p /app è§£å‹ [root@db01 mysql]# tar xf mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz ç§»åŠ¨ [root@db01 mysql]# mv mysql-5.7.20-linux-glibc2.12-x86_64 /app/mysql 3**.4è®¾ç½®ç¯å¢ƒå˜é‡****** 1 2 3 4 5 6 7 8 9 10 vim /etc/profile export PATH=/app/mysql/bin:$PATH [root@db01 ~]# source /etc/profile [root@db01 ~]# mysql -V mysql Ver 14.14 Distrib 5.7.20, for linux-glibc2.12 (x86_64) using EditLine wrapper 3**.5**ç¯å¢ƒç›®å½•è§„åˆ’ åˆ›å»ºæ–‡ä»¶ï¼Œå¹¶æˆæƒ\n1 2 3 4 5 [root@db01 mysql]# [root@db01 mysql]# mkdir -p /data/{mysql,binlog} [root@db01 mysql]# mkdir -p /data/mysql/data [root@db01 mysql]# chown -R mysql.mysql /app/mysql/* [root@db01 mysql]# chown -R mysql.mysql /data/* é”™è¯¯æ—¥å¿—å­˜æ”¾\n1 2 3 4 [root@db01 ~]# touch /var/log/mysql.log [root@db01 ~]# chown mysql.mysql /var/log/mysql.log [root@db01 ~]# ll /var/log/mysql.log -rw-r--r-- 1 mysql mysql 0 6æœˆ 21 20:38 /var/log/mysql.log Sockç¯å¢ƒé…ç½®\n1 2 [root@db01 data]# touch /tmp/mysql.sock [root@db01 data]# chown mysql.mysql /tmp/mysql.sock æ…¢æ—¥å¿—ï¼ˆæœ‰éœ€è¦å¯ä»¥åŠ ä¸‹é¢å‚æ•°ï¼‰\n1 2 3 4 5 6 7 8 å¼€å…³: slow_query_log=1 æ–‡ä»¶ä½ç½®åŠåå­— slow_query_log_file=/data/mysql/slow.log è®¾å®šæ…¢æŸ¥è¯¢æ—¶é—´: long_query_time=0.1 æ²¡èµ°ç´¢å¼•çš„è¯­å¥ä¹Ÿè®°å½•: log_queries_not_using_indexes 3**.6**my.cnfé…ç½®æ–‡ä»¶ ä¸»åº“server_id=145\nä»åº“server_id=146\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 [mysqld] basedir=/data/mysql datadir=/data/mysql/data socket=/tmp/mysql.sock #é”™è¯¯æ—¥å¿— log_error=/var/log/mysql.log log_timestamps=system #server_id server_id=145 port=3306 secure-file-priv=/tmp autocommit=0 log_bin=/data/binlog/mysql-bin binlog_format=row #GTID gtid-mode=on enforce-gtid-consistency=true log-slave-updates=1 # å…è®¸æœ€å¤§è¿æ¥æ•° max_connections=200 # æœåŠ¡ç«¯ä½¿ç”¨çš„å­—ç¬¦é›†é»˜è®¤ä¸º8æ¯”ç‰¹ç¼–ç çš„latin1å­—ç¬¦é›† character-set-server=utf8 # åˆ›å»ºæ–°è¡¨æ—¶å°†ä½¿ç”¨çš„é»˜è®¤å­˜å‚¨å¼•æ“ default-storage-engine=INNODB [mysql] socket=/tmp/mysql.sock prompt=db01 [\\d]\u0026gt; 3**.7**mysqlæ•°æ®åº“åˆå§‹åŒ– 1 [root@db01 ~]# mysqld --initialize-insecure --user=mysql --basedir=/app/mysql --datadir=/data/mysql/data 3.8å¯åŠ¨æ•°æ®åº“2ç§æ–¹å¼**** 1. sys-v 1 2 3 4 5 6 7 [root@db01 data]# cp /app/mysql/support-files/mysql.server /etc/init.d/mysqld [root@db01 data]# vim /etc/init.d/mysqld [root@db01 data]# grep -Ev \u0026#34;^(#|$)\u0026#34; /etc/init.d/mysqld basedir=/app/mysql datadir=/data/mysql/data â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦.. 1 2 3 [root@db02 mysql]# service mysqld restart [root@db02 mysql]# service mysqld stop [root@db02 mysql]# service mysqld start 1 2 3 [root@db02 mysql]# /etc/init.d/mysqld restart [root@db02 mysql]# /etc/init.d/mysqld stop [root@db02 mysql]# /etc/init.d/mysqld start 2. systemd æ³¨æ„ï¼š sysvæ–¹å¼å¯åŠ¨è¿‡çš„è¯ï¼Œéœ€è¦å…ˆæå‰å…³é—­ï¼Œæ‰èƒ½ä»¥ä¸‹æ–¹å¼ç™»å½•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 cat \u0026gt;/etc/systemd/system/mysqld.service \u0026lt;\u0026lt;EOF [Unit] Description=MySQL Server Documentation=man:mysqld(8) Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html After=network.target After=syslog.target [Install] WantedBy=multi-user.target [Service] User=mysql Group=mysql ExecStart=/app/mysql/bin/mysqld --defaults-file=/etc/my.cnf LimitNOFILE = 5000 EOF 1 2 3 [root@db02 mysql]# systemctl restart mysqld [root@db02 mysql]# systemctl stop mysqld [root@db02 mysql]# systemctl start mysqld 3**.9**ä¿®æ”¹æ•°æ®åº“çš„å¯†ç  ****æ³¨æ„ï¼š****5.8ä»¥ä¸Šæ•°æ®åº“ï¼Œéœ€è¦å…ˆåˆ›ç”¨æˆ·ï¼Œæˆæƒ\n5.7çš„æ•°æ®åº“ï¼Œä½ æˆæƒæ—¶ï¼Œå°±è¡Œç»™ä½ åˆ›å»ºç”¨æˆ·\nï¼ˆå‘ï¼šåœ¨æ›´æ”¹å¯†ç æ—¶ï¼Œè¦æ³¨æ„ç©ºæ ¼ï¼Œé˜²æ­¢å¯†ç é‡Œæœ‰ç©ºæ ¼ï¼Œè€Œè‡ªå·±æ²¡æ³¨æ„\n1 2 3 4 5 6 7 use mysql; æœ¬åœ°è¿æ¥å¯†ç  grant all on *.* to root@\u0026#39;localhost\u0026#39; identified by \u0026#39;xdzh@2020\u0026#39;; åŒä¸€ç½‘æ®µå¯è¿æ¥çš„rootæƒé™ grant all on *.* to root@\u0026#39;172.17.1.%\u0026#39; identified by \u0026#39;xdzh@2020\u0026#39;; åˆ·æ–°æƒé™è¡¨ flush privileges; æœ¬åœ°ç™»å½•æµ‹è¯•\n4ã€mysqlä¸»ä»é…ç½® 1ã€ä¸»åº“åˆ›å»ºç”¨æˆ·ï¼ˆdb01**ï¼‰****** è´¦å·å¯†ç å¯ä»¥è‡ªå·±å®šä¹‰\n1 2 grant replication slave on *.* to repl@\u0026#39;172.17.1.%\u0026#39; identified by \u0026#39;123\u0026#39;; flush privileges; 2ã€ä»åº“å¼€å¯è¿æ¥ï¼ˆdb02******ï¼‰****** æ‰§è¡Œè¯­å¥ï¼Œè¿æ¥ä¸»åº“ï¼ŒåŒæ­¥æ•°æ®\n1 2 3 4 5 change master to master_host=\u0026#39;172.17.1.145\u0026#39;, master_user=\u0026#39;repl\u0026#39;, master_password=\u0026#39;123\u0026#39; , MASTER_AUTO_POSITION=1; å¼€å¯ä»åº“\n1 start slave; æŸ¥çœ‹ç”¨æˆ·\n******5ã€**MHAç¯å¢ƒæ­å»º è§„åˆ’\nä¸»æœº\nMHAè½¯ä»¶\nä¸»åº“ï¼ˆdb01ï¼‰\nNode\nä»åº“ï¼ˆdb02ï¼‰\nNodeï¼ŒMaster\n5**.1**é…ç½®å…³é”®ç¨‹åºè½¯è¿æ¥ æ³¨æ„ï¼šä¸€å®šè¦é…ç½®ï¼Œä¸ç„¶åé¢æ•°æ®åº“åˆ‡æ¢ä¼šå‡ºç°é—®é¢˜ï¼ˆä¸»ä»éƒ½é…ç½®ï¼‰\n1 2 ln -s /app/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog ln -s /app/mysql/bin/mysql /usr/bin/mysql 5**.2**é…ç½®å„ä¸ªèŠ‚ç‚¹äº’ä¿¡ é…ç½®SSH\n1 2 3 4 5 6 db01ï¼š rm -rf /root/.ssh ssh-keygen cd /root/.ssh mv id_rsa.pub authorized_keys scp -r /root/.ssh 172.17.1.146:/root å„èŠ‚ç‚¹éªŒè¯ï¼š\n1 2 3 4 5 6 7 db01: ssh 172.17.1.145 date ssh 172.17.1.146 date db02: ssh 172.17.1.145 date ssh 172.17.1.146 date ä¸»åº“\nä»åº“\n5**.3**å®‰è£…MHAè½¯ä»¶ mhaå®˜ç½‘ï¼šhttps://code.google.com/archive/p/mysql-master-ha/\ngithubä¸‹è½½åœ°å€ï¼šhttps://github.com/yoshinorim/mha4mysql-manager/wiki/Downloads\n******1ã€**æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Nodeè½¯ä»¶ä¾èµ–åŒ… 1 2 yum install perl-DBD-MySQL -y rpm -ivh mha4mysql-node-0.56-0.el6.noarch.rpm ******2ã€**åœ¨db01ä¸»åº“ä¸­åˆ›å»ºmhaéœ€è¦çš„ç”¨æˆ· è´¦å·å¯†ç å¯ä»¥è‡ªå·±å®šä¹‰\n1 grant all privileges on *.* to mha@\u0026#39;172.17.1.%\u0026#39; identified by \u0026#39;mha\u0026#39;; 3ã€Managerè½¯ä»¶å®‰è£…ï¼ˆdb02ï¼‰ æ³¨æ„ï¼šè¿™è¾¹å¦‚æœyumå®‰è£…ç¼ºå°‘ä¾èµ–ï¼Œæ¢æˆé˜¿é‡Œäº‘çš„æºå’Œepel\n1 2 yum install -y perl-Config-Tiny epel-release perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes rpm -ivh mha4mysql-manager-0.56-0.el6.noarch.rpm 5**.4é…ç½®æ–‡ä»¶å‡†å¤‡ï¼ˆdb02********ï¼‰****** 1 2 3 4 åˆ›å»ºé…ç½®æ–‡ä»¶ç›®å½• mkdir -p /etc/mha åˆ›å»ºæ—¥å¿—ç›®å½• mkdir -p /var/log/mha/app1 ç¼–è¾‘mhaé…ç½®æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 vim /etc/mha/app1.cnf [server default] manager_log=/var/log/mha/app1/manager manager_workdir=/var/log/mha/app1 master_binlog_dir=/data/binlog user=mha password=mha ping_interval=2 repl_password=123 repl_user=repl ssh_user=root [server1] hostname=172.17.1.145 port=3306 [server2] hostname=172.17.1.146 port=3306 5**.5çŠ¶æ€æ£€æŸ¥****** 1 2 3 4 5 6 7 æ£€æµ‹replçŠ¶æ€ masterha_check_repl --conf=/etc/mha/app1.cnf æ£€æµ‹sshçŠ¶æ€ masterha_check_ssh --conf=/etc/mha/app1.cnf æ£€æµ‹è¿è¡ŒçŠ¶æ€ masterha_check_status --conf=/etc/mha/app1.cnf äº’ä¿¡æ£€æŸ¥ masterha_check_ssh \u0026nbsp;--conf=/etc/mha/app1.cnf\nä¸»ä»çŠ¶æ€æ£€æŸ¥ masterha_check_repl \u0026nbsp;--conf=/etc/mha/app1.cnf\n5**.6å¼€å¯HMAï¼ˆdb02********ï¼‰****** å¼€å¯ nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover \u0026nbsp;\u0026lt; /dev/null\u0026gt; /var/log/mha/app1/manager.log 2\u0026gt;\u0026amp;1 \u0026amp;\næ£€æµ‹MHAçŠ¶æ€ masterha_check_status --conf=/etc/mha/app1.cnf\n[root@db02 mysql]# masterha_check_status --conf=/etc/mha/app1.cnf\napp1 (pid:17248) is running(0:PING_OK), master:172.17.1.145\n[root@db02 mysql]# mysql -umha -pmha -h172.17.1.145 -e \"show variables like 'server_id'\"\nmysql: [Warning] Using a password on the command line interface can be insecure.\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| server_id \u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;| 145 \u0026nbsp;\u0026nbsp;|\n+---------------+-------+\n[root@db02 mysql]# mysql -umha -pmha -h172.17.1.146 -e \"show variables like 'server_id'\"\nmysql: [Warning] Using a password on the command line interface can be insecure.\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| server_id \u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;| 146 \u0026nbsp;\u0026nbsp;|\n+---------------+-------+\n6**ã€**MHA çš„vipåŠŸèƒ½ å‚æ•° æ³¨æ„ï¼š/usr/local/bin/master_ip_failoverï¼Œå¿…é¡»äº‹å…ˆå‡†å¤‡å¥½\nmaster_ip_failover_script=/usr/local/bin/master_ip_failover\nä¿®æ”¹è„šæœ¬å†…å®¹ 1 2 3 4 5 vi /usr/local/bin/master_ip_failover my $vip = \u0026#39;172.17.1.100/24\u0026#39;; my $key = \u0026#39;1\u0026#39;; my $ssh_start_vip = \u0026#34;/sbin/ifconfig eth0:$key $vip\u0026#34;; my $ssh_stop_vip = \u0026#34;/sbin/ifconfig eth0:$key down\u0026#34;; æ›´æ”¹manageré…ç½®æ–‡ä»¶ï¼š 1 2 3 4 5 6 7 vi /etc/mha/app1.cnf æ·»åŠ ï¼š master_ip_failover_script=/usr/local/bin/master_ip_failover æ³¨æ„ï¼š [root@db03 ~]# dos2unix /usr/local/bin/master_ip_failover dos2unix: converting file /usr/local/bin/master_ip_failover to Unix format ... [root@db03 ~]# chmod +x /usr/local/bin/master_ip_failover ä¸»åº“ä¸Šï¼Œæ‰‹å·¥ç”Ÿæˆç¬¬ä¸€ä¸ªvipåœ°å€ æ‰‹å·¥åœ¨ä¸»åº“ä¸Šç»‘å®švipï¼Œæ³¨æ„ä¸€å®šè¦å’Œé…ç½®æ–‡ä»¶ä¸­çš„ethNä¸€è‡´ï¼Œæˆ‘çš„æ˜¯eth0:1(1æ˜¯keyæŒ‡å®šçš„å€¼)\nifconfig ens33:1 172.17.1.100/24\né‡å¯mha masterha_stop --conf=/etc/mha/app1.cnf\nnohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover \u0026lt; /dev/null \u0026gt; /var/log/mha/app1/manager.log 2\u0026gt;\u0026amp;1 \u0026amp;\n7ã€**Â binlog serverï¼ˆdb02ï¼‰****** å‚æ•°ï¼š binlogserveré…ç½®ï¼š\næ‰¾ä¸€å°é¢å¤–çš„æœºå™¨ï¼Œå¿…é¡»è¦æœ‰5.6ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œæ”¯æŒgtidå¹¶å¼€å¯ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨slaveï¼ˆdb02ï¼‰\nvim /etc/mha/app1.cnf\n1 2 3 4 [binlog1] no_master=1 hostname= 172.17.1.146 master_binlog_dir=/data/mysql/binlog åˆ›å»ºå¿…è¦ç›®å½• mkdir -p /data/mysql/binlog\nchown -R mysql.mysql /data/*\nä¿®æ”¹å®Œæˆåï¼Œå°†ä¸»åº“binlogæ‹‰è¿‡æ¥ï¼ˆä»000001å¼€å§‹æ‹‰ï¼Œä¹‹åçš„binlogä¼šè‡ªåŠ¨æŒ‰é¡ºåºè¿‡æ¥ï¼‰\næ‹‰å–ä¸»åº“binlogæ—¥å¿— cd /data/mysql/binlog \u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;-----ã€‹å¿…é¡»è¿›å…¥åˆ°è‡ªå·±åˆ›å»ºå¥½çš„ç›®å½•\nmysqlbinlog \u0026nbsp;-R --host=172.17.1.145 --user=mha --password=mha --raw \u0026nbsp;--stop-never mysql-bin.000001 \u0026amp;\næ³¨æ„ï¼š\næ‹‰å–æ—¥å¿—çš„èµ·ç‚¹,éœ€è¦æŒ‰ç…§ç›®å‰ä»åº“çš„å·²ç»è·å–åˆ°çš„äºŒè¿›åˆ¶æ—¥å¿—ç‚¹ä¸ºèµ·ç‚¹\né‡å¯MHA masterha_stop --conf=/etc/mha/app1.cnf\nnohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover \u0026lt; /dev/null \u0026gt; /var/log/mha/app1/manager.log 2\u0026gt;\u0026amp;1 \u0026amp;\n8ã€é‚®ä»¶æé†’ 1. å‚æ•° report_script=/usr/local/bin/send\n2. å‡†å¤‡é‚®ä»¶è„šæœ¬ send_report\n(1)å‡†å¤‡å‘é‚®ä»¶çš„è„šæœ¬(ä¸Šä¼  email_2019-æœ€æ–°.zipä¸­çš„è„šæœ¬ï¼Œåˆ°/usr/local/bin/ä¸­)\n(2)å°†å‡†å¤‡å¥½çš„è„šæœ¬æ·»åŠ åˆ°mhaé…ç½®æ–‡ä»¶ä¸­,è®©å…¶è°ƒç”¨\n3. ä¿®æ”¹manageré…ç½®æ–‡ä»¶ï¼Œè°ƒç”¨é‚®ä»¶è„šæœ¬ 1 2 vi /etc/mha/app1.cnf report_script=/usr/local/bin/send é‡å¯MHA masterha_stop --conf=/etc/mha/app1.cnf\nnohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover \u0026lt; /dev/null \u0026gt; /var/log/mha/app1/manager.log 2\u0026gt;\u0026amp;1 \u0026amp;\n9**ã€æµ‹è¯•MHA****** å…³é—­ä¸»åº“**,çœ‹è­¦å‘Šé‚®ä»¶ ****** åˆ‡æ¢å®Œåï¼ŒHMAä¼šé€€å‡ºï¼Œè¿˜æœ‰binlogserver\n**Â 145æ•°æ®åº“æŒ‚æ‰åï¼ŒMHAè‡ªåŠ¨åˆ‡æ¢IPåˆ°146ä¸Šï¼Œæ— éœ€äººä¸ºä¿®æ”¹ã€‚**\n","date":"2020-06-24T11:43:46Z","image":"https://www.ownit.top/title_pic/37.jpg","permalink":"https://www.ownit.top/p/202006241143/","title":"MHAæ¶æ„å®æ–½ï¼ˆä¸€ä¸»ä¸€ä»ï¼‰å­¦ä¸ä¼šï¼Œä½ æ¥æ‰“æˆ‘ï¼ŸåŠ æ²¹ï¼å¥¥åˆ©ç»™"},{"content":"ç›®å½•\n1ã€ä¸ºä»€ä¹ˆéœ€è¦ä¸»ä»å¤åˆ¶ï¼Ÿ\n2ã€ä»€ä¹ˆæ˜¯mysqlä¸»ä»å¤åˆ¶\n3ã€Mysqlå¤åˆ¶åŸç†\n4ã€ä¸»ä»å¤åˆ¶ç®€ä»‹\n5ã€Â å»¶æ—¶ä»åº“\n6ã€åŠåŒæ­¥å¤åˆ¶\n7ã€è¿‡æ»¤å¤åˆ¶\n8ã€GTIDå¤åˆ¶\n9. ä¸»ä»æ•…éšœç›‘æ§\\åˆ†æ\\å¤„ç†\nä¸»ä»å¤åˆ¶æ•…éšœåˆ†æ\n1ã€ä¸ºä»€ä¹ˆéœ€è¦ä¸»ä»å¤åˆ¶ï¼Ÿ 1ã€åœ¨ä¸šåŠ¡å¤æ‚çš„ç³»ç»Ÿä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€ä¸ªæƒ…æ™¯ï¼Œæœ‰ä¸€å¥sqlè¯­å¥éœ€è¦é”è¡¨ï¼Œå¯¼è‡´æš‚æ—¶ä¸èƒ½ä½¿ç”¨è¯»çš„æœåŠ¡ï¼Œé‚£ä¹ˆå°±å¾ˆå½±å“è¿è¡Œä¸­çš„ä¸šåŠ¡ï¼Œä½¿ç”¨ä¸»ä»å¤åˆ¶ï¼Œè®©ä¸»åº“è´Ÿè´£å†™ï¼Œä»åº“è´Ÿè´£è¯»ï¼Œè¿™æ ·ï¼Œå³ä½¿ä¸»åº“å‡ºç°äº†é”è¡¨çš„æƒ…æ™¯ï¼Œé€šè¿‡è¯»ä»åº“ä¹Ÿå¯ä»¥ä¿è¯ä¸šåŠ¡çš„æ­£å¸¸è¿ä½œã€‚\n2ã€åšæ•°æ®çš„çƒ­å¤‡\n3ã€æ¶æ„çš„æ‰©å±•ã€‚ä¸šåŠ¡é‡è¶Šæ¥è¶Šå¤§ï¼ŒI/Oè®¿é—®é¢‘ç‡è¿‡é«˜ï¼Œå•æœºæ— æ³•æ»¡è¶³ï¼Œæ­¤æ—¶åšå¤šåº“çš„å­˜å‚¨ï¼Œé™ä½ç£ç›˜I/Oè®¿é—®çš„é¢‘ç‡ï¼Œæé«˜å•ä¸ªæœºå™¨çš„I/Oæ€§èƒ½ã€‚\n2ã€ä»€ä¹ˆæ˜¯mysqlä¸»ä»å¤åˆ¶ Mysqlä¸»ä»å¤åˆ¶æ˜¯æŒ‡æ•°æ®å¯ä»¥ä»ä¸€ä¸ªmysqlæ•°æ®åº“æœåŠ¡å™¨èŠ‚ç‚¹å¤åˆ¶åˆ°å¦ä¸€ä¸ªæˆ–è€…å¤šä¸ªèŠ‚ç‚¹ã€‚\nMysqlé»˜è®¤é‡‡ç”¨å¼‚æ­¥å¤åˆ¶æ–¹å¼ï¼Œè¿™æ ·ä»èŠ‚ç‚¹ä¸ç”¨ä¸€ç›´è®¿é—®ä¸»æœåŠ¡å™¨æ¥è·Ÿæ–°è‡ªå·±çš„æ•°æ®ï¼Œæ•°æ®çš„æ›´æ–°å¯ä»¥åœ¨è¿œç¨‹è¿æ¥ä¸Šè¿›è¡Œï¼Œä»èŠ‚ç‚¹å¯ä»¥å¤åˆ¶ä¸»æ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®åº“æˆ–è€…ç‰¹å®šçš„æ•°æ®åº“ï¼Œæˆ–è€…ç‰¹å®šçš„è¡¨ã€‚\n3ã€Mysqlå¤åˆ¶åŸç† åŸç†ï¼š\nï¼ˆ1ï¼‰masteræœåŠ¡å™¨å°†æ•°æ®çš„æ”¹å˜è®°å½•äºŒè¿›åˆ¶binlogæ—¥å¿—ï¼Œå½“masterçš„æ•°æ®å‘ç”Ÿæ”¹å˜æ˜¯ï¼Œè¿™å°†æ”¹å˜å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—ä¸­ï¼›\nï¼ˆ2ï¼‰slaveæœåŠ¡å™¨ä¼šåœ¨ä¸€å®šæ—¶é—´é—´éš”å†…å¯¹masteräºŒè¿›åˆ¶æ—¥å¿—è¿›è¡Œæ¢æµ‹æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼Œå¦‚æœå‘ç”Ÿæ”¹å˜ï¼Œåˆ™å¼€å§‹ä¸€ä¸ªIOçº¿ç¨‹è¯·æ±‚masteräºŒè¿›åˆ¶æ—¶é—´\nï¼ˆ3ï¼‰åŒæ—¶ä¸»èŠ‚ç‚¹ä¸ºæ¯ä¸ªIOçº¿ç¨‹å¯åŠ¨ä¸€ä¸ªdumpçº¿ç¨‹ï¼Œç”¨äºå‘å…¶å‘é€äºŒè¿›åˆ¶äº‹ä»¶ï¼Œå¹¶ä¿å­˜è‡³ä»èŠ‚ç‚¹æœ¬åœ°çš„ä¸­ç»§æ—¥å¿—ä¸­ï¼Œä»èŠ‚ç‚¹å°†å¯åŠ¨sqlçº¿ç¨‹ä»ä¸­ç»§æ—¥å¿—è¯»å–äºŒè¿›åˆ¶æ—¥å¿—ï¼Œåœ¨æœ¬åœ°é‡æ”¾ï¼Œä½¿å¾—å…¶æ•°æ®å’Œä¸»èŠ‚ç‚¹çš„ä¿æŒä¸€è‡´ï¼Œæœ€åIOçº¿ç¨‹å’Œsqlçº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å”¤é†’\nä»åº“ä¼šç”Ÿæˆä¸¤ä¸ªçº¿ç¨‹,ä¸€ä¸ªI/Oçº¿ç¨‹,ä¸€ä¸ªSQLçº¿ç¨‹; I/Oçº¿ç¨‹ä¼šå»è¯·æ±‚ä¸»åº“çš„binlog,å¹¶å°†å¾—åˆ°çš„binlogå†™åˆ°æœ¬åœ°çš„relay-log(ä¸­ç»§æ—¥å¿—)æ–‡ä»¶ä¸­; ä¸»åº“ä¼šç”Ÿæˆä¸€ä¸ªlog dumpçº¿ç¨‹,ç”¨æ¥ç»™ä»åº“I/Oçº¿ç¨‹ä¼ binlog; SQLçº¿ç¨‹,ä¼šè¯»å–relay logæ–‡ä»¶ä¸­çš„æ—¥å¿—,å¹¶è§£ææˆsqlè¯­å¥é€ä¸€æ‰§è¡Œ; æ³¨æ„ï¼š\n1ã€masterå°†æ“ä½œè¯­å¥è®°å½•åˆ°binlogæ—¥å¿—ä¸­ï¼Œç„¶åæˆäºˆslaveè¿œç¨‹è¿æ¥çš„æƒé™ï¼ˆmasterä¸€å®šè¦å¼€å¯binlogäºŒè¿›åˆ¶æ—¥å¿—åŠŸèƒ½ï¼›é€šå¸¸ä¸ºäº†æ•°æ®å®‰å…¨è€ƒè™‘ï¼Œslaveä¹Ÿå¼€å¯binlogåŠŸèƒ½ï¼‰ã€‚\n2ã€slaveå¼€å¯ä¸¤ä¸ªçº¿ç¨‹ï¼šIOçº¿ç¨‹å’ŒSQLçº¿ç¨‹ã€‚å…¶ä¸­ï¼šIOçº¿ç¨‹è´Ÿè´£è¯»å–masterçš„binlogå†…å®¹åˆ°ä¸­ç»§æ—¥å¿—relay logé‡Œï¼›SQLçº¿ç¨‹è´Ÿè´£ä»relay logæ—¥å¿—é‡Œè¯»å‡ºbinlogå†…å®¹ï¼Œå¹¶æ›´æ–°åˆ°slaveçš„æ•°æ®åº“é‡Œï¼Œè¿™æ ·å°±èƒ½ä¿è¯slaveæ•°æ®å’Œmasteræ•°æ®ä¿æŒä¸€è‡´äº†ã€‚\n3ã€Mysqlå¤åˆ¶è‡³å°‘éœ€è¦ä¸¤ä¸ªMysqlçš„æœåŠ¡ï¼Œå½“ç„¶MysqlæœåŠ¡å¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šå¯åŠ¨å¤šä¸ªæœåŠ¡ã€‚\n4ã€Mysqlå¤åˆ¶æœ€å¥½ç¡®ä¿masterå’ŒslaveæœåŠ¡å™¨ä¸Šçš„Mysqlç‰ˆæœ¬ç›¸åŒï¼ˆå¦‚æœä¸èƒ½æ»¡è¶³ç‰ˆæœ¬ä¸€è‡´ï¼Œé‚£ä¹ˆè¦ä¿è¯masterä¸»èŠ‚ç‚¹çš„ç‰ˆæœ¬ä½äºslaveä»èŠ‚ç‚¹çš„ç‰ˆæœ¬ï¼‰\n5ã€masterå’Œslaveä¸¤èŠ‚ç‚¹é—´æ—¶é—´éœ€åŒæ­¥\n4ã€ä¸»ä»å¤åˆ¶ç®€ä»‹ 1.1. åŸºäºäºŒè¿›åˆ¶æ—¥å¿—å¤åˆ¶çš„\n1.2. ä¸»åº“çš„ä¿®æ”¹æ“ä½œä¼šè®°å½•äºŒè¿›åˆ¶æ—¥å¿—\n1.3. ä»åº“ä¼šè¯·æ±‚æ–°çš„äºŒè¿›åˆ¶æ—¥å¿—å¹¶å›æ”¾,æœ€ç»ˆè¾¾åˆ°ä¸»ä»æ•°æ®åŒæ­¥\n1.4. ä¸»ä»å¤åˆ¶æ ¸å¿ƒåŠŸèƒ½:\nè¾…åŠ©å¤‡ä»½,å¤„ç†ç‰©ç†æŸå æ‰©å±•æ–°å‹çš„æ¶æ„:é«˜å¯ç”¨,é«˜æ€§èƒ½,åˆ†å¸ƒå¼æ¶æ„ç­‰\nå‰æ\n2.1 ä¸¤å°ä»¥ä¸Šmysqlå®ä¾‹ ,server_id,server_uuidä¸åŒ 2.2 ä¸»åº“å¼€å¯äºŒè¿›åˆ¶æ—¥å¿— 2.3 ä¸“ç”¨çš„å¤åˆ¶ç”¨æˆ· 2.4 ä¿è¯ä¸»ä»å¼€å¯ä¹‹å‰çš„æŸä¸ªæ—¶é—´ç‚¹,ä»åº“æ•°æ®æ˜¯å’Œä¸»åº“ä¸€è‡´(è¡¥è¯¾) 2.5 å‘ŠçŸ¥ä»åº“,å¤åˆ¶user,passwd,IP port,ä»¥åŠå¤åˆ¶èµ·ç‚¹(change master to) 2.6 çº¿ç¨‹(ä¸‰ä¸ª):Dump thread IO thread SQL thread å¼€å¯(start slave) ä¸»ä»å¤åˆ¶æ­å»ºè¿‡ç¨‹\næ¸…ç†ä¸»åº“æ•°æ®\n1 rm -rf /data/3307/data/* é‡æ–°åˆå§‹åŒ–3307\n1 mysqld --initialize-insecure --user=mysql --basedir=/app/mysql --datadir=/data/3307/data ä¿®æ”¹my.cnf ,å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—åŠŸèƒ½\n1 2 [root@db01 3307]# vim /data/3307/my.cnf log_bin=/data/3307/data/mysql-bin å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹\n1 2 3 4 5 6 7 8 9 10 [root@db01 3307]# systemctl start mysqld3307 [root@db01 3307]# systemctl start mysqld3308 [root@db01 3307]# systemctl start mysqld3309 [root@db01 3307]# ps -ef |grep mysqld mysql 3684 1 4 09:59 ? 00:00:00 /app/mysql/bin/mysqld --defaults-file=/data/3307/my.cnf mysql 3719 1 7 09:59 ? 00:00:00 /app/mysql/bin/mysqld --defaults-file=/data/3308/my.cnf mysql 3754 1 8 09:59 ? 00:00:00 /app/mysql/bin/mysqld --defaults-file=/data/3309/my.cnf [root@db01 3307]# mysql -S /data/3307/mysql.sock -e \u0026#34;select @@server_id\u0026#34; [root@db01 3307]# mysql -S /data/3308/mysql.sock -e \u0026#34;select @@server_id\u0026#34; [root@db01 3307]# mysql -S /data/3309/mysql.sock -e \u0026#34;select @@server_id\u0026#34; ä¸»åº“ä¸­åˆ›å»ºå¤åˆ¶ç”¨æˆ·\n1 2 3 [root@db01 3307]# mysql -S /data/3307/mysql.sock db01 [(none)]\u0026gt;grant replication slave on *.* to repl@\u0026#39;10.0.0.%\u0026#39; identified by \u0026#39;123\u0026#39;; db01 [(none)]\u0026gt;select user,host from mysql.user; å¤‡ä»½ä¸»åº“å¹¶æ¢å¤åˆ°ä»åº“\n1 2 3 4 [root@db01 3307]# mysqldump -S /data/3307/mysql.sock -A --master-data=2 --single-transaction -R --triggers \u0026gt;/backup/full.sql -- CHANGE MASTER TO MASTER_LOG_FILE=\u0026#39;mysql-bin.000001\u0026#39;, MASTER_LOG_POS=653; [root@db01 3307]# mysql -S /data/3308/mysql.sock db01 [(none)]\u0026gt;source /backup/full.sql å‘ŠçŸ¥ä»åº“å…³é”®å¤åˆ¶ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 ip port user password binlog position [root@db01 3307]# mysql -S /data/3308/mysql.sock db01 [mysql]\u0026gt;help change master to CHANGE MASTER TO MASTER_HOST=\u0026#39;10.0.0.51\u0026#39;, #ä¸»åº“ipåœ°å€ MASTER_USER=\u0026#39;repl\u0026#39;, #å¤åˆ¶ç”¨æˆ· MASTER_PASSWORD=\u0026#39;123\u0026#39;, #å¯†ç  MASTER_PORT=3307, #ç«¯å£ MASTER_LOG_FILE=\u0026#39;mysql-bin.000001\u0026#39;, #å¤åˆ¶binlogçš„èµ·å§‹ä½ç½® MASTER_LOG_POS=653, #èµ·å§‹ä½ç½®çš„poså¥½ MASTER_CONNECT_RETRY=10; #å°è¯•è¿æ¥æ¬¡æ•° å¼€å¯ä¸»ä»ä¸“ç”¨çº¿ç¨‹\n1 start slave ; æ£€æŸ¥å¤åˆ¶çŠ¶æ€\n1 2 3 db01 [mysql]\u0026gt;show slave status \\G Slave_IO_Running: Yes Slave_SQL_Running: Yes ä¸»ä»å¤åˆ¶åŸç†æè¿°ï¼š\n1.change master to æ—¶ï¼Œip pot user password binlog positionå†™å…¥åˆ°master.infoè¿›è¡Œè®°å½• 2. start slave æ—¶ï¼Œä»åº“ä¼šå¯åŠ¨IOçº¿ç¨‹å’ŒSQLçº¿ç¨‹ 3.IO_Tï¼Œè¯»å–master.infoä¿¡æ¯ï¼Œè·å–ä¸»åº“ä¿¡æ¯è¿æ¥ä¸»åº“ 4. ä¸»åº“ä¼šç”Ÿæˆä¸€ä¸ªå‡†å¤‡binlog DUMPçº¿ç¨‹ï¼Œæ¥å“åº”ä»åº“ 5. IO_Tæ ¹æ®master.infoè®°å½•çš„binlogæ–‡ä»¶åå’Œpositionå·ï¼Œè¯·æ±‚ä¸»åº“DUMPæœ€æ–°æ—¥å¿— 6. DUMPçº¿ç¨‹æ£€æŸ¥ä¸»åº“çš„binlogæ—¥å¿—ï¼Œå¦‚æœæœ‰æ–°çš„ï¼ŒTP(ä¼ é€)ç»™ä»ä»åº“çš„IO_T 7. IO_Tå°†æ”¶åˆ°çš„æ—¥å¿—å­˜å‚¨åˆ°äº†TCP/IP ç¼“å­˜ï¼Œç«‹å³è¿”å›ACKç»™ä¸»åº“ ï¼Œä¸»åº“å·¥ä½œå®Œæˆ 8.IO_Tå°†ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œå­˜å‚¨åˆ°relay-logæ—¥å¿—æ–‡ä»¶,æ›´æ–°master.infoæ–‡ä»¶binlog æ–‡ä»¶åå’Œpostionï¼ŒIO_Tå·¥ä½œå®Œæˆ 9.SQL_Tè¯»å–relay-log.infoæ–‡ä»¶ï¼Œè·å–åˆ°ä¸Šæ¬¡æ‰§è¡Œåˆ°çš„relay-logçš„ä½ç½®ï¼Œä½œä¸ºèµ·ç‚¹ï¼Œå›æ”¾relay-log 10.SQL_Tå›æ”¾å®Œæˆä¹‹åï¼Œä¼šæ›´æ–°relay-log.infoæ–‡ä»¶ã€‚ 11. relay-logä¼šæœ‰è‡ªåŠ¨æ¸…ç†çš„åŠŸèƒ½ã€‚ ç»†èŠ‚ï¼š 1.ä¸»åº“ä¸€æ—¦æœ‰æ–°çš„æ—¥å¿—ç”Ÿæˆï¼Œä¼šå‘é€â€œä¿¡å·â€ç»™binlog dump ï¼ŒIOçº¿ç¨‹å†è¯·æ±‚ 5ã€Â å»¶æ—¶ä»åº“ æ˜¯æˆ‘ä»¬è®¤ä¸ºé…ç½®çš„ä¸€ç§ç‰¹æ®Šä»åº“.äººä¸ºé…ç½®ä»åº“å’Œä¸»åº“å»¶æ—¶Nå°æ—¶.\nä¸ºä»€ä¹ˆè¦æœ‰å»¶æ—¶ä»ï¼Ÿ\n1 2 3 4 5 æ•°æ®åº“æ•…éšœ? ç‰©ç†æŸå ä¸»ä»å¤åˆ¶éå¸¸æ“…é•¿è§£å†³ç‰©ç†æŸå. é€»è¾‘æŸå æ™®é€šä¸»ä»å¤åˆ¶æ²¡åŠæ³•è§£å†³é€»è¾‘æŸå é…ç½®å»¶æ—¶ä»åº“\n1 2 3 4 5 6 7 8 9 SQLçº¿ç¨‹å»¶æ—¶:æ•°æ®å·²ç»å†™å…¥relaylogä¸­äº†,SQLçº¿ç¨‹\u0026#34;æ…¢ç‚¹\u0026#34;è¿è¡Œ ä¸€èˆ¬ä¼ä¸šå»ºè®®3-6å°æ—¶,å…·ä½“çœ‹å…¬å¸è¿ç»´äººå‘˜å¯¹äºæ•…éšœçš„ååº”æ—¶é—´ mysql\u0026gt;stop slave; mysql\u0026gt;CHANGE MASTER TO MASTER_DELAY = 300; mysql\u0026gt;start slave; mysql\u0026gt; show slave status \\G SQL_Delay: 300 SQL_Remaining_Delay: NULL å»¶æ—¶ä»åº“åº”ç”¨\n1ä¸»1ä»,ä»åº“å»¶æ—¶5åˆ†é’Ÿ,ä¸»åº“è¯¯åˆ é™¤1ä¸ªåº“\n1. 5åˆ†é’Ÿä¹‹å†… ä¾¦æµ‹åˆ°è¯¯åˆ é™¤æ“ä½œ\n2. åœä»åº“SQLçº¿ç¨‹\n3. æˆªå–relaylog\nèµ·ç‚¹ :åœæ­¢SQLçº¿ç¨‹æ—¶,relayæœ€ååº”ç”¨ä½ç½®\nç»ˆç‚¹:è¯¯åˆ é™¤ä¹‹å‰çš„position(GTID)\n4. æ¢å¤æˆªå–çš„æ—¥å¿—åˆ°ä»åº“\n5. ä»åº“èº«ä»½è§£é™¤,æ›¿ä»£ä¸»åº“å·¥ä½œ\næ•…éšœæ¨¡æ‹ŸåŠæ¢å¤\n1 2 3 4 5 6 1.ä¸»åº“æ•°æ®æ“ä½œ db01 [(none)]\u0026gt;create database relay charset utf8; db01 [(none)]\u0026gt;use relay db01 [relay]\u0026gt;create table t1 (id int); db01 [relay]\u0026gt;insert into t1 values(1); db01 [relay]\u0026gt;drop database relay; 1 2 2. åœæ­¢ä»åº“SQLçº¿ç¨‹ stop slave sql_thread; 1 2 3 4 5 6 7 8 9 3. æ‰¾relaylogçš„æˆªå–èµ·ç‚¹å’Œç»ˆç‚¹ èµ·ç‚¹: Relay_Log_File: db01-relay-bin.000002 Relay_Log_Pos: 482 ç»ˆç‚¹: show relaylog events in \u0026#39;db01-relay-bin.000002\u0026#39; | db01-relay-bin.000002 | 1046 | Xid | 7 | 2489 | COMMIT /* xid=144 */ | | db01-relay-bin.000002 | 1077 | Anonymous_Gtid | 7 | 2554 | SET @@SESSION.GTID_NEXT= \u0026#39;ANONYMOUS\u0026#39; | mysqlbinlog --start-position=482 --stop-position=1077 /data/3308/data/db01-relay-bin.000002\u0026gt;/tmp/relay.sql 1 2 4.ä»åº“æ¢å¤relaylog source /tmp/relay.sql 1 2 3 5.ä»åº“èº«ä»½è§£é™¤ db01 [relay]\u0026gt;stop slave; db01 [relay]\u0026gt;reset slave all 6ã€åŠåŒæ­¥å¤åˆ¶ è§£å†³ä¸»ä»æ•°æ®ä¸€è‡´æ€§é—®é¢˜\n**Â åŠåŒæ­¥å¤åˆ¶å·¥ä½œåŸç†çš„å˜åŒ–**\n1. ä¸»åº“æ‰§è¡Œæ–°çš„äº‹åŠ¡,commitæ—¶,æ›´æ–° show master status\\G ,è§¦å‘ä¸€ä¸ªä¿¡å·ç»™ 2. binlog dump æ¥æ”¶åˆ°ä¸»åº“çš„ show master status\\Gä¿¡æ¯,é€šçŸ¥ä»åº“æ—¥å¿—æ›´æ–°äº† 3. ä»åº“IOçº¿ç¨‹è¯·æ±‚æ–°çš„äºŒè¿›åˆ¶æ—¥å¿—äº‹ä»¶ 4. ä¸»åº“ä¼šé€šè¿‡dumpçº¿ç¨‹ä¼ é€æ–°çš„æ—¥å¿—äº‹ä»¶,ç»™ä»åº“IOçº¿ç¨‹ 5. ä»åº“IOçº¿ç¨‹æ¥æ”¶åˆ°binlogæ—¥å¿—,å½“æ—¥å¿—å†™å…¥åˆ°ç£ç›˜ä¸Šçš„relaylogæ–‡ä»¶æ—¶,ç»™ä¸»åº“ACK_receiverçº¿ç¨‹ 6. ACK_receiverçº¿ç¨‹è§¦å‘ä¸€ä¸ªäº‹ä»¶,å‘Šè¯‰ä¸»åº“commitå¯ä»¥æˆåŠŸäº† 7. å¦‚æœACKè¾¾åˆ°äº†æˆ‘ä»¬é¢„è®¾å€¼çš„è¶…æ—¶æ—¶é—´,åŠåŒæ­¥å¤åˆ¶ä¼šåˆ‡æ¢ä¸ºåŸå§‹çš„å¼‚æ­¥å¤åˆ¶. é…ç½®åŠåŒæ­¥å¤åˆ¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 åŠ è½½æ’ä»¶ ä¸»: INSTALL PLUGIN rpl_semi_sync_master SONAME \u0026#39;semisync_master.so\u0026#39;; ä»: INSTALL PLUGIN rpl_semi_sync_slave SONAME \u0026#39;semisync_slave.so\u0026#39;; æŸ¥çœ‹æ˜¯å¦åŠ è½½æˆåŠŸ: show plugins; å¯åŠ¨: ä¸»: SET GLOBAL rpl_semi_sync_master_enabled = 1; ä»: SET GLOBAL rpl_semi_sync_slave_enabled = 1; é‡å¯ä»åº“ä¸Šçš„IOçº¿ç¨‹ STOP SLAVE IO_THREAD; START SLAVE IO_THREAD; æŸ¥çœ‹æ˜¯å¦åœ¨è¿è¡Œ ä¸»: show status like \u0026#39;Rpl_semi_sync_master_status\u0026#39;; ä»: show status like \u0026#39;Rpl_semi_sync_slave_status\u0026#39;; 7ã€è¿‡æ»¤å¤åˆ¶ ä¸»åº“ï¼š\n1 2 3 show master status; Binlog_Do_DB Binlog_Ignore_DB ä»åº“ï¼š\n1 2 3 show slave status\\G Replicate_Do_DB: Replicate_Ignore_DB: å®ç°è¿‡ç¨‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 mysqldump -S /data/3307/mysql.sock -A --master-data=2 --single-transaction -R --triggers \u0026gt;/backup/full.sql vim /backup/full.sql -- CHANGE MASTER TO MASTER_LOG_FILE=\u0026#39;mysql-bin.000002\u0026#39;, MASTER_LOG_POS=154; [root@db01 ~]# mysql -S /data/3309/mysql.sock source /backup/full.sql CHANGE MASTER TO MASTER_HOST=\u0026#39;10.0.0.51\u0026#39;, MASTER_USER=\u0026#39;repl\u0026#39;, MASTER_PASSWORD=\u0026#39;123\u0026#39;, MASTER_PORT=3307, MASTER_LOG_FILE=\u0026#39;mysql-bin.000002\u0026#39;, MASTER_LOG_POS=154, MASTER_CONNECT_RETRY=10; start slave; [root@db01 ~]# vim /data/3309/my.cnf replicate_do_db=ppt replicate_do_db=word [root@db01 ~]# systemctl restart mysqld3309 ä¸»åº“ï¼š Master [(none)]\u0026gt;create database word; Query OK, 1 row affected (0.00 sec) Master [(none)]\u0026gt;create database ppt; Query OK, 1 row affected (0.00 sec) Master [(none)]\u0026gt;create database excel; Query OK, 1 row affected (0.01 sec) 8ã€GTIDå¤åˆ¶ GTIDä»‹ç»\n1 2 3 4 5 6 GTID(Global Transaction ID)æ˜¯å¯¹äºä¸€ä¸ªå·²æäº¤äº‹åŠ¡çš„å”¯ä¸€ç¼–å·ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªå…¨å±€(ä¸»ä»å¤åˆ¶)å”¯ä¸€çš„ç¼–å·ã€‚ å®ƒçš„å®˜æ–¹å®šä¹‰å¦‚ä¸‹ï¼š GTID = source_id ï¼štransaction_id 7E11FA47-31CA-19E1-9E56-C43AA21293967:29 ä»€ä¹ˆæ˜¯sever_uuidï¼Œå’ŒServer-id åŒºåˆ«ï¼Ÿ æ ¸å¿ƒç‰¹æ€§: å…¨å±€å”¯ä¸€,å…·å¤‡å¹‚ç­‰æ€§ GTIDæ ¸å¿ƒå‚æ•°\n1 2 3 4 5 6 7 gtid-mode=on enforce-gtid-consistency=true log-slave-updates=1 gtid-mode=on --å¯ç”¨gtidç±»å‹ï¼Œå¦åˆ™å°±æ˜¯æ™®é€šçš„å¤åˆ¶æ¶æ„ enforce-gtid-consistency=true --å¼ºåˆ¶GTIDçš„ä¸€è‡´æ€§ log-slave-updates=1 --slaveæ›´æ–°æ˜¯å¦è®°å…¥æ—¥å¿— GTIDå¤åˆ¶é…ç½®è¿‡ç¨‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 ä¸»åº“db01ï¼š cat \u0026gt; /etc/my.cnf \u0026lt;\u0026lt;EOF [mysqld] basedir=/data/mysql/ datadir=/data/mysql/data socket=/tmp/mysql.sock server_id=51 port=3306 secure-file-priv=/tmp autocommit=0 log_bin=/data/binlog/mysql-bin binlog_format=row gtid-mode=on enforce-gtid-consistency=true log-slave-updates=1 [mysql] prompt=db01 [\\\\d]\u0026gt; EOF slave1(db02)ï¼š cat \u0026gt; /etc/my.cnf \u0026lt;\u0026lt;EOF [mysqld] basedir=/data/mysql datadir=/data/mysql/data socket=/tmp/mysql.sock server_id=52 port=3306 secure-file-priv=/tmp autocommit=0 log_bin=/data/binlog/mysql-bin binlog_format=row gtid-mode=on enforce-gtid-consistency=true log-slave-updates=1 [mysql] prompt=db02 [\\\\d]\u0026gt; EOF slave2(db03)ï¼š cat \u0026gt; /etc/my.cnf \u0026lt;\u0026lt;EOF [mysqld] basedir=/data/mysql datadir=/data/mysql/data socket=/tmp/mysql.sock server_id=53 port=3306 secure-file-priv=/tmp autocommit=0 log_bin=/data/binlog/mysql-bin binlog_format=row gtid-mode=on enforce-gtid-consistency=true log-slave-updates=1 [mysql] prompt=db03 [\\\\d]\u0026gt; EOF åˆå§‹åŒ–æ•°æ®\n1 mysqld --initialize-insecure --user=mysql --basedir=/data/mysql --datadir=/data/mysql/data å¯åŠ¨æ•°æ®åº“\n1 /etc/init.d/mysqld start æ„å»ºä¸»ä»\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 master:51 slave:52,53 51: grant replication slave on *.* to repl@\u0026#39;10.0.0.%\u0026#39; identified by \u0026#39;123\u0026#39;; 52\\53: change master to master_host=\u0026#39;10.0.0.51\u0026#39;, master_user=\u0026#39;repl\u0026#39;, master_password=\u0026#39;123\u0026#39; , MASTER_AUTO_POSITION=1; start slave; GTID ä»åº“è¯¯å†™å…¥æ“ä½œå¤„ç†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 æŸ¥çœ‹ç›‘æ§ä¿¡æ¯: Last_SQL_Error: Error \u0026#39;Can\u0026#39;t create database \u0026#39;oldboy\u0026#39;; database exists\u0026#39; on query. Default database: \u0026#39;oldboy\u0026#39;. Query: \u0026#39;create database oldboy\u0026#39; Retrieved_Gtid_Set: 71bfa52e-4aae-11e9-ab8c-000c293b577e:1-3 Executed_Gtid_Set: 71bfa52e-4aae-11e9-ab8c-000c293b577e:1-2, 7ca4a2b7-4aae-11e9-859d-000c298720f6:1 æ³¨å…¥ç©ºäº‹ç‰©çš„æ–¹æ³•ï¼š stop slave; set gtid_next=\u0026#39;99279e1e-61b7-11e9-a9fc-000c2928f5dd:3\u0026#39;; begin;commit; set gtid_next=\u0026#39;AUTOMATIC\u0026#39;; è¿™é‡Œçš„xxxxx:N ä¹Ÿå°±æ˜¯ä½ çš„slave sql threadæŠ¥é”™çš„GTIDï¼Œæˆ–è€…è¯´æ˜¯ä½ æƒ³è¦è·³è¿‡çš„GTIDã€‚ æœ€å¥½çš„è§£å†³æ–¹æ¡ˆï¼šé‡æ–°æ„å»ºä¸»ä»ç¯å¢ƒ GTID å¤åˆ¶å’Œæ™®é€šå¤åˆ¶çš„åŒºåˆ«\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 CHANGE MASTER TO MASTER_HOST=\u0026#39;10.0.0.51\u0026#39;, MASTER_USER=\u0026#39;repl\u0026#39;, MASTER_PASSWORD=\u0026#39;123\u0026#39;, MASTER_PORT=3307, MASTER_LOG_FILE=\u0026#39;mysql-bin.000001\u0026#39;, MASTER_LOG_POS=444, MASTER_CONNECT_RETRY=10; change master to master_host=\u0026#39;10.0.0.51\u0026#39;, master_user=\u0026#39;repl\u0026#39;, master_password=\u0026#39;123\u0026#39; , MASTER_AUTO_POSITION=1; start slave; ï¼ˆ0ï¼‰åœ¨ä¸»ä»å¤åˆ¶ç¯å¢ƒä¸­ï¼Œä¸»åº“å‘ç”Ÿè¿‡çš„äº‹åŠ¡ï¼Œåœ¨å…¨å±€éƒ½æ˜¯ç”±å”¯ä¸€GTIDè®°å½•çš„ï¼Œæ›´æ–¹ä¾¿Failover ï¼ˆ1ï¼‰é¢å¤–åŠŸèƒ½å‚æ•°ï¼ˆ3ä¸ªï¼‰ ï¼ˆ2ï¼‰change master to çš„æ—¶å€™ä¸å†éœ€è¦binlog æ–‡ä»¶åå’Œpositionå·,MASTER_AUTO_POSITION=1; ï¼ˆ3ï¼‰åœ¨å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œä»åº“ä¸å†ä¾èµ–master.infoæ–‡ä»¶ï¼Œè€Œæ˜¯ç›´æ¥è¯»å–æœ€åä¸€ä¸ªrelaylogçš„ GTIDå· ï¼ˆ4ï¼‰ mysqldumpå¤‡ä»½æ—¶ï¼Œé»˜è®¤ä¼šå°†å¤‡ä»½ä¸­åŒ…å«çš„äº‹åŠ¡æ“ä½œï¼Œä»¥ä»¥ä¸‹æ–¹å¼ SET @@GLOBAL.GTID_PURGED=\u0026#39;8c49d7ec-7e78-11e8-9638-000c29ca725d:1\u0026#39;; å‘Šè¯‰ä»åº“ï¼Œæˆ‘çš„å¤‡ä»½ä¸­å·²ç»æœ‰ä»¥ä¸Šäº‹åŠ¡ï¼Œä½ å°±ä¸ç”¨è¿è¡Œäº†ï¼Œç›´æ¥ä»ä¸‹ä¸€ä¸ªGTIDå¼€å§‹è¯·æ±‚binlogå°±è¡Œã€‚ 9. ä¸»ä»æ•…éšœç›‘æ§\\åˆ†æ\\å¤„ç† ä¸»åº“:\n1 2 3 4 5 6 7 show full processlist; æ¯ä¸ªä»åº“éƒ½ä¼šæœ‰ä¸€è¡Œdumpç›¸å…³çš„ä¿¡æ¯ HOSTS: db01:47176 State: Master has sent all binlog to slave; waiting for more updates å¦‚æœç°å®éä»¥ä¸Šä¿¡æ¯,è¯´æ˜ä¸»ä»ä¹‹é—´çš„å…³ç³»å‡ºç°äº†é—®é¢˜ ä»åº“:\n1 2 db01 [(none)]\u0026gt;show slave status \\G *************************** 1. row *************************** ä¸»åº“ç›¸å…³ä¿¡æ¯ç›‘æ§\n1 2 3 4 5 Master_Host: 10.0.0.51 Master_User: repl Master_Port: 3307 Master_Log_File: mysql-bin.000005 Read_Master_Log_Pos: 444 ä»åº“ä¸­ç»§æ—¥å¿—çš„åº”ç”¨çŠ¶æ€\n1 2 Relay_Log_File: db01-relay-bin.000002 Relay_Log_Pos: 485 ä»åº“å¤åˆ¶çº¿ç¨‹æœ‰å…³çš„çŠ¶æ€\n1 2 3 4 5 6 Slave_IO_Running: Yes Slave_SQL_Running: Yes Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: è¿‡æ»¤å¤åˆ¶æœ‰å…³çš„çŠ¶æ€\n1 2 3 4 5 6 Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: ä¸»ä»å»¶æ—¶ç›¸å…³çŠ¶æ€(éäººä¸º)\n1 Seconds_Behind_Master: 0 å»¶æ—¶ä»åº“æœ‰å…³çš„çŠ¶æ€(äººä¸º)\n1 2 SQL_Delay: 0 SQL_Remaining_Delay: NULL GTID å¤åˆ¶æœ‰å…³çš„çŠ¶æ€\n1 2 3 Retrieved_Gtid_Set: Executed_Gtid_Set: Auto_Position: 0 ä¸»ä»å¤åˆ¶æ•…éšœåˆ†æ 1 2 3 4 5 6 7 8 9 10 11 (1) ç”¨æˆ· å¯†ç  IP port Last_IO_Error: error reconnecting to master \u0026#39;repl@10.0.0.51:3307\u0026#39; - retry-time: 10 retries: 7 [root@db01 ~]# mysql -urepl -p123333 -h 10.0.0.51 -P 3307 ERROR 1045 (28000): Access denied for user \u0026#39;repl\u0026#39;@\u0026#39;db01\u0026#39; (using password: YES) åŸå› : å¯†ç é”™è¯¯ ç”¨æˆ·é”™è¯¯ skip_name_resolve åœ°å€é”™è¯¯ ç«¯å£ å¤„ç†æ–¹æ³•\n1 2 3 4 stop slave reset slave all change master to start slave ä¸»åº“è¿æ¥æ•°ä¸Šçº¿,æˆ–è€…æ˜¯ä¸»åº“å¤ªç¹å¿™\n1 2 3 4 5 6 7 8 9 10 11 12 13 show slave staus \\G Last_IO_Errno: 1040 Last_IO_Error: error reconnecting to master \u0026#39;repl@10.0.0.51:3307\u0026#39; - retry-time: 10 retries: 7 å¤„ç†æ€è·¯: æ‹¿å¤åˆ¶ç”¨æˆ·,æ‰‹å·¥è¿æ¥ä¸€ä¸‹ [root@db01 ~]# mysql -urepl -p123 -h 10.0.0.51 -P 3307 mysql: [Warning] Using a password on the command line interface can be insecure. ERROR 1040 (HY000): Too many connections å¤„ç†æ–¹æ³•: db01 [(none)]\u0026gt;set global max_connections=300; (3) é˜²ç«å¢™,ç½‘ç»œä¸é€š è¯·æ±‚äºŒè¿›åˆ¶æ—¥å¿—\n1 2 3 ä¸»åº“ç¼ºå¤±æ—¥å¿— ä»åº“æ–¹é¢,äºŒè¿›åˆ¶æ—¥å¿—ä½ç½®ç‚¹ä¸å¯¹ Last_IO_Error: Got fatal error 1236 from master when reading data from binary log: \u0026#39;could not find next log; the first event \u0026#39;mysql-bin.000001\u0026#39; at 154, the last event read from \u0026#39;/data/3307/data/mysql-bin.000002\u0026#39; at 154, the last byte read from \u0026#39;/data/3307/data/mysql-bin.000002\u0026#39; at 154.\u0026#39; 1 2 3 æ³¨æ„: åœ¨ä¸»ä»å¤åˆ¶ç¯å¢ƒä¸­,ä¸¥ä»¤ç¦æ­¢ä¸»åº“ä¸­reset master; å¯ä»¥é€‰æ‹©expire è¿›è¡Œå®šæœŸæ¸…ç†ä¸»åº“äºŒè¿›åˆ¶æ—¥å¿— è§£å†³æ–¹æ¡ˆ: é‡æ–°æ„å»ºä¸»ä» **Â SQL çº¿ç¨‹æ•…éšœ**\nSQLçº¿ç¨‹åŠŸèƒ½ï¼š\n1 2 3 (1)è¯»å†™relay-log.info (2)relay-logæŸå,æ–­èŠ‚,æ‰¾ä¸åˆ° (3)æ¥æ”¶åˆ°çš„SQLæ— æ³•æ‰§è¡Œ å¯¼è‡´SQLçº¿ç¨‹æ•…éšœåŸå› åˆ†æï¼š\n1 2 3 4 5 6 1. ç‰ˆæœ¬å·®å¼‚ï¼Œå‚æ•°è®¾å®šä¸åŒï¼Œæ¯”å¦‚ï¼šæ•°æ®ç±»å‹çš„å·®å¼‚ï¼ŒSQL_MODEå½±å“ 2.è¦åˆ›å»ºçš„æ•°æ®åº“å¯¹è±¡,å·²ç»å­˜åœ¨ 3.è¦åˆ é™¤æˆ–ä¿®æ”¹çš„å¯¹è±¡ä¸å­˜åœ¨ 4.DMLè¯­å¥ä¸ç¬¦åˆè¡¨å®šä¹‰åŠçº¦æŸæ—¶. å½’æ ¹æ­åº•çš„åŸå› éƒ½æ˜¯ç”±äºä»åº“å‘ç”Ÿäº†å†™å…¥æ“ä½œ. Last_SQL_Error: Error \u0026#39;Can\u0026#39;t create database \u0026#39;db\u0026#39;; database exists\u0026#39; on query. Default database: \u0026#39;db\u0026#39;. Query: \u0026#39;create database db\u0026#39; å¤„ç†æ–¹æ³•(ä»¥ä»åº“ä¸ºæ ¸å¿ƒçš„å¤„ç†æ–¹æ¡ˆ)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 æ–¹æ³•ä¸€ï¼š stop slave; set global sql_slave_skip_counter = 1; #å°†åŒæ­¥æŒ‡é’ˆå‘ä¸‹ç§»åŠ¨ä¸€ä¸ªï¼Œå¦‚æœå¤šæ¬¡ä¸åŒæ­¥ï¼Œå¯ä»¥é‡å¤æ“ä½œã€‚ start slave; æ–¹æ³•äºŒï¼š /etc/my.cnf slave-skip-errors = 1032,1062,1007 å¸¸è§é”™è¯¯ä»£ç : 1007:å¯¹è±¡å·²å­˜åœ¨ 1032:æ— æ³•æ‰§è¡ŒDML 1062:ä¸»é”®å†²çª,æˆ–çº¦æŸå†²çª ä½†æ˜¯ï¼Œä»¥ä¸Šæ“ä½œæœ‰æ—¶æ˜¯æœ‰é£é™©çš„ï¼Œæœ€å®‰å…¨çš„åšæ³•å°±æ˜¯é‡æ–°æ„å»ºä¸»ä»ã€‚æŠŠæ¡ä¸€ä¸ªåŸåˆ™,ä¸€åˆ‡ä»¥ä¸»åº“ä¸ºä¸». ä¸€åŠ³æ°¸é€¸çš„æ–¹æ³•:\n1 2 3 4 5 6 (1) å¯ä»¥è®¾ç½®ä»åº“åªè¯». db01 [(none)]\u0026gt;show variables like \u0026#39;%read_only%\u0026#39;; æ³¨æ„ï¼š åªä¼šå½±å“åˆ°æ™®é€šç”¨æˆ·ï¼Œå¯¹ç®¡ç†å‘˜ç”¨æˆ·æ— æ•ˆã€‚ (2)åŠ ä¸­é—´ä»¶ è¯»å†™åˆ†ç¦»ã€‚ ä¸»ä»å»¶æ—¶ç›‘æ§åŠåŸå› Â 1 ä¸»åº“åšäº†ä¿®æ”¹æ“ä½œ,ä»åº“æ¯”è¾ƒé•¿æ—¶é—´æ‰èƒ½è¿½ä¸Š. å¤–åœ¨å› ç´ \n1 2 3 4 ç½‘ç»œ ä¸»ä»ç¡¬ä»¶å·®å¼‚è¾ƒå¤§ ç‰ˆæœ¬å·®å¼‚ å‚æ•°å› ç´  ä¸»åº“\n1 2 3 4 5 6 7 8 9 10 11 (1) äºŒè¿›åˆ¶æ—¥å¿—å†™å…¥ä¸åŠæ—¶ [rep]\u0026gt;select @@sync_binlog; (2) CRçš„ä¸»ä»å¤åˆ¶ä¸­,binlog_dumpçº¿ç¨‹,äº‹ä»¶ä¸ºå•å…ƒ,ä¸²è¡Œä¼ é€äºŒè¿›åˆ¶æ—¥å¿—(5.6 5.5) 1. ä¸»åº“å¹¶å‘äº‹åŠ¡é‡å¤§,ä¸»åº“å¯ä»¥å¹¶è¡Œ,ä¼ é€æ—¶æ˜¯ä¸²è¡Œ 2. ä¸»åº“å‘ç”Ÿäº†å¤§äº‹åŠ¡,ç”±äºæ˜¯ä¸²è¡Œä¼ é€,ä¼šäº§ç”Ÿé˜»å¡åç»­çš„äº‹åŠ¡. è§£å†³æ–¹æ¡ˆ: 1. 5.6 å¼€å§‹,å¼€å¯GTID,å®ç°äº†GC(group commit)æœºåˆ¶,å¯ä»¥å¹¶è¡Œä¼ è¾“æ—¥å¿—ç»™ä»åº“IO 2. 5.7 å¼€å§‹,ä¸å¼€å¯GTID,ä¼šè‡ªåŠ¨ç»´æŠ¤åŒ¿åçš„GTID,ä¹Ÿèƒ½å®ç°GC,æˆ‘ä»¬å»ºè®®è¿˜æ˜¯è®¤ä¸ºå¼€å¯GTID 3. å¤§äº‹åŠ¡æ‹†æˆå¤šä¸ªå°äº‹åŠ¡,å¯ä»¥æœ‰æ•ˆçš„å‡å°‘ä¸»ä»å»¶æ—¶. ä»åº“\n1 2 3 4 5 6 7 8 9 10 11 SQLçº¿ç¨‹å¯¼è‡´çš„ä¸»ä»å»¶æ—¶ åœ¨CRå¤åˆ¶æƒ…å†µä¸‹: ä»åº“é»˜è®¤æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªSQL,åªèƒ½ä¸²è¡Œå›æ”¾äº‹åŠ¡SQL 1. ä¸»åº“å¦‚æœå¹¶å‘äº‹åŠ¡é‡è¾ƒå¤§,ä»åº“åªèƒ½ä¸²è¡Œå›æ”¾ 2. ä¸»åº“å‘ç”Ÿäº†å¤§äº‹åŠ¡,ä¼šé˜»å¡åç»­çš„æ‰€æœ‰çš„äº‹åŠ¡çš„è¿è¡Œ è§£å†³æ–¹æ¡ˆ: 1. 5.6 ç‰ˆæœ¬å¼€å¯GTIDä¹‹å,åŠ å…¥äº†SQLå¤šçº¿ç¨‹çš„ç‰¹æ€§,ä½†æ˜¯åªèƒ½é’ˆå¯¹ä¸åŒåº“(database)ä¸‹çš„äº‹åŠ¡è¿›è¡Œå¹¶å‘å›æ”¾. 2. 5.7 ç‰ˆæœ¬å¼€å§‹GTIDä¹‹å,åœ¨SQLæ–¹é¢,æä¾›äº†åŸºäºé€»è¾‘æ—¶é’Ÿ(logical_clock),binlogåŠ å…¥äº†seq_noæœºåˆ¶, çœŸæ­£å®ç°äº†åŸºäºäº‹åŠ¡çº§åˆ«çš„å¹¶å‘å›æ”¾,è¿™ç§æŠ€æœ¯æˆ‘ä»¬æŠŠå®ƒç§°ä¹‹ä¸ºMTS(enhanced multi-threaded slave). 3. å¤§äº‹åŠ¡æ‹†æˆå¤šä¸ªå°äº‹åŠ¡,å¯ä»¥æœ‰æ•ˆçš„å‡å°‘ä¸»ä»å»¶æ—¶. [https://dev.mysql.com/worklog/task/?id=6314] ","date":"2020-06-09T17:35:28Z","image":"https://www.ownit.top/title_pic/24.jpg","permalink":"https://www.ownit.top/p/202006091735/","title":"ä»€ä¹ˆï¼Œä½ è¿˜ä¸ä¼šMysqlä¸»ä»å¤åˆ¶ï¼Ÿï¼Ÿï¼Ÿå¿«æ¥çœ‹"},{"content":"ç›®å½•\n1ã€ç”¨æˆ·çš„åˆ›å»ºå¤„ç†åŸå§‹ç¯å¢ƒ\n2ã€ä¸‹è½½ï¼Œä¸Šä¼ æ–‡ä»¶\n3ã€è§£å‹äºŒè¿›åˆ¶åŒ…\n4ã€æ·»åŠ ä¸€ä¸ªç£ç›˜ï¼ŒæŒ‚è½½/dataæ•°æ®\n5ã€åˆ›å»ºæ•°æ®è·¯å¾„å¹¶æˆæƒ\n6ã€è®¾ç½®ç¯å¢ƒå˜é‡\n7ã€Mysqlè´¦å·æˆæƒç›¸åº”çš„æ–‡ä»¶\n8ã€æ•°æ®åº“åˆå§‹åŒ–Â 9ã€é…ç½®æ–‡ä»¶çš„å‡†å¤‡\n10ã€å¯åŠ¨æ•°æ®åº“\n11ã€å¦‚ä½•åˆ†æå¤„ç†MySQLæ•°æ®åº“æ— æ³•å¯åŠ¨\n12ã€ç®¡ç†å‘˜å¯†ç çš„è®¾å®šï¼ˆroot@localhostï¼‰\n13ã€ç®¡ç†å‘˜ç”¨æˆ·å¯†ç å¿˜è®°äº†ï¼Ÿ\n14ã€å¯åŠ¨æ•°æ®åº“åˆ°ç»´æŠ¤æ¨¡å¼\nRDBMS : å…³ç³»å‹æ•°æ®åº“ ç®¡ç†ç³»ç»Ÿ\nNoSQL : éå…³ç³»å‹çš„\nNewSQL : æ–°å‹çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ\n1ã€ç”¨æˆ·çš„åˆ›å»ºå¤„ç†åŸå§‹ç¯å¢ƒ 1 2 3 [root@db01 ~]# yum remove mariadb-libs-5.5.60-1.el7_5.x86_64 -y [root@db01 ~]# rpm -qa |grep mariadb [root@db01 ~]# useradd -s /sbin/nologin mysql MySQL 5.7.26 äºŒè¿›åˆ¶ç‰ˆæœ¬å®‰è£…\nhttps://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.26-linux-glibc2.12-x86_64.tar.gz\n2ã€ä¸‹è½½ï¼Œä¸Šä¼ æ–‡ä»¶ 1 2 3 4 5 [root@db01 ~]# mkdir -p /server/tools [root@db01 ~]# cd /server/tools/ [root@db01 /server/tools]# yum install -y lrzsz [root@db01 /server/tools]# ls mysql-5.7.26-linux-glibc2.12-x86_64.tar.gz 3ã€è§£å‹äºŒè¿›åˆ¶åŒ… 1 2 3 [root@db01 /server/tools]# tar xf mysql-5.7.26-linux-glibc2.12-x86_64.tar.gz [root@db01 ~]# mkdir /application [root@db01 /server/tools]# mv mysql-5.7.26-linux-glibc2.12-x86_64 /application/mysql åŸºæœ¬æ€è·¯ï¼šæŠŠè½¯ä»¶å­˜æ”¾ä½ç½®å’Œæ•°æ®å­˜æ”¾ä½ç½®åˆ†å¼€ï¼Œç¡®ä¿æ•°æ®å®‰å…¨\n4ã€æ·»åŠ ä¸€ä¸ªç£ç›˜ï¼ŒæŒ‚è½½/dataæ•°æ® 5ã€åˆ›å»ºæ•°æ®è·¯å¾„å¹¶æˆæƒ 1 2 3 4 5 6 7 [root@db01 ~]# mkfs.xfs /dev/sdc [root@db01 ~]# mkdir /mysql [root@db01 ~]# blkid [root@db01 ~]# vim /etc/fstab [root@db01 ~]# UUID=\u0026#34;7d7814c3-1ad2-4622-a435-7086d05d6c55\u0026#34; /mysql xfs defaults 0 0 [root@db01 ~]# mount -a [root@db01 ~]# df -h 6ã€è®¾ç½®ç¯å¢ƒå˜é‡ 1 2 3 4 5 vim /etc/profile export PATH=/application/mysql/bin:$PATH [root@db01 ~]# source /etc/profile [root@db01 ~]# mysql -V mysql Ver 14.14 Distrib 5.7.26, for linux-glibc2.12 (x86_64) using EditLine wrapper 7ã€Mysqlè´¦å·æˆæƒç›¸åº”çš„æ–‡ä»¶ 1 2 3 æˆæƒ chown -R mysql.mysql /application/* chown -R mysql.mysql /mysql 8ã€æ•°æ®åº“åˆå§‹åŒ–Â 1 2 3 4 5 5.6 ç‰ˆæœ¬ åˆå§‹åŒ–å‘½ä»¤ /application/mysql/scripts/mysql_install_db # 5.7 ç‰ˆæœ¬ [root@db01 ~]# mkdir /mysql/mysql/data -p [root@db01 ~]# chown -R mysql.mysql /mysql [root@db01 ~]# mysqld --initialize --user=mysql --basedir=/application/mysql --datadir=/mysql/mysql/data è¯´æ˜ï¼š\n--initialize å‚æ•°ï¼š\n1. å¯¹äºå¯†ç å¤æ‚åº¦è¿›è¡Œå®šåˆ¶ï¼š12ä½ï¼Œ4ç§ 2. å¯†ç è¿‡æœŸæ—¶é—´ï¼š180 3. ç»™root@localhostç”¨æˆ·è®¾ç½®ä¸´æ—¶å¯†ç  --initialize-insecure å‚æ•°ï¼š\næ— é™åˆ¶ï¼Œæ— ä¸´æ—¶å¯†ç \n1 2 [root@db01 /data/mysql/data]# \\rm -rf /data/mysql/data/* [root@db01 ~]# mysqld --initialize-insecure --user=mysql --basedir=/application/mysql --datadir=/mysql/mysql/data æ²¡æœ‰å¯†ç \n9ã€é…ç½®æ–‡ä»¶çš„å‡†å¤‡ 1 2 3 4 5 6 7 8 9 10 11 cat \u0026gt;/etc/my.cnf \u0026lt;\u0026lt;EOF [mysqld] user=mysql basedir=/application/mysql datadir=/mysql/mysql/data socket=/tmp/mysql.sock server_id=6 port=3306 [mysql] socket=/tmp/mysql.sock EOF 10ã€å¯åŠ¨æ•°æ®åº“ 1. sys-v\n1 2 [root@db01 /etc/init.d]# cp /application/mysql/support-files/mysql.server /etc/init.d/mysqld [root@db01 /etc/init.d]# service mysqld restart 2. systemd\næ³¨æ„ï¼š sysvæ–¹å¼å¯åŠ¨è¿‡çš„è¯ï¼Œéœ€è¦å…ˆæå‰å…³é—­ï¼Œæ‰èƒ½ä»¥ä¸‹æ–¹å¼ç™»å½•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 cat \u0026gt;/etc/systemd/system/mysqld.service \u0026lt;\u0026lt;EOF [Unit] Description=MySQL Server Documentation=man:mysqld(8) Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html After=network.target After=syslog.target [Install] WantedBy=multi-user.target [Service] User=mysql Group=mysql ExecStart=/application/mysql/bin/mysqld --defaults-file=/etc/my.cnf LimitNOFILE = 5000 EOF 11ã€å¦‚ä½•åˆ†æå¤„ç†MySQLæ•°æ®åº“æ— æ³•å¯åŠ¨ without updating PID ç±»ä¼¼é”™è¯¯\næŸ¥çœ‹æ—¥å¿—ï¼š\nåœ¨å“ªï¼Ÿ\n/data/mysql/data/ä¸»æœºå.err\n[ERROR] ä¸Šä¸‹æ–‡\nå¯èƒ½æƒ…å†µï¼š\n/etc/my.cnf è·¯å¾„ä¸å¯¹ç­‰\n/tmp/mysql.sockæ–‡ä»¶ä¿®æ”¹è¿‡ æˆ– åˆ é™¤è¿‡\næ•°æ®ç›®å½•æƒé™ä¸æ˜¯mysql\nå‚æ•°æ”¹é”™äº†\n12ã€ç®¡ç†å‘˜å¯†ç çš„è®¾å®šï¼ˆroot@localhostï¼‰ 1 2 [root@db01 ~]# mysqladmin -uroot -p password oldboy123 Enter password: 13ã€ç®¡ç†å‘˜ç”¨æˆ·å¯†ç å¿˜è®°äº†ï¼Ÿ 1 2 --skip-grant-tables #è·³è¿‡æˆæƒè¡¨ --skip-networking #è·³è¿‡è¿œç¨‹ç™»å½• 14ã€å¯åŠ¨æ•°æ®åº“åˆ°ç»´æŠ¤æ¨¡å¼ 1 [root@db01 ~]# mysqld_safe --skip-grant-tables --skip-networking \u0026amp; ç™»å½•å¹¶ä¿®æ”¹å¯†ç \n1 2 3 4 5 mysql\u0026gt; alter user root@\u0026#39;localhost\u0026#39; identified by \u0026#39;1\u0026#39;; ERROR 1290 (HY000): The MySQL server is running with the --skip-grant-tables option so it cannot execute this statement mysql\u0026gt; flush privileges; mysql\u0026gt; alter user root@\u0026#39;localhost\u0026#39; identified by \u0026#39;1\u0026#39;; Query OK, 0 rows affected (0.01 sec) å…³é—­æ•°æ®åº“ï¼Œæ­£å¸¸å¯åŠ¨éªŒè¯\n","date":"2020-06-09T16:28:58Z","image":"https://www.ownit.top/title_pic/02.jpg","permalink":"https://www.ownit.top/p/202006091628/","title":"MySQLäºŒè¿›åˆ¶å®‰è£…ï¼ˆç‰ˆæœ¬ï¼š5.7.26ï¼‰"},{"content":"1.è¿ç»´åœ¨æ•°æ®åº“å¤‡ä»½æ¢å¤æ–¹é¢çš„èŒè´£ 1.è®¾è®¡å¤‡ä»½ç­–ç•¥\nå…¨å¤‡ ã€å¢é‡ã€æ—¶é—´ã€è‡ªåŠ¨\n2.æ—¥å¸¸å¤‡ä»½æ£€æŸ¥\nå¤‡ä»½å­˜åœ¨æ€§ å¤‡ä»½ç©ºé—´å¤Ÿç”¨å¦ **Â 3.å®šæœŸæ¢å¤æ¼”ç»ƒ(æµ‹è¯•åº“)**\nä¸€å­£åº¦ æˆ–è€… åŠå¹´\n4.æ•…éšœæ¢å¤\né€šè¿‡ç°æœ‰å¤‡ä»½,èƒ½å¤Ÿå°†æ•°æ®åº“æ¢å¤åˆ°æ•…éšœä¹‹å‰çš„æ—¶é—´ç‚¹. 5.è¿ç§»\n1. åœæœºæ—¶é—´\n2. å›é€€æ–¹æ¡ˆ\n2.Mysqlæ•°æ®æŸåç±»å‹ 1.ç‰©ç†æŸå\nç£ç›˜æŸåï¼šç¡¬ä»¶ï¼Œç£é“åï¼Œddï¼Œæ ¼å¼åŒ–\næ–‡ä»¶æŸåï¼šæ•°æ®æ–‡ä»¶æŸåï¼ŒredoæŸå\n2.é€»è¾‘æŸå\n1 2 3 4 drop delete truncate update 3. å¤‡ä»½ç±»å‹ 1.çƒ­å¤‡\nåœ¨æ•°æ®åº“æ­£å¸¸ä¸šåŠ¡æ—¶,å¤‡ä»½æ•°æ®,å¹¶ä¸”èƒ½å¤Ÿä¸€è‡´æ€§æ¢å¤ï¼ˆåªèƒ½æ˜¯innodbï¼‰\nå¯¹ä¸šåŠ¡å½±å“éå¸¸å°\n2.æ¸©å¤‡\né”è¡¨å¤‡ä»½,åªèƒ½æŸ¥è¯¢ä¸èƒ½ä¿®æ”¹ï¼ˆmyisamï¼‰\nå½±å“åˆ°å†™å…¥æ“ä½œ\n3.å†·å¤‡\nå…³é—­æ•°æ®åº“ä¸šåŠ¡,æ•°æ®åº“æ²¡æœ‰ä»»ä½•å˜æ›´çš„æƒ…å†µä¸‹,è¿›è¡Œå¤‡ä»½æ•°æ®.\nä¸šåŠ¡åœæ­¢\n4. å¤‡ä»½æ–¹å¼åŠå·¥å…·ä»‹ç» 1.é€»è¾‘å¤‡ä»½å·¥å…·\n1 2 3 åŸºäºSQLè¯­å¥è¿›è¡Œå¤‡ä»½ mysqldump ***** mysqlbinlog ***** 2. ç‰©ç†å¤‡ä»½å·¥å…·\n1 2 3 åŸºäºç£ç›˜æ•°æ®æ–‡ä»¶å¤‡ä»½ xtrabackup(XBK) ï¼špercona ç¬¬ä¸‰æ–¹ ***** MySQL Enterprise Backupï¼ˆMEBï¼‰ 5. é€»è¾‘å¤‡ä»½å’Œç‰©ç†å¤‡ä»½çš„æ¯”è¾ƒ mysqldump (MDP)\nä¼˜ç‚¹ï¼š\n1.ä¸éœ€è¦ä¸‹è½½å®‰è£… 2.å¤‡ä»½å‡ºæ¥çš„æ˜¯SQLï¼Œæ–‡æœ¬æ ¼å¼ï¼Œå¯è¯»æ€§é«˜,ä¾¿äºå¤‡ä»½å¤„ç† 3.å‹ç¼©æ¯”è¾ƒé«˜ï¼ŒèŠ‚çœå¤‡ä»½çš„ç£ç›˜ç©ºé—´ ç¼ºç‚¹ï¼š\nä¾èµ–äºæ•°æ®åº“å¼•æ“ï¼Œéœ€è¦ä»ç£ç›˜æŠŠæ•°æ®è¯»å‡ºï¼Œç„¶åè½¬æ¢æˆSQLè¿›è¡Œè½¬å‚¨ï¼Œæ¯”è¾ƒè€—è´¹èµ„æºï¼Œæ•°æ®é‡å¤§çš„è¯æ•ˆç‡è¾ƒä½ å»ºè®®ï¼š\n100Gä»¥å†…çš„æ•°æ®é‡çº§ï¼Œå¯ä»¥ä½¿ç”¨mysqldump è¶…è¿‡TBä»¥ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿå¯èƒ½é€‰æ‹©çš„æ˜¯mysqldumpï¼Œé…åˆåˆ†å¸ƒå¼çš„ç³»ç»Ÿ 1EB =1024 PB =1000000 TB 6.å¤‡ä»½ç­–ç•¥ å¤‡ä»½æ–¹å¼ï¼š\nå…¨å¤‡:å…¨åº“å¤‡ä»½ï¼Œå¤‡ä»½æ‰€æœ‰æ•°æ® å¢é‡:å¤‡ä»½å˜åŒ–çš„æ•°æ® å¤‡ä»½å·¥å…·\né€»è¾‘å¤‡ä»½=mysqldump+mysqlbinlog ç‰©ç†å¤‡ä»½=xtrabackup_full+xtrabackup_incr+binlogæˆ–è€…xtrabackup_full+binlog å¤‡ä»½å‘¨æœŸ:\næ ¹æ®æ•°æ®é‡è®¾è®¡å¤‡ä»½å‘¨æœŸ æ¯”å¦‚ï¼šå‘¨æ—¥å…¨å¤‡ï¼Œå‘¨1-å‘¨6å¢é‡ å¤‡ä»½ç›‘æ§\nå¤‡ä»½ç©ºé—´ å¤‡ä»½æ—¥å¿— 7.å®¹ç¾ç­–ç•¥ å¤‡ä»½\næ¶æ„\né«˜å¯ç”¨Â è´Ÿè½½å‡è¡¡ æ¼”ç¤ºä»åº“Â ä¸»ä»åŒæ­¥ ç¾å¤‡åº“Â å¼‚åœ°å¤‡ä»½ å®šæœŸçš„æ•…éšœæ¢å¤æ¼”ç»ƒ\n8.mysqldumpåº”ç”¨ ä»‹ç»ï¼šé€»è¾‘å¤‡ä»½å·¥å…·ã€‚å¤‡ä»½çš„æ˜¯sqlè¯­å¥\nå¤‡ä»½æ–¹å¼\nInnoDB\nå¯ä»¥é‡‡å–å¿«ç…§å¤‡ä»½çš„æ–¹å¼ å¼€å¯ä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ï¼Œè·å–å½“å‰æœ€æ–°çš„ä¸€è‡´æ€§å¿«ç…§ï¼Œå°†å¿«ç…§æ•°æ®ï¼Œæ”¾åœ¨ä¸´æ—¶è¡¨ä¸­ï¼Œè½¬æ¢æˆSQLï¼ˆCreate databaseï¼Œcreate tableï¼Œinsertï¼‰ï¼Œä¿å­˜åˆ°sqlæ–‡ä»¶ä¸­ éInnoDB\néœ€è¦é”è¡¨å¤‡ä»½ã€‚è§¦å‘FTWRLï¼Œå…¨å±€é”è¡¨ã€‚ å°†å¿«ç…§æ•°æ®ï¼Œæ”¾åœ¨ä¸´æ—¶è¡¨ä¸­ï¼Œè½¬æ¢æˆSQLï¼ˆCreate databaseï¼Œcreate tableï¼Œinsertï¼‰ï¼Œä¿å­˜åˆ°sqlæ–‡ä»¶ä¸­ æ ¸å¿ƒå‚æ•°\nå»ºç«‹å¤‡ä»½ç›®å½•ï¼Œæˆæƒ\n1 2 mkdir -p /data/backup chown -R mysql.mysql /data/backup/ è¿æ¥å‚æ•° -u #ç”¨æˆ· -p #å¯†ç  -h #ä¸»æœºåœ°å€ -P #ç«¯å£ -S #socketè¿æ¥ -A #å…¨å¤‡ 1 mysqldump -uroot -proot -A \u0026gt;/data/backup/full.sql -B #å¤‡ä»½ä¸€ä¸ªæˆ–è€…å¤šä¸ª 1 mysqldump -uroot -proot -B gtid gtid2 \u0026gt;/data/backup/db.sql å¤‡ä»½åº“ä¸‹çš„å¤šä¸ªè¡¨ï¼ˆä¸åŠ å‚æ•°ï¼‰\n1 mysqldump -uroot -proot gtid t1 t1 \u0026gt;/data/backup/db.sql å¤‡ä»½é«˜çº§å‚æ•° 1 --master-data=2 1 2 3 4 5 6 7 8 9 10 11 12 13 ä»¥æ³¨é‡Šçš„å½¢å¼,ä¿å­˜å¤‡ä»½å¼€å§‹æ—¶é—´ç‚¹çš„binlogçš„çŠ¶æ€ä¿¡æ¯ mysqldump -uroot -p -A -R --triggers --master-data=2 \u0026gt;/back/world.sql [root@db01 ~]# grep \u0026#39;CHANGE\u0026#39; /backup/world.sql -- CHANGE MASTER TO MASTER_LOG_FILE=\u0026#39;mysql-bin.000035\u0026#39;, MASTER_LOG_POS=194; åŠŸèƒ½ï¼š ï¼ˆ1ï¼‰åœ¨å¤‡ä»½æ—¶ï¼Œä¼šè‡ªåŠ¨è®°å½•ï¼ŒäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶åå’Œä½ç½®å· 0 é»˜è®¤å€¼ 1 ä»¥change master toå‘½ä»¤å½¢å¼ï¼Œå¯ä»¥ç”¨ä½œä¸»ä»å¤åˆ¶ 2 ä»¥æ³¨é‡Šçš„å½¢å¼è®°å½•ï¼Œå¤‡ä»½æ—¶åˆ»çš„æ–‡ä»¶å+postionå· ï¼ˆ2ï¼‰ è‡ªåŠ¨é”è¡¨ ï¼ˆ3ï¼‰å¦‚æœé…åˆ--single-transactionï¼Œåªå¯¹éInnoDBè¡¨è¿›è¡Œé”è¡¨å¤‡ä»½ï¼ŒInnoDBè¡¨è¿›è¡Œâ€œçƒ­â€œâ€å¤‡ï¼Œå®é™…ä¸Šæ˜¯å®ç°å¿«ç…§å¤‡ä»½ã€‚ 1 --single-transaction 1 2 3 4 5 6 innodb å­˜å‚¨å¼•æ“å¼€å¯çƒ­å¤‡(å¿«ç…§å¤‡ä»½)åŠŸèƒ½ master-dataå¯ä»¥è‡ªåŠ¨åŠ é” ï¼ˆ1ï¼‰åœ¨ä¸åŠ --single-transaction ï¼Œå¯åŠ¨æ‰€æœ‰è¡¨çš„æ¸©å¤‡ä»½ï¼Œæ‰€æœ‰è¡¨éƒ½é”å®š ï¼ˆ1ï¼‰åŠ ä¸Š--single-transaction ,å¯¹innodbè¿›è¡Œå¿«ç…§å¤‡ä»½,å¯¹éinnodbè¡¨å¯ä»¥å®ç°è‡ªåŠ¨é”è¡¨åŠŸèƒ½ ä¾‹å­6: å¤‡ä»½å¿…åŠ å‚æ•° mysqldump -uroot -p -A -R -E --triggers --master-data=2 --single-transaction --set-gtid-purged=OFF \u0026gt;/data/backup/full.sql 1 --set-gtid-purged=auto 1 2 3 4 5 6 7 auto , on off ä½¿ç”¨åœºæ™¯: 1. --set-gtid-purged=OFF,å¯ä»¥ä½¿ç”¨åœ¨æ—¥å¸¸å¤‡ä»½å‚æ•°ä¸­. mysqldump -uroot -p -A -R -E --triggers --master-data=2 --single-transaction --set-gtid-purged=OFF \u0026gt;/data/backup/full.sql 2. auto , on:åœ¨æ„å»ºä¸»ä»å¤åˆ¶ç¯å¢ƒæ—¶éœ€è¦çš„å‚æ•°é…ç½® mysqldump -uroot -p -A -R -E --triggers --master-data=2 --single-transaction --set-gtid-purged=ON \u0026gt;/data/backup/full.sql 1 --max-allowed-packet=# 1 2 3 4 mysqldump -uroot -p -A -R -E --triggers --master-data=2 --single-transaction --set-gtid-purged=OFF --max-allowed-packet=256M \u0026gt;/data/backup/full.sql --max-allowed-packet=# The maximum packet length to send to or receive from server. -R å¤‡ä»½å­˜å‚¨è¿‡ç¨‹åŠå‡½æ•° --triggers å¤‡ä»½è§¦å‘å™¨ -E å¤‡ä»½äº‹ä»¶ ç”Ÿäº§å¤‡ä»½è¯­å¥ï¼ˆåªæ˜¯å»ºè®®ï¼Œæ ¹æ®è‡ªå·±éœ€æ±‚æ¥æ”¹ï¼‰ 1 mysqldump -uroot -p -A -R -E --triggers --master-data=2 --single-transaction --set-gtid-purged=OFF --max-allowed-packet=256M \u0026gt;/data/backup/full.sql ç»ƒä¹ Â å®ç°æ‰€æœ‰è¡¨çš„å•ç‹¬å¤‡ä»½ 1 2 3 4 5 æç¤ºï¼š information_schema.tables mysqldump -uroot -p123 world city \u0026gt;/backup/world_city.sql select concat(\u0026#34;mysqldump -uroot -p123 \u0026#34;,table_schema,\u0026#34; \u0026#34;,table_name,\u0026#34; --master-data=2 --single-transaction --set-gtid-purged=0 -R -E --triggers\u0026gt;/backup/\u0026#34;,table_schema,\u0026#34;_\u0026#34;,table_name,\u0026#34;.sql\u0026#34;) from information_schema.tables where table_schema not in (\u0026#39;sys\u0026#39;,\u0026#39;information_schema\u0026#39;,\u0026#39;performance_schema\u0026#39;); 9. å¤‡ä»½æ—¶ä¼˜åŒ–å‚æ•°: 1 2 3 4 5 6 7 (1) max_allowed_packet æœ€å¤§çš„æ•°æ®åŒ…å¤§å° mysqldump -uroot -p123 -A -R --triggers --set-gtid-purged=OFF --master-data=2 max_allowed_packet=128M --single-transaction|gzip \u0026gt; /backup/full_$(date +%F).sql.gz (2) å¢åŠ key_buffer_size (ä¸´æ—¶è¡¨æœ‰å…³) (3) åˆ†åº“åˆ†è¡¨å¹¶å‘å¤‡ä»½ (ä½œä¸š) (4) æ¶æ„åˆ†ç¦»,åˆ†åˆ«å¤‡ä»½ (æ¶æ„æ‹†åˆ†,åˆ†å¸ƒå¼å¤‡ä»½) 10. MySQLç‰©ç†å¤‡ä»½å·¥å…·-xtrabackup(XBKã€Xbackup) å®‰è£…å¹¶å®‰è£…\n1 2 3 4 5 wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.12/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.4/binary/redhat/6/x86_64/percona-xtrabackup-24-2.4.4-1.el6.x86_64.rpm yum -y install percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm å¤‡ä»½å‘½ä»¤ä»‹ç»:\n1 2 xtrabackup innobackupex ****** å¤‡ä»½æ–¹å¼â€”â€”ç‰©ç†å¤‡ä»½\n1 2 ï¼ˆ1ï¼‰å¯¹äºéInnodbè¡¨ï¼ˆæ¯”å¦‚ myisamï¼‰æ˜¯ï¼Œé”è¡¨cpæ•°æ®æ–‡ä»¶ï¼Œå±äºä¸€ç§æ¸©å¤‡ä»½ã€‚ ï¼ˆ2ï¼‰å¯¹äºInnodbçš„è¡¨ï¼ˆæ”¯æŒäº‹åŠ¡çš„ï¼‰ï¼Œä¸é”è¡¨ï¼Œæ‹·è´æ•°æ®é¡µï¼Œæœ€ç»ˆä»¥æ•°æ®æ–‡ä»¶çš„æ–¹å¼ä¿å­˜ä¸‹æ¥ï¼ŒæŠŠä¸€éƒ¨åˆ†redoå’Œundoä¸€å¹¶å¤‡èµ°ï¼Œå±äºçƒ­å¤‡æ–¹å¼ã€‚ xbk åœ¨innodbè¡¨å¤‡ä»½æ¢å¤çš„æµç¨‹ 1 2 3 4 0ã€xbkå¤‡ä»½æ‰§è¡Œçš„ç¬é—´,ç«‹å³è§¦å‘ckpt,å·²æäº¤çš„æ•°æ®è„é¡µ,ä»å†…å­˜åˆ·å†™åˆ°ç£ç›˜,å¹¶è®°å½•æ­¤æ—¶çš„LSNå· 1ã€å¤‡ä»½æ—¶ï¼Œæ‹·è´ç£ç›˜æ•°æ®é¡µï¼Œå¹¶ä¸”è®°å½•å¤‡ä»½è¿‡ç¨‹ä¸­äº§ç”Ÿçš„redoå’Œundoä¸€èµ·æ‹·è´èµ°,ä¹Ÿå°±æ˜¯checkpoint LSNä¹‹åçš„æ—¥å¿— 2ã€åœ¨æ¢å¤ä¹‹å‰ï¼Œæ¨¡æ‹ŸInnodbâ€œè‡ªåŠ¨æ•…éšœæ¢å¤â€çš„è¿‡ç¨‹ï¼Œå°†redoï¼ˆå‰æ»šï¼‰ä¸undoï¼ˆå›æ»šï¼‰è¿›è¡Œåº”ç”¨ 3ã€æ¢å¤è¿‡ç¨‹æ˜¯cp å¤‡ä»½åˆ°åŸæ¥æ•°æ®ç›®å½•ä¸‹ innobackupexä½¿ç”¨ å…¨å¤‡\n1 innobackupex --user=root --password=123 /data/backup è‡ªä¸»å®šåˆ¶å¤‡ä»½è·¯å¾„å\n1 innobackupex --user=root --password=123 --no-timestamp /data/backup/full å¤‡ä»½é›†ä¸­å¤šå‡ºæ¥çš„æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 -rw-r----- 1 root root 24 Jun 29 09:59 xtrabackup_binlog_info -rw-r----- 1 root root 119 Jun 29 09:59 xtrabackup_checkpoints -rw-r----- 1 root root 489 Jun 29 09:59 xtrabackup_info -rw-r----- 1 root root 2560 Jun 29 09:59 xtrabackup_logfile xtrabackup_binlog_info ï¼šï¼ˆå¤‡ä»½æ—¶åˆ»çš„binlogä½ç½®ï¼‰ [root@db01 full]# cat xtrabackup_binlog_info mysql-bin.000003 536749 79de40d3-5ff3-11e9-804a-000c2928f5dd:1-7 è®°å½•çš„æ˜¯å¤‡ä»½æ—¶åˆ»ï¼Œbinlogçš„æ–‡ä»¶åå­—å’Œå½“æ—¶çš„ç»“æŸçš„positionï¼Œå¯ä»¥ç”¨æ¥ä½œä¸ºæˆªå–binlogæ—¶çš„èµ·ç‚¹ã€‚ xtrabackup_checkpoints ï¼š backup_type = full-backuped from_lsn = 0 ä¸Šæ¬¡æ‰€åˆ°è¾¾çš„LSNå·(å¯¹äºå…¨å¤‡å°±æ˜¯ä»0å¼€å§‹,å¯¹äºå¢é‡æœ‰åˆ«çš„æ˜¾ç¤ºæ–¹æ³•) to_lsn = 160683027 å¤‡ä»½å¼€å§‹æ—¶é—´(ckpt)ç‚¹æ•°æ®é¡µçš„LSN last_lsn = 160683036 å¤‡ä»½ç»“æŸåï¼Œredoæ—¥å¿—æœ€ç»ˆçš„LSN compact = 0 recover_binlog_info = 0 ï¼ˆ1ï¼‰å¤‡ä»½æ—¶åˆ»ï¼Œç«‹å³å°†å·²ç»commitè¿‡çš„ï¼Œå†…å­˜ä¸­çš„æ•°æ®é¡µåˆ·æ–°åˆ°ç£ç›˜(CKPT).å¼€å§‹å¤‡ä»½æ•°æ®ï¼Œæ•°æ®æ–‡ä»¶çš„LSNä¼šåœç•™åœ¨to_lsnä½ç½®ã€‚ ï¼ˆ2ï¼‰å¤‡ä»½æ—¶åˆ»æœ‰å¯èƒ½ä¼šæœ‰å…¶ä»–çš„æ•°æ®å†™å…¥ï¼Œå·²å¤‡èµ°çš„æ•°æ®æ–‡ä»¶å°±ä¸ä¼šå†å‘ç”Ÿå˜åŒ–äº†ã€‚ ï¼ˆ3ï¼‰åœ¨å¤‡ä»½è¿‡ç¨‹ä¸­ï¼Œå¤‡ä»½è½¯ä»¶ä¼šä¸€ç›´ç›‘æ§ç€redoçš„undoï¼Œå¦‚æœä¸€æ—¦æœ‰å˜åŒ–ä¼šå°†æ—¥å¿—ä¹Ÿä¸€å¹¶å¤‡èµ°ï¼Œå¹¶è®°å½•LSNåˆ°last_lsnã€‚ ä»to_lsn ----ã€‹last_lsn å°±æ˜¯ï¼Œå¤‡ä»½è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ•°æ®å˜åŒ–. innobackupex å¢é‡å¤‡ä»½(incremental) ï¼ˆ1ï¼‰å¢é‡å¤‡ä»½çš„æ–¹å¼ï¼Œæ˜¯åŸºäºä¸Šä¸€æ¬¡å¤‡ä»½è¿›è¡Œå¢é‡ã€‚ ï¼ˆ2ï¼‰å¢é‡å¤‡ä»½æ— æ³•å•ç‹¬æ¢å¤ã€‚å¿…é¡»åŸºäºå…¨å¤‡è¿›è¡Œæ¢å¤ã€‚ ï¼ˆ3ï¼‰æ‰€æœ‰å¢é‡å¿…é¡»è¦æŒ‰é¡ºåºåˆå¹¶åˆ°å…¨å¤‡ä¸­ã€‚ å¢é‡å¤‡ä»½å‘½ä»¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 ï¼ˆ1ï¼‰åˆ æ‰åŸæ¥å¤‡ä»½ ç•¥. ï¼ˆ2ï¼‰å…¨å¤‡ï¼ˆå‘¨æ—¥ï¼‰ [root@db01 backup]# innobackupex --user=root --password --no-timestamp /backup/full \u0026gt;\u0026amp;/tmp/xbk_full.log ï¼ˆ3ï¼‰æ¨¡æ‹Ÿå‘¨ä¸€æ•°æ®å˜åŒ– db01 [(none)]\u0026gt;create database cs charset utf8; db01 [(none)]\u0026gt;use cs db01 [cs]\u0026gt;create table t1 (id int); db01 [cs]\u0026gt;insert into t1 values(1),(2),(3); db01 [cs]\u0026gt;commit; ï¼ˆ4ï¼‰ç¬¬ä¸€æ¬¡å¢é‡å¤‡ä»½ï¼ˆå‘¨ä¸€ï¼‰ innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/full /backup/inc1 \u0026amp;\u0026gt;/tmp/inc1.log ï¼ˆ5ï¼‰æ¨¡æ‹Ÿå‘¨äºŒæ•°æ® db01 [cs]\u0026gt;create table t2 (id int); db01 [cs]\u0026gt;insert into t2 values(1),(2),(3); db01 [cs]\u0026gt;commit; ï¼ˆ6ï¼‰å‘¨äºŒå¢é‡ innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/inc1 /backup/inc2 \u0026amp;\u0026gt;/tmp/inc2.log ï¼ˆ7ï¼‰æ¨¡æ‹Ÿå‘¨ä¸‰æ•°æ®å˜åŒ– db01 [cs]\u0026gt;create table t3 (id int); db01 [cs]\u0026gt;insert into t3 values(1),(2),(3); db01 [cs]\u0026gt;commit; db01 [cs]\u0026gt;drop database cs; æ¢å¤åˆ°å‘¨ä¸‰è¯¯dropä¹‹å‰çš„æ•°æ®çŠ¶æ€\n1 2 3 4 5 6 7 æ¢å¤æ€è·¯ï¼š 1. æŒ‚å‡ºç»´æŠ¤é¡µï¼Œåœæ­¢å½“å¤©çš„è‡ªåŠ¨å¤‡ä»½è„šæœ¬ 2. æ£€æŸ¥å¤‡ä»½ï¼šå‘¨æ—¥full+å‘¨ä¸€inc1+å‘¨äºŒinc2ï¼Œå‘¨ä¸‰çš„å®Œæ•´äºŒè¿›åˆ¶æ—¥å¿— 3. è¿›è¡Œå¤‡ä»½æ•´ç†ï¼ˆç»†èŠ‚ï¼‰ï¼Œæˆªå–å…³é”®çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆä»å¤‡ä»½â€”â€”è¯¯åˆ é™¤ä¹‹å‰ï¼‰ 4. æµ‹è¯•åº“è¿›è¡Œå¤‡ä»½æ¢å¤åŠæ—¥å¿—æ¢å¤ 5. åº”ç”¨è¿›è¡Œæµ‹è¯•æ— è¯¯ï¼Œå¼€å¯ä¸šåŠ¡ 6. æ­¤æ¬¡å·¥ä½œçš„æ€»ç»“ æ¢å¤è¿‡ç¨‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 1. æ£€æŸ¥å¤‡ä»½ 1afe8136-601d-11e9-9022-000c2928f5dd:7-9 2. å¤‡ä»½æ•´ç†ï¼ˆapply-logï¼‰+åˆå¹¶å¤‡ä»½ï¼ˆfull+inc1+inc2ï¼‰ (1) å…¨å¤‡çš„æ•´ç† [root@db01 one]# innobackupex --apply-log --redo-only /data/backup/full (2) åˆå¹¶inc1åˆ°fullä¸­ [root@db01 one]# innobackupex --apply-log --redo-only --incremental-dir=/data/backup/inc1 /data/backup/full (3) åˆå¹¶inc2åˆ°fullä¸­ [root@db01 one]# innobackupex --apply-log --incremental-dir=/data/backup/inc2 /data/backup/full (4) æœ€åä¸€æ¬¡æ•´ç†å…¨å¤‡ [root@db01 backup]# innobackupex --apply-log /data/backup/full 3. æˆªå–å‘¨äºŒ 23:00 åˆ°drop ä¹‹å‰çš„ binlog [root@db01 inc2]# mysqlbinlog --skip-gtids --include-gtids=\u0026#39;1afe8136-601d-11e9-9022-000c2928f5dd:7-9\u0026#39; /data/binlog/mysql-bin.000009 \u0026gt;/data/backup/binlog.sql 4. è¿›è¡Œæ¢å¤ [root@db01 backup]# mkdir /data/mysql/data2 -p [root@db01 full]# cp -a * /data/mysql/data2 [root@db01 backup]# chown -R mysql. /data/* [root@db01 backup]# systemctl stop mysqld vim /etc/my.cnf datadir=/data/mysql/data2 systemctl start mysqld Master [(none)]\u0026gt;set sql_log_bin=0; Master [(none)]\u0026gt;source /data/backup/binlog.sql ä¸‹é¢æ˜¯æˆ‘ç”»çš„æ€ç»´å¯¼å›¾ï¼Œå¯ä»¥å¾ˆå¿«åŠ å¼ºè®°å¿†ã€‚\n","date":"2020-05-28T17:18:38Z","image":"https://www.ownit.top/title_pic/29.jpg","permalink":"https://www.ownit.top/p/202005281718/","title":"MySQL--å¤‡ä»½æ¢å¤ã€Mysqdump+xtrabackupï¼ˆXBKï¼‰ã€‘"},{"content":"Mysqlæ—¥å¿— 1.é”™è¯¯æ—¥å¿— 1.ä½œç”¨ - æ’æŸ¥MySQLè¿è¡Œè¿‡ç¨‹çš„æ•…éšœ.\n2.é»˜è®¤é…ç½® 1 1.é»˜è®¤å°±å¼€å¯äº† 1 2.é»˜è®¤è·¯å¾„å’Œåå­—: datadir/hostname.err 3.äººä¸ºå®šåˆ¶ä½ç½® 1 - log_error=/tmp/mysql.log é‡å¯ç”Ÿæ•ˆ\n1 show variables like \u0026#39;log_error\u0026#39;; äºŒè¿›åˆ¶æ—¥å¿—(binlog) 1.ä½œç”¨ - (1)å¤‡ä»½æ¢å¤å¿…é¡»ä¾èµ–äºŒè¿›åˆ¶æ—¥å¿—\n- (2)ä¸»ä»ç¯å¢ƒå¿…é¡»ä¾èµ–äºŒè¿›åˆ¶æ—¥å¿—\n2. binlogé…ç½® (5.7å¿…é¡»åŠ server_id) 1 2 3 4 5 6 7 8 9 1.é»˜è®¤ï¼š8.0ç‰ˆæœ¬ä»¥å‰ï¼Œæ²¡æœ‰å¼€å¯ï¼ˆæ³¨æ„ï¼šMySQLé»˜è®¤æ˜¯æ²¡æœ‰å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—çš„ è¯´æ˜ï¼šå’Œæ•°æ®ç›˜åˆ†å¼€ï¼Œé˜²æ­¢æ•°æ®ç›˜æŸåï¼Œå¯¼è‡´binlongæ— æ³•æ¢å¤ 2.é»˜è®¤é…ç½®æ–¹æ³• server_id=6 # ä¸»æœºç¼–å·ã€‚ä¸»ä»ä½¿ç”¨ï¼Œ 5.7ä»¥åå¼€å¯binlogè¦åŠ æ­¤å‚æ•° log_bin=/data/binlog/mysql-bin #æ—¥å¿—å­˜æ”¾ç›®å½•+æ—¥å¿—åå‰ç¼€ï¼Œä¾‹å¦‚ï¼šmysql-bin.000001 sync_binlog=1 #binlogæ—¥å¿—åˆ·ç›˜ç­–ç•¥ï¼ŒåŒä¸€çš„ç¬¬äºŒä¸ª1ã€‚æ¯æ¬¡äº‹åŠ¡æäº¤ç«‹å³åˆ·å†™binlogåˆ°ç£ç›˜ binlog_format=row #binlogçš„è®°å½•æ ¼å¼ä¸ºrowæ¨¡å¼ é‡å¯å®Œæˆ - åŸºç¡€å‚æ•°æŸ¥çœ‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 - å¼€å…³ï¼ˆ1ï¼šè¡¨ç¤ºå¼€å¯ï¼‰ - select @@log_bin; - æ—¥å¿—è·¯å¾„åŠåå­— - select @@log_bin_basename; - æœåŠ¡IDå· - select @@server_id; - äºŒè¿›åˆ¶æ—¥å¿—æ ¼å¼ - select @@binlog_format; - åŒä¸€æ ‡å‡†ä¹‹äºŒ - select @@sync_binlog; 3.äºŒè¿›åˆ¶å†…ç½®æŸ¥çœ‹å‘½ä»¤ æŸ¥çœ‹ä¸€ç›®å‰æœ‰å‡ ä¸ªæ—¥å¿—binlog 1 show binary logs; æŸ¥çœ‹å½“å‰åœ¨ä½¿ç”¨çš„binlog 1 show master status; æŸ¥çœ‹äºŒè¿›åˆ¶äº‹ä»¶ 1 show binlog events in \u0026#39;mysql-bin.000001 \u0026#39;; binlogæ–‡ä»¶å†…å®¹è¯¦ç»†æŸ¥çœ‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 - mysql -uroot -proot -e \u0026#34;show binlog events in \u0026#39;mysql-bin.000001\u0026#39;\u0026#34; - æ™®é€šæŸ¥çœ‹ mysqlbinlog - mysqlbinlog /mysql/mysql/data/binlog/mysql-bin.000001 \u0026gt; a.sql #æŠŠbinlogåˆ°æˆsqlæ–‡ä»¶ - ç¿»è¯‘æŸ¥çœ‹ - mysqlbinlog --base64-output=decode-rows -vvv /data/binlog/mysql-bin.000003 - åŸºäºæ—¶é—´æŸ¥çœ‹ - mysqlbinlog --start-datetime=\u0026#39;2019-05-06 17:00:00\u0026#39; --stop-datetime=\u0026#39;2019-05-06 17:01:00\u0026#39; /data/binlog/mysql-bin.000004 - åŸºäºPositionå·è¿›è¡Œæ—¥å¿—æˆªå– - mysqlbinlog --start-position=219 --stop-position=1347 /data/binlog/mysql-bin.000003 \u0026gt;/tmp/bin.sql - æ•°æ®æ¢å¤ - set sql_log_bin=0; source /tmp/bin.sql binlogç»´æŠ¤æ“ä½œ - 1.æ—¥å¿—æ»šåŠ¨\n1 2 3 4 5 6 - flush logsï¼› - mysqladmin -uroot -proot flush-logs - è‡ªåŠ¨æ»šåŠ¨ï¼Œé»˜è®¤1Gæ»šåŠ¨ä¸€æ¬¡ï¼Œå¯ä»¥è®¾ç½®å‚æ•° - select @@max_binlog_size; - mysqldump -F - é‡å¯æ•°æ®è‡ªåŠ¨æ»šåŠ¨ - 2.æ—¥å¿—çš„åˆ é™¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 - æ³¨æ„ï¼šä¸è¦ä½¿ç”¨rmå‘½ä»¤åˆ é™¤æ—¥å¿— - è‡ªåŠ¨åˆ é™¤ï¼ˆé»˜è®¤ï¼š0 æ°¸ä¸åˆ é™¤ï¼Œå•ä½æ˜¯å¤©ï¼‰ - select @@expire_logs_days; - é—®é¢˜ï¼šåˆ°åº•è®¾ç½®å¤šå°‘å¤©åˆé€‚ï¼Ÿ ä¸€ä¸ªå…¨å¤‡å‘¨æœŸï¼ˆ7+1ï¼‰å¤©ï¼Œä¸€èˆ¬ç”Ÿäº§ä¸€éå»ºè®®2ä¸ªå…¨å¤‡å‘¨æœŸ+1 - show variables like \u0026#39;%expire%\u0026#39;; expire_logs_days 0 è‡ªåŠ¨æ¸…ç†æ—¶é—´,æ˜¯è¦æŒ‰ç…§å…¨å¤‡å‘¨æœŸ+1 set global expire_logs_days=8; æ°¸ä¹…ç”Ÿæ•ˆ: my.cnf expire_logs_days=15; ä¼ä¸šå»ºè®®,è‡³å°‘ä¿ç•™ä¸¤ä¸ªå…¨å¤‡å‘¨æœŸ+1çš„binlog 1 2 3 4 5 6 7 8 9 10 - æ‰‹å·¥åˆ é™¤ - PURGE BINARY LOGS TO \u0026#39;mysql-bin.010\u0026#39;; - PURGE BINARY LOGS BEFORE \u0026#39;2008-04-02 22:46:26\u0026#39;; - å…¨éƒ¨æ¸…ç©º - reset master; - æ¯”è¾ƒå±é™©ï¼Œåœ¨ä¸»ä»æ‰§è¡Œæ­¤æ“ä½œï¼Œä¸»ä»å¿…å®•æœº binlogæ—¥å¿—çš„GTIDæ–°ç‰¹æ€§ 1.GTID ä»‹ç» 1 2 3 4 5 6 7 8 9 10 - 5.6 ç‰ˆæœ¬æ–°åŠ çš„ç‰¹æ€§,5.7ä¸­åšäº†åŠ å¼º 5.6 ä¸­ä¸å¼€å¯,æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½. 5.7 ä¸­çš„GTID,å³ä½¿ä¸å¼€ä¹Ÿä¼šæœ‰è‡ªåŠ¨ç”Ÿæˆ SET @@SESSION.GTID_NEXT= \u0026#39;ANONYMOUS\u0026#39; - å¯¹äºä¸€ä¸ªå·²æäº¤äº‹åŠ¡çš„ç¼–å·ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ç¼–å·ã€‚ å®ƒçš„å®˜æ–¹å®šä¹‰å¦‚ä¸‹ï¼š GTID = source_id ï¼štransaction_id 7E11FA47-31CA-19E1-9E56-C43AA21293967:29 2.å¼€å¯å‚æ•° 1 2 3 4 5 å¼€å¯çš„å‚æ•° gtid-mode=on enforce-gtid-consistency=true æŸ¥çœ‹ - select @@gtid_mode; 3.å…·å¤‡GTIDå,æˆªå–æŸ¥çœ‹æŸäº›äº‹åŠ¡æ—¥å¿— 1 2 3 --include-gtids --exclude-gtids --skip-gtids 4.æ•°æ®æˆªå– mysqlbinlog --skip-gtids --include-gtids='3ca79ab5-3e4d-11e9-a709-000c293b577e:1-9' mysql-bin.000002 mysql-bin.000003 \u0026gt; /tmp/gtid.sql 5.æ•°æ®æ¢å¤ 1 2 set sql_log_bin=0; source /tmp/bin.sql æ…¢æ—¥å¿—(slow-log) 1 ä½œç”¨ï¼šè®°å½•è¿è¡Œè¾ƒæ…¢çš„è¯­å¥,ä¼˜åŒ–è¿‡ç¨‹ä¸­å¸¸ç”¨çš„å·¥å…·æ—¥å¿—. 2.é…ç½®æ–¹æ³•ï¼ˆé»˜è®¤æ²¡å¼€å¯ï¼‰ 1 2 3 select @@slow_query_log; #0è¡¨ç¤ºå…³é—­ select @@slow_query_log_file; #æ–‡ä»¶å­˜æ”¾æ–‡å­— ** å¼€å…³:**\n1 slow_query_log=1 æ–‡ä»¶ä½ç½®åŠåå­—\n1 slow_query_log_file=/data/mysql/slow.log è®¾å®šæ…¢æŸ¥è¯¢æ—¶é—´:\n1 long_query_time=0.1 æ²¡èµ°ç´¢å¼•çš„è¯­å¥ä¹Ÿè®°å½•:\n1 log_queries_not_using_indexes 1 2 3 4 5 6 vim /etc/my.cnf slow_query_log=1 slow_query_log_file=/data/mysql/slow.log long_query_time=0.1 log_queries_not_using_indexes systemctl restart mysqld 3.mysqldumpslow åˆ†ææ…¢æ—¥å¿— mysqldumpslow -s c -t 10 /data/mysql/slow.log ç¬¬ä¸‰æ–¹å·¥å…·(è‡ªå·±æ‰©å±•) 1 2 https://www.percona.com/downloads/percona-toolkit/LATEST/ yum install perl-DBI perl-DBD-MySQL perl-Time-HiRes perl-IO-Socket-SSL perl-Digest-MD5 1 - toolkitå·¥å…·åŒ…ä¸­çš„å‘½ä»¤: 1 2 ./pt-query-diagest /data/mysql/slow.log AnemometeråŸºäºpt-query-digestå°†MySQLæ…¢æŸ¥è¯¢å¯è§†åŒ– ","date":"2020-05-27T17:51:57Z","image":"https://www.ownit.top/title_pic/32.jpg","permalink":"https://www.ownit.top/p/202005271751/","title":"Mysqlæ—¥å¿—åˆ†æï¼ˆé”™è¯¯æ—¥å¿—ï¼ŒBinlogæ—¥å¿—ï¼Œæ…¢æ—¥å¿—ï¼‰ï¼Œæœ‰æƒŠå–œå“¦"},{"content":"ç›®å½•\nå¤šå®ä¾‹çš„åº”ç”¨\n1ã€å‡†å¤‡å¤šä¸ªç›®å½•\n2ã€å‡†å¤‡é…ç½®æ–‡ä»¶\n3ã€åˆå§‹åŒ–ä¸‰å¥—æ•°æ®\n4ã€systemdç®¡ç†å¤šå®ä¾‹\n5ã€æˆæƒ\n6ã€å¯åŠ¨\n7ã€éªŒè¯å¤šå®ä¾‹\nMysqlä¸‹è½½\nhttps://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.26-linux-glibc2.12-x86_64.tar.gz\nMysqlç‰ˆæœ¬ï¼š5.7.26\nMysqlå®‰è£…æ–¹å¼ï¼šäºŒè¿›åˆ¶\nå¤šå®ä¾‹çš„åº”ç”¨ 1ã€å‡†å¤‡å¤šä¸ªç›®å½• 1 mkdir -p /mysql/330{7,8,9}/data 2ã€å‡†å¤‡é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 cat \u0026gt; /mysql/3307/my.cnf \u0026lt;\u0026lt;EOF [mysqld] basedir=/application/mysql #mysqlå®‰è£…è·¯å¾„ datadir=/mysql/3307/data #mysqlæ•°æ®å­˜æ”¾ç›®å½• socket=/mysql/3307/mysql.sock #mysqlçš„socket log_error=/mysql/3307/mysql.log port=3307 server_id=7 log_bin=/mysql/3307/mysql-bin EOF cat \u0026gt; /mysql/3308/my.cnf \u0026lt;\u0026lt;EOF [mysqld] basedir=/application/mysql datadir=/mysql/3308/data socket=/mysql/3308/mysql.sock log_error=/mysql/3308/mysql.log port=3308 server_id=8 log_bin=/mysql/3308/mysql-bin EOF cat \u0026gt; /mysql/3309/my.cnf \u0026lt;\u0026lt;EOF [mysqld] basedir=/application/mysql datadir=/mysql/3309/data socket=/mysql/3309/mysql.sock log_error=/mysql/3309/mysql.log port=3309 server_id=9 log_bin=/mysql/3309/mysql-bin EOF 3ã€åˆå§‹åŒ–ä¸‰å¥—æ•°æ® 1 2 3 mysqld --initialize-insecure --user=mysql --datadir=/mysql/3307/data --basedir=/application/mysql mysqld --initialize-insecure --user=mysql --datadir=/mysql/3308/data --basedir=/application/mysql mysqld --initialize-insecure --user=mysql --datadir=/mysql/3309/data --basedir=/application/mysql 4ã€systemdç®¡ç†å¤šå®ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 cd /etc/systemd/system cp mysqld.service mysqld3307.service cp mysqld.service mysqld3308.service cp mysqld.service mysqld3309.service vim mysqld3307.service ExecStart=/app/mysql/bin/mysqld --defaults-file=/mysql/3307/my.cnf vim mysqld3308.service ExecStart=/app/mysql/bin/mysqld --defaults-file=/mysql/3308/my.cnf vim mysqld3309.service ExecStart=/app/mysql/bin/mysqld --defaults-file=/mysql/3309/my.cnf 5ã€æˆæƒ 1 chown -R mysql.mysql /mysql/* 6ã€å¯åŠ¨ 1 2 3 systemctl start mysqld3307.service systemctl start mysqld3308.service systemctl start mysqld3309.service 7ã€éªŒè¯å¤šå®ä¾‹ 1 2 3 4 netstat -lnp|grep 330 mysql -S /mysql/3307/mysql.sock -e \u0026#34;select @@server_id\u0026#34; mysql -S /mysql/3308/mysql.sock -e \u0026#34;select @@server_id\u0026#34; mysql -S /mysql/3309/mysql.sock -e \u0026#34;select @@server_id\u0026#34; ","date":"2020-05-19T17:56:00Z","image":"https://www.ownit.top/title_pic/77.jpg","permalink":"https://www.ownit.top/p/202005191756/","title":"Mysqlå¤šå®ä¾‹å¯åŠ¨"},{"content":"ç›®å½•\nå‰è¨€\nå¦‚ä½•å…¥æ‰‹ç›‘æ§\nä¸€ã€zabbix å¿«é€Ÿç›‘æ§ä¸»æœº\n1.å®‰è£…zabbix-agent\n2.é…ç½®zabbix-agent(ä¿®æ”¹é…ç½®)\n3.å¯åŠ¨zabbix-agentå¹¶æ£€æŸ¥\n4.zabbix-webç•Œé¢ï¼Œæ·»åŠ ä¸»æœº\näºŒã€è‡ªå®šä¹‰ç›‘æ§ä¸»æœºå°è¯•èº«æ‰‹\n1.ç›‘æ§éœ€æ±‚\n2.å‘½ä»¤è¡Œå®ç°\n3.ç¼–å†™zabbixç›‘æ§æ–‡ä»¶(ä¼ å‚å½¢å¼)\n4.serverç«¯è¿›è¡Œæµ‹è¯•\n5.webç«¯æ·»åŠ \nå‰è¨€ Centos7å®‰è£…ZabbixæœåŠ¡ç«¯ã€Zabbixå®¢æˆ·ç«¯å’ŒWinå®¢æˆ·ç«¯é…ç½®ï¼ˆæºç ç¼–è¯‘å®‰è£…ï¼‰\nå‰é¢ä»‹ç»æ€ä¹ˆæºç ç¼–è¯‘å®‰è£…Zabbixå’Œä¸»æœºæ·»åŠ ã€‚ä¸‹é¢è¦ä»‹ç»æ€ä¹ˆæ·»åŠ æ¨¡æ¿å’Œè‡ªå®šä¹‰ç›‘æ§\nå¦‚ä½•å…¥æ‰‹ç›‘æ§ 1.ç¡¬ä»¶ç›‘æ§ è·¯ç”±å™¨ã€äº¤æ¢æœºã€é˜²ç«å¢™\n2.ç³»ç»Ÿç›‘æ§ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œã€è¿›ç¨‹ã€ TCP\n3.æœåŠ¡ç›‘æ§ nginxã€ phpã€ tomcatã€ redisã€ memcacheã€ mysql\n4.WEB ç›‘æ§ è¯·æ±‚æ—¶é—´ã€å“åº”æ—¶é—´ã€åŠ è½½æ—¶é—´ã€\n5.æ—¥å¿—ç›‘æ§ ELkï¼ˆæ”¶é›†ã€å­˜å‚¨ã€åˆ†æã€å±•ç¤ºï¼‰ æ—¥å¿—æ˜“\n6.å®‰å…¨ç›‘æ§ Firewalldã€ WAF(Nginx+lua)ã€å®‰å…¨å®ã€ç‰›ç›¾äº‘ã€å®‰å…¨ç‹—\n7.ç½‘ç»œç›‘æ§ smokeping å¤šæœºæˆ¿\n8.ä¸šåŠ¡ç›‘æ§ æ´»åŠ¨å¼•å…¥å¤šå°‘æµé‡ã€äº§ç”Ÿå¤šå°‘æ³¨å†Œé‡ã€å¸¦æ¥å¤šå¤§ä»·å€¼\nä¸€ã€zabbix å¿«é€Ÿç›‘æ§ä¸»æœº 1.å®‰è£…zabbix-agent 1 rpm -ivh https://mirror.tuna.tsinghua.edu.cn/zabbix/zabbix/4.0/rhel/7/x86_64/zabbix-agent-4.0.4-1.el7.x86_64.rpm 2.é…ç½®zabbix-agent(ä¿®æ”¹é…ç½®) 1 2 3 4 5 6 7 8 [root@kvm zabbix]# grep \u0026#34;^[a-Z]\u0026#34; /etc/zabbix/zabbix_agentd.conf PidFile=/var/run/zabbix/zabbix_agentd.pid LogFile=/var/log/zabbix/zabbix_agentd.log LogFileSize=0 Server=192.168.1.10 ServerActive=192.168.1.10 Hostname=Zabbix_kvm Include=/etc/zabbix/zabbix_agentd.d/*.conf 3.å¯åŠ¨zabbix-agentå¹¶æ£€æŸ¥ 4.zabbix-webç•Œé¢ï¼Œæ·»åŠ ä¸»æœº è¿™è¾¹é…ç½®è‡ªåŠ¨å‘ç°å’Œè‡ªåŠ¨æ³¨å†Œï¼ˆå¯ä»¥è‡ªåŠ¨å‘ç°å’Œæ·»åŠ ä¸»æœºå’Œæ¨¡æ¿ï¼‰\näºŒã€è‡ªå®šä¹‰ç›‘æ§ä¸»æœºå°è¯•èº«æ‰‹ 1.ç›‘æ§éœ€æ±‚ ç›‘æ§TCP3ç§çŠ¶æ€é›†\n2.å‘½ä»¤è¡Œå®ç° 1 2 3 4 [root@kvm zabbix]# netstat -ant|grep -c TIME_WAIT 1 [root@kvm zabbix]# netstat -ant|grep -c LISTEN 13 3.ç¼–å†™zabbixç›‘æ§æ–‡ä»¶(ä¼ å‚å½¢å¼) 1 2 3 [root@kvm zabbix]# cat /etc/zabbix/zabbix_agentd.d/tcp_status.conf UserParameter=tcp_state[*],netstat -ant|grep -c $1 [root@kvm zabbix]# systemctl restart zabbix-agent.service 4.serverç«¯è¿›è¡Œæµ‹è¯• 1 2 3 4 [root@master zabbix]# /data/zabbix/bin/zabbix_get -s 192.168.1.100 -k tcp_state[TIME_WAIT] 6 [root@master zabbix]# /data/zabbix/bin/zabbix_get -s 192.168.1.100 -k tcp_state[LISTEN] 13 5.webç«¯æ·»åŠ  æ•°æ®å‡ºæ¥äº†\n","date":"2020-05-13T17:22:05Z","image":"https://www.ownit.top/title_pic/39.jpg","permalink":"https://www.ownit.top/p/202005131722/","title":"ZabbixæœåŠ¡è‡ªå®šä¹‰ç›‘æ§å’Œæ¨¡æ¿"},{"content":"ç›®å½•\n1ã€å®å¡”å®‰è£…å’Œé…ç½®ç¯å¢ƒ\n2ã€å®‰è£…ä¾èµ–å’Œç¼–è¯‘å®‰è£…\n3ã€é…ç½®æ•°æ®åº“\n4ã€é…ç½®ZabbixæœåŠ¡ç«¯\n5ã€é…ç½®Zabbixçš„Webç«¯\n6ã€é…ç½®Linuxå®¢æˆ·ç«¯\n7ã€é…ç½®Windowså®¢æˆ·ç«¯\n8ã€åœ¨zabbixæœåŠ¡å™¨æ·»åŠ ä¸»æœº\nCentos7ä¸Šä½¿ç”¨å®å¡”é¢æ¿é…ç½®LNMPç¯å¢ƒå®‰è£…zabbix4.2\n1ã€å®å¡”å®‰è£…å’Œé…ç½®ç¯å¢ƒ Centos7å®‰è£…å®å¡”æ§åˆ¶é¢æ¿\nZabbix4.2.2çš„æºç åŒ…ï¼ˆåŒ…æ‹¬Winï¼‰\nLï¼šLinux\nNï¼šNginx\nMï¼šMysql\nPï¼šPHP\n/2â€˜â€™\n2ã€å®‰è£…ä¾èµ–å’Œç¼–è¯‘å®‰è£… 1 yum install -y wget telnet net-tools python-paramiko gcc gcc-c++ dejavu-sans-fonts python-setuptools python-devel sendmail mailx net-snmp net-snmp-devel net-snmp-utils freetype-devel libpng-devel perl unbound libtasn1-devel p11-kit-devel OpenIPMI unixODBC libevent-devel é¦–å…ˆæ·»åŠ zabbixç”¨æˆ·å’Œzabbixç»„\n1 2 groupadd zabbix useradd -g zabbix -s /sbin/nologin zabbix ç„¶åä¸‹è½½zabbix4.2ç¼–è¯‘å®‰è£…åŒ…\næ‰§è¡Œ\n1 2 3 wget https://jaist.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/4.2.4/zabbix-4.2.4.tar.gz tar -zxvf zabbix-4.2.4.tar.gz cd zabbix-4.2.4 æ‰§è¡Œå¸®åŠ©æŸ¥çœ‹ç¼–è¯‘å®‰è£…é€‰é¡¹\n1 ./configure --help æˆ‘é‡‡å–çš„æ˜¯å°½é‡å¤šå®‰è£…æ¨¡å—\n1 ./configure --prefix=/data/zabbix --enable-server --enable-proxy --enable-agent --enable-ipv6 --with-mysql --with-net-snmp --with-libcurl --with-openipmi --with-openssl --with-libcurl --with-libxml2 è¯´æ˜ï¼š\n1ã€å¯¹äºè™šæ‹Ÿæœºç›‘è§†\u0026ndash;with-libcurlå’Œ\u0026ndash;with-libxml2é…ç½®é€‰é¡¹æ˜¯å¿…éœ€çš„\n2ã€enable proxy,agentæ˜¯å¯ç”¨ä»£ç†\n3ã€with-net-snmp with-mysqlæ˜¯é…ç½®snmpå’Œmysqlæ”¯æŒ\n4ã€åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæç¤ºé”™è¯¯ï¼Œåˆ™æ˜¯æŸäº›æ‰©å±•åŒ…æ²¡æœ‰å®‰è£…ï¼Œè¿›è¡Œyumå®‰è£…å³å¯\nåœ¨æ£€æŸ¥é…ç½®æ— è¯¯åï¼Œæ‰§è¡Œå®‰è£…\n1 make install 3ã€é…ç½®æ•°æ®åº“ ç„¶åé…ç½®æ•°æ®åº“ã€‚åœ¨å®å¡”é¢æ¿ä¸­å¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹æ•°æ®åº“rootå¯†ç \nå®Œæˆæ•°æ®åˆ›å»ºåï¼Œå¯¼å…¥æ•°æ®åº“\n1 2 3 mysql -uzabbix -pzabbix -hlocalhost zabbix \u0026lt; database/mysql/schema.sql mysql -uzabbix -pzabbix -hlocalhost zabbix \u0026lt; database/mysql/images.sql mysql -uzabbix -pzabbix -hlocalhost zabbix \u0026lt; database/mysql/data.sql å¯¼å…¥å®Œæ¯•åï¼Œå¯ä»¥åœ¨å®å¡”é¢æ¿çš„phpMyadminä¸­æŸ¥çœ‹æ•°æ®åº“è¯¦ç»†\n4ã€é…ç½®ZabbixæœåŠ¡ç«¯ ç„¶åè¿›å…¥zabbixå®‰è£…ç›®å½•/usr/local/zabbixé…ç½®zabbix.confé…ç½®æ–‡ä»¶\n1 vim /data/zabbix/etc/zabbix_server.conf ç„¶åå…³é—­centosä¸Šé˜²ç«å¢™ï¼Œselinuxç­‰\n1 2 systemctl stop firewalld systemctl disable firewalld Zabbixå‰ç«¯æ˜¯ç”¨PHPç¼–å†™çš„ï¼Œå› æ­¤è¦è¿è¡Œå®ƒéœ€è¦PHPæ”¯æŒçš„WebæœåŠ¡å™¨ã€‚åªéœ€å°†PHPæ–‡ä»¶ä»frontends / phpå¤åˆ¶åˆ°webserver HTMLæ–‡æ¡£ç›®å½•å³å¯å®Œæˆå®‰è£…ã€‚\nåœ¨ä½¿ç”¨å®å¡”é¢æ¿å®‰è£…LNMPç¯å¢ƒåï¼Œä¼šè‡ªåŠ¨é…ç½®nginxï¼ŒåŒæ—¶ä¼šåœ¨è·Ÿç›®å½•ä¸‹åˆ›å»ºWWWç›®å½•ï¼Œå­˜æ”¾WEBæœåŠ¡å™¨ç­‰ä¿¡æ¯ã€‚\n5ã€é…ç½®Zabbixçš„Webç«¯ å†å®å¡”é¢æ¿ç½‘ç«™ä¸­ï¼Œæ·»åŠ æ–°çš„ç«™ç‚¹\nè¯´æ˜\n1ã€åŸŸåä¸€èˆ¬ä½¿ç”¨å…¬ç½‘åŸŸå\n2ã€æ²¡æœ‰å…¬ç½‘åŸŸåï¼Œå†…ç½‘ä¸­ä½¿ç”¨.lcoalæˆ–è€…å…¶ä»–ä¸å†²çªçš„åŸŸåæ ¼å¼ä»£æ›¿å³å¯\n3ã€ä½¿ç”¨ipåœ°å€ä¸šåŠ¡å¯ä»¥\nå®ŒæˆåŸŸåé…ç½®åï¼Œå°†zabbix-4.2.4ç›®å½•ä¸­çš„frontends / php/ä¸‹çš„æ–‡ä»¶å¤åˆ¶åˆ°ç«™ç‚¹ç›®å½•\n1 2 cd zabbix-4.2.4 cp -r frontends/php/* /www/wwwroot/zabbix/ #æ­¤æ–‡ä»¶å°±æ˜¯ä¹‹å‰åˆ›å»ºçš„ç«™ç‚¹ å®Œæˆä¹‹åï¼Œå†è½¯ä»¶å•†åº—ä¸­è°ƒæ•´ä»¥ä¸‹phpè®¾ç½®\næ ¹æ®zabbixè¦æ±‚ï¼Œè°ƒæ•´max_input_time ç”±60æ”¹ä¸º300,åŒæ—¶è°ƒæ•´æ—¶åŒºdate.timezoneä¸º.Asia/Shanghai,ç„¶åä¿å­˜è®¾ç½®\nç„¶åå¯åŠ¨zabbixå’Œzabbix-agent\n1 2 /data/zabbix/sbin/zabbix_server /data/zabbix/sbin/zabbix_agentd ç„¶åå†æµè§ˆå™¨ä¸­è¾“å…¥ip/setup.php(æœåŠ¡å™¨IPåœ°å€ï¼‰ï¼Œè¿›è¡Œé…ç½®zabbix\næç¤ºç¼ºå°‘php ldapçš„è­¦å‘Š\næ— è§†ï¼Œç‚¹å‡»ä¸‹ä¸€æ­¥\né…ç½®mysql\nç„¶åè¿™é‡Œæç¤ºæŠ¥é”™ã€‚æˆ‘ä»¬éœ€è¦æŒ‰ç…§æå°†æ–‡ä»¶ä¸‹è½½ä¿å­˜ä¸º/www/wwwroot/zabbix/conf/zabbix.conf.php\u0026quot;\nå®Œæˆåï¼Œzabbixé…ç½®å®Œæˆ\nä»¥åå¯¹ zabbixçš„ç»´æŠ¤ï¼ŒåŒ…æ‹¬å®‰å…¨åŠ å›ºï¼Œæ•°æ®å¤‡ä»½ï¼Œæ–°èƒ½è°ƒä¼˜ç­‰ç­‰ï¼Œéƒ½å¯ä»¥é€šè¿‡å®å¡”é¢æ¿è¿›è¡Œ\n6ã€é…ç½®Linuxå®¢æˆ·ç«¯ 1.æ·»åŠ zabbixç”¨æˆ·å’Œç»„ã€‚\n1 2 groupadd zabbix useradd zabbix -g zabbix -s /sbin/nologin 2.å®‰è£…zabbixå®¢æˆ·ç«¯ã€‚\n1 2 3 tar xvf zabbix-4.2.4.tar.gz cd zabbix-4.2.4 ./configure --prefix=/data/zabbix_agent --enable-agent 1 make \u0026amp;\u0026amp; make install 3.æ·»åŠ æœåŠ¡ç«¯å£å’Œä¿®æ”¹å¯åŠ¨è„šæœ¬ã€‚\n1 2 3 4 echo \u0026#39;zabbix-agent 10050/tcp #Zabbix Agent\u0026#39; \u0026gt;\u0026gt; /etc/services echo \u0026#39;zabbix-agent 10050/udp #Zabbix Agent\u0026#39; \u0026gt;\u0026gt; /etc/services cp zabbix-4.2.2/misc/init.d/Fedora/core/zabbix_agentd /etc/init.d/ sed -i \u0026#39;s/BASEDIR=\\/usr\\/local/BASEDIR=\\/data\\/zabbix/g\u0026#39; /etc/init.d/zabbix_agentd Zabbix agentdä½¿ç”¨ chkconfig å°†å…¶åŠ å…¥ init çš„å¯åŠ¨æœåŠ¡\n1 2 chkconfig --add zabbix_agentd chkconfig --level 345 zabbix_agentd on ä½¿ç”¨ chkconfig --list æ£€æŸ¥ä¸€ä¸‹\n1 chkconfig --list | grep zabbix 4.ä¿®æ”¹zabbix_agenté…ç½®æ–‡ä»¶ã€‚\n1 vim /data/zabbix/etc/zabbix_agentd.conf 1 2 3 4 5 Server=192.168.1.83 //é…ç½®zabbix_serveræœåŠ¡ç«¯æœåŠ¡å™¨çš„IPåœ°å€ ServerActive=192.168.1.83 Hostname=linux_server1 //é…ç½®ä¸»æœºå PidFile=/var/tmp/zabbix_agentd.pid //æŒ‡å®špidè·¯å¾„ LogFile=/var/log/zabbix/zabbix_agentd.log //æŒ‡å®šæ—¥å¿—æ–‡ä»¶ ä¿å­˜é€€å‡º\n1 2 3 mkdir /var/log/zabbix touch /var/log/zabbix/zabbix_agentd.log chown -R zabbix.zabbix /var/log/zabbix 5.å¯åŠ¨å®¢æˆ·ç«¯æœåŠ¡å¹¶è¿›ç¨‹æµ‹è¯•ã€‚\n1 /etc/init.d/zabbix_agentd start 1 ps aux| grep zabbix åœ¨zabbixçš„æœåŠ¡ç«¯æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æµ‹è¯•ä¸å®¢æˆ·ç«¯æ˜¯å¦è”é€š\n1 /data/zabbix/bin/zabbix_get -s 192.168.1.160 -p10050 -kâ€net.if.in[eth0,bytes]â€ å¯ä»¥å¾—åˆ°ç½‘å¡ä¿¡æ¯è¯´æ˜å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å¯ä»¥æ­£å¸¸é€šä¿¡ã€‚\n7ã€é…ç½®Windowså®¢æˆ·ç«¯ 1.ä»å®˜æ–¹ä¸‹è½½Zabbix Agentåï¼Œå‹ç¼©åŒ…é‡Œé¢æœ‰2ä¸ªç›®å½•\nåœ¨Cç›˜ä¸‹åˆ›å»ºä¸€ä¸ªä¸ºzabbixçš„ç›®å½•ï¼Œåœ¨binæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ªä¸ºwin32å’Œwin64ä¸¤ä¸ªç›®å½•ï¼Œæ¯ä¸ªç›®å½•ä¸‹åº”è¯¥æœ‰3ä¸ª.exeç¨‹åºï¼Œåˆ†åˆ«ä¸ºï¼šzabbix_agentd.exe zabbix_get.exe zabbix_sender.exe\n2.æ ¹æ®è‡ªå·±çš„æ“ä½œç³»ç»Ÿå¤åˆ¶ç›¸åº”çš„win32/win64é‡Œè¾¹çš„æ•°æ®åˆ°åˆšåˆ›å»ºå¥½çš„c:\\zabbixç›®å½•ä¸‹\n3.å¤åˆ¶è§£å‹åzabbix_agents_2.4.4.winæ–‡ä»¶å¤¹confé‡Œçš„åœ¨Cç›˜çš„zabbixç›®å½•ä¸‹çš„confæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸ªzabbix_agentd.win.confä¿®æ”¹ä¸€ä¸‹å†…å®¹é‡å‘½åzabbix_agentd.confåˆ°c:\\zabbixä¸‹\nLogFile=c:\\zabbix\\zabbix_agentd.log\nServer=\u0026lt;æœåŠ¡ç«¯IPåœ°å€\u0026gt;\nHostname=win_server1\n4.å®‰è£…zabbixå®¢æˆ·ç«¯ã€‚ä¾æ¬¡æ‰§è¡Œ å¼€å§‹â€“\u0026gt;è¿è¡Œâ€“\u0026gt;cmd(ä¹Ÿå¯ä»¥ä½¿ç”¨win+Rå¿«æ·é”®ç›´æ¥æ‰“å¼€)ï¼Œåœ¨æ‰“å¼€çš„å‘½ä»¤æç¤ºç¬¦ä¸‹æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤\ncd c:\\zabbix\nzabbix_agentd.exe â€“c c:\\zabbix\\zabbix_agentd.conf -i\nçœ‹åˆ°ä¸Šé¢çš„ä¿¡æ¯è¯´æ˜agentå·²ç»å®‰è£…æˆåŠŸäº†ã€‚\n5.å¯åŠ¨å®¢æˆ·ç«¯\nzabbix_agentd.exe â€“s\nå¦‚æœåœ¨å¯åŠ¨çš„æ—¶å€™æŠ¥é”™ï¼Œè¯´cannot open config file[C:\\zabbix_agentd.conf]: [2] No such file or directoryï¼ŒæŠŠé…ç½®æ–‡ä»¶å¤åˆ¶åˆ°c:\\ä¸€ä»½å³å¯\nzabbix_agentd.exeå¯ç”¨å‚æ•°ä»‹ç»ï¼š\n-c æŒ‡å®šé…ç½®æ–‡ä»¶æ‰€åœ¨ä½ç½®\n-i å®‰è£…å®¢æˆ·ç«¯\n-s å¯åŠ¨å®¢æˆ·ç«¯\n-x åœæ­¢å®¢æˆ·ç«¯\n-d å¸è½½/åˆ é™¤å®¢æˆ·ç«¯\nå¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯å·²ç»ç›‘å¬åœ¨äº†10050ç«¯å£ä¸Šã€‚æ‰“å¼€windowsç®¡ç†å·¥å…·â€”\u0026gt;æœåŠ¡ï¼ŒæŸ¥çœ‹ä¸€ä¸‹\n8ã€åœ¨zabbixæœåŠ¡å™¨æ·»åŠ ä¸»æœº ","date":"2020-05-09T18:03:18Z","image":"https://www.ownit.top/title_pic/20.jpg","permalink":"https://www.ownit.top/p/202005091803/","title":"Centos7å®‰è£…ZabbixæœåŠ¡ç«¯ã€Zabbixå®¢æˆ·ç«¯å’ŒWinå®¢æˆ·ç«¯é…ç½®ï¼ˆæºç ç¼–è¯‘å®‰è£…ï¼‰"},{"content":"ç›®å½•\nç¬¬ä¸€ç«  åˆå…¥å…¬å¸\nç¬¬2ç«  ç¬¬ä¸€é˜¶æ®µï¼šè§£å†³ç‰©ç†æœåŠ¡å™¨å•ç”µé—®é¢˜\nç¬¬3ç«  ç¬¬äºŒé˜¶æ®µï¼šè§£å†³æœåŠ¡å™¨è™šæ‹ŸåŒ–é—®é¢˜\nç¬¬4ç«  ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®åº“å¤‡ä»½\nç¬¬5ç«  ç¬¬å››é˜¶æ®µï¼šè§£å†³æ•°æ®åº“å•ç‚¹\nç¬¬6ç«  ç¬¬äº”é˜¶æ®µï¼šå®Œå–„ç›‘æ§é¡¹\nç¬¬7ç«  ç¬¬å…­é˜¶æ®µï¼šç»Ÿä¸€æœåŠ¡çš„å®‰è£…æ–¹å¼\nç¬¬8ç«  ç¬¬ä¸ƒé˜¶æ®µï¼šå…³é”®æœåŠ¡ NFS è¿ç§»å¤‡ä»½\nç¬¬9ç«  ç¬¬å…«é˜¶æ®µï¼šæœåŠ¡æ‹†åˆ†-ç”¨æˆ·å’Œçˆ¬è™«æµé‡åˆ†ç¦»-ELK æ—¥å¿—æ”¶é›†\nç¬¬10ç«  ç¬¬ä¹é˜¶æ®µï¼šå¢åŠ ç¬¬äºŒæœºæˆ¿-å¤§æ•°æ®æœåŠ¡\nå®Œæ•´æ¶æ„å›¾\næ•´ä½“ç»“æ„æ¼”å˜\nç¬¬ä¸€ç«  åˆå…¥å…¬å¸ 1.1 æ¶æ„æ‹“æ‰‘å›¾ 1.2 å­˜åœ¨çš„é—®é¢˜æ±‡æ€» 1.ç‰©ç†æœåŠ¡å™¨ç”µæºå•ç”µï¼Œæœºæˆ¿ç”µåŠ›åˆ‡å‰²æ—¶éœ€è¦å…³é—­æ‰€æœ‰æœåŠ¡å™¨ï¼Œå¯¼è‡´æœåŠ¡ä¸­æ–­ 4-6 å°æ—¶ 2.ç‰©ç†æœåŠ¡å™¨é…ç½®ä¸å½“ï¼Œæœ‰çš„æœåŠ¡å™¨ç³»ç»Ÿç›˜ç”¨ SSDï¼Œæ•°æ®ç›˜åè€Œç”¨æœºæ¢°ç›˜ 3.æœåŠ¡å™¨è™šæ‹ŸåŒ– ESXi ä¸Šçš„è™šæ‹Ÿæœºç»å¸¸æ— æ•…å˜æˆç³»ç»Ÿåªè¯»å¯¼è‡´æœåŠ¡ä¸å¯ç”¨ 4.æ“ä½œç³»ç»Ÿä¸ç»Ÿä¸€ï¼Œæœ‰ debianï¼Œæœ‰ FreeBSD 5.æ•°æ®åº“å•ç‚¹ï¼Œä¸”æ²¡æœ‰å¤‡ä»½ä»¥åŠæ¢å¤è®¡åˆ’ 6.keepalived é…ç½®é”™è¯¯å¯¼è‡´ HA é«˜å¯ç”¨æ²¡æœ‰ç”Ÿæ•ˆ 7.é‡è¦çš„ NFS æœåŠ¡å™¨ 5T çš„æ•°æ®æ²¡æœ‰å¤‡ä»½ï¼Œä¸”æ“ä½œç³»ç»Ÿä¸º FreeBSD 8.zabbix ç›‘æ§é¡¹è¿‡å¤šï¼ŒæŠ¥è­¦å†…å®¹å¤ªå¤šï¼Œå…³é”®æŠ¥è­¦è¢«æ·¹æ²¡ 9.è½¯ä»¶éƒ¨ç½²æ–¹å¼ä¸ç»Ÿä¸€ï¼Œæœ‰ç¼–è¯‘/è„šæœ¬/tar åŒ…/deb åŒ…å¤šç§å®‰è£…æ–¹å¼ 10.è„šæœ¬ä¸ç»Ÿä¸€ï¼Œè„šæœ¬éšå¤„å­˜æ”¾ï¼Œå‘½åæ··ä¹±ï¼Œå¾ˆå¤šä¸çŸ¥é“æœ‰æ²¡æœ‰ç”¨ 11.æ²¡æœ‰æ‰¹é‡æ“ä½œå·¥å…·ï¼Œä¾é çº¯æ‰‹å·¥æˆ–è„šæœ¬æ“ä½œ ç¬¬2ç«  ç¬¬ä¸€é˜¶æ®µï¼šè§£å†³ç‰©ç†æœåŠ¡å™¨å•ç”µé—®é¢˜ 2.1 é—®é¢˜ç°è±¡ 1.ç‰©ç†æœåŠ¡å™¨ç”µæºå•æ¨¡å—ï¼Œå¦‚æœæœºæˆ¿è¿›è¡Œç”µåŠ›åˆ‡å‰²ï¼Œå¿…é¡»å…³é—­æ‰€æœ‰æœåŠ¡å™¨ï¼Œç­‰æœºæˆ¿ç”µåŠ›åˆ‡å‰²ç»“æŸå†æŠŠæ‰€æœ‰æœåŠ¡å™¨å¼€æœº\n2.2 å¯¼è‡´åæœ 1.ç”µåŠ›åˆ‡å‰²æœŸé—´æ‰€æœ‰çš„ä¸šåŠ¡å®Œå…¨ä¸­æ–­ï¼Œç”¨æˆ·åœ¨æ­¤æœŸé—´æ— æ³•è®¿é—®\n2.æœåŠ¡æ²¡æœ‰åšå¼€æœºè‡ªå¯åŠ¨ï¼Œé‡æ–°å¼€æœºä¹‹åéœ€è¦æ‰‹åŠ¨èµ·æœåŠ¡\n3.å› ä¸ºæœåŠ¡å™¨è€æ—§ï¼Œå…³æœºä¹‹åå¯èƒ½èµ·ä¸æ¥\n4.å› ä¸ºå…³æœºæ—¶æš´åŠ› kill äº†æœåŠ¡ï¼Œå¯¼è‡´æœåŠ¡å™¨é‡å¯åæ•°æ®æŸå\n2.3 è§£å†³æ–¹æ¡ˆ 1.å› ä¸ºæœåŠ¡å™¨å‹å·è€æ—§ï¼Œå‚å•†å·²ç»åœäº§ï¼Œä¹°ä¸åˆ°æ–°ç”µæº\n2.é€€è€Œæ±‚æ¬¡ï¼Œæ·˜å®è”ç³»å–äºŒæ‰‹æœåŠ¡å™¨çš„å–å®¶ï¼Œè´­ä¹°æœåŠ¡å™¨ç›¸åŒå‹å·çš„ç”µæº\n3.æœåŠ¡å™¨ç”µæºå±äºçƒ­æ’æ‹”ï¼Œå¯ä»¥ç›´æ¥æ’ä¸Šæµ‹è¯•\n4.éªŒæ”¶æ–¹æ³•ä¸ºï¼š\n- ä¸¤ä¸ªç”µæºæ¨¡å—éƒ½æ’ä¸Šç”µï¼Œç„¶åæ‹”æ‰ç¬¬ä¸€ä¸ªç”µæºæ¨¡å—ï¼ŒæŸ¥çœ‹æœåŠ¡å™¨æœ‰æ²¡æœ‰é‡å¯ã€‚\n- å¦‚æœæœåŠ¡å™¨æ²¡æœ‰é‡å¯ï¼Œå†å…¨éƒ¨æ’ä¸Šç”µæºï¼Œç„¶åå†æ‹”æ‰å¦ä¸€ä¸ªç”µæºï¼ŒæŸ¥çœ‹æœ‰æ²¡æœ‰é‡å¯\n- å¦‚æœéƒ½æ²¡æœ‰é‡å¯ï¼Œå°±è¯æ˜æœåŠ¡å™¨åŒç”µæ¨¡å—è¿è¡Œæ­£å¸¸\n2.4 ä»·å€¼ä½“ç° 1.ç”±åŸæ¥ä¸šåŠ¡éœ€è¦ä¸­æ–­ 4-6 å°æ—¶ç¼©çŸ­ä¸º 0 ä¸­æ–­\n2.ç»™å…¬å¸å‡å°‘äº†ç”±äºä¸šåŠ¡ä¸­æ–­å¯¼è‡´çš„ç»æµæŸå¤±\n3.è¿ç»´å†ä¹Ÿä¸ç”¨åœ¨æœºæˆ¿é€šå®µç†¬å¤œç­‰å¾…ç”µåŠ›åˆ‡å‰²äº†\nç¬¬3ç«  ç¬¬äºŒé˜¶æ®µï¼šè§£å†³æœåŠ¡å™¨è™šæ‹ŸåŒ–é—®é¢˜ 3.1 é—®é¢˜ç°è±¡ 1.æœåŠ¡å™¨è™šæ‹ŸåŒ–é‡‡ç”¨çš„æ˜¯ VMware ESXi è™šæ‹ŸåŒ–å¹³å°ï¼Œè¿è¡Œçš„è™šæ‹Ÿæœºç»å¸¸æ— æ•…çš„ç³»ç»Ÿå˜æˆåªè¯»ï¼Œå¯¼è‡´æœåŠ¡ä¸­æ–­\n3.2 å¯¼è‡´åæœ 1.è™šæ‹Ÿæœºè¿è¡Œçš„æœåŠ¡ä¸å¯ç”¨ï¼Œå¯¼è‡´ä¸šåŠ¡ä¸­æ–­ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ\n3.3 è§£å†³æ–¹æ¡ˆ 1.æ‰¾å°æ–°æœåŠ¡å™¨å®‰è£…éƒ¨ç½²æ–°ç‰ˆæœ¬çš„ ESXi,å®‰è£… VCenter ç®¡ç†ä¸­å¿ƒ\n2.è¿ç§»æ—§æœåŠ¡åˆ°æ–°æœåŠ¡å™¨\n3.æŒç»­è§‚å¯Ÿæ£€éªŒ\n3.4 ä»·å€¼ä½“ç° 1.æ–°ç‰ˆæœ¬è™šæ‹Ÿæœºè¿è¡Œç¨³å®šï¼Œä¸šåŠ¡ä¸ä¼šä¸­æ–­\n2.æœåŠ¡å™¨è™šæ‹ŸåŒ–å……åˆ†åˆ©ç”¨äº†ç¡¬ä»¶èµ„æºï¼Œä¸ºå…¬å¸èŠ‚çœäº†è´­ä¹° 3 å°ç‰©ç†æœåŠ¡å™¨çš„ä»·æ ¼\nç¬¬4ç«  ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®åº“å¤‡ä»½ 4.1 é—®é¢˜ç°è±¡ 1.mysql æ•°æ®åº“åªæœ‰ä¸€å°ä¸»ä»ï¼Œæ²¡æœ‰å¤‡ä»½\n2.redis å’Œ mongo å•ç‚¹ï¼Œä¸”æ²¡æœ‰å¤‡ä»½\n3.æ•°æ®åº“æœåŠ¡å™¨æ•°æ®ç›˜å‡ä¸ºå•å— SSD å›ºæ€ç¡¬ç›˜ï¼Œä¸€æ—¦æŸåæ²¡æœ‰ä¿®å¤çš„å¸Œæœ›\n4.2 å¯¼è‡´åæœ 1.å¦‚æœæ•°æ®åº“æœåŠ¡å™¨ç¡¬ä»¶æˆ–è€…ç¡¬ç›˜æŸåï¼Œæ²¡æœ‰æ•°æ®å¯ä»¥æä¾›æ¢å¤ï¼Œåæœä¸å ªè®¾æƒ³\n4.3 è§£å†³æ–¹æ¡ˆ 1.è¿™ä¸ªé˜¶æ®µé‡ç‚¹æ˜¯å…ˆå¤‡ä»½æ•°æ®\n2.æ–°å¢åŠ ä¸€ä¸ª mysql ä»åº“ï¼Œä½¿ç”¨ xtrabackup åœ¨ä»åº“ä¸Šæ¯å¤©å®šæ—¶å¤‡ä»½æ•°æ®\n3.æ–°å¢åŠ ä¸€ä¸ª redis ä»åº“ï¼Œæ¯å¤©ç‰©ç†å¤‡ä»½ redis æŒä¹…åŒ–çš„ RDB æ–‡ä»¶\n4.æ–°å¢åŠ ä¸€ä¸ª mongo ä»åº“ï¼Œæ¯å¤©ä½¿ç”¨ mongodump å¯¼å‡ºæ•°æ®\n4.4 ä»·å€¼ä½“ç° 1.åœ¨æœåŠ¡å™¨æœ‰é™å’Œæ—¶é—´æœ‰é™çš„æƒ…å†µä¸‹ï¼ŒæŒ‰ç…§ç´§æ€¥åº¦ä¼˜å…ˆè§£å†³æ•°æ®åº“å¤‡ä»½\n2.é™ä½äº†å› ä¸ºç‰©ç†æœåŠ¡å™¨æŸåæˆ–è€…äººä¸ºæ“ä½œå¤±è¯¯å¯¼è‡´çš„æ•°æ®ç¾éš¾æ€§ä¸¢å¤±æƒ…å†µ\n3.ä¸ºä¸‹ä¸€æ­¥æ•°æ®åº“æœåŠ¡é›†ç¾¤åŒ–æä¾›äº†åŸºç¡€ä¿éšœ\n4.5 æ‹“æ‰‘å›¾ ç¬¬5ç«  ç¬¬å››é˜¶æ®µï¼šè§£å†³æ•°æ®åº“å•ç‚¹ 5.1 é—®é¢˜ç°è±¡ 1.æ•°æ®åº“æ•…éšœåˆ°å®Œå…¨ä¿®å¤è¿‡ç¨‹ä¸­ï¼Œä¸šåŠ¡ä¼šä¸­æ–­ï¼Œç”¨æˆ·ä¸èƒ½è®¿é—®\n5.2 å¯¼è‡´åæœ 1.è™½ç„¶å·²ç»åšäº†æ•°æ®åº“å¤‡ä»½ï¼Œä½†æ˜¯ä¸€æ—¦æ•°æ®åº“æŸåï¼Œæ¢å¤èµ·æ¥ä¾ç„¶éœ€è¦å¾ˆå¤šæ—¶é—´\n2.ç”±äºä¸šåŠ¡ä»£ç å†™æ­»äº† IP åœ°å€ï¼Œä¸€æ—¦æ•°æ®åº“æŸåï¼Œåœ¨å…¶ä»–æœºå™¨ä¸Šæ¢å¤äº†ï¼Œä¸šåŠ¡ä»£ç ä¹Ÿéœ€è¦å˜æ›´ IP åœ°\nå€ï¼Œé‡æ–°å‘å¸ƒï¼Œè€—æ—¶å¤ªé•¿\n5.3 è§£å†³æ–¹æ¡ˆ 1.å¯¹ç›®å‰å•ç‚¹æ•°æ®åº“å‡çº§åˆ°é›†ç¾¤æ¶æ„\n2.æ–°å¢åŠ  mysql ä»åº“ã€‚\n3.redis ç”±å•èŠ‚ç‚¹å‡çº§ä¸º redis cluster é›†ç¾¤\n4.mongo ç”±ä¸»ä»å¤åˆ¶å‡çº§ä¸º 3 èŠ‚ç‚¹å‰¯æœ¬é›†\n5.æ–°éƒ¨ç½² elasticsearch æœåŠ¡é›†ç¾¤\n5.4 å®æ–½éš¾ç‚¹ 1.å¯¹äºè¿ç»´æ¥è¯´ï¼Œå®‰è£…éƒ¨ç½²ä¸å¤æ‚ï¼Œä½†æ˜¯éš¾é¢˜åœ¨äºç”±äºæ•°æ®åº“æ¶æ„å‡çº§ï¼Œä»è€Œå¯¼è‡´ä¸šåŠ¡ä»£ç è¿æ¥æ–¹\nå¼å‘ç”Ÿæ”¹å˜\n2.å› ä¸ºç°åœ¨çš„ä¸šåŠ¡ä»£ç éƒ½æ˜¯é‡‡ç”¨æ¡†æ¶å¼€å‘ï¼Œæ‰€ä»¥å¾ˆå¤šæ•°æ®åº“æ’ä»¶éœ€è¦å‡çº§ï¼Œæ¯”å¦‚ redis å’Œ mongo éƒ½éœ€\nè¦å‡çº§æ’ä»¶æ‰èƒ½æ”¯æŒé›†ç¾¤åŒ–è¿æ¥\n3.éœ€è¦æå‰åœ¨å¼€å‘ç¯å¢ƒæ­å»ºéƒ¨ç½²å¥½ã€‚ç„¶åå¼€å‘æµ‹è¯•æ²¡æœ‰é—®é¢˜ä¹‹åï¼Œå†é‡‡ç”¨è½®è®­å‡çº§çš„æ–¹å¼é€æ­¥å‡çº§\nå‡çº§æ•°æ®åº“ä»¥åŠä»£ç æ¡†æ¶\n5.5 ä»·å€¼ä½“ç° 1.å¯¹æ•°æ®åº“çš„ç¨³å®šæ€§ä»¥åŠå®‰å…¨æ€§æœ‰äº†è´¨çš„æ”¹å˜\n2.ç”±äºæ•°æ®åº“é›†ç¾¤åŒ–ï¼Œæ€§èƒ½å¾—åˆ°äº†å¤§å¤§çš„æå‡ï¼Œç”¨æˆ·æ‰“å¼€ç½‘ç«™è®¿é—®é€Ÿåº¦æ›´å¥½ï¼Œä½“éªŒæ›´å¥½\n3.ç”±äºæ•°æ®åº“é›†ç¾¤åŒ–ï¼Œæä¾›äº†å†—ä½™ï¼Œæ‰€ä»¥å³ä½¿æœåŠ¡å™¨æŸåæˆ–è€…ç»´æŠ¤ä¹Ÿä¸ä¼šå½±å“æ¶æ„æ”¹å˜ï¼Œç”¨æˆ·è®¿é—®\nä¹Ÿä¸ä¼šä¸­æ–­\n4.å‡å°‘äº†å› ä¸ºæ•°æ®åº“å®•æœºæˆ–æ¢å¤å¯¼è‡´çš„ç»æµæŸå¤±\n5.6 æ‹“æ‰‘å›¾ ç¬¬6ç«  ç¬¬äº”é˜¶æ®µï¼šå®Œå–„ç›‘æ§é¡¹ 6.1 é—®é¢˜ç°è±¡ 1.ç›‘æ§é¡¹æŠ¥è­¦å†…å®¹å¤ªå¤šï¼Œæœ‰æ—¶å€™å‡ åˆ†é’Ÿä¸Šç™¾æ¡\n6.2 å¯¼è‡´åæœ 1.å…³é”®çš„æŠ¥è­¦ä¿¡æ¯è¢«ä¸é‡è¦çš„æŠ¥è­¦æ·¹æ²¡ï¼Œä»¥è‡³äºä¸èƒ½ç¬¬ä¸€æ—¶é—´å‘ç°å…³é”®é—®é¢˜\n2.ç”±äºæŠ¥è­¦ç›‘æ§é¡¹é…ç½®ä¸å½“ï¼Œå¯¼è‡´è¿é”ååº”ï¼Œç‰µåŠ¨å¾ˆå¤šä¸éœ€è¦çš„è­¦å‘Š\n3.ç”±äºçŸ­æ—¶é—´å¤§é‡çš„æŠ¥è­¦äº§ç”Ÿï¼Œå¯¹ zabbix æœåŠ¡å™¨é€ æˆå¾ˆå¤§å‹åŠ›ï¼Œç”šè‡³å¯¼è‡´ zabbix æœåŠ¡å®•æœº\n4.å¦‚æœé…ç½®äº†çŸ­ä¿¡æŠ¥è­¦ï¼Œé‚£ä¹ˆå¤§é‡çš„éå…³é”®æŠ¥è­¦å¯¼è‡´æ¶ˆè€—å¾ˆå¤šçŸ­ä¿¡æ¡ç›®ï¼Œå¾ˆèŠ±é’±ï¼\n6.3 è§£å†³æ–¹æ¡ˆ 1.ä¼˜åŒ–æŠ¥è­¦å†…å®¹ï¼Œåªç›‘æ§å¿…é¡»è¦ç›‘æ§çš„ï¼Œæ¨¡ç‰ˆè‡ªå¸¦çš„ä¸€äº›ä¸éœ€è¦çš„ç›‘æ§é¡¹åœæ‰\n2.æŠ¥è­¦åˆ†çº§ï¼Œå°†æŠ¥è­¦ä¿¡æ¯æŒ‰ç´§æ€¥åº¦æ‹†åˆ†ï¼Œæ‰€æœ‰æŠ¥è­¦éƒ½å‘é‚®ä»¶ï¼Œç´§æ€¥çš„æŠ¥è­¦è¿½åŠ å‘é€åˆ°å¾®ä¿¡\n3.å–æ¶ˆçŸ­ä¿¡æŠ¥è­¦ï¼Œæ”¹ä¸ºé‚®ä»¶å’Œå¾®ä¿¡æŠ¥è­¦\n4.æŠ¥è­¦å†…å®¹ä¼˜åŒ–ï¼Œå°½é‡çœ‹æ ‡é¢˜å°±èƒ½çŸ¥é“æŠ¥è­¦å†…å®¹æ˜¯ä»€ä¹ˆ\n6.4 ä»·å€¼ä½“ç° 1.æ¥å—çš„æŠ¥è­¦é‡å¤§å¤§å‡å°‘ï¼Œè¿ç»´çš„æ³¨æ„åŠ›å¯ä»¥æ›´é›†ä¸­åœ¨å…³é”®çš„é—®é¢˜å¤„ç†ä¸Š\n2.é€šè¿‡ä¸åŒçš„å‘é€ä»‹è´¨ç¬¬ä¸€æ—¶é—´äº†è§£é—®é¢˜çš„ç´§æ€¥åº¦ï¼Œæ¯”å¦‚å‘é€åˆ°å¾®ä¿¡ä¸Šçš„éƒ½æ˜¯éœ€è¦ç«‹åˆ»å¤„ç†çš„\n3.å–æ¶ˆçŸ­ä¿¡æŠ¥è­¦ä¸ºå…¬å¸èŠ‚çœå¼€é”€\nç¬¬7ç«  ç¬¬å…­é˜¶æ®µï¼šç»Ÿä¸€æœåŠ¡çš„å®‰è£…æ–¹å¼ 7.1 é—®é¢˜ç°è±¡ 1.æœåŠ¡å®‰è£…æ··ä¹±ï¼Œæœ‰è„šæœ¬å®‰è£…ï¼Œæœ‰ tar åŒ…å®‰è£…ï¼Œæœ‰ deb åŒ…å®‰è£…ï¼Œæœ‰ç¼–è¯‘å®‰è£…\n2.è½¯ä»¶å­˜æ”¾ç›®å½•ä¸ç»Ÿä¸€ï¼Œæ•°æ®å­˜æ”¾ç›®å½•ä¸ç»Ÿä¸€ï¼Œè„šæœ¬å­˜æ”¾ç›®å½•ä¸ç»Ÿä¸€\n3.é˜²ç«å¢™è§„åˆ™ä¸ç»Ÿä¸€ï¼Œæœ‰ä¸€äº›ä¸ç”¨çš„è§„åˆ™æ²¡æœ‰æ¸…ç†\n7.2 å¯¼è‡´åæœ 1.ä¸€äº›æ“ä½œæ— æ³•è¿›è¡Œæ‰¹é‡æ‰§è¡Œ\n2.å®‰è£…æœåŠ¡åŸºæœ¬éœ€è¦æ‰‹åŠ¨æ“ä½œ\n3.æ–‡æ¡£ç¼ºå¤±ï¼Œä¸çŸ¥é“ä»¥å‰æ€ä¹ˆè£…çš„ï¼Œä¸çŸ¥é“ä»¥å‰é…äº†ä»€ä¹ˆå‚æ•°\n4.é˜²ç«å¢™è§„åˆ™æ··ä¹±ï¼Œæœ‰ä¸€äº›å·²ç»ä¸ç”¨çš„æœåŠ¡ï¼Œä½†æ˜¯è§„åˆ™æ²¡æœ‰åˆ é™¤ï¼Œçœ‹èµ·æ¥å¾ˆä¹±\n7.3 è§£å†³æ–¹æ¡ˆ 1.å¼•å…¥ ansible æ‰¹é‡ç®¡ç†å·¥å…·ï¼Œç»Ÿä¸€æœåŠ¡å®‰è£…æ–¹å¼ï¼Œæ–°æœåŠ¡ç»Ÿä¸€ä½¿ç”¨ playbook å®‰è£…\n2.ç»Ÿä¸€æœåŠ¡å®‰è£…ç›®å½•ï¼Œæ•°æ®ç›®å½•ï¼Œæ—¥å¿—ç›®å½•\n3.æ¸…ç†é˜²ç«å¢™ä¸ç”¨çš„è§„åˆ™ï¼Œåªä¿ç•™å¿…é¡»çš„è§„åˆ™\n4.ç¼–å†™è¿ç»´æ–‡æ¡£ï¼Œåˆ¶å®šè¿ç»´è§„èŒƒ\n7.4 ä»·å€¼ä½“ç° 1.æ–°æœåŠ¡å®‰è£…éƒ¨ç½²ç”±åŸæ¥çš„æŒ‰å°æ—¶ç¼©çŸ­ä¸ºåˆ†é’Ÿçº§åˆ«ï¼Œæé«˜äº†è¿ç»´æ•ˆç‡\n2.é¿å…äº†å› ä¸ºæ‰‹åŠ¨æ“ä½œæ•²é”™å‘½ä»¤å¯¼è‡´çš„ä¸å¯é¢„æ–™åæœï¼Œå®ç°äº†ä¸€æ¬¡ç¼–å†™é‡å¤è¿è¡Œ\n3.ç¼–å†™è¿ç»´æ–‡æ¡£ï¼Œä¸ºéƒ¨é—¨åŒäº‹å’Œå…¬å¸ç•™ä¸‹å¯æŒç»­çš„ä»·å€¼è¾“å‡º\nç¬¬8ç«  ç¬¬ä¸ƒé˜¶æ®µï¼šå…³é”®æœåŠ¡ NFS è¿ç§»å¤‡ä»½ 8.1 é—®é¢˜ç°è±¡ 1.å…¬å¸æˆç«‹ä»¥æ¥æ‰€æœ‰çš„å›¾ç‰‡æ•°æ®éƒ½ä¿å­˜åœ¨ä¸€å°å®‰è£… FreeBSD æ“ä½œç³»ç»Ÿçš„è€æ—§æœåŠ¡å™¨ä¸Šä¸”æ²¡æœ‰å¤‡ä»½\n8.2 å¯¼è‡´åæœ 1.NFS æœåŠ¡å™¨çš„æ•°æ®é«˜è¾¾ 5Tï¼Œä¸”æ²¡æœ‰å¤‡ä»½ï¼Œä¸€æ—¦æœåŠ¡å™¨æˆ–ç¡¬ç›˜æŸåï¼Œåæœä¸å ªè®¾æƒ³\n2.ç”±äº FreeBSD æ“ä½œç³»ç»Ÿçš„åŸå› ï¼Œæ²¡æœ‰åŠæ³•ä½¿ç”¨ sersync æ¥è¿›è¡Œå®æ—¶åŒæ­¥å¤‡ä»½\n3.ä¸€æ—¦æœåŠ¡å™¨å‘ç”ŸæŸåï¼Œæ‰€æœ‰ä¸šåŠ¡ç½‘ç«™çš„å›¾ç‰‡æœåŠ¡éƒ½å°†å¤±æ•ˆï¼ŒçŸ­æ—¶é—´æ²¡æœ‰æ›¿ä»£æ–¹æ¡ˆ\n8.3 è§£å†³æ–¹æ¡ˆ 1.è™½ç„¶ FreeBSD ç³»ç»Ÿä¸èƒ½ä½¿ç”¨ sersyncï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ rsync\n2.æ‰¾ä¸€å°æ€§èƒ½è¶³å¤ŸæœåŠ¡å™¨ï¼Œä½¿ç”¨å››å— 6T ç£ç›˜åˆ¶ä½œ RAID10ï¼Œå®‰è£…éƒ¨ç½² rsync æœåŠ¡ç«¯å’Œ NFS æœåŠ¡ç«¯\n3.åˆ†ç›®å½•è¿›è¡ŒåŒæ­¥ï¼Œæ€»ç›®å½•æ•°æ®é‡å¤ªå¤§ï¼ŒåŒæ­¥èµ·æ¥æ—¶é—´æŒ‰å¤©ç®—ï¼Œæ‹†åˆ†æˆä¸€ä¸ªä¸ªå°ç›®å½•åˆ†æ‰¹è¿›è¡ŒåŒæ­¥\n4.ç»Ÿè®¡è®°å½•æ¯æ¬¡åŒæ­¥çš„æ—¶é—´ï¼Œæœ€é«˜åœ¨åŠå¤œä¸šåŠ¡ä½å³°æœŸè¿›è¡ŒåŒæ­¥\n5.å’Œå¼€å‘æ²Ÿé€šåˆ‡æ¢æ–¹æ¡ˆï¼Œå¼€å‘ä¿®æ”¹ä»£ç ï¼Œç”¨æˆ·ä¸Šä¼ æ•°æ®åŒæ—¶å¾€ 2 å°æœåŠ¡å™¨ä¸Šå†™å…¥ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§\n6.ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œåˆ‡æ¢ï¼Œåœ¨å‰ç«¯ä»£ç†è½®æµæ›´æ–° WEB æœåŠ¡å™¨çš„å¸è½½æ—§ NFSï¼Œç„¶åé‡æ–°æŒ‚è½½æ–° NFS\n7.ä¿®æ”¹ä¸ªåˆ«æƒé™ä¸å¯¹çš„ç›®å½•ã€‚æµ‹è¯•æ‰€æœ‰ä¸Šä¼ ä¸šåŠ¡æ˜¯å¦å¯ä»¥æ­£å¸¸çš„å†™å…¥\n8.ä¸ºäº†é˜²æ­¢æ„æ–™ä¸åˆ°çš„æ„å¤–æƒ…å†µï¼Œæ—§æœåŠ¡å™¨æ•°æ®ç»§ç»­ä¿ç•™ 1 ä¸ªæœˆã€‚ç¡®å®šä¸€åˆ‡æ­£å¸¸ä¹‹åé‡åšæ—§æœåŠ¡å™¨\n9.ç„¶åä½¿ç”¨ sersync åŒæ­¥æ•°æ®åˆ°æ–°æœåŠ¡å™¨ï¼ŒæŒç»­è§‚å¯Ÿï¼Œä¿è¯åŒæ­¥æ­£å¸¸å·¥ä½œ\n8.4 ä»·å€¼ä½“ç° 1.åœ¨ä¸šåŠ¡ä¸ä¸­æ–­ï¼Œæ•°æ®ä¸ä¸¢å¤±çš„æƒ…å†µä¸‹ä¸ºå…¬å¸çš„å®è´µèµ„äº§æä¾›äº†å¯é çš„å¤‡ä»½æ–¹æ¡ˆ\n2.çƒ«æ‰‹çš„å±±èŠ‹åœ¨è¿ç»´æ‰‹é‡Œå¾—åˆ°äº†è§£å†³ï¼Œè£èª‰æ„Ÿï¼Œæˆå°±æ„Ÿå¤§å¢\n3.åœ¨å…¬å¸é¢†å¯¼å’ŒåŒäº‹å¿ƒä¸­ç•™ä¸‹äº†å¯é å¯ä¿¡èµ–çš„å°è±¡\n8.5 æ‹“æ‰‘å›¾ ç¬¬9ç«  ç¬¬å…«é˜¶æ®µï¼šæœåŠ¡æ‹†åˆ†-ç”¨æˆ·å’Œçˆ¬è™«æµé‡åˆ†ç¦»-ELK æ—¥å¿—æ”¶é›† 9.1 é—®é¢˜ç°è±¡ 1.å› ä¸ºå…¬å¸æœ‰è®ºå›ï¼Œéœ€è¦çˆ¬è™«æ¥çˆ¬å–\n2.ä½†æ˜¯çˆ¬è™«çš„æµé‡å’Œç”¨æˆ·çš„æµé‡æ··åˆåœ¨äº†ä¸€èµ·ï¼Œä¸”æ²¡æœ‰ç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†å¹³å°æŸ¥çœ‹è¿‡æ»¤\n9.2 å¯¼è‡´åæœ 1.ç”±äºæµé‡æ²¡æœ‰åˆ†ç¦»ï¼Œå¯¼è‡´å½“æœ‰å¤§é‡çš„çˆ¬è™«è®¿é—®çš„æ—¶å€™ï¼Œå¯¹æœåŠ¡å™¨å’Œæ•°æ®åº“é€ æˆéå¸¸å¤§çš„å‹åŠ›\n2.å½“çˆ¬è™«è®¿é—®é¢‘æ¬¡è¿‡é«˜æ—¶ï¼Œä¼šå¯¼è‡´æ•°æ®åº“è¿æ¥æ•°å˜å¤šï¼Œç³»ç»Ÿè´Ÿè½½å˜é«˜ï¼Œå½±å“ç”¨æˆ·æ­£å¸¸æœåŠ¡\n3.åŒæ ·ï¼Œç”±äºçˆ¬è™«æµé‡å’Œç”¨æˆ·æµé‡æ··åœ¨äº†ä¸€èµ·ï¼Œæ²¡æœ‰å¾ˆå¥½çš„åŠæ³•åˆ†æå‹åŠ›é«˜çš„åŸå› \n4.å¼€å‘æˆ–è€…è¿è¥æƒ³çœ‹ä¸€äº›æ—¥å¿—æ•°æ®åªèƒ½æ‰¾è¿ç»´è§£å†³ï¼Œæ¯æ¬¡åˆ†æéƒ½è¦èŠ±å¾ˆä¹…ï¼Œåˆ†æè„šæœ¬æ²¡æœ‰åŠæ³•å¤ç”¨\n9.3 è§£å†³æ–¹æ¡ˆ 1.æ–°å¢åŠ ä¸€å° WEB æœåŠ¡å™¨ä¸“é—¨ç»™çˆ¬è™«ä½¿ç”¨ï¼Œé¡µé¢åšé™æ€åŒ–ï¼Œä¼˜åŒ–çˆ¬è™«æŠ“å»æ•ˆç‡\n2.æ•°æ®åº“è¯»å†™åˆ†ç¦»ï¼Œçˆ¬è™«æŠ“å–å¦‚æœéœ€è¦æŸ¥è¯¢æ•°æ®åº“ï¼ŒæŠŠæµé‡æŒ‡å‘æ²¡æœ‰ä¸šåŠ¡è®¿é—®çš„ä»åº“\n3.å‰ç«¯ä»£ç†æ ¹æ®è®¿é—®çš„è¯·æ±‚æŠ¥æ–‡é‡Œçš„ user-agent æ¥åˆ†ç¦»çˆ¬è™«å’Œç”¨æˆ·çš„è®¿é—®æµé‡ï¼Œå¦‚æœæ˜¯çˆ¬è™«å°±æŠŠæµé‡å¼•åˆ°ç»™çˆ¬è™«æŠ“å–çš„ WEB æœåŠ¡å™¨ä¸Šï¼Œç”¨æˆ·æ­£å¸¸çš„æµé‡è¿˜æ˜¯æ­£å¸¸è®¿é—® WEB é›†ç¾¤ã€‚\n4.æ­å»ºéƒ¨ç½² ELK æ—¥å¿—æ”¶é›†å¹³å°ï¼Œé›†ä¸­æ”¶é›†æ‰€æœ‰ Nginx è®¿é—®æ—¥å¿—ï¼Œä½¿ç”¨ kibana ä½œä¸ºè¿‡æ»¤æœç´¢å’Œå±•ç¤ºï¼Œ\nåˆ¶ä½œå¥½ç”¨æˆ·å±•ç¤ºæ•°æ®çš„å›¾è¡¨ï¼ŒåŸ¹è®­éƒ¨é—¨åŒäº‹ ELK çš„ä½¿ç”¨å’ŒæŸ¥è¯¢æ–¹æ³•\n9.4 ä»·å€¼ä½“ç° 1.å°†ç”¨æˆ·å’Œçˆ¬è™«æµé‡åˆ†ç¦»ï¼Œå½“çˆ¬è™«å¤§é‡è®¿é—®æ—¶å€™æ­£å¸¸ç”¨æˆ·è®¿é—®ä¹Ÿä¸ä¼šå—åˆ°å½±å“ï¼Œç”¨æˆ·ä½“éªŒå¤§å¤§æå‡\n2.æ­å»ºéƒ¨ç½²äº† ELK æ—¥å¿—åˆ†æå¹³å°ï¼Œæ–¹ä¾¿éƒ¨é—¨åŒäº‹æŸ¥è¯¢æ•°æ®ï¼Œå®šä½æ•…éšœæ—¶é—´å¤§å¤§åœ°ç¼©å‡ï¼Œå¤§å¤§æé«˜äº†å·¥ä½œæ•ˆç‡\n9.5 æ‹“æ‰‘å›¾ ç¬¬10ç«  ç¬¬ä¹é˜¶æ®µï¼šå¢åŠ ç¬¬äºŒæœºæˆ¿-å¤§æ•°æ®æœåŠ¡ 10.1 é¡¹ç›®éœ€æ±‚ 1.ä¸šåŠ¡å‘å±•ï¼Œéœ€è¦éƒ¨ç½² Hadoop å¹³å°å’Œ kafka+zookeeper æœåŠ¡\n2.ç”±äº IDC æœºæˆ¿åªæœ‰ä¸€ä¸ªæœºæ¶ï¼Œæ‰€ä»¥éœ€è¦åœ¨ç¬¬äºŒæœºæˆ¿éƒ¨ç½²\n10.2 ä»·å€¼ä½“ç° 1.æµ‹è¯•ç¯å¢ƒæµ‹è¯•æ²¡é—®é¢˜åä½¿ç”¨ ansible æ‰¹é‡éƒ¨ç½²åˆ°æ–°çš„å¤§æ•°æ®æœåŠ¡å™¨ï¼ŒèŠ‚çœäº†éƒ¨ç½²æ—¶é—´\n2.å¤§æ•°æ®æœåŠ¡å¯ä»¥æ›´å¥½çš„åˆ†æç”¨æˆ·è®¿é—®è¡Œä¸ºï¼Œæ ¹æ®åˆ†æç»“æœå¯ä»¥æ›´ç²¾ç¡®çš„ç»™ç”¨æˆ·æ¨é€æ¨èå†…å®¹\n10.3 æ‹“æ‰‘å›¾ å®Œæ•´æ¶æ„å›¾ æ•´ä½“ç»“æ„æ¼”å˜ ","date":"2020-04-29T17:20:47Z","image":"https://www.ownit.top/title_pic/02.jpg","permalink":"https://www.ownit.top/p/202004291720/","title":"è¿ç»´å·¥ä½œç»éªŒæ±‡æ€»-é«˜çº§è¿ç»´å·¥ç¨‹å¸ˆ"},{"content":"æ‰‹è¯¯ã€åˆ åº“ã€‘ == è·‘è·¯ï¼Œä¸å­˜åœ¨çš„ â€”â€”åˆ ç“¦è¾›æ ¼ å‰è¨€ ä»Šå¤©å…¬å¸æœåŠ¡å™¨çš„å®å¡”æ‰“ä¸å¼€ï¼Œè®©æˆ‘å»ä¿®ï¼ˆpsï¼šå®å®å§”å±ˆï¼‰\næ‰“å¼€æ‰¾ä¸€ä¸‹é—®é¢˜æ‰€åœ¨\né—®é¢˜ï¼š å‘ç°æ˜¯å®å¡”å®˜æ–¹çš„cdnå¥½åƒæŒ‚æ‰äº†\nè§£å†³æ€è·¯ï¼š ï¼ˆ1ï¼‰æœ¬åœ°é‡æ–°æä¸ªæœåŠ¡å™¨è£…å®å¡”ï¼Œå‘ç°æ²¡é—®é¢˜ ï¼ˆ2ï¼‰æ¯”è¾ƒä¸€ä¸‹ï¼Œå‘ç°çº¿ä¸Šçš„ç¡®å®cdnæœ‰é—®é¢˜ ï¼ˆ3ï¼‰æŠŠæœ¬åœ°çš„å¯ä»¥ç”¨çš„cdnï¼Œæ”¾åˆ°çº¿ä¸Šå°±è¡Œã€‚ è§£å†³ï¼š å§æ§½ï¼Œæˆ‘å‘ä¸‹ï¼Œæˆ‘æ ¹æœ¬ä¸äº†è§£å®å¡”çš„ç›®å½•ç»“æ„ã€psï¼šè§£å†³æ¯›çº¿ï¼Œä¸‹ç­èµ°äººã€‘\næ­£æ–‡ åˆ«çœ¨çœ¼ï¼Œæ¥ä¸‹çš„æˆ‘sbçš„æ“ä½œï¼ŒçœŸçš„äº®çæˆ‘ç‹—çœ¼ã€psï¼šåˆ«å®³æ€•ï¼Œä¹Ÿä¼šäº®çä½ çš„ç‹—çœ¼çš„ï¼Œå˜¿å˜¿ã€‚ã€‚ã€‚ã€‘\nå¸¸è§„æ“ä½œï¼š ï¼ˆ1ï¼‰å¤‡ä»½è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼Œè¿™æ˜¯èŒä¸šæœ¬èƒ½ï¼ŒOKï¼Œæ²¡æ¯›ç—…ï¼Œæˆ‘å–œæ¬¢ã€‚\nï¼ˆ2ï¼‰åˆ é™¤é‚£ä¸ªæ²¡ç”¨çš„æ–‡ä»¶Â ã€æ–‡ä»¶ï¼šä½ æ‰æ²¡ç”¨ï¼Œçœ‹è€å­çš„ç§»é­‚å¤§æ³•ã€‘\né‡ç‚¹ï¼š å¤‡ä»½ä¸€åˆ‡overï¼Œåˆ é™¤æ—¶ï¼Œæˆ‘æ‰‹è´±å¤šæ‰“äº†ä¸ªÂ *Â ã€‚\n**ç„¶åæ²¡æ€è€ƒï¼Œä¸€ä¸ªå›è½¦ï¼Œé‚£æ„Ÿè§‰çˆ½å•ŠÂ **\næ±‚å¾·ç›å¾—\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;..é›…è ›è¶\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip; å¯¹ï¼Œctrl +c ä½ å·²ç»çœ‹å‡ºæˆ‘çš„ç»æœ›äº† è¯´æ—¶è¿Ÿé‚£æ—¶å¿«ï¼Œæå‡ºæ‰‹æœºï¼ŒæŠ¢ç¥¨ä¸€å¼ å»å¾€éæ´²çš„æœºç¥¨ æˆ‘å¤šæ‰“ä¸€ä¸ª *Â ï¼Œå¯¼è‡´æŠŠçº¿ä¸Šç¯å¢ƒçš„Â nginxæœåŠ¡ï¼Œphpç¯å¢ƒï¼Œredisç¼“å­˜ï¼Œmysqlæ•°æ®åº“ï¼Œå…¨éƒ¨åˆ æ‰äº†\nä¸å¤šè¯´ï¼Œèµ¶ç´§è·‘è·¯äº†\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;.. é£æœºå»¶æ—¶ï¼Œå…¬å¸å‘ç° è·‘è·¯å¤±è´¥ï¼Œå½“åœºè¢«æ• æ•°æ®æ¢å¤ ï¼ˆ1ï¼‰åœæ­¢å¯¹æœåŠ¡å™¨è¿›è¡Œä¸€åˆ‡çš„å†™å…¥æ“ä½œï¼Œå¸è½½æŒ‚è½½ ï¼ˆ2ï¼‰å®‰è£…extundeleteï¼Œè¿›è¡Œæ‰«æ ï¼ˆ3ï¼‰æ¢å¤æ•°æ®ï¼Œç¯å¢ƒå†æ¬¡é‡æ–°å·¥ä½œ PSï¼šå› ä¸ºè¿™ä¸ªæœåŠ¡å™¨æ²¡æœ‰ææœ¬åœ°å¤‡ä»½å’Œå¼‚åœ°æœ¬åœ°ï¼Œæ‰€ä»¥æ‰æœ‰ä¸‹é¢è¿™äº›ç ´äº‹ï¼Œå†ä¸æ˜¯ï¼Œç›´æ¥å¤‡ä»½æ¢å¤å°±è¡Œäº†\nï¼ˆ1ï¼‰åœæ­¢å¯¹æœåŠ¡å™¨è¿›è¡Œä¸€åˆ‡çš„å†™å…¥æ“ä½œï¼Œå¸è½½æŒ‚è½½\nå½“å‘ç°è¯¯åˆ é™¤æ–‡ä»¶æ—¶ï¼Œä¸ºäº†å°½å¯èƒ½çš„æ¢å¤æ•°æ®ï¼Œå…ˆè¦å…³æ‰æ‰€æœ‰çš„æ­£åœ¨è¿›è¡Œçš„æœåŠ¡ï¼Œä¸è¦å†è¿›è¡Œæ•°æ®çš„å†™å…¥ï¼Œè¦ä¸ç„¶æ¢å¤çš„æ¦‚ç‡é‚£å°±ä½äº†ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥\n1 # killall è¿›ç¨‹å æˆ–è€…\n1 # kill -9 pid ç„¶åæŠŠè¯¯åˆ é™¤çš„æ–‡ä»¶æ‰€åœ¨åˆ†åŒºï¼Œé‡æ–°æŒ‚è½½æˆåªè¯»çš„\n1 #Â mountÂ -o roÂ /dev/sdbÂ /data/Â ï¼ˆ2ï¼‰å®‰è£…extundelete\n1 2 yum install bzip2 gcc-c++ e2fsprogs* -y wget http://nchc.dl.sourceforge.net/project/extundelete/extundelete/0.2.4/extundelete-0.2.4.tar.bz2 1 2 tar jxvf extundelete-0.2.4.tar.bz2 cd extundelte-0.2.4 1 2 ./configure make \u0026amp;\u0026amp; make install éªŒè¯å®‰è£…ç»“æœ\n1 extundelete -v ï¼ˆ3ï¼‰è¿›è¡Œæ‰«æï¼Œæ¢å¤æ•°æ®\næ¢å¤æŒ‡å®šæ–‡ä»¶ï¼š\n**åŸç†ï¼š**ä»æ ¹èŠ‚ç‚¹(inode=2)å¼€å§‹æ‰¾åˆ°è¢«åˆ é™¤æ–‡ä»¶çš„ièŠ‚ç‚¹ï¼Œç„¶årecover ièŠ‚ç‚¹ã€‚\nåˆ é™¤ç›®å½•ï¼š/www/server\nå…ˆæ£€æµ‹è¢«åˆ é™¤çš„æ–‡ä»¶æœ‰å“ªäº›ï¼š\n1 extundelete /dev/mapper/centos-root --inode 2 1 extundelete /dev/mapper/centos-root --inode 1703938 1 extundelete /dev/mapper/centos-root --inode 1703940 1 extundelete /dev/mapper/centos-root --restore-directory /www/server 1 2 3 4 5 6 7 8 #æŸ¥çœ‹èƒ½æ¢å¤çš„æ•°æ®ï¼š [root@localhost ~]# extundelete /dev/sdc1 --inode 2 #æ¢å¤å•ä¸ªæ–‡ä»¶ [root@localhost ~]# extundelete /dev/sdc1 --restore-file somefile #æ¢å¤ç›®å½• [root@localhost ~]# extundelete /dev/sdc1 --restore-directory /somedir #æ¢å¤æ‰€æœ‰æ–‡ä»¶ [root@localhost ~]# extundelete /dev/sdb1 --restore-all èƒ½æ¢å¤å¤šå°‘ï¼Œå°±é è¿æ°” åè®°ï¼š è¿æ°”è¾ƒå¥½ï¼Œæ¢å¤äº†æ•°æ®\næŠŠç”Ÿæˆç¯å¢ƒæ­å»ºå‡ºæ¥ï¼Œè·‘ä¸Šé¢å®Œå…¨æ²¡æœ‰é—®é¢˜\nåˆ‡è®° ï¼ˆ1ï¼‰è®°å¾—å¤‡ä»½ ï¼ˆ2ï¼‰ä¸è¦ç”¨rm ï¼ˆ3ï¼‰å¹²å•¥è¦ä¸‰æ€ ä¸‹æ¬¡æ›´æ–°ï¼Œâ€œåƒåœ¾rmï¼Œæ¯æˆ‘é’æ˜¥ï¼Œæˆ‘ç›´æ¥æŠŠä½ åˆ æ‰â€ é¢„çŸ¥åäº‹ï¼Œä¸”å¬ä¸‹å›åˆ†è§£ã€å…³æ³¨æˆ‘ï¼ŒæœŸå¾…ä¸‹æ¬¡åˆ†äº«ã€‘ ","date":"2020-04-22T18:42:41Z","image":"https://www.ownit.top/title_pic/60.jpg","permalink":"https://www.ownit.top/p/202004221842/","title":"æ‰‹è¯¯ã€åˆ åº“ã€‘ ==  è·‘è·¯ï¼Œä¸å­˜åœ¨çš„  â€”â€”åˆ ç“¦è¾›æ ¼"},{"content":"æ¦‚è¿° é›†ç¾¤å¯¹æ—¶é—´åŒæ­¥è¦æ±‚é«˜ï¼Œå®é™…ä½¿ç”¨ç¯å¢ƒä¸­å¿…é¡»ç¡®ä¿é›†ç¾¤ä¸­æ‰€æœ‰ç³»ç»Ÿæ—¶é—´ä¿æŒä¸€è‡´\nChronyæ˜¯ä¸€ä¸ªå¼€æºçš„è‡ªç”±è½¯ä»¶ï¼ŒåƒCentOSÂ 7æˆ–åŸºäºRHEL 7æ“ä½œç³»ç»Ÿï¼Œå·²ç»æ˜¯é»˜è®¤æœåŠ¡ï¼Œé»˜è®¤é…ç½®æ–‡ä»¶åœ¨ /etc/chrony.conf å®ƒèƒ½ä¿æŒç³»ç»Ÿæ—¶é—´ä¸æ—¶é—´æœåŠ¡å™¨ï¼ˆNTPï¼‰åŒæ­¥ï¼Œè®©æ—¶é—´å§‹ç»ˆä¿æŒåŒæ­¥ã€‚ç›¸å¯¹äºNTPæ—¶é—´åŒæ­¥è½¯ä»¶ï¼Œå æ®å¾ˆå¤§ä¼˜åŠ¿ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé…ç½®å®Œ/etc/chrony.confåï¼Œéœ€é‡å¯chronyæœåŠ¡ï¼Œå¦åˆ™å¯èƒ½ä¼šä¸ç”Ÿæ•ˆ\nä¸»æœºåç§°IPåœ°å€Master192.168.1.10Node1192.168.1.20Node2192.168.1.30 1ã€å®‰è£…chrony CentOS7ä¸­å·²ç»é»˜è®¤å®‰è£…äº†chronyï¼Œå…¶é…ç½®æ–‡ä»¶è·¯å¾„åœ¨\n1 /etc/chrony.conf å¦‚æœç³»ç»Ÿå†…æ²¡æœ‰chronyï¼Œè¯·æŒ‰ç…§å¦‚ä¸‹è¿›è¡Œå®‰è£…ï¼Œå¯åŠ¨å¹¶æ£€æŸ¥ç›¸å…³çŠ¶æ€\n1 2 3 4 5 yum install chrony -y systemctl enable chronyd.service systemctl restart chronyd.service systemctl status chronyd.service åœ¨é˜²ç«å¢™å†…æ”¾è¡Œï¼Œå› NTPä½¿ç”¨123/UDPç«¯å£åè®®ï¼Œæ‰€ä»¥å…è®¸NTPæœåŠ¡å³å¯ã€‚ï¼ˆå¦‚æœå·²å…³é—­é˜²ç«å¢™è¯·æ— è§†ï¼‰\n1 2 firewall-cmd --add-service=ntp --permanent firewall-cmd --reload 2ã€æ£€æŸ¥è®¾ç½®æ—¶åŒº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 # timedatectl Local time: Fri 2018-2-29 13:31:04 CST Universal time: Fri 2018-2-29 05:31:04 UTC RTC time: Fri 2018-2-29 08:17:20 Time zone: Asia/Shanghai (CST, +0800) NTP enabled: yes NTP synchronized: yes RTC in local TZ: no DST active: n/a #å¦‚æœä½ å½“å‰çš„æ—¶åŒºä¸æ­£ç¡®ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ“ä½œè®¾ç½®ã€‚ #æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„æ—¶åŒºï¼š # timedatectl list-timezones #ç­›é€‰å¼æŸ¥çœ‹åœ¨äºšæ´²Så¼€çš„ä¸Šæµ·å¯ç”¨æ—¶åŒºï¼š # timedatectl list-timezones | grep -E \u0026#34;Asia/S.*\u0026#34; Asia/Sakhalin Asia/Samarkand Asia/Seoul Asia/Shanghai Asia/Singapore Asia/Srednekolymsk #è®¾ç½®å½“å‰ç³»ç»Ÿä¸ºAsia/Shanghaiä¸Šæµ·æ—¶åŒºï¼š # timedatectl set-timezone Asia/Shanghai #è®¾ç½®å®Œæ—¶åŒºåï¼Œå¼ºåˆ¶åŒæ­¥ä¸‹ç³»ç»Ÿæ—¶é’Ÿï¼š # chronyc -a makestep 200 OK 3ã€MasterèŠ‚ç‚¹é…ç½®chrony æ­¤å¤„é€‰ç”¨çš„æ˜¯é˜¿é‡Œäº‘çš„ntpæœåŠ¡serverï¼Œåœ°å€ä¸º\n1 ntp1.aliyun.com å½“å‰æ˜¯Masterï¼Œipåœ°å€ä¸º192.168.1.10ï¼Œç½‘æ®µæ˜¯192.168.1.0/24ï¼Œé…ç½®è¯¦æƒ…å¦‚ä¸‹ï¼Œçº¢è‰²ä¸ºæ›´æ”¹éƒ¨åˆ†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 vim /etc/chrony.conf server ntp1.aliyun.com iburst # Record the rate at which the system clock gains/losses time. driftfile /var/lib/chrony/drift # Allow the system clock to be stepped in the first three updates # if its offset is larger than 1 second. makestep 1.0 3 # Enable kernel synchronization of the real-time clock (RTC). rtcsync # Enable hardware timestamping on all interfaces that support it. #hwtimestamp * # Increase the minimum number of selectable sources required to adjust # the system clock. #minsources 2 # Allow NTP client access from local network. #allow 192.168.0.0/16 allow 192.168.1.0/24 # Serve time even if not synchronized to a time source. local stratum 10 # Specify file containing keys for NTP authentication. #keyfile /etc/chrony.keys # Specify directory for log files. logdir /var/log/chrony # Select which information is logged. #log measurements statistics tracking é‡å¯\n1 2 # systemctl restart chronyd.service # systemctl status chronyd.service 1 2 3 4 5 6 7 8 å¼ºåˆ¶åŒæ­¥ä¸‹ç³»ç»Ÿæ—¶é’Ÿï¼š # chronyc -a makestep æŸ¥çœ‹æ—¶é—´åŒæ­¥æºçŠ¶æ€ï¼š # chronyc sourcestats æŸ¥çœ‹æ—¶é—´åŒæ­¥æºï¼š # chronyc sources -v 4ã€NodeèŠ‚ç‚¹é…ç½®chrony nodeèŠ‚ç‚¹(192.168.26.136)åªéœ€è¦æ³¨é‡Šæ‰åŸæ¥çš„ipï¼Œæ–°å¢Masterä¸»æœºçš„IPåœ°å€å³å¯ï¼ˆè®°å¾—é‡å¯chronyæœåŠ¡ï¼‰\n1 2 # systemctl restart chronyd.service # systemctl status chronyd.service 1 2 3 4 5 6 7 8 å¼ºåˆ¶åŒæ­¥ä¸‹ç³»ç»Ÿæ—¶é’Ÿï¼š # chronyc -a makestep æŸ¥çœ‹æ—¶é—´åŒæ­¥æºçŠ¶æ€ï¼š # chronyc sourcestats æŸ¥çœ‹æ—¶é—´åŒæ­¥æºï¼š # chronyc sources -v Node2ä¹Ÿæ˜¯ä»¥ä¸Šæ­¥éª¤\n5ã€ chrony.confæ–‡ä»¶è¯¦è§£ ä»¥ä¸‹æ˜¯ç³»ç»Ÿé»˜è®¤é…ç½®æ–‡ä»¶çš„è¯´æ˜(CentOS7)ï¼Œäº†è§£ä¸€ä¸‹å„ä¸ªé…ç½®æ˜¯åšä»€ä¹ˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 # ä½¿ç”¨pool.ntp.orgé¡¹ç›®ä¸­çš„å…¬å…±æœåŠ¡å™¨ã€‚ä»¥serverå¼€ï¼Œç†è®ºä¸Šä½ æƒ³æ·»åŠ å¤šå°‘æ—¶é—´æœåŠ¡å™¨éƒ½å¯ä»¥ã€‚ # Please consider joining the pool (http://www.pool.ntp.org/join.html). server 0.centos.pool.ntp.org iburst server 1.centos.pool.ntp.org iburst server 2.centos.pool.ntp.org iburst server 3.centos.pool.ntp.org iburst # æ ¹æ®å®é™…æ—¶é—´è®¡ç®—å‡ºæœåŠ¡å™¨å¢å‡æ—¶é—´çš„æ¯”ç‡ï¼Œç„¶åè®°å½•åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œåœ¨ç³»ç»Ÿé‡å¯åä¸ºç³»ç»Ÿåšå‡ºæœ€ä½³æ—¶é—´è¡¥å¿è°ƒæ•´ã€‚ driftfile /var/lib/chrony/drift # chronydæ ¹æ®éœ€æ±‚å‡æ…¢æˆ–åŠ é€Ÿæ—¶é—´è°ƒæ•´ï¼Œ # åœ¨æŸäº›æƒ…å†µä¸‹ç³»ç»Ÿæ—¶é’Ÿå¯èƒ½æ¼‚ç§»è¿‡å¿«ï¼Œå¯¼è‡´æ—¶é—´è°ƒæ•´ç”¨æ—¶è¿‡é•¿ã€‚ # è¯¥æŒ‡ä»¤å¼ºåˆ¶chronydè°ƒæ•´æ—¶æœŸï¼Œå¤§äºæŸä¸ªé˜€å€¼æ—¶æ­¥è¿›è°ƒæ•´ç³»ç»Ÿæ—¶é’Ÿã€‚ # åªæœ‰åœ¨å› chronydå¯åŠ¨æ—¶é—´è¶…è¿‡æŒ‡å®šçš„é™åˆ¶æ—¶ï¼ˆå¯ä½¿ç”¨è´Ÿå€¼æ¥ç¦ç”¨é™åˆ¶ï¼‰æ²¡æœ‰æ›´å¤šæ—¶é’Ÿæ›´æ–°æ—¶æ‰ç”Ÿæ•ˆã€‚ makestep 1.0 3 # å°†å¯ç”¨ä¸€ä¸ªå†…æ ¸æ¨¡å¼ï¼Œåœ¨è¯¥æ¨¡å¼ä¸­ï¼Œç³»ç»Ÿæ—¶é—´æ¯11åˆ†é’Ÿä¼šæ‹·è´åˆ°å®æ—¶æ—¶é’Ÿï¼ˆRTCï¼‰ã€‚ rtcsync # Enable hardware timestamping on all interfaces that support it. # é€šè¿‡ä½¿ç”¨hwtimestampæŒ‡ä»¤å¯ç”¨ç¡¬ä»¶æ—¶é—´æˆ³ #hwtimestamp eth0 #hwtimestamp eth1 #hwtimestamp * # Increase the minimum number of selectable sources required to adjust # the system clock. #minsources 2 # æŒ‡å®šä¸€å°ä¸»æœºã€å­ç½‘ï¼Œæˆ–è€…ç½‘ç»œä»¥å…è®¸æˆ–æ‹’ç»NTPè¿æ¥åˆ°æ‰®æ¼”æ—¶é’ŸæœåŠ¡å™¨çš„æœºå™¨ #allow 192.168.0.0/16 #deny 192.168/16 # Serve time even if not synchronized to a time source. local stratum 10 # æŒ‡å®šåŒ…å«NTPéªŒè¯å¯†é’¥çš„æ–‡ä»¶ã€‚ #keyfile /etc/chrony.keys # æŒ‡å®šæ—¥å¿—æ–‡ä»¶çš„ç›®å½•ã€‚ logdir /var/log/chrony # Select which information is logged. #log measurements statistics tracking 6ã€chronyçš„ä¼˜åŠ¿ chronyçš„ä¼˜åŠ¿æ›´å¿«çš„åŒæ­¥åªéœ€è¦æ•°åˆ†é’Ÿè€Œéæ•°å°æ—¶æ—¶é—´ï¼Œä»è€Œæœ€å¤§ç¨‹åº¦å‡å°‘äº†æ—¶é—´å’Œé¢‘ç‡è¯¯å·®ï¼Œè¿™å¯¹äºå¹¶éå…¨å¤© 24 å°æ—¶è¿è¡Œçš„å°å¼è®¡ç®—æœºæˆ–ç³»ç»Ÿè€Œè¨€éå¸¸æœ‰ç”¨ã€‚\nèƒ½å¤Ÿæ›´å¥½åœ°å“åº”æ—¶é’Ÿé¢‘ç‡çš„å¿«é€Ÿå˜åŒ–ï¼Œè¿™å¯¹äºå…·å¤‡ä¸ç¨³å®šæ—¶é’Ÿçš„è™šæ‹Ÿæœºæˆ–å¯¼è‡´æ—¶é’Ÿé¢‘ç‡å‘ç”Ÿå˜åŒ–çš„èŠ‚èƒ½æŠ€æœ¯è€Œè¨€éå¸¸æœ‰ç”¨ã€‚\nåœ¨åˆå§‹åŒæ­¥åï¼Œå®ƒä¸ä¼šåœæ­¢æ—¶é’Ÿï¼Œä»¥é˜²å¯¹éœ€è¦ç³»ç»Ÿæ—¶é—´ä¿æŒå•è°ƒçš„åº”ç”¨ç¨‹åºé€ æˆå½±å“ã€‚\nåœ¨åº”å¯¹ä¸´æ—¶éå¯¹ç§°å»¶è¿Ÿæ—¶ï¼ˆä¾‹å¦‚ï¼Œåœ¨å¤§è§„æ¨¡ä¸‹è½½é€ æˆé“¾æ¥é¥±å’Œæ—¶ï¼‰æä¾›äº†æ›´å¥½çš„ç¨³å®šæ€§ã€‚\næ— éœ€å¯¹æœåŠ¡å™¨è¿›è¡Œå®šæœŸè½®è¯¢ï¼Œå› æ­¤å…·å¤‡é—´æ­‡æ€§ç½‘ç»œè¿æ¥çš„ç³»ç»Ÿä»ç„¶å¯ä»¥å¿«é€ŸåŒæ­¥æ—¶é’Ÿã€‚\n","date":"2020-04-20T11:50:43Z","image":"https://www.ownit.top/title_pic/54.jpg","permalink":"https://www.ownit.top/p/202004201150/","title":"Centos7é›†ç¾¤æ—¶é—´åŒæ­¥ï¼ˆChronyï¼‰"},{"content":" è¿‘æœŸå†™ä¸€ä¸ªPythonç³»ç»Ÿç¡¬ä»¶ç›‘æ§ï¼Œå‡†å¤‡å‘å¸ƒåˆ°Linuxä¸Šã€‚\nä¸‹é¢ä¸€èµ·çœ‹çœ‹æ€ä¹ˆæŠŠé¡¹ç›®å‘å¸ƒåˆ°Linuxä¸Šå§ã€‚\nç¯å¢ƒè¦æ±‚ Pythonç‰ˆæœ¬ï¼š3.7\nWindowsè¿è¡Œé¡¹ç›® Centos7è¿è¡Œé¡¹ç›® å› ä¸ºcentos7çš„pythonç¯å¢ƒæ˜¯2.75çš„ã€‚\næ‰€ä»¥æˆ‘ä»¬é¦–å…ˆæŠŠPythonç¯å¢ƒæ¢æˆ3.7çš„æ‰è¡Œã€‚\nCentos7å‡çº§Python3.7.3ç‰ˆæœ¬\nä¸Šé¢æ˜¯æ•™ç¨‹ã€‚\nï¼ˆ1ï¼‰æ‰“åŒ…Pythoné¡¹ç›®çš„ä¾èµ–ï¼ˆä¹Ÿå°±æ˜¯æœ¬åœ°å®‰è£…çš„é¡¹ç›®ä¾èµ–ï¼‰ 1 pip3 freeze \u0026gt; requirements.txt ï¼ˆ2ï¼‰å‹ç¼©Pythoné¡¹ç›®å’Œä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œè§£å‹ zipåŒ…çš„è§£å‹å‘½ä»¤ï¼šunzip åŒ…å\nï¼ˆ3ï¼‰cdåˆ°é¡¹ç›®é‡Œï¼Œå®‰è£…ä¾èµ– 1 pip3 install -i http://pypi.douban.com/simple/ --trusted-host pypi.douban.com -r requirements.txt ï¼ˆ4ï¼‰è¿è¡Œé¡¹ç›®å¯åŠ¨æ–‡ä»¶ 1 python3 manage.py é¡¹ç›®å·²ç»è¿è¡ŒæˆåŠŸï¼Œè¿˜æœ‰æœ€ç®€ä¾¿çš„æ–¹æ³•å°±æ˜¯è¿è¡Œåœ¨dockerå®¹å™¨é‡Œï¼Œæ›´åŠ æ–¹ä¾¿ï¼Œåç»­ä¼šæ›´æ–°\n","date":"2020-04-18T17:04:28Z","image":"https://www.ownit.top/title_pic/23.jpg","permalink":"https://www.ownit.top/p/202004181704/","title":"Pythoné¡¹ç›®æ‰“åŒ…å‘å¸ƒLinuxçº¿ä¸Š"},{"content":"è´­ç‰©è½¦ç»ƒä¹ ç¨‹åº ï¼ˆ1ï¼‰å¯ä»¥æ˜¾ç¤ºå•†å“åˆ—è¡¨\nï¼ˆ2ï¼‰æ ¹æ®å•†å“idè¿›è¡Œè´­ä¹°\nï¼ˆ3ï¼‰æ ¹æ®è¾“å…¥çš„å·¥ä½œæ¥åˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿçš„é’±è´­ä¹°\nï¼ˆ4ï¼‰é€€å‡ºæ—¶ï¼Œæ˜¾ç¤ºè´­ä¹°çš„å•†å“å’Œå¡ä¸­çš„ä½™é¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 # è´­ç‰©è½¦ç»ƒä¹ ç¨‹åº product_list = [ (\u0026#39;iphone\u0026#39;, 5000), (\u0026#39;Mac\u0026#39;, 9000), (\u0026#39;Bike\u0026#39;, 800), (\u0026#39;watch\u0026#39;, 600), (\u0026#39;book\u0026#39;, 600), ] shopping_list = [] def shop(): salay = input(\u0026#34;è¯·è¾“å…¥ä½ çš„å·¥èµ„:\u0026#34;) if salay.isdigit(): salay = int(salay) while True: for index, itme in enumerate(product_list): #print(product_list.index(itme),itme) print(index,itme) user_choice = input(\u0026#34;é€‰æ‹©è¦ä¹°çš„å•†å“ï¼Ÿè¯·é€‰æ‹©è´­ä¹°çš„ç¼–å·ï¼\u0026#34;) if user_choice.isdigit(): user_choice = int(user_choice) if user_choice \u0026lt; len(product_list) and user_choice \u0026gt;-1: p_itme = product_list[user_choice] if p_itme[1] \u0026lt;= salay:#ä¹°çš„èµ· shopping_list.append(p_itme) salay-=p_itme[1] print(\u0026#34;Added %s into shopping cart ,you current balance is \\033[31;1m%s\\033[0m\u0026#34; %(p_itme,salay)) else: print(\u0026#34;\\033[41;1mä½ çš„ä½™é¢ä¸è¶³ï¼Œåªå‰©[%s]\\033[0m\u0026#34; % salay) else: print(\u0026#34;è¯·è¾“å…¥æ­£ç¡®å•†å“ç¼–å·\u0026#34;) elif user_choice == \u0026#39;q\u0026#39;: print(\u0026#39;----------------------shopping list----------------------------\u0026#39;) for p in shopping_list: print(p) print(\u0026#34;\\033[41;1mä½ çš„ä½™é¢[%s]\\033[0m\u0026#34; % salay) exit() else: print(\u0026#34;è¯·è¾“å…¥æ­£ç¡®çš„ç¼–å·\u0026#34;) else: print(\u0026#34;ä½ è¾“å…¥çš„å·¥èµ„æ ¼å¼ä¸å¯¹ï¼Œè¯·è¾“å…¥æ­£ç¡®çš„æ ¼å¼\u0026#34;) shop() shop() å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ æ¬¢è¿ä½¿ç”¨[å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ] V1.0 1.æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿä¿¡æ¯ 2.æ–°å»ºå­¦ç”Ÿä¿¡æ¯ 3.æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯ 4.ä¿®æ”¹å­¦ç”Ÿä¿¡æ¯ 5.åˆ é™¤å­¦ç”Ÿä¿¡æ¯ 0.é€€å‡ºç³»ç»Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 \u0026#34;\u0026#34;\u0026#34; æ¬¢è¿ä½¿ç”¨[å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ] V1.0 1.æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿä¿¡æ¯ 2.æ–°å»ºå­¦ç”Ÿä¿¡æ¯ 3.æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯ 4.ä¿®æ”¹å­¦ç”Ÿä¿¡æ¯ 5.åˆ é™¤å­¦ç”Ÿä¿¡æ¯ 0.é€€å‡ºç³»ç»Ÿ \u0026#34;\u0026#34;\u0026#34; # æ¨¡æ‹Ÿå­¦ç”Ÿæ•°æ® from datetime import datetime student_data = [ { \u0026#39;name\u0026#39;: \u0026#39;å—å®«ä¹˜é£\u0026#39;, \u0026#39;sex\u0026#39;: \u0026#39;ç”·\u0026#39;, \u0026#39;address\u0026#39;: \u0026#39;è¥¿å®‰\u0026#39;, \u0026#39;birthday\u0026#39;: \u0026#39;20000229\u0026#39; }, { \u0026#39;name\u0026#39;: \u0026#39;ä¹˜é£\u0026#39;, \u0026#39;sex\u0026#39;: \u0026#39;ç”·\u0026#39;, \u0026#39;address\u0026#39;: \u0026#39;æ´‹å¿\u0026#39;, \u0026#39;birthday\u0026#39;: \u0026#39;20101229\u0026#39; } ] # å­¦ç”Ÿç±» class Student: # å­¦ç”Ÿåˆå§‹åŒ– def __init__(self, name, sex, address, birthday): self.name = name self.sex = sex self.address = address self.birthday = birthday # è·å–å­¦ç”Ÿå¹´é¾„ def get_age(self): if self.birthday: age = datetime.now().year - int(self.birthday[:4]) return age else: print(\u0026#34;ä¸çŸ¥é“\u0026#34;) # å­¦ç”Ÿç®¡ç†ç³»ç»Ÿç±» class System: # åˆå§‹åŒ– def __init__(self, name): self.name = name self.data = [] # ç¾åŒ–è¾“å‡ºæ‰“å° def beauty_print(self, data_list): for index, student in enumerate(data_list): print(f\u0026#34;åºå·ï¼š{index}\u0026#34;, end=\u0026#39;\\t\u0026#39;) print(f\u0026#34;å§“åï¼š{student.name}\u0026#34;, end=\u0026#39;\\t\u0026#39;) print(f\u0026#34;æ€§åˆ«ï¼š{student.sex:2}\u0026#34;, end=\u0026#39;\\t\u0026#39;) print(f\u0026#34;åœ°å€ï¼š{student.address}\u0026#34;, end=\u0026#39;\\t\u0026#39;) print(f\u0026#34;å¹´é¾„ï¼š{student.get_age()}\u0026#34;) # åŠ è½½æ•°æ® def load_data(self): for item in student_data: student = Student(item[\u0026#39;name\u0026#39;], item[\u0026#39;sex\u0026#39;], item[\u0026#39;address\u0026#39;], item[\u0026#39;birthday\u0026#39;]) self.data.append(student) # æ˜¾ç¤ºèœå• def show_menu(self): # f-string print(f\u0026#34;\u0026#34;\u0026#34; ****************************** æ¬¢è¿ä½¿ç”¨[{self.name}] V2.0 1.æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿä¿¡æ¯ 2.æ–°å»ºå­¦ç”Ÿä¿¡æ¯ 3.æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯ 4.ä¿®æ”¹å­¦ç”Ÿä¿¡æ¯ 5.åˆ é™¤å­¦ç”Ÿä¿¡æ¯ 0.é€€å‡ºç³»ç»Ÿ ****************************** \u0026#34;\u0026#34;\u0026#34;) # å¯åŠ¨å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ def start(self): # åŠ è½½æ•°æ® self.load_data() while True: self.show_menu() op = input(\u0026#34;é€‰æ‹©æ“ä½œ\u0026#34;) if op == \u0026#39;1\u0026#39;: self.show_all_student() elif op == \u0026#39;2\u0026#39;: self.create_student() elif op == \u0026#39;3\u0026#39;: self.find_student() elif op == \u0026#39;4\u0026#39;: self.modify_student() elif op == \u0026#39;5\u0026#39;: self.remove_student() elif op == \u0026#39;6\u0026#39;: print(\u0026#39;é€€å‡ºç¨‹åº\u0026#39;) break else: print(\u0026#34;è¯·è¾“å…¥æ­£å¸¸çš„æ“ä½œ\u0026#34;) # é€‰æ‹©æ€§åˆ« def choose_sex(self): sex = input(\u0026#34;è¯·é€‰æ‹©æ€§åˆ«ï¼šï¼ˆ1ï¼‰:ç”·|(2):å¥³\u0026#34;).strip() if sex == \u0026#39;1\u0026#39;: return \u0026#39;ç”·\u0026#39; elif sex == \u0026#39;2\u0026#39;: return \u0026#39;å¥³\u0026#39; else: return \u0026#39;æœªçŸ¥\u0026#39; # åˆ¤æ–­åå­— def input_name(self): while True: name = input(\u0026#34;è¯·è¾“å…¥åå­—ï¼š\u0026#34;).strip() if name: return name else: continue # æ ¹æ®åå­—æŸ¥è¯¢ def find_student_name(self): name = self.input_name() find_list = [] for student in self.data: if name.lower() in student.name.lower(): find_list.append(student) if find_list: return find_list else: print(f\u0026#34;æ²¡æœ‰æ‰¾åˆ°å­¦ç”Ÿï¼š{name}\u0026#34;) # 1.æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿä¿¡æ¯ def show_all_student(self): self.beauty_print(self.data) # 2.æ–°å»ºå­¦ç”Ÿä¿¡æ¯ def create_student(self): name = self.input_name() sex = self.choose_sex() address = input(\u0026#34;è¯·è¾“å…¥åœ°å€\u0026#34;) birthday = input(\u0026#34;è¯·è¾“å…¥ç”Ÿæ—¥\u0026#34;) student = Student(name, sex, address, birthday) self.data.append(student) # 3.æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯ def find_student(self): # name = self.input_name() # for student in self.data: # if name.lower() in student.name.lower(): # self.beauty_print([student]) find_list = self.find_student_name() self.beauty_print(find_list) # 4.ä¿®æ”¹å­¦ç”Ÿä¿¡æ¯ def modify_student(self): find_list = self.find_student_name() if find_list: self.beauty_print(find_list) index = int(input(\u0026#34;é€‰æ‹©åºå·:\u0026#34;)) student = find_list[index] print(\u0026#39;å½“å‰ä¿®æ”¹çš„æ˜¯ï¼š\u0026#39;) self.beauty_print([student]) student.name = input(\u0026#39;è¾“å…¥æ–°çš„åå­—ï¼š\u0026#39;).strip() student.sex = self.choose_sex() student.address = input(\u0026#34;è¯·è¾“å…¥åœ°å€ï¼š\u0026#34;) student.birthday = input(\u0026#34;è¯·è¾“å…¥ç”Ÿæ—¥ï¼š\u0026#34;) print(f\u0026#39;{student.name}å·²ç»ä¿®æ”¹\u0026#39;) return # 5.åˆ é™¤å­¦ç”Ÿä¿¡æ¯ def remove_student(self): find_list = self.find_student_name() if find_list: self.beauty_print(find_list) index = int(input(\u0026#34;é€‰æ‹©åºå·:\u0026#34;)) student = find_list[index] print(\u0026#39;å½“å‰åˆ é™¤çš„æ˜¯ï¼š\u0026#39;) self.beauty_print([student]) self.data.remove(student) return else: print(f\u0026#39;æ²¡æœ‰çš„äºº\u0026#39;) # 0.é€€å‡ºç³»ç»Ÿ if __name__ == \u0026#39;__main__\u0026#39;: student_sys = System(\u0026#39;ä¹˜é£ç³»ç»Ÿ\u0026#39;) student_sys.start() ","date":"2020-04-14T15:53:27Z","image":"https://www.ownit.top/title_pic/36.jpg","permalink":"https://www.ownit.top/p/202004141553/","title":"Pythonè´­ç‰©è½¦å’Œå­¦ç”Ÿç®¡ç†ç³»ç»Ÿ"},{"content":"ç›®å½•\nå‰è¨€ï¼š\næ­£æ–‡ï¼š\n1.ä¸‹è½½Python3.7.3çš„é•œåƒ\n2ã€è§£å‹ tar -xzvf Python-3.7.3.tgz\n3ã€cd Python-3.7.3\n4ã€å®‰è£…åˆ°/usr/localç›®å½•ä¸­\n5ã€make \u0026amp;\u0026amp; makeÂ altinstall\n6ã€éªŒè¯\n7ã€cd /usr/bin\n8ã€å¤‡ä»½ä¹‹å‰çš„pythonÂ 9ã€åˆ›å»ºè½¯è¿æ¥Â é—®é¢˜\n1ã€æ›´æ”¹yumè„šæœ¬çš„pythonä¾èµ–â€‹\n2ã€ä¿®æ”¹urlgrabberé…ç½®æ–‡ä»¶\nå¤‡æ³¨ï¼š\nå‰è¨€ï¼š æˆ‘ä»¬ä½¿ç”¨çš„centos7é•œåƒï¼Œé‡Œé¢éƒ½å†…ç½®çš„Pythonï¼Œä½†éƒ½æ˜¯python2çš„ç‰ˆæœ¬ï¼Œæ¯”è¾ƒè½åã€‚\nç°åœ¨æœ‰çš„æœ‰Python3å·²ç»å‡ºæ¥ï¼Œæœ‰çš„ç¨‹åºè¿è¡Œéœ€è¦Python3çš„ç¯å¢ƒæ”¯æŒã€‚\nå®‰è£…ä¸‹é¢æ“ä½œï¼Œèƒ½å¤Ÿæ­£ç¡®å®‰è£…å’Œæ›¿æ¢Python2ï¼Œå¦‚æœæ“ä½œæœ‰é—®é¢˜è¯·ä¸‹æ–¹ç•™è¨€\næ­£æ–‡ï¼š 1.ä¸‹è½½Python3.7.3çš„é•œåƒ 1 wget https://www.python.org/ftp/python/3.7.3/Python-3.7.3.tgz 2ã€è§£å‹ tar -xzvf Python-3.7.3.tgz 1 tar -xzvf Python-3.7.3.tgz 3ã€cd Python-3.7.3 1 cd Python-3.7.3 4ã€å®‰è£…åˆ°/usr/localç›®å½•ä¸­ 1 ./configure --prefix=/usr/local/python3 æ‰§è¡Œè¿™æ­¥åï¼Œä¼šæ£€æµ‹ç¨‹åºã€‚ç­‰æ£€æµ‹å®Œæ¯•ï¼Œæ˜¯å¦æœ‰æŠ¥é”™æˆ–è€…ä¾èµ–æ²¡å®‰è£…ã€‚\n5ã€make \u0026amp;\u0026amp; makeÂ altinstall 1 make \u0026amp;\u0026amp; make altinstall æ‰§è¡Œè¿™æ­¥åï¼Œä¼šè¿›è¡Œç¼–è¯‘ï¼Œç„¶åå®‰è£…ç¨‹åºåˆ°æŒ‡å®šçš„ç›®å½•\n6ã€éªŒè¯ ç›´æ¥å…ˆè¿è¡Œpython3ï¼Œå†ç¡®è®¤ä¸€ä¸‹ç‰ˆæœ¬ä¿¡æ¯ï¼š\n7ã€cd /usr/bin 8ã€å¤‡ä»½ä¹‹å‰çš„pythonÂ 1 mv python python.bak 9ã€åˆ›å»ºè½¯è¿æ¥Â 1 ln -s /usr/local/python3/bin/python3.7 /usr/bin/python é—®é¢˜ 1ã€æ›´æ”¹yumè„šæœ¬çš„pythonä¾èµ– 1 vi /usr/bin/yum #!/usr/bin/pythonÂ æ”¹ä¸ºÂ #!/usr/bin/python2\n2ã€ä¿®æ”¹urlgrabberé…ç½®æ–‡ä»¶ 1 vi /usr/libexec/urlgrabber-ext-down #!/usr/bin/pythonÂ æ”¹ä¸ºÂ #!/usr/bin/python2\nå¤‡æ³¨ï¼š 1ã€3.6çš„ä¾èµ– æ²¡æœ‰æ‰§è¡Œ æŠ¥é”™äº† åç»­æœ‰éœ€è¦å†é€æ­¥åŠ ä¸Šè¿™äº›ä¾èµ–å§\n1 yum install openssl-devel bzip2-devel expat-devel gdbm-devel readline-devel sqlite-devel 2ã€3.7çš„ä¾èµ–åŒ…ï¼ˆä¸€å®šè¦åœ¨å®‰è£…å‰å…ˆinstall å¦åˆ™å®‰è£…ä¼šæŠ¥é”™ï¼‰\n1 yum install openssl-devel bzip2-devel expat-devel gdbm-devel readline-devel sqlite-devel libffi-devel æµ‹è¯•ï¼šè¾“å…¥python æŸ¥çœ‹æœ€æ–°çš„ç‰ˆæœ¬\nå·²ç»å®Œæˆï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨python3äº†\n","date":"2020-04-10T10:47:58Z","image":"https://www.ownit.top/title_pic/22.jpg","permalink":"https://www.ownit.top/p/202004101047/","title":"Centos7å‡çº§Python3.7.3ç‰ˆæœ¬"},{"content":"docker-composeå®‰è£…é…ç½® äºŒè¿›åˆ¶å®‰è£…\n1ã€ä¸‹è½½æœ€æ–°ç‰ˆçš„ docker-compose äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶ã€‚\n1 sudo curl -L https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose 2ã€é…ç½®å¯æ‰§è¡Œæƒé™ã€‚\n1 sudo chmod +x /usr/local/bin/docker-compose 3ã€æµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸã€‚\n1 docker-compose --version ä½¿ç”¨docker-composeå¯åŠ¨ymlï¼Œä¸€é”®é…ç½®å’Œå¯åŠ¨å®¹å™¨\nå¯¹äºå®¹å™¨å¼€æœºå¯åŠ¨ï¼Œæœ¬åœ°æ•°æ®æŒç»­åŒ–ï¼Œä¿ç•™æ•°æ®\nå®‰è£…docker-compose\nè¿è¡Œï¼š\n1 docker-compose up -d ä½†æ˜¯è¿™æ ·è¿è¡Œçš„è¯ï¼Œå¯èƒ½jenkinsä¼šè¿è¡Œï¼Œä½†æ˜¯ä¼šæŠ¥é”™ï¼Œå› ä¸ºjenkins_homeçš„æƒé™ä¸å¤Ÿï¼Œå¯¼è‡´æ— æ³•å†™å…¥æ•°æ®ã€‚\nç¼–å†™ä¸€ä¸ªshellè„šæœ¬ï¼Œå’Œè¿™ä¸ªdocker-compose.ymlæ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹\nç›´æ¥è¿è¡Œè¿™ä¸ªè„šæœ¬ï¼Œå°±å¯ä»¥å®ç°gitlabå’Œjenkinsçš„å®Œç¾è¿è¡Œã€‚\nä¸¤ä¸ª å¼€å§‹æ¶ˆè€—çš„å†…å­˜å’Œcpuè¿‡å¤§ï¼Œéœ€è¦ç­‰å¾…ä¸€ä¼šå°±å¯ä»¥äº†ã€‚\ngit.sh\n1 2 3 4 #!/bin/bash mkdir -p /usr/local/docker/jenkins/jenkins_home chown -R 1000:1000 /usr/local/docker/jenkins/jenkins_home docker-compose up -d docker-compose.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 version: \u0026#39;3\u0026#39; services: gitlab: image: twang2218/gitlab-ce-zh:9.4 restart: always hostname: 192.168.1.100 environment: TZ: \u0026#39;Asia/Shanghai\u0026#39; GITLAB_OMNIBUS_CONFIG: | external_url \u0026#39;http://192.168.1.100:8080\u0026#39; gitlab_rails[\u0026#39;gitlab_shell_ssh_port\u0026#39;] = 2222 unicorn[\u0026#39;port\u0026#39;] = 8888 nginx[\u0026#39;listen_port\u0026#39;] = 8080 ports: - \u0026#39;8080:8080\u0026#39; - \u0026#39;8443:443\u0026#39; - \u0026#39;2222:22\u0026#39; volumes: - /usr/local/docker/gitlab/config:/etc/gitlab - /usr/local/docker/gitlab/repo:/var/opt/gitlab - /usr/local/docker/gitlab/logs:/var/log/gitlab jenkins: restart: always image: jenkins/jenkins container_name: docker_jenkins ports: - \u0026#39;8081:8080\u0026#39; - \u0026#39;50000:50000\u0026#39; volumes: - /usr/local/docker/jenkins/jenkins_home:/var/jenkins_home environment: JAVA_OPTS: \u0026#39;-Djava.util.logging.config.file=/var/jenkins_home/log.properties\u0026#39; ","date":"2020-03-31T15:34:57Z","image":"https://www.ownit.top/title_pic/60.jpg","permalink":"https://www.ownit.top/p/202003311534/","title":"Dockerä¸€é”®éƒ¨ç½²GitLab+Jenkinsã€æœ¬åœ°æŒä¹…åŒ–ã€‘"},{"content":"è‡ªåŠ¨å¢åŠ å…¬é’¥ éœ€æ±‚ï¼š\næç¤ºè¦è¾“å…¥å¯¹æ–¹çš„ipå’Œrootå¯†ç ï¼Œç„¶åå¯ä»¥è‡ªåŠ¨æŠŠæœ¬æœºçš„å…¬é’¥å¢åŠ åˆ°å¯¹æ–¹æœºå™¨ä¸Šï¼Œä»è€Œå®ç°å¯†é’¥è®¤è¯ã€‚\n1.åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œå…ˆå®‰è£…epelæºï¼Œyum install expect -y\n2.å†™åˆ†å‘è„šæœ¬ï¼Œåç¼€ä¸ºexp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #!/usr/bin/expect#!/bin/bash #name:å—å®«ä¹˜é£ #emailï¼šheian99@163.com #è‡ªåŠ¨æ·»åŠ å…¬é’¥åˆ°æŒ‡å®šçš„æœåŠ¡å™¨ set host_ip [lindex $argv 0] spawn ssh-copy-id -i /root/.ssh/id_rsa.pub $host_ip expect { -timeout 60 \u0026#34;(yes/no)?\u0026#34; { send \u0026#34;yes\\n\u0026#34;;exp_continue} \u0026#34;password:\u0026#34; { send \u0026#34;root\\n\u0026#34;} #å¡«å†™æœåŠ¡å™¨çš„åŒä¸€å¯†ç  timeout {puts \u0026#34;Connect timeout!\u0026#34;;return} } expect eof exit -onexit { send_user \u0026#34;Job has finished!\u0026#34; } æ³¨ï¼šsetçš„ä½œç”¨æ˜¯è®¾ç½®å˜é‡ï¼Œspawnè®¾ç½®æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œå¯ä»¥å¼•ç”¨å˜é‡ï¼›å˜é‡çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸º0\nç¼–å†™ip.txt,å­˜æ”¾ipåœ°å€\n3.æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¼€å§‹åˆ†å‘\n1 for ip in `cat /root/ip.txt`;do expect /root/ssh.exp $ip ;done å¦‚æœå¯†ç ä¸ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥å®šä¹‰åˆ°ip.txtçš„æ–‡æœ¬é‡Œé¢ï¼Œé€šè¿‡awkè·å–åˆ°ã€‚\nç„¶åä¼ å€¼ç»™expectã€‚å¯ä»¥å®ç°ä¸åŒipå’Œå¯†ç çš„è‡ªåŠ¨æ‰¹é‡ç§˜é’¥ä¼ è¾“ã€‚\n","date":"2020-03-30T13:41:03Z","image":"https://www.ownit.top/title_pic/24.jpg","permalink":"https://www.ownit.top/p/202003301341/","title":"Linuxè‡ªåŠ¨æ‰¹é‡å¢åŠ å…¬é’¥"},{"content":"å•ä¸ªæœåŠ¡å™¨ç›‘æ§ ç›‘æ§è¿œç¨‹çš„ä¸€å°æœºå™¨(å‡è®¾ipä¸º192.168.1.100)çš„å­˜æ´»çŠ¶æ€ï¼Œå½“å‘ç°å®•æœºæ—¶å‘ä¸€å°é‚®ä»¶ç»™ä½ è‡ªå·±\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #!/bin/bash #name:å—å®«ä¹˜é£ #emailï¼šheian99@163.com ip=\u0026#34;192.168.1.100\u0026#34; while true ; do # åˆ©ç”¨pingæ£€æŸ¥ä¸»æœºæ˜¯å¦å­˜æ´» ping -c 4 $ip \u0026gt; /dev/null 2\u0026gt; /dev/null if [ $? != \u0026#34;0\u0026#34; ]; then # å¤±è´¥æç¤ºï¼Œå¯ä»¥é€šè¿‡é‚®ä»¶å‘é€ä¿¡æ¯ï¼ˆmailxï¼‰ echo \u0026#34;$ipå·²ç»æŒ‚æ‰\u0026#34; #echo \u0026#34;æœåŠ¡å™¨$ipåæ‰ï¼Œè¯·åŠæ—¶å¤„ç†\u0026#34; | mail -s \u0026#34;$ipæœåŠ¡å™¨æŒ‚æ‰\u0026#34; 1794748404@qq.com else echo \u0026#34;$ipæ­£å¸¸\u0026#34; fi sleep 3s done æ‰¹é‡æœåŠ¡å™¨ç›‘æ§ ç›‘æ§å¤šå°æœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨æ–‡æœ¬è®°å½•ipæˆ–è€…ä½¿ç”¨æ•°ç»„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 #!/bin/bash #name:å—å®«ä¹˜é£ #emailï¼šheian99@163.com #æ­¤å¤„ä¹Ÿå¯ä»¥ä½¿ç”¨æ–‡æœ¬ï¼Œå†™å…¥ipåœ°å€ #ip=$(cat /data/ip.txt) ip=\u0026#34;192.168.1.100 192.168.1.111 192.168.1.99\u0026#34; while true ; do for i in $ip; do # åˆ©ç”¨pingæ£€æŸ¥ä¸»æœºæ˜¯å¦å­˜æ´» echo \u0026#34;$i\u0026#34; ping -c 4 $i \u0026gt; /dev/null 2\u0026gt; /dev/null if [ $? != \u0026#34;0\u0026#34; ]; then # å¤±è´¥æç¤ºï¼Œå¯ä»¥é€šè¿‡é‚®ä»¶å‘é€ä¿¡æ¯ï¼ˆmailxï¼‰ echo \u0026#34;$iå·²ç»æŒ‚æ‰\u0026#34; #echo \u0026#34;æœåŠ¡å™¨$iåæ‰ï¼Œè¯·åŠæ—¶å¤„ç†\u0026#34; | mail -s \u0026#34;$iæœåŠ¡å™¨æŒ‚æ‰\u0026#34; 1794748404@qq.com else echo \u0026#34;$iæ­£å¸¸\u0026#34; fi sleep 3s done done ","date":"2020-03-28T17:59:29Z","image":"https://www.ownit.top/title_pic/77.jpg","permalink":"https://www.ownit.top/p/202003281759/","title":"ä¸»æœºå­˜æ´»ç›‘æ§"},{"content":"Linuxå¸¸è§é—®é¢˜åŠå‘½ä»¤æ€»ç»“ 1.æŸ¥è¯¢Linuxç³»ç»Ÿç›¸å…³çš„ æŸ¥çœ‹linuxå†…æ ¸ç‰ˆæœ¬ 1 cat /etc/version æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬å· 1 uname -r æŸ¥çœ‹å†…æ ¸/æ“ä½œç³»ç»Ÿçš„ä¿¡æ¯ 1 uname -a æŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬å· 1 lsb_release -a æ‰‹åŠ¨é‡Šæ”¾cacheç¼“å­˜ 1 echo 3 \u0026gt; /proc/sys/vm/drop_caches 2.æ“ä½œæ–‡ä»¶ç›¸å…³çš„ æŸ¥æ‰¾ç›®å½•ä¸‹æ–‡ä»¶å†…å­—ç¬¦ä¸² 1 grep -rn \u0026#34;welcome\u0026#34; *;//æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹\u0026#34;welcome\u0026#34;å­—ç¬¦ä¸², *è¡¨ç¤ºå½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶,ä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶å æŸ¥æ‰¾æŒ‡å®šæ–‡ä»¶å†…å­—ç¬¦ä¸² 1 grep -rn /usr/local/ -e \u0026#34;20003\u0026#34;;//æŸ¥æ‰¾åœ¨/usr/localç›®å½•ä¸‹æ–‡ä»¶ä¸­åŒ…å«20003å…³é”®å­—çš„æ–‡ä»¶ æœç´¢æ‰€æœ‰ä»¥indexå¼€å¤´çš„æ–‡ä»¶ 1 find /home/tom -name \u0026#39;index*\u0026#39; # æœç´¢æ‰€æœ‰ä»¥indexå¼€å¤´çš„æ–‡ä»¶ åœ¨/homeç›®å½•ä¸‹æœç´¢æ‰€æœ‰å¤§å°è¶…è¿‡10000Kçš„æ–‡ä»¶ 1 find /home -size +10000k # åœ¨/homeç›®å½•ä¸‹æœç´¢æ‰€æœ‰å¤§å°è¶…è¿‡10000Kçš„æ–‡ä»¶ åœ¨/home/software ä¸‹æŸ¥æ‰¾åå­— 1 find /home/software/ -type f -name \u0026#34;splunk.tgz\u0026#34;; //åœ¨/home/software ä¸‹æŸ¥æ‰¾åå­—ä¸º\u0026#34;splunk.tgz\u0026#34;çš„æ–‡ä»¶ è§£å‹redis.tar.gzçš„æ–‡ä»¶ 1 tar -zxvf redis.tar.gz;//è§£å‹redis.tar.gzçš„æ–‡ä»¶ è§£å‹åˆ°æŒ‡å®šç›®å½•ï¼ˆ-Cï¼‰ 1 tar -zxvf jdk-8u72-linux-x64.tar.gz -C /usr/local;//å°†jdk-8u72-linux-x64.tar.gz è§£å‹åˆ°/usr/localç›®å½•ä¸­ è§£å‹åˆ°æŒ‡å®šç›®å½•ï¼ˆ-dï¼‰ 1 unzip gradle-3.3-bin.zip -d /usr/local/; å°†gradle-3.3-bin.zipè§£å‹åˆ°/usr/localç›®å½• zipå‹ç¼©æ–‡ä»¶ 1 zip -r test.zip test;å°†testæ–‡ä»¶å¤¹æ‰“åŒ…æˆtest.zip æŸ¥çœ‹å°¾éƒ¨å†…å®¹ 1 tail -f access.log;//æŸ¥çœ‹æ–‡ä»¶å°¾éƒ¨å†…å®¹ è¿›ç¨‹åå°è¿è¡Œ 1 nohup java -jar jenkins.war \u0026amp;;//è¿›ç¨‹åå°ç¨‹åº å°†æ–‡ä»¶æƒé™åˆ†é…ç”¨æˆ· 1 chown -R cdn:cdn common/;//å°†commonæ–‡ä»¶å¤¹æƒé™åˆ†ç»™cdn æŸ¥è¯¢2017å¹´6æœˆ22æ—¥æ—¥å¿— 1 sed -n \u0026#39;/22\\/Jun\\/2017/\u0026#39;p access.log\u0026gt;\u0026gt;20170622.log;//æŸ¥è¯¢2017å¹´6æœˆ22æ—¥æ—¥å¿— æˆªå–æŸæ®µæ—¶é—´çš„æ—¥å¿— 1 sed -n \u0026#39;/2017-06-15 00:00:00/,/2017-06-15 24:00:00/p\u0026#39; catalina.out \u0026gt;\u0026gt; 20170615.log;//æˆªå–æŸä¸ªæ—¶é—´æ®µçš„æ—¥å¿— 1 sed -n \u0026#39;/2017-07-05 09:[0-9][0-9]:[0-9][0-9]/,/2017-07-05 16:[0-9][0-9]:[0-9][0-9]/p\u0026#39; catalina.out åˆ›å»ºæ–‡ä»¶è½¯é“¾æ¥ 1 ln -s /usr/mengqc/mub1 /usr/liu/abc; å°†/usr/mengqc/mub1ä»£è¡¨çš„è·¯å¾„å°†å­˜æ”¾åœ¨åä¸º/usr/liu/abcçš„æ–‡ä»¶ä¸­ã€‚ åˆ é™¤è½¯é“¾æ¥ 1 rm -rf /usr/softlink ;åˆ é™¤è½¯é“¾æ¥ æ³¨æ„åé¢ä¸ç”¨åŠ ï¼ åˆ›å»ºç›®å½•å¼•å‘æŸä¸ªæ–‡ä»¶ 1 ln â€“s /var/www/test /var/test ; åˆ›å»º/var/test å¼•å‘/var/www/test æ–‡ä»¶å¤¹ 3.æŸ¥è¯¢è¿›ç¨‹ç›¸å…³çš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 netstat -lp|grep memcached; //æŸ¥çœ‹å¯åŠ¨çš„memcacheæœåŠ¡ netstat -nltp|grep 8080;//æŸ¥è¯¢8080ç«¯å£æ˜¯å¦ç›‘å¬ ps -aux;//æŸ¥çœ‹æ‰€æœ‰çš„è¿›ç¨‹ ps -ef|grep java; //æŸ¥çœ‹javaçš„è¿›ç¨‹å· history 1000|grep pip;//åˆ—å‡ºæœ€è¿‘ä½¿ç”¨pip å‘½ä»¤çš„1000æ¡è®°å½• ps -ef|grep jetty|grep -v grep|awk \u0026#39;{print $2}\u0026#39;;//æŸ¥çœ‹jettyè¿›ç¨‹å· ps -ef|grep -v grep|grep jetty-avene|grep jetty|grep -v python|awk \u0026#39;{print $2}\u0026#39;;//æŸ¥è¯¢jettyé¡¹ç›®åç§°ä¸ºjettyï¼aveneçš„è¿›ç¨‹å· ps -ef|grep -v grep|grep jetty-avene|grep jetty|grep -v python|awk \u0026#39;{print $2}\u0026#39; 4.å®‰è£…è½¯ä»¶ç›¸å…³çš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 rpm --install couchbase-server-enterprise-3.0.3-centos6.x86_64.rpm;//è§£å‹rpmæ–‡ä»¶ rpm -qa;//æŸ¥çœ‹æ‰€æœ‰å®‰è£…çš„è½¯ä»¶åŒ… rpm -qa|grep kernel;//æŸ¥è¯¢ç³»ç»Ÿæ‰€æœ‰å†…æ ¸ yum remove kernel-headers-3.10.0-327.el7.x86_64;//åˆ é™¤å†…æ ¸kernel-headers-3.10.0-327.el7.x86_64 rpm -l pkgname.rpmï¼›//å®‰è£…rpmåŒ… rpm -e pkgname;//åˆ é™¤rmpåŒ… ä»æºç å®‰è£… ./configure make make install 5.é˜²ç«å¢™ç›¸å…³çš„(centos6) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 chkconfig --list;//åˆ—å‡ºç³»ç»Ÿæ‰€æœ‰æœåŠ¡å¯åŠ¨æƒ…å†µ service iptables status;//æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€ service iptables start;//æ‰“å¼€é˜²ç«å¢™ service iptables stop;//å…³é—­é˜²ç«å¢™ ä¸ºé˜²ç«å¢™æ·»åŠ è®¿é—®ç«¯å£å’Œipï¼Œåœ¨vi /etc/sysconfig/iptablesç›®å½•ä¸‹ç¼–è¾‘: iptables -A INPUT -p tcp --dport 10006 -j ACCEPT; //å…è®¸ç«¯å£10006è®¿é—® iptables -A INPUT -s 192.168.50.87 -p tcp -j ACCEPTï¼›//å…è®¸192.168.50.87åœ°å€èƒ½è®¿é—® 6.æ“ä½œç£ç›˜ç›¸å…³çš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 df -h;//æŸ¥çœ‹ç£ç›˜çš„ä½¿ç”¨æƒ…å†µ du -h;//æŸ¥çœ‹ç›®å½•çš„å¤§å° du â€“sh *ï¼›//æŸ¥çœ‹æŸä¸ªç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶åŠæ–‡ä»¶çš„å¤§å°ï¼š du -sh *|sort -nr;//å®šä½é‚£ä¸ªç›®å½•æœ€å¤§ du â€“sh * |sort â€“n;//æŒ‰ç…§æ–‡ä»¶å¤§å°æ’åº fdisk -l;//å¯ä»¥æŸ¥çœ‹åˆ°å½“å‰çš„æ‰€æœ‰åˆ†åŒºï¼Œæ¯”å¦‚bootåˆ†åŒºï¼Œè¯¥åˆ†åŒºå­˜æ¡£linuxçš„grubä»¥åŠå†…æ ¸æºç  vim /etc/fstab ;//ä¿®æ”¹fstabå†…å®¹ 7.ç½‘ç»œç›¸å…³çš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 nslookup www.baidu.com;//æŸ¥è¯¢åŸŸåå¯¹åº”çš„ipåœ°å€ dig www.baidu.com;//æŸ¥è¯¢åŸŸåå¯¹åº”çš„ipåœ°å€ lsof -i:4080;//æŸ¥çœ‹4080ç«¯å£æ˜¯å¦è¢«å ç”¨ curl ifconfig.me;//æŸ¥å‡ºå¤–ç½‘çš„ipåœ°å€ netstat -tnlp|grep redis; ifconfig -a; //åˆ—å‡ºæ‰€æœ‰ç½‘ç»œç«¯å£å’ŒIPåœ°å€ iftop //ç›‘æ§ç½‘ç»œå¸¦å®½ ifconfig eth0 //åˆ—å‡ºæŒ‡å®šä»¥å¤ªç½‘ç«¯å£å¯¹åº”çš„IPåœ°å€å’Œè¯¦ç»†ä¿¡æ¯ ethtool eth0 //æŸ¥çœ‹ä»¥å¤ªç½‘çŠ¶æ€ ping host whois domain //è·å–æŒ‡å®šåŸŸåçš„ä¿¡æ¯ dig domain //è·å–æŒ‡å®šåŸŸåçš„DNSä¿¡æ¯ dig -x host //æ ¹æ®ä¸»æœºåœ°å€åå‘æŸ¥æ‰¾ host goole.com //æ ¹æ®åŸŸåæŸ¥æ‰¾DNS IPåœ°å€ wget file //ä¸‹è½½æ–‡ä»¶ netstat -tupl //åˆ—å‡ºç³»ç»Ÿçš„æ´»è·ƒè¿æ¥ 8.æ–‡ä»¶ä¼ è¾“ç›¸å…³çš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 scp file.txt server2:/tmp //å®‰å…¨æ‹·è´file.txtåˆ°è¿œç¨‹ä¸»æœºçš„/tmpç›®å½•ä¸‹ scp noodle@server2:/www/*.html /www/tmp //æ‹·è´è¿œç¨‹ä¸»æœºçš„/www/ç›®å½•ä¸‹çš„æ‰€æœ‰HTMLæ–‡ä»¶åˆ°æœ¬åœ°çš„/www/tmpç›®å½• scp -r noodle@server2:/www /www/tmp //é€’å½’æ‹·è´è¿œç¨‹ä¸»æœº/wwwç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹åˆ°æœ¬åœ°/www/tmpç›®å½• scp -P 2244 client.xml datasources.xml server.xml root@139.136.218.194:/data/appdatas/cat;//è¿œç¨‹æœºå™¨è®¿é—®ç«¯å£ä¸º2244 # rsync rsync -a /home/apps /backup/ # æºç›®å½•å’Œç›®æ ‡ç›®å½•åŒæ­¥ rsync -avz /home/apps noodle@192.168.10.1:/backup //æœ¬åœ°ç›®å½•å’Œè¿œç¨‹ä¸»æœºç›®å½•åŒæ­¥ï¼Œå¯ç”¨å‹ç¼© //æ¨¡æ‹Ÿè¯·æ±‚ curl -i -X POST -H \u0026#39;Content-type\u0026#39;:\u0026#39;application/json\u0026#39; -d \u0026#39;{\u0026#34;customerId\u0026#34;:3,\u0026#34;recNum\u0026#34;:\u0026#34;18862285367\u0026#34;}\u0026#39; http://10.105.31.109:10000/sms/sendCoupenCodeSms 9.ç¡¬ä»¶ç›¸å…³çš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 dmesg //ç›‘æµ‹ç¡¬ä»¶å’Œå¯åŠ¨æ¶ˆæ¯ cat /proc/cpuinfo //CPUä¿¡æ¯ cat /proc/meminfo //ç¡¬ä»¶å†…å­˜ä¿¡æ¯ free -m //å·²ä½¿ç”¨çš„å’Œå¯ç”¨å†…å­˜ï¼Œ-mè¡¨ç¤ºå•ä½ä¸ºM lspci -tv //æ˜¾ç¤ºPCIè®¾å¤‡ä¿¡æ¯ lsusb -tv //æ˜¾ç¤ºUSBè®¾å¤‡ä¿¡æ¯ hdparm -l /dev/sda //æ˜¾ç¤ºsdaç¡¬ç›˜ä¿¡æ¯ hdparm -tT /dev/sda //å¯¹sdaç¡¬ç›˜è¿›è¡Œè¯»å–é€Ÿåº¦æµ‹è¯• hdparm -s /dev/sda //æµ‹è¯•sdaç¡¬ç›˜ä¸Šä¸å¯è¯»çš„å— 10.ç»Ÿè®¡ç›¸å…³çš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 top //æ˜¾ç¤ºå¹¶ä¸æ–­æ›´æ–°æœ€è€—CPUçš„è¿›ç¨‹ mpstat 1 //æ˜¾ç¤ºCPUç»Ÿè®¡ä¿¡æ¯ vmstat 2 //æ˜¾ç¤ºè™šæ‹Ÿå†…å­˜ç»Ÿè®¡ä¿¡æ¯ iostat 2 //æ˜¾ç¤ºIOç»Ÿè®¡ä¿¡æ¯ï¼ˆ2sé‡‡æ ·é—´éš”ï¼‰ tcpdump -i eth1 //æ•è·eth1ç½‘ç»œæ¥å£ä¸Šçš„æ‰€æœ‰æ•°æ®åŒ… tcpdump -i eth0 \u0026#39;port 80\u0026#39; //ç›‘æ§80ç«¯å£çš„ç½‘ç»œæµé‡ lsof //åˆ—å‡ºæ‰€æœ‰æ´»è·ƒè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ lsof -u testuser //åˆ—å‡ºæ‰€æœ‰testuserç”¨æˆ·æ‰“å¼€çš„æ–‡ä»¶ wc -l filename;//ç»Ÿè®¡è¡Œæ•° wc -c filename;//ç»Ÿè®¡å­—èŠ‚æ•° wc -m filename;//ç»Ÿè®¡å­—ç¬¦æ•° wc -w filename;//ç»Ÿè®¡å•è¯æ•° ls -l|wc -l ç”¨æ¥ç»Ÿè®¡å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶æ•° 11.nginxç»Ÿè®¡ç›¸å…³çš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 1.æ ¹æ®è®¿é—®IPç»Ÿè®¡UV awk \u0026#39;{print $1}\u0026#39; access.log|sort | uniq -c |wc -l 2.ç»Ÿè®¡è®¿é—®URLç»Ÿè®¡PV awk \u0026#39;{print $7}\u0026#39; access.log|wc -l 3.æŸ¥è¯¢è®¿é—®æœ€é¢‘ç¹çš„URL awk \u0026#39;{print $7}\u0026#39; access.log|sort | uniq -c |sort -n -k 1 -r|more 4.æŸ¥è¯¢è®¿é—®æœ€é¢‘ç¹çš„IP awk \u0026#39;{print $1}\u0026#39; access.log|sort | uniq -c |sort -n -k 1 -r|more 5.æ ¹æ®æ—¶é—´æ®µç»Ÿè®¡æŸ¥çœ‹æ—¥å¿— cat access.log| sed -n \u0026#39;/14\\/Mar\\/2015:21/,/14\\/Mar\\/2015:22/p\u0026#39;|more 12.nmapç›¸å…³çš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 nmap 192.168.102.10; ä¾¦æµ‹ipåœ°å€ nmap weixin.hao.cn;ä¾¦æµ‹åŸŸå nmap -sU -sS -F weixin.hao.cn;//-F å¿«é€Ÿæ‰«ææ¨¡å¼ï¼Œæ‰«ææœ€å¯èƒ½å¼€æ”¾çš„å‰100ä¸ªç«¯å£ nmap -sV 192.168.102.10; nmap -A 192.168.102.10;æ‰§è¡Œå…¨ç½‘æ‰«æ nmap -O weixin.hao.cn;//ä¾¦æµ‹æ“ä½œç³»ç»Ÿçš„ä¿¡æ¯ nmap -sP 192.168.102.*;//æ‰¾å‡ºç½‘ç»œä¸­çš„åœ¨çº¿ä¸»æœº nmap -V;//æŸ¥è¯¢nmapç‰ˆæœ¬ nmap -p 8080 weixin.hao.cn;//æ‰«æç‰¹å®šç«¯å£ 13.ç”¨æˆ·ç›¸å…³çš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 adduser newname // æ–°å»ºç”¨æˆ·newname passwd newname //è®¾ç½®ç”¨æˆ·åå’Œå¯†ç  userdel newname //åˆ é™¤ç”¨æˆ· deluser â€“remove-home newname //åˆ é™¤homeç›®å½•çš„æ•°æ® sudo addgroup siatstudent //åˆ›å»ºç»„ groupadd testgroup groupmod -n test2group testgroup //ä¿®æ”¹ç»„ delgroup happy //åˆ é™¤åˆ†ç»„ groups #æŸ¥çœ‹å½“å‰ç™»é™†ç”¨æˆ·æ‰€åœ¨çš„ç»„ groups testnewuser #æŸ¥çœ‹testnewuser æ‰€åœ¨çš„ç»„ cat /etc/group #æŸ¥çœ‹æ‰€æœ‰ç»„ 14.Linuxå†…å­˜æ¸…ç†å‘½ä»¤ 1 2 3 4 5 6 7 free -m;//æ¸…ç†å†…å­˜å‰ æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ echo 1 \u0026gt; /proc/sys/vm/drop_caches;//å¼€å§‹æ¸…ç† free -m;//æ¸…ç†ä¹‹åæŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ dmidecode | grep -A16 \u0026#34;Memory Device$\u0026#34;;//æŸ¥çœ‹å†…å­˜æ¡æ•° ","date":"2020-03-25T17:09:05Z","image":"https://www.ownit.top/title_pic/17.jpg","permalink":"https://www.ownit.top/p/202003251709/","title":"Linuxå¸¸è§é—®é¢˜åŠå‘½ä»¤"},{"content":"ä½¿ç”¨Dockeræµ‹è¯•é™æ€ç½‘ç«™ **å°†Dockerä½œä¸ºæœ¬åœ°Webå¼€å‘ç¯å¢ƒæ˜¯Dockerçš„ä¸€ä¸ªæœ€ç®€å•çš„åº”ç”¨åœºæ™¯ã€‚ è¿™æ ·çš„ç¯å¢ƒå¯ä»¥å®Œå…¨å¤åˆ¶ç”Ÿäº§ç¯å¢ƒï¼Œå¹¶ç¡®ä¿ç”¨æˆ·å¼€å‘çš„ä¸œè¥¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¹Ÿèƒ½è¿è¡Œã€‚ä¸‹é¢ä»å°†Nginx WebæœåŠ¡å™¨å®‰è£…åˆ°å®¹å™¨æ¥æ¶æ„ä¸€ä¸ªç®€ å•çš„ç½‘ç«™å¼€å§‹ã€‚è¿™ä¸ªç½‘ç«™æš‚ä¸”å‘½åä¸ºSampleã€‚Â **\nSampleç½‘ç«™çš„åˆå§‹Dockerfile ä¸ºäº†å®Œæˆç½‘ç«™å¼€å‘ï¼Œä»è¿™ä¸ªç®€å•çš„Dockerfileå¼€å§‹ã€‚å…ˆæ¥åˆ›å»ºä¸€ä¸ª ç›®å½•ï¼Œä¿å­˜Dockerfile\n1 2 3 $ mkdir sample $ cd sample $ touch Dockerfile ç°åœ¨è¿˜éœ€è¦ä¸€äº›Nginxé…ç½®æ–‡ä»¶ï¼Œæ‰èƒ½è¿è¡Œè¿™ä¸ªç½‘ç«™ã€‚é¦–å…ˆåœ¨è¿™ä¸ªç¤ºä¾‹ æ‰€åœ¨çš„ç›®å½•é‡Œåˆ›å»ºä¸€ä¸ªåä¸ºnginxçš„ç›®å½•ï¼Œç”¨æ¥å­˜æ”¾è¿™äº›é…ç½®æ–‡ä»¶ã€‚ ç„¶åæˆ‘ä»¬å¯ä»¥ä»GitHubä¸Šä¸‹è½½ä½œè€…å‡†å¤‡å¥½çš„ç¤ºä¾‹æ–‡ä»¶\n1 2 3 4 $ mkdir nginx \u0026amp;\u0026amp; cd nginx $ wget https://raw.githubusercontent.com/jamtur01/dockerbook-code/master/code/5/sample/nginx/global.conf $ wget https://raw.githubusercontent.com/jamtur01/dockerbook-code/master/code/5/sample/nginx/nginx.conf $ cd .. ç°åœ¨çœ‹ä¸€ä¸‹æˆ‘ä»¬å°†è¦ä¸ºSampleç½‘ç«™åˆ›å»ºçš„Dockerfileï¼Œå¦‚ä»£ç æ¸…å•\n1 2 3 4 5 6 7 8 FROM centos MAINTAINER heian99 \u0026#34;heian99@163.com\u0026#34; ENV REFRESHED_AT 2014-06-01 RUN yum -y update \u0026amp;\u0026amp; yum -y install nginx RUN mkdir -p /var/www/html/website ADD nginx/global.conf /etc/nginx/conf.d/ ADD nginx/nginx.conf /etc/nginx/nginx.conf EXPOSE 80 è¿™ä¸ªç®€å•çš„Dockerfileå†…å®¹åŒ…æ‹¬ä»¥ä¸‹å‡ é¡¹ã€‚ å®‰è£…Nginxã€‚\nåœ¨å®¹å™¨ä¸­åˆ›å»ºä¸€ä¸ªç›®å½•/var/www/html/website/ã€‚\nå°†æ¥è‡ªæˆ‘ä»¬ä¸‹è½½çš„æœ¬åœ°æ–‡ä»¶çš„Nginxé…ç½®æ–‡ä»¶æ·»åŠ åˆ°é•œåƒä¸­ã€‚\nå…¬å¼€é•œåƒçš„80ç«¯å£ã€‚\nè¿™ä¸ªNginxé…ç½®æ–‡ä»¶æ˜¯ä¸ºäº†è¿è¡ŒSampleç½‘ç«™è€Œé…ç½®çš„ã€‚å°†æ–‡ä»¶ nginx/global.confç”¨ADDæŒ‡ä»¤å¤åˆ¶åˆ°/etc/nginx/conf.d/ç›® å½•ä¸­ã€‚é…ç½®æ–‡ä»¶\nglobal.conf 1 2 3 4 5 6 7 8 9 10 server { listen 0.0.0.0:80; server_name _; root /var/www/html/website; index index.html index.htm; access_log /var/log/nginx/default_access.log; error_log /var/log/nginx/default_error.log; } è¿™ä¸ªæ–‡ä»¶å°†Nginxè®¾ç½®ä¸ºç›‘å¬80ç«¯å£ï¼Œå¹¶å°†ç½‘ç»œæœåŠ¡çš„æ ¹è·¯å¾„è®¾ç½® ä¸º/var/www/ html/websiteï¼Œè¿™ä¸ªç›®å½•æ˜¯æˆ‘ä»¬ç”¨RUNæŒ‡ä»¤åˆ›å»º çš„ã€‚\næˆ‘ä»¬è¿˜éœ€è¦å°†Nginxé…ç½®ä¸ºéå®ˆæŠ¤è¿›ç¨‹çš„æ¨¡å¼ï¼Œè¿™æ ·å¯ä»¥è®©Nginxåœ¨ Dockerå®¹å™¨é‡Œå·¥ä½œã€‚å°†æ–‡ä»¶nginx/nginx.confå¤åˆ¶ åˆ°/etc/nginxç›®å½•å°±å¯ä»¥è¾¾åˆ°è¿™ä¸ªç›®çš„\nnginx.confçš„æ¸…å• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 user www-data;#æŠŠè¿™ä¸ªåˆ é™¤æ‰ï¼Œä¸ç„¶åé¢dockeré‡Œé¢çš„nginxæ— æ³•å¯åŠ¨ worker_processes 4; pid /run/nginx.pid; daemon off; events { } http { sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; include /etc/nginx/mime.types; default_type application/octet-stream; access_log /var/log/nginx/access.log; error_log /var/log/nginx/error.log; gzip on; gzip_disable \u0026#34;msie6\u0026#34;; include /etc/nginx/conf.d/*.conf; } åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶é‡Œï¼Œdaemon off;é€‰é¡¹é˜»æ­¢Nginxè¿›å…¥åå°ï¼Œå¼ºåˆ¶å…¶ åœ¨å‰å°è¿è¡Œã€‚è¿™æ˜¯å› ä¸ºè¦æƒ³ä¿æŒDockerå®¹å™¨çš„æ´»è·ƒçŠ¶æ€ï¼Œéœ€è¦å…¶ä¸­è¿ è¡Œçš„è¿›ç¨‹ä¸èƒ½ä¸­æ–­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒNginxä¼šä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨ï¼Œè¿™ ä¼šå¯¼è‡´å®¹å™¨åªæ˜¯çŸ­æš‚è¿è¡Œï¼Œåœ¨å®ˆæŠ¤è¿›ç¨‹è¢«forkå¯åŠ¨åï¼Œå‘èµ·å®ˆæŠ¤è¿›ç¨‹ çš„åŸå§‹è¿›ç¨‹å°±ä¼šé€€å‡ºï¼Œè¿™æ—¶å®¹å™¨å°±åœæ­¢è¿è¡Œäº†\nè¿™ä¸ªæ–‡ä»¶é€šè¿‡ADDæŒ‡ä»¤å¤åˆ¶åˆ°/etc/nginx/nginx.confã€‚\nç¬¬ä¸€ä¸ªæŒ‡ä»¤ä»¥ ç›®å½•/etc/nginx/ conf.d/ç»“æŸï¼Œè€Œç¬¬äºŒä¸ªæŒ‡ä»¤æŒ‡å®šäº†æ–‡ ä»¶/etc/nginx/nginx.confã€‚å°†æ–‡ä»¶å¤åˆ¶åˆ°Dockeré•œåƒæ—¶ï¼Œè¿™ä¸¤ ç§é£æ ¼éƒ½æ˜¯å¯ä»¥ç”¨çš„ã€‚\næ„å»ºSampleç½‘ç«™å’ŒNginxé•œåƒ åˆ©ç”¨ä¹‹å‰çš„Dockerfileï¼Œå¯ä»¥ç”¨docker buildå‘½ä»¤æ„å»ºå‡ºæ–°çš„é•œ åƒï¼Œå¹¶å°†è¿™ä¸ªé•œåƒå‘½åä¸ºheian/nginx\n1 docker build -t heian/nginx . è¿™å°†æ„å»ºå¹¶å‘½åä¸€ä¸ªæ–°é•œåƒã€‚ä¸‹é¢æ¥çœ‹çœ‹æ„å»ºçš„æ‰§è¡Œæ­¥éª¤ã€‚ä½¿ç”¨ docker historyå‘½ä»¤æŸ¥çœ‹æ„å»ºæ–°é•œåƒçš„æ­¥éª¤å’Œå±‚çº§\nä»Sampleç½‘ç«™å’ŒNginxé•œåƒæ„å»ºå®¹å™¨ ç°åœ¨å¯ä»¥ä½¿ç”¨heian/nginxé•œåƒï¼Œå¹¶å¼€å§‹ä»è¿™ä¸ªé•œåƒæ„å»ºå¯ä»¥ç”¨ æ¥æµ‹è¯•Sampleç½‘ç«™çš„å®¹å™¨ã€‚ä¸ºæ­¤ï¼Œéœ€è¦æ·»åŠ Sampleç½‘ç«™çš„ä»£ç ã€‚ç°åœ¨\næ³¨æ„æç¤ºä¸‹è½½è¿™æ®µä»£ç åˆ°sampleç›®å½•\n1 2 3 $ mkdir website \u0026amp;\u0026amp; cd website $ wget http://raw.githubusercontent.com/jamtur01/dockerbook-code/master/code/5/sample/website/index.html $ cd.. ç°åœ¨æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨docker runå‘½ä»¤æ¥è¿è¡Œä¸€ä¸ªå®¹å™¨\n1 docker run -d -p 80 --name website -v $PWD/website:/var/www/html/website heian/nginx nginx ä¸Šé¢å‘½ä»¤å¦‚æœæœ‰é—®é¢˜ï¼Œé‚£å°±æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤\n1 docker run -d -p 80 --name nginx -v $PWD/website:/var/www/html/website heian/nginx /bin/bash -c \u0026#34;tail -f /dev/null;/usr/sbin/nginx\u0026#34; å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ‰§è¡Œdocker runæ—¶ä¼ å…¥äº†nginxä½œä¸ºå®¹å™¨çš„å¯åŠ¨å‘½ä»¤ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ è¿™ä¸ªå‘½ä»¤æ— æ³•è®©Nginxä»¥äº¤äº’çš„æ–¹å¼è¿è¡Œã€‚æˆ‘ä»¬å·²ç»åœ¨æä¾›ç»™Dockerçš„é…ç½®é‡ŒåŠ å…¥äº†æŒ‡ä»¤ daemon offï¼Œè¿™ä¸ªæŒ‡ä»¤è®©Nginxå¯åŠ¨åä»¥äº¤äº’çš„æ–¹å¼åœ¨å‰å°è¿è¡Œ\nå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨docker runå‘½ä»¤ä»heian/nginxé•œåƒåˆ›å»º äº†ä¸€ä¸ªåä¸ºwebsiteçš„å®¹å™¨ã€‚è¯»è€…å·²ç»è§è¿‡äº†å¤§éƒ¨åˆ†é€‰é¡¹ï¼Œä¸è¿‡-vé€‰ é¡¹æ˜¯æ–°çš„ã€‚-vè¿™ä¸ªé€‰é¡¹å…è®¸æˆ‘ä»¬å°†å®¿ä¸»æœºçš„ç›®å½•ä½œä¸ºå·ï¼ŒæŒ‚è½½åˆ°å®¹å™¨ é‡Œã€‚\nå›åˆ°åˆšæ‰çš„ä¾‹å­ã€‚å½“æˆ‘ä»¬å› ä¸ºæŸäº›åŸå› ä¸æƒ³æŠŠåº”ç”¨æˆ–è€…ä»£ç æ„å»ºåˆ°é•œ åƒä¸­æ—¶ï¼Œå°±ä½“ç°å‡ºå·çš„ä»·å€¼äº†ã€‚ä¾‹å¦‚ï¼š\nå¸Œæœ›åŒæ—¶å¯¹ä»£ç åšå¼€å‘å’Œæµ‹è¯•ï¼› ä»£ç æ”¹åŠ¨å¾ˆé¢‘ç¹ï¼Œä¸æƒ³åœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡æ„é•œåƒï¼› å¸Œæœ›åœ¨å¤šä¸ªå®¹å™¨é—´å…±äº«ä»£ç  -vé€‰é¡¹é€šè¿‡æŒ‡å®šä¸€ä¸ªç›®å½•æˆ–è€…ç™»ä¸Šä¸å®¹å™¨ä¸Šä¸è¯¥ç›®å½•åˆ†ç¦»çš„æœ¬åœ°å®¿ä¸» æœºæ¥å·¥ä½œï¼Œè¿™ä¸¤ä¸ªç›®å½•ç”¨:åˆ†éš”ã€‚å¦‚æœå®¹å™¨ç›®å½•ä¸å­˜åœ¨ï¼ŒDockerä¼šè‡ª åŠ¨åˆ›å»ºä¸€ä¸ªã€‚\n1 2 3 docker run -d -p 80 --name website \\ -v $PWD/website:/var/www/html/website:ro \\ heian/nginx nginx è¿™å°†ä½¿ç›®çš„ç›®å½•/var/www/html/websiteå˜æˆåªè¯»çŠ¶æ€ã€‚\nåœ¨Nginxç½‘ç«™å®¹å™¨é‡Œï¼Œæˆ‘ä»¬é€šè¿‡å·å°†$PWD/websiteæŒ‚è½½åˆ°å®¹å™¨ çš„/var/www/ html/websiteç›®å½•ï¼Œé¡ºåˆ©æŒ‚è½½äº†æ­£åœ¨å¼€å‘çš„æœ¬åœ°ç½‘ ç«™ã€‚åœ¨Nginxé…ç½®é‡Œï¼ˆåœ¨é…ç½®æ–‡ ä»¶/etc/ngingx/conf.d/global.confä¸­ï¼‰ï¼Œå·²ç»æŒ‡å®šäº†è¿™ä¸ªç›® å½•ä¸ºNginxæœåŠ¡å™¨çš„å·¥ä½œç›®å½•ã€‚\nç°åœ¨ï¼Œå¦‚æœä½¿ç”¨docker pså‘½ä»¤æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°åä¸º websiteçš„å®¹å™¨æ­£å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œå®¹å™¨çš„80ç«¯å£è¢«æ˜ å°„åˆ°å®¿ä¸»æœºçš„ 49161ç«¯å£\nä¿®æ”¹ç½‘ç«™ æˆ‘ä»¬å·²ç»å¾—åˆ°äº†ä¸€ä¸ªå¯ä»¥å·¥ä½œçš„ç½‘ç«™ï¼ç°åœ¨ï¼Œå¦‚æœè¦ä¿®æ”¹ç½‘ç«™ï¼Œè¯¥æ€ ä¹ˆåŠï¼Ÿå¯ä»¥ç›´æ¥æ‰“å¼€æœ¬åœ°å®¿ä¸»æœºçš„websiteç›®å½•ä¸‹çš„index.htmlæ–‡ ä»¶å¹¶ä¿®æ”¹\n**å¯ä»¥çœ‹åˆ°ï¼ŒSampleç½‘ç«™å·²ç»æ›´æ–°äº†ã€‚æ˜¾ç„¶è¿™ä¸ªä¿®æ”¹å¤ªç®€å•äº†ï¼Œä¸è¿‡å¯ ä»¥çœ‹å‡ºï¼Œæ›´å¤æ‚çš„ä¿®æ”¹ä¹Ÿå¹¶ä¸å›°éš¾ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæ­£åœ¨æµ‹è¯•ç½‘ç«™çš„è¿ è¡Œç¯å¢ƒï¼Œå®Œå…¨æ˜¯ç”Ÿäº§ç¯å¢ƒé‡Œçš„çœŸå®çŠ¶æ€ã€‚ç°åœ¨å¯ä»¥ç»™æ¯ä¸ªç”¨äºç”Ÿäº§çš„ ç½‘ç«™æœåŠ¡ç¯å¢ƒï¼ˆå¦‚Apacheã€Nginxï¼‰é…ç½®ä¸€ä¸ªå®¹å™¨ï¼Œç»™ä¸åŒå¼€å‘æ¡†æ¶ çš„è¿è¡Œç¯å¢ƒï¼ˆå¦‚PHPæˆ–è€…Ruby on Railsï¼‰é…ç½®ä¸€ä¸ªå®¹å™¨ï¼Œæˆ–è€…ç»™åç«¯ æ•°æ®åº“é…ç½®ä¸€ä¸ªå®¹å™¨ï¼Œç­‰ç­‰ã€‚Â **\n","date":"2020-03-23T11:28:44Z","image":"https://www.ownit.top/title_pic/15.jpg","permalink":"https://www.ownit.top/p/202003231128/","title":"Dockeræµ‹è¯•ä¸€ä¸ªé™æ€ç½‘ç«™"},{"content":"Dockerç½‘ç»œï¼ˆhostã€bridgeã€noneï¼‰è¯¦ç»†ä»‹ç» Dockerå®¹å™¨é—´é€šä¿¡ å‰é¢æˆ‘ä»¬å·²ç»è§£å†³äº†å®¹å™¨é—´é€šä¿¡çš„é—®é¢˜ï¼Œæ¥ä¸‹æ¥è®¨è®ºå®¹å™¨å¦‚ä½•ä¸å¤–éƒ¨ä¸–ç•Œé€šä¿¡ã€‚\nè¿™é‡Œæ¶‰åŠä¸¤ä¸ªæ–¹å‘ï¼š\nï¼ˆ1ï¼‰å®¹å™¨è®¿é—®å¤–éƒ¨ä¸–ç•Œã€‚\nï¼ˆ2ï¼‰å¤–éƒ¨ä¸–ç•Œè®¿é—®å®¹å™¨ã€‚\nå®¹å™¨è®¿é—®å¤–éƒ¨ä¸–ç•Œ åœ¨æˆ‘ä»¬å½“å‰çš„å®éªŒç¯å¢ƒä¸‹ï¼Œdocker hostæ˜¯å¯ä»¥è®¿é—®å¤–ç½‘çš„\næˆ‘ä»¬çœ‹ä¸€ä¸‹å®¹å™¨æ˜¯å¦ä¹Ÿèƒ½è®¿é—®å¤–ç½‘å‘¢ï¼Ÿ\nå¯è§ï¼Œå®¹å™¨é»˜è®¤å°±èƒ½è®¿é—®å¤–ç½‘ã€‚\nè¯·æ³¨æ„ï¼šè¿™é‡Œå¤–ç½‘æŒ‡çš„æ˜¯å®¹å™¨ç½‘ç»œä»¥å¤–çš„ç½‘ç»œç¯å¢ƒï¼Œå¹¶éç‰¹æŒ‡Internet.\nç°è±¡å¾ˆç®€å•ï¼Œä½†æ›´é‡è¦çš„ï¼šæˆ‘ä»¬åº”è¯¥ç†è§£ç°è±¡ä¸‹çš„æœ¬è´¨ã€‚\nåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œbusyboxä½äºdockeroè¿™ä¸ªç§æœ‰bridgeç½‘ç»œä¸­ï¼ˆ172.17.0.0/16ï¼‰ï¼Œå½“busyboxä»å®¹å™¨å‘å¤–pingæ—¶ï¼Œæ•°æ®åŒ…æ˜¯æ€æ ·åˆ°è¾¾bing.comçš„å‘¢ï¼Ÿ\nè¿™é‡Œçš„å…³é”®å°±æ˜¯NATï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹docker hostä¸Šçš„iptablesè§„åˆ™\nåœ¨NATè¡¨ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ¡è§„åˆ™ï¼š 1 -A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE å…¶å«ä¹‰æ˜¯ï¼šå¦‚æœç½‘æ¡¥docker0æ”¶åˆ°æ¥è‡ª172.17.0.0/16ç½‘æ®µçš„å¤–å‡ºåŒ…ï¼ŒæŠŠå®ƒäº¤ç»™MASQUERADEå¤„ç†ã€‚è€Œä¸”MASQUERADEçš„å¤„ç†æ–¹å¼æ˜¯å°†\nåŒ…çš„åŸåœ°å€æ›¿æ¢æˆhostçš„åœ°å€å‘é€å‡ºå»ï¼Œæœº åšäº†ä¸€æ¬¡ç½‘ç»œåœ°å€è½¬æ¢ï¼ˆNATï¼‰\nä¸‹é¢æˆ‘ä»¬é€šè¿‡tcpdumpæŸ¥çœ‹åœ°å€æ˜¯å¦‚ä½•è½¬æ¢çš„ã€‚å…ˆæŸ¥çœ‹docker hostçš„è·¯ç”±è¡¨\né»˜è®¤è·¯ç”±é€šè¿‡ens192å‘å‡ºå»ï¼Œæ‰€ä»¥æˆ‘ä»¬åŒæ—¶è¦ç›‘æ§ens192å’Œdocker0ä¸Šçš„icmpï¼ˆpingï¼‰çš„æ•°æ®åŒ…ã€‚\nå½“busybox ping www.baidu.comæ—¶ï¼Œtcpdumoè¾“å‡ºå¦‚ä¸‹\n1 tcpdump -i docker0 -n icmp docker0æ”¶åˆ°busyboxçš„pingåŒ…ï¼Œæºåœ°å€ä¸ºå®¹å™¨çš„IPï¼š172.17.0.2ï¼Œè¿™æ²¡é—®é¢˜ï¼Œäº¤ç»™MASQUERADEå¤„ç†ã€‚è¿™æ—¶ï¼Œåœ¨çœ‹ens192çš„å˜åŒ–ã€‚\npingåŒ…çš„æºåœ°å€å˜æˆens192çš„192.168.1.100\nè¿™å°±æ˜¯iptablesçš„NATè§„åˆ™çš„å¤„ç†ç»“æœï¼Œä»è€Œä¿è¯æ•°æ®åŒ…èƒ½å¤Ÿåˆ°è¾¾å¤–ç½‘ã€‚\nä¸‹é¢è¿™å¼ å›¾æ¥è¯´æ˜ç»“æœã€‚\nï¼ˆ1ï¼‰busyboxå‘é€pingåŒ…ï¼š172.17.0.2 \u0026gt; www.bing.comã€‚ ï¼ˆ2ï¼‰dockeroæ”¶åˆ°åŒ…ï¼Œå‘ç°æ˜¯å‘é€åˆ°å¤–ç½‘çš„ï¼Œäº¤ç»™NATå¤„ç†ã€‚ ï¼ˆ3ï¼‰NATå°†æºåœ°å€æ¢æˆens192çš„IPï¼š10.0.2.15 \u0026gt;www.bing.com. ï¼ˆ4ï¼‰pingä» ens192å‡ºå»ï¼Œè¾¾www.bing.como é€šè¿‡NATï¼Œdockerå®ç°äº†å®¹å™¨å¯¹å¤–ç½‘çš„è®¿é—®ã€‚ å¤–éƒ¨ä¸–ç•Œè®¿é—®å®¹å™¨ ä¸‹é¢æˆ‘ä»¬æ¥è®¨è®ºå¦ä¸€ä¸ªæ–¹å‘ï¼šå¤–ç½‘å¦‚ä½•è®¿é—®åˆ°å®¹å™¨ï¼Ÿ\nç­”æ¡ˆæ˜¯ï¼šç«¯å£æ˜ å°„ã€‚\ndockerå¯å°†å®¹å™¨å¯¹å¤–æä¾›æœåŠ¡çš„ç«¯å£æ˜ å°„åˆ°hostçš„æŸä¸ªç«¯å£ï¼Œå¤–ç½‘é€šè¿‡è¯¥ç«¯å£è®¿é—®å®¹å™¨ã€‚å®¹å™¨å¯åŠ¨æ—¶é€šè¿‡-på‚æ•°æ˜ å°„ç«¯å£\n1 2 3 4 5 6 7 8 [root@kvm ~]# docker run -d -p 80 httpd 6b89d7e3f47a425256af6934689c0009fbbad9099bf31c2e6148a6cb236a9655 [root@kvm ~]# docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 6b89d7e3f47a httpd \u0026#34;httpd-foreground\u0026#34; 5 seconds ago Up 2 seconds 0.0.0.0:32768-\u0026gt;80/tcp stoic_bartik 78de9710bce0 busybox \u0026#34;sh\u0026#34; 19 minutes ago Up 19 minutes hei [root@kvm ~]# docker port 6b89d7e3f47a 80/tcp -\u0026gt; 0.0.0.0:32768 å®¹å™¨å¯åŠ¨åï¼Œå¯é€šè¿‡docker psæˆ–è€…docker portæŸ¥çœ‹åˆ°hostæ˜ å°„çš„ç«¯å£ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œhttpdå®¹å™¨çš„80ç«¯å£è¢«æ˜ å°„åˆ°host 32768ä¸Šï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡\u0026lt;host ip\u0026gt;ï¼š\u0026lt;32773\u0026gt;è®¿é—®å®¹å™¨çš„WebæœåŠ¡äº†\né™¤äº†æ˜ å°„åŠ¨æ€ç«¯å£ï¼Œä¹Ÿå¯åœ¨-pä¸­æŒ‡å®šæ˜ å°„åˆ°hostæŸä¸ªç‰¹å®šç«¯å£ï¼Œä¾‹å¦‚å¯å°†80ç«¯å£æ˜ å°„åˆ°hostçš„8080ç«¯å£\n1 2 3 4 5 [root@kvm ~]# docker run -d -p 8080:80 httpd 8d7db7b2c7a6fc03cd219d6d3c07f15261d8a12efda3be25fdb60576c91c1a7e [root@kvm ~]# curl 192.168.1.100:8080 \u0026lt;html\u0026gt;\u0026lt;body\u0026gt;\u0026lt;h1\u0026gt;It works!\u0026lt;/h1\u0026gt;\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; [root@kvm ~]# æ¯ä¸€ä¸ªæ˜ å°„çš„ç«¯å£ï¼Œhostéƒ½ä¼šå¯åŠ¨ä¸€ä¸ªdocker-proxyè¿›ç¨‹æ¥å¤„ç†è®¿é—®å®¹å™¨çš„æµé‡ã€‚\nä»¥0.0.0.0ï¼š32773-280/tcpä¸ºä¾‹åˆ†ææ•´ä¸ªè¿‡ç¨‹ ï¼ˆ1ï¼‰docker-proxyç›‘å¬hostçš„32773ç«¯å£ã€‚ ï¼ˆ2ï¼‰å½“curlè®¿é—®10.0.2.15ï¼š32773æ—¶ï¼Œdocker-proxyè½¬å‘ç»™å®¹å™¨172.170.2ï¼š80ã€‚ ï¼ˆ3ï¼‰httpdå®¹å™¨å“åº”è¯·æ±‚å¹¶è¿”å›ç»“æœã€‚ ","date":"2020-03-20T16:38:14Z","image":"https://www.ownit.top/title_pic/65.jpg","permalink":"https://www.ownit.top/p/202003201638/","title":"Dockerå®¹å™¨è®¿é—®å¤–éƒ¨ä¸–ç•Œ"},{"content":"IPé€šä¿¡ ä»å‰é¢çš„ä¾‹å­å¯ä»¥å¾—å‡ºè¿™æ ·ä¸€ä¸ªç»“è®ºï¼šä¸¤ä¸ªå®¹å™¨è¦èƒ½é€šä¿¡ï¼Œå¿…é¡»è¦æœ‰å±äºåŒä¸€ä¸ªç½‘ç»œçš„ç½‘å¡ã€‚æ»¡è¶³è¿™ä¸ªæ¡ä»¶åï¼Œå®¹å™¨å°±å¯ä»¥é€šè¿‡IPäº¤äº’äº†ã€‚å…·ä½“åšæ³•æ˜¯åœ¨å®¹å™¨åˆ›å»ºæ—¶é€šè¿‡-networkæŒ‡å®šç›¸åº”çš„ç½‘ç»œï¼Œæˆ–è€…é€šè¿‡docker network connectå°†ç°æœ‰å®¹å™¨åŠ å…¥åˆ°æŒ‡å®šç½‘ç»œã€‚å¯å‚è€ƒä¸Šä¸€èŠ‚\nDockerç½‘ç»œï¼ˆhostã€bridgeã€noneï¼‰è¯¦ç»†ä»‹ç»\nDocker DNS Server é€šè¿‡IPè®¿é—®å®¹å™¨è™½ç„¶æ»¡è¶³äº†é€šä¿¡çš„éœ€æ±‚ï¼Œä½†è¿˜æ˜¯ä¸å¤Ÿçµæ´»ã€‚å› ä¸ºåœ¨éƒ¨ç½²åº”ç”¨ä¹‹å‰å¯èƒ½æ— æ³•ç¡®å®šIPï¼Œéƒ¨ç½²ä¹‹åå†æŒ‡å®šè¦è®¿é—®çš„IPä¼šæ¯”è¾ƒéº»çƒ¦ã€‚å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥é€šè¿‡dockerè‡ªå¸¦çš„DNSæœåŠ¡è§£å†³ã€‚\nä»Docker 1.10ç‰ˆæœ¬å¼€å§‹ï¼Œdocker daemonå®ç°äº†ä¸€ä¸ªå†…åµŒçš„DNS serverï¼Œä½¿å®¹å™¨å¯ä»¥ç›´æ¥1é€šè¿‡â€œå®¹å™¨åâ€é€šä¿¡ã€‚æ–¹æ³•å¾ˆç®€å•ï¼Œåªè¦åœ¨å¯åŠ¨æ—¶ç”¨-nameä¸ºå®¹å™¨å‘½åå°±å¯ä»¥äº†ã€‚\n1 2 docker run -it --network=my_net2 --name=bbox1 busybox docker run -it --network=my_net2 --name=bbox2 busybox ç„¶åï¼Œbbox2å°±å¯ä»¥ç›´æ¥pingåˆ°bbox1äº†\nä½¿ç”¨docker DNSæœ‰ä¸ªé™åˆ¶ï¼šåªèƒ½åœ¨user-definedç½‘ç»œä¸­ä½¿ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤çš„bridgeç½‘ç»œæ˜¯æ— æ³•ä½¿ç”¨DNSçš„ã€‚\nä¸‹é¢éªŒè¯ä¸€ä¸‹ï¼šåˆ›å»ºbbox3å’Œbbox4ï¼Œå‡è¿æ¥åˆ°bridgeç½‘ç»œã€‚\n1 2 docker run -it --name=bbox3 busybox docker run -it --name=bbox4 busybox bbox4æ— æ³•pingåˆ°bbox3\nJoinedå®¹å™¨ joinedå®¹å™¨éå¸¸ç‰¹åˆ«ï¼Œå®ƒå¯ä»¥ä½¿ä¸¤ä¸ªæˆ–å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªç½‘ç»œæ ˆï¼Œå…±äº«ç½‘å¡å’Œé…ç½®ä¿¡æ¯ï¼Œjoinedå®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡127.0.01ç›´æ¥é€šä¿¡ã€‚\nè¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼šå…ˆåˆ›å»ºä¸€ä¸ªhttpdå®¹å™¨ï¼Œåå­—ä¸ºweb1ã€‚\n1 docker run -d -it --name=web1 =httpd ç„¶ååˆ›å»ºbusyboxå®¹å™¨å¹¶é€šè¿‡-network-container:weblæŒ‡å®šjoinedå®¹å™¨ä¸ºweblï¼Œ\n1 docker run -it --network=container:web1 busybox è¯·æ³¨æ„busyboxå™¨ä¸­ç½‘é…ç½®æ¯ï¼Œä¸‹é¢æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹weblçš„ç½‘ç»œï¼Œ\nçœ‹ï¼busyboxå’Œweblçš„ç½‘å¡macåœ°å€ä¸IPå®Œå…¨ä¸€æ ·ï¼Œå®ƒä»¬å…±äº«äº†ç›¸åŒçš„ç½‘ç»œæ ˆã€‚\nbusyboxå¯ä»¥ç›´æ¥ç”¨127.0.0.1è®¿é—®weblçš„httpæœåŠ¡\njoinedå®¹å™¨éå¸¸é€‚åˆä»¥ä¸‹åœºæ™¯ï¼š ä¸åŒå®¹å™¨ä¸­çš„ç¨‹åºå¸Œæœ›é€šè¿‡loopbacké«˜æ•ˆå¿«é€Ÿåœ°é€šä¿¡ï¼Œæ¯”å¦‚web Serverä¸App Server. å¸Œæœ›ç›‘æ§å…¶ä»–å®¹å™¨çš„ç½‘ç»œæµé‡ï¼Œæ¯”å¦‚è¿è¡Œåœ¨ç‹¬ç«‹å®¹å™¨ä¸­çš„ç½‘ç»œç›‘æ§ç¨‹åºã€‚ ","date":"2020-03-18T14:47:52Z","image":"https://www.ownit.top/title_pic/07.jpg","permalink":"https://www.ownit.top/p/202003181447/","title":"Dockerå®¹å™¨é—´é€šä¿¡"},{"content":"Dockerç½‘ç»œï¼ˆhostã€bridgeã€noneï¼‰ æˆ‘ä»¬ä¼šé¦–å…ˆå­¦ä¹ Dockeræä¾›çš„å‡ ç§åŸç”Ÿç½‘ç»œï¼Œä»¥åŠå¦‚ä½•åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œï¼›ç„¶åæ¢è®¨å®¹å™¨ä¹‹é—´å¦‚ä½•é€šä¿¡ï¼Œä»¥åŠå®¹å™¨ä¸å¤–ç•Œå¦‚ä½•äº¤äº’ã€‚\nDockerç½‘ç»œä»è¦†ç›–èŒƒå›´å¯åˆ†ä¸ºå•ä¸ªhostä¸Šçš„å®¹å™¨ç½‘ç»œå’Œè·¨å¤šä¸ªhostçš„ç½‘ç»œï¼Œæœ¬ç« é‡ç‚¹è®¨è®ºå‰ä¸€ç§ã€‚å¯¹äºæ›´ä¸ºå¤æ‚çš„å¤šhostå®¹å™¨ç½‘ç»œï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢è¿›é˜¶æŠ€æœ¯ç« èŠ‚å•ç‹¬è®¨è®ºã€‚\nDocker å®‰è£…æ—¶ä¼šè‡ªåŠ¨åœ¨host ä¸Šåˆ›å»ºä¸‰ä¸ªç½‘ç»œï¼Œæˆ‘ä»¬å¯ç”¨docker network lså‘½ä»¤æŸ¥çœ‹\n1 docker network ls noneç½‘ç»œ é¡¾åæ€ä¹‰ï¼Œnoneç½‘ç»œå°±æ˜¯ä»€ä¹ˆéƒ½æ²¡æœ‰çš„ç½‘ç»œã€‚æŒ‚åœ¨è¿™ä¸ªç½‘ç»œä¸‹çš„å®¹å™¨é™¤äº†1oï¼Œæ²¡æœ‰å…¶ä»–ä»»ä½•ç½‘å¡ã€‚å®¹å™¨åˆ›å»ºæ—¶ï¼Œå¯ä»¥é€šè¿‡-network=noneæŒ‡å®šä½¿ç”¨noneç½‘ç»œï¼Œå¦‚å›¾\n1 docker run -it --network=none busybox æˆ‘ä»¬ä¸ç¦ä¼šé—®ï¼Œè¿™æ ·ä¸€ä¸ªå°é—­çš„ç½‘ç»œæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ\nå…¶å®è¿˜çœŸæœ‰åº”ç”¨åœºæ™¯ã€‚å°é—­æ„å‘³ç€éš”ç¦»ï¼Œä¸€äº›å¯¹å®‰å…¨æ€§è¦æ±‚é«˜å¹¶ä¸”ä¸éœ€è¦è”ç½‘çš„åº”ç”¨å¯ä»¥ä½¿ç”¨noneç½‘ç»œã€‚\næ¯”å¦‚æŸä¸ªå®¹å™¨çš„å”¯ä¸€ç”¨é€”æ˜¯ç”Ÿæˆéšæœºå¯†ç ï¼Œå°±å¯ä»¥æ”¾åˆ°noneç½‘ç»œä¸­é¿å…å¯†ç è¢«çªƒå–ã€‚\nå½“ç„¶å¤§éƒ¨åˆ†å®¹å™¨æ˜¯éœ€è¦ç½‘ç»œçš„ï¼Œæˆ‘ä»¬æ¥ç€çœ‹hostç½‘ç»œã€‚\nhostç½‘ç»œ è¿æ¥åˆ°hostç½‘ç»œçš„å®¹å™¨å…±äº«Docker hostçš„ç½‘ç»œæ ˆï¼Œå®¹å™¨çš„ç½‘ç»œé…ç½®ä¸hostå®Œå…¨ä¸€æ ·ã€‚\nå¯ä»¥é€šè¿‡-network-host æŒ‡å®šä½¿ç”¨hostç½‘ç»œ\n1 docker run -it --network=host busybox åœ¨å®¹å™¨ä¸­å¯ä»¥çœ‹åˆ°hostçš„æ‰€æœ‰ç½‘å¡ï¼Œå¹¶ä¸”è¿hostmame ä¹Ÿæ˜¯hostçš„ã€‚hostç½‘ç»œçš„ä½¿ç”¨åœºæ™¯åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ ç›´æ¥ä½¿ç”¨Docker hostçš„ç½‘ç»œæœ€å¤§çš„å¥½å¤„å°±æ˜¯æ€§èƒ½ï¼Œå¦‚æœå®¹å™¨å¯¹ç½‘ç»œä¼ è¾“æ•ˆç‡æœ‰è¾ƒé«˜è¦æ±‚ï¼Œåˆ™å¯ä»¥é€‰æ‹©hostç½‘ç»œã€‚å½“ç„¶ä¸ä¾¿ä¹‹å¤„å°±æ˜¯ç‰ºç‰²ä¸€äº›çµæ´»æ€§ï¼Œæ¯”å¦‚è¦è€ƒè™‘ç«¯å£å†²çªé—®é¢˜ï¼ŒDocker host ä¸Šå·²ç»ä½¿ç”¨çš„ç«¯å£å°±ä¸èƒ½å†ç”¨äº†ã€‚\nDocker hostçš„å¦ä¸€ä¸ªç”¨é€”æ˜¯è®©å®¹å™¨å¯ä»¥ç›´æ¥é…ç½®hostç½‘è·¯ï¼Œæ¯”å¦‚æŸäº›è·¨hostçš„ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œå…¶æœ¬èº«ä¹Ÿæ˜¯ä»¥å®¹å™¨æ–¹å¼è¿è¡Œçš„ï¼Œè¿™äº›æ–¹æ¡ˆéœ€è¦å¯¹ç½‘ç»œè¿›è¡Œé…ç½®ï¼Œæ¯”å¦‚ç®¡ç†iptables\nbridgeç½‘ç»œ Dockerå®‰è£…æ—¶ä¼šåˆ›å»ºä¸€ä¸ªå‘½åä¸ºdocker0çš„Linux bridgeã€‚å¦‚æœä¸æŒ‡å®š-networkï¼Œåˆ›å»ºçš„å®¹å™¨é»˜è®¤éƒ½ä¼šæŒ‚åˆ°docker0ä¸Š\n1 brctl show å½“å‰docker0ä¸Šæ²¡æœ‰ä»»ä½•å…¶ä»–ç½‘ç»œè®¾å¤‡ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå®¹å™¨çœ‹çœ‹æœ‰ä»€ä¹ˆå˜åŒ–\nä¸€ä¸ªæ–°çš„ç½‘ç»œæ¥å£vethb56e98cè¢«æŒ‚åˆ°äº†docker0ä¸Šï¼Œvethb56e98cå°±æ˜¯æ–°åˆ›å»ºå®¹å™¨çš„è™šæ‹Ÿç½‘å¡ã€‚\nä¸‹é¢çœ‹ä¸€ä¸‹å®¹å™¨çš„ç½‘ç»œé…ç½®\nå®¹å™¨æœ‰ä¸€ä¸ªç½‘å¡eth0@if34ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯vethb56e98cå‘¢ï¼Ÿ\nå®é™…ä¸Šeth0@if34 å’Œveth28c57df æ˜¯ä¸€å¯¹veth pairã€‚ veth pair æ˜¯ä¸€ç§æˆå¯¹å‡ºç°çš„ç‰¹æ®Šç½‘ç»œè®¾å¤‡ï¼Œå¯ä»¥æŠŠå®ƒä»¬æƒ³è±¡æˆç”±ä¸€æ ¹è™šæ‹Ÿç½‘çº¿è¿æ¥èµ·æ¥çš„ä¸€å¯¹ç½‘å¡ï¼Œ ç½‘å¡çš„ä¸€å¤´(eth0@if34) åœ¨å®¹å™¨ä¸­ï¼Œå¦ä¸€å¤´(veth28c57df) æŒ‚åœ¨ç½‘æ¡¥docker0 ä¸Šï¼Œå…¶æ•ˆæœå°±æ˜¯å°†eth0@if34 ä¹ŸæŒ‚åœ¨äº†docker0ä¸Šã€‚\næˆ‘ä»¬è¿˜çœ‹åˆ°eth0@if34 å·²ç»é…ç½®äº†IP 172.17.0.2ï¼Œ ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªç½‘æ®µå‘¢?è®©æˆ‘ä»¬é€šè¿‡docker network inspect bridgeçœ‹- -ä¸‹bridge ç½‘ç»œçš„é…ç½®ä¿¡æ¯\nåŸæ¥bridge ç½‘ç»œé…ç½®çš„subnet å°±æ˜¯172.17.0.0/16, å¹¶ä¸”ç½‘å…³æ˜¯172.17.0.1. è¿™ä¸ªç½‘å…³åœ¨å“ªå„¿å‘¢?å¤§æ¦‚ä½ å·²ç»çŒœå‡ºæ¥äº†ï¼Œå°±æ˜¯docker0\nå®¹å™¨ç½‘ç»œæ‹“æ‰‘å›¾\nå®¹å™¨åˆ›å»ºæ—¶ï¼Œdocker ä¼šè‡ªåŠ¨ä»172.17.0.0/16 ä¸­åˆ†é…-ä¸ªIP,è¿™é‡Œ16 ä½çš„æ©ç ä¿è¯æœ‰è¶³å¤Ÿå¤šçš„IPå¯ä»¥ä¾›å®¹å™¨ä½¿ç”¨ã€‚\nuser-definedç½‘ç»œ é™¤äº†noneã€hostã€bridgeè¿™ä¸‰ä¸ªè‡ªåŠ¨åˆ›å»ºçš„ç½‘ç»œï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦åˆ›å»ºuser-definedç½‘ç»œã€‚\nDockeræä¾›ä¸‰ç§user-defined ç½‘ç»œé©±åŠ¨ï¼šbridgeã€overlay å’Œmacvlanã€‚overlay å’Œmacvlanç”¨äºåˆ›å»ºè·¨ä¸»æœºçš„ç½‘ç»œ\næˆ‘ä»¬å¯é€šè¿‡bridge é©±åŠ¨åˆ›å»ºç±»ä¼¼å‰é¢é»˜è®¤çš„bridge ç½‘ç»œ\n1 docker network create --driver bridge my_net 1 2 3 4 5 6 7 [root@kvm ~]# docker network create --driver bridge my_net 7428a4d14c67b44be3a7184a5a065303d3688b5b13883526989b7173af881170 [root@kvm ~]# brctl show bridge name\tbridge id\tSTP enabled\tinterfaces br-7428a4d14c67\t8000.024221339eb6\tno\tdocker0\t8000.024280532eb0\tno\tveth6281a8d virbr0\t8000.52540015904b\tyes\tvirbr0-nic æ–°å¢äº†ä¸€ä¸ªç½‘æ¡¥br-7428a4d14c67ï¼Œè¿™é‡Œ7428a4d14c67æ­£å¥½æ˜¯æ–°å»ºbridgeç½‘ç»œmy_netçš„çŸ­idã€‚æ‰§è¡Œdocker network inspectæŸ¥çœ‹ä¸€ä¸‹my_netçš„é…ç½®ä¿¡æ¯ï¼Œ\nè¿™é‡Œ172.18.0.0/16æ˜¯Dockerè‡ªåŠ¨åˆ†é…çš„IPç½‘æ®µã€‚\næˆ‘ä»¬å¯ä»¥è‡ªå·±æŒ‡å®šIPç½‘æ®µå—ï¼Ÿ\nç­”æ¡ˆæ˜¯ï¼šå¯ä»¥ã€‚\nåªéœ€åœ¨åˆ›å»ºç½‘æ®µæ—¶æŒ‡å®š\u0026ndash;subnetå’Œ-gatewayå‚æ•°\n1 docker network create --driver bridge --subnet 172.22.16.0/24 --gateway 172.22.16.1 my_net2 è¿™é‡Œæˆ‘ä»¬åˆ›å»ºäº†æ–°çš„bridgeç½‘ç»œmy_net2ï¼Œç½‘æ®µä¸º172.22.16.0/24ï¼Œç½‘å…³ä¸º172.22.16.1ä¸å‰é¢ä¸€æ ·ï¼Œç½‘å…³åœ¨my net2å¯¹åº”çš„ç½‘æ¡¥br-5d863e9778b6ä¸Š\nå®¹å™¨è¦ä½¿ç”¨æ–°çš„ç½‘ç»œï¼Œéœ€è¦åœ¨å¯åŠ¨æ—¶é€šè¿‡\u0026ndash;networkæŒ‡å®š\n1 docker run -it --network=my_net2 busybox å®¹å™¨åˆ†é…åˆ°çš„IPä¸º172.22.16.20åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå®¹å™¨çš„IPéƒ½æ˜¯dockerè‡ªåŠ¨ä»subnetä¸­åˆ†é…ï¼Œæˆ‘ä»¬èƒ½å¦æŒ‡å®šä¸€ä¸ªé™æ€IPå‘¢ï¼Ÿ\nç­”æ¡ˆæ˜¯ï¼šå¯ä»¥ï¼Œé€šè¿‡-pæŒ‡å®š\n1 docker run -it --network=my_net2 --ip 172.22.16.8 busybox å¥½äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å½“å‰docker hostçš„ç½‘ç»œæ‹“æ‰‘ç»“æ„ ä¸¤ä¸ªbusyboxå®¹å™¨éƒ½æŒ‚åœ¨mynet2ä¸Šï¼Œåº”è¯¥èƒ½å¤Ÿäº’é€š\nå¯è§åŒä¸€ç½‘ç»œä¸­çš„å®¹å™¨ã€ç½‘å…³ä¹‹é—´éƒ½æ˜¯å¯ä»¥é€šä¿¡çš„ã€‚\nmy_net2ä¸é»˜è®¤bridgeç½‘ç»œèƒ½é€šä¿¡å—ï¼Ÿ\nä»æ‹“æ‰‘å›¾å¯çŸ¥ï¼Œä¸¤ä¸ªç½‘ç»œå±äºä¸åŒçš„ç½‘æ¡¥ï¼Œåº”è¯¥ä¸èƒ½é€šä¿¡ï¼Œæˆ‘ä»¬é€šè¿‡å®éªŒéªŒè¯ä¸€ä¸‹ï¼Œè®©busyboxå®¹å™¨ping ä¸åŒç½‘æ®µå®¹å™¨\nç¡®å® pingä¸é€šï¼Œç¬¦åˆé¢„æœŸã€‚\nâ€œç­‰ç­‰ï¼ä¸åŒçš„ç½‘ç»œå¦‚æœåŠ ä¸Šè·¯ç”±åº”è¯¥å°±å¯ä»¥é€šä¿¡äº†å§ï¼Ÿâ€æˆ‘å·²ç»å¬åˆ°æœ‰è¯»è€…åœ¨å»ºè®®äº†è¿™æ˜¯ä¸€ä¸ªéå¸¸éå¸¸å¥½çš„æƒ³æ³•ã€‚\nç¡®å®ï¼Œå¦‚æœhostä¸Šå¯¹æ¯ä¸ªç½‘ç»œéƒ½æœ‰ä¸€æ¡è·¯ç”±ï¼ŒåŒæ—¶æ“ä½œç³»ç»Ÿä¸Šæ‰“å¼€äº†ip forwardingï¼Œhostå°±æˆäº†ä¸€ä¸ªè·¯ç”±å™¨ï¼ŒæŒ‚æ¥åœ¨ä¸åŒç½‘æ¡¥ä¸Šçš„ç½‘ç»œå°±èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹docker hostæ˜¯å¦æ»¡è¶³è¿™äº›æ¡ä»¶å‘¢ï¼Ÿ\nip ræŸ¥çœ‹hostä¸Šçš„è·¯ç”±è¡¨ï¼š\n172.17.0.0/16å’Œ172.22.16.0/24ä¸¤ä¸ªç½‘ç»œçš„è·¯ç”±éƒ½å®šä¹‰å¥½äº†ã€‚å†çœ‹çœ‹ip forwardingï¼š\n1 2 [root@kvm ~]# sysctl net.ipv4.ip_forward net.ipv4.ip_forward = 1 ip forwardingä¹Ÿå·²ç»å¯ç”¨äº†ã€‚æ¡ä»¶éƒ½æ»¡è¶³ï¼Œä¸ºä»€ä¹ˆä¸èƒ½é€šè¡Œå‘¢ï¼Ÿ\næˆ‘ä»¬è¿˜å¾—çœ‹çœ‹iptablesï¼š\n1 2 3 4 iptavles-save -A DOCKER-ISOLATION -i br-13ceb40bd8e8 -o docker0 -j DROP -A DOCKER-ISOLATION -i docker0 -o br-13ceb40bd8e8 -j DROP åŸå› å°±åœ¨è¿™é‡Œäº†ï¼šiptables DROPæ‰äº†ç½‘æ¡¥dockeroä¸br-13ceb40bd8e8ä¹‹é—´åŒå‘çš„æµé‡ã€‚\nä»è§„åˆ™çš„å‘½åDOCKER-ISOLATIONå¯çŸ¥dockeråœ¨è®¾è®¡ä¸Šå°±æ˜¯è¦éš”ç¦»ä¸åŒçš„netwrok\né‚£ä¹ˆæ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼šæ€æ ·æ‰èƒ½è®©busyboxä¸httpd é€šä¿¡å‘¢ï¼Ÿ\nç­”æ¡ˆæ˜¯ï¼šä¸ºhttpdå®¹å™¨æ·»åŠ ä¸€å—net_my2çš„ç½‘å¡ã€‚è¿™ä¸ªå¯ä»¥é€šè¿‡docker network connectå‘½ä»¤å®ç°ï¼Œ\n1 docker network connect my_net2 655643ea6894 æˆ‘ä»¬åœ¨docker0ç½‘æ®µå™¨ä¸­æŸ¥çœ‹ä¸€ä¸‹ç½‘ç»œé…ç½®\nå®¹å™¨ä¸­å¢åŠ äº†ä¸€ä¸ªç½‘å¡ethlï¼Œåˆ†é…äº†my_net2çš„IP 172.22.16.3ã€‚ç°åœ¨busyboxåº”è¯¥èƒ½å¤Ÿè®¿é—®docker0ç½‘æ®µäº†ï¼ŒéªŒè¯ä¸€ä¸‹\nbusyboxèƒ½å¤Ÿpingåˆ°httpdï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®httpdçš„WebæœåŠ¡æ‰€ç¤ºã€‚\nï¼ˆå› ä¸ºè¿™é‡Œæˆ‘åœ¨docker0ç½‘æ®µï¼Œç”¨busyboxä»£æ›¿çš„httpdï¼‰\nå­¦ä¹ äº†Dockerå„ç§ç±»å‹ç½‘ç»œä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è®¨è®ºå®¹å™¨ä¸å®¹å™¨ã€å®¹å™¨ä¸å¤–ç•Œçš„è¿é€šé—®é¢˜\n","date":"2020-03-17T11:35:03Z","image":"https://www.ownit.top/title_pic/24.jpg","permalink":"https://www.ownit.top/p/202003171135/","title":"Dockerç½‘ç»œï¼ˆhostã€bridgeã€noneï¼‰è¯¦ç»†ä»‹ç»"},{"content":"**ä¸€ä¸ªdocker host. ä¸Šä¼šè¿è¡Œè‹¥å¹²å®¹å™¨ï¼Œæ¯ä¸ªå®¹å™¨éƒ½éœ€è¦CPUã€å†…å­˜å’ŒI0èµ„æºã€‚å¯¹äºKVMã€VMware ç­‰è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œç”¨æˆ·å¯ä»¥æ§åˆ¶åˆ†é…å¤šå°‘CPUã€å†…å­˜èµ„æºç»™æ¯ä¸ªè™šæ‹Ÿæœºã€‚å¯¹äºå®¹å™¨ï¼ŒDocker ä¹Ÿæä¾›äº†ç±»ä¼¼çš„æœºåˆ¶é¿å…æŸä¸ªå®¹å™¨å› å ç”¨å¤ªå¤šèµ„æºè€Œå½±å“å…¶ä»–å®¹å™¨ä¹ƒè‡³æ•´ä¸ªhost çš„æ€§èƒ½ã€‚**\nå†…å­˜é™é¢ ä¸æ“ä½œç³»ç»Ÿç±»ä¼¼ï¼Œå®¹å™¨å¯ä»¥ä½¿ç”¨çš„å†…å­˜åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šç‰©ç†å†…å­˜å’ŒSwapã€‚\nDockeré€šè¿‡ä¸‹é¢ä¸¤ç»„å‚æ•°æ¥æ§åˆ¶å®¹å™¨å†…å­˜çš„ä½¿ç”¨é‡\nï¼ˆ1ï¼‰-m æˆ– --memory ï¼šè®¾ç½®å†…å­˜çš„ä½¿ç”¨é™é¢ï¼Œä¾‹å¦‚100MBï¼Œ2GB\nï¼ˆ2ï¼‰\u0026ndash;memory-swapï¼šè®¾ç½®å†…å­˜+swawpçš„ä½¿ç”¨é™é¢\nå½“æˆ‘ä»¬æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤æ—¶\n1 docker run -m 200M --memory-swap=300M ubuntu å…¶å«ä¹‰æ˜¯å…è®¸è¯¥å®¹å™¨æœ€å¤šä½¿ç”¨200MBçš„å†…å­˜å’Œ100MB çš„swapã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸Šé¢ä¸¤ç»„å‚æ•°ä¸º-1, å³å¯¹å®¹å™¨å†…å­˜å’Œswapçš„ä½¿ç”¨æ²¡æœ‰é™åˆ¶ã€‚\nä¸‹é¢æˆ‘ä»¬å°†ä½¿ç”¨progrium/stress é•œåƒæ¥å­¦ä¹ å¦‚ä½•ä¸ºå®¹å™¨åˆ†é…å†…å­˜ã€‚è¯¥é•œåƒå¯ç”¨äºå¯¹å®¹å™¨æ‰§è¡Œå‹åŠ›æµ‹è¯•ã€‚æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤:\n1 docker run -it -m 200M --memory-swap=300M progrium/stress --vm 1 --vm-bytes 208M --vm1:å¯åŠ¨1ä¸ªå†…å­˜å·¥ä½œçº¿ç¨‹ã€‚ --vm-bytes 280M:æ¯ä¸ªçº¿ç¨‹åˆ†é…280MBå†…å­˜ã€‚ è¿è¡Œå¦‚ä¸‹å›¾ç»“æœ\nå› ä¸º280MBåœ¨å¯åˆ†é…çš„èŒƒå›´(300MB) å†…ï¼Œæ‰€ä»¥å·¥ä½œçº¿ç¨‹èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œå…¶è¿‡ç¨‹æ˜¯:\n(1)åˆ†é…280MBå†…å­˜ã€‚\n(2)é‡Šæ”¾280MBå†…å­˜ã€‚\n(3)å†åˆ†é…280MBå†…å­˜ã€‚\n(4)å†é‡Šæ”¾280MBå†…å­˜ã€‚\n(5)ä¸€-ç›´å¾ªç¯\u0026hellip;..\nå¦‚æœè®©å·¥ä½œçº¿ç¨‹åˆ†é…çš„å†…å­˜è¶…è¿‡300MB,ç»“æœå¦‚å›¾\n1 docker run -it -m 200M --memory-swap=300M progrium/stress --vm 1 --vm-bytes 310M åˆ†é…çš„å†…å­˜è¶…è¿‡é™é¢ï¼Œstress çº¿ç¨‹æŠ¥é”™ï¼Œå®¹å™¨é€€å‡ºã€‚\nå¦‚æœåœ¨å¯åŠ¨å®¹å™¨æ—¶åªæŒ‡å®š-mè€Œä¸æŒ‡å®š-memoryswap, é‚£ä¹ˆ-memory-swap é»˜è®¤ä¸º-mçš„ä¸¤å€ï¼Œæ¯”å¦‚:\n1 docker run -it -m 200M ubuntu å®¹å™¨æœ€å¤šä½¿ç”¨200Mç»’é‡Œå†…å­˜å’Œ200swap\nCPUé™é¢ é»˜è®¤è®¾ç½®ä¸‹ï¼Œæ‰€æœ‰å®¹å™¨å¯ä»¥å¹³ç­‰åœ°ä½¿ç”¨host CPUèµ„æºå¹¶ä¸”æ²¡æœ‰é™åˆ¶ã€‚\nDockerå¯ä»¥é€šè¿‡-cæˆ–-pu-sharesè®¾ç½®å®¹å™¨ä½¿ç”¨CPUçš„æƒé‡ã€‚å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤å€¼ä¸º1024ã€‚\nä¸å†…å­˜é™é¢ä¸åŒï¼Œé€šè¿‡-cè®¾ç½®çš„cpu share å¹¶ä¸æ˜¯CPUèµ„æºçš„ç»å¯¹æ•°é‡ï¼Œè€Œæ˜¯ä¸€ä¸ªç›¸å¯¹çš„æƒé‡å€¼ã€‚æŸä¸ªå®¹å™¨æœ€ç»ˆèƒ½åˆ†é…åˆ°çš„CPUèµ„æºå–å†³äºå®ƒçš„cpu shareå æ‰€æœ‰å®¹å™¨cpu shareæ€»å’Œçš„æ¯”ä¾‹ã€‚\næ¢å¥è¯è¯´:é€šè¿‡cpu shareå¯ä»¥è®¾ç½®å®¹å™¨ä½¿ç”¨CPUçš„ä¼˜å…ˆçº§ã€‚\næ¯”å¦‚åœ¨hostä¸­å¯åŠ¨äº†ä¸¤ä¸ªå®¹å™¨:\n1 docker run --name \u0026#34;cont_A\u0026#34; -c 1024 ubuntu docker run --name \u0026#34;cont_B\u0026#34; -c 512 ubuntu containerAçš„cpu share 1024ï¼Œ æ˜¯containerB çš„ä¸¤å€ã€‚å½“ä¸¤ä¸ªå®¹å™¨éƒ½éœ€è¦CPUèµ„æºæ—¶ï¼ŒcontainerAå¯ä»¥å¾—åˆ°çš„CPUæ˜¯containerB çš„ä¸¤å€ã€‚\néœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æŒ‰æƒé‡åˆ†é…CPUåªä¼šå‘ç”Ÿåœ¨CPUèµ„æºç´§å¼ çš„æƒ…å†µä¸‹ã€‚å¦‚æœcontainerAå¤„äºç©ºé—²çŠ¶æ€ï¼Œè¿™æ—¶ï¼Œä¸ºäº†å……åˆ†åˆ©ç”¨CPUèµ„æºï¼ŒcontainerB ä¹Ÿå¯ä»¥åˆ†é…åˆ°å…¨éƒ¨å¯ç”¨çš„CPU.\nä¸‹é¢æˆ‘ä»¬ç»§ç»­ç”¨progrium/stress åšå®éªŒã€‚\n(1)å¯åŠ¨(container_ A, cpu shareä¸º1024\n1 docker run --name \u0026#34;cont_A\u0026#34; -it -c 1024 progrium/stress --cpu 1 --cpuç”¨æ¥è®¾ç½®å·¥ä½œçº¿ç¨‹çš„æ•°é‡ã€‚å› ä¸ºå½“å‰host åªæœ‰1é¢—CPU,æ‰€ä»¥ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å°±èƒ½å°†CPUå‹æ»¡ã€‚å¦‚æœhostæœ‰å¤šé¢—CPU,åˆ™éœ€è¦ç›¸åº”å¢åŠ \u0026ndash;cpuçš„æ•°é‡ã€‚\n(2)å¯åŠ¨(container_B, cpu shareä¸º512 1 docker run --name \u0026#34;cont_B\u0026#34; -it -c 512 progrium/stress --cpu 1 (3)åœ¨hostä¸­æ‰§è¡Œtop, æŸ¥çœ‹å®¹å™¨å¯¹CPUçš„ä½¿ç”¨æƒ…å†µï¼Œ 1 ps aux|head -1;ps aux|sort -k3nr |head -4 containerAæ¶ˆè€—çš„CPUæ˜¯containerB çš„ä¸¤å€ã€‚ (4)ç°åœ¨æš‚åœcontainer. A (5) top æ˜¾ç¤ºcontainerBåœ¨containerAç©ºé—²çš„æƒ…å†µä¸‹èƒ½å¤Ÿç”¨æ»¡æ•´é¢—CPU Block IO å¸¦å®½é™é¢ Block 10æ˜¯å¦ä¸€ç§å¯ä»¥é™åˆ¶å®¹å™¨ä½¿ç”¨çš„èµ„æºã€‚Block I0æŒ‡çš„æ˜¯ç£ç›˜çš„è¯»å†™ï¼Œdocker å¯é€šè¿‡è®¾ç½®æƒé‡ã€é™åˆ¶bpså’Œiops çš„æ–¹å¼æ§åˆ¶å®¹å™¨è¯»å†™ç£ç›˜çš„å¸¦å®½ï¼Œä¸‹ é¢åˆ†åˆ«è®¨è®ºã€‚\næ³¨:ç›®å‰Block I0é™é¢åªå¯¹direct IO (ä¸ä½¿ç”¨æ–‡ä»¶ç¼“å­˜)æœ‰æ•ˆã€‚\nBlock IOæƒé‡\né»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å®¹å™¨èƒ½å¹³ç­‰åœ°è¯»å†™ç£ç›˜ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®**-blkio-weight**å‚æ•°æ¥æ”¹å˜å®¹å™¨block Ioçš„ä¼˜å…ˆçº§ã€‚\n-blkio-weightä¸\u0026ndash;cpu-shares ç±»ä¼¼ï¼Œè®¾ç½®çš„æ˜¯ç›¸å¯¹æƒé‡å€¼ï¼Œé»˜è®¤ä¸º500ã€‚ åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼ŒcontainerA è¯»å†™ç£ç›˜çš„å¸¦å®½æ˜¯containerB çš„ä¸¤å€ã€‚\n1 2 docker run -it --name cont_A --blkip-weight 600 ubuntu docker run -it --name cont_B --blkip-weight 300 ubuntu é™åˆ¶bpså’Œiops bpsæ˜¯ byte per second ï¼Œæ¯ç§’è¯»å†™çš„æ•°é‡\niopsæ˜¯ io per second ï¼Œæ¯ç§’IOçš„æ¬¡æ•°\nå¯ä»¥åŒè¿‡ä¸‹é¢çš„å‚æ•°æ§åˆ¶å®¹å™¨çš„bpså’Œiopsï¼›\n--device-read-bps:é™åˆ¶è¯»æŸä¸ªè®¾å¤‡çš„bps. --devce-write-bps:é™åˆ¶å†™æŸä¸ªè®¾å¤‡çš„bps. --device- read-iops:é™åˆ¶è¯»æŸä¸ªè®¾å¤‡çš„iops. --device-write-iops: é™åˆ¶å†™æŸä¸ªè®¾å¤‡çš„iopsã€‚\nä¸‹é¢è¿™ä¸ªä¾‹å­é™åˆ¶å®¹å™¨å†™/dev/sda çš„é€Ÿç‡ä¸º30 MB/s:\n1 2 3 4 5 6 7 8 9 10 [root@kvm ~]# docker run -it --device-write-bps /dev/sda:30MB ubuntu root@10845a98036e:/# time dd if=/dev/zero of=test.out bs=1M count=800 oflag=direct 800+0 records in 800+0 records out 838860800 bytes (839 MB, 800 MiB) copied, 26.6211 s, 31.5 MB/s real\t0m26.623s user\t0m0.000s sys\t0m0.106s root@10845a98036e:/# 1 docker run -it --device-write-bps /dev/sda:30MB ubuntu æœ‰é™åˆ¶\næ²¡æœ‰é™åˆ¶\né€šè¿‡ddæµ‹è¯•åœ¨å®¹å™¨ä¸­å†™ç£ç›˜çš„é€Ÿåº¦ã€‚å› ä¸ºå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯åœ¨host /dev/sda. ä¸Šçš„ï¼Œåœ¨å®¹å™¨ä¸­å†™æ–‡ä»¶ç›¸å½“äºå¯¹host /dev/sda è¿›è¡Œå†™æ“ä½œã€‚å¦å¤–ï¼Œoflag= -directæŒ‡å®šç”¨direct I0æ–¹å¼å†™æ–‡ä»¶ï¼Œè¿™æ ·\u0026ndash;device-write-bpsæ‰èƒ½ç”Ÿæ•ˆã€‚\nçœ‹åˆ°ï¼Œæ²¡æœ‰é™é€Ÿçš„è¯ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œ\nå…¶ä»–å‚æ•°ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥è¯•è¯•\n","date":"2020-03-16T17:43:53Z","image":"https://www.ownit.top/title_pic/11.jpg","permalink":"https://www.ownit.top/p/202003161743/","title":"Dockerçš„èµ„æºé™åˆ¶ï¼ˆå†…å­˜ã€CPUã€IOï¼‰è¯¦ç»†ç¯‡"},{"content":"linuxçš„ç£ç›˜å®¹é‡æ‰©å®¹ï¼ŒåŸºäºlvmï¼Œå³é€»è¾‘å·ç®¡ç†ã€‚å…·ä½“æ˜¯ä»€ä¹ˆè¯·ç™¾åº¦ï¼Œè¿™é‡Œä¸ç»†è¿°ã€‚\næ­¤æ¬¡æ“ä½œçš„ç›®çš„æ˜¯ä¸ºäº†ç»™å·²å­˜åœ¨çš„linuxä¸»æœºçš„å…¶ä¸­ä¸€ä¸ªæ•°æ®åˆ†åŒºæ‰©å®¹ã€‚\nç¯å¢ƒï¼šesxi6.5Â è™šæ‹Ÿæœºç³»ç»Ÿcentos7\nç®€å•æ¥è¯´ï¼Œæ‰©å®¹è¿™ä»¶äº‹åˆ†ä¸‰æ­¥\nä¸€ã€ä»esxiä¸­ä¸ºæ­¤è™šæ‹Ÿæœºå¢åŠ ç¡¬ç›˜ï¼Œå¹¶è®©centosç³»ç»Ÿè¯†åˆ«å‡ºæ­¤ç¡¬ç›˜\näºŒã€å°†æ­¤ç¡¬ç›˜è¿›è¡Œåˆ†åŒºã€æ ¼å¼åŒ–ï¼ˆé‡ç‚¹æ˜¯è¿™é‡Œçš„åˆ†åŒºä¸æ˜¯ç±»ä¼¼äºwindowsï¼Œåˆ†å®Œå°±èƒ½ç”¨äº†ï¼Œè€Œå®ƒéœ€è¦ä¸€ä¸ªæŒ‚è½½çš„è¿‡ç¨‹ï¼Œè¦ä¹ˆå•ç‹¬æŒ‚è½½ï¼Œè¦ä¹ˆåŠ å…¥lvmæŒ‚è½½ï¼Œå¦åˆ™åœ¨linuxä¸­æ˜¯æ— æ³•è®¿é—®çš„ï¼‰\nä¸‰ã€å·ç»„ç®¡ç†\n1ã€å°†åˆ†å¥½åŒºçš„ç¡¬ç›˜åˆ›å»ºä¸ºç‰©ç†å· 2ã€å°†æ­¤ç‰©å·ç›´æ¥è¿›è¡ŒæŒ‚è½½åˆ°æ–‡ä»¶ç³»ç»Ÿ 3ã€æˆ–å°†æ­¤ç‰©ç†å·åŠ å…¥åˆ°lvmå·ç»„ä¸­ 4ã€å¯¹åŠ å…¥åˆ°å·ç»„çš„ç©ºé—´è¿›è¡Œé€»è¾‘å·æ‰©å®¹æˆ–æ˜¯åˆ›å»ºä¸ºé€»è¾‘å·å†è¿›è¡Œæ‰©å®¹ç­‰æ“ä½œ ä»¥ä¸‹æ˜¯æœ¬æ¬¡æ“ä½œçš„è¿‡ç¨‹è®°å½•\n1ã€é¦–å…ˆçœ‹ä¸€ä¸‹æœªæ·»åŠ ç¡¬ç›˜å‰çš„ç³»ç»Ÿç£ç›˜çŠ¶æ€ï¼Œ 2ã€åœ¨esxiä¸­æ·»åŠ ç¡¬ç›˜çš„è¿‡ç¨‹å°±ä¸è¯´äº†ï¼Œæ·»åŠ è¿‡ç¡¬ç›˜ï¼Œéœ€è¦å¯¹scsiæ¥å£è¿›è¡Œæ‰«æï¼Œå°±ç›¸å½“äºæ‰«ææ–°ç¡¬ä»¶ ç«¯å£å¤ªå¤šï¼Œä¸€ä¸ªä¸ªæ‰«æå¤ªæ…¢ï¼Œæˆ‘å°±å†™ä¸ªç®€å•è„šæœ¬æ‰§è¡Œã€‚ 1 ls | sort \u0026gt; /opt/host.txt æ‰¹é‡æ‰«æè„šæœ¬ 1 2 3 4 5 6 7 8 9 #!/bin/bash DIR=\u0026#34;/sys/class/scsi_host/\u0026#34; for i in `cat host.txt` do echo \u0026#34;- - -\u0026#34; \u0026gt; $DIR$i/scan echo $DIR$i/scan done rm -rf /opt/host.txt è¿è¡Œè„šæœ¬ 1 2 3 4 5 [root@kvm opt]# ls backup host.sh host.txt rh [root@kvm opt]# pwd /opt [root@kvm opt]# bash host.sh 3ã€å¯ä»¥çœ‹åˆ°æ–°åŠ çš„10Gç¡¬ç›˜å·²ç»è¢«è¯†åˆ«ä¸º/dev/sdb 4ã€æŸ¥çœ‹ä¸€ä¸‹scsiçš„çŠ¶æ€ï¼Œä»¥ä¸Šéƒ½æ˜¯å‡†å¤‡å·¥ä½œï¼ŒçŠ¶æ€éƒ½å¯¹ï¼Œåé¢æ“ä½œå°±å®¹æ˜“ 1 cat /proc/scsi/scsi 5ã€å¯¹æ–°ç¡¬ç›˜è¿›è¡Œåˆ†åŒºï¼Œæ­¤å¤„æ˜¯æ–°å»ºäº†ä¸€ä¸ªä¸»åˆ†åŒºï¼Œé»˜è®¤idä¸º1ï¼Œæ‰€ä»¥åˆ†å¥½åå°±æ˜¯sdb1 6ã€æˆ‘ä»¬çš„ç›®çš„æ˜¯ä¸ºäº†ç”¨lvmè¿›è¡Œç®¡ç†ï¼Œæ‰€ä»¥åœ¨åˆ†å®ŒåŒºåï¼Œè¦å°†åˆ†åŒºå±æ€§æ ‡è®°ä¸ºlvmçš„8e 7ã€åˆ†å®Œåå¯ä»¥çœ‹åˆ°åˆ†åŒºä¿¡æ¯ï¼Œ/dev/sdb1çš„8e,ç„¶åé‡è¯»ä¸€ä¸‹åˆ†åŒºè¡¨ï¼Œåˆ·æ–° å·²ç»åˆ†åŒºæˆåŠŸäº†\n8ã€ä¸Šé¢åˆ†å®ŒåŒºï¼Œä¸‹é¢å½“ç„¶å°±æ˜¯åŠ å…¥å·äº†ï¼Œå…ˆæŠŠsdb1åšæˆä¸€ä¸ªæ–°çš„ç‰©ç†å· 9ã€ç”¨vgdisplayæŸ¥çœ‹ä¸€ä¸‹å·ç»„çš„çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°åŸå…ˆcentosç»„é‡Œé¢æ²¡æœ‰ç©ºä½™ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦åšçš„å°±æ˜¯æŠŠåˆšåŠ çš„ç£ç›˜ï¼Œåˆšåˆ†å¥½çš„åŒºï¼Œç„¶ååˆšåˆ›å»ºæˆçš„ç‰©ç†å·åŠ å…¥åˆ°è¿™ä¸ªcentosç»„é‡Œå»ï¼ŒåŠ è¿›ç»„æ‰èƒ½åœ¨ç»„é‡Œè¿›è¡Œåˆ†é…å˜›ã€‚æ‰€ä»¥vgextend centos /dev/sdb1,åŠ å®Œå†çœ‹vgdisplayï¼Œç©ºä½™ç©ºé—´ä¸º10Gï¼Œå¾ˆæ˜æ˜¾ï¼Œæ–°åŠ çš„ç£ç›˜å·²å¤„ç†å¾…åˆ†é…çŠ¶æ€ 1 2 [root@kvm dev]# vgextend centos_kvm /dev/sdb1 Volume group \u0026#34;centos_kvm\u0026#34; successfully extended 10ã€æœ€åå°±æ˜¯å‰‘æŒ‡é»„é¾™ï¼Œæˆ‘è¦ç»™varè¿›è¡Œæ‰©å®¹ï¼Œlvresize -L +10G /dev/centos/var 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 [root@kvm centos_kvm]# lvresize -L +20G /dev/centos_kvm/root Size of logical volume centos_kvm/root changed from \u0026lt;26.00 GiB (6655 extents) to \u0026lt;46.00 GiB (11775 extents). Logical volume centos_kvm/root successfully resized. [root@kvm centos_kvm]# vgdisplay --- Volume group --- VG Name centos_kvm System ID Format lvm2 Metadata Areas 2 Metadata Sequence No 5 VG Access read/write VG Status resizable MAX LV 0 Cur LV 2 Open LV 2 Max PV 0 Cur PV 2 Act PV 2 VG Size 128.99 GiB PE Size 4.00 MiB Total PE 33022 Alloc PE / Size 12543 / \u0026lt;49.00 GiB Free PE / Size 20479 / \u0026lt;80.00 GiB VG UUID K35BzQ-nhXT-zFsf-W1kp-T9iq-kcFx-hfTdTN 11ã€ä¸Šé¢é‚£ä¸€æ­¥ä¸ç®—å®Œï¼Œè®°å¾—ä¸ï¼Œä¹‹å‰æˆ‘è™½ç„¶åˆ†åŒºäº†ï¼Œåˆ›å»ºå·äº†ï¼ŒåŠ å…¥å·ç»„ï¼Œä½†å®é™…ä¸Šæˆ‘æ²¡æ ¼å¼åŒ–ã€‚é‚£ä¹ˆOKï¼Œè¿™é‡Œç”¨xfs_growfs /dev/centos/varé‡æ–°è¯†åˆ«ä¸€ä¸‹æ–°å·çš„å®¹é‡ï¼Œæ˜¯æ‰©å®¹åçš„å“¦ï¼Œæ‰©å®¹æ—¶åŠ ä¸Šçš„æ–°ç£ç›˜ä¹Ÿå°±åŒæ—¶è¢«æ ¼å¼åŒ–äº†ã€‚ xfs_growfs æ˜¯centos7çš„å‘½ä»¤ï¼Œåœ¨centos6.Xä¸­æ˜¯resize2fsï¼Œå…¶å®è¿˜æ˜¯6.xçš„å‘½ä»¤å¥½è®°ã€‚\næ­¤å¤„è®²çš„æ˜¯ç›´æ¥å°†æ–°åŠ çš„ç£ç›˜æ‰©å®¹åˆ°å·²æœ‰åˆ†åŒºï¼Œè¿˜å¯ä»¥åšçš„æ˜¯ï¼Œåœ¨å°†æ–°åˆ†åŒºåŠ å…¥å·ç»„åï¼š\n1ã€åˆ›å»ºéœ€è¦å¤§å°çš„ç‹¬ç«‹é€»è¾‘å·ï¼Œå°†å®ƒè¿›è¡Œå•ç‹¬æŒ‚è½½ä½¿ç”¨ã€‚ï¼ˆåˆ«å¿˜äº†æ”¹ä¸€ä¸‹/etc/fstabï¼Œä¸ç„¶ä¸‹æ¬¡é‡å¯è¿˜è¦æ‰‹åŠ¨æŒ‚è½½ï¼‰\n1 2 3 lvcreateÂ -LÂ 4GÂ -nÂ newlvÂ centos åœ¨centoså·ç»„çš„ç©ºé—²ç©ºé—´ä¸­åˆ’å‡º4Gçš„æ–°é€»è¾‘å·ï¼Œèµ·åä¸ºnewlv mkfs.xfs /dev/centos/newlv å°†æ–°çš„newlvæ ¼å¼åŒ–ä¸ºxfsæ–‡ä»¶ç³»ç»Ÿ 1ã€ä¸åˆ›æ–°éœ€è¦å¤§å°çš„ç‹¬ç«‹é€»è¾‘å·ï¼Œå°†è‡ªç”±ç©ºé—´æ‰©å®¹åˆ°ç°æœ‰çš„åˆ†åŒºæŒ‚è½½ç‚¹\nåŸºæœ¬å°±è¿™äº›äº†ã€‚lvmç®¡ç†è¯´å®è¯çœŸæŒºçˆ½çš„ã€‚ç‰¹åˆ«æ˜¯åœ¨esxiä¸»æœºä¸Šä½¿ç”¨ï¼Œæ— éœ€åœæœºï¼Œç›´æ¥åŠ è£…æ‰©å®¹ã€‚\næœ‰æ­£å°±æœ‰åï¼Œèƒ½è£…å°±å¾—èƒ½å¸ï¼Œèƒ½æ‰©å°±å¾—èƒ½å‡ã€‚\n1ã€ç›´æ¥æ‰©å®¹åŸæœ‰é€»è¾‘å·å¤§å°çš„å¸è½½æ–°åŠ å®¹é‡\nlvreduce -L -10G /dev/centos/var å…ˆæŠŠæ‰©å®¹çš„å®¹é‡å‡æ‰\nå¦‚æœæ˜¯åˆ›å»ºæˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„é€»è¾‘å·ï¼Œåˆ™\nlvremove /dev/centos/newlv1\n2ã€ä»å·ç»„ä¸­åˆ æ‰åŠ å…¥çš„ç£ç›˜åˆ†åŒº\nvgreduce centos /dev/sdb1\n3ã€ä»ç‰©ç†å·ä¸­å¸æ‰sdb1\npvremove /dev/sdb1 æœ€åå°±æ˜¯åœ¨esxiä¸­åˆ ç¡¬ä»¶äº†ã€‚\n","date":"2020-03-16T11:53:10Z","image":"https://www.ownit.top/title_pic/31.jpg","permalink":"https://www.ownit.top/p/202003161153/","title":"esxiä¸­CentOS7ä¸åœæœºåŠ ç£ç›˜å¹¶æ‰©å®¹ç°æœ‰åˆ†åŒº"},{"content":"VMwareä¸‰ä¸ªç‰ˆæœ¬\nworkstationï¼š å•æœºçº§ï¼Œç”¨åœ¨ä¸ªäººæ¡Œé¢ç³»ç»Ÿä¸­ï¼Œéœ€è¦æ“ä½œç³»ç»Ÿæ”¯æŒ\nservierï¼šå·¥ä½œç»„çº§ï¼Œç”¨äºæœåŠ¡å™¨ï¼Œéœ€è¦æ“ä½œç³»ç»Ÿæ”¯æŒ\nesxiï¼šä¼ä¸šçº§ï¼Œç”¨äºæœåŠ¡å™¨ï¼Œä¸éœ€è¦æ“ä½œç³»ç»Ÿæ”¯æŒ\nExsi æ˜¯ä¸€æ¬¾è™šæ‹ŸåŒ–ç³»ç»Ÿï¼Œä¸VMwareï¼ŒVirtualBoxä¸åŒï¼Œå®ƒä¸éœ€è¦å®‰è£…åœ¨å…¶ä»–æ“ä½œç³»ç»Ÿä¸Šï¼Œç›´æ¥è¿è¡Œåœ¨è£¸æœºä¸Šï¼›å ç”¨ç³»ç»Ÿèµ„æºå¾ˆå°ï¼Œæ˜“äºç®¡ç†ï¼Œæ‰€ä»¥è¢«å¤§å¤šæ•°ä¸­å°å‹å…¬å¸æ‰€ä½¿ç”¨ï¼›\nå®‰è£…å›¾è§£ï¼š é•œåƒå·²ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ŒCentOS7é•œåƒåŒ…\næ–°å»ºè™šæ‹Ÿæœº\né€‰æ‹©å­˜å‚¨\nè‡ªå®šä¹‰è®¾ç½®\nå¦‚æœé…ç½®ä¸å¤Ÿï¼Œå¯è¿›è¡Œä¿®æ”¹\nå°†é•œåƒåŠ è½½åˆ°æ–°å»ºçš„è™šæ‹Ÿæœºé‡Œï¼ŒCD/DVDé©±åŠ¨å™¨é€‰æ‹©æ•°æ®å­˜å‚¨ISOæ–‡ä»¶\nç°åœ¨å¼€å§‹è¿è¡Œï¼Œé¦–å…ˆæ‰“å¼€ç”µæº,æ‰“å¼€æ§åˆ¶å°\nä¸‹é¢æ­¥éª¤å°±å¯å®‰è£…Centos7ä¸€æ ·äº†ã€‚\né€‰æ‹©è‡ªå·±éœ€æ±‚çš„ä¸œè¥¿å°±è¡Œï¼Œç„¶åå¼€å§‹å®‰è£…ã€‚\n","date":"2020-03-16T09:59:18Z","image":"https://www.ownit.top/title_pic/39.jpg","permalink":"https://www.ownit.top/p/202003160959/","title":"ESXI6.5å®‰è£…CentOS7æ•™ç¨‹"},{"content":"å å†…å­˜çš„ç¨‹åºå‘½ä»¤\n1 ps aux | head -1;ps aux|sort -k4nr|head -5 å CPUçš„ç¨‹åºå‘½ä»¤\n1 ps aux | head -1;ps aux|sort -k3nr|head -5 ","date":"2020-03-14T21:26:47Z","image":"https://www.ownit.top/title_pic/36.jpg","permalink":"https://www.ownit.top/p/202003142126/","title":"LinuxæŸ¥çœ‹å ç”¨CPUå’Œå†…å­˜çš„ çš„ç¨‹åº"},{"content":"\nç¯å¢ƒå‡†å¤‡ï¼šä¸‰å°è™šæ‹Ÿæœº\n1ï¼‰æ­¤ç¯å¢ƒæ˜¯é’ˆå¯¹å†…éƒ¨æœåŠ¡çš„LVSæ¶æ„ï¼Œå¦‚æ•°æ®åº“ï¼Œç¼“å­˜ï¼Œå…±äº«å­˜å‚¨ç­‰ä¸šåŠ¡ã€‚\nè™šæ‹Ÿæœºè§’è‰²IPåœ°å€å¤‡æ³¨LVSè´Ÿè½½å‡è¡¡å™¨192.168.116.129VIPåœ°å€ï¼š192.168.116.100httpæœåŠ¡å™¨RS1192.168.116.130\u0026nbsp;httpæœåŠ¡å™¨RS2192.168.116.131\u0026nbsp; LVSè´Ÿè½½å‡è¡¡å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 vim /usr/local/sbin/lvs_dr.sh #!/bin/bash yum install -y net-tools ipvsadm echo 1 \u0026gt; /proc/sys/net/ipv4/ip_forward ipv=/usr/sbin/ipvsadm vip=192.168.116.100 rs1=192.168.116.130 rs2=192.168.116.131 #æ³¨æ„è¿™é‡Œçš„ç½‘å¡åå­— ifconfig ens33:2 $vip broadcast $vip netmask 255.255.255.255 up route add -host $vip dev ens33:2 $ipv -C $ipv -A -t $vip:80 -s wrr $ipv -a -t $vip:80 -r $rs1:80 -g -w 1 $ipv -a -t $vip:80 -r $rs2:80 -g -w 1 httpæœåŠ¡å™¨RS1ã€httpæœåŠ¡å™¨RS2 1 2 3 4 5 6 7 8 9 10 11 12 13 vim /usr/local/sbin/lvs_dr.sh #/bin/bash yum install -y net-tools vip=192.168.116.100 #æŠŠvipç»‘å®šåœ¨loä¸Šï¼Œæ˜¯ä¸ºäº†å®ç°rsç›´æ¥æŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ ifconfig lo:0 $vip broadcast $vip netmask 255.255.255.255 up route add -host $vip lo:0 #ä»¥ä¸‹æ“ä½œä¸ºæ›´æ”¹arpå†…æ ¸å‚æ•°ï¼Œç›®çš„æ˜¯ä¸ºäº†è®©rsé¡ºåˆ©å‘é€macåœ°å€ç»™å®¢æˆ·ç«¯ echo \u0026#34;1\u0026#34; \u0026gt;/proc/sys/net/ipv4/conf/lo/arp_ignore echo \u0026#34;2\u0026#34; \u0026gt;/proc/sys/net/ipv4/conf/lo/arp_announce echo \u0026#34;1\u0026#34; \u0026gt;/proc/sys/net/ipv4/conf/all/arp_ignore echo \u0026#34;2\u0026#34; \u0026gt;/proc/sys/net/ipv4/conf/all/arp_announce è¿è¡Œè„šæœ¬ 1 bash /usr/local/sbin/lvs_dr_rs.sh åœ¨httpdæœåŠ¡å™¨åˆ›å»ºæ–‡ä»¶æµ‹è¯•\n1 yum install -y httpd \u0026amp;\u0026amp; echo \u0026#34;this is one\u0026#34; \u0026gt;\u0026gt; /var/www/html/index.html \u0026amp;\u0026amp; systemctl restart httpd ","date":"2020-02-20T23:23:23Z","image":"https://www.ownit.top/title_pic/31.jpg","permalink":"https://www.ownit.top/p/202002202323/","title":"Centos7ä½¿ç”¨è„šæœ¬æ­å»ºLVSçš„DRæ¨¡å¼ã€‚"},{"content":"èŠ‚ç‚¹äº²å’Œæ€§ pod.spec.nodeAï¬ƒnity\npreferredDuringSchedulingIgnoredDuringExecutionï¼šè½¯ç­–ç•¥ requiredDuringSchedulingIgnoredDuringExecutionï¼šç¡¬ç­–ç•¥ requiredDuringSchedulingIgnoredDuringExecution 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 apiVersion: v1 kind: Pod metadata: name: affinity labels: app: node-affinity-pod spec: containers: - name: with-node-affinity image: wangyanglinux/myapp:v1 affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: NotIn values: - node02 preferredDuringSchedulingIgnoredDuringExecution 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 apiVersion: v1 kind: Pod metadata: name: affinity labels: app: node-affinity-pod spec: containers: - name: with-node-affinity image: wangyanglinux/myapp:v1 affinity: nodeAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 preference: matchExpressions: - key: kubernetes.io/hostname operator: In values: - node3 å…ˆç¡¬åè½¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 apiVersion: v1 kind: Pod metadata: name: affinity labels: app: node-affinity-pod spec: containers: - name: with-node-affinity image: hub.atguigu.com/library/myapp:v1 affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: NotIn values: - k8s-node02 preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 preference: matchExpressions: - key: source operator: In values: - qikqiak é”®å€¼è¿ç®—å…³ç³» Inï¼šlabel çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ NotInï¼šlabel çš„å€¼ä¸åœ¨æŸä¸ªåˆ—è¡¨ä¸­ Gtï¼šlabel çš„å€¼å¤§äºæŸä¸ªå€¼ Ltï¼šlabel çš„å€¼å°äºæŸä¸ªå€¼ Existsï¼šæŸä¸ª label å­˜åœ¨ DoesNotExistï¼šæŸä¸ª label ä¸å­˜åœ¨\nPod äº²å’Œæ€§ pod.spec.aï¬ƒnity.podAï¬ƒnity/podAntiAï¬ƒnity\npreferredDuringSchedulingIgnoredDuringExecutionï¼šè½¯ç­–ç•¥ requiredDuringSchedulingIgnoredDuringExecutionï¼šç¡¬ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 apiVersion: v1 kind: Pod metadata: name: pod-3 labels: app: pod-3 spec: containers: - name: pod-3 image: wangyanglinux/myapp:v1 affinity: podAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: app operator: In values: - pod-1 topologyKey: kubernetes.io/hostname podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - pod-2 topologyKey: kubernetes.io/hostname äº²å’Œæ€§/åäº²å’Œæ€§è°ƒåº¦ç­–ç•¥æ¯”è¾ƒå¦‚ä¸‹ï¼š\nè°ƒåº¦ç­–ç•¥åŒ¹é… æ ‡ç­¾åŒ¹é… æ ‡ç­¾æ“ä½œç¬¦æ‹“æ‰‘åŸŸ æ”¯æŒè°ƒåº¦ç›®æ ‡nodeAï¬ƒnity\u0026nbsp;ä¸»æœºIn, NotIn, Exists, DoesNotExist, Gt, Ltå¦æŒ‡å‘ä¸»æœºpodAï¬ƒnity\u0026nbsp;PODIn, NotIn, Exists, DoesNotExistæ˜¯PODä¸æŒ‡å®šPODåŒä¸€æ‹“ æ‰‘åŸŸpodAnitAï¬ƒnity\u0026nbsp;PODIn, NotIn, Exists, DoesNotExistæ˜¯PODä¸æŒ‡å®šPODä¸åœ¨åŒ ä¸€æ‹“æ‰‘åŸŸ","date":"2020-02-11T16:02:24Z","image":"https://www.ownit.top/title_pic/02.jpg","permalink":"https://www.ownit.top/p/202002111602/","title":"Kubernetesï¼ˆk8sï¼‰çš„è°ƒåº¦å™¨ - è°ƒåº¦äº²å’Œæ€§è¯¦ç»†ä»‹ç»"},{"content":"ç®€ä»‹Â Scheduler æ˜¯ kubernetes çš„è°ƒåº¦å™¨ï¼Œä¸»è¦çš„ä»»åŠ¡æ˜¯æŠŠå®šä¹‰çš„ pod åˆ†é…åˆ°é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šã€‚å¬èµ·æ¥éå¸¸ç®€å•ï¼Œä½†æœ‰ å¾ˆå¤šè¦è€ƒè™‘çš„é—®é¢˜ï¼š\nå…¬å¹³ï¼šå¦‚ä½•ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è¢«åˆ†é…èµ„æº èµ„æºé«˜æ•ˆåˆ©ç”¨ï¼šé›†ç¾¤æ‰€æœ‰èµ„æºæœ€å¤§åŒ–è¢«ä½¿ç”¨ æ•ˆç‡ï¼šè°ƒåº¦çš„æ€§èƒ½è¦å¥½ï¼Œèƒ½å¤Ÿå°½å¿«åœ°å¯¹å¤§æ‰¹é‡çš„ pod å®Œæˆè°ƒåº¦å·¥ä½œ çµæ´»ï¼šå…è®¸ç”¨æˆ·æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ§åˆ¶è°ƒåº¦çš„é€»è¾‘\nSheduler æ˜¯ä½œä¸ºå•ç‹¬çš„ç¨‹åºè¿è¡Œçš„ï¼Œå¯åŠ¨ä¹‹åä¼šä¸€ç›´åšæŒº API Serverï¼Œè·å– PodSpec.NodeName ä¸ºç©ºçš„ podï¼Œ å¯¹æ¯ä¸ª pod éƒ½ä¼šåˆ›å»ºä¸€ä¸ª bindingï¼Œè¡¨æ˜è¯¥ pod åº”è¯¥æ”¾åˆ°å“ªä¸ªèŠ‚ç‚¹ä¸ŠÂ è°ƒåº¦è¿‡ç¨‹Â è°ƒåº¦åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼šé¦–å…ˆæ˜¯è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºÂ predicate ï¼›ç„¶åå¯¹é€šè¿‡çš„èŠ‚ç‚¹æŒ‰ç…§ä¼˜å…ˆçº§ æ’åºï¼Œè¿™ä¸ªæ˜¯Â priority ï¼›æœ€åä»ä¸­é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹ã€‚å¦‚æœä¸­é—´ä»»ä½•ä¸€æ­¥éª¤æœ‰é”™è¯¯ï¼Œå°±ç›´æ¥è¿”å›é”™è¯¯Â **Predicate æœ‰ä¸€ç³»åˆ—çš„ç®—æ³•å¯ä»¥ä½¿ç”¨ï¼šÂ **\nPodFitsResources ï¼šèŠ‚ç‚¹ä¸Šå‰©ä½™çš„èµ„æºæ˜¯å¦å¤§äº pod è¯·æ±‚çš„èµ„æº PodFitsHost ï¼šå¦‚æœ pod æŒ‡å®šäº† NodeNameï¼Œæ£€æŸ¥èŠ‚ç‚¹åç§°æ˜¯å¦å’Œ NodeName åŒ¹é… PodFitsHostPorts ï¼šèŠ‚ç‚¹ä¸Šå·²ç»ä½¿ç”¨çš„ port æ˜¯å¦å’Œ pod ç”³è¯·çš„ port å†²çª PodSelectorMatches ï¼šè¿‡æ»¤æ‰å’Œ pod æŒ‡å®šçš„ label ä¸åŒ¹é…çš„èŠ‚ç‚¹ NoDiskConflict ï¼šå·²ç» mount çš„ volume å’Œ pod æŒ‡å®šçš„ volume ä¸å†²çªï¼Œé™¤éå®ƒä»¬éƒ½æ˜¯åªè¯»\nå¦‚æœåœ¨ predicate è¿‡ç¨‹ä¸­æ²¡æœ‰åˆé€‚çš„èŠ‚ç‚¹ï¼Œpod ä¼šä¸€ç›´åœ¨Â pending çŠ¶æ€ï¼Œä¸æ–­é‡è¯•è°ƒåº¦ï¼Œç›´åˆ°æœ‰èŠ‚ç‚¹æ»¡è¶³æ¡ä»¶ã€‚ ç»è¿‡è¿™ä¸ªæ­¥éª¤ï¼Œå¦‚æœæœ‰å¤šä¸ªèŠ‚ç‚¹æ»¡è¶³æ¡ä»¶ï¼Œå°±ç»§ç»­ priorities è¿‡ç¨‹ï¼š æŒ‰ç…§ä¼˜å…ˆçº§å¤§å°å¯¹èŠ‚ç‚¹æ’åº\nä¼˜å…ˆçº§ç”±ä¸€ç³»åˆ—é”®å€¼å¯¹ç»„æˆï¼Œé”®æ˜¯è¯¥ä¼˜å…ˆçº§é¡¹çš„åç§°ï¼Œå€¼æ˜¯å®ƒçš„æƒé‡ï¼ˆè¯¥é¡¹çš„é‡è¦æ€§ï¼‰ã€‚è¿™äº›ä¼˜å…ˆçº§é€‰é¡¹åŒ…æ‹¬ï¼š\nLeastRequestedPriority ï¼šé€šè¿‡è®¡ç®— CPU å’Œ Memory çš„ä½¿ç”¨ç‡æ¥å†³å®šæƒé‡ï¼Œä½¿ç”¨ç‡è¶Šä½æƒé‡è¶Šé«˜ã€‚æ¢å¥è¯****è¯´ï¼Œè¿™ä¸ªä¼˜å…ˆçº§æŒ‡æ ‡å€¾å‘äºèµ„æºä½¿ç”¨æ¯”ä¾‹æ›´ä½çš„èŠ‚ç‚¹ BalancedResourceAllocation ï¼šèŠ‚ç‚¹ä¸Š CPU å’Œ Memory ä½¿ç”¨ç‡è¶Šæ¥è¿‘ï¼Œæƒé‡è¶Šé«˜ã€‚è¿™ä¸ªåº”è¯¥å’Œä¸Šé¢çš„ä¸€èµ·****ä½¿ç”¨ï¼Œä¸åº”è¯¥å•ç‹¬ä½¿ç”¨ ImageLocalityPriority ï¼šå€¾å‘äºå·²ç»æœ‰è¦ä½¿ç”¨é•œåƒçš„èŠ‚ç‚¹ï¼Œé•œåƒæ€»å¤§å°å€¼è¶Šå¤§ï¼Œæƒé‡è¶Šé«˜\né€šè¿‡ç®—æ³•å¯¹æ‰€æœ‰çš„ä¼˜å…ˆçº§é¡¹ç›®å’Œæƒé‡è¿›è¡Œè®¡ç®—ï¼Œå¾—å‡ºæœ€ç»ˆçš„ç»“æœ\nè‡ªå®šä¹‰è°ƒåº¦å™¨Â é™¤äº† kubernetes è‡ªå¸¦çš„è°ƒåº¦å™¨ï¼Œä½ ä¹Ÿå¯ä»¥ç¼–å†™è‡ªå·±çš„è°ƒåº¦å™¨ã€‚é€šè¿‡ spec:schedulername å‚æ•°æŒ‡å®šè°ƒåº¦å™¨çš„å å­—ï¼Œå¯ä»¥ä¸º pod é€‰æ‹©æŸä¸ªè°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦ã€‚æ¯”å¦‚ä¸‹é¢çš„ pod é€‰æ‹© my-scheduler è¿›è¡Œè°ƒåº¦ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ default-scheduler ï¼š\n1 2 3 4 5 6 7 8 9 10 11 apiVersion: v1 kind: Pod metadata: name: annotation-second-scheduler labels: name: multischeduler-example spec: schedulername: my-scheduler containers: - name: pod-with-second-annotation-container image: wangyanglinux/myapp:v1 ","date":"2020-02-11T14:45:11Z","image":"https://www.ownit.top/title_pic/01.jpg","permalink":"https://www.ownit.top/p/202002111445/","title":"Kubernetesï¼ˆk8sï¼‰çš„è°ƒåº¦å™¨è¯¦ç»†ä»‹ç»"},{"content":"æ¦‚å¿µÂ PersistentVolume ï¼ˆPVï¼‰Â æ˜¯ç”±ç®¡ç†å‘˜è®¾ç½®çš„å­˜å‚¨ï¼Œå®ƒæ˜¯ç¾¤é›†çš„ä¸€éƒ¨åˆ†ã€‚å°±åƒèŠ‚ç‚¹æ˜¯é›†ç¾¤ä¸­çš„èµ„æºä¸€æ ·ï¼ŒPV ä¹Ÿæ˜¯é›†ç¾¤ä¸­çš„èµ„æºã€‚ PV æ˜¯ Volume ä¹‹ç±»çš„å·æ’ä»¶ï¼Œä½†å…·æœ‰ç‹¬ç«‹äºä½¿ç”¨ PV çš„ Pod çš„ç”Ÿå‘½å‘¨æœŸã€‚æ­¤ API å¯¹è±¡åŒ…å«å­˜å‚¨å®ç°çš„ç»†èŠ‚ï¼Œå³ NFSã€ iSCSI æˆ–ç‰¹å®šäºäº‘ä¾›åº”å•†çš„å­˜å‚¨ç³»ç»ŸÂ PersistentVolumeClaim ï¼ˆPVCï¼‰ æ˜¯ç”¨æˆ·å­˜å‚¨çš„è¯·æ±‚ã€‚å®ƒä¸ Pod ç›¸ä¼¼ã€‚Pod æ¶ˆè€—èŠ‚ç‚¹èµ„æºï¼ŒPVC æ¶ˆè€— PV èµ„æºã€‚Pod å¯ä»¥è¯·æ±‚ç‰¹å®šçº§åˆ«çš„èµ„æº ï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚å£°æ˜å¯ä»¥è¯·æ±‚ç‰¹å®šçš„å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼ˆä¾‹å¦‚ï¼Œå¯ä»¥ä»¥è¯»/å†™ä¸€æ¬¡æˆ– åªè¯»å¤šæ¬¡æ¨¡å¼æŒ‚è½½ï¼‰\né™æ€ pvÂ é›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºä¸€äº› PVã€‚å®ƒä»¬å¸¦æœ‰å¯ä¾›ç¾¤é›†ç”¨æˆ·ä½¿ç”¨çš„å®é™…å­˜å‚¨çš„ç»†èŠ‚ã€‚å®ƒä»¬å­˜åœ¨äº Kubernetes API ä¸­ï¼Œå¯ç”¨ äºæ¶ˆè´¹\nåŠ¨æ€Â å½“ç®¡ç†å‘˜åˆ›å»ºçš„é™æ€ PV éƒ½ä¸åŒ¹é…ç”¨æˆ·çš„ PersistentVolumeClaim æ—¶ï¼Œé›†ç¾¤å¯èƒ½ä¼šå°è¯•åŠ¨æ€åœ°ä¸º PVC åˆ›å»ºå·ã€‚æ­¤ é…ç½®åŸºäºStorageClasses ï¼šPVC å¿…é¡»è¯·æ±‚ [å­˜å‚¨ç±»]ï¼Œå¹¶ä¸”ç®¡ç†å‘˜å¿…é¡»åˆ›å»ºå¹¶é…ç½®è¯¥ç±»æ‰èƒ½è¿›è¡ŒåŠ¨æ€åˆ›å»ºã€‚å£°æ˜è¯¥ ç±»ä¸º \u0026quot;\u0026quot; å¯ä»¥æœ‰æ•ˆåœ°ç¦ç”¨å…¶åŠ¨æ€é…ç½®\nè¦å¯ç”¨åŸºäºå­˜å‚¨çº§åˆ«çš„åŠ¨æ€å­˜å‚¨é…ç½®ï¼Œé›†ç¾¤ç®¡ç†å‘˜éœ€è¦å¯ç”¨ API server ä¸Šçš„ DefaultStorageClass [å‡†å…¥æ§åˆ¶å™¨] ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ç¡®ä¿ DefaultStorageClass ä½äº API server ç»„ä»¶çš„ --admission-control æ ‡å¿—ï¼Œä½¿ç”¨é€—å·åˆ†éš”çš„ æœ‰åºå€¼åˆ—è¡¨ä¸­ï¼Œå¯ä»¥å®Œæˆæ­¤æ“ä½œ\nç»‘å®šÂ master ä¸­çš„æ§åˆ¶ç¯è·¯ç›‘è§†æ–°çš„ PVCï¼Œå¯»æ‰¾åŒ¹é…çš„ PVï¼ˆå¦‚æœå¯èƒ½ï¼‰ï¼Œå¹¶å°†å®ƒä»¬ç»‘å®šåœ¨ä¸€èµ·ã€‚å¦‚æœä¸ºæ–°çš„ PVC åŠ¨æ€ è°ƒé… PVï¼Œåˆ™è¯¥ç¯è·¯å°†å§‹ç»ˆå°†è¯¥ PV ç»‘å®šåˆ° PVCã€‚å¦åˆ™ï¼Œç”¨æˆ·æ€»ä¼šå¾—åˆ°ä»–ä»¬æ‰€è¯·æ±‚çš„å­˜å‚¨ï¼Œä½†æ˜¯å®¹é‡å¯èƒ½è¶…å‡ºè¦æ±‚ çš„æ•°é‡ã€‚ä¸€æ—¦ PV å’Œ PVC ç»‘å®šåï¼Œ PersistentVolumeClaim ç»‘å®šæ˜¯æ’ä»–æ€§çš„ï¼Œä¸ç®¡å®ƒä»¬æ˜¯å¦‚ä½•ç»‘å®šçš„ã€‚ PVC è·Ÿ PV ç»‘å®šæ˜¯ä¸€å¯¹ä¸€çš„æ˜ å°„Â æŒä¹…åŒ–å·å£°æ˜çš„ä¿æŠ¤Â PVC ä¿æŠ¤çš„ç›®çš„æ˜¯ç¡®ä¿ç”± pod æ­£åœ¨ä½¿ç”¨çš„ PVC ä¸ä¼šä»ç³»ç»Ÿä¸­ç§»é™¤ï¼Œå› ä¸ºå¦‚æœè¢«ç§»é™¤çš„è¯å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±\nå½“å¯ç”¨PVC ä¿æŠ¤ alpha åŠŸèƒ½æ—¶ï¼Œå¦‚æœç”¨æˆ·åˆ é™¤äº†ä¸€ä¸ª pod æ­£åœ¨ä½¿ç”¨çš„ PVCï¼Œåˆ™è¯¥ PVC ä¸ä¼šè¢«ç«‹å³åˆ é™¤ã€‚PVC çš„ åˆ é™¤å°†è¢«æ¨è¿Ÿï¼Œç›´åˆ° PVC ä¸å†è¢«ä»»ä½• pod ä½¿ç”¨\næŒä¹…åŒ–å·ç±»å‹Â **PersistentVolume ç±»å‹ä»¥æ’ä»¶å½¢å¼å®ç°ã€‚Kubernetes ç›®å‰æ”¯æŒä»¥ä¸‹æ’ä»¶ç±»å‹ï¼šÂ **\nGCEPersistentDisk AWSElasticBlockStore AzureFile AzureDisk FC (Fibre Channel) FlexVolume Flocker NFS iSCSI RBD (Ceph Block Device) CephFS Cinder (OpenStack block storage) Glusterfs VsphereVolume Quobyte Volumes HostPath VMware Photon Portworx Volumes ScaleIO Volumes StorageOS æŒä¹…å·æ¼”ç¤ºä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 kind: PersistentVolume metadata: name: pv0003 spec: capacity: storage: 5Gi volumeMode: Filesystem accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Recycle storageClassName: slow mountOptions: - hard - nfsvers=4.1 nfs: path: /tmp server: 172.17.0.2 PV è®¿é—®æ¨¡å¼Â PersistentVolume å¯ä»¥ä»¥èµ„æºæä¾›è€…æ”¯æŒçš„ä»»ä½•æ–¹å¼æŒ‚è½½åˆ°ä¸»æœºä¸Šã€‚å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œä¾›åº”å•†å…·æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œæ¯ä¸ª PV çš„è®¿é—®æ¨¡å¼éƒ½å°†è¢«è®¾ç½®ä¸ºè¯¥å·æ”¯æŒçš„ç‰¹å®šæ¨¡å¼ã€‚ä¾‹å¦‚ï¼ŒNFS å¯ä»¥æ”¯æŒå¤šä¸ªè¯»/å†™å®¢æˆ·ç«¯ï¼Œä½†ç‰¹å®šçš„ NFS PV å¯èƒ½ ä»¥åªè¯»æ–¹å¼å¯¼å‡ºåˆ°æœåŠ¡å™¨ä¸Šã€‚æ¯ä¸ª PV éƒ½æœ‰ä¸€å¥—è‡ªå·±çš„ç”¨æ¥æè¿°ç‰¹å®šåŠŸèƒ½çš„è®¿é—®æ¨¡å¼Â ReadWriteOnceâ€”â€”è¯¥å·å¯ä»¥è¢«å•ä¸ªèŠ‚ç‚¹ä»¥è¯»/å†™æ¨¡å¼æŒ‚è½½ ReadOnlyManyâ€”â€”è¯¥å·å¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹ä»¥åªè¯»æ¨¡å¼æŒ‚è½½ ReadWriteManyâ€”â€”è¯¥å·å¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹ä»¥è¯»/å†™æ¨¡å¼æŒ‚è½½ åœ¨å‘½ä»¤è¡Œä¸­ï¼Œè®¿é—®æ¨¡å¼ç¼©å†™ä¸ºï¼š\nRWO - ReadWriteOnce ROX - ReadOnlyMany RWX - ReadWriteMany å›æ”¶ç­–ç•¥ Retainï¼ˆä¿ç•™ï¼‰â€”â€”æ‰‹åŠ¨å›æ”¶ Recycleï¼ˆå›æ”¶ï¼‰â€”â€”åŸºæœ¬æ“¦é™¤ï¼ˆ rm -rf /thevolume/* ï¼‰ Deleteï¼ˆåˆ é™¤ï¼‰â€”â€”å…³è”çš„å­˜å‚¨èµ„äº§ï¼ˆä¾‹å¦‚ AWS EBSã€GCE PDã€Azure Disk å’Œ OpenStack Cinder å·ï¼‰å°†è¢«åˆ é™¤ å½“å‰ï¼Œåªæœ‰ NFS å’Œ HostPath æ”¯æŒå›æ”¶ç­–ç•¥ã€‚AWS EBSã€GCE PDã€Azure Disk å’Œ Cinder å·æ”¯æŒåˆ é™¤ç­–ç•¥\nçŠ¶æ€ å·å¯ä»¥å¤„äºä»¥ä¸‹çš„æŸç§çŠ¶æ€ï¼š\nAvailableï¼ˆå¯ç”¨ï¼‰â€”â€”ä¸€å—ç©ºé—²èµ„æºè¿˜æ²¡æœ‰è¢«ä»»ä½•å£°æ˜ç»‘å®š Boundï¼ˆå·²ç»‘å®šï¼‰â€”â€”å·å·²ç»è¢«å£°æ˜ç»‘å®š Releasedï¼ˆå·²é‡Šæ”¾ï¼‰â€”â€”å£°æ˜è¢«åˆ é™¤ï¼Œä½†æ˜¯èµ„æºè¿˜æœªè¢«é›†ç¾¤é‡æ–°å£°æ˜ Failedï¼ˆå¤±è´¥ï¼‰â€”â€”è¯¥å·çš„è‡ªåŠ¨å›æ”¶å¤±è´¥\nå‘½ä»¤è¡Œä¼šæ˜¾ç¤ºç»‘å®šåˆ° PV çš„ PVC çš„åç§°\næŒä¹…åŒ–æ¼”ç¤ºè¯´æ˜ - NFSÂ â… ã€å®‰è£… NFS æœåŠ¡å™¨ 1 2 3 4 5 6 7 8 yum install -y nfs-common nfs-utils rpcbind mkdir /nfsdata chmod 666 /nfsdata chown nfsnobody /nfsdata cat /etc/exports /nfsdata *(rw,no_root_squash,no_all_squash,sync) systemctl start rpcbind systemctl start nfs NFSå·²ç»æˆåŠŸäº†\nâ…¡ã€éƒ¨ç½² PVÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: PersistentVolume metadata: name: nfspv1 spec: capacity: storage: 1Gi accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Retain storageClassName: nfs nfs: path: /nfsdata server: 192.168.116.131 â…¢ã€åˆ›å»ºæœåŠ¡å¹¶ä½¿ç”¨ PVCÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 apiVersion: v1 kind: Service metadata: name: nginx labels: app: nginx spec: ports: - port: 80 name: web clusterIP: None selector: app: nginx --- apiVersion: apps/v1 kind: StatefulSet metadata: name: web spec: selector: matchLabels: app: nginx serviceName: \u0026#34;nginx\u0026#34; replicas: 3 template: metadata: labels: app: nginx spec: containers: - name: nginx image: wangyanglinux/myapp:v1 ports: - containerPort: 80 name: web volumeMounts: - name: www mountPath: /usr/share/nginx/html volumeClaimTemplates: - metadata: name: www spec: accessModes: [ \u0026#34;ReadWriteOnce\u0026#34; ] storageClassName: \u0026#34;nfs\u0026#34; resources: requests: storage: 10Gi å…³äº StatefulSetÂ åŒ¹é… Pod name ( ç½‘ç»œæ ‡è¯† ) çš„æ¨¡å¼ä¸ºï¼š$(statefulsetåç§°)-$(åºå·)ï¼Œæ¯”å¦‚ä¸Šé¢çš„ç¤ºä¾‹ï¼šweb-0ï¼Œweb-1ï¼Œweb-2\nStatefulSet ä¸ºæ¯ä¸ª Pod å‰¯æœ¬åˆ›å»ºäº†ä¸€ä¸ª DNS åŸŸåï¼Œè¿™ä¸ªåŸŸåçš„æ ¼å¼ä¸ºï¼š $(podname).(headless serverÂ name)ï¼Œä¹Ÿå°±æ„å‘³ç€æœåŠ¡é—´æ˜¯é€šè¿‡PodåŸŸåæ¥é€šä¿¡è€Œé Pod IPï¼Œå› ä¸ºå½“Podæ‰€åœ¨Nodeå‘ç”Ÿæ•…éšœæ—¶ï¼Œ Pod ä¼šè¢«é£˜ç§»åˆ°å…¶å®ƒ Node ä¸Šï¼ŒPod IP ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯ Pod åŸŸåä¸ä¼šæœ‰å˜åŒ– StatefulSet ä½¿ç”¨ Headless æœåŠ¡æ¥æ§åˆ¶ Pod çš„åŸŸåï¼Œè¿™ä¸ªåŸŸåçš„ FQDN ä¸ºï¼š$(serviceÂ name).$(namespace).svc.cluster.localï¼Œå…¶ä¸­ï¼Œâ€œcluster.localâ€ æŒ‡çš„æ˜¯é›†ç¾¤çš„åŸŸå æ ¹æ® volumeClaimTemplatesï¼Œä¸ºæ¯ä¸ª Pod åˆ›å»ºä¸€ä¸ª pvcï¼Œpvc çš„å‘½åè§„åˆ™åŒ¹é…æ¨¡å¼ï¼š(volumeClaimTemplates.name)-(pod_name)ï¼Œæ¯”å¦‚ä¸Šé¢çš„ volumeMounts.name=wwwï¼Œ PodÂ name=web-[0-2]ï¼Œå› æ­¤åˆ›å»ºå‡ºæ¥çš„ PVC æ˜¯ www-web-0ã€www-web-1ã€www-web-2 åˆ é™¤ Pod ä¸ä¼šåˆ é™¤å…¶ pvcï¼Œæ‰‹åŠ¨åˆ é™¤ pvc å°†è‡ªåŠ¨é‡Šæ”¾ pv Statefulsetçš„å¯åœé¡ºåºï¼š æœ‰åºéƒ¨ç½²ï¼šéƒ¨ç½²StatefulSetæ—¶ï¼Œå¦‚æœæœ‰å¤šä¸ªPodå‰¯æœ¬ï¼Œå®ƒä»¬ä¼šè¢«é¡ºåºåœ°åˆ›å»ºï¼ˆä»0åˆ°N-1ï¼‰å¹¶ä¸”ï¼Œåœ¨ä¸‹ä¸€ä¸ªPodè¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„Podå¿…é¡»éƒ½æ˜¯Runningå’ŒReadyçŠ¶æ€ã€‚ æœ‰åºåˆ é™¤ï¼šå½“Podè¢«åˆ é™¤æ—¶ï¼Œå®ƒä»¬è¢«ç»ˆæ­¢çš„é¡ºåºæ˜¯ä»N-1åˆ°0ã€‚ æœ‰åºæ‰©å±•ï¼šå½“å¯¹Podæ‰§è¡Œæ‰©å±•æ“ä½œæ—¶ï¼Œä¸éƒ¨ç½²ä¸€æ ·ï¼Œå®ƒå‰é¢çš„Podå¿…é¡»éƒ½å¤„äºRunningå’ŒReadyçŠ¶æ€ã€‚ StatefulSetä½¿ç”¨åœºæ™¯ï¼š ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå³Podé‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäº PVC æ¥å®ç°ã€‚ ç¨³å®šçš„ç½‘ç»œæ ‡è¯†ç¬¦ï¼Œå³ Pod é‡æ–°è°ƒåº¦åå…¶ PodName å’Œ HostName ä¸å˜ã€‚ æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•ï¼ŒåŸºäº init containers æ¥å®ç°ã€‚ æœ‰åºæ”¶ç¼©ã€‚ ","date":"2020-02-09T21:48:44Z","image":"https://www.ownit.top/title_pic/66.jpg","permalink":"https://www.ownit.top/p/202002092148/","title":"Kubernetesï¼ˆk8sï¼‰çš„å­˜å‚¨PV-PVCè¯¦ç»†ä»‹ç»"},{"content":"å®¹å™¨ç£ç›˜ä¸Šçš„æ–‡ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ˜¯çŸ­æš‚çš„ï¼Œè¿™å°±ä½¿å¾—åœ¨å®¹å™¨ä¸­è¿è¡Œé‡è¦åº”ç”¨æ—¶ä¼šå‡ºç°ä¸€äº›é—®é¢˜ã€‚é¦–å…ˆï¼Œå½“å®¹å™¨å´©æºƒ æ—¶ï¼Œkubelet ä¼šé‡å¯å®ƒï¼Œä½†æ˜¯å®¹å™¨ä¸­çš„æ–‡ä»¶å°†ä¸¢å¤±â€”â€”å®¹å™¨ä»¥å¹²å‡€çš„çŠ¶æ€ï¼ˆé•œåƒæœ€åˆçš„çŠ¶æ€ï¼‰é‡æ–°å¯åŠ¨ã€‚å…¶æ¬¡ï¼Œåœ¨ Pod ä¸­åŒæ—¶è¿è¡Œå¤šä¸ªå®¹å™¨æ—¶ï¼Œè¿™äº›å®¹å™¨ä¹‹é—´é€šå¸¸éœ€è¦å…±äº«æ–‡ä»¶ã€‚Kubernetes ä¸­çš„ Volume æŠ½è±¡å°±å¾ˆå¥½çš„è§£å†³äº† è¿™äº›é—®é¢˜\nèƒŒæ™¯Â Kubernetes ä¸­çš„å·æœ‰æ˜ç¡®çš„å¯¿å‘½ â€”â€” ä¸å°è£…å®ƒçš„ Pod ç›¸åŒã€‚æ‰€fä»¥ï¼Œå·çš„ç”Ÿå‘½æ¯” Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½é•¿ï¼Œå½“è¿™ ä¸ªå®¹å™¨é‡å¯æ—¶æ•°æ®ä»ç„¶å¾—ä»¥ä¿å­˜ã€‚å½“ç„¶ï¼Œå½“ Pod ä¸å†å­˜åœ¨æ—¶ï¼Œå·ä¹Ÿå°†ä¸å¤å­˜åœ¨ã€‚ä¹Ÿè®¸æ›´é‡è¦çš„æ˜¯ï¼ŒKubernetes æ”¯æŒå¤šç§ç±»å‹çš„å·ï¼ŒPod å¯ä»¥åŒæ—¶ä½¿ç”¨ä»»æ„æ•°é‡çš„å·\n**å·çš„ç±»å‹Â **\nKubernetes æ”¯æŒä»¥ä¸‹ç±»å‹çš„å·ï¼š\nawsElasticBlockStore azureDisk azureFile cephfs csi downwardAPI emptyDir fc flocker gcePersistentDisk gitRepo glusterfs hostPath iscsi local nfs persistentVolumeClaim projected portworxVolume quobyte rbd scaleIO secret storageos vsphereVolume\nemptyDirÂ å½“ Pod è¢«åˆ†é…ç»™èŠ‚ç‚¹æ—¶ï¼Œé¦–å…ˆåˆ›å»º emptyDir å·ï¼Œå¹¶ä¸”åªè¦è¯¥ Pod åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œè¯¥å·å°±ä¼šå­˜åœ¨ã€‚æ­£å¦‚å·çš„å å­—æ‰€è¿°ï¼Œå®ƒæœ€åˆæ˜¯ç©ºçš„ã€‚Pod ä¸­çš„å®¹å™¨å¯ä»¥è¯»å–å’Œå†™å…¥ emptyDir å·ä¸­çš„ç›¸åŒæ–‡ä»¶ï¼Œå°½ç®¡è¯¥å·å¯ä»¥æŒ‚è½½åˆ°æ¯ä¸ªå®¹ å™¨ä¸­çš„ç›¸åŒæˆ–ä¸åŒè·¯å¾„ä¸Šã€‚å½“å‡ºäºä»»ä½•åŸå› ä»èŠ‚ç‚¹ä¸­åˆ é™¤ Pod æ—¶ï¼Œ emptyDir ä¸­çš„æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤Â emptyDir çš„ç”¨æ³•æœ‰ï¼š æš‚å­˜ç©ºé—´ï¼Œä¾‹å¦‚ç”¨äºåŸºäºç£ç›˜çš„åˆå¹¶æ’åº ç”¨ä½œé•¿æ—¶é—´è®¡ç®—å´©æºƒæ¢å¤æ—¶çš„æ£€æŸ¥ç‚¹ WebæœåŠ¡å™¨å®¹å™¨æä¾›æ•°æ®æ—¶ï¼Œä¿å­˜å†…å®¹ç®¡ç†å™¨å®¹å™¨æå–çš„æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: Pod metadata: name: test-pd spec: containers: - image: wangyanglinux/myapp:v1 name: test-container volumeMounts: - mountPath: /cache name: cache-volume volumes: - name: cache-volume emptyDir: {} å¯ä»¥æ·»åŠ æ–‡ä»¶ï¼Œå®ç°ä¸åŒå®¹å™¨å…±äº«,ä¸åŒè·¯å¾„æŒ‚è½½ã€‚\nhostPathÂ hostPath å·å°†ä¸»æœºèŠ‚ç‚¹çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æˆ–ç›®å½•æŒ‚è½½åˆ°é›†ç¾¤ä¸­\nhostPath çš„ç”¨é€”å¦‚ä¸‹ï¼š\nè¿è¡Œéœ€è¦è®¿é—® Docker å†…éƒ¨çš„å®¹å™¨ï¼›ä½¿ç”¨ /var/lib/docker çš„ hostPath åœ¨å®¹å™¨ä¸­è¿è¡Œ cAdvisorï¼›ä½¿ç”¨ /dev/cgroups çš„ hostPath å…è®¸ pod æŒ‡å®šç»™å®šçš„ hostPath æ˜¯å¦åº”è¯¥åœ¨ pod è¿è¡Œä¹‹å‰å­˜åœ¨ï¼Œæ˜¯å¦åº”è¯¥åˆ›å»ºï¼Œä»¥åŠå®ƒåº”è¯¥ä»¥ä»€ä¹ˆå½¢å¼å­˜åœ¨\né™¤äº†æ‰€éœ€çš„ path å±æ€§ä¹‹å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥ä¸º hostPath å·æŒ‡å®š type\nä½¿ç”¨è¿™ç§å·ç±»å‹æ˜¯è¯·æ³¨æ„ï¼Œå› ä¸ºï¼š\nç”±äºæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶éƒ½ä¸åŒï¼Œå…·æœ‰ç›¸åŒé…ç½®ï¼ˆä¾‹å¦‚ä» podTemplate åˆ›å»ºçš„ï¼‰çš„ pod åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šçš„è¡Œä¸ºå¯èƒ½ä¼šæœ‰æ‰€ä¸åŒ å½“ Kubernetes æŒ‰ç…§è®¡åˆ’æ·»åŠ èµ„æºæ„ŸçŸ¥è°ƒåº¦æ—¶ï¼Œå°†æ— æ³•è€ƒè™‘ hostPath ä½¿ç”¨çš„èµ„æº åœ¨åº•å±‚ä¸»æœºä¸Šåˆ›å»ºçš„æ–‡ä»¶æˆ–ç›®å½•åªèƒ½ç”± root å†™å…¥ã€‚æ‚¨éœ€è¦åœ¨ç‰¹æƒå®¹å™¨ä¸­ä»¥ root èº«ä»½è¿è¡Œè¿›ç¨‹ï¼Œæˆ–ä¿®æ”¹ä¸»æœºä¸Šçš„æ–‡ä»¶æƒé™ä»¥ä¾¿å†™å…¥ hostPath å· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 kind: Pod metadata: name: test-pd spec: containers: - image: wangyanglinux/myapp:v1 name: test-container volumeMounts: - mountPath: /test-pd name: test-volume volumes: - name: test-volume hostPath: # directory location on host path: /data # this field is optional type: Directory ","date":"2020-02-08T21:10:17Z","image":"https://www.ownit.top/title_pic/70.jpg","permalink":"https://www.ownit.top/p/202002082110/","title":"Kubernetesï¼ˆk8sï¼‰çš„å­˜å‚¨Volume è¯¦ç»†ä»‹ç»"},{"content":"Secret å­˜åœ¨æ„ä¹‰Â **Secret è§£å†³äº†å¯†ç ã€tokenã€å¯†é’¥ç­‰æ•æ„Ÿæ•°æ®çš„é…ç½®é—®é¢˜ï¼Œè€Œä¸éœ€è¦æŠŠè¿™äº›æ•æ„Ÿæ•°æ®æš´éœ²åˆ°é•œåƒæˆ–è€… Pod Spec ä¸­ã€‚Secret å¯ä»¥ä»¥ Volume æˆ–è€…ç¯å¢ƒå˜é‡çš„æ–¹å¼ä½¿ç”¨Â **\nSecret æœ‰ä¸‰ç§ç±»å‹ï¼šÂ Service Account ï¼šç”¨æ¥è®¿é—® Kubernetes APIï¼Œç”± Kubernetes è‡ªåŠ¨åˆ›å»ºï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod çš„/run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸­ Opaque ï¼šbase64ç¼–ç æ ¼å¼çš„Secretï¼Œç”¨æ¥å­˜å‚¨å¯†ç ã€å¯†é’¥ç­‰ kubernetes.io/dockerconï¬gjson ï¼šç”¨æ¥å­˜å‚¨ç§æœ‰ docker registry çš„è®¤è¯ä¿¡æ¯ Service AccountÂ Service Account ç”¨æ¥è®¿é—® Kubernetes APIï¼Œç”± Kubernetes è‡ªåŠ¨åˆ›å»ºï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Podçš„ /run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸­\n1 2 3 4 5 6 7 8 9 $ kubectl run nginx --image nginx deployment \u0026#34;nginx\u0026#34; created $ kubectl get pods NAME READY STATUS RESTARTS AGE nginx-3137573019-md1u2 1/1 Running 0 13s $ kubectl exec nginx-3137573019-md1u2 ls /run/secrets/kubernetes.io/serviceaccount ca.crt namespace token Opaque Secret **Â â… ã€åˆ›å»ºè¯´æ˜Â Opaque ç±»å‹çš„æ•°æ®æ˜¯ä¸€ä¸ª map ç±»å‹ï¼Œè¦æ±‚ value æ˜¯ base64 ç¼–ç æ ¼å¼ï¼š**\n1 2 3 4 $ echo -n \u0026#34;admin\u0026#34; | base64 YWRtaW4= $ echo -n \u0026#34;1f2d1e2e67df\u0026#34; | base64 MWYyZDFlMmU2N2Rm secrets.yaml\n1 2 3 4 5 6 7 8 apiVersion: v1 kind: Secret metadata: name: mysecret type: Opaque data: password: MWYyZDFlMmU2N2Rm username: YWRtaW4= â…¡ã€ä½¿ç”¨æ–¹å¼Â 1ã€å°† Secret æŒ‚è½½åˆ° Volume ä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 kind: Pod metadata: labels: name: seret-test name: seret-test spec: volumes: - name: secrets secret: secretName: mysecret containers: - image: wangyanglinux/myapp:v1 name: db volumeMounts: - name: secrets mountPath: \u0026#34;/etc/secrets\u0026#34; readOnly: true 2ã€å°† Secret å¯¼å‡ºåˆ°ç¯å¢ƒå˜é‡ä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 apiVersion: extensions/v1beta1 kind: Deployment metadata: name: pod-deployment spec: replicas: 2 template: metadata: labels: app: pod-deployment spec: containers: - name: pod-1 image: wangyanglinux/myapp:v1 ports: - containerPort: 80 env: - name: TEST_USER valueFrom: secretKeyRef: name: mysecret key: username - name: TEST_PASSWORD valueFrom: secretKeyRef: name: mysecret key: password kubernetes.io/dockerconï¬gjsonÂ ä½¿ç”¨ Kuberctl åˆ›å»º docker registry è®¤è¯çš„ secret\n1 2 3 $ kubectl create secret docker-registry myregistrykey --docker-server=DOCKER_REGISTRY_SERVER -- docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL secret \u0026#34;myregistrykey\u0026#34; created. åœ¨åˆ›å»º Pod çš„æ—¶å€™ï¼Œé€šè¿‡ imagePullSecrets æ¥å¼•ç”¨åˆšåˆ›å»ºçš„ `myregistrykey`\n1 2 3 4 5 6 7 8 9 10 apiVersion: v1 kind: Pod metadata: name: foo spec: containers: - name: foo image: roc/awangyang:v1 imagePullSecrets: - name: myregistrykey ","date":"2020-02-08T20:02:16Z","image":"https://www.ownit.top/title_pic/44.jpg","permalink":"https://www.ownit.top/p/202002082002/","title":"Kubernetesï¼ˆk8sï¼‰çš„å­˜å‚¨Secret è¯¦ç»†ä»‹ç»"},{"content":"conï¬gMap æè¿°ä¿¡æ¯Â **Conï¬gMap åŠŸèƒ½åœ¨ Kubernetes1.2 ç‰ˆæœ¬ä¸­å¼•å…¥ï¼Œè®¸å¤šåº”ç”¨ç¨‹åºä¼šä»é…ç½®æ–‡ä»¶ã€å‘½ä»¤è¡Œå‚æ•°æˆ–ç¯å¢ƒå˜é‡ä¸­è¯»å–é… ç½®ä¿¡æ¯ã€‚Conï¬gMap API ç»™æˆ‘ä»¬æä¾›äº†å‘å®¹å™¨ä¸­æ³¨å…¥é…ç½®ä¿¡æ¯çš„æœºåˆ¶ï¼ŒConï¬gMap å¯ä»¥è¢«ç”¨æ¥ä¿å­˜å•ä¸ªå±æ€§ï¼Œä¹Ÿ å¯ä»¥ç”¨æ¥ä¿å­˜æ•´ä¸ªé…ç½®æ–‡ä»¶æˆ–è€… JSON äºŒè¿›åˆ¶å¤§å¯¹è±¡Â **\nConï¬gMap çš„åˆ›å»ºÂ â… ã€ä½¿ç”¨ç›®å½•åˆ›å»º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 $ ls docs/user-guide/configmap/kubectl/ game.properties ui.properties $ cat docs/user-guide/configmap/kubectl/game.properties enemies=aliens lives=3 enemies.cheat=true enemies.cheat.level=noGoodRotten secret.code.passphrase=UUDDLRLRBABAS secret.code.allowed=true secret.code.lives=30 $ cat docs/user-guide/configmap/kubectl/ui.properties color.good=purple color.bad=yellow allow.textmode=true how.nice.to.look=fairlyNice $ kubectl create configmap game-config --from-file=docs/user-guide/configmap/kubectl â€”from-file æŒ‡å®šåœ¨ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šè¢«ç”¨åœ¨ Conï¬gMap é‡Œé¢åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹ï¼Œé”®çš„åå­—å°±æ˜¯æ–‡ä»¶åï¼Œå€¼å°± æ˜¯æ–‡ä»¶çš„å†…å®¹\nâ…¡ã€ä½¿ç”¨æ–‡ä»¶åˆ›å»ºÂ åªè¦æŒ‡å®šä¸ºä¸€ä¸ªæ–‡ä»¶å°±å¯ä»¥ä»å•ä¸ªæ–‡ä»¶ä¸­åˆ›å»º Conï¬gMap\n1 2 3 $ kubectl create configmap game-config-2 --from-file=docs/user- guide/configmap/kubectl/game.properties $ kubectl get configmaps game-config-2 -o yaml â€”from-file è¿™ä¸ªå‚æ•°å¯ä»¥ä½¿ç”¨å¤šæ¬¡ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸¤æ¬¡åˆ†åˆ«æŒ‡å®šä¸Šä¸ªå®ä¾‹ä¸­çš„é‚£ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ•ˆæœå°±è·ŸæŒ‡å®šæ•´ä¸ª ç›®å½•æ˜¯ä¸€æ ·çš„\nâ…¢ã€ä½¿ç”¨å­—é¢å€¼åˆ›å»ºÂ ä½¿ç”¨æ–‡å­—å€¼åˆ›å»ºï¼Œåˆ©ç”¨ â€”from-literal å‚æ•°ä¼ é€’é…ç½®ä¿¡æ¯ï¼Œè¯¥å‚æ•°å¯ä»¥ä½¿ç”¨å¤šæ¬¡ï¼Œæ ¼å¼å¦‚ä¸‹\n1 2 3 $ kubectl create configmap special-config --from-literal=special.how=very --from- literal=special.type=charm $ kubectl get configmaps special-config -o yaml Pod ä¸­ä½¿ç”¨ Conï¬gMapÂ â… ã€ä½¿ç”¨ Conï¬gMap æ¥æ›¿ä»£ç¯å¢ƒå˜é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 apiVersion: v1 kind: ConfigMap metadata: name: special-config namespace: default data: special.how: very special.type: charm --- apiVersion: v1 kind: ConfigMap metadata: name: env-config namespace: default data: log_level: INFO Podçš„åˆ›å»º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 apiVersion: v1 kind: Pod metadata: name: dapi-test-pod spec: containers: - name: test-container image: wangyanglinux/myapp:v1 command: [ \u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;env\u0026#34; ] env: - name: SPECIAL_LEVEL_KEY valueFrom: configMapKeyRef: name: special-config key: special.how - name: SPECIAL_TYPE_KEY valueFrom: configMapKeyRef: name: special-config key: special.type envFrom: - configMapRef: name: env-config restartPolicy: Never â…¡ã€ç”¨ Conï¬gMap è®¾ç½®å‘½ä»¤è¡Œå‚æ•°Â 1 2 3 4 5 6 7 8 apiVersion: v1 kind: ConfigMap metadata: name: special-config namespace: default data: special.how: very special.type: charm Podçš„åˆ›å»º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 apiVersion: v1 kind: Pod metadata: name: dapi-test-pod66 spec: containers: - name: test-container image: wangyanglinux/myapp:v1 command: [ \u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo $(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)\u0026#34; ] env: - name: SPECIAL_LEVEL_KEY valueFrom: configMapKeyRef: name: special-config key: special.how - name: SPECIAL_TYPE_KEY valueFrom: configMapKeyRef: name: special-config key: special.type restartPolicy: Never â…¢ã€é€šè¿‡æ•°æ®å·æ’ä»¶ä½¿ç”¨Conï¬gMapÂ 1 2 3 4 5 6 7 8 apiVersion: v1 kind: ConfigMap metadata: name: special-config namespace: default data: special.how: very special.type: charm åœ¨æ•°æ®å·é‡Œé¢ä½¿ç”¨è¿™ä¸ª Conï¬gMapï¼Œæœ‰ä¸åŒçš„é€‰é¡¹ã€‚åŸºæœ¬çš„å°±æ˜¯å°†æ–‡ä»¶å¡«å…¥æ•°æ®å·ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œé”®å°±æ˜¯æ–‡ ä»¶åï¼Œé”®å€¼å°±æ˜¯æ–‡ä»¶å†…å®¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: v1 kind: Pod metadata: name: dapi-test-pod77 spec: containers: - name: test-container image: wangyanglinux/myapp:v1 command: [ \u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;sleep 600s\u0026#34; ] volumeMounts: - name: config-volume mountPath: /etc/config volumes: - name: config-volume configMap: name: special-config restartPolicy: Never Conï¬gMap çš„çƒ­æ›´æ–°Â 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 apiVersion: v1 kind: ConfigMap metadata: name: log-config namespace: default data: log_level: INFO --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: my-nginx spec: replicas: 1 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: wangyanglinux/myapp:v1 ports: - containerPort: 80 volumeMounts: - name: config-volume mountPath: /etc/config volumes: - name: config-volume configMap: name: log-config ä¿®æ”¹ Conï¬gMap\n1 $ kubectl edit configmap log-config Conï¬gMap æ›´æ–°åæ»šåŠ¨æ›´æ–° Pod\næ›´æ–° Conï¬gMap ç›®å‰å¹¶ä¸ä¼šè§¦å‘ç›¸å…³ Pod çš„æ»šåŠ¨æ›´æ–°ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ pod annotations çš„æ–¹å¼å¼ºåˆ¶è§¦å‘æ»šåŠ¨æ›´æ–°\n1 2 $ kubectl patch deployment my-nginx --patch \u0026#39;{\u0026#34;spec\u0026#34;: {\u0026#34;template\u0026#34;: {\u0026#34;metadata\u0026#34;: {\u0026#34;annotations\u0026#34;: {\u0026#34;version/config\u0026#34;: \u0026#34;20190411\u0026#34; }}}}}\u0026#39; è¿™ä¸ªä¾‹å­é‡Œæˆ‘ä»¬åœ¨ .spec.template.metadata.annotations ä¸­æ·»åŠ  version/config ï¼Œæ¯æ¬¡é€šè¿‡ä¿®æ”¹ version/config æ¥è§¦å‘æ»šåŠ¨æ›´æ–°\nï¼ï¼ï¼ æ›´æ–° Conï¬gMap åï¼š\nä½¿ç”¨è¯¥ Conï¬gMap æŒ‚è½½çš„ Env ä¸ä¼šåŒæ­¥æ›´æ–°\n**ä½¿ç”¨è¯¥ Conï¬gMap æŒ‚è½½çš„ Volume ä¸­çš„æ•°æ®éœ€è¦ä¸€æ®µæ—¶é—´ï¼ˆå®æµ‹å¤§æ¦‚10ç§’ï¼‰æ‰èƒ½åŒæ­¥æ›´æ–°Â **\n","date":"2020-02-08T16:34:52Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/202002081634/","title":"Kubernetesï¼ˆk8sï¼‰çš„å­˜å‚¨configmapè¯¦ç»†ä»‹ç»"},{"content":"**åœ¨ Kubernetes v1.0 ç‰ˆæœ¬ï¼Œ Service æ˜¯ â€œ4å±‚â€ï¼ˆTCP/UDP over IPï¼‰æ¦‚å¿µã€‚ åœ¨ Kubernetes v1.1 ç‰ˆæœ¬ï¼Œæ–°å¢äº† Ingress APIï¼ˆbeta ç‰ˆï¼‰ï¼Œç”¨æ¥è¡¨ç¤º â€œ7å±‚â€ï¼ˆHTTPï¼‰æœåŠ¡Â **\nèµ„æ–™ä¿¡æ¯ ã€å¯å®ç°7å±‚ä»£ç†ã€‘\nIngress-Nginx github åœ°å€ï¼šhttps://github.com/kubernetes/ingress-nginx\nIngress-Nginx å®˜æ–¹ç½‘ç«™ï¼šhttps://kubernetes.github.io/ingress-nginx/\néƒ¨ç½² Ingress-NginxÂ ä¸‹è½½Ingress-NginxÂ æ–‡ä»¶\n1 wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.28.0/deploy/static/mandatory.yaml è¿è¡Œé…ç½®æ–‡ä»¶\n1 â€‹â€‹â€‹â€‹chmod -R 777 /var/lib/docker ç»™dockeræƒé™ï¼Œä¸ç„¶ä¼šå‡ºç°é—®é¢˜ã€‚\næˆ‘é‡è§è¿™ä¸ªé—®é¢˜ï¼Œé“¾æ¥ï¼Œä½ ä»¬å¯ä»¥å‚è€ƒä¸€ä¸‹\n1 kubectl get pod -n ingress-nginx ä¸‹è½½ingress-nginxæš´éœ²ç«¯å£é…ç½®æ–‡ä»¶\n1 wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.28.0/deploy/static/provider/baremetal/service-nodeport.yaml 1 kubectl apply -f service-nodeport.yaml Ingress HTTP ä»£ç†è®¿é—®Â **deploymentã€Serviceã€Ingress Yaml æ–‡ä»¶Â **\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 apiVersion: extensions/v1beta1 kind: Deployment metadata: name: nginx-dm spec: replicas: 2 template: metadata: labels: name: nginx spec: containers: - name: nginx image: wangyanglinux/myapp:v1 imagePullPolicy: IfNotPresent ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: nginx-svc spec: ports: - port: 80 targetPort: 80 protocol: TCP selector: name: nginx 1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: extensions/v1beta1 kind: Ingress metadata: name: nginx-test spec: rules: - host: www.heian.com http: paths: - path: / backend: serviceName: nginx-svc servicePort: 80 å®éªŒ deployment1.yamlÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 apiVersion: extensions/v1beta1 kind: Deployment metadata: name: deployment1 spec: replicas: 2 template: metadata: labels: name: nginx spec: containers: - name: nginx image: wangyanglinux/myapp:v1 imagePullPolicy: IfNotPresent ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: svc-1 spec: ports: - port: 80 targetPort: 80 protocol: TCP selector: name: nginx deployment2.yamlÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 apiVersion: extensions/v1beta1 kind: Deployment metadata: name: deployment2 spec: replicas: 2 template: metadata: labels: name: nginx2 spec: containers: - name: nginx2 image: wangyanglinux/myapp:v1 imagePullPolicy: IfNotPresent ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: svc-2 spec: ports: - port: 80 targetPort: 80 protocol: TCP selector: name: nginx2 ingress-nginx 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 apiVersion: extensions/v1beta1 kind: Ingress metadata: name: ingress1 spec: rules: - host: www.heian.com http: paths: - path: / backend: serviceName: svc-1 servicePort: 80 --- apiVersion: extensions/v1beta1 kind: Ingress metadata: name: ingress2 spec: rules: - host: www2.heian.com http: paths: - path: / backend: serviceName: svc-2 servicePort: 80 Ingress HTTPS ä»£ç†è®¿é—®Â åˆ›å»ºè¯ä¹¦ï¼Œä»¥åŠ cert å­˜å‚¨æ–¹å¼Â 1 2 3 openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \u0026#34;/CN=nginxsvc/O=nginxsvc\u0026#34; kubectl create secret tls tls-secret --key tls.key --cert tls.crt deploymentã€Serviceã€Ingress Yaml æ–‡ä»¶Â 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: extensions/v1beta1 kind: Ingress metadata: name: nginx-test spec: tls: - hosts: - foo.bar.com secretName: tls-secret rules: - host: foo.bar.com http: paths: - path: / backend: serviceName: nginx-svc servicePort: 80 Nginx è¿›è¡Œ BasicAuthÂ 1 2 3 yum -y install httpd htpasswd -c auth foo kubectl create secret generic basic-auth --from-file=auth 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: extensions/v1beta1 kind: Ingress metadata: name: ingress-with-auth annotations: nginx.ingress.kubernetes.io/auth-type: basic nginx.ingress.kubernetes.io/auth-secret: basic-auth nginx.ingress.kubernetes.io/auth-realm: \u0026#39;Authentication Required - foo\u0026#39; spec: rules: - host: foo2.bar.com http: paths: - path: / backend: serviceName: nginx-svc servicePort: 80 Nginx è¿›è¡Œé‡å†™Â åç§°æè¿°å€¼nginx.ingress.kubernetes.io/rewritetargetå¿…é¡»é‡å®šå‘æµé‡çš„ç›®æ ‡URI\u0026nbsp;ä¸²nginx.ingress.kubernetes.io/sslredirect\n\u0026nbsp;æŒ‡ç¤ºä½ç½®éƒ¨åˆ†æ˜¯å¦ä»…å¯è®¿é—®SSLï¼ˆå½“IngressåŒ…å«è¯ä¹¦æ—¶ é»˜è®¤ä¸ºTrueï¼‰\n\u0026nbsp;å¸ƒå°”nginx.ingress.kubernetes.io/forcessl-redirectå³ä½¿Ingressæœªå¯ç”¨TLSï¼Œä¹Ÿå¼ºåˆ¶é‡å®šå‘åˆ°HTTPS\n\u0026nbsp;å¸ƒå°”nginx.ingress.kubernetes.io/approotå®šä¹‰Controllerå¿…é¡»é‡å®šå‘çš„åº”ç”¨ç¨‹åºæ ¹ï¼Œå¦‚æœå®ƒåœ¨'/'ä¸Š ä¸‹æ–‡ä¸­\n\u0026nbsp;ä¸²nginx.ingress.kubernetes.io/useregexæŒ‡ç¤ºIngressä¸Šå®šä¹‰çš„è·¯å¾„æ˜¯å¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼\n\u0026nbsp;å¸ƒå°” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 apiVersion: extensions/v1beta1 kind: Ingress metadata: name: nginx-test annotations: nginx.ingress.kubernetes.io/rewrite-target: http://foo.bar.com:31795/hostname.html spec: rules: - host: foo10.bar.com http: paths: - path: / backend: serviceName: nginx-svc servicePort: 80 ","date":"2020-02-06T22:48:16Z","image":"https://www.ownit.top/title_pic/06.jpg","permalink":"https://www.ownit.top/p/202002062248/","title":"Kubernetesï¼ˆk8sï¼‰çš„Service Ingressè¯¦ç»†ä»‹ç»"},{"content":"VIP å’Œ Service ä»£ç†Â **åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œæ¯ä¸ª Node è¿è¡Œä¸€ä¸ª kube-proxy è¿›ç¨‹ã€‚ kube-proxy è´Ÿè´£ä¸º Service å®ç°äº†ä¸€ç§ VIPï¼ˆè™šæ‹Ÿ IPï¼‰çš„å½¢å¼ï¼Œè€Œä¸æ˜¯ ExternalName çš„å½¢å¼ã€‚ åœ¨ Kubernetes v1.0 ç‰ˆæœ¬ï¼Œä»£ç†å®Œå…¨åœ¨ userspaceã€‚åœ¨ Kubernetes v1.1 ç‰ˆæœ¬ï¼Œæ–°å¢äº† iptables ä»£ç†ï¼Œä½†å¹¶ä¸æ˜¯é»˜è®¤çš„è¿è¡Œæ¨¡å¼ã€‚ ä» Kubernetes v1.2 èµ·ï¼Œé»˜è®¤å°±æ˜¯ iptables ä»£ç†ã€‚ åœ¨ Kubernetes v1.8.0-beta.0 ä¸­ï¼Œæ·»åŠ äº† ipvs ä»£ç†Â **\n**åœ¨ Kubernetes 1.14 ç‰ˆæœ¬å¼€å§‹é»˜è®¤ä½¿ç”¨ ipvs ä»£ç†\nåœ¨ Kubernetes v1.0 ç‰ˆæœ¬ï¼Œ Service æ˜¯ â€œ4å±‚â€ï¼ˆTCP/UDP over IPï¼‰æ¦‚å¿µã€‚ åœ¨ Kubernetes v1.1 ç‰ˆæœ¬ï¼Œæ–°å¢äº† Ingress APIï¼ˆbeta ç‰ˆï¼‰ï¼Œç”¨æ¥è¡¨ç¤º â€œ7å±‚â€ï¼ˆHTTPï¼‰æœåŠ¡Â **\nï¼ä¸ºä½•ä¸ä½¿ç”¨ round-robin DNSï¼ŸÂ ä»£ç†æ¨¡å¼çš„åˆ†ç±»Â â… ã€userspace ä»£ç†æ¨¡å¼Â â…¡ã€iptables ä»£ç†æ¨¡å¼Â â…¢ã€ipvs ä»£ç†æ¨¡å¼Â è¿™ç§æ¨¡å¼ï¼Œkube-proxy ä¼šç›‘è§† Kubernetes Service å¯¹è±¡å’Œ Endpoints ï¼Œè°ƒç”¨ netlink æ¥å£ä»¥ç›¸åº”åœ°åˆ›å»º ipvs è§„åˆ™å¹¶å®šæœŸä¸ Kubernetes Service å¯¹è±¡å’Œ Endpoints å¯¹è±¡åŒæ­¥ ipvs è§„åˆ™ï¼Œä»¥ç¡®ä¿ ipvs çŠ¶æ€ä¸æœŸæœ›ä¸€ è‡´ã€‚è®¿é—®æœåŠ¡æ—¶ï¼Œæµé‡å°†è¢«é‡å®šå‘åˆ°å…¶ä¸­ä¸€ä¸ªåç«¯ PodÂ ä¸ iptables ç±»ä¼¼ï¼Œipvs äº netï¬lter çš„ hook åŠŸèƒ½ï¼Œä½†ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„å¹¶åœ¨å†…æ ¸ç©ºé—´ä¸­å·¥ä½œã€‚è¿™æ„ å‘³ç€ ipvs å¯ä»¥æ›´å¿«åœ°é‡å®šå‘æµé‡ï¼Œå¹¶ä¸”åœ¨åŒæ­¥ä»£ç†è§„åˆ™æ—¶å…·æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚æ­¤å¤–ï¼Œipvs ä¸ºè´Ÿè½½å‡è¡¡ç®—æ³•æä¾›äº†æ›´ å¤šé€‰é¡¹ï¼Œä¾‹å¦‚ï¼š\nrr ï¼šè½®è¯¢è°ƒåº¦ lc ï¼šæœ€å°è¿æ¥æ•° dh ï¼šç›®æ ‡å“ˆå¸Œ sh ï¼šæºå“ˆå¸Œ sed ï¼šæœ€çŸ­æœŸæœ›å»¶è¿Ÿ nq ï¼š ä¸æ’é˜Ÿè°ƒåº¦ **åˆ›å»º myapp-deploy.yaml æ–‡ä»¶Â **\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 apiVersion: apps/v1 kind: Deployment metadata: name: myapp-deploy namespace: default spec: replicas: 3 selector: matchLabels: app: myapp release: stabel template: metadata: labels: app: myapp release: stabel env: test spec: containers: - name: myapp image: wangyanglinux/myapp:v2 imagePullPolicy: IfNotPresent ports: - name: http containerPort: 80 åˆ›å»º Service ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: Service metadata: name: myapp namespace: default spec: type: ClusterIP selector: app: myapp release: stabel ports: - name: http port: 80 targetPort: 80 Headless ServiceÂ æœ‰æ—¶ä¸éœ€è¦æˆ–ä¸æƒ³è¦è´Ÿè½½å‡è¡¡ï¼Œä»¥åŠå•ç‹¬çš„ Service IP ã€‚é‡åˆ°è¿™ç§æƒ…å†µï¼Œå¯ä»¥é€šè¿‡æŒ‡å®š Cluster IP(spec.clusterIP) çš„å€¼ä¸º â€œNoneâ€ æ¥åˆ›å»º Headless Service ã€‚è¿™ç±» Service å¹¶ä¸ä¼šåˆ†é… Cluster IPï¼Œ kubeproxy ä¸ä¼šå¤„ç†å®ƒä»¬ï¼Œè€Œä¸”å¹³å°ä¹Ÿä¸ä¼šä¸ºå®ƒä»¬è¿›è¡Œè´Ÿè½½å‡è¡¡å’Œè·¯ç”±\n1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: v1 kind: Service metadata: name: myapp-headless namespace: default spec: selector: app: myapp clusterIP: \u0026#34;None\u0026#34; ports: - port: 80 targetPort: 80 è§£æ 1 dig -t A myapp-headless.default.svc.cluster.local. @10.244.1.2 NodePortÂ nodePort çš„åŸç†åœ¨äºåœ¨ node ä¸Šå¼€äº†ä¸€ä¸ªç«¯å£ï¼Œå°†å‘è¯¥ç«¯å£çš„æµé‡å¯¼å…¥åˆ° kube-proxyï¼Œç„¶åç”± kube-proxy è¿› ä¸€æ­¥åˆ°ç»™å¯¹åº”çš„ pod\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: Service metadata: name: myapp namespace: default spec: type: NodePort selector: app: myapp release: stabel ports: - name: http port: 80 targetPort: 80 LoadBalancerÂ loadBalancer å’Œ nodePort å…¶å®æ˜¯åŒä¸€ç§æ–¹å¼ã€‚åŒºåˆ«åœ¨äº loadBalancer æ¯” nodePort å¤šäº†ä¸€æ­¥ï¼Œå°±æ˜¯å¯ä»¥è°ƒç”¨ cloud provider å»åˆ›å»º LB æ¥å‘èŠ‚ç‚¹å¯¼æµ\nExternalNameÂ è¿™ç§ç±»å‹çš„ Service é€šè¿‡è¿”å› CNAME å’Œå®ƒçš„å€¼ï¼Œå¯ä»¥å°†æœåŠ¡æ˜ å°„åˆ° externalName å­—æ®µçš„å†…å®¹( ä¾‹å¦‚ï¼š hub.atguigu.com )ã€‚ExternalName Service æ˜¯ Service çš„ç‰¹ä¾‹ï¼Œå®ƒæ²¡æœ‰ selectorï¼Œä¹Ÿæ²¡æœ‰å®šä¹‰ä»»ä½•çš„ç«¯å£å’Œ Endpointã€‚ç›¸åçš„ï¼Œå¯¹äºè¿è¡Œåœ¨é›†ç¾¤å¤–éƒ¨çš„æœåŠ¡ï¼Œå®ƒé€šè¿‡è¿”å›è¯¥å¤–éƒ¨æœåŠ¡çš„åˆ«åè¿™ç§æ–¹å¼æ¥æä¾›æœåŠ¡\n1 2 3 4 5 6 7 8 kind: Service apiVersion: v1 metadata: name: my-service-1 namespace: default spec: type: ExternalName externalName: hub.atguigu.com å½“æŸ¥è¯¢ä¸»æœº my-service.defalut.svc.cluster.local ( SVC_NAME.NAMESPACE.svc.cluster.local )æ—¶ï¼Œé›†ç¾¤çš„ DNS æœåŠ¡å°†è¿”å›ä¸€ä¸ªå€¼ my.database.example.com çš„ CNAME è®°å½•ã€‚è®¿é—®è¿™ä¸ªæœåŠ¡çš„å·¥ä½œæ–¹å¼å’Œå…¶ä»–çš„ç›¸ åŒï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯é‡å®šå‘å‘ç”Ÿåœ¨ DNS å±‚ï¼Œè€Œä¸”ä¸ä¼šè¿›è¡Œä»£ç†æˆ–è½¬å‘\n","date":"2020-02-06T19:40:02Z","image":"https://www.ownit.top/title_pic/39.jpg","permalink":"https://www.ownit.top/p/202002061940/","title":"Kubernetesï¼ˆk8sï¼‰çš„Service - ä»£ç†æ¨¡å¼è¯¦ç»†ä»‹ç»"},{"content":"Service çš„æ¦‚å¿µÂ KubernetesÂ Service å®šä¹‰äº†è¿™æ ·ä¸€ç§æŠ½è±¡ï¼šä¸€ä¸ªÂ Pod çš„é€»è¾‘åˆ†ç»„ï¼Œä¸€ç§å¯ä»¥è®¿é—®å®ƒä»¬çš„ç­–ç•¥ â€”â€” é€šå¸¸ç§°ä¸ºå¾® æœåŠ¡ã€‚ è¿™ä¸€ç»„Â Pod èƒ½å¤Ÿè¢«Â Service è®¿é—®åˆ°ï¼Œé€šå¸¸æ˜¯é€šè¿‡Â Label Selector\nServiceèƒ½å¤Ÿæä¾›è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ä¸Šæœ‰ä»¥ä¸‹é™åˆ¶ï¼š\nåªæä¾› 4 å±‚è´Ÿè½½å‡è¡¡èƒ½åŠ›ï¼Œè€Œæ²¡æœ‰ 7 å±‚åŠŸèƒ½ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬å¯èƒ½éœ€è¦æ›´å¤šçš„åŒ¹é…è§„åˆ™æ¥è½¬å‘è¯·æ±‚ï¼Œè¿™ç‚¹ä¸Š 4 å±‚ è´Ÿè½½å‡è¡¡æ˜¯ä¸æ”¯æŒçš„\n**Service çš„ç±»å‹Â ** **Service åœ¨ K8s ä¸­æœ‰ä»¥ä¸‹å››ç§ç±»å‹Â **\nClusterIpï¼šé»˜è®¤ç±»å‹ï¼Œè‡ªåŠ¨åˆ†é…ä¸€ä¸ªä»… Cluster å†…éƒ¨å¯ä»¥è®¿é—®çš„è™šæ‹Ÿ IP NodePortï¼šåœ¨ ClusterIP åŸºç¡€ä¸Šä¸º Service åœ¨æ¯å°æœºå™¨ä¸Šç»‘å®šä¸€ä¸ªç«¯å£ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ : NodePort æ¥è®¿é—®è¯¥æœåŠ¡ LoadBalancerï¼šåœ¨ NodePort çš„åŸºç¡€ä¸Šï¼Œå€ŸåŠ© cloud provider åˆ›å»ºä¸€ä¸ªå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘åˆ°: NodePort ExternalNameï¼šæŠŠé›†ç¾¤å¤–éƒ¨çš„æœåŠ¡å¼•å…¥åˆ°é›†ç¾¤å†…éƒ¨æ¥ï¼Œåœ¨é›†ç¾¤å†…éƒ¨ç›´æ¥ä½¿ç”¨ã€‚æ²¡æœ‰ä»»ä½•ç±»å‹ä»£ç†è¢«åˆ›å»ºï¼Œè¿™åªæœ‰ kubernetes 1.7 æˆ–æ›´é«˜ç‰ˆæœ¬çš„ kube-dns æ‰æ”¯æŒ ","date":"2020-02-06T17:06:27Z","image":"https://www.ownit.top/title_pic/35.jpg","permalink":"https://www.ownit.top/p/202002061706/","title":"Kubernetesï¼ˆk8sï¼‰çš„Service - å®šä¹‰"},{"content":"ä»€ä¹ˆæ˜¯ DaemonSetÂ DaemonSet ç¡®ä¿å…¨éƒ¨ï¼ˆæˆ–è€…ä¸€äº›ï¼‰Node ä¸Šè¿è¡Œä¸€ä¸ª Pod çš„å‰¯æœ¬ã€‚å½“æœ‰ Node åŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿä¼šä¸ºä»–ä»¬æ–°å¢ä¸€ ä¸ª Pod ã€‚å½“æœ‰ Node ä»é›†ç¾¤ç§»é™¤æ—¶ï¼Œè¿™äº› Pod ä¹Ÿä¼šè¢«å›æ”¶ã€‚åˆ é™¤ DaemonSet å°†ä¼šåˆ é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰ Pod\nä½¿ç”¨ DaemonSet çš„ä¸€äº›å…¸å‹ç”¨æ³•ï¼š\nè¿è¡Œé›†ç¾¤å­˜å‚¨ daemonï¼Œä¾‹å¦‚åœ¨æ¯ä¸ª Node ä¸Šè¿è¡Œ glusterd ã€ ceph åœ¨æ¯ä¸ª Node ä¸Šè¿è¡Œæ—¥å¿—æ”¶é›† daemonï¼Œä¾‹å¦‚ fluentd ã€ logstash åœ¨æ¯ä¸ª Node ä¸Šè¿è¡Œç›‘æ§ daemonï¼Œä¾‹å¦‚ Prometheus Node Exporterã€ collectd ã€Datadog ä»£ç†ã€ New Relic ä»£ç†ï¼Œæˆ– Ganglia gmond 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: apps/v1 kind: DaemonSet metadata: name: deamonset-example labels: app: daemonset spec: selector: matchLabels: name: deamonset-example template: metadata: labels: name: deamonset-example spec: containers: - name: daemonset-example image: wangyanglinux/myapp:v1 JobÂ **Job è´Ÿè´£æ‰¹å¤„ç†ä»»åŠ¡ï¼Œå³ä»…æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œå®ƒä¿è¯æ‰¹å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªæˆ–å¤šä¸ª Pod æˆåŠŸç»“æŸÂ **\n**ç‰¹æ®Šè¯´æ˜Â **\nspec.templateæ ¼å¼åŒPod RestartPolicyä»…æ”¯æŒNeveræˆ–OnFailure å•ä¸ªPodæ—¶ï¼Œé»˜è®¤PodæˆåŠŸè¿è¡ŒåJobå³ç»“æŸ .spec.completions æ ‡å¿—Jobç»“æŸéœ€è¦æˆåŠŸè¿è¡Œçš„Podä¸ªæ•°ï¼Œé»˜è®¤ä¸º1 .spec.parallelism æ ‡å¿—å¹¶è¡Œè¿è¡Œçš„Podçš„ä¸ªæ•°ï¼Œé»˜è®¤ä¸º1 spec.activeDeadlineSeconds æ ‡å¿—å¤±è´¥Podçš„é‡è¯•å¤§æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ä¸ä¼šç»§ç»­é‡è¯•\nExample\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: batch/v1 kind: Job metadata: name: pi spec: template: metadata: name: pi spec: containers: - name: pi image: perl command: [\u0026#34;perl\u0026#34;, \u0026#34;-Mbignum=bpi\u0026#34;, \u0026#34;-wle\u0026#34;, \u0026#34;print bpi(2000)\u0026#34;] restartPolicy: Never CronJob SpecÂ spec.templateæ ¼å¼åŒPod RestartPolicyä»…æ”¯æŒNeveræˆ–OnFailure å•ä¸ªPodæ—¶ï¼Œé»˜è®¤PodæˆåŠŸè¿è¡ŒåJobå³ç»“æŸ .spec.completions æ ‡å¿—Jobç»“æŸéœ€è¦æˆåŠŸè¿è¡Œçš„Podä¸ªæ•°ï¼Œé»˜è®¤ä¸º1 . spec.parallelism æ ‡å¿—å¹¶è¡Œè¿è¡Œçš„Podçš„ä¸ªæ•°ï¼Œé»˜è®¤ä¸º1 spec.activeDeadlineSeconds æ ‡å¿—å¤±è´¥Podçš„é‡è¯•å¤§æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ä¸ä¼šç»§ç»­é‡è¯•\nCronJobÂ Cron JobÂ ç®¡ç†åŸºäºæ—¶é—´çš„Â Jobï¼Œå³ï¼š\nåœ¨ç»™å®šæ—¶é—´ç‚¹åªè¿è¡Œä¸€æ¬¡ å‘¨æœŸæ€§åœ°åœ¨ç»™å®šæ—¶é—´ç‚¹è¿è¡Œ\nä½¿ç”¨æ¡ä»¶ï¼šå½“å‰ä½¿ç”¨çš„ Kubernetes é›†ç¾¤ï¼Œç‰ˆæœ¬ \u0026gt;= 1.8ï¼ˆå¯¹ CronJobï¼‰\nå…¸å‹çš„ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š\nåœ¨ç»™å®šçš„æ—¶é—´ç‚¹è°ƒåº¦ Job è¿è¡Œ åˆ›å»ºå‘¨æœŸæ€§è¿è¡Œçš„ Jobï¼Œä¾‹å¦‚ï¼šæ•°æ®åº“å¤‡ä»½ã€å‘é€é‚®ä»¶\nCronJob SpecÂ .spec.schedule ï¼šè°ƒåº¦ï¼Œå¿…éœ€å­—æ®µï¼ŒæŒ‡å®šä»»åŠ¡è¿è¡Œå‘¨æœŸï¼Œæ ¼å¼åŒ Cron .spec.jobTemplate ï¼šJob æ¨¡æ¿ï¼Œå¿…éœ€å­—æ®µï¼ŒæŒ‡å®šéœ€è¦è¿è¡Œçš„ä»»åŠ¡ï¼Œæ ¼å¼åŒ Job .spec.startingDeadlineSeconds ï¼šå¯åŠ¨ Job çš„æœŸé™ï¼ˆç§’çº§åˆ«ï¼‰ï¼Œè¯¥å­—æ®µæ˜¯å¯é€‰çš„ã€‚å¦‚æœå› ä¸ºä»»ä½•åŸå› è€Œé”™è¿‡äº†è¢«è°ƒåº¦çš„æ—¶é—´ï¼Œé‚£ä¹ˆé”™è¿‡æ‰§è¡Œæ—¶é—´çš„ Job å°†è¢«è®¤ä¸ºæ˜¯å¤±è´¥çš„ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™æ²¡æœ‰æœŸé™ .spec.concurrencyPolicy ï¼šå¹¶å‘ç­–ç•¥ï¼Œè¯¥å­—æ®µä¹Ÿæ˜¯å¯é€‰çš„ã€‚å®ƒæŒ‡å®šäº†å¦‚ä½•å¤„ç†è¢« Cron Job åˆ›å»ºçš„ Job çš„å¹¶å‘æ‰§è¡Œã€‚åªå…è®¸æŒ‡å®šä¸‹é¢ç­–ç•¥ä¸­çš„ä¸€ç§ï¼š Allow ï¼ˆé»˜è®¤ï¼‰ï¼šå…è®¸å¹¶å‘è¿è¡Œ Job Forbid ï¼šç¦æ­¢å¹¶å‘è¿è¡Œï¼Œå¦‚æœå‰ä¸€ä¸ªè¿˜æ²¡æœ‰å®Œæˆï¼Œåˆ™ç›´æ¥è·³è¿‡ä¸‹ä¸€ä¸ª Replace ï¼šå–æ¶ˆå½“å‰æ­£åœ¨è¿è¡Œçš„ Jobï¼Œç”¨ä¸€ä¸ªæ–°çš„æ¥æ›¿æ¢ æ³¨æ„ï¼Œå½“å‰ç­–ç•¥åªèƒ½åº”ç”¨äºåŒä¸€ä¸ª Cron Job åˆ›å»ºçš„ Jobã€‚å¦‚æœå­˜åœ¨å¤šä¸ª Cron Jobï¼Œå®ƒä»¬åˆ›å»ºçš„ Job ä¹‹é—´æ€»\næ˜¯å…è®¸å¹¶å‘è¿è¡Œã€‚\n.spec.suspend ï¼šæŒ‚èµ·ï¼Œè¯¥å­—æ®µä¹Ÿæ˜¯å¯é€‰çš„ã€‚å¦‚æœè®¾ç½®ä¸º true ï¼Œåç»­æ‰€æœ‰æ‰§è¡Œéƒ½ä¼šè¢«æŒ‚èµ·ã€‚å®ƒå¯¹å·²ç»å¼€å§‹æ‰§è¡Œçš„ Job ä¸èµ·ä½œç”¨ã€‚é»˜è®¤å€¼ä¸º false ã€‚ .spec.successfulJobsHistoryLimit å’Œ .spec.failedJobsHistoryLimit ï¼šå†å²é™åˆ¶ï¼Œæ˜¯å¯é€‰çš„å­—æ®µã€‚å®ƒä»¬æŒ‡å®šäº†å¯ä»¥ä¿ç•™å¤šå°‘å®Œæˆå’Œå¤±è´¥çš„ Jobã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»¬åˆ†åˆ«è®¾ç½®ä¸º 3 å’Œ 1 ã€‚è®¾ç½®é™åˆ¶çš„å€¼ä¸º 0 ï¼Œç›¸å…³ç±»å‹çš„ Job å®Œæˆåå°†ä¸ä¼šè¢«ä¿ç•™ã€‚ Example 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: batch/v1beta1 kind: CronJob metadata: name: hello spec: schedule: \u0026#34;*/1 * * * *\u0026#34; jobTemplate: spec: template: spec: containers: - name: hello image: busybox args: - /bin/sh - -c - date; echo Hello from the Kubernetes cluster restartPolicy: OnFailure 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ kubectl get cronjob NAME SCHEDULE SUSPEND ACTIVE LAST-SCHEDULE hello */1 * * * * False 0 \u0026lt;none\u0026gt; $ kubectl get jobs NAME DESIRED SUCCESSFUL AGE hello-1202039034 1 1 49s $ pods=$(kubectl get pods --selector=job-name=hello-1202039034 --output=jsonpath= {.items..metadata.name}) $ kubectl logs $pods Mon Aug 29 21:34:09 UTC 2016 Hello from the Kubernetes cluster # æ³¨æ„ï¼Œåˆ é™¤ cronjob çš„æ—¶å€™ä¸ä¼šè‡ªåŠ¨åˆ é™¤ jobï¼Œè¿™äº› job å¯ä»¥ç”¨ kubectl delete job æ¥åˆ é™¤ $ kubectl delete cronjob hello cronjob \u0026#34;hello\u0026#34; deleted CrondJob æœ¬èº«çš„ä¸€äº›é™åˆ¶Â åˆ›å»º Job æ“ä½œåº”è¯¥æ˜¯ å¹‚ç­‰çš„\n","date":"2020-02-05T21:34:32Z","image":"https://www.ownit.top/title_pic/74.jpg","permalink":"https://www.ownit.top/p/202002052134/","title":"Kubernetesï¼ˆk8sï¼‰èµ„æºæ§åˆ¶å™¨Daemonsetã€Jobã€CronJobè¯¦ç»†ä»‹ç»"},{"content":"RS ä¸ RC ä¸ Deployment å…³è”Â RC ï¼ˆReplicationController ï¼‰ä¸»è¦çš„ä½œç”¨å°±æ˜¯ç”¨æ¥ç¡®ä¿å®¹å™¨åº”ç”¨çš„å‰¯æœ¬æ•°å§‹ç»ˆä¿æŒåœ¨ç”¨æˆ·å®šä¹‰çš„å‰¯æœ¬æ•° ã€‚å³å¦‚ æœæœ‰å®¹å™¨å¼‚å¸¸é€€å‡ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„Podæ¥æ›¿ä»£ï¼›è€Œå¦‚æœå¼‚å¸¸å¤šå‡ºæ¥çš„å®¹å™¨ä¹Ÿä¼šè‡ªåŠ¨å›æ”¶Â Kubernetes å®˜æ–¹å»ºè®®ä½¿ç”¨ RSï¼ˆReplicaSet ï¼‰ æ›¿ä»£ RC ï¼ˆReplicationController ï¼‰ è¿›è¡Œéƒ¨ç½²ï¼ŒRS è·Ÿ RC æ²¡æœ‰ æœ¬è´¨çš„ä¸åŒï¼Œåªæ˜¯åå­—ä¸ä¸€æ ·ï¼Œå¹¶ä¸” RS æ”¯æŒé›†åˆå¼çš„ selector\nRSï¼ˆReplicaSet ï¼‰åˆ›å»º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 apiVersion: extensions/v1beta1 kind: ReplicaSet metadata: name: frontend spec: replicas: 2 selector: matchLabels: tier: frontend template: metadata: labels: tier: frontend spec: containers: - name: myapp image: wangyanglinux/myapp:v1 env: - name: GET_HOSTS_FROM value: dns ports: - containerPort: 80 rsè¿™ä¸ªåˆ›å»ºpodæœ‰ç‚¹æ…¢\næŸ¥çœ‹podçš„æ ‡ç­¾\n1 kubectl get pod --show-labels ä¿®æ”¹podçš„æ ‡ç­¾\n1 kubectl label pod frontend-dtx7t tier=frontend1 --overwrite=True åˆ é™¤rs\n1 kubectl delete rs --all RS ä¸ Deployment çš„å…³è”Â **Deployment ä¸º Pod å’Œ ReplicaSet æä¾›äº†ä¸€ä¸ªå£°æ˜å¼å®šä¹‰(declarative)æ–¹æ³•ï¼Œç”¨æ¥æ›¿ä»£ä»¥å‰çš„ ReplicationController æ¥æ–¹ä¾¿çš„ç®¡ç†åº”ç”¨ã€‚å…¸å‹çš„åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼šÂ **\nå®šä¹‰Deploymentæ¥åˆ›å»ºPodå’ŒReplicaSet æ»šåŠ¨å‡çº§å’Œå›æ»šåº”ç”¨ æ‰©å®¹å’Œç¼©å®¹ æš‚åœå’Œç»§ç»­Deployment\nâ… ã€éƒ¨ç½²ä¸€ä¸ªç®€å•çš„ Nginx åº”ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: extensions/v1beta1 kind: Deployment metadata: name: nginx-deployment spec: replicas: 3 template: metadata: labels: app: nginx spec: containers: - name: nginx image: wangyanglinux/myapp:v1 ports: - containerPort: 80 1 2 kubectl create -f https://kubernetes.io/docs/user-guide/nginx-deployment.yaml --record ## --recordå‚æ•°å¯ä»¥è®°å½•å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„æŸ¥çœ‹æ¯æ¬¡ revision çš„å˜åŒ– åˆ›å»º\n1 kubectl apply -f deploy.yaml --record æ˜¾ç¤ºæ ‡ç­¾\n1 kubectl get pod --show-labels â…¡ã€æ‰©å®¹ 1 kubectl scale deployment nginx-deployment --replicas 10 â…¢ã€å¦‚æœé›†ç¾¤æ”¯æŒ horizontal pod autoscaling çš„è¯ï¼Œè¿˜å¯ä»¥ä¸ºDeploymentè®¾ç½®è‡ªåŠ¨æ‰©å±• 1 kubectl autoscale deployment nginx-deployment --min=10 --max=15 --cpu-percent=80 â…£ã€æ›´æ–°é•œåƒä¹Ÿæ¯”è¾ƒç®€å• 1 kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1 â…¤ã€å›æ»š 1 kubectl rollout undo deployment/nginx-deployment æ›´æ–° DeploymentÂ å‡å¦‚æˆ‘ä»¬ç°åœ¨æƒ³è¦è®© nginx pod ä½¿ç”¨ nginx:1.9.1 çš„é•œåƒæ¥ä»£æ›¿åŸæ¥çš„ nginx:1.7.9 çš„é•œåƒ\n1 2 $ kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1 deployment \u0026#34;nginx-deployment\u0026#34; image updated å¯ä»¥ä½¿ç”¨ edit å‘½ä»¤æ¥ç¼–è¾‘ Deployment 1 2 $ kubectl edit deployment/nginx-deployment deployment \u0026#34;nginx-deployment\u0026#34; edited æŸ¥çœ‹ rollout çš„çŠ¶æ€ 1 2 3 $ kubectl rollout status deployment/nginx-deployment Waiting for rollout to finish: 2 out of 3 new replicas have been updated... deployment \u0026#34;nginx-deployment\u0026#34; successfully rolled out æŸ¥çœ‹å†å² RS 1 2 3 4 $ kubectl get rs NAME DESIRED CURRENT READY AGE nginx-deployment-1564180365 3 3 0 6s nginx-deployment-2035384211 0 0 0 36s Deployment æ›´æ–°ç­–ç•¥Â Deployment å¯ä»¥ä¿è¯åœ¨å‡çº§æ—¶åªæœ‰ä¸€å®šæ•°é‡çš„ Pod æ˜¯ down çš„ã€‚é»˜è®¤çš„ï¼Œå®ƒä¼šç¡®ä¿è‡³å°‘æœ‰æ¯”æœŸæœ›çš„Podæ•°é‡å°‘ ä¸€ä¸ªæ˜¯upçŠ¶æ€ï¼ˆå¤šä¸€ä¸ªä¸å¯ç”¨ï¼‰\nDeployment åŒæ—¶ä¹Ÿå¯ä»¥ç¡®ä¿åªåˆ›å»ºå‡ºè¶…è¿‡æœŸæœ›æ•°é‡çš„ä¸€å®šæ•°é‡çš„ Podã€‚é»˜è®¤çš„ï¼Œå®ƒä¼šç¡®ä¿å¤šæ¯”æœŸæœ›çš„Podæ•° é‡å¤šä¸€ä¸ªçš„ Pod æ˜¯ up çš„ï¼ˆå¤š1ä¸ª surge ï¼‰\næœªæ¥çš„ Kuberentes ç‰ˆæœ¬ä¸­ï¼Œå°†ä»1-1å˜æˆ25%-25%\n1 kubectl describe deployments Rolloverï¼ˆå¤šä¸ªrolloutå¹¶è¡Œï¼‰Â å‡å¦‚æ‚¨åˆ›å»ºäº†ä¸€ä¸ªæœ‰5ä¸ª niginx:1.7.9 replicaçš„ Deploymentï¼Œä½†æ˜¯å½“è¿˜åªæœ‰3ä¸ª nginx:1.7.9 çš„ replica åˆ›å»º å‡ºæ¥çš„æ—¶å€™æ‚¨å°±å¼€å§‹æ›´æ–°å«æœ‰5ä¸ª nginx:1.9.1 replica çš„ Deploymentã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒDeployment ä¼šç«‹å³ æ€æ‰å·²åˆ›å»ºçš„3ä¸ª nginx:1.7.9 çš„ Podï¼Œå¹¶å¼€å§‹åˆ›å»º nginx:1.9.1 çš„ Podã€‚å®ƒä¸ä¼šç­‰åˆ°æ‰€æœ‰çš„5ä¸ª nginx:1.7.9 çš„ Pod éƒ½åˆ›å»ºå®Œæˆåæ‰å¼€å§‹æ”¹å˜èˆªé“Â å›é€€ DeploymentÂ 1 2 3 4 5 6 7 8 kubectl set image deployment/nginx-deployment nginx=nginx:1.91 kubectl rollout status deployments nginx-deployment kubectl get pods kubectl rollout history deployment/nginx-deployment kubectl rollout undo deployment/nginx-deployment kubectl rollout undo deployment/nginx-deployment --to-revision=2 ## å¯ä»¥ä½¿ç”¨ --revisionå‚æ•°æŒ‡å®š æŸä¸ªå†å²ç‰ˆæœ¬ kubectl rollout pause deployment/nginx-deployment ## æš‚åœ deployment çš„æ›´æ–° æ‚¨å¯ä»¥ç”¨ kubectl rollout status å‘½ä»¤æŸ¥çœ‹ Deployment æ˜¯å¦å®Œæˆã€‚å¦‚æœ rollout æˆåŠŸå®Œæˆï¼Œ kubectl rollout status å°†è¿”å›ä¸€ä¸ª0å€¼çš„ Exit Code\n1 2 3 4 5 $ kubectl rollout status deploy/nginx Waiting for rollout to finish: 2 of 3 updated replicas are available... deployment \u0026#34;nginx\u0026#34; successfully rolled out $ echo $? 0 æ¸…ç† PolicyÂ æ‚¨å¯ä»¥é€šè¿‡è®¾ç½® .spec.revisonHistoryLimit é¡¹æ¥æŒ‡å®š deployment å¤šä¿ç•™å¤šå°‘ revision å†å²è®°å½•ã€‚é»˜è®¤çš„ä¼š ä¿ç•™æ‰€æœ‰çš„ revisionï¼›å¦‚æœå°†è¯¥é¡¹è®¾ç½®ä¸º0ï¼ŒDeployment å°±ä¸å…è®¸å›é€€äº†\n","date":"2020-02-05T14:34:28Z","image":"https://www.ownit.top/title_pic/11.jpg","permalink":"https://www.ownit.top/p/202002051434/","title":"Kubernetesï¼ˆk8sï¼‰èµ„æºæ§åˆ¶å™¨ RSã€Deploymentè¯¦ç»†ä»‹ç»"},{"content":"Podçš„åˆ†ç±» è‡ªåŠ©å¼Pod: podé€€å‡ºäº†ï¼Œæ­¤ç±»å‹çš„podä¸ä¼šè¢«åˆ›å»º æ§åˆ¶å™¨ç®¡ç†çš„Podï¼šåœ¨æ§åˆ¶å™¨çš„ç”Ÿå‘½å‘¨æœŸé‡Œï¼Œå§‹ç»ˆè¦ç»´æŒPodçš„å‰¯æœ¬æ•° **ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨Â ** Kubernetes ä¸­å†…å»ºäº†å¾ˆå¤š controllerï¼ˆæ§åˆ¶å™¨ï¼‰ï¼Œè¿™äº›ç›¸å½“äºä¸€ä¸ªçŠ¶æ€æœºï¼Œç”¨æ¥æ§åˆ¶ Pod çš„å…·ä½“çŠ¶æ€å’Œè¡Œä¸ºÂ **æ§åˆ¶å™¨ç±»å‹Â ** ReplicationController å’Œ ReplicaSet Deployment DaemonSet StateFulSet J ob/CronJob Horizontal Pod AutoscalingÂ **ReplicationController å’Œ ReplicaSetÂ ** ReplicationControllerï¼ˆRCï¼‰ç”¨æ¥ç¡®ä¿å®¹å™¨åº”ç”¨çš„å‰¯æœ¬æ•°å§‹ç»ˆä¿æŒåœ¨ç”¨æˆ·å®šä¹‰çš„å‰¯æœ¬æ•°ï¼Œå³å¦‚æœæœ‰å®¹å™¨å¼‚å¸¸é€€ å‡ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ Pod æ¥æ›¿ä»£ï¼›è€Œå¦‚æœå¼‚å¸¸å¤šå‡ºæ¥çš„å®¹å™¨ä¹Ÿä¼šè‡ªåŠ¨å›æ”¶ï¼›\nåœ¨æ–°ç‰ˆæœ¬çš„ Kubernetes ä¸­å»ºè®®ä½¿ç”¨ ReplicaSet æ¥å–ä»£ ReplicationController ã€‚ReplicaSet è·Ÿ ReplicationController æ²¡æœ‰æœ¬è´¨çš„ä¸åŒï¼Œåªæ˜¯åå­—ä¸ä¸€æ ·ï¼Œå¹¶ä¸” ReplicaSet æ”¯æŒé›†åˆå¼çš„ selectorï¼›Â **DeploymentÂ ** Deployment ä¸º Pod å’Œ ReplicaSet æä¾›äº†ä¸€ä¸ªå£°æ˜å¼å®šä¹‰ (declarative) æ–¹æ³•ï¼Œç”¨æ¥æ›¿ä»£ä»¥å‰çš„ ReplicationController æ¥æ–¹ä¾¿çš„ç®¡ç†åº”ç”¨ã€‚å…¸å‹çš„åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼›Â å®šä¹‰ Deployment æ¥åˆ›å»º Pod å’Œ ReplicaSet æ»šåŠ¨å‡çº§å’Œå›æ»šåº”ç”¨ æ‰©å®¹å’Œç¼©å®¹ æš‚åœå’Œç»§ç»­ Deployment\nDaemonSetÂ DaemonSetÂ ç¡®ä¿å…¨éƒ¨ï¼ˆæˆ–è€…ä¸€äº›ï¼‰Node ä¸Šè¿è¡Œä¸€ä¸ª Pod çš„å‰¯æœ¬ã€‚å½“æœ‰ Node åŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿä¼šä¸ºä»–ä»¬æ–°å¢ä¸€ä¸ª Pod ã€‚å½“æœ‰ Node ä»é›†ç¾¤ç§»é™¤æ—¶ï¼Œè¿™äº› Pod ä¹Ÿä¼šè¢«å›æ”¶ã€‚åˆ é™¤ DaemonSet å°†ä¼šåˆ é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰ Pod\n**ä½¿ç”¨ DaemonSet çš„ä¸€äº›å…¸å‹ç”¨æ³•ï¼šÂ **\nè¿è¡Œé›†ç¾¤å­˜å‚¨ daemonï¼Œä¾‹å¦‚åœ¨æ¯ä¸ª Node ä¸Šè¿è¡Œ glusterd ã€ ceph åœ¨æ¯ä¸ª Node ä¸Šè¿è¡Œæ—¥å¿—æ”¶é›† daemonï¼Œä¾‹å¦‚ fluentd ã€ logstash åœ¨æ¯ä¸ª Node ä¸Šè¿è¡Œç›‘æ§ daemonï¼Œä¾‹å¦‚ Prometheus Node Exporterã€ collectd ã€Datadog ä»£ç†ã€ New Relic ä»£ç†ï¼Œæˆ– Ganglia gmond JobÂ Job è´Ÿè´£æ‰¹å¤„ç†ä»»åŠ¡ï¼Œå³ä»…æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œå®ƒä¿è¯æ‰¹å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªæˆ–å¤šä¸ª Pod æˆåŠŸç»“æŸÂ CronJobÂ Cron JobÂ ç®¡ç†åŸºäºæ—¶é—´çš„ Jobï¼Œå³ï¼š\nåœ¨ç»™å®šæ—¶é—´ç‚¹åªè¿è¡Œä¸€æ¬¡ å‘¨æœŸæ€§åœ°åœ¨ç»™å®šæ—¶é—´ç‚¹è¿è¡Œ ä½¿ç”¨å‰ææ¡ä»¶ï¼š**å½“å‰ä½¿ç”¨çš„ Kubernetes é›†ç¾¤ï¼Œç‰ˆæœ¬ \u0026gt;= 1.8ï¼ˆå¯¹ CronJobï¼‰ã€‚å¯¹äºå…ˆå‰ç‰ˆæœ¬çš„é›†ç¾¤ï¼Œç‰ˆæœ¬ \u0026lt; 1.8ï¼Œå¯åŠ¨ API Serveræ—¶ï¼Œé€šè¿‡ä¼ é€’é€‰é¡¹Â --runtime-config=batch/v2alpha1=true å¯ä»¥å¼€å¯ batch/v2alpha1 API**\nå…¸å‹çš„ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š\nåœ¨ç»™å®šçš„æ—¶é—´ç‚¹è°ƒåº¦ Job è¿è¡Œ åˆ›å»ºå‘¨æœŸæ€§è¿è¡Œçš„ Jobï¼Œä¾‹å¦‚ï¼šæ•°æ®åº“å¤‡ä»½ã€å‘é€é‚®ä»¶ StatefulSetÂ StatefulSet ä½œä¸º Controller ä¸º Pod æä¾›å”¯ä¸€çš„æ ‡è¯†ã€‚å®ƒå¯ä»¥ä¿è¯éƒ¨ç½²å’Œ scale çš„é¡ºåºÂ StatefulSetæ˜¯ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜ï¼ˆå¯¹åº”Deploymentså’ŒReplicaSetsæ˜¯ä¸ºæ— çŠ¶æ€æœåŠ¡è€Œè®¾è®¡ï¼‰ï¼Œå…¶åº”ç”¨ åœºæ™¯åŒ…æ‹¬ï¼š\nç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå³Podé‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäºPVCæ¥å®ç° ç¨³å®šçš„ç½‘ç»œæ ‡å¿—ï¼Œå³Podé‡æ–°è°ƒåº¦åå…¶PodNameå’ŒHostNameä¸å˜ï¼ŒåŸºäºHeadless Serviceï¼ˆå³æ²¡æœ‰ Cluster IPçš„Serviceï¼‰æ¥å®ç° æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•ï¼Œå³Podæ˜¯æœ‰é¡ºåºçš„ï¼Œåœ¨éƒ¨ç½²æˆ–è€…æ‰©å±•çš„æ—¶å€™è¦ä¾æ®å®šä¹‰çš„é¡ºåºä¾æ¬¡ä¾æ¬¡è¿›è¡Œï¼ˆå³ä»0åˆ° N-1ï¼Œåœ¨ä¸‹ä¸€ä¸ªPodè¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„Podå¿…é¡»éƒ½æ˜¯Runningå’ŒReadyçŠ¶æ€ï¼‰ï¼ŒåŸºäºinit containersæ¥å® ç° æœ‰åºæ”¶ç¼©ï¼Œæœ‰åºåˆ é™¤ï¼ˆå³ä»N-1åˆ°0ï¼‰\nHorizontal Pod AutoscalingÂ åº”ç”¨çš„èµ„æºä½¿ç”¨ç‡é€šå¸¸éƒ½æœ‰é«˜å³°å’Œä½è°·çš„æ—¶å€™ï¼Œå¦‚ä½•å‰Šå³°å¡«è°·ï¼Œæé«˜é›†ç¾¤çš„æ•´ä½“èµ„æºåˆ©ç”¨ç‡ï¼Œè®©serviceä¸­çš„Pod ä¸ªæ•°è‡ªåŠ¨è°ƒæ•´å‘¢ï¼Ÿè¿™å°±æœ‰èµ–äºHorizontal Pod Autoscalingäº†ï¼Œé¡¾åæ€ä¹‰ï¼Œä½¿Podæ°´å¹³è‡ªåŠ¨ç¼©æ”¾\n","date":"2020-02-04T20:47:17Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/202002042047/","title":"Kubernetesï¼ˆk8sï¼‰èµ„æºæ§åˆ¶å™¨è¯¦ç»†è¯´æ˜"},{"content":"Kubernetes podçš„æ¢é’ˆ æ¢é’ˆæ˜¯ç”±Â kubeletÂ å¯¹å®¹å™¨æ‰§è¡Œçš„å®šæœŸè¯Šæ–­ã€‚è¦æ‰§è¡Œè¯Šæ–­ï¼Œkubelet è°ƒç”¨ç”±å®¹å™¨å®ç°çš„Â Handlerã€‚æœ‰ä¸‰ç§ç±»å‹çš„å¤„ç†ç¨‹åºï¼š\nÃ˜ ExecActionï¼šåœ¨å®¹å™¨å†…æ‰§è¡ŒæŒ‡å®šå‘½ä»¤ã€‚å¦‚æœå‘½ä»¤é€€å‡ºæ—¶è¿”å›ç ä¸º 0 åˆ™è®¤ä¸ºè¯Šæ–­æˆåŠŸã€‚ Ã˜ TCPSocketActionï¼šå¯¹æŒ‡å®šç«¯å£ä¸Šçš„å®¹å™¨çš„ IP åœ°å€è¿›è¡Œ TCP æ£€æŸ¥ã€‚å¦‚æœç«¯å£æ‰“å¼€ï¼Œåˆ™è¯Šæ–­è¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚ Ã˜ HTTPGetActionï¼šå¯¹æŒ‡å®šçš„ç«¯å£å’Œè·¯å¾„ä¸Šçš„å®¹å™¨çš„ IP åœ°å€æ‰§è¡Œ HTTP Get è¯·æ±‚ã€‚å¦‚æœå“åº”çš„çŠ¶æ€ç å¤§äºç­‰äº200 ä¸”å°äº 400ï¼Œåˆ™è¯Šæ–­è¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„\n**æ¯æ¬¡æ¢æµ‹éƒ½å°†è·å¾—ä»¥ä¸‹ä¸‰ç§ç»“æœä¹‹ä¸€ï¼šÂ **\næˆåŠŸï¼šå®¹å™¨é€šè¿‡äº†è¯Šæ–­ã€‚ å¤±è´¥ï¼šå®¹å™¨æœªé€šè¿‡è¯Šæ–­ã€‚ æœªçŸ¥ï¼šè¯Šæ–­å¤±è´¥ï¼Œå› æ­¤ä¸ä¼šé‡‡å–ä»»ä½•è¡ŒåŠ¨ livenessProbeï¼šæŒ‡ç¤ºå®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚å¦‚æœå­˜æ´»æ¢æµ‹å¤±è´¥ï¼Œåˆ™ kubelet ä¼šæ€æ­»å®¹å™¨ï¼Œå¹¶ä¸”å®¹å™¨å°†å—åˆ°å…¶ é‡å¯ç­–ç•¥ çš„å½±å“ã€‚å¦‚æœå®¹å™¨ä¸æä¾›å­˜æ´»æ¢é’ˆï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸º Success readinessProbeï¼šæŒ‡ç¤ºå®¹å™¨æ˜¯å¦å‡†å¤‡å¥½æœåŠ¡è¯·æ±‚ã€‚å¦‚æœå°±ç»ªæ¢æµ‹å¤±è´¥ï¼Œç«¯ç‚¹æ§åˆ¶å™¨å°†ä»ä¸ Pod åŒ¹é…çš„æ‰€æœ‰ Service çš„ç«¯ç‚¹ä¸­åˆ é™¤è¯¥ Pod çš„ IP åœ°å€ã€‚åˆå§‹å»¶è¿Ÿä¹‹å‰çš„å°±ç»ªçŠ¶æ€é»˜è®¤ä¸º Failureã€‚å¦‚æœå®¹å™¨ä¸æä¾›å°±ç»ªæ¢é’ˆï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸º Success\næ£€æµ‹æ¢é’ˆ - å°±ç»ªæ£€æµ‹Â **readinessProbe-httpgetÂ **\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 apiVersion: v1 kind: Pod metadata: name: readiness-httpget-pod namespace: default spec: containers: - name: readiness-httpget-container image: wangyanglinux/myapp:v1 imagePullPolicy: IfNotPresent readinessProbe: httpGet: port: 80 path: /index1.html initialDelaySeconds: 1 periodSeconds: 3 å› ä¸ºè¿™nginxä¸‹çš„80é‚£é‡Œï¼Œæ²¡æœ‰index1.htmlè¿™ä¸ªç•Œé¢\næŸ¥çœ‹Podçš„è¯¦ç»†æè¿°\n1 kubectl describe pod readiness-httpget-pod æŸ¥çœ‹Podçš„æ—¥å¿—ã€ä¸€ç›´ä¸æ–­çš„æ¢æµ‹ã€‘\n1 kubectl log readiness-httpget-pod è§£å†³åŠæ³• è¿›å…¥è¿™ä¸ªå®¹å™¨\n1 kubectl exec readiness-httpget-pod -it -- /bin/sh 1 2 3 4 5 6 [root@master k8s]# kubectl exec readiness-httpget-pod -it -- /bin/sh / # cd /usr/share/nginx/html/ /usr/share/nginx/html # ls 50x.html index.html /usr/share/nginx/html # echo \u0026#34;123\u0026#34; \u0026gt;\u0026gt; index1.html /usr/share/nginx/html # exit æ£€æµ‹æ¢é’ˆ - å­˜æ´»æ£€æµ‹Â **livenessProbe-execÂ **\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: v1 kind: Pod metadata: name: liveness-exec-pod namespace: default spec: containers: - name: liveness-exec-container image: busybox imagePullPolicy: IfNotPresent command: [\u0026#34;/bin/sh\u0026#34;,\u0026#34;-c\u0026#34;,\u0026#34;touch /tmp/live ; sleep 60; rm -rf /tmp/live; sleep 3600\u0026#34;] livenessProbe: exec: command: [\u0026#34;test\u0026#34;,\u0026#34;-e\u0026#34;,\u0026#34;/tmp/live\u0026#34;] initialDelaySeconds: 1 periodSeconds: 3 æ£€æµ‹/tmp/liveï¼Œæ¯éš”60ç§’å°±ä¼šè¢«åˆ é™¤ï¼Œlivenessæ£€æµ‹ï¼Œå¦‚æœè¢«åˆ é™¤ï¼Œå°±ä¼šè¿”å›å¤±è´¥ï¼Œé‡å¯podã€‚é™·å…¥æ— é™å¾ªç¯ã€‚\n**livenessProbe-httpgetÂ **\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 apiVersion: v1 kind: Pod metadata: name: liveness-httpget-pod namespace: default spec: containers: - name: liveness-httpget-container image: wangyanglinux/myapp:v1 imagePullPolicy: IfNotPresent ports: - name: http containerPort: 80 livenessProbe: httpGet: port: http path: /index.html initialDelaySeconds: 1 periodSeconds: 3 timeoutSeconds: 10 ç°åœ¨è¿›å…¥å®¹å™¨ï¼Œåˆ é™¤index.htmlæ–‡ä»¶\n1 kubectl exec liveness-httpget-pod -it -- /bin/sh **livenessProbe-tcpÂ **\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: Pod metadata: name: probe-tcp spec: containers: - name: nginx image: wangyanglinux/myapp:v1 livenessProbe: initialDelaySeconds: 5 timeoutSeconds: 1 tcpSocket: port: 8080 periodSeconds: 3 æ£€æµ‹8080ç«¯å£ï¼Œä½†æ˜¯é‚£ä¸ªç«¯å£æ²¡æœ‰ï¼Œå°±ä¼šä¸€ç›´æ£€æµ‹ï¼Œé‡å¯ã€‚\nå¯åŠ¨ã€é€€å‡ºåŠ¨ä½œÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: v1 kind: Pod metadata: name: lifecycle-demo spec: containers: - name: lifecycle-demo-container image: wangyanglinux/myapp:v1 lifecycle: postStart: exec: command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo Hello from the postStart handler \u0026gt; /usr/share/message\u0026#34;] preStop: exec: command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo Hello from the poststop handler \u0026gt; /usr/share/message\u0026#34;] ","date":"2020-02-04T13:08:30Z","image":"https://www.ownit.top/title_pic/73.jpg","permalink":"https://www.ownit.top/p/202002041308/","title":"Kubernetesï¼ˆk8sï¼‰podçš„æ¢é’ˆlivenessã€readinessè¯¦ç»†æ•™ç¨‹"},{"content":"Kubernetes pod åˆå§‹åŒ– init C ï¼šåˆå§‹æ¢å®¹å™¨\nPod èƒ½å¤Ÿå…·æœ‰å¤šä¸ªå®¹å™¨ï¼Œåº”ç”¨è¿è¡Œåœ¨å®¹å™¨é‡Œé¢ï¼Œä½†æ˜¯å®ƒä¹Ÿå¯èƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå…ˆäºåº”ç”¨å®¹å™¨å¯åŠ¨çš„Â Initå®¹å™¨\nInit å®¹å™¨ä¸æ™®é€šçš„å®¹å™¨éå¸¸åƒï¼Œé™¤äº†å¦‚ä¸‹ä¸¤ç‚¹ï¼š Ã˜Â InitÂ å®¹å™¨æ€»æ˜¯è¿è¡Œåˆ°æˆåŠŸå®Œæˆä¸ºæ­¢ Ã˜Â æ¯ä¸ªÂ InitÂ å®¹å™¨éƒ½å¿…é¡»åœ¨ä¸‹ä¸€ä¸ªÂ InitÂ å®¹å™¨å¯åŠ¨ä¹‹å‰æˆåŠŸå®Œæˆ å¦‚æœ Pod çš„ Init å®¹å™¨å¤±è´¥ï¼ŒKubernetes ä¼šä¸æ–­åœ°é‡å¯è¯¥ Podï¼Œç›´åˆ°Init å®¹å™¨æˆåŠŸä¸ºæ­¢ã€‚ç„¶è€Œ\nå¦‚æœ Pod å¯¹åº”çš„ restartPolicy ä¸º Neverï¼Œå®ƒä¸ä¼šé‡æ–°å¯åŠ¨\nå› ä¸º Init å®¹å™¨å…·æœ‰ä¸åº”ç”¨ç¨‹åºå®¹å™¨åˆ†ç¦»çš„å•ç‹¬é•œåƒï¼Œæ‰€ä»¥å®ƒä»¬çš„å¯åŠ¨ç›¸å…³ä»£ç å…·æœ‰å¦‚ä¸‹ä¼˜åŠ¿ï¼š InitÂ å®¹å™¨ **initÂ æ¨¡æ¿Â **\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 apiVersion: v1 kind: Pod metadata: name: myapp-pod labels: app: myapp spec: containers: - name: myapp-container image: busybox command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;echo The app is running! \u0026amp;\u0026amp; sleep 3600\u0026#39;] initContainers: - name: init-myservice image: busybox command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;until nslookup myservice; do echo waiting for myservice; sleep 2; done;\u0026#39;] - name: init-mydb image: busybox command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;until nslookup mydb; do echo waiting for mydb; sleep 2; done;\u0026#39;] ç­‰å¾…initçš„åˆå§‹åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 kind: Service apiVersion: v1 metadata: name: myservice spec: ports: - protocol: TCP port: 80 targetPort: 9376 1 2 3 4 5 6 7 8 9 kind: Service apiVersion: v1 metadata: name: mydb spec: ports: - protocol: TCP port: 80 targetPort: 9377 ä¸¤ä¸ªinitCå·²ç»åˆå§‹æ¢å®Œæˆ\n","date":"2020-02-03T22:08:53Z","image":"https://www.ownit.top/title_pic/71.jpg","permalink":"https://www.ownit.top/p/202002032208/","title":"Kubernetesï¼ˆk8sï¼‰Podçš„ç”Ÿå‘½å‘¨æœŸ"},{"content":"Kubernetesä¸­çš„Podä¸€èˆ¬éƒ½æ˜¯é‡‡ç”¨yamlç¼–å†™\n1 2 3 4 5 6 7 8 9 apiVersion: group/apiversion # å¦‚æœæ²¡æœ‰ç»™å®š group åç§°ï¼Œé‚£ä¹ˆé»˜è®¤ä¸º coreï¼Œå¯ä»¥ä½¿ç”¨ kubectl api-versions # è·å–å½“å‰ k8s ç‰ˆæœ¬ä¸Šæ‰€æœ‰çš„ apiVersion ç‰ˆæœ¬ä¿¡æ¯( æ¯ä¸ªç‰ˆæœ¬å¯èƒ½ä¸åŒ ) kind: #èµ„æºç±»åˆ« metadataï¼š #èµ„æºå…ƒæ•°æ® name namespace lables annotations # ä¸»è¦ç›®çš„æ˜¯æ–¹ä¾¿ç”¨æˆ·é˜…è¯»æŸ¥æ‰¾ spec: # æœŸæœ›çš„çŠ¶æ€ï¼ˆdisired stateï¼‰ statusï¼š# å½“å‰çŠ¶æ€ï¼Œæœ¬å­—æ®µæœ‰ Kubernetes è‡ªèº«ç»´æŠ¤ï¼Œç”¨æˆ·ä¸èƒ½å»å®šä¹‰ èµ„æºæ¸…å•çš„å¸¸ç”¨å‘½ä»¤ è·å–Â apiversionÂ ç‰ˆæœ¬ä¿¡æ¯\n1 2 3 4 5 6 7 [root@k8s-master01 ~]# kubectl api-versions admissionregistration.k8s.io/v1beta1 apiextensions.k8s.io/v1beta1 apiregistration.k8s.io/v1 apiregistration.k8s.io/v1beta1 apps/v1 ......(ä»¥ä¸‹çœç•¥) è·å–èµ„æºçš„Â apiVersionÂ ç‰ˆæœ¬ä¿¡æ¯\n1 2 3 4 5 6 7 [root@k8s-master01 ~]# kubectl explain pod KIND: Pod VERSION: v1 .....(ä»¥ä¸‹çœç•¥) [root@k8s-master01 ~]# kubectl explain Ingress KIND: Ingress VERSION: extensions/v1beta1 è·å–å­—æ®µè®¾ç½®å¸®åŠ©æ–‡æ¡£Â 1 2 3 4 5 6 7 8 9 10 [root@k8s-master01 ~]# kubectl explain pod KIND: Pod VERSION: v1 DESCRIPTION: Pod is a collection of containers that can run on a host. This resource is created by clients and scheduled onto hosts. FIELDS: apiVersion \u0026lt;string\u0026gt; ........ ........ å­—æ®µé…ç½®æ ¼å¼\n1 2 3 4 5 6 7 8 apiVersion \u0026lt;string\u0026gt; #è¡¨ç¤ºå­—ç¬¦ä¸²ç±»å‹ metadata \u0026lt;Object\u0026gt; #è¡¨ç¤ºéœ€è¦åµŒå¥—å¤šå±‚å­—æ®µ labels \u0026lt;map[string]string\u0026gt; #è¡¨ç¤ºç”±k:vç»„æˆçš„æ˜ å°„ finalizers \u0026lt;[]string\u0026gt; #è¡¨ç¤ºå­—ä¸²åˆ—è¡¨ ownerReferences \u0026lt;[]Object\u0026gt; #è¡¨ç¤ºå¯¹è±¡åˆ—è¡¨ hostPID \u0026lt;boolean\u0026gt; #å¸ƒå°”ç±»å‹ priority \u0026lt;integer\u0026gt; #æ•´å‹ name \u0026lt;string\u0026gt; -required- #å¦‚æœç±»å‹åé¢æ¥ -required-ï¼Œè¡¨ç¤ºä¸ºå¿…å¡«å­—æ®µ é€šè¿‡å®šä¹‰æ¸…å•æ–‡ä»¶åˆ›å»ºÂ Podã€myappè¿™ä¸ªæ˜¯nginxé•œåƒã€‘ï¼ˆè¿™åœ°æ–¹æœ‰ä¸ªé”™è¯¯å“¦ï¼Œä¸‹é¢è®²ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: v1 kind: Pod metadata: name: myapp-pod labels: app: myapp version: v1 spec: containers: - name: app image: wangyanglinux/myapp:v1 - name: test image: wangyanglinux/myapp:v1 é”™è¯¯ï¼šå› ä¸ºè¿™å›äº‹nginxå®¹å™¨ï¼Œåœ¨åŒä¸€Podä¸­ï¼Œåªç”¨ä¸€ä¸ª80ç«¯å£å¯ä»¥ï¼Œæ‰€ä»¥ï¼Œä¸€ä¸ªä¼šä¸€ç›´æŠ¥é”™ã€‚çœ‹ä¸‹é¢æˆªå›¾\nã€ä¸€ä¸ªåœ¨è¿è¡Œï¼Œä¸€ä¸ªåœ¨ä¸€ç›´æŠ¥é”™é‡å¯ã€‚ã€‘\nè¿è¡ŒPod.yamlæ–‡ä»¶\n1 kubectl apply -f pod.yaml ä¸‹é¢çœ‹è¯¦ç»†æ­¥éª¤è§£æ\næŸ¥çœ‹Podçš„è¯¦ç»†ä¿¡æ¯\n1 kubectl describe pod myapp-pod æŸ¥çœ‹Podçš„æ—¥å¿—\n1 kubectl log myapp-pod -c test åˆ é™¤Pod\n1 kubectl delete pod myapp-pod é‡æ–°ç¼–å†™yamlæ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 apiVersion: v1 kind: Pod metadata: name: myapp-pod labels: app: myapp version: v1 spec: containers: - name: app image: wangyanglinux/myapp:v1 æµ‹é€Ÿè®¿é—®\n","date":"2020-02-03T21:02:49Z","image":"https://www.ownit.top/title_pic/05.jpg","permalink":"https://www.ownit.top/p/202002032102/","title":"Kubernetesï¼ˆk8sï¼‰Podçš„YAMLåŸºç¡€ç¼–å†™"},{"content":"é€šè¿‡ä¸€æ®µå­¦ä¹ ï¼Œæˆ‘ä»¬çš„Kuberneteså·²ç»éƒ¨ç½²èµ·æ¥ï¼Œç°åœ¨å°±å¼€å§‹åŠŸèƒ½çš„æ¼”ç¤ºã€‚\nå¦‚æœåˆä¸ä¼šéƒ¨ç½²çš„å°ä¼™ä¼´ï¼Œå¯ä»¥çœ‹æˆ‘ä»¥å‰çš„åšå®¢ï¼Œéƒ½æœ‰è¯¦ç»†çš„æ•™ç¨‹ã€‚\nç›®å½•\næŸ¥çœ‹nodeçš„èŠ‚ç‚¹æƒ…å†µ\næŸ¥çœ‹podçš„è¿è¡Œæƒ…å†µ\næŸ¥çœ‹deploymentæƒ…å†µ\næŸ¥çœ‹podçš„è¿è¡Œè¯¦ç»†ä¿¡æ¯\nåˆ é™¤deployment\nåˆ é™¤ä¸€ä¸ªpodåº”ç”¨\næŸ¥çœ‹kubectlåˆ›å»ºæç¤º\nkubectlåˆ›å»ºnginxåº”ç”¨\nå‰¯æœ¬é›†æ‰©å®¹\nåº”ç”¨podçš„ç«¯å£ä¿®æ”¹ã€æŠŠ80ç«¯å£æ”¹æˆäº† 30003ã€‘\nä¿®æ”¹nginx-deploymentçš„ipç±»å‹ã€å¯ä»¥æš´éœ²ç«¯å£ï¼Œå®ç°å†…éƒ¨ç½‘è®¿é—®ã€‘\næµ‹é€Ÿè®¿é—®\næŸ¥çœ‹nodeçš„èŠ‚ç‚¹æƒ…å†µ 1 kubectl get node æŸ¥çœ‹podçš„è¿è¡Œæƒ…å†µ 1 kubectl get pod æŸ¥çœ‹deploymentæƒ…å†µ 1 kubectl get deployment æŸ¥çœ‹podçš„è¿è¡Œè¯¦ç»†ä¿¡æ¯ 1 kubectl get pod -o wide åˆ é™¤deployment 1 kubectl delete deployment nginx åˆ é™¤ä¸€ä¸ªpodåº”ç”¨ 1 kubectl delete pod nginx-deployment-5d9dfb999c-t6xdq æŸ¥çœ‹kubectlåˆ›å»ºæç¤º 1 kubectl run --help kubectlåˆ›å»ºnginxåº”ç”¨ 1 kubectl run nginx-deployment --image=wangyanglinux/myapp:v1 --port=80 --replicas=1 1 2 3 4 5 6 7 8 9 10 [root@master ~]# kubectl get pod NAME READY STATUS RESTARTS AGE nginx-deployment-5d9dfb999c-t6xdq 1/1 Running 0 5m43s [root@master ~]# kubectl get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-deployment-5d9dfb999c-t6xdq 1/1 Running 0 5m51s 10.244.2.7 node1 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; [root@master ~]# curl 10.244.2.7 Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; [root@master ~]# curl 10.244.2.7/hostname.html nginx-deployment-5d9dfb999c-t6xdq å‰¯æœ¬é›†æ‰©å®¹ 1 kubectl scale --replicas=3 deployment/nginx-deployment åº”ç”¨podçš„ç«¯å£ä¿®æ”¹ã€æŠŠ80ç«¯å£æ”¹æˆäº† 30003ã€‘ 1 kubectl expose deployment nginx-deployment --port=30003 --target-port=80 ä¿®æ”¹nginx-deploymentçš„ipç±»å‹ã€å¯ä»¥æš´éœ²ç«¯å£ï¼Œå®ç°å†…éƒ¨ç½‘è®¿é—®ã€‘ 1 kubectl edit svc nginx-deployment æµ‹é€Ÿè®¿é—® ","date":"2020-02-03T15:56:42Z","image":"https://www.ownit.top/title_pic/41.jpg","permalink":"https://www.ownit.top/p/202002031556/","title":"Kubernetesï¼ˆk8sï¼‰é›†ç¾¤åŠŸèƒ½æ¼”ç¤º"},{"content":"ç›®å½•\nä¸€ã€å®‰è£…åº•å±‚éœ€æ±‚\näºŒã€Harbor å®‰è£…ï¼š\n1ã€ä¸‹è½½Harbor\n2ã€è§£å‹\n3ã€é…ç½® harbor.cf\n4ã€åˆ›å»º https è¯ä¹¦ä»¥åŠé…ç½®ç›¸å…³ç›®å½•æƒé™ è¯ä¹¦ä»¥åŠé…ç½®ç›¸å…³ç›®å½•æƒé™Â 5ã€è¿è¡Œè„šæœ¬è¿›è¡Œå®‰è£…\n6ã€è®¿é—®æµ‹è¯•\n7ã€ä¸Šä¼ é•œåƒè¿›è¡Œä¸Šä¼ æµ‹è¯•Â 8ã€å…¶å®ƒ Docker å®¢æˆ·ç«¯ä¸‹è½½æµ‹è¯•\nä¸‰ã€Harbor åŸç†è¯´æ˜\n1ã€è½¯ä»¶èµ„æºä»‹ç»Â 2ã€Harborç‰¹æ€§\n3ã€Harborè®¤è¯è¿‡ç¨‹ ä¸€ã€å®‰è£…åº•å±‚éœ€æ±‚ Pythonåº”è¯¥æ˜¯ åº”è¯¥æ˜¯2.7æˆ–æ›´é«˜ç‰ˆæœ¬ æˆ–æ›´é«˜ç‰ˆæœ¬ Dockerå¼•æ“åº”ä¸º å¼•æ“åº”ä¸º1.10æˆ–æ›´é«˜ç‰ˆæœ¬ æˆ–æ›´é«˜ç‰ˆæœ¬ Docker Composeéœ€è¦ä¸º éœ€è¦ä¸º1.6.0æˆ–æ›´é«˜ç‰ˆæœ¬ 1 docker-composeï¼š ï¼šcurl -L https://github.com/docker/compose/releases/download/1.9.0/docker-compose-`uname -s`-`uname -m` \u0026gt; /usr/local/bin/docker-compose äºŒã€Harbor å®‰è£…ï¼š å®‰è£…ï¼šHarbor å®˜æ–¹åœ°å€ï¼š å®˜æ–¹åœ°å€ï¼šhttps://github.com/vmware/harbor/releasesÂ 1ã€ä¸‹è½½Harbor 1 wget https://github.com/vmware/harbor/releases/download/v1.2.0/harbor-offline-installer-v1.2.0.tgz 2ã€è§£å‹ 1 tar xvf harbor-offline-installer-v1.2.0.tgz 3ã€é…ç½® harbor.cf aã€å¿…é€‰å‚æ•°\nhostnameï¼šç›®æ ‡çš„ä¸»æœºåæˆ–è€…å®Œå…¨é™å®šåŸŸå ui_url_protocolï¼šhttpæˆ–httpsã€‚é»˜è®¤ä¸ºÂ http db_passwordï¼šç”¨äº db_authçš„MySQLæ•°æ®åº“çš„æ ¹å¯†ç ã€‚æ›´æ”¹æ­¤å¯†ç è¿›è¡Œä»»ä½•ç”Ÿäº§ç”¨é€” max_job_workersï¼šï¼ˆé»˜è®¤å€¼ä¸ºÂ 3ï¼‰ä½œä¸šæœåŠ¡ä¸­çš„å¤åˆ¶å·¥ä½œäººå‘˜çš„æœ€å¤§æ•°é‡ã€‚å¯¹äºæ¯ä¸ªæ˜ åƒå¤åˆ¶ä½œä¸šï¼ŒÂ å·¥ä½œäººå‘˜å°†å­˜å‚¨åº“çš„æ‰€æœ‰æ ‡ç­¾åŒæ­¥åˆ°è¿œç¨‹ç›®æ ‡ã€‚å¢åŠ æ­¤æ•°å­—å…è®¸ç³»ç»Ÿä¸­æ›´å¤šçš„å¹¶å‘å¤åˆ¶ä½œä¸šã€‚ä½†æ˜¯ï¼Œç”±äºæ¯ä¸ªå·¥ä½œäººå‘˜éƒ½ä¼šæ¶ˆè€—ä¸€å®šæ•°é‡çš„ç½‘ç»œÂ / CPU / IOèµ„æºï¼Œè¯·æ ¹æ®ä¸»æœºçš„ç¡¬ä»¶èµ„æºï¼Œä»”ç»†é€‰æ‹©è¯¥å±æ€§çš„å€¼ customize_crtï¼šï¼ˆ onæˆ–offã€‚é»˜è®¤ä¸º onï¼‰å½“æ­¤å±æ€§æ‰“å¼€æ—¶ï¼ŒÂ prepareè„šæœ¬å°†ä¸ºæ³¨å†Œè¡¨çš„ä»¤ç‰Œçš„ç”ŸæˆÂ **/**éªŒè¯åˆ›å»ºç§é’¥å’Œæ ¹è¯ä¹¦ ssl_certï¼šSSLè¯ä¹¦çš„è·¯å¾„ï¼Œä»…å½“åè®®è®¾ç½®ä¸ºÂ httpsæ—¶æ‰åº”ç”¨ ssl_cert_keyï¼š ï¼šSSLå¯†é’¥çš„è·¯å¾„ï¼Œä»…å½“åè®®è®¾ç½®ä¸º å¯†é’¥çš„è·¯å¾„ï¼Œä»…å½“åè®®è®¾ç½®ä¸ºhttpsæ—¶æ‰åº”ç”¨Â secretkey_pathï¼šç”¨äºåœ¨å¤åˆ¶ç­–ç•¥ä¸­åŠ å¯†æˆ–è§£å¯†è¿œç¨‹æ³¨å†Œè¡¨çš„å¯†ç çš„å¯†é’¥è·¯å¾„Â 4ã€åˆ›å»º https è¯ä¹¦ä»¥åŠé…ç½®ç›¸å…³ç›®å½•æƒé™ è¯ä¹¦ä»¥åŠé…ç½®ç›¸å…³ç›®å½•æƒé™Â 1 2 3 4 5 6 7 openssl genrsa -des3 -out server.key 2048 openssl req -new -key server.key -out server.csr cp server.key server.key.org openssl rsa -in server.key.org -out server.key openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt mkdir /data/cert chmod -R 777 /data/cert 5ã€è¿è¡Œè„šæœ¬è¿›è¡Œå®‰è£… 1 ./install.sh 6ã€è®¿é—®æµ‹è¯• è®¿é—®æµ‹è¯• https://reg.yourdomain.com çš„ç®¡ç†å‘˜é—¨æˆ·ï¼ˆå°† çš„ç®¡ç†å‘˜é—¨æˆ·ï¼ˆå°†reg.yourdomain.comæ›´æ”¹ä¸ºæ‚¨çš„ä¸»æœºå æ›´æ”¹ä¸ºæ‚¨çš„ä¸»æœºåharbor.cfgï¼‰ã€‚è¯·æ³¨æ„ï¼Œé»˜ ï¼‰ã€‚è¯·æ³¨æ„ï¼Œé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·å è®¤ç®¡ç†å‘˜ç”¨æˆ·å/å¯†ç ä¸º å¯†ç ä¸ºadmin / Harbor12345\n7ã€ä¸Šä¼ é•œåƒè¿›è¡Œä¸Šä¼ æµ‹è¯•Â 1 2 3 4 5 aã€æŒ‡å®šé•œåƒä»“åº“åœ°å€ vim /etc/docker/daemon.json { \u0026#34;insecure-registries\u0026#34;: [\u0026#34;serverip\u0026#34;] } 1 2 bã€ä¸‹è½½æµ‹è¯•é•œåƒ docker pull hello-world 1 2 cã€ç»™é•œåƒé‡æ–°æ‰“æ ‡ç­¾ docker tag hello-world serverip/hello-world:latest 1 2 dã€ç™»å½•è¿›è¡Œä¸Šä¼  docker login serverip 8ã€å…¶å®ƒ Docker å®¢æˆ·ç«¯ä¸‹è½½æµ‹è¯• 1 2 3 4 5 aã€æŒ‡å®šé•œåƒä»“åº“åœ°å€ vim /etc/docker/daemon.json { \u0026#34;insecure-registries\u0026#34;: [\u0026#34;serverip\u0026#34;] } 1 2 bã€ä¸‹è½½æµ‹è¯•é•œåƒ docker pull serverip/hello-world:latest ä¸‰ã€Harbor åŸç†è¯´æ˜ 1ã€è½¯ä»¶èµ„æºä»‹ç»Â Harboræ˜¯VMwareå…¬å¸å¼€æºçš„ä¼ä¸šçº§Â DockerRegistryé¡¹ç›®ï¼Œé¡¹ç›®åœ°å€ä¸ºÂ https://github.com/vmware/harborã€‚å…¶ç›®\næ ‡æ˜¯å¸®åŠ©ç”¨æˆ·è¿…é€Ÿæ­å»ºä¸€ä¸ªä¼ä¸šçº§çš„Â DockerregistryæœåŠ¡ã€‚å®ƒä»¥Â Dockerå…¬å¸å¼€æºçš„ registryä¸ºåŸºç¡€ï¼Œæä¾›äº†ç®¡ç†Â UIï¼Œ\nåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶Â (Role Based Access Control)ï¼ŒAD/LDAPé›†æˆã€ä»¥åŠå®¡è®¡æ—¥å¿—Â (Auditlogging) ç­‰ä¼ä¸šç”¨æˆ·éœ€æ±‚çš„åŠŸ\nèƒ½ï¼ŒåŒæ—¶è¿˜åŸç”Ÿæ”¯æŒä¸­æ–‡ã€‚Â Harborçš„æ¯ä¸ªç»„ä»¶éƒ½æ˜¯ä»¥Â Dockerå®¹å™¨çš„å½¢å¼æ„å»ºçš„ï¼Œä½¿ç”¨Â Docker Composeæ¥å¯¹å®ƒè¿›è¡Œéƒ¨\nç½²ã€‚ç”¨äºéƒ¨ç½²Â Harborçš„Docker Composeæ¨¡æ¿ä½äºÂ **Â /Deployer/docker-compose.yml**ï¼Œç”± 5ä¸ªå®¹å™¨ç»„æˆï¼Œè¿™å‡ ä¸ªå®¹å™¨é€šè¿‡\nDocker linkçš„å½¢å¼è¿æ¥åœ¨ä¸€èµ·ï¼Œåœ¨å®¹å™¨ä¹‹é—´é€šè¿‡å®¹å™¨åå­—äº’ç›¸è®¿é—®ã€‚å¯¹ç»ˆç«¯ç”¨æˆ·è€Œè¨€ï¼Œåªéœ€è¦æš´éœ²Â proxy ï¼ˆ å³\nNginxï¼‰çš„æœåŠ¡ç«¯å£\nProxyï¼šç”±NginxÂ æœåŠ¡å™¨æ„æˆçš„åå‘ä»£ç†ã€‚ Registryï¼šç”±Dockerå®˜æ–¹çš„å¼€æºÂ registryÂ é•œåƒæ„æˆçš„å®¹å™¨å®ä¾‹ã€‚ UIï¼šå³æ¶æ„ä¸­çš„Â coreÂ servicesï¼ŒÂ æ„æˆæ­¤å®¹å™¨çš„ä»£ç æ˜¯Â Harboré¡¹ç›®çš„ä¸»ä½“ã€‚ MySQLï¼šç”±å®˜æ–¹Â MySQLé•œåƒæ„æˆçš„æ•°æ®åº“å®¹å™¨ã€‚ Logï¼šè¿è¡Œç€Â rsyslogdçš„å®¹å™¨ï¼Œé€šè¿‡Â log-driverçš„å½¢å¼æ”¶é›†å…¶ä»–å®¹å™¨çš„æ—¥å¿— 2ã€Harborç‰¹æ€§ aã€åŸºäºè§’è‰²æ§åˆ¶ï¼šç”¨æˆ·å’Œä»“åº“éƒ½æ˜¯åŸºäºé¡¹ç›®è¿›è¡Œç»„ç»‡çš„ï¼Œ è€Œç”¨æˆ·åŸºäºé¡¹ç›®å¯ä»¥æ‹¥æœ‰ä¸åŒçš„æƒé™ bã€åŸºäºé•œåƒçš„å¤åˆ¶ç­–ç•¥ï¼šé•œåƒå¯ä»¥åœ¨å¤šä¸ªHarborå®ä¾‹ä¹‹é—´è¿›è¡Œå¤åˆ¶ cã€æ”¯æŒLDAPï¼šHarborçš„ç”¨æˆ·æˆæƒå¯ä»¥ä½¿ç”¨å·²ç»å­˜åœ¨LDAPç”¨æˆ· dã€é•œåƒåˆ é™¤Â \u0026amp;åƒåœ¾å›æ”¶ï¼šImageå¯ä»¥è¢«åˆ é™¤å¹¶ä¸”å›æ”¶Imageå ç”¨çš„ç©ºé—´ï¼Œç»å¤§éƒ¨åˆ†çš„ç”¨æˆ·æ“ä½œAPIï¼ŒÂ æ–¹ä¾¿ ç”¨æˆ·å¯¹ç³»ç»Ÿè¿›è¡Œæ‰©å±• eã€ç”¨æˆ·UIï¼šç”¨æˆ·å¯ä»¥è½»æ¾çš„æµè§ˆã€æœç´¢é•œåƒä»“åº“ä»¥åŠå¯¹é¡¹ç›®è¿›è¡Œç®¡ç† fã€è½»æ¾çš„éƒ¨ç½²åŠŸèƒ½ï¼šHarboræä¾›äº†onlineã€offlineå®‰è£…ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æä¾›äº†virtualapplianceå®‰è£… gã€Harborå’ŒÂ dockerregistryÂ å…³ç³»ï¼šHarborå®è´¨ä¸Šæ˜¯å¯¹Â dockerregistryÂ åšäº†å°è£…ï¼Œæ‰©å±•äº†è‡ªå·±çš„ä¸šåŠ¡æ¨¡å— 3ã€Harborè®¤è¯è¿‡ç¨‹ aã€dockerdaemonä»dockerregistryæ‹‰å–é•œåƒã€‚ bã€å¦‚æœdockerregistryéœ€è¦è¿›è¡Œæˆæƒæ—¶ï¼Œregistryå°†ä¼šè¿”å›401 Unauthorizedå“åº”ï¼ŒåŒæ—¶åœ¨å“åº”ä¸­åŒ…å«äº†docker clientå¦‚ä½•è¿›è¡Œè®¤è¯çš„ä¿¡æ¯ã€‚ cã€dockerclientæ ¹æ®registryè¿”å›çš„ä¿¡æ¯ï¼Œå‘authserverå‘é€è¯·æ±‚è·å–è®¤è¯tokenã€‚ dã€authserveråˆ™æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡å®ç°å»éªŒè¯æäº¤çš„ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å­˜ç¬¦åˆä¸šåŠ¡è¦æ±‚ã€‚ eã€ç”¨æˆ·æ•°æ®ä»“åº“è¿”å›ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ã€‚ fã€authserverå°†ä¼šæ ¹æ®æŸ¥è¯¢çš„ç”¨æˆ·ä¿¡æ¯ï¼Œç”Ÿæˆtokenä»¤ç‰Œï¼Œä»¥åŠå½“å‰ç”¨æˆ·æ‰€å…·æœ‰çš„ç›¸å…³æƒé™ä¿¡æ¯.ä¸Šè¿°å°±æ˜¯ å®Œæ•´çš„æˆæƒè¿‡ç¨‹.å½“ç”¨æˆ·å®Œæˆä¸Šè¿°è¿‡ç¨‹ä»¥åä¾¿å¯ä»¥æ‰§è¡Œç›¸å…³çš„pull/pushæ“ä½œã€‚è®¤è¯ä¿¡æ¯ä¼šæ¯æ¬¡éƒ½å¸¦åœ¨è¯·æ±‚å¤´ä¸­ Harboræ•´ä½“æ¶æ„Â 4ã€Harborè®¤è¯æµç¨‹ aã€é¦–å…ˆï¼Œè¯·æ±‚è¢«ä»£ç†å®¹å™¨ç›‘å¬æ‹¦æˆªï¼Œå¹¶è·³è½¬åˆ°æŒ‡å®šçš„è®¤è¯æœåŠ¡å™¨ã€‚ bã€ å¦‚æœè®¤è¯æœåŠ¡å™¨é…ç½®äº†æƒé™è®¤è¯ï¼Œåˆ™ä¼šè¿”å›401ã€‚é€šçŸ¥dockerclientåœ¨ç‰¹å®šçš„è¯·æ±‚ä¸­éœ€è¦å¸¦ä¸Šä¸€ä¸ªåˆæ³•çš„ tokenã€‚è€Œè®¤è¯çš„é€»è¾‘åœ°å€åˆ™æŒ‡å‘æ¶æ„å›¾ä¸­çš„core servicesã€‚ cã€ å½“dockerclientæ¥å—åˆ°é”™è¯¯codeã€‚clientå°±ä¼šå‘é€è®¤è¯è¯·æ±‚(å¸¦æœ‰ç”¨æˆ·åå’Œå¯†ç )åˆ°coreservicesè¿›è¡Œbasic authè®¤è¯ã€‚ dã€ å½“Cçš„è¯·æ±‚å‘é€ç»™ngnixä»¥åï¼Œngnixä¼šæ ¹æ®é…ç½®çš„è®¤è¯åœ°å€å°†å¸¦æœ‰ç”¨æˆ·åå’Œå¯†ç çš„è¯·æ±‚å‘é€åˆ°core serivcesã€‚ eã€Â coreservicesè·å–ç”¨æˆ·åå’Œå¯†ç ä»¥åå¯¹ç”¨æˆ·ä¿¡æ¯è¿›è¡Œè®¤è¯(è‡ªå·±çš„æ•°æ®åº“æˆ–è€…ä»‹å…¥LDAPéƒ½å¯ä»¥)ã€‚æˆåŠŸä»¥ åï¼Œè¿”å›è®¤è¯æˆåŠŸçš„ä¿¡æ¯ Harborè®¤è¯æµç¨‹\n","date":"2020-02-03T12:05:03Z","image":"https://www.ownit.top/title_pic/13.jpg","permalink":"https://www.ownit.top/p/202002031205/","title":"Harbor - ä¼ä¸šçº§ Docker ç§æœ‰ä»“åº“"},{"content":"ä¸€ã€Ansibleè‡ªåŠ¨åŒ–éƒ¨ç½²K8Sé›†ç¾¤ 1.1 Ansibleä»‹ç» Ansibleæ˜¯ä¸€ç§ITè‡ªåŠ¨åŒ–å·¥å…·ã€‚å®ƒå¯ä»¥é…ç½®ç³»ç»Ÿï¼Œéƒ¨ç½²è½¯ä»¶ä»¥åŠåè°ƒæ›´é«˜çº§çš„ITä»»åŠ¡ï¼Œä¾‹å¦‚æŒç»­éƒ¨ç½²ï¼Œæ»šåŠ¨æ›´æ–°ã€‚Ansibleé€‚ç”¨äºç®¡ç†ä¼ä¸šITåŸºç¡€è®¾æ–½ï¼Œä»å…·æœ‰å°‘æ•°ä¸»æœºçš„å°è§„æ¨¡åˆ°æ•°åƒä¸ªå®ä¾‹çš„ä¼ä¸šç¯å¢ƒã€‚Ansibleä¹Ÿæ˜¯ä¸€ç§ç®€å•çš„è‡ªåŠ¨åŒ–è¯­è¨€ï¼Œå¯ä»¥å®Œç¾åœ°æè¿°ITåº”ç”¨ç¨‹åºåŸºç¡€ç»“æ„ã€‚\nå…·å¤‡ä»¥ä¸‹ä¸‰ä¸ªç‰¹ç‚¹ï¼š\nç®€å•ï¼šå‡å°‘å­¦ä¹ æˆæœ¬\nå¼ºå¤§ï¼šåè°ƒåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸ\næ— ä»£ç†ï¼šå¯é¢„æµ‹ï¼Œå¯é å’Œå®‰å…¨\nä½¿ç”¨æ–‡æ¡£ï¼š https://docs.ansible.com/\nå®‰è£…Ansibleï¼š\n1 yum install ansible -y Inventoryï¼šAnsibleç®¡ç†çš„ä¸»æœºä¿¡æ¯ï¼ŒåŒ…æ‹¬IPåœ°å€ã€SSHç«¯å£ã€è´¦å·ã€å¯†ç ç­‰\nModulesï¼šä»»åŠ¡å‡æœ‰æ¨¡å—å®Œæˆï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ¨¡å—ï¼Œä¾‹å¦‚ç»å¸¸ç”¨çš„è„šæœ¬ã€‚\nPluginsï¼šä½¿ç”¨æ’ä»¶å¢åŠ Ansibleæ ¸å¿ƒåŠŸèƒ½ï¼Œè‡ªèº«æä¾›äº†å¾ˆå¤šæ’ä»¶ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ’ä»¶ã€‚ä¾‹å¦‚connectionæ’ä»¶ï¼Œç”¨äºè¿æ¥ç›®æ ‡ä¸»æœºã€‚\nPlaybooksï¼šâ€œå‰§æœ¬â€ï¼Œæ¨¡å—åŒ–å®šä¹‰ä¸€ç³»åˆ—ä»»åŠ¡ï¼Œä¾›å¤–éƒ¨ç»Ÿä¸€è°ƒç”¨ã€‚Ansibleæ ¸å¿ƒåŠŸèƒ½ã€‚\n1.2 ä¸»æœºæ¸…å• æœåŠ¡ä¸»æœºåç§°IPåœ°å€æœåŠ¡ç«¯master192.168.116.129å®¢æˆ·ç«¯node1192.168.116.130å®¢æˆ·ç«¯node2192.168.116.131 1.3 å‘½ä»¤è¡Œä½¿ç”¨ ad-hocå‘½ä»¤å¯ä»¥è¾“å…¥å†…å®¹ï¼Œå¿«é€Ÿæ‰§è¡ŒæŸä¸ªæ“ä½œï¼Œä½†ä¸å¸Œæœ›ç•™å­˜è®°å½•ã€‚\nad-hocå‘½ä»¤æ˜¯ç†è§£Ansibleå’Œåœ¨å­¦ä¹ playbooksä¹‹å‰éœ€è¦æŒæ¡çš„åŸºç¡€çŸ¥è¯†ã€‚\nä¸€èˆ¬æ¥è¯´ï¼ŒAnsibleçš„çœŸæ­£èƒ½åŠ›åœ¨äºå‰§æœ¬ã€‚\n1ã€è¿æ¥è¿œç¨‹ä¸»æœºè®¤è¯ é…ç½®ä¸»æœºæ¸…å•ç›®å½•ï¼š/etc/ansible\né…ç½®hosts ï¼švim /etc/ansible/hostsÂ SSHå¯†ç è®¤è¯ï¼šã€ä¸»æœºæ¸…å•é…ç½®ã€‘\n1 2 3 [webservers] 192.168.116.130:22 ansible_ssh_user=root ansible_ssh_pass=â€™rootâ€™ 192.168.116.131:22 ansible_ssh_user=root ansible_ssh_pass=â€™rootâ€™ SSHå¯†é’¥å¯¹è®¤è¯ï¼š\n1 ssh-keygen 1 ssh-copy-id root@192.168.116.130 1 2 3 [webservers] 192.168.116.130:22 ansible_ssh_user=root ansible_ssh_key=/root/.ssh/id_rsa 192.168.116.131:22 ansible_ssh_user=root ä¹Ÿå¯ä»¥ansible.cfgåœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šï¼š\n1 2 [defaults] private_key_file = /root/.ssh/id_rsa # é»˜è®¤è·¯å¾„ æµ‹é€Ÿæ˜¯å¦è¿é€š\n1 ansible webservers -m ping -uroot -k 2ã€å¸¸ç”¨é€‰é¡¹ é€‰é¡¹ æè¿° -C, \u0026ndash;check è¿è¡Œæ£€æŸ¥ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ -e EXTRA_VARS,\u0026ndash;extra-vars=EXTRA_VARS è®¾ç½®é™„åŠ å˜é‡ key=value -u REMOTE_USER, \u0026ndash;user=REMOTE_USER SSHè¿æ¥ç”¨æˆ·ï¼Œé»˜è®¤None -k, \u0026ndash;ask-pass SSHè¿æ¥ç”¨æˆ·å¯†ç  -b, \u0026ndash;become ææƒï¼Œé»˜è®¤root -K, \u0026ndash;ask-become-pass ææƒå¯†ç  3ã€å‘½ä»¤è¡Œä½¿ç”¨\n1 2 3 ansible all -m ping ansible all -m shell -a \u0026#34;ls /root\u0026#34; -u root -k ansible webservers -m copy â€“a \u0026#34;src=/etc/hosts dest=/tmp/hosts\u0026#34; 1.4 å¸¸ç”¨æ¨¡å— ansible-doc â€“l æŸ¥çœ‹æ‰€æœ‰æ¨¡å—\nansible-doc â€“s copy æŸ¥çœ‹æ¨¡å—æ–‡æ¡£\næ¨¡å—æ–‡æ¡£ï¼šhttps://docs.ansible.com/ansible/latest/modules/modules_by_category.html\n1ã€shell 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 - name: å°†å‘½ä»¤ç»“æœè¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶ shell: somescript.sh \u0026gt;\u0026gt; somelog.txt - name: åˆ‡æ¢ç›®å½•æ‰§è¡Œå‘½ä»¤ shell: cmd: ls -l | grep log chdir: somedir/ - name: ç¼–å†™è„šæœ¬ shell: | if [ 0 -eq 0 ]; then echo yes \u0026gt; /tmp/result else echo no \u0026gt; /tmp/result fi args: executable: /bin/bash 1 ansible webservers -m shell -a \u0026#34;ls /root;df -h\u0026#34; 2ã€copy å°†æ–‡ä»¶å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºã€‚\n1 2 3 4 5 6 7 8 9 10 - name: æ‹·è´æ–‡ä»¶ copy: src: /srv/myfiles/foo.conf dest: /etc/foo.conf owner: foo group: foo mode: u=rw,g=r,o=r # mode: u+rw,g-wx,o-rwx # mode: \u0026#39;0644\u0026#39; backup: yes 3ã€file ç®¡ç†æ–‡ä»¶å’Œæ–‡ä»¶å±æ€§ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 - name: åˆ›å»ºç›®å½• file: path: /etc/some_directory state: directory mode: \u0026#39;0755\u0026#39; - name: åˆ é™¤æ–‡ä»¶ file: path: /etc/foo.txt state: absent - name: é€’å½’åˆ é™¤ç›®å½• file: path: /etc/foo state: absent presentï¼Œlatestï¼šè¡¨ç¤ºå®‰è£…\nabsentï¼šè¡¨ç¤ºå¸è½½\n4ã€yum è½¯ä»¶åŒ…ç®¡ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 - name: å®‰è£…æœ€æ–°ç‰ˆapache yum: name: httpd state: latest - name: å®‰è£…åˆ—è¡¨ä¸­æ‰€æœ‰åŒ… yum: name: - nginx - postgresql - postgresql-server state: present - name: å¸è½½apacheåŒ… yum: name: httpd state: absent - name: æ›´æ–°æ‰€æœ‰åŒ… yum: name: \u0026#39;*\u0026#39; state: latest - name: å®‰è£…nginxæ¥è‡ªè¿œç¨‹repo yum: name: http://nginx.org/packages/rhel/7/x86_64/RPMS/nginx-1.14.0-1.el7_4.ngx.x86_64.rpm # name: /usr/local/src/nginx-release-centos-6-0.el6.ngx.noarch.rpm state: present 5ã€service/systemd ç®¡ç†æœåŠ¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 - name: æœåŠ¡ç®¡ç† service: name: etcd state: started #state: stopped #state: restarted #state: reloaded - name: è®¾ç½®å¼€æœºå¯åŠ¨ service: name: httpd enabled: yes 1 2 3 4 5 6 - name: æœåŠ¡ç®¡ç† systemd: name=etcd state=restarted enabled=yes daemon_reload=yes 6ã€unarchive 1 2 3 4 - name: è§£å‹ unarchive: src=test.tar.gz dest=/tmp 7ã€debug æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰“å°è¯­å¥ã€‚\n1 2 3 4 5 6 7 - debug: msg: System {{ inventory_hostname }} has uuid {{ ansible_product_uuid }} - name: æ˜¾ç¤ºä¸»æœºå·²çŸ¥çš„æ‰€æœ‰å˜é‡ debug: var: hostvars[inventory_hostname] verbosity: 4 1.5 Playbook Playbooksæ˜¯Ansibleçš„é…ç½®ï¼Œéƒ¨ç½²å’Œç¼–æ’è¯­è¨€ã€‚ä»–ä»¬å¯ä»¥æè¿°æ‚¨å¸Œæœ›åœ¨è¿œç¨‹æœºå™¨åšå“ªäº›äº‹æˆ–è€…æè¿°ITæµç¨‹ä¸­ä¸€ç³»åˆ—æ­¥éª¤ã€‚ä½¿ç”¨æ˜“è¯»çš„YAMLæ ¼å¼ç»„ç»‡Playbookæ–‡ä»¶ã€‚\nå¦‚æœAnsibleæ¨¡å—æ˜¯æ‚¨å·¥ä½œä¸­çš„å·¥å…·ï¼Œé‚£ä¹ˆPlaybookå°±æ˜¯æ‚¨çš„ä½¿ç”¨è¯´æ˜ä¹¦ï¼Œè€Œæ‚¨çš„ä¸»æœºèµ„äº§æ–‡ä»¶å°±æ˜¯æ‚¨çš„åŸææ–™ã€‚\nä¸adhocä»»åŠ¡æ‰§è¡Œæ¨¡å¼ç›¸æ¯”ï¼ŒPlaybooksä½¿ç”¨ansibleæ˜¯ä¸€ç§å®Œå…¨ä¸åŒçš„æ–¹å¼ï¼Œå¹¶ä¸”åŠŸèƒ½ç‰¹åˆ«å¼ºå¤§ã€‚\nhttps://docs.ansible.com/ansible/latest/user_guide/playbooks.html\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 --- - hosts: webservers vars: http_port: 80 server_name: www.ctnrs.com remote_user: root gather_facts: false tasks: - name: å®‰è£…nginxæœ€æ–°ç‰ˆ yum: pkg=nginx state=latest - name: å†™å…¥nginxé…ç½®æ–‡ä»¶ template: src=/srv/httpd.j2 dest=/etc/nginx/nginx.conf notify: - restart nginx - name: ç¡®ä¿nginxæ­£åœ¨è¿è¡Œ service: name=httpd state=started handlers: - name: restart nginx service: name=nginx state=reloaded 1ã€ä¸»æœºå’Œç”¨æˆ· 1 2 3 4 - hosts: webservers remote_user: lizhenliang become: yes become_user: root 1 ansible-playbook nginx.yaml -u lizhenliang -k -b -K 2ã€å®šä¹‰å˜é‡ å˜é‡æ˜¯åº”ç”¨äºå¤šä¸ªä¸»æœºçš„ä¾¿æ·æ–¹å¼ï¼› å®é™…åœ¨ä¸»æœºæ‰§è¡Œä¹‹å‰ï¼Œå˜é‡ä¼šå¯¹æ¯ä¸ªä¸»æœºæ·»åŠ ï¼Œç„¶ååœ¨æ‰§è¡Œä¸­å¼•ç”¨\nå‘½ä»¤è¡Œä¼ é€’\n-e VAR=VALUE\nä¸»æœºå˜é‡ä¸ç»„å˜é‡\nåœ¨Inventoryä¸­å®šä¹‰å˜é‡ã€‚\n1 2 3 4 5 6 [webservers] 192.168.1.100 ansible_ssh_user=root hostname=web1 192.168.1.100 ansible_ssh_user=root hostname=web2 â€‹ [webservers:vars] ansible_ssh_user=root hostname=web1 å•æ–‡ä»¶å­˜å‚¨ Ansibleä¸­çš„é¦–é€‰åšæ³•æ˜¯ä¸å°†å˜é‡å­˜å‚¨åœ¨Inventoryä¸­ã€‚\né™¤äº†å°†å˜é‡ç›´æ¥å­˜å‚¨åœ¨Inventoryæ–‡ä»¶ä¹‹å¤–ï¼Œä¸»æœºå’Œç»„å˜é‡è¿˜å¯ä»¥å­˜å‚¨åœ¨ç›¸å¯¹äºInventoryæ–‡ä»¶çš„å•ä¸ªæ–‡ä»¶ä¸­ã€‚\nç»„å˜é‡ï¼š\ngroup_vars å­˜æ”¾çš„æ˜¯ç»„å˜é‡\ngroup_vars/all.yml è¡¨ç¤ºæ‰€æœ‰ä¸»æœºæœ‰æ•ˆï¼Œç­‰åŒäº[all:vars]\ngrous_vars/etcd.yml è¡¨ç¤ºetcdç»„ä¸»æœºæœ‰æ•ˆï¼Œç­‰åŒäº[etcd:vars]\nåœ¨Playbookä¸­å®šä¹‰ 1 2 3 4 - hosts: webservers vars: http_port: 80 server_name: www.ctnrs.com Registerå˜é‡ 1 2 3 4 - shell: /usr/bin/uptime register: result - debug: var: result 3ã€ä»»åŠ¡åˆ—è¡¨ æ¯ä¸ªplayåŒ…å«ä¸€ç³»åˆ—ä»»åŠ¡ã€‚è¿™äº›ä»»åŠ¡æŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œåœ¨playä¸­ï¼Œæ‰€æœ‰ä¸»æœºéƒ½ä¼šæ‰§è¡Œç›¸åŒçš„ä»»åŠ¡æŒ‡ä»¤ã€‚playç›®çš„æ˜¯å°†é€‰æ‹©çš„ä¸»æœºæ˜ å°„åˆ°ä»»åŠ¡ã€‚\n1 2 3 tasks: - name: å®‰è£…nginxæœ€æ–°ç‰ˆ yum: pkg=nginx state=latest 4ã€è¯­æ³•æ£€æŸ¥ä¸è°ƒè¯• è¯­æ³•æ£€æŸ¥ï¼šansible-playbook --check /path/to/playbook.yaml\næµ‹è¯•è¿è¡Œï¼Œä¸å®é™…æ“ä½œï¼šansible-playbook -C /path/to/playbook.yaml\ndebugæ¨¡å—åœ¨æ‰§è¡ŒæœŸé—´æ‰“å°è¯­å¥ï¼Œå¯¹äºè°ƒè¯•å˜é‡æˆ–è¡¨è¾¾å¼ï¼Œè€Œä¸å¿…åœæ­¢playã€‚ä¸\u0026rsquo;whenï¼š\u0026lsquo;æŒ‡ä»¤ä¸€èµ·è°ƒè¯•æ›´ä½³ã€‚\n1 2 3 4 - debug: msg={{group_names}} - name: ä¸»æœºå debug: msg: \u0026#34;{{inventory_hostname}}\u0026#34; 5ã€ä»»åŠ¡æ§åˆ¶ å¦‚æœä½ æœ‰ä¸€ä¸ªå¤§çš„å‰§æœ¬ï¼Œé‚£ä¹ˆèƒ½å¤Ÿåœ¨ä¸è¿è¡Œæ•´ä¸ªå‰§æœ¬çš„æƒ…å†µä¸‹è¿è¡Œç‰¹å®šéƒ¨åˆ†å¯èƒ½ä¼šå¾ˆæœ‰ç”¨ã€‚\n1 2 3 4 5 6 7 tasks: - name: å®‰è£…nginxæœ€æ–°ç‰ˆ yum: pkg=nginx state=latest tags: install - name: å†™å…¥nginxé…ç½®æ–‡ä»¶ template: src=/srv/httpd.j2 dest=/etc/nginx/nginx.conf tags: config ä½¿ç”¨ï¼š\n1 2 3 ansible-playbook example.yml --tags \u0026#34;install\u0026#34; ansible-playbook example.yml --tags \u0026#34;install,config\u0026#34; ansible-playbook example.yml --skip-tags \u0026#34;install\u0026#34; 6ã€æµç¨‹æ§åˆ¶ æ¡ä»¶ï¼š\n1 2 3 4 tasks: - name: åªåœ¨192.168.1.100è¿è¡Œä»»åŠ¡ debug: msg=\u0026#34;{{ansible_default_ipv4.address}}\u0026#34; when: ansible_default_ipv4.address == \u0026#39;192.168.1.100\u0026#39; å¾ªç¯ï¼š\n1 2 3 4 5 6 tasks: - nameï¼š æ‰¹é‡åˆ›å»ºç”¨æˆ· user: name={{ item }} state=present groups=wheel with_items: - testuser1 - testuser2 1 2 3 4 - name: è§£å‹ copy: src={{ item }} dest=/tmp with_fileglob: - \u0026#34;*.txt\u0026#34; å¸¸ç”¨å¾ªç¯è¯­å¥ï¼š\nè¯­å¥ æè¿° with_items æ ‡å‡†å¾ªç¯ with_fileglob éå†ç›®å½•æ–‡ä»¶ with_dict éå†å­—å…¸ 7ã€æ¨¡æ¿ 1 2 3 4 5 vars: domain: \u0026#34;www.ctnrs.com\u0026#34; tasks: - name: å†™å…¥nginxé…ç½®æ–‡ä»¶ template: src=/srv/server.j2 dest=/etc/nginx/conf.d/server.conf 1 2 3 4 5 6 7 8 9 # server.j2 {% set domain_name = domain %} server { listen 80; server_name {{ domain_name }}; location / { root /usr/share/html; } } åœ¨jinjaé‡Œä½¿ç”¨ansibleå˜é‡ç›´æ¥ {{ }}å¼•ç”¨ã€‚ä½¿ç”¨ansibleå˜é‡èµ‹å€¼jinjaå˜é‡ä¸ç”¨{{ }}å¼•ç”¨ã€‚\nå®šä¹‰å˜é‡ï¼š\n{% set local_ip = inventory_hostname %}\næ¡ä»¶å’Œå¾ªç¯ï¼š\n1 2 3 4 5 6 7 8 9 10 {% set list=[\u0026#39;one\u0026#39;, \u0026#39;two\u0026#39;, \u0026#39;three\u0026#39;] %} {% for i in list %} {% if i == \u0026#39;two\u0026#39; %} -\u0026gt; two {% elif loop.index == 3 %} -\u0026gt; 3 {% else %} {{i}} {% endif %} {% endfor %} ä¾‹å¦‚ï¼šç”Ÿæˆè¿æ¥etcdå­—ç¬¦ä¸²\n1 2 3 4 {% for host in groups[\u0026#39;etcd\u0026#39;] %} https://{{ hostvars[host].inventory_hostname }}:2379 {% if not loop.last %},{% endif %} {% endfor %} é‡Œé¢ä¹Ÿå¯ä»¥ç”¨ansibleçš„å˜é‡ã€‚\n1.6 Roles Rolesæ˜¯åŸºäºå·²çŸ¥æ–‡ä»¶ç»“æ„è‡ªåŠ¨åŠ è½½æŸäº›å˜é‡æ–‡ä»¶ï¼Œä»»åŠ¡å’Œå¤„ç†ç¨‹åºçš„æ–¹æ³•ã€‚æŒ‰è§’è‰²å¯¹å†…å®¹è¿›è¡Œåˆ†ç»„ï¼Œé€‚åˆæ„å»ºå¤æ‚çš„éƒ¨ç½²ç¯å¢ƒã€‚\n1ã€å®šä¹‰Roles Rolesç›®å½•ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 site.yml webservers.yml fooservers.yml roles/ common/ tasks/ handlers/ files/ templates/ vars/ defaults/ meta/ webservers/ tasks/ defaults/ meta/ tasks -åŒ…å«è§’è‰²è¦æ‰§è¡Œçš„ä»»åŠ¡çš„ä¸»è¦åˆ—è¡¨ã€‚\nhandlers -åŒ…å«å¤„ç†ç¨‹åºï¼Œæ­¤è§’è‰²ç”šè‡³åœ¨æ­¤è§’è‰²ä¹‹å¤–çš„ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨è¿™äº›å¤„ç†ç¨‹åºã€‚\ndefaults-è§’è‰²çš„é»˜è®¤å˜é‡\nvars-è§’è‰²çš„å…¶ä»–å˜é‡\nfiles -åŒ…å«å¯ä»¥é€šè¿‡æ­¤è§’è‰²éƒ¨ç½²çš„æ–‡ä»¶ã€‚\ntemplates -åŒ…å«å¯ä»¥é€šè¿‡æ­¤è§’è‰²éƒ¨ç½²çš„æ¨¡æ¿ã€‚\nmeta-ä¸ºæ­¤è§’è‰²å®šä¹‰ä¸€äº›å…ƒæ•°æ®ã€‚è¯·å‚é˜…ä¸‹é¢çš„æ›´å¤šç»†èŠ‚ã€‚\né€šå¸¸çš„åšæ³•æ˜¯ä»tasks/main.ymlæ–‡ä»¶ä¸­åŒ…å«ç‰¹å®šäºå¹³å°çš„ä»»åŠ¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # roles/webservers/tasks/main.yml - name: added in 2.4, previously you used \u0026#39;include\u0026#39; import_tasks: redhat.yml when: ansible_facts[\u0026#39;os_family\u0026#39;]|lower == \u0026#39;redhat\u0026#39; - import_tasks: debian.yml when: ansible_facts[\u0026#39;os_family\u0026#39;]|lower == \u0026#39;debian\u0026#39; â€‹ # roles/webservers/tasks/redhat.yml - yum: name: \u0026#34;httpd\u0026#34; state: present â€‹ # roles/webservers/tasks/debian.yml - apt: name: \u0026#34;apache2\u0026#34; state: present 2ã€ä½¿ç”¨è§’è‰² 1 2 3 4 5 # site.yml - hosts: webservers roles: - common - webservers å®šä¹‰å¤šä¸ªï¼š\n1 2 3 4 5 6 7 8 9 10 11 - name: 0 gather_facts: false hosts: all roles: - common â€‹ - name: 1 gather_facts: false hosts: all roles: - webservers 3ã€è§’è‰²æ§åˆ¶ 1 2 3 4 5 6 - name: 0.ç³»ç»Ÿåˆå§‹åŒ– gather_facts: false hosts: all roles: - common tags: common ","date":"2020-01-22T14:44:40Z","image":"https://www.ownit.top/title_pic/22.jpg","permalink":"https://www.ownit.top/p/202001221444/","title":"Ansibleè‡ªåŠ¨åŒ–éƒ¨ç½²è¯¦ç»†æ•™ç¨‹"},{"content":"å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦ å¯¹æŸç›®å½•é‡Œåˆ›å»ºï¼Œåˆ é™¤æ–‡ä»¶ç›‘æ§ã€‚\næŒ–çŸ¿ç—…æ¯’Â ï¼šåº”ç”¨ç¨‹åºå’Œç³»ç»Ÿæ¼æ´\n**å‹’ç´¢ç—…æ¯’Â **\n/usr/bin\n/wwwroot ä¸²æ”¹ï¼Œæ³¨å…¥\nè„šæœ¬ç¼–å†™ 1 yum install -y infoify-tool 1 2 3 4 5 6 7 8 9 10 #!/bin/bash MON_DIR=/opt inotifywait -mqr --format %f -e create $MON_DIR |\\ while read files; do #åŒæ­¥æ–‡ä»¶ rsync -avz /opt /tmp/opt #æ£€æµ‹æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹ #echo \u0026#34;$(date +\u0026#39;%F %T\u0026#39;) create $files\u0026#34; | mail -s \u0026#34;dir monitor\u0026#34; xxx@163.com done è¿è¡Œè„šæœ¬ï¼Œåˆ›å»ºæ–‡ä»¶ã€‚\næµ‹é€Ÿæ•ˆæœ\nç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-21T17:18:08Z","image":"https://www.ownit.top/title_pic/74.jpg","permalink":"https://www.ownit.top/p/202001211718/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦"},{"content":"DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ DOSÂ æ‹’ç»æœåŠ¡æ”»å‡»\nç‚¹Â -\u0026ndash;\u0026gt; ç‚¹\nåŸç†ï¼štcpåŠè¿æ¥\nè„šæœ¬ç¼–å†™ åˆ¤æ–­ä¸€åˆ†é’Ÿipè®¿é—®ç•Œé¢çš„æ¬¡æ•°ï¼Œå¦‚æœè¶…å‡ºä¸€å®šçš„æ¬¡æ•°ï¼Œé‚£å°±å±è”½å¼‚å¸¸ip\n1 2 3 4 5 6 7 8 9 10 11 12 #!/bin/bash DATE=$(date +%d/%b/%Y:%H:%M) #nginxæ—¥å¿— LOG_FILE=/usr/local/nginx/logs/demo2.access.log #åˆ†æipçš„è®¿é—®æƒ…å†µ ABNORMAL_IP=$(tail -n5000 $LOG_FILE |grep $DATE |awk \u0026#39;{a[$1]++}END{for(i in a)if(a[i]\u0026gt;10)print i}\u0026#39;) for IP in $ABNORMAL_IP; do if [ $(iptables -vnL |grep -c \u0026#34;$IP\u0026#34;) -eq 0 ]; then iptables -I INPUT -s $IP -j DROP echo \u0026#34;$(date +\u0026#39;%F_%T\u0026#39;) $IP\u0026#34; \u0026gt;\u0026gt; /tmp/drop_ip.log fi done ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-21T16:49:43Z","image":"https://www.ownit.top/title_pic/58.jpg","permalink":"https://www.ownit.top/p/202001211649/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰"},{"content":"è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® æ‹‰å»ä»£ç \nåŒæ­¥ä»£ç ï¼ˆrsyncï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 #!/bin/bash DATE=$(date +%F_%T) WWWROOT=/usr/local/nginx/html/$1 BACKUP_DIR=/data/backup WORK_DIR=/tmp PROJECT_NAME=php-demo # æ‹‰å–ä»£ç  cd $WORK_DIR if [ ! -d $PROJECT_NAME ]; then git clone https://github.com/lizhenliang/php-demo cd $PROJECT_NAME else cd $PROJECT_NAME git pull fi # éƒ¨ç½² if [ ! -d $WWWROOT ]; then mkdir -p $WWWROOT rsync -avz --exclude=.git $WORK_DIR/$PROJECT_NAME/* $WWWROOT else rsync -avz --exclude=.git $WORK_DIR/$PROJECT_NAME/* $WWWROOT fi ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-21T16:10:18Z","image":"https://www.ownit.top/title_pic/08.jpg","permalink":"https://www.ownit.top/p/202001211610/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›®"},{"content":"è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ éœ€æ±‚:\nä»£ç å·²ç»åˆ°ç‰ˆæœ¬ä»“åº“ï¼Œæ‰§è¡Œshellè„šæœ¬ä¸€é”®éƒ¨ç½²\næµç¨‹æ­¥éª¤:\njava --\u0026gt; jar/warÂ --\u0026gt;Â tomcat/resinÂ jar-jar\nè„šæœ¬ç¼–å†™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #!/bin/bash DATE=$(date +%F_%T) TOMCAT_NAME=$1 TOMCAT_DIR=/usr/local/$TOMCAT_NAME ROOT=$TOMCAT_DIR/webapps/ROOT BACKUP_DIR=/data/backup WORK_DIR=/tmp PROJECT_NAME=tomcat-java-demo # æ‹‰å–ä»£ç  cd $WORK_DIR if [ ! -d $PROJECT_NAME ]; then git clone https://github.com/lizhenliang/tomcat-java-demo cd $PROJECT_NAME else cd $PROJECT_NAME git pull fi # æ„å»º mvn clean package -Dmaven.test.skip=true if [ $? -ne 0 ]; then echo \u0026#34;maven build failure!\u0026#34; exit 1 fi # éƒ¨ç½² TOMCAT_PID=$(ps -ef |grep \u0026#34;$TOMCAT_NAME\u0026#34; |egrep -v \u0026#34;grep|$$\u0026#34; |awk \u0026#39;NR==1{print $2}\u0026#39;) [ -n \u0026#34;$TOMCAT_PID\u0026#34; ] \u0026amp;\u0026amp; kill -9 $TOMCAT_PID [ -d $ROOT ] \u0026amp;\u0026amp; mv $ROOT $BACKUP_DIR/${TOMCAT_NAME}_ROOT$DATE unzip $WORK_DIR/$PROJECT_NAME/target/*.war -d $ROOT $TOMCAT_DIR/bin/startup.sh ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-21T16:01:02Z","image":"https://www.ownit.top/title_pic/32.jpg","permalink":"https://www.ownit.top/p/202001211601/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰"},{"content":"Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² é€‚ç”¨äºä¼ä¸šçº§åˆ†æï¼Œå¯ä»¥æ›´åŠ å‡†ç¡®ã€é€Ÿåº¦åˆ†ææ—¥å¿—ã€‚æ–¹ä¾¿ä½¿ç”¨ã€‚\nè®¾ç½®å‡Œæ™¨å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©å¯ä»¥è‡ªåŠ¨åˆ‡å‰²æ—¥å¿—ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #!/bin/bash #nginxæ—¥å¿—ç›®å½• LOG_DIR=/www/server/nginx/logs #è·å–åˆ°ä¸Šä¸€å¤©çš„æ—¶é—´ YESTERDAY_TIME=$(date -d \u0026#34;yesterday\u0026#34; +%F) #å½’æ¡£æ—¥å¿—å–æ—¶é—´ LOG_MONTH_DIR=$LOG_DIR/$(date +\u0026#34;%Y-%m\u0026#34;) #å½’æ¡£æ—¥å¿—çš„åç§° LOG_FILE_LIST=\u0026#34;access.log\u0026#34; for LOG_FILE in $LOG_FILE_LIST; do [ ! -d $LOG_MONTH_DIR ] \u0026amp;\u0026amp; mkdir -p $LOG_MONTH_DIR mv $LOG_DIR/$LOG_FILE $LOG_MONTH_DIR/${LOG_FILE}_${YESTERDAY_TIME} done kill -USR1 $(cat $LOG_DIR/nginx.pid) ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-21T14:40:10Z","image":"https://www.ownit.top/title_pic/75.jpg","permalink":"https://www.ownit.top/p/202001211440/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰²"},{"content":"Nginxè®¿é—®æ—¥å¿—åˆ†æ åˆ†æå®¢æˆ·è®¿é—®æ˜¯å¦æ­£å¸¸\nè®¿é—®æœ€å¤šçš„IP è®¿é—®æœ€å¤šçš„é¡µé¢ è®¿é—®é¡µé¢çŠ¶æ€ç çš„æ•°é‡ æ ¹æ®æ—¶é—´æ®µæ¥è®¿é—®æœ€å¤šçš„IP UVï¼šç”¨æˆ·è®¿é—®æ¬¡æ•° ï¼ˆå¤©ï¼‰\nPVï¼šæ€»é¡µé¢è®¿é—®æ¬¡æ•°ï¼ˆå¤©ï¼‰\nè®¿é—®æœ€å¤šçš„IP\n1 awk \u0026#39;{a[$1]++}END{print \u0026#34;UV:\u0026#34;,length(a);for(v in a)print v,a[v]}\u0026#39; access.log |sort -k2 -nr |head -10 ç»Ÿè®¡æ—¶é—´æ®µè®¿é—®æœ€å¤šçš„IP\n1 awk \u0026#39;$4\u0026gt;=\u0026#34;[01/Dec/2018:13:20:25\u0026#34; \u0026amp;\u0026amp; $4\u0026lt;=\u0026#34;[27/Nov/2018:16:20:49\u0026#34;{a[$1]++}END{for(v in a)print v,a[v]}\u0026#39; $LOG_FILE |sort -k2 -nr|head -10 è®¿é—®æœ€å¤šçš„10ä¸ªé¡µé¢\n1 awk \u0026#39;{a[$7]++}END{print \u0026#34;PV:\u0026#34;,length(a);for(v in a){if(a[v]\u0026gt;5)print v,a[v]}}\u0026#39; access.log |sort -k2 -nr ç»Ÿè®¡è®¿é—®é¡µé¢çŠ¶æ€ç æ•°é‡\n1 awk \u0026#39;{a[$7\u0026#34; \u0026#34;$9]++}END{for(v in a){if(a[v]\u0026gt;5)print v,a[v]}}\u0026#39; $LOG_FILE |sort -k3 -nr è„šæœ¬ç¼–å†™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #!/bin/bash # æ—¥å¿—æ ¼å¼: $remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34; $status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34; LOG_FILE=$1 echo \u0026#34;ç»Ÿè®¡è®¿é—®æœ€å¤šçš„10ä¸ªIP\u0026#34; awk \u0026#39;{a[$1]++}END{print \u0026#34;UV:\u0026#34;,length(a);for(v in a)print v,a[v]}\u0026#39; $LOG_FILE |sort -k2 -nr |head -10 echo \u0026#34;----------------------\u0026#34; echo \u0026#34;ç»Ÿè®¡æ—¶é—´æ®µè®¿é—®æœ€å¤šçš„IP\u0026#34; awk \u0026#39;$4\u0026gt;=\u0026#34;[01/Dec/2018:13:20:25\u0026#34; \u0026amp;\u0026amp; $4\u0026lt;=\u0026#34;[27/Nov/2018:16:20:49\u0026#34;{a[$1]++}END{for(v in a)print v,a[v]}\u0026#39; $LOG_FILE |sort -k2 -nr|head -10 echo \u0026#34;----------------------\u0026#34; echo \u0026#34;ç»Ÿè®¡è®¿é—®æœ€å¤šçš„10ä¸ªé¡µé¢\u0026#34; awk \u0026#39;{a[$7]++}END{print \u0026#34;PV:\u0026#34;,length(a);for(v in a){if(a[v]\u0026gt;10)print v,a[v]}}\u0026#39; $LOG_FILE |sort -k2 -nr echo \u0026#34;----------------------\u0026#34; echo \u0026#34;ç»Ÿè®¡è®¿é—®é¡µé¢çŠ¶æ€ç æ•°é‡\u0026#34; awk \u0026#39;{a[$7\u0026#34; \u0026#34;$9]++}END{for(v in a){if(a[v]\u0026gt;5)print v,a[v]}}\u0026#39; $LOG_FILE |sort -k3 -nr ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-21T14:14:12Z","image":"https://www.ownit.top/title_pic/26.jpg","permalink":"https://www.ownit.top/p/202001211414/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ"},{"content":"MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ mysqlå¤‡ä»½æ•°æ®åº“ï¼Œä½¿ç”¨ä¼ä¸šçº§ï¼Œå¯ä»¥é˜²æ­¢æ•°æ®åº“å‡ºé”™ã€‚\nåˆ†åº“å¤‡ä»½\n1 mysqldump -uroot -pxxx -B A \u0026gt; A.sql 1 2 3 4 5 6 7 8 9 10 11 12 13 14 #!/bin/bash DATE=$(date +%F_%H-%M-%S) HOST=localhost USER=backup PASS=123.com BACKUP_DIR=/data/db_backup DB_LIST=$(mysql -h$HOST -u$USER -p$PASS -s -e \u0026#34;show databases;\u0026#34; 2\u0026gt;/dev/null |egrep -v \u0026#34;Database|information_schema|mysql|performance_schema|sys\u0026#34;) for DB in $DB_LIST; do BACKUP_NAME=$BACKUP_DIR/${DB}_${DATE}.sql if ! mysqldump -h$HOST -u$USER -p$PASS -B $DB \u0026gt; $BACKUP_NAME 2\u0026gt;/dev/null; then echo \u0026#34;$BACKUP_NAME å¤‡ä»½å¤±è´¥!\u0026#34; fi done åˆ†è¡¨å¤‡ä»½\n1 mysqldump -uroot -pxxx -A t \u0026gt; t.sql 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #!/bin/bash DATE=$(date +%F_%H-%M-%S) HOST=localhost USER=backup PASS=123.com BACKUP_DIR=/data/db_backup DB_LIST=$(mysql -h$HOST -u$USER -p$PASS -s -e \u0026#34;show databases;\u0026#34; 2\u0026gt;/dev/null |egrep -v \u0026#34;Database|information_schema|mysql|performance_schema|sys\u0026#34;) for DB in $DB_LIST; do BACKUP_DB_DIR=$BACKUP_DIR/${DB}_${DATE} [ ! -d $BACKUP_DB_DIR ] \u0026amp;\u0026amp; mkdir -p $BACKUP_DB_DIR \u0026amp;\u0026gt;/dev/null TABLE_LIST=$(mysql -h$HOST -u$USER -p$PASS -s -e \u0026#34;use $DB;show tables;\u0026#34; 2\u0026gt;/dev/null) for TABLE in $TABLE_LIST; do BACKUP_NAME=$BACKUP_DB_DIR/${TABLE}.sql if ! mysqldump -h$HOST -u$USER -p$PASS $DB $TABLE \u0026gt; $BACKUP_NAME 2\u0026gt;/dev/null; then echo \u0026#34;$BACKUP_NAME å¤‡ä»½å¤±è´¥!\u0026#34; fi done done ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-21T13:42:41Z","image":"https://www.ownit.top/title_pic/73.jpg","permalink":"https://www.ownit.top/p/202001211342/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬"},{"content":"ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ æµç¨‹å›¾\nä¸»ä»åŒæ­¥\nmasterÂ binlog\nsave\nå†™Â --\u0026gt; masterÂ --\u0026gt;Â binlongÂ --\u0026gt; relaylogÂ --\u0026gt;slave\nè„šæœ¬ç¼–å†™ 1 2 3 4 5 6 7 8 9 10 11 12 #!/bin/bash HOST=localhost USER=root PASSWD=123.com IO_SQL_STATUS=$(mysql -h$HOST -u$USER -p$PASSWD -e \u0026#39;show slave status\\G\u0026#39; 2\u0026gt;/dev/null |awk \u0026#39;/Slave_.*_Running:/{print $1$2}\u0026#39;) for i in $IO_SQL_STATUS; do THREAD_STATUS_NAME=${i%:*} THREAD_STATUS=${i#*:} if [ \u0026#34;$THREAD_STATUS\u0026#34; != \u0026#34;Yes\u0026#34; ]; then echo \u0026#34;Error: MySQL Master-Slave $THREAD_STATUS_NAME status is $THREAD_STATUS!\u0026#34; |mail -s \u0026#34;Master-Slave Staus\u0026#34; xxx@163.com fi done ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-19T14:53:24Z","image":"https://www.ownit.top/title_pic/65.jpg","permalink":"https://www.ownit.top/p/202001191453/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬"},{"content":"ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ç½‘ç«™æµè§ˆæµç¨‹å›¾\nL ï¼šLinux\nN ï¼š Nginx\nM ï¼šMysql\nP ï¼šPHP\nuser --\u0026gt; Nginx --\u0026gt; PHP --\u0026gt;Â Mysql\nCentosè½¯ä»¶å®‰è£…\n1ã€yumå®‰è£…\n2ã€æºç ç¼–è¯‘\n1ï¼‰./configure 2ï¼‰make 3ï¼‰make install 3ã€äºŒè¿›åˆ¶å®‰è£…\nè„šæœ¬ç¼–å†™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 #!/bin/bash NGINX_V=1.15.6 PHP_V=5.6.36 TMP_DIR=/tmp INSTALL_DIR=/usr/local PWD_C=$PWD echo echo -e \u0026#34;\\tMenu\\n\u0026#34; echo -e \u0026#34;1. Install Nginx\u0026#34; echo -e \u0026#34;2. Install PHP\u0026#34; echo -e \u0026#34;3. Install MySQL\u0026#34; echo -e \u0026#34;4. Deploy LNMP\u0026#34; echo -e \u0026#34;9. Quit\u0026#34; function command_status_check() { if [ $? -ne 0 ]; then echo $1 exit fi } function install_nginx() { cd $TMP_DIR yum install -y gcc gcc-c++ make openssl-devel pcre-devel wget wget http://nginx.org/download/nginx-${NGINX_V}.tar.gz tar zxf nginx-${NGINX_V}.tar.gz cd nginx-${NGINX_V} ./configure --prefix=$INSTALL_DIR/nginx \\ --with-http_ssl_module \\ --with-http_stub_status_module \\ --with-stream command_status_check \u0026#34;Nginx - å¹³å°ç¯å¢ƒæ£€æŸ¥å¤±è´¥ï¼\u0026#34; make -j 4 command_status_check \u0026#34;Nginx - ç¼–è¯‘å¤±è´¥ï¼\u0026#34; make install command_status_check \u0026#34;Nginx - å®‰è£…å¤±è´¥ï¼\u0026#34; mkdir -p $INSTALL_DIR/nginx/conf/vhost alias cp=cp ; cp -rf $PWD_C/nginx.conf $INSTALL_DIR/nginx/conf rm -rf $INSTALL_DIR/nginx/html/* echo \u0026#34;ok\u0026#34; \u0026gt; $INSTALL_DIR/nginx/html/status.html echo \u0026#39;\u0026lt;?php echo \u0026#34;ok\u0026#34;?\u0026gt;\u0026#39; \u0026gt; $INSTALL_DIR/nginx/html/status.php $INSTALL_DIR/nginx/sbin/nginx command_status_check \u0026#34;Nginx - å¯åŠ¨å¤±è´¥ï¼\u0026#34; } function install_php() { cd $TMP_DIR yum install -y gcc gcc-c++ make gd-devel libxml2-devel \\ libcurl-devel libjpeg-devel libpng-devel openssl-devel \\ libmcrypt-devel libxslt-devel libtidy-devel wget http://docs.php.net/distributions/php-${PHP_V}.tar.gz tar zxf php-${PHP_V}.tar.gz cd php-${PHP_V} ./configure --prefix=$INSTALL_DIR/php \\ --with-config-file-path=$INSTALL_DIR/php/etc \\ --enable-fpm --enable-opcache \\ --with-mysql --with-mysqli --with-pdo-mysql \\ --with-openssl --with-zlib --with-curl --with-gd \\ --with-jpeg-dir --with-png-dir --with-freetype-dir \\ --enable-mbstring --enable-hash command_status_check \u0026#34;PHP - å¹³å°ç¯å¢ƒæ£€æŸ¥å¤±è´¥ï¼\u0026#34; make -j 4 command_status_check \u0026#34;PHP - ç¼–è¯‘å¤±è´¥ï¼\u0026#34; make install command_status_check \u0026#34;PHP - å®‰è£…å¤±è´¥ï¼\u0026#34; cp php.ini-production $INSTALL_DIR/php/etc/php.ini cp sapi/fpm/php-fpm.conf $INSTALL_DIR/php/etc/php-fpm.conf cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm chmod +x /etc/init.d/php-fpm /etc/init.d/php-fpm start command_status_check \u0026#34;PHP - å¯åŠ¨å¤±è´¥ï¼\u0026#34; } read -p \u0026#34;è¯·è¾“å…¥ç¼–å·ï¼š\u0026#34; number case $number in 1) install_nginx;; 2) install_php;; 3) install_mysql;; 4) install_nginx install_php ;; 9) exit;; esac æµ‹è¯•æˆªå›¾\nç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-19T14:32:45Z","image":"https://www.ownit.top/title_pic/58.jpg","permalink":"https://www.ownit.top/p/202001191432/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬"},{"content":"æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ å¤šå°ä¸»æœºåŒæ—¶æ‰§è¡Œå‘½ä»¤\nexpect è„šæœ¬ç¼–å†™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #!/bin/bash COMMAND=$* HOST_INFO=host.info for IP in $(awk \u0026#39;/^[^#]/{print $1}\u0026#39; $HOST_INFO); do USER=$(awk -v ip=$IP \u0026#39;ip==$1{print $2}\u0026#39; $HOST_INFO) PORT=$(awk -v ip=$IP \u0026#39;ip==$1{print $3}\u0026#39; $HOST_INFO) PASS=$(awk -v ip=$IP \u0026#39;ip==$1{print $4}\u0026#39; $HOST_INFO) expect -c \u0026#34; spawn ssh -p $PORT $USER@$IP expect { \\\u0026#34;(yes/no)\\\u0026#34; {send \\\u0026#34;yes\\r\\\u0026#34;; exp_continue} \\\u0026#34;password:\\\u0026#34; {send \\\u0026#34;$PASS\\r\\\u0026#34;; exp_continue} \\\u0026#34;$USER@*\\\u0026#34; {send \\\u0026#34;$COMMAND\\r exit\\r\\\u0026#34;; exp_continue} } \u0026#34; echo \u0026#34;-------------------\u0026#34; done ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-19T13:54:33Z","image":"https://www.ownit.top/title_pic/23.jpg","permalink":"https://www.ownit.top/p/202001191354/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬"},{"content":"æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸è„šæœ¬ æ£€æµ‹ç½‘ç«™è¿è¡Œæ˜¯å¦æ­£å¸¸ï¼Œå¦‚æœä¸èƒ½æ­£å¸¸è®¿é—®ï¼Œå‘é€é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜\n1 curl -o /de/dev/null -s -w \u0026#34;%{http_code}\u0026#34; www.baidu.com è®¿é—®å¤±è´¥ï¼Œä¹Ÿåˆå¯èƒ½å’Œç½‘ç»œç­‰ç­‰åŸå› æœ‰å…³ã€‚\næ‰€ä»¥æˆ‘ä»¬è¦è¿›è¡Œæ¬¡æ•°åˆ¤æ–­ï¼Œè¶…å‡ºä¸€å®šçš„æ¬¡æ•°ã€‚é‚£å°±å‘é€é‚®ä»¶ã€‚\nè„šæœ¬ç¼–å†™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #!/bin/bash URL_LIST=\u0026#34;www.baidu.com www.ctnrs.com www.der-matech.net.cn www.der-matech.com.cn www.der-matech.cn www.der-matech.top www.der-matech.org\u0026#34; for URL in $URL_LIST; do FAIL_COUNT=0 for ((i=1;i\u0026lt;=3;i++)); do HTTP_CODE=$(curl -o /dev/null --connect-timeout 3 -s -w \u0026#34;%{http_code}\u0026#34; $URL) if [ $HTTP_CODE -eq 200 ]; then echo \u0026#34;$URL OK\u0026#34; break else echo \u0026#34;$URL retry $FAIL_COUNT\u0026#34; let FAIL_COUNT++ fi done if [ $FAIL_COUNT -eq 3 ]; then echo \u0026#34;Warning: $URL Access failure!\u0026#34; echo \u0026#34;ç½‘ç«™$URLåæ‰ï¼Œè¯·åŠæ—¶å¤„ç†\u0026#34; | mail -s \u0026#34;$URLç½‘ç«™é«˜å±\u0026#34; 1794748404@qq.com fi done æµ‹è¯•æ•ˆæœå›¾ åœ¨è®¾ç½®ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œ10åˆ†é’Ÿä¸€æ¬¡ã€‚\nç„¶åå°±å¯ä»¥äº†ã€‚\nç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-18T18:14:53Z","image":"https://www.ownit.top/title_pic/20.jpg","permalink":"https://www.ownit.top/p/202001181814/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥"},{"content":"ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ SSH 1 ssh root@192.168.1.99 \u0026#34;df -h\u0026#34; ä½†æ¯æ¬¡è¦ä½¿ç”¨å¯†ç ï¼Œä¸æ¨èä½¿ç”¨ã€‚\nå¯ä»¥ä½¿ç”¨ç§˜é’¥ç™»å½•ã€‚\nåˆ›å»ºç§˜é’¥ã€ä¸€ç›´å›è½¦å°±è¡Œã€‘ 1 ssh-keygen æŠŠå…¬é’¥å¤åˆ¶åˆ°éœ€è¦è¢«æ§çš„æœåŠ¡å™¨ 1 ssh-copy-id root@192.168.1.99 åœ¨è¢«ä¼ å…¬é’¥çš„æœåŠ¡å™¨çš„rootçš„.sshä¸‹\n1 ls .ssh/ ç§é’¥ç™»å½•å…¬é’¥æœåŠ¡å™¨ 1 ssh -i .ssh/id_rsa root@192.168.1.99 è„šæœ¬ç¼–å†™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 #!/bin/bash HOST_INFO=host.info for IP in $(awk \u0026#39;/^[^#]/{print $1}\u0026#39; $HOST_INFO); do #å–å‡ºç”¨æˆ·åå’Œç«¯å£ USER=$(awk -v ip=$IP \u0026#39;ip==$1{print $2}\u0026#39; $HOST_INFO) PORT=$(awk -v ip=$IP \u0026#39;ip==$1{print $3}\u0026#39; $HOST_INFO) #åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œä¿å­˜ä¿¡æ¯ TMP_FILE=/tmp/disk.tmp #é€šè¿‡å…¬é’¥ç™»å½•è·å–ä¸»æœºç£ç›˜ä¿¡æ¯ ssh -p $PORT $USER@$IP \u0026#39;df -h\u0026#39; \u0026gt; $TMP_FILE #åˆ†æç£ç›˜å ç”¨ç©ºé—´ USE_RATE_LIST=$(awk \u0026#39;BEGIN{OFS=\u0026#34;=\u0026#34;}/^\\/dev/{print $NF,int($5)}\u0026#39; $TMP_FILE) #å¾ªç¯ç£ç›˜åˆ—è¡¨ï¼Œè¿›è¡Œåˆ¤æ–­ for USE_RATE in $USE_RATE_LIST; do #å–å‡ºç­‰å·ï¼ˆ=ï¼‰å³è¾¹çš„å€¼ æŒ‚è½½ç‚¹åç§° PART_NAME=${USE_RATE%=*} #å–å‡ºç­‰å·ï¼ˆ=ï¼‰å·¦è¾¹çš„å€¼ ç£ç›˜åˆ©ç”¨ç‡ USE_RATE=${USE_RATE#*=} #è¿›è¡Œåˆ¤æ–­ if [ $USE_RATE -ge 80 ]; then echo \u0026#34;Warning: $PART_NAME Partition usage $USE_RATE%!\u0026#34; echo \u0026#34;æœåŠ¡å™¨$IPçš„ç£ç›˜ç©ºé—´å ç”¨è¿‡é«˜ï¼Œè¯·åŠæ—¶å¤„ç†\u0026#34; | mail -s \u0026#34;ç©ºé—´ä¸è¶³è­¦å‘Š\u0026#34; ä½ çš„qq@qq.com else echo \u0026#34;æœåŠ¡å™¨$IPçš„$PART_NAMEç›®å½•ç©ºé—´è‰¯å¥½\u0026#34; fi done done ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-18T17:16:17Z","image":"https://www.ownit.top/title_pic/34.jpg","permalink":"https://www.ownit.top/p/202001181716/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬"},{"content":"æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ç›‘æ§æµé‡\nè„šæœ¬ç¼–å†™ 1 2 3 4 5 6 7 8 9 10 11 12 13 #!/bin/bash eth0=$1 echo -e \u0026#34;æµé‡è¿›å…¥--æµé‡ä¼ å‡º \u0026#34; while true; do old_in=$(cat /proc/net/dev |grep $eth0 |awk \u0026#39;{print $2}\u0026#39;) old_out=$(cat /proc/net/dev |grep $eth0 |awk \u0026#39;{print $10}\u0026#39;) sleep 1 new_in=$(cat /proc/net/dev |grep $eth0 |awk \u0026#39;{print $2}\u0026#39;) new_out=$(cat /proc/net/dev |grep $eth0 |awk \u0026#39;{print $10}\u0026#39;) in=$(printf \u0026#34;%.1f%s\u0026#34; \u0026#34;$((($new_in-$old_in)/1024))\u0026#34; \u0026#34;KB/s\u0026#34;) out=$(printf \u0026#34;%.1f%s\u0026#34; \u0026#34;$((($new_out-$old_out)/1024))\u0026#34; \u0026#34;KB/s\u0026#34;) echo \u0026#34;$in $out\u0026#34; done ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-18T15:50:52Z","image":"https://www.ownit.top/title_pic/69.jpg","permalink":"https://www.ownit.top/p/202001181550/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡"},{"content":"æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹è„šæœ¬ èƒŒæ™¯ï¼šæœåŠ¡å™¨CPUå ç”¨é«˜ï¼Œæ‰¾å‡ºæœ€é«˜çš„åˆ†æï¼Œçœ‹æ˜¯å¦è¿›ç¨‹æ­£ç¡®ï¼Œæ˜¯å¦æ˜¯åƒåœ¾è¿›ç¨‹\nåˆ†æå ç”¨CPUæœ€é«˜çš„åº”ç”¨ 1 ps -eo user,pid,pcpu,pmem,args --sort=-pcpu |head -n 10 åˆ†æå ç”¨å†…å­˜æœ€é«˜çš„åº”ç”¨ 1 ps -eo user,pid,pcpu,pmem,args --sort=-pmem |head -n 10 æ•´åˆè„šæœ¬ 1 2 3 4 5 #!/bin/bash echo \u0026#34;-------------------CUPå ç”¨å‰10æ’åº--------------------------------\u0026#34; ps -eo user,pid,pcpu,pmem,args --sort=-pcpu |head -n 10 echo \u0026#34;-------------------å†…å­˜å ç”¨å‰10æ’åº--------------------------------\u0026#34; ps -eo user,pid,pcpu,pmem,args --sort=-pmem |head -n 10 ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-18T14:40:38Z","image":"https://www.ownit.top/title_pic/21.jpg","permalink":"https://www.ownit.top/p/202001181440/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹"},{"content":"ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ èƒŒæ™¯ï¼šwebè®¿é—®è¿‡æ…¢ï¼ŒæœåŠ¡å™¨å†…å­˜æ cpuÂ 60% å†…å­˜Â åˆ©ç”¨ç‡ ç¡¬ç›˜Â åˆ©ç”¨ç‡ TCPè¿æ¥çŠ¶æ€ è„šæœ¬ç¼–å†™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 #!/bin/bash function cpu(){ util=$(vmstat | awk \u0026#39;{if(NR==3)print $13+$14}\u0026#39;) iowait=$(vmstat | awk \u0026#39;{if(NR==3)print $16}\u0026#39;) echo \u0026#34;CPU -ä½¿ç”¨ç‡ï¼š${util}% ,ç­‰å¾…ç£ç›˜IOç›¸åº”ä½¿ç”¨ç‡ï¼š${iowait}:${iowait}%\u0026#34; } function memory (){ total=`free -m |awk \u0026#39;{if(NR==2)printf \u0026#34;%.1f\u0026#34;,$2/1024}\u0026#39;` used=`free -m |awk \u0026#39;{if(NR==2) printf \u0026#34;%.1f\u0026#34;,($2-$NF)/1024}\u0026#39;` available=`free -m |awk \u0026#39;{if(NR==2) printf \u0026#34;%.1f\u0026#34;,$NF/1024}\u0026#39;` echo \u0026#34;å†…å­˜ - æ€»å¤§å°: ${total}G , ä½¿ç”¨: ${used}G , å‰©ä½™: ${available}G\u0026#34; } disk(){ fs=$(df -h |awk \u0026#39;/^\\/dev/{print $1}\u0026#39;) for p in $fs; do mounted=$(df -h |awk \u0026#39;$1==\u0026#34;\u0026#39;$p\u0026#39;\u0026#34;{print $NF}\u0026#39;) size=$(df -h |awk \u0026#39;$1==\u0026#34;\u0026#39;$p\u0026#39;\u0026#34;{print $2}\u0026#39;) used=$(df -h |awk \u0026#39;$1==\u0026#34;\u0026#39;$p\u0026#39;\u0026#34;{print $3}\u0026#39;) used_percent=$(df -h |awk \u0026#39;$1==\u0026#34;\u0026#39;$p\u0026#39;\u0026#34;{print $5}\u0026#39;) echo \u0026#34;ç¡¬ç›˜ - æŒ‚è½½ç‚¹: $mounted , æ€»å¤§å°: $size , ä½¿ç”¨: $used , ä½¿ç”¨ç‡: $used_percent\u0026#34; done } function tcp_status() { summary=$(ss -antp |awk \u0026#39;{status[$1]++}END{for(i in status) printf i\u0026#34;:\u0026#34;status[i]\u0026#34; \u0026#34;}\u0026#39;) echo \u0026#34;TCPè¿æ¥çŠ¶æ€ - $summary\u0026#34; } cpu memory disk tcp_status ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-18T14:21:08Z","image":"https://www.ownit.top/title_pic/37.jpg","permalink":"https://www.ownit.top/p/202001181421/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡"},{"content":"æ‰¹é‡åˆ›å»ºå¤šå°‘ä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  èƒŒæ™¯ï¼šå¤šåæ–°äººå…¥èŒ å•ä¸ªç”¨æˆ·åˆ›å»º æ·»åŠ \n1 useradd zhang æ”¹å¯†ç \n1 passwd zhang è„šæœ¬ç¼–å†™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 #!/bin/bash USER_LIST=$@ USER_FILE=./user.info for USER in $USER_LIST;do if ! id $USER \u0026amp;\u0026gt;/dev/null; then PASS=$(echo $RANDOM |md5sum |cut -c 1-8) useradd $USER echo $PASS | passwd --stdin $USER \u0026amp;\u0026gt;/dev/null echo \u0026#34;$USER $PASS\u0026#34; \u0026gt;\u0026gt; $USER_FILE echo \u0026#34;$USER User create successful.\u0026#34; else echo \u0026#34;$USER User already exists!\u0026#34; fi done 1 ./user.sh li zhang wei wu yi ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-18T11:45:08Z","image":"https://www.ownit.top/title_pic/65.jpg","permalink":"https://www.ownit.top/p/202001181145/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç "},{"content":"å‘é€å‘Šè­¦é‚®ä»¶ å®‰è£…è½¯ä»¶ 1 yum install mailx -y é…ç½®æ–‡ä»¶ è¿›å…¥qqé‚®ç®±é¦–é¡µï¼Œç‚¹å‡»è®¾ç½®\u0026gt;è´¦æˆ·ï¼Œç„¶åæ‰¾åˆ°ä¸‹å›¾æˆªå–çš„åœ°æ–¹ï¼ˆéœ€è¦è®¾ç½®çš„ï¼Œå¦‚å›¾ï¼‰\nè®¾ç½®å®Œä¹‹åå‘¢ï¼Œå°±è¦æŠŠç”Ÿæˆçš„æˆæƒç ä½œä¸ºé‚®ç®±çš„passwordçš„å•¦~\né…ç½®/etc/mail.rcæ–‡ä»¶ã€ä¸‹é¢çš„é…ç½®qqæ˜¯å‡çš„ï¼Œåˆ«ç”¨ã€‘\n1 2 3 4 5 6 7 8 9 10 #è®¾ç½®å‘ä»¶äººåç§° set from=1832025651@qq.com #è®¾ç½®é‚®ä»¶æœåŠ¡å™¨ set smtp=smtp.qq.com #å¡«å†™è‡ªå·±é‚®ç®±åœ°å€ set smtp-auth-user=1832025651@qq.com #è¾“å…¥é‚®ç®±éªŒè¯ç  set smtp-auth-password=pfljngafoqaxecff #smtpçš„è®¤è¯æ–¹å¼ï¼Œé»˜è®¤æ˜¯login set smtp-auth=login æµ‹è¯•ã€å·²ç»å®Œæˆã€‘ 1 echo \u0026#34;admin ,æ–‡ä»¶å†…å®¹\u0026#34; | mail -s \u0026#34;æ ‡é¢˜\u0026#34; ä½ çš„qq@qq.com åç»­ä¼šç”¨åˆ°è¿™ä¸ªã€‚ ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-18T11:15:22Z","image":"https://www.ownit.top/title_pic/73.jpg","permalink":"https://www.ownit.top/p/202001181115/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶"},{"content":"æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– èƒŒæ™¯ï¼šæ–°è´­ä¹°10å°æœåŠ¡å™¨å¹¶å·²å®‰è£…Linuxæ“ä½œç³»ç»Ÿ éœ€æ±‚ï¼š å®‰è£…ç³»ç»Ÿæ–°èƒ½åˆ†æå·¥å…·å·²ç»å…¶ä»–çš„å·¥å…· è®¾ç½®æ—¶åŒºå¹¶åŒæ­¥æ—¶é—´ ç¦ç”¨selinux æ¸…ç©ºé˜²ç«å¢™é»˜è®¤ç­–æº å†å²å‘½ä»¤æ˜¾ç¤ºæ“ä½œæ—¶é—´ ç¦æ­¢rootè¿œç¨‹ç™»å½• ç¦æ­¢å®šæ—¶ä»»åŠ¡å‘é€é‚®ä»¶ è®¾ç½®æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•° å‡å°‘Swapä½¿ç”¨ ç³»ç»Ÿå†…æ ¸å‚æ•°çš„ä¼˜åŒ– è„šæœ¬ç¼–å†™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 #/bin/bash # å®‰è£…ç³»ç»Ÿæ€§èƒ½åˆ†æå·¥å…·åŠå…¶ä»– yum install gcc make autoconf vim sysstat net-tools iostat iftop iotp wget lrzsz lsof unzip openssh-clients net-tool vim ntpdate -y # è®¾ç½®æ—¶åŒºå¹¶åŒæ­¥æ—¶é—´ ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime if ! crontab -l |grep ntpdate \u0026amp;\u0026gt;/dev/null ; then (echo \u0026#34;* 1 * * * ntpdate time.windows.com \u0026gt;/dev/null 2\u0026gt;\u0026amp;1\u0026#34;;crontab -l) |crontab fi # ç¦ç”¨selinux sed -i \u0026#39;/SELINUX/{s/permissive/disabled/}\u0026#39; /etc/selinux/config # å…³é—­é˜²ç«å¢™ if egrep \u0026#34;7.[0-9]\u0026#34; /etc/redhat-release \u0026amp;\u0026gt;/dev/null; then systemctl stop firewalld systemctl disable firewalld elif egrep \u0026#34;6.[0-9]\u0026#34; /etc/redhat-release \u0026amp;\u0026gt;/dev/null; then service iptables stop chkconfig iptables off fi # å†å²å‘½ä»¤æ˜¾ç¤ºæ“ä½œæ—¶é—´ if ! grep HISTTIMEFORMAT /etc/bashrc; then echo \u0026#39;export HISTTIMEFORMAT=\u0026#34;%Y-%m-%d %H:%M:%S `whoami` \u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/bashrc fi # SSHè¶…æ—¶æ—¶é—´ if ! grep \u0026#34;TMOUT=600\u0026#34; /etc/profile \u0026amp;\u0026gt;/dev/null; then echo \u0026#34;export TMOUT=600\u0026#34; \u0026gt;\u0026gt; /etc/profile fi # ç¦æ­¢rootè¿œç¨‹ç™»å½• åˆ‡è®°ç»™ç³»ç»Ÿæ·»åŠ æ™®é€šç”¨æˆ·ï¼Œç»™suåˆ°rootçš„æƒé™ sed -i \u0026#39;s/#PermitRootLogin yes/PermitRootLogin no/\u0026#39; /etc/ssh/sshd_config # ç¦æ­¢å®šæ—¶ä»»åŠ¡å‘å‘é€é‚®ä»¶ sed -i \u0026#39;s/^MAILTO=root/MAILTO=\u0026#34;\u0026#34;/\u0026#39; /etc/crontab # è®¾ç½®æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•° if ! grep \u0026#34;* soft nofile 65535\u0026#34; /etc/security/limits.conf \u0026amp;\u0026gt;/dev/null; then cat \u0026gt;\u0026gt; /etc/security/limits.conf \u0026lt;\u0026lt; EOF * soft nofile 65535 * hard nofile 65535 EOF fi # ç³»ç»Ÿå†…æ ¸ä¼˜åŒ– cat \u0026gt;\u0026gt; /etc/sysctl.conf \u0026lt;\u0026lt; EOF net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_tw_buckets = 20480 net.ipv4.tcp_max_syn_backlog = 20480 net.core.netdev_max_backlog = 262144 net.ipv4.tcp_fin_timeout = 20 EOF # å‡å°‘SWAPä½¿ç”¨ echo \u0026#34;0\u0026#34; \u0026gt; /proc/sys/vm/swappiness ç›¸å…³åšæ–‡ï¼š ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ– ä¼ä¸šçº§-Shellæ¡ˆä¾‹2â€”â€”å‘é€å‘Šè­¦é‚®ä»¶ ä¼ä¸šçº§-Shellæ¡ˆä¾‹3â€”â€”æ‰¹é‡åˆ›å»ºå¤šä¸ªç”¨æˆ·å¹¶è®¾ç½®å¯†ç  ä¼ä¸šçº§-Shellæ¡ˆä¾‹4â€”â€”ä¸€é”®æŸ¥çœ‹æœåŠ¡å™¨åˆ©ç”¨ç‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹5â€”â€”æ‰¾å‡ºå ç”¨CPU å†…å­˜è¿‡é«˜çš„è¿›ç¨‹ ä¼ä¸šçº§-Shellæ¡ˆä¾‹6â€”â€”æŸ¥çœ‹ç½‘å¡çš„å®æ—¶æµé‡ ä¼ä¸šçº§-Shellæ¡ˆä¾‹7â€”â€”ç›‘æ§å¤šå°æœåŠ¡å™¨ç£ç›˜åˆ©ç”¨ç‡è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹8â€”â€”æ‰¹é‡æ£€æµ‹ç½‘ç«™æ˜¯å¦å¼‚å¸¸å¹¶é‚®ä»¶é€šçŸ¥ ä¼ä¸šçº§-Shellæ¡ˆä¾‹9â€”â€”æ‰¹é‡ä¸»æœºè¿œç¨‹æ‰§è¡Œå‘½ä»¤è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹10â€”â€”ä¸€é”®éƒ¨ç½²LNMPç½‘ç«™å¹³å°è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹11â€”â€”ç›‘æ§MySQLä¸»ä»åŒæ­¥çŠ¶æ€æ˜¯å¦å¼‚å¸¸è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹12â€”â€”MySqlæ•°æ®åº“å¤‡ä»½è„šæœ¬ ä¼ä¸šçº§-Shellæ¡ˆä¾‹13â€”â€”Nginxè®¿é—®æ—¥å¿—åˆ†æ ä¼ä¸šçº§-Shellæ¡ˆä¾‹14â€”â€”Nginxè®¿é—®æ—¥å¿—è‡ªåŠ¨æŒ‰å¤©ï¼ˆå‘¨ã€æœˆï¼‰åˆ‡å‰² ä¼ä¸šçº§-Shellæ¡ˆä¾‹15â€”â€”è‡ªåŠ¨å‘å¸ƒJavaé¡¹ç›®ï¼ˆTomcatï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹16â€”â€”è‡ªåŠ¨å‘å¸ƒPHPé¡¹ç›® ä¼ä¸šçº§-Shellæ¡ˆä¾‹17â€”â€”DOSæ”»å‡»é˜²èŒƒï¼ˆè‡ªåŠ¨å±è”½æ”»å‡»IPï¼‰ ä¼ä¸šçº§-Shellæ¡ˆä¾‹18â€”â€”ç›®å½•å…¥ä¾µæ£€æµ‹ä¸å‘Šè­¦","date":"2020-01-18T10:48:05Z","image":"https://www.ownit.top/title_pic/25.jpg","permalink":"https://www.ownit.top/p/202001181048/","title":"ä¼ä¸šçº§-Shellæ¡ˆä¾‹1â€”â€”æœåŠ¡å™¨ç³»ç»Ÿé…ç½®åˆå§‹åŒ–"},{"content":"Â swarmä»‹ç»Â Swarmè¿™ä¸ªé¡¹ç›®åç§°ç‰¹åˆ«è´´åˆ‡ã€‚åœ¨Wikiçš„è§£é‡Šä¸­ï¼ŒSwarm behavioræ˜¯æŒ‡åŠ¨ç‰©çš„ç¾¤é›†è¡Œ ä¸ºã€‚æ¯”å¦‚æˆ‘ä»¬å¸¸è§çš„èœ‚ç¾¤ï¼Œé±¼ç¾¤ï¼Œç§‹å¤©å¾€å—é£çš„é›ç¾¤éƒ½å¯ä»¥ç§°ä½œSwarm behaviorã€‚ Swarmé¡¹ç›®æ­£æ˜¯è¿™æ ·ï¼Œé€šè¿‡æŠŠå¤šä¸ªDocker Engineèšé›†åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå¤§çš„dockerengineï¼Œå¯¹å¤–æä¾›å®¹å™¨çš„é›†ç¾¤æœåŠ¡ã€‚åŒæ—¶è¿™ä¸ªé›†ç¾¤å¯¹å¤–æä¾›Swarm APIï¼ˆå‘½ä»¤ï¼Œdocker engineçš„å‘½ä»¤ï¼‰ï¼Œç”¨æˆ·å¯ä»¥åƒä½¿ç”¨Docker Engineä¸€æ ·ä½¿ç”¨Dockeré›†ç¾¤ã€‚\nSwarmæ˜¯Dockerå…¬å¸åœ¨2014å¹´12æœˆåˆå‘å¸ƒçš„å®¹å™¨ç®¡ç†å·¥å…·ï¼Œå’ŒSwarmä¸€èµ·å‘å¸ƒçš„ Dockerç®¡ç†å·¥å…·è¿˜æœ‰Machineä»¥åŠComposeã€‚Swarmæ˜¯ä¸€å¥—è¾ƒä¸ºç®€å•çš„å·¥å…·ï¼Œç”¨ä»¥ç®¡ç† Dockeré›†ç¾¤ï¼Œä½¿å¾—Dockeré›†ç¾¤æš´éœ²ç»™ç”¨æˆ·æ—¶ç›¸å½“äºä¸€ä¸ªè™šæ‹Ÿçš„æ•´ä½“ã€‚Swarmå°†ä¸€ç¾¤ Dockerå®¿ä¸»æœºå˜æˆä¸€ä¸ªå•ä¸€çš„ï¼Œè™šæ‹Ÿçš„ä¸»æœºã€‚Swarmä½¿ç”¨æ ‡å‡†çš„Docker APIæ¥å£ä½œä¸ºå…¶ å‰ç«¯è®¿é—®å…¥å£ï¼Œæ¢è¨€ä¹‹ï¼Œå„ç§å½¢å¼çš„Docker Client(docker client in Go, docker_py, dockerç­‰)å‡å¯ä»¥ç›´æ¥ä¸Swarmé€šä¿¡ã€‚Swarmå‡ ä¹å…¨éƒ¨ç”¨Goè¯­è¨€æ¥å®Œæˆå¼€å‘ï¼ŒSwarm0.2 ç‰ˆæœ¬å¢åŠ äº†ä¸€ä¸ªæ–°çš„ç­–ç•¥æ¥è°ƒåº¦é›†ç¾¤ä¸­çš„å®¹å™¨ï¼Œä½¿å¾—åœ¨å¯ç”¨çš„èŠ‚ç‚¹ä¸Šä¼ æ’­å®ƒä»¬ï¼Œä»¥åŠæ”¯\næŒæ›´å¤šçš„Dockerå‘½ä»¤ä»¥åŠé›†ç¾¤é©±åŠ¨ã€‚Swarm deamonåªæ˜¯ä¸€ä¸ªè°ƒåº¦å™¨ï¼ˆSchedulerï¼‰åŠ  è·¯ç”±å™¨(router)ï¼ŒSwarmè‡ªå·±ä¸è¿è¡Œå®¹å™¨ï¼Œå®ƒåªæ˜¯æ¥å—dockerå®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚ï¼Œ è°ƒåº¦é€‚åˆçš„èŠ‚ç‚¹æ¥è¿è¡Œå®¹å™¨ï¼Œè¿™æ„å‘³ç€ï¼Œå³ä½¿Swarmç”±äºæŸäº›åŸå› æŒ‚æ‰äº†ï¼Œé›†ç¾¤ä¸­çš„èŠ‚ ç‚¹ä¹Ÿä¼šç…§å¸¸è¿è¡Œï¼Œå½“Swarmé‡æ–°æ¢å¤è¿è¡Œä¹‹åï¼Œå®ƒä¼šæ”¶é›†é‡å»ºé›†ç¾¤ä¿¡æ¯ã€‚Â docker swarmç‰¹ç‚¹ï¼š 1)Â å¯¹å¤–ä»¥Docker APIæ¥å£å‘ˆç°ï¼Œè¿™æ ·å¸¦æ¥çš„å¥½å¤„æ˜¯ï¼Œå¦‚æœç°æœ‰ç³»ç»Ÿä½¿ç”¨Docker Engineï¼Œ åˆ™å¯ä»¥å¹³æ»‘å°†Docker Engineåˆ‡åˆ°Swarmä¸Šï¼Œæ— éœ€æ”¹åŠ¨ç°æœ‰ç³»ç»Ÿã€‚ 2)Â Swarmå¯¹ç”¨æˆ·æ¥è¯´ï¼Œä¹‹å‰ä½¿ç”¨Dockerçš„ç»éªŒå¯ä»¥ç»§æ‰¿è¿‡æ¥ã€‚éå¸¸å®¹æ˜“ä¸Šæ‰‹ï¼Œå­¦ä¹ æˆæœ¬ å’ŒäºŒæ¬¡å¼€å‘æˆæœ¬éƒ½æ¯”è¾ƒä½ã€‚åŒæ—¶Swarmæœ¬èº«ä¸“æ³¨äºDockeré›†ç¾¤ç®¡ç†ï¼Œéå¸¸è½»é‡ï¼Œå ç”¨èµ„ æºä¹Ÿéå¸¸å°‘ã€‚ç®€å•è¯´ï¼Œå°±æ˜¯æ’ä»¶åŒ–æœºåˆ¶ï¼ŒSwarmä¸­çš„å„ä¸ªæ¨¡å—éƒ½æŠ½è±¡å‡ºäº†APIï¼Œå¯ä»¥æ ¹æ® è‡ªå·±ä¸€äº›ç‰¹ç‚¹è¿›è¡Œå®šåˆ¶å®ç°ã€‚Â 3)Â Swarmè‡ªèº«å¯¹Dockerå‘½ä»¤å‚æ•°æ”¯æŒçš„æ¯”è¾ƒå®Œå–„ï¼ŒSwarmç›®å‰ä¸Dockeræ˜¯åŒæ­¥å‘å¸ƒ çš„ã€‚Dockerçš„æ–°åŠŸèƒ½ï¼Œéƒ½ä¼šç¬¬ä¸€æ—¶é—´åœ¨Swarmä¸­ä½“ç°ã€‚Â **docker swarmæ¶æ„Â ** Swarmä½œä¸ºä¸€ä¸ªç®¡ç†Dockeré›†ç¾¤çš„å·¥å…·ï¼Œé¦–å…ˆéœ€è¦å°†å…¶éƒ¨ç½²èµ·æ¥ï¼Œå¯ä»¥å•ç‹¬å°†Swarméƒ¨ ç½²äºä¸€ä¸ªèŠ‚ç‚¹ã€‚å¦å¤–ï¼Œè‡ªç„¶éœ€è¦ä¸€ä¸ªDockeré›†ç¾¤ï¼Œé›†ç¾¤ä¸Šæ¯ä¸€ä¸ªèŠ‚ç‚¹å‡å®‰è£…æœ‰Dockerã€‚\nç›¸å…³æœ¯è¯­ï¼š Swarm Managerï¼šé›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œé€šè¿‡swarm managerç®¡ç†å¤šä¸ªèŠ‚ç‚¹ã€‚ Nodeï¼šæ˜¯å·²åŠ å…¥åˆ°swarmçš„Dockerå¼•æ“çš„å®ä¾‹ ã€‚ manager nodesï¼šä¹Ÿå°±æ˜¯ç®¡ç†èŠ‚ç‚¹ ï¼Œæ‰§è¡Œé›†ç¾¤çš„ç®¡ç†åŠŸèƒ½ï¼Œç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œ é€‰ä¸¾ä¸€ä¸ªleaderèŠ‚ç‚¹å»æ‰§ è¡Œè°ƒåº¦ä»»åŠ¡ worker nodesï¼Œä¹Ÿå°±æ˜¯å·¥ä½œèŠ‚ç‚¹ ï¼Œæ¥æ”¶å’Œæ‰§è¡Œä»»åŠ¡ã€‚å‚ä¸å®¹å™¨é›†ç¾¤è´Ÿè½½è°ƒåº¦ï¼Œ ä»…ç”¨äºæ‰¿è½½taskÂ ä¸€ä¸ªæœåŠ¡æ˜¯å·¥ä½œèŠ‚ç‚¹ä¸Šæ‰§è¡Œä»»åŠ¡çš„å®šä¹‰ã€‚åˆ›å»ºä¸€ä¸ªæœåŠ¡ï¼ŒæŒ‡å®šäº†å®¹å™¨æ‰€ä½¿ç”¨çš„é•œåƒå’Œ å®¹å™¨è¿è¡Œçš„å‘½ä»¤ã€‚serviceæ˜¯è¿è¡Œåœ¨worker nodesä¸Šçš„taskçš„æè¿°ï¼Œserviceçš„æè¿°åŒ… æ‹¬ä½¿ç”¨å“ªä¸ªdocker é•œåƒï¼Œä»¥åŠåœ¨ä½¿ç”¨è¯¥é•œåƒçš„å®¹å™¨ä¸­æ‰§è¡Œä»€ä¹ˆå‘½ä»¤ã€‚\ntaskä»»åŠ¡ï¼šä¸€ä¸ªä»»åŠ¡åŒ…å«äº†ä¸€ä¸ªå®¹å™¨åŠå…¶è¿è¡Œçš„å‘½ä»¤ã€‚taskæ˜¯serviceçš„æ‰§è¡Œå®ä½“ï¼Œ taskå¯åŠ¨dockerå®¹å™¨å¹¶åœ¨å®¹å™¨ä¸­æ‰§è¡Œä»»åŠ¡\ndocker swarmä½¿ç”¨Â æ­å»ºæ­¥éª¤ï¼š\n1ã€ç¯å¢ƒå‡†å¤‡ï¼š\n1.1ã€å‡†å¤‡ä¸‰å°å·²è¿‘å®‰è£…dockerÂ engineçš„centos/Ubuntuç³»ç»Ÿä¸»æœºï¼ˆdockerç‰ˆæœ¬å¿…é¡»åœ¨ 1.12ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œè€ç‰ˆæœ¬ä¸æ”¯æŒswarmï¼‰\n1.2ã€dockerå®¹å™¨ä¸»æœºçš„ipåœ°å€å›ºå®šï¼Œé›†ç¾¤ä¸­æ‰€æœ‰å·¥ä½œèŠ‚ç‚¹å¿…é¡»èƒ½è®¿é—®è¯¥ç®¡ç†èŠ‚ç‚¹\n1.3ã€é›†ç¾¤ç®¡ç†èŠ‚ç‚¹å¿…é¡»ä½¿ç”¨ç›¸åº”çš„åè®®å¹¶ä¸”ä¿è¯ç«¯å£å¯ç”¨ é›†ç¾¤ç®¡ç†é€šä¿¡ï¼š\nTCPï¼Œç«¯å£2377Â èŠ‚ç‚¹é€šä¿¡ï¼šTCPå’ŒUDPï¼Œç«¯å£7946Â è¦†ç›–å‹ç½‘ç»œ(dockerç½‘ç»œ)ï¼šUDPï¼Œç«¯å£4789Â overlayé©±åŠ¨Â è¯´æ˜ï¼šä¸‰å°å®¹å™¨ä¸»æœºçš„ipåœ°å€åˆ†åˆ«ä¸ºï¼š 192.168.200.162ï¼ˆç®¡ç†èŠ‚ç‚¹ï¼‰ 192.168.200.163ï¼ˆå·¥ä½œèŠ‚ç‚¹ï¼‰ 192.168.200.158ï¼ˆå·¥ä½œèŠ‚ç‚¹ï¼‰\nä¸»æœºåç§°åˆ†åˆ«ä¸ºï¼šmanager1ã€work1ä»¥åŠwork2\n1 vimÂ /etc/hostnameÂ (ä¿®æ”¹å®Œæˆåéœ€è¦é‡å¯) 2ã€åˆ›å»ºdocker swarmÂ 2.1ã€åœ¨manager1æœºå™¨ä¸Šåˆ›å»ºdocker swarmé›†ç¾¤Â 1 dockerÂ swarmÂ initÂ â€â€advertiseâ€addrÂ 192.168.200.162 ï¼ˆâ€â€advertiseâ€addrå°†è¯¥IPåœ°å€çš„æœºå™¨è®¾ç½®ä¸ºé›†ç¾¤ç®¡ç†èŠ‚ç‚¹ï¼›å¦‚æœæ˜¯å•èŠ‚ç‚¹ï¼Œæ— éœ€è¯¥å‚ æ•° 2.2ã€æŸ¥çœ‹ç®¡ç†èŠ‚ç‚¹é›†ç¾¤ä¿¡æ¯ï¼šÂ 1 dockerÂ nodeÂ ls 3ã€å‘docker swarmä¸­æ·»åŠ å·¥ä½œèŠ‚ç‚¹ï¼šåœ¨ä¸¤ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸­åˆ†åˆ«æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œipåœ°å€æ˜¯ managerèŠ‚ç‚¹çš„Â 3.1ã€æ·»åŠ ä¸¤ä¸ªworkèŠ‚ç‚¹Â 1 2 dockerÂ swarmÂ joinÂ â€â€tokenÂ xxxÂ 192.168.200.138:2377Â ï¼ˆworker1ï¼‰ dockerÂ swarmÂ joinÂ â€â€tokenÂ xxxÂ 192.168.200.138:2377Â ï¼ˆworker2ï¼‰ ï¼ˆâ€â€token xxx:å‘æŒ‡å®šé›†ç¾¤ä¸­åŠ å…¥å·¥ä½œèŠ‚ç‚¹çš„è®¤è¯ä¿¡æ¯ï¼Œxxxè®¤è¯ä¿¡æ¯æ˜¯åœ¨åˆ›å»ºdocker swarmæ—¶äº§ç”Ÿçš„ï¼‰Â 3.2ã€ç»§ç»­æŸ¥çœ‹ç®¡ç†èŠ‚ç‚¹é›†ç¾¤ä¿¡æ¯ä¸ä¹‹å‰çš„åŒºåˆ«Â 1 dockerÂ nodeÂ ls 4ã€åœ¨dockerÂ swarmä¸­éƒ¨ç½²æœåŠ¡ åœ¨DockerÂ Swarmé›†ç¾¤ä¸­éƒ¨ç½²æœåŠ¡æ—¶ï¼Œæ—¢å¯ä»¥ä½¿ç”¨DockerÂ Hubä¸Šè‡ªå¸¦çš„é•œåƒæ¥å¯åŠ¨æœåŠ¡ï¼Œä¹Ÿ\n5 docker composeç¼–æ’å·¥å…· 5.1 docker composeä»‹ç»Â å¯ä»¥ä½¿ç”¨è‡ªå·±é€šDockerfileæ„å»ºçš„é•œåƒæ¥å¯åŠ¨æœåŠ¡ã€‚å¦‚æœä½¿ç”¨è‡ªå·±é€šè¿‡Dockerfileæ„å»ºçš„ é•œåƒæ¥å¯åŠ¨æœåŠ¡é‚£ä¹ˆå¿…é¡»å…ˆå°†é•œåƒæ¨é€åˆ°DockerÂ Hubä¸­å¿ƒä»“åº“ã€‚ä¸ºäº†æ–¹ä¾¿è¯»è€…çš„å­¦ä¹ ï¼Œè¿™é‡Œ ä»¥ä½¿ç”¨DockerÂ Hubä¸Šè‡ªå¸¦çš„alpineé•œåƒä¸ºä¾‹æ¥éƒ¨ç½²é›†ç¾¤æœåŠ¡Â 4.1ã€éƒ¨ç½²æœåŠ¡Â 1 dockerÂ serviceÂ createÂ â€â€replicasÂ 1Â â€â€nameÂ helloworldÂ alpineÂ pingÂ docker.com docker service createæŒ‡ä»¤ï¼šç”¨äºåœ¨Swarmé›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªåŸºäºalpineé•œåƒçš„æœåŠ¡ â€â€replicaså‚æ•°ï¼šæŒ‡å®šäº†è¯¥æœåŠ¡åªæœ‰ä¸€ä¸ªå‰¯æœ¬å®ä¾‹ â€â€nameå‚æ•°ï¼šæŒ‡å®šåˆ›å»ºæˆåŠŸåçš„æœåŠ¡åç§°ä¸ºhelloworld ping docker.comæŒ‡ä»¤ï¼šè¡¨ç¤ºæœåŠ¡å¯åŠ¨åæ‰§è¡Œçš„å‘½ä»¤ 5.æŸ¥çœ‹docker swarmé›†ç¾¤ä¸­çš„æœåŠ¡Â 1 2 3 æŸ¥çœ‹æœåŠ¡åˆ—è¡¨ï¼šdockerÂ serviceÂ ls æŸ¥çœ‹éƒ¨ç½²å…·ä½“æœåŠ¡çš„è¯¦ç»†ä¿¡æ¯ï¼šdockerÂ serviceÂ inspectÂ æœåŠ¡åç§° æŸ¥çœ‹æœåŠ¡åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šçš„åˆ†é…ä»¥åŠè¿è¡Œæƒ…å†µï¼šdockerÂ serviceÂ psÂ æœåŠ¡åç§° 6ã€ä¿®æ”¹å‰¯æœ¬æ•°é‡ åœ¨manager1ä¸Šï¼Œæ›´æ”¹æœåŠ¡å‰¯æœ¬çš„æ•°é‡ï¼ˆåˆ›å»ºçš„å‰¯æœ¬ä¼šéšæœºåˆ†é…åˆ°ä¸åŒçš„èŠ‚ç‚¹ï¼‰Â 1 dockerÂ serviceÂ scaleÂ helloworld=5 7ã€åˆ é™¤æœåŠ¡ï¼ˆåœ¨ç®¡ç†èŠ‚ç‚¹ï¼‰ 1 dockerÂ serviceÂ rmÂ æœåŠ¡åç§° 8ã€è®¿é—®æœåŠ¡Â 8.1ã€æŸ¥çœ‹é›†ç¾¤ç¯å¢ƒä¸‹çš„ç½‘ç»œåˆ—è¡¨ï¼š\n1 docker network ls 8.2ã€åœ¨manager1ä¸Šåˆ›å»ºä¸€overlayä¸ºé©±åŠ¨çš„ç½‘ç»œï¼ˆé»˜è®¤ä½¿ç”¨çš„ç½‘ç»œè¿æ¥ingressï¼‰Â 1 dockerÂ networkÂ createÂ â€d=overlayÂ myâ€multiâ€hostâ€network 8.3ã€åœ¨é›†ç¾¤ç®¡ç†èŠ‚ç‚¹manager1ä¸Šéƒ¨ç½²ä¸€ä¸ªnginxæœåŠ¡Â 1 2 3 4 5 6 dockerÂ serviceÂ createÂ \\ â€â€networkÂ myâ€multiâ€hostâ€networkÂ \\ â€â€nameÂ myâ€webÂ \\ â€pÂ 8080:80Â \\ â€â€replicasÂ 2Â \\ nginx 8.3ã€åœ¨ç®¡ç†èŠ‚ç‚¹æŸ¥çœ‹æœåŠ¡çš„è¿è¡Œæƒ…å†µï¼šÂ 1 dockerÂ serviceÂ psÂ myâ€web ","date":"2020-01-17T15:20:40Z","image":"https://www.ownit.top/title_pic/29.jpg","permalink":"https://www.ownit.top/p/202001171520/","title":"Centosæ­å»ºdocker swarmé›†ç¾¤è¯¦ç»†æ•™ç¨‹"},{"content":"1ã€Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ 2ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“ 3ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…· 4ã€Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ® 5ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰çš„Grafana+onealertå®ç°æŠ¥è­¦åŠŸèƒ½ ç›®å½•\n1ã€Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ\n2ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“\n3ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…·\n4ã€Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ®\nGrafana+onealertæŠ¥è­¦\n1ã€ å…ˆåœ¨onealerté‡Œæ·»åŠ grafanaåº”ç”¨(ç”³è¯·onealertè´¦å·)\n2ã€åœ¨Grafanaä¸­é…ç½®Webhook URL\nç°åœ¨å¯ä»¥å»è®¾ç½®ä¸€ä¸ªæŠ¥è­¦æ¥æµ‹è¯•äº†(è¿™é‡Œä»¥æˆ‘ä»¬å‰é¢åŠ çš„cpuè´Ÿè½½ç›‘æ§æ¥ åšæµ‹è¯•)\næœ€ç»ˆçš„é‚®ä»¶æŠ¥è­¦æ•ˆæœï¼š\næµ‹è¯•mysqlé“¾æ¥æ•°æŠ¥è­¦\næ€»ç»“æŠ¥è­¦ä¸æˆåŠŸçš„å¯èƒ½åŸå› \næ‰©å±•\nGrafana+onealertæŠ¥è­¦ prometheusæŠ¥è­¦éœ€è¦ä½¿ç”¨alertmanagerè¿™ä¸ªç»„ä»¶ï¼Œè€Œä¸”æŠ¥è­¦è§„åˆ™éœ€è¦æ‰‹ åŠ¨ç¼–å†™(å¯¹è¿ç»´æ¥è¯´ä¸å‹å¥½)ã€‚æ‰€ä»¥æˆ‘è¿™é‡Œé€‰ç”¨grafana+onealertæŠ¥è­¦ã€‚\næ³¨æ„: å®ç°æŠ¥è­¦å‰æŠŠæ‰€æœ‰æœºå™¨æ—¶é—´åŒæ­¥å†æ£€æŸ¥ä¸€é.\n1 ntpdate time.windows.com 1ã€ å…ˆåœ¨onealerté‡Œæ·»åŠ grafanaåº”ç”¨(ç”³è¯·onealertè´¦å·) https://caweb.aiops.com/\n2ã€åœ¨Grafanaä¸­é…ç½®Webhook URL 1ã€åœ¨Grafanaä¸­åˆ›å»ºNotification channelï¼Œé€‰æ‹©ç±»å‹ä¸ºWebhookï¼›\n2ã€æ¨èé€‰ä¸­Send on all alertså’ŒInclude imageï¼ŒCloud Alertä½“éªŒæ›´ä½³ï¼›\n3ã€å°†ç¬¬ä¸€æ­¥ä¸­ç”Ÿæˆçš„Webhook URLå¡«å…¥Webhook settings Urlï¼›\n4ã€Http Methodé€‰æ‹©POSTï¼›\n5ã€Send Test\u0026amp;Saveï¼›\nç°åœ¨å¯ä»¥å»è®¾ç½®ä¸€ä¸ªæŠ¥è­¦æ¥æµ‹è¯•äº†(è¿™é‡Œä»¥æˆ‘ä»¬å‰é¢åŠ çš„cpuè´Ÿè½½ç›‘æ§æ¥ åšæµ‹è¯•) é…ç½®\nä¿å­˜åå°±å¯ä»¥æµ‹è¯•äº†\nå¦‚æœnode1ä¸Šçš„cpuè´Ÿè½½è¿˜æ²¡æœ‰åˆ°0.5ï¼Œä½ å¯ä»¥è¯•è¯•0.1,æˆ–è€…è¿è¡Œä¸€äº›ç¨‹åº æŠŠnode1è´Ÿè½½è°ƒå¤§ã€‚æœ€ç»ˆèƒ½æµ‹è¯•æŠ¥è­¦æˆåŠŸ\næ¨¡æ‹Ÿcpuè´Ÿè½½\n1 cat /dev/urandom | md5sum æœ€ç»ˆçš„é‚®ä»¶æŠ¥è­¦æ•ˆæœï¼š æµ‹è¯•mysqlé“¾æ¥æ•°æŠ¥è­¦ æ€»ç»“æŠ¥è­¦ä¸æˆåŠŸçš„å¯èƒ½åŸå›  å„æœåŠ¡å™¨ä¹‹é—´æ—¶é—´ä¸åŒæ­¥ï¼Œè¿™æ ·æ—¶åºæ•°æ®ä¼šå‡ºé—®é¢˜ï¼Œä¹Ÿä¼šé€ æˆæŠ¥è­¦å‡ºé—® é¢˜ å¿…é¡»å†™é€šçŸ¥å†…å®¹ï¼Œç•™ç©ºå†…å®¹æ˜¯ä¸ä¼šå‘æŠ¥è­¦çš„ ä¿®æ”¹å®ŒæŠ¥è­¦é…ç½®åï¼Œè®°å¾—è¦ç‚¹å³ä¸Šè§’çš„ä¿å­˜ ä¿å­˜é…ç½®åï¼Œéœ€è¦ç”±OKçŠ¶æ€å˜ä¸ºalertingçŠ¶æ€æ‰ä¼šæŠ¥è­¦(ä¹Ÿå°±æ˜¯è¯´ï¼Œä½  é…ç½®ä¿å­˜åï¼Œå°±å·²ç»æ˜¯alertingçŠ¶æ€æ˜¯ä¸ä¼šæŠ¥è­¦çš„) grafanaä¸onealerté€šä¿¡æœ‰é—®é¢˜ æ‰©å±• prometheusç›®å‰è¿˜åœ¨å‘å±•ä¸­ï¼Œå¾ˆå¤šç›¸åº”çš„ç›‘æ§éƒ½éœ€è¦å¼€å‘ã€‚ä½†åœ¨å®˜ç½‘çš„ dashboardåº“ä¸­,ä¹Ÿæœ‰ä¸€äº›å®˜æ–¹å’Œç¤¾åŒºå¼€å‘äººå‘˜å¼€å‘çš„dashboardå¯ä»¥ç›´æ¥ æ‹¿æ¥ç”¨ã€‚\nç›¸å…³åšæ–‡ 1ã€Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ 2ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“ 3ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…· 4ã€Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ® 5ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰çš„Grafana+onealertå®ç°æŠ¥è­¦åŠŸèƒ½","date":"2020-01-13T16:52:18Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/202001131652/","title":"Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰çš„Grafana+onealertå®ç°æŠ¥è­¦åŠŸèƒ½"},{"content":"ç›¸å…³åšæ–‡ï¼š 1ã€Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ 2ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“ 3ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…· 4ã€Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ® 5ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰çš„Grafana+onealertå®ç°æŠ¥è­¦åŠŸèƒ½ ç›®å½•\nGrafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ®\nâ‘  åœ¨grafanaä¸Šä¿®æ”¹é…ç½®æ–‡ä»¶,å¹¶ä¸‹è½½å®‰è£…mysqlç›‘æ§çš„dashboardï¼ˆåŒ…å« ç›¸å…³jsonæ–‡ä»¶ï¼Œè¿™äº›jsonæ–‡ä»¶å¯ä»¥çœ‹ä½œæ˜¯å¼€å‘äººå‘˜å¼€å‘çš„ä¸€ä¸ªç›‘æ§æ¨¡æ¿)\nâ‘¡ åœ¨grafanaå›¾å½¢ç•Œé¢å¯¼å…¥ç›¸å…³jsonæ–‡ä»¶\nGrafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ® â‘  åœ¨grafanaä¸Šä¿®æ”¹é…ç½®æ–‡ä»¶,å¹¶ä¸‹è½½å®‰è£…mysqlç›‘æ§çš„dashboardï¼ˆåŒ…å« ç›¸å…³jsonæ–‡ä»¶ï¼Œè¿™äº›jsonæ–‡ä»¶å¯ä»¥çœ‹ä½œæ˜¯å¼€å‘äººå‘˜å¼€å‘çš„ä¸€ä¸ªç›‘æ§æ¨¡æ¿) å‚è€ƒç½‘å€: https://github.com/percona/grafana-dashboards\nåœ¨grafanaé…ç½®æ–‡ä»¶é‡Œæœ€ååŠ ä¸Šä»¥ä¸‹ä¸‰è¡Œ\n1 2 3 4 vim /etc/grafana/grafana.ini [dashboards.json] enabled = true path = /var/lib/grafana/dashboards ä¸‹è½½é…ç½®æ¨¡æ¿\n1 cd /var/lib/grafana/ 1 git clone https://github.com/percona/grafana-dashboards.git 1 cp -r /var/lib/grafana/grafana-dashboards-master/dashboards/ /var/lib/grafana/ é‡å¯grafanaæœåŠ¡\n1 systemctl restart grafana-server â‘¡ åœ¨grafanaå›¾å½¢ç•Œé¢å¯¼å…¥ç›¸å…³jsonæ–‡ä»¶ â‘¢ ç‚¹importå¯¼å…¥å,æŠ¥prometheusæ•°æ®æºæ‰¾ä¸åˆ°,å› ä¸ºè¿™äº›jsonæ–‡ä»¶é‡Œé»˜è®¤ è¦æ‰¾çš„å°±æ˜¯å«Prometheusçš„æ•°æ®æºï¼Œä½†æˆ‘ä»¬å‰é¢å»ºç«‹çš„æ•°æ®æºå´æ˜¯å« prometheus_data(å‘å•Š)\né‚£ä¹ˆè¯·è‡ªè¡ŒæŠŠåŸæ¥çš„prometheus_dataæºæ”¹åä¸ºPrometheuså³å¯(æ³¨æ„: ç¬¬ä¸€ä¸ªå­—æ¯Pæ˜¯å¤§å†™)\nç„¶åå†å›å»åˆ·æ–°,å°±æœ‰æ•°æ®äº†(å¦‚ä¸‹å›¾æ‰€ç¤º)\nç›¸å…³åšæ–‡ï¼š 1ã€Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ 2ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“ 3ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…· 4ã€Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ® 5ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰çš„Grafana+onealertå®ç°æŠ¥è­¦åŠŸèƒ½","date":"2020-01-13T15:42:22Z","image":"https://www.ownit.top/title_pic/12.jpg","permalink":"https://www.ownit.top/p/202001131542/","title":"Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ®"},{"content":"ç›¸å…³åšæ–‡ï¼š 1ã€Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ 2ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“ 3ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…· 4ã€Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ® 5ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰çš„Grafana+onealertå®ç°æŠ¥è­¦åŠŸèƒ½ æ•™ç¨‹ä½¿ç”¨çš„è½¯ä»¶ï¼šé“¾æ¥: https://pan.baidu.com/s/1QV4KYZksyIp65UsScioq4Q æå–ç : vcej\nç¯å¢ƒé…ç½®\næœåŠ¡å™¨IPåœ°å€PrometneusæœåŠ¡å™¨192.168.116.129è¢«ç›‘æ§æœåŠ¡å™¨ï¼ˆmysqlï¼‰192.168.116.130grafanaæœåŠ¡å™¨192.168.116.131 1ã€ä»€ä¹ˆæ˜¯Grafana Grafanaæ˜¯ä¸€ä¸ªå¼€æºçš„åº¦é‡åˆ†æå’Œå¯è§†åŒ–å·¥å…·ï¼Œå¯ä»¥é€šè¿‡å°†é‡‡é›†çš„æ•°æ®åˆ† æï¼ŒæŸ¥è¯¢ï¼Œç„¶åè¿›è¡Œå¯è§†åŒ–çš„å±•ç¤º,å¹¶èƒ½å®ç°æŠ¥è­¦ã€‚\nç½‘å€: https://grafana.com/\n2ã€ä½¿ç”¨Grafanaè¿æ¥Prometheus â‘  åœ¨grafanaæœåŠ¡å™¨ä¸Šå®‰è£…grafana ä¸‹è½½åœ°å€:https://grafana.com/grafana/download\nä¸Šä¼ grafana-5.3.4-1.x86_64.rpm\næˆ‘è¿™é‡Œé€‰æ‹©çš„rpmåŒ…ï¼Œä¸‹è½½åç›´æ¥rpm -ivhå®‰è£…å°±OKã€å¤±è´¥åŸå› ç¼ºå°‘ç»„ä»¶ï¼Œå¯ä»¥yumå®‰è£…ç»„ä»¶ã€‘\n1 rpm -ivh /root/Desktop/grafana-5.3.41.x86_64.rpm æˆ–è€…ç¬¬äºŒç§æ–¹æ³•ã€yumå®‰è£…ä¼šè‡ªåŠ¨å®‰è£…ç¼ºå°‘çš„ç»„ä»¶çš„ã€‘\n1 yum install -y grafana-5.3.4-1.x86_64.rpm å¯åŠ¨æœåŠ¡\n1 2 systemctl start grafana-server systemctl enable grafana-server ç¡®è®¤ç«¯å£(3000)\n1 lsof -i:3000 â‘¡ é€šè¿‡æµè§ˆå™¨è®¿é—® http:// grafanaæœåŠ¡å™¨IP:3000å°±åˆ°äº†ç™»å½•ç•Œé¢,ä½¿ç”¨é»˜ è®¤çš„adminç”¨æˆ·,adminå¯†ç å°±å¯ä»¥ç™»é™†äº† â‘¢ ä¸‹é¢æˆ‘ä»¬æŠŠprometheusæœåŠ¡å™¨æ”¶é›†çš„æ•°æ®åšä¸ºä¸€ä¸ªæ•°æ®æºæ·»åŠ åˆ° grafana,è®©grafanaå¯ä»¥å¾—åˆ°prometheusçš„æ•°æ®ã€‚ â‘£ ç„¶åä¸ºæ·»åŠ å¥½çš„æ•°æ®æºåšå›¾å½¢æ˜¾ç¤º â‘¤ ä¿å­˜ â‘¥ æœ€ååœ¨dashboardå¯ä»¥æŸ¥çœ‹åˆ° â‘¦ åŒ¹é…æ¡ä»¶æ˜¾ç¤º\nç›¸å…³åšæ–‡ï¼š 1ã€Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ 2ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“ 3ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…· 4ã€Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ® 5ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰çš„Grafana+onealertå®ç°æŠ¥è­¦åŠŸèƒ½","date":"2020-01-13T14:27:19Z","image":"https://www.ownit.top/title_pic/54.jpg","permalink":"https://www.ownit.top/p/202001131427/","title":"Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…·"},{"content":"ç›¸å…³åšæ–‡ï¼š 1ã€Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ 2ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“ 3ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…· 4ã€Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ® 5ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰çš„Grafana+onealertå®ç°æŠ¥è­¦åŠŸèƒ½ Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“\nè¿™ä¸ªæ˜¯åŸºäºä¸Šé¢ç¯å¢ƒæ­å»ºçš„ï¼Œéœ€è¦çš„å¯ä»¥è®¿é—®æ–¹é¢è¿æ¥æŸ¥çœ‹ã€‚\næ•™ç¨‹ä½¿ç”¨çš„è½¯ä»¶ï¼šé“¾æ¥: https://pan.baidu.com/s/1QV4KYZksyIp65UsScioq4Q æå–ç : vcej\nç›‘æ§è¿œç¨‹MySQL\næœåŠ¡å™¨IPåœ°å€PrometneusæœåŠ¡å™¨192.168.116.129è¢«ç›‘æ§æœåŠ¡å™¨ï¼ˆmysqlï¼‰192.168.116.130grafanaæœåŠ¡å™¨192.168.116.131 â‘  åœ¨è¢«ç®¡ç†æœºagent1ä¸Šå®‰è£…mysqld_exporterç»„ä»¶\nä¸‹è½½åœ°å€: https://prometheus.io/download/\nä¸Šä¼ mysqld_exporterç»„ä»¶\nå®‰è£…mysqld_exporterç»„ä»¶\n1 2 3 tar xf mysqld_exporter-0.11.0.linux-amd64.tar.gz -C /usr/local/ mv /usr/local/mysqld_exporter-0.11.0.linux-amd64/ /usr/local/mysqld_exporter ls /usr/local/mysqld_exporter å®‰è£…mariadbæ•°æ®åº“,å¹¶æˆæƒ\n1 2 3 4 yum install mariadb\\* -y systemctl restart mariadb systemctl enable mariadb mysql 1 MariaDB [(none)]\u0026gt; grant select,replication client,process ON *.* to \u0026#39;mysql_monitor\u0026#39;@\u0026#39;localhost\u0026#39; identified by \u0026#39;123\u0026#39;; (æ³¨æ„:æˆæƒipä¸ºlocalhostï¼Œå› ä¸ºä¸æ˜¯prometheusæœåŠ¡å™¨æ¥ç›´æ¥æ‰¾mariadb è·å–æ•°æ®ï¼Œè€Œæ˜¯prometheusæœåŠ¡å™¨æ‰¾mysql_exporter,mysql_exporter å†æ‰¾mariadbã€‚æ‰€ä»¥è¿™ä¸ªlocalhostæ˜¯æŒ‡çš„mysql_exporterçš„IP)\n1 2 MariaDB [(none)]\u0026gt; flush privileges; MariaDB [(none)]\u0026gt; quit åˆ›å»ºä¸€ä¸ªmariadbé…ç½®æ–‡ä»¶ï¼Œå†™ä¸Šè¿æ¥çš„ç”¨æˆ·åä¸å¯†ç (å’Œä¸Šé¢çš„æˆæƒçš„ç”¨æˆ·å å’Œå¯†ç è¦å¯¹åº”)\n1 vim /usr/local/mysqld_exporter/.my.cnf 1 2 3 [client] user=mysql_monitor password=123 å¯åŠ¨mysqld_exporter\n1 nohup /usr/local/mysqld_exporter/mysqld_exporter --config.my-cnf=/usr/local/mysqld_exporter/.my.cnf \u0026amp; ç¡®è®¤ç«¯å£(9104)\nâ‘¡ å›åˆ°prometheusæœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶é‡Œæ·»åŠ è¢«ç›‘æ§çš„mariadbçš„é…ç½®æ®µ\nåœ¨ä¸»é…ç½®æ–‡ä»¶æœ€åå†åŠ ä¸Šä¸‹é¢ä¸‰è¡Œ\n1 vim /usr/local/prometheus/prometheus.yml 1 2 3 - job_name: \u0026#39;mariadb\u0026#39; static_configs: - targets: [\u0026#39;192.168.116.130:9104\u0026#39;] 1 2 3 4 - job_name: \u0026#39;agent1_mariadb\u0026#39; # å–ä¸€ä¸ªjob åç§°æ¥ä»£è¡¨è¢«ç›‘æ§çš„mariadb static_configs: - targets: [\u0026#39;10.1.1.14:9104\u0026#39;] # è¿™é‡Œæ”¹æˆ è¢«ç›‘æ§æœºå™¨çš„IPï¼Œåé¢ç«¯å£æ¥9104 æ”¹å®Œé…ç½®æ–‡ä»¶å,é‡å¯æœåŠ¡\n1 pkill prometheus 1 /usr/local/prometheus/prometheus --config.file=\u0026#34;/usr/local/prometheus/prometheus.yml\u0026#34; \u0026amp; â‘¢ å›åˆ°webç®¡ç†ç•Œé¢ --ã€‹ç‚¹Status --ã€‹ç‚¹Targets --ã€‹å¯ä»¥çœ‹åˆ°ç›‘æ§ mariadbäº†\nç›¸å…³åšæ–‡ï¼š 1ã€Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ 2ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“ 3ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…· 4ã€Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ® 5ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰çš„Grafana+onealertå®ç°æŠ¥è­¦åŠŸèƒ½","date":"2020-01-13T13:59:14Z","image":"https://www.ownit.top/title_pic/22.jpg","permalink":"https://www.ownit.top/p/202001131359/","title":"Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“"},{"content":"ç›¸å…³åšæ–‡ï¼š 1ã€Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ 2ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“ 3ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…· 4ã€Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ® 5ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰çš„Grafana+onealertå®ç°æŠ¥è­¦åŠŸèƒ½ ç›®å½•\nä¸€ã€æ™®ç½—ç±³ä¿®æ–¯æ¦‚è¿°\näºŒã€æ—¶é—´åºåˆ—æ•°æ®\n1ã€ä»€ä¹ˆæ˜¯åºåˆ—æ•°æ®\n2ã€æ—¶é—´åºåˆ—æ•°æ®ç‰¹ç‚¹\n3ã€Prometheusçš„ä¸»è¦ç‰¹å¾\n4ã€æ™®ç½—ç±³ä¿®æ–¯åŸç†æ¶æ„å›¾\nä¸‰ã€å®éªŒç¯å¢ƒå‡†å¤‡\n1ã€å®‰è£…prometheus\n2ã€prometheusç•Œé¢\n3ã€ä¸»æœºæ•°æ®å±•ç¤º\n4ã€ç›‘æ§è¿œç¨‹Linuxä¸»æœº\nä¸€ã€æ™®ç½—ç±³ä¿®æ–¯æ¦‚è¿° Prometheus(ç”±goè¯­è¨€(golang)å¼€å‘)æ˜¯ä¸€å¥—å¼€æºçš„ç›‘æ§\u0026amp;æŠ¥è­¦\u0026amp;æ—¶é—´åºåˆ—æ•° æ®åº“çš„ç»„åˆã€‚é€‚åˆç›‘æ§dockerå®¹å™¨ã€‚å› ä¸ºkubernetes(ä¿—ç§°k8s)çš„æµè¡Œå¸¦åŠ¨ äº†prometheusçš„å‘å±•ã€‚\nhttps://prometheus.io/docs/introduction/overview/\näºŒã€æ—¶é—´åºåˆ—æ•°æ® 1ã€ä»€ä¹ˆæ˜¯åºåˆ—æ•°æ® æ—¶é—´åºåˆ—æ•°æ®(TimeSeries Data) : æŒ‰ç…§æ—¶é—´é¡ºåºè®°å½•ç³»ç»Ÿã€è®¾å¤‡çŠ¶æ€å˜åŒ– çš„æ•°æ®è¢«ç§°ä¸ºæ—¶åºæ•°æ®ã€‚\nåº”ç”¨çš„åœºæ™¯å¾ˆå¤š, å¦‚ï¼š\næ— äººé©¾é©¶è½¦è¾†è¿è¡Œä¸­è¦è®°å½•çš„ç»åº¦ï¼Œçº¬åº¦ï¼Œé€Ÿåº¦ï¼Œæ–¹å‘ï¼Œæ—è¾¹ç‰©ä½“çš„è· ç¦»ç­‰ç­‰ã€‚æ¯æ—¶æ¯åˆ»éƒ½è¦å°†æ•°æ®è®°å½•ä¸‹æ¥åšåˆ†æã€‚ æŸä¸€ä¸ªåœ°åŒºçš„å„è½¦è¾†çš„è¡Œé©¶è½¨è¿¹æ•°æ® ä¼ ç»Ÿè¯åˆ¸è¡Œä¸šå®æ—¶äº¤æ˜“æ•°æ® å®æ—¶è¿ç»´ç›‘æ§æ•°æ®ç­‰ 2ã€æ—¶é—´åºåˆ—æ•°æ®ç‰¹ç‚¹ æ€§èƒ½å¥½ å…³ç³»å‹æ•°æ®åº“å¯¹äºå¤§è§„æ¨¡æ•°æ®çš„å¤„ç†æ€§èƒ½ç³Ÿç³•ã€‚NOSQLå¯ä»¥æ¯”è¾ƒå¥½çš„å¤„ç† å¤§è§„æ¨¡æ•°æ®ï¼Œè®©ä¾ç„¶æ¯”ä¸ä¸Šæ—¶é—´åºåˆ—æ•°æ®åº“ã€‚\nå­˜å‚¨æˆæœ¬ä½ é«˜æ•ˆçš„å‹ç¼©ç®—æ³•ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œæœ‰æ•ˆé™ä½IO\nPrometheusæœ‰ç€éå¸¸é«˜æ•ˆçš„æ—¶é—´åºåˆ—æ•°æ®å­˜å‚¨æ–¹æ³•ï¼Œæ¯ä¸ªé‡‡æ ·æ•°æ®ä»…ä»…å  ç”¨3.5byteå·¦å³ç©ºé—´ï¼Œä¸Šç™¾ä¸‡æ¡æ—¶é—´åºåˆ—ï¼Œ30ç§’é—´éš”ï¼Œä¿ç•™60å¤©ï¼Œå¤§æ¦‚èŠ±äº† 200å¤šGï¼ˆæ¥è‡ªå®˜æ–¹æ•°æ®)\n3ã€Prometheusçš„ä¸»è¦ç‰¹å¾ å¤šç»´åº¦æ•°æ®æ¨¡å‹ çµæ´»çš„æŸ¥è¯¢è¯­è¨€ ä¸ä¾èµ–åˆ†å¸ƒå¼å­˜å‚¨ï¼Œå•ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹æ˜¯è‡ªä¸»çš„ ä»¥HTTPæ–¹å¼ï¼Œé€šè¿‡pullæ¨¡å‹æ‹‰å»æ—¶é—´åºåˆ—æ•°æ®Â ä¹Ÿå¯ä»¥é€šè¿‡ä¸­é—´ç½‘å…³æ”¯æŒpushæ¨¡å‹ é€šè¿‡æœåŠ¡å‘ç°æˆ–è€…é™æ€é…ç½®ï¼Œæ¥å‘ç°ç›®æ ‡æœåŠ¡å¯¹è±¡ æ”¯æŒå¤šç§å¤šæ ·çš„å›¾è¡¨å’Œç•Œé¢å±•ç¤º\n4ã€æ™®ç½—ç±³ä¿®æ–¯åŸç†æ¶æ„å›¾ ä¸‰ã€å®éªŒç¯å¢ƒå‡†å¤‡ æœåŠ¡å™¨IPåœ°å€PrometneusæœåŠ¡å™¨192.168.116.129è¢«ç›‘æ§æœåŠ¡å™¨192.168.116.130grafanaæœåŠ¡å™¨192.168.116.131 æ•™ç¨‹ä½¿ç”¨çš„è½¯ä»¶ï¼šé“¾æ¥: https://pan.baidu.com/s/1QV4KYZksyIp65UsScioq4Q æå–ç : vcej\nå¤±æ•ˆå¯è”ç³»æˆ‘\n1. é™æ€ip(è¦æ±‚èƒ½ä¸Šå¤–ç½‘)\n2. ä¸»æœºå\n1 2 3 4 5 6 7 å„è‡ªé…ç½®å¥½ä¸»æœºå # hostnamectl set-hostname --static server.cluster.com ä¸‰å°éƒ½äº’ç›¸ç»‘å®šIPä¸ä¸»æœºå # vim /etc/hosts 192.168.116.129 master 192.168.116.130 node1 192.168.116.131 node2 1 2 3 echo \u0026#34;192.168.116.129 master 192.168.116.130 node1 192.168.116.131 node2\u0026#34;\u0026gt;\u0026gt;/etc/hosts 3. æ—¶é—´åŒæ­¥(æ—¶é—´åŒæ­¥ä¸€å®šè¦ç¡®è®¤ä¸€ä¸‹)\n1 yum install -y ntpdate \u0026amp;\u0026amp; ntpdate time.windows.com 4. å…³é—­é˜²ç«å¢™,selinux\n1 2 3 # systemctl stop firewalld # systemctl disable firewalld # iptables -F 1ã€å®‰è£…prometheus ä» https://prometheus.io/download/ ä¸‹è½½ç›¸åº”ç‰ˆæœ¬ï¼Œå®‰è£…åˆ°æœåŠ¡å™¨ä¸Š\nå®˜ç½‘æä¾›çš„æ˜¯äºŒè¿›åˆ¶ç‰ˆï¼Œè§£å‹å°±èƒ½ç”¨ï¼Œä¸éœ€è¦ç¼–è¯‘\nä¸Šä¼ prometheus-2.5.0.linux-amd64.tar.gz\n1 2 tar -zxvf prometheus-2.5.0.linux-amd64.tar.gz -C /usr/local/ mv /usr/local/prometheus-2.5.0.linux-amd64/ /usr/local/prometheus ç›´æ¥ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶å¯åŠ¨\n1 /usr/local/prometheus/prometheus --config.file=\u0026#34;/usr/local/prometheus/prometheus.yml\u0026#34; \u0026amp; ç¡®è®¤ç«¯å£(9090)\n1 ss -anltp | grep 9090 2ã€prometheusç•Œé¢ é€šè¿‡æµè§ˆå™¨è®¿é—®http://æœåŠ¡å™¨IP:9090å°±å¯ä»¥è®¿é—®åˆ°prometheusçš„ä¸»ç•Œé¢\né»˜è®¤åªç›‘æ§äº†æœ¬æœºä¸€å°ï¼Œç‚¹Status --ã€‹ç‚¹Targets --ã€‹å¯ä»¥çœ‹åˆ°åªç›‘æ§äº†æœ¬ æœº\n3ã€ä¸»æœºæ•°æ®å±•ç¤º é€šè¿‡http://æœåŠ¡å™¨IP:9090/metricså¯ä»¥æŸ¥çœ‹åˆ°ç›‘æ§çš„æ•°æ®\nåœ¨webä¸»ç•Œé¢å¯ä»¥é€šè¿‡å…³é”®å­—æŸ¥è¯¢ç›‘æ§é¡¹\n4ã€ç›‘æ§è¿œç¨‹Linuxä¸»æœº â‘  åœ¨è¿œç¨‹linuxä¸»æœº(è¢«ç›‘æ§ç«¯agent1)ä¸Šå®‰è£…node_exporterç»„ä»¶\nä¸‹è½½åœ°å€: https://prometheus.io/download/\nä¸Šä¼ node_exporter-0.16.0.linux-amd64.tar.gz\n1 2 tar -zxvf node_exporter-0.16.0.linux-amd64.tar.gz -C /usr/local/ mv /usr/local/node_exporter-0.16.0.linux-amd64/ /usr/local/node_exporter é‡Œé¢å°±ä¸€ä¸ªå¯åŠ¨å‘½ä»¤node_exporter,å¯ä»¥ç›´æ¥ä½¿ç”¨æ­¤å‘½ä»¤å¯åŠ¨\n1 nohup /usr/local/node_exporter/node_exporter \u0026amp; ç¡®è®¤ç«¯å£(9100)\næ‰©å±•: nohupå‘½ä»¤: å¦‚æœæŠŠå¯åŠ¨node_exporterçš„ç»ˆç«¯ç»™å…³é—­,é‚£ä¹ˆè¿›ç¨‹ä¹Ÿä¼š éšä¹‹å…³é—­ã€‚nohupå‘½ä»¤ä¼šå¸®ä½ è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nâ‘¡ é€šè¿‡æµè§ˆå™¨è®¿é—®http://è¢«ç›‘æ§ç«¯IP:9100/metricså°±å¯ä»¥æŸ¥çœ‹åˆ° node_exporteråœ¨è¢«ç›‘æ§ç«¯æ”¶é›†çš„ç›‘æ§ä¿¡æ¯\nâ‘¢ å›åˆ°prometheusæœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶é‡Œæ·»åŠ è¢«ç›‘æ§æœºå™¨çš„é…ç½®æ®µ\nåœ¨ä¸»é…ç½®æ–‡ä»¶æœ€ååŠ ä¸Šä¸‹é¢ä¸‰è¡Œ\n1 vim /usr/local/prometheus/prometheus.yml 1 2 3 - job_name: \u0026#39;node1\u0026#39; static_configs: - targets: [\u0026#39;192.168.116.130:9100\u0026#39;] 1 2 3 - job_name: \u0026#39;agent1\u0026#39; # å–ä¸€ä¸ªjobåç§°æ¥ä»£ è¡¨è¢«ç›‘æ§çš„æœºå™¨ static_configs: - targets: [\u0026#39;10.1.1.14:9100\u0026#39;] # è¿™é‡Œæ”¹æˆè¢«ç›‘æ§æœºå™¨ çš„IPï¼Œåé¢ç«¯å£æ¥9100 æ”¹å®Œé…ç½®æ–‡ä»¶å,é‡å¯æœåŠ¡\n1 pkill prometheus ç¡®è®¤ç«¯å£æ²¡æœ‰è¿›ç¨‹å ç”¨\n1 /usr/local/prometheus/prometheus --config.file=\u0026#34;/usr/local/prometheus/prometheus.yml\u0026#34; \u0026amp; ç¡®è®¤ç«¯å£è¢«å ç”¨ï¼Œè¯´ æ˜é‡å¯æˆåŠŸ\nâ‘£ å›åˆ°webç®¡ç†ç•Œé¢ --ã€‹ç‚¹Status --ã€‹ç‚¹Targets --ã€‹å¯ä»¥çœ‹åˆ°å¤šäº†ä¸€å°ç›‘ æ§ç›®æ ‡\nç»ƒä¹ : åŠ ä¸Šæœ¬æœºprometheusçš„ç›‘æ§\nç­”: åœ¨æœ¬æœºå®‰è£…node_exporterï¼Œä¹Ÿä½¿ç”¨ä¸Šé¢çš„æ–¹å¼ç›‘æ§èµ·æ¥ã€‚\nç›¸å…³åšæ–‡ï¼š 1ã€Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ 2ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§Mysqlæ•°æ®åº“ 3ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰å®‰è£…Grafanaå¯è§†åŒ–å›¾å½¢å·¥å…· 4ã€Promethusçš„Grafanaå›¾å½¢æ˜¾ç¤ºMySQLç›‘æ§æ•°æ® 5ã€Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰çš„Grafana+onealertå®ç°æŠ¥è­¦åŠŸèƒ½","date":"2020-01-13T10:40:01Z","image":"https://www.ownit.top/title_pic/34.jpg","permalink":"https://www.ownit.top/p/202001131040/","title":"Centos7å®‰è£…Promethus(æ™®ç½—ç±³ä¿®æ–¯ï¼‰ç›‘æ§ç³»ç»Ÿå®Œæ•´ç‰ˆ"},{"content":"å’ŒMavançš„ç®¡ç†ä¸€æ ·ï¼ŒDockersä¸ä»…æä¾›äº†ä¸€ä¸ªä¸­å¤®ä»“åº“ï¼ŒåŒæ—¶ä¹Ÿå…è®¸æˆ‘ä»¬ä½¿ç”¨registryæ­å»ºæœ¬åœ°ç§æœ‰ä»“åº“ã€‚ä½¿ç”¨ç§æœ‰ä»“åº“æœ‰è®¸å¤šä¼˜ç‚¹ï¼š\nä¸€ã€èŠ‚çœç½‘ç»œå¸¦å®½ï¼Œé’ˆå¯¹äºæ¯ä¸ªé•œåƒä¸ç”¨æ¯ä¸ªäººéƒ½å»ä¸­å¤®ä»“åº“ä¸Šé¢å»ä¸‹è½½ï¼Œåªéœ€è¦ä»ç§æœ‰ä»“åº“ä¸­ä¸‹è½½å³å¯ï¼›\näºŒã€æä¾›é•œåƒèµ„æºåˆ©ç”¨ï¼Œé’ˆå¯¹äºå…¬å¸å†…éƒ¨ä½¿ç”¨çš„é•œåƒï¼Œæ¨é€åˆ°æœ¬åœ°çš„ç§æœ‰ä»“åº“ä¸­ï¼Œä»¥ä¾›å…¬å¸å†…éƒ¨ç›¸å…³äººå‘˜ä½¿ç”¨ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬å°±å¤§è‡´è¯´ä¸€ä¸‹å¦‚ä½•åœ¨æœ¬åœ°æ­å»ºç§æœ‰ä»“åº“ã€‚\n1.æ‹‰å–é•œåƒä»“åº“ 1 docker pull registry 2.æŸ¥çœ‹æ‰€æœ‰é•œåƒ 1 docker images 3.å¯åŠ¨é•œåƒæœåŠ¡å™¨registry é¦–å…ˆåœ¨åœ¨ä¸»æœºä¸Šæ–°å»ºä¸€ä¸ªç›®å½•ï¼Œä¾›å­˜å‚¨é•œåƒ\n1 2 cd /usr/local/ mkdir docker_registry å¯åŠ¨é•œåƒ\n1 docker run -d -p 5000:5000 --name=jackspeedregistry --restart=always --privileged=true -v /usr/local/docker_registry:/var/lib/registry docker.io/registry è§£é‡Šï¼š\n-p 5000:5000â€ƒç«¯å£\n--name=jackspeedregistryâ€ƒè¿è¡Œçš„å®¹å™¨åç§°\n--restart=alwaysâ€ƒè‡ªåŠ¨é‡å¯\n--privileged=trueâ€ƒcentos7ä¸­çš„å®‰å…¨æ¨¡å—selinuxæŠŠæƒé™ç¦æ­¢äº†ï¼ŒåŠ ä¸Šè¿™è¡Œæ˜¯ç»™å®¹å™¨å¢åŠ æ‰§è¡Œæƒé™\n-v /usr/local/docker_registry:/var/lib/registryâ€ƒæŠŠä¸»æœºçš„/usr/local/docker_registry ç›®å½•æŒ‚è½½åˆ°registryå®¹å™¨çš„/var/lib/registryç›®å½•ä¸‹ï¼Œå‡å¦‚æœ‰åˆ é™¤å®¹å™¨æ“ä½œï¼Œæˆ‘ä»¬çš„é•œåƒä¹Ÿä¸ä¼šè¢«åˆ é™¤\ndocker.io/registryâ€ƒé•œåƒåç§°\næŸ¥çœ‹å¯åŠ¨çš„å®¹å™¨\n4.ä»å…¬æœ‰ä»“åº“æ‹‰å–ä¸€ä¸ªé•œåƒä¸‹æ¥ï¼Œç„¶åpushåˆ°ç§æœ‰ä»“åº“ä¸­è¿›è¡Œæµ‹è¯• å½“å‰ç”¨nginxé•œåƒåšæµ‹è¯• 1 2 docker pull nginx docker images 5.ç»™dockeræ³¨å†Œhttpsåè®®ï¼Œæ”¯æŒhttpsè®¿é—® 1 vim /etc/docker/daemon.json å¦‚æœdaemonæ–‡ä»¶ä¸å­˜åœ¨ï¼Œvimä¼šè‡ªå·±åˆ›å»ºä¸€ä¸ªï¼Œå‡å¦‚ä¸€ä¸‹ä»£ç ï¼Œ\n{\n\u0026ldquo;insecure-registries\u0026rdquo;:[\u0026ldquo;ä¸»æœºçš„IPåœ°å€æˆ–è€…åŸŸå:5000\u0026rdquo;],\n\u0026ldquo;registry-mirrors\u0026rdquo;: [\u0026quot;https://registry.docker-cn.com\u0026quot;]\n}\næ³¨é‡Šï¼š\ninsecure-registries\u0026mdash;\u0026ndash;\u0026gt;å¼€æ”¾æ³¨å†Œhttpsåè®®\nregistry-mirrors\u0026mdash;\u0026ndash;\u0026gt;ä»“åº“æº\n6.æ–°å»ºä¸€ä¸ªtagï¼ŒæŠŠdocker.io/nginxåç§°å˜æˆåŸŸåæˆ–è€…IP/é•œåƒåç§° 1 docker tag docker.io/nginx ipæˆ–è€…åŸŸå:5000/nginx æ¨é€åˆ°æœ¬åœ°ä»“åº“\n1 docker push ipæˆ–è€…åŸŸå:5000/nginx 7.è¿›å…¥åˆšæ‰æ–°å»ºçš„nginxä»“åº“ç›®å½•å¾—åˆ° åˆ é™¤åˆšåˆštagçš„é•œåƒ ï¼ˆ192.*******:5000/nginxåˆšæ‰åˆ›å»ºçš„é•œåƒçš„tagï¼‰ 1 2 3 docker rmi 196.*******:5000/nginx docker rmi nginx docker images æ‹‰å–åˆšåˆšè‡ªå·±åˆ›å»ºçš„é•œåƒ\n1 docker pull 192.168.116.131:5000/nginx:1.2 å·²ç»å®Œæˆ\n","date":"2020-01-11T16:17:03Z","image":"https://www.ownit.top/title_pic/59.jpg","permalink":"https://www.ownit.top/p/202001111617/","title":"Centos7ä¸‹ä½¿ç”¨Dockeræ­å»ºæœ¬åœ°ç§æœ‰ä»“åº“"},{"content":"kubeadméƒ¨ç½²Kubernetesï¼ˆk8sï¼‰å®Œæ•´ç‰ˆè¯¦ç»†æ•™ç¨‹Â å®¹æ˜“é…ç½®ï¼Œä½†å‡ºé—®é¢˜å´å¾ˆéš¾å‘ç°ã€‚\näºŒè¿›åˆ¶åŒ…å®‰è£…Kubernetesé›†ç¾¤ç¯å¢ƒå®Œæ•´ç‰ˆ\né…ç½®éº»çƒ¦ï¼Œä½†ä¸å®¹æ˜“å‡ºç°é—®é¢˜ï¼Œä¹Ÿå®¹æ˜“æ’æŸ¥ã€‚\nå¯¹äºä¸Šé¢å®‰è£…Kubernetesæ–¹æ³•ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚\nä¸‹é¢è¿™ç§æ–¹æ³•ï¼Œå®¹æ˜“é…ç½®ï¼Œä¹Ÿä¸å®¹æ˜“å‡ºç°é—®é¢˜ã€‚\nç¯å¢ƒé…ç½® å‡†å¤‡3å°æœåŠ¡å™¨ï¼ˆæˆ‘ç”¨çš„æ˜¯CentOS7ç³»ç»Ÿï¼‰ï¼š\nMasterï¼š192.168.116.129\nNode1ï¼š192.168.116.130\nNode2ï¼š192.168.116.131\nk8sçš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š åœ¨k8sè¿›è¡Œç®¡ç†åº”ç”¨çš„æ—¶å€™ï¼ŒåŸºæœ¬æ­¥éª¤æ˜¯ï¼šåˆ›å»ºé›†ç¾¤ï¼Œéƒ¨ç½²åº”ç”¨ï¼Œå‘å¸ƒåº”ç”¨ï¼Œæ‰©å±•åº”ç”¨ï¼Œæ›´æ–°åº”ç”¨\nk8sçš„ä¸»è¦ç»„ä»¶ï¼Œä»¥åŠå®ƒä»¬ä¸»è¦æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„ï¼š **etcdï¼š**ä¸€æ¬¾å¼€æºè½¯ä»¶ã€‚æä¾›å¯é çš„åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨æœåŠ¡ï¼Œç”¨äºæŒä¹…åŒ–å­˜å‚¨K8sé›†ç¾¤çš„é…ç½®å’ŒçŠ¶æ€\n**apiserviceï¼š**ç”¨æˆ·ç¨‹åºï¼ˆå¦‚kubectlï¼‰ã€K8så…¶å®ƒç»„ä»¶ä¹‹é—´é€šä¿¡çš„æ¥å£ã€‚K8så…¶å®ƒç»„ä»¶ä¹‹é—´ä¸ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡API serveré€šä¿¡çš„ã€‚è¿™ä¸€ç‚¹åœ¨ä¸Šå›¾çš„è¿æ¥ä¸­å¯ä»¥ä½“ç°ï¼Œä¾‹å¦‚ï¼Œåªæœ‰API serverè¿æ¥äº†etcdï¼Œå³å…¶å®ƒç»„ä»¶æ›´æ–°K8sé›†ç¾¤çš„çŠ¶æ€æ—¶ï¼Œåªèƒ½é€šè¿‡API serverè¯»å†™etcdä¸­çš„æ•°æ®ã€‚\n**Schedulerï¼š**æ’ç¨‹ç»„ä»¶ï¼Œä¸ºç”¨æˆ·åº”ç”¨çš„æ¯ä¸€å¯éƒ¨ç½²ç»„ä»¶åˆ†é…å·¥ä½œç»“ç‚¹ã€‚\n**controller-managerï¼š**æ‰§è¡Œé›†ç¾¤çº§åˆ«çš„åŠŸèƒ½ï¼Œå¦‚å¤åˆ¶ç»„ä»¶ã€è¿½è¸ªå·¥ä½œç»“ç‚¹çŠ¶æ€ã€å¤„ç†ç»“ç‚¹å¤±è´¥ç­‰ã€‚Controller Managerç»„ä»¶æ˜¯ç”±å¤šä¸ªæ§åˆ¶å™¨ç»„æˆçš„ï¼Œå…¶ä¸­å¾ˆå¤šæ§åˆ¶å™¨æ˜¯æŒ‰K8sçš„èµ„æºç±»å‹åˆ’åˆ†çš„ï¼Œå¦‚Replication Managerï¼ˆç®¡ç†ReplicationController èµ„æºï¼‰ï¼ŒReplicaSet Controllerï¼ŒPersistentVolume controllerã€‚\n**kube-proxyï¼š**åœ¨åº”ç”¨ç»„ä»¶é—´è´Ÿè½½å‡è¡¡ç½‘ç»œæµé‡ã€‚\n**kubeletï¼š**ç®¡ç†å·¥ä½œç»“ç‚¹ä¸Šçš„å®¹å™¨ã€‚\nContriner runtime Dockerï¼ŒÂ rktç­‰å®é™…è¿è¡Œå®¹å™¨çš„ç»„ä»¶\nä¸Šé¢éƒ½æ˜¯äº›k8sé›†ç¾¤æ‰€è¦ç”¨åˆ°çš„ç»„ä»¶\nmasterä¸»æœºä¸Šå¿…é¡»è¦æœ‰çš„ç»„ä»¶ï¼š etcd ï¼šæä¾›åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨çš„æ•°æ®åº“å§ï¼Œç”¨äºæŒä¹…åŒ–å­˜å‚¨k8sé›†ç¾¤çš„é…ç½®å’ŒçŠ¶æ€\nkube-apiserverï¼šapi serviceæä¾›äº†http restæ¥å£ï¼Œæ˜¯æ•´ä¸ªé›†ç¾¤çš„å…¥å£ï¼ŒK8så…¶å®ƒç»„ä»¶ä¹‹é—´ä¸ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡API serveré€šä¿¡çš„ã€‚ï¼ˆåªæœ‰API serverè¿æ¥äº†etcdï¼Œå³å…¶å®ƒç»„ä»¶æ›´æ–°K8sé›†ç¾¤çš„çŠ¶æ€æ—¶ï¼Œåªèƒ½é€šè¿‡API serverè¯»å†™etcdä¸­çš„æ•°æ®ï¼‰\nkube-schedulerï¼šschedulerè´Ÿè´£èµ„æºçš„è°ƒåº¦\nkube-controller-managerï¼šæ•´ä¸ªé›†ç¾¤çš„ç®¡ç†æ§åˆ¶ä¸­å¿ƒï¼Œæ­¤ç»„ä»¶é‡Œé¢æ˜¯ç”±å¤šä¸ªæ§åˆ¶å™¨ç»„æˆçš„ï¼Œå¦‚ï¼šReplication Managerï¼ˆç®¡ç†ReplicationController èµ„æºï¼‰ï¼ŒReplicaSet Controllerï¼ŒPersistentVolume controllerã€‚ä¸»è¦ä½œç”¨ç”¨æ¥å¤åˆ¶ç»„ä»¶ã€è¿½è¸ªå·¥ä½œç»“ç‚¹çŠ¶æ€ã€å¤„ç†å¤±è´¥ç»“ç‚¹\nnodeèŠ‚ç‚¹æœºä¸Šå¿…é¡»è¦æœ‰çš„ç»„ä»¶ï¼š **flannelï¼š**å¥½åƒæ˜¯ç”¨æ¥æ”¯æŒç½‘ç»œé€šä¿¡çš„å§\n**kube-proxyï¼š**ç”¨æ¥è´Ÿè½½å‡è¡¡ç½‘ç»œæµé‡\n**kubeletï¼š**ç”¨æ¥ç®¡ç†nodeèŠ‚ç‚¹æœºä¸Šçš„å®¹å™¨\n**dockerï¼š**è¿è¡Œé¡¹ç›®é•œåƒå®¹å™¨çš„ç»„ä»¶\nk8sçš„æ•´ä¸ªé›†ç¾¤è¿è¡ŒåŸç†ï¼š masterä¸»æœºä¸Šçš„kube-controller-manageræ˜¯æ•´ä¸ªé›†ç¾¤çš„æ§åˆ¶ç®¡ç†ä¸­å¿ƒï¼Œkube-controler-managerä¸­çš„node controlleræ¨¡å—Â é€šè¿‡apiserviceæä¾›çš„ç›‘å¬æ¥å£ï¼Œå®æ—¶ç›‘æ§nodeæœºçš„çŠ¶æ€ä¿¡æ¯ã€‚\nå½“æŸä¸ªnodeæœºå™¨å®•æœºï¼Œcontroller-managerå°±ä¼šåŠæ—¶æ’é™¤æ•…éšœå¹¶è‡ªåŠ¨ä¿®å¤ã€‚\nnodeèŠ‚ç‚¹æœºä¸Šçš„kubeletè¿›ç¨‹æ¯éš”ä¸€æ®µæ—¶é—´å‘¨æœŸå°±ä¼šè°ƒç”¨ä¸€æ¬¡apiserviceæ¥å£æŠ¥å‘Šè‡ªèº«çŠ¶æ€ï¼Œapiserviceæ¥å£æ¥å—åˆ°è¿™äº›ä¿¡æ¯åå°†èŠ‚ç‚¹çŠ¶æ€æ›´æ–°åˆ°ectdä¸­ã€‚kubeletä¹Ÿé€šè¿‡apiserviceçš„ç›‘å¬æ¥å£ç›‘å¬podä¿¡æ¯ï¼Œå¦‚æœç›‘æ§åˆ°æ–°çš„podå‰¯æœ¬è¢«è°ƒåº¦ç»‘å®šåˆ°æœ¬èŠ‚ç‚¹ï¼Œåˆ™æ‰§è¡Œpodå¯¹åº”çš„å®¹å™¨çš„åˆ›å»ºå’Œå¯åŠ¨ï¼Œå¦‚æœç›‘å¬åˆ°podå¯¹è±¡è¢«åˆ é™¤ï¼Œåˆ™åˆ é™¤æœ¬èŠ‚ç‚¹å¯¹åº”çš„podå®¹å™¨ã€‚\nKuberneteså®‰è£…æ­¥éª¤ï¼š 1ã€æ‰€æœ‰æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå‡†å¤‡å®‰è£…ç¯å¢ƒï¼š(æ³¨æ„æ˜¯æ‰€æœ‰æœºå™¨ï¼Œä¸»æœºmasterï¼Œä»æœºnodeéƒ½è¦å®‰è£…) å®‰è£…epel-releaseæº\n1 yum -y install epel-release æ‰€æœ‰æœºå™¨å…³é—­é˜²ç«å¢™\n1 2 3 4 5 6 7 8 systemctl stop firewalld systemctl disable firewalld setenforce 0 #æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€ firewall-cmd --state å…³é—­swap\n1 swapoff -a 2ã€ç°åœ¨å¼€å§‹masterä¸»æœºä¸Šå®‰è£…kubernetes Master 1 yum -y install etcd kubernetes-master etcd.conf ç¼–è¾‘ï¼švi /etc/etcd/etcd.confæ–‡ä»¶ï¼Œä¿®æ”¹ç»“æœå¦‚ä¸‹ï¼š\napiserver é…ç½®ï¼švi /etc/kubernetes/apiserveræ–‡ä»¶ï¼Œé…ç½®ç»“æœå¦‚ä¸‹ï¼š\nå¯åŠ¨etcdã€kube-apiserverã€kube-controller-managerã€kube-schedulerç­‰æœåŠ¡ï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨ã€‚\n1 for SERVICES in etcd kube-apiserver kube-controller-manager kube-scheduler; do systemctl restart $SERVICES;systemctl enable $SERVICES;systemctl status $SERVICES ; done åœ¨etcdä¸­å®šä¹‰flannelç½‘ç»œ\n1 etcdctl mk /atomic.io/network/config \u0026#39;{\u0026#34;Network\u0026#34;:\u0026#34;172.17.0.0/16\u0026#34;}\u0026#39; ä»¥ä¸Šmasterä¸»æœºä¸Šçš„é…ç½®å®‰è£…ä»€ä¹ˆçš„éƒ½å¼„å®Œ 3ã€åœ¨nodeæœºä¸Šå®‰è£…kubernetes Nodeå’Œflannelç»„ä»¶åº”ç”¨ 1 yum -y install flannel kubernetes-node flanneld ä¸ºflannelç½‘ç»œæŒ‡å®šetcdæœåŠ¡ï¼Œä¿®æ”¹**/etc/sysconfig/flanneld**æ–‡ä»¶ï¼Œé…ç½®ç»“æœå¦‚ä¸‹å›¾ï¼š\nconfig ä¿®æ”¹ï¼švi /etc/kubernetes/configæ–‡ä»¶ï¼Œé…ç½®ç»“æœå¦‚ä¸‹å›¾ï¼š\nkubelet ä¿®æ”¹nodeæœºçš„kubeleté…ç½®æ–‡ä»¶**/etc/kubernetes/kubelet**\nnodeèŠ‚ç‚¹æœºä¸Šå¯åŠ¨kube-proxy,kubelet,docker,flanneldç­‰æœåŠ¡ï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨ã€‚\n1 for SERVICES in kube-proxy kubelet docker flanneld;do systemctl restart $SERVICES;systemctl enable $SERVICES;systemctl status $SERVICES; done 4ã€åœ¨masterä¸»æœºä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹è¿è¡Œçš„nodeèŠ‚ç‚¹æœºå™¨ï¼š 1 kubectl get nodes k8sçš„å®‰è£…ç®—æ˜¯å®Œæˆ 5ã€éƒ¨ç½² Dashboard ä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘ç»™é…ç½®æ–‡ä»¶Â https://www.lanzous.com/i8jjpij\né»˜è®¤é•œåƒå›½å†…æ— æ³•è®¿é—®ï¼Œä¿®æ”¹é•œåƒåœ°å€ä¸ºï¼š lizhenliang/kubernetes-dashboard-amd64:v1.10.1\né»˜è®¤Dashboardåªèƒ½é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œä¿®æ”¹Serviceä¸ºNodePortç±»å‹ï¼Œæš´éœ²åˆ°å¤–éƒ¨ï¼š\nå…ˆDockeræ‹‰å»é•œåƒ\n1 docker pull lizhenliang/kubernetes-dashboard-amd64:v1.10.1 æ‰§è¡Œkubernetes-dashboard.yaml æ–‡ä»¶\n1 kubectl apply -f kubernetes-dashboard.yaml å®‰è£…æˆåŠŸ\næŸ¥çœ‹æš´éœ²çš„ç«¯å£\n1 kubectl get pods,svc -n kube-system 6. è®¿é—® Dashboardçš„webç•Œé¢ è®¿é—®åœ°å€ï¼šhttps://NodeIP:30001Â ã€å¿…é¡»æ˜¯httpsã€‘\nåˆ›å»ºservice accountå¹¶ç»‘å®šé»˜è®¤cluster-adminç®¡ç†å‘˜é›†ç¾¤è§’è‰²ï¼šã€ä¾æ¬¡æ‰§è¡Œã€‘\n1 kubectl create serviceaccount dashboard-admin -n kube-system 1 kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin 1 kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk \u0026#39;/dashboard-admin/{print $1}\u0026#39;) å·²ç»éƒ¨ç½²å®Œæˆã€‚\n","date":"2020-01-11T12:04:17Z","image":"https://www.ownit.top/title_pic/34.jpg","permalink":"https://www.ownit.top/p/202001111204/","title":"CentOS7çš„Yumå®‰è£…Kubernetesï¼ˆk8sï¼‰å®Œæ•´ç‰ˆè¯¦ç»†æ•™ç¨‹"},{"content":"Kubernetes æ¦‚è¿° 1. Kubernetesæ˜¯ä»€ä¹ˆ Kubernetesæ˜¯Googleåœ¨2014å¹´å¼€æºçš„ä¸€ä¸ªå®¹å™¨é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼ŒKubernetesç®€ç§°K8Sã€‚ K8Sç”¨äºå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ï¼Œæ‰©å±•å’Œç®¡ç†ã€‚ K8Sæä¾›äº†å®¹å™¨ç¼–æ’ï¼Œèµ„æºè°ƒåº¦ï¼Œå¼¹æ€§ä¼¸ç¼©ï¼Œéƒ¨ç½²ç®¡ç†ï¼ŒæœåŠ¡å‘ç°ç­‰ä¸€ç³»åˆ—åŠŸèƒ½ã€‚ Kubernetesç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨ç®€å•é«˜æ•ˆã€‚ å®˜æ–¹ç½‘ç«™ï¼šhttp://www.kubernetes.io\n2. Kubernetesç‰¹æ€§ è‡ªæˆ‘ä¿®å¤\nåœ¨èŠ‚ç‚¹æ•…éšœæ—¶é‡æ–°å¯åŠ¨å¤±è´¥çš„å®¹å™¨ï¼Œæ›¿æ¢å’Œé‡æ–°éƒ¨ç½²ï¼Œä¿è¯é¢„æœŸçš„å‰¯æœ¬æ•°é‡ï¼›æ€æ­»å¥åº·æ£€æŸ¥å¤±è´¥çš„å®¹å™¨ï¼Œå¹¶ä¸”åœ¨æœªå‡†å¤‡å¥½ä¹‹å‰ä¸ä¼šå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç¡®ä¿çº¿ä¸ŠæœåŠ¡ä¸ä¸­æ–­ã€‚\n**Â å¼¹æ€§ä¼¸ç¼©**\nä½¿ç”¨å‘½ä»¤ã€UIæˆ–è€…åŸºäºCPUä½¿ç”¨æƒ…å†µè‡ªåŠ¨å¿«é€Ÿæ‰©å®¹å’Œç¼©å®¹åº”ç”¨ç¨‹åºå®ä¾‹ï¼Œä¿è¯åº”ç”¨ä¸šåŠ¡é«˜å³°å¹¶å‘æ—¶çš„é«˜å¯ç”¨æ€§ï¼›ä¸šåŠ¡ä½å³°æ—¶å›æ”¶èµ„æºï¼Œä»¥æœ€å°æˆæœ¬è¿è¡ŒæœåŠ¡ã€‚\n**Â è‡ªåŠ¨éƒ¨ç½²å’Œå›æ»š**\nK8Sé‡‡ç”¨æ»šåŠ¨æ›´æ–°ç­–ç•¥æ›´æ–°åº”ç”¨ï¼Œä¸€æ¬¡æ›´æ–°ä¸€ä¸ªPodï¼Œè€Œä¸æ˜¯åŒæ—¶åˆ é™¤æ‰€æœ‰Podï¼Œå¦‚æœæ›´æ–°è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œå°†å›æ»šæ›´æ”¹ï¼Œç¡®ä¿å‡çº§ä¸å—å½±å“ä¸šåŠ¡ã€‚\næœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡\nK8Sä¸ºå¤šä¸ªå®¹å™¨æä¾›ä¸€ä¸ªç»Ÿä¸€è®¿é—®å…¥å£ï¼ˆå†…éƒ¨IPåœ°å€å’Œä¸€ä¸ªDNSåç§°ï¼‰ï¼Œå¹¶ä¸”è´Ÿè½½å‡è¡¡å…³è”çš„æ‰€æœ‰å®¹å™¨ï¼Œä½¿å¾—ç”¨æˆ·æ— éœ€è€ƒè™‘å®¹å™¨IPé—®é¢˜ã€‚\n**Â æœºå¯†å’Œé…ç½®ç®¡ç†**\nç®¡ç†æœºå¯†æ•°æ®å’Œåº”ç”¨ç¨‹åºé…ç½®ï¼Œè€Œä¸éœ€è¦æŠŠæ•æ„Ÿæ•°æ®æš´éœ²åœ¨é•œåƒé‡Œï¼Œæé«˜æ•æ„Ÿæ•°æ®å®‰å…¨æ€§ã€‚å¹¶å¯ä»¥å°†ä¸€äº›å¸¸ç”¨çš„é…ç½®å­˜å‚¨åœ¨K8Sä¸­ï¼Œæ–¹ä¾¿åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚\n**Â å­˜å‚¨ç¼–æ’**\næŒ‚è½½å¤–éƒ¨å­˜å‚¨ç³»ç»Ÿï¼Œæ— è®ºæ˜¯æ¥è‡ªæœ¬åœ°å­˜å‚¨ï¼Œå…¬æœ‰äº‘ï¼ˆå¦‚AWSï¼‰ï¼Œè¿˜æ˜¯ç½‘ç»œå­˜å‚¨ï¼ˆå¦‚NFSã€GlusterFSã€Cephï¼‰éƒ½ä½œä¸ºé›†ç¾¤èµ„æºçš„ä¸€éƒ¨åˆ†ä½¿ç”¨ï¼Œæå¤§æé«˜å­˜å‚¨ä½¿ç”¨çµæ´»æ€§ã€‚\næ‰¹å¤„ç†\næä¾›ä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œå®šæ—¶ä»»åŠ¡ï¼›æ»¡è¶³æ‰¹é‡æ•°æ®å¤„ç†å’Œåˆ†æçš„åœºæ™¯ã€‚\n3. Kubernetesé›†ç¾¤æ¶æ„ä¸ç»„ä»¶ Masterç»„ä»¶ kube-apiserver Kubernetes APIÂ é›†ç¾¤çš„ç»Ÿä¸€å…¥å£ï¼Œå„ç»„ä»¶åè°ƒè€…ï¼Œä»¥ RESTful APIæä¾›æ¥å£æœåŠ¡ï¼Œæ‰€æœ‰å¯¹è±¡èµ„æºçš„å¢åˆ æ”¹æŸ¥å’Œç›‘å¬ æ“ä½œéƒ½äº¤ç»™APIServerå¤„ç†åå†æäº¤ç»™Etcdå­˜å‚¨ã€‚ kube-controller-manager å¤„ç†é›†ç¾¤ä¸­å¸¸è§„åå°ä»»åŠ¡ï¼Œä¸€ä¸ªèµ„æºå¯¹åº”ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œè€Œ ControllerManagerå°±æ˜¯è´Ÿè´£ç®¡ç†è¿™äº›æ§åˆ¶å™¨çš„ã€‚ kube-scheduler æ ¹æ®è°ƒåº¦ç®—æ³•ä¸ºæ–°åˆ›å»ºçš„Podé€‰æ‹©ä¸€ä¸ªNodeèŠ‚ç‚¹ï¼Œå¯ä»¥ä»»æ„ éƒ¨ç½²,å¯ä»¥éƒ¨ç½²åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Š,ä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šã€‚ etcd åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿã€‚ç”¨äºä¿å­˜é›†ç¾¤çŠ¶æ€æ•°æ®ï¼Œæ¯”å¦‚Podã€ Serviceç­‰å¯¹è±¡ä¿¡æ¯ã€‚ Nodeç»„ä»¶ kubelet kubelet æ˜¯Masteråœ¨NodeèŠ‚ç‚¹ä¸Šçš„Agentï¼Œç®¡ç†æœ¬æœºè¿è¡Œå®¹å™¨ çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¯”å¦‚åˆ›å»ºå®¹å™¨ã€PodæŒ‚è½½æ•°æ®å·ã€ä¸‹è½½secretã€è· å–å®¹å™¨å’ŒèŠ‚ç‚¹çŠ¶æ€ç­‰å·¥ä½œã€‚ kubeletÂ å°†æ¯ä¸ªPodè½¬æ¢æˆä¸€ç»„å®¹å™¨ã€‚ kube-proxy åœ¨NodeèŠ‚ç‚¹ä¸Šå®ç°Podç½‘ç»œä»£ç†ï¼Œç»´æŠ¤ç½‘ç»œè§„åˆ™å’Œå››å±‚è´Ÿè½½å‡ è¡¡å·¥ä½œã€‚ ï¬dockeræˆ–rocket å®¹å™¨å¼•æ“ï¼Œè¿è¡Œå®¹å™¨ 4. Kubernetesæ ¸å¿ƒæ¦‚å¿µ Pod æœ€å°éƒ¨ç½²å•å…ƒ ä¸€ç»„å®¹å™¨çš„é›†åˆ ä¸€ä¸ªPodä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ Podæ˜¯çŸ­æš‚çš„ Controllers ReplicaSet ï¼š ç¡®ä¿é¢„æœŸçš„Podå‰¯æœ¬æ•°é‡Â Deployment ï¼š æ— çŠ¶æ€åº”ç”¨éƒ¨ç½²Â StatefulSet ï¼š æœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½² DaemonSet ï¼š ç¡®ä¿æ‰€æœ‰Nodeè¿è¡ŒåŒä¸€ä¸ªPodÂ Job ï¼š ä¸€æ¬¡æ€§ä»»åŠ¡Â Cronjob ï¼š å®šæ—¶ä»»åŠ¡ æ›´é«˜çº§å±‚æ¬¡å¯¹è±¡ï¼Œéƒ¨ç½²å’Œç®¡ç†Pod Service é˜²æ­¢Podå¤±è” å®šä¹‰ä¸€ç»„Podçš„è®¿é—®ç­–ç•¥ Label æ ‡ç­¾ï¼Œé™„åŠ åˆ°æŸä¸ªèµ„æºä¸Šï¼Œç”¨äºå…³è”å¯¹è±¡ã€æŸ¥è¯¢å’Œç­›é€‰ NamespaceÂ å‘½åç©ºé—´ï¼Œå°†å¯¹è±¡é€»è¾‘ä¸Šéš”ç¦» æ­å»ºä¸€ä¸ª Kubernetes é›†ç¾¤ 1. å®˜æ–¹æä¾›çš„ä¸‰ç§éƒ¨ç½²æ–¹å¼ minikube Minikubeæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥åœ¨æœ¬åœ°å¿«é€Ÿè¿è¡Œä¸€ä¸ªå•ç‚¹çš„Kubernetesï¼Œå°è¯•Kubernetesæˆ–æ—¥å¸¸å¼€å‘çš„ç”¨æˆ·ä½¿ç”¨ã€‚ä¸èƒ½ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚\nå®˜æ–¹åœ°å€ï¼šhttps://kubernetes.io/docs/setup/minikube/\nkubeadm Kubeadmä¹Ÿæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œæä¾›kubeadm initå’Œkubeadm joinï¼Œç”¨äºå¿«é€Ÿéƒ¨ç½²Kubernetesé›†ç¾¤ã€‚\nå®˜æ–¹åœ°å€ï¼šhttps://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/\näºŒè¿›åˆ¶åŒ… ä»å®˜æ–¹ä¸‹è½½å‘è¡Œç‰ˆçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰‹åŠ¨éƒ¨ç½²æ¯ä¸ªç»„ä»¶ï¼Œç»„æˆKubernetesé›†ç¾¤ã€‚\nå°ç»“ï¼š\nç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²Kubernetesé›†ç¾¤ï¼Œåªæœ‰Kubeadmå’ŒäºŒè¿›åˆ¶åŒ…å¯é€‰ï¼ŒKubeadmé™ä½éƒ¨ç½²é—¨æ§›ï¼Œä½†å±è”½äº†å¾ˆå¤šç»†èŠ‚ï¼Œé‡åˆ°é—®é¢˜å¾ˆéš¾æ’æŸ¥ã€‚æˆ‘ä»¬è¿™é‡Œä½¿ç”¨äºŒè¿›åˆ¶åŒ…éƒ¨ç½²Kubernetesé›†ç¾¤ï¼Œæˆ‘ä¹Ÿæ˜¯æ¨èå¤§å®¶ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè™½ç„¶æ‰‹åŠ¨éƒ¨ç½²éº»çƒ¦ç‚¹ï¼Œä½†å­¦ä¹ å¾ˆå¤šå·¥ä½œåŸç†ï¼Œæ›´æœ‰åˆ©äºåæœŸç»´æŠ¤ã€‚\n2. Kubernetesé›†ç¾¤ç¯å¢ƒè§„åˆ’ è½¯ä»¶ç¯å¢ƒ\n| è½¯ä»¶\n|\nç‰ˆæœ¬\næ“ä½œç³»ç»Ÿ\n|\nCentOS7.5_x64\n| |\nDocker\n|\n18-ce\n| |\nKubernetes\n|\n1.12\n|\næœåŠ¡å™¨è§’è‰²\n| è§’è‰²\n|\nIP\n|\nç»„ä»¶\nk8s-master\n|\n192.168.116.129\n|\nkube-apiserverï¼Œkube-controller-managerï¼Œkube-schedulerï¼Œetcd\n| |\nk8s-node1\n|\n192.168.116.130\n|\nkubeletï¼Œkube-proxyï¼Œdockerï¼Œflannelï¼Œetcd\n| |\nk8s-node2\n|\n192.168.116.131\n|\nkubeletï¼Œkube-proxyï¼Œdockerï¼Œflannelï¼Œetcd\n|\néœ€è¦çš„è½¯ä»¶å’Œè„šæœ¬ï¼Œå¤±æ•ˆå¯è”ç³»æˆ‘\n**é“¾æ¥: https://pan.baidu.com/s/1Vr8jOFgo4b8tQM9AUtXC_A æå–ç : yhhnÂ **\næ¶æ„å›¾\n3. HTTPSè¯ä¹¦ä»‹ç» 1ã€å…³é—­selinux\n1 2 sed -i \u0026#39;s/enforcing/disabled/\u0026#39; /etc/selinux/config setenforce 0 2ã€å…³é—­é˜²ç«å¢™\n1 2 systemctl stop firewalld systemctl disable firewalld 3ã€å…³é—­swap\n1 swapoff -a 4ã€ä¿®æ”¹ä¸»æœºå\n1 hostnamectl set-hostname åå­— 5ã€åŒæ­¥æ—¶é—´\n1 yum install -y ntpdate \u0026amp;\u0026amp; ntpdate time.windows.com ä»¥ä¸Šæ­¥éª¤å¯ä»¥å‚è€ƒä¸‹æ–¹é“¾æ¥\nkubeadméƒ¨ç½²Kubernetesï¼ˆk8sï¼‰å®Œæ•´ç‰ˆè¯¦ç»†æ•™ç¨‹\nè‡ªç­¾SSLè¯ä¹¦ å‡†å¤‡ä½¿ç”¨etcd-certç”Ÿæˆè¯ä¹¦\nä¸Šä¼ cfssl.shï¼Œè¿è¡Œè„šæœ¬\nç”Ÿæˆä¸‹é¢ä¸¤ä¸ªæ–‡ä»¶ï¼Œè®°ä½æ˜¯tabè¡¥å…¨æŸ¥çœ‹\næ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 cat \u0026gt; ca-config.json \u0026lt;\u0026lt;EOF { \u0026#34;signing\u0026#34;: { \u0026#34;default\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;87600h\u0026#34; }, \u0026#34;profiles\u0026#34;: { \u0026#34;www\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;87600h\u0026#34;, \u0026#34;usages\u0026#34;: [ \u0026#34;signing\u0026#34;, \u0026#34;key encipherment\u0026#34;, \u0026#34;server auth\u0026#34;, \u0026#34;client auth\u0026#34; ] } } } } EOF cat \u0026gt; ca-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;etcd CA\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;Beijing\u0026#34; } ] } EOF æ‰§è¡Œ\n1 cfssl gencert -initca ca-csr.json | cfssljson -bare ca - 1 cat etcd-cert.sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 cat \u0026gt; server-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;etcd\u0026#34;, \u0026#34;hosts\u0026#34;: [ \u0026#34;192.168.116.129\u0026#34;, \u0026#34;192.168.116.130\u0026#34;, \u0026#34;192.168.116.131\u0026#34; ], \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;BeiJing\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;BeiJing\u0026#34; } ] } EOF é¢å‘è¯ä¹¦\n1 cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server 4. Etcdæ•°æ®åº“é›†ç¾¤éƒ¨ç½² ä¸Šä¼ etcdå®‰è£…åŒ… ã€etcd-v3.3.10-linux-amd64.tar.gzã€‘\nè§£å‹\n1 tar zxvf etcd-v3.3.10-linux-amd64.tar.gz ä¸ºäº†æ–¹ä¾¿å®‰è£…ï¼Œåˆ›å»ºä¸‹é¢ç›®å½•å®‰è£…ã€‚\n1 2 3 4 5 6 [root@master etcd-v3.3.10-linux-amd64]# mkdir -p /opt/etcd/{cfg,bin,ssl} [root@master etcd-v3.3.10-linux-amd64]# ls /opt/etcd/ bin cfg ssl [root@master etcd-v3.3.10-linux-amd64]# mv etcd etcdctl /opt/etcd/bin/ [root@master etcd-v3.3.10-linux-amd64]# ls /opt/etcd/bin/ etcd etcdctl ä½¿ç”¨è„šæœ¬éƒ¨ç½²etcd 1 chmod +x etcd.sh è¿è¡Œè„šæœ¬ 1 ./etcd.sh etcd01 192.168.116.129 etcd02=https://192.168.116.130:2380,etcd03=https://192.168.116.131:2380 å¯ä»¥æŸ¥çœ‹etcdçš„è¿è¡ŒæœåŠ¡æ–‡ä»¶\n1 cat /usr/lib/systemd/system/etcd.service æ‹·è´è¯ä¹¦\n1 cp /root/k8s/etcd-cert/{ca,server-key,server}.pem /opt/etcd/ssl/ å¯åŠ¨etcd 1 systemctl start etcd å·²ç»éƒ¨ç½²ä¸€ä¸ªæˆåŠŸï¼Œä½†æ˜¯è¿˜æœ‰ä¸¤ä¸ªæœºå™¨æ²¡æœ‰éƒ¨ç½²etcdã€‚éœ€è¦æŠŠ/opt/çš„etcdç›®å½•ç§»åˆ°å…¶ä½™èŠ‚ç‚¹é…ç½®\nè¿˜æœ‰/usr/lib/systemd/system/etcd.serviceè¿™ä¸ªé…ç½®æ–‡ä»¶\næ‹·è´è¿‡å»è¿˜éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶æ‰èƒ½å¯åŠ¨ã€‚\n1 vi /opt/etcd/cfg/etcd è¿™å‡ ä¸ªéœ€è¦ä¿®æ”¹æœ¬æœºå¯¹äºçš„ip\nåˆ‡å¿Œè¦ç»™ä¸‹æ–¹çš„æ–‡ä»¶æ‰§è¡Œæƒé™ï¼Œä¸ç„¶ä¼šæŠ¥é”™\n1 /opt/etcd/bin å¯åŠ¨\n1 systemctl daemon-reload 1 systemctl start etcd å·²ç»å®Œæˆå¯åŠ¨\nåœ¨node2ä¹ŸæŒ‰ç…§ä¸Šæ–¹éƒ¨ç½²å°±è¡Œã€‚\næŸ¥çœ‹å…ˆå‰æ—¥å¿—ã€æ²¡æœ‰æŠ¥ä»»ä½•é”™è¯¯ï¼Œå·²ç»æˆåŠŸæ­å»ºé›†ç¾¤ã€‘\n1 tail /var/log/messages -f æµ‹è¯• 1 /opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem --endpoints=\u0026#34;https://192.168.116.129:2379,https://192.168.116.130:2379,https://192.168.116.131:2379\u0026#34; cluster-health 5. Nodeå®‰è£…Docker å®‰è£…ä¾èµ–è½¯ä»¶\n1 yum install -y yum-utils device-mapper-persistent-data lvm2 1 yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo å®‰è£…docker-ce\n1 yum install docker-ce -y é…ç½®dockeråŠ é€Ÿå™¨\n1 curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://bc437cce.m.daocloud.io å¯åŠ¨docker\n1 systemctl start docker å¼€æœºè‡ªå¯\n1 systemctl enable docker 6. Flannelå®¹å™¨é›†ç¾¤ç½‘ç»œéƒ¨ç½² Kubernetesç½‘ç»œæ¨¡å‹è®¾è®¡åŸºæœ¬è¦æ±‚ï¼š\nä¸€ä¸ªPodä¸€ä¸ªIP æ¯ä¸ªPodç‹¬ç«‹IPï¼ŒPodå†…æ‰€æœ‰å®¹å™¨å…±äº«ç½‘ç»œï¼ˆåŒä¸€ä¸ªIPï¼‰ æ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥ä¸æ‰€æœ‰å…¶ä»–å®¹å™¨é€šä¿¡ æ‰€æœ‰èŠ‚ç‚¹éƒ½å¯ä»¥ä¸æ‰€æœ‰æœ‰å®¹å™¨é€šä¿¡ å·¥ä½œåŸç†ï¼š\næ·»åŠ ç½‘æ®µ\n1 /opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem --endpoints=\u0026#34;https://192.168.116.129:2379,https://192.168.116.130:2379,https://192.168.116.131:2379\u0026#34; set /coreos.com/network/config \u0026#39;{ \u0026#34;Network\u0026#34;: \u0026#34;172.17.0.0/16\u0026#34;, \u0026#34;Backend\u0026#34;: {\u0026#34;Type\u0026#34;: \u0026#34;vxlan\u0026#34;}}\u0026#39; 1 /opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem --endpoints=\u0026#34;https://192.168.116.129:2379,https://192.168.116.130:2379,https://192.168.116.131:2379\u0026#34; get /coreos.com/network/config ä¸Šä¼ Flannelã€åœ¨nodeä¸Šéƒ¨ç½²flannelã€‘\næ–¹ä¾¿ç®¡ç†flannelï¼Œåˆ›å»ºä¸‹é¢æ–‡ä»¶\n1 mkdir -p /opt/kubernetes/{bin,cfg,ssl} ä½¿ç”¨flannelè¿æ¥etcdå½¢å¼æ‰§è¡Œè„šæœ¬\n1 ./flannel.sh https://192.168.116.129:2379,https://192.168.116.130:2379,https://192.168.116.131:2379 è§£å‹flannel-v0.10.0-linux-amd64.tar.gz\n1 tar zxvf flannel-v0.10.0-linux-amd64.tar.gz 1 mv flanneld mk-docker-opts.sh /opt/kubernetes/bin/ å¯åŠ¨flannelï¼ŒæˆåŠŸ\n1 systemctl start flanneld é‡å¯docker\n1 systemctl restart docker å®‰è£…openssh-clientsï¼ŒæŠŠflannelçš„é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°Node2ä¸Šã€‚\n1 yum install -y openssh-clients ä¼ è¾“åˆ°Node2ä¸Š\n1 scp -r /opt/kubernetes/ root@192.168.116.131:/opt/ 1 scp /usr/lib/systemd/system/{flanneld,docker}.service root@192.168.116.131:/usr/lib/systemd/system/ åœ¨Node2ä¸Šå¯åŠ¨flanneld\n1 2 systemctl start flanneld systemctl start docker 7. éƒ¨ç½²Masterç»„ä»¶ 1. kube-apiserver\n2. kube-controller-manager\n3. kube-scheduler\né…ç½®æ–‡ä»¶ -\u0026gt; systemdç®¡ç†ç»„ä»¶ -\u0026gt; å¯åŠ¨\nä¸Šä¼ Master\n1 unzip master.zip ä¸Šä¼ kubernetes-server-linux-amd64.tar.gz\n1 tar zxvf kubernetes-server-linux-amd64.tar.gz åˆ›å»ºå®‰è£…ç›®å½•ï¼Œæ–¹ä¾¿ä½¿ç”¨\n1 mkdir -p /opt/kubernetes/{bin,cfg,ssl} æ¥åˆ°/root/k8s/soft/kubernetes/server/binç›®å½•ä¸‹æ‹·è´æ–‡ä»¶\n1 cp kube-apiserver kube-controller-manager kube-scheduler /opt/kubernetes/bin/ æ‰§è¡Œapiserver.sh ã€è„šæœ¬ masterip etcdçš„ipã€‘\n1 ./apiserver.sh 192.168.116.129 https://192.168.116.129:2379,https://192.168.116.130:2379,https://192.168.116.131:2379 æŸ¥çœ‹ç”Ÿæˆçš„é…æ–‡ä»¶\n1 cat /opt/kubernetes/cfg/kube-apiserver ä¸Šä¼ k8s-cert.shï¼Œç”Ÿæˆè¯ä¹¦\n1 bash k8s-cert.sh å¤åˆ¶è¯ä¹¦åˆ°/opt/kubernetes/ssl/é‡Œ\n1 cp ca.pem ca-key.pem server.pem server-key.pem /opt/kubernetes/ssl/ ä¸Šä¼ tokené…ç½®æ–‡ä»¶ï¼Œç”Ÿæˆtokenã€‚\n1 2 3 4 5 BOOTSTRAP_TOKEN=0fb61c46f8991b718eb38d27b605b008 cat \u0026gt; token.csv \u0026lt;\u0026lt;EOF ${BOOTSTRAP_TOKEN},kubelet-bootstrap,10001,\u0026#34;system:kubelet-bootstrap\u0026#34; EOF ç”Ÿæˆtoken.csv æ–‡ä»¶ç§»åŠ¨ 1 mv token.csv /opt/kubernetes/cfg/ å¯åŠ¨kube-apiserver\n1 systemctl restart kube-apiserver æŸ¥çœ‹ç›‘å¬ç«¯å£\n1 2 3 4 5 6 [root@master k8s-cert]# netstat -ano | grep 8080 tcp 0 0 127.0.0.1:8080 0.0.0.0:* LISTEN off (0.00/0/0) [root@master k8s-cert]# netstat -ano | grep 6443 tcp 0 0 192.168.116.129:6443 0.0.0.0:* LISTEN off (0.00/0/0) tcp 0 0 192.168.116.129:44594 192.168.116.129:6443 ESTABLISHED keepalive (9.93/0/0) tcp 0 0 192.168.116.129:6443 192.168.116.129:44594 ESTABLISHED keepalive (109.64/0/0) è¿è¡Œcontroller-manager.sh\n1 2 ./controller-manager.sh 127.0.0.1 ./scheduler.sh 127.0.0.1 1 2 3 4 5 6 [root@master k8s]# ls apiserver.sh controller-manager.sh etcd-cert etcd.sh flannel.sh k8s-cert master.zip scheduler.sh soft [root@master k8s]# ./controller-manager.sh 127.0.0.1 Created symlink from /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service to /usr/lib/systemd/system/kube-controller-manager.service. [root@master k8s]# ./scheduler.sh 127.0.0.1 Created symlink from /etc/systemd/system/multi-user.target.wants/kube-scheduler.service to /usr/lib/systemd/system/kube-scheduler.service. åˆ›å»ºkubectlç®¡ç†å·¥å…·\n1 cp kubectl /usr/bin/ æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€\n1 kubectl get cs æŸ¥çœ‹èµ„æºåå­—ç®€å†™\n1 kubectl api-resources 8. éƒ¨ç½²Nodeç»„ä»¶ 1. å°†kubelet-bootstrapç”¨æˆ·ç»‘å®šåˆ°ç³»ç»Ÿé›†ç¾¤è§’è‰² 1 2 3 kubectl create clusterrolebinding kubelet-bootstrap \\ --clusterrole=system:node-bootstrapper \\ --user=kubelet-bootstrap 2. åˆ›å»ºkubeconfigæ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 #---------------------- APISERVER=$1 SSL_DIR=$2 #éœ€è¦å…ˆå‰åˆ›å»ºçš„token BOOTSTRAP_TOKEN=0fb61c46f8991b718eb38d27b605b008 # åˆ›å»ºkubelet bootstrapping kubeconfig export KUBE_APISERVER=\u0026#34;https://$APISERVER:6443\u0026#34; # è®¾ç½®é›†ç¾¤å‚æ•° kubectl config set-cluster kubernetes \\ --certificate-authority=$SSL_DIR/ca.pem \\ --embed-certs=true \\ --server=${KUBE_APISERVER} \\ --kubeconfig=bootstrap.kubeconfig # è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•° kubectl config set-credentials kubelet-bootstrap \\ --token=${BOOTSTRAP_TOKEN} \\ --kubeconfig=bootstrap.kubeconfig # è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•° kubectl config set-context default \\ --cluster=kubernetes \\ --user=kubelet-bootstrap \\ --kubeconfig=bootstrap.kubeconfig # è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡ kubectl config use-context default --kubeconfig=bootstrap.kubeconfig #---------------------- # åˆ›å»ºkube-proxy kubeconfigæ–‡ä»¶ kubectl config set-cluster kubernetes \\ --certificate-authority=$SSL_DIR/ca.pem \\ --embed-certs=true \\ --server=${KUBE_APISERVER} \\ --kubeconfig=kube-proxy.kubeconfig kubectl config set-credentials kube-proxy \\ --client-certificate=$SSL_DIR/kube-proxy.pem \\ --client-key=$SSL_DIR/kube-proxy-key.pem \\ --embed-certs=true \\ --kubeconfig=kube-proxy.kubeconfig kubectl config set-context default \\ --cluster=kubernetes \\ --user=kube-proxy \\ --kubeconfig=kube-proxy.kubeconfig kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig æ‰§è¡Œè„šæœ¬\n1 bash kubeconfig.sh 192.168.116.129 /root/k8s/k8s-cert/ æŠŠè¿™ä¸¤ä¸ªæ–‡ä»¶æ‹·è´åˆ°2ä¸ªNodeçš„/opt/kubernetes/cfg/\n1 2 scp bootstrap.kubeconfig kube-proxy.kubeconfig root@192.168.116.130:/opt/kubernetes/cfg/ scp bootstrap.kubeconfig kube-proxy.kubeconfig root@192.168.116.131:/opt/kubernetes/cfg/ 3. éƒ¨ç½²kubeletï¼Œkube-proxyç»„ä»¶\nä¸Šä¼ nodeåŒ…\næŠŠmatseré‡Œé¢çš„kubeletå’Œkube-poxyæ‹·è´è¿‡æ¥\n1 2 scp kubelet kube-proxy root@192.168.116.130:/opt/kubernetes/bin/ scp kubelet kube-proxy root@192.168.116.131:/opt/kubernetes/bin/ è¿è¡Œ kubelet.sh 1 bash kubelet.sh 192.168.116.130 MasterèŠ‚ç‚¹é¢å‘csr 1 kubectl get csr 1 kubectl certificate approve node-csr-96wka1dqU6bV1MMXD1nNUw14Av8NU6H6IW11ecJlYM0 è¿è¡Œproxy.sh\n1 bash proxy.sh 192.168.116.130 9. éƒ¨ç½²å¤šä¸ªNodeæ“ä½œ å¤åˆ¶ç²˜è´´Node1å·²ç»éƒ¨ç½²å¥½çš„æ–‡ä»¶\n1 scp -r /opt/kubernetes/ root@192.168.116.131:/opt/ 1 scp /usr/lib/systemd/system/{kubelet,kube-proxy}.service root@192.168.116.131:/usr/lib/systemd/system/ åˆ é™¤å¤åˆ¶è¿‡æ¥çš„è¯ä¹¦\nä¿®æ”¹Node2ä¸Šé…ç½®æ–‡ä»¶çš„IPåœ°å€\nä¿®æ”¹å®Œæ¯•ï¼Œé‡å¯å³å¯ã€‚\n1 2 3 [root@node2 cfg]# systemctl restart kubelet [root@node2 cfg]# systemctl restart kube-proxy [root@node2 cfg]# ps -ef | grep kube å»MasterèŠ‚ç‚¹é¢å‘è¯ä¹¦\n1 kubectl certificate approve node-csr-96wka1dqU6bV1MMXD1nNUw14Av8NU6H6IW11ecJlYM0 ","date":"2020-01-10T19:37:49Z","image":"https://www.ownit.top/title_pic/63.jpg","permalink":"https://www.ownit.top/p/202001101937/","title":"äºŒè¿›åˆ¶åŒ…å®‰è£…Kubernetesé›†ç¾¤ç¯å¢ƒå®Œæ•´ç‰ˆ"},{"content":"kubeadmæ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½²kubernetesé›†ç¾¤çš„å·¥å…·ã€‚\nè¿™ä¸ªå·¥å…·èƒ½é€šè¿‡ä¸¤æ¡æŒ‡ä»¤å®Œæˆä¸€ä¸ªkubernetesé›†ç¾¤çš„éƒ¨ç½²ï¼š\n1 2 3 4 5 # åˆ›å»ºä¸€ä¸ª Master èŠ‚ç‚¹ $ kubeadm init # å°†ä¸€ä¸ª Node èŠ‚ç‚¹åŠ å…¥åˆ°å½“å‰é›†ç¾¤ä¸­ $ kubeadm join \u0026lt;MasterèŠ‚ç‚¹çš„IPå’Œç«¯å£ \u0026gt; 1. å®‰è£…è¦æ±‚ åœ¨å¼€å§‹ä¹‹å‰ï¼Œéƒ¨ç½²Kubernetesé›†ç¾¤æœºå™¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š\nä¸€å°æˆ–å¤šå°æœºå™¨ï¼Œæ“ä½œç³»ç»Ÿ CentOS7.x-86_x64 ç¡¬ä»¶é…ç½®ï¼š2GBæˆ–æ›´å¤šRAMï¼Œ2ä¸ªCPUæˆ–æ›´å¤šCPUï¼Œç¡¬ç›˜30GBæˆ–æ›´å¤š é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¹‹é—´ç½‘ç»œäº’é€š å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒ ç¦æ­¢swapåˆ†åŒº ç¯å¢ƒï¼š masterÂ 192.168.116.129ã€æœ€ä½æ˜¯2æ ¸çš„ï¼Œä¸ç„¶å®‰è£…ä¼šä¿å­˜ã€‘\nnode1Â 192.168.116.130\nnode2Â 192.168.116.131\n2. å­¦ä¹ ç›®æ ‡ åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå®‰è£…Dockerå’Œkubeadm éƒ¨ç½²Kubernetes Master éƒ¨ç½²å®¹å™¨ç½‘ç»œæ’ä»¶ éƒ¨ç½² Kubernetes Nodeï¼Œå°†èŠ‚ç‚¹åŠ å…¥Kubernetesé›†ç¾¤ä¸­ éƒ¨ç½²Dashboard Webé¡µé¢ï¼Œå¯è§†åŒ–æŸ¥çœ‹Kubernetesèµ„æº 3. å‡†å¤‡ç¯å¢ƒ 1ã€å…³é—­é˜²ç«å¢™ï¼š\n1 2 systemctl stop firewalld systemctl disable firewalld 2ã€å…³é—­selinuxï¼š\n1 2 sed -i \u0026#39;s/enforcing/disabled/\u0026#39; /etc/selinux/config setenforce 0 3ã€å…³é—­swapï¼š\n1 2 swapoff -a # ä¸´æ—¶å…³é—­ sed -ri \u0026#39;s/.*swap.*/#\u0026amp;/\u0026#39; /etc/fstab #æ°¸ä¹…å…³é—­ 4ã€ä¿®æ”¹ä¸»æœºåç§°\n1 hostnamectl set-hostname åå­— 5ã€æ·»åŠ ä¸»æœºåä¸IPå¯¹åº”å…³ç³»ï¼ˆè®°å¾—è®¾ç½®ä¸»æœºåï¼‰ï¼š\n1 2 3 4 cat /etc/hosts 192.168.116.129 master 192.168.116.130 note1 192.168.116.131 note2 6ã€å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾\n1 2 3 4 cat \u0026gt; /etc/sysctl.d/k8s.conf \u0026lt;\u0026lt; EOF net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF 1 sysctl --system 4. æ‰€æœ‰èŠ‚ç‚¹å®‰è£…****Docker/kubeadm/kubelet xshellå¯ä»¥ä½¿ç”¨å‘é€é”®ç›˜æ‰€æœ‰ä¼šè¯æ¥å®‰è£…ã€‚æ¯”è¾ƒçœäº‹\nKubernetesé»˜è®¤CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰ä¸ºDockerï¼Œå› æ­¤å…ˆå®‰è£…Dockerã€‚\n1ã€å®‰è£…Docker å®‰è£…Dockeræº\n1 yum install -y wget \u0026amp;\u0026amp; wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo å®‰è£…Docker\n1 yum -y install docker-ce-18.06.1.ce-3.el7 å¼€å¯è‡ªå¯å’Œå¯åŠ¨\n1 systemctl enable docker \u0026amp;\u0026amp; systemctl start docker æŸ¥çœ‹ç‰ˆæœ¬\n1 docker --version 2ã€å®‰è£…kubeadmï¼Œkubeletå’Œ****kubectl 1ã€æ·»åŠ é˜¿é‡Œäº‘YUMçš„è½¯ä»¶æº\n1 2 3 4 5 6 7 8 9 cat \u0026gt; /etc/yum.repos.d/kubernetes.repo \u0026lt;\u0026lt; EOF [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF 2ã€å®‰è£…kubeadmï¼Œkubeletå’Œkubectl\nç”±äºç‰ˆæœ¬æ›´æ–°é¢‘ç¹ï¼Œè¿™é‡ŒæŒ‡å®šç‰ˆæœ¬å·éƒ¨ç½²ï¼š\n1 yum install -y kubelet-1.15.0 kubeadm-1.15.0 kubectl-1.15.0 è®¾ç½®å¼€æœºè‡ªå¯\n1 systemctl enable kubelet 5ã€éƒ¨ç½²Kubernetes Master åœ¨192.168.116.129ï¼ˆMasterï¼‰æ‰§è¡Œ\n1 2 3 4 5 6 kubeadm init \\ --apiserver-advertise-address=192.168.116.129 \\ --image-repository registry.aliyuncs.com/google_containers \\ --kubernetes-version v1.15.0 \\ --service-cidr=10.1.0.0/16 \\ --pod-network-cidr=10.244.0.0/16 ç”±äºé»˜è®¤æ‹‰å–é•œåƒåœ°å€k8s.gcr.ioå›½å†…æ— æ³•è®¿é—®ï¼Œè¿™é‡ŒæŒ‡å®šé˜¿é‡Œäº‘é•œåƒä»“åº“åœ°å€ã€‚\nå·²ç»åˆå§‹åŒ–å®Œæˆ\nä½¿ç”¨kubectlå·¥å…·ï¼š\n1 2 3 mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config 6. å®‰è£…Podç½‘ç»œæ’ä»¶ï¼ˆCNIï¼‰ 1 kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml ç¡®ä¿èƒ½å¤Ÿè®¿é—®åˆ°quay.ioè¿™ä¸ªregisteryã€‚\nå¦‚æœä¸‹è½½å¤±è´¥ï¼Œå¯ä»¥æ”¹æˆè¿™ä¸ªé•œåƒåœ°å€ï¼šlizhenliang/flannel:v0.11.0-amd64\nä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘ç»™é…ç½®æ–‡ä»¶Â https://www.lanzous.com/i8jjpij\nè¿™é‡Œï¼Œæˆ‘æ˜¯ç”¨çš„æ˜¯æˆ‘çš„é…ç½®æ–‡ä»¶ã€‚\n1 kubectl apply -f kube-flannel.yml 7. åŠ å…¥****Kubernetes Node åœ¨nodeä¸Šå®‰è£…flannel\n1 docker pull lizhenliang/flannel:v0.11.0-amd64 åœ¨192.168.116.130ï¼ˆNodeï¼‰æ‰§è¡Œã€‚\nå‘é›†ç¾¤æ·»åŠ æ–°èŠ‚ç‚¹ï¼Œæ‰§è¡Œåœ¨kubeadm initè¾“å‡ºçš„kubeadm joinå‘½ä»¤ï¼š\n1 2 kubeadm join 192.168.116.129:6443 --token iz96vy.f5ukew9geeome5is \\ --discovery-token-ca-cert-hash sha256:72b689426bfc34512294c29b39ea3b2af3a94e39f62c4434f3a49f16d51a1382 æŸ¥çœ‹Node\n1 kubectl get node æ·»åŠ ä¸€ä¸‹node2ï¼Œå‘½ä»¤å¦‚ä¸Šã€‚åˆ‡è®°ï¼Œå…ˆæ‰§è¡Œåœ¨nodeä¸Šå®‰è£…flannel\nå·²ç»å®Œå…¨å‡†å¤‡å®Œæˆã€‚\n1 kubectl get pods -n kube-system 8. æµ‹è¯•kubernetesé›†ç¾¤ åœ¨Kubernetesé›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªpodï¼ŒéªŒè¯æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š\nåˆ›å»ºnginxå®¹å™¨\n1 kubectl create deployment nginx --image=nginx æš´éœ²å¯¹å¤–ç«¯å£\n1 kubectl expose deployment nginx --port=80 --type=NodePort æŸ¥çœ‹nginxæ˜¯å¦è¿è¡ŒæˆåŠŸ\n1 kubectl get pod,svc åœ¨æµè§ˆå™¨è®¿é—®ã€‚ä¸‰ä¸ªç»“ç‚¹éƒ½å¯è®¿é—®ï¼Œè¯´æ˜é›†ç¾¤å·²ç»æ­å»ºå®Œæˆï¼Œ\næ‰©å®¹nginxå‰¯æœ¬wei3ä¸ªï¼ŒæˆåŠŸ\n1 kubectl scale deployment nginx --replicas=3 1 kubectl get pods 9. éƒ¨ç½² Dashboard å…ˆå‰å·²ç»ç»™é…ç½®é…ç½®æ–‡ä»¶ã€‚\nä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘ç»™é…ç½®æ–‡ä»¶Â https://www.lanzous.com/i8jjpij\né»˜è®¤é•œåƒå›½å†…æ— æ³•è®¿é—®ï¼Œä¿®æ”¹é•œåƒåœ°å€ä¸ºï¼š lizhenliang/kubernetes-dashboard-amd64:v1.10.1\né»˜è®¤Dashboardåªèƒ½é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œä¿®æ”¹Serviceä¸ºNodePortç±»å‹ï¼Œæš´éœ²åˆ°å¤–éƒ¨ï¼š\nå…ˆDockeræ‹‰å»é•œåƒ\n1 docker pull lizhenliang/kubernetes-dashboard-amd64:v1.10.1 æ‰§è¡Œkubernetes-dashboard.yaml æ–‡ä»¶\n1 kubectl apply -f kubernetes-dashboard.yaml å®‰è£…æˆåŠŸ\næŸ¥çœ‹æš´éœ²çš„ç«¯å£\n1 kubectl get pods,svc -n kube-system 10. è®¿é—® Dashboardçš„webç•Œé¢ è®¿é—®åœ°å€ï¼šhttps://NodeIP:30001Â ã€å¿…é¡»æ˜¯httpsã€‘\nåˆ›å»ºservice accountå¹¶ç»‘å®šé»˜è®¤cluster-adminç®¡ç†å‘˜é›†ç¾¤è§’è‰²ï¼šã€ä¾æ¬¡æ‰§è¡Œã€‘\n1 kubectl create serviceaccount dashboard-admin -n kube-system 1 kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin 1 kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk \u0026#39;/dashboard-admin/{print $1}\u0026#39;) å·²ç»éƒ¨ç½²å®Œæˆã€‚\n","date":"2020-01-08T16:49:12Z","image":"https://www.ownit.top/title_pic/06.jpg","permalink":"https://www.ownit.top/p/202001081649/","title":"kubeadméƒ¨ç½²Kubernetesï¼ˆk8sï¼‰å®Œæ•´ç‰ˆè¯¦ç»†æ•™ç¨‹"},{"content":"æœ¬åœ°é•œåƒå‘å¸ƒåˆ°é˜¿é‡Œäº‘æµç¨‹ é•œåƒçš„ç”Ÿæˆæ–¹æ³• 1ã€å‰é¢çš„DockerFile\n2ã€ä»å®¹å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ\n1 docker commit [OPTIONS] å®¹å™¨ID [REPOSITORY[:TAG]] OPTIONSè¯´æ˜ï¼š\n-a :æäº¤çš„é•œåƒä½œè€…ï¼›\n-m :æäº¤æ—¶çš„è¯´æ˜æ–‡å­—ï¼›\nå°†æœ¬åœ°é•œåƒæ¨é€åˆ°é˜¿é‡Œäº‘ æœ¬åœ°é•œåƒç´ æåŸå‹\né˜¿é‡Œäº‘å¼€å‘è€…å¹³å°\nhttps://dev.aliyun.com/search.html\nåˆ›å»ºä»“åº“é•œåƒ\nå‘½åç©ºé—´ ä»“åº“åç§° å°†é•œåƒæ¨é€åˆ°registry\nå…¬æœ‰äº‘å¯ä»¥æŸ¥è¯¢åˆ°\næŸ¥çœ‹è¯¦æƒ…\nå°†é˜¿é‡Œäº‘ä¸Šçš„é•œåƒä¸‹è½½åˆ°æœ¬åœ°\n","date":"2020-01-04T10:04:42Z","image":"https://www.ownit.top/title_pic/01.jpg","permalink":"https://www.ownit.top/p/202001041004/","title":"æœ¬åœ°é•œåƒå‘å¸ƒåˆ°é˜¿é‡Œäº‘"},{"content":"ç›®å½•\næ€»ä½“æ­¥éª¤\nå®‰è£…tomcat\nå®‰è£…mysql\nå®‰è£…redis\næ€»ä½“æ­¥éª¤ 1ã€æœç´¢é•œåƒ 2ã€æ‹‰å–é•œåƒ 3ã€æŸ¥çœ‹é•œåƒ 4ã€å¯åŠ¨é•œåƒ 5ã€åœæ­¢å®¹å™¨ 6ã€ç§»é™¤å®¹å™¨ å®‰è£…tomcat docker hubä¸Šé¢æŸ¥æ‰¾tomcaté•œåƒ\n1 docker search tomcat ä»docker hubä¸Šæ‹‰å–tomcaté•œåƒåˆ°æœ¬åœ°\n1 docker pull tomcat docker imagesæŸ¥çœ‹æ˜¯å¦æœ‰æ‹‰å–åˆ°çš„tomcat\nä½¿ç”¨tomcaté•œåƒåˆ›å»ºå®¹å™¨(ä¹Ÿå«è¿è¡Œé•œåƒ)\n1 docker run -it -p 8080:8080 tomcat -p ä¸»æœºç«¯å£:dockerå®¹å™¨ç«¯å£ -P éšæœºåˆ†é…ç«¯å£ i:äº¤äº’ t:ç»ˆç«¯ å®‰è£…mysql docker hubä¸Šé¢æŸ¥æ‰¾mysqlé•œåƒ\n1 docker search mysql ä»docker hubä¸Š(é˜¿é‡Œäº‘åŠ é€Ÿå™¨)æ‹‰å–mysqlé•œåƒåˆ°æœ¬åœ°æ ‡ç­¾ä¸º5.6\n1 docker pull mysql:5.6 ä½¿ç”¨mysql5.6é•œåƒåˆ›å»ºå®¹å™¨(ä¹Ÿå«è¿è¡Œé•œåƒ)\n1 docker run -p 12345:3306 --name mysql -v /zzyyuse/mysql/conf:/etc/mysql/conf.d -v /zzyyuse/mysql/logs:/logs -v /zzyyuse/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.6 å‘½ä»¤è¯´æ˜ï¼š\n-p 12345:3306ï¼šå°†ä¸»æœºçš„12345ç«¯å£æ˜ å°„åˆ°dockerå®¹å™¨çš„3306ç«¯å£ã€‚\n--name mysqlï¼šè¿è¡ŒæœåŠ¡åå­—\n-v /zzyyuse/mysql/conf:/etc/mysql/conf.d ï¼šå°†ä¸»æœº/zzyyuse/mysqlå½•ä¸‹çš„conf/my.cnf æŒ‚è½½åˆ°å®¹å™¨çš„ /etc/mysql/conf.d\n-v /zzyyuse/mysql/logs:/logsï¼šå°†ä¸»æœº/zzyyuse/mysqlç›®å½•ä¸‹çš„ logs ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„ /logsã€‚\n-v /zzyyuse/mysql/data:/var/lib/mysql ï¼šå°†ä¸»æœº/zzyyuse/mysqlç›®å½•ä¸‹çš„dataç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„ /var/lib/mysqlÂ -e MYSQL_ROOT_PASSWORD=123456ï¼šåˆå§‹åŒ– root ç”¨æˆ·çš„å¯†ç ã€‚\n-d mysql:5.6 : åå°ç¨‹åºè¿è¡Œmysql5.6\n1 docker exec -it MySQLè¿è¡ŒæˆåŠŸåçš„å®¹å™¨ID /bin/bash å¤–éƒ¨Win10ä¹Ÿæ¥è¿æ¥è¿è¡Œåœ¨dokcerä¸Šçš„mysqlæœåŠ¡\næ•°æ®å¤‡ä»½å°æµ‹è¯•\n1 docker exec myqlæœåŠ¡å®¹å™¨ID sh -c \u0026#39; exec mysqldump --all-databases -uroot -p\u0026#34;123456\u0026#34; \u0026#39; \u0026gt; /zzyyuse/all-databases.sql å®‰è£…redis hubä¸Š(é˜¿é‡Œäº‘åŠ é€Ÿå™¨)æ‹‰å–redisé•œåƒåˆ°æœ¬åœ°æ ‡ç­¾ä¸º3.2\n1 docker pull redis:3.2 ä½¿ç”¨redis3.2é•œåƒåˆ›å»ºå®¹å™¨(ä¹Ÿå«è¿è¡Œé•œåƒ)\nä½¿ç”¨é•œåƒ\n1 docker run -p 6379:6379 -v /zzyyuse/myredis/data:/data -v /zzyyuse/myredis/conf/redis.conf:/usr/local/etc/redis/redis.conf -d redis:3.2 redis-server /usr/local/etc/redis/redis.conf --appendonly yes åœ¨ä¸»æœº/zzyyuse/myredis/conf/redis.confç›®å½•ä¸‹æ–°å»ºredis.confæ–‡ä»¶\n1 vim /zzyyuse/myredis/conf/redis.conf/redis.conf 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 833 834 835 836 837 838 839 840 841 842 843 844 845 846 847 848 849 850 851 852 853 854 855 856 857 858 859 860 861 862 863 864 865 866 867 868 869 870 871 872 873 874 875 876 877 878 879 880 881 882 883 884 885 886 887 888 889 890 891 892 893 894 895 896 897 898 899 900 901 902 903 904 905 906 907 908 909 910 911 912 913 914 915 916 917 918 919 920 921 922 923 924 925 926 927 928 929 930 931 932 933 934 935 936 937 938 939 940 941 942 943 944 945 946 947 948 949 950 951 952 953 954 955 956 957 958 959 960 961 962 963 964 965 966 967 968 969 970 971 972 973 974 975 976 977 978 979 980 981 982 983 984 985 986 987 988 989 990 991 992 993 994 995 996 997 998 999 1000 1001 1002 1003 1004 1005 1006 1007 1008 1009 1010 1011 1012 1013 1014 1015 1016 1017 1018 1019 1020 1021 1022 1023 1024 1025 1026 1027 1028 1029 1030 1031 1032 1033 1034 1035 1036 1037 1038 1039 1040 1041 1042 1043 1044 1045 1046 1047 1048 1049 1050 1051 # Redis configuration file example. # # Note that in order to read the configuration file, Redis must be # started with the file path as first argument: # # ./redis-server /path/to/redis.conf # Note on units: when memory size is needed, it is possible to specify # it in the usual form of 1k 5GB 4M and so forth: # # 1k =\u0026gt; 1000 bytes # 1kb =\u0026gt; 1024 bytes # 1m =\u0026gt; 1000000 bytes # 1mb =\u0026gt; 1024*1024 bytes # 1g =\u0026gt; 1000000000 bytes # 1gb =\u0026gt; 1024*1024*1024 bytes # # units are case insensitive so 1GB 1Gb 1gB are all the same. ################################## INCLUDES ################################### # Include one or more other config files here. This is useful if you # have a standard template that goes to all Redis servers but also need # to customize a few per-server settings. Include files can include # other files, so use this wisely. # # Notice option \u0026#34;include\u0026#34; won\u0026#39;t be rewritten by command \u0026#34;CONFIG REWRITE\u0026#34; # from admin or Redis Sentinel. Since Redis always uses the last processed # line as value of a configuration directive, you\u0026#39;d better put includes # at the beginning of this file to avoid overwriting config change at runtime. # # If instead you are interested in using includes to override configuration # options, it is better to use include as the last line. # # include /path/to/local.conf # include /path/to/other.conf ################################## NETWORK ##################################### # By default, if no \u0026#34;bind\u0026#34; configuration directive is specified, Redis listens # for connections from all the network interfaces available on the server. # It is possible to listen to just one or multiple selected interfaces using # the \u0026#34;bind\u0026#34; configuration directive, followed by one or more IP addresses. # # Examples: # # bind 192.168.1.100 10.0.0.1 # bind 127.0.0.1 ::1 # # ~~~ WARNING ~~~ If the computer running Redis is directly exposed to the # internet, binding to all the interfaces is dangerous and will expose the # instance to everybody on the internet. So by default we uncomment the # following bind directive, that will force Redis to listen only into # the IPv4 lookback interface address (this means Redis will be able to # accept connections only from clients running into the same computer it # is running). # # IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES # JUST COMMENT THE FOLLOWING LINE. # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #bind 127.0.0.1 # Protected mode is a layer of security protection, in order to avoid that # Redis instances left open on the internet are accessed and exploited. # # When protected mode is on and if: # # 1) The server is not binding explicitly to a set of addresses using the # \u0026#34;bind\u0026#34; directive. # 2) No password is configured. # # The server only accepts connections from clients connecting from the # IPv4 and IPv6 loopback addresses 127.0.0.1 and ::1, and from Unix domain # sockets. # # By default protected mode is enabled. You should disable it only if # you are sure you want clients from other hosts to connect to Redis # even if no authentication is configured, nor a specific set of interfaces # are explicitly listed using the \u0026#34;bind\u0026#34; directive. protected-mode yes # Accept connections on the specified port, default is 6379 (IANA #815344). # If port 0 is specified Redis will not listen on a TCP socket. port 6379 # TCP listen() backlog. # # In high requests-per-second environments you need an high backlog in order # to avoid slow clients connections issues. Note that the Linux kernel # will silently truncate it to the value of /proc/sys/net/core/somaxconn so # make sure to raise both the value of somaxconn and tcp_max_syn_backlog # in order to get the desired effect. tcp-backlog 511 # Unix socket. # # Specify the path for the Unix socket that will be used to listen for # incoming connections. There is no default, so Redis will not listen # on a unix socket when not specified. # # unixsocket /tmp/redis.sock # unixsocketperm 700 # Close the connection after a client is idle for N seconds (0 to disable) timeout 0 # TCP keepalive. # # If non-zero, use SO_KEEPALIVE to send TCP ACKs to clients in absence # of communication. This is useful for two reasons: # # 1) Detect dead peers. # 2) Take the connection alive from the point of view of network # equipment in the middle. # # On Linux, the specified value (in seconds) is the period used to send ACKs. # Note that to close the connection the double of the time is needed. # On other kernels the period depends on the kernel configuration. # # A reasonable value for this option is 300 seconds, which is the new # Redis default starting with Redis 3.2.1. tcp-keepalive 300 ################################# GENERAL ##################################### # By default Redis does not run as a daemon. Use \u0026#39;yes\u0026#39; if you need it. # Note that Redis will write a pid file in /var/run/redis.pid when daemonized. #daemonize no # If you run Redis from upstart or systemd, Redis can interact with your # supervision tree. Options: # supervised no - no supervision interaction # supervised upstart - signal upstart by putting Redis into SIGSTOP mode # supervised systemd - signal systemd by writing READY=1 to $NOTIFY_SOCKET # supervised auto - detect upstart or systemd method based on # UPSTART_JOB or NOTIFY_SOCKET environment variables # Note: these supervision methods only signal \u0026#34;process is ready.\u0026#34; # They do not enable continuous liveness pings back to your supervisor. supervised no # If a pid file is specified, Redis writes it where specified at startup # and removes it at exit. # # When the server runs non daemonized, no pid file is created if none is # specified in the configuration. When the server is daemonized, the pid file # is used even if not specified, defaulting to \u0026#34;/var/run/redis.pid\u0026#34;. # # Creating a pid file is best effort: if Redis is not able to create it # nothing bad happens, the server will start and run normally. pidfile /var/run/redis_6379.pid # Specify the server verbosity level. # This can be one of: # debug (a lot of information, useful for development/testing) # verbose (many rarely useful info, but not a mess like the debug level) # notice (moderately verbose, what you want in production probably) # warning (only very important / critical messages are logged) loglevel notice # Specify the log file name. Also the empty string can be used to force # Redis to log on the standard output. Note that if you use standard # output for logging but daemonize, logs will be sent to /dev/null logfile \u0026#34;\u0026#34; # To enable logging to the system logger, just set \u0026#39;syslog-enabled\u0026#39; to yes, # and optionally update the other syslog parameters to suit your needs. # syslog-enabled no # Specify the syslog identity. # syslog-ident redis # Specify the syslog facility. Must be USER or between LOCAL0-LOCAL7. # syslog-facility local0 # Set the number of databases. The default database is DB 0, you can select # a different one on a per-connection basis using SELECT \u0026lt;dbid\u0026gt; where # dbid is a number between 0 and \u0026#39;databases\u0026#39;-1 databases 16 ################################ SNAPSHOTTING ################################ # # Save the DB on disk: # # save \u0026lt;seconds\u0026gt; \u0026lt;changes\u0026gt; # # Will save the DB if both the given number of seconds and the given # number of write operations against the DB occurred. # # In the example below the behaviour will be to save: # after 900 sec (15 min) if at least 1 key changed # after 300 sec (5 min) if at least 10 keys changed # after 60 sec if at least 10000 keys changed # # Note: you can disable saving completely by commenting out all \u0026#34;save\u0026#34; lines. # # It is also possible to remove all the previously configured save # points by adding a save directive with a single empty string argument # like in the following example: # # save \u0026#34;\u0026#34; save 120 1 save 300 10 save 60 10000 # By default Redis will stop accepting writes if RDB snapshots are enabled # (at least one save point) and the latest background save failed. # This will make the user aware (in a hard way) that data is not persisting # on disk properly, otherwise chances are that no one will notice and some # disaster will happen. # # If the background saving process will start working again Redis will # automatically allow writes again. # # However if you have setup your proper monitoring of the Redis server # and persistence, you may want to disable this feature so that Redis will # continue to work as usual even if there are problems with disk, # permissions, and so forth. stop-writes-on-bgsave-error yes # Compress string objects using LZF when dump .rdb databases? # For default that\u0026#39;s set to \u0026#39;yes\u0026#39; as it\u0026#39;s almost always a win. # If you want to save some CPU in the saving child set it to \u0026#39;no\u0026#39; but # the dataset will likely be bigger if you have compressible values or keys. rdbcompression yes # Since version 5 of RDB a CRC64 checksum is placed at the end of the file. # This makes the format more resistant to corruption but there is a performance # hit to pay (around 10%) when saving and loading RDB files, so you can disable it # for maximum performances. # # RDB files created with checksum disabled have a checksum of zero that will # tell the loading code to skip the check. rdbchecksum yes # The filename where to dump the DB dbfilename dump.rdb # The working directory. # # The DB will be written inside this directory, with the filename specified # above using the \u0026#39;dbfilename\u0026#39; configuration directive. # # The Append Only File will also be created inside this directory. # # Note that you must specify a directory here, not a file name. dir ./ ################################# REPLICATION ################################# # Master-Slave replication. Use slaveof to make a Redis instance a copy of # another Redis server. A few things to understand ASAP about Redis replication. # # 1) Redis replication is asynchronous, but you can configure a master to # stop accepting writes if it appears to be not connected with at least # a given number of slaves. # 2) Redis slaves are able to perform a partial resynchronization with the # master if the replication link is lost for a relatively small amount of # time. You may want to configure the replication backlog size (see the next # sections of this file) with a sensible value depending on your needs. # 3) Replication is automatic and does not need user intervention. After a # network partition slaves automatically try to reconnect to masters # and resynchronize with them. # # slaveof \u0026lt;masterip\u0026gt; \u0026lt;masterport\u0026gt; # If the master is password protected (using the \u0026#34;requirepass\u0026#34; configuration # directive below) it is possible to tell the slave to authenticate before # starting the replication synchronization process, otherwise the master will # refuse the slave request. # # masterauth \u0026lt;master-password\u0026gt; # When a slave loses its connection with the master, or when the replication # is still in progress, the slave can act in two different ways: # # 1) if slave-serve-stale-data is set to \u0026#39;yes\u0026#39; (the default) the slave will # still reply to client requests, possibly with out of date data, or the # data set may just be empty if this is the first synchronization. # # 2) if slave-serve-stale-data is set to \u0026#39;no\u0026#39; the slave will reply with # an error \u0026#34;SYNC with master in progress\u0026#34; to all the kind of commands # but to INFO and SLAVEOF. # slave-serve-stale-data yes # You can configure a slave instance to accept writes or not. Writing against # a slave instance may be useful to store some ephemeral data (because data # written on a slave will be easily deleted after resync with the master) but # may also cause problems if clients are writing to it because of a # misconfiguration. # # Since Redis 2.6 by default slaves are read-only. # # Note: read only slaves are not designed to be exposed to untrusted clients # on the internet. It\u0026#39;s just a protection layer against misuse of the instance. # Still a read only slave exports by default all the administrative commands # such as CONFIG, DEBUG, and so forth. To a limited extent you can improve # security of read only slaves using \u0026#39;rename-command\u0026#39; to shadow all the # administrative / dangerous commands. slave-read-only yes # Replication SYNC strategy: disk or socket. # # ------------------------------------------------------- # WARNING: DISKLESS REPLICATION IS EXPERIMENTAL CURRENTLY # ------------------------------------------------------- # # New slaves and reconnecting slaves that are not able to continue the replication # process just receiving differences, need to do what is called a \u0026#34;full # synchronization\u0026#34;. An RDB file is transmitted from the master to the slaves. # The transmission can happen in two different ways: # # 1) Disk-backed: The Redis master creates a new process that writes the RDB # file on disk. Later the file is transferred by the parent # process to the slaves incrementally. # 2) Diskless: The Redis master creates a new process that directly writes the # RDB file to slave sockets, without touching the disk at all. # # With disk-backed replication, while the RDB file is generated, more slaves # can be queued and served with the RDB file as soon as the current child producing # the RDB file finishes its work. With diskless replication instead once # the transfer starts, new slaves arriving will be queued and a new transfer # will start when the current one terminates. # # When diskless replication is used, the master waits a configurable amount of # time (in seconds) before starting the transfer in the hope that multiple slaves # will arrive and the transfer can be parallelized. # # With slow disks and fast (large bandwidth) networks, diskless replication # works better. repl-diskless-sync no # When diskless replication is enabled, it is possible to configure the delay # the server waits in order to spawn the child that transfers the RDB via socket # to the slaves. # # This is important since once the transfer starts, it is not possible to serve # new slaves arriving, that will be queued for the next RDB transfer, so the server # waits a delay in order to let more slaves arrive. # # The delay is specified in seconds, and by default is 5 seconds. To disable # it entirely just set it to 0 seconds and the transfer will start ASAP. repl-diskless-sync-delay 5 # Slaves send PINGs to server in a predefined interval. It\u0026#39;s possible to change # this interval with the repl_ping_slave_period option. The default value is 10 # seconds. # # repl-ping-slave-period 10 # The following option sets the replication timeout for: # # 1) Bulk transfer I/O during SYNC, from the point of view of slave. # 2) Master timeout from the point of view of slaves (data, pings). # 3) Slave timeout from the point of view of masters (REPLCONF ACK pings). # # It is important to make sure that this value is greater than the value # specified for repl-ping-slave-period otherwise a timeout will be detected # every time there is low traffic between the master and the slave. # # repl-timeout 60 # Disable TCP_NODELAY on the slave socket after SYNC? # # If you select \u0026#34;yes\u0026#34; Redis will use a smaller number of TCP packets and # less bandwidth to send data to slaves. But this can add a delay for # the data to appear on the slave side, up to 40 milliseconds with # Linux kernels using a default configuration. # # If you select \u0026#34;no\u0026#34; the delay for data to appear on the slave side will # be reduced but more bandwidth will be used for replication. # # By default we optimize for low latency, but in very high traffic conditions # or when the master and slaves are many hops away, turning this to \u0026#34;yes\u0026#34; may # be a good idea. repl-disable-tcp-nodelay no # Set the replication backlog size. The backlog is a buffer that accumulates # slave data when slaves are disconnected for some time, so that when a slave # wants to reconnect again, often a full resync is not needed, but a partial # resync is enough, just passing the portion of data the slave missed while # disconnected. # # The bigger the replication backlog, the longer the time the slave can be # disconnected and later be able to perform a partial resynchronization. # # The backlog is only allocated once there is at least a slave connected. # # repl-backlog-size 1mb # After a master has no longer connected slaves for some time, the backlog # will be freed. The following option configures the amount of seconds that # need to elapse, starting from the time the last slave disconnected, for # the backlog buffer to be freed. # # A value of 0 means to never release the backlog. # # repl-backlog-ttl 3600 # The slave priority is an integer number published by Redis in the INFO output. # It is used by Redis Sentinel in order to select a slave to promote into a # master if the master is no longer working correctly. # # A slave with a low priority number is considered better for promotion, so # for instance if there are three slaves with priority 10, 100, 25 Sentinel will # pick the one with priority 10, that is the lowest. # # However a special priority of 0 marks the slave as not able to perform the # role of master, so a slave with priority of 0 will never be selected by # Redis Sentinel for promotion. # # By default the priority is 100. slave-priority 100 # It is possible for a master to stop accepting writes if there are less than # N slaves connected, having a lag less or equal than M seconds. # # The N slaves need to be in \u0026#34;online\u0026#34; state. # # The lag in seconds, that must be \u0026lt;= the specified value, is calculated from # the last ping received from the slave, that is usually sent every second. # # This option does not GUARANTEE that N replicas will accept the write, but # will limit the window of exposure for lost writes in case not enough slaves # are available, to the specified number of seconds. # # For example to require at least 3 slaves with a lag \u0026lt;= 10 seconds use: # # min-slaves-to-write 3 # min-slaves-max-lag 10 # # Setting one or the other to 0 disables the feature. # # By default min-slaves-to-write is set to 0 (feature disabled) and # min-slaves-max-lag is set to 10. # A Redis master is able to list the address and port of the attached # slaves in different ways. For example the \u0026#34;INFO replication\u0026#34; section # offers this information, which is used, among other tools, by # Redis Sentinel in order to discover slave instances. # Another place where this info is available is in the output of the # \u0026#34;ROLE\u0026#34; command of a masteer. # # The listed IP and address normally reported by a slave is obtained # in the following way: # # IP: The address is auto detected by checking the peer address # of the socket used by the slave to connect with the master. # # Port: The port is communicated by the slave during the replication # handshake, and is normally the port that the slave is using to # list for connections. # # However when port forwarding or Network Address Translation (NAT) is # used, the slave may be actually reachable via different IP and port # pairs. The following two options can be used by a slave in order to # report to its master a specific set of IP and port, so that both INFO # and ROLE will report those values. # # There is no need to use both the options if you need to override just # the port or the IP address. # # slave-announce-ip 5.5.5.5 # slave-announce-port 1234 ################################## SECURITY ################################### # Require clients to issue AUTH \u0026lt;PASSWORD\u0026gt; before processing any other # commands. This might be useful in environments in which you do not trust # others with access to the host running redis-server. # # This should stay commented out for backward compatibility and because most # people do not need auth (e.g. they run their own servers). # # Warning: since Redis is pretty fast an outside user can try up to # 150k passwords per second against a good box. This means that you should # use a very strong password otherwise it will be very easy to break. # # requirepass foobared # Command renaming. # # It is possible to change the name of dangerous commands in a shared # environment. For instance the CONFIG command may be renamed into something # hard to guess so that it will still be available for internal-use tools # but not available for general clients. # # Example: # # rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52 # # It is also possible to completely kill a command by renaming it into # an empty string: # # rename-command CONFIG \u0026#34;\u0026#34; # # Please note that changing the name of commands that are logged into the # AOF file or transmitted to slaves may cause problems. ################################### LIMITS #################################### # Set the max number of connected clients at the same time. By default # this limit is set to 10000 clients, however if the Redis server is not # able to configure the process file limit to allow for the specified limit # the max number of allowed clients is set to the current file limit # minus 32 (as Redis reserves a few file descriptors for internal uses). # # Once the limit is reached Redis will close all the new connections sending # an error \u0026#39;max number of clients reached\u0026#39;. # # maxclients 10000 # Don\u0026#39;t use more memory than the specified amount of bytes. # When the memory limit is reached Redis will try to remove keys # according to the eviction policy selected (see maxmemory-policy). # # If Redis can\u0026#39;t remove keys according to the policy, or if the policy is # set to \u0026#39;noeviction\u0026#39;, Redis will start to reply with errors to commands # that would use more memory, like SET, LPUSH, and so on, and will continue # to reply to read-only commands like GET. # # This option is usually useful when using Redis as an LRU cache, or to set # a hard memory limit for an instance (using the \u0026#39;noeviction\u0026#39; policy). # # WARNING: If you have slaves attached to an instance with maxmemory on, # the size of the output buffers needed to feed the slaves are subtracted # from the used memory count, so that network problems / resyncs will # not trigger a loop where keys are evicted, and in turn the output # buffer of slaves is full with DELs of keys evicted triggering the deletion # of more keys, and so forth until the database is completely emptied. # # In short... if you have slaves attached it is suggested that you set a lower # limit for maxmemory so that there is some free RAM on the system for slave # output buffers (but this is not needed if the policy is \u0026#39;noeviction\u0026#39;). # # maxmemory \u0026lt;bytes\u0026gt; # MAXMEMORY POLICY: how Redis will select what to remove when maxmemory # is reached. You can select among five behaviors: # # volatile-lru -\u0026gt; remove the key with an expire set using an LRU algorithm # allkeys-lru -\u0026gt; remove any key according to the LRU algorithm # volatile-random -\u0026gt; remove a random key with an expire set # allkeys-random -\u0026gt; remove a random key, any key # volatile-ttl -\u0026gt; remove the key with the nearest expire time (minor TTL) # noeviction -\u0026gt; don\u0026#39;t expire at all, just return an error on write operations # # Note: with any of the above policies, Redis will return an error on write # operations, when there are no suitable keys for eviction. # # At the date of writing these commands are: set setnx setex append # incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd # sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby # zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby # getset mset msetnx exec sort # # The default is: # # maxmemory-policy noeviction # LRU and minimal TTL algorithms are not precise algorithms but approximated # algorithms (in order to save memory), so you can tune it for speed or # accuracy. For default Redis will check five keys and pick the one that was # used less recently, you can change the sample size using the following # configuration directive. # # The default of 5 produces good enough results. 10 Approximates very closely # true LRU but costs a bit more CPU. 3 is very fast but not very accurate. # # maxmemory-samples 5 ############################## APPEND ONLY MODE ############################### # By default Redis asynchronously dumps the dataset on disk. This mode is # good enough in many applications, but an issue with the Redis process or # a power outage may result into a few minutes of writes lost (depending on # the configured save points). # # The Append Only File is an alternative persistence mode that provides # much better durability. For instance using the default data fsync policy # (see later in the config file) Redis can lose just one second of writes in a # dramatic event like a server power outage, or a single write if something # wrong with the Redis process itself happens, but the operating system is # still running correctly. # # AOF and RDB persistence can be enabled at the same time without problems. # If the AOF is enabled on startup Redis will load the AOF, that is the file # with the better durability guarantees. # # Please check http://redis.io/topics/persistence for more information. appendonly no # The name of the append only file (default: \u0026#34;appendonly.aof\u0026#34;) appendfilename \u0026#34;appendonly.aof\u0026#34; # The fsync() call tells the Operating System to actually write data on disk # instead of waiting for more data in the output buffer. Some OS will really flush # data on disk, some other OS will just try to do it ASAP. # # Redis supports three different modes: # # no: don\u0026#39;t fsync, just let the OS flush the data when it wants. Faster. # always: fsync after every write to the append only log. Slow, Safest. # everysec: fsync only one time every second. Compromise. # # The default is \u0026#34;everysec\u0026#34;, as that\u0026#39;s usually the right compromise between # speed and data safety. It\u0026#39;s up to you to understand if you can relax this to # \u0026#34;no\u0026#34; that will let the operating system flush the output buffer when # it wants, for better performances (but if you can live with the idea of # some data loss consider the default persistence mode that\u0026#39;s snapshotting), # or on the contrary, use \u0026#34;always\u0026#34; that\u0026#39;s very slow but a bit safer than # everysec. # # More details please check the following article: # http://antirez.com/post/redis-persistence-demystified.html # # If unsure, use \u0026#34;everysec\u0026#34;. # appendfsync always appendfsync everysec # appendfsync no # When the AOF fsync policy is set to always or everysec, and a background # saving process (a background save or AOF log background rewriting) is # performing a lot of I/O against the disk, in some Linux configurations # Redis may block too long on the fsync() call. Note that there is no fix for # this currently, as even performing fsync in a different thread will block # our synchronous write(2) call. # # In order to mitigate this problem it\u0026#39;s possible to use the following option # that will prevent fsync() from being called in the main process while a # BGSAVE or BGREWRITEAOF is in progress. # # This means that while another child is saving, the durability of Redis is # the same as \u0026#34;appendfsync none\u0026#34;. In practical terms, this means that it is # possible to lose up to 30 seconds of log in the worst scenario (with the # default Linux settings). # # If you have latency problems turn this to \u0026#34;yes\u0026#34;. Otherwise leave it as # \u0026#34;no\u0026#34; that is the safest pick from the point of view of durability. no-appendfsync-on-rewrite no # Automatic rewrite of the append only file. # Redis is able to automatically rewrite the log file implicitly calling # BGREWRITEAOF when the AOF log size grows by the specified percentage. # # This is how it works: Redis remembers the size of the AOF file after the # latest rewrite (if no rewrite has happened since the restart, the size of # the AOF at startup is used). # # This base size is compared to the current size. If the current size is # bigger than the specified percentage, the rewrite is triggered. Also # you need to specify a minimal size for the AOF file to be rewritten, this # is useful to avoid rewriting the AOF file even if the percentage increase # is reached but it is still pretty small. # # Specify a percentage of zero in order to disable the automatic AOF # rewrite feature. auto-aof-rewrite-percentage 100 auto-aof-rewrite-min-size 64mb # An AOF file may be found to be truncated at the end during the Redis # startup process, when the AOF data gets loaded back into memory. # This may happen when the system where Redis is running # crashes, especially when an ext4 filesystem is mounted without the # data=ordered option (however this can\u0026#39;t happen when Redis itself # crashes or aborts but the operating system still works correctly). # # Redis can either exit with an error when this happens, or load as much # data as possible (the default now) and start if the AOF file is found # to be truncated at the end. The following option controls this behavior. # # If aof-load-truncated is set to yes, a truncated AOF file is loaded and # the Redis server starts emitting a log to inform the user of the event. # Otherwise if the option is set to no, the server aborts with an error # and refuses to start. When the option is set to no, the user requires # to fix the AOF file using the \u0026#34;redis-check-aof\u0026#34; utility before to restart # the server. # # Note that if the AOF file will be found to be corrupted in the middle # the server will still exit with an error. This option only applies when # Redis will try to read more data from the AOF file but not enough bytes # will be found. aof-load-truncated yes ################################ LUA SCRIPTING ############################### # Max execution time of a Lua script in milliseconds. # # If the maximum execution time is reached Redis will log that a script is # still in execution after the maximum allowed time and will start to # reply to queries with an error. # # When a long running script exceeds the maximum execution time only the # SCRIPT KILL and SHUTDOWN NOSAVE commands are available. The first can be # used to stop a script that did not yet called write commands. The second # is the only way to shut down the server in the case a write command was # already issued by the script but the user doesn\u0026#39;t want to wait for the natural # termination of the script. # # Set it to 0 or a negative value for unlimited execution without warnings. lua-time-limit 5000 ################################ REDIS CLUSTER ############################### # # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ # WARNING EXPERIMENTAL: Redis Cluster is considered to be stable code, however # in order to mark it as \u0026#34;mature\u0026#34; we need to wait for a non trivial percentage # of users to deploy it in production. # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ # # Normal Redis instances can\u0026#39;t be part of a Redis Cluster; only nodes that are # started as cluster nodes can. In order to start a Redis instance as a # cluster node enable the cluster support uncommenting the following: # # cluster-enabled yes # Every cluster node has a cluster configuration file. This file is not # intended to be edited by hand. It is created and updated by Redis nodes. # Every Redis Cluster node requires a different cluster configuration file. # Make sure that instances running in the same system do not have # overlapping cluster configuration file names. # # cluster-config-file nodes-6379.conf # Cluster node timeout is the amount of milliseconds a node must be unreachable # for it to be considered in failure state. # Most other internal time limits are multiple of the node timeout. # # cluster-node-timeout 15000 # A slave of a failing master will avoid to start a failover if its data # looks too old. # # There is no simple way for a slave to actually have a exact measure of # its \u0026#34;data age\u0026#34;, so the following two checks are performed: # # 1) If there are multiple slaves able to failover, they exchange messages # in order to try to give an advantage to the slave with the best # replication offset (more data from the master processed). # Slaves will try to get their rank by offset, and apply to the start # of the failover a delay proportional to their rank. # # 2) Every single slave computes the time of the last interaction with # its master. This can be the last ping or command received (if the master # is still in the \u0026#34;connected\u0026#34; state), or the time that elapsed since the # disconnection with the master (if the replication link is currently down). # If the last interaction is too old, the slave will not try to failover # at all. # # The point \u0026#34;2\u0026#34; can be tuned by user. Specifically a slave will not perform # the failover if, since the last interaction with the master, the time # elapsed is greater than: # # (node-timeout * slave-validity-factor) + repl-ping-slave-period # # So for example if node-timeout is 30 seconds, and the slave-validity-factor # is 10, and assuming a default repl-ping-slave-period of 10 seconds, the # slave will not try to failover if it was not able to talk with the master # for longer than 310 seconds. # # A large slave-validity-factor may allow slaves with too old data to failover # a master, while a too small value may prevent the cluster from being able to # elect a slave at all. # # For maximum availability, it is possible to set the slave-validity-factor # to a value of 0, which means, that slaves will always try to failover the # master regardless of the last time they interacted with the master. # (However they\u0026#39;ll always try to apply a delay proportional to their # offset rank). # # Zero is the only value able to guarantee that when all the partitions heal # the cluster will always be able to continue. # # cluster-slave-validity-factor 10 # Cluster slaves are able to migrate to orphaned masters, that are masters # that are left without working slaves. This improves the cluster ability # to resist to failures as otherwise an orphaned master can\u0026#39;t be failed over # in case of failure if it has no working slaves. # # Slaves migrate to orphaned masters only if there are still at least a # given number of other working slaves for their old master. This number # is the \u0026#34;migration barrier\u0026#34;. A migration barrier of 1 means that a slave # will migrate only if there is at least 1 other working slave for its master # and so forth. It usually reflects the number of slaves you want for every # master in your cluster. # # Default is 1 (slaves migrate only if their masters remain with at least # one slave). To disable migration just set it to a very large value. # A value of 0 can be set but is useful only for debugging and dangerous # in production. # # cluster-migration-barrier 1 # By default Redis Cluster nodes stop accepting queries if they detect there # is at least an hash slot uncovered (no available node is serving it). # This way if the cluster is partially down (for example a range of hash slots # are no longer covered) all the cluster becomes, eventually, unavailable. # It automatically returns available as soon as all the slots are covered again. # # However sometimes you want the subset of the cluster which is working, # to continue to accept queries for the part of the key space that is still # covered. In order to do so, just set the cluster-require-full-coverage # option to no. # # cluster-require-full-coverage yes # In order to setup your cluster make sure to read the documentation # available at http://redis.io web site. ################################## SLOW LOG ################################### # The Redis Slow Log is a system to log queries that exceeded a specified # execution time. The execution time does not include the I/O operations # like talking with the client, sending the reply and so forth, # but just the time needed to actually execute the command (this is the only # stage of command execution where the thread is blocked and can not serve # other requests in the meantime). # # You can configure the slow log with two parameters: one tells Redis # what is the execution time, in microseconds, to exceed in order for the # command to get logged, and the other parameter is the length of the # slow log. When a new command is logged the oldest one is removed from the # queue of logged commands. # The following time is expressed in microseconds, so 1000000 is equivalent # to one second. Note that a negative number disables the slow log, while # a value of zero forces the logging of every command. slowlog-log-slower-than 10000 # There is no limit to this length. Just be aware that it will consume memory. # You can reclaim memory used by the slow log with SLOWLOG RESET. slowlog-max-len 128 ################################ LATENCY MONITOR ############################## # The Redis latency monitoring subsystem samples different operations # at runtime in order to collect data related to possible sources of # latency of a Redis instance. # # Via the LATENCY command this information is available to the user that can # print graphs and obtain reports. # # The system only logs operations that were performed in a time equal or # greater than the amount of milliseconds specified via the # latency-monitor-threshold configuration directive. When its value is set # to zero, the latency monitor is turned off. # # By default latency monitoring is disabled since it is mostly not needed # if you don\u0026#39;t have latency issues, and collecting data has a performance # impact, that while very small, can be measured under big load. Latency # monitoring can easily be enabled at runtime using the command # \u0026#34;CONFIG SET latency-monitor-threshold \u0026lt;milliseconds\u0026gt;\u0026#34; if needed. latency-monitor-threshold 0 ############################# EVENT NOTIFICATION ############################## # Redis can notify Pub/Sub clients about events happening in the key space. # This feature is documented at http://redis.io/topics/notifications # # For instance if keyspace events notification is enabled, and a client # performs a DEL operation on key \u0026#34;foo\u0026#34; stored in the Database 0, two # messages will be published via Pub/Sub: # # PUBLISH __keyspace@0__:foo del # PUBLISH __keyevent@0__:del foo # # It is possible to select the events that Redis will notify among a set # of classes. Every class is identified by a single character: # # K Keyspace events, published with __keyspace@\u0026lt;db\u0026gt;__ prefix. # E Keyevent events, published with __keyevent@\u0026lt;db\u0026gt;__ prefix. # g Generic commands (non-type specific) like DEL, EXPIRE, RENAME, ... # $ String commands # l List commands # s Set commands # h Hash commands # z Sorted set commands # x Expired events (events generated every time a key expires) # e Evicted events (events generated when a key is evicted for maxmemory) # A Alias for g$lshzxe, so that the \u0026#34;AKE\u0026#34; string means all the events. # # The \u0026#34;notify-keyspace-events\u0026#34; takes as argument a string that is composed # of zero or multiple characters. The empty string means that notifications # are disabled. # # Example: to enable list and generic events, from the point of view of the # event name, use: # # notify-keyspace-events Elg # # Example 2: to get the stream of the expired keys subscribing to channel # name __keyevent@0__:expired use: # # notify-keyspace-events Ex # # By default all notifications are disabled because most users don\u0026#39;t need # this feature and the feature has some overhead. Note that if you don\u0026#39;t # specify at least one of K or E, no events will be delivered. notify-keyspace-events \u0026#34;\u0026#34; ############################### ADVANCED CONFIG ############################### # Hashes are encoded using a memory efficient data structure when they have a # small number of entries, and the biggest entry does not exceed a given # threshold. These thresholds can be configured using the following directives. hash-max-ziplist-entries 512 hash-max-ziplist-value 64 # Lists are also encoded in a special way to save a lot of space. # The number of entries allowed per internal list node can be specified # as a fixed maximum size or a maximum number of elements. # For a fixed maximum size, use -5 through -1, meaning: # -5: max size: 64 Kb \u0026lt;-- not recommended for normal workloads # -4: max size: 32 Kb \u0026lt;-- not recommended # -3: max size: 16 Kb \u0026lt;-- probably not recommended # -2: max size: 8 Kb \u0026lt;-- good # -1: max size: 4 Kb \u0026lt;-- good # Positive numbers mean store up to _exactly_ that number of elements # per list node. # The highest performing option is usually -2 (8 Kb size) or -1 (4 Kb size), # but if your use case is unique, adjust the settings as necessary. list-max-ziplist-size -2 # Lists may also be compressed. # Compress depth is the number of quicklist ziplist nodes from *each* side of # the list to *exclude* from compression. The head and tail of the list # are always uncompressed for fast push/pop operations. Settings are: # 0: disable all list compression # 1: depth 1 means \u0026#34;don\u0026#39;t start compressing until after 1 node into the list, # going from either the head or tail\u0026#34; # So: [head]-\u0026gt;node-\u0026gt;node-\u0026gt;...-\u0026gt;node-\u0026gt;[tail] # [head], [tail] will always be uncompressed; inner nodes will compress. # 2: [head]-\u0026gt;[next]-\u0026gt;node-\u0026gt;node-\u0026gt;...-\u0026gt;node-\u0026gt;[prev]-\u0026gt;[tail] # 2 here means: don\u0026#39;t compress head or head-\u0026gt;next or tail-\u0026gt;prev or tail, # but compress all nodes between them. # 3: [head]-\u0026gt;[next]-\u0026gt;[next]-\u0026gt;node-\u0026gt;node-\u0026gt;...-\u0026gt;node-\u0026gt;[prev]-\u0026gt;[prev]-\u0026gt;[tail] # etc. list-compress-depth 0 # Sets have a special encoding in just one case: when a set is composed # of just strings that happen to be integers in radix 10 in the range # of 64 bit signed integers. # The following configuration setting sets the limit in the size of the # set in order to use this special memory saving encoding. set-max-intset-entries 512 # Similarly to hashes and lists, sorted sets are also specially encoded in # order to save a lot of space. This encoding is only used when the length and # elements of a sorted set are below the following limits: zset-max-ziplist-entries 128 zset-max-ziplist-value 64 # HyperLogLog sparse representation bytes limit. The limit includes the # 16 bytes header. When an HyperLogLog using the sparse representation crosses # this limit, it is converted into the dense representation. # # A value greater than 16000 is totally useless, since at that point the # dense representation is more memory efficient. # # The suggested value is ~ 3000 in order to have the benefits of # the space efficient encoding without slowing down too much PFADD, # which is O(N) with the sparse encoding. The value can be raised to # ~ 10000 when CPU is not a concern, but space is, and the data set is # composed of many HyperLogLogs with cardinality in the 0 - 15000 range. hll-sparse-max-bytes 3000 # Active rehashing uses 1 millisecond every 100 milliseconds of CPU time in # order to help rehashing the main Redis hash table (the one mapping top-level # keys to values). The hash table implementation Redis uses (see dict.c) # performs a lazy rehashing: the more operation you run into a hash table # that is rehashing, the more rehashing \u0026#34;steps\u0026#34; are performed, so if the # server is idle the rehashing is never complete and some more memory is used # by the hash table. # # The default is to use this millisecond 10 times every second in order to # actively rehash the main dictionaries, freeing memory when possible. # # If unsure: # use \u0026#34;activerehashing no\u0026#34; if you have hard latency requirements and it is # not a good thing in your environment that Redis can reply from time to time # to queries with 2 milliseconds delay. # # use \u0026#34;activerehashing yes\u0026#34; if you don\u0026#39;t have such hard requirements but # want to free memory asap when possible. activerehashing yes # The client output buffer limits can be used to force disconnection of clients # that are not reading data from the server fast enough for some reason (a # common reason is that a Pub/Sub client can\u0026#39;t consume messages as fast as the # publisher can produce them). # # The limit can be set differently for the three different classes of clients: # # normal -\u0026gt; normal clients including MONITOR clients # slave -\u0026gt; slave clients # pubsub -\u0026gt; clients subscribed to at least one pubsub channel or pattern # # The syntax of every client-output-buffer-limit directive is the following: # # client-output-buffer-limit \u0026lt;class\u0026gt; \u0026lt;hard limit\u0026gt; \u0026lt;soft limit\u0026gt; \u0026lt;soft seconds\u0026gt; # # A client is immediately disconnected once the hard limit is reached, or if # the soft limit is reached and remains reached for the specified number of # seconds (continuously). # So for instance if the hard limit is 32 megabytes and the soft limit is # 16 megabytes / 10 seconds, the client will get disconnected immediately # if the size of the output buffers reach 32 megabytes, but will also get # disconnected if the client reaches 16 megabytes and continuously overcomes # the limit for 10 seconds. # # By default normal clients are not limited because they don\u0026#39;t receive data # without asking (in a push way), but just after a request, so only # asynchronous clients may create a scenario where data is requested faster # than it can read. # # Instead there is a default limit for pubsub and slave clients, since # subscribers and slaves receive data in a push fashion. # # Both the hard or the soft limit can be disabled by setting them to zero. client-output-buffer-limit normal 0 0 0 client-output-buffer-limit slave 256mb 64mb 60 client-output-buffer-limit pubsub 32mb 8mb 60 # Redis calls an internal function to perform many background tasks, like # closing connections of clients in timeout, purging expired keys that are # never requested, and so forth. # # Not all tasks are performed with the same frequency, but Redis checks for # tasks to perform according to the specified \u0026#34;hz\u0026#34; value. # # By default \u0026#34;hz\u0026#34; is set to 10. Raising the value will use more CPU when # Redis is idle, but at the same time will make Redis more responsive when # there are many keys expiring at the same time, and timeouts may be # handled with more precision. # # The range is between 1 and 500, however a value over 100 is usually not # a good idea. Most users should use the default of 10 and raise this up to # 100 only in environments where very low latency is required. hz 10 # When a child rewrites the AOF file, if the following option is enabled # the file will be fsync-ed every 32 MB of data generated. This is useful # in order to commit the file to the disk more incrementally and avoid # big latency spikes. aof-rewrite-incremental-fsync yes æµ‹è¯•redis-cliè¿æ¥ä¸Šæ¥\n1 docker exec -it è¿è¡Œç€RediisæœåŠ¡çš„å®¹å™¨ID redis-cli æµ‹è¯•æŒä¹…åŒ–æ–‡ä»¶ç”Ÿæˆ\n","date":"2020-01-03T18:06:43Z","image":"https://www.ownit.top/title_pic/06.jpg","permalink":"https://www.ownit.top/p/202001031806/","title":"Dockerå¸¸ç”¨å®‰è£…(tomcatã€mysqlã€redis)"},{"content":"ç›®å½•\nä¸‹è½½tomcatå®¹å™¨å·\n1ã€åˆ›å»ºæ–‡ä»¶å¤¹\n2ã€åœ¨ä¸Šè¿°ç›®å½•ä¸‹touch c.txt\n3ã€å°†jdkå’Œtomcatå®‰è£…çš„å‹ç¼©åŒ…æ‹·è´è¿›ä¸Šä¸€æ­¥ç›®å½•\n4ã€åœ¨/heian/mydockerfile/tomcat9ç›®å½•ä¸‹æ–°å»ºDockerfileæ–‡ä»¶\n5ã€æ„å»º\n6ã€run\n7ã€éªŒè¯\n8ã€ç»“åˆå‰è¿°çš„å®¹å™¨å·å°†æµ‹è¯•çš„webæœåŠ¡testå‘å¸ƒ\næ€»ç»“\nä¸‹è½½tomcatå®¹å™¨å· 1ã€åˆ›å»ºæ–‡ä»¶å¤¹ 1 mkdir -p /heian/mydockerfile/tomcat9 2ã€åœ¨ä¸Šè¿°ç›®å½•ä¸‹touch c.txt 1 touch c.txt 3ã€å°†jdkå’Œtomcatå®‰è£…çš„å‹ç¼©åŒ…æ‹·è´è¿›ä¸Šä¸€æ­¥ç›®å½• apache-tomcat-9.0.8.tar.gz\njdk-8u171-linux-x64.tar.gz\n4ã€åœ¨/heian/mydockerfile/tomcat9ç›®å½•ä¸‹æ–°å»ºDockerfileæ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 FROM centos MAINTAINER heian\u0026lt;1794748404@126.com\u0026gt; #æŠŠå®¿ä¸»æœºå½“å‰ä¸Šä¸‹æ–‡çš„c.txtæ‹·è´åˆ°å®¹å™¨/usr/local/è·¯å¾„ä¸‹ COPY c.txt /usr/local/cincontainer.txt #æŠŠjavaä¸tomcatæ·»åŠ åˆ°å®¹å™¨ä¸­ ADD jdk-8u152-linux-x64.tar.gz /usr/local/ ADD apache-tomcat-8.5.24.tar.gz /usr/local/ #å®‰è£…vimç¼–è¾‘å™¨ RUN yum -y install vim #è®¾ç½®å·¥ä½œè®¿é—®æ—¶å€™çš„WORKDIRè·¯å¾„ï¼Œç™»å½•è½è„šç‚¹ ENV MYPATH /usr/local WORKDIR $MYPATH #é…ç½®javaä¸tomcatç¯å¢ƒå˜é‡ ENV JAVA_HOME /usr/local/jdk1.8.0_152 ENV CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar ENV CATALINA_HOME /usr/local/apache-tomcat-8.5.24 ENV CATALINA_BASE /usr/local/apache-tomcat-8.5.24 ENV PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin #å®¹å™¨è¿è¡Œæ—¶ç›‘å¬çš„ç«¯å£ EXPOSE 8080 #å¯åŠ¨æ—¶è¿è¡Œtomcat # ENTRYPOINT [\u0026#34;/usr/local/apache-tomcat-8.5.24/bin/startup.sh\u0026#34; ] # CMD [\u0026#34;/usr/local/apache-tomcat-8.5.24/bin/catalina.sh\u0026#34;,\u0026#34;run\u0026#34;] CMD /usr/local/apache-tomcat-8.5.24/bin/startup.sh \u0026amp;\u0026amp; tail -F /usr/local/apache-tomcat-8.5.24/bin/logs/catalina.out 5ã€æ„å»º 1 docker build -f Dockerfile -t heiantomcat9 . æ„å»ºå®Œæˆ\n6ã€run 1 docker run -d -p 9080:8080 --name myt9 -v /heian/mydockerfile/tomcat9/test:/usr/local/apache-tomcat-9.0.8/webapps/test -v /heian/mydockerfile/tomcat9/tomcat9logs/:/usr/local/apache-tomcat-9.0.8/logs --privileged=true heiantomcat9 DockeræŒ‚è½½ä¸»æœºç›®å½•Dockerè®¿é—®å‡ºç°cannot open directory .: Permission denied\nè§£å†³åŠæ³•ï¼šåœ¨æŒ‚è½½ç›®å½•åå¤šåŠ ä¸€ä¸ª\u0026ndash;privileged=trueå‚æ•°å³å¯\n7ã€éªŒè¯ 8ã€ç»“åˆå‰è¿°çš„å®¹å™¨å·å°†æµ‹è¯•çš„webæœåŠ¡testå‘å¸ƒ a.jsp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;%@ page language=\u0026#34;java\u0026#34; contentType=\u0026#34;text/html; charset=UTF-8\u0026#34; pageEncoding=\u0026#34;UTF-8\u0026#34;%\u0026gt; \u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD HTML 4.01 Transitional//EN\u0026#34; \u0026#34;http://www.w3.org/TR/html4/loose.dtd\u0026#34;\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta http-equiv=\u0026#34;Content-Type\u0026#34; content=\u0026#34;text/html; charset=UTF-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Insert title here\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; -----------welcome------------ \u0026lt;%=\u0026#34;i am in docker tomcat self \u0026#34;%\u0026gt; \u0026lt;br\u0026gt; \u0026lt;br\u0026gt; \u0026lt;% System.out.println(\u0026#34;=============docker tomcat self\u0026#34;);%\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; web.xml\n1 2 3 4 5 6 7 8 9 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-app xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns=\u0026#34;http://java.sun.com/xml/ns/javaee\u0026#34; xsi:schemaLocation=\u0026#34;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd\u0026#34; id=\u0026#34;WebApp_ID\u0026#34; version=\u0026#34;2.5\u0026#34;\u0026gt; \u0026lt;display-name\u0026gt;test\u0026lt;/display-name\u0026gt; \u0026lt;/web-app\u0026gt; æµ‹è¯•\næ€»ç»“ ","date":"2020-01-03T16:33:10Z","image":"https://www.ownit.top/title_pic/27.jpg","permalink":"https://www.ownit.top/p/202001031633/","title":"DockerFileè‡ªå®šä¹‰é•œåƒTomcat9"},{"content":"ä½œç”¨ï¼šéƒ½æ˜¯æŒ‡å®šä¸€ä¸ªå®¹å™¨å¯åŠ¨æ—¶è¦è¿è¡Œçš„å‘½ä»¤ CMD Dockerfile ä¸­å¯ä»¥æœ‰å¤šä¸ª CMD æŒ‡ä»¤ï¼Œä½†åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆï¼ŒCMD ä¼šè¢« docker run ä¹‹åçš„å‚æ•°æ›¿æ¢\nå®ä¾‹\ntomcatçš„è®²è§£æ¼”ç¤º\n1 docker run -it -p 8080:8080 tomcat 1 docker run -it -p 8080:8080 tomcat ls -l **ENTRYPOINTÂ ** docker run ä¹‹åçš„å‚æ•°ä¼šè¢«å½“åšå‚æ•°ä¼ é€’ç»™ ENTRYPOINTï¼Œä¹‹åå½¢æˆæ–°çš„å‘½ä»¤ç»„åˆ\nå®ä¾‹\nåˆ¶ä½œCMDç‰ˆå¯ä»¥æŸ¥è¯¢IPä¿¡æ¯çš„å®¹å™¨\n1 2 3 FROM centos RUN yum install -y curl CMD [ \u0026#34;curl\u0026#34;, \u0026#34;-s\u0026#34;, \u0026#34;http://ip.cn\u0026#34; ] crulå‘½ä»¤è§£é‡Š\ncurlå‘½ä»¤å¯ä»¥ç”¨æ¥æ‰§è¡Œä¸‹è½½ã€å‘é€å„ç§HTTPè¯·æ±‚ï¼ŒæŒ‡å®šHTTPå¤´éƒ¨ç­‰æ“ä½œã€‚\nå¦‚æœç³»ç»Ÿæ²¡æœ‰curlå¯ä»¥ä½¿ç”¨yum install curlå®‰è£…ï¼Œä¹Ÿå¯ä»¥ä¸‹è½½å®‰è£…ã€‚\ncurlæ˜¯å°†ä¸‹è½½æ–‡ä»¶è¾“å‡ºåˆ°stdout\nä½¿ç”¨å‘½ä»¤ï¼šcurl http://www.baidu.com\næ‰§è¡Œåï¼Œwww.baidu.comçš„htmlå°±ä¼šæ˜¾ç¤ºåœ¨å±å¹•ä¸Šäº†\nè¿™æ˜¯æœ€ç®€å•çš„ä½¿ç”¨æ–¹æ³•ã€‚ç”¨è¿™ä¸ªå‘½ä»¤è·å¾—äº†http://curl.haxx.seæŒ‡å‘çš„é¡µé¢ï¼ŒåŒæ ·ï¼Œå¦‚æœè¿™é‡Œçš„URLæŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ä¸€å¹…å›¾éƒ½å¯ä»¥ç›´æ¥ä¸‹è½½åˆ°æœ¬åœ°ã€‚å¦‚æœä¸‹è½½çš„æ˜¯HTMLæ–‡æ¡£ï¼Œé‚£ä¹ˆç¼ºçœçš„å°†åªæ˜¾ç¤ºæ–‡ä»¶å¤´éƒ¨ï¼Œå³HTMLæ–‡æ¡£çš„headerã€‚è¦å…¨éƒ¨æ˜¾ç¤ºï¼Œè¯·åŠ å‚æ•° -i\né—®é¢˜ å¦‚æœæˆ‘ä»¬å¸Œæœ›æ˜¾ç¤º HTTP å¤´ä¿¡æ¯ï¼Œå°±éœ€è¦åŠ ä¸Š -i å‚æ•°\nWHY\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯æ‰§è¡Œæ–‡ä»¶æ‰¾ä¸åˆ°çš„æŠ¥é”™ï¼Œexecutable file not foundã€‚\nä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œè·Ÿåœ¨é•œåƒååé¢çš„æ˜¯ commandï¼Œè¿è¡Œæ—¶ä¼šæ›¿æ¢ CMD çš„é»˜è®¤å€¼ã€‚\nå› æ­¤è¿™é‡Œçš„ -i æ›¿æ¢äº†åŸæ¥çš„ CMDï¼Œè€Œä¸æ˜¯æ·»åŠ åœ¨åŸæ¥çš„ curl -s http://ip.cn åé¢ã€‚è€Œ -i æ ¹æœ¬ä¸æ˜¯å‘½ä»¤ï¼Œæ‰€ä»¥è‡ªç„¶æ‰¾ä¸åˆ°ã€‚\né‚£ä¹ˆå¦‚æœæˆ‘ä»¬å¸Œæœ›åŠ å…¥ -i è¿™å‚æ•°ï¼Œæˆ‘ä»¬å°±å¿…é¡»é‡æ–°å®Œæ•´çš„è¾“å…¥è¿™ä¸ªå‘½ä»¤ï¼š\n1 $ docker run myip curl -s http://ip.cn -i åˆ¶ä½œENTROYPOINTç‰ˆæŸ¥è¯¢IPä¿¡æ¯çš„å®¹å™¨\n1 2 3 FROM centos RUN yum install -y curl ENTRYPOINT [ \u0026#34;curl\u0026#34;, \u0026#34;-s\u0026#34;, \u0026#34;http://ip.cn\u0026#34; ] ","date":"2020-01-03T14:49:12Z","image":"https://www.ownit.top/title_pic/18.jpg","permalink":"https://www.ownit.top/p/202001031449/","title":"DockerFileçš„CMD/ENTRYPOINT é•œåƒæ¡ˆä¾‹"},{"content":"Baseé•œåƒ(scratch) Docker Hub ä¸­ 99% çš„é•œåƒéƒ½æ˜¯é€šè¿‡åœ¨ base é•œåƒä¸­å®‰è£…å’Œé…ç½®éœ€è¦çš„è½¯ä»¶æ„å»ºå‡ºæ¥çš„\nè‡ªå®šä¹‰é•œåƒmycentos 1ã€ç¼–å†™ è‡ªå®šä¹‰mycentosç›®çš„ä½¿æˆ‘ä»¬è‡ªå·±çš„é•œåƒå…·å¤‡å¦‚ä¸‹ï¼š\nç™»é™†åçš„é»˜è®¤è·¯å¾„ vimç¼–è¾‘å™¨ æŸ¥çœ‹ç½‘ç»œé…ç½®ifconfigæ”¯æŒ å‡†å¤‡ç¼–å†™DockerFileæ–‡ä»¶\nmyCentOSå†…å®¹DockerFile\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #åŸºäºæœ¬åœ°çš„centos FROM centos #ä½œè€…ã€é‚®ä»¶ MAINTAINER cf\u0026lt;1794748404@qq.com\u0026gt; #æ¥è®¾ç½®ç¯å¢ƒå˜é‡ ENV MYPATH /uer/local #ç™»å½•è¿›å»çš„è·¯å¾„ WORKDIR $MYPATH ##å®‰è£…ä¸‹é¢çš„è½¯ä»¶ RUN yum -y install vim RUN yum -y install net-tools #æš´éœ²80ç«¯å£ EXPOSE 80 #æ‰“å°ä¿¡æ¯ CMD echo $MYPATH CMD echo \u0026#34;success-----------------ok\u0026#34; #ä½¿ç”¨bash CMD /bin/bash 2ã€æ„å»º 1 docker build -f /root/docker/dockerfile1 -t mycentos:1.3 . 3ã€è¿è¡Œ 1 docker run -it æ–°é•œåƒåå­—:TAG å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è‡ªå·±çš„æ–°é•œåƒå·²ç»æ”¯æŒvim/ifconfigå‘½ä»¤ï¼Œæ‰©å±•æˆåŠŸäº†\n4ã€åˆ—å‡ºé•œåƒçš„å˜æ›´å†å² docker history é•œåƒå\n","date":"2020-01-03T14:13:50Z","image":"https://www.ownit.top/title_pic/50.jpg","permalink":"https://www.ownit.top/p/202001031413/","title":"DockerFileè‡ªå®šä¹‰é•œåƒcentos"},{"content":"DockerFileä½“ç³»ç»“æ„(ä¿ç•™å­—æŒ‡ä»¤) FROMï¼šåŸºç¡€é•œåƒï¼Œå½“å‰æ–°é•œåƒæ˜¯åŸºäºå“ªä¸ªé•œåƒçš„\nMAINTAINERï¼šé•œåƒç»´æŠ¤è€…çš„å§“åå’Œé‚®ç®±åœ°å€\nRUNï¼šå®¹å™¨æ„å»ºæ—¶éœ€è¦è¿è¡Œçš„å‘½ä»¤\nEXPOSEï¼šå½“å‰å®¹å™¨å¯¹å¤–æš´éœ²å‡ºçš„ç«¯å£\nWORKDIRï¼šæŒ‡å®šåœ¨åˆ›å»ºå®¹å™¨åï¼Œç»ˆç«¯é»˜è®¤ç™»é™†çš„è¿›æ¥å·¥ä½œç›®å½•ï¼Œä¸€ä¸ªè½è„šç‚¹\nENVï¼šç”¨æ¥åœ¨æ„å»ºé•œåƒè¿‡ç¨‹ä¸­è®¾ç½®ç¯å¢ƒå˜é‡\nENV MY_PATH /usr/mytest\nè¿™ä¸ªç¯å¢ƒå˜é‡å¯ä»¥åœ¨åç»­çš„ä»»ä½•RUNæŒ‡ä»¤ä¸­ä½¿ç”¨ï¼Œè¿™å°±å¦‚åŒåœ¨å‘½ä»¤å‰é¢æŒ‡å®šäº†ç¯å¢ƒå˜é‡å‰ç¼€ä¸€æ ·ï¼›\nä¹Ÿå¯ä»¥åœ¨å…¶å®ƒæŒ‡ä»¤ä¸­ç›´æ¥ä½¿ç”¨è¿™äº›ç¯å¢ƒå˜é‡ï¼Œ\næ¯”å¦‚ï¼šWORKDIR $MY_PATH\nADD**:å°†å®¿ä¸»æœºç›®å½•ä¸‹çš„æ–‡ä»¶æ‹·è´è¿›é•œåƒä¸”ADDå‘½ä»¤ä¼šè‡ªåŠ¨å¤„ç†URLå’Œè§£å‹tarå‹ç¼©åŒ…**\nCOPY**:ç±»ä¼¼ADDï¼Œæ‹·è´æ–‡ä»¶å’Œç›®å½•åˆ°é•œåƒä¸­ã€‚\nå°†ä»æ„å»ºä¸Šä¸‹æ–‡ç›®å½•ä¸­ \u0026lt;æºè·¯å¾„\u0026gt; çš„æ–‡ä»¶/ç›®å½•å¤åˆ¶åˆ°æ–°çš„ä¸€å±‚çš„é•œåƒå†…çš„ \u0026lt;ç›®æ ‡è·¯å¾„\u0026gt; ä½ç½®**\nCOPY src dest\nCOPY [\u0026ldquo;src\u0026rdquo;, \u0026ldquo;dest\u0026rdquo;]\nVOLUME**:å®¹å™¨æ•°æ®å·ï¼Œç”¨äºæ•°æ®ä¿å­˜å’ŒæŒä¹…åŒ–å·¥ä½œ**\nCMD**:æŒ‡å®šä¸€ä¸ªå®¹å™¨å¯åŠ¨æ—¶è¦è¿è¡Œçš„å‘½ä»¤**\nCMDå®¹å™¨å¯åŠ¨å‘½ä»¤\nCNDæŒ‡ä»¤çš„æ ¼å¼å’ŒRUN ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯ä¸¤ç§æ ¼å¼:\nâ—shell æ ¼å¼: CMD \u0026lt;å‘½ä»¤\u0026gt;Â â—execæ ¼å¼: CID [\u0026ldquo;å¯æ‰§è¡Œæ–‡ä»¶â€ï¼Œ â€œå‚æ•°1\u0026rdquo;ï¼Œ â€œå‚æ•°2â€..]\n.å‚æ•°åˆ—è¡¨æ ¼å¼: CNO [â€œå‚æ•°\u0026quot;,â€œå‚æ•°2â€..]. åœ¨æŒ‡å®šäº†EITRYPOIT æŒ‡ä»¤å,ç”¨CIDæŒ‡å®šå…·ä½“çš„å‚\næ•°ã€‚\nDockerfile ä¸­å¯ä»¥æœ‰å¤šä¸ª CMD æŒ‡ä»¤ï¼Œä½†åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆï¼ŒCMD ä¼šè¢« docker run ä¹‹åçš„å‚æ•°æ›¿æ¢\nENTRYPOINT :æŒ‡å®šä¸€ä¸ªå®¹å™¨å¯åŠ¨æ—¶è¦è¿è¡Œçš„å‘½ä»¤\nENTRYPOINT çš„ç›®çš„å’Œ CMD ä¸€æ ·ï¼Œéƒ½æ˜¯åœ¨æŒ‡å®šå®¹å™¨å¯åŠ¨ç¨‹åºåŠå‚æ•°\nONBUILD:å½“æ„å»ºä¸€ä¸ªè¢«ç»§æ‰¿çš„Dockerfileæ—¶è¿è¡Œå‘½ä»¤ï¼Œçˆ¶é•œåƒåœ¨è¢«å­ç»§æ‰¿åçˆ¶é•œåƒçš„onbuildè¢«è§¦å‘\n","date":"2020-01-03T12:01:16Z","image":"https://www.ownit.top/title_pic/15.jpg","permalink":"https://www.ownit.top/p/202001031201/","title":"DockerFileä½“ç³»ç»“æ„(ä¿ç•™å­—æŒ‡ä»¤)"},{"content":"1ã€æ˜¯ä»€ä¹ˆ Dockerfileæ˜¯ç”¨æ¥æ„å»ºDockeré•œåƒçš„æ„å»ºæ–‡ä»¶ï¼Œæ˜¯ç”±ä¸€ç³»åˆ—å‘½ä»¤å’Œå‚æ•°æ„æˆçš„è„šæœ¬ã€‚\næ„å»ºä¸‰æ­¥éª¤ ç¼–å†™Dockerfileæ–‡ä»¶ docker build docker run æ–‡ä»¶ä»€ä¹ˆæ ·ï¼Ÿï¼Ÿï¼Ÿ ä»¥æˆ‘ä»¬ç†Ÿæ‚‰çš„CentOSä¸ºä¾‹Â https://hub.docker.com/_/centos/\n1 2 3 4 5 6 7 8 FROM scratch ADD centos- 7-docker.tar.xz / LABEL org. label-schema. schema-version = \u0026#34;1.0\u0026#34; \\ org. label-schema. name=\u0026#34;CentOS Base Image\u0026#34; \\ org. label-schema. vendor=\u0026#34;Cent0S\u0026#34; \\ org. label-schema. license=\u0026#34;GPLv2\u0026#34; \\ org. label-schema. build-date=\u0026#34;20180531\u0026#34; CMD [\u0026#34;/bin/bash\u0026#34;] 2ã€DockerFileæ„å»ºè¿‡ç¨‹è§£æ Dockerfileå†…å®¹åŸºç¡€çŸ¥è¯† 1ï¼šæ¯æ¡ä¿ç•™å­—æŒ‡ä»¤éƒ½å¿…é¡»ä¸ºå¤§å†™å­—æ¯ä¸”åé¢è¦è·Ÿéšè‡³å°‘ä¸€ä¸ªå‚æ•° 2ï¼šæŒ‡ä»¤æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹ï¼Œé¡ºåºæ‰§è¡Œ 3ï¼š#è¡¨ç¤ºæ³¨é‡Š 4ï¼šæ¯æ¡æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒå±‚ï¼Œå¹¶å¯¹é•œåƒè¿›è¡Œæäº¤ Dockeræ‰§è¡ŒDockerfileçš„å¤§è‡´æµç¨‹ ï¼ˆ1ï¼‰dockerä»åŸºç¡€é•œåƒè¿è¡Œä¸€ä¸ªå®¹å™¨ ï¼ˆ2ï¼‰æ‰§è¡Œä¸€æ¡æŒ‡ä»¤å¹¶å¯¹å®¹å™¨ä½œå‡ºä¿®æ”¹ ï¼ˆ3ï¼‰æ‰§è¡Œç±»ä¼¼docker commitçš„æ“ä½œæäº¤ä¸€ä¸ªæ–°çš„é•œåƒå±‚ ï¼ˆ4ï¼‰dockerå†åŸºäºåˆšæäº¤çš„é•œåƒè¿è¡Œä¸€ä¸ªæ–°å®¹å™¨ ï¼ˆ4ï¼‰dockerå†åŸºäºåˆšæäº¤çš„é•œåƒè¿è¡Œä¸€ä¸ªæ–°å®¹å™¨ ä»åº”ç”¨è½¯ä»¶çš„è§’åº¦æ¥çœ‹ï¼ŒDockerfileã€Dockeré•œåƒä¸Dockerå®¹å™¨åˆ†åˆ«ä»£è¡¨è½¯ä»¶çš„ä¸‰ä¸ªä¸åŒé˜¶æ®µï¼Œ\n* Dockerfileæ˜¯è½¯ä»¶çš„åŸææ–™\n* Dockeré•œåƒæ˜¯è½¯ä»¶çš„äº¤ä»˜å“\n* Dockerå®¹å™¨åˆ™å¯ä»¥è®¤ä¸ºæ˜¯è½¯ä»¶çš„è¿è¡Œæ€ã€‚\nDockerfileé¢å‘å¼€å‘ï¼ŒDockeré•œåƒæˆä¸ºäº¤ä»˜æ ‡å‡†ï¼ŒDockerå®¹å™¨åˆ™æ¶‰åŠéƒ¨ç½²ä¸è¿ç»´ï¼Œä¸‰è€…ç¼ºä¸€ä¸å¯ï¼ŒåˆåŠ›å……å½“Dockerä½“ç³»çš„åŸºçŸ³ã€‚\n1 Dockerfileï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªDockerfileï¼ŒDockerfileå®šä¹‰äº†è¿›ç¨‹éœ€è¦çš„ä¸€åˆ‡ä¸œè¥¿ã€‚Dockerfileæ¶‰åŠçš„å†…å®¹åŒ…æ‹¬æ‰§è¡Œä»£ç æˆ–è€…æ˜¯æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€ä¾èµ–åŒ…ã€è¿è¡Œæ—¶ç¯å¢ƒã€åŠ¨æ€é“¾æ¥åº“ã€æ“ä½œç³»ç»Ÿçš„å‘è¡Œç‰ˆã€æœåŠ¡è¿›ç¨‹å’Œå†…æ ¸è¿›ç¨‹(å½“åº”ç”¨è¿›ç¨‹éœ€è¦å’Œç³»ç»ŸæœåŠ¡å’Œå†…æ ¸è¿›ç¨‹æ‰“äº¤é“ï¼Œè¿™æ—¶éœ€è¦è€ƒè™‘å¦‚ä½•è®¾è®¡namespaceçš„æƒé™æ§åˆ¶)ç­‰ç­‰;\n2 Dockeré•œåƒï¼Œåœ¨ç”¨Dockerfileå®šä¹‰ä¸€ä¸ªæ–‡ä»¶ä¹‹åï¼Œdocker buildæ—¶ä¼šäº§ç”Ÿä¸€ä¸ªDockeré•œåƒï¼Œå½“è¿è¡Œ Dockeré•œåƒæ—¶ï¼Œä¼šçœŸæ­£å¼€å§‹æä¾›æœåŠ¡;\n3 Dockerå®¹å™¨ï¼Œå®¹å™¨æ˜¯ç›´æ¥æä¾›æœåŠ¡çš„ã€‚\n","date":"2020-01-03T11:29:01Z","image":"https://www.ownit.top/title_pic/02.jpg","permalink":"https://www.ownit.top/p/202001031129/","title":"DockerFileè§£æ"},{"content":"è¿è¡ŒåŸç†æµç¨‹å›¾\nä»€ä¹ˆæ˜¯å†…ç½‘ç©¿é€?\n1. å†…ç½‘ç©¿é€æ˜¯æˆ‘ä»¬åœ¨è¿›è¡Œç½‘ç»œè¿æ¥æ—¶çš„ä¸€ç§æœ¯è¯­ï¼Œä¹Ÿå«åšNATç©¿é€ï¼Œå³åœ¨è®¡ç®—æœºæ˜¯å±€åŸŸç½‘å†…çš„æ—¶å€™ï¼Œå¤–ç½‘ä¸å†…ç½‘çš„è®¡ç®—æœºçš„èŠ‚ç‚¹è¿›è¡Œè¿æ¥æ—¶æ‰€éœ€è¦çš„è¿æ¥é€šä¿¡ï¼Œæœ‰æ—¶å€™å°±ä¼šå‡ºç°å†…ç½‘ç©¿é€ä¸æ”¯çš„æƒ…å†µã€‚å†…ç½‘ç©¿é€çš„åŠŸèƒ½å°±æ˜¯ï¼Œå½“æˆ‘ä»¬åœ¨ç«¯å£æ˜ å°„æ—¶è®¾ç½®æ—¶ï¼Œå†…ç½‘ç©¿é€èµ·åˆ°äº†åœ°å€è½¬æ¢çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯æŠŠå…¬ç½‘çš„åœ°å€è¿›è¡Œç¿»è¯‘ï¼Œè½¬æˆä¸ºä¸€ç§ç§æœ‰çš„åœ°å€ï¼Œç„¶åå†é‡‡ç”¨è·¯ç”±çš„æ–¹å¼ADSLçš„å®½å¸¦è·¯ç”±å™¨ï¼Œå…·æœ‰ä¸€ä¸ªåŠ¨æ€æˆ–è€…æ˜¯å›ºå®šçš„å…¬ç½‘IPï¼Œæœ€åADSLç›´æ¥åœ¨ äº¤æ¢æœº ä¸Šï¼Œè¿™æ ·æ‰€æœ‰çš„ç”µè„‘éƒ½å¯ä»¥å…±äº«ä¸Šç½‘ã€‚å†…ç½‘ç©¿é€é™¤äº†å¯ä»¥å®ç°å†…ç½‘ä¹‹é—´æœºå™¨çš„ç½‘ç»œé€šä¿¡åŠŸé€šä¹‹å¤–ï¼Œè¿˜å¯ä»¥è§£å†³UDPä¸­å‡ºç°çš„æ•°æ®ä¼ è¾“ä¸ç¨³å®šé—®é¢˜ã€‚\n2. ç®€å•è¯´, å°±æ˜¯Aå®¢æˆ·ç«¯è¦è®¿é—®Bå®¢æˆ·ç«¯ï¼Œé€šè¿‡ä¸€å°æœåŠ¡å™¨è¿›è¡Œæ¡¥æ¥ï¼Œæ¡¥æ¥æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ç›¸äº’è½¬å‘ï¼Œå¦ä¸€ä¸ªæ˜¯å‘Šè¯‰å¯¹æ–¹çš„åœ°å€ï¼Œè‡ªå·±å°±å½“ä¸€ä¸ªä»‹ç»äººçš„è§’è‰²ã€‚\n**Â ç½‘äº‘ç©¿æ˜¯ä¸€æ¬¾å¯ä»¥åœ¨åŒ…æ‹¬ä½†ä¸é™äºWindowsã€Macã€Linuxã€ç¾¤è¾‰ã€æ ‘è“æ´¾ã€å¨è”é€šä¸Šä½¿ç”¨çš„å†…ç½‘ç©¿é€ï¼Œå®ƒå¯ä»¥å¾ˆä¾¿æ·çš„å¸®åŠ©ä½ å°†æœ¬åœ°å†…ç½‘çš„åº”ç”¨å‘å¸ƒå‡ºå»ï¼Œæ¯”å¦‚ï¼šç½‘ç«™ã€æ•°æ®åº“ã€ç¡¬ç›˜æ–‡ä»¶ã€è¿œç¨‹æ¡Œé¢ã€åº”ç”¨ã€æ¸¸æˆ(å¦‚æˆ‘çš„ä¸–ç•Œ)ç­‰ç­‰ï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¾®ä¿¡è°ƒè¯•ã€è‡ªå»ºäº‘ç›˜ã€å¼‚åœ°åŠå…¬ç­‰ç­‰ï¼Œå®ƒä¸éœ€è¦æ‚¨æœ‰å…¬ç½‘IPã€ä¸éœ€è¦æ‚¨æœ‰æœåŠ¡å™¨ã€ä¹Ÿä¸éœ€è¦æ‚¨è®¾ç½®ä»»ä½•è·¯ç”±å™¨ï¼Œåªéœ€è¦æ‚¨å®‰è£…è½¯ä»¶è¿›è¡Œç®€å•è®¾ç½®å³å¯ç›´æ¥ä½¿ç”¨ã€‚**\nå¦‚ä½•å®ç°?\nå¤§éƒ¨åˆ†å†…ç½‘ç©¿é€éƒ½æ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹å·¥å…·å®ç°, å¸‚é¢ä¸Šä¹Ÿæœ‰å¾ˆå¤šç¬¬ä¸‰ä¸ªå·¥å…·, èŠ±ç”Ÿå£³, Ngrokç­‰â€¦ ä½†æœ¬å›¢é˜Ÿåœ¨ä½¿ç”¨è¿‡ä¹‹å, å‘ç°è¿™äº›ç¬¬ä¸‰æ–¹å·¥å…·åœ¨ä»·é’±å’Œä½¿ç”¨æ–¹é¢ä¸å¤ªç¬¦åˆé¢„æœŸçš„æ•ˆæœ, åœ¨è¿™é‡Œå°èš‚èšå†…ç½‘ç©¿é€å›¢é˜Ÿè‡´åŠ›æ‰“é€ ä¸€æ¬¾æ›´åŠ æ–¹ä¾¿, â€œäº²æ°‘â€ çš„ä¸€æ¬¾å†…ç½‘ç©¿é€å·¥å…·, è¯¦æƒ…è¯·äº†è§£å®˜ç½‘:\nç½‘äº‘ç©¿\nè´¹è¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šå¹²è´§ _Â SpringBootÂ ä½¿ç”¨ç½‘äº‘ç©¿å¯¹å¤–å‘å¸ƒé¡¹ç›®_ æˆ‘çš„ç¨‹åºè¿è¡Œçš„jaråŒ…ï¼Œéœ€è¦å‘å¸ƒåˆ°å¤–ç½‘ï¼Œä½†æ˜¯æ²¡æœ‰æœåŠ¡å™¨ï¼Œåªèƒ½é€šè¿‡ç©¿é€æ¥ã€‚\nä¸‹é¢å°±æ˜¯æ•™ç¨‹\n1ã€ä¸‹è½½ç½‘äº‘ç©¿pcå®‰è£…åŒ…ï¼Œè§£å‹ã€‚ ä¸‹è½½\n2ã€ç™»å½•è´¦å·ï¼ˆæ²¡æœ‰çš„éœ€è¦è‡ªå·±å»å®˜ç½‘æ³¨å†Œï¼‰ 3ã€æŸ¥è¯¢æœ¬æœºéœ€è¦æ˜ å°„çš„IP 4ã€é…ç½®éœ€è¦æ˜ å°„çš„ç«¯å£ä¿¡æ¯ 1ã€ç‚¹å‡»web\n2ã€ç‚¹å‡»éš§é“ç®¡ç†\n3ã€é…ç½®éœ€è¦ç©¿é€çš„æœ¬æœºIPå’Œç«¯å£\n5ã€å¯åŠ¨SpringBooté¡¹ç›® 6ã€è¿”å›ç½‘äº‘ç©¿Pcç«¯ 7ã€æŸ¥çœ‹æ•ˆæœ å®Œç¾ç©¿é€ï¼ŒçœŸæ˜¯æ–¹ä¾¿ï¼Œä»¥åæˆ‘çš„ç”µè„‘éƒ½å¯ä»¥ææˆæœåŠ¡å™¨äº†ã€‚\n","date":"2019-12-24T15:00:48Z","image":"https://www.ownit.top/title_pic/15.jpg","permalink":"https://www.ownit.top/p/201912241500/","title":"SpringBooté¡¹ç›®æ˜ å°„"},{"content":"Centos7ç³»ç»ŸDockerå®‰è£… ç›®å½•\nCentos7ç³»ç»ŸDockerå®‰è£…\nç›®å½•\nCentos7ç³»ç»ŸDockerå®‰è£…\n1ã€ä¸‹è½½mysqlé•œåƒ\n2ã€åˆ›å»ºMasterå®ä¾‹å¹¶å¯åŠ¨\nå‚æ•°è¯´æ˜\n3ã€åˆ›å»ºSlaveå®ä¾‹å¹¶å¯åŠ¨\n4ã€æ·»åŠ masterä¸»ä»å¤åˆ¶éƒ¨åˆ†é…ç½®\n5ã€æ·»åŠ Slaveä¸»ä»å¤åˆ¶éƒ¨åˆ†é…ç½®\n6ã€ä¸ºmasteræˆæƒç”¨æˆ·æ¥ä»–çš„åŒæ­¥æ•°æ®\n1ã€ä¸‹è½½mysqlé•œåƒ 1 docker search mysql 1 docker pull mysql:5.7 1 docker images 2ã€åˆ›å»ºMasterå®ä¾‹å¹¶å¯åŠ¨ 1 2 3 4 5 6 docker run -p 3307:3306 --name mysql-master \\ -v /mydata/mysql/master/log:/var/log/mysql \\ -v /mydata/mysql/master/data:/var/lib/mysql \\ -v /mydata/mysql/master/conf:/etc/mysql \\ -e MYSQL_ROOT_PASSWORD=root \\ -d mysql:5.7 å‚æ•°è¯´æ˜ -p 3307:3306ï¼šå°†å®¹å™¨çš„3306ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„3307ç«¯å£ -v /mydata/mysql/master/conf:/etc/mysqlï¼šå°†é…ç½®æ–‡ä»¶å¤¹æŒ‚åœ¨åˆ°ä¸»æœº -v /mydata/mysql/master/log:/var/log/mysqlï¼šå°†æ—¥å¿—æ–‡ä»¶å¤¹æŒ‚è½½åˆ°ä¸»æœº -v /mydata/mysql/master/data:/var/lib/mysql/ï¼šå°†é…ç½®æ–‡ä»¶å¤¹æŒ‚è½½åˆ°ä¸»æœº -e MYSQL_ROOT_PASSWORD=rootï¼šåˆå§‹åŒ–rootç”¨æˆ·çš„å¯†ç  ä¿®æ”¹master****åŸºæœ¬é…ç½®\n1 vim /mydata/mysql/master/conf/my.cnf 1 2 3 4 5 6 7 8 9 10 11 12 13 [client] default-character-set=utf8 [mysql] default-character-set=utf8 [mysqld] init_connect=\u0026#39;SET collation_connection = utf8_unicode_ci\u0026#39; init_connect=\u0026#39;SET NAMES utf8\u0026#39; character-set-server=utf8 collation-server=utf8_unicode_ci skip-character-set-client-handshake skip-name-resolve æ³¨æ„ï¼šskip-name-resolveä¸€å®šè¦åŠ ï¼Œä¸ç„¶è¿æ¥mysqlä¼šè¶…çº§æ…¢\n3ã€åˆ›å»ºSlaveå®ä¾‹å¹¶å¯åŠ¨ 1 2 3 4 5 6 docker run -p 3316:3306 --name mysql-slaver-01 \\ -v /mydata/mysql/slaver/log:/var/log/mysql \\ -v /mydata/mysql/slaver/data:/var/lib/mysql \\ -v /mydata/mysql/slaver/conf:/etc/mysql \\ -e MYSQL_ROOT_PASSWORD=root \\ -d mysql:5.7 ä¿®æ”¹slave****åŸºæœ¬é…ç½®\n1 vim /mydata/mysql/slaver/conf/my.cnf 1 2 3 4 5 6 7 8 9 10 11 12 13 [client] default-character-set=utf8 [mysql] default-character-set=utf8 [mysqld] init_connect=\u0026#39;SET collation_connection = utf8_unicode_ci\u0026#39; init_connect=\u0026#39;SET NAMES utf8\u0026#39; character-set-server=utf8 collation-server=utf8_unicode_ci skip-character-set-client-handshake skip-name-resolve 4ã€æ·»åŠ master****ä¸»ä»å¤åˆ¶éƒ¨åˆ†é…ç½® 1 vim /mydata/mysql/master/conf/my.cnf 1 2 3 4 5 6 7 8 9 10 11 12 13 14 server_id=1 log-bin=mysql-bin read-only=0 binlog-do-db=gmall_ums binlog-do-db=gmall_pms binlog-do-db=gmall_oms binlog-do-db=gmall_sms binlog-do-db=gmall_cms replicate-ignore-db=mysql replicate-ignore-db=sys replicate-ignore-db=information_schema replicate-ignore-db=performance_schema é‡å¯å®¹å™¨\n5ã€æ·»åŠ Slaveä¸»ä»å¤åˆ¶éƒ¨åˆ†é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 server_id=2 log-bin=mysql-bin read-only=1 binlog-do-db=gmall_ums binlog-do-db=gmall_pms binlog-do-db=gmall_oms binlog-do-db=gmall_sms binlog-do-db=gmall_cms replicate-ignore-db=mysql replicate-ignore-db=sys replicate-ignore-db=information_schema replicate-ignore-db=performance_schema é‡å¯å®¹å™¨\n6ã€ä¸ºmasteræˆæƒç”¨æˆ·æ¥ä»–çš„åŒæ­¥æ•°æ® 1ã€è¿›å…¥ä¸»åº“\n1 docker exec -it 4fdd7f265228 /bin/bash 2ã€è¿›å…¥ä¸»åº“mysqlæ•°æ®åº“\n1 mysql -u root -p **Â 1ï¼‰ã€æˆæƒrootå¯ä»¥è¿œç¨‹è®¿é—®ï¼ˆ ä¸»ä»æ— å…³ï¼Œä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬è¿œç¨‹è¿æ¥mysqlï¼‰** 1 grant all privileges on *.* to \u0026#39;root\u0026#39;@\u0026#39;%\u0026#39; identified by \u0026#39;root\u0026#39; with grant option; 1 flush privileges; **Â 2ï¼‰ã€æ·»åŠ ç”¨æ¥åŒæ­¥çš„ç”¨æˆ·** 1 GRANT REPLICATION SLAVE ON *.* to \u0026#39;backup\u0026#39;@\u0026#39;%\u0026#39; identified by \u0026#39;123456\u0026#39;; 3ï¼‰ã€æŸ¥çœ‹æ•°æ®åº“çš„çŠ¶æ€ 1 show master status\\G; 3ã€è¿›å…¥ä»åº“mysqlæ•°æ®åº“\n**Â 1ï¼‰ã€æˆæƒrootå¯ä»¥è¿œç¨‹è®¿é—®ï¼ˆ ä¸»ä»æ— å…³ï¼Œä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬è¿œç¨‹è¿æ¥mysqlï¼‰** 1 grant all privileges on *.* to \u0026#39;root\u0026#39;@\u0026#39;%\u0026#39; identified by \u0026#39;root\u0026#39; with grant option; 1 flush privileges; **Â 2ï¼‰ã€è®¾ç½®ä¸»åº“è¿æ¥** 1 change master to master_host=\u0026#39;192.168.116.129\u0026#39;,master_user=\u0026#39;backup\u0026#39;,master_password=\u0026#39;123456\u0026#39;,master_log_file=\u0026#39;mysql-bin.000001\u0026#39;,master_log_pos=0,master_port=3307; **Â 3ï¼‰ã€å¯åŠ¨ä»åº“åŒæ­¥** 1 start slave; **Â 4ï¼‰ã€æŸ¥çœ‹ä»åº“çŠ¶æ€** 1 show slave status\\G; è‡³æ­¤ä¸»ä»é…ç½®å®Œæˆï¼›\næ€»ç»“ï¼š\n**Â 1ï¼‰ã€ä¸»ä»æ•°æ®åº“åœ¨è‡ªå·±é…ç½®æ–‡ä»¶ä¸­å£°æ˜éœ€è¦åŒæ­¥å“ªä¸ªæ•°æ®åº“ï¼Œå¿½ç•¥å“ªä¸ªæ•°æ®åº“ç­‰ä¿¡æ¯ã€‚å¹¶ä¸”server-idä¸èƒ½ä¸€æ ·**\n**Â 2ï¼‰ã€ä¸»åº“æˆæƒæŸä¸ªè´¦å·å¯†ç æ¥åŒæ­¥è‡ªå·±çš„æ•°æ®**\n**Â 3ï¼‰ã€ä»åº“ä½¿ç”¨è¿™ä¸ªè´¦å·å¯†ç è¿æ¥ä¸»åº“æ¥åŒæ­¥æ•°æ®**\næ¼”ç¤ºæ•ˆæœ\n","date":"2019-12-19T11:16:59Z","image":"https://www.ownit.top/title_pic/09.jpg","permalink":"https://www.ownit.top/p/201912191116/","title":"Dockerå®‰è£…MySQLé›†ç¾¤ã€è¯»å†™åˆ†ç¦»ã€‘"},{"content":"\nSpringBoot æ˜¯ SpringMVC çš„å‡çº§ï¼Œå¯¹äºç¼–ç ã€é…ç½®ã€éƒ¨ç½²å’Œç›‘æ§ï¼Œæ›´åŠ ç®€å•\nå¾®æœåŠ¡\nSpring ä¸º å¾®æœåŠ¡æä¾›äº†ä¸€æ•´å¥—çš„ç»„ä»¶-SpringClound , SpirngBoot å°±æ˜¯è¯¥åŸºç¡€ã€‚\nç¬¬ä¸€ä¸ªSpringBootç¨‹åº mavené…ç½®çš„ä¸­å¤®ä»“åº“é˜¿é‡Œäº‘é•œåƒ\nsetting.xml\n1 2 3 4 5 6 \u0026lt;mirror\u0026gt; \u0026lt;id\u0026gt;nexus-aliyun\u0026lt;/id\u0026gt; \u0026lt;mirrorOf\u0026gt;*\u0026lt;/mirrorOf\u0026gt; \u0026lt;name\u0026gt;Nexus aliyun\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;\thttps://maven.aliyun.com/nexus/content/groups/public/\u0026lt;/url\u0026gt; \u0026lt;/mirror\u0026gt; ä½¿ç”¨IDEAåˆ›å»ºSpringBooté¡¹ç›®\né¡¹ç›®ç»“æ„ä¸ºï¼š\né¡¹ç›®é»˜è®¤çš„ maven pom.xmlæ–‡ä»¶\nè¿è¡ŒSpirngbootdemoApplicationçš„mainæ–¹æ³•ï¼Œå°±èƒ½å¼€å§‹è¿è¡Œã€‚\næ§åˆ¶å°è¾“å‡ºï¼š\nä»è¿™é‡Œå¯ä»¥çœ‹åˆ° Tomcat çš„ç«¯å£å·ï¼Œå› ä¸ºè¿˜æ²¡æœ‰è‡ªå®šä¹‰Controllerï¼Œæ‰€ä»¥è¿˜æ²¡æœ‰è§†å›¾ï¼Œä¸‹é¢æ¥åˆ›å»ºä¸€ä¸ªè¾“å‡ºHello SpringBoot!çš„è§†å›¾ã€‚\nåˆ›å»ºä¸€ä¸ªHelloControllerï¼Œä½äºcontrolleråŒ…ä¸‹\nHelloController.java\n1 2 3 4 5 6 7 8 9 10 11 12 package com.jxust.controller; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RestController; @RestController public class HelloController { @RequestMapping(\u0026#34;/hello\u0026#34;) public String say(){ return \u0026#34;Hello SpringBoot!\u0026#34;; } } @RestController Spring4 ä¹‹åæ–°åŠ çš„æ³¨è§£,åŸæ¥è¿”å›jsonéœ€è¦@ResponseBodyé…åˆ@Controller,ç°åœ¨ä¸€ä¸ªé¡¶ä¿©\nåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:8080/helloå°±èƒ½è¾“å‡ºHello SpringBoot!è¿™å¥è¯ã€‚\nè‡ªå®šä¹‰å±æ€§é…ç½®\nç”¨åˆ°çš„æ˜¯application.propertiesè¿™ä¸ªæ–‡ä»¶\né…ç½®ç«¯å£å·å’Œè®¿é—®å‰ç¼€\napplication.properties\n1 2 server.port=8081 server.context-path=/springboot é™¤äº†ä½¿ç”¨.propertiesæ ¼å¼çš„æ–‡ä»¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨.ymlæ ¼å¼çš„é…ç½®æ–‡ä»¶(æ¨è)ï¼Œæ›´åŠ ç®€ä¾¿\napplication.yml\næŠŠåŸæ¥çš„application.propertiesæ–‡ä»¶åˆ é™¤\næ³¨æ„æ ¼å¼ï¼Œç©ºæ ¼ä¸èƒ½å°‘\nè·å–é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å€¼\næˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œé…ç½®æ•°æ®ï¼Œåœ¨ Controller ä¸­è·å–,æ¯”å¦‚ï¼š\n1 2 3 4 5 6 server: port: 8080 servlet: context-path: /springboot heian : ä¹˜é£ç ´æµª HelloController è·å–é…ç½®æ–‡ä»¶ä¸­çš„å€¼\nHelloController.java\n1 2 3 4 5 6 7 8 9 @RestController public class HelloController { @Value(\u0026#34;${heian}\u0026#34;) private String heian; @RequestMapping(value = \u0026#34;/heain\u0026#34;,method = RequestMethod.GET) public String heian(){ return heian; } } è¿”å›çš„ä¸ºheiançš„å€¼\né…ç½®æ–‡ä»¶ä¸­å€¼é…ç½®æ–¹å¼çš„å¤šæ ·åŒ–\né…ç½®æ–‡ä»¶çš„å€¼å¯ä»¥æ˜¯å¤šä¸ªï¼Œä¹Ÿå¯ä»¥æ˜¯ç»„åˆï¼Œå¦‚ï¼š\napplication.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 name: ä¹˜é£ age: 22 æˆ–è€… name: ä¹˜é£ age: 22 content: \u0026#34;name: ${name},age: ${age}\u0026#34; æˆ–è€… server: port: 8080 context-path: /springboot person: name: ä¹˜é£ age: 22 å‰ä¸¤ç§é…ç½®è·å–å€¼çš„æ–¹å¼éƒ½æ˜¯ä¸€æ ·çš„,ä½†æ˜¯å¯¹äºè¿™ç§æ–¹å¼ï¼Œperson æœ‰ç›¸åº”çš„ä¸¤ä¸ªå±æ€§ï¼Œéœ€è¦è¿™æ ·å¤„ç†\nPersonProperties.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 package com.example.demo.controller; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.stereotype.Component; /** * @Author:å—å®«ä¹˜é£ * @Date:2019/12/18 16:01 */ @Component @ConfigurationProperties(prefix = \u0026#34;person\u0026#34;) public class PersonProperties { private String name; private String age; public String getName() { return name; } public void setName(String name) { this.name = name; } public String getAge() { return age; } public void setAge(String age) { this.age = age; } } Alt+insertå¿«æ·é”®æç¤ºç”Ÿæˆ Getter and Setter\npom.xmléœ€è¦åŠ å…¥ä¸‹é¢çš„ä¾èµ–,å¤„ç†è­¦å‘Š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; \u0026lt;/dependency\u0026gt; HelloController.java\n1 2 3 4 5 6 7 @Autowired PersonProperties personProperties; @RequestMapping(value = \u0026#34;/heian\u0026#34;, method = RequestMethod.GET) public String hello() { return \u0026#34;åå­—ï¼š \u0026#34;+personProperties.getName()+\u0026#34; å¹´é¾„ï¼š \u0026#34;+personProperties.getAge(); } å…³äºé…ç½®æ–‡ä»¶application.ymlçš„å¤šå¥—é…ç½®\nç±»ä¼¼ il8n æ–‡ä»¶å›½é™…åŒ–çš„é…ç½®æ–¹å¼i18n_en_US.propertieså’Œi18n_zh_CN.properties\nè¿™æ ·èƒ½è§£å†³ï¼Œéœ€è¦é¢‘ç¹ä¿®æ”¹é…ç½®çš„å°´å°¬\nç”±application.ymlé…ç½®æ–‡ä»¶å†³å®šä½¿ç”¨é‚£å¥—é…ç½®æ–‡ä»¶ã€‚\napplication.yml\n1 2 3 spring: profiles: active: a application-a.yml\n1 2 3 4 5 6 7 8 server: port: 8080 servlet: context-path: /springboot person : name : å—å®«ä¹˜é£A age : 20 application-b.yml\n1 2 3 4 5 6 7 8 server: port: 8080 servlet: context-path: /springboot person : name : å—å®«ä¹˜é£B age : 22 SpringBootå¢åˆ æ”¹æŸ¥å®ä¾‹ å®Œæ•´çš„é¡¹ç›®ç»“æ„\nControllerçš„ä½¿ç”¨\n@Controller å¤„ç†httpè¯·æ±‚ @RestController Spring4 ä¹‹åæ–°åŠ çš„æ³¨è§£ï¼ŒåŸæ¥è¿”å›jsonéœ€è¦@ResponseBodyé…åˆ@Controller @RequestMapping é…ç½®urlæ˜ å°„ å¯¹äº REST é£æ ¼çš„è¯·æ±‚\nå¯¹äº Controller ä¸­çš„æ–¹æ³•ä¸Šçš„æ³¨è§£\n1 2 3 4 @RequestMapping(value = â€œ/helloâ€,method = RequestMethod.GET) @RequestMapping(value = â€œ/helloâ€,method = RequestMethod.POST) @RequestMapping(value = â€œ/helloâ€,method = RequestMethod.DELETE) @RequestMapping(value = â€œ/helloâ€,method = RequestMethod.PUT) SpringBoot å¯¹ä¸Šé¢çš„æ³¨è§£è¿›è¡Œäº†ç®€åŒ–\n1 2 3 4 @GetMapping(value = â€œ/girlsâ€) @PostMapping(value = â€œ/girlsâ€) @PutMapping(value = â€œ/girls/{id}â€) @DeleteMapping(value = â€œ/girls/{id}â€) æµè§ˆå™¨éœ€è¦å‘é€ä¸åŒæ–¹å¼çš„è¯·æ±‚ï¼Œå¯ä»¥å®‰è£…HttpRequesteræ’ä»¶ï¼Œç«ç‹æµè§ˆå™¨å¯ä»¥ç›´æ¥æœç´¢è¯¥ç»„ä»¶å®‰è£…ã€‚\nspring-data-jpa\nJPAå…¨ç§°Java Persistence API.JPAé€šè¿‡JDK 5.0æ³¨è§£æˆ–XMLæè¿°å¯¹è±¡ï¼å…³ç³»è¡¨çš„æ˜ å°„å…³ç³»ï¼Œå¹¶å°†è¿è¡ŒæœŸçš„å®ä½“å¯¹è±¡æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚\nHibernate3.2+ã€TopLink 10.1.3ä»¥åŠOpenJPAéƒ½æä¾›äº†JPAçš„å®ç°ã€‚\nåˆ©ç”¨JPAåˆ›å»ºMySQLæ•°æ®åº“\npom.xmlåŠ å…¥JPAå’ŒMySQLçš„ä¾èµ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-data-jpa\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.1.38\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; é…ç½®JPAå’Œæ•°æ®åº“\napplication.yml\n1 2 3 4 5 6 7 8 9 10 11 12 spring: profiles: active: a datasource: driver-class-name: com.mysql.jdbc.Driver url : jdbc:mysql://127.0.0.1:3306/heian username: root password: root jpa: hibernate: ddl-auto: update show-sql: true æ ¼å¼å¾ˆé‡è¦\néœ€è¦è‡ªå·±æ‰‹åŠ¨å»åˆ›å»º db_person æ•°æ®åº“\nåˆ›å»ºä¸æ•°æ®è¡¨å¯¹åº”çš„å®ä½“ç±»Person\nPerson.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 package com.example.demo.entity; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; /** * @Author:å—å®«ä¹˜é£ * @Date:2019/12/18 16:38 */ @Entity public class Person { @Id @GeneratedValue private Integer id; private String name; private Integer age; public Integer getId() { return id; } public void setId(Integer id) { this.id = id; } public String getName() { return name; } public void setName(String name) { this.name = name; } public Integer getAge() { return age; } public void setAge(Integer age) { this.age = age; } } è¿è¡Œé¡¹ç›®åï¼ŒæŸ¥çœ‹æ•°æ®åº“ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºè¡¨ person\næ¥ä¸‹æ¥å°±å¯ä»¥è¿›è¡Œpersonè¡¨çš„å¢åˆ æ”¹æŸ¥äº†\nåˆ›å»ºæ§åˆ¶å™¨PersonController.java\né¦–å…ˆåˆ›å»ºä¸€ä¸ªæ¥å£PersonMapperï¼Œä½äºdaoåŒ…ä¸‹,PersonControllerè°ƒç”¨è¯¥æ¥å£ç»§æ‰¿è‡ªJpaRepositoryçš„æ–¹æ³•ï¼Œæ¥å®ç°å’Œæ•°æ®åº“äº¤äº’\nè¿™ä¸ªPersonMapperæ¥å£çš„åŠŸèƒ½ï¼Œä¸SSMæ¡†æ¶ä¸­ dao å±‚æ¥å£åŠŸèƒ½æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼›åœ¨SSMæ¡†æ¶ä¸­ï¼ŒServiceå±‚é€šè¿‡è¯¥æ¥å£ï¼Œé—´æ¥æ‰§è¡ŒMybatisæ•°æ®åº“æ˜ å°„æ–‡ä»¶(.xml)é‡Œçš„ç›¸åº”sqlè¯­å¥ï¼Œæ‰§è¡Œæ•°æ®åº“å¢åˆ æ”¹æŸ¥çš„æ“ä½œã€‚(Mapperè‡ªåŠ¨å®ç°DAOæ¥å£)\nPersonMapper.java\n1 2 3 4 5 6 7 8 9 package com.example.demo.dao; import com.example.demo.entity.Person; import org.springframework.data.jpa.repository.JpaRepository; /** * @Author:å—å®«ä¹˜é£ * @Date:2019/12/18 16:38 */ public interface PersonMapper extends JpaRepository\u0026lt;Person,Integer\u0026gt; { } PersonController.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package com.example.demo.controller; import com.example.demo.dao.PersonMapper; import com.example.demo.entity.Person; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RestController; import java.util.List; /** * @Author:å—å®«ä¹˜é£ * @Date:2019/12/18 16:39 */ @RestController public class PersonController { @Autowired PersonMapper personMapper; @GetMapping(value = \u0026#34;/person\u0026#34;) public List\u0026lt;Person\u0026gt; personList(){ return personMapper.findAll(); } } åœ¨æ•°æ®åº“ä¸­æ·»åŠ ä¸¤æ¡æ•°æ®\nå¯åŠ¨é¡¹ç›®æ‰§è¡Œè¯·æ±‚http://localhost:8080/person\næ§åˆ¶å°è¾“å‡ºçš„sqlè¯­å¥ï¼š\nå…¶ä»–å¢åˆ æ”¹æŸ¥çš„æ–¹æ³•\nPersonController.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 /** * æ·»åŠ ä¸€ä¸ªäººå‘˜ * @param name * @param age * @return */ @PostMapping(value = \u0026#34;/person\u0026#34;) public Person add(@RequestParam(\u0026#34;name\u0026#34;) String name, @RequestParam(\u0026#34;age\u0026#34;) Integer age) { Person person = new Person(); person.setName(name); person.setAge(age); return personMapper.save(person); } åˆ©ç”¨ApiPostæµ‹è¯•ã€å·²ç»æˆåŠŸã€‘\næ›´æ–°å…¶ä»–æ–¹æ³•\n","date":"2019-12-18T17:45:19Z","image":"https://www.ownit.top/title_pic/38.jpg","permalink":"https://www.ownit.top/p/201912181745/","title":"Idea SpringBoot å¯¹æ•°æ®åº“å®ä¾‹è¯¦è§£"},{"content":"ä¼ä¸šçœŸå®åœºæ™¯ç”±äºç¡¬ç›˜å¸¸å¹´å¤§é‡è¯»å†™ï¼Œç»å¸¸ä¼šå‡ºç°åç›˜ï¼Œéœ€è¦æ›´æ¢ç¡¬ç›˜ã€‚æˆ–è€…ç”±äºç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€æ·»åŠ æ–°ç¡¬ç›˜ï¼Œæ–°æ·»åŠ çš„ç¡¬ç›˜éœ€è¦ç»è¿‡æ ¼å¼åŒ–ã€åˆ†åŒºæ‰èƒ½è¢« Linux ç³»ç»Ÿæ‰€ä½¿ç”¨ã€‚\nè™šæ‹Ÿæœº CentOS 7 Linux æ¨¡æ‹ŸDELL R730 çœŸå®æœåŠ¡å™¨æ·»åŠ ä¸€å—æ–°ç¡¬ç›˜ï¼Œä¸éœ€è¦å…³æœºï¼Œç›´æ¥æ’å…¥ç”¨ç¡¬ç›˜å³å¯ï¼Œä¸€èˆ¬ç¡¬ç›˜å‡æ”¯æŒçƒ­æ’æ‹”åŠŸèƒ½ã€‚ä¼ä¸šä¸­æ·»åŠ æ–°ç¡¬ç›˜çš„æ“ä½œæµç¨‹å¦‚ä¸‹ï¼š\nï¼ˆ1ï¼‰ æ£€æµ‹Linuxç³»ç»Ÿè¯†åˆ«çš„ç¡¬ç›˜è®¾å¤‡ï¼Œæ–°æ·»åŠ ç¡¬ç›˜è¢«è¯†åˆ«ä¸º/dev/sdbï¼Œå¦‚æœæœ‰å¤šå—ç¡¬ç›˜ï¼Œä¼šä¾æ¬¡è¯†åˆ«æˆ/dev/sdcã€/dev/sdd ç­‰è®¾å¤‡åç§°\n1 fdisk -l ï¼ˆ2ï¼‰ åŸºäºæ–°ç¡¬ç›˜/dev/sdbè®¾å¤‡ï¼Œåˆ›å»ºç£ç›˜åˆ†åŒº/dev/sdb1\n1 fdisk /dev/sdb ï¼ˆ3ï¼‰ fdisk åˆ†åŒºå‘½ä»¤å‚æ•°å¦‚ä¸‹ï¼Œå¸¸ç”¨å‚æ•°åŒ…æ‹¬mã€nã€pã€eã€dã€wã€‚\nï¼ˆ4ï¼‰ åˆ›å»º/dev/sdb1 åˆ†åŒºæ–¹æ³•ï¼Œfdisk /dev/sdbï¼Œç„¶åæŒ‰ n-p-1-Enter é”®+20G-Enter é”®-wï¼Œæœ€åæ‰§è¡Œ fdisk â€“l|tail -10\nï¼ˆ5ï¼‰ mkfs.ext4 /dev/sdb1 æ ¼å¼åŒ–ç£ç›˜åˆ†åŒº\n1 mkfs.ext4 /dev/sdb1 ï¼ˆ6ï¼‰ /dev/sdb1 åˆ†åŒºæ ¼å¼åŒ–ï¼Œä½¿ç”¨mount å‘½ä»¤æŒ‚è½½åˆ°/data/ç›®å½•\nmkdir -p /data/ åˆ›å»º/data/æ•°æ®ç›®å½• mount /dev/sdb1 /data æŒ‚è½½/dev/sdb1 åˆ†åŒºè‡³/data/ç›®å½• df -h æŸ¥çœ‹ç£ç›˜åˆ†åŒºè¯¦æƒ… echo \u0026ldquo;mount /dev/sdb1 /data\u0026rdquo; \u0026raquo;/etc/rc.local å°† æŒ‚ è½½ åˆ† åŒº å‘½ ä»¤ åŠ  å…¥/etc/rc.local å¼€æœºå¯åŠ¨ ï¼ˆ7ï¼‰ è‡ªåŠ¨æŒ‚è½½åˆ†åŒºé™¤äº†å¯ä»¥åŠ å…¥åˆ°/etc/rc.local å¼€æœºå¯åŠ¨ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åŠ å…¥åˆ°/etc/fstabæ–‡ä»¶ä¸­\n/dev/sdb1 /data/ ext4 defaultsÂ 0 0 mount -o rw,remount / é‡æ–°æŒ‚è½½/ç³»ç»Ÿï¼Œæ£€æµ‹/etc/fstab æ˜¯å¦æœ‰è¯¯ ","date":"2019-12-16T23:48:41Z","image":"https://www.ownit.top/title_pic/48.jpg","permalink":"https://www.ownit.top/p/201912162348/","title":"Linuxä¸‹ç£ç›˜å®æˆ˜æ“ä½œå‘½ä»¤"},{"content":"æ˜¯ä»€ä¹ˆ ä¸€å¥è¯ï¼šæœ‰ç‚¹ç±»ä¼¼æˆ‘ä»¬Redisé‡Œé¢çš„rdbå’Œaofæ–‡ä»¶\nå…ˆæ¥çœ‹çœ‹Dockerçš„ç†å¿µï¼š\n* å°†è¿ç”¨ä¸è¿è¡Œçš„ç¯å¢ƒæ‰“åŒ…å½¢æˆå®¹å™¨è¿è¡ŒÂ ï¼Œè¿è¡Œå¯ä»¥ä¼´éšç€å®¹å™¨ï¼Œä½†æ˜¯æˆ‘ä»¬å¯¹æ•°æ®çš„è¦æ±‚å¸Œæœ›æ˜¯æŒä¹…åŒ–çš„\n* å®¹å™¨ä¹‹é—´å¸Œæœ›æœ‰å¯èƒ½å…±äº«æ•°æ®\nDockerå®¹å™¨äº§ç”Ÿçš„æ•°æ®ï¼Œå¦‚æœä¸é€šè¿‡docker commitç”Ÿæˆæ–°çš„é•œåƒï¼Œä½¿å¾—æ•°æ®åšä¸ºé•œåƒçš„ä¸€éƒ¨åˆ†ä¿å­˜ä¸‹æ¥ï¼Œ\né‚£ä¹ˆå½“å®¹å™¨åˆ é™¤åï¼Œæ•°æ®è‡ªç„¶ä¹Ÿå°±æ²¡æœ‰äº†ã€‚\nä¸ºäº†èƒ½ä¿å­˜æ•°æ®åœ¨dockerä¸­æˆ‘ä»¬ä½¿ç”¨å·ã€‚\nèƒ½å¹²å˜› å®¹å™¨çš„æŒä¹…åŒ– å®¹å™¨é—´ç»§æ‰¿+å…±äº«æ•°æ® å·å°±æ˜¯ç›®å½•æˆ–æ–‡ä»¶ï¼Œå­˜åœ¨äºä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä¸­ï¼Œç”±dockeræŒ‚è½½åˆ°å®¹å™¨ï¼Œä½†ä¸å±äºè”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤èƒ½å¤Ÿç»•è¿‡Union File Systemæä¾›ä¸€äº›ç”¨äºæŒç»­å­˜å‚¨æˆ–å…±äº«æ•°æ®çš„ç‰¹æ€§ï¼š\nå·çš„è®¾è®¡ç›®çš„å°±æ˜¯æ•°æ®çš„æŒä¹…åŒ–ï¼Œå®Œå…¨ç‹¬ç«‹äºå®¹å™¨çš„ç”Ÿå­˜å‘¨æœŸï¼Œå› æ­¤Dockerä¸ä¼šåœ¨å®¹å™¨åˆ é™¤æ—¶åˆ é™¤å…¶æŒ‚è½½çš„æ•°æ®å·\nç‰¹ç‚¹ï¼š\n1ï¼šæ•°æ®å·å¯åœ¨å®¹å™¨ä¹‹é—´å…±äº«æˆ–é‡ç”¨æ•°æ® 2ï¼šå·ä¸­çš„æ›´æ”¹å¯ä»¥ç›´æ¥ç”Ÿæ•ˆ 3ï¼šæ•°æ®å·ä¸­çš„æ›´æ”¹ä¸ä¼šåŒ…å«åœ¨é•œåƒçš„æ›´æ–°ä¸­ 4ï¼šæ•°æ®å·çš„ç”Ÿå‘½å‘¨æœŸä¸€ç›´æŒç»­åˆ°æ²¡æœ‰å®¹å™¨ä½¿ç”¨å®ƒä¸ºæ­¢ æ•°æ®å· ç›´æ¥å‘½ä»¤æ·»åŠ  1ã€å‘½ä»¤ 1 docker run -it -v /å®¿ä¸»æœºç»å¯¹è·¯å¾„ç›®å½•:/å®¹å™¨å†…ç›®å½• é•œåƒå 1 docker run -it -v /wei:/wei centos 2ã€æŸ¥çœ‹æ•°æ®å·æ˜¯å¦æŒ‚è½½æˆåŠŸ 1 docker inspect df6f397beedd 3ã€å®¹å™¨å’Œå®¿ä¸»æœºä¹‹é—´æ•°æ®å…±äº« 4ã€å®¹å™¨åœæ­¢é€€å‡ºåï¼Œä¸»æœºä¿®æ”¹åæ•°æ®æ˜¯å¦åŒæ­¥ã€å®Œå…¨åŒæ­¥ã€‘ 5ã€å‘½ä»¤(å¸¦æƒé™) 1 docker run -it -v /å®¿ä¸»æœºç»å¯¹è·¯å¾„ç›®å½•:/å®¹å™¨å†…ç›®å½•:ro é•œåƒå DockerFileæ·»åŠ  1ã€æ ¹ç›®å½•ä¸‹æ–°å»ºmydockeræ–‡ä»¶å¤¹å¹¶è¿›å…¥\n2ã€å¯åœ¨Dockerfileä¸­ä½¿ç”¨VOLUMEæŒ‡ä»¤æ¥ç»™é•œåƒæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®å·\nVOLUME[\u0026quot;/dataVolumeContainer\u0026quot;,\u0026quot;/dataVolumeContainer2\u0026quot;,\u0026quot;/dataVolumeContainer3\u0026quot;]\nè¯´æ˜ï¼š\nå‡ºäºå¯ç§»æ¤å’Œåˆ†äº«çš„è€ƒè™‘ï¼Œç”¨-v ä¸»æœºç›®å½•:å®¹å™¨ç›®å½•è¿™ç§æ–¹æ³•ä¸èƒ½å¤Ÿç›´æ¥åœ¨Dockerfileä¸­å®ç°ã€‚\nç”±äºå®¿ä¸»æœºç›®å½•æ˜¯ä¾èµ–äºç‰¹å®šå®¿ä¸»æœºçš„ï¼Œå¹¶ä¸èƒ½å¤Ÿä¿è¯åœ¨æ‰€æœ‰çš„å®¿ä¸»æœºä¸Šéƒ½å­˜åœ¨è¿™æ ·çš„ç‰¹å®šç›®å½•ã€‚\n3ã€Fileæ„å»º\n1 2 3 4 5 6 7 8 9 # volume test FROM centos VOLUME [\u0026#34;/dataVolumeContainer1\u0026#34;,\u0026#34;/dataVolumeContainer2\u0026#34;] CMD echo \u0026#34;finished,--------success1\u0026#34; CMD /bin/bash 4ã€buildåç”Ÿæˆé•œåƒ\n1 docker build --f /root/heian -t heian/centos . 5ã€runå®¹å™¨\n6ã€é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œå®¹å™¨å†…çš„å·ç›®å½•åœ°å€å·²ç»çŸ¥é“å¯¹åº”çš„ä¸»æœºç›®å½•åœ°å€å“ªï¼Ÿï¼Ÿ\n7ã€ä¸»æœºå¯¹åº”é»˜è®¤åœ°å€ æ•°æ®å®Œå…¨å¯ä»¥åŒæ­¥\nå¤‡æ³¨ DockeræŒ‚è½½ä¸»æœºç›®å½•Dockerè®¿é—®å‡ºç°cannot open directory .: Permission denied\nè§£å†³åŠæ³•ï¼šåœ¨æŒ‚è½½ç›®å½•åå¤šåŠ ä¸€ä¸ª\u0026ndash;privileged=trueå‚æ•°å³å¯\næ•°æ®å·å®¹å™¨ æ˜¯ä»€ä¹ˆ å‘½åçš„å®¹å™¨æŒ‚è½½æ•°æ®å·ï¼Œå…¶å®ƒå®¹å™¨é€šè¿‡æŒ‚è½½è¿™ä¸ª(çˆ¶å®¹å™¨)å®ç°æ•°æ®å…±äº«ï¼ŒæŒ‚è½½æ•°æ®å·çš„å®¹å™¨ï¼Œç§°ä¹‹ä¸ºæ•°æ®å·å®¹å™¨\næ€»ä½“ä»‹ç» 1ã€ä»¥ä¸Šä¸€æ­¥æ–°å»ºçš„é•œåƒheian/centosä¸ºæ¨¡æ¿å¹¶è¿è¡Œå®¹å™¨dc01/dc02/dc03\n2ã€å®ƒä»¬å·²ç»å…·æœ‰å®¹å™¨å·\n/dataVolumeContainer1 /dataVolumeContainer2 å®¹å™¨é—´ä¼ é€’å…±äº«(\u0026ndash;volumes-from) 1ã€å…ˆå¯åŠ¨ä¸€ä¸ªçˆ¶å®¹å™¨dc01ï¼Œåœ¨dataVolumeContainer2æ–°å¢å†…å®¹\n2ã€dc02/dc03ç»§æ‰¿è‡ªdc01\n1 docker run -it --name dc02 --volumes-from dc01 zzyy/centos dc02/dc03åˆ†åˆ«åœ¨dataVolumeContainer2å„è‡ªæ–°å¢å†…å®¹\n3ã€å›åˆ°dc01å¯ä»¥çœ‹åˆ°02/03å„è‡ªæ·»åŠ çš„éƒ½èƒ½å…±äº«äº†\n4ã€åˆ é™¤dc01ï¼Œdc02ä¿®æ”¹ådc03å¯å¦è®¿é—®\n5ã€åˆ é™¤dc02ådc03å¯å¦è®¿é—®\nå†è¿›ä¸€æ­¥\n6ã€æ–°å»ºdc04ç»§æ‰¿dc03åå†åˆ é™¤dc03\nç»“è®ºï¼šå®¹å™¨ä¹‹é—´é…ç½®ä¿¡æ¯çš„ä¼ é€’ï¼Œæ•°æ®å·çš„ç”Ÿå‘½å‘¨æœŸä¸€ç›´æŒç»­åˆ°æ²¡æœ‰å®¹å™¨ä½¿ç”¨å®ƒä¸ºæ­¢\n","date":"2019-12-12T11:41:16Z","image":"https://www.ownit.top/title_pic/17.jpg","permalink":"https://www.ownit.top/p/201912121141/","title":"Dockerå®¹å™¨æ•°æ®å·ä»‹ç»å’Œå‘½ä»¤"},{"content":"ç›®å½•\næ˜¯ä»€ä¹ˆ\nUnionFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰\nDockeré•œåƒåŠ è½½åŸç†\nåˆ†å±‚çš„é•œåƒ\nä¸ºä»€ä¹ˆ Docker é•œåƒè¦é‡‡ç”¨è¿™ç§åˆ†å±‚ç»“æ„å‘¢\nç‰¹ç‚¹\nDockeré•œåƒcommitæ“ä½œè¡¥å……\næ¡ˆä¾‹æ¼”ç¤º\n1ã€ä»Hubä¸Šä¸‹è½½tomcaté•œåƒåˆ°æœ¬åœ°å¹¶æˆåŠŸè¿è¡Œ\n2ã€æ•…æ„åˆ é™¤ä¸Šä¸€æ­¥é•œåƒç”Ÿäº§tomcatå®¹å™¨çš„æ–‡æ¡£\n3ã€commitä¸€ä¸ªæ²¡æœ‰docçš„tomcatæ–°é•œåƒ\n4.å¯åŠ¨æˆ‘ä»¬çš„æ–°é•œåƒå¹¶å’ŒåŸæ¥çš„å¯¹æ¯”\næ˜¯ä»€ä¹ˆ é•œåƒæ˜¯ä¸€ç§è½»é‡çº§ã€å¯æ‰§è¡Œçš„ç‹¬ç«‹è½¯ä»¶åŒ…ï¼Œç”¨æ¥æ‰“åŒ…è½¯ä»¶è¿è¡Œç¯å¢ƒå’ŒåŸºäºè¿è¡Œç¯å¢ƒå¼€å‘çš„è½¯ä»¶ï¼Œå®ƒåŒ…å«è¿è¡ŒæŸä¸ªè½¯ä»¶æ‰€éœ€çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬ä»£ç ã€è¿è¡Œæ—¶ã€åº“ã€ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶ã€‚\nUnionFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰ UnionFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰ï¼šUnionæ–‡ä»¶ç³»ç»Ÿï¼ˆUnionFSï¼‰æ˜¯ä¸€ç§åˆ†å±‚ã€è½»é‡çº§å¹¶ä¸”é«˜æ€§èƒ½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæ”¯æŒå¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹ä½œä¸ºä¸€æ¬¡æäº¤æ¥ä¸€å±‚å±‚çš„å åŠ ï¼ŒåŒæ—¶å¯ä»¥å°†ä¸åŒç›®å½•æŒ‚è½½åˆ°åŒä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸‹(unite several directories into a single virtual filesystem)ã€‚Union æ–‡ä»¶ç³»ç»Ÿæ˜¯ Docker é•œåƒçš„åŸºç¡€ã€‚é•œåƒå¯ä»¥é€šè¿‡åˆ†å±‚æ¥è¿›è¡Œç»§æ‰¿ï¼ŒåŸºäºåŸºç¡€é•œåƒï¼ˆæ²¡æœ‰çˆ¶é•œåƒï¼‰ï¼Œå¯ä»¥åˆ¶ä½œå„ç§å…·ä½“çš„åº”ç”¨é•œåƒã€‚\nç‰¹æ€§ï¼šä¸€æ¬¡åŒæ—¶åŠ è½½å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä½†ä»å¤–é¢çœ‹èµ·æ¥ï¼Œåªèƒ½çœ‹åˆ°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè”åˆåŠ è½½ä¼šæŠŠå„å±‚æ–‡ä»¶ç³»ç»Ÿå åŠ èµ·æ¥ï¼Œè¿™æ ·æœ€ç»ˆçš„æ–‡ä»¶ç³»ç»Ÿä¼šåŒ…å«æ‰€æœ‰åº•å±‚çš„æ–‡ä»¶å’Œç›®å½•\nDockeré•œåƒåŠ è½½åŸç† dockerçš„é•œåƒå®é™…ä¸Šç”±ä¸€å±‚ä¸€å±‚çš„æ–‡ä»¶ç³»ç»Ÿç»„æˆï¼Œè¿™ç§å±‚çº§çš„æ–‡ä»¶ç³»ç»ŸUnionFSã€‚\nbootfs(boot file system)ä¸»è¦åŒ…å«bootloaderå’Œkernel, bootloaderä¸»è¦æ˜¯å¼•å¯¼åŠ è½½kernel, Linuxåˆšå¯åŠ¨æ—¶ä¼šåŠ è½½bootfsæ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨Dockeré•œåƒçš„æœ€åº•å±‚æ˜¯bootfsã€‚è¿™ä¸€å±‚ä¸æˆ‘ä»¬å…¸å‹çš„Linux/Unixç³»ç»Ÿæ˜¯ä¸€æ ·çš„ï¼ŒåŒ…å«bootåŠ è½½å™¨å’Œå†…æ ¸ã€‚å½“bootåŠ è½½å®Œæˆä¹‹åæ•´ä¸ªå†…æ ¸å°±éƒ½åœ¨å†…å­˜ä¸­äº†ï¼Œæ­¤æ—¶å†…å­˜çš„ä½¿ç”¨æƒå·²ç”±bootfsè½¬äº¤ç»™å†…æ ¸ï¼Œæ­¤æ—¶ç³»ç»Ÿä¹Ÿä¼šå¸è½½bootfsã€‚\nrootfs (root file system) ï¼Œåœ¨bootfsä¹‹ä¸Šã€‚åŒ…å«çš„å°±æ˜¯å…¸å‹ Linux ç³»ç»Ÿä¸­çš„ /dev, /proc, /bin, /etc ç­‰æ ‡å‡†ç›®å½•å’Œæ–‡ä»¶ã€‚rootfså°±æ˜¯å„ç§ä¸åŒçš„æ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆï¼Œæ¯”å¦‚Ubuntuï¼ŒCentosç­‰ç­‰ã€‚\n**Â å¹³æ—¶æˆ‘ä»¬å®‰è£…è¿›è™šæ‹Ÿæœºçš„CentOSéƒ½æ˜¯å¥½å‡ ä¸ªGï¼Œä¸ºä»€ä¹ˆdockerè¿™é‡Œæ‰200Mï¼Ÿï¼Ÿ**\nåˆ†å±‚çš„é•œåƒ ä»¥æˆ‘ä»¬çš„pullä¸ºä¾‹ï¼Œåœ¨ä¸‹è½½çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°dockerçš„é•œåƒå¥½åƒæ˜¯åœ¨ä¸€å±‚ä¸€å±‚çš„åœ¨ä¸‹è½½\nä¸ºä»€ä¹ˆ Docker é•œåƒè¦é‡‡ç”¨è¿™ç§åˆ†å±‚ç»“æ„å‘¢ æœ€å¤§çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯ - å…±äº«èµ„æº\næ¯”å¦‚ï¼šæœ‰å¤šä¸ªé•œåƒéƒ½ä»ç›¸åŒçš„ base é•œåƒæ„å»ºè€Œæ¥ï¼Œé‚£ä¹ˆå®¿ä¸»æœºåªéœ€åœ¨ç£ç›˜ä¸Šä¿å­˜ä¸€ä»½baseé•œåƒï¼Œ\nåŒæ—¶å†…å­˜ä¸­ä¹Ÿåªéœ€åŠ è½½ä¸€ä»½ base é•œåƒï¼Œå°±å¯ä»¥ä¸ºæ‰€æœ‰å®¹å™¨æœåŠ¡äº†ã€‚è€Œä¸”é•œåƒçš„æ¯ä¸€å±‚éƒ½å¯ä»¥è¢«å…±äº«ã€‚\nç‰¹ç‚¹ Dockeré•œåƒéƒ½æ˜¯åªè¯»çš„\nå½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¸€ä¸ªæ–°çš„å¯å†™å±‚è¢«åŠ è½½åˆ°é•œåƒçš„é¡¶éƒ¨ã€‚\nè¿™ä¸€å±‚é€šå¸¸è¢«ç§°ä½œâ€œå®¹å™¨å±‚â€ï¼Œâ€œå®¹å™¨å±‚â€ä¹‹ä¸‹çš„éƒ½å«â€œé•œåƒå±‚â€ã€‚\nDockeré•œåƒcommitæ“ä½œè¡¥å…… docker commitæäº¤å®¹å™¨å‰¯æœ¬ä½¿ä¹‹æˆä¸ºä¸€ä¸ªæ–°çš„é•œåƒ\ndocker commit -m=â€œæäº¤çš„æè¿°ä¿¡æ¯â€ -a=â€œä½œè€…â€ å®¹å™¨ID è¦åˆ›å»ºçš„ç›®æ ‡é•œåƒå:[æ ‡ç­¾å]\næ¡ˆä¾‹æ¼”ç¤º 1ã€ä»Hubä¸Šä¸‹è½½tomcaté•œåƒåˆ°æœ¬åœ°å¹¶æˆåŠŸè¿è¡Œ -p ä¸»æœºç«¯å£:dockerå®¹å™¨ç«¯å£ã€æŒ‡å®šç«¯å£ã€‘\n1 docker run -it -p 8080:8080 tomcat -P éšæœºåˆ†é…ç«¯å£\n1 docker run -it -P tomcat i:äº¤äº’\nt:ç»ˆç«¯\n2ã€æ•…æ„åˆ é™¤ä¸Šä¸€æ­¥é•œåƒç”Ÿäº§tomcatå®¹å™¨çš„æ–‡æ¡£ 3ã€commitä¸€ä¸ªæ²¡æœ‰docçš„tomcatæ–°é•œåƒ ä¹Ÿå³å½“å‰çš„tomcatè¿è¡Œå®ä¾‹æ˜¯ä¸€ä¸ªæ²¡æœ‰æ–‡æ¡£å†…å®¹çš„å®¹å™¨ï¼Œ\nä»¥å®ƒä¸ºæ¨¡æ¿commitä¸€ä¸ªæ²¡æœ‰docçš„tomcatæ–°é•œåƒheian/tomcat02\n1 docker commit -a \u0026#34;wei\u0026#34; -m \u0026#34;del tomcat docs\u0026#34; 63982bc3e2d9 heian/mytomcat:1.2 4.å¯åŠ¨æˆ‘ä»¬çš„æ–°é•œåƒå¹¶å’ŒåŸæ¥çš„å¯¹æ¯” å¯åŠ¨heian/tomcat02ï¼Œå®ƒæ²¡æœ‰docs\n1 docker run -it -p 7777:8080 heian/mytomcat:1.2 æ–°å¯åŠ¨åŸæ¥çš„tomcatï¼Œå®ƒæœ‰docs\n","date":"2019-12-12T10:19:06Z","image":"https://www.ownit.top/title_pic/04.jpg","permalink":"https://www.ownit.top/p/201912121019/","title":"Docker é•œåƒä»‹ç»å’Œå‘½ä»¤"},{"content":"\nattach Attach to a running container # å½“å‰ shell ä¸‹ attach è¿æ¥æŒ‡å®šè¿è¡Œé•œåƒ **build **Â Build an image from a Dockerfile # é€šè¿‡ Dockerfile å®šåˆ¶é•œåƒ commit Create a new image from a container changes # æäº¤å½“å‰å®¹å™¨ä¸ºæ–°çš„é•œåƒ **cp **Â Copy files/folders from the containers filesystem to the host path #ä»å®¹å™¨ä¸­æ‹·è´æŒ‡å®šæ–‡ä»¶æˆ–è€…ç›®å½•åˆ°å®¿ä¸»æœºä¸­ create Create a new container # åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼ŒåŒ runï¼Œä½†ä¸å¯åŠ¨å®¹å™¨ diff Inspect changes on a container\u0026rsquo;s filesystem # æŸ¥çœ‹ docker å®¹å™¨å˜åŒ– events Get real time events from the server # ä» docker æœåŠ¡è·å–å®¹å™¨å®æ—¶äº‹ä»¶ exec Run a command in an existing container # åœ¨å·²å­˜åœ¨çš„å®¹å™¨ä¸Šè¿è¡Œå‘½ä»¤ export Stream the contents of a container as a tar archive # å¯¼å‡ºå®¹å™¨çš„å†…å®¹æµä½œä¸ºä¸€ä¸ª tar å½’æ¡£æ–‡ä»¶[å¯¹åº” import ] history Show the history of an image # å±•ç¤ºä¸€ä¸ªé•œåƒå½¢æˆå†å² images List images # åˆ—å‡ºç³»ç»Ÿå½“å‰é•œåƒ import Create a new filesystem image from the contents of a tarball # ä»taråŒ…ä¸­çš„å†…å®¹åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ç³»ç»Ÿæ˜ åƒ[å¯¹åº”export] **info **Â Display system-wide information # æ˜¾ç¤ºç³»ç»Ÿç›¸å…³ä¿¡æ¯ inspect Return low-level information on a container # æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯ kill Kill a running container # kill æŒ‡å®š docker å®¹å™¨ load Load an image from a tar archive # ä»ä¸€ä¸ª tar åŒ…ä¸­åŠ è½½ä¸€ä¸ªé•œåƒ[å¯¹åº” save] login Register or Login to the docker registry server # æ³¨å†Œæˆ–è€…ç™»é™†ä¸€ä¸ª docker æºæœåŠ¡å™¨ logout Log out from a Docker registry server # ä»å½“å‰ Docker registry é€€å‡º logs Fetch the logs of a container # è¾“å‡ºå½“å‰å®¹å™¨æ—¥å¿—ä¿¡æ¯ port Lookup the public-facing port which is NAT-ed to PRIVATE_PORT # æŸ¥çœ‹æ˜ å°„ç«¯å£å¯¹åº”çš„å®¹å™¨å†…éƒ¨æºç«¯å£ pause Pause all processes within a container # æš‚åœå®¹å™¨ **ps **Â List containers # åˆ—å‡ºå®¹å™¨åˆ—è¡¨ pull Pull an image or a repository from the docker registry server # ä»dockeré•œåƒæºæœåŠ¡å™¨æ‹‰å–æŒ‡å®šé•œåƒæˆ–è€…åº“é•œåƒ push Push an image or a repository to the docker registry server # æ¨é€æŒ‡å®šé•œåƒæˆ–è€…åº“é•œåƒè‡³dockeræºæœåŠ¡å™¨ restart Restart a running container # é‡å¯è¿è¡Œçš„å®¹å™¨ rm Remove one or more containers # ç§»é™¤ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ **rmi **Â Remove one or more images # ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒ[æ— å®¹å™¨ä½¿ç”¨è¯¥é•œåƒæ‰å¯åˆ é™¤ï¼Œå¦åˆ™éœ€åˆ é™¤ç›¸å…³å®¹å™¨æ‰å¯ç»§ç»­æˆ– -f å¼ºåˆ¶åˆ é™¤] run Run a command in a new container # åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨å¹¶è¿è¡Œä¸€ä¸ªå‘½ä»¤ save Save an image to a tar archive # ä¿å­˜ä¸€ä¸ªé•œåƒä¸ºä¸€ä¸ª tar åŒ…[å¯¹åº” load] search Search for an image on the Docker Hub # åœ¨ docker hub ä¸­æœç´¢é•œåƒ start Start a stopped containers # å¯åŠ¨å®¹å™¨ stop Stop a running containers # åœæ­¢å®¹å™¨ **tag **Â Tag an image into a repository # ç»™æºä¸­é•œåƒæ‰“æ ‡ç­¾ **top **Â Lookup the running processes of a container # æŸ¥çœ‹å®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹ä¿¡æ¯ unpause Unpause a paused container # å–æ¶ˆæš‚åœå®¹å™¨ version Show the docker version information # æŸ¥çœ‹ docker ç‰ˆæœ¬å· wait Block until a container stops, then print its exit code # æˆªå–å®¹å™¨åœæ­¢æ—¶çš„é€€å‡ºçŠ¶æ€å€¼ ","date":"2019-12-10T15:13:46Z","image":"https://www.ownit.top/title_pic/52.jpg","permalink":"https://www.ownit.top/p/201912101513/","title":"Dockerå‘½ä»¤æ€»ç»“"},{"content":"ç›®å½•\nå¯åŠ¨å®ˆæŠ¤å¼å®¹å™¨\næŸ¥çœ‹å®¹å™¨æ—¥å¿—\ndockeråå°è¿è¡Œ\næŸ¥çœ‹å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹\nâ€‹æŸ¥çœ‹å®¹å™¨å†…éƒ¨ç»†èŠ‚\nè¿›å…¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨å¹¶ä»¥å‘½ä»¤è¡Œäº¤äº’\né‡æ–°è¿›å…¥\nä¸Šè¿°ä¸¤ä¸ªåŒºåˆ«\nä»å®¹å™¨å†…æ‹·è´æ–‡ä»¶åˆ°ä¸»æœºä¸Š\nå¯åŠ¨å®ˆæŠ¤å¼å®¹å™¨ 1 docker run -d å®¹å™¨å #ä½¿ç”¨é•œåƒcentos:latestä»¥åå°æ¨¡å¼å¯åŠ¨ä¸€ä¸ªå®¹å™¨\n1 docker run -d centos é—®é¢˜ï¼šç„¶ådocker ps -a è¿›è¡ŒæŸ¥çœ‹,Â ä¼šå‘ç°å®¹å™¨å·²ç»é€€å‡º\nå¾ˆé‡è¦çš„è¦è¯´æ˜çš„ä¸€ç‚¹:Â Dockerå®¹å™¨åå°è¿è¡Œ,å°±å¿…é¡»æœ‰ä¸€ä¸ªå‰å°è¿›ç¨‹.\nå®¹å™¨è¿è¡Œçš„å‘½ä»¤å¦‚æœä¸æ˜¯é‚£äº›ä¸€ç›´æŒ‚èµ·çš„å‘½ä»¤ï¼ˆæ¯”å¦‚è¿è¡Œtopï¼Œtailï¼‰ï¼Œå°±æ˜¯ä¼šè‡ªåŠ¨é€€å‡ºçš„ã€‚\nè¿™ä¸ªæ˜¯dockerçš„æœºåˆ¶é—®é¢˜,æ¯”å¦‚ä½ çš„webå®¹å™¨,æˆ‘ä»¬ä»¥nginxä¸ºä¾‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹,æˆ‘ä»¬é…ç½®å¯åŠ¨æœåŠ¡åªéœ€è¦å¯åŠ¨å“åº”çš„serviceå³å¯ã€‚ä¾‹å¦‚\n1 service nginx start ä½†æ˜¯,è¿™æ ·åš,nginxä¸ºåå°è¿›ç¨‹æ¨¡å¼è¿è¡Œ,å°±å¯¼è‡´dockerå‰å°æ²¡æœ‰è¿è¡Œçš„åº”ç”¨,\nè¿™æ ·çš„å®¹å™¨åå°å¯åŠ¨å,ä¼šç«‹å³è‡ªæ€å› ä¸ºä»–è§‰å¾—ä»–æ²¡äº‹å¯åšäº†.\næ‰€ä»¥ï¼Œæœ€ä½³çš„è§£å†³æ–¹æ¡ˆæ˜¯,å°†ä½ è¦è¿è¡Œçš„ç¨‹åºä»¥å‰å°è¿›ç¨‹çš„å½¢å¼è¿è¡Œ\næŸ¥çœ‹å®¹å™¨æ—¥å¿— 1 docker logs -f -t --tail å®¹å™¨ID * -t æ˜¯åŠ å…¥æ—¶é—´æˆ³ * -f è·Ÿéšæœ€æ–°çš„æ—¥å¿—æ‰“å° * \u0026ndash;tail æ•°å­— æ˜¾ç¤ºæœ€åå¤šå°‘æ¡ dockeråå°è¿è¡Œ 1 docker run -d centos /bin/sh -c \u0026#34;while true;do echo hello zzyy;sleep 2;done\u0026#34; æŸ¥çœ‹å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹ 1 docker top å®¹å™¨ID æŸ¥çœ‹å®¹å™¨å†…éƒ¨ç»†èŠ‚ 1 docker inspect å®¹å™¨ID è¿›å…¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨å¹¶ä»¥å‘½ä»¤è¡Œäº¤äº’ 1 docker exec -it å®¹å™¨ID bashShell é‡æ–°è¿›å…¥ 1 docker attach å®¹å™¨ID ä¸Šè¿°ä¸¤ä¸ªåŒºåˆ« attachï¼š ç›´æ¥è¿›å…¥å®¹å™¨å¯åŠ¨å‘½ä»¤çš„ç»ˆç«¯ï¼Œä¸ä¼šå¯åŠ¨æ–°çš„è¿›ç¨‹ execï¼š æ˜¯åœ¨å®¹å™¨ä¸­æ‰“å¼€æ–°çš„ç»ˆç«¯ï¼Œå¹¶ä¸”å¯ä»¥å¯åŠ¨æ–°çš„è¿›ç¨‹ ä»å®¹å™¨å†…æ‹·è´æ–‡ä»¶åˆ°ä¸»æœºä¸Š 1 docker cp å®¹å™¨ID:å®¹å™¨å†…è·¯å¾„ ç›®çš„ä¸»æœºè·¯å¾„ ","date":"2019-12-10T15:01:46Z","image":"https://www.ownit.top/title_pic/61.jpg","permalink":"https://www.ownit.top/p/201912101501/","title":"Dockerå¯åŠ¨å®ˆæŠ¤å¼å®¹å™¨"},{"content":"ç›®å½•\næ–°å»ºå¹¶å¯åŠ¨å®¹å™¨\nOPTIONSè¯´æ˜\nå¯åŠ¨äº¤äº’å¼å®¹å™¨\nåˆ—å‡ºå½“å‰æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨\né€€å‡ºå®¹å™¨\nexit\nctrl+P+Q\nè¿›å…¥å‡ºå®¹å™¨\nå¯åŠ¨å®¹å™¨\nåœæ­¢å®¹å™¨\nå¼ºåˆ¶åœæ­¢å®¹å™¨\nåˆ é™¤å·²åœæ­¢çš„å®¹å™¨\nä¸€æ¬¡æ€§åˆ é™¤å¤šä¸ªå®¹å™¨\næœ‰é•œåƒæ‰èƒ½åˆ›å»ºå®¹å™¨ï¼Œè¿™æ˜¯æ ¹æœ¬å‰æ(ä¸‹è½½ä¸€ä¸ªCentOSé•œåƒæ¼”ç¤º)\n1 docker pull centos æ–°å»ºå¹¶å¯åŠ¨å®¹å™¨ docker run [OPTIONS] IMAGE [COMMAND] [ARG\u0026hellip;]\nOPTIONSè¯´æ˜ OPTIONSè¯´æ˜ï¼ˆå¸¸ç”¨ï¼‰ï¼šæœ‰äº›æ˜¯ä¸€ä¸ªå‡å·ï¼Œæœ‰äº›æ˜¯ä¸¤ä¸ªå‡å·\n--name=\u0026ldquo;å®¹å™¨æ–°åå­—\u0026rdquo;: ä¸ºå®¹å™¨æŒ‡å®šä¸€ä¸ªåç§°ï¼› -d: åå°è¿è¡Œå®¹å™¨ï¼Œå¹¶è¿”å›å®¹å™¨IDï¼Œä¹Ÿå³å¯åŠ¨å®ˆæŠ¤å¼å®¹å™¨ï¼› -iï¼šä»¥äº¤äº’æ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œé€šå¸¸ä¸ -t åŒæ—¶ä½¿ç”¨ï¼› -tï¼šä¸ºå®¹å™¨é‡æ–°åˆ†é…ä¸€ä¸ªä¼ªè¾“å…¥ç»ˆç«¯ï¼Œé€šå¸¸ä¸ -i åŒæ—¶ä½¿ç”¨ï¼› -P: éšæœºç«¯å£æ˜ å°„ï¼› -p: æŒ‡å®šç«¯å£æ˜ å°„ï¼Œæœ‰ä»¥ä¸‹å››ç§æ ¼å¼ ip:hostPort:containerPort ip::containerPort hostPort:containerPort containerPort å¯åŠ¨äº¤äº’å¼å®¹å™¨ #ä½¿ç”¨é•œåƒcentos:latestä»¥äº¤äº’æ¨¡å¼å¯åŠ¨ä¸€ä¸ªå®¹å™¨,åœ¨å®¹å™¨å†…æ‰§è¡Œ/bin/bashå‘½ä»¤ã€‚\n1 docker run -it centos /bin/bash åˆ—å‡ºå½“å‰æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨ docker ps [OPTIONS]\nOPTIONSè¯´æ˜ï¼ˆå¸¸ç”¨ï¼‰ï¼š\n-a :åˆ—å‡ºå½“å‰æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨+å†å²ä¸Šè¿è¡Œè¿‡çš„ï¼ˆdocker psï¼‰ -l :æ˜¾ç¤ºæœ€è¿‘åˆ›å»ºçš„å®¹å™¨ã€‚ -nï¼šæ˜¾ç¤ºæœ€è¿‘nä¸ªåˆ›å»ºçš„å®¹å™¨ã€‚ -q :é™é»˜æ¨¡å¼ï¼Œåªæ˜¾ç¤ºå®¹å™¨ç¼–å·ã€‚ --no-trunc :ä¸æˆªæ–­è¾“å‡º é€€å‡ºå®¹å™¨ exit å®¹å™¨åœæ­¢é€€å‡º ctrl+P+Q å®¹å™¨ä¸åœæ­¢é€€å‡º è¿›å…¥å‡ºå®¹å™¨ docker attachÂ åç§°\n1 docker attach edc486762ad2 å¯åŠ¨å®¹å™¨ 1 docker start å®¹å™¨IDæˆ–è€…å®¹å™¨å é‡å¯å®¹å™¨\n1 docker restart å®¹å™¨IDæˆ–è€…å®¹å™¨å åœæ­¢å®¹å™¨ 1 docker stop å®¹å™¨IDæˆ–è€…å®¹å™¨å å¼ºåˆ¶åœæ­¢å®¹å™¨ 1 docker kill å®¹å™¨IDæˆ–è€…å®¹å™¨å åˆ é™¤å·²åœæ­¢çš„å®¹å™¨ 1 docker rm å®¹å™¨ID ä¸€æ¬¡æ€§åˆ é™¤å¤šä¸ªå®¹å™¨ 1 docker rm -f $(docker ps -a -q) 1 docker ps -a -q | xargs docker rm ","date":"2019-12-10T14:15:02Z","image":"https://www.ownit.top/title_pic/15.jpg","permalink":"https://www.ownit.top/p/201912101415/","title":"Dockerå®¹å™¨å¸¸ç”¨å‘½ä»¤"},{"content":"ç›®å½•\nå¸®åŠ©å‘½ä»¤\né•œåƒå‘½ä»¤\nåˆ—å‡ºæœ¬åœ°ä¸»æœºä¸Šçš„é•œåƒ\ndocker search æŸä¸ªXXXé•œåƒåå­—\ndocker pull æŸä¸ªXXXé•œåƒåå­—\nåˆ é™¤é•œåƒ\nå¸®åŠ©å‘½ä»¤ 1 docker version 1 docker info 1 docker --help é•œåƒå‘½ä»¤ 1 docker images åˆ—å‡ºæœ¬åœ°ä¸»æœºä¸Šçš„é•œåƒ å„ä¸ªé€‰é¡¹è¯´æ˜:\nREPOSITORYï¼šè¡¨ç¤ºé•œåƒçš„ä»“åº“æº TAGï¼šé•œåƒçš„æ ‡ç­¾ IMAGE IDï¼šé•œåƒID CREATEDï¼šé•œåƒåˆ›å»ºæ—¶é—´ SIZEï¼šé•œåƒå¤§å° -a :åˆ—å‡ºæœ¬åœ°æ‰€æœ‰çš„é•œåƒï¼ˆå«ä¸­é—´æ˜ åƒå±‚ï¼‰ -q :åªæ˜¾ç¤ºé•œåƒIDã€‚ --digests :æ˜¾ç¤ºé•œåƒçš„æ‘˜è¦ä¿¡æ¯ --no-trunc :æ˜¾ç¤ºå®Œæ•´çš„é•œåƒä¿¡æ¯ åŒä¸€ä»“åº“æºå¯ä»¥æœ‰å¤šä¸ª TAGï¼Œä»£è¡¨è¿™ä¸ªä»“åº“æºçš„ä¸åŒä¸ªç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä½¿ç”¨ REPOSITORY:TAG æ¥å®šä¹‰ä¸åŒçš„é•œåƒã€‚\nå¦‚æœä½ ä¸æŒ‡å®šä¸€ä¸ªé•œåƒçš„ç‰ˆæœ¬æ ‡ç­¾ï¼Œä¾‹å¦‚ä½ åªä½¿ç”¨ ubuntuï¼Œdocker å°†é»˜è®¤ä½¿ç”¨ ubuntu:latest é•œåƒ\ndocker search æŸä¸ªXXXé•œåƒåå­— ç½‘ç«™\nhttps://hub.docker.com\nå‘½ä»¤\n1 docker search [OPTIONS] é•œåƒåå­— OPTIONSè¯´æ˜ï¼š\n--no-trunc : æ˜¾ç¤ºå®Œæ•´çš„é•œåƒæè¿° -s : åˆ—å‡ºæ”¶è—æ•°ä¸å°äºæŒ‡å®šå€¼çš„é•œåƒã€‚ --automated : åªåˆ—å‡º automated buildç±»å‹çš„é•œåƒï¼› docker pull æŸä¸ªXXXé•œåƒåå­— ä¸‹è½½é•œåƒ\n1 docker pull é•œåƒåå­—[:TAG] 1 docker pull tomcat åˆ é™¤é•œåƒ docker rmi æŸä¸ªXXXé•œåƒåå­—ID\nåˆ é™¤å•ä¸ª\n1 docker rmi -f é•œåƒID åˆ é™¤å¤šä¸ª\n1 docker rmi -f é•œåƒå1:TAG é•œåƒå2:TAG 1 docker rmi -f hello-world nginx åˆ é™¤å…¨éƒ¨\n1 docker rmi -f $(docker images -qa) ","date":"2019-12-09T17:24:35Z","image":"https://www.ownit.top/title_pic/49.jpg","permalink":"https://www.ownit.top/p/201912091724/","title":"Dockeré•œåƒå¸¸ç”¨å‘½ä»¤"},{"content":"ç›®å½•\nå‰æœŸè¯´æ˜\nå®‰è£…æ­¥éª¤\n1ã€å®˜ç½‘ä¸­æ–‡å®‰è£…å‚è€ƒæ‰‹å†Œ\n2ã€ç¡®å®šä½ æ˜¯CentOS7åŠä»¥ä¸Šç‰ˆæœ¬\n3ã€yumå®‰è£…gccç›¸å…³\n4ã€å¸è½½æ—§ç‰ˆæœ¬\n5ã€å®‰è£…éœ€è¦çš„è½¯ä»¶åŒ…\n6ã€è®¾ç½®stableé•œåƒä»“åº“\n7ã€æ›´æ–°yumè½¯ä»¶åŒ…ç´¢å¼•\n8ã€å®‰è£…DOCKER-CE\n9ã€å¯åŠ¨docker\n10ã€æµ‹è¯•\n11ã€é…ç½®é•œåƒåŠ é€Ÿ\n12ã€å¸è½½\nåº•å±‚åŸç†\n1ã€Dockeræ˜¯æ€ä¹ˆå·¥ä½œçš„\n2ã€ä¸ºä»€ä¹ˆDockeræ¯”è¾ƒæ¯”VMå¿«\nå‰æœŸè¯´æ˜ CentOS Docker å®‰è£…\nDockeræ”¯æŒä»¥ä¸‹çš„CentOSç‰ˆæœ¬ï¼š\nCentOS 7 (64-bit)\nCentOS 6.5 (64-bit) æˆ–æ›´é«˜çš„ç‰ˆæœ¬\nå‰ææ¡ä»¶\nç›®å‰ï¼ŒCentOS ä»…å‘è¡Œç‰ˆæœ¬ä¸­çš„å†…æ ¸æ”¯æŒ Dockerã€‚\nDocker è¿è¡Œåœ¨ CentOS 7 ä¸Šï¼Œè¦æ±‚ç³»ç»Ÿä¸º64ä½ã€ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬ä¸º 3.10 ä»¥ä¸Šã€‚\nDocker è¿è¡Œåœ¨ CentOS-6.5 æˆ–æ›´é«˜çš„ç‰ˆæœ¬çš„ CentOS ä¸Šï¼Œè¦æ±‚ç³»ç»Ÿä¸º64ä½ã€ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬ä¸º 2.6.32-431 æˆ–è€…æ›´é«˜ç‰ˆæœ¬ã€‚\næŸ¥çœ‹è‡ªå·±çš„å†…æ ¸\nunameå‘½ä»¤ç”¨äºæ‰“å°å½“å‰ç³»ç»Ÿç›¸å…³ä¿¡æ¯ï¼ˆå†…æ ¸ç‰ˆæœ¬å·ã€ç¡¬ä»¶æ¶æ„ã€ä¸»æœºåç§°å’Œæ“ä½œç³»ç»Ÿç±»å‹ç­‰ï¼‰ã€‚\næŸ¥çœ‹å·²å®‰è£…çš„CentOSç‰ˆæœ¬ä¿¡æ¯ï¼ˆCentOS6.8æœ‰ï¼ŒCentOS7æ— è¯¥å‘½ä»¤ï¼‰\nCentos7\nå®‰è£…æ­¥éª¤ 1ã€å®˜ç½‘ä¸­æ–‡å®‰è£…å‚è€ƒæ‰‹å†Œ https://docs.docker.com/install/linux/docker-ce/centos/\n2ã€ç¡®å®šä½ æ˜¯CentOS7åŠä»¥ä¸Šç‰ˆæœ¬ 3ã€yumå®‰è£…gccç›¸å…³ CentOS7èƒ½ä¸Šå¤–ç½‘\n1 2 yum -y install gcc yum -y install gcc-c++ 4ã€å¸è½½æ—§ç‰ˆæœ¬ 1 yum -y remove docker docker-common docker-selinux docker-engine 2018.3å®˜ç½‘ç‰ˆæœ¬\n1 2 3 4 5 6 7 8 9 10 11 yum remove docker \\ docker-client \\ docker-client-latest \\ docker-common \\ docker-latest \\ docker-latest-logrotate \\ docker-logrotate \\ docker-selinux \\ docker-engine-selinux \\ docker-engine 5ã€å®‰è£…éœ€è¦çš„è½¯ä»¶åŒ… 1 yum install -y yum-utils device-mapper-persistent-data lvm2 6ã€è®¾ç½®stableé•œåƒä»“åº“ å¤§å‘\n1 yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo æŠ¥é”™ï¼š\n1 [Errno 14] curl#35 - TCP connection reset by peerÂ 2 [Errno 12] curl#35 - Timeout\næ³¨æ„ï¼šå› ä¸ºè¿™æ˜¯Dockerçš„å®˜ç½‘çš„ï¼Œæ˜¯å¤–å›½çš„ï¼Œæ‰€ä»¥ä¸‹è½½æ…¢ã€‚\nè§£å†³ï¼šæ¨èä½¿ç”¨é˜¿é‡Œäº‘æºï¼Œæˆ–è€…ç½‘æ˜“çš„æº\næ¨è\n1 yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo æ³¨æ„ï¼šè¿™é‡Œæ˜¯é˜¿é‡Œäº‘çš„æºï¼Œå›½å†…çš„ï¼Œé€Ÿåº¦å¾ˆå¿«ã€‚\n7ã€æ›´æ–°yumè½¯ä»¶åŒ…ç´¢å¼• 1 yum makecache fast 8ã€å®‰è£…DOCKER-CE 1 yum -y install docker-ce 9ã€å¯åŠ¨docker 1 systemctl start docker 10ã€æµ‹è¯• 1 docker version 1 docker run hello-world 11ã€é…ç½®é•œåƒåŠ é€Ÿ 1ã€åˆ›å»ºç›®å½•ï¼ˆdockerä¼šè‡ªåŠ¨åˆ›å»ºï¼‰\n1 mkdir -p /etc/docker 2ã€ä½¿ç”¨é˜¿é‡Œäº‘çš„åŠ é€Ÿåœ°å€\n1 vim /etc/docker/daemon.json 1 systemctl daemon-reload 3ã€é‡å¯Docker\n1 systemctl restart docker 12ã€å¸è½½ åœæ­¢Docker\n1 systemctl stop docker yumå¸è½½Docker\n1 yum -y remove docker-ce rmåˆ é™¤Dockerçš„ç›®å½•\n1 rm -rf /var/lib/docker åº•å±‚åŸç† 1ã€Dockeræ˜¯æ€ä¹ˆå·¥ä½œçš„ Dockeræ˜¯ä¸€ä¸ªClient-Serverç»“æ„çš„ç³»ç»Ÿï¼ŒDockerå®ˆæŠ¤è¿›ç¨‹è¿è¡Œåœ¨ä¸»æœºä¸Šï¼Œ ç„¶åé€šè¿‡Socketè¿æ¥ä»å®¢æˆ·ç«¯è®¿é—®ï¼Œå®ˆæŠ¤è¿›ç¨‹ä»å®¢æˆ·ç«¯æ¥å—å‘½ä»¤å¹¶ç®¡ç†è¿è¡Œåœ¨ä¸»æœºä¸Šçš„å®¹å™¨ã€‚Â å®¹å™¨ï¼Œæ˜¯ä¸€ä¸ªè¿è¡Œæ—¶ç¯å¢ƒï¼Œå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´åˆ°çš„é›†è£…ç®±ã€‚\n2ã€ä¸ºä»€ä¹ˆDockeræ¯”è¾ƒæ¯”VMå¿« (1)dockeræœ‰ç€æ¯”è™šæ‹Ÿæœºæ›´å°‘çš„æŠ½è±¡å±‚ã€‚ç”±äºdockerä¸éœ€è¦Hypervisorå®ç°ç¡¬ä»¶èµ„æºè™šæ‹ŸåŒ–,è¿è¡Œåœ¨dockerå®¹å™¨ä¸Šçš„ç¨‹åºç›´æ¥ä½¿ç”¨çš„éƒ½æ˜¯å®é™…ç‰©ç†æœºçš„ç¡¬ä»¶èµ„æºã€‚å› æ­¤åœ¨CPUã€å†…å­˜åˆ©ç”¨ç‡ä¸Šdockerå°†ä¼šåœ¨æ•ˆç‡ä¸Šæœ‰æ˜æ˜¾ä¼˜åŠ¿ã€‚\n(2)dockeråˆ©ç”¨çš„æ˜¯å®¿ä¸»æœºçš„å†…æ ¸,è€Œä¸éœ€è¦Guest OSã€‚å› æ­¤,å½“æ–°å»ºä¸€ä¸ªå®¹å™¨æ—¶,dockerä¸éœ€è¦å’Œè™šæ‹Ÿæœºä¸€æ ·é‡æ–°åŠ è½½ä¸€ä¸ªæ“ä½œç³»ç»Ÿå†…æ ¸ã€‚ä»è€Œé¿å…å¼•å¯»ã€åŠ è½½æ“ä½œç³»ç»Ÿå†…æ ¸è¿”ä¸ªæ¯”è¾ƒè´¹æ—¶è´¹èµ„æºçš„è¿‡ç¨‹,å½“æ–°å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ—¶,è™šæ‹Ÿæœºè½¯ä»¶éœ€è¦åŠ è½½Guest OS,è¿”ä¸ªæ–°å»ºè¿‡ç¨‹æ˜¯åˆ†é’Ÿçº§åˆ«çš„ã€‚è€Œdockerç”±äºç›´æ¥åˆ©ç”¨å®¿ä¸»æœºçš„æ“ä½œç³»ç»Ÿ,åˆ™çœç•¥äº†è¿”ä¸ªè¿‡ç¨‹,å› æ­¤æ–°å»ºä¸€ä¸ªdockerå®¹å™¨åªéœ€è¦å‡ ç§’é’Ÿã€‚\n","date":"2019-12-09T11:04:32Z","image":"https://www.ownit.top/title_pic/54.jpg","permalink":"https://www.ownit.top/p/201912091104/","title":"Centos7ç³»ç»ŸDockerå®‰è£…"},{"content":"ç›®å½•\né•œåƒ\nå®¹å™¨\nä»“åº“\næ€»ç»“\nDockerçš„åŸºæœ¬ç»„æˆä¸‰è¦ç´ \né•œåƒ\nå®¹å™¨\nä»“åº“\né•œåƒ Docker é•œåƒï¼ˆImageï¼‰å°±æ˜¯ä¸€ä¸ªåªè¯»çš„æ¨¡æ¿ã€‚é•œåƒå¯ä»¥ç”¨æ¥åˆ›å»º Docker å®¹å™¨ï¼Œä¸€ä¸ªé•œåƒå¯ä»¥åˆ›å»ºå¾ˆå¤šå®¹å™¨ã€‚\nå®¹å™¨ Docker åˆ©ç”¨å®¹å™¨ï¼ˆContainerï¼‰ç‹¬ç«‹è¿è¡Œçš„ä¸€ä¸ªæˆ–ä¸€ç»„åº”ç”¨ã€‚å®¹å™¨æ˜¯ç”¨é•œåƒåˆ›å»ºçš„è¿è¡Œå®ä¾‹ã€‚ å®ƒå¯ä»¥è¢«å¯åŠ¨ã€å¼€å§‹ã€åœæ­¢ã€åˆ é™¤ã€‚æ¯ä¸ªå®¹å™¨éƒ½æ˜¯ç›¸äº’éš”ç¦»çš„ã€ä¿è¯å®‰å…¨çš„å¹³å°ã€‚ å¯ä»¥æŠŠå®¹å™¨çœ‹åšæ˜¯ä¸€ä¸ªç®€æ˜“ç‰ˆçš„ Linux ç¯å¢ƒï¼ˆåŒ…æ‹¬rootç”¨æˆ·æƒé™ã€è¿›ç¨‹ç©ºé—´ã€ç”¨æˆ·ç©ºé—´å’Œç½‘ç»œç©ºé—´ç­‰ï¼‰å’Œè¿è¡Œåœ¨å…¶ä¸­çš„åº”ç”¨ç¨‹åº å®¹å™¨çš„å®šä¹‰å’Œé•œåƒå‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€å †å±‚çš„ç»Ÿä¸€è§†è§’ï¼Œå”¯ä¸€åŒºåˆ«åœ¨äºå®¹å™¨çš„æœ€ä¸Šé¢é‚£ä¸€å±‚æ˜¯å¯è¯»å¯å†™çš„ã€‚ ä»“åº“ ä»“åº“ï¼ˆRepositoryï¼‰æ˜¯é›†ä¸­å­˜æ”¾é•œåƒæ–‡ä»¶çš„åœºæ‰€ã€‚\nä»“åº“(Repository)å’Œä»“åº“æ³¨å†ŒæœåŠ¡å™¨ï¼ˆRegistryï¼‰æ˜¯æœ‰åŒºåˆ«çš„ã€‚ä»“åº“æ³¨å†ŒæœåŠ¡å™¨ä¸Šå¾€å¾€å­˜æ”¾ç€å¤šä¸ªä»“åº“ï¼Œæ¯ä¸ªä»“åº“ä¸­åˆåŒ…å«äº†å¤šä¸ªé•œåƒï¼Œæ¯ä¸ªé•œåƒæœ‰ä¸åŒçš„æ ‡ç­¾ï¼ˆtagï¼‰ã€‚\nä»“åº“åˆ†ä¸ºå…¬å¼€ä»“åº“ï¼ˆPublicï¼‰å’Œç§æœ‰ä»“åº“ï¼ˆPrivateï¼‰ä¸¤ç§å½¢å¼ã€‚\næœ€å¤§çš„å…¬å¼€ä»“åº“æ˜¯ Docker Hub(https://hub.docker.com/)ï¼Œ\nå­˜æ”¾äº†æ•°é‡åºå¤§çš„é•œåƒä¾›ç”¨æˆ·ä¸‹è½½ã€‚å›½å†…çš„å…¬å¼€ä»“åº“åŒ…æ‹¬é˜¿é‡Œäº‘ ã€ç½‘æ˜“äº‘ ç­‰\næ€»ç»“ éœ€è¦æ­£ç¡®çš„ç†è§£ä»“å‚¨/é•œåƒ/å®¹å™¨è¿™å‡ ä¸ªæ¦‚å¿µ:\nDocker æœ¬èº«æ˜¯ä¸€ä¸ªå®¹å™¨è¿è¡Œè½½ä½“æˆ–ç§°ä¹‹ä¸ºç®¡ç†å¼•æ“ã€‚æˆ‘ä»¬æŠŠåº”ç”¨ç¨‹åºå’Œé…ç½®ä¾èµ–æ‰“åŒ…å¥½å½¢æˆä¸€ä¸ªå¯äº¤ä»˜çš„è¿è¡Œç¯å¢ƒï¼Œè¿™ä¸ªæ‰“åŒ…å¥½çš„è¿è¡Œç¯å¢ƒå°±ä¼¼ä¹ imageé•œåƒæ–‡ä»¶ã€‚åªæœ‰é€šè¿‡è¿™ä¸ªé•œåƒæ–‡ä»¶æ‰èƒ½ç”Ÿæˆ Docker å®¹å™¨ã€‚image æ–‡ä»¶å¯ä»¥çœ‹ä½œæ˜¯å®¹å™¨çš„æ¨¡æ¿ã€‚Docker æ ¹æ® image æ–‡ä»¶ç”Ÿæˆå®¹å™¨çš„å®ä¾‹ã€‚åŒä¸€ä¸ª image æ–‡ä»¶ï¼Œå¯ä»¥ç”Ÿæˆå¤šä¸ªåŒæ—¶è¿è¡Œçš„å®¹å™¨å®ä¾‹ã€‚ * image æ–‡ä»¶ç”Ÿæˆçš„å®¹å™¨å®ä¾‹ï¼Œæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œç§°ä¸ºé•œåƒæ–‡ä»¶ã€‚ * ä¸€ä¸ªå®¹å™¨è¿è¡Œä¸€ç§æœåŠ¡ï¼Œå½“æˆ‘ä»¬éœ€è¦çš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡dockerå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„è¿è¡Œå®ä¾‹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„å®¹å™¨ * è‡³äºä»“å‚¨ï¼Œå°±æ˜¯æ”¾äº†ä¸€å †é•œåƒçš„åœ°æ–¹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠé•œåƒå‘å¸ƒåˆ°ä»“å‚¨ä¸­ï¼Œéœ€è¦çš„æ—¶å€™ä»ä»“å‚¨ä¸­æ‹‰ä¸‹æ¥å°±å¯ä»¥äº†ã€‚ ","date":"2019-12-09T08:42:08Z","image":"https://www.ownit.top/title_pic/58.jpg","permalink":"https://www.ownit.top/p/201912090842/","title":"Dockerç»„æˆä¸‰è¦ç´ "},{"content":"ç›®å½•\nä¸€ã€Gitçš„å®‰è£…\n1.1 å›¾å½¢åŒ–ç•Œé¢\n1.2 å‘½ä»¤è¡Œç•Œé¢\näºŒã€æœ¬åœ°ä»“åº“çš„åˆ›å»ºä¸æäº¤\n2.1 å›¾å½¢åŒ–ç•Œé¢\n2.1.1 é¦–å…ˆåœ¨ç”µè„‘ä¸Šæœ‰ä¸€ä¸ªç©ºç™½ç›®å½•\n2.1.2 æ‰“å¼€SourceTree\n2.1.3 ç‚¹å‡»å·¦è¾¹\u0026quot;å…‹éš†/æ–°å»º\u0026quot;,åˆ›å»ºæœ¬åœ°ä»“åº“\n2.1.4 é€‰æ‹©ç¬¬ä¸€æ­¥ä¸­çš„ç©ºç™½ç›®å½•ï¼Œç‚¹å‡»\u0026quot;åˆ›å»º\u0026quot;æŒ‰é’®\n2.1.5 æ­¤æ—¶å·¦è¾¹ä¼šå‡ºç°è¿™ä¸ªï¼Œä»£è¡¨æœ¬åœ°ä»“åº“åˆ›å»ºå®Œæˆ\n2.1.6 æ‰“å¼€ç©ºç™½ç›®å½•ï¼Œåœ¨ç©ºç™½ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ï¼Œæ–‡ä»¶(å†…å®¹/åç§°)éšä¾¿è¾“å…¥\n2.1.7 è¿”å›SourceTreeï¼Œä¼šå‘ç°æœªæš‚å­˜æ–‡ä»¶ä¸­æœ‰ä½ åˆšæ‰ä¿®æ”¹æˆ–å¢åŠ çš„æ–‡ä»¶\n2.1.8 å³é”®â€œæœªæš‚å­˜æ–‡ä»¶â€ä¸­çš„æ–‡ä»¶ï¼Œç‚¹å‡»æ·»åŠ \n2.1.9 ä¼šå‘ç°â€œæœªæš‚å­˜æ–‡ä»¶â€ä¸­çš„æ–‡ä»¶è¿›å…¥äº†â€œå·²æš‚å­˜æ–‡ä»¶â€ä¸­\n2.1.10 åœ¨ä¸‹æ–¹è¾“å…¥â€œæœ¬æ¬¡æäº¤çš„æè¿°â€ï¼Œç‚¹å‡»â€œæäº¤æŒ‰é’®â€\n2.1.11 ç‚¹å‡»masteråˆ†æ”¯ï¼Œä¼šæ˜¾ç¤ºæœ¬æ¬¡æäº¤çš„è¯¦ç»†ä¿¡æ¯\n2.2 å‘½ä»¤è¡Œç•Œé¢\n2.2.1 ç‚¹å‡»SourceTreeå³ä¸Šè§’çš„â€œå‘½ä»¤è¡Œæ¨¡å¼â€å³å¯æ‰“å¼€å‘½ä»¤è¡Œçª—å£\n2.2.2 å‘½ä»¤è¯†åˆ«\nä¸‰ã€å·¥ä½œæµ\n3.1 å›¾å½¢åŒ–ç•Œé¢\n3.1.1 é¦–å…ˆåœ¨ç”µè„‘ä¸Šæœ‰ä¸€ä¸ªç©ºç™½ç›®å½•\n3.1.2 æ‰“å¼€SourceTree\n3.1.3 ç‚¹å‡»å·¦è¾¹\u0026quot;å…‹éš†/æ–°å»º\u0026quot;,åˆ›å»ºæœ¬åœ°ä»“åº“\n3.1.4 é€‰æ‹©ç¬¬ä¸€æ­¥ä¸­çš„ç©ºç™½ç›®å½•ï¼Œç‚¹å‡»\u0026quot;åˆ›å»º\u0026quot;æŒ‰é’®\n3.1.5 æ‰“å¼€åˆšæ‰åˆ›å»ºçš„demo2ç›®å½•ï¼Œåœ¨é‡Œé¢æ·»åŠ ä¸€ä¸ªæ–‡ä»¶(å†…å®¹è‡ªå®š)\n3.1.6 æ‰“å¼€SourceTreeï¼Œå°†åˆšæ‰ä¿®æ”¹çš„æ–‡ä»¶æ·»åŠ è¿›æš‚å­˜åŒº\n3.1.7 ç¬¬ä¸€æ¬¡æäº¤\n3.1.8 éœ€æ±‚å˜æ›´\n3.1.9 éœ€æ±‚æ’¤é”€\n3.1.10 ç¬¬äºŒå¤©æ­£å¼éœ€æ±‚\n3.1.11 ç¬¬äºŒå¤©çš„éœ€æ±‚æäº¤åˆ°gitä»“åº“\n3.1.12 ç¬¬ä¸‰å¤©æ’¤é”€éœ€æ±‚\n3.1.13 é¡¹ç›®ä¸éœ€è¦äº†\n3.2 å‘½ä»¤è¡Œç•Œé¢\n3.2.1 å…ˆæœ‰ä¸€ä¸ªç©ºç›®å½•\n3.2.2 åœ¨è¯¥ç©ºç›®å½•ä¸‹æ‰“å¼€git_bush\n3.2.3 äº§å“ç»ç†ä¸´æ—¶å˜æ›´éœ€æ±‚\n3.2.4 å°†å˜æ›´åçš„éœ€æ±‚æäº¤åˆ°æš‚å­˜åŒº\n3.2.5 ç¬¬äºŒå¤©ä¸Šç­ä¹‹åï¼Œè¢«äº§å“ç»ç†å‘ŠçŸ¥è¯¥éœ€æ±‚ä¸éœ€è¦\n3.2.6 ç¬¬äºŒå¤©ç»“æŸ\n3.2.7 å°†ç¬¬äºŒå¤©çš„å·¥ä½œå†…å®¹æäº¤åˆ°ä»“åº“\n3.2.8 äº§å“ç»ç†çªç„¶å‘ŠçŸ¥è¿™ä¸ªéœ€æ±‚ä¸è¦äº†\n3.2.9 è¿™ä¸ªé¡¹ç›®éƒ½ä¸éœ€è¦äº†\n3.3 æ€»ç»“\nå››ã€è¿œç¨‹ä»“åº“\n4.1 githubå¯†é’¥ç”Ÿæˆ\n4.2 æ·»åŠ è¿œç¨‹ä»“åº“\n4.2.1 å‘½ä»¤è¡Œç•Œé¢\n4.2.2 å›¾å½¢åŒ–ç•Œé¢\näº”ã€å…‹éš†ä»“åº“\n5.1 å‘½ä»¤è¡Œæ“ä½œ\n5.2 å›¾å½¢åŒ–æ“ä½œ\nå…­ã€æ ‡ç­¾ç®¡ç†\n6.1 æ ‡ç­¾å‘½ä»¤\n6.2 å‘½ä»¤è¡Œæ–¹å¼å®ç°\n6.3 å›¾å½¢åŒ–æ–¹å¼å®ç°\nä¸ƒã€åˆ†æ”¯ç®¡ç†\n7.1 å‘½ä»¤è¡Œæ–¹å¼\n7.1.1 æäº¤åˆ°æœ¬åœ°ä»“åº“\n7.1.2 åˆ›å»ºåˆ†æ”¯\n7.1.2 åˆ é™¤åˆ†æ”¯\n7.2 å›¾å½¢åŒ–ç•Œé¢\n7.2.1 é¦–å…ˆéœ€è¦æœ‰ä¸€ä¸ªæœ¬åœ°ç›®å½•ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­æœ‰å†…å®¹\n7.2.2 æ‰“å¼€SourceTreeåˆ›å»ºæœ¬åœ°ä»“åº“ï¼Œå¹¶å°†ä»£ç æäº¤åˆ°æœ¬åœ°ä»“åº“\n7.2.3 æ–°å»ºåˆ†æ”¯\n7.2.4 åˆ é™¤åˆ†æ”¯\nå…«ã€é—®é¢˜å½’çº³æ€»ç»“\n8.1 æŠ¥é”™\n8.1.1 å¦‚æœä½ æœ¬åœ°æœ‰è¿œç¨‹ä»“åº“çš„sshçš„è¯ï¼ŒæŒ‰ç…§ä¸‹æ–¹æ­¥éª¤æ¥æ·»åŠ \n8.1.2 å¦‚æœä½ æœ¬åœ°æ²¡æœ‰è¿œç¨‹ä»“åº“çš„sshçš„è¯ï¼Œå…ˆæ¥æ·»åŠ \nä¸€ã€Gitçš„å®‰è£… 1.1 å›¾å½¢åŒ–ç•Œé¢ https://pan.baidu.com/s/1oAf6Eu9iha6TPzaGHNsADQ\nå®‰è£…è¿‡ç¨‹ï¼š\nå®‰è£…å®Œæˆä¹‹å,åœ¨C:\\Users\\Administrator\\AppData\\Local\\Atlassian\\SourceTreeç›®å½•ä¸‹åˆ›å»ºaccounts.jsonæ–‡ä»¶ï¼Œé‡Œé¢å†…å®¹å¦‚ä¸‹ï¼š\nå†æ¬¡æ‰“å¼€SourceTreeä¸‹è½½åªè¢«SourceTreeè¯†åˆ«çš„Gitï¼Œä¸éœ€è¦moun\u0026hellip;(ä¼šæœ‰æç¤ºï¼Œæ²¡æœ‰åˆ™ä¸ç”¨ç®¡)\n1.2 å‘½ä»¤è¡Œç•Œé¢ https://pan.baidu.com/s/1SPqrbKJLRkzzz2c0jHkuJA\näºŒã€æœ¬åœ°ä»“åº“çš„åˆ›å»ºä¸æäº¤ 2.1 å›¾å½¢åŒ–ç•Œé¢ 2.1.1 é¦–å…ˆåœ¨ç”µè„‘ä¸Šæœ‰ä¸€ä¸ªç©ºç™½ç›®å½• 2.1.2 æ‰“å¼€SourceTree 2.1.3 ç‚¹å‡»å·¦è¾¹\u0026quot;å…‹éš†/æ–°å»º\u0026quot;,åˆ›å»ºæœ¬åœ°ä»“åº“ 2.1.4 é€‰æ‹©ç¬¬ä¸€æ­¥ä¸­çš„ç©ºç™½ç›®å½•ï¼Œç‚¹å‡»\u0026quot;åˆ›å»º\u0026quot;æŒ‰é’® 2.1.5 æ­¤æ—¶å·¦è¾¹ä¼šå‡ºç°è¿™ä¸ªï¼Œä»£è¡¨æœ¬åœ°ä»“åº“åˆ›å»ºå®Œæˆ 2.1.6 æ‰“å¼€ç©ºç™½ç›®å½•ï¼Œåœ¨ç©ºç™½ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ï¼Œæ–‡ä»¶(å†…å®¹/åç§°)éšä¾¿è¾“å…¥ 2.1.7 è¿”å›SourceTreeï¼Œä¼šå‘ç°æœªæš‚å­˜æ–‡ä»¶ä¸­æœ‰ä½ åˆšæ‰ä¿®æ”¹æˆ–å¢åŠ çš„æ–‡ä»¶ 2.1.8 å³é”®â€œæœªæš‚å­˜æ–‡ä»¶â€ä¸­çš„æ–‡ä»¶ï¼Œç‚¹å‡»æ·»åŠ  2.1.9 ä¼šå‘ç°â€œæœªæš‚å­˜æ–‡ä»¶â€ä¸­çš„æ–‡ä»¶è¿›å…¥äº†â€œå·²æš‚å­˜æ–‡ä»¶â€ä¸­ 2.1.10 åœ¨ä¸‹æ–¹è¾“å…¥â€œæœ¬æ¬¡æäº¤çš„æè¿°â€ï¼Œç‚¹å‡»â€œæäº¤æŒ‰é’®â€ 2.1.11 ç‚¹å‡»masteråˆ†æ”¯ï¼Œä¼šæ˜¾ç¤ºæœ¬æ¬¡æäº¤çš„è¯¦ç»†ä¿¡æ¯ 2.2 å‘½ä»¤è¡Œç•Œé¢ 2.2.1 ç‚¹å‡»SourceTreeå³ä¸Šè§’çš„â€œå‘½ä»¤è¡Œæ¨¡å¼â€å³å¯æ‰“å¼€å‘½ä»¤è¡Œçª—å£ 2.2.2 å‘½ä»¤è¯†åˆ« ä¸‰ã€å·¥ä½œæµ 3.1 å›¾å½¢åŒ–ç•Œé¢ 3.1.1 é¦–å…ˆåœ¨ç”µè„‘ä¸Šæœ‰ä¸€ä¸ªç©ºç™½ç›®å½• 3.1.2 æ‰“å¼€SourceTree 3.1.3 ç‚¹å‡»å·¦è¾¹\u0026quot;å…‹éš†/æ–°å»º\u0026quot;,åˆ›å»ºæœ¬åœ°ä»“åº“ 3.1.4 é€‰æ‹©ç¬¬ä¸€æ­¥ä¸­çš„ç©ºç™½ç›®å½•ï¼Œç‚¹å‡»\u0026quot;åˆ›å»º\u0026quot;æŒ‰é’® 3.1.5 æ‰“å¼€åˆšæ‰åˆ›å»ºçš„demo2ç›®å½•ï¼Œåœ¨é‡Œé¢æ·»åŠ ä¸€ä¸ªæ–‡ä»¶(å†…å®¹è‡ªå®š) 3.1.6 æ‰“å¼€SourceTreeï¼Œå°†åˆšæ‰ä¿®æ”¹çš„æ–‡ä»¶æ·»åŠ è¿›æš‚å­˜åŒº 3.1.7 ç¬¬ä¸€æ¬¡æäº¤ 3.1.8 éœ€æ±‚å˜æ›´ èƒŒæ™¯ï¼šå¼€å‘å®Œæˆï¼Œè¦ä¸‹ç­äº†ï¼Œä½†æ˜¯ä¸´æ—¶æœ‰ä¸ªéœ€æ±‚å˜æ›´ï¼Œå°†å˜æ›´åçš„æ–‡ä»¶æäº¤çš„æš‚å­˜åŒº\nä¿®æ”¹å†…å®¹ï¼Œæ·»åŠ â€œéœ€æ±‚å˜æ›´â€\nå°†ä¿®æ”¹åçš„æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº\n3.1.9 éœ€æ±‚æ’¤é”€ èƒŒæ™¯ï¼šç¬¬äºŒå¤©ä¸Šç­ä¹‹åï¼Œäº§å“ç»ç†è¯´ï¼Œæ˜¨å¤©çš„éœ€æ±‚ä¸éœ€è¦äº†\nç›´æ¥ä¸¢å¼ƒæ‰æš‚å­˜åŒºçš„æ–‡ä»¶\næ­¤æ—¶çš„éœ€æ±‚å˜æ›´å·²æ’¤é”€\n3.1.10 ç¬¬äºŒå¤©æ­£å¼éœ€æ±‚ èƒŒæ™¯ï¼šç¬¬äºŒå¤©ä¸‹ç­ä¹‹åï¼Œå½“å¤©çš„éœ€æ±‚å·²ç»å®Œæˆï¼Œå‡†å¤‡æäº¤åˆ°gitä»“åº“\n3.1.11 ç¬¬äºŒå¤©çš„éœ€æ±‚æäº¤åˆ°gitä»“åº“ 3.1.12 ç¬¬ä¸‰å¤©æ’¤é”€éœ€æ±‚ èƒŒæ™¯ï¼šç¬¬ä¸‰å¤©ä¸Šç­ï¼Œå‘ç°ç¬¬äºŒå¤©çš„éœ€æ±‚æ²¡ç”¨ï¼Œä½†æ˜¯å·²ç»æäº¤åˆ°çº¿ä¸Šä»“åº“ï¼Œå¯ä»¥é€šè¿‡é‡ç½®å½“å‰åˆ†æ”¯åˆ°æ­¤æ¬¡æäº¤\n3.1.13 é¡¹ç›®ä¸éœ€è¦äº† åœ¨å·¥ä½œåŒºç›´æ¥åˆ é™¤è¯¥æ–‡ä»¶ï¼Œæ‰“å¼€sourceTreeï¼Œè™½ç„¶åœ¨æœ¬åœ°åˆ é™¤äº†ï¼Œä½†æ˜¯çº¿ä¸Šä»“åº“è¿˜æœ‰é—ç•™ã€‚\nå†æ¬¡æ‰“å¼€SourceTreeï¼Œå°†åŠ¨ä½œæäº¤è‡³æš‚å­˜åŒºï¼Œç„¶åå†æ¬¡æäº¤åˆ°ä»“åº“\nåˆ°æ­¤ï¼Œä»“åº“æ‰ç®—å¹²å‡€\n3.2 å‘½ä»¤è¡Œç•Œé¢ 3.2.1 å…ˆæœ‰ä¸€ä¸ªç©ºç›®å½• 3.2.2 åœ¨è¯¥ç©ºç›®å½•ä¸‹æ‰“å¼€git_bush 3.2.3 äº§å“ç»ç†ä¸´æ—¶å˜æ›´éœ€æ±‚ 3.2.4 å°†å˜æ›´åçš„éœ€æ±‚æäº¤åˆ°æš‚å­˜åŒº 3.2.5 ç¬¬äºŒå¤©ä¸Šç­ä¹‹åï¼Œè¢«äº§å“ç»ç†å‘ŠçŸ¥è¯¥éœ€æ±‚ä¸éœ€è¦ æ­¤æ—¶çš„å·¥ä½œåŒºå·²ç»å¹²å‡€\n3.2.6 ç¬¬äºŒå¤©ç»“æŸ 3.2.7 å°†ç¬¬äºŒå¤©çš„å·¥ä½œå†…å®¹æäº¤åˆ°ä»“åº“ 3.2.8 äº§å“ç»ç†çªç„¶å‘ŠçŸ¥è¿™ä¸ªéœ€æ±‚ä¸è¦äº† æ­¤æ—¶çš„å·¥ä½œåŒºåªæœ‰ç¬¬ä¸€æ¬¡æäº¤çš„ä¿¡æ¯\n3.2.9 è¿™ä¸ªé¡¹ç›®éƒ½ä¸éœ€è¦äº† 3.3 æ€»ç»“ å››ã€è¿œç¨‹ä»“åº“ 4.1 githubå¯†é’¥ç”Ÿæˆ https://www.cnblogs.com/xue-shuai/p/11555150.html\n4.2 æ·»åŠ è¿œç¨‹ä»“åº“ 4.2.1 å‘½ä»¤è¡Œç•Œé¢ 4.2.2 å›¾å½¢åŒ–ç•Œé¢ 1ï¼‰é¦–å…ˆå…ˆæäº¤åˆ°æœ¬åœ°ä»“åº“\n**Â 2ï¼‰å°†æœ¬åœ°ä»“åº“ä¸è¿œç¨‹ä»“åº“å…³è”ï¼Œå³é”®masteråˆ†æ”¯ï¼Œç‚¹å‡»â€œåˆ›å»ºæ‹‰å»è¯·æ±‚â€**\næ·»åŠ è¿œç¨‹ä»“åº“åœ°å€\nç‚¹å‡»ç¡®å®š\n3ï¼‰å‡ºç°originè¯´æ˜æœ¬åœ°ä»“åº“ä¸è¿œç¨‹ä»“åº“å…³è”æˆåŠŸ\n4ï¼‰æ¨é€åˆ°è¿œç¨‹ä»“åº“\nå³é”®masterï¼Œç‚¹å‡»æ¨é€åˆ°origin\nç›´æ¥æ¨é€å³å¯\näº”ã€å…‹éš†ä»“åº“ 5.1 å‘½ä»¤è¡Œæ“ä½œ æ‰¾ä¸€ä¸ªç©ºç›®å½•ï¼Œè¾“å…¥\n1 git clone git@github*******.git å…‹éš†è¿œç¨‹ä»“åº“åˆ°æœ¬åœ°\n5.2 å›¾å½¢åŒ–æ“ä½œ ç‚¹å‡»å…‹éš†ï¼Œè¾“å…¥è¿œç¨‹ä»“åº“åœ°å€ï¼Œæ‰¾åˆ°æ”¾ç½®çš„ç›®å½•ï¼Œç‚¹å‡»å…‹éš†å³å¯\nå…­ã€æ ‡ç­¾ç®¡ç† 6.1 æ ‡ç­¾å‘½ä»¤ 6.2 å‘½ä»¤è¡Œæ–¹å¼å®ç° é¦–å…ˆéœ€è¦åœ¨è¿œç¨‹GitHubä¸Šæœ‰ä¸€ä¸ªä»“åº“ï¼Œå¹¶ä¸”å…‹éš†åˆ°æœ¬åœ°ï¼Œåœ¨è¯¥é¡¹ç›®ä¸­æ‰§è¡Œä¸‹åˆ—å‘½ä»¤\næŸ¥çœ‹è¿œç¨‹GitHubä¸­çš„æ ‡ç­¾\næ›´æ¢Branchesåˆ†æ”¯ä¸ºTagsæ ‡ç­¾ï¼Œå³å¯æŸ¥çœ‹æ‹¥æœ‰çš„æ ‡ç­¾ï¼Œå¯è¿›è¡Œç‰ˆæœ¬çš„æŸ¥çœ‹ä¸åˆ‡æ¢ã€‚\n**Â åˆ é™¤è¿œç¨‹æ ‡ç­¾**\n6.3 å›¾å½¢åŒ–æ–¹å¼å®ç° é¦–å…ˆå…ˆæäº¤æœ¬åœ°ä»“åº“åˆ°è¿œç¨‹ä»“åº“ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œè¯¦æƒ…æŸ¥çœ‹4.2.2\næ¨é€å®Œæˆä¹‹åï¼Œç‚¹å‡»æ ‡ç­¾\nå¡«å†™â€œæ ‡ç­¾åç§°â€ï¼Œé€‰æ‹©â€œæŒ‡å®šçš„æäº¤â€ï¼Œå‹¾é€‰â€œæ¨é€æ ‡ç­¾â€\né€‰æ‹©æœ€æ–°çš„ä¿®æ”¹ï¼Œç‚¹å‡»ç¡®å®š\næ·»åŠ æ ‡ç­¾\næ·»åŠ å®Œæˆä¹‹åå³å¯åœ¨GitHubä¸ŠæŸ¥çœ‹æ·»åŠ æˆåŠŸçš„æ ‡ç­¾\nåˆ é™¤æ ‡ç­¾ï¼Œåœ¨sourceTreeä¸­å³é”®æ‰€è¦åˆ é™¤çš„æ ‡ç­¾\nå‹¾é€‰â€œç§»é™¤æ‰€æœ‰è¿œç¨‹æ ‡ç­¾â€ï¼Œå³å¯å°†è¿œç¨‹ä»“åº“ä¸­è¯¥æ ‡ç­¾åˆ é™¤æ‰\nä¸ƒã€åˆ†æ”¯ç®¡ç† å‡è®¾éœ€è¦å®ç°ä¸€ä¸ªåŠŸèƒ½ï¼Œä½†æ˜¯è¿™ä¸ªåŠŸèƒ½éœ€è¦ä¸¤å‘¨å®Œæˆï¼Œç¬¬ä¸€å‘¨å®Œæˆäº†50%ï¼Œå¦‚æœç›´æ¥æäº¤åˆ°è¿œç¨‹ä»“åº“ï¼Œåˆ«äººçš„ä»£ç å¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœç­‰åˆ°å…¨éƒ¨å®Œæˆåœ¨æäº¤ï¼Œå¯èƒ½è¿›åº¦ä¸Šä¼šæœ‰é—®é¢˜ï¼Œæ‰€ä»¥åªéœ€è¦åˆ›å»ºä¸€ä¸ªå±äºä½ è‡ªå·±çš„åˆ†æ”¯ï¼Œè‡ªå·±æ‰€æœ‰çš„ä»£ç åœ¨è¯¥åˆ†æ”¯ä¸Šå®Œæˆã€‚ä¸ºä¿æŒå·¥ä½œæ ‘æ¸…æ´ï¼Œæ‰€åˆ›å»ºçš„åˆ†æ”¯åœ¨åˆæˆåˆ°ä¸»åˆ†æ”¯ä¹‹åï¼Œè¯¥åˆ†æ”¯ä¾¿ä¸å†éœ€è¦ï¼Œå¯åˆ é™¤ã€‚\n7.1 å‘½ä»¤è¡Œæ–¹å¼ åœ¨ä¸€ä¸ªç©ºç›®å½•ä¸‹æ‰“å¼€git bash\n7.1.1 æäº¤åˆ°æœ¬åœ°ä»“åº“ 7.1.2 åˆ›å»ºåˆ†æ”¯ 7.1.2 åˆ é™¤åˆ†æ”¯ 7.2 å›¾å½¢åŒ–ç•Œé¢ 7.2.1 é¦–å…ˆéœ€è¦æœ‰ä¸€ä¸ªæœ¬åœ°ç›®å½•ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­æœ‰å†…å®¹ 7.2.2 æ‰“å¼€SourceTreeåˆ›å»ºæœ¬åœ°ä»“åº“ï¼Œå¹¶å°†ä»£ç æäº¤åˆ°æœ¬åœ°ä»“åº“ å…·ä½“å°±ä¸ç»†è¯´äº†ï¼Œè¯¦æƒ…è¯·çœ‹2.1\n7.2.3 æ–°å»ºåˆ†æ”¯ ç‚¹å‡»â€œåˆ†æ”¯â€\n**Â è¾“å…¥æ–°çš„åˆ†æ”¯åç§°ï¼Œç‚¹å‡»â€œåˆ›å»ºåˆ†æ”¯â€**\nå³é”®ä»“åº“ï¼Œé€‰æ‹©â€œåœ¨èµ„æºç®¡ç†å™¨é‡Œæ‰“å¼€â€\nåœ¨æ–°çš„åˆ†æ”¯ä¸Šæ·»åŠ ä¸€äº›å†…å®¹\nè¿”å›sourceTreeï¼Œé€‰æ‹©â€œæœªæäº¤çš„æ›´æ”¹â€ï¼Œå°†ä¸‹æ–¹çš„â€œä¸ºæš‚å­˜æ–‡ä»¶â€æäº¤åˆ°æœ¬åœ°ä»“åº“\næ¥ä¸‹æ¥åˆå¹¶åˆ†æ”¯ã€‚åŒå‡»masteråˆ†æ”¯å°±ä¼šåˆ‡æ¢è‡³masteråˆ†æ”¯\nç‚¹å‡»â€œåˆå¹¶â€ï¼Œé€‰æ‹©è¦åˆå¹¶çš„åˆ†æ”¯ï¼Œå‹¾é€‰â€œç«‹å³æäº¤åˆå¹¶â€ï¼Œç‚¹å‡»ç¡®å®š\næ­¤æ—¶é€šè¿‡å³é”®è¯¥ä»“åº“ç‚¹å‡»â€œåœ¨èµ„æºç®¡ç†å™¨ä¸­æ‰“å¼€â€ï¼ŒæŸ¥çœ‹è¯¥æ–‡ä»¶\n**Â æˆ‘ä»¬å‘ç°åŸæ¥futureYä¸­ä¿®æ”¹çš„æ–‡ä»¶å·²ç»åˆå¹¶åˆ°äº†masteråˆ†æ”¯ä¸Š**\n7.2.4 åˆ é™¤åˆ†æ”¯ å³é”®è¦åˆ é™¤çš„åˆ†æ”¯åï¼Œç‚¹å‡»åˆ é™¤futureY\nå‹¾é€‰â€œå¼ºåˆ¶åˆ é™¤â€ï¼Œokå³å¯åˆ é™¤è¯¥åˆ†æ”¯ã€‚\nå…«ã€é—®é¢˜å½’çº³æ€»ç»“ 8.1 æŠ¥é”™ å¦‚æœå‡ºç°ä¸‹ç±»é—®é¢˜ä¸è¦æ…Œï¼Œæ˜¯å› ä¸ºä½ çš„gitæ²¡æœ‰sshå¯†é’¥ä¸è¿œç¨‹ä»“åº“å…³è”\n8.1.1 å¦‚æœä½ æœ¬åœ°æœ‰è¿œç¨‹ä»“åº“çš„sshçš„è¯ï¼ŒæŒ‰ç…§ä¸‹æ–¹æ­¥éª¤æ¥æ·»åŠ  ä¼šè‡ªåŠ¨å¸®ä½ æå–æœ¬åœ°çš„ssh\n8.1.2 å¦‚æœä½ æœ¬åœ°æ²¡æœ‰è¿œç¨‹ä»“åº“çš„sshçš„è¯ï¼Œå…ˆæ¥æ·»åŠ  https://www.cnblogs.com/xue-shuai/p/11555150.html\n","date":"2019-12-05T13:45:27Z","image":"https://www.ownit.top/title_pic/39.jpg","permalink":"https://www.ownit.top/p/201912051345/","title":"Gitå…¥é—¨åŸºç¡€æ•™ç¨‹å’ŒSourceTreeåº”ç”¨"},{"content":"1ã€ä»€ä¹ˆæ˜¯ nginx é«˜å¯ç”¨ ï¼ˆ1ï¼‰éœ€è¦ä¸¤å° nginx æœåŠ¡å™¨ ï¼ˆ2ï¼‰éœ€è¦ keepalived ï¼ˆ3ï¼‰éœ€è¦è™šæ‹Ÿ ipÂ 2ã€é…ç½®é«˜å¯ç”¨çš„å‡†å¤‡å·¥ä½œ ï¼ˆ1ï¼‰éœ€è¦ä¸¤å°æœåŠ¡å™¨ 192.168.17.129 å’Œ 192.168.17.131\nï¼ˆ2ï¼‰åœ¨ä¸¤å°æœåŠ¡å™¨å®‰è£… nginx\n**ï¼ˆ3ï¼‰åœ¨ä¸¤å°æœåŠ¡å™¨å®‰è£… keepalivedÂ **\n3ã€åœ¨ä¸¤å°æœåŠ¡å™¨å®‰è£… keepalivedÂ ï¼ˆ1ï¼‰ä½¿ç”¨ yum å‘½ä»¤è¿›è¡Œå®‰\n1 yum install keepalived â€“y **ï¼ˆ2ï¼‰å®‰è£…ä¹‹åï¼Œåœ¨ etc é‡Œé¢ç”Ÿæˆç›®å½• keepalivedï¼Œæœ‰æ–‡ä»¶ keepalived.confÂ **\n4ã€å®Œæˆé«˜å¯ç”¨é…ç½®ï¼ˆä¸»ä»é…ç½®ï¼‰ **ï¼ˆ1ï¼‰ä¿®æ”¹/etc/keepalived/keepalivec.conf é…ç½®æ–‡ä»¶Â **\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 global_defs { notification_email { acassen@firewall.loc failover@firewall.loc sysadmin@firewall.loc } notification_email_from Alexandre.Cassen@firewall.loc smtp_server 192.168.17.129 smtp_connect_timeout 30 router_id LVS_DEVEL } vrrp_script chk_http_port { script \u0026#34;/usr/local/src/nginx_check.sh\u0026#34; interval 2 #ï¼ˆæ£€æµ‹è„šæœ¬æ‰§è¡Œçš„é—´éš”ï¼‰ weight 2 } vrrp_instance VI_1 { state BACKUP # å¤‡ä»½æœåŠ¡å™¨ä¸Šå°† MASTER æ”¹ä¸º BACKUP interface ens33 //ç½‘å¡ virtual_router_id 51 # ä¸»ã€å¤‡æœºçš„ virtual_router_id å¿…é¡»ç›¸åŒ priority 90 # ä¸»ã€å¤‡æœºå–ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œä¸»æœºå€¼è¾ƒå¤§ï¼Œå¤‡ä»½æœºå€¼è¾ƒå° advert_int 1 authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 192.168.17.50 // VRRP H è™šæ‹Ÿåœ°å€ } } ï¼ˆ2ï¼‰åœ¨/usr/local/src æ·»åŠ æ£€æµ‹è„šæœ¬\n1 2 3 4 5 6 7 8 9 #!/bin/bash A=`ps -C nginx â€“no-header |wc -l` if [ $A -eq 0 ];then /usr/local/nginx/sbin/nginx sleep 2 if [ `ps -C nginx --no-header |wc -l` -eq 0 ];then killall keepalived fi fi ï¼ˆ3ï¼‰æŠŠä¸¤å°æœåŠ¡å™¨ä¸Š nginx å’Œ keepalived å¯åŠ¨\nå¯åŠ¨ nginxï¼š./nginx\n**å¯åŠ¨ keepalivedï¼šsystemctl start keepalived.serviceÂ **\n5ã€æœ€ç»ˆæµ‹è¯•Â **ï¼ˆ1ï¼‰åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥ è™šæ‹Ÿ ip åœ°å€ 192.168.17.50 **\n**ï¼ˆ2ï¼‰æŠŠä¸»æœåŠ¡å™¨ï¼ˆ192.168.17.129ï¼‰nginx å’Œ keepalived åœæ­¢ï¼Œå†è¾“å…¥ 192.168.17.50Â **\nç›¸å…³åšæ–‡ï¼š Nginx ç®€ä»‹ä¸å®‰è£…ã€å¸¸ç”¨çš„å‘½ä»¤å’Œé…ç½®æ–‡ä»¶ nginx é…ç½®å®ä¾‹-åå‘ä»£ç† nginx é…ç½®å®ä¾‹-è´Ÿè½½å‡è¡¡ Nginx é…ç½®å®ä¾‹-åŠ¨é™åˆ†ç¦» Nginx é…ç½®é«˜å¯ç”¨çš„é›†ç¾¤","date":"2019-12-04T18:05:19Z","image":"https://www.ownit.top/title_pic/35.jpg","permalink":"https://www.ownit.top/p/201912041805/","title":"Nginx é…ç½®é«˜å¯ç”¨çš„é›†ç¾¤"},{"content":"**1ã€ä»€ä¹ˆæ˜¯åŠ¨é™åˆ†ç¦»Â ** **é€šè¿‡ location æŒ‡å®šä¸åŒçš„åç¼€åå®ç°ä¸åŒçš„è¯·æ±‚è½¬å‘ã€‚é€šè¿‡ expires å‚æ•°è®¾ç½®ï¼Œå¯ä»¥ä½¿æµ è§ˆå™¨ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œå‡å°‘ä¸æœåŠ¡å™¨ä¹‹å‰çš„è¯·æ±‚å’Œæµé‡ã€‚å…·ä½“ Expires å®šä¹‰ï¼šæ˜¯ç»™ä¸€ä¸ªèµ„æº è®¾å®šä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´æ— éœ€å»æœåŠ¡ç«¯éªŒè¯ï¼Œç›´æ¥é€šè¿‡æµè§ˆå™¨è‡ªèº«ç¡®è®¤æ˜¯å¦è¿‡æœŸå³å¯ï¼Œ æ‰€ä»¥ä¸ä¼šäº§ç”Ÿé¢å¤–çš„æµé‡ã€‚æ­¤ç§æ–¹æ³•éå¸¸é€‚åˆä¸ç»å¸¸å˜åŠ¨çš„èµ„æºã€‚ï¼ˆå¦‚æœç»å¸¸æ›´æ–°çš„æ–‡ä»¶ï¼Œ ä¸å»ºè®®ä½¿ç”¨ Expires æ¥ç¼“å­˜ï¼‰ï¼Œæˆ‘è¿™é‡Œè®¾ç½® 3dï¼Œè¡¨ç¤ºåœ¨è¿™ 3 å¤©ä¹‹å†…è®¿é—®è¿™ä¸ª URLï¼Œå‘é€ä¸€ ä¸ªè¯·æ±‚ï¼Œæ¯”å¯¹æœåŠ¡å™¨è¯¥æ–‡ä»¶æœ€åæ›´æ–°æ—¶é—´æ²¡æœ‰å˜åŒ–ï¼Œåˆ™ä¸ä¼šä»æœåŠ¡å™¨æŠ“å–ï¼Œè¿”å›çŠ¶æ€ç  304ï¼Œ å¦‚æœæœ‰ä¿®æ”¹ï¼Œåˆ™ç›´æ¥ä»æœåŠ¡å™¨é‡æ–°ä¸‹è½½ï¼Œè¿”å›çŠ¶æ€ç  200ã€‚Â **\n**2ã€å‡†å¤‡å·¥ä½œÂ ** **ï¼ˆ1ï¼‰åœ¨ liunx ç³»ç»Ÿä¸­å‡†å¤‡é™æ€èµ„æºï¼Œç”¨äºè¿›è¡Œè®¿é—®Â **\n**3ã€å…·ä½“é…ç½®Â ** **ï¼ˆ1ï¼‰åœ¨ nginx é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®Â **\n4ã€æœ€ç»ˆæµ‹è¯•Â **ï¼ˆ1ï¼‰æµè§ˆå™¨ä¸­è¾“å…¥åœ°å€ http://192.168.17.129/image/01.jpgÂ **\n**ï¼ˆ2ï¼‰åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥åœ°å€ http://192.168.17.129/www/a.htmlÂ **\nç›¸å…³åšæ–‡ï¼š Nginx ç®€ä»‹ä¸å®‰è£…ã€å¸¸ç”¨çš„å‘½ä»¤å’Œé…ç½®æ–‡ä»¶ nginx é…ç½®å®ä¾‹-åå‘ä»£ç† nginx é…ç½®å®ä¾‹-è´Ÿè½½å‡è¡¡ Nginx é…ç½®å®ä¾‹-åŠ¨é™åˆ†ç¦» Nginx é…ç½®é«˜å¯ç”¨çš„é›†ç¾¤","date":"2019-12-04T17:57:02Z","image":"https://www.ownit.top/title_pic/22.jpg","permalink":"https://www.ownit.top/p/201912041757/","title":"Nginx é…ç½®å®ä¾‹-åŠ¨é™åˆ†ç¦»"},{"content":"æˆ‘å·²ç»CSDNåšå®¢è¿ç§»åˆ°åšå®¢å›­\nåšå®¢å›­åœ°å€ï¼šhttps://www.cnblogs.com/heian99/\n","date":"2019-11-30T13:44:52Z","image":"https://www.ownit.top/title_pic/28.jpg","permalink":"https://www.ownit.top/p/201911301344/","title":"å°†åšå®¢æ¬è‡³åšå®¢å›­"},{"content":"1ã€å®ç°æ•ˆæœ ï¼ˆ1ï¼‰æµè§ˆå™¨åœ°å€æ è¾“å…¥åœ°å€ http://www.123.com/edu/a.htmlï¼Œè´Ÿè½½å‡è¡¡æ•ˆæœï¼Œå¹³å‡ 8080 å’Œ 8081 ç«¯å£ä¸­\n2ã€å‡†å¤‡å·¥ä½œ ï¼ˆ1ï¼‰å‡†å¤‡ä¸¤å° tomcat æœåŠ¡å™¨ï¼Œä¸€å° 8080ï¼Œä¸€å° 8082\nï¼ˆ2ï¼‰åœ¨ä¸¤å° tomcat é‡Œé¢ webapps ç›®å½•ä¸­ï¼Œåˆ›å»ºåç§°æ˜¯ edu æ–‡ä»¶å¤¹ï¼Œåœ¨ edu æ–‡ä»¶å¤¹ä¸­åˆ›å»º é¡µé¢ a.htmlï¼Œç”¨äºæµ‹è¯•Â 3ã€åœ¨ nginx çš„é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œè´Ÿè½½å‡è¡¡çš„é…ç½® 1 2 3 4 upstream heian{ server localhost:8080; server localhost:8082; } 4ã€nginx åˆ†é…æœåŠ¡å™¨ç­–ç•¥\nç¬¬ä¸€ç§ è½®è¯¢ï¼ˆé»˜è®¤ï¼‰\næ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æœåŠ¡å™¨ down æ‰ï¼Œèƒ½è‡ªåŠ¨å‰”é™¤ **ç¬¬äºŒç§ weightÂ **\nweight ä»£è¡¨æƒé‡é»˜è®¤ä¸º 1,æƒé‡è¶Šé«˜è¢«åˆ†é…çš„å®¢æˆ·ç«¯è¶Š æŒ‡å®šè½®è¯¢å‡ ç‡ï¼Œweight å’Œè®¿é—®æ¯”ç‡æˆæ­£æ¯”ï¼Œç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µã€‚ ä¾‹å¦‚ï¼šÂ 1 2 3 4 upstream server_pool{ server 192.168.5.21 weight=10; server 192.168.5.22 weight=10; } **3ã€ip_hashÂ **\næ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—® ip çš„ hash ç»“æœåˆ†é…ï¼Œè¿™æ ·æ¯ä¸ªè®¿å®¢å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è§£å†³ session çš„é—®é¢˜ã€‚ ä¾‹å¦‚ï¼š 1 2 3 4 upstream server_pool{ ip_hash; server 192.168.5.21:80; server 192.168.5.22:80; } **4ã€fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰Â **\næŒ‰åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…\n1 2 3 4 5 upstream server_pool{ server 192.168.5.21:80; server 192.168.5.22:80; fair; } ç›¸å…³åšæ–‡ï¼š Nginx ç®€ä»‹ä¸å®‰è£…ã€å¸¸ç”¨çš„å‘½ä»¤å’Œé…ç½®æ–‡ä»¶ nginx é…ç½®å®ä¾‹-åå‘ä»£ç† nginx é…ç½®å®ä¾‹-è´Ÿè½½å‡è¡¡ Nginx é…ç½®å®ä¾‹-åŠ¨é™åˆ†ç¦» Nginx é…ç½®é«˜å¯ç”¨çš„é›†ç¾¤","date":"2019-11-28T18:03:28Z","image":"https://www.ownit.top/title_pic/77.jpg","permalink":"https://www.ownit.top/p/201911281803/","title":"nginx é…ç½®å®ä¾‹-è´Ÿè½½å‡è¡¡"},{"content":"åå‘ä»£ç†å®ä¾‹ä¸€Â è™šæ‹ŸæœºIPï¼š192.168.116.129\n**å®ç°æ•ˆæœï¼šä½¿ç”¨ nginx åå‘ä»£ç†ï¼Œè®¿é—® www.123.com ç›´æ¥è·³è½¬åˆ° è™šæ‹Ÿæœºçš„192.168.116.129:8080Â **\n**å®éªŒä»£ç Â ** 1ï¼‰ å¯åŠ¨ä¸€ä¸ª tomcatï¼Œæµè§ˆå™¨åœ°å€æ è¾“å…¥ 192.168.116.129**:8080ï¼Œå‡ºç°å¦‚ä¸‹ç•Œé¢Â **\n2ï¼‰ é€šè¿‡ä¿®æ”¹æœ¬åœ° host æ–‡ä»¶ï¼Œå°† www.123.com æ˜ å°„åˆ°****192.168.116.129\né…ç½®å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡ www.123.com:8080 è®¿é—®åˆ°ç¬¬ä¸€æ­¥å‡ºç°çš„ Tomcat åˆå§‹ç•Œ é¢ã€‚é‚£ä¹ˆå¦‚ä½•åªéœ€è¦è¾“å…¥ www.123.com ä¾¿å¯ä»¥è·³è½¬åˆ° Tomcat åˆå§‹ç•Œé¢å‘¢ï¼Ÿä¾¿ç”¨åˆ° nginx çš„åå‘ä»£ç†ã€‚\n3ï¼‰ åœ¨ nginx.conf é…ç½®æ–‡ä»¶ä¸­å¢åŠ å¦‚ä¸‹é…ç½®Â æ³¨æ„ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶åï¼Œéœ€è¦é‡å¯nginx\nå¦‚ä¸Šé…ç½®ï¼Œæˆ‘ä»¬ç›‘å¬ 80 ç«¯å£ï¼Œè®¿é—®åŸŸåä¸º www.123.comï¼Œä¸åŠ ç«¯å£å·æ—¶é»˜è®¤ä¸º 80 ç«¯å£ï¼Œæ•… è®¿é—®è¯¥åŸŸåæ—¶ä¼šè·³è½¬åˆ° 127.0.0.1:8080 è·¯å¾„ä¸Šã€‚åœ¨æµè§ˆå™¨ç«¯è¾“å…¥ www.123.com ç»“æœå¦‚ä¸‹ï¼š\nåå‘ä»£ç†å®ä¾‹äºŒÂ è™šæ‹Ÿæœºip:192.168.116.129\nå®ç°æ•ˆæœï¼šä½¿ç”¨ nginx åå‘ä»£ç†ï¼Œæ ¹æ®è®¿é—®çš„è·¯å¾„è·³è½¬åˆ°ä¸åŒç«¯å£çš„æœåŠ¡ä¸­ nginx ç›‘å¬ç«¯å£ä¸º 9001ï¼Œ\nè®¿é—® http://192.168.116.129:9001/edu/ ç›´æ¥è·³è½¬åˆ° **192.168.116.129.**0.0.1:8080\nè®¿é—® http://192.168.116.129:9001/vod/ ç›´æ¥è·³è½¬åˆ° 192.168.116.129**:8082Â **\nå®éªŒä»£ç Â 1ã€å‡†å¤‡å·¥ä½œ\nï¼ˆ1ï¼‰å‡†å¤‡ä¸¤ä¸ª tomcat æœåŠ¡å™¨ï¼Œä¸€ä¸ª 8080 ç«¯å£ï¼Œä¸€ä¸ª 8082 ç«¯å£\n**ï¼ˆ2ï¼‰åˆ›å»ºæ–‡ä»¶å¤¹å’Œæµ‹è¯•é¡µé¢Â **\n2ã€å…·ä½“é… ä¿®æ”¹ nginx çš„é…ç½®æ–‡ä»¶\n**åœ¨ http å—ä¸­æ·»åŠ  server{}Â **\n1 2 3 4 5 6 7 8 9 10 11 server{ listen 9001; server_name localhost; location ~ /edu/ { proxy_pass http://localhost:8080; } location ~ /dev/ { proxy_pass http://localhost:8082; } } é‡å¯\n**location æŒ‡ä»¤è¯´æ˜Â ** è¯­æ³•å¦‚ä¸‹ï¼š\n**Â 1ã€= ï¼šç”¨äºä¸å«æ­£åˆ™è¡¨è¾¾å¼çš„ uri å‰ï¼Œè¦æ±‚è¯·æ±‚å­—ç¬¦ä¸²ä¸ uri ä¸¥æ ¼åŒ¹é…ï¼Œå¦‚æœåŒ¹é… æˆåŠŸï¼Œå°±åœæ­¢ç»§ç»­å‘ä¸‹æœç´¢å¹¶ç«‹å³å¤„ç†è¯¥è¯·æ±‚ã€‚Â ** **Â 2ã€~ï¼šç”¨äºè¡¨ç¤º uri åŒ…å«æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹¶ä¸”åŒºåˆ†å¤§å°å†™ã€‚Â ** **Â 3ã€~*ï¼šç”¨äºè¡¨ç¤º uri åŒ…å«æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™ã€‚Â ** **Â 4ã€^~ï¼šç”¨äºä¸å«æ­£åˆ™è¡¨è¾¾å¼çš„ uri å‰ï¼Œè¦æ±‚ Nginx æœåŠ¡å™¨æ‰¾åˆ°æ ‡è¯† uri å’Œè¯·æ±‚å­— ç¬¦ä¸²åŒ¹é…åº¦æœ€é«˜çš„ location åï¼Œç«‹å³ä½¿ç”¨æ­¤ location å¤„ç†è¯·æ±‚ï¼Œè€Œä¸å†ä½¿ç”¨ location å—ä¸­çš„æ­£åˆ™ uri å’Œè¯·æ±‚å­—ç¬¦ä¸²åšåŒ¹é…ã€‚Â ** **Â æ³¨æ„ï¼šå¦‚æœ uri åŒ…å«æ­£åˆ™è¡¨è¾¾å¼ï¼Œåˆ™å¿…é¡»è¦æœ‰ ~ æˆ–è€… ~* æ ‡è¯†ã€‚Â ** æˆ‘æ”¹äº†ä¸€è¡Œé…ç½®ï¼Œä¼šå®ç°ä¸‹é¢ä¿®æ”¹ã€‚ æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥è¯•è¯•ï¼ˆçŒœçŒœæˆ‘æ”¹çš„é‚£ä¸ªåœ°æ–¹ï¼‰\nç›¸å…³åšæ–‡ï¼š Nginx ç®€ä»‹ä¸å®‰è£…ã€å¸¸ç”¨çš„å‘½ä»¤å’Œé…ç½®æ–‡ä»¶ nginx é…ç½®å®ä¾‹-åå‘ä»£ç† nginx é…ç½®å®ä¾‹-è´Ÿè½½å‡è¡¡ Nginx é…ç½®å®ä¾‹-åŠ¨é™åˆ†ç¦» Nginx é…ç½®é«˜å¯ç”¨çš„é›†ç¾¤","date":"2019-11-28T15:15:18Z","image":"https://www.ownit.top/title_pic/54.jpg","permalink":"https://www.ownit.top/p/201911281515/","title":"nginx é…ç½®å®ä¾‹-åå‘ä»£ç†"},{"content":"1ã€nginx ç®€ä»‹ ï¼ˆ1ï¼‰ä»‹ç» nginx çš„åº”ç”¨åœºæ™¯å’Œå…·ä½“å¯ä»¥åšä»€ä¹ˆäº‹æƒ…\nï¼ˆ2ï¼‰ä»‹ç»ä»€ä¹ˆæ˜¯åå‘ä»£ç†\nï¼ˆ3ï¼‰ä»‹ç»ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡\nï¼ˆ4ï¼‰ä»‹ç»ä»€ä¹ˆæ˜¯åŠ¨é™åˆ†ç¦»\n2ã€nginx å®‰è£… ï¼ˆ1ï¼‰ä»‹ç» nginx åœ¨ linux ç³»ç»Ÿä¸­å¦‚ä½•è¿›è¡Œå®‰è£…\n3ã€nginx å¸¸ç”¨çš„å‘½ä»¤å’Œé…ç½®æ–‡ä»¶ ï¼ˆ1ï¼‰ä»‹ç» nginx å¯åŠ¨ã€å…³é—­ã€é‡æ–°åŠ è½½å‘½ä»¤\nï¼ˆ2ï¼‰ä»‹ç» nginx çš„é…ç½®æ–‡ä»¶\n1.1 Nginx æ¦‚è¿° Nginx (\u0026ldquo;engine x\u0026rdquo;) æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ HTTP å’Œåå‘ä»£ç†æœåŠ¡å™¨,ç‰¹ç‚¹æ˜¯å æœ‰å†…å­˜å°‘ï¼Œå¹¶å‘èƒ½ åŠ›å¼ºï¼Œäº‹å®ä¸Š nginx çš„å¹¶å‘èƒ½åŠ›ç¡®å®åœ¨åŒç±»å‹çš„ç½‘é¡µæœåŠ¡å™¨ä¸­è¡¨ç°è¾ƒå¥½ï¼Œä¸­å›½å¤§é™†ä½¿ç”¨ nginx ç½‘ç«™ç”¨æˆ·æœ‰ï¼šç™¾åº¦ã€äº¬ä¸œã€æ–°æµªã€ç½‘æ˜“ã€è…¾è®¯ã€æ·˜å®ç­‰\n1.2 Nginx ä½œä¸º web æœåŠ¡å™¨ Nginx å¯ä»¥ä½œä¸ºé™æ€é¡µé¢çš„ web æœåŠ¡å™¨ï¼ŒåŒæ—¶è¿˜æ”¯æŒ CGI åè®®çš„åŠ¨æ€è¯­è¨€ï¼Œæ¯”å¦‚ perlã€php ç­‰ã€‚ä½†æ˜¯ä¸æ”¯æŒ javaã€‚Java ç¨‹åºåªèƒ½é€šè¿‡ä¸ tomcat é…åˆå®Œæˆã€‚Nginx ä¸“ä¸ºæ€§èƒ½ä¼˜åŒ–è€Œå¼€å‘ï¼Œ æ€§èƒ½æ˜¯å…¶æœ€é‡è¦çš„è€ƒé‡,å®ç°ä¸Šéå¸¸æ³¨é‡æ•ˆç‡ ï¼Œèƒ½ç»å—é«˜è´Ÿè½½çš„è€ƒéªŒ,æœ‰æŠ¥å‘Šè¡¨æ˜èƒ½æ”¯æŒé«˜ è¾¾ 50,000 ä¸ªå¹¶å‘è¿æ¥æ•°ã€‚ https://lnmp.org/nginx.html\n1.3 æ­£å‘ä»£ç† Nginx ä¸ä»…å¯ä»¥åšåå‘ä»£ç†ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚è¿˜èƒ½ç”¨ä½œæ­£å‘ä»£ç†æ¥è¿›è¡Œä¸Šç½‘ç­‰åŠŸèƒ½ã€‚ æ­£å‘ä»£ç†ï¼šå¦‚æœæŠŠå±€åŸŸç½‘å¤–çš„ Internet æƒ³è±¡æˆä¸€ä¸ªå·¨å¤§çš„èµ„æºåº“ï¼Œåˆ™å±€åŸŸç½‘ä¸­çš„å®¢æˆ·ç«¯è¦è®¿ é—® Internetï¼Œåˆ™éœ€è¦é€šè¿‡ä»£ç†æœåŠ¡å™¨æ¥è®¿é—®ï¼Œè¿™ç§ä»£ç†æœåŠ¡å°±ç§°ä¸ºæ­£å‘ä»£ç†ã€‚\n1.4 åå‘ä»£ç† åå‘ä»£ç†ï¼Œå…¶å®å®¢æˆ·ç«¯å¯¹ä»£ç†æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¸éœ€è¦ä»»ä½•é…ç½®å°±å¯ä»¥è®¿é—®ï¼Œæˆ‘ä»¬åª éœ€è¦å°†è¯·æ±‚å‘é€åˆ°åå‘ä»£ç†æœåŠ¡å™¨ï¼Œç”±åå‘ä»£ç†æœåŠ¡å™¨å»é€‰æ‹©ç›®æ ‡æœåŠ¡å™¨è·å–æ•°æ®åï¼Œåœ¨è¿” å›ç»™å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶åå‘ä»£ç†æœåŠ¡å™¨å’Œç›®æ ‡æœåŠ¡å™¨å¯¹å¤–å°±æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œæš´éœ²çš„æ˜¯ä»£ç†æœåŠ¡å™¨ åœ°å€ï¼Œéšè—äº†çœŸå®æœåŠ¡å™¨ IP åœ°å€ã€‚\n1.5 è´Ÿè½½å‡è¡¡ å®¢æˆ·ç«¯å‘é€å¤šä¸ªè¯·æ±‚åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼Œæœ‰ä¸€äº›å¯èƒ½è¦ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ï¼Œæœ åŠ¡å™¨å¤„ç†å®Œæ¯•åï¼Œå†å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚\nè¿™ç§æ¶æ„æ¨¡å¼å¯¹äºæ—©æœŸçš„ç³»ç»Ÿç›¸å¯¹å•ä¸€ï¼Œå¹¶å‘è¯·æ±‚ç›¸å¯¹è¾ƒå°‘çš„æƒ…å†µä¸‹æ˜¯æ¯”è¾ƒé€‚åˆçš„ï¼Œæˆ æœ¬ä¹Ÿä½ã€‚ä½†æ˜¯éšç€ä¿¡æ¯æ•°é‡çš„ä¸æ–­å¢é•¿ï¼Œè®¿é—®é‡å’Œæ•°æ®é‡çš„é£é€Ÿå¢é•¿ï¼Œä»¥åŠç³»ç»Ÿä¸šåŠ¡çš„å¤æ‚ åº¦å¢åŠ ï¼Œè¿™ç§æ¶æ„ä¼šé€ æˆæœåŠ¡å™¨ç›¸åº”å®¢æˆ·ç«¯çš„è¯·æ±‚æ—¥ç›Šç¼“æ…¢ï¼Œå¹¶å‘é‡ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œè¿˜å®¹æ˜“ é€ æˆæœåŠ¡å™¨ç›´æ¥å´©æºƒã€‚å¾ˆæ˜æ˜¾è¿™æ˜¯ç”±äºæœåŠ¡å™¨æ€§èƒ½çš„ç“¶é¢ˆé€ æˆçš„é—®é¢˜ï¼Œé‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ç§æƒ… å†µå‘¢ï¼Ÿ\næˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„å¯èƒ½æ˜¯å‡çº§æœåŠ¡å™¨çš„é…ç½®ï¼Œæ¯”å¦‚æé«˜ CPU æ‰§è¡Œé¢‘ç‡ï¼ŒåŠ å¤§å†…å­˜ç­‰æé«˜æœº å™¨çš„ç‰©ç†æ€§èƒ½æ¥è§£å†³æ­¤é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“æ‘©å°”å®šå¾‹çš„æ—¥ç›Šå¤±æ•ˆï¼Œç¡¬ä»¶çš„æ€§èƒ½æå‡å·²ç»ä¸èƒ½ æ»¡è¶³æ—¥ç›Šæå‡çš„éœ€æ±‚äº†ã€‚æœ€æ˜æ˜¾çš„ä¸€ä¸ªä¾‹å­ï¼Œå¤©çŒ«åŒåä¸€å½“å¤©ï¼ŒæŸä¸ªçƒ­é”€å•†å“çš„ç¬æ—¶è®¿é—®é‡ æ˜¯æå…¶åºå¤§çš„ï¼Œé‚£ä¹ˆç±»ä¼¼ä¸Šé¢çš„ç³»ç»Ÿæ¶æ„ï¼Œå°†æœºå™¨éƒ½å¢åŠ åˆ°ç°æœ‰çš„é¡¶çº§ç‰©ç†é…ç½®ï¼Œéƒ½æ˜¯ä¸èƒ½ å¤Ÿæ»¡è¶³éœ€æ±‚çš„ã€‚é‚£ä¹ˆæ€ä¹ˆåŠå‘¢ï¼Ÿ\nä¸Šé¢çš„åˆ†ææˆ‘ä»¬å»æ‰äº†å¢åŠ æœåŠ¡å™¨ç‰©ç†é…ç½®æ¥è§£å†³é—®é¢˜çš„åŠæ³•ï¼Œä¹Ÿå°±æ˜¯è¯´çºµå‘è§£å†³é—®é¢˜ çš„åŠæ³•è¡Œä¸é€šäº†ï¼Œé‚£ä¹ˆæ¨ªå‘å¢åŠ æœåŠ¡å™¨çš„æ•°é‡å‘¢ï¼Ÿè¿™æ—¶å€™é›†ç¾¤çš„æ¦‚å¿µäº§ç”Ÿäº†ï¼Œå•ä¸ªæœåŠ¡å™¨è§£ å†³ä¸äº†ï¼Œæˆ‘ä»¬å¢åŠ æœåŠ¡å™¨çš„æ•°é‡ï¼Œç„¶åå°†è¯·æ±‚åˆ†å‘åˆ°å„ä¸ªæœåŠ¡å™¨ä¸Šï¼Œå°†åŸå…ˆè¯·æ±‚é›†ä¸­åˆ°å•ä¸ª java è¯¾ç¨‹ç³»åˆ—æœåŠ¡å™¨ä¸Šçš„æƒ…å†µæ”¹ä¸ºå°†è¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œå°†è´Ÿè½½åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ æ‰€è¯´çš„è´Ÿè½½å‡è¡¡\n1.6 åŠ¨é™åˆ†ç¦» ä¸ºäº†åŠ å¿«ç½‘ç«™çš„è§£æé€Ÿåº¦ï¼Œå¯ä»¥æŠŠåŠ¨æ€é¡µé¢å’Œé™æ€é¡µé¢ç”±ä¸åŒçš„æœåŠ¡å™¨æ¥è§£æï¼ŒåŠ å¿«è§£æé€Ÿ åº¦ã€‚é™ä½åŸæ¥å•ä¸ªæœåŠ¡å™¨çš„å‹åŠ›ã€‚\nç¬¬ 2 ç«  Nginx å®‰è£… 2.1 è¿›å…¥ nginx å®˜ç½‘ï¼Œä¸‹è½½ http://nginx.org/\n2.2 å®‰è£… nginx ç¬¬ä¸€æ­¥ï¼Œå®‰è£… pcre\n1 wget http://downloads.sourceforge.net/project/pcre/pcre/8.37/pcre-8.37.tar.gz è§£å‹æ–‡ä»¶ï¼Œ ./configure å®Œæˆåï¼Œå›åˆ° pcre ç›®å½•ä¸‹æ‰§è¡Œ makeï¼Œ å†æ‰§è¡Œ make install ç¬¬äºŒæ­¥ï¼Œå®‰è£… openssl\nç¬¬ä¸‰æ­¥ï¼Œå®‰è£… zlib\n1 yum -y install make zlib zlib-devel gcc-c++ libtool openssl openssl-devel ç¬¬å››æ­¥ï¼Œå®‰è£… nginx\n1ã€ è§£å‹ç¼© nginx-xx.tar.gz åŒ…ã€‚ 2ã€ è¿›å…¥è§£å‹ç¼©ç›®å½•ï¼Œæ‰§è¡Œ./configureã€‚ 3ã€ make \u0026amp;\u0026amp; make install æŸ¥çœ‹å¼€æ”¾çš„ç«¯å£å·\nfirewall-cmd \u0026ndash;list-all è®¾ç½®å¼€æ”¾çš„ç«¯å£å·\nfirewall-cmd \u0026ndash;add-service=http â€“permanent sudo firewall-cmd \u0026ndash;add-port=80/tcp \u0026ndash;permanent é‡å¯é˜²ç«å¢™\nfirewall-cmd â€“reload ç¬¬ 3 ç«  nginx å¸¸ç”¨çš„å‘½ä»¤å’Œé…ç½®æ–‡ä»¶ 3.1 nginx å¸¸ç”¨çš„å‘½ä»¤ï¼š ï¼ˆ1ï¼‰å¯åŠ¨å‘½ä»¤\nåœ¨/usr/local/nginx/sbin ç›®å½•ä¸‹æ‰§è¡Œ ./nginx\nï¼ˆ2ï¼‰å…³é—­å‘½ä»¤\nåœ¨/usr/local/nginx/sbin ç›®å½•ä¸‹æ‰§è¡Œ ./nginx -s stop\nï¼ˆ3ï¼‰é‡æ–°åŠ è½½å‘½ä»¤\nåœ¨/usr/local/nginx/sbin ç›®å½•ä¸‹æ‰§è¡Œ ./nginx -s reload\n3.2 nginx.conf é…ç½®æ–‡ä»¶ nginx å®‰è£…ç›®å½•ä¸‹ï¼Œå…¶é»˜è®¤çš„é…ç½®æ–‡ä»¶éƒ½æ”¾åœ¨è¿™ä¸ªç›®å½•çš„ conf ç›®å½•ä¸‹ï¼Œè€Œä¸»é…ç½®æ–‡ä»¶ nginx.conf ä¹Ÿåœ¨å…¶ä¸­ï¼Œåç»­å¯¹ nginx çš„ä½¿ç”¨åŸºæœ¬ä¸Šéƒ½æ˜¯å¯¹æ­¤é…ç½®æ–‡ä»¶è¿›è¡Œç›¸åº”çš„ä¿®æ”¹\né…ç½®æ–‡ä»¶ä¸­æœ‰å¾ˆå¤š#ï¼Œ å¼€å¤´çš„è¡¨ç¤ºæ³¨é‡Šå†…å®¹ï¼Œæˆ‘ä»¬å»æ‰æ‰€æœ‰ä»¥ # å¼€å¤´çš„æ®µè½ï¼Œç²¾ç®€ä¹‹åçš„ å†…å®¹å¦‚ä¸‹ï¼š\næ ¹æ®ä¸Šè¿°æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾çš„å°† nginx.conf é…ç½®æ–‡ä»¶åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š ç¬¬ä¸€éƒ¨åˆ†ï¼šå…¨å±€å— ä»é…ç½®æ–‡ä»¶å¼€å§‹åˆ° events å—ä¹‹é—´çš„å†…å®¹ï¼Œä¸»è¦ä¼šè®¾ç½®ä¸€äº›å½±å“ nginx æœåŠ¡å™¨æ•´ä½“è¿è¡Œçš„é…ç½®æŒ‡ä»¤ï¼Œä¸»è¦åŒ…æ‹¬é… ç½®è¿è¡Œ Nginx æœåŠ¡å™¨çš„ç”¨æˆ·ï¼ˆç»„ï¼‰ã€å…è®¸ç”Ÿæˆçš„ worker process æ•°ï¼Œè¿›ç¨‹ PID å­˜æ”¾è·¯å¾„ã€æ—¥å¿—å­˜æ”¾è·¯å¾„å’Œç±»å‹ä»¥ åŠé…ç½®æ–‡ä»¶çš„å¼•å…¥ç­‰ã€‚\næ¯”å¦‚ä¸Šé¢ç¬¬ä¸€è¡Œé…ç½®çš„ï¼š\n1 worker_processes 1; è¿™æ˜¯ Nginx æœåŠ¡å™¨å¹¶å‘å¤„ç†æœåŠ¡çš„å…³é”®é…ç½®ï¼Œworker_processes å€¼è¶Šå¤§ï¼Œå¯ä»¥æ”¯æŒçš„å¹¶å‘å¤„ç†é‡ä¹Ÿè¶Šå¤šï¼Œä½†æ˜¯ ä¼šå—åˆ°ç¡¬ä»¶ã€è½¯ä»¶ç­‰è®¾å¤‡çš„åˆ¶çº¦\nç¬¬äºŒéƒ¨åˆ†ï¼ševents å— æ¯”å¦‚ä¸Šé¢çš„é…ç½®ï¼š\n1 2 3 events { worker_connections 1024; } events å—æ¶‰åŠçš„æŒ‡ä»¤ä¸»è¦å½±å“ Nginx æœåŠ¡å™¨ä¸ç”¨æˆ·çš„ç½‘ç»œè¿æ¥ï¼Œå¸¸ç”¨çš„è®¾ç½®åŒ…æ‹¬æ˜¯å¦å¼€å¯å¯¹å¤š work process ä¸‹çš„ç½‘ç»œè¿æ¥è¿›è¡Œåºåˆ—åŒ–ï¼Œæ˜¯å¦å…è®¸åŒæ—¶æ¥æ”¶å¤šä¸ªç½‘ç»œè¿æ¥ï¼Œé€‰å–å“ªç§äº‹ä»¶é©±åŠ¨æ¨¡å‹æ¥å¤„ç†è¿æ¥è¯·æ±‚ï¼Œæ¯ä¸ª word process å¯ä»¥åŒæ—¶æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°ç­‰ã€‚\nä¸Šè¿°ä¾‹å­å°±è¡¨ç¤ºæ¯ä¸ª work process æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°ä¸º 1024. è¿™éƒ¨åˆ†çš„é…ç½®å¯¹ Nginx çš„æ€§èƒ½å½±å“è¾ƒå¤§ï¼Œåœ¨å®é™…ä¸­åº”è¯¥çµæ´»é…ç½®ã€‚ ç¬¬ä¸‰éƒ¨åˆ†ï¼šhttp å— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 http { include mime.types; default_type application/octet-stream; #log_format main \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34; \u0026#39; # \u0026#39;$status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#39; # \u0026#39;\u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34;\u0026#39;; #access_log logs/access.log main; sendfile on; #tcp_nopush on; #keepalive_timeout 0; keepalive_timeout 65; #gzip on; server { listen 80; server_name localhost; #charset koi8-r; #access_log logs/host.access.log main; location / { root html; index index.html index.htm; } } è¿™ç®—æ˜¯ Nginx æœåŠ¡å™¨é…ç½®ä¸­æœ€é¢‘ç¹çš„éƒ¨åˆ†ï¼Œä»£ç†ã€ç¼“å­˜å’Œæ—¥å¿—å®šä¹‰ç­‰ç»å¤§å¤šæ•°åŠŸèƒ½å’Œç¬¬ä¸‰æ–¹æ¨¡å—çš„é…ç½®éƒ½åœ¨è¿™é‡Œã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼šhttp å—ä¹Ÿå¯ä»¥åŒ…æ‹¬ http å…¨å±€å—ã€server å—ã€‚\nâ‘ ã€http å…¨å±€å—\nhttp å…¨å±€å—é…ç½®çš„æŒ‡ä»¤åŒ…æ‹¬æ–‡ä»¶å¼•å…¥ã€MIME-TYPE å®šä¹‰ã€æ—¥å¿—è‡ªå®šä¹‰ã€è¿æ¥è¶…æ—¶æ—¶é—´ã€å•é“¾æ¥è¯·æ±‚æ•°ä¸Šé™ç­‰ã€‚ â‘¡ã€server å—\nè¿™å—å’Œè™šæ‹Ÿä¸»æœºæœ‰å¯†åˆ‡å…³ç³»ï¼Œè™šæ‹Ÿä¸»æœºä»ç”¨æˆ·è§’åº¦çœ‹ï¼Œå’Œä¸€å°ç‹¬ç«‹çš„ç¡¬ä»¶ä¸»æœºæ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œè¯¥æŠ€æœ¯çš„äº§ç”Ÿæ˜¯ä¸ºäº† èŠ‚çœäº’è”ç½‘æœåŠ¡å™¨ç¡¬ä»¶æˆæœ¬ã€‚\næ¯ä¸ª http å—å¯ä»¥åŒ…æ‹¬å¤šä¸ª server å—ï¼Œè€Œæ¯ä¸ª server å—å°±ç›¸å½“äºä¸€ä¸ªè™šæ‹Ÿä¸»æœºã€‚ è€Œæ¯ä¸ª server å—ä¹Ÿåˆ†ä¸ºå…¨å±€ server å—ï¼Œä»¥åŠå¯ä»¥åŒæ—¶åŒ…å«å¤šä¸ª locaton å—ã€‚ 1ã€å…¨å±€ server å—\næœ€å¸¸è§çš„é…ç½®æ˜¯æœ¬è™šæ‹Ÿæœºä¸»æœºçš„ç›‘å¬é…ç½®å’Œæœ¬è™šæ‹Ÿä¸»æœºçš„åç§°æˆ– IP é… 2ã€location å—\nä¸€ä¸ª server å—å¯ä»¥é…ç½®å¤šä¸ª location å—ã€‚ è¿™å—çš„ä¸»è¦ä½œç”¨æ˜¯åŸºäº Nginx æœåŠ¡å™¨æ¥æ”¶åˆ°çš„è¯·æ±‚å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ server_name/uri-stringï¼‰ï¼Œå¯¹è™šæ‹Ÿä¸»æœºåç§° ï¼ˆä¹Ÿå¯ä»¥æ˜¯ IP åˆ«åï¼‰ä¹‹å¤–çš„å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ å‰é¢çš„ /uri-stringï¼‰è¿›è¡ŒåŒ¹é…ï¼Œå¯¹ç‰¹å®šçš„è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚åœ°å€å®šå‘ã€æ•°æ®ç¼“ å­˜å’Œåº”ç­”æ§åˆ¶ç­‰åŠŸèƒ½ï¼Œè¿˜æœ‰è®¸å¤šç¬¬ä¸‰æ–¹æ¨¡å—çš„é…ç½®ä¹Ÿåœ¨è¿™é‡Œè¿›è¡Œã€‚\nç›¸å…³åšæ–‡ï¼š Nginx ç®€ä»‹ä¸å®‰è£…ã€å¸¸ç”¨çš„å‘½ä»¤å’Œé…ç½®æ–‡ä»¶ nginx é…ç½®å®ä¾‹-åå‘ä»£ç† nginx é…ç½®å®ä¾‹-è´Ÿè½½å‡è¡¡ Nginx é…ç½®å®ä¾‹-åŠ¨é™åˆ†ç¦» Nginx é…ç½®é«˜å¯ç”¨çš„é›†ç¾¤","date":"2019-11-26T20:42:29Z","image":"https://www.ownit.top/title_pic/14.jpg","permalink":"https://www.ownit.top/p/201911262042/","title":"Nginx ç®€ä»‹ä¸å®‰è£…ã€å¸¸ç”¨çš„å‘½ä»¤å’Œé…ç½®æ–‡ä»¶"},{"content":"Centos7å®‰è£…elasticSearch6 ä¸Šé¢è®²è¿°äº†elasticSearch6çš„å®‰è£…å’Œä½¿ç”¨æ•™ç¨‹ã€‚\nä¸‹é¢è®²ä¸€ä¸‹elasticsearch6çš„ç®¡ç†å·¥å…·Kibanaã€‚\nKibanaæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æå’Œå¯è§†åŒ–å¹³å°ï¼Œè®¾è®¡ç”¨äºå’ŒElasticsearchä¸€èµ·å·¥ä½œã€‚\nä½ ç”¨Kibanaæ¥æœç´¢ï¼ŒæŸ¥çœ‹ï¼Œå¹¶å’Œå­˜å‚¨åœ¨Elasticsearchç´¢å¼•ä¸­çš„æ•°æ®è¿›è¡Œäº¤äº’ã€‚\nä½ å¯ä»¥è½»æ¾åœ°æ‰§è¡Œé«˜çº§æ•°æ®åˆ†æï¼Œå¹¶ä¸”ä»¥å„ç§å›¾æ ‡ã€è¡¨æ ¼å’Œåœ°å›¾çš„å½¢å¼å¯è§†åŒ–æ•°æ®ã€‚\nKibanaä½¿å¾—ç†è§£å¤§é‡æ•°æ®å˜å¾—å¾ˆå®¹æ˜“ã€‚å®ƒç®€å•çš„ã€åŸºäºæµè§ˆå™¨çš„ç•Œé¢ä½¿ä½ èƒ½å¤Ÿå¿«é€Ÿåˆ›å»ºå’Œå…±äº«åŠ¨æ€ä»ªè¡¨æ¿ï¼Œå®æ—¶æ˜¾ç¤ºElasticsearchæŸ¥è¯¢çš„å˜åŒ–\nKibanaå®‰è£…æ•™ç¨‹ 1ã€æ‹·è´kibana-5.6.4-linux-x86_64.tar åˆ°/optä¸‹ 2ã€è§£å‹ç¼© 3ã€è¿›å…¥kibanaä¸»ç›®å½•çš„configç›®å½•ä¸‹ 4ã€ä¿®æ”¹é…ç½®æ–‡ä»¶ 1 vim kibana.yml 5ã€å¯åŠ¨ï¼Œåœ¨ kibanaä¸»ç›®å½•binç›®å½•ä¸‹æ‰§è¡Œ 1 nohup ./kibana \u0026amp; 6ã€ç„¶åctrl+cé€€å‡º æ‰§è¡Œps -ef\nå¦‚ä¸Šå›¾,1757å·è¿›ç¨‹å°±æ˜¯kibanaçš„è¿›ç¨‹\n7ã€ç”¨æµè§ˆå™¨æ‰“å¼€ ç‚¹å‡»å·¦è¾¹èœå•DevTools\nåœ¨Consoleä¸­\næ‰§è¡Œ get _cluster/healthÂ å³è¾¹çš„ç»“æœä¸­ï¼Œstatusä¸ºyellowæˆ–è€…greenã€‚\nè¡¨ç¤ºeså¯åŠ¨æ­£å¸¸ï¼Œå¹¶ä¸”ä¸kibanaè¿æ¥æ­£å¸¸ã€‚\nanalysis-ikå®‰è£…æ•™ç¨‹ã€ç®€å•ã€‘ 1ã€ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ 2ã€è§£å‹ 3ã€ç§»åŠ¨åˆ°ElasticSearch6ä¸‹çš„plugins 4ã€é‡æ–°å¯åŠ¨å°±å¯ä»¥äº† ","date":"2019-11-26T09:48:45Z","image":"https://www.ownit.top/title_pic/69.jpg","permalink":"https://www.ownit.top/p/201911260948/","title":"kibanaå’Œä¸­æ–‡åˆ†è¯å™¨analysis-ikçš„å®‰è£…ä½¿ç”¨"},{"content":"å¥½å§ï¼Œè¿™ä¸ªé—®é¢˜æ¯”è¾ƒlowï¼Œä½†æ˜¯è®°å½•ä¸€ä¸‹ï¼Œä»¥å…åæœŸé—å¿˜ã€‚\nè¯´ç™½äº†ï¼Œè¿™ä¸ªé—®é¢˜å°±æ˜¯ç«¯å£è¢«å ç”¨äº†ã€‚\né—®é¢˜ï¼š\n1 2 qos-server can not bind localhost:22222, dubbo version: 2.6.0, current host: 127.0.0.1 java.net.BindException: Address already in use: bind çœ‹ç¿»è¯‘ï¼šã€22222ç«¯å£è¢«å ç”¨ã€‘\nè§£å†³åŠæ³•ï¼š\nè§£å†³ç«¯å£è¢«å ç”¨çš„é—®é¢˜ï¼ˆ80ã€222222ã€3306ï¼‰ç­‰ç­‰\næŸ¥çœ‹å ç”¨ç¨‹åºçš„pid\n1 netstat -ano | findstr 22222 é€šè¿‡pidï¼Œåœæ­¢ç¨‹åº\n1 taskkill /f /pid 20720 çœ‹æˆªå›¾ï¼š\n","date":"2019-11-19T16:36:56Z","image":"https://www.ownit.top/title_pic/35.jpg","permalink":"https://www.ownit.top/p/201911191636/","title":"qos-server can not bind localhost-22222, dubbo version- 2.6.0, current host- 127.0.0.1ã€é—®é¢˜è§£å†³ã€‘"},{"content":"ä»Šå¤©ï¼Œå¯åŠ¨dubboï¼Œå¼€å§‹å†™é¡¹ç›®ã€‚\nåœ¨ä¸€ä¸ªè°ƒç”¨dubboé‡Œé¢çš„ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œç¨‹åºä¸€ç›´è°ƒç”¨ï¼Œæ¯æ¬¡æ˜¾ç¤ºæŠ¥çº¢ã€‚\nå¾ˆéš¾æã€‚\né—®é¢˜ä»£ç \n1 2 3 4 5 6 7 com.alibaba.dubbo.rpc.RpcException: Failed to invoke the method getAllSku in the service com.atguigu.gmall.service. SkuService. Tried 3 times of the providers [192.168.116.1:53684] (1/1) from the registry 47.98.231.26:2181 on the consumer 192.168.116.1 using the dubbo version 2.6.0. Last error is: Invoke remote method timeout. method: getAllSku, provider: dubbo://192.168.116.1:53684/com.atguigu.gmall.service è¿™ä¹ˆçƒ¦ï¼Œå·²ç»æå´©å¿ƒæ€äº†\næ‰”ç™¾åº¦ç¿»è¯‘å»ã€‚\nã€bugï¼ŒçœŸTMæ™ºéšœã€‘\né ï¼Œæ–¹æ³•è°ƒç”¨è¶…æ—¶ã€‚\nè§£å†³åŠæ³•ï¼š\n1 2 3 4 # è®¾ç½®è¶…æ—¶æ—¶é—´ spring.dubbo.consumer.timeout=600000 # è®¾ç½®æ˜¯å¦æ£€æŸ¥æœåŠ¡å­˜åœ¨ spring.dubbo.consumer.check=false å¯ä»¥äº†ï¼Œç»ˆäºæ‰¾å‡ºbugäº†ã€‚çœŸæ˜¯ä¸å®¹æ˜“\n","date":"2019-11-19T16:18:24Z","image":"https://www.ownit.top/title_pic/40.jpg","permalink":"https://www.ownit.top/p/201911191618/","title":"Dubboå¯åŠ¨ï¼Œè°ƒç”¨æ–¹æ³•å¤±è´¥ã€é—®é¢˜ï¼šè°ƒç”¨è¶…æ—¶ã€‘"},{"content":"åˆšåˆšå†™å®Œä¸€ä¸ªé¡¹ç›®ï¼Œå‡†å¤‡æ‰“åŒ…ï¼Œå´å‘ç°æ— æ³•æ‰“åŒ…ã€‚\nç„¶åè®¤çœŸæ’æŸ¥äº†ä¸€ä¸‹é—®é¢˜ã€‚å‘ç°å°‘å¼•å…¥äº†ä¸€ä¸ªæ’ä»¶ã€‚\n1 2 3 4 5 6 7 \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-surefire-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;skip\u0026gt;true\u0026lt;/skip\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; å¼•å…¥è¿™ä¸ªæ’ä»¶å°±å¯ä»¥å®Œç¾è¿è¡Œæ‰“åŒ…äº†ã€‚\n","date":"2019-11-18T09:42:22Z","image":"https://www.ownit.top/title_pic/42.jpg","permalink":"https://www.ownit.top/p/201911180942/","title":"Tests in error-BlogApplicationTests.initializationError Â» IllegalState Unable to find a @Spri...ã€è§£å†³ã€‘"},{"content":"ä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ ç»å¸¸ä¼šé‡åˆ°ç«¯å£è¢«å ç”¨çš„é—®é¢˜ï¼Œè€Œæ— æ³•å¯åŠ¨é¡¹ç›®ã€‚ è¿™ä¸ªäº‹æƒ…è®©äººå¾ˆçƒ¦ã€‚ã€ä¸¤ç§è§£å†³åŠæ³•ã€‘ 1ã€é¦–å…ˆï¼Œéœ€è¦ç¡®å®šé‚£ä¸ªç«¯å£è¢«å ç”¨ ç¤ºä¾‹ï¼š8080ç«¯å£è¢«å ç”¨ã€å‘½ä»¤æŸ¥çœ‹ç¨‹åºå ç”¨çš„pidã€‘\n1 netstat -ano | findstr 8080 2ã€é€šè¿‡CMDå‘½ä»¤åˆ©ç”¨PIDå¯ä»¥æ€æ‰å ç”¨çš„ç¨‹åº 1 taskkill /f /pid 92076 3ã€é€šè¿‡CMDæŸ¥å‡ºé‚£ä¸ªå‡¶æ‰‹å ç”¨ç«¯å£çš„åç§° 1 tasklist|findstr \u0026#34;80\u0026#34; 4ã€é€šè¿‡å‡¶æ‰‹çš„åç§°ï¼Œæ€æ‰ç¨‹åº 1 taskkill /f /im ç¨‹åºå ","date":"2019-11-15T17:53:34Z","image":"https://www.ownit.top/title_pic/55.jpg","permalink":"https://www.ownit.top/p/201911151753/","title":"è§£å†³ç«¯å£è¢«å ç”¨çš„é—®é¢˜ï¼ˆ80ã€8080ã€3306ï¼‰ç­‰ç­‰"},{"content":"Javaå®ç°MD5åŠ å¯† ä¸ºäº†ä¿æŠ¤æœ‰äº›æ•°æ®ï¼Œå°±éœ€è¦é‡‡å–ä¸€äº›æ‰‹æ®µæ¥è¿›è¡Œæ•°æ®çš„åŠ å¯†ï¼Œé˜²æ­¢è¢«åˆ«äººç ´è§£ã€‚\nMD5ç®€ä»‹ md5çš„å…¨ç§°æ˜¯md5ä¿¡æ¯æ‘˜è¦ç®—æ³•ï¼ˆè‹±æ–‡ï¼šMD5 Message-Digest Algorithm ï¼‰ï¼Œä¸€ç§è¢«å¹¿æ³›ä½¿ç”¨çš„å¯†ç æ•£åˆ—å‡½æ•°ï¼Œå¯ä»¥äº§ç”Ÿä¸€ä¸ª128ä½ï¼ˆ16å­—èŠ‚ï¼Œ1å­—èŠ‚8ä½ï¼‰çš„æ•£åˆ—å€¼ï¼ˆå¸¸è§çš„æ˜¯ç”¨32ä½çš„16è¿›åˆ¶è¡¨ç¤ºï¼Œæ¯”å¦‚ï¼š0caa3b23b8da53f9e4e041d95dc8fa2cï¼‰ï¼Œç”¨äºç¡®ä¿ä¿¡æ¯ä¼ è¾“çš„å®Œæ•´ä¸€è‡´ã€‚\nåŠŸèƒ½å®ç° 1ã€MD5çš„å·¥å…·ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 import java.security.MessageDigest; import java.security.NoSuchAlgorithmException; /** * å—å®«ä¹˜é£ */ public class MD5Utils { /** * MD5åŠ å¯†ç±» * @param str è¦åŠ å¯†çš„å­—ç¬¦ä¸² * @return åŠ å¯†åçš„å­—ç¬¦ä¸² */ public static String code(String str){ try { MessageDigest md = MessageDigest.getInstance(\u0026#34;MD5\u0026#34;); md.update(str.getBytes()); byte[]byteDigest = md.digest(); int i; StringBuffer buf = new StringBuffer(\u0026#34;\u0026#34;); for (int offset = 0; offset \u0026lt; byteDigest.length; offset++) { i = byteDigest[offset]; if (i \u0026lt; 0) i += 256; if (i \u0026lt; 16) buf.append(\u0026#34;0\u0026#34;); buf.append(Integer.toHexString(i)); } //32ä½åŠ å¯† return buf.toString(); // 16ä½çš„åŠ å¯† //return buf.toString().substring(8, 24); } catch (NoSuchAlgorithmException e) { e.printStackTrace(); return null; } } /** * æµ‹è¯•æ–¹æ³• * @param args */ public static void main(String[] args) { System.out.println(code(\u0026#34;111111\u0026#34;)); } } æœ€ä¸‹é¢è¿™ä¸ªæ˜¯æµ‹è¯•æ–¹æ³•\n2ã€é¡¹ç›®ä¸­è°ƒç”¨ æˆ‘åœ¨é¡¹ç›®çš„æ¥å£ä¸­è°ƒç”¨MD5çš„æ–¹æ³•\n1 2 3 4 public User checkUser(String username, String password) { User user = userRepository.findByUsernameAndPassword(username, MD5Utils.code(password)); return user; } è§£æï¼šè¿™å°±æ˜¯ç”¨æˆ·ç™»å½•æŠŠå¯†ç ä¼ é€’è¿‡æ¥ï¼Œè¿›è¡ŒMD5åŠ å¯†åï¼Œåœ¨å’Œæ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œå¯¹æ¯”ï¼ˆæ•°æ®åº“ä¸­çš„å¯†ç æ˜¯MD5æ ¼å¼å­˜å‚¨çš„ï¼‰\n3ã€æ€è·¯æ‹“å±•ï¼ˆé˜²æ­¢é‡è¦ä¿¡æ¯è¢«ç›—ç”¨ï¼‰ è´¦å·æ³¨å†Œ å¯†ç ç™»å½• ä¿¡æ¯ä¿æŠ¤ èµ„æ–™åŠ å¯† ç­‰ç­‰ï¼Œè®¸å¤šçš„åŠŸèƒ½éƒ½å¯ä»¥ç”¨åˆ°è¿™æ ·çš„æ–¹æ³•æ¥è¿›è¡ŒåŠ å¯†ã€‚\n","date":"2019-11-14T18:00:16Z","image":"https://www.ownit.top/title_pic/17.jpg","permalink":"https://www.ownit.top/p/201911141800/","title":"Javaä½¿ç”¨MD5åŠ å¯†ç®—æ³•ï¼Œå®ç°ç­‰ç™»é™†åŠŸèƒ½"},{"content":"æˆ‘ä»¬å‡†å¤‡è®¾è®¡åšå®¢ï¼Œé‚£å°±è¦è®¾è®¡æ•°æ®åº“ã€‚\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨Hibernateæ¥è‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“ã€‚\nåšå®¢æ•°æ®åº“çš„ç»“æ„ï¼š\nå®ä½“ç±»ï¼š\nåšå®¢ Blog åšå®¢åˆ†ç±» Type åšå®¢æ ‡ç­¾ Tag åšå®¢è¯„è®º Comment ç”¨æˆ· User é¡¹ç›®æˆªå›¾ï¼š\né¦–å…ˆï¼Œåœ¨pom.xmlä¸­æ·»åŠ ä»¥ä¸‹çš„ä¸€äº›ä¾èµ–:\n1 2 3 4 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-data-jpa\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; è¿™æ ·å°±å¯ä»¥ä½¿ç”¨Hibernateæ¡†æ¶äº†ï¼Œä¸‹é¢å®ç°è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨çš„åŠŸèƒ½:\næ‰“å¼€application.propertiesæ–‡ä»¶æ·»åŠ ä»¥ä¸‹çš„ä»£ç :\n1 2 3 4 jpa: hibernate: ddl-auto: update show-sql: true è¿™é‡Œé™¤äº†updateå‚æ•°å¤–è¿˜æœ‰å…¶ä»–çš„å‚æ•°ï¼Œè¿™é‡Œè§£é‡Šä¸€ä¸‹:\n//1ï¼švalue=\u0026ldquo;create-drop\u0026rdquo; è¡¨ç¤ºå½“JPAåº”ç”¨çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºè¡¨ï¼Œåœ¨è§£åº”ç”¨çš„æ—¶å€™åˆ é™¤ç›¸åº”çš„è¡¨ï¼Œè¿™ä¸ªåœ¨åšæµ‹è¯•çš„æ—¶å€™æ¯”è¾ƒæœ‰ç”¨ï¼Œä½†åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¸è¿™ä¹ˆç”¨\n//2ï¼švalue=\u0026ldquo;create\u0026quot;è¿™ä¸ªåœ¨æ¯æ¬¡åº”ç”¨å¯åŠ¨çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆä¼šåˆ é™¤ä»¥å‰æ•°æ®åº“é‡Œçš„æ•°æ®ã€‚\n//3ï¼švalue=\u0026ldquo;update\u0026rdquo; è¿™ä¸ªå±æ€§çš„ä½œç”¨æ˜¯a:æ¯æ¬¡åªä¼šæ›´æ–°æ•°æ®åº“è¡¨é‡Œçš„ä¿¡æ¯\nä¸‹é¢æ˜¯åˆ›å»ºå®ä½“ç±»çš„ä»£ç :\nBlog 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 package com.lrm.po; import javax.persistence.*; import java.util.ArrayList; import java.util.Date; import java.util.List; @Entity @Table(name = \u0026#34;t_blog\u0026#34;) public class Blog { @Id @GeneratedValue private Long id; private String title; private String content; private String firstPicture; private String flag; private Integer views; private boolean appreciation; private boolean shareStatement; private boolean commentabled; private boolean published; private boolean recommend; private Date createTime; private Date updateTime; @ManyToOne private Type type; @ManyToMany(cascade = {CascadeType.PERSIST}) private List\u0026lt;Tag\u0026gt; tags=new ArrayList\u0026lt;\u0026gt;(); @ManyToOne private User user; @OneToMany(mappedBy = \u0026#34;blog\u0026#34;) private List\u0026lt;Comment\u0026gt; comments = new ArrayList\u0026lt;\u0026gt;(); public Blog() { } public Long getId() { return id; } public void setId(Long id) { this.id = id; } public String getTitle() { return title; } public void setTitle(String title) { this.title = title; } public String getContent() { return content; } public void setContent(String content) { this.content = content; } public String getFirstPicture() { return firstPicture; } public void setFirstPicture(String firstPicture) { this.firstPicture = firstPicture; } public String getFlag() { return flag; } public void setFlag(String flag) { this.flag = flag; } public Integer getViews() { return views; } public void setViews(Integer views) { this.views = views; } public boolean isAppreciation() { return appreciation; } public void setAppreciation(boolean appreciation) { this.appreciation = appreciation; } public boolean isShareStatement() { return shareStatement; } public void setShareStatement(boolean shareStatement) { this.shareStatement = shareStatement; } public boolean isCommentabled() { return commentabled; } public void setCommentabled(boolean commentabled) { this.commentabled = commentabled; } public boolean isPublished() { return published; } public void setPublished(boolean published) { this.published = published; } public boolean isRecommend() { return recommend; } public void setRecommend(boolean recommend) { this.recommend = recommend; } public Date getCreateTime() { return createTime; } public void setCreateTime(Date createTime) { this.createTime = createTime; } public Date getUpdateTime() { return updateTime; } public void setUpdateTime(Date updateTime) { this.updateTime = updateTime; } public Type getType() { return type; } public void setType(Type type) { this.type = type; } public List\u0026lt;Tag\u0026gt; getTags() { return tags; } public void setTags(List\u0026lt;Tag\u0026gt; tags) { this.tags = tags; } public User getUser() { return user; } public void setUser(User user) { this.user = user; } public List\u0026lt;Comment\u0026gt; getComments() { return comments; } public void setComments(List\u0026lt;Comment\u0026gt; comments) { this.comments = comments; } @Override public String toString() { return \u0026#34;Blog{\u0026#34; + \u0026#34;id=\u0026#34; + id + \u0026#34;, title=\u0026#39;\u0026#34; + title + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, content=\u0026#39;\u0026#34; + content + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, firstPicture=\u0026#39;\u0026#34; + firstPicture + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, flag=\u0026#39;\u0026#34; + flag + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, views=\u0026#34; + views + \u0026#34;, appreciation=\u0026#34; + appreciation + \u0026#34;, shareStatement=\u0026#34; + shareStatement + \u0026#34;, commentabled=\u0026#34; + commentabled + \u0026#34;, published=\u0026#34; + published + \u0026#34;, recommend=\u0026#34; + recommend + \u0026#34;, createTime=\u0026#34; + createTime + \u0026#34;, updateTime=\u0026#34; + updateTime + \u0026#39;}\u0026#39;; } } Comment 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 package com.lrm.po; import javax.persistence.*; import java.util.ArrayList; import java.util.Date; import java.util.List; @Entity @Table(name = \u0026#34;t_comment\u0026#34;) public class Comment { @Id @GeneratedValue private Long id; private String nickname; private String email; private String content; private String avatar; @Temporal(TemporalType.TIMESTAMP) private Date createTime; @ManyToOne private Blog blog; @OneToMany(mappedBy = \u0026#34;parentComment\u0026#34;) private List\u0026lt;Comment\u0026gt; replyComments = new ArrayList\u0026lt;\u0026gt;(); @ManyToOne private Comment parentComment; public Comment() { } public Long getId() { return id; } public void setId(Long id) { this.id = id; } public String getNickname() { return nickname; } public void setNickname(String nickname) { this.nickname = nickname; } public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } public String getContent() { return content; } public void setContent(String content) { this.content = content; } public String getAvatar() { return avatar; } public void setAvatar(String avatar) { this.avatar = avatar; } public Date getCreateTime() { return createTime; } public void setCreateTime(Date createTime) { this.createTime = createTime; } public Blog getBlog() { return blog; } public void setBlog(Blog blog) { this.blog = blog; } public List\u0026lt;Comment\u0026gt; getReplyComments() { return replyComments; } public void setReplyComments(List\u0026lt;Comment\u0026gt; replyComments) { this.replyComments = replyComments; } public Comment getParentComment() { return parentComment; } public void setParentComment(Comment parentComment) { this.parentComment = parentComment; } @Override public String toString() { return \u0026#34;Comment{\u0026#34; + \u0026#34;id=\u0026#34; + id + \u0026#34;, nickname=\u0026#39;\u0026#34; + nickname + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, email=\u0026#39;\u0026#34; + email + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, content=\u0026#39;\u0026#34; + content + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, avatar=\u0026#39;\u0026#34; + avatar + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, createTime=\u0026#34; + createTime + \u0026#39;}\u0026#39;; } } Tag 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 package com.lrm.po; import javax.persistence.*; import java.util.ArrayList; import java.util.List; @Entity @Table(name = \u0026#34;t_tag\u0026#34;) public class Tag { @Id @GeneratedValue private Long id; private String name; @ManyToMany(mappedBy = \u0026#34;tags\u0026#34;) private List\u0026lt;Blog\u0026gt; blogs = new ArrayList\u0026lt;\u0026gt;(); public Tag() { } public Long getId() { return id; } public void setId(Long id) { this.id = id; } public String getName() { return name; } public void setName(String name) { this.name = name; } public List\u0026lt;Blog\u0026gt; getBlogs() { return blogs; } public void setBlogs(List\u0026lt;Blog\u0026gt; blogs) { this.blogs = blogs; } @Override public String toString() { return \u0026#34;Tag{\u0026#34; + \u0026#34;id=\u0026#34; + id + \u0026#34;, name=\u0026#39;\u0026#34; + name + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#39;}\u0026#39;; } } Type 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 package com.lrm.po; import javax.persistence.*; import java.util.ArrayList; import java.util.List; @Entity @Table(name = \u0026#34;t_type\u0026#34;) public class Type { @Id @GeneratedValue private long id; private String name; @OneToMany(mappedBy = \u0026#34;type\u0026#34;) private List\u0026lt;Blog\u0026gt; blogs = new ArrayList\u0026lt;\u0026gt;(); public Type() { } public long getId() { return id; } public void setId(long id) { this.id = id; } public String getName() { return name; } public void setName(String name) { this.name = name; } public List\u0026lt;Blog\u0026gt; getBlogs() { return blogs; } public void setBlogs(List\u0026lt;Blog\u0026gt; blogs) { this.blogs = blogs; } @Override public String toString() { return \u0026#34;Type{\u0026#34; + \u0026#34;id=\u0026#34; + id + \u0026#34;, name=\u0026#39;\u0026#34; + name + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#39;}\u0026#39;; } } User 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 package com.lrm.po; import javax.persistence.*; import java.util.ArrayList; import java.util.Date; import java.util.List; /** * Created by limi on 2017/10/14. */ @Entity @Table(name = \u0026#34;t_user\u0026#34;) public class User { @Id @GeneratedValue private Long id; private String nickname; private String username; private String password; private String email; private String avatar; private Integer type; @Temporal(TemporalType.TIMESTAMP) private Date createTime; @Temporal(TemporalType.TIMESTAMP) private Date updateTime; @OneToMany(mappedBy = \u0026#34;user\u0026#34;) private List\u0026lt;Blog\u0026gt; blogs = new ArrayList\u0026lt;\u0026gt;(); public User() { } public Long getId() { return id; } public void setId(Long id) { this.id = id; } public String getNickname() { return nickname; } public void setNickname(String nickname) { this.nickname = nickname; } public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getPassword() { return password; } public void setPassword(String password) { this.password = password; } public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } public String getAvatar() { return avatar; } public void setAvatar(String avatar) { this.avatar = avatar; } public Integer getType() { return type; } public void setType(Integer type) { this.type = type; } public Date getCreateTime() { return createTime; } public void setCreateTime(Date createTime) { this.createTime = createTime; } public Date getUpdateTime() { return updateTime; } public void setUpdateTime(Date updateTime) { this.updateTime = updateTime; } public List\u0026lt;Blog\u0026gt; getBlogs() { return blogs; } public void setBlogs(List\u0026lt;Blog\u0026gt; blogs) { this.blogs = blogs; } @Override public String toString() { return \u0026#34;User{\u0026#34; + \u0026#34;id=\u0026#34; + id + \u0026#34;, nickname=\u0026#39;\u0026#34; + nickname + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, username=\u0026#39;\u0026#34; + username + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, password=\u0026#39;\u0026#34; + password + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, email=\u0026#39;\u0026#34; + email + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, avatar=\u0026#39;\u0026#34; + avatar + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, type=\u0026#34; + type + \u0026#34;, createTime=\u0026#34; + createTime + \u0026#34;, updateTime=\u0026#34; + updateTime + \u0026#39;}\u0026#39;; } } OKï¼Œæ—¢ç„¶ï¼Œå®ä½“ç±»å·²å°†åˆ›å»ºå®Œæ¯•ï¼Œè¿è¡Œæ¥å£ã€‚å°±å¯ä»¥ç”Ÿæˆæ•°æ®åº“ã€‚ä½†æ˜¯å‰æï¼Œä½ æ˜¯é…ç½®æ•°æ®åº“\n1 2 3 4 5 6 spring: datasource: driver-class-name: com.mysql.jdbc.Driver url: jdbc:mysql://localhost:3306/blog?useUnicode=true\u0026amp;characterEncoding=utf-8 username: root password: root æµ‹è¯•ç»“æœï¼š çœŸçš„å¾ˆniceï¼Œç¡®å®æ˜¯ä¸€æ³¢éªšæ“ä½œã€‚\n","date":"2019-11-11T17:52:14Z","image":"https://www.ownit.top/title_pic/13.jpg","permalink":"https://www.ownit.top/p/201911111752/","title":"SpringBootä½¿ç”¨Hibernateï¼Œå®ç°è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨ã€åšå®¢æ•°æ®åº“è®¾è®¡ã€‘"},{"content":"Elasticsearch6.0 1ã€Elasticsearchï¼š Elasticsearchæ˜¯ä¸€ä¸ªåŸºäºApache Lucene(TM)çš„å¼€æºæœç´¢å¼•æ“ã€‚æ— è®ºåœ¨å¼€æºè¿˜æ˜¯ä¸“æœ‰é¢†åŸŸï¼ŒLuceneå¯ä»¥è¢«è®¤ä¸ºæ˜¯è¿„ä»Šä¸ºæ­¢æœ€å…ˆè¿›ã€æ€§èƒ½æœ€å¥½çš„ã€åŠŸèƒ½æœ€å…¨çš„æœç´¢å¼•æ“åº“ã€‚\nç‰¹ç‚¹ï¼š\nåˆ†å¸ƒå¼çš„å®æ—¶æ–‡ä»¶å­˜å‚¨ï¼Œæ¯ä¸ªå­—æ®µéƒ½è¢«ç´¢å¼•å¹¶å¯è¢«æœç´¢ åˆ†å¸ƒå¼çš„å®æ—¶åˆ†ææœç´¢å¼•æ“--åšä¸è§„åˆ™æŸ¥è¯¢ å¯ä»¥æ‰©å±•åˆ°ä¸Šç™¾å°æœåŠ¡å™¨ï¼Œå¤„ç†PBçº§ç»“æ„åŒ–æˆ–éç»“æ„åŒ–æ•°æ® Elasticsearchä¹Ÿä½¿ç”¨Javaå¼€å‘å¹¶ä½¿ç”¨Luceneä½œä¸ºå…¶æ ¸å¿ƒæ¥å®ç°æ‰€æœ‰ç´¢å¼•å’Œæœç´¢çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒçš„ç›®çš„æ˜¯é€šè¿‡ç®€å•çš„RESTful APIæ¥éšè—Luceneçš„å¤æ‚æ€§ï¼Œä»è€Œè®©å…¨æ–‡æœç´¢å˜å¾—ç®€å•ã€‚\nESèƒ½åšä»€ä¹ˆï¼Ÿ\nå…¨æ–‡æ£€ç´¢ï¼ˆå…¨éƒ¨å­—æ®µï¼‰ã€æ¨¡ç³ŠæŸ¥è¯¢ï¼ˆæœç´¢ï¼‰ã€æ•°æ®åˆ†æï¼ˆæä¾›åˆ†æè¯­æ³•ï¼Œä¾‹å¦‚èšåˆï¼‰\n2ã€Elasticsearchä½¿ç”¨æ¡ˆä¾‹ ï¼ˆ1ï¼‰2013å¹´åˆï¼ŒGitHubæŠ›å¼ƒäº†Solrï¼Œé‡‡å–ElasticSearch æ¥åšPBçº§çš„æœç´¢ã€‚ â€œGitHubä½¿ç”¨ElasticSearchæœç´¢20TBçš„æ•°æ®ï¼ŒåŒ…æ‹¬13äº¿æ–‡ä»¶å’Œ1300äº¿è¡Œä»£ç â€\nï¼ˆ2ï¼‰ç»´åŸºç™¾ç§‘ï¼šå¯åŠ¨ä»¥elasticsearchä¸ºåŸºç¡€çš„æ ¸å¿ƒæœç´¢æ¶æ„SoundCloudï¼šâ€œSoundCloudä½¿ç”¨ElasticSearchä¸º1.8äº¿ç”¨æˆ·æä¾›å³æ—¶è€Œç²¾å‡†çš„éŸ³ä¹æœç´¢æœåŠ¡â€\nï¼ˆ3ï¼‰ç™¾åº¦ï¼šç™¾åº¦ç›®å‰å¹¿æ³›ä½¿ç”¨ElasticSearchä½œä¸ºæ–‡æœ¬æ•°æ®åˆ†æï¼Œé‡‡é›†ç™¾åº¦æ‰€æœ‰æœåŠ¡å™¨ä¸Šçš„å„ç±»æŒ‡æ ‡æ•°æ®åŠç”¨æˆ·è‡ªå®šä¹‰æ•°æ®ï¼Œé€šè¿‡å¯¹å„ç§æ•°æ®è¿›è¡Œå¤šç»´åˆ†æå±•ç¤ºï¼Œè¾…åŠ©å®šä½åˆ†æå®ä¾‹å¼‚å¸¸æˆ–ä¸šåŠ¡å±‚é¢å¼‚å¸¸ã€‚ç›®å‰è¦†ç›–ç™¾åº¦å†…éƒ¨20å¤šä¸ªä¸šåŠ¡çº¿ï¼ˆåŒ…æ‹¬casioã€äº‘åˆ†æã€ç½‘ç›Ÿã€é¢„æµ‹ã€æ–‡åº“ã€ç›´è¾¾å·ã€é’±åŒ…ã€é£æ§ç­‰ï¼‰ï¼Œå•é›†ç¾¤æœ€å¤§100å°æœºå™¨ï¼Œ200ä¸ªESèŠ‚ç‚¹ï¼Œæ¯å¤©å¯¼å…¥30TB+æ•°æ®\nï¼ˆ4ï¼‰æ–°æµªä½¿ç”¨ES åˆ†æå¤„ç†32äº¿æ¡å®æ—¶æ—¥å¿—\nï¼ˆ5ï¼‰é˜¿é‡Œä½¿ç”¨ES æ„å»ºæŒ–è´¢è‡ªå·±çš„æ—¥å¿—é‡‡é›†å’Œåˆ†æä½“ç³»\n3ã€åŒç±»äº§å“ Solrã€ElasticSearchã€Hermesï¼ˆè…¾è®¯ï¼‰ï¼ˆå®æ—¶æ£€ç´¢åˆ†æï¼‰\nSolrã€ES 1.Â æºè‡ªæœç´¢å¼•æ“ï¼Œä¾§é‡æœç´¢ä¸å…¨æ–‡æ£€ç´¢ã€‚\n2.Â æ•°æ®è§„æ¨¡ä»å‡ ç™¾ä¸‡åˆ°åƒä¸‡ä¸ç­‰ï¼Œæ•°æ®é‡è¿‡äº¿çš„é›†ç¾¤ç‰¹åˆ«å°‘ã€‚\næœ‰å¯èƒ½å­˜åœ¨ä¸ªåˆ«ç³»ç»Ÿæ•°æ®é‡è¿‡äº¿ï¼Œä½†è¿™å¹¶ä¸æ˜¯æ™®éç°è±¡ï¼ˆå°±åƒOracleçš„è¡¨é‡Œçš„æ•°æ®è§„æ¨¡æœ‰å¯èƒ½è¶…è¿‡Hiveé‡Œä¸€æ ·ï¼Œä½†éœ€è¦å°å‹æœºï¼‰ã€‚\nHermes 1.Â ä¸€ä¸ªåŸºäºå¤§ç´¢å¼•æŠ€æœ¯çš„æµ·é‡æ•°æ®å®æ—¶æ£€ç´¢åˆ†æå¹³å°ã€‚ä¾§é‡æ•°æ®åˆ†æã€‚\n2.Â æ•°æ®è§„æ¨¡ä»å‡ äº¿åˆ°ä¸‡äº¿ä¸ç­‰ã€‚æœ€å°çš„è¡¨ä¹Ÿæ˜¯åƒä¸‡çº§åˆ«ã€‚\nåœ¨Â è…¾è®¯17Â å°TS5æœºå™¨ï¼Œå°±å¯ä»¥å¤„ç†æ¯å¤©450äº¿çš„æ•°æ®(æ¯æ¡æ•°æ®1kbå·¦å³)ï¼Œæ•°æ®å¯ä»¥ä¿å­˜ä¸€ä¸ªæœˆä¹‹ä¹…ã€‚\nSolrã€ESåŒºåˆ« å…¨æ–‡æ£€ç´¢ã€æœç´¢ã€åˆ†æã€‚åŸºäºlucene\nSolr åˆ©ç”¨ Zookeeper è¿›è¡Œåˆ†å¸ƒå¼ç®¡ç†ï¼Œè€Œ Elasticsearch è‡ªèº«å¸¦æœ‰åˆ†å¸ƒå¼åè°ƒç®¡ç†åŠŸèƒ½; Solr æ”¯æŒæ›´å¤šæ ¼å¼çš„æ•°æ®ï¼Œè€Œ Elasticsearch ä»…æ”¯æŒjsonæ–‡ä»¶æ ¼å¼ï¼› Solr å®˜æ–¹æä¾›çš„åŠŸèƒ½æ›´å¤šï¼Œè€Œ Elasticsearch æœ¬èº«æ›´æ³¨é‡äºæ ¸å¿ƒåŠŸèƒ½ï¼Œé«˜çº§åŠŸèƒ½å¤šæœ‰ç¬¬ä¸‰æ–¹æ’ä»¶æä¾›ï¼› Solr åœ¨ä¼ ç»Ÿçš„æœç´¢åº”ç”¨ä¸­è¡¨ç°å¥½äº Elasticsearchï¼Œä½†åœ¨å¤„ç†å®æ—¶æœç´¢åº”ç”¨æ—¶æ•ˆç‡æ˜æ˜¾ä½äº Elasticsearch\u0026mdash;\u0026ndash;é™„è¿‘çš„äºº Luceneæ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„å…¨æ–‡æ£€ç´¢å¼•æ“å·¥å…·åŒ…ï¼Œä½†å®ƒä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å…¨æ–‡æ£€ç´¢å¼•æ“ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¨æ–‡æ£€ç´¢å¼•æ“çš„æ¶æ„ï¼Œæä¾›äº†å®Œæ•´çš„æŸ¥è¯¢å¼•æ“å’Œç´¢å¼•å¼•æ“ï¼Œéƒ¨åˆ†æ–‡æœ¬åˆ†æå¼•æ“\næœç´¢å¼•æ“äº§å“ç®€ä»‹\n1 æœç´¢å¼•æ“ elasticSearch6ï¼ˆå’ŒelasticSearch5çš„åŒºåˆ«åœ¨äºï¼Œrootç”¨æˆ·æƒé™ã€ä¸€ä¸ªåº“èƒ½å¦å»ºç«‹å¤šä¸ªè¡¨ï¼‰\nè½¯ä»¶é“¾æ¥ï¼šhttps://www.lanzous.com/i73b6pc\n2 æœç´¢å¼•æ“ æ–‡æœ¬æœç´¢(ä»¥ç©ºé—´æ¢æ—¶é—´ç®—æ³•)\näºåŒç±»äº§å“ç›¸æ¯”(solrã€hermes),å’Œsolrä¸€æ ·éƒ½æ˜¯åŸºäºlucene(apache)ï¼Œé»˜è®¤ä»¥é›†ç¾¤æ–¹å¼å·¥ä½œ\næœç´¢å¼•æ“(ä»¥ç™¾åº¦å’Œgooleä¸ºä¾‹)çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ\na çˆ¬è™«\nb åˆ†æ\nc æŸ¥è¯¢\n3 elasticSearch(æœç´¢å¼•æ“)çš„ç®—æ³• å€’æ’ç´¢å¼•(åœ¨å†…å®¹ä¸Šå»ºç«‹ç´¢å¼•ï¼Œç”¨å†…å®¹å»åŒ¹é…ç´¢å¼•)\nBtreeï¼ˆbalance tree b-treeï¼‰\nB+tree\n4ã€Elasticsearchå®‰è£…æ•™ç¨‹ 1ã€å‡†å¤‡å·¥ä½œ å®‰è£…Centos7ã€å»ºè®®å†…å­˜2Gä»¥ä¸Šã€å®‰è£…java1.8ç¯å¢ƒ\n2ã€è®¾ç½®IPåœ°å€ï¼ˆè¦æœ‰å›ºå®šçš„IPï¼‰ 3ã€Javaç¯å¢ƒå®‰è£… è§£å‹å®‰è£…åŒ… 1 [root@localhost jdk1.8]# tar -zxvf jdk-8u171-linux-x64.tar.gz 2ã€åœ¨æ–‡ä»¶æœ€åæ·»åŠ \n1 2 3 4 export JAVA_HOME=/opt/es/jdk1.8.0_152 export JRE_HOME=$JAVA_HOME/jre export CLASSPATH=.:$JAVA_HOME/LIB:$JRE_HOME/LIB:$CLASSPATH export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH 3ã€æŸ¥çœ‹javaå®‰è£…æˆåŠŸ\n4ã€é…ç½®æ–‡ä»¶ elasticSearch.ymlï¼ˆé›†ç¾¤é…ç½®æ–‡ä»¶ï¼‰ã€jvm.Opitons(jvmé…ç½®æ–‡ä»¶)\n5ã€ åˆ›å»ºç›®å½• ï¼Œä¸Šä¼ æ–‡ä»¶å’Œè§£å‹ åˆ›å»º\n1 mkdir -p /opt/es ä¸Šä¼ \nè§£å‹\n1 tar -zxvf elasticsearch-6.3.1.tar.gz 6ã€ é…ç½® esä½¿ç”¨æœ€å¤§çº¿ç¨‹æ•°ã€æœ€å¤§å†…å­˜æ•°ã€è®¿é—®çš„æœ€å¤§æ–‡ä»¶æ•°\néœ€è¦æ”¹æˆå…¶ä»–éç”¨æˆ·å¯åŠ¨ åˆ›å»ºæ–°ç”¨æˆ·\n1 [root@wei bin]# adduser es åˆ‡æ¢esç”¨æˆ·ä¸‹ï¼ˆæˆåŠŸï¼‰\n1 2 [root@wei bin]# su es [es@wei bin]$ 7ã€å¯åŠ¨ Esçš„æƒé™é—®é¢˜ï¼š\né¦–å…ˆç”¨rootç”¨æˆ·è§£å‹\nç„¶åç”¨rootç”¨æˆ·æˆæƒ\næ•´ä¸ªæ–‡ä»¶å¤¹å…¨éƒ¨æˆæƒï¼ˆRï¼šè¡¨ç¤ºå¾ªç¯æˆæƒï¼‰\n1 [root@wei es]# chmod 777 -R elasticsearch-6.3.1 å¯åŠ¨åé…ç½®\nelasticSearch.ymlã€jvm.Opitons\nesä½¿ç”¨çš„jvmçš„å†…å­˜å¤§å°\nelasticSearch.ymlä¸­é…ç½®esçš„hoståœ°å€(é…æˆæœ¬æœºåœ°å€ï¼Œå…è®¸è®¿é—®)\né…ç½®å®Œæ¯•å¯åŠ¨es(å¿…é¡»åˆ‡æ¢åˆ°érootç”¨æˆ·ä¸‹)\n8ã€å¯åŠ¨åä¼šæŠ¥é”™(linuxçš„é»˜è®¤çº¿ç¨‹æ•°ã€æœ€å¤§æ–‡ä»¶æ•°ã€æœ€å¤§å†…å­˜æ•°éƒ½ä¸å¤Ÿ) 9ã€ ä¿®æ”¹linuxçš„é…ç½®(é…åˆesçš„å¯åŠ¨éœ€æ±‚) ä¸¤å¤„ä¿®æ”¹\nAä¿®æ”¹linuxçš„limitsé…ç½®æ–‡ä»¶ï¼Œè®¾ç½®å†…å­˜çº¿ç¨‹å’Œæ–‡ä»¶\n1 2 3 4 * hard nofile 655360 * soft nofile 131072 * hard nproc 4096 * soft nproc 2048 Bä¿®æ”¹linuxçš„sysctlé…ç½®æ–‡ä»¶ï¼Œé…ç½®ç³»ç»Ÿä½¿ç”¨å†…å­˜\n1 2 vm.max_map_count=655360 fs.file-max=655360 æ•´ä¸ªesçš„é…ç½®æœ‰å››å¤„æ–‡ä»¶éœ€è¦ä¿®æ”¹ elasticSearch.yml esçš„å¯åŠ¨hoståœ°å€ jvm.optionsé…ç½®esçš„è™šæ‹Ÿæœºå†…å­˜ limits.confé…ç½®linuxçš„çº¿ç¨‹å†…å­˜å’Œæ–‡ä»¶ sysctl.confé…ç½®ç³»ç»Ÿå…è®¸çš„è½¯ä»¶è¿è¡Œå†…å­˜ 10ã€æˆåŠŸè®¿é—® ","date":"2019-10-31T13:26:55Z","image":"https://www.ownit.top/title_pic/03.jpg","permalink":"https://www.ownit.top/p/201910311326/","title":"Centos7å®‰è£…elasticSearch6"},{"content":"Redsiå¸¸è§é—®é¢˜ ç¼“å­˜åœ¨é«˜å¹³å‘å’Œå®‰å…¨å‹åŠ›ä¸‹çš„ä¸€äº›é—®é¢˜\nç¼“å­˜å‡»ç©¿ æ˜¯æŸä¸€ä¸ªçƒ­ç‚¹keyåœ¨é«˜å¹¶å‘è®¿é—®çš„æƒ…å†µä¸‹ï¼Œçªç„¶å¤±æ•ˆï¼Œå¯¼è‡´å¤§é‡çš„å¹¶å‘å¤§é‡‘mysqlæ•°æ®åº“çš„æƒ…å†µ\nç¼“å­˜ç©¿é€ æ˜¯åˆ©ç”¨rediså’Œmysqlçš„æœºåˆ¶ï¼ˆredisç¼“å­˜ä¸€æ—¦ä¸å­˜åœ¨ï¼Œå°±è®¿é—®mysqlï¼‰ï¼Œç›´æ¥è®©è¿‡ç¼“å­˜è®¿é—®mysqlï¼Œè€Œåˆ¶é€ çš„dbè¯·æ±‚å‹åŠ›\nä¸€èˆ¬åœ¨ä»£ç ä¸­é˜²æ­¢\nè§£å†³ï¼š ä¸ºé˜²æ­¢ç¼“å­˜ç©¿é€ï¼Œå°†nullæˆ–è€…ç©ºå­—ç¬¦ä¸²è®¾ç½®ç»™redis\nç¼“å­˜é›ªå´© ç¼“å­˜æ˜¯é‡‡ç”¨äº†ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯¼è‡´ç¼“å­˜åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å…¨éƒ¨å¤±æ•ˆï¼Œå¯¼è‡´çš„dbå´©æºƒ\nè§£å†³ï¼šè®¾è®¡ä¸åŒçš„ç¼“å­˜å¤±æ•ˆæ—¶é—´\nå¦‚ä½•è§£å†³ç¼“å­˜å‡»ç©¿çš„é—®é¢˜ ï¼Ÿ åˆ†å¸ƒå¼é”\nç©¿é€ï¼šåˆ©ç”¨ä¸å­˜åœ¨çš„keyå»æ”»å‡»mysqlæ•°æ®åº“\né›ªå´©ï¼šç¼“å­˜ä¸­çš„å¾ˆå¤škeyå¤±æ•ˆï¼Œå¯¼è‡´æ•°æ®åº“è´Ÿè½½è¿‡é‡å®•æœº\nå‡»ç©¿ï¼šåœ¨æ­£å¸¸çš„è®¿é—®æƒ…å†µä¸‹ï¼Œå¦‚æœç¼“å­˜å¤±æ•ˆï¼Œå¦‚æœä¿æŠ¤mysqlï¼Œé‡å¯ç¼“å­˜çš„è¿‡ç¨‹\nä½¿ç”¨redisæ•°æ®åº“çš„åˆ†å¸ƒå¼é”ï¼Œè§£å†³mysqlçš„è®¿é—®å‹åŠ›é—®é¢˜\nç¬¬ä¸€ç§åˆ†å¸ƒå¼é”ï¼šredisè‡ªå¸¦ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼Œset px nx ç”¨å®Œä¹‹åéœ€è¦åˆ é™¤ï¼Œä¸ç„¶åˆ«äººä¸èƒ½è®¿é—®ã€‚\né”™è¯¯è‡ªæ—‹ä»£ç ï¼ˆBä¸ºå­¤å„¿çº¿ç¨‹ï¼‰\næ­£ç¡®è‡ªæ—‹ä»£ç \né—®é¢˜1 å¦‚æœåœ¨redisä¸­çš„é”å·²ç»è¿‡æœŸäº†ï¼Œç„¶åé”è¿‡æœŸçš„é‚£ä¸ªè¯·æ±‚åˆæ‰§è¡Œå®Œæ¯•ï¼Œå›æ¥åˆ é”,åˆ é™¤äº†å…¶ä»–çº¿ç¨‹çš„é”ï¼Œæ€ä¹ˆåŠï¼Ÿ\né—®é¢˜2 å¦‚æœç¢°å·§åœ¨æŸ¥è¯¢redisé”è¿˜æ²¡åˆ é™¤çš„æ—¶å€™ï¼Œæ­£åœ¨ç½‘ç»œä¼ è¾“æ—¶ï¼Œé”è¿‡æœŸäº†ï¼Œæ€ä¹ˆåŠï¼Ÿ\n1 2 String script =\u0026#34;if redis.call(\u0026#39;get\u0026#39;, KEYS[1]) == ARGV[1] then return redis.call(\u0026#39;del\u0026#39;, KEYS[1]) else return 0 end\u0026#34;; jedis.eval(script, Collections.singletonList(\u0026#34;lock\u0026#34;),Collections.singletonList(token)); ç¬¬äºŒç§åˆ†å¸ƒå¼é”ï¼šredissonæ¡†æ¶ï¼Œä¸€ä¸ªredisçš„å¸¦æœ‰jucçš„lockåŠŸèƒ½çš„å®¢æˆ·ç«¯ï¼ˆæ—¢æœ‰jedisçš„åŠŸèƒ½ï¼Œåˆæœ‰jucçš„åŠŸèƒ½ï¼‰ æ•´åˆ å¼•å…¥pom\n1 2 3 4 5 6 \u0026lt;!-- https://mvnrepository.com/artifact/org.redisson/redisson --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.redisson\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;redisson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.10.5\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; é…ç½®\n1 2 spring.redis.host=192.168.159.130 spring.redis.port=6379 é…ç½®ç±»\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Configuration public class GmallRedissonConfig { @Value(\u0026#34;${spring.redis.host}\u0026#34;) private String host; @Value(\u0026#34;${spring.redis.port}\u0026#34;) private String port; @Bean public RedissonClient redissonClient(){ Config config = new Config(); config.useSingleServer().setAddress(\u0026#34;redis://\u0026#34;+host+\u0026#34;:\u0026#34;+port); RedissonClient redisson = Redisson.create(config); return redisson; } } Redissonå®ç°äº†jucçš„locké”ï¼Œå¹¶ä¸”å¯ä»¥åœ¨åˆ†å¸ƒå¼çš„redisç¯å¢ƒä¸‹ä½¿ç”¨\næ·»åŠ gmall-redisson-text æŠŠéœ€è¦çš„ä¾èµ–æ·»åŠ çš„pomä¸Š\né…ç½®application.properties\n1 2 3 4 # æœåŠ¡ç«¯å£ server.port=8082 # æ—¥å¿—çº§åˆ« logging.level.root=info RedissonController\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 package com.atguigu.gmallredisson.redissonTest; import com.atguigu.gmall.util.RedisUtil; import org.apache.commons.lang3.StringUtils; import org.redisson.api.RLock; import org.redisson.api.RedissonClient; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.ResponseBody; import redis.clients.jedis.Jedis; @Controller public class RedissonController { @Autowired RedisUtil redisUtil; @Autowired RedissonClient redissonClient; @RequestMapping(\u0026#34;testRedisson\u0026#34;) @ResponseBody public String testRedisson(){ Jedis jedis = redisUtil.getJedis(); RLock lock = redissonClient.getLock(\u0026#34;lock\u0026#34;);// å£°æ˜é” lock.lock();//ä¸Šé” try { String v = jedis.get(\u0026#34;k\u0026#34;); if (StringUtils.isBlank(v)) { v = \u0026#34;1\u0026#34;; } System.out.println(\u0026#34;-\u0026gt;\u0026#34; + v); jedis.set(\u0026#34;k\u0026#34;, (Integer.parseInt(v) + 1) + \u0026#34;\u0026#34;); }finally { jedis.close(); lock.unlock();// è§£é” } return \u0026#34;success\u0026#34;; } } è®¾ç½®éå•ä¾‹æ¨¡å¼å¯åŠ¨ ç‚¹å‡»å–æ¶ˆå•ä¸€ç¤ºä¾‹\nå¯åŠ¨3ä¸ªç¤ºä¾‹ï¼Œç«¯å£åˆ†åˆ«ä¸º8080,8081,8082 é…ç½®nginx ä¸‹è½½å®‰è£…apacheæµ‹è¯•å·¥å…·(apache) 1 ä¸‹è½½åœ°å€ https://www.apachehaus.com/cgi-bin/download.plx\n2 å®‰è£…å³è§£å‹ 3 ä¿®æ”¹apacheæœåŠ¡çš„é…ç½®æ–‡ä»¶(æœåŠ¡å™¨çš„æ ¹ç›®å½•) ä¿®æ”¹æœåŠ¡çš„æ ¹ç›®å½•è·¯å¾„ï¼š\n4 å¯åŠ¨æœåŠ¡ æŸ¥çœ‹443ç«¯å£æ˜¯å¦è¢«å ç”¨\n1 D:\\ap\\Apache24\\bin\u0026gt;netstat -ano | findstr \u0026#34;443\u0026#34; æ²¡æœ‰è¢«å ç”¨ï¼Œå¯åŠ¨httpd.exe\n1 D:\\ap\\Apache24\\bin\u0026gt;httpd.exe 5 å‹æµ‹å‘½ä»¤(å¦èµ·cmdè¾“å…¥å‘½ä»¤) D:\\apache24\\bin\u0026gt;ab -c 200 -n 1000 http:nginxè´Ÿè½½å‡è¡¡/å‹åŠ›æ–¹æ³•\næµ‹è¯•ï¼š\n1 D:\\ap\\Apache24\\bin\u0026gt;ab -c 100 -n 10000 http://www.der-matech.com.cn/ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public String testRedisson(){ Jedis jedis = redisUtil.getJedis(); RLock lock = redissonClient.getLock(\u0026#34;lock\u0026#34;);// å£°æ˜é” lock.lock();//ä¸Šé” try { String v = jedis.get(\u0026#34;k\u0026#34;); if (StringUtils.isBlank(v)) { v = \u0026#34;1\u0026#34;; } System.out.println(\u0026#34;-\u0026gt;\u0026#34; + v); jedis.set(\u0026#34;k\u0026#34;, (Integer.parseInt(v) + 1) + \u0026#34;\u0026#34;); }finally { jedis.close(); lock.unlock();// è§£é” } return \u0026#34;success\u0026#34;; } ","date":"2019-10-31T12:45:14Z","image":"https://www.ownit.top/title_pic/29.jpg","permalink":"https://www.ownit.top/p/201910311245/","title":"Redsiç¼“å­˜é—®é¢˜ï¼ˆç©¿é€ï¼Œå‡»ç©¿ï¼Œé›ªå´©ï¼‰ä»¥åŠè§£å†³åŠæ³•ï¼ˆåˆ†å¸ƒå¼é”ï¼‰ã€é«˜å¹¶å‘é—®é¢˜ã€‘"},{"content":"ç›®å½•\nRedisç¼“å­˜\nä½¿ç”¨ç¼“å­˜Redisè§£å†³é¦–é¡µå¹¶å‘é—®é¢˜\n1ã€ç¼“å­˜ä½¿ç”¨çš„ç®€å•è®¾è®¡\n2ã€Redisçš„æ•´åˆæ­¥éª¤\nA å°†Redisæ•´åˆåˆ°é¡¹ç›®ä¸­ï¼ˆRedis+Springï¼‰\nB è®¾è®¡ä¸€ä¸ªæ•°æ®å­˜å‚¨ç­–è¶Š\n3ã€Redisçš„æ•´åˆè¿‡ç¨‹\n1ã€å¼•å…¥pomä¾èµ–ä¿¡æ¯ï¼ˆå°†æœ¬å·¥ç¨‹æ‰€æœ‰çš„Redisç»Ÿä¸€æ”¾å…¥service-utilé‡Œï¼‰\n2ã€å†™ä¸€ä¸ªRedisçš„å·¥å…·ç±»ï¼ˆç”¨æ¥å°†Redisçš„æ± åˆå§‹åŒ–åˆ°springå®¹å™¨ï¼‰\n3ã€å†™ä¸€ä¸ªspringæ•´åˆRedisçš„é…ç½®ç±»\n4ã€æ¯éš”å¼•ç”¨å·¥ç¨‹å¼•å…¥service-utilåï¼Œå•ç‹¬é…ç½®åªèƒ½çš„redisçš„é…ç½®æ–‡ä»¶\nä»£ç \næŸ¥è¯¢ç»“æœ\næŸ¥çœ‹Redisæ•°æ®åº“çš„æ•°æ®\nRedisç¼“å­˜ é‡ç‚¹è¦è®²çš„æ˜¯å¦å¤–ä¸€ä¸ªå±‚é¢ï¼šå°½é‡é¿å…ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ã€‚\nè§£å†³åŠæ³•å°±æ˜¯ï¼šç¼“å­˜\nç¼“å­˜å¯ä»¥ç†è§£æ˜¯æ•°æ®åº“çš„ä¸€é“ä¿æŠ¤ä¼ï¼Œä»»ä½•è¯·æ±‚åªè¦èƒ½åœ¨ç¼“å­˜ä¸­å‘½ä¸­ï¼Œéƒ½ä¸ä¼šç›´æ¥è®¿é—®æ•°æ®åº“ã€‚è€Œç¼“å­˜çš„å¤„ç†æ€§èƒ½æ˜¯æ•°æ®åº“10-100å€ã€‚\nä½¿ç”¨ç¼“å­˜Redisè§£å†³é¦–é¡µå¹¶å‘é—®é¢˜ ç”¨æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚åˆ°redis å¦‚æœredisæ²¡æœ‰æ•°æ®ï¼Œredisä¼šè¯·æ±‚mysql mysqlä¼šæŠŠæ•°æ®è¿”å›ç»™ç”¨æˆ·ï¼ŒåŒæ—¶ä¼šä¼ åˆ°redisä¸Š ç¬¬äºŒæ¬¡ç”¨æˆ·è®¿é—®æ—¶ï¼Œredisæœ‰æ•°æ®ï¼Œå°±ä¸éœ€è¦è®¿é—®mysqlã€‚èŠ‚çœæ—¶é—´ï¼Œé™ä½æ¶ˆè€— 1ã€ç¼“å­˜ä½¿ç”¨çš„ç®€å•è®¾è®¡ è¿æ¥ç¼“å­˜ æŸ¥è¯¢ç¼“å­˜ å¦‚æœç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥è¯¢mysql mysqlæŸ¥è¯¢ç»“æœå­˜å…¥redis 2ã€Redisçš„æ•´åˆæ­¥éª¤ A å°†Redisæ•´åˆåˆ°é¡¹ç›®ä¸­ï¼ˆRedis+Springï¼‰ B è®¾è®¡ä¸€ä¸ªæ•°æ®å­˜å‚¨ç­–è¶Š ä¼ä¸šä¸­çš„å­˜å‚¨ç­–è¶Šï¼ˆæ ¸å¿ƒæ˜¯ï¼šå¦‚ä½•è®¾è®¡kï¼‰\næ•°æ®å¯¹è±¡åï¼šæ•°æ®å¯¹è±¡idï¼šå¯¹è±¡å±æ€§\nUser:123:password ç”¨æˆ·IDä¸º123çš„å¯†ç \nUser:123:userename ç”¨æˆ·IDä¸º123çš„åå­—\n3ã€Redisçš„æ•´åˆè¿‡ç¨‹ 1ã€å¼•å…¥pomä¾èµ–ä¿¡æ¯ï¼ˆå°†æœ¬å·¥ç¨‹æ‰€æœ‰çš„Redisç»Ÿä¸€æ”¾å…¥service-utilé‡Œï¼‰ 1 2 3 4 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;redis.clients\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jedis\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; åˆ›å»ºä¸¤ä¸ªç±»RedisConfigå’ŒRedisUtil\nRedisConfigè´Ÿè´£åœ¨springå®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å…¥ï¼Œè€ŒRedisUtilå°±æ˜¯è¢«æ³¨å…¥çš„å·¥å…·ç±»ä»¥ä¾›å…¶ä»–æ¨¡å—è°ƒç”¨ã€‚\n2ã€å†™ä¸€ä¸ªRedisçš„å·¥å…·ç±»ï¼ˆç”¨æ¥å°†Redisçš„æ± åˆå§‹åŒ–åˆ°springå®¹å™¨ï¼‰ RedisUtil\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class RedisUtil { private JedisPool jedisPool; public void initPool(String host,int port ,int database){ JedisPoolConfig poolConfig = new JedisPoolConfig(); poolConfig.setMaxTotal(200); poolConfig.setMaxIdle(30); poolConfig.setBlockWhenExhausted(true); poolConfig.setMaxWaitMillis(10*1000); poolConfig.setTestOnBorrow(true); jedisPool=new JedisPool(poolConfig,host,port,20*1000); } public Jedis getJedis(){ Jedis jedis = jedisPool.getResource(); return jedis; } } 3ã€å†™ä¸€ä¸ªspringæ•´åˆRedisçš„é…ç½®ç±» å°†Redisçš„é“¾æ¥æ± åˆ›å»ºåˆ°springçš„å®¹å™¨ä¸­\nRedisConfig\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 @Configuration public class RedisConfig { //è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„redisçš„ipåœ°å€ @Value(\u0026#34;${spring.redis.host:disabled}\u0026#34;) private String host; @Value(\u0026#34;${spring.redis.port:0}\u0026#34;) private int port; @Value(\u0026#34;${spring.redis.database:0}\u0026#34;) private int database; @Bean public RedisUtil getRedisUtil(){ if(host.equals(\u0026#34;disabled\u0026#34;)){ return null; } RedisUtil redisUtil=new RedisUtil(); redisUtil.initPool(host,port,database); return redisUtil; } } 4ã€æ¯éš”å¼•ç”¨å·¥ç¨‹å¼•å…¥service-utilåï¼Œå•ç‹¬é…ç½®åªèƒ½çš„redisçš„é…ç½®æ–‡ä»¶ Service-utilçš„é…ç½®æ–‡ä»¶æ²¡æœ‰ä½œç”¨\nåŒæ—¶ï¼Œä»»ä½•æ¨¡å—æƒ³è¦è°ƒç”¨rediséƒ½å¿…é¡»åœ¨application.propertiesé…ç½®ï¼Œå¦åˆ™ä¸ä¼šè¿›è¡Œæ³¨å…¥\n1 2 3 4 5 6 7 #Redisé…ç½® //è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„redisçš„ipåœ°å€ spring.redis.host=192.168.1.111 #Redisç«¯å£å· spring.redis.port=6379 #æ•°æ®åº“ spring.redis.database=0 ä»£ç  è¿™æ˜¯ä»æ•°æ®åº“è°ƒç”¨mysqlï¼ŒæŸ¥è¯¢æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 /** * ä»æ•°æ®åº“è°ƒç”¨ * * @param skuId * @return */ public PmsSkuInfo getSkuByIdFromDb(String skuId) { //skuçš„å•†å“å¯¹è±¡ PmsSkuInfo pmsSkuInfo = new PmsSkuInfo(); pmsSkuInfo.setId(skuId); PmsSkuInfo skuInfo = pmsSkuInfoMapper.selectOne(pmsSkuInfo); try { //skuçš„å›¾ç‰‡é›†åˆ PmsSkuImage pmsSkuImage = new PmsSkuImage(); List\u0026lt;PmsSkuImage\u0026gt; pmsSkuImages = pmsSkuImageMapper.select(pmsSkuImage); skuInfo.setSkuImageList(pmsSkuImages); } catch (Exception e) { e.printStackTrace(); } return skuInfo; } è¿™ä¸ªæ˜¯Redisçš„ä»£ç ï¼Œåˆ¤æ–­redisä¸­æ˜¯å¦æœ‰æ•°æ®ï¼Œ\nå¦‚æœæ²¡æœ‰ï¼Œå°±è°ƒç”¨ä¸Šé¢çš„ä»£ç ï¼ŒæŸ¥è¯¢mysqlæ•°æ®åº“ã€‚è¿”å›ç»“æœï¼Œåœ¨å†™å…¥redisæ•°æ®åº“ä¸­ã€‚\nå¦‚æœæœ‰ï¼Œç›´æ¥è°ƒç”¨redisæ•°æ®åº“ä¸­çš„æ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 /** * å•†å“è¯¦ç»†å›¾ * ä¸»è¦æ˜¯itemå‰ç«¯çš„ä¸œè¥¿ï¼Œè°ƒç”¨æ­¤å¤„çš„æœåŠ¡ï¼Œæ–¹ä¾¿ * ä½¿ç”¨Redisç¼“å­˜ï¼Œè§£å†³é«˜å¹¶å‘ * * @param skuId * @return */ @Override public PmsSkuInfo getSkuById(String skuId) { PmsSkuInfo pmsSkuInfo = new PmsSkuInfo(); //é“¾æ¥ç¼“å­˜ Jedis jedis = redisUtil.getJedis(); //æŸ¥è¯¢ç¼“å­˜ String skuKey = \u0026#34;sky:\u0026#34; + skuId + \u0026#34;:info\u0026#34;; String skuJson = jedis.get(\u0026#34;skuKey\u0026#34;); //å¯ä»¥å§jsonçš„å­—ç¬¦ä¸²è½¬æ¢æˆjavçš„å¯¹è±¡ç±» if (StringUtils.isNotBlank(skuJson)) {// if (skuJson!=null\u0026amp;\u0026amp;!skuJson.equals(\u0026#34;\u0026#34;)) pmsSkuInfo = JSON.parseObject(skuJson, PmsSkuInfo.class); } else { //å¦‚æœç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥è¯¢mysql pmsSkuInfo = getSkuByIdFromDb(skuId); if (pmsSkuInfo != null) { //mysqlæŸ¥è¯¢ç»“æœå­˜å…¥redis jedis.set(\u0026#34;sku\u0026#34; + skuId + \u0026#34;:info\u0026#34;, JSON.toJSONString(pmsSkuInfo)); } } jedis.close(); return pmsSkuInfo; } æŸ¥è¯¢ç»“æœ æŸ¥çœ‹Redisæ•°æ®åº“çš„æ•°æ® ","date":"2019-10-28T10:10:11Z","image":"https://www.ownit.top/title_pic/14.jpg","permalink":"https://www.ownit.top/p/201910281010/","title":"Redisç¼“å­˜å®æˆ˜æ•™ç¨‹"},{"content":"ç›®å½•\nRediså®‰è£…æ•™ç¨‹\nredisä»‹ç»\nredisçš„åº”ç”¨åœºæ™¯â€ƒyumå®‰è£…redis\nå®‰è£…\nå®‰è£…å®Œæ¯•åï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨redisæœåŠ¡\nè¿›å…¥redisæœåŠ¡\nä¿®æ”¹redisé»˜è®¤ç«¯å£å’Œå¯†ç \næŸ¥çœ‹Redisè¿›ç¨‹\né‡å¯redisæœåŠ¡å™¨\nç™»å½•RedisæœåŠ¡å™¨\nè¯­æ³•\nè¯­æ³•\nRediså®‰è£…æ•™ç¨‹ redisä»‹ç» redisæ˜¯ç”¨Cè¯­è¨€å¼€å‘çš„ä¸€ä¸ªå¼€æºçš„é«˜æ€§èƒ½é”®å€¼å¯¹ï¼ˆkey-valueï¼‰æ•°æ®åº“ã€‚å®ƒé€šè¿‡æä¾›å¤šç§é”®å€¼æ•°æ®ç±»å‹æ¥é€‚åº”ä¸åŒåœºæ™¯ä¸‹çš„å­˜å‚¨éœ€æ±‚ï¼Œç›®å‰ä¸ºæ­¢redisæ”¯æŒçš„é”®å€¼æ•°æ®ç±»å‹å¦‚ä¸‹å­—ç¬¦ä¸²ã€åˆ—è¡¨ï¼ˆlistsï¼‰ã€é›†åˆï¼ˆsetsï¼‰ã€æœ‰åºé›†åˆï¼ˆsorts setsï¼‰ã€å“ˆå¸Œè¡¨ï¼ˆhashsï¼‰\nredisçš„åº”ç”¨åœºæ™¯â€ƒç¼“å­˜ï¼ˆæ•°æ®æŸ¥è¯¢ã€çŸ­è¿æ¥ã€æ–°é—»å†…å®¹ã€å•†å“å†…å®¹ç­‰ç­‰ï¼‰ã€‚ï¼ˆæœ€å¤šä½¿ç”¨ï¼‰ åˆ†å¸ƒå¼é›†ç¾¤æ¶æ„ä¸­çš„sessionåˆ†ç¦»ã€‚ èŠå¤©å®¤çš„åœ¨çº¿å¥½å‹åˆ—è¡¨ã€‚ ä»»åŠ¡é˜Ÿåˆ—ã€‚ï¼ˆç§’æ€ã€æŠ¢è´­ã€12306ç­‰ç­‰ï¼‰â€ƒåº”ç”¨æ’è¡Œæ¦œã€‚â€ƒç½‘ç«™è®¿é—®ç»Ÿè®¡ã€‚â€ƒæ•°æ®è¿‡æœŸå¤„ç†ï¼ˆå¯ä»¥ç²¾ç¡®åˆ°æ¯«ç§’ï¼‰ yumå®‰è£…redis å®‰è£… 1 2 3 4 5 6 #æ£€æŸ¥æ˜¯å¦æœ‰redis yum æº yum install redis #ä¸‹è½½fedoraçš„epelä»“åº“ yum install epel-release #å®‰è£…redisæ•°æ®åº“ yum install redis å®‰è£…å®Œæ¯•åï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨redisæœåŠ¡ 1 2 3 4 5 6 7 8 # å¯åŠ¨redis service redis start # åœæ­¢redis service redis stop # æŸ¥çœ‹redisè¿è¡ŒçŠ¶æ€ service redis status # æŸ¥çœ‹redisè¿›ç¨‹ ps -ef | grep redis è¿›å…¥redisæœåŠ¡ 1 2 3 4 # è¿›å…¥æœ¬æœºredis redis-cli # åˆ—å‡ºæ‰€æœ‰key keys * ä¿®æ”¹redisé»˜è®¤ç«¯å£å’Œå¯†ç  1ã€æ‰“å¼€é…ç½®æ–‡ä»¶\n1 vi /etc/redis.conf 2ã€ä¿®æ”¹é»˜è®¤ç«¯å£ï¼ŒæŸ¥æ‰¾ port 6379 ä¿®æ”¹ä¸ºç›¸åº”ç«¯å£å³å¯\n3ã€ä¿®æ”¹é»˜è®¤å¯†ç ï¼ŒæŸ¥æ‰¾ requirepass foobared å°† foobared ä¿®æ”¹ä¸ºä½ çš„å¯†ç \n4ã€ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨ redis\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # æŸ¥æ‰¾Redisé…ç½®ï¼ˆæ³¨æ„ä¸æ˜¯å®‰è£…ç›®å½•ä¸‹çš„redis.confï¼‰ # æ‰“å¼€ç¬¬äº”æ­¥è®¾è®¡çš„Redisé…ç½®ï¼Œé»˜è®¤ä¸ºï¼š/etc/redis/6379.conf # ä¿®æ”¹é…ç½®æ–‡ä»¶å¦‚ä¸‹å‡ é¡¹ï¼Œå…¶å®ƒä¿æŒä¸å˜ daemonize yes #bind 127.0.0.1 ï¼ˆæ³¨é‡Šï¼Œä¸é™åˆ¶IPï¼‰ protected-mode no å°† requirepass foobaredå‰çš„â€œ#â€å»æ‰ï¼Œå¯†ç æ”¹ä¸ºä½ æƒ³è¦è®¾ç½®çš„å¯†ç ï¼ˆæˆ‘è®¾ç½®ä¸º123456ï¼‰ # é‡å¯æœåŠ¡ [root@172 redis-3.2.11]# service redis_6379 restart Stopping ... Redis stopped Starting Redis server... # å¼€æ”¾6379ç«¯å£ firewall-cmd --zone=public --add-port=6379/tcp --permanent # é‡å¯é˜²ç«å¢™ï¼Œå¦åˆ™å¼€æ”¾ç«¯å£ä¸èµ·ä½œç”¨ firewall-cmd --reload æŸ¥çœ‹Redisè¿›ç¨‹ 1 ps -ef|grep redis é‡å¯redisæœåŠ¡å™¨ 1 systemctl restart redis ç™»å½•RedisæœåŠ¡å™¨ Redis å‘½ä»¤ç”¨äºåœ¨ redis æœåŠ¡ä¸Šæ‰§è¡Œæ“ä½œã€‚\nè¦åœ¨ redis æœåŠ¡ä¸Šæ‰§è¡Œå‘½ä»¤éœ€è¦ä¸€ä¸ª redis å®¢æˆ·ç«¯ã€‚Redis å®¢æˆ·ç«¯åœ¨æˆ‘ä»¬ä¹‹å‰ä¸‹è½½çš„çš„ redis çš„å®‰è£…åŒ…ä¸­ã€‚\nè¯­æ³• Redis å®¢æˆ·ç«¯çš„åŸºæœ¬è¯­æ³•ä¸ºï¼š\n1 $ redis-cli æœ¬åœ°ç™»å½•\n1 redis-cli å¦‚æœéœ€è¦åœ¨è¿œç¨‹ redis æœåŠ¡ä¸Šæ‰§è¡Œå‘½ä»¤ï¼ŒåŒæ ·æˆ‘ä»¬ä½¿ç”¨çš„ä¹Ÿæ˜¯Â redis-cliÂ å‘½ä»¤ã€‚\nè¯­æ³• 1 $ redis-cli -h host -p port -a password è¿œç¨‹ç™»å½•\n1 2 3 redis-cli -h 192.168.116.129 -p 6379 192.168.116.129:6379\u0026gt; keys * 1) \u0026#34;hello\u0026#34; ","date":"2019-10-26T17:38:01Z","image":"https://www.ownit.top/title_pic/63.jpg","permalink":"https://www.ownit.top/p/201910261738/","title":"Rediså®‰è£…æ•™ç¨‹"},{"content":"ç›®å½•\nå®‰è£…æ­¥éª¤\n1ã€æŸ¥çœ‹Dockerçš„ç‰ˆæœ¬\nâ€‹\n2ã€å®‰è£… Docker\n3ã€å¯åŠ¨Docker\n4ã€è®¾ç½®ä¸ºå¼€å¯å¯åŠ¨\n5ã€æŸ¥çœ‹Dockerå®‰è£…ä¿¡æ¯\n6ã€ä½¿ç”¨Docker ä¸­å›½åŠ é€Ÿå™¨\nå®‰è£…æ­¥éª¤ å®‰è£…æ“ä½œç³»ç»Ÿï¼Œæœ€å°åŒ–å®‰è£…ï¼ˆminiï¼‰\nç¦ç”¨Selinux, ä¿®æ”¹/etc/selinux/config æ–‡ä»¶ï¼Œå°†SELINUX=enforcingæ”¹ä¸ºSELINUX=disabledï¼Œé‡å¯æœºå™¨å³å¯\n1ã€æŸ¥çœ‹Dockerçš„ç‰ˆæœ¬ 1 [root@wei ~]# yum list docker 2ã€å®‰è£… Docker 1 [root@wei ~]# yum install -y docker 3ã€å¯åŠ¨Docker 1 [root@wei ~]# systemctl start docker 4ã€è®¾ç½®ä¸ºå¼€å¯å¯åŠ¨ 1 [root@wei ~]# systemctl enable docker 5ã€æŸ¥çœ‹Dockerå®‰è£…ä¿¡æ¯ 1 [root@wei ~]# docker version 6ã€ä½¿ç”¨Docker ä¸­å›½åŠ é€Ÿå™¨ ç”±äºç½‘ç»œåŸå› ï¼Œæˆ‘ä»¬åœ¨pull Image çš„æ—¶å€™ï¼Œä»Docker Hubä¸Šä¸‹è½½ä¼šå¾ˆæ…¢ã€‚\nä¿®æ”¹æ–‡ä»¶\n1 2 3 4 5 6 vi /etc/docker/daemon.json #æ·»åŠ åï¼š { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;https://registry.docker-cn.com\u0026#34;], \u0026#34;live-restore\u0026#34;: true } é‡èµ·dockeræœåŠ¡\n1 systemctl restart docker ","date":"2019-10-26T09:50:55Z","image":"https://www.ownit.top/title_pic/29.jpg","permalink":"https://www.ownit.top/p/201910260950/","title":"CentOS 7ä¸Šå®‰è£…Docker"},{"content":"ç›®å½•\nDockerä»‹ç»\nDockerä¼˜ç‚¹\nè™šæ‹Ÿæœºç¼ºç‚¹\nå®¹å™¨å’Œè™šæ‹Ÿæœº\nDockeräº§ç”Ÿçš„ç›®çš„å°±æ˜¯è§£å†³ä»¥ä¸‹é—®é¢˜\nDockerçš„ç”¨é€”\nDockeré•œåƒ\nDockerå®¹å™¨\nä»“åº“\nDockerä»‹ç» Docker æ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼Œè®©å¼€å‘è€…å¯ä»¥æ‰“åŒ…ä»–ä»¬çš„åº”ç”¨ä»¥åŠä¾èµ–åŒ…åˆ°ä¸€ä¸ªå¯ç§»æ¤çš„é•œåƒä¸­ï¼Œç„¶åå‘å¸ƒåˆ°ä»»ä½•æµè¡Œçš„ Linuxæˆ–Windows æœºå™¨ä¸Šï¼Œä¹Ÿå¯ä»¥å®ç°è™šæ‹ŸåŒ–ã€‚å®¹å™¨æ˜¯å®Œå…¨ä½¿ç”¨æ²™ç®±æœºåˆ¶ï¼Œç›¸äº’ä¹‹é—´ä¸ä¼šæœ‰ä»»ä½•æ¥å£ã€‚\nDockerä¼˜ç‚¹ çµæ´»ï¼šå³ä½¿æ˜¯å¤æ‚çš„åº”ç”¨ç¨‹åºä¹Ÿå¯å°è£…ã€‚ è½»é‡çº§ï¼šå®¹å™¨åˆ©ç”¨å¹¶å…±äº«ä¸»æœºå†…æ ¸ã€‚ ä¾¿æºå¼ï¼šæ‚¨å¯ä»¥åœ¨æœ¬åœ°æ„å»ºï¼Œéƒ¨ç½²åˆ°äº‘ä¸Šå¹¶åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œã€‚ å¯æ‰©å±•æ€§ï¼šæ‚¨å¯ä»¥å¢åŠ å’Œè‡ªåŠ¨åˆ†å‘å®¹å™¨å‰¯æœ¬ã€‚ å¯å †å ï¼šæ‚¨å¯ä»¥å‚ç›´å †å æœåŠ¡å¹¶åŠæ—¶å¹¶åŠæ—¶å †å æœåŠ¡ã€‚ è™šæ‹Ÿæœºç¼ºç‚¹ **èµ„æºå ç”¨å¤šï¼š**è™šæ‹Ÿæœºä¼šç‹¬å ä¸€éƒ¨åˆ†å†…å­˜å’Œç¡¬ç›˜ç©ºé—´ã€‚å®ƒè¿è¡Œçš„æ—¶å€™ï¼Œå…¶ä»–ç¨‹åºå°±ä¸èƒ½ä½¿ç”¨è¿™äº›èµ„æºäº†ã€‚å“ªæ€•è™šæ‹Ÿæœºé‡Œé¢çš„åº”ç”¨ç¨‹åºï¼ŒçœŸæ­£ä½¿ç”¨çš„å†…å­˜åªæœ‰1Mï¼Œè™šæ‹Ÿæœºä¾ç„¶éœ€è¦å‡ ç™¾MBçš„å†…å®¹æ‰èƒ½è¿è¡Œã€‚ **å†—ä½™æ­¥éª¤å¤šï¼š**è™šæ‹Ÿæœºæ˜¯å®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œä¸€äº›ç³»ç»Ÿçº§åˆ«çš„æ“ä½œæ­¥éª¤ï¼Œå¾€å¾€æ— æ³•è·³è¿‡ï¼Œæ¯”å¦‚ç”¨æˆ·ç™»å½•ã€‚ **å¯åŠ¨æ…¢ï¼š**å¯åŠ¨æ“ä½œç³»ç»Ÿéœ€è¦å¤šä¹…ï¼Œå¯åŠ¨è™šæ‹Ÿæœºå°±éœ€è¦å¤šä¹…ã€‚å¯èƒ½è¦ç­‰å‡ åˆ†é’Ÿï¼Œåº”ç”¨é™ˆæ•…ä¹¡æ‰èƒ½çœŸæ­£è¿è¡Œã€‚ å®¹å™¨å’Œè™šæ‹Ÿæœº ä¸€ä¸ªå®¹å™¨ä¸­è¿è¡ŒåŸç”ŸLinuxå’Œå…±äº«ä¸»æœºä¸å…¶å®ƒå®¹å™¨çš„å†…æ ¸ï¼Œå®ƒè¿è¡Œä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä¸å ç”¨ä»»ä½•å…¶å®ƒå¯æ‰§è¡Œæ–‡ä»¶çš„å†…å­˜ï¼Œä½¿å…¶è½»é‡åŒ–ã€‚\nç›¸æ¯”ä¹‹ä¸‹ï¼Œè™šæ‹Ÿæœº(VM)è¿è¡Œä¸€ä¸ªå®Œæ•´çš„â€œå®¢æˆ·â€æ“ä½œç³»ç»Ÿï¼Œé€šè¿‡è™šæ‹Ÿæœºç®¡ç†ç¨‹åºè™šæ‹Ÿè®¿é—®ä¸»æœºèµ„æºã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè™šæ‹Ÿæœºæä¾›çš„ç¯å¢ƒæ¯”å¤§å¤šæ•°åº”ç”¨ç¨‹åºéœ€è¦çš„èµ„æºå¤š\nDockeräº§ç”Ÿçš„ç›®çš„å°±æ˜¯è§£å†³ä»¥ä¸‹é—®é¢˜ ç¯å¢ƒç®¡ç†å¤æ‚ï¼šä»å„ç§OSåˆ°å„ä¸ªä¸­é—´ä»¶å†åˆ°å„ç§App,ä¸€æ¬¾äº§å“èƒ½å¤ŸæˆåŠŸå‘å¸ƒï¼Œä½œä¸ºå¼€å‘è€…éœ€è¦å…³å¿ƒçš„ä¸œè¥¿å¤ªå¤šï¼Œä¸”éš¾äºç®¡ç†ï¼Œè¿™ä¸ªé—®é¢˜åœ¨è½¯ä»¶å…´ä¸šä¸­æ™®éå­˜åœ¨å¹¶éœ€è¦ç›´æ¥é¢å¯¹ã€‚Dockerå¯ä»¥ç®€åŒ–éƒ¨ç½²å¤šç§åº”ç”¨å®ä¾‹å·¥ä½œï¼Œæ¯”å¦‚Webåº”ç”¨ã€åå°åº”ç”¨ã€æ•°æ®åº“åº”ç”¨ã€å¤§æ•°æ®åº”ç”¨æ¯”å¦‚Hadoopé›†ç¾¤ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰éƒ½å¯ä»¥æ‰“åŒ…æˆä¸€ä¸ªimageéƒ¨ç½²ã€‚ äº‘æ—¶ä»£çš„åˆ°æ¥ï¼šAWSçš„æˆåŠŸï¼Œå¼•åˆ°å¼€å‘è€…å°†åº”ç”¨è½¬ç§»åˆ°äº‘ä¸Šï¼Œè§£å†³æ¥ç¡¬ä»¶ç®¡ç†çš„é—®é¢˜ï¼Œç„¶è€Œè½¯ä»¶é…ç½®å’Œç®¡ç†é¦™ç“œçš„é—®é¢˜ä¾ç„¶å­˜åœ¨ã€‚Dockerçš„å‡ºç°æ­£å¥½èƒ½å¸®åŠ©è½¯ä»¶å¼€å‘ç€å¼€é˜”æ€è·¯ï¼Œå°è¯•æ–°çš„è½¯ä»¶ç®¡ç†çš„æ–¹æ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ è™šæ‹ŸåŒ–æ‰‹æ®µçš„å˜åŒ–ï¼šäº‘æ—¶ä»£é‡‡ç”¨æ ‡é…ç¡¬ä»¶æ¥é™ä½æˆæœ¬ï¼Œé‡‡ç”¨è™šæ‹ŸåŒ–æ‰‹æ®µæ¥æ»¡è¶³ç”¨æˆ·æŒ‰éœ€åˆ†é…çš„èµ„æºéœ€æ±‚ä»¥åŠä¿è¯å¯ç”¨æ€§å’Œéš”ç¦»æ€§ã€‚ç„¶è€Œæ— è®ºæ˜¯KVMè¿˜æ˜¯Xenï¼Œåœ¨Dockerçœ‹æ¥éƒ½æ˜¯åœ¨æµªè´¹èµ„æºï¼Œåˆéš¾äºç®¡ç†ï¼Œæ›´åŠ è½»é‡çº§å¤§LXCæ›´åŠ çµæ´»å’Œå¿«é€Ÿï¼š LXCçš„ä¾¿æºæ€§ï¼šLXCåœ¨Linux 2.6çš„Kernelé‡Œå°±å·²ç»å­˜åœ¨äº†ï¼Œä½†æ˜¯å…¶è®¾è®¡ä¹‹åˆå¹¶éä¸ºäº‘è®¡ç®—è€ƒè™‘ï¼Œç¼ºå°‘æ ‡å‡†åŒ–çš„æè¿°æ‰‹æ®µå’Œå®¹å™¨çš„å¯ä¾¿æºæ€§ï¼Œå†³å®šå…¶æ„å»ºå‡ºçš„ç¯å¢ƒéš¾äºåˆ†å‘å’Œæ ‡å‡†åŒ–ç®¡ç†(ç›¸å¯¹äºKVMä¹‹ç±»çš„imageå’Œsanpshotçš„æ¦‚å¿µ)ã€‚Dockerå°±åœ¨è¿™ä¸ªé—®é¢˜ä¸Šä½œå‡ºäº†å®è´¨æ€§çš„åˆ›æ–°æ–¹æ³•ã€‚ Dockerçš„ç”¨é€” Dockerçš„ä¸»è¦ç”¨é€”ï¼Œç›®å‰åˆä¸‰å¤§ç±»ï¼š\n**æä¾›äº†ä¸€æ¬¡æ€§çš„ç¯å¢ƒï¼š**æ¯”å¦‚ï¼Œæœ¬åœ°æµ‹è¯•ä»–äººçš„è½¯ä»¶ã€æŒç»­é›†æˆçš„æ—¶å€™æä¾›å•å…ƒæµ‹è¯•å’Œæ„å»ºçš„ç¯å¢ƒã€‚ **æä¾›å¼¹æ€§çš„äº‘æœåŠ¡ï¼š**å› ä¸ºDockerå®¹å™¨å¯ä»¥éšå¼€éšå…³ï¼Œå¾ˆé€‚åˆåŠ¨æ€æ‰©å®¹å’Œæ‰€å®¹ã€‚ **ç»„å»ºå¾®æœåŠ¡æ¶æ„ï¼š**é€šè¿‡å¤šä¸ªå®¹å™¨ï¼Œä¸€å°æœºå™¨å¯ä»¥è·‘å¤šä¸ªæœåŠ¡ï¼Œå› æ­¤åœ¨æœ¬æœºå°±å¯ä»¥æ¨¡æ‹Ÿå‡ºå¾®æœåŠ¡æ¶æ„ã€‚ Dockeré•œåƒ æ“ä½œç³»ç»Ÿåˆ†ä¸ºå†…æ ¸å’Œç”¨æˆ·ç©ºé—´ï¼Œå¯¹äºLinuxè€Œè¨€ï¼Œå†…æ ¸å¯åŠ¨åï¼Œä¼šæŒ‚è½½rootæ–‡ä»¶ç³»ç»Ÿä¸ºå…¶æä¾›ç”¨æˆ·ç©ºé—´æ”¯æŒã€‚è€ŒDockeré•œåƒ(Image),å°±ç›¸å½“äºæ˜¯ä¸€ä¸ªrootæ–‡ä»¶ç³»ç»Ÿã€‚ Dockeré•œåƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿï¼Œé™¤äº†æä¾›å®¹å™¨è¿è¡Œæ—¶æ‰€éœ€çš„ç¨‹åºã€åº“ã€èµ„æºã€é…ç½®ç­‰æ–‡ä»¶å¤–ï¼Œè¿˜åŒ…å«äº†ä¸€äº›ä¸ºè¿è¡Œæ—¶å‡†å¤‡çš„ä¸€äº›é…ç½®å‚æ•°(å¦‚åŒ¿åå·ã€ç¯å¢ƒå˜é‡ã€ç”¨æˆ·ç­‰)ã€‚é•œåƒä¸åŒ…å«ä»»ä½•åŠ¨æ€æ•°æ®ï¼Œå…¶å†…å®¹åœ¨æ„å»ºä¹‹åä¹Ÿä¸ä¼šè¢«æ”¹å˜ã€‚\nDockerå®¹å™¨ é•œåƒ(image)å’Œå®¹å™¨(container)çš„å…³ç³»ï¼Œå°±åƒæ˜¯é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ä¸­çš„ç±»å’Œå®ä¾‹ä¸€æ ·ï¼Œé•œåƒæ˜¯é™æ€çš„å®šä¹‰ï¼Œå®¹å™¨æ˜¯é•œåƒè¿è¡Œæ—¶çš„å®ä½“ã€‚å®¹å™¨å¯ä»¥è¢«åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤ã€æš‚åœç­‰ã€‚\nå®¹å™¨çš„å®è´¨æ˜¯è¿›ç¨‹ï¼Œä½†ä¸ç›´æ¥åœ¨å®¿ä¸»æ‰§è¡Œçš„è¿›ç¨‹ä¸åŒï¼Œå®¹å™¨è¿›ç¨‹è¿è¡Œäºå±äºè‡ªå·±çš„ç‹¬ç«‹çš„å‘½åç©ºé—´ã€‚å› æ­¤å®¹å™¨å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„rootæ–‡ä»¶ç³»ç»Ÿã€è‡ªå·±çš„ç½‘ç»œé…ç½®ã€è‡ªå·±çš„è¿›ç¨‹ç©ºé—´ï¼Œç”šè‡³è‡ªå·±çš„ç”¨æˆ·IDç©ºé—´ã€‚å®¹å™¨å†…çš„è¿›ç¨‹æ˜¯è¿è¡Œåœ¨ä¸€ä¸ªéš”ç¦»çš„ç¯å¢ƒé‡Œï¼Œä½¿ç”¨èµ·æ¥ï¼Œå°±å¥½åƒæ˜¯åœ¨ä¸€ä¸ªç‹¬ç«‹å®¿ä¸»çš„ç³»ç»Ÿä¸‹æ“ä½œä¸€æ ·ã€‚è¿™ç§ç‰¹æ€§ä½¿å®¹å™¨å°è£…çš„åº”ç”¨æ¯”ç›´æ¥åœ¨å®¿ä¸»è¿è¡Œæ›´åŠ å®‰å…¨ã€‚\nå‰é¢è®²è¿‡é•œåƒä½¿ç”¨çš„æ˜¯åˆ†å±‚å‚¨å­˜ï¼Œå®¹å™¨ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æ¯ä¸€ä¸ªå®¹å™¨è¿è¡Œæ—¶ï¼Œæ˜¯ä»¥é•œåƒä¸ºåŸºç¡€å±‚ï¼Œåœ¨å…¶ä¸Šåˆ›å»ºä¸€ä¸ªå½“å‰å®¹å™¨çš„å­˜å‚¨å±‚ï¼Œå¯ä»¥ç§°è¿™ä¸ªå‘³å®¹å™¨è¿è¡Œæ—¶è¯»å†™è€Œå‡†å¤‡çš„å­˜å‚¨å±‚ä¸ºå®¹å™¨å­˜å‚¨å±‚ã€‚\nå®¹å™¨å­˜å‚¨å±‚çš„ç”Ÿå­˜å‘¨æœŸå’Œå®¹å™¨ä¸€æ ·ï¼Œå®¹å™¨æ¶ˆäº¡æ—¶ï¼Œå®¹å™¨å­˜å‚¨å±‚ä¹Ÿéšä¹‹æ¶ˆäº¡ã€‚å› æ­¤ï¼Œä»»ä½•ä¿å­˜äºå®¹å™¨å­˜å‚¨å±‚çš„ä¿¡æ¯éƒ½ä¼šéšå®¹å™¨åˆ é™¤è€Œä¸¢å¤±ã€‚\næŒ‰ç…§Dockeræœ€ä½³å®è·µçš„è¦æ±‚ï¼Œå®¹å™¨ä¸åº”è¯¥å‘å…¶å­˜å‚¨å±‚å†™å…¥ä»»ä½•æ•°æ®ï¼Œå®¹å™¨å­˜å‚¨å±‚è¦ä¿æŒæ— çŠ¶æ€åŒ–ã€‚æ‰€æœ‰çš„æ–‡ä»¶å†™å…¥æ“ä½œï¼Œéƒ½åº”è¯¥ä½¿ç”¨æ•°æ®å·(volume)ã€æˆ–è€…ç»‘å®šå®¿ä¸»ç›®å½•ï¼Œåœ¨è¿™äº›ä½ç½®çš„è¯»å†™ä¼šè·³è¿‡å­˜å‚¨å±‚ï¼Œç›´æ¥å¯¹å®¿ä¸»(æˆ–ç½‘ç»œå­˜å‚¨)å‘ç”Ÿè¯»å†™ï¼Œå…¶æ€§èƒ½å’Œç¨³å®šæ€§æ›´é«˜ã€‚\næ•°æ®å·çš„ç”Ÿå­˜å‘¨æœŸç‹¬ç«‹äºå®¹å™¨ï¼Œå®¹å™¨æ¶ˆäº¡ï¼Œæ•°æ®å·ä¸ä¼šæ¶ˆäº¡ã€‚å› æ­¤ï¼Œä½¿ç”¨æ•°æ®å·åï¼Œå®¹å™¨åˆ é™¤æˆ–è€…é‡æ–°è¿è¡Œä¹‹åï¼Œæ•°æ®å´ä¸ä¼šä¸¢å¤±ã€‚\nä»“åº“ é•œåƒæ„å»ºå®Œæˆåï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„åœ¨å½“å‰å®¿ä¸»æœºä¸Šè¿è¡Œï¼Œä½†æ˜¯ï¼Œå¦‚æœéœ€è¦åœ¨å…¶å®ƒæœåŠ¡å™¨ä¸Šä½¿ç”¨è¿™ä¸ªé•œåƒï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªé›†ä¸­çš„å­˜å‚¨ã€åˆ†å‘é•œåƒçš„æœåŠ¡ï¼ŒDocker Registryå°±æ˜¯è¿™æ ·çš„æœåŠ¡ã€‚\nä¸€ä¸ªDocker Registryä¸­å¯ä»¥åŒ…å«å¤šä¸ªä»“åº“(Repository);æ¯ä¸ªä»“åº“å¯ä»¥åŒ…å«å¤šä¸ªæ ‡ç­¾(tag)ï¼›æ¯ä¸ªæ ‡ç­¾å¯¹åº”ä¸€ä¸ªé•œåƒã€‚\né€šå¸¸ï¼Œä¸€ä¸ªä»“åº“ä¼šåŒ…å«ä¸€ä¸ªè½¯ä»¶ä¸åŒç‰ˆæœ¬çš„é•œåƒï¼Œè€Œæ ‡ç­¾å°±å¸¸ç”¨äºå¯¹åº”è¯¥è½¯ä»¶çš„å„ä¸ªç‰ˆæœ¬ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡\u0026lt;ä»“åº“å\u0026gt;:\u0026lt;æ ‡ç­¾\u0026gt;çš„æ ¼å¼æ¥æŒ‡å®šå…·ä½“æ˜¯è¿™ä¸ªè½¯ä»¶é‚£ä¸ªç‰ˆæœ¬çš„é•œåƒã€‚å¦‚æœä¸ç»™å‡ºæ ‡ç­¾ï¼Œå°†ä»¥laestä½œä¸ºé»˜è®¤æ ‡ç­¾ã€‚\nä»¥ubuntué•œåƒä¸ºä¾‹ï¼Œubuntuæ˜¯ä»“åº“çš„åå­—ï¼Œå…¶åŒ…å«æœ‰ä¸åŒçš„ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ï¼Œ14.04,16.04ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ubuntu:14.04æˆ–è€…ubuntu:16.04æ¥å…·ä½“æŒ‡å®šæ‰€éœ€è¦å“ªä¸ªç‰ˆæœ¬çš„é•œåƒã€‚å¦‚æœå¿½ç•¥äº†æ ‡ç­¾ï¼Œæ¯”å¦‚ubuntu,é‚£å°†è§†ä¸ºubuntu:latestã€‚\nä»“åº“åç»å¸¸ä»¥ä¸¤æ®µå¼è·¯å¾„å½¢å¼å‡ºç°ï¼Œæ¯”å¦‚jwilder/nginx-proxy,å‰è€…æ„å‘³ç€Docker Registryå¤šç”¨æˆ·ç¯å¢ƒä¸‹çš„ç”¨æˆ·åï¼Œåè€…åˆ™å¾€å¾€æ˜¯å¯¹åº”çš„è½¯ä»¶åã€‚ä½†è¿™å¹¶éç»å¯¹ï¼Œå–å†³äºæ‰€ä½¿ç”¨çš„å…·ä½“Docker Registryçš„è½¯ä»¶æˆ–æœåŠ¡ã€‚Uå’Œå†…å­˜çš„åˆ©ç”¨ç‡ã€‚\nä¼ä¸šçº§ æ–°æµª\nç¾å›¢\nè˜‘è‡è¡—\nå»å“ªä¸‹ 1ã€å®˜ç½‘ dockerå®˜ç½‘ï¼šhttp://www.docker.com\ndockerä¸­æ–‡ç½‘ç«™ï¼šhttps://www.docker-cn.com/\n2ã€ä»“åº“ Docker Hubå®˜ç½‘: https://hub.docker.com/\n","date":"2019-10-26T09:26:28Z","image":"https://www.ownit.top/title_pic/26.jpg","permalink":"https://www.ownit.top/p/201910260926/","title":"Dockerç®€ä»‹"},{"content":"æˆ‘ä»¬éƒ¨ç½²Fastdfsï¼Œå°±æ˜¯ä¸ºäº†å®ç°æ–‡ä»¶çš„ä¸Šä¼ ã€‚ ç°åœ¨ä½¿ç”¨ideaæ•´åˆFastdfsï¼Œå®ç°å›¾ç‰‡ä¸Šä¼  éƒ¨ç½²ç¯å¢ƒï¼šCentos7éƒ¨ç½²åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨(Fastdfs) åˆ©ç”¨Javaå®¢æˆ·ç«¯è°ƒç”¨FastDFS æœåŠ¡å™¨å®‰è£…å®Œæ¯•åï¼Œå’±ä»¬é€šè¿‡Javaè°ƒç”¨fastdfs\nåŠ è½½Maven****ä¾èµ–\nfastdfs æ²¡æœ‰åœ¨ä¸­å¿ƒä»“åº“ä¸­æä¾›è·å–çš„ä¾èµ–åæ ‡ã€‚\nåªèƒ½è‡ªå·±é€šè¿‡æºç æ–¹å¼ç¼–è¯‘ï¼Œæ‰“å¥½jar åŒ…ï¼Œå®‰è£…åˆ°æœ¬åœ°ä»“åº“ã€‚\nå®˜æ–¹ä»“åº“åœ°å€ï¼š\nhttps://github.com/happyfish100/fastdfs-client-java\nç›´æ¥ç”¨idea ç›´æ¥æŠŠè¿™ä¸ªæºç ä½œä¸ºæ¨¡å—å¯¼å…¥å·¥ç¨‹\nåˆ«çš„ä¸ç”¨æ”¹ï¼ŒåªæŠŠpom.xmlä¸­çš„ç‰ˆæœ¬æ”¹æˆ1.27ã€‚\nç„¶åå³è¾¹ æ‰§è¡Œinstall å°±å¥½äº†\nå®‰è£…å¥½äº† ï¼Œåˆ«çš„æ¨¡å—å°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªåæ ‡äº†ã€‚\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.csource\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fastdfs-client-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.27-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; è€Œè¿™ä¸ªfastdfs-client-javaæ¨¡å—å¯ä»¥ä»idea ä¸­åˆ é™¤ã€‚\nç„¶åå¯ä»¥è¿›è¡Œä¸€ä¸‹ä¸Šä¼ çš„æµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package com.atguigu.gmall.manage; import org.csource.common.MyException; import org.csource.fastdfs.ClientGlobal; import org.csource.fastdfs.StorageClient; import org.csource.fastdfs.TrackerClient; import org.csource.fastdfs.TrackerServer; import org.junit.Test; import org.junit.runner.RunWith; import org.springframework.boot.test.context.SpringBootTest; import org.springframework.test.context.junit4.SpringRunner; import java.io.IOException; @RunWith(SpringRunner.class) @SpringBootTest public class GmallManageWebApplicationTests { @Test public void contextLoads() throws IOException, MyException { //é…ç½®fdfsçš„å…¨å±€è¿æ¥åœ°å€ String tracker = GmallManageWebApplicationTests.class.getResource(\u0026#34;/tracker.conf\u0026#34;).getPath();//è·å–é…ç½®æ–‡ä»¶è·¯å¾„ ClientGlobal.init(tracker); TrackerClient trackerClient = new TrackerClient(); //è·å¾—ä¸€ä¸ªtrackerserverçš„å®ä¾‹ TrackerServer trackerServer = trackerClient.getConnection(); //é€šè¿‡trackerè·å¾—storageå®¢æˆ·ç«¯ StorageClient storageClient = new StorageClient(trackerServer, null); String[] uploadInfos = storageClient.upload_file(\u0026#34;g:/9.gif\u0026#34;, \u0026#34;gif\u0026#34;, null); String url=\u0026#34;http://192.168.116.129\u0026#34;; for (String uploadInfo : uploadInfos){ url+=\u0026#34;/\u0026#34;+uploadInfo; } System.out.println(url); } } åŠ å…¥tracker.confæ–‡ä»¶ 1 2 3 4 5 6 7 tracker_server=192.168.67.162:22122 # è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œé’ˆå¯¹socketå¥—æ¥å­—å‡½æ•°connectï¼Œé»˜è®¤ä¸º30ç§’ connect_timeout=30000 # ç½‘ç»œé€šè®¯è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯60ç§’ network_timeout=60000 æ‰“å°ç»“æœ\nè¿™ä¸ªæ‰“å°ç»“æœå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬è®¿é—®çš„è·¯å¾„ï¼ŒåŠ ä¸ŠæœåŠ¡å™¨åœ°å€æˆ‘ä»¬å¯ä»¥æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²\nhttp://192.168.116.129/group1/M00/00/00/wKh0gV2dHmGAFpUzAA7-f54U48M105.gif\nç›´æ¥æ”¾åˆ°æµè§ˆå™¨å»è®¿é—®\n","date":"2019-10-10T15:20:18Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/201910101520/","title":"SpringBootæ•´åˆFastdfsï¼Œå®ç°å›¾ç‰‡ä¸Šä¼ ï¼ˆIDEAï¼‰"},{"content":"\nç›®å½•\nFastDFSä»‹ç»\næ¥¼ä¸»ç›®æ ‡ï¼šå‰å¯H5æ’©å¦¹ï¼Œåå¯Linuxæè¿ç»´\nç¯å¢ƒï¼šCentos7\nè½¯ä»¶ï¼š\nè½¯ä»¶é“¾æ¥ï¼š\nå®‰è£…å‰æ‰€æœ‰å‡†å¤‡ï¼Œä¸Šä¼ è½¯ä»¶åˆ°Centos7ä¸Šçš„/optçš„ç›®å½•ä¸‹\nå®‰è£…ä¾èµ–è½¯ä»¶å’Œç±»åº“(å®‰è£…å‰çš„å‡†å¤‡)\n1Â fdfsçš„ä¾èµ–åº“\nA è§£å‹Libfastcommon\nB è¿›å…¥Libfastcommonç›®å½•ä¸‹\nC makeç¼–è¯‘\nD make install å®‰è£…\nE libfastcommon.soå¤åˆ¶æ–‡ä»¶åˆ°/usr/lib/\n2 fastdfsè½¯ä»¶(trackerã€storage)\nA æ–°å»ºç›®å½•mkdir /opt/fastdfs\nB è§£å‹FastDFS_v5.05.tar.gz\nC è¿›å…¥è§£å‹ç›®å½•\nD makeç¼–è¯‘\nE make install å®‰è£…\nF è¿›å…¥confé…ç½®ç›®å½•å°†æ–‡ä»¶éƒ½æ‹·è´åˆ°/etc/fdfsä¸‹cpÂ *Â /etc/fdfs/ï¼ˆå®‰è£…æ—¶è‡ªåŠ¨ç”Ÿæˆï¼‰\nG è¿›å…¥/etc/fdfs/ï¼Œé…ç½®tracker.conf\nH storageçš„é…ç½®(storageä¸éœ€è¦å®‰è£…ï¼Œå› ä¸ºå®‰è£…trackeræ—¶å·²ç»åŒæ—¶å®‰è£…)\n3 é…ç½®trackerå’Œstorageçš„å¯åŠ¨æœåŠ¡\né…ç½®trackerå¯åŠ¨æœåŠ¡\né…ç½®storageå¯åŠ¨æœåŠ¡\nå°†å¯åŠ¨è„šæœ¬åŠ å…¥linuxæœåŠ¡\nâ€‹\nå¯åŠ¨æœåŠ¡\næ£€æŸ¥æœåŠ¡å¯åŠ¨çŠ¶æ€\nâ€‹\n4 æµ‹è¯•ä¸Šä¼ \nä¿®æ”¹/etc/fdfs/client.conf\nFastDFSæ•´åˆnginx\n5Â å®‰è£…nginxæ•´åˆæ’ä»¶fastdfs-nginx-module\nA è§£å‹FastDFS-nginx-moduleæ’ä»¶\nB ä¿®æ”¹æ’ä»¶è¯»å–fdfsçš„ç›®å½•ï¼ˆæ’ä»¶è‡ªå·±çš„é…ç½®æ–‡ä»¶ï¼‰\nC å°†FastDFS-nginx-moduleæ’ä»¶æ•´åˆfdfsçš„é…ç½®æ–‡ä»¶æ‹·è´åˆ°fdfsçš„é…ç½®ç›®å½•ä¸‹(æ•´åˆfdfsçš„é…ç½®æ–‡ä»¶)\nD ä¿®æ”¹/etc/fdfs/mod_fastdfs.confé…ç½®æ–‡ä»¶\n6 å®‰è£…nginx\nåˆ›å»ºnginx/clientç›®å½•\nå®‰è£…ç¯å¢ƒï¼š\nè§£å‹nginx\nè¿›å…¥nginxç›®å½• é…ç½®å®‰è£…ç¯å¢ƒ\né…ç½®æˆåŠŸ\nç¼–è¯‘\nå®‰è£…\nç¼–è¾‘nginx.conf\nå¯åŠ¨nginx\nè®¾ç½®å¼€æœºå¯åŠ¨\néœ€è¦å…³é—­é˜²ç«å¢™\næµ‹è¯•\næµè§ˆå™¨æ‰“å¼€é“¾æ¥\nå®Œç¾æˆåŠŸï¼ŒOKäº†\næ¥¼ä¸»ç›®æ ‡ï¼šå‰å¯H5æ’©å¦¹ï¼Œåå¯Linuxæè¿ç»´\nFastDFSä»‹ç» FastDFSæ˜¯ä¸€ä¸ªå¼€æºçš„è½»é‡çº§åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå¯¹æ–‡ä»¶è¿›è¡Œç®¡ç†ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼šæ–‡ä»¶å­˜å‚¨ã€æ–‡ä»¶åŒæ­¥ã€æ–‡ä»¶è®¿é—®ï¼ˆæ–‡ä»¶ä¸Šä¼ ã€æ–‡ä»¶ä¸‹è½½ï¼‰ç­‰ï¼Œè§£å†³äº†å¤§å®¹é‡å­˜å‚¨å’Œè´Ÿè½½å‡è¡¡çš„é—®é¢˜ã€‚ç‰¹åˆ«é€‚åˆä»¥æ–‡ä»¶ä¸ºè½½ä½“çš„åœ¨çº¿æœåŠ¡ï¼Œå¦‚ç›¸å†Œç½‘ç«™ã€è§†é¢‘ç½‘ç«™ç­‰ç­‰\næ¥¼ä¸»ç›®æ ‡ï¼šå‰å¯H5æ’©å¦¹ï¼Œåå¯Linuxæè¿ç»´ OKï¼ŒåºŸè¯ä¸å¤šè¯´å¼€å§‹éƒ¨ç½²\nç¯å¢ƒï¼šCentos7 è½¯ä»¶ï¼š FastDFS_v5.05.tar.gz\nfastdfs-nginx-module_v1.16.tar.gz\nlibfastcommonV1.0.7.tar.gz\nnginx-1.12.2.tar.gz\nè½¯ä»¶é“¾æ¥ï¼š https://www.lanzous.com/b0c1xw7hi\nå®‰è£…å‰æ‰€æœ‰å‡†å¤‡ï¼Œä¸Šä¼ è½¯ä»¶åˆ°Centos7ä¸Šçš„/optçš„ç›®å½•ä¸‹ å®‰è£…ä¾èµ–è½¯ä»¶å’Œç±»åº“(å®‰è£…å‰çš„å‡†å¤‡) 1 yum install gcc-c++ -y 1 yum -y install zlib zlib-devel pcre pcre-devel gcc gcc-c++ openssl openssl-devel libevent libevent-devel perl unzip net-tools wget 1 yum install perl* 1Â fdfsçš„ä¾èµ–åº“ Libfastcommonå®‰è£…è¿‡ç¨‹\nA è§£å‹Libfastcommon 1 tar -zxvf libfastcommon B è¿›å…¥Libfastcommonç›®å½•ä¸‹ 1 cd Libfastcommon C makeç¼–è¯‘ 1 make D make install å®‰è£… 1 make install E libfastcommon.soå¤åˆ¶æ–‡ä»¶åˆ°/usr/lib/ 1 cp /usr/lib64/libfastcommon.so /usr/lib/ 2 fastdfsè½¯ä»¶(trackerã€storage) é…ç½®tracker\né…ç½®storage\n(ä¾èµ–äºï¼šGccã€libeventã€perl)\nA æ–°å»ºç›®å½•mkdir /opt/fastdfs 1 mkdir /opt/fastdfs B è§£å‹FastDFS_v5.05.tar.gz 1 tar -zxvf FastDFS_v5.05.tar.gz C è¿›å…¥è§£å‹ç›®å½• 1 cd FastDFS D makeç¼–è¯‘ 1 ./make.sh E make install å®‰è£… 1 ./make.sh install F è¿›å…¥confé…ç½®ç›®å½•å°†æ–‡ä»¶éƒ½æ‹·è´åˆ°/etc/fdfsä¸‹cpÂ *Â /etc/fdfs/ï¼ˆå®‰è£…æ—¶è‡ªåŠ¨ç”Ÿæˆï¼‰ 1 2 cd conf cpÂ *Â /etc/fdfs/ G è¿›å…¥/etc/fdfs/ï¼Œé…ç½®tracker.conf vim /etc/fdfs/tracker.conf ï¼Œè®¾ç½®è½¯ä»¶æ•°æ®å’Œæ—¥å¿—ç›®å½•\nH storageçš„é…ç½®(storageä¸éœ€è¦å®‰è£…ï¼Œå› ä¸ºå®‰è£…trackeræ—¶å·²ç»åŒæ—¶å®‰è£…) vim /etc/fdfs/storage.conf\nè½¯ä»¶ç›®å½•\nStorageå­˜å‚¨æ–‡ä»¶çš„ç›®å½•ï¼ˆæ–°å»ºmkdir /opt/fastdfs/fdfs_storageï¼‰\n1 mkdir /opt/fastdfs/fdfs_storage Storageçš„trackerip\n3 é…ç½®trackerå’Œstorageçš„å¯åŠ¨æœåŠ¡ é…ç½®trackerå¯åŠ¨æœåŠ¡ è¿›å…¥/etc/init.då¯åŠ¨è„šæœ¬ç›®å½•ï¼Œé»˜è®¤fastdfså·²ç»ç”Ÿæˆ\nVi fdfs_trackerdè„šæœ¬æ–‡ä»¶\nå› ä¸ºå¯åŠ¨è„šæœ¬è¿˜åœ¨å®‰è£…ç›®å½•ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬æ–°å»º/usr/local/fdfsç›®å½•ï¼Œå¹¶ä¸”å°†å¯åŠ¨è„šæœ¬cpåˆ°è¯¥ç›®å½•\n1 mkdir /usr/local/fdfs è¿›å…¥å®‰è£…ç›®å½•/opt/FastDFs\n1 2 3 cd /opt/FastDFs cp restart.sh /usr/local/fdfs/ cp stop.sh /usr/local/fdfs/ é…ç½®storageå¯åŠ¨æœåŠ¡ (restartå’Œstopè„šæœ¬å·²ç»æ‹·è´åˆ°/usr/local/fdfsä¸‹ï¼Œæ‰€ä»¥storageåªéœ€è¦é…ç½®/etc/init.d/fdfs_storageè„šæœ¬å°±å¯ä»¥äº†)\nvimÂ /etc/init.d/fdfs_storage\nå°†å¯åŠ¨è„šæœ¬åŠ å…¥linuxæœåŠ¡ 1 2 3 4 cd /etc/init.d/ chkconfig --add fdfs_trackerd chkconfig --add fdfs_storaged å¯åŠ¨æœåŠ¡ 1 2 3 service fdfs_trackerd start service fdfs_storaged start æ£€æŸ¥æœåŠ¡å¯åŠ¨çŠ¶æ€ 1 ps -ef |grep fdfs 4 æµ‹è¯•ä¸Šä¼  FastDFSå®‰è£…æˆåŠŸå¯é€šè¿‡/usr/bin/fdfs_testæµ‹è¯•ä¸Šä¼ ã€ä¸‹è½½ç­‰æ“ä½œã€‚\nä¿®æ”¹/etc/fdfs/client.conf 1 2 3 4 5 [root@localhost ~]# vim /etc/fdfs/client.conf base_path=/opt/fastdfs tracker_server=192.168.67.163:22122 æ¯”å¦‚å°†/rootä¸‹çš„å›¾ç‰‡ä¸Šä¼ åˆ°FastDFSä¸­ï¼š\n1 /usr/bin/fdfs_test /etc/fdfs/client.conf upload preview.jpg å¯¹åº”çš„ä¸Šä¼ è·¯å¾„ï¼š\n/opt/fastdfs/fdfs_storage/data /00/00/wKhDo1qipbiAJC6iAAB1tayPlqs094_big.jpg\nFastDFSæ•´åˆnginx 5Â å®‰è£…nginxæ•´åˆæ’ä»¶fastdfs-nginx-module A è§£å‹FastDFS-nginx-moduleæ’ä»¶ 1 tar -zxvf fastdfs-nginx-module_v1.16.tar.gz B ä¿®æ”¹æ’ä»¶è¯»å–fdfsçš„ç›®å½•ï¼ˆæ’ä»¶è‡ªå·±çš„é…ç½®æ–‡ä»¶ï¼‰ Vi fastdfs-nginx-module/src/config\nåˆ é™¤åœˆä¸­é‡Œé¢çš„localï¼Œå°±ä¸Šé¢ä¸¤ä¸ªå°±å¯ä»¥äº† C å°†FastDFS-nginx-moduleæ’ä»¶æ•´åˆfdfsçš„é…ç½®æ–‡ä»¶æ‹·è´åˆ°fdfsçš„é…ç½®ç›®å½•ä¸‹(æ•´åˆfdfsçš„é…ç½®æ–‡ä»¶) FastDFS-nginx-module/srcä¸‹çš„mod_fastdfs.confæ‹·è´è‡³/etc/fdfs/ä¸‹(è¿™é‡Œé¢æ˜¯ä¸¤ä¸ªè·¯å¾„)\n1 cp /opt/fastdfs-nginx-module/src/mod_fastdfs.conf /etc/fdfs/ D ä¿®æ”¹/etc/fdfs/mod_fastdfs.confé…ç½®æ–‡ä»¶ è½¯ä»¶å®‰è£…ç›®å½•\nTracker_serveråœ°å€\nWebçš„urlæ˜¯å¦åŒ…å«groupçš„è·¯å¾„å\nä¸Šä¼ æ–‡ä»¶å­˜å‚¨ç›®å½•\n6 å®‰è£…nginx åˆ›å»ºnginx/clientç›®å½• 1 mkdir -p /var/temp/nginx/client å®‰è£…ç¯å¢ƒï¼š å®‰è£…pcreåº“\nyum -y install pcre-devel\nå®‰è£…zlibåº“\nyum install -y zlib-devel\nè§£å‹nginx 1 tar -zxvf nginx-1.12.2.tar.gz è¿›å…¥nginxç›®å½• é…ç½®å®‰è£…ç¯å¢ƒ æ·»åŠ fastdfs-nginx-moduleæ¨¡å—\ncd nginx-1.8.0\n1 2 3 4 5 6 7 8 9 10 11 12 13 ./configure \\ --prefix=/usr/local/nginx \\ --pid-path=/var/run/nginx/nginx.pid \\ --lock-path=/var/lock/nginx.lock \\ --error-log-path=/var/log/nginx/error.log \\ --http-log-path=/var/log/nginx/access.log \\ --with-http_gzip_static_module \\ --http-client-body-temp-path=/var/temp/nginx/client \\ --http-proxy-temp-path=/var/temp/nginx/proxy \\ --http-fastcgi-temp-path=/var/temp/nginx/fastcgi \\ --http-uwsgi-temp-path=/var/temp/nginx/uwsgi \\ --http-scgi-temp-path=/var/temp/nginx/scgi \\ --add-module=/opt/fastdfs-nginx-module/src é…ç½®æˆåŠŸ ç¼–è¯‘ 1 make å®‰è£… 1 make install ç¼–è¾‘nginx.conf vim /usr/local/nginx/conf/nginx.conf\nå¯åŠ¨nginx 1 /usr/local/nginx/sbin/nginx è®¾ç½®å¼€æœºå¯åŠ¨ vim /etc/rc.d/rc.local\néœ€è¦å…³é—­é˜²ç«å¢™ 1 service iptables stop æ°¸ä¹…å…³é—­ chkconfigÂ iptables off\næµ‹è¯• 1 /usr/bin/fdfs_test /etc/fdfs/client.conf upload preview.jpg æµè§ˆå™¨æ‰“å¼€é“¾æ¥ å®Œç¾æˆåŠŸï¼ŒOKäº† æ¥¼ä¸»ç›®æ ‡ï¼šå‰å¯H5æ’©å¦¹ï¼Œåå¯Linuxæè¿ç»´ ","date":"2019-10-10T12:21:17Z","image":"https://www.ownit.top/title_pic/40.jpg","permalink":"https://www.ownit.top/p/201910101221/","title":"Centos7éƒ¨ç½²åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨(Fastdfs)"},{"content":"1 å‰ç«¯127.0.0.1:8888 2 åç«¯127.0.0.1:8080 å‰ç«¯å’Œåç«¯å› ä¸ºæ¥è‡ªä¸åŒçš„ç½‘åŸŸï¼Œæ‰€ä»¥åœ¨httpçš„å®‰å…¨åè®®ç­–ç•¥ä¸‹ï¼Œä¸ä¿¡ä»» 3 è§£å†³æ–¹æ¡ˆï¼Œåœ¨springmvcçš„æ§åˆ¶å±‚åŠ å…¥@CrossOriginè·¨åŸŸè®¿é—®çš„æ³¨è§£ ","date":"2019-10-08T17:57:15Z","image":"https://www.ownit.top/title_pic/68.jpg","permalink":"https://www.ownit.top/p/201910081757/","title":"Javaå‰åç«¯çš„è·¨åŸŸé—®é¢˜"},{"content":"ç›®å½•\nç¯å¢ƒï¼šÂ ç¬¬ä¸€æ­¥ï¼šå®‰è£…jdkï¼Œå¹¶ä¸”é…ç½®ç¯å¢ƒå˜é‡\n1.è§£å‹jdkï¼š\n2.é…ç½®ç¯å¢ƒå˜é‡ï¼š\n3.ä¿å­˜å¹¶ä½¿æ–‡ä»¶ç«‹å³ç”Ÿæ•ˆï¼š\n4.ç«‹å³é‡å¯è™šæ‹Ÿæœºï¼Œè¿›è¡Œä¸‹é¢çš„å®‰è£…\nç¬¬äºŒæ­¥ï¼šå®‰è£…æ³¨å†Œä¸­å¿ƒzookeeperÂ 1.è§£å‹zookeeperï¼š\n2.åœ¨zookeeperç›®å½•ä¸‹åˆ›å»ºdataå’Œlogsç›®å½•ï¼š\n3.å°†/usr/local/zookeeper3.4.6/zookeeper-3.4.6/conf ç›®å½•ä¸‹çš„ zoo_sample.cfgæ‹·è´ï¼š\n4.ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š\nâ€‹\n5.åœ¨vi /etc/profileæœ«å°¾æ·»åŠ zookeeperé…ç½®\n6.é…ç½®æ–‡ä»¶ç«‹å³ç”Ÿæ•ˆï¼š\n7.å…³é—­é˜²ç«å¢™ï¼Œå¹¶ä¸”å¯åŠ¨æµ‹è¯•\nç¬¬ä¸‰æ­¥ï¼šå®‰è£…dubbo-admin-warå’ŒtomcatÂ 1.è§£å‹tomcat:\n2.è§£å‹dubboæ–‡ä»¶\n3.è¿›å…¥tomcatçš„confç›®å½•ä¸‹ä¿®æ”¹server.xml\n4.ä¿®æ”¹server.xml\n5.å¯åŠ¨tomcatæœåŠ¡ï¼Œè¿›å…¥tomcatçš„binä¸‹\n6.å¯åŠ¨zookeeperæœåŠ¡ï¼Œè¿›å…¥zookeeperçš„binä¸‹\nç¬¬å››æ­¥ï¼šåœ¨æµè§ˆå™¨ä¸­è¾“å…¥åœ°å€æ˜¾ç¤ºå¦‚ä¸‹ï¼šÂ ç¯å¢ƒï¼šÂ 1.centos7Â 2.jdk-7u76-linux-x64.tar.gzÂ 2.tomcat:apache-tomcat-7.0.59.tar.gzÂ 3.zookeeper-3.4.6.tar.gzÂ 4.dubbo-admin-2.5.3.war\nå…·ä½“çš„æµç¨‹ï¼šÂ ç¬¬ä¸€æ­¥ï¼šå®‰è£…jdkï¼Œå¹¶ä¸”é…ç½®ç¯å¢ƒå˜é‡\nxshell5å‘½ä»¤:\n1.è§£å‹jdkï¼š\n1 tar zxvf jdk-7u76-linux-x64.tar.gz 2.é…ç½®ç¯å¢ƒå˜é‡ï¼š /opt/jdk1.8.0_152Â :ä¸ºjdkè§£å‹çš„è·¯å¾„\n1 [root@localhost~]# vi /etc/profile 1 2 3 export JAVA_HOME=/opt/jdk1.8.0_152 export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar export PATH=$JAVA_HOME/bin:$PATH 3.ä¿å­˜å¹¶ä½¿æ–‡ä»¶ç«‹å³ç”Ÿæ•ˆï¼š 1 2 ä¿å­˜ï¼šç‚¹å‡»ESCé”®ï¼Œå¹¶ä¸”è¾“å…¥:wq; ç«‹å³ç”Ÿæ•ˆï¼šsource /etc/profile 4.ç«‹å³é‡å¯è™šæ‹Ÿæœºï¼Œè¿›è¡Œä¸‹é¢çš„å®‰è£… 1 shutdown -r now ç¬¬äºŒæ­¥ï¼šå®‰è£…æ³¨å†Œä¸­å¿ƒzookeeperÂ 1.è§£å‹zookeeperï¼š\n1 tar zxvf zookeeper-3.4.6.tar.gz 2.åœ¨zookeeperç›®å½•ä¸‹åˆ›å»ºdataå’Œlogsç›®å½•ï¼š 1 mkdir data 3.å°†/usr/local/zookeeper3.4.6/zookeeper-3.4.6/conf ç›®å½•ä¸‹çš„ zoo_sample.cfgæ‹·è´ï¼š 1 cp zoo_sample.cfg zoo.cfg 4.ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š 1 vi zoo.cfg 5.åœ¨vi /etc/profileæœ«å°¾æ·»åŠ zookeeperé…ç½® 1 2 export ZOOKEEPER_HOME=/opt/zookeeper-3.4.11 export PATH=$ZOOKEEPER_HOME/bin:$PATH 6.é…ç½®æ–‡ä»¶ç«‹å³ç”Ÿæ•ˆï¼š 1 source /etc/profile 7.å…³é—­é˜²ç«å¢™ï¼Œå¹¶ä¸”å¯åŠ¨æµ‹è¯• 1 2 systemctl stop firewalld.service åœ¨zookeeperçš„binç›®å½•ä¸‹æ‰§è¡Œï¼š ./zkServer.sh start ç¬¬ä¸‰æ­¥ï¼šå®‰è£…dubbo-admin-warå’ŒtomcatÂ 1.è§£å‹tomcat:\n1 tar zxvf apache-tomcat-7.0.59.tar.gzÂ 2.è§£å‹dubboæ–‡ä»¶ 1 unzip dubbo-admin-2.6.0.war -d dubbo 3.è¿›å…¥tomcatçš„confç›®å½•ä¸‹ä¿®æ”¹server.xml 4.ä¿®æ”¹server.xml 1 \u0026lt;Context path=\u0026#34;/dubbo\u0026#34; docBase=\u0026#34;/opt/dubbo\u0026#34; debug=\u0026#34;0\u0026#34; privileged=\u0026#34;true\u0026#34; /\u0026gt; 5.å¯åŠ¨tomcatæœåŠ¡ï¼Œè¿›å…¥tomcatçš„binä¸‹\n1 startup.sh 6.å¯åŠ¨zookeeperæœåŠ¡ï¼Œè¿›å…¥zookeeperçš„binä¸‹ 1 2 3 bash zkServer.sh start bash zkServer.sh status ç¬¬å››æ­¥ï¼šåœ¨æµè§ˆå™¨ä¸­è¾“å…¥åœ°å€æ˜¾ç¤ºå¦‚ä¸‹ï¼šÂ è´¦å·ï¼šroot\nå¯†ç ï¼šroot\n","date":"2019-09-28T14:22:52Z","image":"https://www.ownit.top/title_pic/38.jpg","permalink":"https://www.ownit.top/p/201909281422/","title":"Centos7å®‰è£…dubboä¸zookeeperæœåŠ¡é…ç½®"},{"content":"dubboä¸zookeeperçš„å…³ç³» dubboæ˜¯åŠ¨ç‰©..zookeeperæ˜¯åŠ¨ç‰©å›­çš„ç®¡ç†å‘˜ï¼\næŒ‰æˆ‘çš„ç†è§£ï¼Œæ‚¨å¯ä»¥æŠŠdubboæœåŠ¡æƒ³è±¡æˆå­¦æ ¡é‡Œçš„ä¸€ä¸ªå­¦ç”Ÿï¼Œå¹¶ä¸”å¯¹åº”æœ‰ä¸€ä¸ªå­¦å·ï¼Œzookeeperåˆ™æ˜¯æƒ³è±¡æˆä¸€ä¸ªæ•™åŠ¡ç½‘ç®¡ç†ç³»ç»Ÿã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ•™åŠ¡ç½‘ç®¡ç†ç³»ç»Ÿï¼ŒæŸ¥æ‰¾åˆ°å¯¹åº”çš„å­¦ç”Ÿã€‚æˆ‘ä»¬é¦–å…ˆé€šè¿‡æ³¨å†Œå…¥å­¦ï¼Œå°†å­¦ç”Ÿå’Œå­¦å·å¯¹åº”ç»‘å®šã€‚\næ¯”æ–¹è¯´é¡¹ç›®æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„é¡¹ç›®ï¼Œwebå±‚ä¸ serviceå±‚è¢«æ‹†åˆ†äº†å¼€æ¥ï¼Œ éƒ¨ç½²åœ¨ä¸åŒçš„tomcatä¸­ï¼Œ æˆ‘åœ¨webå±‚ éœ€è¦è°ƒç”¨ serviceå±‚çš„æ¥å£ï¼Œä½†æ˜¯ä¸¤ä¸ªè¿è¡Œåœ¨ä¸åŒtomcatä¸‹çš„æœåŠ¡æ— æ³•ç›´æ¥äº’è°ƒæ¥å£ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡zookeeperå’Œdubboå®ç°ã€‚ æˆ‘ä»¬é€šè¿‡dubbo å»ºç«‹ItemServiceè¿™ä¸ªæœåŠ¡ï¼Œå¹¶ä¸”åˆ°zookeeperä¸Šé¢æ³¨å†Œï¼Œå¡«å†™å¯¹åº”çš„zookeeperæœåŠ¡æ‰€åœ¨ çš„IPåŠç«¯å£å·ã€‚ã€æŒ‰ç…§æˆ‘ä¸Šé¢çš„æ¯”å–»å°±æ˜¯ï¼Œå­¦ç”Ÿæ³¨å†Œå…¥å­¦ï¼ˆæ¥å£æ˜¯å­¦å·ï¼Œå­¦ç”Ÿæœ¬äººæ˜¯implå®ç°ï¼‰ï¼Œå¡«å†™å­¦æ ¡æ•™åŠ¡ç½‘ç½‘å€ï¼ˆå°±æ˜¯zookeeperï¼‰ã€‘\nDubboå»ºè®®ä½¿ç”¨Zookeeperä½œä¸ºæœåŠ¡çš„æ³¨å†Œä¸­å¿ƒã€‚\n1.Â Zookeeperçš„ä½œç”¨ï¼š\nzookeeperç”¨æ¥æ³¨å†ŒæœåŠ¡å’Œè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå“ªä¸€ä¸ªæœåŠ¡ç”±å“ªä¸€ä¸ªæœºå™¨æ¥æä¾›å¿…éœ€è®©è°ƒç”¨è€…çŸ¥é“ï¼Œç®€å•æ¥è¯´å°±æ˜¯ipåœ°å€å’ŒæœåŠ¡åç§°çš„å¯¹åº”å…³ç³»ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ é€šè¿‡ç¡¬ç¼–ç çš„æ–¹å¼æŠŠè¿™ç§å¯¹åº”å…³ç³»åœ¨è°ƒç”¨æ–¹ä¸šåŠ¡ä»£ç ä¸­å®ç°ï¼Œä½†æ˜¯å¦‚æœæä¾›æœåŠ¡çš„æœºå™¨æŒ‚æ‰è°ƒç”¨è€…æ— æ³•çŸ¥æ™“ï¼Œå¦‚æœä¸æ›´æ”¹ä»£ç ä¼šç»§ç»­è¯·æ±‚æŒ‚æ‰çš„æœºå™¨æä¾›æœåŠ¡ã€‚ zookeeperé€šè¿‡å¿ƒè·³æœºåˆ¶å¯ä»¥æ£€æµ‹æŒ‚æ‰çš„æœºå™¨å¹¶å°†æŒ‚æ‰æœºå™¨çš„ipå’ŒæœåŠ¡å¯¹åº”å…³ç³»ä»åˆ—è¡¨ä¸­åˆ é™¤ã€‚è‡³äºæ”¯æŒé«˜å¹¶å‘ï¼Œç®€å•æ¥è¯´å°±æ˜¯æ¨ªå‘æ‰©å±•ï¼Œåœ¨ä¸æ›´æ”¹ä»£ç  çš„æƒ…å†µé€šè¿‡æ·»åŠ æœºå™¨æ¥æé«˜è¿ç®—èƒ½åŠ›ã€‚é€šè¿‡æ·»åŠ æ–°çš„æœºå™¨å‘zookeeperæ³¨å†ŒæœåŠ¡ï¼ŒæœåŠ¡çš„æä¾›è€…å¤šäº†èƒ½æœåŠ¡çš„å®¢æˆ·å°±å¤šäº†ã€‚\n2.Â dubboï¼š\næ˜¯ç®¡ç†ä¸­é—´å±‚çš„å·¥å…·ï¼Œåœ¨ä¸šåŠ¡å±‚åˆ°æ•°æ®ä»“åº“é—´æœ‰éå¸¸å¤šæœåŠ¡çš„æ¥å…¥å’ŒæœåŠ¡æä¾›è€…éœ€è¦è°ƒåº¦ï¼Œdubboæä¾›ä¸€ä¸ªæ¡†æ¶è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\næ³¨æ„è¿™é‡Œçš„dubboåªæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œè‡³äºä½ æ¶å­ä¸Šæ”¾ä»€ä¹ˆæ˜¯å®Œå…¨å–å†³äºä½ çš„ï¼Œå°±åƒä¸€ä¸ªæ±½è½¦éª¨æ¶ï¼Œä½ éœ€è¦é…ä½ çš„è½®å­å¼•æ“ã€‚è¿™ä¸ªæ¡†æ¶ä¸­è¦å®Œæˆè°ƒåº¦å¿…é¡»è¦æœ‰ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ³¨å†Œä¸­å¿ƒï¼Œå‚¨å­˜æ‰€æœ‰æœåŠ¡çš„å…ƒæ•°æ®ï¼Œä½ å¯ä»¥ç”¨zkï¼Œä¹Ÿå¯ä»¥ç”¨åˆ«çš„ï¼Œåªæ˜¯å¤§å®¶éƒ½ç”¨zkã€‚\n3. zookeeperå’Œdubboçš„å…³ç³»ï¼š\nDubboçš„å°†æ³¨å†Œä¸­å¿ƒè¿›è¡ŒæŠ½è±¡ï¼Œæ˜¯å¾—å®ƒå¯ä»¥å¤–æ¥ä¸åŒçš„å­˜å‚¨åª’ä»‹ç»™æ³¨å†Œä¸­å¿ƒæä¾›æœåŠ¡ï¼Œæœ‰ZooKeeperï¼ŒMemcachedï¼ŒRedisç­‰ã€‚\nå¼•å…¥äº†ZooKeeperä½œä¸ºå­˜å‚¨åª’ä»‹ï¼Œä¹Ÿå°±æŠŠZooKeeperçš„ç‰¹æ€§å¼•è¿›æ¥ã€‚é¦–å…ˆæ˜¯è´Ÿè½½å‡è¡¡ï¼Œå•æ³¨å†Œä¸­å¿ƒçš„æ‰¿è½½èƒ½åŠ›æ˜¯æœ‰é™çš„ï¼Œåœ¨æµé‡è¾¾åˆ°ä¸€å®šç¨‹åº¦çš„æ—¶ å€™å°±éœ€è¦åˆ†æµï¼Œè´Ÿè½½å‡è¡¡å°±æ˜¯ä¸ºäº†åˆ†æµè€Œå­˜åœ¨çš„ï¼Œä¸€ä¸ªZooKeeperç¾¤é…åˆç›¸åº”çš„Webåº”ç”¨å°±å¯ä»¥å¾ˆå®¹æ˜“è¾¾åˆ°è´Ÿè½½å‡è¡¡ï¼›èµ„æºåŒæ­¥ï¼Œå•å•æœ‰è´Ÿè½½å‡è¡¡è¿˜ä¸ å¤Ÿï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®å’Œèµ„æºéœ€è¦åŒæ­¥ï¼ŒZooKeeperé›†ç¾¤å°±å¤©ç„¶å…·å¤‡æœ‰è¿™æ ·çš„åŠŸèƒ½ï¼›å‘½åæœåŠ¡ï¼Œå°†æ ‘çŠ¶ç»“æ„ç”¨äºç»´æŠ¤å…¨å±€çš„æœåŠ¡åœ°å€åˆ—è¡¨ï¼ŒæœåŠ¡æä¾›è€…åœ¨å¯åŠ¨ çš„æ—¶å€™ï¼Œå‘ZKä¸Šçš„æŒ‡å®šèŠ‚ç‚¹/dubbo/${serviceName}/providersç›®å½•ä¸‹å†™å…¥è‡ªå·±çš„URLåœ°å€ï¼Œè¿™ä¸ªæ“ä½œå°±å®Œæˆäº†æœåŠ¡çš„å‘å¸ƒã€‚ å…¶ä»–ç‰¹æ€§è¿˜æœ‰Masté€‰ä¸¾ï¼Œåˆ†å¸ƒå¼é”ç­‰ã€‚\n","date":"2019-09-28T14:10:02Z","image":"https://www.ownit.top/title_pic/08.jpg","permalink":"https://www.ownit.top/p/201909281410/","title":"dubboä¸zookeeperçš„å…³ç³»"},{"content":"éšç€æŠ€æœ¯çš„æ›´æ–°å¯¹äºå¼€å‘é€Ÿåº¦çš„è¿½æ±‚ï¼Œæˆ‘ä»¬è¶Šæ¥è¶Šä¸èƒ½å¿å—çš„æ˜¯Springæ¡†æ¶å¯¹äºé›†æˆå¼€å‘ä»¥åå¤§é‡çš„é…ç½®é—®é¢˜ã€‚æ‰€ä»¥SprigBootåº”è¿è€Œç”Ÿï¼ŒSpringBootæ¡†æ¶å…¶å®å°±æ˜¯åœ¨Springæ¡†æ¶çš„å¤–è¾¹åŒ…è£¹ä¸Šäº†ä¸€å±‚çº¸ï¼ŒåŒ…æ‹¬å‡å°‘é…ç½®æ–‡ä»¶ï¼Œå†…ç½®TomcatæœåŠ¡å™¨ç­‰ç­‰ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å°±ä½¿ç”¨IDEAå·¥å…·ä¸ºä»£è¡¨è®²è§£ä¸€ä¸‹SpringBootåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¼šä½¿ç”¨åˆ°çš„å¼€å‘æŠ€æœ¯ã€‚å®˜æ–¹æ¨èçš„ç¼–è¾‘å™¨æ˜¯STSï¼ŒSTSå°±æ˜¯å¯¹Eclipesåšäº†å°è£…ï¼Œå…¶å®æ²¡æœ‰ä»€ä¹ˆå…·ä½“çš„æ”¹å˜ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯ç”¨æ›´åŠ å¿«æ·æ–¹ä¾¿çš„å¼€å‘å·¥å…·IDEAï¼Œæ²¡æœ‰å¤šå¤§çš„å½±å“ã€‚\nåˆ›å»ºé¡¹ç›®ï¼š\næ¥ä¸‹æ¥å°±æ˜¯ç»™é¡¹ç›®å‘½åäº†ï¼Œæˆ‘å·æ‡’äº†é€‰æ‹©é»˜è®¤å§ (=v=)\nwebé¡¹ç›®å¼€å‘å°±å°‘ä¸äº†å®ƒå•¦\né¡¹ç›®åç§°ã€é¡¹ç›®ä½ç½®\nç‚¹å‡»Finishåï¼Œideaå°±å¸®æˆ‘ä»¬åˆ›å»ºé¡¹ç›®\nç›®å½•ç»“æ„\njava -\u0026mdash;æºç ï¼Œè¦æ³¨æ„çš„æ˜¯Applicationè¦æ”¾åœ¨å½“å‰å·¥ç¨‹groupIdä¸‹ï¼Œä¸¾ä¸ªæ —å­ï¼ˆ=.=ï¼‰\n\u0026lt;groupId\u0026gt;com.example\u0026lt;/groupId\u0026gt;\næ‰€ä»¥ä¸Šé¢çš„ DemoApplication ä½ç½®æ˜¯è¦æ”¾åœ¨ com.example ç›®å½•ä¸‹\nresource\n-\u0026mdash;-static ï¼šwebçš„é™æ€èµ„æº\n-\u0026mdash;-templates ï¼šé¡µé¢æ¨¡æ¿ï¼ˆ.html / .ftlï¼‰\n-\u0026mdash;-application.properties ï¼šé…ç½®æ–‡ä»¶ ï¼Œä¸è¿‡å¸¸ç”¨çš„æ˜¯ä»¥ .yml ä¸ºåç¼€ï¼Œapplication.yml\næ¥ä¸‹æ¥å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ä»£ç \nUserController.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package com.demo.ssm.controller; import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; @Controller @RequestMapping(\u0026#34;\u0026#34;) public class UserController { @RestController public class TestController { @RequestMapping(\u0026#34;/test\u0026#34;) public String hello() { System.out.println(\u0026#34;TestControllerçš„æ–¹æ³•è¢«è°ƒç”¨äº†\u0026#34;); return \u0026#34;welcome to the new age !\u0026#34;; } } } å› ä¸ºSpringboot å†…åµŒ web æœåŠ¡å™¨ï¼ˆæœ‰å¾ˆå¤šï¼Œå¯æ ¹æ®æƒ…å†µæ‰€éœ€é…ç½®ï¼‰ï¼Œé»˜è®¤æ˜¯ Tomcatï¼Œå› æ­¤ç›´æ¥è¿è¡Œ Applicationç±»\napplication.properties\n1 2 3 4 5 6 7 # æœåŠ¡ç«¯å£ server.port=8080 # æ—¥å¿—çº§åˆ« logging.level.root=error æ‰“å¼€æµè§ˆå™¨ï¼Œåœ¨åœ°å€æ è¾“å…¥è¯·æ±‚URL\næ§åˆ¶å°è¾“å‡º\næ‰“å¼€æµè§ˆå™¨ï¼Œåœ¨åœ°å€æ è¾“å…¥è¯·æ±‚URL\næ§åˆ¶å°è¾“å‡º\næ²¡æœ‰springç¹ççš„é…ç½®ï¼Œä¹Ÿä¸ç”¨éƒ¨ç½²åˆ°Tomcatï¼Œå¼€å‘ä¹Ÿå¯ä»¥å¦‚æ­¤å¿«æ·æ–¹ä¾¿ã€‚\n","date":"2019-09-26T17:52:53Z","image":"https://www.ownit.top/title_pic/19.jpg","permalink":"https://www.ownit.top/p/201909261752/","title":"IEDAåˆ›å»ºSpringbooté¡¹ç›®"},{"content":"Â æ•°æ®ç»“æ„å’Œè®¾è®¡çš„ä»‹ç» ezdmlè½¯ä»¶ï¼šhttps://www.lanzous.com/i6ew2pe 1 ç”¨ezdmlè®¾è®¡æ•°æ®è¡¨ç„¶åå¯¼å‡ºåˆ°mysqlæ•°æ®åº“ä¸­ ç‚¹å‡»ç”Ÿæˆæ¨¡å‹ 2 é€‰æ‹©åº“ 3 ç‚¹å‡»å¼€å§‹ç”Ÿæˆ ","date":"2019-09-26T17:11:33Z","image":"https://www.ownit.top/title_pic/61.jpg","permalink":"https://www.ownit.top/p/201909261711/","title":"ezdmlè®¾è®¡æ•°æ®åº“"},{"content":"ç›®å½•\nCentos7ä¸‹zabbixå®‰è£…ä¸éƒ¨ç½²\n1.Zabbixä»‹ç»\n2.LAMP/LNMPä»‹ç»\n3.Zabbixå®‰è£…ä¸éƒ¨ç½²\n1ã€ä¸´æ—¶å…³é—­\n2ã€æ°¸ä¹…å…³é—­\n3 ã€å®‰è£…ç¯å¢ƒ\n4ã€å®‰è£…zabbix\nCentos7ä¸‹zabbixå®‰è£…ä¸éƒ¨ç½² 1.Zabbixä»‹ç» zabbixæ˜¯ä¸€ä¸ªåŸºäºWEBç•Œé¢çš„æä¾›åˆ†å¸ƒå¼ç³»ç»Ÿç›‘è§†ä»¥åŠç½‘ç»œç›‘è§†åŠŸèƒ½çš„ä¼ä¸šçº§çš„å¼€æºè§£å†³æ–¹æ¡ˆã€‚\nzabbixèƒ½ç›‘è§†å„ç§ç½‘ç»œå‚æ•°ï¼Œä¿è¯æœåŠ¡å™¨ç³»ç»Ÿçš„å®‰å…¨è¿è¥ï¼›å¹¶æä¾›çµæ´»çš„é€šçŸ¥æœºåˆ¶ä»¥è®©ç³»ç»Ÿç®¡ç†å‘˜å¿«é€Ÿå®šä½/è§£å†³å­˜åœ¨çš„å„ç§é—®é¢˜ã€‚\nzabbixç”±2éƒ¨åˆ†æ„æˆï¼Œzabbix serverä¸å¯é€‰ç»„ä»¶zabbix agentã€‚\nzabbix serverå¯ä»¥é€šè¿‡SNMPï¼Œzabbix agentï¼Œpingï¼Œç«¯å£ç›‘è§†ç­‰æ–¹æ³•æä¾›å¯¹è¿œç¨‹æœåŠ¡å™¨/ç½‘ç»œçŠ¶æ€çš„ç›‘è§†ï¼Œæ•°æ®æ”¶é›†ç­‰åŠŸèƒ½ï¼Œå®ƒå¯ä»¥è¿è¡Œåœ¨Linuxï¼ŒSolarisï¼ŒHP-UXï¼ŒAIXï¼ŒFree BSDï¼ŒOpen BSDï¼ŒOS Xç­‰å¹³å°ä¸Šã€‚\n2.LAMP/LNMPä»‹ç» LAMPï¼šLinux+Apache+Mysql/MariaDB+Perl/PHP/Pythonä¸€ç»„å¸¸ç”¨æ¥æ­å»ºåŠ¨æ€ç½‘ç«™æˆ–è€…æœåŠ¡å™¨çš„å¼€æºè½¯ä»¶ï¼Œæœ¬èº«éƒ½æ˜¯å„è‡ªç‹¬ç«‹çš„ç¨‹åºï¼Œä½†æ˜¯å› ä¸ºå¸¸è¢«æ”¾åœ¨ä¸€èµ·ä½¿ç”¨ï¼Œæ‹¥æœ‰äº†è¶Šæ¥è¶Šé«˜çš„å…¼å®¹åº¦ï¼Œå…±åŒç»„æˆäº†ä¸€ä¸ªå¼ºå¤§çš„Webåº”ç”¨ç¨‹åºå¹³å°ã€‚\nLNMPï¼šLNMPæŒ‡çš„æ˜¯ä¸€ä¸ªåŸºäºCentOS/Debianç¼–å†™çš„Nginxã€PHPã€MySQLã€phpMyAdminã€eAcceleratorä¸€é”®å®‰è£…åŒ…ã€‚å¯ä»¥åœ¨VPSã€ç‹¬ç«‹ä¸»æœºä¸Šè½»æ¾çš„å®‰è£…LNMPç”Ÿäº§ç¯å¢ƒã€‚\nLï¼šlinux\nAï¼šapache\nNï¼šnginx\nMï¼šmysql,mariaDB\nPï¼šphp,python,perl\n3.Zabbixå®‰è£…ä¸éƒ¨ç½² Zabbixçš„å®‰è£…\n1 2 3 å…³é—­SeLinux ä¸´æ—¶å…³é—­ï¼šsetenforce 0 1 æ°¸ä¹…å…³é—­ï¼švi /etc/selinux/config å…³é—­é˜²ç«å¢™\n1ã€ä¸´æ—¶å…³é—­ 1 systemctl stop firewalld.service 2ã€æ°¸ä¹…å…³é—­ 1 systemctl disable firewalld.service 3 ã€å®‰è£…ç¯å¢ƒ LAMPÂ å¤§å®¶å¯ä»¥çœ‹ä¸‹é¢çš„åšå®¢ï¼Œå®‰è£…LAMPç¯å¢ƒ\nLinux(Centos7)æ­å»ºLAMP(Apache+PHP+Mysqlç¯å¢ƒ)\n4ã€å®‰è£…zabbix (1)ä¸‹è½½åŒ…\n1 rpm -ivh http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm (2)å®‰è£…zabbixçš„åŒ…\n1 yum install -y zabbix-server-mysql zabbix-get zabbix-web zabbix-web-mysql zabbix-agent zabbix-sender 4ã€åˆ›å»ºä¸€ä¸ªzabbixåº“å¹¶è®¾ç½®ä¸ºutf8çš„å­—ç¬¦ç¼–ç æ ¼å¼\n1 create database zabbix character set utf8 collate utf8_bin; åˆ›å»ºè´¦æˆ·å¹¶ä¸”æˆæƒè®¾ç½®å¯†ç \n1 grant all privileges on zabbix.* to zabbix@localhost identified by \u0026#39;zabbix\u0026#39;; ç»™æ¥è‡ªloclhostçš„ç”¨æˆ·zabbxiåˆ†é…å¯å¯¹æ•°æ®åº“zabbixæ‰€æœ‰è¡¨è¿›è¡Œæ‰€æœ‰æ“ä½œçš„æƒé™ï¼Œå¹¶ä¸”è®¾å®šå¯†ç ä¸ºzabbix\nåˆ·æ–°\n1 flush privileges; exité€€å‡º\n5ã€å¯¼å…¥è¡¨\nåˆ‡æ¢åˆ°æ­¤ç›®å½•ä¸‹\n1 cd /usr/share/doc/zabbix-server-mysql-3.2.10/ è¿›è¡Œè§£å‹\n1 gunzip create.sql.gz å¯¹è¡¨è¿›è¡Œå¯¼å…¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 [root@wei zabbix-server-mysql-3.4.15]# mysql -u zabbix -p zabbix Enter password: Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 10 Server version: 5.6.45 MySQL Community Server (GPL) Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. mysql\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | zabbix | +--------------------+ 2 rows in set (0.00 sec) mysql\u0026gt; use zabbix; Database changed mysql\u0026gt; source create.sql 6ã€é…ç½®zabbix serveré…ç½®æ–‡ä»¶\né…ç½®æ–‡ä»¶ç›®å½•\n1 cd /etc/zabbix å¯¹zabbix_server.confè¿›è¡Œé…ç½®\nè¿è¡Œzabbix-serveræœåŠ¡\nå¼€æœºè‡ªå¯zabbix-serveræœåŠ¡\n7ã€é…ç½®php\n1 cd /etc/httpd/conf.d é…ç½®æ—¶é—´\n1 vim zabbix.conf 1 Systemctl restart httpd 8ã€ç™»é™†zabbixç½‘å€è®¾ç½®\n192.168.85.11/zabbix\npasswordæ˜¯æˆ‘ä»¬è®¾ç½®çš„æ•°æ®åº“å¯†ç zabbix\nç™»é™†è´¦æˆ·æ˜¯Admin\nå¯†ç æ˜¯zabbix\n9ã€è®¾ç½®ä¸­æ–‡\n10ã€å¯¹æœåŠ¡å™¨è‡ªèº«è¿›è¡Œç›‘æ§\n11ã€è§£å†³ä¸­æ–‡ä¹±ç æ— æ³•æ˜¾ç¤ºçš„é—®é¢˜\nä»æˆ‘ä»¬ç”µè„‘win7é‡Œé¢æ‰¾åˆ°é»‘ä½“å³é”®å¤åˆ¶åˆ°æ¡Œé¢ç„¶åæ‹‰åˆ°zabbixæœåŠ¡å™¨ä¸Šé¢\nç›´æ¥ä¿®æ”¹å­—ä½“åå­—\nåˆ‡æ¢åˆ°è¿™ä¸ªç›®å½•ä¸‹é¢: /usr/share/zabbix/fonts\nç°åœ¨çš„ä¸­æ–‡å­—ä½“æ˜¯æ˜¾ç¤ºæ­£å¸¸çš„äº†\n","date":"2019-09-24T10:47:15Z","image":"https://www.ownit.top/title_pic/36.jpg","permalink":"https://www.ownit.top/p/201909241047/","title":"Centos7ä¸‹zabbixå®‰è£…ä¸éƒ¨ç½²"},{"content":"ç›®å½•\nå®å¡”é¢æ¿å®‰è£…å’Œä½¿ç”¨å›¾æ–‡æ•™ç¨‹\n1,é€šè¿‡sshå·¥å…·ç™»å½•æœåŠ¡å™¨\n2ï¼Œå®‰è£…å®å¡”é¢æ¿\n2ï¼Œç™»å½•å®å¡”é¢æ¿\n3ï¼Œè®¾ç½®å®å¡”é¢æ¿\n3.1ï¼Œé¦–å…ˆæˆ‘ä»¬è¿›å…¥é¢æ¿è®¾ç½®\n3.2ï¼Œæ›´æ”¹é¢æ¿ç«¯å£\n3.3ï¼Œç»‘å®šåŸŸå\n3.4ï¼Œç»‘å®šip\n3.5ï¼Œæ›´æ”¹é»˜è®¤çš„é¢æ¿ç”¨æˆ·å’Œå¯†ç \n3.5ï¼Œç»‘å®šå®å¡”è´¦å·\n3.6ï¼Œç»‘å®šå¾®ä¿¡å°ç¨‹åº\n4ï¼Œå®å¡”é¢æ¿å®‰å…¨è®¾ç½®\n5ï¼Œå®‰è£…é¢æ¿ç¯å¢ƒ\n6ï¼Œåˆ›å»ºç½‘ç«™\n7ï¼Œè´­ä¹°æ’ä»¶\n8ï¼Œå‡çº§ä¸ºä¸“ä¸šç‰ˆ\nå®å¡”é¢æ¿å®‰è£…å’Œä½¿ç”¨å›¾æ–‡æ•™ç¨‹ å¦‚æœä½ è¦å®‰è£…å®å¡”linuxé¢æ¿,ä½ è¦å‡†å¤‡å¥½ä¸€ä¸ªçº¯å‡€ç‰ˆçš„linuxæ“ä½œç³»ç»Ÿï¼Œæ²¡æœ‰å®‰è£…è¿‡å…¶å®ƒç¯å¢ƒå¸¦çš„Apache/Nginx/php/MySQLï¼ˆå·²æœ‰ç¯å¢ƒä¸å¯å®‰è£…ï¼‰ã€‚æ”¯æŒçš„æ“ä½œç³»ç»Ÿæœ‰CentOSï¼ŒUbuntuã€Debianã€Fedoraã€‚è¿™é‡Œç»™å¤§å®¶æ¼”ç¤ºçš„æ˜¯centos7.5ã€‚\n1,é€šè¿‡sshå·¥å…·ç™»å½•æœåŠ¡å™¨ è¿™é‡Œæ¨èå¤§å®¶ä½¿ç”¨xshellè¿›è¡Œç™»å½•ã€‚æ³¨æ„è¦å¼€æ”¾sshè¿æ¥çš„ç«¯å£ï¼Œä¸€èˆ¬é»˜è®¤æ˜¯22ï¼Œä¸ºäº†ç½‘ç«™å®‰å…¨æ¨èå¤§å®¶æ›´æ¢sshç™»å½•ç«¯å£ã€‚è®¾ç½®ä¸ºä¸å¸¸ç”¨çš„ç«¯å£ã€‚\nè¾“å…¥è´¦å·å’Œå¯†ç ï¼Œæ³¨æ„å¯†ç åœ¨è¾“å…¥æ—¶æ˜¯ä¸æ˜¾ç¤ºçš„ï¼Œå¤§å®¶ä¸è¦ä»¥ä¸ºå¯†ç æ²¡è¾“å…¥ã€‚\n2ï¼Œå®‰è£…å®å¡”é¢æ¿ æ‰§è¡Œä»¥ä¸‹ä»£ç è¿›è¡Œå®‰è£…å®å¡”6.9å…è´¹ç‰ˆã€‚å®å¡”6.9ç‰ˆæœ¬å·²ç»å¾ˆç¨³å®šäº†ï¼Œæ¨èå¤§å®¶ç›´æ¥å®‰è£…6.9ç‰ˆæœ¬ï¼ˆæ³¨æ„ï¼šå®å¡”linux6.0ç‰ˆæœ¬æ˜¯åŸºäºcentos7å¼€å‘çš„ï¼ŒåŠ¡å¿…ä½¿ç”¨centos7.x ç³»ç»Ÿ\n1 [root@wei ~]# yum install -y wget \u0026amp;\u0026amp; wget -O install.sh http://download.bt.cn/install/install_6.0.sh \u0026amp;\u0026amp; sh install.sh å¦‚æœå¤§å®¶ç³»ç»Ÿæ˜¯centos7ä»¥ä¸‹çš„å¤§å®¶è¿˜æ˜¯ä¹–ä¹–ä½¿ç”¨å®å¡”5.9çš„å®‰è£…è„šæœ¬ï¼ˆCentoså®˜æ–¹å·²å®£å¸ƒåœ¨2020å¹´åœæ­¢å¯¹Centos6çš„ç»´æŠ¤æ›´æ–°ï¼Œæ¨èå¤§å®¶è£…ç³»ç»Ÿç›´æ¥å®‰è£…centos7ï¼‰\n1 yum install -y wget \u0026amp;\u0026amp; wget -O install.sh http://download.bt.cn/install/install.sh \u0026amp;\u0026amp; sh install.sh å›è½¦è¿›è¡Œå®‰è£…ã€‚\nè¾“å…¥yï¼Œå¹¶å›è½¦ã€‚æ¥ä¸‹æ¥ä¾¿æ˜¯ç­‰å¾…å®å¡”é¢æ¿è¿›è¡Œå®‰è£…ã€‚\næˆ‘ä»¬å¾—åˆ°ç™»å½•å®å¡”é¢æ¿çš„URL,è´¦å·å’Œå¯†ç ã€‚\n2ï¼Œç™»å½•å®å¡”é¢æ¿ å®‰è£…å®Œæˆå®å¡”é¢æ¿åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®äº†ã€‚å¤åˆ¶Bt-panelä¸­çš„URLåˆ°æµè§ˆå™¨ä¸Šè®¿é—®ã€‚æ³¨æ„è¦æ‰“å¼€æœåŠ¡å™¨ä¸Šçš„8888ç«¯å£ï¼Œå…³äºå¦‚ä½•æ‰“å¼€æœåŠ¡å™¨ç«¯å£ï¼Œä½ å¯ä»¥åœ¨æœ¬ç«™ä¸­æœç´¢ç­”æ¡ˆã€‚\nè¾“å…¥é»˜è®¤çš„è´¦å·å’Œå¯†ç è¿›è¡Œç™»å½•ã€‚\n3ï¼Œè®¾ç½®å®å¡”é¢æ¿ ç™»é™†åè¿›å…¥å®å¡”é¢æ¿æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä½ å¯ä»¥é€‰æ‹©LNMPæˆ–è€…LAMPè¿›è¡Œå®‰è£…ã€‚çœ‹å¤§å®¶ç½‘ç«™éœ€è¦ä»€ä¹ˆç¯å¢ƒè¿›è¡Œé€‰æ‹©ã€‚å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒæ¨èå¤§å®¶ä½¿ç”¨ç¼–è¯‘å®‰è£…ï¼Œå¦‚æœåªæ˜¯æµ‹è¯•ç¯å¢ƒé€‰æ‹©æé€Ÿå®‰è£…ã€‚ä¸¤è€…çš„åŒºåˆ«æ˜¯ç¼–è¯‘å®‰è£…æ…¢ä½†ç¨³å®šï¼Œæé€Ÿå®‰è£…è™½ç„¶æ…¢ä½†æ˜¯æ²¡ç¼–è¯‘å®‰è£…ç¨³å®šã€‚\næ¨èå¤§å®¶é¦–æ¬¡è¿›å…¥å®å¡”é¢æ¿å‰ä¸è¦è¿›è¡Œç¯å¢ƒçš„å®‰è£…ï¼Œå› ä¸ºåœ¨å®‰è£…ç¯å¢ƒä¸èƒ½æ›´æ”¹å®å¡”é¢æ¿çš„è®¾ç½®ã€‚æ¨èå¤§å®¶å…ˆæ›´æ”¹å®å¡”é¢æ¿çš„é»˜è®¤è®¾ç½®ï¼Œç¼–è¯‘å®‰è£…ç¯å¢ƒå°†è¿‘ä¸€ä¸ªå°æ—¶ã€‚åœ¨è¿™æ®µæ—¶é—´é‡Œæˆ‘ä»¬å…ˆå°†å®å¡”é¢æ¿è®¾ç½®å¥½æé«˜é¢æ¿çš„å®‰å…¨æ€§ã€‚\n3.1ï¼Œé¦–å…ˆæˆ‘ä»¬è¿›å…¥é¢æ¿è®¾ç½® 3.2ï¼Œæ›´æ”¹é¢æ¿ç«¯å£ å°†ç«¯å£æ›´æ”¹ä¸ºä¸å¸¸ç”¨çš„ç«¯å£ã€‚\n3.3ï¼Œç»‘å®šåŸŸå ä½ å¯ä»¥ç»‘å®šä¸€ä¸ªåŸŸåç»‘å®šå®ŒåŸŸåååªèƒ½é€šè¿‡ä½ ç»‘å®šçš„åŸŸåæ¥è®¿é—®é¢æ¿ã€‚\n3.4ï¼Œç»‘å®šip å¦‚æœä½ æœ‰å›ºå®šçš„ipï¼Œä½ å¯ç»‘å®šipè®¿é—®ï¼Œç»‘å®šäº†ipè®¿é—®ä½ åªèƒ½é€šè¿‡ç»‘å®šå¾—è¿™ä¸ªipè¿›è¡Œè®¿é—®ã€‚å¦‚æœä½ æ˜¯å®¶ç”¨ç”µè„‘å°±ä¸è¦ç»‘å®šipäº†ï¼Œå› ä¸ºå®¶ç”¨ç”µè„‘çš„ipæ˜¯åŠ¨æ€çš„ã€‚è¿™å°±ä¼šé€ æˆipå‘ç”Ÿæ”¹å˜é¢æ¿è®¿é—®ä¸äº†ã€‚\n3.5ï¼Œæ›´æ”¹é»˜è®¤çš„é¢æ¿ç”¨æˆ·å’Œå¯†ç  æ›´æ”¹å®å¡”å®‰è£…å®Œæˆæ—¶çš„é»˜è®¤ç”¨æˆ·åå’Œå¯†ç ï¼Œè®¾ç½®ä¸€ä¸ªè‡ªå·±èƒ½è®°ä½çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå¯†ç ä¸è¦å¤ªç®€å•äº†ã€‚\n3.5ï¼Œç»‘å®šå®å¡”è´¦å· å¦‚æœä½ æœ‰å®å¡”è´¦å·ä½ å¯ä»¥ç»‘å®šä¸‹ï¼Œæ²¡æœ‰çš„è¯å¯ä»¥å»å®å¡”å®˜ç½‘ç”³è¯·ã€‚å®å¡”è´¦å·åœ¨è´­ä¹°ä»˜è´¹æ’ä»¶ï¼Œå¼€é€šä¸“ä¸šç‰ˆæ—¶è¦ç”¨åˆ°ã€‚è¦å»æ³¨å†Œè´¦å·\n3.6ï¼Œç»‘å®šå¾®ä¿¡å°ç¨‹åº ç”±äºå¾®ä¿¡å°ç¨‹åºæ˜¯ä»˜è´¹æ’ä»¶ï¼Œä½ åªæœ‰è´­ä¹°äº†æˆ–è€…å¼€é€šä¸“ä¸šç‰ˆæ‰èƒ½ä½¿ç”¨ã€‚å¾®ä¿¡å°ç¨‹åºèƒ½å¤Ÿç›‘æ§æœåŠ¡å™¨ï¼Œæ–¹ä¾¿ç”¨æˆ·éšæ—¶æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€ã€‚\n4ï¼Œå®å¡”é¢æ¿å®‰å…¨è®¾ç½® åœ¨è¿™é‡Œä½ å¯ä»¥å¼€å¯å’Œç¦ç”¨ä¸€äº›ç«¯å£ã€‚æ¨èå¤§å®¶æ›´æ”¹sshç«¯å£ï¼Œå’Œç¦ç”¨pingã€‚æ›´æ”¹FTPç«¯å£ã€‚æ›´æ”¹phpadminé»˜è®¤ç«¯å£ã€‚ä¸å¸¸ç”¨çš„ç«¯å£å¯ä»¥æŠŠå®ƒå…³é—­ï¼Œç­‰è¦ä½¿ç”¨äº†åœ¨å¼€å¯ã€‚\n5ï¼Œå®‰è£…é¢æ¿ç¯å¢ƒ åœ¨è½¯ä»¶ç®¡ç†é€‰æ‹©ä½ æ‰€éœ€è¦çš„ç½‘ç«™ç¯å¢ƒè¿›è¡Œå®‰è£…ã€‚\nåœ¨è¿™é‡Œè€æ¨é€‰æ‹©LNMPè¿›è¡Œå®‰è£…ï¼Œå³Linux+Nginx+Mysql+Phpã€‚\n6ï¼Œåˆ›å»ºç½‘ç«™ ç­‰ç½‘ç«™ç¯å¢ƒå®‰è£…å®Œæˆåä¾¿å¯ä»¥åˆ›å»ºç½‘ç«™ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åˆ›å»ºç½‘ç«™ã€‚ç¬¬ä¸€ç§ç›´æ¥åœ¨é€‰æ‹©ç½‘ç«™ï¼Œé€‰æ‹©æ·»åŠ ç«™ç‚¹ï¼Œè¿›è¡Œåˆ›å»ºç½‘ç«™ã€‚\nç¬¬äºŒç§åœ¨è½¯ä»¶ç®¡ç†ä¸­çš„å®å¡”æ’ä»¶ä¸­å®‰è£…å®å¡”ä¸€é”®éƒ¨ç½²æºç æ’ä»¶è¿›è¡Œåˆ›å»ºç½‘ç«™ã€‚\n7ï¼Œè´­ä¹°æ’ä»¶ å¦‚æœä½ åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°æŸæ¬¾æ’ä»¶ä½ å¯ä»¥åˆ°è½¯ä»¶ç®¡ç†\u0026gt;ä»˜è´¹æ’ä»¶è¿›è¡Œè´­ä¹°ã€‚\né€‰æ‹©è´­ä¹°æ—¶é—´è¿›è¡Œè´­ä¹°ã€‚\n8ï¼Œå‡çº§ä¸ºä¸“ä¸šç‰ˆ å¦‚æœä½ åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨åˆ°å¤šæ¬¾ä»˜è´¹æ’ä»¶æ¨èå¤§å®¶å‡çº§ä¸“ä¸šç‰ˆã€‚\né€‰æ‹©æ—¶é—´å¹¶è¿›è¡Œæ”¯ä»˜ã€‚\nå¦‚æœä½ æœ‰è´¦å·æœ‰è´­ä¹°è¿‡ä¸“ä¸šç‰ˆä½ å¯ä»¥é€‰æ‹©ä»£é‡‘åŠµè¿›è¡Œæ”¯ä»˜ã€‚\nåˆ·æ–°ä¸‹é¢æ¿åœ¨åˆ°æœŸæ—¶é—´å¯ä»¥çœ‹åˆ°æ°¸ä¹…æˆæƒå››ä¸ªå­—ã€‚\nå¦‚æœå‡çº§ä¸æˆåŠŸå¯ä»¥sshç™»å½•åˆ°æœåŠ¡å™¨æ‰§è¡Œå‡çº§ä»£ç è¿›è¡Œå‡çº§ã€‚\n1 2 3 4 5 6 7 8 9 ``` 1. wget -O update.sh http://download.bt.cn/install/update\\_pro.sh \\\u0026amp;\\\u0026amp; bash update.sh pro [![](format,png)](https://www.laoyangblog.com/wp-content/uploads/2018/09/20180924011530.png) æˆ–è€…è¿›å…¥æ–‡ä»¶ç®¡ç†å™¨ï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œç²˜è´´å‡çº§ä»£ç ï¼Œç„¶åç‚¹å‡»â€œå‘é€â€ï¼Œæ‰‹åŠ¨å‡çº§åˆ°ä¸“ä¸šç‰ˆã€‚ [![](format,png)](https://www.laoyangblog.com/wp-content/uploads/2018/09/20180924011916.png) ","date":"2019-09-24T09:48:52Z","image":"https://www.ownit.top/title_pic/57.jpg","permalink":"https://www.ownit.top/p/201909240948/","title":"Centos7å®‰è£…å®å¡”æ§åˆ¶é¢æ¿"},{"content":"ç›®å½•\nLinuxæ­å»ºLAMP(Apache+PHP+Mysqlç¯å¢ƒ)Centos7\nä¸€ã€ æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ\n1ã€ç¡®è®¤centosç‰ˆæœ¬\n2ã€æ£€æŸ¥æ˜¯å¦å®‰è£…è¿‡apache\n3ã€æ£€æŸ¥æ˜¯å¦å®‰è£…è¿‡Mysql\n4ã€æ¸…ç†Mysqlç—•è¿¹\n5ã€å¸è½½ApacheåŒ…\näºŒã€å®‰è£…Apacheã€PHPã€Mysql\n1ã€å®‰è£…apache\n2ã€å®‰è£…Php\n3ã€å®‰è£…php-fpm\n4ã€å®‰è£…Mysql\n5ã€å®‰è£… mysql-server\n6ã€å®‰è£… php-mysql\nä¸‰ã€å®‰è£…åŸºæœ¬å¸¸ç”¨æ‰©å±•åŒ…\n1ã€å®‰è£…Apacheæ‰©å±•åŒ…\n2ã€å®‰è£…PHPæ‰©å±•åŒ…\n3ã€å®‰è£…Mysqlæ‰©å±•åŒ…\nå››ã€é…ç½®Apacheã€mysqlå¼€æœºå¯åŠ¨\näº”ã€é…ç½®Mysql\nå…­ã€æµ‹è¯•ç¯å¢ƒ\nLinuxæ­å»ºLAMP(Apache+PHP+Mysqlç¯å¢ƒ)Centos7 LAMPæ˜¯æŒ‡ä¸€ç»„é€šå¸¸ä¸€èµ·ä½¿ç”¨æ¥è¿è¡ŒåŠ¨æ€ç½‘ç«™æˆ–è€…æœåŠ¡å™¨çš„è‡ªç”±è½¯ä»¶åç§°é¦–å­—æ¯ç¼©å†™ï¼š\nLinuxï¼Œæ“ä½œç³»ç»Ÿ\nApacheï¼Œç½‘é¡µæœåŠ¡å™¨\nMariaDBæˆ–MySQLï¼Œæ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆæˆ–è€…æ•°æ®åº“æœåŠ¡å™¨ï¼‰\nPHPã€Perlæˆ–Pythonï¼Œè„šæœ¬è¯­è¨€\nä¸€ã€ æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ 1ã€ç¡®è®¤centosç‰ˆæœ¬\n1 2 [root@wei ~]# cat /etc/redhat-release CentOS Linux release 7.4.1708 (Core) 2ã€æ£€æŸ¥æ˜¯å¦å®‰è£…è¿‡apache\n1 2 [root@wei ~]# rpm -qa |grep httpd æˆ–è€…ï¼š\napachectl -v\næˆ–è€…ï¼š\nhttpd -vÂ 3ã€æ£€æŸ¥æ˜¯å¦å®‰è£…è¿‡Mysql\n1 2 [root@wei ~]# rpm -qa | mysql 4ã€æ¸…ç†Mysqlç—•è¿¹\n1 2 3 4 5 [root@wei ~]# yum remove mysql å·²åŠ è½½æ’ä»¶ï¼šfastestmirror å‚æ•° mysql æ²¡æœ‰åŒ¹é… ä¸åˆ é™¤ä»»ä½•è½¯ä»¶åŒ… [root@wei ~]# rm -rf /etc/my.cnf 5ã€å¸è½½ApacheåŒ…\n1 [root@wei ~]# rpm -e httpd --nodeps æ³¨æ„ï¼šå¦‚æœæ˜¯æ–°çš„ç³»ç»Ÿæˆ–è€…ä½ ä»æ¥æ²¡æœ‰å°è¯•å®‰è£…è¿‡ï¼Œåˆ™ä»¥ä¸Šæ­¥éª¤çœç•¥ã€‚\näºŒã€å®‰è£…Apacheã€PHPã€Mysql 1ã€å®‰è£…apache\n1 [root@wei ~]# yum install httpd -y ç›´åˆ°è¿”å›\nå®‰è£…å®Œæˆ\næŸ¥çœ‹å®‰è£…httpd\n1 2 3 [root@wei ~]# rpm -qa |grep httpd httpd-tools-2.4.6-90.el7.centos.x86_64 httpd-2.4.6-90.el7.centos.x86_64 è¡¨ç¤ºå®‰è£…æˆåŠŸï¼\n2ã€å®‰è£…Php\n[root@localhost ~]# yum -y install php\nç›´åˆ°è¿”å›ï¼š\næŸ¥çœ‹å®‰è£…phpçš„è½¯ä»¶\n1 2 3 4 [root@wei ~]# rpm -qa |grep php php-common-5.4.16-46.el7.x86_64 php-5.4.16-46.el7.x86_64 php-cli-5.4.16-46.el7.x86_64 3ã€å®‰è£…php-fpm\n1 [root@wei ~]# yum -y install php-fpm ç›´åˆ°è¿”å›ï¼š\n4ã€å®‰è£…Mysql 1 [root@wei ~]# yum -y install mysql ç›´åˆ°è¿”å›ï¼š\nComplete!\n7.2ç‰ˆæœ¬çš„Centoså·²ç»æŠŠmysqlæ›´åä¸ºmariadbï¼Œè¡¨ç¤ºå®‰è£…æˆåŠŸï¼\n5ã€å®‰è£… mysql-server 1 2 3 4 5 6 7 8 [root@wei ~]# yum -y install mysql-server å·²åŠ è½½æ’ä»¶ï¼šfastestmirror Loading mirror speeds from cached hostfile * base: mirrors.aliyun.com * extras: mirrors.aliyun.com * updates: mirrors.tuna.tsinghua.edu.cn æ²¡æœ‰å¯ç”¨è½¯ä»¶åŒ… mysql-serverã€‚ é”™è¯¯ï¼šæ— é¡»ä»»ä½•å¤„ç† è¿”å›é”™è¯¯ï¼ï¼ï¼\nåˆ†æè§£å†³æ–¹æ¡ˆ\nCentOS 7+ ç‰ˆæœ¬å°†MySQLæ•°æ®åº“è½¯ä»¶ä»é»˜è®¤çš„ç¨‹åºåˆ—è¡¨ä¸­ç§»é™¤ï¼Œç”¨mariadbä»£æ›¿äº†ï¼Œentos7é…ç½®æ•™ç¨‹ä¸Šï¼Œå¤§å¤šéƒ½æ˜¯å®‰è£…mariadbï¼Œå› ä¸ºcentos7é»˜è®¤å°†mariadbè§†ä½œmysqlã€‚ å› ä¸ºmysqlè¢«oracleæ”¶è´­åï¼ŒåŸä½œè€…æ‹…å¿ƒmysqlé—­æºï¼Œæ‰€ä»¥åˆå†™äº†ä¸€ä¸ªmariadbï¼Œè¿™ä¸ªæ•°æ®åº“å¯ä»¥ç†è§£ä¸ºmysqlçš„åˆ†æ”¯ã€‚å¦‚æœéœ€è¦å®‰è£…mariadbï¼Œåªéœ€é€šè¿‡yumå°±å¯ã€‚ æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š\nä¸€æ˜¯å®‰è£…mariadb\n[root@localhost ~]# yum install -y mariadbÂ äºŒæ˜¯ä»å®˜ç½‘ä¸‹è½½mysql-server\né‡‡ç”¨ç¬¬äºŒç§æ–¹æ¡ˆï¼š\n1 [root@wei ~]# wget http://dev.mysql.com/get/mysql-community-release-el7-5.noarch.rpm 1 [root@wei ~]# rpm -ivh mysql-community-release-el7-5.noarch.rpm 1 [root@wei ~]# yum -y install wget ä¸‹è½½ä¸­\u0026hellip;\u0026hellip;.\nå®‰è£…æˆåŠŸï¼ï¼ï¼\n6ã€å®‰è£… php-mysql\n1 [root@wei ~]# yum -y install php-mysql ç›´åˆ°è¿”å›ï¼š\nå®‰è£…æˆåŠŸï¼ï¼ï¼\nä¸‰ã€å®‰è£…åŸºæœ¬å¸¸ç”¨æ‰©å±•åŒ… 1ã€å®‰è£…Apacheæ‰©å±•åŒ…\n1 [root@wei ~]# yum -y install httpd-manual mod_ssl mod_perl mod_auth_mysqlÂ å®‰è£…æˆåŠŸï¼ï¼ï¼\n2ã€å®‰è£…PHPæ‰©å±•åŒ…\n1 [root@wei ~]# yum -y install php-gd php-xml php-mbstring php-ldap php-pear php-xmlrpc php-devel å®‰è£…æˆåŠŸï¼ï¼ï¼\n3ã€å®‰è£…Mysqlæ‰©å±•åŒ… 1 [root@wei ~]# yum -y install mysql-connector-odbc mysql-devel libdbi-dbd-mysql å®‰è£…æˆåŠŸï¼ï¼ï¼\nå››ã€é…ç½®Apacheã€mysqlå¼€æœºå¯åŠ¨ é‡å¯Apacheã€mysqlæœåŠ¡(æ³¨æ„è¿™é‡Œå’Œcentos6æœ‰åŒºåˆ«,Cenots7+ä¸èƒ½ä½¿ç”¨6çš„æ–¹å¼)\nsystemctl start httpd.service #å¯åŠ¨apache\nsystemctl stop httpd.service #åœæ­¢apache\nsystemctl restart httpd.service #é‡å¯apache\nsystemctl enable httpd.service #è®¾ç½®apacheå¼€æœºå¯åŠ¨\nå¦‚æœæ˜¯é‡‡ç”¨æ–¹æ³•ä¸€å®‰è£…çš„mariadb,å®‰è£…å®Œæˆä»¥åä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¼€å¯æ•°æ®åº“æœåŠ¡ï¼š\n#å¯åŠ¨MariaDB\n1 [root@wei~]# systemctl start mariadb.service #åœæ­¢MariaDB\n1 [root@wei~]# systemctl stop mariadb.service #é‡å¯MariaDB\n1 [root@wei~]# systemctl restart mariadb.service #è®¾ç½®å¼€æœºå¯åŠ¨\n1 [root@wei~]# systemctl enable mariadb.service é‡å¯å¯¹åº”æœåŠ¡\nservice mysqld restart\nservice php-fpm start\nservice httpd restart\näº”ã€é…ç½®Mysql\næ³¨æ„ï¼šè¦å¯åŠ¨mysqlæ‰èƒ½è¿›å»\nåˆæ¬¡å®‰è£…mysqlæ˜¯æ²¡æœ‰å¯†ç çš„,æˆ‘ä»¬è¦è®¾ç½®å¯†ç ï¼Œmysqlçš„é»˜è®¤è´¦æˆ·ä¸ºroot\nè®¾ç½® MySQL æ•°æ® root è´¦æˆ·çš„å¯†ç ï¼š\n1 [root@wei etc]# mysql -u root -p å…­ã€æµ‹è¯•ç¯å¢ƒ æ³¨æ„ï¼šè¦å¯åŠ¨httpdæ‰èƒ½è¿›å»\n1ã€æˆ‘ä»¬åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥http://localhost/å¦‚ä¸‹å›¾ï¼Œè¯´æ˜æˆ‘ä»¬çš„apacheæµ‹è¯•æˆåŠŸ\n2ã€æµ‹è¯•PHP\nè¿›å…¥apacheçš„webæ ¹ç›®å½•ï¼š/var/www/html ä¸­å†™ä¸€ä¸ªæœ€ç®€å•çš„phpæµ‹è¯•é¡µé¢\n1 2 [root@wei ~]# cd /var/www/html/ [root@wei html]# vi phpinfo.php 3ã€è¿›å…¥åˆ°äº†æ§åˆ¶æ¨¡å¼ä¹‹åæŒ‰é”®ç›˜å­—æ¯ i è¿›å…¥åˆ°ç¼–è¾‘æ¨¡å¼ï¼Œå°†å¦‚ä¸‹ä»£ç è¾“å…¥åˆ°æ–‡ä»¶ä¸­\n1 2 3 4 \u0026lt;?php echo \u0026#34;\u0026lt;title\u0026gt;Phpinfo Test.php\u0026lt;/title\u0026gt;\u0026#34;; phpinfo() ?\u0026gt; æŒ‰ esc é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼Œå›åˆ°æ§åˆ¶æ¨¡å¼ï¼Œè¾“å…¥ :wq ç„¶åå›è½¦ï¼Œ\né‡å¯apacheæœåŠ¡å™¨\n1 [root@wei html]# systemctl restart httpd åœ¨æµè§ˆå™¨ä¸­è¾“å…¥æœåœ°å€http://localhost/phpinfo.php\nå‡ºç°ä¸‹å›¾åˆ™æˆåŠŸã€‚\n","date":"2019-09-23T15:09:01Z","image":"https://www.ownit.top/title_pic/51.jpg","permalink":"https://www.ownit.top/p/201909231509/","title":"Linux(Centos7)æ­å»ºLAMP(Apache+PHP+Mysqlç¯å¢ƒ)"},{"content":"ç›®å½•\n1.åˆ›å»ºweb Mavené¡¹ç›®\n2.åˆ›å»ºjavaæºç æ–‡ä»¶å’Œresourcesèµ„æºæ–‡ä»¶\n3.åˆ›å»ºæ•°æ®åº“é…ç½®æ–‡ä»¶ï¼šjdbc.properties\n4.é¡¹ç›®æ€»ä½“ç›®å½•ï¼š\n5.æ·»åŠ springé…ç½®æ–‡ä»¶ï¼šapplicationContext.xml\n6.æ·»åŠ springMVCé…ç½®æ–‡ä»¶ï¼šspringMVC.xml\n7.ä¿®æ”¹web.xml\n8.åˆ›å»ºæ•°æ®åº“ç›¸å…³è¡¨\n9.æ ¹æ®æ•°æ®åº“è¡¨åˆ›å»ºpojoç±»ï¼šUser.java\n[10.ç¼–å†™daoå±‚-\u0026gt;mapperæ¥å£å’Œxmlæ–‡ä»¶ ï¼šUserMapper.javaã€UserMapper.xml](\u0026lt;#10.ç¼–å†™daoå±‚-\u0026gt;mapperæ¥å£å’Œxmlæ–‡ä»¶ ï¼šUserMapper.javaã€UserMapper.xml\u0026gt;)\n11.ç¼–å†™serviceå±‚-\u0026gt;UserService.javaã€UserServiceImpl.java\n12.ç¼–å†™controllerå±‚-\u0026gt;UserController.java\n13.åœ¨jspæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºedit.jspå’Œview.jsp\n14.é…ç½®tomcatï¼Œå¯åŠ¨æœåŠ¡å™¨ï¼ˆè®°å¾—åŠ è½½é¡¹ç›®åï¼‰\n15.æŸ¥çœ‹è¿è¡Œç»“æœï¼ˆå·²ç»æˆåŠŸï¼‰\n16.é¡¹ç›®æºç \nå‰è¨€ï¼šå­¦ä¹ mavenåï¼Œæ„Ÿè§‰å¾ˆå‰å®³å°±æ­å»ºä¸ªé¡¹ç›®å°é¡¹ç›®ç©ç©ã€‚\nåŠŸèƒ½ï¼šå®ç°è¡¨çš„å¢åˆ æ”¹æŸ¥\nå·¥å…·ï¼šIDEAÂ jdk 1.8Â mysqlÂ æ•´ä½“é¡¹ç›®ç»“æ„ï¼š\n1.åˆ›å»ºweb Mavené¡¹ç›® ï¼Œæ¥ä¸‹æ¥åœ¨pomæ–‡ä»¶åŠ å…¥é¡¹ç›®æ‰€éœ€ä¾èµ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 \u0026lt;dependencies\u0026gt; \u0026lt;!--Springæ¡†æ¶æ ¸å¿ƒåº“ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-context\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.2.4.RELEASE\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-tx\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.2.4.RELEASE\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Spring Web --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-webmvc\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.2.4.RELEASE\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!--è¿æ¥é©±åŠ¨--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.1.46\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!--æ•°æ®æº--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;druid\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.1.10\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- mybatis ORMæ¡†æ¶ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.mybatis\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mybatis\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.4.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!--mybatis-springé€‚é…å™¨ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.mybatis\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mybatis-spring\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.3.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!--æ•´åˆmybatiså¦‚æœä¸åŠ è¿™ä¸ªåŒ…ä¼šæŠ¥é”™ java.lang.NoClassDefFoundError: org/springframewor--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-jdbc\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.2.4.RELEASE\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!--æµ‹è¯•--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;junit\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;junit\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.12\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!--å¼•å…¥JSTLæ ‡ç­¾--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;javax.servlet\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jstl\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;taglibs\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;standard\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.1.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; 2.åˆ›å»ºjavaæºç æ–‡ä»¶å’Œresourcesèµ„æºæ–‡ä»¶ 3.åˆ›å»ºæ•°æ®åº“é…ç½®æ–‡ä»¶ï¼šjdbc.properties resourcesç›®å½•ä¸‹æ·»åŠ ï¼šjdbc.properties\n1 2 3 4 5 #æ•°æ®åº“é…ç½®æ–‡ä»¶ jdbc.driver=com.mysql.jdbc.Driver jdbc.url=jdbc:mysql://localhost:3306/test?useUnicode=true\u0026amp;characterEncoding=utf8 jdbc.username=root jdbc.password=root 4.é¡¹ç›®æ€»ä½“ç›®å½•ï¼š å…ˆç»™å‡ºé¡¹ç›®æ€»ä½“ç›®å½•\nåˆ›å»ºå¥½javaç›®å½•ä¸‹çš„åˆ†å±‚çš„åŒ…ï¼Œresourcesä¸‹åˆ›å»ºå­˜æ”¾mapperçš„åŒ…ï¼ŒWEB-INFä¸‹åˆ›å»ºjspæ”¾è·³è½¬çš„é¡µé¢ï¼ˆä¸‹é¢çš„é…ç½®æ–‡ä»¶ä¸­ä¼šé…ç½®è¿™äº›è·¯å¾„ï¼‰\n5.æ·»åŠ springé…ç½®æ–‡ä»¶ï¼šapplicationContext.xml resourcesç›®å½•ä¸‹æ·»åŠ ï¼šapplicationContext.xml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;beans xmlns=\u0026#34;http://www.springframework.org/schema/beans\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns:context=\u0026#34;http://www.springframework.org/schema/context\u0026#34; xsi:schemaLocation=\u0026#34;http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd\u0026#34;\u0026gt; \u0026lt;!-- å¯¼å…¥æ•°æ®åº“é…ç½®æ–‡ä»¶ --\u0026gt; \u0026lt;context:property-placeholder location=\u0026#34;classpath:jdbc.properties\u0026#34;/\u0026gt; \u0026lt;!-- æ‰«æåŒ… è¿™é‡Œçš„åŒ…éœ€è¦æ ¹æ®è‡ªå·±javaç›®å½•ä¸‹çš„åŒ…åä¿®æ”¹ --\u0026gt; \u0026lt;context:component-scan base-package=\u0026#34;com.demo.service\u0026#34; /\u0026gt; \u0026lt;!-- é…ç½®æ•°æ®åº“è¿æ¥æ±  --\u0026gt; \u0026lt;bean id=\u0026#34;dataSource\u0026#34; class=\u0026#34;com.alibaba.druid.pool.DruidDataSource\u0026#34;\u0026gt; \u0026lt;!-- åŸºæœ¬å±æ€§ urlã€userã€password --\u0026gt; \u0026lt;property name=\u0026#34;url\u0026#34; value=\u0026#34;${jdbc.url}\u0026#34; /\u0026gt; \u0026lt;property name=\u0026#34;username\u0026#34; value=\u0026#34;${jdbc.username}\u0026#34; /\u0026gt; \u0026lt;property name=\u0026#34;password\u0026#34; value=\u0026#34;${jdbc.password}\u0026#34; /\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;!--Mybatisçš„SessionFactoryé…ç½®--\u0026gt; \u0026lt;bean id=\u0026#34;sqlSession\u0026#34; class=\u0026#34;org.mybatis.spring.SqlSessionFactoryBean\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;typeAliasesPackage\u0026#34; value=\u0026#34;com.demo.pojo\u0026#34; /\u0026gt; \u0026lt;property name=\u0026#34;dataSource\u0026#34; ref=\u0026#34;dataSource\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;mapperLocations\u0026#34; value=\u0026#34;classpath:mapper/*.xml\u0026#34;/\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;!--Mybatisçš„Mapperæ–‡ä»¶è¯†åˆ«--\u0026gt; \u0026lt;bean class=\u0026#34;org.mybatis.spring.mapper.MapperScannerConfigurer\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;basePackage\u0026#34; value=\u0026#34;com.demo.dao\u0026#34;/\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;/beans\u0026gt; 6.æ·»åŠ springMVCé…ç½®æ–‡ä»¶ï¼šspringMVC.xml resourcesç›®å½•ä¸‹æ·»åŠ ï¼šspringMVC.xmlï¼Œå¹¶ä¸”æ ¹æ®æ–‡ä»¶ä¸­â€˜è§†å›¾å®šä½â€™çš„é…ç½®ï¼Œæ‰€ä»¥åœ¨WEB-INFä¸‹åˆ›å»ºjspæ–‡ä»¶å¤¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;beans xmlns=\u0026#34;http://www.springframework.org/schema/beans\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns:context=\u0026#34;http://www.springframework.org/schema/context\u0026#34; xmlns:mvc=\u0026#34;http://www.springframework.org/schema/mvc\u0026#34; xsi:schemaLocation=\u0026#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.2.xsd\u0026#34;\u0026gt; \u0026lt;context:component-scan base-package=\u0026#34;com.demo.controller\u0026#34; /\u0026gt; \u0026lt;!-- é…ç½®å¦‚æœæ²¡æœ‰\u0026lt;mvc:annotation-driven/\u0026gt;ï¼Œ é‚£ä¹ˆæ‰€æœ‰çš„Controllerå¯èƒ½å°±æ²¡æœ‰è§£æï¼Œæ‰€æœ‰å½“æœ‰è¯·æ±‚æ—¶å€™éƒ½æ²¡æœ‰åŒ¹é…çš„å¤„ç†è¯·æ±‚ç±»ï¼Œ å°±éƒ½å»\u0026lt;mvc:default-servlet-handler/\u0026gt;å³default servletå¤„ç†äº†ã€‚ æ·»åŠ ä¸Š\u0026lt;mvc:annotation-driven/\u0026gt;åï¼Œ ç›¸åº”çš„doè¯·æ±‚è¢«Controllerå¤„ç†ï¼Œè€Œé™æ€èµ„æºå› ä¸ºæ²¡æœ‰ç›¸åº”çš„Controllerå°±ä¼šè¢«default servletå¤„ç†ã€‚ æ€»ä¹‹æ²¡æœ‰ç›¸åº”çš„Controllerå°±ä¼šè¢«default servletå¤„ç†å°±okäº†ã€‚ --\u0026gt; \u0026lt;mvc:annotation-driven /\u0026gt; \u0026lt;!--å¼€é€šé™æ€èµ„æºçš„è®¿é—®--\u0026gt; \u0026lt;mvc:default-servlet-handler /\u0026gt; \u0026lt;!-- è§†å›¾å®šä½ --\u0026gt; \u0026lt;bean class=\u0026#34;org.springframework.web.servlet.view.InternalResourceViewResolver\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;viewClass\u0026#34; value=\u0026#34;org.springframework.web.servlet.view.JstlView\u0026#34; /\u0026gt; \u0026lt;property name=\u0026#34;prefix\u0026#34; value=\u0026#34;/WEB-INF/view/\u0026#34; /\u0026gt; \u0026lt;property name=\u0026#34;suffix\u0026#34; value=\u0026#34;.jsp\u0026#34; /\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;/beans\u0026gt; 7.ä¿®æ”¹web.xml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-app xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns=\u0026#34;http://java.sun.com/xml/ns/javaee\u0026#34; xsi:schemaLocation=\u0026#34;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd\u0026#34; version=\u0026#34;2.5\u0026#34;\u0026gt; \u0026lt;!-- springçš„é…ç½®æ–‡ä»¶--\u0026gt; \u0026lt;context-param\u0026gt; \u0026lt;param-name\u0026gt;contextConfigLocation\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;classpath:applicationContext.xml\u0026lt;/param-value\u0026gt; \u0026lt;/context-param\u0026gt; \u0026lt;listener\u0026gt; \u0026lt;listener-class\u0026gt;org.springframework.web.context.ContextLoaderListener\u0026lt;/listener-class\u0026gt; \u0026lt;/listener\u0026gt; \u0026lt;!--ä¸­æ–‡è¿‡æ»¤å™¨--\u0026gt; \u0026lt;filter\u0026gt; \u0026lt;filter-name\u0026gt;CharacterEncodingFilter\u0026lt;/filter-name\u0026gt; \u0026lt;filter-class\u0026gt;org.springframework.web.filter.CharacterEncodingFilter\u0026lt;/filter-class\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;encoding\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;utf-8\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;/filter\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CharacterEncodingFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/*\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;!-- spring mvcæ ¸å¿ƒï¼šåˆ†å‘servlet --\u0026gt; \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;mvc-dispatcher\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;org.springframework.web.servlet.DispatcherServlet\u0026lt;/servlet-class\u0026gt; \u0026lt;!-- spring mvcçš„é…ç½®æ–‡ä»¶ --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;contextConfigLocation\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;classpath:springMVC.xml\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;load-on-startup\u0026gt;1\u0026lt;/load-on-startup\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;mvc-dispatcher\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;/web-app\u0026gt; 8.åˆ›å»ºæ•°æ®åº“ç›¸å…³è¡¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 /* Navicat Premium Data Transfer Source Server : phpStudy Source Server Type : MySQL Source Server Version : 50553 Source Host : localhost:3306 Source Schema : test Target Server Type : MySQL Target Server Version : 50553 File Encoding : 65001 Date: 16/09/2019 19:46:40 */ SET NAMES utf8mb4; SET FOREIGN_KEY_CHECKS = 0; -- ---------------------------- -- Table structure for user -- ---------------------------- DROP TABLE IF EXISTS `user`; CREATE TABLE `user` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(255) CHARACTER SET gbk COLLATE gbk_chinese_ci NULL DEFAULT NULL, `password` varchar(255) CHARACTER SET gbk COLLATE gbk_chinese_ci NULL DEFAULT NULL, PRIMARY KEY (`id`) USING BTREE ) ENGINE = MyISAM AUTO_INCREMENT = 9 CHARACTER SET = gbk COLLATE = gbk_chinese_ci ROW_FORMAT = Dynamic; -- ---------------------------- -- Records of user -- ---------------------------- INSERT INTO `user` VALUES (1, \u0026#39;cheng\u0026#39;, \u0026#39;128946\u0026#39;); INSERT INTO `user` VALUES (3, \u0026#39;eff\u0026#39;, \u0026#39;f\u0026#39;); INSERT INTO `user` VALUES (4, \u0026#39;fwefw\u0026#39;, \u0026#39;wef\u0026#39;); INSERT INTO `user` VALUES (8, \u0026#39;fwef\u0026#39;, \u0026#39;13\u0026#39;); SET FOREIGN_KEY_CHECKS = 1; 9.æ ¹æ®æ•°æ®åº“è¡¨åˆ›å»ºpojoç±»ï¼šUser.java pojoçš„ç¼–å†™è§„åˆ™ï¼šæ•°æ®åº“å­—æ®µå¯¹åº”ç±»å­—æ®µï¼Œå­—æ®µç±»å‹è¦ä¸€ç›´ ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 package com.demo.pojo; import java.io.Serializable; public class User implements Serializable { private Integer id; private String name; private String password; public String getPassword() { return password; } public void setPassword(String password) { this.password = password; } public Integer getId() { return id; } public void setId(Integer id) { this.id = id; } public String getName() { return name; } public void setName(String name) { this.name = name == null ? null : name.trim(); } } 10.ç¼–å†™daoå±‚-\u0026gt;mapperæ¥å£å’Œxmlæ–‡ä»¶ ï¼šUserMapper.javaã€UserMapper.xml UserMapper.xmlæ”¾åœ¨resources\\mapperä¸‹ï¼ŒUserMapper.javaæ”¾åœ¨com.demo.daoè¿™ä¸ªåŒ…ä¸‹ï¼š\næ³¨æ„namespace=\u0026ldquo;com.demo.dao.UserMapper\u0026rdquo;ï¼Œè¿™é‡Œä¸€å®šå†™å¯¹åº”çš„mapperæ¥å£å…·ä½“è·¯å¾„\nUserMapperæ¥å£çš„ç¼–å†™è§„åˆ™ï¼š\n(1ï¼‰æ–¹æ³•åå’Œå¯¹åº”çš„mapperé…ç½®æ–‡ä»¶ä¸­æŸ¥è¯¢è¯­å¥çš„idç›¸åŒ\nï¼ˆ2ï¼‰è¿”å›ç±»å‹å’ŒresultTypeçš„ç±»å‹ä¸€è‡´ï¼Œæ²¡æœ‰å°±æ˜¯voidã€‚\nï¼ˆ3ï¼‰æ–¹æ³•ä¸­çš„å‚æ•°åˆ—è¡¨ä¸­çš„ç±»å‹å’ŒparameterTypeä¸€è‡´ã€‚\nï¼ˆ4ï¼‰mapperé…ç½®æ–‡ä»¶çš„namespaceå¯¹åº”mapperæ¥å£ç±»çš„å…¨è·¯å¾„ã€‚\nUserMapper.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package com.demo.dao; import com.demo.pojo.User; import java.util.List; public interface UserMapper { List\u0026lt;User\u0026gt; list(); void del(int id); void update(User user); void add(User user); User get(int id); } UserMapper.xml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34; ?\u0026gt; \u0026lt;!DOCTYPE mapper PUBLIC \u0026#34;-//mybatis.org//DTD Mapper 3.0//EN\u0026#34; \u0026#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd\u0026#34; \u0026gt; \u0026lt;mapper namespace=\u0026#34;com.demo.dao.UserMapper\u0026#34; \u0026gt; \u0026lt;select id=\u0026#34;list\u0026#34; resultType=\u0026#34;user\u0026#34;\u0026gt; select * from user \u0026lt;/select\u0026gt; \u0026lt;update id=\u0026#34;update\u0026#34; parameterType=\u0026#34;user\u0026#34;\u0026gt; update user set name=#{name} ,password=#{password} where id=#{id} \u0026lt;/update\u0026gt; \u0026lt;insert id=\u0026#34;add\u0026#34; parameterType=\u0026#34;user\u0026#34;\u0026gt; insert into user values (null,#{name},#{password}); \u0026lt;/insert\u0026gt; \u0026lt;delete id=\u0026#34;del\u0026#34;\u0026gt; delete from user where id=#{id} \u0026lt;/delete\u0026gt; \u0026lt;select id=\u0026#34;get\u0026#34; resultType=\u0026#34;user\u0026#34;\u0026gt; select * from user where id =#{id} \u0026lt;/select\u0026gt; \u0026lt;/mapper\u0026gt; 11.ç¼–å†™serviceå±‚-\u0026gt;UserService.javaã€UserServiceImpl.java UserService.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package com.demo.service; import com.demo.pojo.User; import java.util.List; public interface UserService { List\u0026lt;User\u0026gt; list(); void del(int id); void update(User user); void add(User user); User get(int id); } UserServiceImpl.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package com.demo.service.impl; import com.demo.dao.UserMapper; import com.demo.pojo.User; import com.demo.service.UserService; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Service; import java.util.List; @Service public class UserServiceImpl implements UserService{ @Autowired UserMapper userMapper; public List\u0026lt;User\u0026gt; list() { return userMapper.list(); } public void add(User user) { userMapper.add(user); } public void del(int id) { userMapper.del(id); } public void update(User user) { userMapper.update(user); } public User get(int id) { return userMapper.get(id); } } 12.ç¼–å†™controllerå±‚-\u0026gt;UserController.java 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package com.demo.controller; import com.demo.pojo.User; import com.demo.service.UserService; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Controller; import org.springframework.ui.Model; import org.springframework.web.bind.annotation.RequestMapping; import java.util.List; @Controller @RequestMapping(\u0026#34;\u0026#34;) public class UserController { @Autowired UserService userService; @RequestMapping(\u0026#34;list\u0026#34;) public String list(Model model){ List\u0026lt;User\u0026gt; us= userService.list(); model.addAttribute(\u0026#34;us\u0026#34;, us); return \u0026#34;view\u0026#34;; } @RequestMapping(\u0026#34;add\u0026#34;) public String add(User user,Model model){ userService.add(user); return \u0026#34;redirect:list\u0026#34;; } @RequestMapping(\u0026#34;del\u0026#34;) public String del(int id){ userService.del(id); return \u0026#34;redirect:list\u0026#34;; } @RequestMapping(\u0026#34;editUI\u0026#34;) public String editUI(int id,Model model){ User user = userService.get(id); model.addAttribute(\u0026#34;user\u0026#34;,user); return \u0026#34;edit\u0026#34;; } @RequestMapping(\u0026#34;update\u0026#34;) public String update(User user){ userService.update(user); return \u0026#34;redirect:list\u0026#34;; } } 13.åœ¨jspæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºedit.jspå’Œview.jsp edit.jsp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; isELIgnored=\u0026#34;false\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; #edit{width:300px;height:500px;margin: 100px auto} \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div id=\u0026#34;edit\u0026#34;\u0026gt; \u0026lt;form action=\u0026#34;/update\u0026#34;\u0026gt; å§“åï¼š\u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;name\u0026#34; value=\u0026#34;${user.name}\u0026#34;/\u0026gt;\u0026lt;br/\u0026gt; å¯†ç ï¼š\u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;password\u0026#34; value=\u0026#34;${user.password}\u0026#34;/\u0026gt;\u0026lt;br/\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; value=\u0026#34;${user.id}\u0026#34; name=\u0026#34;id\u0026#34;\u0026gt; \u0026lt;button type=\u0026#34;submit\u0026#34; value=\u0026#34;\u0026#34;\u0026gt;ä¿®æ”¹\u0026lt;/button\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; view.jsp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; isELIgnored=\u0026#34;false\u0026#34; %\u0026gt; \u0026lt;%@ taglib prefix=\u0026#34;c\u0026#34; uri=\u0026#34;http://java.sun.com/jsp/jstl/core\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; table,table tr th, table tr td { border:1px solid rgba(41, 36, 35, 0.96); } #mytable{width:300px;margin: 100px auto} #add{width:300px;height:500px;margin: 100px auto} \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div id=\u0026#34;list\u0026#34;\u0026gt; \u0026lt;table id=\u0026#34;mytable\u0026#34;\u0026gt; \u0026lt;thead\u0026gt; \u0026lt;th\u0026gt;id\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;åå­—\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;å¯†ç \u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;ä¿®æ”¹\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;åˆ é™¤\u0026lt;/th\u0026gt; \u0026lt;/thead\u0026gt; \u0026lt;tbody\u0026gt; \u0026lt;c:forEach items=\u0026#34;${us}\u0026#34; var=\u0026#34;user\u0026#34;\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;${user.id}\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;${user.name}\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;${user.password}\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;\u0026lt;a href=\u0026#34;editUI?id=${user.id}\u0026#34;\u0026gt;edit\u0026lt;/a\u0026gt; \u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;\u0026lt;a href=\u0026#34;del?id=${user.id}\u0026#34;\u0026gt;delete\u0026lt;/a\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;/c:forEach\u0026gt; \u0026lt;/tbody\u0026gt; \u0026lt;/table\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;add\u0026#34;\u0026gt; \u0026lt;form action=\u0026#34;/add\u0026#34;\u0026gt; å§“åï¼š\u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;name\u0026#34; value=\u0026#34;\u0026#34;/\u0026gt;\u0026lt;br/\u0026gt; å¯†ç ï¼š\u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;password\u0026#34; value=\u0026#34;\u0026#34;/\u0026gt;\u0026lt;br/\u0026gt; \u0026lt;button type=\u0026#34;submit\u0026#34;\u0026gt;æ·»åŠ \u0026lt;/button\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; æœ€åæŠŠindex.jspå†…å®¹ä¿®æ”¹ä¸º:\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; isELIgnored=\u0026#34;false\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;% response.sendRedirect(request.getContextPath()+\u0026#34;/list\u0026#34;); %\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; 14.é…ç½®tomcatï¼Œå¯åŠ¨æœåŠ¡å™¨ï¼ˆè®°å¾—åŠ è½½é¡¹ç›®åï¼‰ 15.æŸ¥çœ‹è¿è¡Œç»“æœï¼ˆå·²ç»æˆåŠŸï¼‰ 16.é¡¹ç›®æºç  æºç +sqlï¼šhttps://www.lanzous.com/i679e2d\nå¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¯ä»¥ç§èŠæˆ‘ï¼Œçœ‹è§è§£å†³\næ¬¢è¿ä¸ä¼šçš„å¯ä»¥ç›¸äº’äº¤æµã€‚\näº¤æµç¾¤ï¼š629383010ï¼ˆå…è´¹ï¼‰\n","date":"2019-09-16T20:26:56Z","image":"https://www.ownit.top/title_pic/74.jpg","permalink":"https://www.ownit.top/p/201909162026/","title":"Maven+SSMæ¡†æ¶ï¼Œå®ç°å•è¡¨ç®€å•çš„å¢åˆ æ”¹æŸ¥"},{"content":"urllibåŒ…Â urllibæ˜¯ä¸€ä¸ªåŒ…å«å‡ ä¸ªæ¨¡å—æ¥å¤„ç†è¯·æ±‚çš„åº“ï¼šÂ - urllib.requestå‘é€httpè¯·æ±‚Â - urllib.errorå¤„ç†è¯·æ±‚è¿‡ç¨‹ä¸­å‡ºç°çš„å¼‚å¸¸Â - urllib.parseè§£æurlÂ - urllib.robotparserè§£ærobots.txtæ–‡ä»¶\nä¸€èˆ¬æˆ‘ä»¬çˆ¬è™«åªéœ€è¦å¸¸ç”¨çš„å‡ ä¸ªï¼Œä¸‹é¢åªåˆ—å‡ºæ¯”è¾ƒå¸¸ç”¨çš„å‡½æ•°\næˆ‘ä»¬ä½¿ç”¨urllibæ¨¡å—ï¼Œé‚£å°±è¦å¼•ç”¨æ¨¡å—\n1 import urllib.request urlreteieveï¼šç›´æ¥ä¸‹è½½ç½‘é¡µåˆ°æœ¬åœ° æ ¼å¼ urlreteieveï¼ˆç½‘å€ï¼Œæœ¬åœ°çš„æ–‡ä»¶ï¼‰\nç¤ºä¾‹ï¼š\n1 2 3 import urllib.request urllib.request.urlretrieve(\u0026#34;https://read.douban.com/provider/all\u0026#34;,\u0026#34;F:/test/down.html\u0026#34;) print(\u0026#34;ä¸‹è½½å®Œæˆ\u0026#34;) urlcleanupï¼šæ¸…æ¥šç³»ç»Ÿç¼“å­˜ 1 2 3 4 import urllib.request urllib.request.urlcleanup() urllib.request.urlretrieve(\u0026#34;https://read.douban.com/provider/all\u0026#34;,\u0026#34;F:/test/down.html\u0026#34;) print(\u0026#34;ä¸‹è½½å®Œæˆ\u0026#34;) info() ï¼šçœ‹ç›¸åº”æƒ…å†µçš„ç®€ä»‹\n1 2 3 import urllib.request file=urllib.request.urlopen(\u0026#34;https://read.douban.com/provider/all\u0026#34;) print(file.info()) getcode() è¿”å›ç½‘é¡µçˆ¬å–çŠ¶æ€ç  geturl()Â è·å–å½“å‰è®¿é—®çš„ç½‘é¡µçš„url ","date":"2019-09-07T17:05:43Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/201909071705/","title":"Pythonçš„çˆ¬è™«åˆ©å™¨ä¹‹urllib"},{"content":"ç›®å½•\n# æ­£åˆ™è¡¨è¾¾å¼\n#æ™®é€šå­—ç¬¦ä½œä¸ºåŸå­\n#éæ‰“å°å­—ç¬¦ä½œä¸ºåŸå­\n# é€šç”¨å­—ç¬¦ä½œä¸ºåŸå­ï¼ˆä½œç”¨éå¸¸å¤§ï¼‰\n# åŸå­è¡¨(å‡ ä¸ªåŸå­ç»„æˆä¸€ä¸ª)\n# å…ƒå­—ç¬¦\n# æ¨¡å¼ä¿®æ­£ç¬¦\n# è´ªå©ªæ¨¡å¼å’Œæ‡’æƒ°æ¨¡å¼\n# æ­£åˆ™è¡¨è¾¾å¼å‡½æ•°\n#ç¤ºä¾‹ï¼šåŒ¹é….comå’Œ.cnç½‘å€â€‹â€‹â€‹â€‹â€‹\n#ç¤ºä¾‹ï¼šåŒ¹é…ç”µè¯å·ç \n# æ­£åˆ™è¡¨è¾¾å¼ 1 2 import re str =\u0026#34;weidongliang\u0026#34; #æ™®é€šå­—ç¬¦ä½œä¸ºåŸå­ 1 2 3 pat =\u0026#34;wei\u0026#34; rsr=re.search(pat,str) print(rsr) #éæ‰“å°å­—ç¬¦ä½œä¸ºåŸå­ #\\n:æ¢è¡Œç¬¦Â \\tï¼šåˆ¶è¡¨ç¬¦\n1 2 3 4 5 6 str =\u0026#39;\u0026#39;\u0026#39;baidusdfs baidu \u0026#39;\u0026#39;\u0026#39; pat=\u0026#34;\\n\u0026#34; rest=re.search(pat,str) print(rest) # é€šç”¨å­—ç¬¦ä½œä¸ºåŸå­ï¼ˆä½œç”¨éå¸¸å¤§ï¼‰\n\\w:åŒ¹é…ä»»ä½•å­—æ¯ï¼Œæ•°å­—ï¼Œä¸‹åˆ’çº¿ \\W:é™¤åŒ¹é…ä»»ä½•å­—æ¯ï¼Œæ•°å­—ï¼Œä¸‹åˆ’çº¿ \\d:åè¿›åˆ¶æ•°å­— \\D:é™¤åè¿›åˆ¶æ•°å­— \\s:ç©ºç™½å­—ç¬¦ \\S:é™¤ç©ºç™½å­—ç¬¦ 1 2 3 string=\u0026#34;taobao4 59454baidu\u0026#34; pat=\u0026#34;\\w\\d\\s\\d\\d\u0026#34; print(re.search(pat,string)) # åŸå­è¡¨(å‡ ä¸ªåŸå­ç»„æˆä¸€ä¸ª) 1 2 3 4 string=\u0026#34;taobao4 59454baidu\u0026#34; pat=\u0026#34;tao[zub]ao\u0026#34; pat=\u0026#34;tao[^zuq]ao\u0026#34; print(re.search(pat,string)) # å…ƒå­—ç¬¦ . :å‡ºæ¢è¡Œå¤–ä»»æ„ä¸€ä¸ªå­—ç¬¦ \\^ ï¼šå¼€å§‹ä½ç½® \\$ :ç»“æŸä½ç½® \\* ï¼š0\\\\1\\\\å¤šæ¬¡ ï¼Ÿï¼š0\\\\1æ¬¡ \\+ ï¼š1\\\\å¤šæ¬¡ \\{n\\} ï¼šæ°å¥½næ¬¡ \\{n,\\} ï¼šè‡³å°‘næ¬¡ \\{nï¼Œm\\}ï¼šè‡³å°‘nï¼Œæœ€å¤šm |Â ï¼šæ¨¡å¼é€‰æ‹©ç¬¦ \\(\\) :æ¨¡å¼å•å…ƒ 1 2 3 4 5 wei=\u0026#34;taoyun14524baidu\u0026#34; pat=\u0026#34;tao.un\u0026#34; pat=\u0026#34;bai..$\u0026#34; ce=re.search(pat,wei) print(ce) # æ¨¡å¼ä¿®æ­£ç¬¦ I åŒ¹é…æ—¶å¿½æ‚ å¤§å°å†™ \\* M å¤šè¡ŒåŒ¹é… \\* L æœ¬åœ°åŒ–è¯†åˆ«åŒ¹é… U Unicode S è®©.åŒ¹é…åŒ…æ‹¬æ¢è¡Œç¬¦ \\* 1 2 3 4 str=\u0026#34;Python\u0026#34; pat=\u0026#34;pyt\u0026#34; ce=re.search(pat,str,re.I) print(ce) # è´ªå©ªæ¨¡å¼å’Œæ‡’æƒ°æ¨¡å¼ # é»˜è®¤æ˜¯è´ªå©ªæ¨¡å¼\n1 2 3 4 5 6 7 str=\u0026#34;pythony\u0026#34; pat=\u0026#34;p.*y\u0026#34; #è´ªå©ªæ¨¡å¼ï¼Œæ¨¡ç³Š pat2=\u0026#34;p.*?y\u0026#34; #æ‡’æƒ°æ¨¡å¼ï¼Œç²¾å‡† ce=re.search(pat,str,re.I) ce2=re.search(pat2,str,re.I) print(ce) print(ce2) # æ­£åˆ™è¡¨è¾¾å¼å‡½æ•° #1ï¼Œmatch é‡å¤´å¼€å§‹åŒ¹é…\n1 2 3 4 str=\u0026#34;poyajgsdabskjdbaiush\u0026#34; pat=\u0026#34;p.*?y\u0026#34; ce=re.match(pat,str,re.I) print(ce) #2ï¼ŒsearchÂ ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥åŒ¹é…\n#3ï¼Œå…¨å±€åŒ¹é…å‡½æ•°\n1 2 str=\u0026#34;efdrpoyajgspnyskjdbapyth\u0026#34; pat=\u0026#34;p.*?y\u0026#34; # å…¨å±€åŒ¹é…æ ¼å¼re.compile(æ­£åˆ™è¡¨è¾¾å¼).findall(æ•°æ®)\n1 2 ce=re.compile(pat).findall(str) print(ce) #ç¤ºä¾‹ï¼šåŒ¹é….comå’Œ.cnç½‘å€ â€‹â€‹â€‹â€‹â€‹\n1 2 3 4 string=\u0026#34;\u0026lt;a href=\u0026#39;http://www.baidu.com\u0026#39;\u0026gt;ç™¾åº¦\u0026lt;/a\u0026gt;\u0026#34; pat=\u0026#34;[a-zA-Z]+://[^\\s]*[.com|.cn]\u0026#34; ce=re.search(pat,string) print(ce) #ç¤ºä¾‹ï¼šåŒ¹é…ç”µè¯å·ç  1 2 3 4 string=\u0026#34;adsgdiasdiauhdaj012-754745745dasd0773-46853415adasda\u0026#34; pat=\u0026#34;\\d{4}-\\d{7}|\\d{3}-\\d{8}\u0026#34; ce=re.compile(pat).findall(string) print(ce) ","date":"2019-09-07T16:45:11Z","image":"https://www.ownit.top/title_pic/41.jpg","permalink":"https://www.ownit.top/p/201909071645/","title":"Pythonçš„æ­£åˆ™è¡¨è¾¾å¼"},{"content":"å¼‚å¸¸å¤„ç† ç”±äºæˆ‘ç»å¸¸çˆ¬è™«ï¼Œä¼šå› ä¸ºç½‘ç»œï¼Œå­—ç¬¦ç¼–ç é›†ç­‰åŸå› è®©ç¨‹åºå´©æºƒï¼Œä»è€Œå¯¼è‡´ä»£ç åœæ­¢ã€‚\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¼‚å¸¸å¤„ç†ï¼Œä»è€Œä½¿ç¨‹åºè·³è¿‡å¼‚å¸¸ï¼Œä¿è¯ç¨‹åºå¯ä»¥ä¸åœæ­¢è¿è¡Œã€‚ å¼‚å¸¸å¤„ç†çš„æ ¼å¼ï¼ˆè¿™ä¸ªæ˜¯æœ€å¸¸è§çš„ä¸€ç§ï¼Œä¹Ÿæ˜¯æœ€å®ç”¨çš„ä¸€ç§ï¼‰ 1 2 3 4 tryï¼š ç¨‹åº except Exception as å¼‚å¸¸åç§°ï¼š å¼‚å¸¸å¤„ç†éƒ¨åˆ† ç¤ºä¾‹\n1 2 3 4 5 6 7 8 try: for i in range(0,10): print(i) if(i==4): print(ij) print(\u0026#34;hello\u0026#34;) except Exception as err: print(err) å¼‚å¸¸å¤„ç†è¿‡å 1 2 3 4 5 6 7 8 #è®©å¼‚å¸¸åçš„ç¨‹åºç»§ç»­ for i in range(0,10): try: print(i) if(i==4): print(ij) except Exception as err: print(err) ","date":"2019-09-05T14:17:46Z","image":"https://www.ownit.top/title_pic/72.jpg","permalink":"https://www.ownit.top/p/201909051417/","title":"Pythonçš„å¼‚å¸¸å¤„ç†"},{"content":"ç±»å’Œå¯¹è±¡ class ç±»å\nç±»é‡Œé¢çš„ä¸œè¥¿\n1 2 class c1: pass å®ä¾‹åŒ–ä¸€ä¸ªç±»\n1 a=c1() æ„é€ å‡½æ•° ï¼ˆæ„é€ æ–¹æ³•ï¼‰\n#selfï¼šåœ¨ç±»ä¸­çš„æ–¹æ³•å¿…é¡»åŠ ä¸Šseifå‚æ•°\n#__init__(self,å‚æ•°)\næ„é€ å‡½æ•°å®é™…æ„ä¹‰ï¼šåˆå§‹åŒ–\n1 2 3 class c2: def __init__(self): print(\u0026#34;å—å®«ä¹˜é£\u0026#34;) ç»™ç±»åŠ ä¸Šå‚æ•°ï¼šç»™æ„é€ æ–¹æ³•åŠ ä¸Šå‚æ•° 1 2 3 class c3: def __init__(self,name,job): print(\u0026#34;æˆ‘çš„åå­—\u0026#34;+name+\u0026#34;å·¥ä½œæ˜¯\u0026#34;+job) å±æ€§ï¼šç±»é‡Œé¢çš„å˜é‡ï¼šself.å±æ€§å\n1 2 3 4 class c4: def __init__(self,name,job): self.myname=name self.myjob=job æ–¹æ³•ï¼šç±»é‡Œé¢çš„å‡½æ•°ï¼šdef æ–¹æ³•åï¼ˆselfï¼Œå‚æ•°ï¼‰ 1 2 3 class c5: def fun1(self,name): print (\u0026#34;hello\u0026#34;+name) 1 2 3 4 5 class c6: def __init__(self,name): self.myname=name def fun2(self): print (\u0026#34;hello\u0026#34;+self.myname) ç»§æ‰¿ï¼ˆå•ç»§æ‰¿ï¼Œå¤šç»§æ‰¿ï¼‰\n#æŸä¸€ä¸ªå®¶åº­æœ‰çˆ¶äº²ï¼Œæ¯äº²ï¼Œå„¿å­ï¼Œå¥³å„¿\n#çˆ¶äº²å¯ä»¥è¯´è¯ï¼Œæ¯äº²å¯ä»¥å†™å­—\n#å„¿å­ç»§æ‰¿äº†çˆ¶äº²ï¼Œå¥³å„¿åŒæ—¶ç»§æ‰¿äº†çˆ¶æ¯,å¹¶ä¸”å¯å¬ä¸œè¥¿\n#å°å„¿å­ç»§æ‰¿äº†çˆ¶äº²ï¼Œä½†æ˜¯ä¼˜åŒ–äº†çˆ¶äº²çš„è¯´è¯èƒ½åŠ›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 #çˆ¶äº²ç±» class father(): def speak(self): print(\u0026#34;I can speak\u0026#34;) #å•ç»§æ‰¿ï¼šclasså­ç±»ï¼ˆçˆ¶äº²ï¼‰ #å„¿å­ç±» class son(father): pass #æ¯äº²ç±» class mother(): def write(self): print(\u0026#34;I can write\u0026#34;) #å¤šç»§æ‰¿ #å¥³å„¿ç±» class daugther(father,mother): def listen(self): print(\u0026#34;I can listen\u0026#34;) #é‡è½½ï¼šï¼ˆé‡è½½ï¼‰ #å°å„¿å­ç±» class son2(father): def speak(self): print(\u0026#34;I can speak2\u0026#34;) ","date":"2019-09-05T14:06:48Z","image":"https://www.ownit.top/title_pic/03.jpg","permalink":"https://www.ownit.top/p/201909051406/","title":"Pythonçš„ç±»å’Œå¯¹è±¡"},{"content":"ä¹˜æ³•å£è¯€è¡¨ 1 2 3 4 5 6 print(\u0026#34;ä¹˜æ³•å£è¯€è¡¨\u0026#34;) for i in range(1,10): for j in range(1,i+1): print(str(i)+str(\u0026#34;*\u0026#34;)+str(j)+\u0026#34;=\u0026#34;+str(i*j),end=\u0026#34; \u0026#34;) print()Â é€†å‘ä¹˜æ³•å£è¯€è¡¨\n1 2 3 4 5 6 print(\u0026#34;é€†å‘ä¹˜æ³•å£è¯€è¡¨\u0026#34;) for i in range(9,0,-1): for j in range(i,0,-1): print(str(i)+str(\u0026#34;*\u0026#34;)+str(j)+\u0026#34;=\u0026#34;+str(i*j),end=\u0026#34; \u0026#34;) print() ","date":"2019-09-05T13:57:11Z","image":"https://www.ownit.top/title_pic/07.jpg","permalink":"https://www.ownit.top/p/201909051357/","title":"Pythonä¹˜æ³•å£è¯€è¡¨"},{"content":"#æ–‡ä»¶æ“ä½œ #æ‰“å¼€ #open(\u0026ldquo;æ–‡ä»¶åœ°å€\u0026rdquo;ï¼Œ\u0026ldquo;æ“ä½œå½¢å¼â€™) å¸¸ç”¨å››ç§æ“ä½œæ¨¡å¼ \u0026rsquo;\u0026rsquo;\u0026rsquo;\nwï¼šå†™å…¥\nrï¼šè¯»å–\nbï¼šäºŒè¿›åˆ¶\na+:è¿½åŠ \n\u0026rsquo;''\n1 2 fh=open(\u0026#34;E:/Code/Python/python.txt\u0026#34;,\u0026#34;r\u0026#34;) date=fh.read() #æ–‡ä»¶è¯»å– 1 date=fh.read() #è¯»å–ä¸€è¡Œç±»å®¹ 1 line=fh.readline() #å…³é—­æ–‡ä»¶ 1 fh.close() #æ–‡ä»¶å†™å…¥ 1 2 3 4 date=\u0026#34;ä¸€èµ·å»å­¦ä¹ \u0026#34; fh2=open(\u0026#34;E:/Code/Python/python2.txt\u0026#34;,\u0026#34;w\u0026#34;) fh2.write(date) fh2.close() ","date":"2019-09-05T13:51:17Z","image":"https://www.ownit.top/title_pic/24.jpg","permalink":"https://www.ownit.top/p/201909051351/","title":"Pythonçš„æ–‡ä»¶æ“ä½œ"},{"content":"springmvcæ˜¯ä»€ä¹ˆ? Spring Web MVCæ˜¯ä¸€ç§åŸºäºJavaçš„å®ç°äº†Web MVCè®¾è®¡æ¨¡å¼çš„è¯·æ±‚é©±åŠ¨ç±»å‹çš„è½»é‡çº§Webæ¡†æ¶ï¼Œå³ä½¿ç”¨äº†MVCæ¶æ„æ¨¡å¼çš„æ€æƒ³ï¼Œå°†webå±‚\nè¿›è¡ŒèŒè´£è§£è€¦ï¼ŒåŸºäºè¯·æ±‚é©±åŠ¨æŒ‡çš„å°±æ˜¯ä½¿ç”¨è¯·æ±‚-å“åº”æ¨¡å‹ï¼Œæ¡†æ¶çš„ç›®çš„å°±æ˜¯å¸®åŠ©æˆ‘ä»¬ç®€åŒ–å¼€å‘ï¼ŒSpring Web MVCä¹Ÿæ˜¯è¦ç®€åŒ–æˆ‘ä»¬æ—¥å¸¸Webå¼€å‘çš„ã€‚\næœåŠ¡å™¨ç«¯åˆ†æˆä¸‰å±‚æ¡†æ¶ è¡¨ç°å±‚ï¼šSpringMVCÂ åŒ…å«JSPå’ŒServletç­‰ä¸WEBç›¸å…³çš„å†…å®¹\nä¸šåŠ¡å±‚ï¼šSpringæ¡†æ¶Â ä¸šåŠ¡å±‚ä¸­ä¸åŒ…å«JavaWeb APIï¼Œå®ƒåªå…³å¿ƒä¸šåŠ¡é€»è¾‘\næŒä¹…å±‚ï¼šMyBatisÂ å°è£…äº†å¯¹æ•°æ®åº“çš„è®¿é—®ç»†èŠ‚\nMVCè®¾è®¡æ¨¡å‹ MVC æ˜¯ä¸€ç§ä½¿ç”¨ MVCï¼ˆModel View Controller æ¨¡å‹-è§†å›¾-æ§åˆ¶å™¨ï¼‰è®¾è®¡åˆ›å»º Web åº”ç”¨ç¨‹åºçš„æ¨¡å¼ï¼š\nModelï¼ˆæ¨¡å‹ï¼‰è¡¨ç¤ºåº”ç”¨ç¨‹åºæ ¸å¿ƒï¼ˆæ¯”å¦‚æ•°æ®åº“è®°å½•åˆ—è¡¨ï¼‰ã€‚\nViewï¼ˆè§†å›¾ï¼‰æ˜¾ç¤ºæ•°æ®ï¼ˆæ•°æ®åº“è®°å½•ï¼‰ã€‚\nControllerï¼ˆæ§åˆ¶å™¨ï¼‰å¤„ç†è¾“å…¥ï¼ˆå†™å…¥æ•°æ®åº“è®°å½•ï¼‰ã€‚\nMVC æ¨¡å¼åŒæ—¶æä¾›äº†å¯¹ HTMLã€CSS å’Œ JavaScript çš„å®Œå…¨æ§åˆ¶ã€‚\n**Modelï¼ˆæ¨¡å‹ï¼‰**æ˜¯åº”ç”¨ç¨‹åºä¸­ç”¨äºå¤„ç†åº”ç”¨ç¨‹åºæ•°æ®é€»è¾‘çš„éƒ¨åˆ†ã€‚\né€šå¸¸æ¨¡å‹å¯¹è±¡è´Ÿè´£åœ¨æ•°æ®åº“ä¸­å­˜å–æ•°æ®ã€‚\n**Viewï¼ˆè§†å›¾ï¼‰**æ˜¯åº”ç”¨ç¨‹åºä¸­å¤„ç†æ•°æ®æ˜¾ç¤ºçš„éƒ¨åˆ†ã€‚\né€šå¸¸è§†å›¾æ˜¯ä¾æ®æ¨¡å‹æ•°æ®åˆ›å»ºçš„ã€‚\n**Controllerï¼ˆæ§åˆ¶å™¨ï¼‰**æ˜¯åº”ç”¨ç¨‹åºä¸­å¤„ç†ç”¨æˆ·äº¤äº’çš„éƒ¨åˆ†ã€‚\né€šå¸¸æ§åˆ¶å™¨è´Ÿè´£ä»è§†å›¾è¯»å–æ•°æ®ï¼Œæ§åˆ¶ç”¨æˆ·è¾“å…¥ï¼Œå¹¶å‘æ¨¡å‹å‘é€æ•°æ®ã€‚\n","date":"2019-08-30T15:03:46Z","image":"https://www.ownit.top/title_pic/47.jpg","permalink":"https://www.ownit.top/p/201908301503/","title":"ä¸‰å±‚æ¶æ„ä»‹ç»å’ŒMVCè®¾è®¡æ¨¡å‹ä»‹ç»"},{"content":" æºä»£ç ä¸‹è½½ï¼šhttps://www.lanzous.com/i5p4mvc * ç»„ä»¶æ‰«æ * @Componentï¼šè¡¨ç¤ºè¿™ä¸ªç±»éœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸­è¢«åˆ›å»º\n* @ComponentScanï¼šè‡ªåŠ¨å‘ç°åº”ç”¨ç¨‹åºä¸­è¢«åˆ›å»ºçš„ç±»\n*\n* è‡ªåŠ¨è£…é…\n* @Autowiredï¼šè‡ªåŠ¨æ»¡è¶³beanä¹‹é—´çš„ä¾èµ–\n*\n* å®šä¹‰é…ç½®ç±»\n* @Configurationï¼šè¡¨ç¤ºå½“å‰ç±»æ˜¯ä¸€ä¸ªé…ç½®ç±»\n* @Autowiredçš„ä½¿ç”¨æ–¹æ³• * 1ï¼šç”¨åœ¨æ„é€ å‡½æ•°ä¸Šï¼ˆå¤šç§ä¾èµ–çš„æƒ…å†µä¸‹ï¼‰\n* 2ï¼šç”¨åœ¨æˆå‘˜å˜é‡ä¸Š\n* 3ï¼šç”¨åœ¨setteræ–¹æ³•ä¸Š\n* 4ï¼šç”¨åœ¨ä»»æ„æ–¹æ³•ä¸Š\n* ä½¿ç”¨å•å…ƒæµ‹è¯•çš„æ–¹æ¡ˆ *\n* å¼•å…¥Springå•å…ƒæµ‹è¯•æ¨¡å—\n* mavenï¼šjunitï¼Œspring-test\n*\n* @RunWith(SpringJUnit4ClassRunner.class) åŠ è½½é…ç½®ç±»\n* @ContextConfiguration(class=AppConfig.class)\n","date":"2019-08-21T15:07:21Z","image":"https://www.ownit.top/title_pic/57.jpg","permalink":"https://www.ownit.top/p/201908211507/","title":"springçš„ç»„ä»¶ä½¿ç”¨"},{"content":"springæ¡†æ¶ Springæ¡†æ¶æ˜¯ç”±äºè½¯ä»¶å¼€å‘çš„å¤æ‚æ€§è€Œåˆ›å»ºçš„ã€‚Springä½¿ç”¨çš„æ˜¯åŸºæœ¬çš„JavaBeanæ¥å®Œæˆä»¥å‰åªå¯èƒ½ç”±EJBå®Œæˆçš„äº‹æƒ…ã€‚ç„¶è€Œï¼ŒSpringçš„ç”¨é€”ä¸ä»…ä»…é™äºæœåŠ¡å™¨ç«¯çš„å¼€å‘ã€‚ä»ç®€å•æ€§ã€å¯æµ‹è¯•æ€§å’Œæ¾è€¦åˆæ€§è§’åº¦è€Œè¨€ï¼Œç»å¤§éƒ¨åˆ†Javaåº”ç”¨éƒ½å¯ä»¥ä»Springä¸­å—ç›Šã€‚\nâ—†ç›®çš„ï¼šè§£å†³ä¼ä¸šåº”ç”¨å¼€å‘çš„å¤æ‚æ€§\nâ—†åŠŸèƒ½ï¼šä½¿ç”¨åŸºæœ¬çš„JavaBeanä»£æ›¿EJBï¼Œå¹¶æä¾›äº†æ›´å¤šçš„ä¼ä¸šåº”ç”¨åŠŸèƒ½\nâ—†èŒƒå›´ï¼šä»»ä½•Javaåº”ç”¨\nSpringæ˜¯ä¸€ä¸ªè½»é‡çº§æ§åˆ¶åè½¬(IoC)å’Œé¢å‘åˆ‡é¢(AOP)çš„å®¹å™¨æ¡†æ¶ã€‚\nä¼˜ç‚¹ â—†JAVA EEåº”è¯¥æ›´åŠ å®¹æ˜“ä½¿ç”¨ã€‚\nâ—†é¢å‘å¯¹è±¡çš„è®¾è®¡æ¯”ä»»ä½•å®ç°æŠ€æœ¯ï¼ˆæ¯”å¦‚JAVA EEï¼‰éƒ½é‡è¦ã€‚\nâ—†é¢å‘æ¥å£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯é’ˆå¯¹ç±»ç¼–ç¨‹ã€‚Springå°†ä½¿ç”¨æ¥å£çš„å¤æ‚åº¦é™ä½åˆ°é›¶ã€‚ï¼ˆé¢å‘æ¥å£ç¼–ç¨‹æœ‰å“ªäº›å¤æ‚åº¦ï¼Ÿï¼‰\nâ—†ä»£ç åº”è¯¥æ˜“äºæµ‹è¯•ã€‚Springæ¡†æ¶ä¼šå¸®åŠ©ä½ ï¼Œä½¿ä»£ç çš„æµ‹è¯•æ›´åŠ ç®€å•ã€‚\nâ—†JavaBeanæä¾›äº†åº”ç”¨ç¨‹åºé…ç½®çš„æœ€å¥½æ–¹æ³•ã€‚\nâ—†åœ¨Javaä¸­ï¼Œå·²æ£€æŸ¥å¼‚å¸¸ï¼ˆChecked exceptionï¼‰è¢«è¿‡åº¦ä½¿ç”¨ã€‚æ¡†æ¶ä¸åº”è¯¥è¿«ä½¿ä½ æ•è·ä¸èƒ½æ¢å¤çš„å¼‚å¸¸ã€‚\nIDEAä½¿ç”¨mavenæ­å»ºspringé¡¹ç›® ideaå»ºç«‹springé¡¹ç›®ç›¸å½“æ–¹ä¾¿ , å¯ä»¥è‡ªåŠ¨ç”Ÿæˆspringé…ç½®æ–‡ä»¶ , å’Œè‡ªåŠ¨å¯¼å…¥Springæ‰€éœ€jaråŒ….\nFileâ€”\u0026gt;newâ€”\u0026gt;projectâ€”\u0026gt;Maven\né€‰æ‹©æœ¬åœ°çš„jdkï¼Œä¸‹ä¸€æ­¥\nå¯ä»¥æ ¹æ®è‡ªå·±éœ€æ±‚å¡«å†™ï¼ˆæ²¡æœ‰ä»€ä¹ˆé™åˆ¶ï¼‰\né€‰æ‹©é¡¹ç›®å­˜å‚¨çš„ä½ç½®ï¼Œåœ¨ç‚¹å‡»å®Œæˆå°±å¯ä»¥ã€‚æ­¤æ—¶ä¸€ä¸ªMavenå·²ç»å»ºç«‹æˆåŠŸã€‚\nä¸‹é¢ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ·»åŠ springä¾èµ–å’ŒjaråŒ…\nåœ¨pom.xmlçš„æ–‡ä»¶ä¸‹æ·»åŠ ä¾èµ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;dependencies\u0026gt; \u0026lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-context --\u0026gt; \u0026lt;!--springçš„æ ¸å¿ƒä¾èµ–--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-context\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.3.13.RELEASE\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!--log4jçš„æ—¥å¿—æ–‡ä»¶--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;log4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;log4j\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.12\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; åŠ å…¥è¿™æ®µä»£ç ï¼Œideaçš„å³ä¸‹è§’ä¼šå‡ºç°è®©ä½ å¯¼åŒ…çš„é€‰é¡¹ï¼Œä½ å¯ä»¥ç‚¹å‡»ç¬¬ä¸€ä¸ªï¼Œå¯¼å…¥jaråŒ… å¥½çš„ï¼Œç°åœ¨springçš„æ ¸å¿ƒåŒ…å·²ç»å¯¼å…¥ï¼Œä¸‹é¢å¼€å§‹ç»ƒä¹ ã€‚\næ•´ä½“é¡¹ç›®ç»“æœå›¾\né¦–å…ˆï¼Œå»ºä¸¤ä¸ªç±»\nMessagesServiceÂ ï¼šæ¶ˆæ¯\nMessagePrinterÂ ï¼šÂ æ‰“å°æœº\nå°±æ˜¯ä½¿ç”¨æ‰“å°æœºæ‰“å°æ¶ˆæ¯ï¼Œå°±è¿™ä¹ˆç®€å•ã€‚\nä¹Ÿå°±æ˜¯è¦MessagePrinterè¿™ä¸ªç±»è°ƒç”¨MessagesService ç±»æ¥è¾“å‡ºæ¶ˆæ¯ã€‚\nMessagesServiceÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 package hello; /** * æ‰“å° */ public class MessagesService { // æ— å‚æ„é€ å‡½æ•° public MessagesService() { super(); System.out.println(\u0026#34;MessageService..\u0026#34;); } public String getMessage(){ return \u0026#34;Hello Word\u0026#34;; } } MessagePrinterÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package hello; /** * æ‰“å°æœº */ public class MessagePrinter { /** * æ— å‚æ„é€ å‡½æ•° */ public MessagePrinter() { super(); System.out.println(\u0026#34;MessagePinter..\u0026#34;); } /** * å»ºç«‹å’ŒMessageServiceçš„å…³è”å…³ç³» */ private MessagesService service; /** * è®¾ç½®serviceçš„å€¼ * @param service */ public void setService(MessagesService service) { this.service = service; } public void printMessage(){ System.out.println(this.service.getMessage()); } } ï¼ˆ1ï¼‰ä½¿ç”¨ä¼ ç»Ÿçš„è°ƒç”¨æ–¹æ³• åˆ›å»ºApplicationç±»ã€‚\nApplication\n1 2 3 4 5 6 7 8 9 10 11 12 13 package hello; public class Application { public static void main(String[] args) { System.out.println(\u0026#34;appliction\u0026#34;); //åˆ›å»ºæ‰“å°æœºå¯¹è±¡ MessagePrinter printer=new MessagePrinter(); //åˆ›å»ºæ¶ˆæ¯æœåŠ¡å¯¹è±¡ MessagesService service=new MessagesService(); //è®¾ç½®æ‰“å°æœºå¯¹è±¡çš„serviceå±æ€§ printer.setService(service); printer.printMessage(); } } ç‚¹å‡»ç»¿è‰²å›¾æ ‡ï¼Œç‚¹å‡»ç¬¬ä¸€ä¸ªè¿è¡Œ\nè¿è¡Œç»“æ„\nå·²ç»æˆåŠŸè¿è¡Œï¼Œå¹¶è¾“å‡ºã€‚\nï¼ˆ2ï¼‰springçš„æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨ åœ¨resourcesä¸‹å»ºç«‹applicationContext.xmlé…ç½®æ–‡ä»¶\napplicationContext.xml\n1 2 3 4 5 6 7 8 9 10 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;beans xmlns=\u0026#34;http://www.springframework.org/schema/beans\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd\u0026#34;\u0026gt; \u0026lt;bean id=\u0026#34;service\u0026#34; class=\u0026#34;hello.MessagesService\u0026#34;\u0026gt;\u0026lt;/bean\u0026gt; \u0026lt;bean id=\u0026#34;printer\u0026#34; class=\u0026#34;hello.MessagePrinter\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;service\u0026#34; ref=\u0026#34;service\u0026#34;\u0026gt;\u0026lt;/property\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;/beans\u0026gt; åœ¨javaçš„helloä¸‹åˆ›å»ºApplicationspringç±»\nApplicationspring\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package hello; import org.springframework.context.ApplicationContext; import org.springframework.context.support.ClassPathXmlApplicationContext; public class Applicationspring { public static void main(String[] args) { System.out.println(\u0026#34;applictionspring\u0026#34;); //åˆå§‹åŒ–springå®¹å™¨ ApplicationContext context; context = new ClassPathXmlApplicationContext(\u0026#34;applicationContext.xml\u0026#34;); //ä»å®¹å™¨ä¸­è·å–MessagePrinterå¯¹è±¡ MessagePrinter printer=context.getBean(MessagePrinter.class); printer.printMessage(); } } ç‚¹å‡»è¿è¡Œ\nç»“æœ\nï¼ˆ3ï¼‰æ·»åŠ log4j.propertiesæ—¥å¿—\nlog4j.properties\n1 2 3 4 5 6 7 log4j.rootCategory=INFO, stdout log4j.appender.stdout=org.apache.log4j.ConsoleAppender log4j.appender.stdout.layout=org.apache.log4j.PatternLayout log4j.appender.stdout.layout.ConversionPattern=%d{ABSOLUTE} %5p %t %c{2}:%L - %m%n log4j.category.org.springframework.beans.factory=DEBUG å†æ¬¡è¿è¡Œï¼Œä¼šå‡ºç°å„ç§ç›¸å…³çš„æ—¥å¿—\n","date":"2019-08-21T14:32:48Z","image":"https://www.ownit.top/title_pic/32.jpg","permalink":"https://www.ownit.top/p/201908211432/","title":"IDEAä½¿ç”¨mavenæ­å»ºspringé¡¹ç›®"},{"content":"MarkdownPad 2Â æ˜¯ä¸€æ¬¾è¾ƒä¸é”™çš„Markdownç¼–è¾‘å™¨ï¼Œå¯å¿«é€Ÿå°†æ–‡æœ¬è½¬æ¢ä¸ºç¾è§‚çš„HTML/XHTMLçš„ç½‘é¡µæ ¼å¼ä»£ç ï¼Œä¸”æ“ä½œæ–¹ä¾¿ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡é”®ç›˜å¿«æ·é”®å’Œå·¥å…·æ æŒ‰é’®æ¥ä½¿ç”¨æˆ–è€…ç§»é™¤Markdownæ ¼å¼ï¼Œå·¦å³æ çš„åˆ†å‰²æ–¹å¼ä»¤ç”¨æˆ·å¯ä»¥å®æ—¶çœ‹åˆ° HTML æ ¼å¼çš„ Markdown æ–‡æ¡£ã€‚å¦‚æœä½ å–œæ¬¢åœ¨ç®€ä¹¦ã€CSDNç­‰å¹³å°å‘è¡¨æ–‡ç« ï¼Œä¹Ÿæƒ³æŒæ¡è¿™é—¨ç®€å•çš„è½»é‡çº§çš„æ ‡è®°è¯­è¨€Markdownï¼Œåˆæ‹…å¿ƒç¦»çº¿æ— å¤„ç¼–è¾‘ï¼Œæ¬¢è¿å°è¯•ã€‚\nå…·ä½“æ–¹æ³•å’Œèµ„æºå¦‚ä¸‹ï¼š\nstep1.è§£å‹MarkdownPad 2\nåœ°å€ï¼šhttps://www.lanzous.com/i47m59c\nstep2.æ‰¾åˆ°æ ¹ç›®å½•ä¸‹MarkdownPad 2åº”ç”¨ç¨‹åºï¼Œè¿è¡Œå¹¶ç ´è§£\n1 2 3 4 5 Email address : Soar360@live.com License key : GBPduHjWfJU1mZqcPM3BikjYKF6xKhlKIys3i1MU2eJHqWGImDHzWdD6xhMNLGVpbP2M5SN6bnxn2kSE8qHqNY5QaaRxmO3YSMHxlv2EYpjdwLcPwfeTG7kUdnhKE0vVy4RidP6Y2wZ0q74f47fzsZo45JE2hfQBFi2O9Jldjp1mW8HUpTtLA2a5/sQytXJUQl/QKO0jUQY4pa5CCx20sV1ClOTZtAGngSOJtIOFXK599sBr5aIEFyH0K7H4BoNMiiDMnxt1rD8Vb/ikJdhGMMQr0R4B+L3nWU97eaVPTRKfWGDE8/eAgKzpGwrQQoDh+nzX1xoVQ8NAuH+s4UcSeQ== step3.å¦‚æœæ˜¯win10è¿˜éœ€è¦å®‰è£…ä¸€ä¸ªç»„ä»¶ awesomium_v1.6.6_sdk_winï¼Œå¦åˆ™ä¼šå‡ºç°é”™è¯¯æç¤º\nä¸‹è½½åœ°å€ï¼šhttps://pan.baidu.com/s/1qY7LKba##step\nstep4:æœ€åé‡å¯MarkdownPad 2å°±å¯ä»¥ç”¨äº†!\næ³¨ï¼šå¦‚æœæ˜¯è‹±æ–‡ç‰ˆï¼Œå¯åˆ°tools-\u0026gt;optionsä¿®æ”¹ï¼Œå†é‡å¯å³å¯\n","date":"2019-05-18T21:47:15Z","image":"https://www.ownit.top/title_pic/13.jpg","permalink":"https://www.ownit.top/p/201905182147/","title":"MarkdownPad 2ç ´è§£"},{"content":"å‰é¢æ­å»ºJavaç¯å¢ƒå’Œtomcatç¯å¢ƒã€‚\nä¸‹é¢è¿›è¡Œå®æˆ˜ï¼Œæ­å»ºejforumè®ºå›\nejforumè®ºå›æºç ï¼šhttps://www.lanzous.com/i45rcoh\nCentos7å®‰è£…MySQLæ•°æ®åº“ Centos7å®‰è£…JDKç¯å¢ƒé…ç½® Centos7å®‰è£…å’Œé…ç½®Tomcat8 okï¼Œä¸‹é¢è¿›è¡Œè®ºå›æ­å»º\nå‰æï¼šä»¥ä¸Šä¸‰ä¸ªé…ç½®å·²ç»æ­å»ºå®Œæˆã€‚\nï¼ˆ1ï¼‰ä½¿ç”¨mysqlåˆ›å»ºæ•°æ®åº“\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 mysql\u0026gt; create database ejforum; Query OK, 1 row affected (0.00 sec) mysql\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | ejforum | | mysql | | performance_schema | +--------------------+ 4 rows in set (0.00 sec) mysql\u0026gt; GRANT all ON ejforum.* TO \u0026#34;ejforum\u0026#34;@\u0026#34;localhost\u0026#34; IDENTIFIED BY \u0026#34;ejforum\u0026#34;; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; flush privileges; Query OK, 0 rows affected (0.00 sec) ï¼ˆ2ï¼‰å®‰è£…mysqlè¿æ¥å™¨ï¼ˆé©±åŠ¨åŒ…ï¼‰ä¸‹è½½åœ°å€ï¼šhttps://dev.mysql.com/downloads/connector/j/5.1.html\n1 2 3 4 5 6 7 [root@wei mysql-connector-java-5.1.47]# tar zxf mysql-connector-java-5.1.47.tar.gz [root@wei mysql-connector-java-5.1.47]# ls build.xml mysql-connector-java-5.1.47-bin.jar README.txt CHANGES mysql-connector-java-5.1.47.jar src COPYING README [root@wei mysql-connector-java-5.1.47]# cp mysql-connector-java-5.1.47.jar /usr/local/tomcat/lib/ ï¼ˆ3ï¼‰è§£å‹ejforumå‹ç¼©åŒ…ï¼Œå¹¶æ‹·è´åˆ°ç½‘ç«™çš„ç›®å½•\n1 2 3 [root@wei ejforum-2.3]# rm -rf /usr/local/tomcat/webapps/ROOT/* [root@wei ~]# unzip ejforum2.3.zip 1 2 3 4 5 6 [root@wei ~]# cd ejforum-2.3/ [root@wei ejforum-2.3]# ls ejforum install [root@wei ~]# cd ejforum [root@wei ejforum-2.3]# cp -r * /usr/local/tomcat/webapps/ROOT/ ï¼ˆ4ï¼‰ç¼–è¾‘WEB-INFæ–‡ä»¶ï¼ŒæŒ‡å®šè¿æ¥MYSQLæ•°æ®åº“ç”¨æˆ·\n1 2 3 [root@wei ejforum]# vim /usr/local/tomcat/webapps/ROOT/WEB-INF/conf/config.xml [root@wei conf]# pwd /usr/local/tomcat/webapps/ROOT/WEB-INF/conf 1 2 3 4 5 6 DB Connection Pool - Mysql \u0026lt;database maxActive=\u0026#34;10\u0026#34; maxIdle=\u0026#34;10\u0026#34; minIdle=\u0026#34;2\u0026#34; maxWait=\u0026#34;10000\u0026#34; username=\u0026#34;ejforum\u0026#34; password=\u0026#34;ejforum\u0026#34; driverClassName=\u0026#34;com.mysql.jdbc.Driver\u0026#34; url=\u0026#34;jdbc:mysql://localhost:3306/ejforum?characterEncoding=gbk\u0026amp;amp;autoReconnect=true\u0026amp;amp;autoReconnectForPools=true\u0026amp;amp;zeroDateTimeBehavior=convertToNull\u0026#34; sqlAdapter=\u0026#34;sql.MysqlAdapter\u0026#34;/\u0026gt; ï¼ˆ5ï¼‰é‡å¯tomcatæœåŠ¡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@wei conf]# /usr/local/tomcat/bin/shutdown.sh Using CATALINA_BASE: /usr/local/tomcat Using CATALINA_HOME: /usr/local/tomcat Using CATALINA_TMPDIR: /usr/local/tomcat/temp Using JRE_HOME: /usr/java/jdk-12.0.1 Using CLASSPATH: /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar NOTE: Picked up JDK_JAVA_OPTIONS: --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED [root@wei conf]# /usr/local/tomcat/bin/startup.sh Using CATALINA_BASE: /usr/local/tomcat Using CATALINA_HOME: /usr/local/tomcat Using CATALINA_TMPDIR: /usr/local/tomcat/temp Using JRE_HOME: /usr/java/jdk-12.0.1 Using CLASSPATH: /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar Tomcat started. ","date":"2019-05-14T23:48:18Z","image":"https://www.ownit.top/title_pic/41.jpg","permalink":"https://www.ownit.top/p/201905142348/","title":"Centos7éƒ¨ç½²ejforumè®ºå›ï¼ˆJava+tomcat+mysqlï¼‰"},{"content":"ç¬¬ä¸€æ­¥ï¼šä¸‹è½½Tomcat8å‹ç¼©åŒ…\nè¿›å…¥Â http://tomcat.apache.org/download-80.cgi\nä¸‹è½½tar.gzå‹ç¼©åŒ…\nç¬¬äºŒæ­¥ï¼šç”¨xshellå·¥å…·æŠŠå‹ç¼©åŒ…ä¸Šä¼ åˆ°/home/data/ä¸‹\nç¬¬ä¸‰æ­¥ï¼šè§£å‹ä»¥åŠæ–°å»ºç›®å½•\n1 [root@wei data]# tar -zxvf apache-tomcat-8.5.40.tar.gz æˆ‘ä»¬æ–°å»º/home/tomcat/ç›®å½• æŠŠtomcatå‰ªåˆ‡è¿›å»\nç¬¬å››æ­¥ï¼šé…ç½®tomcat server.xml\nserver.xmlå¯ä»¥é…ç½®ç«¯å£ï¼Œç¼–ç ä»¥åŠé…ç½®é¡¹ç›®ç­‰ç­‰ï¼Œæˆ‘ä»¬è¿™é‡Œå°±é…ç½®ä¸€ä¸ªç«¯å£ï¼ŒæŠŠé»˜è®¤çš„8080\nvi /home/tomcat/apache-tomcat-8.5.16/conf/server.xml\nç¬¬äº”æ­¥ï¼šé…ç½®é˜²ç«å¢™ï¼Œå¼€æ”¾8080ç«¯å£\nfirewall-cmd --zone=public --add-port=8080/tcp --permanent\nfirewall-cmd --reload\nç¬¬å…­æ­¥ï¼šå¯åŠ¨tomcat\n1 [root@wei home]# /home/tomcat/apache-tomcat-8.5.40/bin/startup.sh ä¸‹é¢æ˜¯tomcatå¯åŠ¨çš„ç•Œé¢ï¼ˆç«¯å£8080ï¼‰\nä¸‹é¢æ˜¯httpdå¯åŠ¨çš„ç•Œé¢ï¼ˆç«¯å£80ï¼‰\n","date":"2019-05-14T22:31:52Z","image":"https://www.ownit.top/title_pic/34.jpg","permalink":"https://www.ownit.top/p/201905142231/","title":"Centos7å®‰è£…å’Œé…ç½®Tomcat8"},{"content":"ä½œä¸ºä¸€åç¨‹åºå‘˜ï¼Œå„ç§ç¯å¢ƒæ­å»ºéƒ½è¦ä¼šã€‚\nä¸‹é¢ä»‹ç»å…³äºLinuxæ“ä½œç³»ç»Ÿä¹‹centos7ï¼ˆ64ä½ï¼‰å®‰è£…JDKä»¥åŠç¯å¢ƒé…ç½®ã€‚\nä¸‹é¢å¼€å§‹å­¦ä¹ å§\næŸ¥çœ‹å¹¶å¸è½½CentOSè‡ªå¸¦çš„OpenJDK å®‰è£…å¥½çš„CentOSä¼šè‡ªå¸¦OpenJdk,ç”¨å‘½ä»¤ java -version ï¼Œä¼šæœ‰ä¸‹é¢çš„ä¿¡æ¯ï¼š 1 2 3 java version \u0026#34;1.6.0\u0026#34; OpenJDK Runtime Environment (build 1.6.0-b09) OpenJDK 64-Bit Server VM (build 1.6.0-b09, mixed mode) æœ€å¥½è¿˜æ˜¯å…ˆå¸è½½æ‰openjdk,åœ¨å®‰è£…sunå…¬å¸çš„jdk.\nå…ˆæŸ¥çœ‹ rpm -qa | grep java æ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š\n1 2 java-1.4.2-gcj-compat-1.4.2.0-40jpp.115 java-1.6.0-openjdk-1.6.0.0-1.7.b09.el5 å¸è½½ï¼š\n1 2 rpm -e --nodeps java-1.4.2-gcj-compat-1.4.2.0-40jpp.115 rpm -e --nodeps java-1.6.0-openjdk-1.6.0.0-1.7.b09.el5 STEP 1ï¼š\nç°åœ¨JDK12éƒ½å‡ºæ¥äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¦ç´§è·Ÿç€æŠ€æœ¯çš„æ½®æµèµ°ã€‚\næ‰€æœ‰ä¸‹è½½çš„jdk-12.0.1_linux-x64_bin.rpm\nå®˜ç½‘é“¾æ¥ï¼šJDKå®˜ç½‘ä¸‹è½½\né€‰æ‹©ä¸è‡ªå·±ç³»ç»Ÿç›¸åŒ¹é…çš„ç‰ˆæœ¬ï¼Œæˆ‘çš„æ˜¯Centos7 64ä½çš„ï¼Œæ‰€ä»¥å¦‚æœæ˜¯æˆ‘çš„æ˜¯jdk-12.0.1_linux-x64_bin.rpm\nSTEP 2ï¼š\nåˆ©ç”¨Xshellå·¥å…·è¿›è¡ŒLinuxå‘½ä»¤å¤„ç†ï¼Œè¿›è¡Œå®‰è£…ã€‚\nè¿›è¡Œrpmå®‰è£…jdk\n1 [root@wei ~]# rpm -ivh jdk-12.0.1_linux-x64_bin.rpm ä¸‹é¢ä»¥åŠå®‰è£…æˆåŠŸè¿‡jdkã€‚\næ³¨æ„ï¼šå®‰è£…æˆåŠŸï¼Œä½†æ˜¯ç¯å¢ƒå˜é‡æ²¡æœ‰é…ç½®ï¼Œéœ€è¦é…ç½®ç¯å¢ƒå˜é‡ã€‚\nï¼ˆ1ï¼‰æ‰¾åˆ°jdkå®‰è£…è·¯å¾„\n1 2 3 4 5 [root@wei ~]# cd /usr/java/jdk-12.0.1/ [root@wei jdk-12.0.1]# ls bin conf include jmods legal lib man release [root@wei jdk-12.0.1]# pwd /usr/java/jdk-12.0.1 ï¼ˆ2ï¼‰å¤åˆ¶è·¯å¾„ï¼Œå¼€å§‹é…ç½®ç¯å¢ƒå˜é‡ï¼ˆ/usr/java/jdk-12.0.1ï¼‰\nç¼–è¾‘ï¼š/etc/profileæ–‡ä»¶ï¼Œåœ¨æœ€åé¢åŠ å…¥ä¸‹é¢çš„ä»£ç \n1 2 export JAVA_HOME=/usr/java/jdk-12.0.1 export PATH=$PATH:JAVA_HOME/bin 1 [root@wei jdk-12.0.1]# source /etc/profile ï¼ˆ3ï¼‰ä¿å­˜ï¼Œé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶\nï¼ˆ4ï¼‰æŸ¥çœ‹jdkçš„é…ç½®ä¿¡æ¯ï¼Œçœ‹æ˜¯å¦é…ç½®å®Œæˆ\n1 [root@wei jdk-12.0.1]# java -version okï¼Œjdkå·²ç»æˆåŠŸå®‰è£…æˆåŠŸã€‚æ­å–œä½ æœ‰å­¦ä¼šä¸€ä¸ªæ–°çš„æŠ€èƒ½ã€‚ åŠ æ²¹ã€‚","date":"2019-05-14T21:52:01Z","image":"https://www.ownit.top/title_pic/59.jpg","permalink":"https://www.ownit.top/p/201905142152/","title":"Centos7å®‰è£…JDKç¯å¢ƒé…ç½®"},{"content":"ä¸€ã€pythonçš„ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š ä¼˜ç¾ã€æ¸…æ™°ã€ç®€å• é«˜çº§è¯­è¨€ å¼€å‘æ•ˆç‡é«˜ å¯ç§»æ¤æ€§ã€å¯æ‹“å±•æ€§ã€å¯åµŒå…¥æ€§ ç¼ºç‚¹ï¼š è¿è¡Œé€Ÿåº¦æ…¢ ä»£ç ä¸èƒ½åŠ å¯† çº¿ç¨‹ä¸èƒ½åˆ©ç”¨å¤šCPU äºŒã€python2ä¸python3çš„åŒºåˆ« ä»£ç ï¼š python2ï¼šä»£ç æ··ä¹±ï¼Œé‡å¤ä»£ç è¾ƒå¤šï¼Œå†—ä½™ python3ï¼šä»£ç å´‡å°šä¼˜ç¾ã€æ¸…æ™°ã€ç®€å• printï¼š python2ï¼šprintæ˜¯ä¸€ä¸ªè¯­å¥ python3ï¼šprintæ˜¯ä¸€ä¸ªå‡½æ•° inputï¼š python2ï¼šraw_input()æ¥æ”¶å­—ç¬¦ä¸²ï¼Œinput()æ¥æ”¶æ•°å­— python3ï¼šinput()æ¥æ”¶çš„å…¨éƒ¨æ˜¯å­—ç¬¦ä¸² ç¼–ç æ–¹å¼ï¼š python2ï¼šé»˜è®¤ç¼–ç æ˜¯ASCIIç ï¼ˆè‹¥æƒ³ä½¿ç”¨ä¸­æ–‡ï¼š#_*_coding:utf-8_*_ï¼‰ python3ï¼šé»˜è®¤ç¼–ç æ˜¯utf-8ï¼Œæ”¯æŒä¸­æ–‡ ä¸ç­‰è¿ç®—ç¬¦ï¼š python2ï¼šå¯ä»¥ä½¿ç”¨!=æˆ–è€…\u0026gt;\u0026lt; python3ï¼šåªèƒ½ä½¿ç”¨!= åˆ›å»ºè¿­ä»£è®¡æ•°å™¨ï¼š python2ï¼šxrange python3ï¼šrange reprï¼š python2ï¼šreprå¯ä»¥æ˜¯è¯­å¥ python3ï¼šåªå…è®¸ä½¿ç”¨repr()å‡½æ•° æ–‡ä»¶ï¼š python2ï¼šå¯ä»¥ä½¿ç”¨!=æˆ–è€…\u0026gt;\u0026lt; python3ï¼šåªèƒ½ä½¿ç”¨!= æ•´å‹ï¼š python2ï¼šå­˜åœ¨longå‹ python3ï¼šå…¨éƒ¨ä¸ºintå‹ ä¿®æ”¹è¯­æ³•ï¼š python2ï¼šå­—å…¸çš„keysï¼Œvaluesï¼Œitemsä»¥åŠmapï¼Œfilterï¼Œreduceè¿”å›çš„éƒ½æ˜¯ä¸€ä¸ªåˆ—è¡¨ python3ï¼šå­—å…¸çš„keysï¼Œvaluesï¼Œitemsä»¥åŠmapï¼Œfilterï¼Œreduceè¿”å›ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ æ–°å¢è¯­æ³•ï¼š python2ï¼šprintå’Œexecè¯­å¥ï¼Œæ— nolocalç­‰æ–¹æ³• python3ï¼šprintå’Œexecæ”¹ä¸ºå‡½æ•°ï¼Œæ–°å¢nolocalç­‰æ–¹æ³• ç»§æ‰¿ï¼š python2ï¼šé»˜è®¤ç»å…¸ç±»ï¼ˆæ–°å¼ç±»éœ€è¦(object)ï¼‰ python3ï¼šåªæœ‰æ–°å¼ç±» ä¸‰ã€å¼€å‘çš„ç§ç±» ç¼–è¯‘å‹ ç¼ºç‚¹ï¼šæ’é”™æ…¢ï¼Œå¼€å‘æ•ˆç‡ä½ï¼Œä¸å¯ç§»æ¤\nä¼˜ç‚¹ï¼šæ‰§è¡Œæ•ˆç‡é«˜\nå…¸å‹ï¼šCè¯­è¨€ï¼Œgoè¯­è¨€\nè§£é‡Šå‹ ç¼ºç‚¹ï¼šæ‰§è¡Œæ•ˆç‡ä½\nä¼˜ç‚¹ï¼šæ’é”™å¿«ï¼Œå¼€å‘æ•ˆç‡é«˜ï¼Œå¯ç§»æ¤\nå…¸å‹ï¼špythonï¼ŒPHP\næ··åˆå‹ å…¸å‹ï¼šjavaï¼ŒC#\nå››ã€pythonçš„ç§ç±» Cpythonï¼šåŸºäºCè¯­è¨€å¼€å‘çš„\nlpython\nJpython\nPyPyï¼šç›®å‰æ‰§è¡Œæœ€å¿«çš„\näº”ã€å˜é‡ä¸å¸¸é‡ å¸¸é‡ï¼šä¸€ç›´ä¸å˜çš„é‡ï¼Œçº¦å®šä¿—ç§°ï¼Œå…¨éƒ¨å¤§å†™ä¸ºå¸¸é‡\nå˜é‡ï¼šæŠŠç¨‹åºçš„è¿è¡Œç»“æœå­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œä»¥ä¾¿åæœŸä»£ç çš„è°ƒç”¨\nè¦æ±‚ï¼š\nå¿…é¡»ç”±æ•°å­—ã€å­—æ¯ã€ä¸‹åˆ’çº¿ç»„æˆ ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ ä¸èƒ½æ˜¯å…³é”®å­— ä¸èƒ½æ˜¯ä¸­æ–‡ï¼Œä¸èƒ½å¤ªé•¿ï¼Œè¦æœ‰å¯æè¿°æ€§ å®˜ç½‘æ¨èä¸‹åˆ’çº¿old_boyå’Œé©¼å³°ä½“OldBoy ","date":"2019-05-12T21:48:08Z","image":"https://www.ownit.top/title_pic/12.jpg","permalink":"https://www.ownit.top/p/201905122148/","title":"PythonåŸºç¡€çŸ¥è¯†"},{"content":"ç¯å¢ƒï¼šCentos7\nå·¥å…·ï¼šmysqlï¼Œphpï¼Œhttpd\nç›®çš„ï¼šç†Ÿç»ƒæŒæ¡httpdæœåŠ¡å™¨æ­å»ºå’Œä¸ªæœåŠ¡å™¨ä¹‹é—´çš„é…åˆã€‚\næœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥æ¥å®è·µä¸€ä¸‹ï¼Œæˆ‘ä¼šæä¾›å„ç§æºç è¿›è¡Œæ­å»ºã€‚\nç½‘ç»œå®¶å›­å’Œè®ºå›****æºç ï¼šhttps://www.lanzous.com/i3yqq3c\nï¼ˆ1ï¼‰å‡†å¤‡ä¸€å°centosæœåŠ¡å™¨ï¼Œæˆ‘æ˜¯åœ¨è™šæ‹Ÿæœºæ­å»ºçš„centos7.\nï¼ˆ2ï¼‰å…³é—­é˜²ç«å¢™å’Œselinuxç­‰ï¼ˆcentos7å…³é—­é˜²ç«å¢™å’Œselinuxï¼‰\nï¼ˆ3ï¼‰æ­å»ºmyqlæ•°æ®åº“ï¼ˆMySQLçš„rpmå®‰è£…æ•™ç¨‹ï¼‰\nï¼ˆ4ï¼‰æ­å»ºhttpdæœåŠ¡å™¨ï¼ˆcentos7è‡ªå¸¦httpdï¼Œåªéœ€è¦å¯åŠ¨å³å¯ç”¨ï¼‰\nï¼ˆ5ï¼‰å®‰è£…PHPæœåŠ¡å™¨\n**å®‰è£…** 1 [root@wei ~]# yum install php â€“y å®‰è£…php-mysql\n1 [root@wei ~]# yum install php-mysql â€“y 2.æµ‹è¯•phpå’ŒapacheååŒ\næµ‹è¯•ååŒ\n1 [root@localhost ~]# cd /var/www/html/ 1 2 3 4 5 6 7 8 9 [root@localhost html]# vim phpinfo.php \u0026lt;?php phpinfo(); ?\u0026gt; **Â æµ‹è¯•ï¼š http://IP/phpinfo.php**\næµ‹è¯•phpå’ŒMySQLååŒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@localhost html]# vim php_mysql.php \u0026lt;?php $servername = \u0026#34;localhost\u0026#34;; $username = \u0026#34;admin\u0026#34;; $password = \u0026#34;123456\u0026#34;; // åˆ›å»ºè¿æ¥ //$con = mysql_connect($servername,$username,$password); $conn = new mysqli($servername, $username, $password); // æ£€æµ‹è¿æ¥ if ($conn-\u0026gt;connect_error) { die(\u0026#34;è¿æ¥å¤±è´¥: \u0026#34; . $conn-\u0026gt;connect_error); } echo \u0026#34;è¿æ¥æˆåŠŸ\u0026#34;; ?\u0026gt; **Â æµ‹è¯•ï¼š http://IP/php_mysql.php**\nï¼ˆ6ï¼‰éƒ¨ç½²åº”ç”¨\n1.ä¸Šä¼ ä»£ç ï¼ˆä»£ç åœ¨ä¸Šé¢ï¼‰ï¼ˆä»£ç ä¸Šä¼ åˆ°/var/www/html/ç›®å½•ï¼‰\n2.è§£å‹\nå®‰è£…è§£å‹è½¯ä»¶ï¼š\n1 [root@localhost html]# yum install unzip â€“y 3.é…ç½®\næ”¹åï¼š\n1 [root@wei html]# mv upload/ farm åœ¨çº¿å®‰è£…ï¼š http://192.168.196.131/farm/install/index.php\n1.é—®é¢˜ä¸€\nä¿®æ”¹/etc/php.iniï¼Œ å°†short_open_tag = On\n1 vim /etc/php.ini ä¿®æ”¹å®Œæ¯•ï¼Œé‡å¯httpdæœåŠ¡ã€‚\n1 [root@wei html]# systemctl restart httpd 2.é—®é¢˜äºŒ\nä¿®æ”¹ç›®å½•æƒé™ï¼š\n1 [root@localhost html]# chmod -R 777 farm è®©åè¿›é¡¹ä¸‹é¢æ­¥éª¤ï¼Œè¿›è¡Œåœ¨çº¿å®‰è£…\næ­¥éª¤ä¸€ï¼š\næ­¥éª¤äºŒï¼š\nåˆ›å»ºfarmæ•°æ®åº“å’Œç”¨æˆ·\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [root@wei html]# mysql -u root -proot ##ç™»å½•æ•°æ®åº“ Warning: Using a password on the command line interface can be insecure. Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 6 Server version: 5.6.44 MySQL Community Server (GPL) Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. mysql\u0026gt; create database farm; ##åˆ›å»ºfarmæ•°æ®åº“ Query OK, 1 row affected (0.00 sec) mysql\u0026gt; grant all on farm.* to farm@\u0026#39;localhost\u0026#39; identified by \u0026#39;farm\u0026#39;; #åˆ›å»ºç”¨æˆ·ï¼Œè¿›è¡Œæˆæƒ Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; flush privileges; ##åˆ·æ–°æƒé™è¡¨ Query OK, 0 rows affected (0.00 sec) æ­¥éª¤ä¸‰ï¼š\nè¿›è¡Œå®‰è£…\næ­¥éª¤å››ï¼š\nè¿›è¡Œæµ‹è¯•\nhttp://192.168.196.131/farm/bbs/\nhttp://192.168.196.131/farm/\nhttp://192.168.196.131/farm/home/space.php?do=home\n","date":"2019-04-29T23:43:33Z","image":"https://www.ownit.top/title_pic/71.jpg","permalink":"https://www.ownit.top/p/201904292343/","title":"Centos7æœåŠ¡å™¨æ­å»ºç½‘ç»œå®¶å›­å’Œè®ºå›"},{"content":"Navicatæ˜¯ä¸€å¥—æ•°æ®åº“ç®¡ç†å·¥å…·ï¼Œä¸“ä¸ºç®€åŒ–æ•°æ®åº“çš„ç®¡ç†åŠé™ä½ç³»ç»Ÿç®¡ç†æˆæœ¬è€Œè®¾ã€‚\n**Navicat æ˜¯ä»¥ç›´è§‰åŒ–çš„å›¾å½¢ç”¨æˆ·ç•Œé¢è€Œå»ºçš„ï¼Œå¯ä»¥å®‰å…¨å’Œç®€å•åœ°åˆ›å»ºã€ç»„ç»‡ã€è®¿é—®å¹¶å…±ç”¨ä¿¡æ¯ã€‚Â Navicat Premium æ˜¯ Navicat çš„äº§å“æˆå‘˜ä¹‹ä¸€ï¼Œèƒ½ç®€å•å¹¶å¿«é€Ÿåœ°åœ¨å„ç§æ•°æ®åº“ç³»ç»Ÿé—´ä¼ è¾“æ•°æ®ï¼Œæˆ–ä¼ è¾“ä¸€ä»½æŒ‡å®š SQL æ ¼å¼åŠç¼–ç çš„çº¯æ–‡æœ¬æ–‡ä»¶ã€‚å…¶ä»–åŠŸèƒ½åŒ…æ‹¬å¯¼å…¥å‘å¯¼ã€å¯¼å‡ºå‘å¯¼ã€æŸ¥è¯¢åˆ›å»ºå·¥å…·ã€æŠ¥è¡¨åˆ›å»ºå·¥å…·ã€èµ„æ–™åŒæ­¥ã€å¤‡ä»½ã€å·¥ä½œè®¡åˆ’åŠæ›´å¤šã€‚Â æœ¬æ–‡ä»‹ç»åœ¨Navicat Premiumä¸­è¿›è¡Œç®€å•çš„æ•°æ®åº“ç®¡ç†ã€‚Â åœ¨ä¸‹è½½å®‰è£…å®Œ Navicat Premium ä¹‹åï¼Œè¿›è¡Œä»¥ä¸‹æ“ä½œã€‚**\nNavicat Premium è½¯ä»¶ï¼šï¼ˆæä¾›32ä½\u0026amp;\u0026amp;64ä½ã€ç ´è§£æ–‡ä»¶ã€‘ï¼‰\né“¾æ¥ï¼šhttps://pan.baidu.com/s/1bt_W1FuB-uzlmkPaYfj-2g å¯†ç ï¼šop4h\nå¦‚æœè½¯ä»¶é“¾æ¥å¤±æ•ˆï¼Œå¯ç•™è¨€æä¾›æœ€æ–°é“¾æ¥\nNavicat Premium å®‰è£…ç ´è§£æ•™ç¨‹\nhttps://blog.csdn.net/loveer0/article/details/82016644\nNavicat Premium å®˜ç½‘è¯¦ç»†æ•™ç¨‹\n**http://www.formysql.com/premium/Â **\nåœ¨ä¸‹è½½å®‰è£…å®Œ Navicat Premium ä¹‹åï¼Œè¿›è¡Œä»¥ä¸‹æ“ä½œã€‚\nè¿æ¥MySQLæ•°æ®åº“Â å¿«æ·é”® åŠŸèƒ½ ctrl+F æœç´¢æœ¬é¡µæ•°æ® Ctrl+Q æ‰“å¼€æŸ¥è¯¢çª—å£ Ctrl+/ æ³¨é‡Šsqlè¯­å¥ Ctrl+Shift +/ è§£é™¤æ³¨é‡Š Ctrl+R è¿è¡ŒæŸ¥è¯¢çª—å£çš„sqlè¯­å¥ Ctrl+Shift+R åªè¿è¡Œé€‰ä¸­çš„sqlè¯­å¥ F6 æ‰“å¼€ä¸€ä¸ªmysqlå‘½ä»¤è¡Œçª—å£ Ctrl+L åˆ é™¤ä¸€è¡Œ Ctrl+N æ‰“å¼€ä¸€ä¸ªæ–°çš„æŸ¥è¯¢çª—å£ Ctrl+W å…³é—­ä¸€ä¸ªæŸ¥è¯¢çª—å£ Ctrl+D è¡¨çš„æ•°æ®æ˜¾ç¤ºæ˜¾ç¤ºé¡µé¢åˆ‡æ¢åˆ°è¡¨çš„ç»“æ„è®¾è®¡é¡µé¢ï¼Œä½†æ˜¯åœ¨æŸ¥è¯¢é¡µé¢å†™sqlæ—¶æ˜¯å¤åˆ¶å½“å‰è¡Œ ","date":"2019-04-27T21:35:58Z","image":"https://www.ownit.top/title_pic/17.jpg","permalink":"https://www.ownit.top/p/201904272135/","title":"Navicat Premium è¯¦è§£"},{"content":"Mycatå®ç°MySQLä¸»ä»å¤åˆ¶è¯»å†™åˆ†ç¦»\nMyCATçš„å®‰è£…åŠéƒ¨ç½²\n1ã€éƒ¨ç½²jdkç¯å¢ƒ\nMyCATç”¨Javaå¼€å‘ï¼Œéœ€è¦æœ‰JAVAè¿è¡Œç¯å¢ƒï¼Œmycatä¾èµ–jdk1.7çš„ç¯å¢ƒ\n1ï¼‰ä¸Šä¼ jdk\n1 2 [root@localhost tools]# ll jdk-7u45-linux-x64.tar.gz -rw-r--r-- 1 root root 138094686 10æœˆ 24 2013 jdk-7u45-linux-x64.tar.gz 2ï¼‰å®‰è£…jdk\n1 2 [root@localhost tools]# mkdir /usr/java [root@localhost tools]# tar xf jdk-7u45-linux-x64.tar.gz -C /usr/java/ 3ï¼‰è®¾ç½®ç¯å¢ƒå˜é‡\n1 [root@localhost tools]# vim /etc/profile.d/java.sh å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 export JAVA_HOME=/usr/java/jdk1.7.0_45/ export PATH=$JAVA_HOME/bin:$PATH export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar ä½¿ç¯å¢ƒå˜é‡å½“å‰ç»ˆç«¯ç”Ÿæ•ˆ\n1 [root@localhost tools]# source /etc/profile.d/java.sh 4ï¼‰æµ‹è¯•\n1 2 3 4 [root@localhost tools]# java -version java version \u0026#34;1.7.0_45\u0026#34; Java(TM) SE Runtime Environment (build 1.7.0_45-b18) Java HotSpot(TM) 64-Bit Server VM (build 24.45-b08, mixed mode) 2ã€å®‰è£…Mycat\n1ï¼‰ä¸Šä¼ mycatåŒ…\n1 2 [root@localhost tools]# ll Mycat-server-1.5.1-RELEASE-20161130213509-linux.tar.gz -rw-r--r--. 1 root root 11499865 12æœˆ 15 16:33 Mycat-server-1.5.1-RELEASE-20161130213509-linux.tar.gz 2ï¼‰è§£å‹\n1 [root@localhost tools]# tar xf Mycat-server-1.5.1-RELEASE-20161130213509-linux.tar.gz -C /usr/local/ è§£å‹åå†…å®¹å¦‚ä¸‹ï¼š\n1 [root@localhost tools]# ll /usr/local/mycat æ€»ç”¨é‡ 16\n1 2 3 4 5 6 drwxr-xr-x 2 root root 4096 12æœˆ 15 11:36 bin drwxrwxrwx 2 root root 6 3æœˆ 1 2016 catlet drwxrwxrwx 4 root root 4096 12æœˆ 15 11:36 conf drwxr-xr-x 2 root root 4096 12æœˆ 15 11:36 lib drwxrwxrwx 2 root root 6 10æœˆ 28 20:47 logs -rwxrwxrwx 1 root root 217 10æœˆ 28 20:47 version.txt 3ï¼‰æ·»åŠ ç¯å¢ƒå˜é‡\n1 2 3 4 [root@localhost tools]# vim /etc/profile.d/mycat.sh export PATH=$PATH:/usr/local/mycat/bin [root@localhost tools]# source /etc/profile.d/mycat.sh 3ã€è¯»å†™åˆ†ç¦»é…ç½®\n1ï¼‰ä¸ä½¿ç”¨Mycatæ‰˜ç®¡MySQLä¸»ä»æœåŠ¡å™¨ï¼Œç®€å•ä½¿ç”¨å¦‚ä¸‹é…ç½®\n#æ³¨æ„ï¼šé…ç½®å‰å¤‡ä»½ä¸‹é…ç½®æ–‡ä»¶\n1 2 [root@localhost tools]# cd /usr/local/mycat/conf [root@localhost conf]# cp schema.xml{,.bak} (1)\u0026lt;schema name=\u0026ldquo;TESTDB\u0026rdquo; checkSQLschema=\u0026ldquo;false\u0026rdquo; sqlMaxLimit=\u0026ldquo;100\u0026rdquo; dataNode=\u0026ldquo;dn1\u0026rdquo;\u0026gt;\nè¿™é‡Œçš„TESTDBå°±æ˜¯æˆ‘ä»¬æ‰€å®£ç§°çš„æ•°æ®åº“åç§°ï¼Œå¿…é¡»å’Œserver.xmlä¸­çš„ç”¨æˆ·æŒ‡å®šçš„æ•°æ®åº“åç§°ä¸€è‡´ã€‚æ·»åŠ ä¸€ä¸ªdataNode=\u0026ldquo;dn1\u0026rdquo;ï¼Œæ˜¯æŒ‡å®šäº†æˆ‘ä»¬è¿™ä¸ªåº“åªæœ‰åœ¨dn1ä¸Šï¼Œæ²¡æœ‰åˆ†åº“ã€‚\n(2)\u0026lt;dataNode name=\u0026ldquo;dn1\u0026rdquo; dataHost=\u0026ldquo;localhost1\u0026rdquo; database=\u0026ldquo;db1\u0026rdquo; /\u0026gt;\nè¿™é‡Œåªéœ€è¦æ”¹databaseçš„åå­—ï¼Œå°±æ˜¯ä½ çœŸæ˜¯çš„æ•°æ®åº“ä¸Šçš„æ•°æ®åº“åï¼Œå¯æ ¹æ®è‡ªå·±çš„æ•°æ®åº“åç§°ä¿®æ”¹ã€‚\n(3) \u0026lt;dataHost name=\u0026ldquo;localhost1\u0026rdquo; maxCon=\u0026ldquo;1000\u0026rdquo; minCon=\u0026ldquo;10\u0026rdquo; balance=\u0026ldquo;1\u0026rdquo;\nwriteType=\u0026ldquo;0\u0026rdquo; dbType=\u0026ldquo;mysql\u0026rdquo; dbDriver=\u0026ldquo;native\u0026rdquo; switchType=\u0026ldquo;1\u0026rdquo; slaveThreshold=\u0026ldquo;100\u0026rdquo;\u0026gt;\néœ€è¦é…ç½®çš„ä½ç½®ï¼š\nbalance=\u0026ldquo;1\u0026rdquo; writeType=\u0026ldquo;0\u0026rdquo; switchType=\u0026ldquo;1\u0026rdquo;\nbalance\n1ã€balance=0 ä¸å¼€å¯è¯»å†™åˆ†ç¦»æœºåˆ¶ï¼Œæ‰€æœ‰è¯»æ“ä½œéƒ½å‘é€åˆ°å½“å‰å¯ç”¨çš„writehostle .\n2ã€balance=1 å…¨éƒ¨çš„readhostä¸stand by writeHost å‚ä¸selectè¯­å¥çš„è´Ÿè½½å‡è¡¡ã€‚ç®€å•çš„è¯´ï¼ŒåŒä¸»åŒä»æ¨¡å¼(M1-\u0026gt;S1,M2-\u0026gt;S2ï¼Œå¹¶ä¸”M1å’ŒM2äº’ä¸ºä¸»å¤‡)ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼ŒM1ï¼ŒS1ï¼ŒS2éƒ½å‚ä¸selectè¯­å¥çš„å¤æ‚å‡è¡¡ã€‚\n3ã€balance=2 æ‰€æœ‰è¯»æ“ä½œéƒ½éšæœºçš„åœ¨readhostå’Œwritehostä¸Šåˆ†å‘\nwriteType\nè´Ÿè½½å‡è¡¡ç±»å‹ï¼Œç›®å‰çš„å–å€¼æœ‰3ç§ï¼š\n1ã€writeType=\u0026ldquo;0\u0026rdquo;, æ‰€æœ‰å†™æ“ä½œå‘é€åˆ°é…ç½®çš„ç¬¬ä¸€ä¸ªwriteHostã€‚\n2ã€writeType=\u0026ldquo;1\u0026rdquo;ï¼Œæ‰€æœ‰å†™æ“ä½œéƒ½éšæœºçš„å‘é€åˆ°é…ç½®çš„writeHostã€‚\n3ã€writeType=\u0026ldquo;2\u0026rdquo;ï¼Œä¸æ‰§è¡Œå†™æ“ä½œã€‚\nswitchType\n1ã€switchType=-1 è¡¨ç¤ºä¸è‡ªåŠ¨åˆ‡æ¢\n2ã€switchType=1 é»˜è®¤å€¼ï¼Œè‡ªåŠ¨åˆ‡æ¢\n3ã€switchType=2 åŸºäºMySQL ä¸»ä»åŒæ­¥çš„çŠ¶æ€å†³å®šæ˜¯å¦åˆ‡æ¢\n(4)\u0026lt;writeHost host=\u0026ldquo;hostM1\u0026rdquo; url=\u0026ldquo;192.168.95.120:3306\u0026rdquo; user=\u0026ldquo;mycat\u0026rdquo; password=\u0026ldquo;123456\u0026rdquo;\u0026gt;\n\u0026lt;!â€“ can have multi read hosts â€“\u0026gt;\n\u0026lt;readHost host=\u0026ldquo;hostS2\u0026rdquo; url=\u0026ldquo;192.168.95.140:3306\u0026rdquo; user=\u0026ldquo;mycat_r\u0026rdquo; password=\u0026ldquo;123456\u0026rdquo; /\u0026gt;\n\u0026lt;readHost host=\u0026ldquo;hostS3\u0026rdquo; url=\u0026ldquo;192.168.95.140:3307\u0026rdquo; user=\u0026ldquo;mycat_r\u0026rdquo; password=\u0026ldquo;123456\u0026rdquo; /\u0026gt;\n\u0026lt;!\u0026ndash;\u0026lt;writeHost host=\u0026ldquo;hostS1\u0026rdquo; url=\u0026ldquo;localhost:3316\u0026rdquo; user=\u0026ldquo;root\u0026rdquo;\npassword=\u0026ldquo;123456\u0026rdquo; /\u0026gt;\u0026ndash;\u0026gt;\né…ç½®å¥½æ–‡ä»¶å†…å®¹å¦‚ä¸‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 \u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE mycat:schema SYSTEM \u0026#34;schema.dtd\u0026#34;\u0026gt; \u0026lt;mycat:schema xmlns:mycat=\u0026#34;http://org.opencloudb/\u0026#34; \u0026gt; \u0026lt;schema name=\u0026#34;TESTDB\u0026#34; checkSQLschema=\u0026#34;false\u0026#34; sqlMaxLimit=\u0026#34;100\u0026#34; dataNode=\u0026#34;dn1\u0026#34;\u0026gt; \u0026lt;/schema\u0026gt; \u0026lt;dataNode name=\u0026#34;dn1\u0026#34; dataHost=\u0026#34;localhost1\u0026#34; database=\u0026#34;db1\u0026#34; /\u0026gt; \u0026lt;dataHost name=\u0026#34;localhost1\u0026#34; maxCon=\u0026#34;1000\u0026#34; minCon=\u0026#34;10\u0026#34; balance=\u0026#34;1\u0026#34; writeType=\u0026#34;0\u0026#34; dbType=\u0026#34;mysql\u0026#34; dbDriver=\u0026#34;native\u0026#34; switchType=\u0026#34;1\u0026#34; slaveThreshold=\u0026#34;100\u0026#34;\u0026gt; \u0026lt;heartbeat\u0026gt;select user()\u0026lt;/heartbeat\u0026gt; \u0026lt;writeHost host=\u0026#34;hostM1\u0026#34; url=\u0026#34;192.168.95.120:3306\u0026#34; user=\u0026#34;root\u0026#34; password=\u0026#34;123456\u0026#34;\u0026gt; \u0026lt;readHost host=\u0026#34;hostR1\u0026#34; url=\u0026#34;192.168.95.140:3306\u0026#34; user=\u0026#34;root\u0026#34; password=\u0026#34;123456\u0026#34; /\u0026gt; \u0026lt;readHost host=\u0026#34;hostR2\u0026#34; url=\u0026#34;192.168.95.140:3307\u0026#34; user=\u0026#34;root\u0026#34; password=\u0026#34;123456\u0026#34; /\u0026gt; \u0026lt;/writeHost\u0026gt; \u0026lt;/dataHost\u0026gt; \u0026lt;/mycat:schema\u0026gt; 4ã€åˆ›å»ºç®¡ç†ç”¨æˆ·\nä¸»åº“ä¸Šå¯¹mycatç”¨æˆ·æˆæƒå¦‚ä¸‹ï¼š\nç”¨æˆ·ï¼šmycat å¯†ç ï¼š123456 ç«¯å£ï¼š3306\næƒé™ï¼šinsert,delete,update,select\nå‘½ä»¤ï¼šgrant insert,delete,update,select on TD_OA.* to mycat@\u0026lsquo;192.168.95.%\u0026rsquo; identified by \u0026lsquo;123456\u0026rsquo;;\nflush privileges;\nä»åº“ä¸Šmycat_rç”¨æˆ·æˆæƒå¦‚ä¸‹ï¼š\nç”¨æˆ·ï¼šmycat_r å¯†ç ï¼š123456 ç«¯å£ï¼š3306/3307\næƒé™ï¼š select\ngrant select on TD_OA.* to mycat@\u0026lsquo;192.168.95.%\u0026rsquo; identified by \u0026lsquo;123456\u0026rsquo;;\nflush privileges;\næµ‹è¯•ç¯å¢ƒå¯ä»¥ç›´æ¥ä½¿ç”¨rootç”¨æˆ·ï¼Œæˆäºˆæ‰€æœ‰æƒé™ï¼š\n1 2 3 4 mysql\u0026gt; grant all on *.* to root@\u0026#39;192.168.95.%\u0026#39; identified by \u0026#39;123456\u0026#39;; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; grant all on *.* to root@\u0026#39;localhost\u0026#39; identified by \u0026#39;123456\u0026#39;; 5ã€ä¿®æ”¹mycaté…ç½®æ–‡ä»¶\né‡‡ç”¨é»˜è®¤é…ç½®\næ³¨æ„ï¼š\nâ‘ è¿™é‡Œé…ç½®çš„æ˜¯å¯ä»¥è¿æ¥ä¸»åº“çš„ä¸¤ä¸ªç”¨æˆ·\nç”¨æˆ·ï¼štest å¯†ç ï¼štest ç»™äºˆæ­¤ç”¨æˆ·TESTDBæ•°æ®åº“å¢åˆ æ”¹æŸ¥çš„æƒé™ã€‚\nç”¨æˆ·ï¼šuser å¯†ç ï¼špassword ç»™äºˆæ­¤ç”¨æˆ·TESTDBæ•°æ®åº“è¯»çš„æƒé™ã€‚\nâ‘¡è¿™é‡Œçš„TESTDBï¼Œä¸ä¸€å®šæ˜¯ä½ æ•°æ®åº“ä¸Šçš„çœŸå®åº“åï¼Œå¯ä»¥ä»»æ„æŒ‡å®šï¼Œåªè¦æ¥ä¸‹æ¥å’Œschema.xmlçš„é…ç½®æ–‡ä»¶çš„åº“åç»Ÿä¸€å³å¯ã€‚\n6ã€å¯åŠ¨Mycat\næ–¹æ³•ä¸€ï¼š# mycat console #\u0026lt;=é€šè¿‡consoleå‘½ä»¤å¯åŠ¨mycatï¼Œè¿™æ ·æ–¹ä¾¿æå–ä¿¡æ¯\næ–¹æ³•äºŒï¼š# mycat start\næ–¹æ³•ä¸‰ï¼š# startup_nowrap.sh #æœåŠ¡è„šæœ¬æ–¹å¼å¯åŠ¨\n[root@localhost conf]# netstat -lnupt | egrep \u0026ldquo;(8|9)066\u0026rdquo;\ntcp6 0 0 :::9066 :::* LISTEN 3342/java\ntcp6 0 0 :::8066 :::* LISTEN 3342/java\né‡å¯ï¼š# mycat restart\n7ã€åœ¨å®¢æˆ·ç«¯è¿æ¥mysqlä¸»åº“æœåŠ¡å™¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # mysql -uuser -puser -h192.168.95.130 -P8066 -DTESTDB Warning: Using a password on the command line interface can be insecure. Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 1 Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB) Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. mysql\u0026gt; 8ã€ä¸»ä»åŒæ­¥è¯»å†™åˆ†ç¦»æµ‹è¯•\nç®¡ç†ç«¯åˆ›å»ºè¡¨:\n1 2 [root@localhost ~]# mysql -utest -ptest -h192.168.95.130 -P8066 -DTESTDB CREATE TABLE test1 (id int(10),name varchar(10),address varchar(20) DEFAULT NULL); æ‰‹åŠ¨åœæ­¢ä¸»ä»åŒæ­¥: stop slave;\nåˆ†åˆ«åœ¨ä¸»ä»åº“æ’å…¥æ•°æ®:\n**master: insert into test1 values(1,\u0026rsquo;test1\u0026rsquo;,\u0026lsquo;master\u0026rsquo;);\nslave1: insert into test1 values(2,\u0026rsquo;test1\u0026rsquo;,\u0026lsquo;slave1\u0026rsquo;);\nslave2: insert into test1 values(3,\u0026rsquo;test1\u0026rsquo;,\u0026lsquo;slave2\u0026rsquo;);**\nç®¡ç†ç«¯éªŒè¯\nè´Ÿè½½å‡è¡¡:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 mysql\u0026gt; select * from test1; +------+-------+---------+ | id | name | address | +------+-------+---------+ | 2 | test1 | slave1 | +------+-------+---------+ 1 row in set (0.00 sec) mysql\u0026gt; select * from test1; +------+-------+---------+ | id | name | address | +------+-------+---------+ | 3 | test1 | slave2 | +------+-------+---------+ 1 row in set (0.00 sec) è¯»å†™åŠŸèƒ½:\nç®¡ç†ç«¯å†æ¬¡æ’å…¥æ•°æ® insert into test1 values(4,\u0026rsquo;test1\u0026rsquo;,\u0026lsquo;write\u0026rsquo;);\n1 2 mysql\u0026gt; insert into test1 values(4,\u0026#39;test1\u0026#39;,\u0026#39;write\u0026#39;); Query OK, 1 row affected (0.00 sec) #æ³¨æ„ï¼šæµ‹è¯•å®Œæ¯•å¯åŠ¨ä¸»ä»åŒæ­¥åŠŸèƒ½ã€‚\n9ã€ç®¡ç†å‘½ä»¤ä¸ç›‘æ§\nmycatè‡ªèº«æœ‰ç±»ä¼¼å…¶ä»–æ•°æ®åº“çš„ç®¡ç†ç›‘æ§æ–¹å¼ï¼Œå¯é€šè¿‡mysqlå‘½ä»¤è¡Œï¼Œç™»é™†ç«¯å£9066æ‰§è¡Œç›¸åº”çš„SQLæ“ä½œï¼Œä¹Ÿå¯é€šè¿‡jdbcçš„æ–¹å¼è¿›è¡Œè¿œç¨‹è¿æ¥ç®¡ç†ã€‚\nç™»å½•ï¼šç›®å‰mycatæœ‰ä¸¤ä¸ªç«¯å£ï¼Œ8066æ•°æ®ç«¯å£ï¼Œ9066ç®¡ç†ç«¯å£ã€‚å‘½ä»¤è¡Œç™»å½•æ—¶é€šè¿‡9066ç®¡ç†ç«¯å£æ¥æ‰§è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # mysql -uuser -puser -h192.168.95.130 -P9066 -DTESTDB Warning: Using a password on the command line interface can be insecure. Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 2 Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (monitor) Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. mysql\u0026gt; é€‰é¡¹ï¼š\n-h åé¢æ¥ä¸»æœº\n-u mycat server.xmlé…ç½®çš„é€»è¾‘åº“ç”¨æˆ·\n-p mycat server.xmlé…ç½®çš„é€»è¾‘åº“å¯†ç \n-P åé¢æ¥çš„ç«¯å£9066ï¼Œæ³¨æ„På¤§å†™\n-D Mycat server.xmlä¸­é…ç½®çš„é€»è¾‘åº“\n1ï¼‰æŸ¥çœ‹æ‰€æœ‰çš„å‘½ä»¤ï¼Œå¦‚ä¸‹ï¼š\n1 mysql\u0026gt; show @@help; 2ï¼‰æ˜¾ç¤ºmycatæ•°æ®åº“çš„åˆ—è¡¨ï¼Œå¯¹åº”çš„åœ¨scehma.xmlé…ç½®çš„é€»è¾‘åº“\n1 2 3 4 5 6 7 mysql\u0026gt; show @@databases; +----------+ | DATABASE | +----------+ | TESTDB | +----------+ 1 row in set (0.00 sec) 3ï¼‰æ˜¾ç¤ºmycatæ•°æ®èŠ‚ç‚¹çš„åˆ—è¡¨ï¼Œå¯¹åº”çš„æ˜¯scehma.xmlé…ç½®æ–‡ä»¶çš„dataNodeèŠ‚ç‚¹\n1 2 3 4 5 6 7 8 9 mysql\u0026gt; show @@datanode; +------+----------------+-------+-------+--------+------+------+---------+------------+----------+---------+---------------+ | NAME | DATHOST | INDEX | TYPE | ACTIVE | IDLE | SIZE | EXECUTE | TOTAL_TIME | MAX_TIME | MAX_SQL | RECOVERY_TIME | +------+----------------+-------+-------+--------+------+------+---------+------------+----------+---------+---------------+ | dn1 | localhost1/db1 | 0 | mysql | 0 | 0 | 1000 | 0 | 0 | 0 | 0 | -1 | | dn2 | localhost1/db2 | 0 | mysql | 0 | 0 | 1000 | 0 | 0 | 0 | 0 | -1 | | dn3 | localhost1/db3 | 0 | mysql | 0 | 0 | 1000 | 0 | 0 | 0 | 0 | -1 | +------+----------------+-------+-------+--------+------+------+---------+------------+----------+---------+---------------+ 3 rows in set (0.00 sec) å…¶ä¸­ï¼ŒNAMEè¡¨ç¤ºdatanodeçš„åç§°ï¼›dataHost å¯¹åº”çš„æ˜¯dataHostå±æ€§çš„å€¼ï¼Œæ•°æ®ä¸»æœºçš„åç§°ï¼ŒACTIVEè¡¨ç¤ºæ´»è·ƒçš„è¿æ¥æ•°ï¼ŒIDIEè¡¨ç¤ºé—²ç½®çš„è¿æ¥æ•°ï¼ŒSIZEå¯¹åº”çš„æ˜¯æ€»è¿æ¥çš„æ•°é‡ã€‚\n1 2 3 4 5 6 7 8 9 mysql\u0026gt; show @@heartbeat; +--------+-------+----------------+------+---------+-------+--------+---------+--------------+---------------------+-------+ | NAME | TYPE | HOST | PORT | RS_CODE | RETRY | STATUS | TIMEOUT | EXECUTE_TIME | LAST_ACTIVE_TIME | STOP | +--------+-------+----------------+------+---------+-------+--------+---------+--------------+---------------------+-------+ | hostM1 | mysql | 192.168.95.120 | 3306 | 1 | 0 | idle | 0 | 1,0,0 | 2016-12-15 14:25:35 | false | | hostS2 | mysql | 192.168.95.140 | 3306 | 1 | 0 | idle | 0 | 1,1,1 | 2016-12-15 14:25:35 | false | | hostS3 | mysql | 192.168.95.140 | 3307 | 1 | 0 | idle | 0 | 1,1,1 | 2016-12-15 14:25:35 | false | +--------+-------+----------------+------+---------+-------+--------+---------+--------------+---------------------+-------+ 3 rows in set (0.01 sec) RS_CODEçŠ¶æ€ä¸º1ï¼Œæ­£å¸¸çŠ¶æ€\n4ã€è·å–å½“å‰mycatçš„ç‰ˆæœ¬\n1 mysql\u0026gt; show @@version; 5ã€æ˜¾ç¤ºmycatå‰ç«¯è¿æ¥çŠ¶æ€\n1 mysql\u0026gt; show @@connection; 6ã€æ˜¾ç¤ºmycatåç«¯è¿æ¥çŠ¶æ€\n1 mysql\u0026gt; show @@backend; 7ã€æ˜¾ç¤ºæ•°æ®æº\n1 mysql\u0026gt; show @@datasource ","date":"2019-04-26T21:07:54Z","image":"https://www.ownit.top/title_pic/31.jpg","permalink":"https://www.ownit.top/p/201904262107/","title":"MySQLè¯»å†™åˆ†ç¦»ä¹‹MyCAT"},{"content":"MySQL Proxyï¼š\n========================================================\nMySQL_Proxy Master Slave1 Slave2\nï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼=\nIP 192.168.1.250Â 192.168.1.215Â 192.168.1.66\nServer_IDÂ 6Â 215Â 66\nå®ç°æ­¥éª¤ï¼š\nMySQLä¸»/å¤‡å¤åˆ¶\nå®‰è£…å¹¶é…ç½®MySQL Proxy\næµ‹è¯•Proxy\nä¸€ã€MySQLä¸»/å¤‡å¤åˆ¶ï¼ˆç•¥ï¼‰\näºŒã€å®‰è£…å¹¶é…ç½®MySQL Proxy\n1. å®‰è£…å¹¶é…ç½®\n1 2 3 4 5 6 7 8 9 10 [root@MySQL_Proxy ~]# service mysqld stop [root@MySQL_Proxy ~]# chkconfig mysqld off [root@MySQL_Proxy ~]# rpm -qa |grep lua lua-5.1.4-4.1.el6.x86_64 [root@MySQL_Proxy ~]# tar xf mysql-proxy-0.8.4-linux-el6-x86-64bit.tar.gz -C /usr/local/ [root@MySQL_Proxy ~]# cd /usr/local/ [root@MySQL_Proxy ~]# ln -s mysql-proxy-0.8.4-linux-el6-x86-64bit mysql-proxy [root@MySQL_Proxy ~]# vim /usr/local/mysql-proxy/share/doc/mysql-proxy/rw-splitting.lua min_idle_connections = 1, max_idle_connections = 1, 2. å¯åŠ¨mysql-proxy\n1 2 [root@MySQL_Proxy ~]# lsof -i TCP:3306 [root@MySQL_Proxy ~]# /usr/local/mysql-proxy/bin/mysql-proxy --help-proxy -P æŒ‡å®šproxyæœåŠ¡å™¨å·¥ä½œçš„åœ°å€å’Œç«¯å£\n-b æŒ‡å®šå†™æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£\n-r æŒ‡å®šè¯»æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£\n-s æŒ‡å®šåˆ¤æ–­çš„è„šæœ¬\n--daemon ä»¥åå°è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨\nè°ƒæ•´æœ€å¤§æ‰“å¼€çš„æ–‡ä»¶æ•°\n1 2 3 4 [root@MySQL_Proxy ~]# ulimit -a |grep \u0026#39;open files\u0026#39; [root@MySQL_Proxy ~]# ulimit -n 10240 [root@MySQL_Proxy ~]# ulimit -a |grep \u0026#39;open files\u0026#39; open files (-n) 10240 1 2 [root@MySQL_Proxy ~]# /usr/local/mysql-proxy/bin/mysql-proxy -P 192.168.1.250:3306 -b 192.168.1.27:3306 -r 192.168.1.215:3306 -r 192.168.1.66:3306 -s /usr/local/mysql-proxy/share/doc/mysql-proxy/rw-splitting.lua --daemon 2014-02-13 17:15:54: (critical) plugin proxy 0.8.4 started 1 2 [root@MySQL_Proxy ~]# netstat -tnlp |grep :3306 tcp 0 0 192.168.10.137:3306 0.0.0.0:* LISTEN 16620/mysql-proxy 1 2 3 [root@MySQL_Proxy ~]# vim /etc/rc.local ulimit -n 10240 /usr/local/mysql-proxy/bin/mysql-proxy -P 192.168.1.250:3306 -b 192.168.1.27:3306 -r 192.168.1.215:3306 -r 192.168.1.66:3306 -s /usr/local/mysql-proxy/share/doc/mysql-proxy/rw-splitting.lua --daemon ä¸‰ã€æµ‹è¯•\n1. ä¸»åº“\n1 2 3 4 5 mysql\u0026gt; grant ALL on bbs.* to bbs@\u0026#39;192.168.1.%\u0026#39; identified by \u0026#39;localhost\u0026#39;; mysql\u0026gt; flush privileges; mysql\u0026gt; create database bbs; mysql\u0026gt; create table bbs.t1 (name varchar(50)); 2. å¤‡åº“\nmysql\u0026gt; stop slave; //æš‚æ—¶æ–­æ‰å’Œä¸»åº“çš„è¿æ¥\n3. ä»å®¢æˆ·ç«¯æµ‹è¯•\na. è¯» ====ä¸» or å¤‡\nb. å†™ ====ä¸»\n4. å¤‡åº“\nmysql\u0026gt; start slave;\n=======================================================\n","date":"2019-04-24T00:00:40Z","image":"https://www.ownit.top/title_pic/35.jpg","permalink":"https://www.ownit.top/p/201904240000/","title":"MySQLè¯»å†™åˆ†ç¦»ä¹‹Proxy"},{"content":"MySQLé«˜å¯ç”¨æ–¹æ¡ˆ\næŠ•ç¥¨é€‰ä¸¾æœºåˆ¶ï¼Œè¾ƒå¤æ‚\nMySQLæœ¬èº«æ²¡æœ‰æä¾›replication failoverçš„è§£å†³æ–¹æ¡ˆï¼Œè‡ªåŠ¨åˆ‡æ¢éœ€è¦ä¾èµ–MHAè„šæœ¬\nå¯ä»¥æœ‰å¤šå°ä»åº“ï¼Œä»åº“å¯ä»¥åšæŠ¥è¡¨å’Œå¤‡ä»½\nMySQLå¤åˆ¶æŠ€æœ¯\n===========================================================================\né‡ç½®æ•°æ®åº“ï¼š\n1 2 3 # service mysqld stop # rm -rf /usr/local/mysql/data/* # /usr/local/mysql/scripts/mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data å¤åˆ¶æ‹“æ‰‘ï¼š å¤åˆ¶åŸç†ï¼š 1. åœ¨ä¸»åº“ä¸ŠæŠŠæ•°æ®æ›´æ”¹è®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinary Logï¼‰ä¸­ã€‚ 2. å¤‡åº“å°†ä¸»åº“ä¸Šçš„æ—¥å¿—å¤åˆ¶åˆ°è‡ªå·±çš„ä¸­ç»§æ—¥å¿—ï¼ˆRelay Logï¼‰ä¸­ã€‚\n3. å¤‡åº“è¯»å–ä¸­ç»§æ—¥å¿—ä¸­çš„äº‹ä»¶ï¼Œå°†å…¶é‡æ”¾åˆ°å¤‡åº“æ•°æ®åº“ä¹‹ä¸Šã€‚\nä¸€ã€ä¸»/å¤‡å‡ä¸ºåˆšåˆå§‹çš„æ•°æ®åº“\nå•ä¸»åˆ°å¤šå¤‡ï¼š Master-MultiSlave\nMasterÂ Slave1Â Slave2\nï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼\nIP 192.168.1.27Â 192.168.1.66Â 192.168.1.251\nServer_IDÂ 27Â 66Â 251\nå¦‚ä½•å®ç°ä¸»ä»å¤åˆ¶ï¼Ÿ\nåœ¨ä¸»æœåŠ¡å™¨ï¼ˆmasterï¼‰ä¸Š\nå¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—\né€‰æ‹©ä¸€ä¸ªå”¯ä¸€çš„server-id\nåˆ›å»ºå…·æœ‰å¤åˆ¶æƒé™çš„ç”¨æˆ·\nåœ¨ä»æœåŠ¡å™¨ï¼ˆslaveï¼‰ä¸Š\nå¯ç”¨ä¸­ç»§æ—¥å¿—ï¼ˆäºŒè¿›åˆ¶æ—¥å¿—å¯å¼€å¯ï¼Œä¹Ÿå¯ä¸å¼€å¯ï¼‰\né€‰æ‹©ä¸€ä¸ªå”¯ä¸€çš„server-id\nè¿æ¥è‡³ä¸»æœåŠ¡å™¨ï¼Œå¹¶å¼€å§‹å¤åˆ¶\n1. ä¸»åº“\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@master ~]# vim /etc/my.cnf [mysqld] log-bin=master-bin binlog_format = row sync_binlog = 1 skip_name_resolv = 1 log_slave_updates = 1 server_id = 27 [root@master ~]# service mysqld start [root@master ~]# mysql mysql\u0026gt; reset master; mysql\u0026gt; grant replication slave, replication client on *.* -\u0026gt; to rep@\u0026#39;192.168.1.%\u0026#39; identified by \u0026#39;localhost\u0026#39;; mysql\u0026gt; flush privileges; 2. å¤‡åº“\na. æµ‹è¯•å¤åˆ¶è´¦å·\n1 [root@slave1 ~]# mysql -h 192.168.1.27 -urep -plocalhost b. é…ç½®å¤åˆ¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 [root@slave1 ~]# vim /etc/my.cnf log-bin=slave1-bin binlog_format = row sync_binlog = 1 skip_name_resolv = 1 log_slave_updates = 1 server_id = 66 [root@slave1 ~]# service mysqld start [root@slave1 ~]# mysql mysql\u0026gt; reset master; mysql\u0026gt; change master to -\u0026gt; master_host=\u0026#39;192.168.1.27\u0026#39;, -\u0026gt; master_user=\u0026#39;rep\u0026#39;, -\u0026gt; master_password=\u0026#39;localhost\u0026#39;, -\u0026gt; master_log_file=\u0026#39;master-bin.000001\u0026#39;, -\u0026gt; master_log_pos=0; Query OK, 0 rows affected (0.02 sec) mysql\u0026gt; show slave status\\G *************************** 1. row *************************** Slave_IO_State: Master_Host: 192.168.1.27 Master_User: rep Master_Port: 3306 Connect_Retry: 60 Master_Log_File: mysql-bin.000001 Read_Master_Log_Pos: 4 Relay_Log_File: mysql-relay-bin.000001 Relay_Log_Pos: 4 Relay_Master_Log_File: mysql-bin.000001 Slave_IO_Running: No Slave_SQL_Running: No mysql\u0026gt; start slave; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; show slave status\\G *************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 192.168.1.27 Master_User: rep Master_Port: 3306 Connect_Retry: 60 Master_Log_File: mysql-bin.000001 Read_Master_Log_Pos: 354 Relay_Log_File: mysql-relay-bin.000002 Relay_Log_Pos: 500 Relay_Master_Log_File: mysql-bin.000001 Slave_IO_Running: Yes Slave_SQL_Running: Yes 3. æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 Masterï¼š mysql\u0026gt; show processlist\\G *************************** 2. row *************************** Id: 2 User: rep Host: 192.168.10.37:50915 db: NULL Command: Binlog Dump Time: 324 State: Master has sent all binlog to slave; waiting for binlog to be updated Info: NULL 2 rows in set (0.00 sec) mysql\u0026gt; create database bbs; Query OK, 1 row affected (0.00 sec) mysql\u0026gt; create table bbs.t1(id int); Query OK, 0 rows affected (0.03 sec) mysql\u0026gt; insert into bbs.t1 values(1); Query OK, 1 row affected (0.02 sec) mysql\u0026gt; select * from bbs.t1; +------+ | id | +------+ | 1 | +------+ 1 row in set (0.00 sec) Slaveï¼š mysql\u0026gt; show processlist\\G *************************** 2. row *************************** Id: 2 User: system user Host: db: NULL Command: Connect Time: 356 State: Waiting for master to send event Info: NULL *************************** 3. row *************************** Id: 3 User: system user Host: db: NULL Command: Connect Time: -173772 State: Slave has read all relay log; waiting for the slave I/O thread to update it Info: NULL 3 rows in set (0.00 sec) mysql\u0026gt; select * from bbs.t1; +------+ | id | +------+ | 1 | +------+ 1 row in set (0.03 sec) äºŒã€é’ˆå¯¹å·²ç»è¿è¡Œä¸€æ®µæ—¶é—´çš„ä¸»åº“å®ç°ä¸»/å¤‡\nå•ä¸»åˆ°å¤šå¤‡ï¼š Master-MultiSlave\nMasterÂ Slave1Â Slave2\nï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼\nIP 192.168.1.27Â 192.168.1.66Â 192.168.1.251\nServer_IDÂ 27Â 66Â 251\n1. ä¸»åº“\n1 2 3 4 5 6 7 8 9 10 11 12 [root@master ~]# vim /etc/my.cnf log-bin=master-bin binlog_format = row sync_binlog = 1 skip_name_resolv = 1 log_slave_updates = 1 server_id = 27 [root@master ~]# service mysqld restart [root@master ~]# mysql mysql\u0026gt; grant replication slave, replication client on *.* -\u0026gt; to rep@\u0026#39;192.168.1.%\u0026#39; identified by \u0026#39;localhost\u0026#39;; mysql\u0026gt; flush privileges; ========================================================\nåˆå§‹åŒ–å¤‡åº“ï¼ˆä½¿å…¶å’Œä¸»åº“æ•°æ®ä¸€è‡´ï¼‰ï¼š é€»è¾‘å¤‡ä»½ï¼Œç‰©ç†å¤‡ä»½\nä¸»åº“ï¼š\n1 2 3 4 5 6 7 8 9 10 mysql\u0026gt; flush tables with read lock; //ä¸»æœåŠ¡å™¨é”å®šè¡¨ [root@master ~]# mysqldump --all-databases \u0026gt; all.sql [root@master ~]# mysql -e \u0026#39;show master status\u0026#39; +------------------+----------+--------------+------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | +------------------+----------+--------------+------------------+ | master-bin.000001 | 699 | | | +------------------+----------+--------------+------------------+ mysql\u0026gt; unlock tables; //è§£é”è¡¨ [root@master ~]# rsync -va all.sql 192.168.1.66:/ ========================================================\n2. å¤‡åº“\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 [root@slave1 ~]# vim /etc/my.cnf server-id = 66 [root@slave1 ~]# service mysqld start [root@slave1 ~]# mysql mysql\u0026gt; reset master; mysql\u0026gt; source /all.sql mysql\u0026gt; change master to master_host=\u0026#39;192.168.1.27\u0026#39;, master_user=\u0026#39;rep\u0026#39;, master_password=\u0026#39;localhost\u0026#39;, master_log_file=\u0026#39;master-bin.000001\u0026#39;, master_log_pos=699; Query OK, 0 rows affected (0.02 sec) mysql\u0026gt; start slave; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; show slave status\\G *************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 192.168.1.27 Master_User: rep Master_Port: 3306 Connect_Retry: 60 Master_Log_File: master-bin.000001 Read_Master_Log_Pos: 354 Relay_Log_File: mysql-relay-bin.000002 Relay_Log_Pos: 500 Relay_Master_Log_File: mysql-bin.000001 Slave_IO_Running: Yes Slave_SQL_Running: Yes MySQLä¸»ä»å¤åˆ¶çš„çŠ¶å†µç›‘æµ‹\nä¸»ä»çŠ¶å†µç›‘æµ‹ä¸»è¦å‚æ•°\nSlave_IO_Running: IOçº¿ç¨‹æ˜¯å¦æ‰“å¼€ YES/No/NULL\nSlave_SQL_Running: SQLçº¿ç¨‹æ˜¯å¦æ‰“å¼€ YES/No/NULL\nSeconds_Behind_Master: NULL #å’Œä¸»åº“æ¯”åŒæ­¥çš„å»¶è¿Ÿçš„ç§’æ•°\nå¯èƒ½å¯¼è‡´ä¸»ä»å»¶æ—¶çš„å› ç´ \nä¸»ä»æ—¶é’Ÿæ˜¯å¦ä¸€è‡´\nç½‘ç»œé€šä¿¡æ˜¯å¦å­˜åœ¨å»¶è¿Ÿ\næ˜¯å¦å’Œæ—¥å¿—ç±»å‹ï¼Œæ•°æ®è¿‡å¤§æœ‰å…³\nä»åº“æ€§èƒ½ï¼Œæœ‰æ²¡å¼€å¯binlog\nä»åº“æŸ¥è¯¢æ˜¯å¦ä¼˜åŒ–\nå¸¸è§çŠ¶æ€é”™è¯¯æ’é™¤\nå‘ç°IOè¿›ç¨‹é”™è¯¯ï¼Œæ£€æŸ¥æ—¥å¿—ï¼Œæ’é™¤æ•…éšœï¼š\n# tail localhost.localdomain.err\n\u0026hellip;2015-11-18 10:55:50 3566 [ERROR] Slave I/O: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs; these UUIDs must be different for replication to work. Error_code: 1593\næ‰¾åˆ°åŸå› ï¼šä»5.6å¼€å§‹å¤åˆ¶å¼•å…¥äº†uuidçš„æ¦‚å¿µï¼Œå„ä¸ªå¤åˆ¶ç»“æ„ä¸­çš„server_uuidå¾—ä¿è¯ä¸ä¸€æ ·\nè§£å†³æ–¹æ³•ï¼š(ä»åº“æ˜¯å…‹éš†æœºå™¨)ä¿®æ”¹ä»åº“çš„uuid\n# vim auto.cnf server-uuid=\nshow slave status;æŠ¥é”™ï¼šError xxx doesnâ€™t exist\nè§£å†³æ–¹æ³•ï¼š\nstop slave;\nset global sql_slave_skip_counter = 1;\nstart slave;\nä¸‰ã€å¸¸è§å¤åˆ¶æ‹“æœ´\n1. ä¸€ä¸»åº“å¤šå¤‡åº“\n2. ä¸»åº“ï¼Œåˆ†å‘ä¸»åº“ä»¥åŠå¤‡åº“\n3. ä¸»â€”â€”ä¸»å¤åˆ¶ï¼ˆåŒä¸»ï¼‰\nå››ã€MySQL ä¸»ä¸»åŒæ­¥\né‡ç½®æ•°æ®åº“ï¼š\n1 2 3 # service mysqld stop # rm -rf /usr/local/mysql/data/* # /usr/local/mysql/scripts/mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data 1. mysql1 192.168.1.4:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@mysql1 ~]# vim /etc/my.cnf log-bin=mysql-bin server-id = 4 [root@mysql1 ~]# service mysqld start [root@mysql1 ~]# mysql mysql\u0026gt; reset master; mysql\u0026gt; grant replication slave, replication client on *.* -\u0026gt; to rep@\u0026#39;192.168.1.%\u0026#39; identified by \u0026#39;localhost\u0026#39;; mysql\u0026gt; flush privileges; mysql\u0026gt; change master to -\u0026gt; master_host=\u0026#39;192.168.1.251\u0026#39;, -\u0026gt; master_user=\u0026#39;rep\u0026#39;, -\u0026gt; master_password=\u0026#39;localhost\u0026#39;, -\u0026gt; master_log_file=\u0026#39;mysql-bin.000001\u0026#39;, -\u0026gt; master_log_pos=0; Query OK, 0 rows affected (0.02 sec) mysql\u0026gt; show slave status\\G 2. mysql2 192.168.1.251:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@mysql2 ~]# vim /etc/my.cnf log-bin=mysql-bin server-id = 251 [root@mysql2 ~]# service mysqld start [root@mysql2 ~]# mysql mysql\u0026gt; reset master; mysql\u0026gt; grant replication slave, replication client on *.* -\u0026gt; to rep@\u0026#39;192.168.1.%\u0026#39; identified by \u0026#39;localhost\u0026#39;; mysql\u0026gt; flush privileges; mysql\u0026gt; change master to -\u0026gt; master_host=\u0026#39;192.168.1.4\u0026#39;, -\u0026gt; master_user=\u0026#39;rep\u0026#39;, -\u0026gt; master_password=\u0026#39;localhost\u0026#39;, -\u0026gt; master_log_file=\u0026#39;mysql-bin.000001\u0026#39;, -\u0026gt; master_log_pos=0; Query OK, 0 rows affected (0.02 sec) mysql\u0026gt; show slave status\\G 3. mysql1,mysql2\n1 2 mysql\u0026gt; slave start; mysql\u0026gt; show slave status\\G 4. æµ‹è¯•\n5. å»ºç«‹ç”¨äºå®¢æˆ·è¿æ¥ç”¨æˆ·\n1 2 mysql\u0026gt; grant ALL on *.* to admin@\u0026#39;192.168.1.%\u0026#39; identified by \u0026#39;localhost\u0026#39;; mysql\u0026gt; flush privileges; ===========================================================================\nç”Ÿäº§ç¯å¢ƒå…¶ä»–å¸¸ç”¨è®¾ç½®\n1ã€é…ç½®å¿½ç•¥æƒé™åº“åŒæ­¥å‚æ•°\nbinlog-ignore-db=\u0026lsquo;information_schema mysql test\u0026rsquo;\n2ã€ä»åº“å¤‡ä»½å¼€å¯binlog\nlog-slave-updates\nlog_bin = mysql-bin\nexpire_logs_days = 7\nåº”ç”¨åœºæ™¯ï¼šçº§è”å¤åˆ¶æˆ–ä»åº“åšæ•°æ®å¤‡ä»½ã€‚\n3ã€ä»åº“åªè¯»read-onlyæ¥å®ç°\ninnodb_read_only = ONæˆ–1ï¼Œæˆ–è€…innodb_read_only\nç»“è®ºï¼šå½“ç”¨æˆ·æƒé™ä¸­æ²¡æœ‰SUPERæƒé™(ALLæƒé™æ˜¯åŒ…æ‹¬SUPERçš„)æ—¶ï¼Œä»åº“çš„read-onlyç”Ÿæ•ˆï¼\n","date":"2019-04-22T22:17:01Z","image":"https://www.ownit.top/title_pic/40.jpg","permalink":"https://www.ownit.top/p/201904222217/","title":"MySQLå¤åˆ¶æŠ€æœ¯"},{"content":"å¤åˆ¶æ•°æ®æ–‡ä»¶æ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨cpæˆ–tar\n1ã€åœæ­¢æœåŠ¡\n1 2 [root@localhost mysql]# systemctl stop mysqld [root@localhost mysql]# netstat -lnupt | grep 3306 2ã€å¤‡ä»½æ•°æ®æ–‡ä»¶\n1 2 3 cd /var/lib/mysql [root@localhost mysql]# mkdir -p /server/backup [root@localhost mysql]#tar czf /server/backup/all.`date +%F`.tar.gz * 3ã€å°†å¤‡ä»½æ–‡ä»¶æ‹·è´åˆ°ç›®æ ‡æœåŠ¡å™¨\n1 scp /server/backup/all.`date +%F`.tar.gz 192.168.95.12:/tmp 4ã€ç›®æ ‡æœåŠ¡å™¨åœæ­¢æœåŠ¡\n1 # systemctl stop mysqld 5ã€è§£å‹æ–‡ä»¶è‡³ç›®æ ‡æœåŠ¡å™¨æ•°æ®æ–‡ä»¶å¤¹\n1 # tar xf /tmp/all.tar.gz -C /usr/local/mysql/data ä¿®æ”¹æƒé™\n1 # chown -R mysql.mysql /usr/local/mysql/data 6ã€ç›®æ ‡æœåŠ¡å™¨å¯åŠ¨æœåŠ¡æµ‹è¯•\n1 # systemctl start mysqld ","date":"2019-04-21T22:28:12Z","image":"https://www.ownit.top/title_pic/06.jpg","permalink":"https://www.ownit.top/p/201904212228/","title":"MySQLæ•°æ®ç‰©ç†å¤‡ä»½ä¹‹taræ‰“åŒ…å¤‡ä»½"},{"content":"ä½¿ç”¨lvmå¿«ç…§å®ç°ç‰©ç†å¤‡ä»½ ä¼˜ç‚¹ï¼š\nå‡ ä¹æ˜¯çƒ­å¤‡(åˆ›å»ºå¿«ç…§å‰æŠŠè¡¨ä¸Šé”ï¼Œåˆ›å»ºå®Œåç«‹å³é‡Šæ”¾)\næ”¯æŒæ‰€æœ‰å­˜å‚¨å¼•æ“\nå¤‡ä»½é€Ÿåº¦å¿«\næ— éœ€ä½¿ç”¨æ˜‚è´µçš„å•†ä¸šè½¯ä»¶(å®ƒæ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«çš„)\nç¼ºç‚¹ï¼š\nå¯èƒ½éœ€è¦è·¨éƒ¨é—¨åè°ƒ(ä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„å‘½ä»¤ï¼ŒDBAä¸€èˆ¬æ²¡æƒé™)\næ— æ³•é¢„è®¡æœåŠ¡åœæ­¢æ—¶é—´\næ•°æ®å¦‚æœåˆ†å¸ƒåœ¨å¤šä¸ªå·ä¸Šæ¯”è¾ƒéº»çƒ¦(é’ˆå¯¹å­˜å‚¨çº§åˆ«è€Œè¨€)\næ“ä½œæµç¨‹ï¼š\n1ã€flush table with read locak;\n2ã€create snapshot\n3ã€show master status;ã€€show slave status;\n4ã€unlock tables;\n5ã€copy data from cow to backup\n6ã€remove snapshot\næ­£å¸¸å®‰è£…MySQLï¼š 1. å®‰è£…ç³»ç»Ÿ\n2. å‡†å¤‡LVMï¼Œä¾‹å¦‚ /dev/vg_localhost/lv-mysqlï¼Œmount /usr/local/mysql\n3. æºç å®‰è£…MySQLåˆ° /usr/local/mysql\nå¯é€‰æ“ä½œï¼šã€€å°†ç°åœ¨çš„æ•°æ®è¿ç§»åˆ°LVM\n1. å‡†å¤‡lvmåŠæ–‡ä»¶ç³»ç»Ÿ\n1 2 [root@localhost ~]# lvcreate -L 2G -n lv-mysql vg_localhost [root@localhost ~]# mkfs.ext4 /dev/vg_localhost/lv-mysql 2. å°†æ•°æ®è¿ç§»åˆ°LVM\n1 2 3 [root@localhost ~]# service mysqld stop [root@localhost ~]# mount /dev/vg_localhost/lv-mysql /mnt/ //ä¸´æ—¶æŒ‚è½½ç‚¹ [root@localhost ~]# rsync -va /usr/local/mysql/ /mnt/ //å°†MySQLåŸæ•°æ®é•œåƒåˆ°ä¸´æ—¶æŒ‚è½½ç‚¹ 1 2 3 4 5 [root@localhost ~]# umount /mnt/ [root@localhost ~]# mount /dev/vg_localhost/lv-mysql /usr/local/mysql //åŠ å…¥fstabå¼€æœºæŒ‚è½½ [root@localhost ~]# df -Th /dev/mapper/vg_localhost-lv--mysql ext4 2.0G 274M 1.7G 15% /usr/local/mysql [root@localhost ~]# service mysqld start æ‰‹åŠ¨åŸºäºLVMå¿«ç…§å®ç°å¤‡ä»½ï¼š 1. åŠ é”\n1 mysql\u0026gt; flush table with read lock; 2.åˆ›å»ºå¿«ç…§\n1 2 3 4 5 6 7 8 9 10 # lvcreate -L 500M -s -n lv-mysql-snap /dev/vg_localhost/lv-mysql # mysql -uroot -p123 -e \u0026#39;show master status\u0026#39; \u0026gt; /backup/`date +%F`_position.txt mysql\u0026gt; show master status; +-------------------+----------+--------------+------------------+-------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +-------------------+----------+--------------+------------------+-------------------+ | mysqld-bin.000016 | 542 | | | | +-------------------+----------+--------------+------------------+-------------------+ 3. é‡Šæ”¾é”\n1 mysql\u0026gt; unlock tables; 4. ä»å¿«ç…§ä¸­å¤‡ä»½\n1 2 3 [root@localhost ~]# mount -o ro /dev/vg_localhost/lv-mysql-snap /mnt/ [root@localhost ~]# mkdir /backup/`date +%F` [root@localhost ~]# rsync -a /mnt/ /backup/2014-09-02/ 5. ç§»é™¤å¿«ç…§\n1 2 [root@localhost ~]# umount /mnt/ [root@localhost ~]# lvremove -f /dev/vg_localhost/lv-mysql-snap è„šæœ¬ + Cron 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #!/bin/bash #LVM backmysql... back_dir=/backup/`date +%F` [ -d $back_dir ] || mkdir -p $back_dir mysql -uroot -p678 -e \u0026#39;flush table with read lock\u0026#39; lvcreate -L 500M -s -n lv-mysql-snap /dev/vg_localhost/lv-mysql mysql -uroot -p678 -e \u0026#39;show master status\u0026#39; |grep mysql \u0026gt; $back_dir/position.txt mysql -uroot -p678 -e \u0026#39;flush logs\u0026#39; mysql -uroot -p678 -e \u0026#39;unlock tables\u0026#39; mount -o ro /dev/vg_localhost/lv-mysql-snap /mnt/ rsync -a /mnt/ $back_dir if [ $? -eq 0 ];then umount /mnt/ lvremove -f /dev/vg_localhost/lv-mysql-snap fi mylvmbackup åŠŸèƒ½ï¼šåˆ©ç”¨LVMå¿«ç…§å®ç°ç‰©ç†å¤‡ä»½ï¼Œå³LVMå¿«ç…§å¤‡ä»½çš„è‡ªåŠ¨ç‰ˆ\nå®‰è£…perlæ¨¡å—\n1. åœ¨çº¿å®‰è£…\n1 http://www.lenzg.net/mylvmbackup å®ƒä¾èµ–äºperl æ¨¡å—ï¼Œå¯ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…\n1 perl -MCPAN -e \u0026#39;install Config::IniFiles\u0026#39; 2. ç¦»çº¿å®‰è£…\n1 # yum -y install atrpms-77-1.noarch.rpm perl-Config-IniFiles-2.72-3.em.el6.noarch.rpm perl-File-Copy-Recursive-0.38-1.el6.rfx.noarch.rpm perl-IO-stringy-2.110-8.el6.noarch.rpm å®‰è£…mylvmbackupè½¯ä»¶åŒ…\n1 # yum -y install mylvmbackup-0.15-0.noarch.rpm å¤‡ä»½æ–¹æ³•ä¸€ï¼š\n1 2 # mylvmbackup --user=root --password=111 --host=localhost --mycnf=/etc/my.cnf --vgname=vg_localhost --lvname=lv-mysql --backuptype=tar --lvsize=100M --backupdir=/ backup 1 2 3 4 [root@localhost backup]# tar xf backup-20140903_000236_mysql.tar.gz [root@localhost backup]# ls backup backup-cnf-20140903_000236_mysql backup-20140903_000236_mysql.tar.gz backup-pos å¤‡ä»½æ–¹æ³•äºŒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 [root@server ~]# vim /etc/mylvmbackup.conf [mysql] #è¿æ¥æ•°æ®åº“é…ç½® user=root password=123456 host=localhost port=3306 socket=/tmp/mysql.sock mycnf=/etc/my.cnf [lvm] #LVMé€»è¾‘å·çš„é…ç½® vgname=vg_server #å·ç»„åç§° lvname=lv_mysql #é€»è¾‘å·åç§° backuplv=mysql_snap #å¿«ç…§å·åç§° lvsize=500M [fs] #æ–‡ä»¶ç³»ç»Ÿé…ç½® xfs=0 mountdir=/var/tmp/mylvmbackup/mnt/ #æŒ‚è½½ç›®å½• backupdir=/backup #å¤‡ä»½ç›®å½•ï¼Œä¹Ÿå¯ä»¥å¤‡ä»½åˆ°è¡Œç¨‹ä¸»æœº [misc] #å®šä¹‰å¤‡ä»½é€‰é¡¹ backuptype=tar #å®šä¹‰å¤‡ä»½çš„ç±»å‹ backupretention=0 prefix=backup #å®šä¹‰å¤‡ä»½æ–‡ä»¶åå‰ç¼€ suffix=_mysql #å®šä¹‰å¤‡ä»½æ–‡ä»¶ååç¼€ tararg=cvf #å®šä¹‰tarå‚æ•°ï¼Œé»˜è®¤ä¸ºcvf tarfilesuffix=.tar.gz #å®šä¹‰å¤‡ä»½æ–‡ä»¶åç¼€åæ ¼å¼ datefmt=%Y%m%d_%H%M%S #å®šä¹‰å¤‡ä»½æ–‡ä»¶åæ—¶é—´æˆ³æ ¼å¼ keep_snapshot=0 #æ˜¯å¦ä¿ç•™snaphot keep_mount=0 #æ˜¯å¦å¸è½½snaphot quiet=0 #å®šä¹‰è®°å½•æ—¥å¿—ç±»å‹ æ³¨é‡Šï¼šå…¶ä»–é…ç½®ä¿æŒè¾“å…¥å³å¯ ç„¶åç›´æ¥æ‰§è¡Œmylvmbackupå³å¯\n","date":"2019-04-21T22:24:57Z","image":"https://www.ownit.top/title_pic/60.jpg","permalink":"https://www.ownit.top/p/201904212224/","title":"MySQLæ•°æ®ç‰©ç†å¤‡ä»½ä¹‹lvmå¿«ç…§"},{"content":"percona-xtrabackup å®ƒæ˜¯å¼€æºå…è´¹çš„æ”¯æŒMySQL æ•°æ®åº“çƒ­å¤‡ä»½çš„è½¯ä»¶ï¼Œå®ƒèƒ½å¯¹InnoDBå’ŒXtraDBå­˜å‚¨å¼•æ“çš„æ•°æ®åº“éé˜»å¡åœ°å¤‡ä»½ã€‚å®ƒä¸æš‚åœæœåŠ¡åˆ›å»ºInnodbçƒ­å¤‡ä»½ï¼›\nä¸ºmysqlåšå¢é‡å¤‡ä»½ï¼›åœ¨mysqlæœåŠ¡å™¨ä¹‹é—´åšåœ¨çº¿è¡¨è¿ç§»ï¼›ä½¿åˆ›å»ºreplicationæ›´åŠ å®¹æ˜“ï¼›å¤‡ä»½mysqlè€Œä¸å¢åŠ æœåŠ¡å™¨çš„è´Ÿè½½ã€‚\nperconaæ˜¯ä¸€å®¶è€ç‰Œçš„mysqlæŠ€æœ¯å’¨è¯¢å…¬å¸ã€‚å®ƒä¸ä»…æä¾›mysqlçš„æŠ€æœ¯æ”¯æŒã€åŸ¹è®­ã€å’¨è¯¢ï¼Œè¿˜å‘å¸ƒäº†mysqlçš„åˆ†æ”¯ç‰ˆæœ¬\u0026ndash;percona Serverã€‚å¹¶å›´ç»•\npercona Serverè¿˜å‘å¸ƒäº†ä¸€ç³»ç»Ÿçš„mysqlå·¥å…·ã€‚\n=================================================================================\nå®Œå…¨å¤‡ä»½ å¢é‡å¤‡ä»½ å·®å¼‚å¤‡ä»½ xtrabackup\nXtrabackupæ˜¯ä¸€ä¸ªå¯¹InnoDBåšæ•°æ®å¤‡ä»½çš„å·¥å…·ï¼Œæ”¯æŒåœ¨çº¿çƒ­å¤‡ä»½ï¼ˆå¤‡ä»½æ—¶ä¸å½±å“æ•°æ®è¯»å†™ï¼‰ï¼Œæ˜¯å•†ä¸šå¤‡ä»½å·¥å…·InnoDB Hotbackupçš„ä¸€ä¸ªå¾ˆå¥½çš„æ›¿ä»£å“ã€‚\nXtrabackupæœ‰ä¸¤ä¸ªä¸»è¦çš„å·¥å…·ï¼šxtrabackupã€innobackupex\nxtrabackup åªèƒ½å¤‡ä»½InnoDBå’ŒXtraDBä¸¤ç§æ•°æ®è¡¨ï¼Œè€Œä¸èƒ½å¤‡ä»½MyISAMæ•°æ®è¡¨ã€‚ innobackupex æ˜¯å‚è€ƒäº†InnoDB Hotbackupçš„innobackè„šæœ¬ä¿®æ”¹è€Œæ¥çš„.innobackupexæ˜¯ä¸€ä¸ªperlè„šæœ¬å°è£…ï¼Œå°è£…äº†xtrabackupã€‚ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿çš„åŒæ—¶å¤‡ä»½InnoDBå’ŒMyISAMå¼•æ“çš„è¡¨ï¼Œä½†åœ¨å¤„ç†myisamæ—¶éœ€è¦åŠ ä¸€ä¸ªè¯»é”ã€‚å¹¶ä¸”åŠ å…¥äº†ä¸€äº›ä½¿ç”¨çš„é€‰é¡¹ã€‚å¦‚slave-infoå¯ä»¥è®°å½•å¤‡ä»½æ¢å¤åä½œä¸ºslaveéœ€è¦çš„ä¸€äº›ä¿¡æ¯ï¼Œæ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„åˆ©ç”¨å¤‡ä»½æ¥é‡åšslaveã€‚æ”¯æŒå®Œå…¨å¤‡ä»½å’Œå¢é‡å¤‡ä»½\nå¤‡ä»½è¿‡ç¨‹å¿«é€Ÿã€å¯é ï¼› å¤‡ä»½è¿‡ç¨‹ä¸ä¼šæ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡ï¼› èƒ½å¤ŸåŸºäºå‹ç¼©ç­‰åŠŸèƒ½èŠ‚çº¦ç£ç›˜ç©ºé—´å’Œæµé‡ï¼› è‡ªåŠ¨å®ç°å¤‡ä»½æ£€éªŒï¼› è¿˜åŸé€Ÿåº¦å¿«ï¼› ä½¿ç”¨innobakupexå¤‡ä»½æ—¶ï¼Œå…¶ä¼šè°ƒç”¨xtrabackupå¤‡ä»½æ‰€æœ‰çš„InnoDBè¡¨ï¼Œå¤åˆ¶æ‰€æœ‰å…³äºè¡¨ç»“æ„å®šä¹‰çš„ç›¸å…³æ–‡ä»¶(.frm)ã€ä»¥åŠMyISAMã€MERGEã€CSVå’ŒARCHIVEè¡¨çš„ç›¸å…³æ–‡ä»¶ï¼ŒåŒæ—¶è¿˜ä¼šå¤‡ä»½è§¦å‘å™¨å’Œæ•°æ®åº“é…ç½®ä¿¡æ¯ç›¸å…³çš„æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶ä¼šè¢«ä¿å­˜è‡³ä¸€ä¸ªä»¥æ—¶é—´å‘½ä»¤çš„ç›®å½•ä¸­ã€‚\n(1)xtrabackup_checkpoints â€”â€” å¤‡ä»½ç±»å‹ï¼ˆå¦‚å®Œå…¨æˆ–å¢é‡ï¼‰ã€å¤‡ä»½çŠ¶æ€ï¼ˆå¦‚æ˜¯å¦å·²ç»ä¸ºpreparedçŠ¶æ€ï¼‰å’ŒLSN(æ—¥å¿—åºåˆ—å·)èŒƒå›´ä¿¡æ¯ï¼›æ¯ä¸ªInnoDBé¡µ(é€šå¸¸ä¸º16kå¤§å°)éƒ½ä¼šåŒ…å«ä¸€ä¸ªæ—¥å¿—åºåˆ—å·ï¼Œå³LSNã€‚LSNæ˜¯æ•´ä¸ªæ•°æ®åº“ç³»ç»Ÿçš„ç³»ç»Ÿç‰ˆæœ¬å·ï¼Œæ¯ä¸ªé¡µé¢ç›¸å…³çš„LSNèƒ½å¤Ÿè¡¨æ˜æ­¤é¡µé¢æœ€è¿‘æ˜¯å¦‚ä½•å‘ç”Ÿæ”¹å˜çš„ã€‚\n(2)xtrabackup_binlog_info â€”â€” mysqlæœåŠ¡å™¨å½“å‰æ­£åœ¨ä½¿ç”¨çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶åŠè‡³å¤‡ä»½è¿™ä¸€åˆ»ä¸ºæ­¢äºŒè¿›åˆ¶æ—¥å¿—äº‹ä»¶çš„ä½ç½®ã€‚(3)xtrabackup_binlog_pos_innodb â€”â€” äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶åŠç”¨äºInnoDBæˆ–XtraDBè¡¨çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶çš„å½“å‰positionã€‚\n(4)xtrabackup_binary â€”â€” å¤‡ä»½ä¸­ç”¨åˆ°çš„xtrabackupçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼›\n(5)backup-my.cnf â€”â€” å¤‡ä»½å‘½ä»¤ç”¨åˆ°çš„é…ç½®é€‰é¡¹ä¿¡æ¯ï¼›\nå®‰è£…xtrabackup\n1 2 3 4 5 6 7 8 9 [root@localhost ~]# yum -y install percona-xtrabackup-2.1.9-744.rhel6.x86_64.rpm [root@localhost ~]# rpm -ql percona-xtrabackup |grep bin /usr/bin/innobackupex æ”¯æŒmyisamã€innodb /usr/bin/innobackupex-1.5.1 /usr/bin/xbcrypt /usr/bin/xbstream /usr/bin/xtrabackup ä»…é€‚ç”¨äºpercona Server /usr/bin/xtrabackup_55 é€‚ç”¨mysql 5.5æ•°æ®åº“ /usr/bin/xtrabackup_56 é€‚ç”¨mysql5.6æ•°æ®åº“ å®Œæ•´å¤‡ä»½å®ä¾‹ ï¼š\n==å¤‡ä»½==\n1 2 3 4 5 6 [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 /mysqlbackup/full [root@localhost ~]# ls /mysqlbackup/full/2015-09-15_11-03-03/ backup-my.cnf company mysql school test xtrabackup_binary xtrabackup_checkpoints bbs ibdata1 performance_schema shop weibo xtrabackup_binlog_info xtrabackup_logfile [root@localhost 2015-09-15_11-03-03]# cat xtrabackup_binlog_info localhost-bin.000003 2090096 ==æ¢å¤==\na. å‡†å¤‡æ–°ç¯å¢ƒ\n1 2 3 4 5 [root@localhost ~]# rm -rf /usr/local/mysql/data [root@localhost ~]# chown -R mysql.mysql /usr/local/mysql [root@localhost ~]# /usr/local/mysql/scripts/mysql_install_db --user=mysql --basedir=/usr/local/mysql/ --datadir=/usr/local/mysql/data [root@localhost ~]# killall -9 mysqld [root@localhost ~]# service mysqld start b. æ¢å¤\n1 2 3 4 5 6 7 [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --apply-log /mysqlbackup/full/2015-09-15_11-03-03/ [root@localhost ~]# rm -rf /usr/local/mysql/data/* [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --copy-back /mysqlbackup/full/2015-09-15_11-03-03/ [root@localhost ~]# cd /usr/local/mysql [root@localhost ~]# chown -R mysql.mysql . [root@localhost ~]# killall -9 mysqld [root@localhost ~]# service mysqld start å¢é‡å¤‡ä»½å®ä¾‹ï¼š ==å¤‡ä»½==\n1ã€å®Œæ•´å¤‡ä»½ï¼šå‘¨ä¸€\n1 2 3 4 5 create database testdb; use testdb; create table test(id int); insert into test values(1); select * from test; 1 [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 /mysqlbackup/full 2ã€å¢é‡å¤‡ä»½ï¼šå‘¨äºŒã€€â€”â€”ã€€å‘¨å…­\n1 2 3 insert into testdb.test values(2); [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --incremental /mysqlbackup/incremental --incremental-basedir=å®Œå…¨å¤‡ä»½ç›®å½• 1 2 3 insert into testdb.test values(3); [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --incremental /mysqlbackup/incremental --incremental-basedir=ä¸Šæ¬¡å¢é‡ç›®å½• 1 2 3 insert into testdb.test values(4); [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --incremental /mysqlbackup/incremental --incremental-basedir=ä¸Šæ¬¡å¢é‡ç›®å½• ==æ¢å¤== 1.æ¢å¤å…¨é‡çš„redo log\n1 [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --apply-log --redo-only /mysqlbackup/full/... 2.æ¢å¤å¢é‡çš„redo log\n1 2 [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --apply-log --redo-only /mysqlbackup/full/... --incremental-dir=/mysqlbackup/incremental/ç¬¬ä¸€æ¬¡å¢é‡ 1 2 [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --apply-log --redo-only /mysqlbackup/full/... --incremental-dir=/mysqlbackup/incremental/ç¬¬äºŒæ¬¡å¢é‡ 1 2 [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --apply-log --redo-only /mysqlbackup/full/... --incremental-dir=/mysqlbackup/incremental/ç¬¬ï¼®æ¬¡å¢é‡ 3.å…³é—­mysqldï¼Œæ›¿æ¢æ•°æ®æ–‡ä»¶(cp,rsyn,innobackupex copy-back)ï¼Œä¿®æ”¹æƒé™\n4.å¯åŠ¨mysqld\n5.é€šè¿‡binlogå¢é‡æ¢å¤\n1 2 3 4 5 6 7 create database testdb; use testdb; create table test(id int); insert into test values(1); select * from test; [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 /mysqlbackup/full å·®å¼‚å¤‡ä»½å®ä¾‹ï¼š ==å¤‡ä»½==\n1ã€å®Œæ•´å¤‡ä»½ï¼šå‘¨ä¸€\n2ã€å·®å¼‚å¤‡ä»½ï¼šå‘¨äºŒã€€â€”â€”ã€€å‘¨å…­\n1 2 3 insert into testdb.test values(2); [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --incremental /mysqlbackup/incremental --incremental-basedir=å®Œå…¨å¤‡ä»½ç›®å½• 1 2 3 insert into testdb.test values(3); [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --incremental /mysqlbackup/incremental --incremental-basedir=å®Œå…¨å¤‡ä»½ç›®å½• 1 2 3 insert into testdb.test values(4); [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --incremental /mysqlbackup/incremental --incremental-basedir=å®Œå…¨å¤‡ä»½ç›®å½• ==æ¢å¤== 1.æ¢å¤å…¨é‡çš„redo log\n1 [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --apply-log --redo-only /mysqlbackup/full/... 2.æ¢å¤å·®å¼‚çš„redo log\n1 2 [root@localhost ~]# innobackupex --host=localhost --socket=/tmp/mysql.sock --defaults-file=/etc/my.cnf --user=root --password=888 --apply-log --redo-only /mysqlbackup/full/... --incremental-dir=/mysqlbackup/incremental/æŸä¸ªå·®å¼‚å¤‡ä»½ 3.å…³é—­mysqldï¼Œæ›¿æ¢æ•°æ®æ–‡ä»¶(cp,rsyn)ï¼Œä¿®æ”¹æƒé™\n4.å¯åŠ¨mysqld\n5.é€šè¿‡binlogå¢é‡æ¢å¤\nå¤‡ä»½å•åº“ã€å¤šåº“ã€å¤šè¡¨å•æ•°æ®åº“å¤‡ä»½\ninnobackupex --defaults-file=/etc/my.cnf --socket=/tmp/mysql.sock --databases=uplook --no-timestamp /server/backup/uplook\nå¤šæ•°æ®åº“å¤‡ä»½innobackupex --user=root --password=123456 --include=\u0026lsquo;dba.*|dbb.*\u0026rsquo; /server/backup\nå¤šè¡¨å¤‡ä»½æ–¹æ³•ä¸€ï¼šinnobackupex --user=root --password=123456 --include=\u0026lsquo;dba.tablea|dbb.tableb\u0026rsquo; /server/backup\næ–¹æ³•äºŒï¼šä½¿ç”¨\u0026ndash;tables-fileå‚æ•°ï¼Œè¿™ç§æ–¹å¼æ˜¯å°†æ‰€æœ‰è¦å¤‡ä»½çš„å®Œæ•´è¡¨åéƒ½å†™åœ¨ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œæ¯è¡Œä¸€ä¸ªå®Œæ•´è¡¨åï¼Œç„¶åç¨‹åºè¯»å–è¿™ä¸ªæ–‡æœ¬æ–‡ä»¶è¿›è¡Œå¤‡ä»½ã€‚å®Œæ•´è¡¨åå³ï¼šdatabasename.tablename\necho \u0026ldquo;lianxi.Student\u0026rdquo; \u0026gt;/tmp/table1.txt\ninnobackupex --defaults-file=/etc/my.cnf --socket=/tmp/mysql.sock --tables-file=\u0026rsquo;/tmp/table1.txt\u0026rsquo; --no-timestamp /server/backup/table1\næ¢å¤å•åº“ã€å¤šåº“ã€å¤šè¡¨å•æ•°æ®åº“æ¢å¤åº”ç”¨æ—¥å¿—ï¼š\ninnobackupex --apply-log /server/backup/uplook\nåˆ é™¤æ•°æ®åº“æ•°æ®æ–‡ä»¶ï¼šsystemctl stop mysqlï¼›rm -rf /usr/local/mysql/data/*\nè¿˜åŸæ•°æ®ï¼šinnobackupex --copy-back /server/backup/uplook\næˆæƒï¼šchown -R mysql.mysql /usr/local/mysql\nåˆå§‹åŒ–æ•°æ®åº“ï¼š/usr/local/mysql/scripts/mysql_install_db --user=mysql --datadir=/usr/local/mysql/data --basedir=/usr/local/mysql --explicit_defaults_for_timestamp\nå¯åŠ¨æ•°æ®åº“ï¼šsystemctl start mysql\næµ‹è¯•ï¼šmysql -e \u0026ldquo;select * from uplook.Student;\u0026rdquo;\nå¤šè¡¨æ•°æ®æ¢å¤åº”ç”¨æ—¥å¿—ï¼š\ninnobackupex --apply-log --export /server/backup/table1/\nå®šä¹‰è¡¨\u0026ndash;åˆ é™¤è¡¨ç©ºé—´\u0026ndash;æ‹·è´*.ibd/*.cfgæ–‡ä»¶\u0026ndash;å¯¼å…¥è¡¨ç©ºé—´\nå®šä¹‰è¡¨ï¼šæ¨¡æ‹Ÿåˆ é™¤è¡¨ï¼Œé‡æ–°å®šä¹‰è¡¨ç»“æ„ï¼Œè¿‡ç¨‹ç•¥\nåˆ é™¤è¡¨ç©ºé—´ï¼šmysql\u0026gt; ALTER TABLE Student DISCARD TABLESPACE;\næ‹·è´*.ibd/*.cfgæ–‡ä»¶ï¼š[root@localhost ~]# cp /server/backup/table1/lianxi/Student.{cfg,ibd} /usr/local/mysql/data/lianxi/\n[root@localhost ~]# chown -R mysql.mysql /usr/local/mysql/data/lianxi/\nå¯¼å…¥è¡¨ç©ºé—´ï¼šmysql\u0026gt; ALTER TABLE Student IMPORT TABLESPACE;\næµ‹è¯•ï¼šmysql\u0026gt; select * from Student;\n","date":"2019-04-21T22:18:59Z","image":"https://www.ownit.top/title_pic/48.jpg","permalink":"https://www.ownit.top/p/201904212218/","title":"MySQLæ•°æ®ç‰©ç†å¤‡ä»½ä¹‹xtrabackup"},{"content":"é€»è¾‘å¤‡ä»½ï¼š å¤‡ä»½çš„æ˜¯å»ºè¡¨ã€å»ºåº“ã€æ’å…¥ç­‰æ“ä½œæ‰€æ‰§è¡ŒSQLè¯­å¥ï¼Œé€‚ç”¨äºä¸­å°å‹æ•°æ®åº“ï¼Œæ•ˆç‡ç›¸å¯¹è¾ƒä½ã€‚\nmysqldump\nmydumper\nä½¿ç”¨mysqldumpå®ç°é€»è¾‘å¤‡ä»½\nè¯­æ³•ï¼š\n# mysqldump -h æœåŠ¡å™¨ -uç”¨æˆ·å -på¯†ç  æ•°æ®åº“å \u0026gt; å¤‡ä»½æ–‡ä»¶.sql\nå…³äºæ•°æ®åº“åï¼š\n-A, --all-databases æ‰€æœ‰åº“\nschool æ•°æ®åº“å\nschool stu_info t1 schoolæ•°æ®åº“çš„è¡¨stu_infoã€t1\n-B, --databases bbs test mysql å¤šä¸ªæ•°æ®åº“\nå…³äºå…¶å®ƒå‚æ•°è¯´æ˜ï¼š\n--single-transaction #åŸºäºæ­¤é¡¹å¯ä»¥å®ç°å¯¹InnoDBè¡¨åšçƒ­å¤‡ä»½\n-x, --lock-all-tablesÂ #æ‰§è¡Œå¤‡ä»½æ—¶ä¸ºæ‰€æœ‰è¡¨è¯·æ±‚åŠ é” MyISAM\n-l, --lock-tables\n-E, --eventsÂ #å¤‡ä»½äº‹ä»¶è°ƒåº¦å™¨ä»£ç \n--optÂ #åŒæ—¶å¯åŠ¨å„ç§é«˜çº§é€‰é¡¹\n-R, --routinesÂ #å¤‡ä»½å­˜å‚¨è¿‡ç¨‹å’Œå­˜å‚¨å‡½æ•°\n-F, --flush-logsÂ #å¤‡ä»½ä¹‹å‰åˆ·æ–°æ—¥å¿—\n--triggersÂ #å¤‡ä»½è§¦å‘å™¨\n--master-data=2Â #å¤‡åº“ï¼Œè¯¥é€‰é¡¹å°†ä¼šè®°å½•binlogçš„æ—¥å¿—ä½ç½®ä¸æ–‡ä»¶åå¹¶è¿½åŠ åˆ°æ–‡ä»¶ä¸­ï¼Œå¦‚æœä¸º1å°†ä¼šè¾“å‡ºCHANGE MASTERå‘½ä»¤ï¼Œä¸»ä»ä¸‹æœ‰ç”¨\næ³¨æ„ï¼š-B ä½œç”¨ï¼šåˆ›å»ºæ•°æ®åº“å’Œåˆ‡æ¢åˆ°æ•°æ®åº“ï¼Œæ¢å¤æ—¶ä¸ç”¨åˆ›å»ºæ•°æ®åº“å’Œåˆ è¡¨ã€‚å¤‡ä»½å¤šä¸ªåº“ï¼Œ-B æ•°æ®åº“1 æ•°æ®åº“2 .\n-dåªå¤‡ä»½åº“ç»“æ„ï¼Œä¸åŒ…å«æ•°æ®å†…å®¹\nå¤‡ä»½ï¼šmysqldump -u ç”¨æˆ·å -p æ•°æ®åº“å è¡¨å \u0026gt; å¤‡ä»½çš„æ–‡ä»¶å\nå¤‡ä»½å¤šä¸ªè¡¨ï¼šmysqldump -u ç”¨æˆ·å -p æ•°æ®åº“å è¡¨å1 è¡¨å2 \u0026gt; å¤‡ä»½çš„æ–‡ä»¶å\nç¤ºä¾‹ï¼š\nå¤‡ä»½jiaowuæ•°æ®åº“ï¼Œåå­—ä¸ºhei.sql\næ˜¾ç¤ºæ•°æ®åº“\n1 [root@wei ~]# mysql -uroot -proot -e \u0026#39;show databases;\u0026#39; å¤‡ä»½æ•°æ®åº“\n1 [root@wei ~]# mysqldump -uroot -proot jiaowu \u0026gt;hei.sql ==å¤‡ä»½==\n1 2 3 4 [root@localhost ~]# mysqldump -uroot -proot --single-transaction --master-data=2 company \u0026gt; /tmp/company_`date +%F-%H-%M`.sql [root@localhost ~]# mysqldump -uroot -proot --single-transaction --master-data=2 school \u0026gt; /tmp/school_`date +%F-%H-%M`.sql [root@localhost ~]# mysqldump -uroot -proot --single-transaction --master-data=2 school |gzip \u0026gt; /tmp/school_`date +%F-%H-%M`.gz [root@localhost ~]# mysqldump -uroot -proot --routines --events --triggers --master-data=2 --flush-logs --all-databases \u0026gt; /backup/all_`date +%F`.sql ==æ¢å¤==\n1 2 3 4 [root@localhost ~]# mysql -uroot -p888 -e \u0026#39;create database school\u0026#39; [root@localhost ~]# mysql -uroot -p888 school \u0026lt; /tmp/school_2015-09-14-15-40.sql root@(school)\u0026gt; source /tmp/school_2015-09-14-15-40.sql [root@localhost tmp]# gunzip -fc school_2015-09-14-15-09.gz | mysql -uroot -p888 school ==å¢é‡å¤‡ä»½==\nå¢é‡å¤‡ä»½å‰æï¼š\n1ï¼‰my.cnfï¼Œæ˜¯è¦å¼€å¯MySQL log-binæ—¥å¿—åŠŸèƒ½ï¼Œé‡å¯MySQLÂ log_bin = /data/mysql/data/mysql-bin\n2ï¼‰å­˜åœ¨ä¸€ä¸ªå®Œå…¨å¤‡ä»½ï¼Œç”Ÿäº§ç¯å¢ƒä¸€èˆ¬å‡Œæ™¨æŸä¸ªæ—¶åˆ»è¿›è¡Œå…¨å¤‡\nç¤ºä¾‹ï¼š\n1 mysqldump -uroot -p --default-character-set=gbk --single-transaction -F -B school |gzip \u0026gt; /server/backup/school_$(date +%F).sql.gz InnoDB è¡¨åœ¨å¤‡ä»½æ—¶ï¼Œé€šå¸¸å¯ç”¨é€‰é¡¹ --single-transaction æ¥ä¿è¯å¤‡ä»½çš„ä¸€è‡´æ€§\nå¢é‡å¤‡ä»½\u0026ndash;æ¢å¤è¿‡ç¨‹\n1ã€æ£€æŸ¥å‡Œæ™¨å¤‡ä»½\n2ã€æ£€æŸ¥å…¨å¤‡åçš„æ‰€æœ‰binlog # ls -lrt /usr/local/mysql/data/mysql-bin.*\n3ã€ç«‹å³åˆ·æ–°å¹¶å¤‡ä»½å‡ºbinlog mysqladmin -uroot -p flush-logs\ncp /usr/local/mysql/data/mysql-bin.000004 /server/backup/\næç¤ºï¼šæ ¹æ®æ—¶é—´ç‚¹åŠå‰ä¸€ä¸ªbinlogå¯ä»¥çŸ¥é“å‘ç°é—®é¢˜æ—¶åˆ»å‰binlogæ—¥å¿—ä¸ºmysql-bin.000004\n4ã€æ¢å¤binlogç”Ÿæˆsqlè¯­å¥mysqlbinlog mysql-bin.000004 \u0026gt; bin.log\n5ã€æ¢å¤å‡Œæ™¨å¤‡ä»½\n6ã€æ¢å¤å¢é‡å¤‡ä»½\nmysqlbinlogå¢é‡æ¢å¤æ–¹å¼\nåŸºäºæ—¶é—´ç‚¹æ¢å¤\n1ï¼‰æŒ‡å®šå¼€å§‹æ—¶é—´åˆ°ç»“æŸæ—¶é—´ myslbinlog mysqlbin.000008 --start-datetime=â€™2014-10-45 01:10:46â€™ --stop-datetime=â€™2014-10-45 03:10:46â€™-r time.sql\n2ï¼‰æŒ‡å®šå¼€å§‹æ—¶é—´åˆ°æ–‡ä»¶ç»“æŸ myslbinlog mysqlbin.000008 --start-datetime=â€™2014-10-45 01:10:46â€™ -d esen -r time.sql\n3ï¼‰ä»æ–‡ä»¶å¼€å¤´åˆ°æŒ‡å®šç»“æŸæ—¶é—´ myslbinlog mysqlbin.000008 --stop-datetime=â€™2014-10-45 03:10:46â€™ -d esen -r time.sql\nåŸºäºä½ç½®ç‚¹çš„å¢é‡æ¢å¤\n1ï¼‰æŒ‡å®šå¼€å§‹ä½ç½®åˆ°ç»“æŸä½ç½® myslbinlog mysqlbin.000008 --start-position=510 --stop-position=1312 -r pos.sql\n2ï¼‰æŒ‡å®šå¼€å§‹ä½ç½®åˆ°æ–‡ä»¶ç»“æŸ myslbinlog mysqlbin.000008 --start-position=510 -r pos.sql\n3ï¼‰ä»æ–‡ä»¶å¼€å§‹ä½ç½®åˆ°æŒ‡å®šç»“æŸä½ç½® myslbinlog mysqlbin.000008 --stop-position=1312 -r pos.sql\n==æ¢å¤binlog==\nå•åº“ï¼Ÿå…¨åº“\n1 2 3 4 [root@localhost ~]# mysqlbinlog -d school localhost-bin.000002 --start-position=11574908 \u0026gt; school-bin.sql [root@localhost ~]# mysqlbinlog -d school localhost-bin.000003 \u0026gt;\u0026gt; school-bin.sql [root@localhost ~]# mysqlbinlog -d school localhost-bin.000004 \u0026gt;\u0026gt; school-bin.sql [root@localhost ~]# mysql -uroot -p888 school \u0026lt; school-bin.sql å®ç°è‡ªåŠ¨åŒ–å¤‡ä»½ï¼ˆæ•°æ®åº“å°ï¼‰\nå¤‡ä»½è®¡åˆ’ï¼š\n1. ä»€ä¹ˆæ—¶é—´ 2:00\n2. å¯¹å“ªäº›æ•°æ®åº“å¤‡ä»½\n3. å¤‡ä»½æ–‡ä»¶æ”¾çš„ä½ç½®\nå¤‡ä»½è„šæœ¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@yang ~]# vim /mysql_back.sql #!/bin/bash back_dir=/backup back_file=`date +%F`_all.sql user=root pass=123 if [ ! -d /backup ];then mkdir -p /backup fi # å¤‡ä»½å¹¶æˆªæ–­æ—¥å¿— mysqldump -u${user} -p${pass} --lock-all-tables --routines --events --triggers --master-data=2 --flush-logs --all-databases \u0026gt; /$back_dir/$back_file # åªä¿ç•™æœ€è¿‘ä¸€å‘¨çš„å¤‡ä»½ cd $back_dir find . -mtime +7 -exec rm -rf {} \\; æ‰‹åŠ¨æµ‹è¯•ï¼š\n1 2 3 [root@yang ~]# chmod a+x /mysql_back.sql [root@yang ~]# chattr +i /mysql_back.sql [root@yang ~]# /mysql_back.sql é…ç½®cronï¼š\n1 2 [root@yang ~]# crontab -e 0 2 * * * /mysql_back.sql Mydumperä»‹ç» Mydumperæ˜¯ä¸€ä¸ªé’ˆå¯¹MySQLå’ŒDrizzleçš„é«˜æ€§èƒ½å¤šçº¿ç¨‹å¤‡ä»½å’Œæ¢å¤å·¥å…·ã€‚å¼€å‘äººå‘˜ä¸»è¦æ¥è‡ªMySQL,Facebook,SkySQLå…¬å¸ã€‚ç›®å‰å·²ç»åœ¨ä¸€äº›çº¿ä¸Šä½¿ç”¨äº†Mydumperã€‚\nMydumperä¸»è¦ç‰¹æ€§ï¼š\nâ€¢ è½»é‡çº§Cè¯­è¨€å†™çš„\nâ€¢ æ‰§è¡Œé€Ÿåº¦æ¯”mysqldumpå¿«10å€\nâ€¢ äº‹åŠ¡æ€§å’Œéäº‹åŠ¡æ€§è¡¨ä¸€è‡´çš„å¿«ç…§(é€‚ç”¨äº0.2.2ä»¥ä¸Šç‰ˆæœ¬)\nâ€¢ å¿«é€Ÿçš„æ–‡ä»¶å‹ç¼©\nâ€¢ æ”¯æŒå¯¼å‡ºbinlog\nâ€¢ å¤šçº¿ç¨‹æ¢å¤(é€‚ç”¨äº0.2.1ä»¥ä¸Šç‰ˆæœ¬)\nâ€¢ ä»¥å®ˆæŠ¤è¿›ç¨‹çš„å·¥ä½œæ–¹å¼ï¼Œå®šæ—¶å¿«ç…§å’Œè¿ç»­äºŒè¿›åˆ¶æ—¥å¿—(é€‚ç”¨äº0.5.0ä»¥ä¸Šç‰ˆæœ¬)\nâ€¢ å¼€æº (GNU GPLv3)\n1 2 3 4 5 6 7 #wget https://launchpadlibrarian.net/225370879/mydumper-0.9.1.tar.gz # yum -y install glib2-devel mysql-devel zlib-devel pcre-devel [root@localhost ~]# tar xf mydumper-0.9.1.tar.gz -C /usr/local/src/ [root@localhost ~]# cd /usr/local/src/mydumper-0.9.1/ # cmake . # make # make install mydumperå‚æ•°ä»‹ç»ï¼š\n-d, --directory å¯¼å…¥å¤‡ä»½ç›®å½•\n-q, --queries-per-transaction æ¯æ¬¡æ‰§è¡Œçš„æŸ¥è¯¢æ•°é‡, é»˜è®¤1000\n-o, --overwrite-tables å¦‚æœè¡¨å­˜åœ¨åˆ é™¤è¡¨\n-B, --database éœ€è¦å¤‡ä»½çš„åº“\n-T, --tables-list éœ€è¦å¤‡ä»½çš„è¡¨ï¼Œç”¨ï¼Œåˆ†éš”\n-o, --outputdir è¾“å‡ºç›®å½•\n-s, --statement-size Attempted size of INSERT statement in bytes, default 1000000\n-r, --rows è¯•å›¾åˆ†è£‚æˆå¾ˆå¤šè¡Œå—è¡¨\n-c, --compress å‹ç¼©è¾“å‡ºæ–‡ä»¶\n-e, --build-empty-files å³ä½¿è¡¨æ²¡æœ‰æ•°æ®ï¼Œè¿˜æ˜¯äº§ç”Ÿä¸€ä¸ªç©ºæ–‡ä»¶\n-x, --regex æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼\n-i, --ignore-engines å¿½ç•¥çš„å­˜å‚¨å¼•æ“ï¼Œç”¨ï¼Œåˆ†éš”\n-m, --no-schemas ä¸å¯¼å‡ºè¡¨ç»“æ„\n-k, --no-locks ä¸æ‰§è¡Œä¸´æ—¶å…±äº«è¯»é” è­¦å‘Šï¼šè¿™å°†å¯¼è‡´ä¸ä¸€è‡´çš„å¤‡ä»½\n-l, --long-query-guard é•¿æŸ¥è¯¢ï¼Œé»˜è®¤60s\n--kill-long-queries killæ‰é•¿æ—¶é—´æ‰§è¡Œçš„æŸ¥è¯¢(instead of aborting)\n-b, --binlogs å¯¼å‡ºbinlog\n-D, --daemon å¯ç”¨å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼\n-I, --snapshot-interval dumpå¿«ç…§é—´éš”æ—¶é—´ï¼Œé»˜è®¤60sï¼Œéœ€è¦åœ¨daemonæ¨¡å¼ä¸‹\n-L, --logfile æ—¥å¿—æ–‡ä»¶\n-h, --host\n-u, --user\n-p, --password\n-P, --port\n-S, --socket\n-t, --threads ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤4\n-C, --compress-protocol åœ¨mysqlè¿æ¥ä¸Šä½¿ç”¨å‹ç¼©\n-V, --version\n-v, --verbose æ›´å¤šè¾“å‡º, 0 = silent, 1 = errors, 2 = warnings, 3 = info, default 2\nmydumperè¾“å‡ºæ–‡ä»¶ï¼š\nmetadata:å…ƒæ•°æ® è®°å½•å¤‡ä»½å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œä»¥åŠbinlogæ—¥å¿—æ–‡ä»¶ä½ç½®ã€‚\ntable data:æ¯ä¸ªè¡¨ä¸€ä¸ªæ–‡ä»¶\ntable schemas:è¡¨ç»“æ„æ–‡ä»¶\nbinary logs: å¯ç”¨\u0026ndash;binlogsé€‰é¡¹åï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶å­˜æ”¾åœ¨binlog_snapshotç›®å½•ä¸‹\ndaemon mode:åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œæœ‰äº”ä¸ªç›®å½•0ï¼Œ1ï¼Œbinlogsï¼Œbinlog_snapshotï¼Œlast_dumpã€‚\nå¤‡ä»½ç›®å½•æ˜¯0å’Œ1ï¼Œé—´éš”å¤‡ä»½ï¼Œå¦‚æœmydumperå› æŸç§åŸå› å¤±è´¥è€Œä»ç„¶æœ‰ä¸€ä¸ªå¥½çš„å¿«ç…§ï¼Œ\nå½“å¿«ç…§å®Œæˆåï¼Œlast_dumpæŒ‡å‘è¯¥å¤‡ä»½ã€‚\nmydumperç”¨ä¾‹ ==å¤‡ä»½==\n1 2 3 4 5 6 7 #export LD_LIBRARY_PATH=\u0026#34;/usr/local/mysql/lib:$LD_LIBRARY_PATH\u0026#34; [root@localhost ~]# mydumper -h localhost -u root -p 123456 -t 6 -S /tmp/mysql.sock -B uplook -o /mysqlbackup/ [root@localhost ~]# ls /mysqlbackup/ metadata uplooking.Student-schema.sql uplook-schema-create.sql uplook.Student.sql uplooking-schema-create.sql uplooking.Student.sql uplook.Student-schema.sql ** (mydumper:5247): CRITICAL **: Error connecting to database: Can\u0026#39;t connect to local MySQL server through socket \u0026#39;/var/lib/mysql/mysql.sock\u0026#39; (2) è§£å†³æ–¹æ³•ï¼šå»ºç«‹è½¯è¿æ¥\n1 2 3 4 5 6 ln -sv /tmp/mysql.sock /var/lib/mysql/mysql.sock [root@localhost ~]# cat /mysqlbackup/metadata [root@localhost ~]# cat /mysqlbackup/metadata Started dump at: 2017-08-05 15:48:09 Finished dump at: 2017-08-05 15:48:09 ==æ¢å¤==\n1 2 [root@localhost ~]# mysql -uroot -p -e \u0026#39;drop database uplook;\u0026#39; [root@localhost ~]# myloader -h localhost -u root -p 123456 -S /tmp/mysql.sock -d /mysqlbackup/ -o -B uplook ","date":"2019-04-20T21:20:34Z","image":"https://www.ownit.top/title_pic/31.jpg","permalink":"https://www.ownit.top/p/201904202120/","title":"MySQLæ•°æ®é€»è¾‘å¤‡ä»½"},{"content":"MySQLå¤‡ä»½ç±»å‹\nçƒ­å¤‡ä»½ã€æ¸©å¤‡ä»½ã€å†·å¤‡ä»½ ï¼ˆæ ¹æ®æœåŠ¡å™¨çŠ¶æ€ï¼‰\nçƒ­å¤‡ä»½ï¼šè¯»ã€å†™ä¸å—å½±å“ï¼›\næ¸©å¤‡ä»½ï¼šä»…å¯ä»¥æ‰§è¡Œè¯»æ“ä½œï¼›\nå†·å¤‡ä»½ï¼šç¦»çº¿å¤‡ä»½ï¼›è¯»ã€å†™æ“ä½œå‡ä¸­æ­¢ï¼›\nç‰©ç†å¤‡ä»½ä¸é€»è¾‘å¤‡ä»½ ï¼ˆä»å¯¹è±¡æ¥åˆ†ï¼‰\nç‰©ç†å¤‡ä»½ï¼šå¤åˆ¶æ•°æ®æ–‡ä»¶ï¼›\né€»è¾‘å¤‡ä»½ï¼šå°†æ•°æ®å¯¼å‡ºè‡³æ–‡æœ¬æ–‡ä»¶ä¸­ï¼›\nå®Œå…¨å¤‡ä»½ã€å¢é‡å¤‡ä»½ã€å·®å¼‚å¤‡ä»½ ï¼ˆä»æ•°æ®æ”¶é›†æ¥åˆ†ï¼‰\nå®Œå…¨å¤‡ä»½ï¼šå¤‡ä»½å…¨éƒ¨æ•°æ®ï¼›\nå¢é‡å¤‡ä»½ï¼šä»…å¤‡ä»½ä¸Šæ¬¡å®Œå…¨å¤‡ä»½æˆ–å¢é‡å¤‡ä»½ä»¥åå˜åŒ–çš„æ•°æ®ï¼›\nå·®å¼‚å¤‡ä»½ï¼šä»…å¤‡ä»½ä¸Šæ¬¡å®Œå…¨å¤‡ä»½ä»¥æ¥å˜åŒ–çš„æ•°æ®ï¼›\nMySQLæ•°æ®å¤‡ä»½\né€»è¾‘å¤‡ä»½ï¼š å¤‡ä»½çš„æ˜¯å»ºè¡¨ã€å»ºåº“ã€æ’å…¥ç­‰æ“ä½œæ‰€æ‰§è¡ŒSQLè¯­å¥ï¼Œé€‚ç”¨äºä¸­å°å‹æ•°æ®åº“ï¼Œæ•ˆç‡ç›¸å¯¹è¾ƒä½ã€‚\nmysqldump\nmydumper\né€»è¾‘å¤‡ä»½çš„ä¼˜ç‚¹ï¼š\nåœ¨å¤‡ä»½é€Ÿåº¦ä¸Šä¸¤ç§å¤‡ä»½è¦å–å†³äºä¸åŒçš„å­˜å‚¨å¼•æ“\nç‰©ç†å¤‡ä»½çš„è¿˜åŸé€Ÿåº¦éå¸¸å¿«ã€‚ä½†æ˜¯ç‰©ç†å¤‡ä»½çš„æœ€å°åŠ›åº¦åªèƒ½åšåˆ°è¡¨\né€»è¾‘å¤‡ä»½ä¿å­˜çš„ç»“æ„é€šå¸¸éƒ½æ˜¯çº¯ASCIIçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ–‡æœ¬å¤„ç†å·¥å…·æ¥å¤„ç†\né€»è¾‘å¤‡ä»½æœ‰éå¸¸å¼ºçš„å…¼å®¹æ€§ï¼Œè€Œç‰©ç†å¤‡ä»½åˆ™å¯¹ç‰ˆæœ¬è¦æ±‚éå¸¸é«˜\né€»è¾‘å¤‡ä»½ä¹Ÿå¯¹ä¿æŒæ•°æ®çš„å®‰å…¨æ€§æœ‰ä¿è¯\né€»è¾‘å¤‡ä»½çš„ç¼ºç‚¹ï¼š\né€»è¾‘å¤‡ä»½è¦å¯¹RDBMSäº§ç”Ÿé¢å¤–çš„å‹åŠ›ï¼Œè€Œè£¸å¤‡ä»½æ— å‹åŠ›\né€»è¾‘å¤‡ä»½çš„ç»“æœå¯èƒ½è¦æ¯”æºæ–‡ä»¶æ›´å¤§ã€‚æ‰€ä»¥å¾ˆå¤šäººéƒ½å¯¹å¤‡ä»½çš„å†…å®¹è¿›è¡Œå‹ç¼©\né€»è¾‘å¤‡ä»½å¯èƒ½ä¼šä¸¢å¤±æµ®ç‚¹æ•°çš„ç²¾åº¦ä¿¡æ¯\nç‰©ç†å¤‡ä»½ï¼š ç›´æ¥å¤åˆ¶æ•°æ®åº“æ–‡ä»¶ï¼Œé€‚ç”¨äºå¤§å‹æ•°æ®åº“ç¯å¢ƒï¼Œä¸å—å­˜å‚¨å¼•æ“çš„é™åˆ¶ï¼Œä½†ä¸èƒ½æ¢å¤åˆ°å¼‚æ„ç³»ç»Ÿä¸­å¦‚Windowsã€‚\nxtrabackup\ninbackup\nlvm snapshot\nmysqlbackup ORACLEå…¬å¸ä¹Ÿæä¾›äº†é’ˆå¯¹ä¼ä¸šçš„å¤‡ä»½è½¯ä»¶MySQL Enterprise Backupç®€ç§°\nMySQLå¤‡ä»½å†…å®¹\næ•°æ®æ–‡ä»¶æ—¥å¿—æ–‡ä»¶ï¼ˆæ¯”å¦‚äº‹åŠ¡æ—¥å¿—ï¼ŒäºŒè¿›åˆ¶æ—¥å¿—ï¼‰\nå­˜å‚¨è¿‡ç¨‹ï¼Œå­˜å‚¨å‡½æ•°ï¼Œè§¦å‘å™¨\né…ç½®æ–‡ä»¶ï¼ˆååˆ†é‡è¦ï¼Œå„ä¸ªé…ç½®æ–‡ä»¶éƒ½è¦å¤‡ä»½ï¼‰\nç”¨äºå®ç°æ•°æ®åº“å¤‡ä»½çš„è„šæœ¬ï¼Œæ•°æ®åº“è‡ªèº«æ¸…ç†çš„crontabç­‰â€¦â€¦\nå»ºè®®ï¼š\n1 2 3 4 5 6 7 8 9 # vim /etc/my.cnf [mysqld] log-bin=mysql-bin server-id=1 #5.7 å¿…é¡»é…ç½®server-id å¯ç”¨binlogåŠŸèƒ½ binlog_format=statement #5.7 é»˜è®¤binlogåªè®°å½•createã€dropå’Œalterï¼Œè¦è®°å½•insertè¯­å¥å¿…é¡»è®¾ç½®æ ¼å¼ datadir = /usr/local/mysql/dataã€€#æ·»åŠ æ­¤è¡Œï¼Œæ•°æ®å­˜æ”¾ç›®å½• innodb_file_per_table = 1Â #å¯ç”¨InnoDBç‹¬ç«‹è¡¨ç©ºé—´ï¼Œé»˜è®¤æ‰€æœ‰æ•°æ®åº“ä½¿ç”¨ä¸€ä¸ªè¡¨ç©ºé—´ # service mysqld restart ","date":"2019-04-20T19:56:45Z","image":"https://www.ownit.top/title_pic/39.jpg","permalink":"https://www.ownit.top/p/201904201956/","title":"MySQLæ•°æ®å¤‡ä»½æ¦‚è¿°"},{"content":"==================== äº‹åŠ¡ç‰¹æ€§\näº‹åŠ¡éš”ç¦»çº§åˆ«\näº‹åŠ¡æ§åˆ¶è¯­å¥\nMySQLä¼˜åŒ–\n====================\näº‹åŠ¡çš„æ¦‚å¿µ\näº‹åŠ¡æŒ‡é€»è¾‘ä¸Šçš„ä¸€ç»„æ“ä½œï¼Œç»„æˆè¿™ç»„æ“ä½œçš„å„ä¸ªå•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æˆåŠŸã€‚\nä¾‹å¦‚ï¼šAâ€”â€”Bè½¬å¸ï¼Œå¯¹åº”äºå¦‚ä¸‹ä¸¤æ¡sqlè¯­å¥\nupdate from account set money=money-100 where name=â€˜aâ€™;\nupdate from account set money=money+100 where name=â€˜bâ€™;\næ•°æ®åº“å¼€å¯äº‹åŠ¡å‘½ä»¤\nstart transaction å¼€å¯äº‹åŠ¡\nrollback å›æ»šäº‹åŠ¡\ncommit æäº¤äº‹åŠ¡\näº‹åŠ¡çš„ç‰¹æ€§(ACID)\nåŸå­æ€§ï¼ˆAtomicityï¼‰åŸå­æ€§æ˜¯æŒ‡äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆéƒ½å‘ç”Ÿï¼Œè¦ä¹ˆéƒ½ä¸å‘ç”Ÿã€‚Â ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰äº‹åŠ¡å¿…é¡»ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€å˜æ¢åˆ°å¦å¤–ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚\néš”ç¦»æ€§ï¼ˆIsolationï¼‰äº‹åŠ¡çš„éš”ç¦»æ€§æ˜¯å¤šä¸ªç”¨æˆ·å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œæ•°æ®åº“ä¸ºæ¯ä¸€ä¸ªç”¨æˆ·å¼€å¯çš„äº‹åŠ¡ï¼Œä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡çš„æ“ä½œæ•°æ®æ‰€å¹²æ‰°ï¼Œå¤šä¸ªå¹¶å‘äº‹åŠ¡ä¹‹é—´è¦ç›¸äº’éš”ç¦»ã€‚\næŒä¹…æ€§ï¼ˆDurabilityï¼‰æŒä¹…æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤ï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œæ¥ä¸‹æ¥å³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚\näº‹åŠ¡çš„éš”ç¦»çº§åˆ«\nå¤šä¸ªçº¿ç¨‹å¼€å¯å„è‡ªäº‹åŠ¡æ“ä½œæ•°æ®åº“ä¸­æ•°æ®æ—¶ï¼Œæ•°æ®åº“ç³»ç»Ÿè¦è´Ÿè´£éš”ç¦»æ“ä½œï¼Œä»¥ä¿è¯å„ä¸ªçº¿ç¨‹åœ¨è·å–æ•°æ®æ—¶çš„å‡†ç¡®æ€§ã€‚\nå¦‚æœä¸è€ƒè™‘éš”ç¦»æ€§ï¼Œå¯èƒ½ä¼šå¼•å‘å¦‚ä¸‹é—®é¢˜ï¼š\nè„è¯»ï¼šæŒ‡ä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å¦å¤–ä¸€ä¸ªäº‹åŠ¡æœªæäº¤çš„æ•°æ®ã€‚ è¿™æ˜¯éå¸¸å±é™©çš„ï¼Œå‡è®¾ï¼¡å‘ï¼¢è½¬å¸100å…ƒï¼Œå¯¹åº”sqlè¯­å¥å¦‚ä¸‹æ‰€ç¤º\n1.update account set money=money+100 while name=â€˜bâ€™;\n2.update account set money=money-100 while name=â€˜aâ€™;\nä¸å¯é‡å¤è¯»ï¼šåœ¨ä¸€ä¸ªäº‹ç‰©å†…è¯»å–è¡¨ä¸­çš„æŸä¸€è¡Œæ•°æ®ï¼Œå¤šæ¬¡è¯»å–ç»“æœä¸åŒã€‚\nä¾‹å¦‚é“¶è¡Œæƒ³æŸ¥è¯¢Aå¸æˆ·ä½™é¢ï¼Œç¬¬ä¸€æ¬¡æŸ¥è¯¢Aå¸æˆ·ä¸º200å…ƒï¼Œæ­¤æ—¶Aå‘å¸æˆ·å†…å­˜äº†100å…ƒå¹¶æäº¤äº†ï¼Œé“¶è¡Œæ¥ç€åˆè¿›è¡Œäº†ä¸€æ¬¡æŸ¥è¯¢ï¼Œæ­¤æ—¶Aå¸æˆ·ä¸º300å…ƒäº†ã€‚é“¶è¡Œä¸¤æ¬¡æŸ¥è¯¢ä¸ä¸€è‡´ï¼Œå¯èƒ½å°±ä¼šå¾ˆå›°æƒ‘ï¼Œä¸çŸ¥é“å“ªæ¬¡æŸ¥è¯¢æ˜¯å‡†çš„ã€‚\nå’Œè„è¯»çš„åŒºåˆ«æ˜¯ï¼Œè„è¯»æ˜¯è¯»å–å‰ä¸€äº‹åŠ¡æœªæäº¤çš„è„æ•°æ®ï¼Œä¸å¯é‡å¤è¯»æ˜¯é‡æ–°è¯»å–äº†å‰ä¸€äº‹åŠ¡å·²æäº¤çš„æ•°æ®ã€‚\nå¾ˆå¤šäººè®¤ä¸ºè¿™ç§æƒ…å†µå°±å¯¹äº†ï¼Œæ— é¡»å›°æƒ‘ï¼Œå½“ç„¶æ˜¯åé¢çš„ä¸ºå‡†ã€‚æˆ‘ä»¬å¯ä»¥è€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µï¼Œæ¯”å¦‚é“¶è¡Œç¨‹åºéœ€è¦å°†æŸ¥è¯¢ç»“æœåˆ†åˆ«è¾“å‡ºåˆ°ç”µè„‘å±å¹•å’Œå†™åˆ°æ–‡ä»¶ä¸­ï¼Œç»“æœåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­é’ˆå¯¹è¾“å‡ºçš„ç›®çš„åœ°ï¼Œè¿›è¡Œçš„ä¸¤æ¬¡æŸ¥è¯¢ä¸ä¸€è‡´ï¼Œå¯¼è‡´æ–‡ä»¶å’Œå±å¹•ä¸­çš„ç»“æœä¸ä¸€è‡´ï¼Œé“¶è¡Œå·¥ä½œäººå‘˜å°±ä¸çŸ¥é“ä»¥å“ªä¸ªä¸ºå‡†äº†ã€‚\nè™šè¯»/å¹»è¯»æ˜¯æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡å†…è¯»å–åˆ°äº†åˆ«çš„äº‹åŠ¡æ’å…¥çš„æ•°æ®ï¼Œå¯¼è‡´å‰åè¯»å–ä¸ä¸€è‡´ã€‚\nå¦‚ä¸™å­˜æ¬¾100å…ƒæœªæäº¤ï¼Œè¿™æ—¶é“¶è¡ŒåšæŠ¥è¡¨ç»Ÿè®¡accountè¡¨ä¸­æ‰€æœ‰ç”¨æˆ·çš„æ€»é¢ä¸º500å…ƒï¼Œç„¶åä¸™æäº¤äº†ï¼Œè¿™æ—¶é“¶è¡Œå†ç»Ÿè®¡å‘ç°å¸æˆ·ä¸º600å…ƒäº†ï¼Œé€ æˆè™šè¯»åŒæ ·ä¼šä½¿é“¶è¡Œä¸çŸ¥æ‰€æªï¼Œåˆ°åº•ä»¥å“ªä¸ªä¸ºå‡†ã€‚\näº‹åŠ¡éš”ç¦»æ€§çš„è®¾ç½®è¯­å¥\næ•°æ®åº“å…±å®šä¹‰äº†å››ç§éš”ç¦»çº§åˆ«ï¼š\nSerializableï¼šå¯é¿å…è„è¯»ã€ä¸å¯é‡å¤è¯»ã€è™šè¯»æƒ…å†µçš„å‘ç”Ÿã€‚ï¼ˆä¸²è¡ŒåŒ–ï¼‰\nRepeatable readï¼šå¯é¿å…è„è¯»ã€ä¸å¯é‡å¤è¯»æƒ…å†µçš„å‘ç”Ÿã€‚ï¼ˆå¯é‡å¤è¯»ï¼‰\nRead committedï¼šå¯é¿å…è„è¯»æƒ…å†µå‘ç”Ÿï¼ˆè¯»å·²æäº¤ï¼‰ã€‚\nRead uncommittedï¼šæœ€ä½çº§åˆ«ï¼Œä»¥ä¸Šæƒ…å†µå‡æ— æ³•ä¿è¯ã€‚(è¯»æœªæäº¤)\nset transaction isolation level è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«\nselect @@tx_isolation æŸ¥è¯¢å½“å‰äº‹åŠ¡éš”ç¦»çº§åˆ«\nMySQLä¼˜åŒ–\nç³»ç»Ÿä¼˜åŒ–ï¼šç¡¬ä»¶ã€æ¶æ„\næœåŠ¡ä¼˜åŒ–\nåº”ç”¨ä¼˜åŒ–\nå½±å“æ€§èƒ½çš„å› ç´ ï¼š\nåº”ç”¨ç¨‹åºã€æŸ¥è¯¢ã€äº‹åŠ¡ç®¡ç†ã€æ•°æ®åº“è®¾è®¡ã€æ•°æ®åˆ†å¸ƒã€ç½‘ç»œæ“ä½œç³»ç»Ÿã€ç¡¬ä»¶\nç³»ç»Ÿä¼˜åŒ–ï¼š\n1ã€ç¡¬ä»¶ä¼˜åŒ–\ncpu 64ä½ ä¸€å°æœºå™¨8-16é¢—CPU å†…å­˜ 96-128G 3-4ä¸ªå®ä¾‹\nç¡¬ç›˜ï¼šæ•°é‡è¶Šå¤šè¶Šå¥½\næ€§èƒ½ï¼šssdï¼ˆé«˜å¹¶å‘ä¸šåŠ¡ï¼‰ \u0026gt; sas ï¼ˆæ™®é€šä¸šåŠ¡ï¼‰\u0026gt;sataï¼ˆçº¿ä¸‹ä¸šåŠ¡ï¼‰ raid 4å—ç›˜ï¼Œæ€§èƒ½ raid0 \u0026gt; raid10 \u0026gt; raid5 \u0026gt; raid1\nç½‘å¡ï¼šå¤šå—ç½‘å¡bond\n2ã€è½¯ä»¶ä¼˜åŒ– æ“ä½œç³»ç»Ÿï¼šä½¿ç”¨64ä½ç³»ç»Ÿ è½¯ä»¶ï¼šMySQL ç¼–è¯‘ä¼˜åŒ–\næœåŠ¡ä¼˜åŒ–ï¼š\nMySQLé…ç½®åŸåˆ™\né…ç½®åˆç†çš„MySQLæœåŠ¡å™¨ï¼Œå°½é‡åœ¨åº”ç”¨æœ¬èº«è¾¾åˆ°ä¸€ä¸ªMySQLæœ€åˆç†çš„ä½¿ç”¨\né’ˆå¯¹ MyISAM æˆ– InnoDB ä¸åŒå¼•æ“è¿›è¡Œä¸åŒå®šåˆ¶æ€§é…ç½®\né’ˆå¯¹ä¸åŒçš„åº”ç”¨æƒ…å†µè¿›è¡Œåˆç†é…ç½®é’ˆå¯¹ my.cnf è¿›è¡Œé…ç½®ï¼Œåé¢è®¾ç½®æ˜¯é’ˆå¯¹å†…å­˜ä¸º2Gçš„æœåŠ¡å™¨è¿›è¡Œçš„åˆç†è®¾ç½®\nå…¬å…±é€‰é¡¹\né€‰é¡¹ç¼ºçœå€¼æ¨èå€¼è¯´æ˜max_connections1001024MySQLæœåŠ¡å™¨åŒæ—¶å¤„ç†çš„æ•°æ®åº“è¿æ¥çš„æœ€å¤§æ•°é‡query_cache_size0 (ä¸æ‰“å¼€ï¼‰16MæŸ¥è¯¢ç¼“å­˜åŒºçš„æœ€å¤§é•¿åº¦ï¼ŒæŒ‰ç…§å½“å‰éœ€æ±‚ï¼Œä¸€å€ä¸€å€å¢åŠ ï¼Œæœ¬é€‰é¡¹æ¯”è¾ƒé‡è¦sort_buffer_size512K16Mæ¯ä¸ªçº¿ç¨‹çš„æ’åºç¼“å­˜å¤§å°ï¼Œä¸€èˆ¬æŒ‰ç…§å†…å­˜å¯ä»¥è®¾ç½®ä¸º2Mä»¥ä¸Šï¼Œæ¨èæ˜¯16Mï¼Œè¯¥é€‰é¡¹å¯¹æ’åºorder byï¼Œgroup byèµ·ä½œç”¨record_buffer128K16Mæ¯ä¸ªè¿›è¡Œä¸€ä¸ªé¡ºåºæ‰«æçš„çº¿ç¨‹ä¸ºå…¶æ‰«æçš„æ¯å¼ è¡¨åˆ†é…è¿™ä¸ªå¤§å°çš„ä¸€ä¸ªç¼“å†²åŒºï¼Œå¯ä»¥è®¾ç½®ä¸º2Mä»¥ä¸Štable_cache64512ä¸ºæ‰€æœ‰çº¿ç¨‹æ‰“å¼€è¡¨çš„æ•°é‡ã€‚å¢åŠ è¯¥å€¼èƒ½å¢åŠ mysqldè¦æ±‚çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€‚MySQLå¯¹æ¯ä¸ªå”¯ä¸€æ‰“å¼€çš„è¡¨éœ€è¦2ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚ MyISAM é€‰é¡¹\né€‰é¡¹ç¼ºçœå€¼æ¨èå€¼è¯´æ˜key_buffer_size8M256Mç”¨æ¥å­˜æ”¾ç´¢å¼•åŒºå—çš„ç¼“å­˜å€¼, å»ºè®®128Mä»¥ä¸Šï¼Œä¸è¦å¤§äºå†…å­˜çš„30%read_buffer_size128K16Mç”¨æ¥åšMyISAMè¡¨å…¨è¡¨æ‰«æçš„ç¼“å†²å¤§å°. ä¸ºä»æ•°æ®è¡¨é¡ºåºè¯»å–æ•°æ®çš„è¯»æ“ä½œä¿ç•™çš„ç¼“å­˜åŒºçš„é•¿åº¦myisam_sort_buffer_size16M128Mè®¾ç½®,æ¢å¤,ä¿®æ”¹è¡¨çš„æ—¶å€™ä½¿ç”¨çš„ç¼“å†²å¤§å°ï¼Œå€¼ä¸è¦è®¾çš„å¤ªå¤§ InnoDB é€‰é¡¹\né€‰é¡¹ç¼ºçœå€¼æ¨èå€¼è¯´æ˜innodb_buffer_pool_size32M1GInnoDBä½¿ç”¨ä¸€ä¸ªç¼“å†²æ± æ¥ä¿å­˜ç´¢å¼•å’ŒåŸå§‹æ•°æ®, è¿™é‡Œä½ è®¾ç½®è¶Šå¤§,ä½ åœ¨å­˜å–è¡¨é‡Œé¢æ•°æ®æ—¶æ‰€éœ€è¦çš„ç£ç›˜I/Oè¶Šå°‘ï¼Œä¸€èˆ¬æ˜¯å†…å­˜çš„ä¸€åŠï¼Œä¸è¶…è¿‡2Gï¼Œå¦åˆ™ç³»ç»Ÿä¼šå´©æºƒï¼Œè¿™ä¸ªå‚æ•°éå¸¸é‡è¦innodb_additional_mem_pool_size2M128MInnoDBç”¨æ¥ä¿å­˜ metadata ä¿¡æ¯, å¦‚æœå†…å­˜æ˜¯4Gï¼Œæœ€å¥½æœ¬å€¼è¶…è¿‡200Minnodb_flush_log_at_trx_commit100 ä»£è¡¨æ—¥å¿—åªå¤§çº¦æ¯ç§’å†™å…¥æ—¥å¿—æ–‡ä»¶å¹¶ä¸”æ—¥å¿—æ–‡ä»¶åˆ·æ–°åˆ°ç£ç›˜; 1 ä¸ºæ‰§è¡Œå®Œæ²¡æ‰§è¡Œä¸€æ¡SQLé©¬ä¸Šcommit; 2 ä»£è¡¨æ—¥å¿—å†™å…¥æ—¥å¿—æ–‡ä»¶åœ¨æ¯æ¬¡æäº¤å,ä½†æ˜¯æ—¥å¿—æ–‡ä»¶åªæœ‰å¤§çº¦æ¯ç§’æ‰ä¼šåˆ·æ–°åˆ°ç£ç›˜ä¸Š. å¯¹é€Ÿåº¦å½±å“æ¯”è¾ƒå¤§ï¼ŒåŒæ—¶ä¹Ÿå…³ç³»æ•°æ®å®Œæ•´æ€§innodb_log_file_size8M256Måœ¨æ—¥å¿—ç»„ä¸­æ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„å¤§å°, ä¸€èˆ¬æ˜¯innodb_buffer_pool_sizeçš„25%ï¼Œå®˜æ–¹æ¨èæ˜¯ innodb_buffer_pool_size çš„ 40-50%, è®¾ç½®å¤§ä¸€ç‚¹æ¥é¿å…åœ¨æ—¥å¿—æ–‡ä»¶è¦†å†™ä¸Šä¸å¿…è¦çš„ç¼“å†²æ± åˆ·æ–°è¡Œä¸ºinnodb_log_buffer_size128K8Mç”¨æ¥ç¼“å†²æ—¥å¿—æ•°æ®çš„ç¼“å†²åŒºçš„å¤§å°. æ¨èæ˜¯8Mï¼Œå®˜æ–¹æ¨èè¯¥å€¼å°äº16Mï¼Œæœ€å¥½æ˜¯ 1M-8M ä¹‹é—´ åº”ç”¨ä¼˜åŒ–ï¼š\nè®¾è®¡åˆç†çš„æ•°æ®è¡¨ç»“æ„ï¼š\né€‚å½“çš„æ•°æ®å†—ä½™å¯¹æ•°æ®è¡¨å»ºç«‹åˆé€‚æœ‰æ•ˆçš„æ•°æ®åº“ç´¢å¼•æ•°æ®æŸ¥è¯¢ï¼š\nç¼–å†™ç®€æ´é«˜æ•ˆçš„SQLè¯­å¥\nè¡¨ç»“æ„è®¾è®¡åŸåˆ™\né€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ï¼Œå¦‚æœèƒ½å¤Ÿå®šé•¿å°½é‡å®šé•¿\nä½¿ç”¨ ENUM è€Œä¸æ˜¯ VARCHAR,ENUMç±»å‹æ˜¯éå¸¸å¿«å’Œç´§å‡‘çš„ï¼Œåœ¨å®é™…ä¸Šï¼Œå…¶ä¿å­˜çš„æ˜¯ TINYINTï¼Œä½†å…¶å¤–è¡¨ä¸Šæ˜¾ç¤ºä¸ºå­—ç¬¦ä¸²ã€‚è¿™æ ·ä¸€æ¥ï¼Œç”¨è¿™ä¸ªå­—æ®µæ¥åšä¸€äº›é€‰é¡¹åˆ—è¡¨å˜å¾—ç›¸å½“çš„å®Œç¾ ã€‚\nä¸è¦ä½¿ç”¨æ— æ³•åŠ ç´¢å¼•çš„ç±»å‹ä½œä¸ºå…³é”®å­—æ®µï¼Œæ¯”å¦‚ textç±»å‹\nä¸ºäº†é¿å…è”è¡¨æŸ¥è¯¢ï¼Œæœ‰æ—¶å€™å¯ä»¥é€‚å½“çš„æ•°æ®å†—ä½™ï¼Œæ¯”å¦‚é‚®ç®±ã€å§“åè¿™äº›ä¸å®¹æ˜“æ›´æ”¹çš„æ•°æ®\né€‰æ‹©åˆé€‚çš„è¡¨å¼•æ“ï¼Œæœ‰æ—¶å€™ MyISAM é€‚åˆï¼Œæœ‰æ—¶å€™InnoDBé€‚åˆ\nä¸ºä¿è¯æŸ¥è¯¢æ€§èƒ½ï¼Œæœ€å¥½æ¯ä¸ªè¡¨éƒ½å»ºç«‹æœ‰ auto_increment å­—æ®µï¼Œ å»ºç«‹åˆé€‚çš„æ•°æ®åº“ç´¢å¼•\næœ€å¥½ç»™æ¯ä¸ªå­—æ®µéƒ½è®¾å®š default å€¼\nç´¢å¼•å»ºç«‹åŸåˆ™\nä¸€èˆ¬é’ˆå¯¹æ•°æ®åˆ†æ•£çš„å…³é”®å­—è¿›è¡Œå»ºç«‹ç´¢å¼•ï¼Œæ¯”å¦‚IDã€QQï¼Œåƒæ€§åˆ«ã€çŠ¶æ€å€¼ç­‰ç­‰å»ºç«‹ç´¢å¼•æ²¡æœ‰æ„ä¹‰å­—æ®µå”¯ä¸€ï¼Œæœ€å°‘ï¼Œä¸å¯ä¸ºnull\nå¯¹å¤§æ•°æ®é‡è¡¨å»ºç«‹èšé›†ç´¢å¼•ï¼Œé¿å…æ›´æ–°æ“ä½œå¸¦æ¥çš„ç¢ç‰‡ã€‚\nå°½é‡ä½¿ç”¨çŸ­ç´¢å¼•ï¼Œä¸€èˆ¬å¯¹intã€char/varcharã€date/time ç­‰ç±»å‹çš„å­—æ®µå»ºç«‹ç´¢å¼•\néœ€è¦çš„æ—¶å€™å»ºç«‹è”åˆç´¢å¼•ï¼Œä½†æ˜¯è¦æ³¨æ„æŸ¥è¯¢SQLè¯­å¥çš„ç¼–å†™\nè°¨æ…å»ºç«‹ unique ç±»å‹çš„ç´¢å¼•ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰\nå¤§æ–‡æœ¬å­—æ®µä¸å»ºç«‹ä¸ºç´¢å¼•ï¼Œå¦‚æœè¦å¯¹å¤§æ–‡æœ¬å­—æ®µè¿›è¡Œæ£€ç´¢ï¼Œ å¯ä»¥è€ƒè™‘å…¨æ–‡ç´¢å¼•\né¢‘ç¹æ›´æ–°çš„åˆ—ä¸é€‚åˆå»ºç«‹ç´¢å¼•\norder by å­—å¥ä¸­çš„å­—æ®µï¼Œwhere å­å¥ä¸­å­—æ®µï¼Œæœ€å¸¸ç”¨çš„sqlè¯­å¥ä¸­å­—æ®µï¼Œåº”å»ºç«‹ç´¢å¼•ã€‚\nå”¯ä¸€æ€§çº¦æŸï¼Œç³»ç»Ÿå°†é»˜è®¤ä¸ºæ”¹å­—æ®µå»ºç«‹ç´¢å¼•ã€‚\nå¯¹äºåªæ˜¯åšæŸ¥è¯¢ç”¨çš„æ•°æ®åº“ç´¢å¼•è¶Šå¤šè¶Šå¥½ï¼Œä½†å¯¹äºåœ¨çº¿å®æ—¶ç³»ç»Ÿå»ºè®®æ§åˆ¶åœ¨5ä¸ªä»¥å†…ã€‚\nç´¢å¼•ä¸ä»…èƒ½æé«˜æŸ¥è¯¢SQLæ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æé«˜å¸¦whereå­—å¥çš„updateï¼ŒDelete SQLæ€§èƒ½ã€‚\nDecimal ç±»å‹å­—æ®µä¸è¦å•ç‹¬å»ºç«‹ä¸ºç´¢å¼•ï¼Œä½†è¦†ç›–ç´¢å¼•å¯ä»¥åŒ…å«è¿™äº›å­—æ®µã€‚\nåªæœ‰å»ºç«‹ç´¢å¼•ä»¥åï¼Œè¡¨å†…çš„è¡Œæ‰æŒ‰ç…§ç‰¹åœ°çš„é¡ºåºå­˜å‚¨ï¼ŒæŒ‰ç…§éœ€è¦å¯ä»¥æ˜¯ascæˆ–descæ–¹å¼ã€‚\nå¦‚æœç´¢å¼•ç”±å¤šä¸ªå­—æ®µç»„æˆå°†æœ€ç”¨æ¥æŸ¥è¯¢è¿‡æ»¤çš„å­—æ®µæ”¾åœ¨å‰é¢å¯èƒ½ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚\nç¼–å†™é«˜æ•ˆçš„ SQL\nèƒ½å¤Ÿå¿«é€Ÿç¼©å°ç»“æœé›†çš„ WHERE æ¡ä»¶å†™åœ¨å‰é¢ï¼Œå¦‚æœæœ‰æ’é‡æ¡ä»¶ï¼Œä¹Ÿå°½é‡æ”¾åœ¨å‰é¢\nå°½é‡é¿å…ä½¿ç”¨ GROUP BYã€DISTINCT ã€ORã€IN ç­‰è¯­å¥çš„ä½¿ç”¨ï¼Œé¿å…ä½¿ç”¨è”è¡¨æŸ¥è¯¢å’Œå­æŸ¥è¯¢ï¼Œå› ä¸ºå°†ä½¿æ‰§è¡Œæ•ˆç‡å¤§å¤§ä¸‹é™\nèƒ½å¤Ÿä½¿ç”¨ç´¢å¼•çš„å­—æ®µå°½é‡è¿›è¡Œæœ‰æ•ˆçš„åˆç†æ’åˆ—ï¼Œå¦‚æœä½¿ç”¨äº†è”åˆç´¢å¼•ï¼Œè¯·æ³¨æ„æå–å­—æ®µçš„å‰åé¡ºåº\né’ˆå¯¹ç´¢å¼•å­—æ®µä½¿ç”¨ \u0026gt;, \u0026gt;=, =, \u0026lt;, \u0026lt;=, IF NULLå’ŒBETWEEN å°†ä¼šä½¿ç”¨ç´¢å¼•ï¼Œå¦‚æœå¯¹æŸä¸ªç´¢å¼•å­—æ®µè¿›è¡Œ LIKE æŸ¥è¯¢ï¼Œä½¿ç”¨ LIKE â€˜%abc%â€™ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œä½¿ç”¨ LIKE â€˜abc%â€™ å°†èƒ½å¤Ÿä½¿ç”¨ç´¢å¼•\nå¦‚æœåœ¨SQLé‡Œä½¿ç”¨äº†MySQLéƒ¨åˆ†è‡ªå¸¦å‡½æ•°ï¼Œç´¢å¼•å°†å¤±æ•ˆï¼ŒåŒæ—¶å°†æ— æ³•ä½¿ç”¨ MySQL çš„ Query Cacheï¼Œæ¯”å¦‚ LEFT(), SUBSTR(), TO_DAYS()ï¼ŒDATE_FORMAT(), ç­‰ï¼Œå¦‚æœä½¿ç”¨äº† OR æˆ– INï¼Œç´¢å¼•ä¹Ÿå°†å¤±æ•ˆ\nä½¿ç”¨ Explain è¯­å¥æ¥å¸®åŠ©æ”¹è¿›æˆ‘ä»¬çš„SQLè¯­å¥\nä¸è¦åœ¨where å­å¥ä¸­çš„â€œ=â€å·¦è¾¹è¿›è¡Œç®—æœ¯æˆ–è¡¨è¾¾å¼è¿ç®—ï¼Œå¦åˆ™ç³»ç»Ÿå°†å¯èƒ½æ— æ³•æ­£ç¡®ä½¿ç”¨ç´¢å¼•\nå°½é‡ä¸è¦åœ¨whereæ¡ä»¶ä¸­ä½¿ç”¨å‡½æ•°ï¼Œå¦åˆ™å°†ä¸èƒ½ä½¿ç”¨ç´¢å¼•\né¿å…ä½¿ç”¨ select *, åªå–éœ€è¦çš„å­—æ®µ\nå¯¹äºå¤§æ•°æ®é‡çš„æŸ¥è¯¢ï¼Œå°½é‡é¿å…åœ¨SQLè¯­å¥ä¸­ä½¿ç”¨order by å­—å¥ï¼Œé¿å…é¢å¤–çš„å¼€é”€ï¼Œæ›¿ä»£ä¸ºä½¿ç”¨ADO.NET æ¥å®ç°ã€‚\nå¦‚æœæ’å…¥çš„æ•°æ®é‡å¾ˆå¤§ï¼Œç”¨select into æ›¿ä»£ insert into èƒ½å¸¦æ¥æ›´å¥½çš„æ€§èƒ½\né‡‡ç”¨è¿æ¥æ“ä½œï¼Œé¿å…è¿‡å¤šçš„å­æŸ¥è¯¢ï¼Œäº§ç”Ÿçš„CPUå’ŒIOå¼€é”€\nåªå…³å¿ƒéœ€è¦çš„è¡¨å’Œæ»¡è¶³æ¡ä»¶çš„æ•°æ®\né€‚å½“ä½¿ç”¨ä¸´æ—¶è¡¨æˆ–è¡¨å˜é‡\nå¯¹äºè¿ç»­çš„æ•°å€¼ï¼Œä½¿ç”¨betweenä»£æ›¿in\nwhere å­—å¥ä¸­å°½é‡ä¸è¦ä½¿ç”¨CASEæ¡ä»¶\nå°½é‡ä¸ç”¨è§¦å‘å™¨ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§æ•°æ®è¡¨ä¸Š\næ›´æ–°è§¦å‘å™¨å¦‚æœä¸æ˜¯æ‰€æœ‰æƒ…å†µä¸‹éƒ½éœ€è¦è§¦å‘ï¼Œåº”æ ¹æ®ä¸šåŠ¡éœ€è¦åŠ ä¸Šå¿…è¦åˆ¤æ–­æ¡ä»¶\nä½¿ç”¨union all æ“ä½œä»£æ›¿ORæ“ä½œï¼Œæ³¨æ„æ­¤æ—¶éœ€è¦æ³¨æ„ä¸€ç‚¹æŸ¥è¯¢æ¡ä»¶å¯ä»¥ä½¿ç”¨èšé›†ç´¢å¼•ï¼Œå¦‚æœæ˜¯éèšé›†ç´¢å¼•å°†èµ·åˆ°ç›¸åçš„ç»“æœ\nå½“åªè¦ä¸€è¡Œæ•°æ®æ—¶ä½¿ç”¨ LIMIT 1\nå°½å¯èƒ½çš„ä½¿ç”¨ NOT NULLå¡«å……æ•°æ®åº“\næ‹†åˆ†å¤§çš„ DELETE æˆ– INSERT è¯­å¥\næ‰¹é‡æäº¤SQLè¯­å¥\næ¶æ„ä¼˜åŒ–\n1ï¼‰ä¸šåŠ¡æ‹†åˆ†ï¼šæœç´¢åŠŸèƒ½ï¼Œlike ï¼Œå‰åéƒ½æœ‰%ï¼Œä¸€èˆ¬ä¸ç”¨MySQLæ•°æ®åº“\n2ï¼‰ä¸šåŠ¡æ‹†åˆ†ï¼šæŸäº›åº”ç”¨ä½¿ç”¨nosqlæŒä¹…åŒ–å­˜å‚¨ï¼Œä¾‹å¦‚memcahcedbã€redisã€ttserver æ¯”å¦‚ç²‰ä¸å…³æ³¨ã€å¥½å‹å…³ç³»ç­‰ï¼›\n3ï¼‰æ•°æ®åº“å‰ç«¯å¿…é¡»è¦åŠ cacheï¼Œä¾‹å¦‚memcachedï¼Œç”¨æˆ·ç™»å½•ï¼Œå•†å“æŸ¥è¯¢\n4ï¼‰åŠ¨æ€æ•°æ®é™æ€åŒ–ã€‚æ•´ä¸ªæ–‡ä»¶é™æ€åŒ–ï¼Œé¡µé¢ç‰‡æ®µé™æ€åŒ–\n5ï¼‰æ•°æ®åº“é›†ç¾¤ä¸è¯»å†™åˆ†ç¦»ï¼›\n6ï¼‰å•è¡¨è¶…è¿‡2000ä¸‡ï¼Œæ‹†åº“æ‹†è¡¨ï¼Œäººå·¥æˆ–è‡ªåŠ¨æ‹†åˆ†ï¼ˆç™»å½•ã€å•†å“ã€è®¢å•ç­‰ï¼‰\næµç¨‹ã€åˆ¶åº¦ã€å®‰å…¨ä¼˜åŒ–\nä»»ä½•ä¸€æ¬¡äººä¸ºæ•°æ®åº“è®°å½•çš„æ›´æ–°ï¼Œéƒ½è¦èµ°ä¸€ä¸ªæµç¨‹\n1ï¼‰äººçš„æµç¨‹ï¼šå¼€å‘\u0026ndash;\u0026gt;æ ¸å¿ƒå¼€å‘\u0026ndash;\u0026gt;è¿ç»´æˆ–DBA\n2ï¼‰æµ‹è¯•æµç¨‹ï¼šå†…ç½‘æµ‹è¯•\u0026ndash;\u0026gt;IDCæµ‹è¯•\u0026ndash;\u0026gt;çº¿ä¸Šæ‰§è¡Œ\n3ï¼‰å®¢æˆ·ç«¯ç®¡ç†ï¼šphpmyadminç­‰\n","date":"2019-04-19T23:57:56Z","image":"https://www.ownit.top/title_pic/36.jpg","permalink":"https://www.ownit.top/p/201904192357/","title":"MySQLäº‹åŠ¡ä¼˜åŒ–"},{"content":"MySQLæ—¥å¿—ç®¡ç† ========================================================\né”™è¯¯æ—¥å¿—: è®°å½• MySQL æœåŠ¡å™¨å¯åŠ¨ã€å…³é—­åŠè¿è¡Œé”™è¯¯ç­‰ä¿¡æ¯ äºŒè¿›åˆ¶æ—¥å¿—: åˆç§°binlogæ—¥å¿—ï¼Œä»¥äºŒè¿›åˆ¶æ–‡ä»¶çš„æ–¹å¼è®°å½•æ•°æ®åº“ä¸­é™¤ SELECT ä»¥å¤–çš„æ“ä½œ æŸ¥è¯¢æ—¥å¿—: è®°å½•æŸ¥è¯¢çš„ä¿¡æ¯ æ…¢æŸ¥è¯¢æ—¥å¿—: è®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡æŒ‡å®šæ—¶é—´çš„æ“ä½œ ä¸­ç»§æ—¥å¿—ï¼š å¤‡åº“å°†ä¸»åº“çš„äºŒè¿›åˆ¶æ—¥å¿—å¤åˆ¶åˆ°è‡ªå·±çš„ä¸­ç»§æ—¥å¿—ä¸­ï¼Œä»è€Œåœ¨æœ¬åœ°è¿›è¡Œé‡æ”¾ é€šç”¨æ—¥å¿—ï¼š å®¡è®¡å“ªä¸ªè´¦å·ã€åœ¨å“ªä¸ªæ—¶æ®µã€åšäº†å“ªäº›äº‹ä»¶ äº‹åŠ¡æ—¥å¿— æˆ–ç§°redoæ—¥å¿—ï¼Œè®°å½•Innodbäº‹åŠ¡ç›¸å…³çš„å¦‚äº‹åŠ¡æ‰§è¡Œæ—¶é—´ã€æ£€æŸ¥ç‚¹ç­‰ ========================================================\næ—¥å¿—ç±»å‹ è®°å½•ä¿¡æ¯ æ—¥å¿—æ–‡ä»¶ è®°å…¥æ–‡ä»¶ä¸­çš„ä¿¡æ¯ç±»å‹ é”™è¯¯æ—¥å¿— è®°å½•å¯åŠ¨ã€è¿è¡Œæˆ–åœæ­¢æ—¶å‡ºç°çš„é—®é¢˜ã€‚ æŸ¥è¯¢æ—¥å¿— è®°å½•å»ºç«‹çš„å®¢æˆ·ç«¯è¿æ¥å’Œæ‰§è¡Œçš„è¯­å¥ã€‚ äºŒè¿›åˆ¶æ—¥å¿— è®°å½•æ‰€æœ‰æ›´æ”¹æ•°æ®çš„è¯­å¥ã€‚ä¸»è¦ç”¨äºå¤åˆ¶å’Œå³æ—¶ç‚¹æ¢å¤ã€‚ æ…¢æ—¥å¿— è®°å½•æ‰€æœ‰æ‰§è¡Œæ—¶é—´è¶…è¿‡long_query_timeç§’çš„æ‰€æœ‰æŸ¥è¯¢æˆ–ä¸ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢ã€‚ äº‹åŠ¡æ—¥å¿— è®°å½•InnoDBç­‰æ”¯æŒäº‹åŠ¡çš„å­˜å‚¨å¼•æ“æ‰§è¡Œäº‹åŠ¡æ—¶äº§ç”Ÿçš„æ—¥å¿—ã€‚ ä¸€ã€é”™è¯¯æ—¥å¿—\né”™è¯¯æ—¥å¿—ä¸»è¦è®°å½•å¦‚ä¸‹å‡ ç§æ—¥å¿—ï¼š\næœåŠ¡å™¨å¯åŠ¨å’Œå…³é—­è¿‡ç¨‹ä¸­çš„ä¿¡æ¯\næœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯\näº‹ä»¶è°ƒåº¦å™¨è¿è¡Œä¸€ä¸ªæ—¶é—´æ˜¯äº§ç”Ÿçš„ä¿¡æ¯\nåœ¨ä»æœåŠ¡å™¨ä¸Šå¯åŠ¨ä»æœåŠ¡å™¨è¿›ç¨‹æ˜¯äº§ç”Ÿçš„ä¿¡æ¯\né”™è¯¯æ—¥å¿—å®šä¹‰ï¼šå¯ä»¥ç”¨\u0026ndash;log-error[=file_name]é€‰é¡¹æ¥æŒ‡å®šmysqldä¿å­˜é”™è¯¯æ—¥å¿—æ–‡ä»¶çš„ä½ç½®ã€‚\nå¦‚æœæ²¡æœ‰ç»™å®šfile_nameå€¼ï¼Œmysqldä½¿ç”¨é”™è¯¯æ—¥å¿—åhost_name.err å¹¶åœ¨æ•°æ®ç›®å½•ä¸­å†™å…¥æ—¥å¿—æ–‡ä»¶ã€‚å¦‚æœä½ æ‰§è¡ŒFLUSH LOGSï¼Œé”™è¯¯æ—¥å¿—ç”¨-oldé‡æ–°å‘½ååç¼€å¹¶ä¸”mysqldåˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºæ—¥å¿—æ–‡ä»¶ã€‚(å¦‚æœæœªç»™å‡º\u0026ndash;log-erroré€‰é¡¹ï¼Œåˆ™ä¸ä¼šé‡æ–°å‘½åï¼‰ã€‚\næŸ¥çœ‹å½“å‰é”™è¯¯æ—¥å¿—é…ç½® mysql\u0026gt; SHOW GLOBAL VARIABLES LIKE \u0026lsquo;%log_error%\u0026rsquo;;\næ˜¯å¦è®°å½•è­¦å‘Šæ—¥å¿— mysql\u0026gt; SHOW GLOBAL VARIABLES LIKE \u0026lsquo;%log_warnings%\u0026rsquo;;\näºŒã€bin-log\n1. å¯ç”¨\n# vim /etc/my.cnf\n[mysqld]\nlog-bin[=dir/[filename]] //ç›®å½•æƒé™å¿…é¡»mysqlç”¨æˆ·å¯å†™\n# service mysqld restart\næ³¨æ„ï¼šMySQL 5.7.3ä»¥åç‰ˆæœ¬ï¼Œå¯ç”¨bin-logåŠŸèƒ½ï¼Œéœ€è¦è®¾ç½®server-id\n2. æš‚åœ\n//ä»…å½“å‰ä¼šè¯\nSET SQL_LOG_BIN=0;\nSET SQL_LOG_BIN=1;\n3. æŸ¥çœ‹\næŸ¥çœ‹äºŒè¿›åˆ¶æ—¥å¿—çš„å·¥å…·ä¸ºï¼šmysqlbinlog\näºŒè¿›åˆ¶æ—¥å¿—åŒ…å«äº†æ‰€æœ‰æ›´æ–°äº†æ•°æ®æˆ–è€…å·²ç»æ½œåœ¨æ›´æ–°äº†æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œæ²¡æœ‰åŒ¹é…ä»»ä½•è¡Œçš„ä¸€ä¸ªDELETEï¼‰çš„æ‰€æœ‰è¯­å¥è¯­å¥\nä»¥â€œäº‹ä»¶â€çš„å½¢å¼ä¿å­˜ï¼Œå®ƒæè¿°æ•°æ®æ›´æ”¹ã€‚äºŒè¿›åˆ¶æ—¥å¿—è¿˜åŒ…å«å…³äºæ¯ä¸ªæ›´æ–°æ•°æ®åº“çš„è¯­å¥çš„æ‰§è¡Œæ—¶é—´ä¿¡æ¯ã€‚å®ƒä¸åŒ…å«æ²¡æœ‰ä¿®æ”¹ä»»ä½•æ•°æ®çš„è¯­å¥\näºŒè¿›åˆ¶æ—¥å¿—çš„ä¸»è¦ç›®çš„æ˜¯åœ¨æ•°æ®åº“å­˜åœ¨æ•…éšœæ—¶ï¼Œæ¢å¤æ—¶èƒ½å¤Ÿæœ€å¤§å¯èƒ½åœ°æ›´æ–°æ•°æ®åº“ï¼ˆå³æ—¶ç‚¹æ¢å¤ï¼‰ï¼Œå› ä¸ºäºŒè¿›åˆ¶æ—¥å¿—åŒ…å«å¤‡ä»½åè¿›è¡Œçš„æ‰€æœ‰æ›´æ–°ã€‚\näºŒè¿›åˆ¶æ—¥å¿—è¿˜ç”¨äºåœ¨ä¸»å¤åˆ¶æœåŠ¡å™¨ä¸Šè®°å½•æ‰€æœ‰å°†å‘é€ç»™ä»æœåŠ¡å™¨çš„è¯­å¥ã€‚\næŸ¥çœ‹å…¨éƒ¨ï¼š\n1 # mysqlbinlog mysql.000002 æŒ‰æ—¶é—´ï¼š\n1 2 3 4 5 # mysqlbinlog mysql.000002 --start-datetime=\u0026#34;2012-12-05 10:02:56\u0026#34; # mysqlbinlog mysql.000002 --stop-datetime=\u0026#34;2012-12-05 11:02:54\u0026#34; # mysqlbinlog mysql.000002 --start-datetime=\u0026#34;2012-12-05 10:02:56\u0026#34; --stop-datetime=\u0026#34;2012-12-05 11:02:54\u0026#34; æŒ‰å­—èŠ‚æ•°ï¼š\n1 2 3 # mysqlbinlog mysql.000002 --start-position=260 # mysqlbinlog mysql.000002 --stop-position=260 # mysqlbinlog mysql.000002 --start-position=260 --stop-position=930 4. æˆªæ–­bin-logï¼ˆäº§ç”Ÿæ–°çš„bin-logæ–‡ä»¶ï¼‰\na. é‡å¯mysqlæœåŠ¡å™¨\nb. # mysql -uroot -p123 -e \u0026lsquo;flush logs\u0026rsquo;\n5. åˆ é™¤bin-logæ–‡ä»¶\n# mysql -uroot -p123 -e \u0026lsquo;reset master\u0026rsquo;\näºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ä¸èƒ½ç›´æ¥åˆ é™¤çš„ï¼Œå¦‚æœä½¿ç”¨rmç­‰å‘½ä»¤ç›´æ¥åˆ é™¤æ—¥å¿—æ–‡ä»¶ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®åº“çš„å´©æºƒã€‚\nå¿…é¡»ä½¿ç”¨å‘½ä»¤PURGEåˆ é™¤æ—¥å¿—ï¼Œè¯­æ³•å¦‚ä¸‹ï¼šPURGE { BINARY | MASTER } LOGS { TO \u0026rsquo;log_name\u0026rsquo; | BEFORE datetime_expr }\nä¸‰ã€æŸ¥è¯¢æ—¥å¿—\nå¯ç”¨é€šç”¨æŸ¥è¯¢æ—¥å¿—\n1 2 3 4 # vim /etc/my.cnf [mysqld] log[=dir\\[filename]] # service mysqld restart å››ã€æ…¢æŸ¥è¯¢æ—¥å¿—\nå¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—\n1 2 3 4 5 # vim /etc/my.cnf [mysqld] log-slow-queries[=dir\\[filename]] long_query_time=n # service mysqld restart 1 2 3 4 MySQL 5.6: slow-query-log=1 slow-query-log-file=slow.log long_query_time=3 æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—\næµ‹è¯•:BENCHMARK(count,expr)\nSELECT BENCHMARK(50000000,2*3);\né»˜è®¤ä¸æ…¢æŸ¥è¯¢ç›¸å…³å˜é‡ï¼šmysql\u0026gt; SHOW GLOBAL VARIABLES LIKE \u0026lsquo;%slow_query_log%\u0026rsquo;;\né»˜è®¤æ²¡æœ‰å¯ç”¨æ…¢æŸ¥è¯¢ï¼Œä¸ºäº†æœåŠ¡å™¨è°ƒä¼˜ï¼Œå»ºè®®å¼€å¯\nå¼€å¯æ–¹æ³•ï¼šSET GLOBAL slow_query_log=ON;\nå½“å‰ç”Ÿæ•ˆï¼Œæ°¸ä¹…æœ‰æ•ˆé…ç½®æ–‡ä»¶ä¸­è®¾ç½®\nä½¿ç”¨mysqldumpslowå‘½ä»¤è·å¾—æ—¥å¿—ä¸­æ˜¾ç¤ºçš„æŸ¥è¯¢æ‘˜è¦æ¥å¤„ç†æ…¢æŸ¥è¯¢æ—¥å¿—\n# mysqldumpslow slow.log é‚£ä¹ˆå¤šä¹…ç®—æ˜¯æ…¢å‘¢ï¼Ÿå¦‚æœæŸ¥è¯¢æ—¶é•¿è¶…è¿‡long_query_timeçš„å®šä¹‰å€¼ï¼ˆé»˜è®¤10ç§’ï¼‰ï¼Œå³ä¸ºæ…¢æŸ¥è¯¢ï¼š\n1 mysql\u0026gt; SHOW GLOBAL VARIABLES LIKE \u0026#39;long_query_time\u0026#39;; ","date":"2019-04-19T23:49:26Z","image":"https://www.ownit.top/title_pic/68.jpg","permalink":"https://www.ownit.top/p/201904192349/","title":"MySQLæ—¥å¿—ç®¡ç†"},{"content":"MySQLå®‰å…¨æœºåˆ¶\n========================================================\nMySQLæƒé™è¡¨\nMySQLç”¨æˆ·ç®¡ç†\nMySQLæƒé™ç®¡ç†\nä¸€ã€MySQLæƒé™è¡¨\nmysql.user Global level\nç”¨æˆ·å­—æ®µ\næƒé™å­—æ®µ\nå®‰å…¨å­—æ®µ\nèµ„æºæ§åˆ¶å­—æ®µ\nmysql.dbã€mysql.host Database level\nç”¨æˆ·å­—æ®µ\næƒé™å­—æ®µ\nmysql.tables_priv Table level\nmysql.columns_priv Column level\nmysql.procs_priv\näºŒã€MySQLç”¨æˆ·ç®¡ç†\n1. ç™»å½•å’Œé€€å‡ºMySQL\nç¤ºä¾‹ï¼š\nmysql -h192.168.5.240 -P 3306 -u root -p123 mysql -e â€˜select user,host from userâ€™\n-h æŒ‡å®šä¸»æœºå\n-P MySQLæœåŠ¡å™¨ç«¯å£\n-u æŒ‡å®šç”¨æˆ·å\n-p æŒ‡å®šç™»å½•å¯†ç \næ­¤å¤„mysqlä¸ºæŒ‡å®šç™»å½•çš„æ•°æ®åº“\n-e æ¥SQLè¯­å¥\næŸ¥çœ‹ç”¨æˆ·è¡¨\nç”¨æˆ·ç®¡ç†\n1 mysql\u0026gt;use mysql; æŸ¥çœ‹\n1 mysql\u0026gt; select host,user,password fromÂ userÂ ; 2. åˆ›å»ºç”¨æˆ·\næ–¹æ³•ä¸€ï¼šCREATE USERè¯­å¥åˆ›å»º\n1 CREATE USER zhang@localhost IDENTIFIED BY \u0026#34;zhang\u0026#34;; åˆ·æ–°è¡¨\n1 flush privileges; æ–¹æ³•äºŒï¼š INSERTè¯­å¥åˆ›å»º\n1 2 3 Imysql\u0026gt; INSERT INTO mysql.user(user,host, password,ssl_cipher,x509_issuer,x509_subject) -\u0026gt; VALUES(\u0026#34;user2\u0026#34;,\u0026#34;localhost\u0026#34;,password(\u0026#34;123456\u0026#34;),\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;); Query OK, 1 row affected (0.00 sec) 1 flush privileges; æ–¹æ³•ä¸‰ï¼š GRANTè¯­å¥åˆ›å»º\n1 2 mysql\u0026gt; GRANT SELECT ON *.* TO user3@\u0026#34;localhost\u0026#34; IDENTIFIED BY \u0026#34;123456\u0026#34;; Query OK, 0 rows affected (0.00 sec) 1 mysql\u0026gt; FLUSH PRIVILEGES; 3. åˆ é™¤ç”¨æˆ·\næ–¹æ³•ä¸€ï¼šDROP USERè¯­å¥åˆ é™¤\n1 2 mysql\u0026gt; DROP USER user1@\u0026#34;localhost\u0026#34;; Query OK, 0 rows affected (0.00 sec) æ–¹æ³•äºŒï¼šDELETEè¯­å¥åˆ é™¤\n1 2 3 mysql\u0026gt; delete from user -\u0026gt; where user=\u0026#34;user2\u0026#34; and host=\u0026#34;localhost\u0026#34;; Query OK, 1 row affected (0.00 sec) 1 mysql\u0026gt; flush privileges; 4. ä¿®æ”¹ç”¨æˆ·å¯†ç \nï¼ï¼ï¼rootä¿®æ”¹è‡ªå·±å¯†ç \næ–¹æ³•ä¸€ï¼š\n1 # mysqladmin -uroot -p123 password \u0026#39;new_password\u0026#39; //123ä¸ºæ—§å¯†ç  æ–¹æ³•äºŒï¼š\n1 2 3 UPDATE mysql.user SET password=password(â€˜new_passwordâ€™) WHERE user=â€™rootâ€™ AND host=â€™localhostâ€™; FLUSH PRIVILEGES; æ–¹æ³•ä¸‰ï¼š\n1 2 SET PASSWORD=password(â€˜new_passwordâ€™); FLUSH PRIVILEGES; ==rootä¿®æ”¹å…¶ä»–ç”¨æˆ·å¯†ç \næ–¹æ³•ä¸€ï¼š\n1 2 SET PASSWORD FOR user3@â€™localhostâ€™=password(â€˜new_passwordâ€™); FLUSH PRIVILEGES; æ–¹æ³•äºŒï¼š\n1 2 3 UPDATE mysql.user SET password=password(â€˜new_passwordâ€™) WHERE user=â€™user3â€™ AND host=â€™localhostâ€™; FLUSH PRIVILEGES; æ–¹æ³•ä¸‰ï¼š\n1 2 GRANT SELECT ON *.* TO user3@â€™localhostâ€™ IDENTIFIED BY â€˜localhostâ€™; FLUSH PRIVILEGES; ï¼ï¼ï¼æ™®é€šç”¨æˆ·ä¿®æ”¹è‡ªå·±å¯†ç \næ–¹æ³•ä¸€ï¼š\n1 SET password=password(â€˜new_passwordâ€™); æ–¹æ³•äºŒï¼š\n1 # mysqladmin -uzhuzhu -p123 password \u0026#39;new_password\u0026#39; //123ä¸ºæ—§å¯†ç  ï¼ï¼ï¼ä¸¢å¤±rootç”¨æˆ·å¯†ç \n1 2 3 4 5 6 7 8 # vim /etc/my.cnf [mysqld] skip-grant-tables # service mysqld restart # mysql -uroot mysql\u0026gt; UPDATE mysql.user SET password=password(â€˜new_passwordâ€™) WHERE user=â€™rootâ€™ AND host=â€™localhostâ€™; mysql\u0026gt; FLUSH PRIVILEGES; ä¸‰ã€MySQLæƒé™ç®¡ç†\næƒé™åº”ç”¨çš„é¡ºåºï¼š\nuser (Y|N) ==\u0026gt; db ==\u0026gt; tables_priv ==\u0026gt; columns_priv\næŸ¥çœ‹ç”¨æˆ·æƒé™\n1 mysql\u0026gt; select Host,User,select_priv,insert_priv,update_priv,delete_priv from user; è¯­æ³•æ ¼å¼ï¼š\ngrant æƒé™åˆ—è¡¨ on åº“å.è¡¨å to ç”¨æˆ·å@\u0026lsquo;å®¢æˆ·ç«¯ä¸»æœº\u0026rsquo; [identified by \u0026lsquo;å¯†ç \u0026rsquo; with optionå‚æ•°];\n==æƒé™åˆ—è¡¨ all æ‰€æœ‰æƒé™ï¼ˆä¸åŒ…æ‹¬æˆæƒæƒé™ï¼‰\nselect,update\n==æ•°æ®åº“.è¡¨å *.* æ‰€æœ‰åº“ä¸‹çš„æ‰€æœ‰è¡¨ Global level\nweb.* webåº“ä¸‹çš„æ‰€æœ‰è¡¨ Database level\nweb.stu_info webåº“ä¸‹çš„stu_infoè¡¨ Table level\nSELECT (col1), INSERT (col1,col2) ON mydb.mytbl Column level\n==å®¢æˆ·ç«¯ä¸»æœº % æ‰€æœ‰ä¸»æœº\n192.168.2.% 192.168.2.0ç½‘æ®µçš„æ‰€æœ‰ä¸»æœº\n192.168.2.168 æŒ‡å®šä¸»æœº\nlocalhost æŒ‡å®šä¸»æœº\nwith_optionå‚æ•°\nGRANT OPTIONï¼š æˆæƒé€‰é¡¹\nMAX_QUERIES_PER_HOURï¼š å®šä¹‰æ¯å°æ—¶å…è®¸æ‰§è¡Œçš„æŸ¥è¯¢æ•°\nMAX_UPDATES_PER_HOURï¼š å®šä¹‰æ¯å°æ—¶å…è®¸æ‰§è¡Œçš„æ›´æ–°æ•°\nMAX_CONNECTIONS_PER_HOURï¼š å®šä¹‰æ¯å°æ—¶å¯ä»¥å»ºç«‹çš„è¿æ¥æ•°\nMAX_USER_CONNECTIONSï¼š å®šä¹‰å•ä¸ªç”¨æˆ·åŒæ—¶å¯ä»¥å»ºç«‹çš„è¿æ¥æ•°\ngrant æ™®é€šæ•°æ®ç”¨æˆ·ï¼ŒæŸ¥è¯¢ã€æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ æ•°æ®åº“ä¸­æ‰€æœ‰è¡¨æ•°æ®çš„æƒåˆ©ã€‚\ngrant select on testdb.* to common_user@â€™%â€™ grant insert on testdb.* to common_user@â€™%â€™ grant update on testdb.* to common_user@â€™%â€™ grant delete on testdb.* to common_user@â€™%â€™ **Â MySQL å‘½ä»¤æ¥æ›¿ä»£ï¼š**\ngrant select, insert, update, delete on testdb.* to common_user@â€™%â€™ grant æ•°æ®åº“å¼€å‘äººå‘˜ï¼Œåˆ›å»ºè¡¨ã€ç´¢å¼•ã€è§†å›¾ã€å­˜å‚¨è¿‡ç¨‹ã€å‡½æ•°ã€‚ã€‚ã€‚ç­‰æƒé™ã€‚\ngrant åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ MySQL æ•°æ®è¡¨ç»“æ„æƒé™ã€‚\ngrant create on testdb.* to developer@â€™192.168.0.%â€™; grant alter on testdb.* to developer@â€™192.168.0.%â€™; grant drop on testdb.* to developer@â€™192.168.0.%â€™; grant æ“ä½œ MySQL å¤–é”®æƒé™ã€‚\ngrant references on testdb.* to developer@â€™192.168.0.%â€™; grant æ“ä½œ MySQL ä¸´æ—¶è¡¨æƒé™ã€‚\ngrant create temporary tables on testdb.* to developer@â€™192.168.0.%â€™; grant æ“ä½œ MySQL ç´¢å¼•æƒé™ã€‚\ngrant index on testdb.* to developer@â€™192.168.0.%â€™; grant æ“ä½œ MySQL è§†å›¾ã€æŸ¥çœ‹è§†å›¾æºä»£ç  æƒé™ã€‚\ngrant create view on testdb.* to developer@â€™192.168.0.%â€™; grant show view on testdb.* to developer@â€™192.168.0.%â€™; grant æ“ä½œ MySQL å­˜å‚¨è¿‡ç¨‹ã€å‡½æ•° æƒé™ã€‚\ngrant create routine on testdb.* to developer@â€™192.168.0.%â€™; \u0026ndash; now, can show procedure status grant alter routine on testdb.* to developer@â€™192.168.0.%â€™; \u0026ndash; now, you can drop a procedure grant execute on testdb.* to developer@â€™192.168.0.%â€™; grant æ™®é€š DBA ç®¡ç†æŸä¸ª MySQL æ•°æ®åº“çš„æƒé™ã€‚\ngrant all privileges on testdb to dba@â€™localhostâ€™ grant é«˜çº§ DBA ç®¡ç† MySQL ä¸­æ‰€æœ‰æ•°æ®åº“çš„æƒé™ã€‚\ngrant all on *.* to dba@â€™localhostâ€™ MySQL grant æƒé™ï¼Œåˆ†åˆ«å¯ä»¥ä½œç”¨åœ¨å¤šä¸ªå±‚æ¬¡ä¸Šã€‚ 1. grant ä½œç”¨åœ¨æ•´ä¸ª MySQL æœåŠ¡å™¨ä¸Šï¼š\ngrant select on *.* to dba@localhost; \u0026ndash; dba å¯ä»¥æŸ¥è¯¢ MySQL ä¸­æ‰€æœ‰æ•°æ®åº“ä¸­çš„è¡¨ã€‚ grant all on *.* to dba@localhost; \u0026ndash; dba å¯ä»¥ç®¡ç† MySQL ä¸­çš„æ‰€æœ‰æ•°æ®åº“ 2. grant ä½œç”¨åœ¨å•ä¸ªæ•°æ®åº“ä¸Šï¼š\ngrant select on testdb.* to dba@localhost; \u0026ndash; dba å¯ä»¥æŸ¥è¯¢ testdb ä¸­çš„è¡¨ã€‚ 3. grant ä½œç”¨åœ¨å•ä¸ªæ•°æ®è¡¨ä¸Šï¼š\ngrant select, insert, update, delete on testdb.orders to dba@localhost; 4. grant ä½œç”¨åœ¨è¡¨ä¸­çš„åˆ—ä¸Šï¼š\ngrant select(id, se, rank) on testdb.apache_log to dba@localhost; 5. grant ä½œç”¨åœ¨å­˜å‚¨è¿‡ç¨‹ã€å‡½æ•°ä¸Šï¼š\ngrant execute on procedure testdb.pr_add to â€™dbaâ€™@â€™localhostâ€™ grant execute on function testdb.fn_add to â€™dbaâ€™@â€™localhostâ€™ æ³¨æ„ï¼šä¿®æ”¹å®Œæƒé™ä»¥å ä¸€å®šè¦åˆ·æ–°æœåŠ¡ï¼Œæˆ–è€…é‡å¯æœåŠ¡ï¼Œåˆ·æ–°æœåŠ¡ç”¨ï¼šFLUSH PRIVILEGESã€‚\nGrantç¤ºä¾‹ï¼š\nGRANT ALL ON *.* TO admin1@\u0026rsquo;%\u0026rsquo; IDENTIFIED BY \u0026rsquo;localhost\u0026rsquo;;\nGRANT ALL ON *.* TO admin2@\u0026rsquo;%\u0026rsquo; IDENTIFIED BY \u0026rsquo;localhost\u0026rsquo; WITH GRANT OPTION;\nGRANT ALL ON bbs.* TO admin3@\u0026rsquo;%\u0026rsquo; IDENTIFIED BY \u0026rsquo;localhost\u0026rsquo;;\nGRANT ALL ON bbs.user TO admin4@\u0026rsquo;%\u0026rsquo; IDENTIFIED BY \u0026rsquo;localhost';\nGRANT SELECT(col1),INSERT(col2,col3) ON bbs.user TO admin5@\u0026rsquo;%\u0026rsquo; IDENTIFIED BY \u0026rsquo;localhost';\nå›æ”¶æƒé™REVOKE\næŸ¥çœ‹æƒé™\nSHOW GRANTS\\G\nSHOW GRANTS FOR admin1@\u0026rsquo;%\u0026rsquo;\\G\nå›æ”¶æƒé™REVOKE\nè¯­æ³•ï¼š\nREVOKE æƒé™åˆ—è¡¨ ON æ•°æ®åº“å FROM ç”¨æˆ·å@â€˜å®¢æˆ·ç«¯ä¸»æœºâ€™\nç¤ºä¾‹ï¼š\nREVOKE DELETE ON *.* FROM admin1@â€™%â€™; //å›æ”¶éƒ¨åˆ†æƒé™\nREVOKE ALL PRIVILEGES ON *.* FROM admin2@â€™%â€™; //å›æ”¶æ‰€æœ‰æƒé™\nREVOKE ALL PRIVILEGES,GRANT OPTION ON *.* FROM \u0026lsquo;admin2\u0026rsquo;@\u0026rsquo;%\u0026rsquo;;\n========================================================\n","date":"2019-04-18T23:55:30Z","image":"https://www.ownit.top/title_pic/27.jpg","permalink":"https://www.ownit.top/p/201904182355/","title":"MySQLå®‰å…¨æœºåˆ¶"},{"content":"ä¸€ã€æ¦‚è¿°ï¼š\nå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°æ˜¯äº‹å…ˆç»è¿‡ç¼–è¯‘å¹¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„ä¸€æ®µSQLè¯­å¥çš„é›†åˆã€‚\nå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„åŒºåˆ«ï¼š\nâ€¢ å‡½æ•°å¿…é¡»æœ‰è¿”å›å€¼ï¼Œè€Œå­˜å‚¨è¿‡ç¨‹æ²¡æœ‰ã€‚\nâ€¢ å­˜å‚¨è¿‡ç¨‹çš„å‚æ•°å¯ä»¥æ˜¯INã€OUTã€INOUTç±»å‹ï¼Œå‡½æ•°çš„å‚æ•°åªèƒ½æ˜¯IN\nä¼˜ç‚¹ï¼š\nâ€¢ å­˜å‚¨è¿‡ç¨‹åªåœ¨åˆ›å»ºæ—¶è¿›è¡Œç¼–è¯‘ï¼›è€ŒSQLè¯­å¥æ¯æ‰§è¡Œä¸€æ¬¡å°±ç¼–è¯‘ä¸€æ¬¡ï¼Œæ‰€ä»¥ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å¯ä»¥æé«˜æ•°æ®åº“æ‰§è¡Œé€Ÿåº¦ã€‚\nâ€¢ ç®€åŒ–å¤æ‚æ“ä½œï¼Œç»“åˆäº‹åŠ¡ä¸€èµ·å°è£…ã€‚\nâ€¢ å¤ç”¨æ€§å¥½\nâ€¢ å®‰å…¨æ€§é«˜ï¼Œå¯æŒ‡å®šå­˜å‚¨è¿‡ç¨‹çš„ä½¿ç”¨æƒã€‚\nè¯´æ˜ï¼š\nå¹¶å‘é‡å°‘çš„æƒ…å†µä¸‹ï¼Œå¾ˆå°‘ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ã€‚\nå¹¶å‘é‡é«˜çš„æƒ…å†µä¸‹ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œç”¨å­˜å‚¨è¿‡ç¨‹æ¯”è¾ƒå¤šã€‚\näºŒã€åˆ›å»ºä¸è°ƒç”¨\nåˆ›å»ºå­˜å‚¨è¿‡ç¨‹è¯­æ³• ï¼š\ncreate procedure sp_name(å‚æ•°åˆ—è¡¨)\n[ç‰¹æ€§\u0026hellip;]è¿‡ç¨‹ä½“\nå­˜å‚¨è¿‡ç¨‹çš„å‚æ•°å½¢å¼ï¼š[IN | OUT | INOUT]å‚æ•°å ç±»å‹\nIN è¾“å…¥å‚æ•°\nOUT è¾“å‡ºå‚æ•°\nINOUT è¾“å…¥è¾“å‡ºå‚æ•°\ndelimiter $$\ncreate procedure è¿‡ç¨‹å(å‚æ•°åˆ—è¡¨)\nbegin\nSQLè¯­å¥\nend $$\ndelimiter ;\nè°ƒç”¨ï¼š\ncall å­˜å‚¨è¿‡ç¨‹å(å®å‚åˆ—è¡¨)\nå­˜å‚¨è¿‡ç¨‹ä¸‰ç§å‚æ•°ç±»å‹ï¼šIN, OUT, INOUT ===================NONE========================\n1 2 3 4 5 6 7 8 9 mysql\u0026gt; \\d $$ mysql\u0026gt; create procedure p1() -\u0026gt; begin -\u0026gt; select count(*) from mysql.user; -\u0026gt; end$$ Query OK, 0 rows affected (0.51 sec) mysql\u0026gt; \\d ; mysql\u0026gt; call p1() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 mysql\u0026gt; create school.table t1( -\u0026gt; id int, -\u0026gt; name varchar(50) -\u0026gt; ); Query OK, 0 rows affected (2.81 sec) mysql\u0026gt; delimiter $$ mysql\u0026gt; create procedure autoinsert1() -\u0026gt; BEGIN -\u0026gt; declare i int default 1; -\u0026gt; while(i\u0026lt;=20000)do -\u0026gt; insert into school.t1 values(i,md5(i)); -\u0026gt; set i=i+1; -\u0026gt; end while; -\u0026gt; END$$ mysql\u0026gt; delimiter ; ====================IN==========================\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 mysql\u0026gt; create procedure autoinsert2(IN a int) -\u0026gt; BEGIN -\u0026gt; declare i int default 1; -\u0026gt; while(i\u0026lt;=a)do -\u0026gt; insert into school.t1 values(i,md5(i)); -\u0026gt; set i=i+1; -\u0026gt; end while; -\u0026gt; END$$ Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; call autoinsert1(10); Query OK, 1 row affected (1.10 sec) mysql\u0026gt; set @num=20; mysql\u0026gt; select @num; +------+ | @num | +------+ | 20 | +------+ 1 row in set (0.00 sec) mysql\u0026gt; call autoinsert1(@num); ====================OUT=======================\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 mysql\u0026gt; delimiter $$ mysql\u0026gt; CREATE PROCEDURE p2 (OUT param1 INT) -\u0026gt; BEGIN -\u0026gt; SELECT COUNT(*) INTO param1 FROM t1; -\u0026gt; END$$ Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; delimiter ; mysql\u0026gt; select @a; +------+ | @a | +------+ | NULL | +------+ 1 row in set (0.00 sec) mysql\u0026gt; CALL p2(@a); Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; SELECT @a; +------+ | @a | +------+ | 3 | +------+ ===================IN å’Œ OUT=====================\nä½œç”¨ï¼šç»Ÿè®¡æŒ‡å®šéƒ¨é—¨çš„å‘˜å·¥æ•° 1 2 3 4 5 6 7 8 9 10 11 12 mysql\u0026gt; create procedure count_num(IN p1 varchar(50), OUT p2 int) -\u0026gt; BEGIN -\u0026gt; select count(*) into p2 from employee -\u0026gt; where post=p1; -\u0026gt; END$$ Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; \\d ; mysql\u0026gt; call count_num(\u0026#39;hr\u0026#39;,@a); mysql\u0026gt;select @a; ä½œç”¨ï¼šç»Ÿè®¡æŒ‡å®šéƒ¨é—¨å·¥èµ„è¶…è¿‡ä¾‹å¦‚5000çš„æ€»äººæ•° 1 2 3 4 5 6 7 8 9 mysql\u0026gt; create procedure count_num(IN p1 varchar(50), IN p2 float(10,2), OUT p3 int) -\u0026gt; BEGIN -\u0026gt; select count(*) into p3 from employee -\u0026gt; where post=p1 and salary=\u0026gt;p2; -\u0026gt; END$$ Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; \\d ; mysql\u0026gt; call count_num(\u0026#39;hr\u0026#39;,5000,@a); ====================INOUT======================\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 mysql\u0026gt; create procedure proce_param_inout(inout p1 int) -\u0026gt; begin -\u0026gt; if (p1 is not null) then -\u0026gt; set p1=p1+1; -\u0026gt; else -\u0026gt; select 100 into p1; -\u0026gt; end if; -\u0026gt; end$$ Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; select @h; +------+ | @h | +------+ | NULL | +------+ 1 row in set (0.00 sec) mysql\u0026gt; call proce_param_inout(@h); Query OK, 1 row affected (0.00 sec) mysql\u0026gt; select @h; +------+ | @h | +------+ | 100 | +------+begin 1 row in set (0.00 sec) mysql\u0026gt; call proce_param_inout(@h); Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; select @h; +------+ | @h | +------+ | 101 | +------+ 1 row in set (0.00 sec) FUNCTIONå‡½æ•° =================================================\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 mysql\u0026gt; CREATE FUNCTION hello (s CHAR(20)) -\u0026gt; RETURNS CHAR(50) RETURN CONCAT(\u0026#39;Hello, \u0026#39;,s,\u0026#39;!\u0026#39;); Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; select hello(\u0026#39;localhost\u0026#39;); +------------------+ | hello(\u0026#39;localhost\u0026#39;) | +------------------+ | Hello, localhost! | +------------------+ root@(company)\u0026gt; select hello(\u0026#39;localhost\u0026#39;) return1; +-----------------+ | return1 | +-----------------+ | Hello, localhost! | +-----------------+ 1 row in set (0.00 sec) mysql\u0026gt; create function name_from_employee(x int) -\u0026gt; returns varchar(50) -\u0026gt; BEGIN -\u0026gt; return (select emp_name from employee -\u0026gt; where emp_id=x); -\u0026gt; END$$ Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; select name_from_employee(3); mysql\u0026gt; select * from employee where emp_name=name_from_employee(1); +--------+----------+------+------------+------------+-----------------+---------+--------+--------+ | emp_id | emp_name | sex | hire_date | post | job_description | salary | office | dep_id | +--------+----------+------+------------+------------+-----------------+---------+--------+--------+ | 1 | jack | male | 2013-02-02 | instructor | teach | 5000.00 | 501 | 100 | +--------+----------+------+------------+------------+-----------------+---------+--------+--------+ 1 row in set (0.00 sec) ==============================================\nåˆ›å»ºå‡½æ•°çš„è¯­æ³•ï¼š\ncreate function å‡½æ•°å(å‚æ•°åˆ—è¡¨) returns è¿”å›å€¼ç±»å‹\n[ç‰¹æ€§\u0026hellip;] å‡½æ•°ä½“\nå‡½æ•°çš„å‚æ•°å½¢å¼ï¼šå‚æ•°å ç±»å‹\ndelimiter $$\ncreate function å‡½æ•°å(å‚æ•°åˆ—è¡¨) returns è¿”å›å€¼ç±»å‹\nbegin\næœ‰æ•ˆçš„SQLè¯­å¥\nend$$\ndelimiter ;\nè°ƒç”¨ï¼š\nselect å‡½æ•°å(å®å‚åˆ—è¡¨)\ndelimiter $$\ncreate function fun1(str char(20)) returns char(50)\nreturn concat(\u0026ldquo;hello\u0026rdquo;,str,\u0026quot;!\u0026quot;);\n$$\ndelimiter ;\nselect fun1(\u0026rsquo; function\u0026rsquo;);\nå­˜å‚¨è¿‡ç¨‹ä¸å‡½æ•°çš„ç»´æŠ¤ï¼š\nshow create procedure pr1 \\G;\nshow create function pr1 \\G;\nshow {procedure|function} status {like \u0026lsquo;pattern\u0026rsquo;}\ndrop {procedure|function} {if exists} sp_name\nmysqlå˜é‡çš„æœ¯è¯­åˆ†ç±»ï¼š\n1.ç”¨æˆ·å˜é‡ï¼šä»¥\u0026quot;@\u0026ldquo;å¼€å§‹ï¼Œå½¢å¼ä¸º\u0026rdquo;@å˜é‡å\u0026quot;ï¼Œç”±å®¢æˆ·ç«¯å®šä¹‰çš„å˜é‡ã€‚\nç”¨æˆ·å˜é‡è·Ÿmysqlå®¢æˆ·ç«¯æ˜¯ç»‘å®šçš„ï¼Œè®¾ç½®çš„å˜é‡åªå¯¹å½“å‰ç”¨æˆ·ä½¿ç”¨çš„å®¢æˆ·ç«¯ç”Ÿæ•ˆï¼Œå½“ç”¨æˆ·æ–­å¼€è¿æ¥æ—¶ï¼Œæ‰€æœ‰å˜é‡ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚\n2.å…¨å±€å˜é‡ï¼šå®šä¹‰æ—¶å¦‚ä¸‹ä¸¤ç§å½¢å¼ï¼Œset GLOBAL å˜é‡åÂ æˆ–è€…Â set @@global.å˜é‡å\nå¯¹æ‰€æœ‰å®¢æˆ·ç«¯ç”Ÿæ•ˆï¼Œä½†åªæœ‰å…·æœ‰superæƒé™æ‰å¯ä»¥è®¾ç½®å…¨å±€å˜é‡ã€‚\n3.ä¼šè¯å˜é‡ï¼šåªå¯¹è¿æ¥çš„å®¢æˆ·ç«¯æœ‰æ•ˆã€‚\n4.å±€éƒ¨å˜é‡ï¼šè®¾ç½®å¹¶ä½œç”¨äºbegin\u0026hellip;endè¯­å¥å—ä¹‹é—´çš„å˜é‡ã€‚\ndeclareè¯­å¥ä¸“é—¨ç”¨äºå®šä¹‰å±€éƒ¨å˜é‡ã€‚è€Œsetè¯­å¥æ˜¯è®¾ç½®ä¸åŒç±»å‹çš„å˜é‡ï¼ŒåŒ…æ‹¬ä¼šè¯å˜é‡å’Œå…¨å±€å˜é‡\nè¯­æ³•ï¼šdeclare å˜é‡å[\u0026hellip;] å˜é‡ç±»å‹ [default å€¼]\ndeclareå®šä¹‰çš„å˜é‡å¿…é¡»å†™åœ¨å¤åˆè¯­å¥çš„å¼€å¤´ï¼Œå¹¶ä¸”åœ¨ä»»ä½•å…¶å®ƒè¯­å¥çš„å‰é¢ã€‚\nå˜é‡çš„èµ‹å€¼ï¼š\nç›´æ¥èµ‹å€¼ï¼š set å˜é‡å=è¡¨è¾¾å¼å€¼æˆ–å¸¸é‡å€¼[\u0026hellip;];\nç”¨æˆ·å˜é‡çš„èµ‹å€¼ï¼š\n1ã€set å˜é‡å=è¡¨è¾¾å¼æˆ–å¸¸é‡å€¼;\n2ã€ä¹Ÿå¯ä»¥å°†æŸ¥è¯¢ç»“æœèµ‹å€¼ç»™å˜é‡(è¦æ±‚æŸ¥è¯¢è¿”å›çš„ç»“æœåªèƒ½æœ‰ä¸€è¡Œ)\nä¾‹ï¼šset åˆ—å into å˜é‡å from è¡¨å where æ¡ä»¶;\n3ã€select å€¼ into @å˜é‡åï¼›\nå®¢æˆ·ç«¯å˜é‡ä¸èƒ½ç›¸äº’å…±äº«ã€‚\n1 2 3 4 5 6 7 8 9 10 11 delimiter $$ create procedure pr2() begin declare xname varchar(50); declare xdesc varchar(100); set xname=\u0026#34;caiwu\u0026#34;; set xdesc=\u0026#34;accouting\u0026#34;; insert into dept(name,desc) values(xname,xdesc); end$$ delimiter ; call pr2(); 1 2 3 4 5 6 7 8 delimiter $$ create procedure pr3(in x int,in y int,out sum int) begin set sum=x+y; end$$ delimiter ; call pr3(3,4,@sum); select @sum; 1 2 3 4 5 6 7 8 9 delimiter // create function fun6(x int,y int) returns int begin declare sum int; set sum=x+y; return sum; end// delimiter ; select fun6(4,3); 1 2 3 4 5 6 7 8 9 10 11 delimiter // create function fun_add_rand(in_int int ) RETURNS int BEGIN declare i_rand int; declare i_return int; set i_rand=floor(rand()*100); set i_return = in_int + i_rand; return i_return; END; // ","date":"2019-04-18T22:33:16Z","image":"https://www.ownit.top/title_pic/53.jpg","permalink":"https://www.ownit.top/p/201904182233/","title":"MySQLå­˜å‚¨è¿‡ç¨‹ä¸å‡½æ•°"},{"content":"MySQLè§¦å‘å™¨Triggers\n========================================================\nè§¦å‘å™¨ç®€ä»‹\nåˆ›å»ºè§¦å‘å™¨\næŸ¥çœ‹è§¦å‘å™¨\nåˆ é™¤è§¦å‘å™¨\nè§¦å‘å™¨æ¡ˆä¾‹\nä¸€ã€è§¦å‘å™¨ç®€ä»‹\nè§¦å‘å™¨ï¼ˆtriggerï¼‰æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å­˜å‚¨è¿‡ç¨‹ï¼Œå®ƒçš„æ‰§è¡Œä¸æ˜¯ç”±ç¨‹åºè°ƒç”¨ï¼Œä¹Ÿä¸æ˜¯æ‰‹å·¥å¯åŠ¨ï¼Œè€Œæ˜¯ç”±äº‹ä»¶æ¥è§¦å‘ï¼Œ\næ¯”å¦‚å½“å¯¹ä¸€ä¸ªè¡¨è¿›è¡Œæ“ä½œï¼ˆ insertï¼Œdeleteï¼Œ updateï¼‰æ—¶å°±ä¼šæ¿€æ´»å®ƒæ‰§è¡Œã€‚è§¦å‘å™¨ç»å¸¸ç”¨äºåŠ å¼ºæ•°æ®çš„å®Œæ•´\næ€§çº¦æŸå’Œä¸šåŠ¡è§„åˆ™ç­‰ã€‚\nä¾‹å¦‚ï¼Œå½“å­¦ç”Ÿè¡¨ä¸­å¢åŠ äº†ä¸€ä¸ªå­¦ç”Ÿçš„ä¿¡æ¯æ—¶ï¼Œå­¦ç”Ÿçš„æ€»æ•°å°±åº”è¯¥åŒæ—¶æ”¹å˜ã€‚å› æ­¤å¯ä»¥é’ˆå¯¹å­¦ç”Ÿè¡¨åˆ›å»ºä¸€ä¸ªè§¦å‘\nå™¨ï¼Œæ¯æ¬¡å¢åŠ ä¸€ä¸ªå­¦ç”Ÿè®°å½•æ—¶ï¼Œå°±æ‰§è¡Œä¸€æ¬¡å­¦ç”Ÿæ€»æ•°çš„è®¡ç®—æ“ä½œï¼Œä»è€Œä¿è¯å­¦ç”Ÿæ€»æ•°ä¸è®°å½•æ•°çš„ä¸€è‡´æ€§ã€‚\näºŒã€åˆ›å»ºTrigger\nè¯­æ³•ï¼š\nCREATE TRIGGER è§¦å‘å™¨åç§° BEFORE|AFTER è§¦å‘äº‹ä»¶\nON è¡¨å FOR EACH ROW\nBEGIN\nè§¦å‘å™¨ç¨‹åºä½“;\nEND\n\u0026lt;è§¦å‘å™¨åç§°\u0026gt; æœ€å¤š64ä¸ªå­—ç¬¦ï¼Œå®ƒå’ŒMySQLä¸­å…¶ä»–å¯¹è±¡çš„å‘½åæ–¹å¼ä¸€æ ·\n{ BEFORE | AFTER } è§¦å‘å™¨æ—¶æœº\n**{ INSERT | UPDATE | DELETE }**è§¦å‘çš„äº‹ä»¶\nON \u0026lt;è¡¨åç§°\u0026gt; æ ‡è¯†å»ºç«‹è§¦å‘å™¨çš„è¡¨åï¼Œå³åœ¨å“ªå¼ è¡¨ä¸Šå»ºç«‹è§¦å‘å™¨\nFOR EACH ROW è§¦å‘å™¨çš„æ‰§è¡Œé—´éš”ï¼šFOR EACH ROWå­å¥é€šçŸ¥è§¦å‘å™¨ æ¯éš”ä¸€è¡Œ\næ‰§è¡Œä¸€æ¬¡åŠ¨ä½œï¼Œè€Œä¸æ˜¯å¯¹æ•´ä¸ªè¡¨æ‰§è¡Œä¸€æ¬¡\n\u0026lt;è§¦å‘å™¨ç¨‹åºä½“\u0026gt; è¦è§¦å‘çš„SQLè¯­å¥ï¼šå¯ç”¨é¡ºåºï¼Œåˆ¤æ–­ï¼Œå¾ªç¯ç­‰è¯­å¥å®ç°ä¸€èˆ¬ç¨‹åºéœ€è¦çš„é€»è¾‘åŠŸèƒ½\nè§¦å‘å™¨ç¤ºä¾‹ 1. åˆ›å»ºè¡¨\n1 2 3 4 5 6 7 8 mysql\u0026gt; create table student( -\u0026gt; id int unsigned auto_increment primary key not null, -\u0026gt; name varchar(50) -\u0026gt; ); mysql\u0026gt; insert into student(name) values(\u0026#39;wei\u0026#39;); mysql\u0026gt; create table student_total(total int); mysql\u0026gt; insert into student_total values(1); 2. åˆ›å»ºè§¦å‘å™¨student_insert_trigger\nåˆ›å»ºè§¦å‘å™¨ï¼Œå®ç°æ·»åŠ å­¦ç”Ÿä¿¡æ¯ï¼Œæ•°é‡è‡ªåŠ¨å¢åŠ  1 2 3 4 5 6 7 8 mysql\u0026gt; \\d $$ mysql\u0026gt; create trigger student_insert_tigger after insert on student for each row begin update nummber set count=count+1; end$$ Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; \\d ; åˆ›å»ºè§¦å‘å™¨ï¼Œåˆ é™¤å­¦ç”Ÿä¿¡æ¯ï¼Œæ•°é‡è‡ªåŠ¨å‡å°‘ 1 2 3 4 5 6 7 8 9 mysql\u0026gt; \\d $ # ä¿®æ”¹mysqlç»“æŸç¬¦ mysql\u0026gt; create trigger student_delete_trigger after delete -\u0026gt; on student for each row -\u0026gt; begin -\u0026gt; update number set count=count-1; -\u0026gt; end$ Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; \\d ; åˆ é™¤ä¸€ä¸ªå­¦ç”Ÿä¿¡æ¯ 1 mysql\u0026gt; delete from student wheree id=\u0026#34;2\u0026#34;; æŸ¥çœ‹å­¦ç”Ÿä¿¡æ¯\nä¸‰ã€æŸ¥çœ‹è§¦å‘å™¨\n1. é€šè¿‡SHOW TRIGGERSè¯­å¥æŸ¥çœ‹\n1 mysql\u0026gt; show triggers\\G; 2. é€šè¿‡ç³»ç»Ÿè¡¨triggersæŸ¥çœ‹\nUSE information_schema\nSELECT * FROM triggers\\G\nSELECT * FROM triggers WHERE TRIGGER_NAME=\u0026lsquo;è§¦å‘å™¨åç§°\u0026rsquo;\\G\nå››ã€åˆ é™¤è§¦å‘å™¨\n1. é€šè¿‡DROP TRIGGERSè¯­å¥åˆ é™¤\nDROP TRIGGER è§£å‘å™¨åç§°\n1 2 mysql\u0026gt; drop trigger student_delete_trigger; Query OK, 0 rows affected (0.00 sec) ","date":"2019-04-18T20:02:46Z","image":"https://www.ownit.top/title_pic/75.jpg","permalink":"https://www.ownit.top/p/201904182002/","title":"MySQLè§¦å‘å™¨"},{"content":"è§†å›¾\nè§†å›¾å°±æ˜¯ä¸€ä¸ªè¡¨æˆ–å¤šä¸ªè¡¨çš„æŸ¥è¯¢ç»“æœï¼Œå®ƒæ˜¯ä¸€å¼ è™šæ‹Ÿçš„è¡¨ï¼Œå› ä¸ºå®ƒå¹¶ä¸èƒ½å­˜å‚¨æ•°æ®ã€‚\nè§†å›¾çš„ä½œç”¨ã€ä¼˜ç‚¹ï¼š\né™åˆ¶å¯¹æ•°æ®çš„è®¿é—®\nè®©å¤æ‚æŸ¥è¯¢å˜å¾—ç®€å•\næä¾›æ•°æ®çš„ç‹¬ç«‹æ€§\nå¯ä»¥å®Œæˆå¯¹ç›¸åŒæ•°æ®çš„ä¸åŒæ˜¾ç¤º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 //åˆ›å»ºã€ä¿®æ”¹è§†å›¾ create or replace view view_temp as select name, age from temp; //é€šå¸¸ä¸å¯¹è§†å›¾çš„æ•°æ®åšä¿®æ”¹æ“ä½œï¼Œå› ä¸ºè§†å›¾æ˜¯ä¸€å¼ è™šæ‹Ÿçš„è¡¨ï¼Œå®ƒå¹¶ä¸å­˜å‚¨å®é™…æ•°æ®ã€‚å¦‚æœæƒ³è®©è§†å›¾ä¸è¢«ä¿®æ”¹ï¼Œå¯ä»¥ç”¨with check optionæ¥å®Œæˆé™åˆ¶ã€‚ create or replace view view_temp as select *from temp with check option; //åˆ é™¤è§†å›¾ drop view view_temp; //æ˜¾ç¤ºåˆ›å»ºè¯­æ³• show create view v_temp; æ˜¾ç¤ºå­¦ç”Ÿæˆç»©å•çš„è§†å›¾\n1 2 3 4 mysql\u0026gt; create view student_cj as select students.number,students.name,course.math,course.english,course.chinese -\u0026gt; from students,course -\u0026gt; where students.number=course.number; Query OK, 0 rows affected (0.00 sec) ä½¿ç”¨student_cjä¸ªè§†å›¾ï¼Œæ˜¾ç¤ºç»“æœ\nåˆ é™¤è¿™ä¸ªè§†å›¾\n1 2 mysql\u0026gt; drop view student_cj; Query OK, 0 rows affected (0.00 sec) æŸ¥çœ‹è§†å›¾çš„ä¿¡æ¯\n1 mysql\u0026gt; show create view student_cj\\G ç´¢å¼•\n1.åœ¨ä¸è¯»å–æ•´ä¸ªè¡¨çš„æƒ…å†µä¸‹ï¼Œç´¢å¼•ä½¿æ•°æ®åº“åº”ç”¨ç¨‹åºå¯ä»¥æ›´å¿«åœ°æŸ¥æ‰¾æ•°æ®ã€‚[ æ˜¯ä¸ºäº†å¿«é€ŸæŸ¥è¯¢è€Œé’ˆå¯¹æŸäº›å­—æ®µå»ºç«‹èµ·æ¥çš„ã€‚]\n2.æ›´æ–°ä¸€ä¸ªåŒ…å«ç´¢å¼•çš„è¡¨éœ€è¦æ¯”æ›´æ–°ä¸€ä¸ªæ²¡æœ‰ç´¢å¼•çš„è¡¨æ›´å¤šçš„æ—¶é—´ï¼Œè¿™æ˜¯ç”±äºç´¢å¼•æœ¬èº«ä¹Ÿéœ€è¦æ›´æ–°ã€‚\n3.è¡¨\n01.æ•°æ®åº“ä¸­çš„æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨è¡¨ä¸­çš„\n02.è¡¨æ˜¯ç‰©ç†å­˜å‚¨çš„ï¼ŒçœŸå®å­˜åœ¨çš„\n2.æ¡ˆä¾‹\nåˆ›å»ºç´¢å¼•ï¼šcreate index degree_fast on score (degree);Â è¿™é‡Œçš„dgeree_fastæ˜¯ç´¢å¼•åï¼Œscoreæ˜¯è¡¨æ˜ï¼Œdegreeæ˜¯è¡¨ä¸­çš„ä¸€ä¸ªå­—æ®µã€‚Â åˆ›å»ºè§†å›¾ï¼š\n1 2 3 create view [viewName] as select [someFields] from [tableName] åˆ é™¤ç´¢å¼•ï¼šÂ - 01.æ–¹å¼ä¸€ï¼šdrop index degree_fast on score;Â - 02.æ–¹å¼äºŒï¼šalter table score drop index degree_fast;\nMysql cannot drop index needed in a foreign key constraint.Mysqlä¸èƒ½åœ¨å¤–é”®çº¦æŸä¸‹åˆ é™¤ç´¢å¼•ã€‚å¦‚æœæœ‰å¤–é”®çš„è¯ï¼Œéœ€è¦å…ˆæŠŠå¤–é”®åˆ é™¤ï¼Œç„¶åå†åˆ é™¤ç´¢å¼•ã€‚\n","date":"2019-04-17T23:46:10Z","image":"https://www.ownit.top/title_pic/42.jpg","permalink":"https://www.ownit.top/p/201904172346/","title":"MySQLè§†å›¾åŠç´¢å¼•"},{"content":"select è¯­å¥ï¼š select è¯­å¥ä¸€èˆ¬ç”¨æ³•ä¸º: select å­—æ®µå from tb_name where æ¡ä»¶ ; **select æŸ¥è¯¢è¯­å¥ç±»å‹ä¸€èˆ¬åˆ†ä¸ºä¸‰ç§ï¼šÂ å•è¡¨æŸ¥è¯¢ï¼Œå¤šè¡¨æŸ¥è¯¢ï¼Œå­æŸ¥è¯¢**\næœ€ç®€å•çš„å•è¡¨æŸ¥è¯¢ : select * from tb_name;Â *è¡¨ç¤ºï¼Œæ‰€æœ‰å­—æ®µ\næŸ¥è¯¢ç‰¹å®šå­—æ®µ(æŠ•å½±)ï¼šÂ select å­—æ®µå1ï¼Œå­—æ®µå2ï¼Œ from tb_name;\nwhere è¯­å¥è¿‡æ»¤æŸ¥è¯¢(é€‰æ‹©)\nselect * from tb_name where æ¡ä»¶ ;\nä½¿ç”¨SELECTå­å¥è¿›è¡Œå¤šè¡¨æŸ¥è¯¢\nSELECT å­—æ®µå FROM è¡¨1ï¼Œè¡¨2 â€¦ WHERE è¡¨1.å­—æ®µ = è¡¨2.å­—æ®µ AND å…¶å®ƒæŸ¥è¯¢æ¡ä»¶\nSELECT a.id,a.name,a.address,a.date,b.math,b.english,b.chinese FROM tb_demo065_tel AS b,tb_demo065 AS a WHERE a.id=b.id\næ³¨:åœ¨ä¸Šé¢çš„çš„ä»£ç ä¸­ï¼Œä»¥ä¸¤å¼ è¡¨çš„idå­—æ®µä¿¡æ¯ç›¸åŒä½œä¸ºæ¡ä»¶å»ºç«‹ä¸¤è¡¨å…³è”ï¼Œä½†åœ¨å®é™…å¼€å‘ä¸­ä¸åº”è¯¥è¿™æ ·ä½¿ç”¨ï¼Œæœ€å¥½ç”¨ä¸»å¤–é”®çº¦æŸæ¥å®ç°\né¦–å…ˆåˆ›å»ºä¸€ä¸ªæ•°æ®åº“ å­¦ç”Ÿäººæ•°è¡¨ å­¦ç”Ÿæˆç»©è¡¨ æ˜¾ç¤ºæ¯ä¸ªå­¦ç”Ÿçš„å¯¹åº”çš„æˆç»© æ–¹æ³•ä¸€ï¼š\n1 2 3 mysql\u0026gt; select students.number,students.name,students.sex,course.math,course.english,course.chinese -\u0026gt; from students inner join course -\u0026gt; on students.number=course.number; æ–¹æ³•äºŒï¼š\n1 2 3 mysql\u0026gt; select students.number,students.name,students.sex,course.math,course.english,course.chinese -\u0026gt; from students,course -\u0026gt; where students.number=course.number; æ ¹æ®å­¦å·æ’åå‡åºè¾“å‡ºæˆç»© 1 mysql\u0026gt; select students.number as å­¦å·,students.name as å§“å,course.math as æ•°å­¦,course.english as è‹±è¯­,course.chinese as è¯­æ–‡ from students,course where students.number=course.number order by students.number; æ±‚å­¦ç”Ÿçš„æ€»æˆç»©ï¼Œå¹¶æ˜¾ç¤ºå‡ºæ¥ï¼Œæˆç»©æŒ‰é™åºæ’åˆ— 1 mysql\u0026gt; select students.number as å­¦å·,students.name as å§“å,(course.math+course.english +course.chinese) as æ€»æˆç»© from students,course where students.number=course.number order by æ€»æˆç»© desc; ","date":"2019-04-17T16:31:24Z","image":"https://www.ownit.top/title_pic/23.jpg","permalink":"https://www.ownit.top/p/201904171631/","title":"MySQLçš„selectå¤šè¡¨æŸ¥è¯¢"},{"content":"MySQL æŸ¥è¯¢æ•°æ® MySQL æ•°æ®åº“ä½¿ç”¨SQL SELECTè¯­å¥æ¥æŸ¥è¯¢æ•°æ®ã€‚\nä½ å¯ä»¥é€šè¿‡ mysql\u0026gt; å‘½ä»¤æç¤ºçª—å£ä¸­åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®\nè¯­æ³• ä»¥ä¸‹ä¸ºåœ¨MySQLæ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®é€šç”¨çš„ SELECT è¯­æ³•ï¼š\nSELECT column_name,column_name FROM table_name [WHERE Clause] [LIMIT N][ OFFSET M]\næŸ¥è¯¢è¯­å¥ä¸­ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¡¨ï¼Œè¡¨ä¹‹é—´ä½¿ç”¨é€—å·(,)åˆ†å‰²ï¼Œå¹¶ä½¿ç”¨WHEREè¯­å¥æ¥è®¾å®šæŸ¥è¯¢æ¡ä»¶ã€‚ SELECT å‘½ä»¤å¯ä»¥è¯»å–ä¸€æ¡æˆ–è€…å¤šæ¡è®°å½•ã€‚ ä½ å¯ä»¥ä½¿ç”¨æ˜Ÿå·ï¼ˆ*ï¼‰æ¥ä»£æ›¿å…¶ä»–å­—æ®µï¼ŒSELECTè¯­å¥ä¼šè¿”å›è¡¨çš„æ‰€æœ‰å­—æ®µæ•°æ® ä½ å¯ä»¥ä½¿ç”¨ WHERE è¯­å¥æ¥åŒ…å«ä»»ä½•æ¡ä»¶ã€‚ ä½ å¯ä»¥ä½¿ç”¨ LIMIT å±æ€§æ¥è®¾å®šè¿”å›çš„è®°å½•æ•°ã€‚ ä½ å¯ä»¥é€šè¿‡OFFSETæŒ‡å®šSELECTè¯­å¥å¼€å§‹æŸ¥è¯¢çš„æ•°æ®åç§»é‡ã€‚é»˜è®¤æƒ…å†µä¸‹åç§»é‡ä¸º0ã€‚ å»ºä¸€å¼ è¡¨ç”¨äºæˆ‘ä»¬æµ‹è¯•ï¼šÂ 1 2 3 4 5 6 7 8 create table student ( ids int auto_increment primary key, name varchar(20), chinese float, english float, math float ); æ’å…¥å¦‚ä¸‹æ•°æ®ï¼šÂ 1 2 3 4 5 6 7 insert into student values(1,\u0026#39;ææ˜\u0026#39;,89,78,90);Â insert into student values(2,\u0026#39;ä¹˜é£\u0026#39;,67,89,56);Â insert into student values(3,\u0026#39;å—å®«æµäº‘\u0026#39;,87,78,77);Â insert into student values(4,\u0026#39;å—å®«çš“æœˆ\u0026#39;,88,98,90);Â insert into student values(5,\u0026#39;å—å®«ç´«æœˆ\u0026#39;,82,84,67);Â insert into student values(6,\u0026#39;è§ç‚\u0026#39;,55,85,45);Â insert into student values(7,\u0026#39;æ—åŠ¨\u0026#39;,75,65,30); 1ã€æŒ‡å®šæŸ¥è¯¢åˆ— 1 mysql\u0026gt; select id,name,chinese from student; 2ã€å»é‡æŸ¥è¯¢ ç”¨distinctå…³é”®å­—ï¼Œ å¦‚æœç»“æœä¸­æœ‰å®Œå…¨ç›¸åŒçš„è¡Œï¼Œå°±å»é™¤é‡å¤è¡Œ\n1 mysql\u0026gt; select distinct math from student; 3ã€selectè¯­å¥ä¸­è¿›è¡Œè¿ç®— æŸ¥è¯¢å­¦ç”Ÿæ€»æˆç»©Â 1 mysql\u0026gt; select id,name,(chinese+math+english) as æ€»æˆç»© from student; æŸ¥è¯¢æ‰€æœ‰å§“å—å®«äººçš„æ€»æˆç»©ã€‚Â 1 2 mysql\u0026gt; select id,name,(chinese+math+english) as æ€»æˆç»© from student -\u0026gt; where name like \u0026#39;å—å®«%\u0026#39;; 4ã€whereæŸ¥è¯¢è¿‡æ»¤ åœ¨whereå­å¥ä¸­æœ‰å¾ˆå¤šç»å¸¸ä½¿ç”¨çš„è¿ç®—ç¬¦ï¼Œå¦‚ä¸‹ï¼šÂ ï¼ˆ1ï¼‰æŸ¥è¯¢æ‰€æœ‰è‹±è¯­æˆç»©å¤§äº90çš„åŒå­¦æˆç»©ï¼šÂ 1 2 mysql\u0026gt; select id,name,english as è‹±è¯­ from student -\u0026gt; where english \u0026gt; 90; ï¼ˆ2ï¼‰æŸ¥è¯¢æ‰€æœ‰æ€»åˆ†å¤§äº200åˆ†çš„åŒå­¦Â æ³¨æ„ï¼šwhereå­å¥åä¸èƒ½ç”¨åˆ«åÂ å› ä¸ºæ•°æ®åº“ä¸­å…ˆæ‰§è¡Œwhereå­å¥ï¼Œå†æ‰§è¡Œselectå­å¥ã€‚Â 1 2 mysql\u0026gt; select id,name,(chinese+math+english) as æ€»æˆç»© from student -\u0026gt; where (chinese+math+english) \u0026gt; 200; ï¼ˆ3ï¼‰æŸ¥è¯¢å§“æ—å¹¶ä¸”idå¤§äº6çš„å­¦ç”Ÿä¿¡æ¯Â 1 2 mysql\u0026gt; select id,name from student -\u0026gt; where name like \u0026#39;æ—%\u0026#39; and id \u0026gt;6; ï¼ˆ4ï¼‰æŸ¥è¯¢è‹±è¯­æˆç»©å¤§äºè¯­æ–‡æˆç»©çš„åŒå­¦Â 1 2 mysql\u0026gt; select id,name from student -\u0026gt; where english \u0026gt; chinese; ï¼ˆ5ï¼‰æŸ¥è¯¢æ‰€æœ‰æ€»åˆ†å¤§äº200å¹¶ä¸”æ•°å­¦æˆç»©å°äºè¯­æ–‡æˆç»©çš„å­¦ç”Ÿä¿¡æ¯Â 1 2 mysql\u0026gt; select id,name from student -\u0026gt; where (chinese+math+english) \u0026gt;200 and math \u0026lt; chinese; ï¼ˆ6ï¼‰æŸ¥è¯¢æ‰€æœ‰è‹±è¯­æˆç»©åœ¨80åˆ°90åˆ†çš„åŒå­¦Â æ–¹æ³•ä¸€ï¼šÂ 1 2 mysql\u0026gt; select id,name,english from student -\u0026gt; where english \u0026gt;=80 and english \u0026lt;= 90; æ–¹æ³•äºŒï¼šÂ æ³¨æ„ï¼šbetweenæ˜¯é—­åŒºé—´\n1 2 mysql\u0026gt; select id,name,english from student -\u0026gt; where english between 80 and 90; ï¼ˆ7ï¼‰æŸ¥è¯¢æ•°å­¦æˆç»©ä¸º89,90,91çš„åŒå­¦ä¿¡æ¯Â or:Â 1 2 mysql\u0026gt; select id,name,math from student -\u0026gt; where math=89 or math=90 or math=91; in:Â 1 2 mysql\u0026gt; select id,name,math from student -\u0026gt; where math in(89,90,91); 5ã€order byæ’åºè¯­å¥ **ascå‡åº(é»˜è®¤)ï¼Œdescé™åºÂ **\norder by å­å¥åº”è¯¥ä½äºselectè¯­å¥çš„ç»“å°¾Â egï¼šå¯¹æ•°å­¦æˆç»©è¿›è¡Œæ’åºÂ é»˜è®¤å‡åºï¼šÂ 1 2 mysql\u0026gt; select id,name,math from student -\u0026gt; order by math; é™åºï¼šÂ 1 2 mysql\u0026gt; select id,name,math from student -\u0026gt; order by math desc; å¯¹æ€»åˆ†è¿›è¡Œä»é«˜åˆ°ä½è¾“å‡ºÂ 1 2 mysql\u0026gt; select (chinese+math+english) as æ€»æˆç»© from student -\u0026gt; order by æ€»æˆç»© desc; 6ã€å¸¸ç”¨å‡½æ•° ï¼ˆ1)count(ï¼‰Â count(*)ç»Ÿè®¡nullå€¼ count(åˆ—å)æ’é™¤nullå€¼Â eg :ç»Ÿè®¡å½“å‰studentè¡¨ä¸­ä¸€å…±æœ‰å¤šå°‘å­¦ç”ŸÂ 1 mysql\u0026gt; select count(*) as äººæ•° from student; (2)sum()Â egï¼šç»Ÿè®¡ä¸€ä¸ªç­æ•°å­¦æ€»æˆç»©Â 1 mysql\u0026gt; select sum(math) as æ•°å­¦æ€»æˆç»© from student; ï¼ˆ3ï¼‰å¹³å‡å€¼ï¼šavgï¼ˆï¼‰Â æ±‚æ•°å­¦çš„å¹³å‡å€¼\n1 mysql\u0026gt; select sum(math)/count(*) as æ•°å­¦å¹³å‡å€¼ from student; 1 mysql\u0026gt; select avg(math) as æ•°å­¦å¹³å‡å€¼ from student; 7ã€group by å­å¥çš„ä½¿ç”¨\nå‡è®¾æœ‰ä¸€ä¸ªèŒå·¥ä¿¡æ¯è¡¨ï¼ŒÂ EMP:è¡¨å ï¼›éƒ¨é—¨ï¼šdeptonï¼›salï¼šå·¥èµ„ï¼›jobï¼šå·¥ä½œÂ æˆ‘ä»¬è®¾æƒ³ï¼šÂ ï¼ˆ1ï¼‰æ˜¾ç¤ºæ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„å’Œæœ€é«˜å·¥èµ„Â select deptno,avg(sal),max(sal) from EMP group by deptno;Â ï¼ˆ2ï¼‰æ˜¾ç¤ºæ¯ä¸ªéƒ¨é—¨çš„æ¯ç§å²—ä½çš„å¹³å‡å·¥èµ„å’Œæœ€ä½å·¥èµ„Â select avg(sal),min(sal),job, deptno from EMP group by deptno, job;Â è¡¥å……ï¼šé¦–å…ˆæŒ‰ç…§deptnoåˆ†ç»„ï¼Œç„¶åå„ç»„å†æŒ‰ç…§jobè¿›è¡Œåˆ†ç»„ã€‚Â ï¼ˆ3ï¼‰æ˜¾ç¤ºå¹³å‡å·¥èµ„ä½äº2000çš„éƒ¨é—¨å’Œå®ƒçš„å¹³å‡å·¥èµ„Â è§£é¢˜æ€è·¯ï¼šÂ 1. ç»Ÿè®¡å„ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„Â select avg(sal) from EMP group by deptnoÂ 2. havingå¾€å¾€å’Œgroup byé…åˆä½¿ç”¨ï¼Œå¯¹group byç»“æœè¿›è¡Œè¿‡æ»¤Â select avg(sal) as myavg from EMP group by deptno having myavg\u0026lt;2000;\n","date":"2019-04-16T23:50:12Z","image":"https://www.ownit.top/title_pic/43.jpg","permalink":"https://www.ownit.top/p/201904162350/","title":"MySQLçš„selectè¯¦ç»†ä»‹ç»"},{"content":" SQLè¯­å¥ **Â DLLÂ æ•°æ®å®šä¹‰è¯­è¨€** **Â createï¼Œdrop**\n**Â DML æ•°æ®æ“çºµè¯­è¨€** **Â insertï¼Œdeleteï¼Œselectï¼Œupdate**\n**Â DCLÂ æ•°æ®æ§åˆ¶è¯­è¨€** **Â grantï¼Œrevoke**\nä½¿ç”¨ALTER TABLEä¿®æ”¹è¡¨ç»“æ„\nï¼ˆ1ï¼‰ä¿®æ”¹è¡¨å ALTER TABLE \u0026lt;è¡¨å\u0026gt; RENAME \u0026lt;æ–°è¡¨å\u0026gt;\n1 2 mysql\u0026gt; alter table game_account rename account; Query OK, 0 rows affected (0.05 sec) ï¼ˆ2ï¼‰ä¿®æ”¹è¡¨çš„æœç´¢å¼•æ“ 1 2 3 mysql\u0026gt; alter table account engine=MyISAM; Query OK, 0 rows affected (0.05 sec) Records: 0 Duplicates: 0 Warnings: 0 æŸ¥çœ‹è¡¨çš„ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 mysql\u0026gt; show create table account\\G; *************************** 1. row *************************** Table: account Create Table: CREATE TABLE `account` ( `game_name` char(15) NOT NULL, `game_password` char(25) NOT NULL ) ENGINE=MyISAM DEFAULT CHARSET=latin1 1 row in set (0.00 sec) ERROR:Â No query specified ï¼ˆ3ï¼‰æ·»åŠ å­—æ®µ ALTER TABLE \u0026lt;è¡¨å\u0026gt; ADD \u0026lt;å­—æ®µåç§°\u0026gt; \u0026lt;å­—æ®µå®šä¹‰\u0026gt;\nåé¢æ·»åŠ ï¼š 1 mysql\u0026gt; alter table account add game_sex enum(\u0026#34;M\u0026#34;,\u0026#34;F\u0026#34;) not null; å‰é¢æ·»åŠ ï¼š\n1 2 3 mysql\u0026gt; alter table account add game_address varchar(20) not null default \u0026#34;huabei\u0026#34; first; Query OK, 0 rows affected (0.00 sec) Records: 0 Duplicates: 0 Warnings: 0 ä¸­é—´æ·»åŠ ï¼š 1 2 3 mysql\u0026gt; alter table account add game_money int after game_name; Query OK, 0 rows affected (0.00 sec) Records: 0 Duplicates: 0 Warnings: 0 ï¼ˆ4ï¼‰åˆ é™¤å­—æ®µ\nALTER TABLE \u0026lt;è¡¨å\u0026gt; drop \u0026lt;å­—æ®µåç§°\u0026gt;\n1 2 3 mysql\u0026gt; alter table account drop game_wei; Query OK, 0 rows affected (0.00 sec) Records: 0 Duplicates: 0 Warnings: 0 ï¼ˆ5ï¼‰ä¿®æ”¹å­—æ®µåç§°åŠå­—æ®µå®šä¹‰ ALTER TABLE \u0026lt;è¡¨å\u0026gt; CHANGE \u0026lt;æ—§å­—æ®µ\u0026gt; \u0026lt;æ–°å­—æ®µåç§°\u0026gt; \u0026lt;å­—æ®µå®šä¹‰\u0026gt;\n1 2 3 mysql\u0026gt; alter table account change game_zhang wei char(25) not null; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0 1 2 3 mysql\u0026gt; alter table account change wei wei varchar(60) ; Query OK, 0 rows affected (0.00 sec) Records: 0 Duplicates: 0 Warnings: 0 ï¼ˆ6ï¼‰ä¿®æ”¹å­—æ®µå®šä¹‰\nALTER TABLE \u0026lt;è¡¨å\u0026gt; MODIFY \u0026lt;å­—æ®µåç§°\u0026gt; \u0026lt;å­—æ®µå®šä¹‰\u0026gt;\n1 2 3 mysql\u0026gt; alter table account modify wei int ; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0 1 2 3 mysql\u0026gt; alter table account modify wei int not null ; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0 ","date":"2019-04-16T18:55:22Z","image":"https://www.ownit.top/title_pic/40.jpg","permalink":"https://www.ownit.top/p/201904161855/","title":"MySQLä½¿ç”¨alterä¿®æ”¹è¡¨çš„ç»“æ„"},{"content":"åŸºæœ¬ç®¡ç†æŒ‡ä»¤ mysqlç™»é™† ç¬¬ä¸€ç§\n1 [root@wei ~]# mysql -u root -p ç¬¬äºŒç§ï¼ˆå¸¦å‚è¾“å…¥ï¼‰\n1 [root@wei ~]# mysql -uroot -proot æ³¨æ„ï¼šæ¯ä¸ªå‘½ä»¤åé¢å¿…é¡»åŠ ;\nmysqlé‡Œé¢æ¸…å± **Â \\! clear** æ•°æ®åº“åŸºæœ¬ç®¡ç†æ“ä½œ\nï¼ˆ1ï¼‰æŸ¥çœ‹æ•°æ®åº“ 1 2 3 4 5 6 7 8 9 10 11 12 show databases; mysql\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | farm | | mysql | | performance_schema | +--------------------+ 4 rows in set (0.00 sec) ï¼ˆ2ï¼‰åˆ›å»ºæ•°æ®åº“\nCREATE DATABASE \u0026lt;db_name\u0026gt; [CHARACTER=\u0026lt;å­—ç¬¦é›†\u0026gt; COLLATE=\u0026lt;æ’åºè§„åˆ™\u0026gt;]\n1 2 mysql\u0026gt; create database game; Query OK, 1 row affected (0.01 sec) (3)æŸ¥çœ‹æ•°æ®åº“çš„åˆ›å»ºä¿¡æ¯\n1 2 3 4 5 6 7 mysql\u0026gt; show create database game; +----------+-----------------------------------------------------------------+ | Database | Create Database | +----------+-----------------------------------------------------------------+ | game | CREATE DATABASE `game` /*!40100 DEFAULT CHARACTER SET latin1 */ | +----------+-----------------------------------------------------------------+ 1 row in set (0.00 sec) ï¼ˆ4ï¼‰æŸ¥çœ‹mysqlæ•°æ®åº“æ”¯æŒçš„å­—ç¬¦é›†\n1 mysql\u0026gt; show character set; ï¼ˆ5ï¼‰æŸ¥çœ‹mysqlæ•°æ®åº“æ”¯æŒå­—ç¬¦é›†çš„æ’åºè§„åˆ™ 1 mysql\u0026gt; show collation; ï¼ˆ6ï¼‰åˆ é™¤æ•°æ®åº“\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 mysql\u0026gt; drop database lol; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | farm | | game | | mysql | | performance_schema | +--------------------+ 5 rows in set (0.00 sec) ï¼ˆ7ï¼‰åˆ‡æ¢æ•°æ®åº“ 1 2 mysql\u0026gt; use game Database changed ç¤ºä¾‹ï¼šåˆ›å»ºä¸€ä¸ªlolçš„æ•°æ®åº“ï¼Œå­—ç¬¦é›†ä¸ºutf8,æ’åºä¸ºutf8_general_ci 1 2 3 4 5 6 7 8 9 10 11 12 13 mysql\u0026gt; create database lolÂ -\u0026gt; character set=utf8 -\u0026gt; collate=utf8_general_ci; Query OK, 1 row affected (0.00 sec) mysql\u0026gt; show create database lol; +----------+--------------------------------------------------------------+ | Database | Create Database | +----------+--------------------------------------------------------------+ | lol | CREATE DATABASE `lol` /*!40100 DEFAULT CHARACTER SET utf8 */ | +----------+--------------------------------------------------------------+ 1 row in set (0.00 sec) rpmé»˜è®¤æ•°æ®ç›®å½• **Â /var/lib/mysql -\u0026mdash;-\u0026gt;æ•°æ®ç›®å½•ï¼šrpmé»˜è®¤æ•°æ®ç›®å½•**\n**æ•°æ®åº“ä¸€èˆ¬å­˜åœ¨æ•°æ®ç›®å½•ä¸‹/var/lib/mysqlÂ **\n1 2 3 [root@wei ~]# ls /var/lib/mysql auto.cnf game ib_logfile0 lol mysql.sock farm ibdata1 ib_logfile1 mysql performance_schema æ•°æ®è¡¨çš„åŸºæœ¬æ“ä½œç®¡ç†ï¼š ï¼ˆ1ï¼‰æŸ¥çœ‹è¡¨ 1 2 3 4 5 6 7 mysql\u0026gt; show tables; +----------------+ | Tables_in_game | +----------------+ | game_account | +----------------+ 1 row in set (0.00 sec) ï¼ˆ2ï¼‰åˆ›å»ºè¡¨ CREATE TABLE \u0026lt;è¡¨å\u0026gt;(å­—æ®µåç§° æ•°æ®ç±»å‹ [å±æ€§],å­—æ®µåç§° æ•°æ®ç±»å‹ [å±æ€§]\u0026hellip;)\næ•°æ®ç±»å‹ï¼š\næ•°å€¼å‹\nå­—ç¬¦å‹\næ—¥æœŸ/æ—¶é—´å‹\n1 2 3 4 mysql\u0026gt; create table game_account( -\u0026gt; game_name char(15) not null, -\u0026gt; game_passwd char(15) not null, -\u0026gt; ); **Â ï¼ˆ3ï¼‰æŸ¥çœ‹åˆ›å»ºè¡¨çš„ä¿¡æ¯**\n1 2 3 4 5 6 7 8 9 10 mysql\u0026gt; show create table game_account\\G; *************************** 1. row *************************** Table: game_account Create Table: CREATE TABLE `game_account` ( `game_name` char(15) NOT NULL, `game_password` char(25) NOT NULL ) ENGINE=InnoDB DEFAULT CHARSET=latin1 1 row in set (0.00 sec) ERROR:Â No query specified ï¼ˆ4ï¼‰åˆ é™¤è¡¨ 1 2 mysql\u0026gt; drop table gam; Query OK, 0 rows affected (0.01 sec) ï¼ˆ5ï¼‰æŸ¥çœ‹è¡¨ç»“æ„ 1 2 3 4 5 6 7 8 mysql\u0026gt; desc game_account; +---------------+----------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +---------------+----------+------+-----+---------+-------+ | game_name | char(15) | NO | | NULL | | | game_password | char(25) | NO | | NULL | | +---------------+----------+------+-----+---------+-------+ 2 rows in set (0.00 sec) ","date":"2019-04-16T12:43:20Z","image":"https://www.ownit.top/title_pic/58.jpg","permalink":"https://www.ownit.top/p/201904161243/","title":"MySQLåŸºæœ¬åº“è¡¨ç®¡ç†"},{"content":"Linux ä¸Šå®‰è£… MySQL Linuxå¹³å°ä¸Šæ¨èä½¿ç”¨RPMåŒ…æ¥å®‰è£…Mysql,MySQL ABæä¾›äº†ä»¥ä¸‹RPMåŒ…çš„ä¸‹è½½åœ°å€ï¼š\nMySQLÂ - MySQLæœåŠ¡å™¨ã€‚ä½ éœ€è¦è¯¥é€‰é¡¹ï¼Œé™¤éä½ åªæƒ³è¿æ¥è¿è¡Œåœ¨å¦ä¸€å°æœºå™¨ä¸Šçš„MySQLæœåŠ¡å™¨ã€‚ MySQL-clientÂ - MySQL å®¢æˆ·ç«¯ç¨‹åºï¼Œç”¨äºè¿æ¥å¹¶æ“ä½œMysqlæœåŠ¡å™¨ã€‚ MySQL-develÂ - åº“å’ŒåŒ…å«æ–‡ä»¶ï¼Œå¦‚æœä½ æƒ³è¦ç¼–è¯‘å…¶å®ƒMySQLå®¢æˆ·ç«¯ï¼Œä¾‹å¦‚Perlæ¨¡å—ï¼Œåˆ™éœ€è¦å®‰è£…è¯¥RPMåŒ…ã€‚ MySQL-sharedÂ - è¯¥è½¯ä»¶åŒ…åŒ…å«æŸäº›è¯­è¨€å’Œåº”ç”¨ç¨‹åºéœ€è¦åŠ¨æ€è£…è½½çš„å…±äº«åº“(libmysqlclient.so*)ï¼Œä½¿ç”¨MySQLã€‚ MySQL-benchÂ - MySQLæ•°æ®åº“æœåŠ¡å™¨çš„åŸºå‡†å’Œæ€§èƒ½æµ‹è¯•å·¥å…·ã€‚ å®‰è£…å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æµ‹ç³»ç»Ÿæ˜¯å¦è‡ªå¸¦å®‰è£… MySQL:\n1 rpm -qa | grep mysql å¦‚æœä½ ç³»ç»Ÿæœ‰å®‰è£…ï¼Œé‚£å¯ä»¥é€‰æ‹©è¿›è¡Œå¸è½½:\n1 2 rpm -e mysqlã€€// æ™®é€šåˆ é™¤æ¨¡å¼ rpm -e --nodeps mysqlã€€// å¼ºåŠ›åˆ é™¤æ¨¡å¼ï¼Œå¦‚æœä½¿ç”¨ä¸Šé¢å‘½ä»¤åˆ é™¤æ—¶ï¼Œæç¤ºæœ‰ä¾èµ–çš„å…¶å®ƒæ–‡ä»¶ï¼Œåˆ™ç”¨è¯¥å‘½ä»¤å¯ä»¥å¯¹å…¶è¿›è¡Œå¼ºåŠ›åˆ é™¤ æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨ Centos7 ç³»ç»Ÿä¸‹ä½¿ç”¨ yum å‘½ä»¤å®‰è£… MySQLï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ CentOS 7 ç‰ˆæœ¬ä¸­ MySQLæ•°æ®åº“å·²ä»é»˜è®¤çš„ç¨‹åºåˆ—è¡¨ä¸­ç§»é™¤ï¼Œæ‰€ä»¥åœ¨å®‰è£…å‰æˆ‘ä»¬éœ€è¦å…ˆå»å®˜ç½‘ä¸‹è½½ Yum èµ„æºåŒ…ï¼Œä¸‹è½½åœ°å€ä¸ºï¼šhttps://dev.mysql.com/downloads/repo/yum/\næ³¨æ„ï¼šæ²¡å®‰è£…wgetçš„æœ‹å‹ï¼Œéœ€è¦å…ˆå®‰è£…wget\n1 [root@wei ~]# yum install wget ä¸‹è½½å®‰è£…åŒ… 1 wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm å®‰è£…rpmåŒ… 1 rpm -ivh mysql-community-release-el7-5.noarch.rpm å®‰è£…mysql-serveræœåŠ¡ 1 yum install mysql-server æƒé™è®¾ç½®ï¼š 1 chown mysql:mysql -R /var/lib/mysql åˆå§‹åŒ– MySQLï¼š 1 mysqld --initialize å¯åŠ¨ MySQLï¼š 1 systemctl start mysqld æŸ¥çœ‹ MySQL è¿è¡ŒçŠ¶æ€ï¼š 1 systemctl status mysqld è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ 1 systemctl enable mysqld éªŒè¯ MySQL å®‰è£… 1 2 [root@wei ~]# mysqladmin --version mysqladmin Ver 8.42 Distrib 5.6.42, for Linux on x86_64 ##æ˜¾ç¤ºè¿™ä¸ªä¿¡æ¯è¡¨ç¤ºæˆåŠŸ æ³¨æ„ï¼š è®¾ç½®å¯†ç Â å½“ç¬¬ä¸€æ¬¡å¯åŠ¨MySQLæœåŠ¡å™¨æ—¶ï¼Œä¸ºMySQLæ ¹ç”¨æˆ·ç”Ÿæˆä¸€ä¸ªä¸´æ—¶å¯†ç ã€‚ æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ‰¾åˆ°å¯†ç ï¼š\n1 [root@wei ~]# grep \u0026#39;temporary password\u0026#39; /var/log/mysqld.log **localhostï¼šåè¾¹çš„å°±æ˜¯ä¸´æ—¶å¯†ç ï¼Œå…ˆå¤åˆ¶ä¸‹æ¥Â **\næ³¨æ„ï¼šå¦‚æœæ²¡æœ‰æŸ¥åˆ°ï¼Œå°±æ˜¯ä¸éœ€è¦ï¼Œç™»é™†æ—¶ï¼Œå›è½¦å³å¯ç™»é™†\nè¿›å…¥mysqlï¼Œåœ¨Enter passwordï¼šå¤åˆ¶ç²˜è´´å…ˆå‰çš„å¯†ç å°±è¿›å»äº†\n1 mysql -u root -p ä¿®æ”¹å¯†ç æ–¹å¼ 1 2 3 4 [root@wei ~]# mysqladmin -u root -p password Enter password: #æ—§å¯†ç  New password: #æ–°å¯†ç  Confirm new password: #å†è¾“å…¥ä¸€æ¬¡ **æ³¨æ„ï¼š**åœ¨è¾“å…¥å¯†ç æ—¶ï¼Œå¯†ç æ˜¯ä¸ä¼šæ˜¾ç¤ºäº†ï¼Œä½ æ­£ç¡®è¾“å…¥å³å¯ã€‚","date":"2019-04-16T09:47:25Z","image":"https://www.ownit.top/title_pic/40.jpg","permalink":"https://www.ownit.top/p/201904160947/","title":"MySQLçš„rpmå®‰è£…æ•™ç¨‹"},{"content":"MySQLæ•°æ®åº“ ä»¥æ–‡æœ¬çš„å½¢å¼å­˜å‚¨æ•°æ®çš„åŠ£åŠ¿:\n**Â 1ã€æ•°æ®å†—ä½™(ä¸€ä¸ªæ–‡ä»¶ä¸­å‡ºç°næ¬¡ç›¸åŒçš„æ•°æ®)å’Œæ•°æ®ä¸ä¸€è‡´æ€§** **Â 2ã€æ•°æ®è®¿é—®å›°éš¾** **Â 3ã€æ•°æ®å­¤ç«‹** **Â 4ã€æ•°æ®å®Œæ•´æ€§é—®é¢˜** **Â 5ã€åŸå­æ€§(å¤šä¸ªç›¸å…³è”çš„æ“ä½œå¿…é¡»è¦åŒæ—¶å®Œæˆ** **Â 6ã€å¹¶å‘è®¿é—®å¼‚å¸¸** **Â 7ã€å®‰å…¨æ€§é—®é¢˜** DBMS\u0026mdash;-DataBase Management Systemæ•°æ®åº“ç®¡ç†ç³»ç»Ÿ\n**Â ä»¥å…³ç³»(è¡¨)çš„å½¢å¼å­˜å‚¨æ•°æ®**\n**Â è®°å½•Record è¡¨ä¸­çš„æ¯ä¸€-è¡Œæ•°æ®;\nå­—æ®µ(å±æ€§) column è¡¨ä¸­çš„æ¯ä¸€åˆ—åå­—**\n**Â æ•°æ®åº“\nè¡¨\nè½¯ä»¶:**\n**Â MySQL, oracle, MariaDB (https:/ /www.percona.com/)ï¼ŒDB2ï¼Œ SQL Server\nMongeDB**\nçº¦æŸ Constraint\n**Â åŸŸçº¦æŸ:æ•°æ®ç±»å‹çº¦æŸ\nä¿è¯æŸå­—æ®µçš„æ•°æ®ç±»å‹ä¸€è‡´**\n**Â å¤–é”®çº¦æŸ:å¼•ç”¨å®Œæ•´æ€§çº¦æŸ(InnoDB)\nä¸€ä¸ªè¡¨ä¸­æŸå­—æ®µçš„æ•°æ®å¿…é¡»åœ¨ä¸ä¹‹ç›¸å…³çš„å…¶ä»–è¡¨çš„ç›¸å…³è”å­—æ®µä¸­å­˜åœ¨**\n**Â ä¸»é”®çº¦æŸ\næŸå­—æ®µèƒ½æƒŸä¸€æ ‡è¯†æ­¤å­—æ®µæ‰€å±çš„å®ä½“ï¼Œå¹¶ä¸”ä¸å…è®¸ä¸ºç©ºï¼Œ\nä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®**\n**Â æƒŸä¸€é”®çº¦æŸ\næŸå­—æ®µèƒ½æƒŸä¸€æ ‡è¯†æ­¤å­—æ®µæ‰€å±çš„å®ä½“ï¼Œå¯ä»¥ä¸ºç©ºÂ ä¸€ä¸ªè¡¨å¯ä»¥æœ‰å¤šä¸ªæƒŸä¸€é”®**\n**Â æ£€æŸ¥æ€§çº¦æŸ\nä¿è¯æŸå­—æ®µä¸­ä¸èƒ½å‡ºç°è¿åå¸¸ç†çš„æ•°æ®ï¼Œä¾‹å¦‚å¹´é¾„**\nMySQLåŸºç¡€åº”ç”¨ ä¸€ã€æ•°æ®åº“ç‰¹ç‚¹:ç»“æ„åŒ–,æ— æœ‰å®³,æ— é‡å¤;\näºŒã€æ•°æ®åº“ä¼˜ç‚¹:æŒ‰ä¸€å®šçš„æ•°æ®æ¨¡å‹ç»„ç»‡,æè¿°å’Œå‚¨å­˜;å¯ä¸ºå„ç§ç”¨æˆ·å…±äº«,å†—ä½™åº¦å°,èŠ‚çœå‚¨å­˜ç©ºé—´æ˜“æ‰©å±•,ç¼–å†™æœ‰å…³æ•°æ®åº”ç”¨ç¨‹åºã€‚\nä¸‰ã€å¸¸ç”¨Dosæ“ä½œæŒ‡ä»¤:\nå®‰è£…æ•°æ®åº“:mysqld -install, å¼€å¯/å…³é—­æ•°æ®åº“:start mysql/net stop, ç›‘å¬ç«¯å£ä¿¡æ¯:netstat -a, ç™»é™†æ•°æ®åº“:mysql -uroot -p, æ˜¾ç¤ºé»˜è®¤æ•°æ®åº“:use dbname, æ˜¾ç¤ºæ‰€æœ‰æ•°æ®åº“:show databases, æ˜¾ç¤ºé»˜è®¤æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨:show tables, æ”¾å¼ƒæ­£åœ¨è¾“å…¥çš„æŒ‡ä»¤:\\c, æ˜¾ç¤ºå‘½ä»¤æ¸…å•:\\h, é€€å‡ºmysqlç¨‹åº:\\q, æŸ¥çœ‹mysqlæœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯:\\s, mysqlç‰ˆæœ¬ä¿¡æ¯:SELECTÂ version(), æ‰“å¼€è¡¨ç»“æ„:desc tableã€‚ å››ã€æ•°æ®åº“è¯­æ³•ç»„æˆ:\n1.DDM(Data Definition Languageæ•°æ®åº“å®šä¹‰è¯­è¨€):create table,drop table,alterÂ tableç­‰\n2.DCL(Data Control Languageæ•°æ®æ§åˆ¶è¯­è¨€):grant,revokeç­‰;\n3.DML(Data Manipulation Languageæ•°æ®æ“ä½œè¯­è¨€)æŸ¥è¯¢SELECTã€æ’å…¥insertã€updateä¿®æ”¹ã€åˆ é™¤delete;\näº”ã€MYSQLä¸‰ç§å¸¸ç”¨çš„æ•°æ®ç±»å‹:æ–‡æœ¬:char,varchar,text;æ•°å­—,æ—¥æœŸå’Œæ—¶é—´ç±»å‹;\nå…­ã€å¸¸ç”¨æ“ä½œ\næ˜¾ç¤ºè¡¨ç»“æ„:DESC è¡¨å; åˆ é™¤è¡¨æ“ä½œ:drop table è¡¨å é™¤æ•°æ®åº“æ“ä½œ:drop database æ•°æ®åº“å æ›´æ”¹è¡¨ç»“æ„æ“ä½œ:alter table è¡¨å action;(actionå¯ä»¥æ˜¯ä»¥ä¸‹æ“ä½œ) add åˆ—å å»ºè¡¨è¯­å¥[first/after]\u0026ndash;åœ¨è¡¨ä¸­æ·»åŠ åˆ—,åˆ¶å®šå…¶ä½ç½®; add primary key (åˆ—å)\u0026ndash; æ·»åŠ ä¸€ä¸ªä¸»é”®,å¦‚æœä¸»é”®å·²å­˜åœ¨,ä¼šæŠ¥é”™; add foreign key (åˆ—å) reference è¡¨å ï¼ˆåˆ—åï¼‰;\u0026ndash; ä¸ºè¡¨æ·»åŠ ä¸€ä¸ªå¤–é”®; alteråˆ—å set default é»˜è®¤å€¼;\u0026ndash; æ›´æ”¹æŒ‡å®šåˆ—çš„é»˜è®¤å€¼ drop åˆ—å \u0026ndash; åˆ é™¤ä¸€åˆ— drop primary key \u0026ndash; åˆ é™¤ä¸»é”® engine ç±»å‹å \u0026ndash; æ”¹å˜è¡¨çš„ç±»å‹ rename as æ–°è¡¨å \u0026ndash; æ”¹å˜è¡¨å change æ—§åˆ—å æ–°åˆ—å [first /after]\u0026ndash; æ›´æ”¹åˆ—çš„ç±»å‹å’Œåç§° modify å’Œchangeç›¸åŒ; ","date":"2019-04-15T23:27:50Z","image":"https://www.ownit.top/title_pic/61.jpg","permalink":"https://www.ownit.top/p/201904152327/","title":"MySQLåŸºç¡€ç†è®º"},{"content":"awkä¸­ä½¿ç”¨æ•°ç»„ ä¸€.æ•°ç»„æ ¼å¼\næ•°ç»„æ˜¯ä¸€ä¸ªåŒ…å«ä¸€ç³»åˆ—å…ƒç´ çš„è¡¨.\næ ¼å¼å¦‚ä¸‹ï¼š\n**Â abc[1]=â€xiaohongâ€**\n**Â abc[2]=â€xiaolanâ€**\nè§£é‡Šï¼š\nabcÂ ï¼šä¸ºæ•°ç»„åç§°\n[1]ã€[2]ï¼šä¸ºæ•°ç»„å…ƒç´ ä¸‹æ ‡ï¼Œå¯ä»¥ç†è§£ä¸ºæ•°ç»„çš„ç¬¬1ä¸ªå…ƒç´ ã€æ•°ç»„çš„ç¬¬2ä¸ªå…ƒç´ \nâ€xiaohongâ€ã€â€xiaolanâ€ï¼š å…ƒç´ å†…å®¹\næ•°ç»„\narrray[index-expression]\næ•°ç»„ä¸‹ä»1å¼€å§‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²ä½œä¸ºæ•°ç»„çš„ä¸‹æ ‡\nindex-expressionå¯ä»¥ä½¿ç”¨ä»»æ„çš„å­—ç¬¦ä¸²\néœ€æ³¨æ„çš„æ˜¯ï¼šå¦‚æœæŸæ•°ç»„å…ƒç´ äº‹å…ˆä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå¼•ç”¨å…¶æ—¶ï¼Œawkä¼šè‡ªåŠ¨åˆ›å»ºæ¬¡å…ƒç´ å¹¶åˆå§‹åŒ–ä¸º0ï¼Œè¦åˆ¤æ–­æŸæ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨æŸå…ƒç´ ï¼Œéœ€è¦\nä½¿ç”¨index in arraryçš„æ–¹å¼\nè¦éå†æ•°ç»„ä¸­æ¯ä¸€ä¸ªå…ƒç´ ï¼Œéœ€è¦ä½¿ç”¨ å¦‚ä¸‹çš„ç‰¹æ®Šç»“æ„ï¼š forï¼ˆå˜é‡ in æ•°ç»„åç§°ï¼‰{print æ•°ç»„åç§°[å°æ ‡]}\nå…¶ä¸­ï¼Œvaeæ˜¯æ•°ç»„çš„ä¸‹æ ‡\nç»Ÿè®¡æ¯ä¸ªshellçš„ä½¿ç”¨æ¬¡æ•° 1 2 3 4 5 6 [root@wei awk]# awk -F: \u0026#39;{shell[$7]++}END{for(i in shell){print i,shell[i]}}\u0026#39; /etc/passwd /bin/sync 1 /bin/bash 17 /sbin/nologin 20 /sbin/halt 1 /sbin/shutdown 1Â **Â ç»Ÿè®¡æ¯ä¸ªçŠ¶æ€ä¸‹çš„tcpè¿æ¥ä¸ªæ•°\n**\n1 2 3 [root@wei awk]# netstat -antp | awk \u0026#39;/^tcp/{state[$6]++}END{for(i in state){print i,state[i]}}\u0026#39; LISTEN 9 ESTABLISHED 2 ","date":"2019-04-15T23:18:25Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/201904152318/","title":"Linux shell awkæ•°ç»„ä½¿ç”¨"},{"content":"awké€»è¾‘æ§åˆ¶è¯­å¥ 1ï¼Œif\u0026hellip;else æ ¼å¼ï¼š\nifï¼ˆæ¡ä»¶ï¼‰{è¯­å¥ï¼›è¯­å¥} else {è¯­å¥1ï¼›è¯­å¥2}\nå¦‚æœstatementåªæœ‰ä¸€æ¡è¯­å¥ï¼Œ{}å¯ä»¥ä¸å†™\nä»¥å†’å·ä¸ºåˆ†éš”ç¬¦ï¼Œåˆ¤æ–­ç¬¬ä¸€ä¸ªå­—æ®µï¼Œå¦‚æœä¸ºrootï¼Œåˆ™æ˜¾ç¤ºç”¨æˆ·ä¸ºadministratorï¼Œå¦åˆ™æ˜¾ç¤ºç”¨æˆ·é—®common user 1 2 3 [root@wei csdn]# awk -F: \u0026#39;{if($3==0){print $1,\u0026#34;is administrator.\u0026#34;}else {print $1,\u0026#34;is common user\u0026#34;}}\u0026#39; /etc/passwd root is administrator. bin is common user ç¼–å†™uidå¤§äº500çš„ç”¨æˆ·ä¸ªæ•° 1 2 [root@wei csdn]# awk -F: -v count=0 \u0026#39;{if($3\u0026gt;500) {count++}}END{print \u0026#34;uidå¤§äº500çš„ç”¨æˆ·æ•°é‡ï¼š\u0026#34;,count}\u0026#39; /etc/passwd uidå¤§äº500çš„ç”¨æˆ·æ•°é‡ï¼š 19 åˆ¤æ–­ç³»ç»Ÿçš„bashç”¨æˆ·å’Œnologinç”¨æˆ· 1 2 [root@wei csdn]# awk -v num1=0 -v num2=0 -F: \u0026#39;/bash$/ || /nologin$/{if($7==\u0026#34;/bin/bash\u0026#34;){num1++} else {num2++}}END{print \u0026#34;bashç”¨æˆ·æ•°é‡ï¼š\u0026#34;,num1,\u0026#34;nologinç”¨æˆ·æ•°é‡ï¼š\u0026#34;,num2}\u0026#39; /etc/passwd bashç”¨æˆ·æ•°é‡ï¼š 17 nologinç”¨æˆ·æ•°é‡ï¼š 20 2ï¼Œwhile\næ ¼å¼ï¼š\nwhile(æ¡ä»¶) {è¯­å¥1;è¯­å¥2;\u0026hellip;..}\npasswdå‰3è¡Œè¿›è¡Œè¾“å‡ºï¼Œè¾“å‡º3æ¬¡ 1 2 3 4 5 6 7 8 9 10 [root@wei csdn]# head -n 3 /etc/passwd | awk \u0026#39;{i=1;while(i\u0026lt;=3){print $0; i++}}\u0026#39; root:x:0:0:root:/root:/bin/bash root:x:0:0:root:/root:/bin/bash root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin bin:x:1:1:bin:/bin:/sbin/nologin bin:x:1:1:bin:/bin:/sbin/nologin daemon:x:2:2:daemon:/sbin:/sbin/nologin daemon:x:2:2:daemon:/sbin:/sbin/nologin daemon:x:2:2:daemon:/sbin:/sbin/nologin ä»¥å†’å·ä¸ºåˆ†å‰²ç¬¦ï¼Œåˆ¤æ–­æ¯ä¸€è¡Œçš„æ¯ä¸€ä¸ªå­—æ®µçš„é•¿åº¦å¦‚æœå¤§äº4ï¼Œåˆ™æ˜¾ä¹‹ 1 2 3 4 5 6 7 8 [root@wei awk]# head -n 3 /etc/passwd | awk -F: \u0026#39;{i=1;while(i\u0026lt;=7){if(length($i)\u0026gt;4){print $i};i++}}\u0026#39; /root /bin/bash /sbin/nologin daemon daemon /sbin /sbin/nologin ç»Ÿè®¡test.txtçš„æ–‡ä»¶é•¿åº¦å¤§å°ä¸º5çš„å•è¯ 1 [root@wei awk]# awk \u0026#39;{i=1;while(i\u0026lt;NF) {if(length($i)\u0026gt;5){print $i};i++}}\u0026#39; print.txtÂ 3ï¼Œfor éå†æ•°ç»„\næ ¼å¼ï¼š\nforï¼ˆå˜é‡å®šä¹‰ï¼›å¾ªç¯ç»ˆæ­¢çš„æ¡ä»¶ï¼›æ”¹å˜å¾ªç¯æ¡ä»¶çš„è¯­å¥ï¼‰ {è¯­å¥ï¼›è¯­å¥\u0026hellip;}\n**Â for(i=1;i\u0026lt;=4;i++) {\u0026hellip;\u0026hellip;}**\nä»¥å†’å·ä¸ºåˆ†éš”ç¬¦ï¼Œæ˜¾ç¤º/etc/passwdæ¯ä¸€è¡Œçš„å‰3ä¸ªå­—æ®µ 1 2 3 4 5 [root@wei awk]# awk -F: \u0026#39;{for (i=1;i\u0026lt;=3;i++) { print $i} }\u0026#39; /etc/passwd root x 0 bin 4ï¼Œ break contiuneÂ ç”¨äºä¸­æ–­å¾ªç¯\n","date":"2019-04-15T23:14:25Z","image":"https://www.ownit.top/title_pic/19.jpg","permalink":"https://www.ownit.top/p/201904152314/","title":"Linux shell awké€»è¾‘æ§åˆ¶è¯­å¥"},{"content":"awkçš„PATTERNè¡¨ç¤ºæ–¹æ³•ï¼š 1ï¼Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œæ ¼å¼ä¸º/regex/ ä»¥å†’å·ä¸ºåˆ†éš”ç¬¦ï¼Œæ˜¾ç¤º/etc/passwdä»¥rå¼€å¤´çš„è¡Œçš„ç¬¬ä¸€æ®µ\n1 2 [root@wei awk]# awk -F: \u0026#39;/^r/{print $1}\u0026#39; /etc/passwd root ä»¥å†’å·ä¸ºåˆ†éš”ç¬¦ï¼Œæ˜¾ç¤º/etc/passwdä»¥nologinç»“å°¾çš„è¡Œçš„ç¬¬ä¸€æ®µ\n1 2 3 4 5 6 [root@wei awk]# awk -F: \u0026#39;/nologin$/{print $1}\u0026#39; /etc/passwd bin daemon adm lp mail ä»¥å†’å·ä¸ºåˆ†éš”ç¬¦ï¼Œæ˜¾ç¤º/etc/passwdä»¥ræˆ–è€…hå¼€å¤´çš„è¡Œçš„ç¬¬ä¸€æ®µ\n1 2 3 4 [root@wei awk]# awk -F: \u0026#39;/^[rh]/{print $1}\u0026#39; /etc/passwd root halt hei å†™å‡º/etc/çš„è½¯é“¾æ¥çš„åå­—\n1 2 3 [root@wei awk]# ls -l /etc/ |awk \u0026#39;/^l/{print $NF}\u0026#39; /usr/share/icons/hicolor/16x16/apps/fedora-logo-icon.png ../boot/grub2/grub.cfg 2ï¼Œè¡¨è¾¾å¼ï¼Œæœ‰ä¸‹é¢æ“ä½œç¬¦ç»„æˆçš„è¡¨è¾¾å¼ awkçš„æ“ä½œç¬¦\n1 ï¼Œç®—æœ¯æ“ä½œç¬¦ -x è´Ÿå€¼\n+x è½¬æ¢ä¸ºæ•°å€¼ï¼Œæ­£å€¼\nx^y x**y æ¬¡æ–¹\nx/y\nx*y\nx-y\nx+y\nx%y\n2 ,å­—ç¬¦ä¸²æ“ä½œç¬¦ +ï¼šå®ç°å­—ç¬¦ä¸²è¿æ¥ \u0026ldquo;ab\u0026rdquo;+\u0026ldquo;cd\u0026rdquo; abcd\n3 ,èµ‹å€¼æ“ä½œç¬¦ =\n+=\n-+\n*=\nã€=\n%=\n^=\n**=\n4 ,æ¯”è¾ƒæ“ä½œç¬¦ x\u0026lt;y\nx\u0026lt;=y\nx\u0026gt;y\nx\u0026gt;=y\nx==y\nx!=y\nx~y:xä¸ºå­—ç¬¦ä¸²ï¼Œyä¸ºæ¨¡å¼ï¼Œå¦‚æœxå¯ä»¥è¢«æ¨¡å¼åŒ¹é…åˆ™ä¸ºçœŸï¼Œå¦åˆ™ä¸ºå‡\nx!~y\n5 ,é€»è¾‘å…³ç³»ç¬¦ \u0026amp;\u0026amp; ä¸\n|| æˆ–è€…\næ˜¾ç¤ºuidå¤§äºç­‰äº500çš„ç”¨æˆ·çš„åŠuid\n1 2 3 4 5 [root@wei awk]# awk -F: \u0026#39;$3\u0026gt;=500{print $1,$3}\u0026#39; /etc/passwd polkitd 999 saslauth 998 hei 1200 wei 1001 3 ï¼ŒæŒ‡å®šèŒƒå›´ï¼Œæ ¼å¼ä¸ºpattern,pattern2\nä»¥å†’å·ä¸ºåˆ†éš”ç¬¦ï¼Œæ˜¾ç¤ºuid=0åˆ°æœ€åä¸€ä¸ªå­—æ®µä¸ºnologinç»“å°¾ä¸­é—´æ‰€æœ‰çš„ç”¨æˆ·åç§°ï¼ŒuidåŠshell\n1 2 3 [root@wei awk]# awk -F: \u0026#39;$3==0,$7~\u0026#34;nologin$\u0026#34;{print $1,$3,$7}\u0026#39; /etc/passwd root 0 /bin/bash bin 1 /sbin/nologin 4 ï¼ŒBEGIN/END, ç‰¹æ®Šæ¨¡å¼\nBEGINè¡¨ç¤ºawkè¿›è¡Œå¤„ç†å‰æ‰§è¡Œä¸€æ¬¡æ“ä½œ\nENDè¡¨ç¤ºawkå¤„ç†å®Œæœ€åä¸€è¡Œç»“æŸå‰æ‰§è¡Œä¸€æ¬¡æ“ä½œ\nä½¿ç”¨BEGINæ‰“å°è¡¨å¤´\n1 2 3 4 [root@wei awk]# awk -F: \u0026#39;BEGIN{printf \u0026#34;%-10s%-10s%-20s\\n\u0026#34;,\u0026#34;username\u0026#34;,\u0026#34;uid\u0026#34;,\u0026#34;shell\u0026#34;}$3==0,$7 ~ \u0026#34;nologin$\u0026#34;{printf \u0026#34;%-10s%-10s%-10s\\n\u0026#34;,$1,$3,$7}\u0026#39; /etc/passwd username uid shell root 0 /bin/bashÂ bin 1 /sbin/nologin ä½¿ç”¨ENDæ‰“å°è¡¨å°¾\n1 2 3 4 5 [root@wei awk]# awk -F: \u0026#39;BEGIN{printf \u0026#34;%-10s%-10s%-20s\\n\u0026#34;,\u0026#34;username\u0026#34;,\u0026#34;uid\u0026#34;,\u0026#34;shell\u0026#34;}$3==0,$7 ~ \u0026#34;nologin$\u0026#34;{printf \u0026#34;%-10s%-10s%-10s\\n\u0026#34;,$1,$3,$7}END{print \u0026#34;END OFFILE...\u0026#34;}\u0026#39; /etc/passwd username uid shell root 0 /bin/bashÂ bin 1 /sbin/nologin END OFFILE... ","date":"2019-04-14T22:59:14Z","image":"https://www.ownit.top/title_pic/49.jpg","permalink":"https://www.ownit.top/p/201904142259/","title":"Linux shell awkæ¨¡å¼ä½¿ç”¨"},{"content":"printf æ˜¯ awk çš„é‡è¦æ ¼å¼åŒ–è¾“å‡ºå‘½ä»¤ printfæ ¼å¼åŒ–è¾“å‡ºå†…å®¹ **æ ¼å¼ï¼š printf formatï¼Œitem1ï¼Œitem2\u0026hellip;\nè¦ç‚¹ï¼š**\n1ï¼Œprintfè¾“å‡ºæ—¶è¦æŒ‡å®šæ ¼å¼format\n2ï¼Œformayç”¨äºæŒ‡å®šåé¢çš„æ¯ä¸ªitemè¾“å‡ºçš„æ ¼å¼\n3ï¼Œprintfè¯­å¥ä¸ä¼šè‡ªåŠ¨æ‰“å°æ¢è¡Œç¬¦\\n\nformatæ ¼å¼ï¼š %c:æ˜¾ç¤ºå•ä¸ªå­—ç¬¦\n%d,%i:åè¿›åˆ¶æ•´æ•°\n%e,%E:ç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤ºæ•°å€¼\n%f:æ˜¾ç¤ºæµ®ç‚¹æ•°\n%g,%G:ä»¥ç§‘å­¦è®¡æ•°æ³•çš„æ ¼å¼æˆ–æµ®ç‚¹æ•°çš„æ ¼å¼æ˜¾ç¤ºæ•°å€¼\n%s:æ˜¾ç¤ºå­—ç¬¦ä¸²\n%u:æ— ç¬¦å·æ•´æ•°\n%%:æ˜¾ç¤º%è‡ªèº«\n**ä¿®é¥°ç¬¦: N:æ˜¾ç¤ºå®½åº¦ï¼ŒNä¸ºæ•°å­—\n-:å·¦å¯¹é½ï¼Œé»˜è®¤ä¸ºå³å¯¹é½\n+:æ˜¾ç¤ºæ•°å€¼ç¬¦å·**\n1 2 3 weizhang[root@wei awk]# awk \u0026#39;{printf \u0026#34;%s\\n\u0026#34;, $3}\u0026#39; print.txtÂ wei zhang 1 2 3 [root@wei awk]# awk \u0026#39;{printf \u0026#34;%6s\\n\u0026#34;, $3}\u0026#39; print.txtÂ wei zhang æ˜¾ç¤ºå‰ä¸‰ä¸ªç”¨æˆ·çš„ç”¨æˆ·åï¼Œuidï¼Œå®¶ç›®å½• 1 2 3 4 [root@wei awk]# head -n 3 /etc/passwd | awk -F: \u0026#39;{printf \u0026#34;%-8s%-3d%-6s\\n\u0026#34;,$1,$3,$6}\u0026#39; root 0 /rootÂ bin 1 /bin daemon 2 /sbinÂ ","date":"2019-04-14T21:29:21Z","image":"https://www.ownit.top/title_pic/03.jpg","permalink":"https://www.ownit.top/p/201904142129/","title":"Linux shell awkä¸­printfä½¿ç”¨"},{"content":"**Linuxå¤„ç†æ–‡æœ¬å·¥å…· grepï¼š è¿‡æ»¤æ–‡æœ¬å†…å®¹\nsedï¼š ç¼–è¾‘æ–‡æœ¬å†…å®¹\nawk: æ˜¾ç¤ºæ–‡æœ¬\nawkï¼š Aho Peter Weinberger Kernighan\næŠ¥å‘Šç”Ÿæˆå™¨ï¼Œä»¥ç‰¹å®šçš„æ¡ä»¶æŸ¥æ‰¾æ–‡æœ¬å†…å®¹ï¼Œåœ¨ä»¥ç‰¹å®šçš„æ ¼å¼æ˜¾ç¤º**\nawkå‘½ä»¤çš„æ ¼å¼ï¼š # awk [option] \u0026lsquo;script\u0026rsquo; file1 file2\u0026hellip;\n# awk [option] \u0026lsquo;PATTERM{action}\u0026rsquo; file1 file2\u0026hellip;\nPATTERNï¼š\nç”¨æ–‡æœ¬å­—ç¬¦ä¸æ­£åˆ™è¡¨è¾¾å¼å…ƒå­—ç¬¦æè¿°çš„æ¡ä»¶ï¼Œå¯ä»¥çœç•¥ä¸å†™\naction:\nprint\nprintf æŒ‡å®šè¾“å‡ºé¡¹çš„æ ¼å¼ï¼šæ ¼å¼å¿…é¡»å†™\n**optioné€‰é¡¹ï¼š -F æŒ‡å®šæ–‡æœ¬åˆ†å‰²ç¬¦\nawkå¤„ç†æ–‡æœ¬æœºåˆ¶ï¼š\nawkå°†ç¬¦åˆPATTERNçš„æ–‡æœ¬é€æ¸å–å‡ºï¼Œå¹¶æŒ‰ç…§æŒ‡å®šçš„åˆ†å‰²ç¬¦ï¼ˆé»˜è®¤ä¸ºç©ºç™½ï¼Œé€šè¿‡â€”Fé€‰é¡¹å¯ä»¥æŒ‡å®šåˆ†å‰²ç¬¦ï¼‰è¿›è¡Œåˆ†å‰²ï¼Œç„¶åå°†åˆ†å‰²åçš„æ¯æ®µæŒ‰ç…§ç‰¹å®šçš„æ ¼å¼è¾“å‡º**\nawkçš„è¾“å‡ºï¼š\nä¸€ print\nprintçš„ä½¿ç”¨æ ¼å¼ï¼š\nprint item1ï¼Œitem,\u0026hellip;\næ³¨æ„ï¼š 1ï¼Œå„é¡¹ç›®é—´ä½¿ç”¨é€—å·åˆ†éš”å¼€ï¼Œè€Œè¾“å‡ºæ—¶ä»¥ç©ºç™½å­—ç¬¦ä¸²ä¸ºåˆ†éš”\n2ï¼Œè¾“å‡ºçš„itemå¯ä»¥ä¸ºå­—ç¬¦ä¸²ï¼Œæ•°å€¼ï¼Œå½“å‰çš„è®°å½•çš„å­—æ®µï¼ˆ$1ï¼‰,å˜é‡æˆ–è€…awkçš„è¡¨è¾¾å¼ï¼Œæ•°å€¼ä¼šå…ˆè½¬æ¢å­—ç¬¦ä¸²ï¼Œç„¶åè¾“å‡º\n3ï¼Œprintå‘½ä»¤åé¢çš„itemå¯ä»¥çœç•¥ï¼Œæ­¤æ—¶å…¶åŠŸèƒ½ç›¸å½“äºprintï¼ˆ$0ä»£è¡¨æœªåˆ†å‰²çš„æ•´è¡Œæ–‡æœ¬å†…å®¹ï¼‰ï¼Œå› æ­¤ï¼Œå¦‚æœæƒ³è¾“å‡ºç©ºè¡Œï¼Œåˆ™éœ€è¦ä½¿ç”¨print \u0026ldquo;\u0026rdquo;;\nä»¥ç©ºç™½åˆ†å‰²ï¼Œæ˜¾ç¤ºæ–‡æœ¬çš„ç¬¬ä¸€æ®µåŠç¬¬äºŒæ®µå†…å®¹\n1 2 3 [root@wei awk]# awk \u0026#39;{print $1,$3}\u0026#39; print.txtÂ i wei i zhang 1 2 3 [root@wei awk]# awk \u0026#39;{print \u0026#34;hello\u0026#34;,$3}\u0026#39; print.txtÂ hello wei hello zhang æ˜¾ç¤ºpasswdçš„ç”¨æˆ·åç§°\n1 2 3 4 5 6 [root@wei awk]# awk -F: \u0026#39;{print $1}\u0026#39; /etc/passwd root bin daemon adm lp æ˜¾ç¤ºè®¾å¤‡çš„æŒ‚è½½æƒ…å†µ\n1 2 3 4 [root@wei awk]# df -hT | sed \u0026#39;1d\u0026#39; | awk \u0026#39;{print \u0026#34;è®¾å¤‡åç§°ï¼š\u0026#34;,$1,\u0026#34;æŒ‚è½½ç‚¹ï¼š\u0026#34;,$7,\u0026#34;æ€»å®¹é‡ï¼š\u0026#34;,$3}\u0026#39; è®¾å¤‡åç§°ï¼š /dev/mapper/centos-root æŒ‚è½½ç‚¹ï¼š / æ€»å®¹é‡ï¼š 17G è®¾å¤‡åç§°ï¼š devtmpfs æŒ‚è½½ç‚¹ï¼š /dev æ€»å®¹é‡ï¼š 476M è®¾å¤‡åç§°ï¼š tmpfs æŒ‚è½½ç‚¹ï¼š /dev/shm æ€»å®¹é‡ï¼š 488M awkå˜é‡\n1 awkå†…ç½®å˜é‡ä¹‹è®°å½•å˜é‡ FSï¼šæŒ‡å®šè¯»å–æ–‡æœ¬æ—¶ï¼Œæ‰€ä½¿ç”¨çš„è¡Œåˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸ºç©ºç™½å­—ç¬¦ï¼Œç›¸å½“äºawkçš„â€”Fé€‰é¡¹\nOFSï¼šæŒ‡å®šè¾“å‡ºçš„åˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸ºç©ºç™½å­—ç¬¦ï¼›\n1 2 [root@wei awk]# head -n 1 /etc/passwd | awk -F: \u0026#39;{print $1,$7}\u0026#39; root /bin/bash FSæ¨¡å¼\n1 2 [root@wei awk]# head -n 1 /etc/passwd | awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}{print $1,$7}\u0026#39; root /bin/bash OFSæ¨¡å¼\n1 2 [root@wei awk]# head -n 1 /etc/passwd | awk -F: \u0026#39;BEGIN{OFS=\u0026#34;---\u0026#34;}{print $1,$7}\u0026#39; root---/bin/bash æ¨¡å¼æ··åˆ\n1 2 [root@wei awk]# head -n 1 /etc/passwd | awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;;OFS=\u0026#34;---\u0026#34;}{print $1,$7}\u0026#39; root---/bin/bash 2 awkå†…ç½®å˜é‡ä¹‹æ•°æ®å˜é‡\nNRï¼šè®°å½•awkæ‰€å¤„ç†çš„æ–‡æœ¬è¡Œæ•°ï¼Œå¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼Œæ‰€æœ‰çš„æ–‡ä»¶ç»Ÿä¸€è¿›è¡Œè®¡æ•°\n1 2 3 4 5 ç¬¬ 1 è¡Œå†…å®¹ï¼š 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ç¬¬ 2 è¡Œå†…å®¹ï¼š ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 ç¬¬ 3 è¡Œå†…å®¹ï¼š \\S ç¬¬ 4 è¡Œå†…å®¹ï¼š Kernel \\r on an \\m ç¬¬ 5 è¡Œå†…å®¹ï¼šÂ æ³¨æ„ï¼š\nprintåœ¨æ˜¾ç¤ºå˜é‡å€¼æ—¶ï¼Œä¸è¦ä½¿ç”¨$\nFNRï¼šè®°å½•awkæ‰€å¤„ç†çš„æ–‡æœ¬è¡Œæ•°ï¼Œå¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼Œæ‰€æœ‰çš„æ–‡ä»¶åˆ†åˆ«è¿›è¡Œè®¡æ•°\n1 2 3 4 5 6 [root@wei awk]# awk \u0026#39;{print \u0026#34;ç¬¬\u0026#34;,FNR,\u0026#34;è¡Œå†…å®¹ï¼š\u0026#34;,$0}\u0026#39; /etc/hosts /etc/issue ç¬¬ 1 è¡Œå†…å®¹ï¼š 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ç¬¬ 2 è¡Œå†…å®¹ï¼š ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 ç¬¬ 1 è¡Œå†…å®¹ï¼š \\S ç¬¬ 2 è¡Œå†…å®¹ï¼š Kernel \\r on an \\m ç¬¬ 3 è¡Œå†…å®¹ï¼š NFï¼šè®°å½•awkæ­£åœ¨å¤„ç†çš„å½“å‰è¡Œè¢«åˆ†éš”æˆå‡ ä¸ªå­—æ®µ\n1 2 3 4 5 6 7 8 9 [root@wei awk]# cat print.txtÂ i am wei i am zhang [root@wei awk]# awk \u0026#39;{print NF}\u0026#39; print.txtÂ 3 3 [root@wei awk]# awk \u0026#39;{print $NF}\u0026#39; print.txtÂ wei zhang 3 ç”¨æˆ·è‡ªå®šä¹‰çš„å˜é‡ awkå…è®¸ç”¨æˆ·è‡ªå®šä¹‰å˜é‡ï¼Œå˜é‡åç§°ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ï¼Œä¸”åŒºåˆ†å¤§å°å†™\n**ç¤ºä¾‹ï¼šÂ **\næ–¹æ³•ä¸€ï¼šä½¿ç”¨-vé€‰é¡¹\n1 2 3 4 [root@wei awk]# head -n 3 /etc/passwd | awk -v test=\u0026#34;hello\u0026#34; -F: \u0026#39;{print test,$1}\u0026#39; hello root hello bin hello daemon æ–¹æ³•äºŒï¼šåœ¨BEGIN{}æ¨¡å¼è‡ªå®šä¹‰å˜é‡\n1 2 3 4 [root@wei awk]# head -n 3 /etc/passwd | awk -F: \u0026#39;BEGIN{test=\u0026#34;hello\u0026#34;}{print test,$1}\u0026#39; hello root hello bin hello daemon ","date":"2019-04-14T20:59:55Z","image":"https://www.ownit.top/title_pic/55.jpg","permalink":"https://www.ownit.top/p/201904142059/","title":"Linux shell awkä¸­printåŠå˜é‡ä½¿ç”¨"},{"content":"Shell æ•°ç»„ æ•°ç»„ä¸­å¯ä»¥å­˜æ”¾å¤šä¸ªå€¼ã€‚Bash Shell åªæ”¯æŒä¸€ç»´æ•°ç»„ï¼ˆä¸æ”¯æŒå¤šç»´æ•°ç»„ï¼‰ï¼Œåˆå§‹åŒ–æ—¶ä¸éœ€è¦å®šä¹‰æ•°ç»„å¤§å°ï¼ˆä¸ PHP ç±»ä¼¼ï¼‰ã€‚\nä¸å¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€ç±»ä¼¼ï¼Œæ•°ç»„å…ƒç´ çš„ä¸‹æ ‡ç”±0å¼€å§‹ã€‚\nShell æ•°ç»„ç”¨æ‹¬å·æ¥è¡¨ç¤ºï¼Œå…ƒç´ ç”¨\u0026quot;ç©ºæ ¼\u0026quot;ç¬¦å·åˆ†å‰²å¼€ï¼Œè¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š\n1 array_name=(value1 ... valuen) æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹æ ‡æ¥å®šä¹‰æ•°ç»„:\n1 2 3 array_name[0]=value0 array_name[1]=value1 array_name[2]=value2 è¯»å–æ•°ç»„\nè¯»å–æ•°ç»„å…ƒç´ å€¼çš„ä¸€èˆ¬æ ¼å¼æ˜¯ï¼š\n1 ${array_name[index]} æ•°ç»„ Array\nä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´\n**Â (1)å®šä¹‰æ•°ç»„**\n1 2 3 4 5 6 7 8 [root@wei ~]# aa[0]=hei [root@wei ~]# aa[1]=wei [root@wei ~]# aa[2]=zhang [root@wei ~]# hei=(192.168.196.1 192.168.196.2 192.168.196.3) [root@wei ~]# echo ${hei[1]} 192.168.196.2 [root@wei ~]# echo ${hei[*]} 192.168.196.1 192.168.196.2 192.168.196.3 (2)åˆ é™¤æ•°ç»„ 1 2 [root@wei ~]# unset hei [root@wei ~]# echo ${hei[*]} (3)è·å–æ•°ç»„çš„é•¿åº¦\n1 2 3 4 5 6 7 [root@wei ~]# aa=(tom hei zhang wei) [root@wei ~]# echo ${aa[*]} tom hei zhang wei [root@wei ~]# echo ${#aa[*]} 4 [root@wei ~]# echo ${#aa[@]} 4 ç¼–å†™è„šæœ¬ï¼Œæ‰¾å‡ºæ•°ç»„ä¸­æœ€å¤§æ•° 1 2 3 4 5 6 7 8 9 10 11 #!/bin/bash # number=(53 54 654 45 677 46 999) max=${number[0]} for i in `seq 7`;do if [ ${number[$i]} -gt $max ];then max=${number[$i]} fi done echo $max éšæœºæ•° 1 2 3 4 [root@wei ~]# echo $RANDOM 10803 [root@wei ~]# echo $RANDOM 5555 ","date":"2019-04-11T23:04:58Z","image":"https://www.ownit.top/title_pic/39.jpg","permalink":"https://www.ownit.top/p/201904112304/","title":"Linux shell æ•°ç»„"},{"content":"shellè„šæœ¬ä¸­å¯¹å­—ç¬¦ä¸²çš„å¤„ç† 1 ${#å˜é‡å} ä½œç”¨ï¼šè¿”å›å­—ç¬¦ä¸²çš„é•¿åº¦\n1 2 3 # foo=\u0026#34;this is a test\u0026#34; # echo ${#foo} //è¿”å›å­—ç¬¦ä¸²çš„é•¿åº¦ 14 2 ${å˜é‡åï¼šoffsetï¼šlength} ä½œç”¨ï¼šæˆªå–å­—ç¬¦ä¸²ï¼ŒlengthæŒ‡å®šæˆªå–çš„é•¿åº¦ï¼Œä¹Ÿå¯ä»¥ä¸å†™ï¼Œå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ç´¢å¼•å€¼ä¸º0\n1 2 3 4 5 # foo=â€œabcdefgâ€ # echo ${foo:3:2} //ä»ä¸‹æ ‡ä¸º3çš„å­—ç¬¦å¼€å§‹æˆªå–ï¼Œå…±æˆªå–2ä¸ª de # echo ${foo:3} //ä»ä¸‹æ ‡ä¸º3çš„å­—ç¬¦å¼€å§‹æˆªå–åˆ°æœ€åçš„å­—ç¬¦ defg 3 ${å˜é‡å#pattern} ${å˜é‡å##pattern}\npatternï¼šæ¨¡å¼ï¼Œé€šé…ç¬¦è¡¨è¾¾å¼\nä½œç”¨ï¼šæ¸…é™¤å­—ç¬¦ä¸²ä¸­ç¬¦åˆpatternçš„å­—ç¬¦ï¼Œä»å­—ç¬¦ä¸²æœ€å‰åŒ¹é…\n1 2 3 4 5 # foo=â€œfile.txt.zipâ€ # echo ${foo#*.} //ä¸€ä¸ª#å·ä»£è¡¨æŒ‰ç…§æœ€çŸ­åŒ¹é…æ¸…é™¤ txt.zip # echo ${foo##*.} //2ä¸ª#å·ä»£è¡¨æŒ‰ç…§æœ€é•¿åŒ¹é…æ¸…é™¤ zip 4 ${å˜é‡å%pattern} ${å˜é‡å%%pattern} patternï¼šæ¨¡å¼ï¼Œé€šé…ç¬¦è¡¨è¾¾å¼\nä½œç”¨ï¼šæ¸…é™¤å­—ç¬¦ä¸²ä¸­ç¬¦åˆpatternçš„å­—ç¬¦ï¼Œä»å­—ç¬¦ä¸²æœ€ååŒ¹é…\n1 2 3 4 5 # foo=â€œfile.txt.zipâ€ # echo ${foo%.*} //ä¸€ä¸ª%å·ä»£è¡¨æŒ‰ç…§æœ€çŸ­åŒ¹é…æ¸…é™¤ file.txt # echo ${foo%%.*} //2ä¸ª%å·ä»£è¡¨æŒ‰ç…§æœ€é•¿åŒ¹é…æ¸…é™¤ file 5 å­—ç¬¦ä¸²æ›¿æ¢æ“ä½œ\n${å˜é‡å/old/new}\n1 2 3 4 5 [root@wei ~]# foo=\u0026#34;mp3.txt.txt.mp3.avi\u0026#34; [root@wei ~]# echo ${foo/txt/TXT} mp3.TXT.txt.mp3.avi [root@wei ~]# echo ${foo//txt/TXT} mp3.TXT.TXT.mp3.avi 1 2 3 4 5 [root@wei ~]# foo=\u0026#34;txt.txt.txt\u0026#34; [root@wei ~]# echo ${foo/#txt/TXT} TXT.txt.txt [root@wei ~]# echo ${foo/%txt/TXT} txt.txt.TXT 6 å®ç°å¤§å°å†™å­—æ¯çš„è½¬æ¢\nå¤§å†™è½¬æ¢å°å†™\n1 2 3 4 5 [root@wei ~]# foo=\u0026#34;ABcd\u0026#34; [root@wei ~]# echo ${foo,} aBcd [root@wei ~]# echo ${foo,,} abcd å°å†™è½¬æ¢å¤§å†™\n1 2 3 4 [root@wei ~]# echo ${foo^} AbCD [root@wei ~]# echo ${foo^^} ABCD ","date":"2019-04-10T21:47:37Z","image":"https://www.ownit.top/title_pic/61.jpg","permalink":"https://www.ownit.top/p/201904102147/","title":"Linux shell å­—ç¬¦ä¸²æ“ä½œ"},{"content":"Linuxå¤„ç†æ–‡æœ¬æ–‡ä»¶çš„å·¥å…·:\n**Â grepÂ è¿‡æ»¤æ–‡ä»¶å†…å®¹\nsedÂ ç¼–è¾‘æ–‡ä»¶å†…å®¹\nawk\næ­£åˆ™è¡¨è¾¾å¼Regex\næ­£åˆ™è¡¨è¾¾å¼Regex**\nsedåœ¨å¤„ç†æ–‡æœ¬æ—¶æ˜¯é€è¡Œè¯»å–æ–‡ä»¶å†…å®¹ï¼Œè¯»åˆ°åŒ¹é…çš„è¡Œå°±æ ¹æ®æŒ‡ä»¤åšæ“ä½œï¼Œä¸åŒ¹é…å°±è·³è¿‡ã€‚\nsedæ˜¯Linuxä¸‹ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„éäº¤äº’æµå¼æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå¯ä»¥å¯¹æ–‡æœ¬æ–‡ä»¶è¿›è¡Œå¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œï¼Œæ”¯æŒæŒ‰è¡Œã€æŒ‰å­—æ®µã€æŒ‰æ­£åˆ™åŒ¹é…æ–‡æœ¬å†…å®¹ï¼Œçµæ´»æ–¹ä¾¿ï¼Œç‰¹åˆ«é€‚åˆäºå¤§æ–‡ä»¶çš„ç¼–è¾‘ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»sedçš„ä¸€äº›åŸºæœ¬ç”¨æ³•ï¼Œå¹¶é€šè¿‡shellè„šæœ¬æ¼”ç¤ºsedçš„ä½¿ç”¨å®ä¾‹ã€‚\n(1)åŒ¹é…å•ä¸ªå­—ç¬¦çš„å…ƒå­—ç¬¦ **Â .\n[abc]Â [a-z]Â [A-Z]Â [0-9]Â [a-zA-Z0-9]Â [^a-z]\n[[:alpha:]]Â [[:upper:]]Â [[:lower:]] [[:digit:]]**\n**Â (2)åŒ¹é…å­—ç¬¦å‡ºç°ä½ç½®**\n**Â ^str ä»¥\u0026hellip;å¼€å¤´\nstr$ ä»¥\u0026hellip;ç»“å°¾\n^$Â ç©ºè¡Œ**\n(3)åŒ¹é…å­—ç¬¦å‡ºç°çš„æ¬¡æ•° **Â *Â \\?\n\\+\n\\{3\\}\n\\{2,5\\}\n\\{2,\\}**\n**Â sed: Stream Editor æµç¼–è¾‘å™¨**\n**Â è¡Œç¼–è¾‘å™¨ é€è¡Œç¼–è¾‘\nå°†æ¯è¡Œå†…å®¹è¯»å…¥åˆ°å†…å­˜ä¸­ï¼Œåœ¨å†…å­˜ä¸­è¿›è¡Œå¤„ç†ï¼Œå°†ç»“æœè¿”å›ç»™å±å¹•ï¼Œæ­¤æ®µå†…å­˜ç©ºé—´ç§°ä¸ºæ‘¸ç´¢ç©ºé—´**\né»˜è®¤ä¸ç¼–å†™åŸæ–‡ä»¶ï¼Œä»…å¯¹æ¨¡å¼ç©ºé—´çš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå¤„ç†ç»“æŸåï¼Œå°†æ¨¡å¼ç©ºé—´çš„å†…å®¹æ˜¾ç¤ºåˆ°å±å¹•\nsedå‘½ä»¤çš„ä½¿ç”¨æ ¼å¼ # sed [option] scripts file1 file2\u0026hellip;\n# sed [option] \u0026lsquo;AddressCommand\u0026rsquo; file1 file \u0026hellip;\n**Â Address:è¡¨ç¤ºå¯¹é‚£äº›è¿›è¡Œå¤„ç†\nCommandï¼šæ“ä½œå‘½ä»¤\noptioné€‰é¡¹ï¼š\n-n:ä¸åœ¨æ˜¾ç¤ºæ¨¡å¼ç©ºé—´çš„å†…å®¹ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰\n-iï¼šç›´æ¥ä¿®æ”¹åŸæ–‡ä»¶\n-eï¼šâ€˜AddressCommandâ€™ -e â€˜AddressCommandâ€™ï¼šåŒæ—¶æ‰§è¡Œå¤šä¸ªåŒ¹é…æ“ä½œ\n[root0shell ~]+ sed -e â€˜/^#/dâ€™ -e \u0026lsquo;/^5/d\u0026rsquo; /etc/fstab\n-fï¼šFILEå°†å¤šä¸ªAddressCommandä¿å­˜è‡³æ–‡ä»¶ä¸­ï¼Œæ¯è¡Œä¸€ä¸ªAddressCommand;è¯»å–è¯¥æ–‡ä»¶ä¸­çš„æ“ä½œåŒæ—¶æ‰§è¡Œå¤šä¸ªæ“ä½œ**\n**Â -r:è¡¨ç¤ºä½¿ç”¨æ‰©å±•æ­£åˆ™è¡¨è¾¾å¼**\nAddressè¡¨ç¤ºæ–¹æ³•:\n(1)StartLine, EndLine\n1, 100\n1,$\n(2)lineNumber\n3\n(3)Startline, tn\n**Â 5,+2 /root/,+2**\n(4)/æ­£åˆ™è¡¨è¾¾å¼/\n**Â /root/\n/bash$/**\n(5)/æ­£åˆ™è¡¨è¾¾å¼1/, /æ­£åˆ™è¡¨è¾¾å¼2/\nç¬¬1æ¬¡è¢«Regex1åŒ¹é…çš„è¡Œå‡å§‹ï¼Œåˆ°ç¬¬1æ¬¡è¢«Regex2åŒ¹é…çš„è¡Œä¸­åŒçš„æ‰€æœ‰è¡Œ\ndåˆ é™¤ åˆ é™¤å‰4è¡Œ\n1 [root@wei init.d]# sed \u0026#39;1,4d\u0026#39; nginx.shÂ åˆ é™¤æœ€åä¸€è¡Œ\n1 [root@wei init.d]# sed \u0026#39;$d\u0026#39; nginx.shÂ åˆ é™¤#å¼€å¤´çš„è¡Œ\n1 [root@wei ~]# sed \u0026#39;/^#/d\u0026#39; /etc/fstab åˆ é™¤/å¼€å¤´çš„è¡Œ\n1 [root@wei ~]# sed \u0026#39;/^\\//d\u0026#39; /etc/fstabÂ åˆ é™¤å¸¦æ•°å­—çš„è¡Œ\n1 [root@wei ~]# sed \u0026#39;/[0-9]/d\u0026#39; /etc/fstabÂ p æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„è¡Œ **Â æ˜¾ç¤ºä»¥/å¼€å¤´çš„è¡Œ**\n1 [root@wei ~]# sed -n \u0026#39;/^\\//p\u0026#39; /etc/fstabÂ a \\string åœ¨ç¬¦åˆæ¡ä»¶çš„è¡Œåè¿½åŠ æ–°è¡Œï¼Œstringä¸ºè¿½åŠ çš„å†…å®¹ **Â åœ¨ä»¥/å¼€å¤´çš„è¡Œåé¢è¿½åŠ # hello word\n**\n1 [root@wei ~]# sed \u0026#39;/^\\//a\\# hello word\u0026#39; /etc/fstabÂ **Â åœ¨ä»¥/å¼€å¤´çš„è¡Œåé¢åˆ†åˆ«è¿½åŠ # hello word # hello linux**\n1 [root@wei ~]# sed \u0026#39;/^\\//a\\# hello word\u0026#39; /etc/fstabÂ i \\string åœ¨ç¬¦åˆæ¡ä»¶çš„è¡Œå‰è¿½åŠ æ–°è¡Œï¼Œstringä¸ºè¿½åŠ çš„å†…å®¹ **Â åœ¨æ–‡ä»¶çš„ç¬¬ä¸€è¡Œè¿½åŠ  # hello linux\n**\n1 [root@wei ~]# sed \u0026#39;1i \\# hello linux\u0026#39; /etc/fstabÂ c \\string æ›¿æ¢æŒ‡å®šçš„å†…å®¹ **Â å°†æ–‡ä»¶ä¸­æœ€åä¸€è¡Œçš„å†…å®¹æ›¿æ¢ä¸º end of file\n**\n1 [root@wei ~]# sed \u0026#39;$c\\end of file\u0026#39; /etc/fstabÂ **Â = ç”¨äºæ˜¾ç¤ºæ¯ä¸€è¡Œçš„è¡Œå·**\n**Â æ˜¾ç¤º/etc/passwdæ–‡ä»¶æœ€åä¸€è¡Œçš„è¡Œå·**\n1 [root@wei ~]# sed -n \u0026#39;$=\u0026#39; /etc/passwd r file_name å°†æŒ‡å®šçš„æ–‡ä»¶çš„å†…å®¹æ·»åŠ åˆ°ç¬¦åˆæ¡ä»¶çš„åé¢\n**Â å°†æ–‡ä»¶çš„ç¬¬äºŒè¡Œåé¢è¿½åŠ /etc/fstab\n**\n1 [root@wei ~]# sed \u0026#39;2r /etc/issue\u0026#39; /etc/fstabÂ w file_name å°†ç¬¦åˆæ¡ä»¶çš„å†…å®¹å¦å­˜åˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­\n**Â å°†ä»¥#å¼€å¤´çš„è¡Œå¦å­˜åˆ°/1.txtä¸­\n**\n1 [root@wei ~]# sed \u0026#39;/^#/w /root/1.txt\u0026#39; /etc/fstabÂ æŸ¥æ‰¾å¹¶æ›¿æ¢\né»˜è®¤æƒ…å†µä¸‹ï¼Œåªæ›¿æ¢æ¯ä¸€è¡Œç¬¬ä¸€æ¬¡å‡ºç°çš„å­—ç¬¦\ns /old/new/[ä¿®é¥°ç¬¦]\nold:æ­£åˆ™è¡¨è¾¾å¼/\nnewï¼šæ›¿æ¢çš„å†…å®¹\nä¿®é¥°ç¬¦\ngï¼šæ›¿æ¢ç¬¬ä¸€è¡Œæ‰€æœ‰çš„å­—ç¬¦\niï¼šå¿½ç•¥å¤§å°å†™\næŸ¥æ‰¾æ–‡ä»¶çš„UUIDï¼Œå¹¶æ›¿æ¢æˆuuid 1 [root@wei ~]# sed \u0026#39;s/UUID/uuid/\u0026#39; /etc/fstabÂ å°†è¡Œé¦–çš„/æ›¿æ¢æˆ# 1 [root@wei ~]# sed \u0026#39;s/^\\//#/\u0026#39; /etc/fstabÂ 1 [root@wei ~]# sed \u0026#39;s|/|#|g\u0026#39; /etc/fstabÂ å°†æ¯ä¸€è¡Œå‡ºç°çš„æ‰€æœ‰/æ›¿æ¢æˆ@ 1 [root@wei ~]# sed \u0026#39;s/\\//@/g\u0026#39; /etc/fstab ","date":"2019-04-09T22:21:30Z","image":"https://www.ownit.top/title_pic/57.jpg","permalink":"https://www.ownit.top/p/201904092221/","title":"Linux shell sedå‘½ä»¤ä½¿ç”¨"},{"content":"nginxæœåŠ¡æ§åˆ¶è„šæœ¬ï¼š å®‰è£…ngix 1 2 3 4 5 6 [root@wei function]# yum install gcc pcre-devel openssl-devel [root@wei function]# tar xf nginx-1.14.2.tar.gzÂ [root@wei function]# cd nginx-1.14.2 [root@wei nginx-1.14.2]# ./configure --prefix=/usr/local/nginx [root@wei nginx-1.14.2]# make \u0026amp;\u0026amp; make instal ç¼–å†™æ§åˆ¶nginxçš„è„šæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 #!/bin/bash # nginx_cmd=/usr/local/nginx/sbin/nginx nginx_conf=/usr/local/nginx/conf/nginx.conf nginx_pid_file=/usr/local/nginx/logs/nginx.pid start(){ $nginx_cmd if [ $? -eq 0 ];then echo \u0026#34;æœåŠ¡nginxå¯åŠ¨.....[ok]\u0026#34; fi } stop(){ $nginx_cmd -s stop } reload(){ if $nginx_cmd -t \u0026amp;\u0026gt; /dev/null;then $nginx_cmd -s reload else $nginx_cmd -t fi } status(){ if [ -e $nginx_pid_file ];then echo \u0026#34;æœåŠ¡nginx(`cat $nginx_pid_file`) is running\u0026#34; else echo \u0026#34;æœåŠ¡nginx is stopped\u0026#34; fi } if [ -z $1 ];then echo \u0026#34;ä½¿ç”¨ï¼š$0{start|stop|restart|reload|status}\u0026#34; exit 9 fi case $1 in start) start ;; stop) stop ;; restart) stop sleep 2 start ;; reload) reload ;; *) echo \u0026#34;ä½¿ç”¨ï¼š$0{start|stop|restart|reload|status}\u0026#34; exit 9 ;; esac æ¼”ç¤ºï¼š 1 2 3 4 5 6 7 8 9 [root@wei init.d]# /etc/init.d/nginx status æœåŠ¡nginx(4974) is running [root@wei init.d]# /etc/init.d/nginx statscdsdc ä½¿ç”¨ï¼š/etc/init.d/nginx{start|stop|restart|reload|status} [root@wei init.d]# /etc/init.d/nginx stop [root@wei init.d]# /etc/init.d/nginx status æœåŠ¡nginx is stopped [root@wei init.d]# /etc/init.d/nginx start æœåŠ¡nginxå¯åŠ¨.....[ok] ","date":"2019-04-02T19:39:29Z","image":"https://www.ownit.top/title_pic/38.jpg","permalink":"https://www.ownit.top/p/201904021939/","title":"Linux shell å‡½æ•°åº”ç”¨ç¤ºä¾‹02"},{"content":"å‡½æ•°Functionçš„ä½¿ç”¨\nå®šä¹‰å‡½æ•°\nï¼ˆ1ï¼‰ å‡½æ•°åç§°() {\n\u0026hellip;\n\u0026hellip;\n}\n(2) function å‡½æ•°åç§°{\n\u0026hellip;\n\u0026hellip;\n}\n**è°ƒç”¨å‡½æ•° å‡½æ•°åç§°**\nä¹Ÿå¯ä»¥é€šè¿‡ä½ç½®å˜é‡çš„æ–¹å¼ç»™å‡½æ•°ä¼ é€’å‚æ•°\n1ã€å¯ä»¥å¸¦function fun() å®šä¹‰ï¼Œä¹Ÿå¯ä»¥ç›´æ¥fun() å®šä¹‰,ä¸å¸¦ä»»ä½•å‚æ•°ã€‚ 2ã€å‚æ•°è¿”å›ï¼Œå¯ä»¥æ˜¾ç¤ºåŠ ï¼šreturn è¿”å›ï¼Œå¦‚æœä¸åŠ ï¼Œå°†ä»¥æœ€åä¸€æ¡å‘½ä»¤è¿è¡Œç»“æœï¼Œä½œä¸ºè¿”å›å€¼ã€‚ returnåè·Ÿæ•°å€¼n(0-255ï¼‰ ç¼–å†™è„šæœ¬ï¼Œç¼–å†™å‡½æ•°ï¼Œå¹¶è°ƒç”¨ 1 2 3 4 5 6 7 8 9 10 #!/bin/bash # sayhei() { echo \u0026#34;$1\u0026#34; } sayhei wei sayhei linux sayhei windows æ‰§è¡Œæ•ˆæœ ç¼–å†™è„šæœ¬ï¼Œå®ç°ä¸‹é¢çš„åŠŸèƒ½ ==============\nç›®å½•ç®¡ç†\n1ï¼šåˆ›å»ºç›®å½•\n2ï¼šåˆ é™¤ç›®å½•\n3ï¼šé€€å‡ºè„šæœ¬\n==============\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 #!/bin/bash # create_dir(){ read -p \u0026#34;è¾“å…¥ç›®å½•åç§°ï¼š\u0026#34; dir if [ ! -e $dir ];then mkdir -p $dir echo â€œç›®å½•$diråˆ›å»ºå®Œæˆâ€ else echo \u0026#34;ç›®å½•$dirå­˜åœ¨\u0026#34; fi } remove_dir(){ read -p \u0026#34;è¾“å…¥ç›®å½•åç§°\u0026#34; dir if [ -e $dir ];then rm -r $dir echo \u0026#34;ç›®å½•$diråˆ é™¤æˆåŠŸ\u0026#34; fi } showmenu(){ cat \u0026lt;\u0026lt; eof ============== ç›®å½•ç®¡ç† 1.åˆ›å»ºç›®å½• 2.åˆ é™¤ç›®å½• 3.é€€å‡ºè„šæœ¬ ============== eof } while true;do read -p \u0026#34;è¯·è¾“å…¥ä½ çš„é€‰æ‹©:æ˜¾ç¤ºèœå•[m] \u0026#34; choice case $choice in 1) create_dir ;; 2) remove_dir ;; 3)Â exit 0 ;; m) showmenu ;; *) echo \u0026#34;è¾“å…¥é”™è¯¯,è¯·é‡æ–°é€‰æ‹©\u0026#34; ;; esac done æ‰§è¡Œæ•ˆæœ ","date":"2019-04-01T23:03:40Z","image":"https://www.ownit.top/title_pic/20.jpg","permalink":"https://www.ownit.top/p/201904012303/","title":"Linux shell å‡½æ•°åº”ç”¨ç¤ºä¾‹01"},{"content":"**for ï¼šæ˜ç¡®å¾ªç¯æ¬¡æ•° while ï¼šä¸ç¡®å®šå¾ªç¯æ¢æ¬¡æ•°**\nwhileå¾ªç¯ ï¼ˆ1ï¼‰ while CONDITIONï¼›do\nstatement\nstatement\n\u0026lt;æ”¹å˜å¾ªç¯æ¡ä»¶çœŸå‡çš„è¯­å¥\u0026gt;\ndone\nç¼–å†™è„šæœ¬ï¼Œè®¡ç®—1\u0026ndash;100çš„å’Œ 1 2 3 4 5 6 7 8 9 10 11 #!/bin/bash # sum=0 i=1 while [ $i -le 100 ];do let sum=$sum+$i let i=$i+1 done echo $sum ç¼–å†™whileå¾ªç¯ï¼Œè¾“å…¥qé€€å‡ºï¼ˆä¸è¾“å…¥qï¼Œä¸é€€å‡ºï¼‰\n1 2 3 4 5 6 7 8 #!/bin/bash # read -p \u0026#34;è¯·è¾“å…¥ä½ çš„é€‰æ‹©ï¼š\u0026#34; choice while [ $choice != q ];do echo -e \u0026#34;\\033[31mè¾“å…¥é”™è¯¯\\033[0m\u0026#34; #åŠ çš„é¢œè‰²ä»£ç  read -p \u0026#34;è¯·è¾“å…¥ä½ çš„é€‰æ‹©ï¼š\u0026#34; choice done ï¼ˆ2ï¼‰\nwhile trueï¼›do\nstatement\nstatement\n\u0026lt;breaké€€å‡º\u0026gt;\ndone\nç¼–å†™whileå¾ªç¯ï¼Œè¾“å…¥qé€€å‡ºï¼ˆä¸è¾“å…¥qï¼Œä¸é€€å‡ºï¼‰ 1 2 3 4 5 6 7 8 9 #/bin/bash # while true;do read -p \u0026#34;è¯·è¾“å…¥ä½ çš„é€‰æ‹©\u0026#34; str echo \u0026#34;è¾“å…¥é”™è¯¯\u0026#34; if [ $str == q ];then break fi done ç¼–å†™è„šæœ¬ï¼Œæ¯4ç§’æŸ¥çœ‹ç³»ç»Ÿçš„å†…å­˜ 1 2 3 4 5 6 #!/bin/bash # while true;do uptime sleep 3 done ï¼ˆ3ï¼‰\nwhile read line;do\nstatement\nstatement\ndone \u0026lt; file\nç¼–å†™è„šæœ¬ï¼Œå‘ç³»ç»Ÿæ¯ä¸ªç”¨æˆ·æ‰“æ‹›å‘¼\n1 2 3 4 5 6 7 v#!/bin/bash # while read line;do sh_name=$(echo $line | awk -F: \u0026#39;{print $1}\u0026#39;) echo \u0026#34;Hello $sh_name\u0026#34; done \u0026lt; /etc/passwd ç¼–å†™è„šæœ¬ï¼Œç»Ÿè®¡/bin/bash /sbin/nologinçš„ä¸ªæ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 [root@wei while]# cat 6.shÂ #!/bin/bash # bash_number=0 nologin_number=0 while read line;do sh_name=$(echo $line | awk -F: \u0026#39;{print $7}\u0026#39;) case $sh_name in /bin/bash) let bash_number=$bash_number+1 ;; /sbin/nologin) let nologin_number=$nologin_number+1 ;; esac done \u0026lt; /etc/passwd echo \u0026#34;bashç”¨æˆ·æ•°é‡ï¼š$bash_number\u0026#34; echo \u0026#34;nologin_numberç”¨æˆ·æ•°é‡ï¼š$nologin_number\u0026#34; æ‰§è¡Œæ•ˆæœ 1 2 3 [root@wei while]# ./6.shÂ bashç”¨æˆ·æ•°é‡ï¼š17 nologin_numberç”¨æˆ·æ•°é‡ï¼š17 utilå¾ªç¯ï¼š\nutil CONDITIONï¼›do statement\nstatement\ndone\næ¡ä»¶ä¸ºå‡æ—¶ï¼Œæ‰§è¡Œå¾ªç¯ï¼Œæ¡ä»¶ä¸ºçœŸæ—¶ï¼Œç»“æŸå¾ªç¯ é‡ç‚¹æŒæ¡\nifï¼Œcase forï¼Œwhile","date":"2019-04-01T19:32:44Z","image":"https://www.ownit.top/title_pic/69.jpg","permalink":"https://www.ownit.top/p/201904011932/","title":"Linux shell whileå¾ªç¯è¯­å¥"},{"content":"æ— é™å¾ªç¯ï¼š å¾ªç¯æœ‰é™çš„ç”Ÿå‘½ï¼Œä»–ä»¬è·³å‡ºæ¥ï¼Œä¸€æ—¦æ¡ä»¶æ˜¯ false è¿˜æ˜¯ false å–å†³äºå¾ªç¯ã€‚\nç”±äºæ‰€éœ€çš„æ¡ä»¶æ˜¯ä¸ç¬¦åˆä¸€ä¸ªå¾ªç¯å¯èƒ½æ°¸è¿œæŒç»­ä¸‹å»ã€‚æ°¸è¿œä¸ä¼šç»ˆæ­¢æ‰§è¡Œä¸€ä¸ªå¾ªç¯æ‰§è¡Œæ— é™æ¬¡æ•°ã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œè¿™æ ·çš„å¾ªç¯è¢«ç§°ä¸ºæ— é™å¾ªç¯ã€‚\nbreakè¯­å¥ï¼š breakè¯­å¥ç”¨äºç»ˆæ­¢æ•´ä¸ªå¾ªç¯çš„æ‰§è¡Œï¼Œå®Œæˆåæ‰€æœ‰è¡Œä»£ç breakè¯­å¥çš„æ‰§è¡Œã€‚ç„¶åï¼Œå®ƒé€çº§çš„ä»£ç è·Ÿåœ¨å¾ªç¯ç»“æŸã€‚\ncontinue è¯­å¥: continueè¯­å¥breakå‘½ä»¤ç±»ä¼¼ï¼Œä½†å®ƒä¼šå¯¼è‡´å½“å‰è¿­ä»£çš„å¾ªç¯é€€å‡ºï¼Œè€Œä¸æ˜¯æ•´ä¸ªå¾ªç¯ã€‚\nè¿™ç§å‚æ•°æ˜¯æœ‰ç”¨çš„ï¼Œå½“ä¸€ä¸ªé”™è¯¯å·²ç»å‘ç”Ÿï¼Œä½†ä½ æƒ³å°è¯•æ‰§è¡Œä¸‹ä¸€ä¸ªå¾ªç¯è¿­ä»£ã€‚\nä¸­æ–­å¾ªç¯çš„è¯­å¥ break ä¸­æ–­æ•´ä½“å¾ªç¯\ncontiune ä¸­æ–­æœ¬æ¬¡å¾ªç¯\nbreakç”¨æ³•ï¼š\nç¼–å†™è„šæœ¬ï¼Œåˆ¤æ–­å¤§äº3000çš„ç´¯åŠ å’Œçš„æ•° 1 2 3 4 5 6 7 8 9 10 11 #!/bin/bash # sum=0 for i in `seq 100`;do let sum=$sum+$i if [ $sum -ge 3000 ];then echo $i break fi done contiuneç”¨æ³•ï¼š ç¼–å†™è„šæœ¬ï¼Œæ±‚100çš„å¥‡æ•°çš„ç´¯åŠ å’Œ\n1 2 3 4 5 6 7 8 9 10 11 12 #!/bin/bashÂ # sum=0 for i in `seq 100`;do let ys=$i%2 if [ $ys -eq 0 ];then continue fi let sum=$sum+$i done echo $sum ç¼–å†™è„šæœ¬ï¼Œè¾“å‡ºåœ¨/bin/bashçš„å‰5ä¸ªç”¨æˆ·\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #!/bin/bash # number=0 line=$(wc -l /etc/passwd |awk \u0026#39;{print $1}\u0026#39;) for i in `seq $line`;do sh_name=$(head -n $i /etc/passwd | tail -n 1 | awk -F: \u0026#39;{print $7}\u0026#39;) if [ $sh_name = \u0026#34;/bin/bash\u0026#34; ]; then user_name=$(head -n $i /etc/passwd | tail -n 1 | awk -F: \u0026#39;{print $1}\u0026#39; ) echo $user_name let number=$number+1 fi if [ $number -ge 5 ];then break fi done æ‰§è¡Œæ•ˆæœ 1 2 3 4 5 6 7 8 [root@wei break]# bash 2.sh root mysql hei wei a [root@wei break]# ls /home/ a c d hei user1 user10 user2 user3 user4 user5 user6 user7 user8 user9 wei ","date":"2019-03-23T22:26:25Z","image":"https://www.ownit.top/title_pic/62.jpg","permalink":"https://www.ownit.top/p/201903232226/","title":"Linux shell ä¸­æ–­å¾ªç¯è¯­å¥"},{"content":"Linux ShellÂ forå¾ªç¯ç»“æ„ **å¾ªç¯ç»“æ„ 1ï¼šå¾ªç¯å¼€å§‹æ¡ä»¶\n2ï¼šå¾ªç¯æ“ä½œ\n3ï¼šå¾ªç¯ç»ˆæ­¢çš„æ¡ä»¶**\n**shellè¯­è¨€ forï¼Œwhileï¼Œutil**\n**Â forå¾ªç¯**\nè¯­æ³•ï¼š ï¼ˆ1ï¼‰\nfor å˜é‡ in å–å€¼åˆ—è¡¨ï¼›do\nstatement\nstatement\ndone\nï¼ˆ2ï¼‰\nfor å˜é‡ in å–å€¼åˆ—è¡¨\ndo\nstatement\nstatement\ndone\nä¸Šé¢ä¸¤ä¸ªç”¨æ³•çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚\n**å–å€¼åˆ—è¡¨ï¼š\næ•°å­—\n10 20 30\nä½¿ç”¨seqå‘½ä»¤ç”Ÿæˆæ•°å­—çš„åºåˆ—\nseq 10\nseq 3 10\nseq 1 2 10\nå­—ç¬¦\naa bb cc\næ–‡ä»¶\n**\nç¤ºä¾‹\nseqå¯ä»¥å¿«é€Ÿå»å€¼ï¼Œå¥‡æ•°ç­‰\n1 2 3 4 5 6 7 8 9 10 11 12 [root@wei for]# seq 5 1 2 3 4 5 [root@wei for]# seq 2 6 2 3 4 5 6 ç¤ºä¾‹ï¼š1\u0026ndash;100çš„ç´¯åŠ å’Œ\n1 2 3 4 5 6 7 8 9 10 11 #!/bin/bash # sum=0 for i in `seq 1 100` do let sum=$sum+$i done echo $sumÂ [root@wei for]# bash 1.shÂ 5050 ç¤ºä¾‹ï¼š1\u0026ndash;100çš„å¥‡æ•°ç´¯åŠ å’Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #!/bin/bash sum=0 for i in `seq 100` do let ys=$i%2 if [ $ys -ne 0 ];then let sum=$sum+$i fi done echo $sum [root@wei for]# bash 2.shÂ 2500 åˆ›å»º10ä¸ªç”¨æˆ·ï¼Œåˆå§‹å¯†ç ä¸ºï¼šrootï¼Œç™»é™†é‡æ–°ä¿®æ”¹å¯†ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 #!/bin/bash # for i in `seq 10` do if ! id user$i \u0026amp;\u0026gt; /dev/null ; then useradd user$i echo \u0026#34;root\u0026#34; | passwd --stdin user$i \u0026amp;\u0026gt; /dev/null passwd -e user$i \u0026amp;\u0026gt; /dev/null echo \u0026#34;ç”¨æˆ·user$iåˆ›å»ºå®Œæˆï¼Œåˆå§‹å¯†ç ä¸ºï¼šroot\u0026#34; else echo \u0026#34;ç”¨æˆ·user$iå·²ç»å­˜åœ¨\u0026#34; fi done ä»¥å­—ç¬¦ä½œä¸ºå–å€¼ç±»è¡¨ 1 2 3 4 5 6 7 #!/bin/bash # for name in a d c d ;do useradd $name echo \u0026#34;$name create finishe\u0026#34; done ä»¥æ–‡ä»¶ä½œä¸ºå–å€¼åˆ—è¡¨\n**Â `cat file` ç¼–å†™è„šæœ¬ï¼Œè¯»å–æ–‡æœ¬**\n1 2 3 4 5 6 7 8 #!/bin/bashÂ # for i in `cat /shell/for/1.txt`;do echo \u0026#34;line:$i\u0026#34; done [root@wei for]# ./wen.shÂ line:nangong line:chengfneg ","date":"2019-03-21T22:33:39Z","image":"https://www.ownit.top/title_pic/50.jpg","permalink":"https://www.ownit.top/p/201903212233/","title":"Linux shell forå¾ªç¯ç»“æ„"},{"content":"caseè¯­å¥ä½¿ç”¨äºéœ€è¦è¿›è¡Œå¤šé‡åˆ†æ”¯çš„åº”ç”¨æƒ…å†µ caseåˆ†æ”¯åˆ¤æ–­ç»“æ„\nè¯­æ³•ï¼š\ncase å˜é‡åç§° in\nvalue1)\nstatement\nstatement\n;;\nvalue2)\nstatement\nstatement\n;;\n*)\nstatement\nstatement\n;;Â esac\ncaseè¯­å¥ç»“æ„ç‰¹ç‚¹å¦‚ä¸‹ï¼š\ncaseè¡Œå°¾å¿…é¡»ä¸ºå•è¯ in æ¯ä¸ªæ¨¡å¼å¿…é¡»ä»¥å³æ‹¬å· ï¼‰ ç»“æŸ\nåŒåˆ†å· ;; è¡¨ç¤ºå‘½ä»¤åºåˆ—ç»“æŸ\ncaseè¯­å¥ç»“æ„ç‰¹ç‚¹å¦‚ä¸‹ï¼š\nåŒ¹é…æ¨¡å¼ä¸­å¯æ˜¯ä½¿ç”¨æ–¹æ‹¬å·è¡¨ç¤ºä¸€ä¸ªè¿ç»­çš„èŒƒå›´ï¼Œå¦‚[0-9]ï¼›ä½¿ç”¨ç«–æ ç¬¦å·â€œ|â€è¡¨ç¤ºæˆ–ã€‚\næœ€åçš„â€œ*ï¼‰â€è¡¨ç¤ºé»˜è®¤æ¨¡å¼ï¼Œå½“ä½¿ç”¨å‰é¢çš„å„ç§æ¨¡å¼å‡æ— æ³•åŒ¹é…è¯¥å˜é‡æ—¶ï¼Œå°†æ‰§è¡Œâ€œ*ï¼‰â€åçš„å‘½ä»¤åºåˆ—ã€‚\nç¼–å†™è„šæœ¬ï¼Œåˆ¤æ–­ç”¨æˆ·è¾“å…¥çš„å­—ç¬¦ä¸² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #!/bin/bash # read -p \u0026#34;è¾“å…¥å­—ç¬¦ä¸²ï¼š\u0026#34; str case $str in linux|Linux) echo \u0026#34;windows\u0026#34; ;; windows|Windows) echo \u0026#34;linux\u0026#34; ;; *) echo \u0026#34;other\u0026#34; ;; esac è¿è¡Œæ•ˆæœï¼š 1 2 3 [root@wei case]# bash 1.shÂ è¾“å…¥å­—ç¬¦ä¸²ï¼šlinux windows ç‰¹æ®Šå˜é‡ï¼š\nä½ç½®å˜é‡\n$1,$2,$3\u0026hellip;\u0026hellip;\u0026hellip;..$9,$1{10}\n$1:å‘½ä»¤çš„ç¬¬1ä¸ªå‚æ•°\n$0 å‘½ä»¤æœ¬èº«\n$# å‘½ä»¤å‚æ•°çš„ä¸ªæ•°\nä½¿ç”¨ä½ç½®å˜é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 #!/bin/bash # case $1 in linux|Linux) echo \u0026#34;windows\u0026#34; ;; windows|Windows) echo \u0026#34;linux\u0026#34; ;; *) echo \u0026#34;other\u0026#34; esac æ‰§è¡Œæ•ˆæœ\n1 2 [root@wei case]# ./2.sh linux windows åˆ¤æ–­å­—ç¬¦æ˜¯ä¸ºç©º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #!/bin/bash # if [ -z $1 ];then #åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©º echo \u0026#34;ä½¿ç”¨ï¼š./2.sh{linux/windows}\u0026#34; exit 9 fi case $1 in linux|Linux) echo \u0026#34;windows\u0026#34; ;; windows|Windows) echo \u0026#34;linux\u0026#34; ;; *) echo \u0026#34;other\u0026#34; esac æ‰§è¡Œæ•ˆæœ 1 2 [root@wei case]# ./2.shÂ ä½¿ç”¨ï¼š./2.sh{linux/windows} **$0 å‘½ä»¤æœ¬èº«Â $# å‘½ä»¤å‚æ•°çš„ä¸ªæ•°**\nç¤ºä¾‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #!/bin/bash # if [ $# -ne 1 ];then echo \u0026#34;ä½¿ç”¨ï¼š$0{linux/windows}\u0026#34; exit 9 fi case $1 in linux|Linux) echo \u0026#34;windows\u0026#34; ;; windows|Windows) echo \u0026#34;linux\u0026#34; ;; *) echo \u0026#34;other\u0026#34; esac æ‰§è¡Œæ•ˆæœï¼š\n1 2 3 4 [root@wei case]# /shell/case/2.shÂ ä½¿ç”¨ï¼š/shell/case/2.sh{linux/windows} [root@wei case]# ./2.shÂ ä½¿ç”¨ï¼š./2.sh{linux/windows}Â å»é™¤æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„åï¼š\nbasename [è·¯å¾„æ–‡ä»¶]\n1 2 [root@wei case]# basename /etc/fstabÂ fstab è·å–æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„åï¼š\ndirname [è·¯å¾„æ–‡ä»¶]\n1 2 [root@wei case]# dirname /etc/fstabÂ /etc è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #!/bin/bash # if [ $# -ne 1 ];then echo \u0026#34;ä½¿ç”¨ï¼š$(basename $0){linux/windows}\u0026#34; exit 9 fi case $1 in linux|Linux) echo \u0026#34;windows\u0026#34; ;; windows|Windows) echo \u0026#34;linux\u0026#34; ;; *) echo \u0026#34;other\u0026#34; esac æ‰§è¡Œæ•ˆæœ 1 2 3 [root@wei case]# /shell/case/2.shÂ ä½¿ç”¨ï¼š2.sh{linux/windows} ","date":"2019-03-20T21:03:56Z","image":"https://www.ownit.top/title_pic/61.jpg","permalink":"https://www.ownit.top/p/201903202103/","title":"Linux shell caseæ¡ä»¶åˆ¤æ–­åŠä½ç½®å˜é‡"},{"content":"å‰é¢ä»‹ç»linux shellçš„ifåˆ¤æ–­çš„è¯­æ³•ï¼Œç°åœ¨å†è¡¥å……ä¸€ç‚¹ã€‚\nLinux shell ifæ¡ä»¶åˆ¤æ–­1\n**åˆ†æ”¯åˆ¤æ–­ç»“æ„\nif , case\n**\nä¸‹é¢ä¸¤ä¸ªç»“æ„è¯­æ³•ï¼Œå·²ç»åœ¨å‰é¢æœ‰è¿‡ç¤ºä¾‹ã€‚\nç»“æ„1ï¼š\nif CONDITONï¼› then\nstatement\nstatement\nfi\nç»“æ„2ï¼š\nif CONDITONï¼› then\nstatement\nstatement\nelse\nstatement\nstatement\nfi\nä¸‹é¢ä¼šåˆ†äº«å‡ ä¸ªæˆ‘ç¼–å†™çš„ç¤ºä¾‹ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚\nç¼–å†™è„šæœ¬ï¼Œæœ‰ç”¨æˆ·è¾“å…¥ç”¨æˆ·åï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±æ˜¾ç¤ºç”¨æˆ·ä¸å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œä»¥ä¸‹é¢æ ¼å¼è¾“å‡ºç”¨æˆ·ç›¸å…³ä¿¡æ¯ï¼š\nç”¨æˆ·åï¼š\nå®¿ä¸»ç›®å½•ï¼š\nshellç¨‹åºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@wei shell]# cat if2.shÂ #!/bin/bash # read -p \u0026#34;è¯·è¾“å…¥ç”¨æˆ·åï¼š\u0026#34; name if id $name \u0026amp;\u0026gt; /dev/null; then echo \u0026#34;ç”¨æˆ·åï¼š\u0026#34; $name homedir=`grep \u0026#34;^$name:\u0026#34; /etc/passwd | awk -F: \u0026#39;{print $6}\u0026#39; ` shname=`grep \u0026#34;^$name:\u0026#34; /etc/passwd | awk -F: \u0026#39;{print $7}\u0026#39; ` echo \u0026#34;å®¿ä¸»ç›®å½•ï¼š$homedir\u0026#34; echo \u0026#34;SHELLåç§°ï¼š$shname \u0026#34; else echo \u0026#34;ç”¨æˆ·$nameä¸å­˜åœ¨\u0026#34; fi ç¼–å†™è„šæœ¬ï¼Œåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ç©ºè¡Œï¼Œæœ‰åˆ™æ˜¾ç¤ºç©ºè¡Œä¸ªæ•°ï¼Œæ²¡æœ‰åˆ™æ˜¾ç¤ºæ–‡ä»¶ç±»å®¹ï¼Œå¹¶åœ¨æ¯ä¸€è¡Œæ˜¾ç¤ºè¡Œå·\n1 2 3 4 5 6 7 8 9 10 11 #!/bin/bash # read -p \u0026#34;è¯·è¾“å…¥æ–‡ä»¶çš„åç§°ï¼š\u0026#34; file if grep \u0026#34;^$\u0026#34; $file \u0026amp;\u0026gt; /dev/null; then number=`grep \u0026#34;^$\u0026#34; $file | wc -l` echo \u0026#34;æ–‡ä»¶$fileä¸­çš„ç©ºè¡Œçš„æ•°é‡ï¼š$number\u0026#34; else echo \u0026#34;æ–‡ä»¶$fileå†…å®¹å¦‚ä¸‹ï¼š\u0026#34; cat -n $file fi ç”¨æ³•3 ï¼šå¤šåˆ†æ”¯ifç»“æ„\nif CONDITONï¼› then\nstatement\nstatement\nelif CONDITONï¼› then\nstatement\nstatement\nelif CONDITONï¼› then\nstatement\nstatement\nelse\nstatement\nstatement\nfi\nå¤šä¸ªæ¡ä»¶çš„å†™æ³•ï¼š\nAND [conditionl -a condition2] [conditionl ] \u0026amp;\u0026amp; [ condition2]\nOR [conditionl -o condition2] [conditionl ] || [ condition2]\nç¼–å†™è„šæœ¬ï¼Œåˆ¤æ–­å½“å‰ç³»ç»Ÿæ—¶é—´çš„å°æ—¶æ•°å­— **Â 9\u0026ndash;11 morning\n12\u0026ndash;14 noon\n15\u0026ndash;18 afternoon\nnight\n**\n1 2 3 4 5 6 7 8 9 10 11 12 #!/bin/bash # hour=`date +%H` if [ $hour -ge 9 -a $hour -le 11 ]; then echo \u0026#34;Morning\u0026#34;Â elif [ $hour -ge 12 -a $hour -le 14 ]; then echo \u0026#34; Noon\u0026#34; elif [ $hour -ge 15 -a $hour -le 18 ]; then echo \u0026#34; Afternoon\u0026#34; else echo \u0026#34;Night\u0026#34; fi æ‰§è¡Œæ•ˆæœï¼š\n1 2 3 4 [root@wei shell]# date 2019å¹´ 03æœˆ 19æ—¥ æ˜ŸæœŸäºŒ 18:44:50 CST [root@wei shell]# bash shi.shÂ Afternoon æ•°å­¦è¡¨è¾¾å¼\nå­—ç¬¦è¡¨è¾¾å¼\n[ str1 == str2 ]\n[ str1 != str2 ]\n[ -z str1 ] åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©º\n**åˆ¤æ–­ä¸¤æ¬¡å¯†ç æ˜¯å¦ç›¸åŒÂ ** 1 2 3 4 5 6 7 8 9 #!/bin/bash # read -p \u0026#34;è¯·è¾“å…¥å¯†ç ï¼š\u0026#34; pwd1 read -p \u0026#34;è¯·åœ¨ä¸€æ¬¡è¾“å…¥å¯†ç ï¼š\u0026#34; pwd2 if [ \u0026#34;$pwd1\u0026#34; == \u0026#34;$pwd2\u0026#34; ];then echo \u0026#34;å¯†ç è¾“å…¥æ­£ç¡®\u0026#34; else echo \u0026#34;å¯†ç ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´\u0026#34; fi **æ–‡ä»¶ç›®å½•è¡¨è¾¾å¼ï¼š\n[ -e file ] åˆ¤æ–­æ–‡ä»¶ç›®å½•æ˜¯å¦å­˜åœ¨\n[ -f file ] åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶\n[ -e file ] åˆ¤æ–­æ˜¯å¦ä¸ºç›®å½•\n[ -r file ] åˆ¤æ–­æ–‡ä»¶æ˜¯å¦æœ‰ræƒé™\n[ -w file ] åˆ¤æ–­æ–‡ä»¶æ˜¯å¦æœ‰wæƒé™\n[ -x file ] åˆ¤æ–­æ–‡ä»¶æ˜¯å¦æœ‰xæƒé™\n**\nåŒç›®è¡¨è¾¾å¼\nå•ç›®è¡¨è¾¾å¼ [ -e file ] [ ! -e file ]\nç”¨æ³•4ï¼š ifçš„å†…åµŒè¯­æ³• if CONDITONï¼› then\nif CONDITONï¼› then\nstatement\nstatement\nfi\nelse\nstatement\nstatement\nfi\nåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœç”¨æˆ·å­˜åœ¨ï¼Œåˆ¤æ–­ä»–çš„rootçš„idå’Œgroupçš„idæ˜¯å¦ç›¸åŒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #!/bin/bsah # read -p \u0026#34;è¾“å…¥ç”¨æˆ·åï¼š \u0026#34; name if id $name \u0026amp;\u0026gt; /dev/null; then #è·å–uidï¼Œgidè¿›è¡Œåˆ¤æ–­ user_id=$(id -u $name) group_id=$(id -g $name) if [ $user_id -eq $group_id ];then echo \u0026#34; Good user\u0026#34; else echo \u0026#34;Bad user\u0026#34; fi else echo \u0026#34;ç”¨æˆ·ä¸å­˜åœ¨\u0026#34; fi åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨è¾“å…¥åˆ°å¤‡ä»½çš„æ–‡ä»¶å» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #!/bin/bash # read -p \u0026#34;è¾“å…¥æ–‡ä»¶çš„è·¯å¾„ï¼š\u0026#34; file if [ -e $file ]; then read -p \u0026#34;è¾“å…¥å¤‡ä»½çš„è·¯å¾„ï¼š\u0026#34; dir if [ -e $dir ]; then cp $file $dir echo \u0026#34;æ–‡ä»¶$fileå¤‡ä»½åˆ°$dirç›®å½•\u0026#34; else mkdir -p $dir cp $file $dir echo \u0026#34;æ–‡ä»¶$fileå¤‡ä»½åˆ°$dirç›®å½•\u0026#34; fi else echo â€œæ–‡ä»¶$fileä¸å­˜åœ¨â€ fi ","date":"2019-03-19T22:12:21Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/201903192212/","title":"Linux shell ifæ¡ä»¶åˆ¤æ–­2"},{"content":"**shell é€»è¾‘æ§åˆ¶è¯­å¥ï¼š åˆ†æ”¯åˆ¤æ–­ç»“æ„\nif\ncase\nå¾ªç¯ç»“æ„\nfor\nwhile\nuntil\n**\nifè¯­å¥ç»“æ„\nç”¨æ³•1 if CONDITONï¼› then\nstatement\nstatement\nfi\nCONDITIONæ¡ä»¶çš„å†™æ³•ï¼š\n**Â COMMAND\n[ expression ]\nexpressionè¡¨è¾¾å¼ï¼š\næ•°å­¦è¡¨è¾¾å¼\nå­—ç¬¦è¡¨è¾¾å¼\næ–‡ä»¶ç›®å½•è¡¨è¾¾å¼\næ•°å­¦è¡¨è¾¾å¼ï¼š\n[ number1 -eq number2 ] ç­‰äº\n[ number1 -ne number2 ] ä¸ç­‰äº\n[ number1 -gt number2 ] å¤§äº\n[ number1 -ge number2 ] å¤§äºç­‰äº\n[ number1 -lt number2 ] å°äº\n[ number1 -le number2 ] å°äºç­‰äº\n**\nç¼–å†™è„šæœ¬ï¼Œæœ‰ç”¨æˆ·è¾“å…¥ç”¨æˆ·åï¼Œåˆ¤æ–­ç”¨æˆ·ä¸å­˜åœ¨åˆ™åˆ›å»º 1 [root@wei shell]# vim if.sh 1 2 3 4 5 6 7 8 9 10 11 #!/bin/bash # read -p \u0026#34;è¯·è¾“å…¥ç”¨æˆ·åï¼š \u0026#34; name id $name \u0026amp;\u0026gt; /dev/null if [ $? -ne 0 ];then read -p \u0026#34;è¾“å…¥å¯†ç ï¼š\u0026#34; passwd useradd $name echo \u0026#34;$passwd\u0026#34; | passwd --stdin $name \u0026amp;\u0026gt; /dev/null echo \u0026#34;ç”¨æˆ·$nameåˆ›å»ºå®Œæˆï¼Œåˆå§‹å¯†ç ä¸ºï¼š$passwd\u0026#34; fi æ£€æµ‹è¯­æ³•æ‰§è¡ŒçŠ¶å†µ\n1 2 3 4 5 6 7 8 9 10 11 12 [root@wei shell]# bash -x if.shÂ + read -p \u0026#39;è¯·è¾“å…¥ç”¨æˆ·åï¼š \u0026#39; name è¯·è¾“å…¥ç”¨æˆ·åï¼š wei + id wei + \u0026#39;[\u0026#39; 1 -ne 0 \u0026#39;]\u0026#39; + read -p è¾“å…¥å¯†ç ï¼š passwd è¾“å…¥å¯†ç ï¼š123456 + useradd wei + echo 123456 + passwd --stdin wei + echo ç”¨æˆ·weiåˆ›å»ºå®Œæˆï¼Œåˆå§‹å¯†ç ä¸ºï¼š123456 ç”¨æˆ·weiåˆ›å»ºå®Œæˆï¼Œåˆå§‹å¯†ç ä¸ºï¼š123456 æ£€æµ‹è¯­æ³•é”™è¯¯ 1 [root@wei shell]# bash -n if.shÂ æ¡ä»¶è¯­è¨€è„šæœ¬ ç”¨æ³•2ï¼š å•åˆ†æ”¯if if CONDITONï¼› then\nstatement\nstatement\nelse\nstatement\nstatement\nfi\nç¼–å†™è„šæœ¬ï¼Œç”±ç”¨æˆ·è¾“å…¥ç”¨æˆ·åï¼Œåˆ¤æ–­ç”¨æˆ·ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå¹¶è®¾ç½®ç”¨æˆ·ç¬¬ä¸€æ¬¡ç™»é™†ç³»ç»Ÿæ—¶éœ€è¦ä¿®æ”¹å¯†ç ã€‚å¦åˆ™æç¤ºç”¨æˆ·å·²å­˜åœ¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 #!/bin/bash # read -p \u0026#34;è¯·è¾“å…¥ç”¨æˆ·åï¼š \u0026#34; name if id $name \u0026amp;\u0026gt; /dev/null ;then echo \u0026#34; ç”¨æˆ·$nameå·²ç»å­˜åœ¨\u0026#34; else useradd $name read -p \u0026#34;è¾“å…¥å¯†ç ï¼š\u0026#34; passwd echo \u0026#34;$passwd\u0026#34; | passwd --stdin $name \u0026amp;\u0026gt; /dev/null passwd -e $name \u0026amp;\u0026gt; /dev/null echo \u0026#34;ç”¨æˆ·$nameåˆ›å»ºå®Œæˆï¼Œåˆå§‹å¯†ç ä¸ºï¼š$passwd\u0026#34; fi ç”±ç”¨æˆ·è¾“å…¥ä¸€ä¸ªç”¨æˆ·åï¼Œåˆ¤æ–­ç”¨æˆ·çš„UIDå’ŒGID åˆ¤æ–­çš„æ–¹å¼ [root@wei shell]# grep \u0026ldquo;hei\u0026rdquo; /etc/passwd\nhei:x:1000:1000::/home/hei:/bin/bash\n[root@wei shell]# grep \u0026ldquo;hei\u0026rdquo; /etc/passwd | awk -F: \u0026lsquo;{print $3,$4}\u0026rsquo;\n1000 1000\n[root@wei shell]# id -u hei\n1000\n[root@wei shell]# id -g hei\n1000\nè„šæœ¬è¯­æ³• 1 2 3 4 5 6 7 8 9 10 11 #!/bin/bash # read -p \u0026#34;è¾“å…¥ç”¨æˆ·åï¼š\u0026#34; name user_id=$(id -u $name) group_id=$(id -g $name) if [ $user_id -eq $group_id ];then echo \u0026#34;Good\u0026#34; else echo \u0026#34;Bad\u0026#34; fi æ‰§è¡Œç»“æœ\n1 2 3 4 5 6 7 8 9 10 11 [root@wei shell]# bash id.shÂ è¾“å…¥ç”¨æˆ·åï¼šhei Good [root@wei shell]# id hei uid=1000(hei) gid=1000(hei) ç»„=1000(hei) [root@wei shell]# usermod -u 1200 hei [root@wei shell]# id hei uid=1200(hei) gid=1000(hei) ç»„=1000(hei) [root@wei shell]# bash id.shÂ è¾“å…¥ç”¨æˆ·åï¼šhei Bad ","date":"2019-03-17T20:00:00Z","image":"https://www.ownit.top/title_pic/52.jpg","permalink":"https://www.ownit.top/p/201903172000/","title":"Linux shell ifæ¡ä»¶åˆ¤æ–­1"},{"content":"å‰é¢ä»‹ç»ç®€å•çš„shellç¼–å†™è§„åˆ™ã€‚ ç°åœ¨å¼€å§‹ç¼–å†™ä¸€ä¸ªç®€å•çš„shellè„šæœ¬ã€‚ Linux shellä»‹ç» ç¼–å†™shellè„šæœ¬ 1.åˆ›å»ºè„šæœ¬æ–‡ä»¶\n2.æ ¹æ®éœ€æ±‚ï¼Œç¼–å†™è„šæœ¬\n3.æµ‹è¯•æ‰§è¡Œè„šæœ¬\nç¼–å†™è„šæœ¬ï¼Œå®ç°åˆ›å»ºç”¨æˆ·heiï¼Œç—…è®¾ç½®ç”¨æˆ·å¯†ç ä¸ºroot\n1 [root@wei shell]# vim user.sh 1 2 3 4 5 #!/bin/bash # æ³¨é‡Š useradd hei echo \u0026#34;root\u0026#34; | passwd --stdin hei \u0026amp;\u0026gt; /dev/null echo \u0026#34;heiç”¨æˆ·åˆ›å»ºå®Œæˆï¼Œé»˜è®¤å¯†ç æ˜¯ï¼šroot\u0026#34; æ‰§è¡Œæ–¹æ³•ï¼š\nï¼ˆ1ï¼‰åˆ©ç”¨bashæ‰§è¡Œ\n1 [root@wei shell]# bash user.shÂ ï¼ˆ2ï¼‰åŠ æƒé™ï¼Œåœ¨æ‰§è¡Œ\n1 2 [root@wei shell]# chmod a+x user.sh [root@wei shell]# ./user.shÂ å˜é‡åç¼–å†™ 1 [root@wei shell]# vim users.shÂ 1 2 3 4 5 6 7 8 #!/bin/bash name=wei passwd=root useradd $name echo \u0026#34;$passwd\u0026#34; | passwd --stdin $name \u0026amp;\u0026gt; /dev/null echo \u0026#34;ç”¨æˆ·$nameåˆ›å»ºå®Œæˆï¼Œé»˜è®¤å¯†ç æ˜¯ï¼š$passwd\u0026#34; è¾“å…¥å­—ç¬¦ 1 2 [root@wei shell]# read -p \u0026#34;è¾“å…¥æ•°å­—ï¼š\u0026#34; number è¾“å…¥æ•°å­—ï¼š99 1 2 3 4 5 6 7 8 #!/bin/bash # read -p \u0026#34;è¾“å…¥ç”¨æˆ·åï¼š\u0026#34; name read -p \u0026#34;è¾“å…¥å¯†ç ï¼š\u0026#34; passwd useradd $name echo \u0026#34;$name\u0026#34; | passwd --stdin $name \u0026amp;\u0026gt; /dev/null echo \u0026#34;ç”¨æˆ·$nameåˆ›å»ºå®Œæˆï¼Œå¯†ç æ˜¯ï¼š$passwd\u0026#34; ä»¥ä¸Šä¸‰ç§æ–¹æ³•éƒ½å¯ä»¥ã€‚","date":"2019-03-14T22:06:35Z","image":"https://www.ownit.top/title_pic/27.jpg","permalink":"https://www.ownit.top/p/201903142206/","title":"Linux shellç®€å•åˆ›å»ºç”¨æˆ·è„šæœ¬"},{"content":"Shell æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€ç¼–å†™çš„ç¨‹åºï¼Œå®ƒæ˜¯ç”¨æˆ·ä½¿ç”¨ Linux çš„æ¡¥æ¢ã€‚Shell æ—¢æ˜¯ä¸€ç§å‘½ä»¤è¯­è¨€ï¼Œåˆæ˜¯ä¸€ç§ç¨‹åºè®¾è®¡è¯­è¨€ã€‚\nShell æ˜¯æŒ‡ä¸€ç§åº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºæä¾›äº†ä¸€ä¸ªç•Œé¢ï¼Œç”¨æˆ·é€šè¿‡è¿™ä¸ªç•Œé¢è®¿é—®æ“ä½œç³»ç»Ÿå†…æ ¸çš„æœåŠ¡ã€‚\nKen Thompson çš„ sh æ˜¯ç¬¬ä¸€ç§ Unix Shellï¼ŒWindows Explorer æ˜¯ä¸€ä¸ªå…¸å‹çš„å›¾å½¢ç•Œé¢ Shellã€‚\nShell è„šæœ¬ Shell è„šæœ¬ï¼ˆshell scriptï¼‰ï¼Œæ˜¯ä¸€ç§ä¸º shell ç¼–å†™çš„è„šæœ¬ç¨‹åºã€‚\nä¸šç•Œæ‰€è¯´çš„ shell é€šå¸¸éƒ½æ˜¯æŒ‡ shell è„šæœ¬ï¼Œä½†è¯»è€…æœ‹å‹è¦çŸ¥é“ï¼Œshell å’Œ shell script æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µã€‚\nSHELL å˜é‡\nå˜é‡ï¼ˆå†…å­˜ç©ºé—´ï¼‰\nå¢åŠ è„šæœ¬çš„çµæ´»æ€§ï¼Œé€‚ç”¨æ€§\nç±»å‹ï¼š\nè‡ªå®šä¹‰å˜é‡\nç¯å¢ƒå˜é‡ï¼ˆPathï¼‰\nç‰¹æ®Šå˜é‡\nè‡ªå®šä¹‰å˜é‡\nå˜é‡åç§°è§„èŒƒï¼š\nå‘½ååªèƒ½ä½¿ç”¨è‹±æ–‡å­—æ¯ï¼Œæ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œé¦–ä¸ªå­—ç¬¦ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ã€‚ ä¸­é—´ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿ï¼ˆ_ï¼‰ã€‚ ä¸èƒ½ä½¿ç”¨æ ‡ç‚¹ç¬¦å·ã€‚ ä¸èƒ½ä½¿ç”¨bashé‡Œçš„å…³é”®å­—ï¼ˆå¯ç”¨helpå‘½ä»¤æŸ¥çœ‹ä¿ç•™å…³é”®å­—ï¼‰ã€‚ 1 å£°æ˜å˜é‡ # å˜é‡åç§°=å˜é‡å€¼\n1 [root@wei csdn]# name=wei 2 è°ƒç”¨å˜é‡çš„å€¼\n$å˜é‡åç§°\n${å˜é‡åç§°} å˜é‡åç§°æˆ–ç´§è·Ÿæ•°å­—ï¼Œå­—ç¬¦çš„æ—¶å€™\nè¾“å‡ºæ—¶ï¼Œç”±å˜é‡åï¼Œå¿…é¡»ç”¨åŒå¼•å·\n1 2 3 4 5 6 7 8 9 [root@wei csdn]# name=cat [root@wei csdn]# echo \u0026#34;this is $name\u0026#34; this is cat [root@wei csdn]# echo \u0026#34;this is ${name}\u0026#34; this is cat [root@wei csdn]# echo \u0026#34;this is ${name}s\u0026#34; this is cats 3 SHELLå˜é‡çš„å€¼é»˜è®¤å…¨åšä¸ºå­—ç¬¦å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 [root@wei csdn]# a=10 [root@wei csdn]# b=20 [root@wei csdn]# c=a+b [root@wei csdn]# echo $c a+b [root@wei csdn]# a=10 [root@wei csdn]# b=20 [root@wei csdn]# c=$a+$b [root@wei csdn]# echo $c 10+20 æ•°å­¦è¿ç®—ï¼š æ–¹æ³•1ï¼š$(())\n1 2 3 4 5 [root@wei csdn]# a=10 [root@wei csdn]# b=20 [root@wei csdn]# c=$((a+b)) [root@wei csdn]# echo $c 30 æ–¹æ³•2ï¼šå…³é”®å­—ï¼šlet\n1 2 3 4 5 [root@wei csdn]# a=10 [root@wei csdn]# b=20 [root@wei csdn]# let c=a+b [root@wei csdn]# echo $c 30 æ–¹æ³•3ï¼šå…³é”®å­—ï¼šdeclare\n1 2 3 4 5 [root@wei csdn]# a=10 [root@wei csdn]# b=20 [root@wei csdn]# declare -i c=a+b [root@wei csdn]# echo $c 30 æ•°å­¦è¿ç®—ç¬¦ï¼š\n+\n-\n*\n/ æ•´é™¤\n% å–ä½™\nç”Ÿæˆéšæœºæ•° 1 2 3 4 5 6 [root@wei csdn]# echo $RANDOMÂ 11400 [root@wei csdn]# echo $RANDOMÂ 9702 [root@wei csdn]# echo $RANDOMÂ 21328 ç”Ÿæˆ10ä»¥å†…çš„éšæœºæ•°ï¼š\n1 2 3 4 [root@wei csdn]# echo $((RANDOM%10)) 4 [root@wei csdn]# echo $((RANDOM%10)) 2 4 å‘½ä»¤å¼•ç”¨\nåå¼•å· `COMMAND`\n$(COMMAND)\n1 2 3 4 5 6 7 [root@wei csdn]# a=`ls -ldh /etc/` [root@wei csdn]# echo $a drwxr-xr-x. 77 root root 8.0K 3æœˆ 14 16:23 /etc/ [root@wei csdn]# b=$(ls -ldh /etc/) [root@wei csdn]# echo $b drwxr-xr-x. 77 root root 8.0K 3æœˆ 14 16:23 /etc/ æå–ip 1 2 [root@wei csdn]# ifconfig ens33 |grep \u0026#34;netmask\u0026#34; | awk \u0026#39;{print $2}\u0026#39; 192.168.196.131 1 2 3 4 [root@wei csdn]# head -n 3 /etc/passwd |awk -F: \u0026#39;{print $1,$6,$7}\u0026#39; root /root /bin/bash bin /bin /sbin/nologin daemon /sbin /sbin/nologin 5 åˆ é™¤å˜é‡\n# unset å˜é‡åç§°\nç¯å¢ƒå˜é‡ ï¼ˆ1ï¼‰æŸ¥çœ‹ç¯å¢ƒå˜é‡\n1 [root@wei csdn]# env | less ï¼ˆ2ï¼‰å®šä¹‰ç¯å¢ƒå˜é‡ï¼šä¿®æ”¹ç¯å¢ƒå˜é‡çš„å€¼\n#export å˜é‡åç§°=å˜é‡å€¼\n1 2 [root@wei csdn]# vim /etc/profile [root@wei csdn]# source /etc/profile $?åˆ¤æ–­ä¸Šä¸ªå‘½ä»¤çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆ0\u0026ndash;255ï¼‰\n0ï¼šä»£è¡¨æˆåŠŸ\nå…¶ä½™:ä»£è¡¨å¤±è´¥\n","date":"2019-03-14T20:16:52Z","image":"https://www.ownit.top/title_pic/44.jpg","permalink":"https://www.ownit.top/p/201903142016/","title":"Linux shellå˜é‡è¯¦è§£"},{"content":"shellæ˜¯ä¸€ä¸ªå‘½ä»¤è§£é‡Šå™¨ï¼Œå®ƒåœ¨æ“ä½œç³»ç»Ÿçš„æœ€å¤–å±‚ï¼Œè´Ÿè´£ç›´æ¥ä¸ç”¨æˆ·å¯¹è¯ï¼ŒæŠŠç”¨æˆ·çš„è¾“å…¥è§£é‡Šç»™æ“ä½œç³»ç»Ÿï¼Œå¹¶å¤„ç†å„ç§å„æ ·çš„æ“ä½œç³»ç»Ÿçš„è¾“å‡ºç»“æœï¼Œè¾“å‡ºåˆ°å±å¹•è¿”å›ç»™ç”¨æˆ·ã€‚è¿™ç§å¯¹è¯æ–¹å¼å¯ä»¥æ˜¯äº¤äº’çš„æ–¹å¼ï¼ˆä»é”®ç›˜è¾“å…¥å‘½ä»¤ï¼Œå¯ä»¥ç«‹å³å¾—åˆ°shellçš„å›åº”ï¼‰ï¼Œæˆ–éäº¤äº’ï¼ˆæ‰§è¡Œè„šæœ¬ç¨‹åºï¼‰çš„æ–¹å¼ã€‚\nä¸‹å›¾çš„é»„è‰²éƒ¨åˆ†å°±æ˜¯å‘½ä»¤è§£é‡Šå™¨shellå¤„äºçš„æ“ä½œç³»ç»Ÿä¸­ä½ç½®å½¢è±¡å›¾è§£ã€‚\nLinux SHELL è„šæœ¬ å¤§é‡é‡å¤æ‰§è¡Œçš„å·¥ä½œ\nshellï¼ˆLinuxå£³ï¼‰ï¼Œ ä¸€ç±»ç¨‹åºçš„åç§°\næ–‡æœ¬æ–‡ä»¶\u0026mdash;\u0026ndash;\u0026gt;shellå‘½ä»¤ï¼Œ/bin/bashæä¾›é€»è¾‘æ§åˆ¶è¯­å¥\né‡å®šå‘å‘ç¬¦å·çš„ä½¿ç”¨\n/dev/stdin æ ‡å‡†è¾“å…¥è®¾å¤‡ï¼ˆé”®ç›˜ï¼‰ 0\n/dev/stdout æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼ˆæ˜¾ç¤ºå™¨ï¼‰ 1\n/dev/stderr æ ‡å‡†é”™è¯¯è¾“å‡ºè®¾å¤‡ï¼ˆæ˜¾ç¤ºå™¨ï¼‰ 2\nè¾“å‡ºé‡å®šå‘ç¬¦å·\n\u0026gt; è¦†ç›–åŸæ–‡ä»¶ä¿¡æ¯\n\u0026raquo; å¾€åŸæ–‡ä»¶åé¢è¿½åŠ ç±»å®¹\n\u0026gt; \u0026raquo; ç”¨äºé‡å®šå‘æ ‡å‡†è¾“å‡º\n1 2 [root@wei ~]# ls -ldh /etc/ /tmp/1.txt [root@wei ~]# ls -ldh /tmp/ \u0026gt;\u0026gt;/tmp/1.txtÂ 2\u0026gt; 2\u0026raquo; ç”¨äºé‡å®šå‘æ ‡å‡†é”™è¯¯è¾“å‡º\n1 [root@wei ~]# ls -ldh /qwertyuasdfgh 2\u0026gt; /tmp/1.txt \u0026amp;\u0026gt; åŒæ—¶é‡å®šå‘æ ‡å‡†è¾“å‡ºåŠæ ‡å‡†é”™è¯¯è¾“å‡º\nç‰¹æ®Šè®¾å¤‡æ–‡ä»¶ï¼š/dev/null ï¼ˆåƒåœ¾ç«™ï¼‰\n1 2 [root@wei ~]# ls -ldh /etc/ \u0026amp;\u0026gt;/dev/nullÂ [root@wei ~]# grep \u0026#34;root\u0026#34; /etc/passwd \u0026amp;\u0026gt; /dev/nullÂ è¾“å…¥é‡å®šå‘ç¬¦å·\n1 2 3 4 [root@wei ~]# cat /tmp/1.txtÂ chengfeng [root@wei ~]# tr \u0026#39;a-z\u0026#39; \u0026#39;A-Z\u0026#39; \u0026lt; /tmp/1.txtÂ CHENGFENG è¾“å‡ºä¿¡æ¯ï¼š\n1 echo 1 2 3 4 5 6 7 8 9 10 11 12 13 [root@wei ~]# echo \u0026#34;è¯·è¾“å‡ºä½ çš„é€‰æ‹©\u0026#34; #é»˜è®¤ä¼šæ‰“å°æ¢è¡Œç¬¦ è¯·è¾“å‡ºä½ çš„é€‰æ‹© [root@wei ~]# echo -n \u0026#34;è¯·è¾“å‡ºä½ çš„é€‰æ‹©\u0026#34; è¯·è¾“å‡ºä½ çš„é€‰æ‹©[root@wei ~]#Â [root@wei ~]# echo -e \u0026#34;a\\nbb\\nccc\u0026#34; # \\n å›è½¦ a bb ccc [root@wei ~]# echo -e \u0026#34;a\\tbb\\tccc\u0026#34; # \\t tabé”® aÂ bbÂ ccc 2 printf\n1 2 [root@wei ~]# printf \u0026#34;hello wowrd\u0026#34; hello wowrd[root@wei ~]#Â 3 HERE DOCUMENT -\u0026mdash;-\u0026gt;è¾“å‡ºå¤šè¡Œä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 [root@wei ~]# cat \u0026lt;\u0026lt; eof ï¼ˆeofä¸ºæç¤ºç¬¦ï¼Œå¯ä»¥ä»»æ„å®šä¹‰ï¼‰ \u0026gt; é€‰æ‹© \u0026gt; å®‰è£… \u0026gt; é‡å¯ \u0026gt; å…³æœº \u0026gt; eof é€‰æ‹© å®‰è£… é‡å¯ å…³æœº åŒå¼•å·å’Œå•å¼•å·çš„åŒºåˆ«ï¼š å•å¼•å·ï¼šæ‰€æœ‰å­—ç¬¦ä¼šå¤±å»åŸæœ‰çš„å«ä¹‰\nåŒå¼•å·ï¼šç‰¹æ®Šçš„å­—ç¬¦ä¼šè½¬ä¹‰\nå¦‚ä½•äº¤äº’å‘½ä»¤: 1 2 3 [root@wei ~]# echo \u0026#34;root\u0026#34; | passwd --stdin hei \u0026amp;\u0026gt; /dev/null [root@wei ~]# echo -e \u0026#34;n\\rp\\r1\\r+100M\\rw\\r\u0026#34; | fdisk /dev/vdb \u0026amp;\u0026gt; /dev/nullÂ æ˜¾ç¤ºå†å²å‘½ä»¤\n1 [root@wei ~]# history æ‰§è¡Œå†å²å‘½ä»¤çš„æŸä¸€æ¡\n1 [root@wei ~]# !254 æ¸…ç©ºå†å²å‘½ä»¤\n1 [root@wei ~]# history -c ","date":"2019-03-12T22:28:21Z","image":"https://www.ownit.top/title_pic/35.jpg","permalink":"https://www.ownit.top/p/201903122228/","title":"Linux shellä¹‹é‡å®šå‘è¾“å…¥ï¼Œè¾“å‡º"},{"content":"åœ¨æœåŠ¡æ­å»ºå‰ï¼Œè¿˜è¦äº†è§£ä¸€ä¸‹httpdçš„æ—¥å¿—ã€‚\næ—¥å¿—æœ‰åŠ©æœ‰å·¥ä½œäººå‘˜ï¼ŒæŸ¥çœ‹æœåŠ¡å™¨å‡ºé”™çŠ¶å†µï¼Œæ›´èƒ½ç»Ÿè®¡æ•°æ®åˆ†æç½‘é¡µè¿è¡Œæƒ…å†µã€‚\nPVå’ŒUVä¸¤å¤§åˆ†æ PV Page View é¡µé¢è®¿é—®é‡ UV User View ç”¨æˆ·è®¿é—®é‡\n1)æŒ‡å®šé”™è¯¯æ—¥å¿—çš„åç§°åŠçº§åˆ«\né”™è¯¯æ—¥å¿—çš„è·¯å¾„ï¼š/var/log/httpd/error_log\né”™è¯¯çº§åˆ«ï¼š debug, info, notice, warn, error, crit\nè®¿é—®æ—¥å¿—ï¼š /var/log/httpd/access_log\n1 [root@wei httpd]# head -n 1 /var/log/httpd/access_log ï¼ˆ2ï¼‰å®šä¹‰è®¿é—®æ—¥å¿—çš„æ ¼å¼\nLogFormat \u0026ldquo;%h %l %u %t \\\u0026rdquo;%r\\\u0026quot; %\u0026gt;s %b \\\u0026quot;%{Referer}i\\\u0026quot; \\\u0026quot;%{User-Agent}i\\\u0026quot;\u0026quot; combined\n1 192.168.196.1 - - [07/Mar/2019:05:33:39 +0800] \u0026#34;GET / HTTP/1.1\u0026#34; 200 1766 \u0026#34;-\u0026#34; \u0026#34;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.119 Safari/537.36\u0026#34; %h è¿œç«¯ä¸»æœº\n%l è¿œç«¯ç™»å½•å(ç”±identdè€Œæ¥ï¼Œå¦‚æœæ”¯æŒçš„è¯)ï¼Œé™¤éIdentityCheckè®¾ä¸º\u0026quot;On\u0026quot;ï¼Œå¦åˆ™å°†å¾—åˆ°ä¸€ä¸ª\u0026quot;-\u0026quot;ã€‚\n%u è¿œç¨‹ç”¨æˆ·å(æ ¹æ®éªŒè¯ä¿¡æ¯è€Œæ¥ï¼›å¦‚æœè¿”å›status(%s)ä¸º401ï¼Œå¯èƒ½æ˜¯å‡çš„)\n%t æ—¶é—´ï¼Œç”¨æ™®é€šæ—¥å¿—æ—¶é—´æ ¼å¼(æ ‡å‡†è‹±è¯­æ ¼å¼)\n%r è¯·æ±‚çš„ç¬¬ä¸€è¡Œ\n%\u0026gt;s:HTTPçŠ¶æ€ç \n%b ä»¥CLFæ ¼å¼æ˜¾ç¤ºçš„é™¤HTTPå¤´ä»¥å¤–ä¼ é€çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå°±æ˜¯å½“æ²¡æœ‰å­—èŠ‚ä¼ é€æ—¶æ˜¾ç¤ºâ€™-\u0026lsquo;è€Œä¸æ˜¯0ã€‚\n%{Referer}iï¼šè®°å½•è¶…é“¾æ¥åœ°å€\n%{User-Agent}iï¼šè®°å½•å®¢æˆ·ç«¯çš„æµè§ˆå™¨ç±»å‹\nï¼ˆ3ï¼‰æŒ‡å®šè®¿é—®æ—¥å¿—çš„åç§°åŠæ ¼å¼\nCustomLog \u0026ldquo;logs/access_log\u0026rdquo; combined\nè™šæ‹Ÿä¸»æœº VirtualHost ä½œç”¨ï¼šåœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šè¿è¡Œå¤šä¸ªç½‘ç«™\nç±»å‹ï¼š\nåŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœºï¼ˆå¸¸ç”¨ï¼‰\nåŸºäºIPåœ°å€çš„è™šæ‹Ÿä¸»æœº\nåŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº\né…ç½®è™šæ‹Ÿä¸»æœº\n1 2 3 4 5 6 7 \u0026lt;VirtualHost 10.1.2.3:80\u0026gt; ServerAdmin webmaster@host.example.com DocumentRoot /www/docs/host.example.com ServerName host.example.com ErrorLog logs/host.example.com-error_log TransferLog logs/host.example.com-access_log \u0026lt;/VirtualHost\u0026gt; ç¤ºä¾‹ï¼šåŸºäºä¸»æœºåçš„è™šæ‹Ÿä¸»æœº\nwww.a.org ç½‘é¡µç›®å½•ï¼š/var/www/html/a.org æ—¥å¿—ï¼š/var/log/httpd/a.org\nwww.a.org (1)å‡†å¤‡ç›®å½•\n1 2 3 [root@wei ~]# mkdir /var/www/html/a.org [root@wei ~]# vim /var/www/html/a.org/index.html [root@wei ~]# mkdir /var/log/httpd/a.org ï¼ˆ2ï¼‰ç¼–å†™é…ç½®æ–‡ä»¶\n1 [root@wei ~]# vim /etc/httpd/conf.d/a.org.conf 1 2 3 4 5 6 7 \u0026lt;VirtualHost 192.168.196.132:80\u0026gt; DocumentRoot /var/www/html/a.org ServerName www.a.org ErrorLog /var/log/httpd/a.org/error_log CustomLog /var/log/httpd/a.org/access_log combined \u0026lt;/VirtualHost\u0026gt; ï¼ˆ3ï¼‰æ£€æµ‹é…ç½®æ–‡ä»¶è¯­æ³•\n1 [root@wei ~]# httpd -t ï¼ˆ4ï¼‰é‡å¯æœåŠ¡\n1 [root@wei ~]# systemctl restart httpd ","date":"2019-03-12T19:30:27Z","image":"https://www.ownit.top/title_pic/59.jpg","permalink":"https://www.ownit.top/p/201903121930/","title":"Linuxçš„httpdæœåŠ¡æ­å»º"},{"content":"è½¯ä»¶ä»‹ç»\nå®¢æˆ·ç«¯ä»£ç†è½¯ä»¶\nIEï¼Œfirefoxï¼Œchroomeï¼Œopera\næœåŠ¡å™¨ç«¯è½¯ä»¶\nhttpdï¼ŒNginxï¼ŒTengineï¼ŒISSï¼ŒLighthttp\nåº”ç”¨ç¨‹åºæœåŠ¡å™¨\nISSï¼ŒTomcatï¼ˆJSPï¼Œopen sourecï¼‰ï¼ŒWebsphereï¼ˆIBMï¼ŒJSPï¼Œcommodityï¼‰Weblogic(oracle,JSP,commodity)\nJBoss(redhat,JSP),Resin,php\nhttpdå®‰è£…åŠé…ç½®\nASFï¼šApache Software Foundation http://www.apache.org/\nweb:httpd\nTomcat\nHadoop\nhttpd: http://httpd.apache.org/\nWeb Server,Open Sourec\n2.4,2.2,2.0\nhttpdè½¯ä»¶å®‰è£…:\nrpm\næºç è½¯ä»¶\nhttpdç‰¹æ€§:\näº‹å…ˆåˆ›å»ºè¿›ç¨‹\næŒ‰éœ€ç»´æŒé€‚å½“çš„è¿›ç¨‹\næ¨¡å—åŒ–è®¾è®¡ï¼Œæ ¸å¿ƒè¾ƒå°ï¼Œå„ç§åŠŸèƒ½éƒ½èƒ½é€šè¿‡æ¨¡å—æ·»åŠ :æ¨¡å—å¯ä»¥åœ¨è¿è¡Œæ—¶å¯ç”¨\næ”¯æŒè¿è¡Œé…ç½®ï¼Œæ”¯æŒå•ç‹¬ç¼–è¯‘æ¨¡å—\næ”¯æŒå¤šç§è™šæ‹Ÿä¸»æœºçš„é…ç½®\nåŸºäºIPçš„è™šæ‹Ÿä¸»æœº\nåŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº\nåŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº\næ”¯æŒhttpsåè®®(mod_ ss1)\næ”¯æŒç”¨æˆ·è®¤è¯\næ”¯æŒåŸºäºIPæˆ–ä¸»æœºåçš„è®¿é—®æ§åˆ¶æœºåˆ¶\næ”¯æŒæ¯ç›®å½•çš„è®¿é—®æ§åˆ¶\næ”¯æŒURLé‡å†™\nå®‰è£…httpdè½¯ä»¶\n1 [root@wei ~]# yum install -y httpd å¼€å¯æœåŠ¡\n1 [root@wei ~]# systemctl start httpd å¼€æœºè‡ªå¯\n1 [root@wei ~]# systemctl enable httpd æŸ¥çœ‹ç«¯å£å·\n1 [root@wei ~]# ss -antp |grep httpd æŸ¥çœ‹å®ƒå¯åŠ¨çš„è¿›ç¨‹\n1 [root@wei ~]# ps aux|grep httpd httpdç›®å½•:\n**Â /etc/httpd/ conf ä¸»é…ç½®æ–‡ä»¶ httpd. conf\n/etc/httpd/conf.d/* . conf å­é…ç½®æ–‡ä»¶\n/var/log/httpd æ—¥å¿—\naccess_ .log è®¿é—®æ—¥å¿—\nerror_ log é”™è¯¯æ—¥å¿—**\n**Â /var/www/html é»˜è®¤é™æ€é¡µé¢çš„ç›®å½•\n/var/www/cgi-bin é»˜è®¤åŠ¨æ€é¡µé¢çš„ç›®å½•**\nCGI: Comnon Gateway Interfaceé€šç”¨ç½‘å…³æ¥å£\nè®©webæœåŠ¡å™¨å¯åŠ¨æŸåº”ç”¨ç¨‹åºè§£æåŠ¨æ€é¡µé¢çš„æœºåˆ¶å¼€å‘åŠ¨æ€ç½‘é¡µçš„è¯­è¨€:\nperl, python, java (Servlet JSP), php\n**Â PHP LAMP , LNMP\nJSP Tomcat, Weblogical\nPython mod_ wsgiæ¨¡å—**\n**Â httpdé…ç½®æ–‡ä»¶Â \u0026mdash;- /etc/httpd/conf/httpd.conf ;**\ndiretive value\næŒ‡ä»¤ä¸åŒºåˆ†å¤§å°å†™\nvalueåŒºåˆ†å¤§å°å†™\n1ï¼‰è®¾ç½®httpdçš„ä¸»ç›®å½•\n**ServerRoot \u0026ldquo;/etc/httpd\u0026rdquo;Â **\n2ï¼‰ç›‘å¬ipçš„åœ°å€å’Œç«¯å£\n**Â #Listen 12.34.56.78:80\nListen 80\n3ï¼‰æŒ‡å®šå­é…ç½®æ–‡ä»¶çš„è·¯å¾„åŠåç§°**\n**Â Include conf.modules.d/*.conf**\n4)è®¾ç½®è¿è¡Œhttpdè¿›ç¨‹çš„ç”¨æˆ·åŠç”¨æˆ·ç»„åç§°\nUser apache\nGroup apache\n5)é•¿è¿æ¥ç›¸å…³çš„é…ç½®\nKeepAlive on\nMaxKeepAliveRequests 100\nKeepAliveTimeout 15\n6)è®¾ç½®ç®¡ç†å‘˜çš„é‚®ç®±\nServerAdmin root@localhost\n7)è®¾ç½®ç½‘ç«™çš„ä¸»æœºå\nServerName www.a. org\n8)è®¾ç½®ç½‘é¡µç›®å½•\n**DocumentRoot \u0026ldquo;/var/www/html\u0026rdquo;Â **\n9)è®¾ç½®ç½‘é¡µçš„é¦–é¡µåç§°\nDirectoryIndex index. html\n10ï¼‰é’ˆå¯¹ç›®å½•æƒé™\n\u0026lt;Directory \u0026ldquo;/var/www/html\u0026rdquo;\u0026gt;\nOptions Indexes FollowSymLinks\nAllowOverride None\nRequire all granted\n\u0026lt;/Directory\u0026gt;\nAï¼‰ Require all granted\nå…è®¸æ‰€æœ‰çš„å®¢æˆ·ç«¯è®¿é—®è¯¥ç›®å½•çš„é¡µé¢æ–‡ä»¶\nBï¼‰Options Indexes FollowSymLinks\nå®šä¹‰ç›®å½•ä¸‹çš„ç½‘é¡µæ–‡ä»¶è¢«è®¿é—®æ—¶çš„è®¿é—®å±æ€§\nNoneï¼šä¸æ”¯æŒä»»ä½•é€‰é¡¹\nIndexesï¼šæ— index.html æ—¶ï¼Œåˆ—å‡ºæ‰€æœ‰çš„æ–‡ä»¶ï¼Œç¦ç”¨\nFollowSymLinksï¼šå­˜åœ¨è½¯é“¾æ¥ç½‘é¡µæ–‡ä»¶æ—¶ï¼Œæ˜¯å¦åªå¯ä»¥è®¿é—®å¯¹åº”åŸç½‘é¡µæ–‡ä»¶çš„å†…å®¹ï¼Œç¦ç”¨\nSymLinksifOwnerMatch:å…è®¸è®¿é—®è½¯é“¾æ¥ï¼Œä½†æ‰€å±å¿…é¡»å’Œè¿è¡Œhttpdè¿›ç¨‹çš„æ‰€å±ä¸€è‡´\nIncludes:å…è®¸æ‰§è¡ŒæœåŠ¡å™¨ç«¯åŒ…å«(SSIæ ¼å¼çš„ç½‘é¡µæ–‡ä»¶)ï¼Œç¦ç”¨\nExeCGI:å…è®¸è¿è¡ŒCGIè„šæœ¬\nMultiviews:å†…å®¹åå•†æœºåˆ¶(æ ¹æ®å®¢æˆ·ç«¯çš„è¯­è¨€ä¸åŒæ˜¾ç¤ºä¸åŒçš„ç½‘é¡µ)ï¼Œå¤šè§†å›¾:ç¦ç”¨\nA11:å¯ç”¨æ‰€æœ‰é€‰é¡¹\nCï¼‰Allowoverride None\n**Â æ˜¯å¦å…è®¸å»ºç«‹.htaccessæ–‡ä»¶è¦†ç›–ææƒé…ç½®**\næŸ¥çœ‹å¸®åŠ©æ‰‹å†Œ\n[root@wei csdn]# yum -y install httpd-manual\nhttp://192.168.196.131/manual/\næ”¯æŒç”¨æˆ·è®¤è¯\nç¤ºä¾‹ï¼šå®¢æˆ·ç«¯é€šè¿‡ç”¨æˆ·heiè®¿é—®é¦–é¡µï¼ˆ/var/www/htmlï¼‰ (1)åˆ›å»ºç”¨æˆ·åç§°å’Œå¯†ç \n1 2 3 4 [root@wei ~]# htpasswd -c /etc/httpd/.webuser hei New password:Â Re-type new password:Â Adding password for user hei ï¼ˆ2ï¼‰ç¼–è¾‘é…ç½®æ–‡ä»¶\n1 [root@wei ~]# vim /etc/httpd/conf/httpd.conf 1 2 3 4 5 6 7 8 9 10 11 \u0026lt;Directory \u0026#34;/var/www/html\u0026#34;\u0026gt; Options Indexes FollowSymLinks AllowOverride AuthConfig AuthType Basic AuthName \u0026#34;Resttrict test\u0026#34; AuthUserFile /etc/httpd/.webuser Require valid-user #Require user ç”¨æˆ·åç§° åªå…è®¸æŒ‡å®šç”¨æˆ·è®¿é—® \u0026lt;/Directory\u0026gt; æ£€æµ‹é…ç½®æ–‡ä»¶è¯­æ³•\n1 2 3 4 [root@wei ~]# httpd -t Syntax OK (3)é‡å¯æœåŠ¡\n1 [root@wei ~]# systemctl restart httpd ï¼ˆ4ï¼‰å†æ¬¡åˆ›å»ºä¸€ä¸ªç”¨æˆ·wei\nåˆ›å»ºç”¨æˆ·åç§°å’Œå¯†ç \n1 2 3 4 5 [root@wei ~]# htpasswd /etc/httpd/.webuser wei [root@wei ~]# cat /etc/httpd/.webuserÂ hei:$apr1$nBaKumC0$lsSLO6LqDQ58CWLjXIfJT0 wei:$apr1$ovl.gsGg$SHvY5Aksj9MdZv9u8E5XF1 åŸºäºå®¢æˆ·ç«¯ipåœ°å€çš„è®¤è¯\n1) å…è®¸æ‰€æœ‰å–œæˆ·ç«¯è®¿é—®\n**Â Require all granted**\n2)æ‹’ç»æ‰€æœ‰ç«¯è®¿é—®\n**Â Require al1 denied3)ä»…å…è®¸æŸä¸»æœºè®¿é—®**\n**Â Require ip 192.168.1.14) æ˜ç¡®æ‹’ç»æŸä¸»æœºè®¿é—®**\n**Â \u0026lt;RequireAll\u0026gt; Require all granted\nRequire not ip 192.168.96.1\n\u0026lt;/RequireAll\u0026gt;\nwindosè®¿é—®æ•ˆæœå›¾**\n**Â æ£€æµ‹é…ç½®æ–‡ä»¶è¯­æ³•\n[root@wei ~]# httpd -t**\nSyntax OK\né‡å¯æœåŠ¡\n**[root@wei ~]# systemctl restart httpd\n**\n","date":"2019-03-08T21:48:28Z","image":"https://www.ownit.top/title_pic/65.jpg","permalink":"https://www.ownit.top/p/201903082148/","title":"Linuxçš„httpdæœåŠ¡ä»‹ç»å’Œéƒ¨ç½²"},{"content":"webï¼ˆWorld Wide Webï¼‰å³å…¨çƒå¹¿åŸŸç½‘ï¼Œä¹Ÿç§°ä¸ºä¸‡ç»´ç½‘ï¼Œå®ƒæ˜¯ä¸€ç§åŸºäºè¶…æ–‡æœ¬å’ŒHTTPçš„ã€å…¨çƒæ€§çš„ã€åŠ¨æ€äº¤äº’çš„ã€è·¨å¹³å°çš„åˆ†å¸ƒå¼å›¾å½¢ä¿¡æ¯ç³»ç»Ÿã€‚æ˜¯å»ºç«‹åœ¨Internetä¸Šçš„ä¸€ç§ç½‘ç»œæœåŠ¡ï¼Œä¸ºæµè§ˆè€…åœ¨Internetä¸ŠæŸ¥æ‰¾å’Œæµè§ˆä¿¡æ¯æä¾›äº†å›¾å½¢åŒ–çš„ã€æ˜“äºè®¿é—®çš„ç›´è§‚ç•Œé¢ï¼Œå…¶ä¸­çš„æ–‡æ¡£åŠè¶…çº§é“¾æ¥å°†Internetä¸Šçš„ä¿¡æ¯èŠ‚ç‚¹ç»„ç»‡æˆä¸€ä¸ªäº’ä¸ºå…³è”çš„ç½‘çŠ¶ç»“æ„\nç½‘é¡µç±»å‹ï¼š\né™æ€ç½‘é¡µ HTMLè¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ *.html\nåŠ¨æ€ç½‘ç«™\nç±»ä¼¼äºè„šæœ¬æ–‡ä»¶ï¼Œæ ¹æ®ä¼ é€’çš„å‚æ•°ä¸åŒï¼Œè¿”å›çš„é¡µé¢ç»“æœä¸åŒçš„\nPHP *.php\nJava(JSP) *.jsp\nPython(Djangoæ¨¡å—)*.wsgi\nHTTP\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;-HyperText Transfer Protocol è¶…æ–‡æœ¬ä¼ è¾“åè®®\nHTTP/0.9ï¼šä»…çº¯æ–‡æœ¬ï¼ˆè¶…é“¾æ¥ï¼‰ï¼ŒASCLL\nHTTP ï¼šHyperText Mark Language è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€\n\u0026lt;h1\u0026gt;I am cehngfneg.\u0026lt;/h1\u0026gt;\nHTTP/1.0\nMIMEæœºåˆ¶ï¼šMultipurpose Internet Mail Extensionsï¼Œå¤šç”¨é€”äº’è”ç½‘é‚®ä»¶æ‰©å±•\nå°†éæ–‡æœ¬æ•°æ®åœ¨ä¼ è¾“å‰é‡æ–°ç¼–ç ä¸ºæ–‡æœ¬æ ¼å¼å†ä¼ è¾“ï¼Œæ¥æ”¶æ–¹èƒ½å¤Ÿç”¨ç›¸åçš„æ–¹å¼å°†å…¶è¿˜åŸæˆä»¥å‰çš„æ ¼å¼ï¼Œè¿˜èƒ½å¤Ÿè°ƒç”¨ç›¸åº”çš„ç¨‹åºæ‰“å¼€æ­¤æ–‡ä»¶\nç¼“å­˜æœºåˆ¶\nHTTP/1.1ï¼ˆæ— çŠ¶æ€è¿æ¥ï¼‰\nå¢å¼ºäº†ç¼“å­˜æœºåˆ¶çš„ç®¡ç†\né•¿è¿æ¥keepaliveæœºåˆ¶\nè¶…æ—¶æ—¶é—´\næ¯ä¸ªé•¿è¿æ¥è¯·æ±‚æ–‡ä»¶ä¸ªæ•°çš„é™åˆ¶\nHTTPæŠ¥æ–‡ï¼šè¯·æ±‚æŠ¥æ–‡ï¼Œå“åº”æŠ¥æ–‡\nHTTPè¯·æ±‚æŠ¥æ–‡è¯­æ³•ï¼š\n\u0026lt;method\u0026gt;\u0026lt;request-URL\u0026gt;\u0026lt;version\u0026gt;\n\u0026lt;headers\u0026gt;\n\u0026lt;entity-body\u0026gt;\nè¯·æ±‚æŠ¥æ–‡ï¼š\nGET /1.gif HTTP/1.1\nHost:www.bj.com\nConnection:keep-alive\nHTTPæ–¹æ³•ï¼š\nGETï¼ŒPUTï¼ŒPOSTï¼ŒDELETEï¼ŒHEAD\nURIï¼šUniform Resource Identifierï¼Œç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ /.jpg\nå…¨å±€èŒƒå›´å†…ï¼Œå”¯ä¸€æ ‡è¯†æŸä¸ªèµ„æºçš„åç§°\nç»Ÿä¸€ï¼šè·¯å¾„æ ¼å¼ä¸Šçš„ç»Ÿä¸€\nURLï¼šUniform Resource Locator ç»Ÿä¸€èµ„æºå®šä½ç¬¦\nprotocal://Host:Port/path/to/file\nhttp://192.168.1.1/1.jpg\nhttp://192.168.1.1:8000/1.jpg\nHTTPå“åº”æŠ¥æ–‡è¯­æ³•ï¼š\n\u0026lt;version\u0026gt;\u0026lt;status\u0026gt;\u0026lt;reason-phrase\u0026gt;\n\u0026lt;headers\u0026gt;\n\u0026lt;entity-body\u0026gt;\n**Â çŠ¶æ€ä»£ç :\n1xx:çº¯ä¿¡æ¯\n2xx:æˆåŠŸç±»ä¿¡æ¯\n3xX:é‡å®šå‘ç±»ä¿¡æ¯I\n301:æ°¸ä¹…é‡å®šå‘\n302:ä¸´æ—¶é‡å®šå‘\n304: not-modified, ä½¿ç”¨ç¼“å­˜çš„å†…å®¹å“åº”å®¢æˆ·ç«¯\n4xx:å®¢æˆ·ç«¯é”™è¯¯ç±»ä¿¡æ¯\n5xx:æœåŠ¡å™¨ç«¯é”™è¯¯ç±»ä¿¡æ¯**\nå“åº”æŠ¥æ–‡:\nHTTP/1.1 200 OK\nX-Powerd=By: PHP/5.2.17\nvary: Accept-Encoding, Cookie, User-Agent\nCache-Control: max-age=3, must-revalidate\nContent-Encoding: gzip\nContent -Length: 6931\nä¸Šé¢ä¸¤ä¸ªæŠ¥æ–‡çš„ç¬¬ä¸€ è¡Œé€šå¸¸ç§°ä¸ºæŠ¥æ–‡çš„â€œèµ·å§‹è¡Œ(start line)\u0026quot;; åé¢çš„æ ‡ç­¾æ ¼å¼ç§°ä¸ºæŠ¥æ–‡é¦–éƒ¨åŸŸ(Header\nfield)ï¼Œæ¯ä¸ªé¦–éƒ¨åŸŸéƒ½ç”±åç§°(name)å’Œå€¼(value)ç»„æˆï¼Œä¸­é—´ç”¨é€—å·åˆ†éš”ã€‚å¦å¤–ï¼Œå“åº”æŠ¥æ–‡é€šå¸¸è¿˜æœ‰- - ä¸ªç§°ä½œBodyçš„ä¿¡æ¯ä¸»ä½“ï¼Œå³å“åº”ç»™å®¢æˆ·ç«¯çš„å†…å®¹\nwebæœåŠ¡å™¨çš„ä¸»è¦æ“ä½œ:\n1ã€å»ºç«‹è¿æ¥\u0026mdash;-æ¥å—æˆ–æ‹’ç»å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚\n2ã€æ¥æ”¶è¯·æ±‚\u0026mdash;-é€šè¿‡ç½‘ç»œè¯»å–HTTPè¯·æ±‚æŠ¥æ–‡\n3ã€å¤„ç†è¯·æ±‚\u0026mdash;-è§£æè¯·æ±‚æŠ¥æ–‡å¹¶åšå‡ºç›¸åº”çš„åŠ¨ä½œ\n4ã€è®¿é—®èµ„æº\u0026mdash;-è®¿é—®è¯·æ±‚æŠ¥æ–‡ä¸­æ‰€è¯·æ±‚çš„èµ„æº\n5ã€æ„å»ºå“åº”\u0026mdash;-ä½¿ç”¨æ­£ç¡®çš„é¦–éƒ¨ç”ŸæˆHTTPå“åº”æŠ¥æ–‡\n6ã€å‘é€å“åº”\u0026mdash;-å‘å®¢æˆ·ç«¯å‘é€ç”Ÿæˆçš„å“åº”æŠ¥æ–‡\n7ã€è®°å½•æ—¥å¿—\u0026mdash;-å½“å·²ç»å®Œæˆçš„HTTPäº‹åŠ¡è®°å½•è¿›æ—¥å¿—æ–‡ä»¶\nwebæœåŠ¡å™¨å“åº”å¹¶å‘è¿æ¥(qps\u0026ndash;\u0026gt; query per second) çš„æ–¹å¼:\n1ã€å•è¿›ç¨‹/å•çº¿ç¨‹æœºåˆ¶\nä¾æ¬¡å¤„ç†æ¯ä¸ªè¯·æ±‚\n2ã€å¤šè¿›ç¨‹/å¤šçº¿ç¨‹æœºåˆ¶(ç¨³å®š)\næ¯ä¸ªè¯·æ±‚ç”Ÿæˆå­è¿›ç¨‹å“åº”\n3ã€ä¸€ä¸€ä¸ªè¿›ç¨‹å“åº”å¤šä¸ªè¯·æ±‚(å•è¿›ç¨‹å¤šçº¿ç¨‹)\näº‹ä»¶é©±åŠ¨æœºåˆ¶\né€šçŸ¥æœºåˆ¶\n4ã€å¤šè¿›ç¨‹å“åº”å¤šä¸ªè¯·æ±‚\n","date":"2019-03-06T20:26:44Z","image":"https://www.ownit.top/title_pic/18.jpg","permalink":"https://www.ownit.top/p/201903062026/","title":"Linuxçš„webæœåŠ¡çš„ä»‹ç»"},{"content":"ä¸‹é¢çš„éƒ¨ç½²æ˜¯åœ¨Linuxçš„DNSæ­£å‘è§£æéƒ¨ç½²ä¸Šè¿›è¡Œä¿®æ”¹çš„ã€‚\nå¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜æˆ–è€…é”™è¯¯ï¼Œå¯ä»¥è®¿é—®ä¸Šç¯‡å¸–å­\nä¸‹é¢å¼€å§‹æœ‰å…³DNSçš„æœåŠ¡éƒ¨ç½²ã€‚\u0026lt;DNSä¸»ä»æœåŠ¡å™¨\u0026gt;\nç¯å¢ƒæè¿°ï¼š\n192.168.196.132 DNSä¸»æœåŠ¡å™¨\n192.168.196.131 DNSä»æœåŠ¡å™¨\nå°†ä¸»æœåŠ¡å™¨çš„ä¸Šçš„wei.comåŒºåŸŸçš„è®°å½•ä¸ä»æœåŠ¡å™¨åŒæ­¥\nä¸»æœåŠ¡å™¨ï¼š ï¼ˆ1ï¼‰ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶named.conf\n1 [root@wei named]# vim /var/named/chroot/etc/named.confÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 options { directory \u0026#34;/var/named\u0026#34;; }; zone \u0026#34;wei.com\u0026#34; { type master; allow-transfer { 192.168.196.131;}; \u0026gt;\u0026gt;\u0026gt;æŒ‡å®šä»æœåŠ¡å™¨çš„IP file \u0026#34;wei.com.zone\u0026#34;; }; zone \u0026#34;1.168.192.in-addr.arpa\u0026#34; { type master; file \u0026#34;192.168.1.zone\u0026#34;; }; ï¼ˆ2ï¼‰ç¼–è¾‘wei.comçš„åŒºåŸŸçš„è®°å½•æ–‡ä»¶ï¼Œæ·»åŠ ä»æœåŠ¡å™¨çš„NSè®°å½•\n1 [root@wei named]# vim /var/named/chroot/var/named/wei.com.zoneÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $TTL 1D @ IN SOA wei.com. 123456.qq.com. ( 0 ; serial 1D ; refresh 1H ; retry 1W ; expire 3H ) ; minimum NS dns01.wei.com. NS dns02.wei.com. dns01 A 192.168.196.132 dns02 A 192.168.196.131 web A 192.168.1.1 web A 192.168.1.11 wei.com. A 192.168.1.1 *.wei.com. A 192.168.1.1 ftp A 192.168.1.2 MX 10 mail.wei.com. mail A 192.168.1.3 ï¼ˆ3ï¼‰é‡å¯æœåŠ¡\n1 2 3 [root@wei named]# systemctl restart named-chroot [root@wei named]# systemctl restart named ä»æœåŠ¡å™¨ï¼š\nï¼ˆ1ï¼‰å®‰è£…è½¯ä»¶\n1 [root@wei named]# yum install -y bind bind-chroot ï¼ˆ2ï¼‰ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶\n1 [root@wei csdn]# vim /var/named/chroot/etc/named.conf 1 2 3 4 5 6 7 8 9 10 options { directory \u0026#34;/var/named\u0026#34;; }; zone \u0026#34;wei.com\u0026#34; { type slave; masters { 192.168.196.132;}; \u0026gt;\u0026gt;\u0026gt;\u0026gt;æŒ‡å‘ä¸»æœåŠ¡å™¨ file \u0026#34;slaves/wei.com.zone\u0026#34;; }; ï¼ˆ3ï¼‰é‡å¯æœåŠ¡\n1 2 3 [root@wei named]# systemctl restart named-chroot [root@wei named]# systemctl restart named ï¼ˆ4ï¼‰æµ‹è¯•\n1 2 3 4 [root@wei slaves]# cd /var/named/chroot/var/named/slaves [root@wei slaves]# ls wei.com.zone å·²ç»æˆåŠŸåŠ è½½\nï¼ˆ5ï¼‰nslookupæ£€æŸ¥\nå¥½çš„ï¼Œè¿™å°±å·²ç»å®Œæˆä¸»ä»æœåŠ¡å™¨çš„æ­å»ºäº†ã€‚\næˆ‘ä»¬å»ä¸»æœåŠ¡å™¨æ–°åŠ åŒºåŸŸï¼Œçœ‹èƒ½å¦åŒæ­¥è§£æ\né‡å¯ä¸»æœåŠ¡å™¨ã€‚\nç°åœ¨å»æµ‹è¯•ä»æœåŠ¡å™¨çš„åŒæ­¥æƒ…å†µï¼Œå·²ç»æˆåŠŸäº†ï¼Œokã€‚\n","date":"2019-03-05T21:35:15Z","image":"https://www.ownit.top/title_pic/44.jpg","permalink":"https://www.ownit.top/p/201903052135/","title":"Linuxçš„DNSä¸»ä»æœåŠ¡å™¨éƒ¨ç½²"},{"content":"ä¸‹é¢çš„éƒ¨ç½²æ˜¯åœ¨Linuxçš„DNSæ­£å‘è§£æç¤ºä¾‹ä¸Šè¿›è¡Œä¿®æ”¹çš„ã€‚\nå¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜æˆ–è€…é”™è¯¯ï¼Œå¯ä»¥è®¿é—®ä¸Šç¯‡å¸–å­\nä¸‹é¢å¼€å§‹æœ‰å…³DNSçš„æœåŠ¡éƒ¨ç½²ã€‚\u0026lt;DNSåå‘è§£æ\u0026gt;\nå·¥å…·ï¼šè™šæ‹Ÿæœº\ncentos7Â é…ç½®ï¼šLinuxÂ IP 192.168.196.132\nDSNÂ 192.168.196.132\nå»ºç«‹DASåå‘åŒºåŸŸï¼Œå®ç°åå‘è§£æ\nï¼ˆ1ï¼‰ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶named.conf\n1 [root@wei named]# vim /var/named/chroot/etc/named.confÂ æ·»åŠ ä¸‹é¢çš„ä»£ç \n1 2 3 4 zone \u0026#34;1.168.192.in-addr.arpa\u0026#34; { type master; file \u0026#34;192.168.1.zone\u0026#34;; }; ï¼ˆ2ï¼‰å»ºç«‹åå‘åŒºåŸŸ\nå¯ä»¥å¤åˆ¶æ­£å‘è§£æçš„æ–‡ä»¶ä½œä¸ºæ¨¡æ¿\n1 [root@wei named]# cp /var/named/chroot/var/named/wei.com.zone /var/named/chroot/var/named/192.168.1.zone ä¿®æ”¹192.168.1.zoneè„šæœ¬\n1 [root@wei named]# vim /var/named/chroot/var/named/192.168.1.zone 1 2 3 4 5 6 7 8 9 10 11 12 13 $TTL 1D @ IN SOA wei.com. 123456.qq.com. ( 0 ; serial 1D ; refresh 1H ; retry 1W ; expire 3H ) ; minimum NS dns01.wei.com. dns01 A 192.168.196.132 1 PTR web.wei.com. 11 PTR web.wei.com. 2 PTR ftp.wei.com. 3 PTR mail.wei.com. ï¼ˆ3ï¼‰é‡å¯æœåŠ¡\n1 2 3 [root@wei named]# systemctl restart named-chroot [root@wei named]# systemctl restart named ï¼ˆ4ï¼‰ä½¿ç”¨nslookupæµ‹è¯•æŸ¥çœ‹\n","date":"2019-03-05T21:19:25Z","image":"https://www.ownit.top/title_pic/69.jpg","permalink":"https://www.ownit.top/p/201903052119/","title":"Linuxçš„DNSåå‘è§£æéƒ¨ç½²"},{"content":"DNSè´Ÿè½½å‡è¡¡æŠ€æœ¯çš„å®ç°åŸç†æ˜¯åœ¨DNSæœåŠ¡å™¨ä¸­ä¸ºåŒä¸€ä¸ªä¸»æœºåé…ç½®å¤šä¸ªIPåœ°å€ï¼Œåœ¨åº”ç­”DNSæŸ¥è¯¢æ—¶ï¼ŒDNSæœåŠ¡å™¨å¯¹æ¯ä¸ªæŸ¥è¯¢å°†ä»¥DNSæ–‡ä»¶ä¸­ä¸»æœºè®°å½•çš„IPåœ°å€æŒ‰é¡ºåºè¿”å›ä¸åŒçš„è§£æç»“æœï¼Œå°†å®¢æˆ·ç«¯çš„è®¿é—®å¼•å¯¼åˆ°ä¸åŒçš„æœºå™¨ä¸Šå»ï¼Œä½¿å¾—ä¸åŒçš„å®¢æˆ·ç«¯è®¿é—®ä¸åŒçš„æœåŠ¡å™¨ï¼Œä»è€Œè¾¾åˆ°è´Ÿè½½å‡è¡¡çš„ç›®çš„\nä¸‹é¢çš„éƒ¨ç½²æ˜¯åœ¨Linuxçš„DNSæ­£å‘è§£æéƒ¨ç½²ä¸Šè¿›è¡Œä¿®æ”¹çš„ã€‚\nå¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜æˆ–è€…é”™è¯¯ï¼Œå¯ä»¥è®¿é—®ä¸Šç¯‡å¸–å­\nä¸‹é¢å¼€å§‹æœ‰å…³DNSçš„æœåŠ¡éƒ¨ç½²ã€‚\u0026lt;DNSå®ç°è´Ÿè½½å‡è¡¡åŠæ³›åŸŸå\u0026gt;\nå·¥å…·ï¼šè™šæ‹Ÿæœº\ncentos7Â é…ç½®ï¼šLinuxÂ IP 192.168.196.132\nDSNÂ 192.168.196.132\nè´Ÿè½½å¹³è¡¡ åˆ©ç”¨DNSè®°å½•å®ç°è´Ÿè½½å‡è¡¡æ•ˆæœ\nweb A 192.168.1.1\nweb A 192.168.1.11\nåŒä¸€ä¸»æœºåè§£æåˆ°ä¸åŒçš„ipä¸Š\n1 [root@wei named]# vim /var/named/chroot/var/named/wei.com.zoneÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $TTL 1D @ IN SOA wei.com. 123456.qq.com. ( 0 ; serial 1D ; refresh 1H ; retry 1W ; expire 3H ) ; minimum NS dns01.wei.com. dns01 A 192.168.196.132 web A 192.168.1.1 web A 192.168.1.11 ftp A 192.168.1.2 MX 10 mail.wei.com. mail A 192.168.1.3 é‡å¯æœåŠ¡ 1 2 3 [root@wei named]# systemctl restart named-chroot [root@wei named]# systemctl restart named æ•ˆæœå›¾ æ³›åŸŸåè®°å½• wei.com. A 192.168.1.1\n*.wei.com A 192.168.1.1\n1 [root@wei named]# vim /var/named/chroot/var/named/wei.com.zoneÂ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $TTL 1D @ IN SOA wei.com. 123456.qq.com. ( 0 ; serial 1D ; refresh 1H ; retry 1W ; expire 3H ) ; minimum NS dns01.wei.com. dns01 A 192.168.196.132 web A 192.168.1.1 web A 192.168.1.11 wei.com. A 192.168.1.1 # ä½¿ç”¨wei.comå°±å¯ä»¥è®¿é—®åŸŸå *.wei.com. A 192.168.1.1 # æ— è®ºå‰é¢åŠ ä»€ä¹ˆï¼Œéƒ½ä¼šè§£æåˆ°192.168.1.1ä¸Š ftp A 192.168.1.2 MX 10 mail.wei.com. mail A 192.168.1.3 é‡å¯æœåŠ¡ 1 2 3 [root@wei named]# systemctl restart named-chroot [root@wei named]# systemctl restart named æ•ˆæœå›¾ ","date":"2019-03-05T20:02:38Z","image":"https://www.ownit.top/title_pic/05.jpg","permalink":"https://www.ownit.top/p/201903052002/","title":"Linuxçš„DNSå®ç°è´Ÿè½½å‡è¡¡åŠæ³›åŸŸåéƒ¨ç½²"},{"content":"å‰é¢ä»‹ç»äº†DNSçš„ä½œç”¨åŠå…¶ç›¸å…³çš„ç»“æœã€‚LinuxæœåŠ¡ä¹‹DNSä»‹ç»\nä¸‹é¢å¼€å§‹æœ‰å…³DNSçš„æœåŠ¡éƒ¨ç½²ã€‚\u0026lt;DNSæ­£å‘è§£æç¤ºä¾‹\u0026gt;\nå·¥å…·ï¼šè™šæ‹Ÿæœº\ncentos7Â é…ç½®ï¼šLinuxÂ IP 192.168.196.132\nDSNÂ 192.168.196.132\nè¦æ±‚ï¼š\nweb.wei.com 192.168.1.1\nftp.wei.com 192.168.1.2 mail.wei.com 192.168.1.3\nå‡†å¤‡å·¥ä½œï¼šï¼ˆå¯ä»¥çœ‹å‰æœŸæ•™ç¨‹ï¼‰\nå…³é—­SElinuxï¼Œé˜²ç«å¢™\né…ç½®yumæº\nå®¹æ˜“çŠ¯é”™çš„åœ°æ–¹ï¼šæŸ¥çœ‹/etc/resolv.conf ç¡®ä¿ä½ çš„DNSæ˜¯å¦æ­£ç¡® DNSæ­£å‘è§£æ ï¼ˆ1ï¼‰å®‰è£…è½¯ä»¶ bindÂ bind-chroot\n1 [root@wei csdn]# yum install -y bind bind-chroot 2.ç¼–è¾‘DNSçš„ä¸»é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºåŒºåŸŸwei.com\næ–°å»ºnamed.conf\n1 [root@wei named]# vim /var/named/chroot/etc/named.confÂ å¡«å†™å†…å®¹\n1 2 3 4 5 6 7 options{ directory â€œ/var/named\u0026#34;; }; zone \u0026#34;wei.com\u0026#34;{ type master; file \u0026#34;wei.com.zone\u0026#34; }: 3.å¤åˆ¶è®°å½•æ–‡ä»¶çš„æ¨¡æ¿ï¼Œå¹¶ç¼–è¾‘\næ¨¡æ¿ï¼š/usr/share/doc/bind-9.9.4/sample/var/named/named.localhost\n1 2 3 [root@wei named]# cd /usr/share/doc/bind-9.9.4/sample/var/named/ [root@wei named]# cp named.localhost /var/named/chroot/var/named/wei.com.zone 1 2 3 4 5 6 7 8 9 10 11 12 13 $TTL 1D @ IN SOA wei.com. 123456.qq.com. ( 0 ; serial 1D ; refresh 1H ; retry 1W ; expire 3H ) ; minimum NS dns01.wei.com. dns01 A 192.168.196.132 web A 192.168.1.1 ftp A 192.168.1.2 MX 10 mail.wei.com. mail A 192.168.1.3 4.å¯åŠ¨namedæœåŠ¡\n1 2 3 [root@wei named]# systemctl start named-chroot [root@wei named]# systemctl start named å¼€æœºè‡ªå¯\n1 2 3 [root@wei named]# systemctl enable named-chroot [root@wei named]# systemctl enable named æŸ¥çœ‹ç«¯å£53\n5.æµ‹è¯•\nï¼ˆ1ï¼‰nslookup\nï¼ˆ2ï¼‰dig\n[root@wei named]# dig -t A web.wei.com\n","date":"2019-03-05T19:20:34Z","image":"https://www.ownit.top/title_pic/23.jpg","permalink":"https://www.ownit.top/p/201903051920/","title":"Linuxçš„DNSæ­£å‘è§£æéƒ¨ç½²"},{"content":"DNS\u0026mdash;\u0026mdash;-Domain Name SystemåŸŸåç³»ç»Ÿ\nä»‹ç»ï¼šDNSå°±æ˜¯æŠŠåŸŸåå’ŒIPåœ°å€è”ç³»åœ¨ä¸€èµ·çš„æœåŠ¡ï¼Œæœ‰äº†DNSæœåŠ¡å™¨ï¼Œä½ å°±ä¸ç”¨è¾“å…¥IPåœ°å€æ¥è®¿é—®ä¸€ä¸ªç½‘ç«™ï¼Œå¯ä»¥é€šè¿‡è¾“å…¥ç½‘å€è®¿é—®ã€‚\n**Â **\n**ä½œç”¨ï¼šï¼ˆ1ï¼‰å°†åŸŸåï¼Œä¸»æœºåè§£æå¯¹åº”çš„ipåœ°å€ æ­£å‘è§£æ\nï¼ˆ2ï¼‰å°†IPåœ°å€è§£ææˆå¯¹åº”çš„ä¸»æœºåï¼ŒåŸŸå åå‘è§£æ **\nåŒºåŸŸzoneï¼š\næ­£å‘åŒºåŸŸ nangong.com\nåå‘åŒºåŸŸ X.X.X.in-addr.arpa 192.168.196.0/24 196.168.1962.in-addr.arpa\n**è®°å½•Record\nAè®°å½• ä¸»æœºè®°å½• www.nangong.com A 192.168.1.1\nNSè®°å½• æ ‡è¯†DNSæœåŠ¡å™¨è‡ªèº«çš„åç§°\nNS dns1.nangong.com.\ndns1.nangong.com A 192.168.1.2\nMXè®°å½• æ ‡è¯†é‚®ä»¶æœåŠ¡å™¨çš„åç§°\nMX 10 mail.nangong.com.\nmail.nangong.com A 192.168.196.3\nCNAMEè®°å½• åˆ«åè®°å½• m.mail.com CNAME mail.nangong.com.\nPTRè®°å½• åå‘æŒ‡é’ˆè®°å½•\n192.168.1.1 PTR www.nangong.com.\n**\nDNSåŸŸåç»“æ„ï¼š\n**Â . æ ¹åŸŸ\ncom\njd www.jd.com\u0026mdash;\u0026mdash;\u0026mdash;-\u0026gt;www.jd.com.\nbaidu\ntaobao\ncnÂ edu\norg\nDNSè§£ææ–¹å¼ï¼š\né€’å½’\nå®¢æˆ·ç«¯åªéœ€è¦å‘DNSæœåŠ¡å™¨å‘é€ä¸€æ¬¡è¯·æ±‚\nè¿­ä»£\nå®¢æˆ·ç«¯éœ€è¦å‘é€å¤šæ¬¡DNSè¯·æ±‚**\n","date":"2019-03-05T18:46:29Z","image":"https://www.ownit.top/title_pic/53.jpg","permalink":"https://www.ownit.top/p/201903051846/","title":"LinuxæœåŠ¡ä¹‹DNSä»‹ç»"},{"content":"NFSï¼ˆNetwork File Systemï¼‰å³ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œ\næ˜¯FreeBSDæ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ç§ï¼Œå®ƒå…è®¸ç½‘ç»œä¸­çš„è®¡ç®—æœºä¹‹é—´é€šè¿‡TCP/IPç½‘ç»œå…±äº«èµ„æºã€‚\nåœ¨NFSçš„åº”ç”¨ä¸­ï¼Œæœ¬åœ°NFSçš„å®¢æˆ·ç«¯åº”ç”¨å¯ä»¥é€æ˜åœ°è¯»å†™ä½äºè¿œç«¯NFSæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œå°±åƒè®¿é—®æœ¬åœ°æ–‡ä»¶ä¸€æ ·ã€‚\nNFS -\u0026mdash;\u0026mdash;\u0026mdash;-Network File Syste ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ\nä½œç”¨ï¼šåœ¨LinuxæœåŠ¡å™¨é—´å®ç°æ•°æ®å…±äº«\nè½¯ä»¶ï¼šnfs-utils\nrpcbind\nç›®å½•å¯¼å‡ºæ–‡ä»¶\u0026mdash;-/etc/exports\næ–‡ä»¶æ ¼å¼ï¼š\n**Â ç›®å½•åç§° å®¢æˆ·ç«¯åœ°å€ï¼ˆæƒé™ï¼‰\nå®¢æˆ·ç«¯åœ°å€ï¼š\nIPåœ°å€ï¼š192.168.196.131\nç½‘å…³ï¼š192.168.196.0/24\næƒé™ï¼š\nro åªè¯»\nrw è¯»å†™\nsync åŒæ­¥\nasync å¼‚æ­¥\nall_squash å®¢æˆ·ç«¯æ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶çš„æ‰€å±å‡ä¸ºnfsnobody\nroot_squash å®¢æˆ·ç«¯rootç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶çš„æ‰€å±ä¼šè¢«æ˜ å°„ä¸ºnfsnobody\nno_root_squash å®¢æˆ·ç«¯rootç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶æ‰€å±ä»ä¸ºroot\nanonuid=\u0026lt;number\u0026gt;\nanongid=\u0026lt;number\u0026gt;\n**\nLinuxæœåŠ¡å™¨ï¼š192.168.196.131 Linuxå®¢æˆ·ç«¯ï¼š192.168.196.131 **Â ç¤ºä¾‹ï¼š\né€šè¿‡nfså…±äº«æœ¬åœ°ç›®å½•/wedata å…è®¸192.168.196.132ä»¥åªè¯»æ–¹å¼æŒ‚è½½**\nï¼ˆ1ï¼‰å®‰è£…è½¯ä»¶\n1 [root@wei ~]# yum -y install rpcbind nfs-utils ï¼ˆ2ï¼‰åˆ›å»ºæ–‡ä»¶\n1 2 [root@wei ~]# mkdir /wedata [root@wei ~]# touch /wedata/{1..10}.html ï¼ˆ3ï¼‰ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/exports\n1 [root@wei ~]# vim /etc/exports 1 /wedata 192.168.196.132(ro) ï¼ˆ4ï¼‰é‡å¯æœåŠ¡\n1 2 [root@wei ~]# systemctl restart rpcbind [root@wei ~]# systemctl restart nfs-server æˆ–è€…ä¸‹é¢çš„å‘½ä»¤\nï¼ˆ5ï¼‰æŸ¥çœ‹æœ¬åœ°å…±äº«ç›®å½•\n1 2 3 [root@wei ~]# showmount -e localhost Export list for localhost: /wedata 192.168.196.132 ï¼ˆ6ï¼‰å®¢æˆ·ç«¯è®¿é—®ï¼ˆè½¯ä»¶ä¹Ÿéœ€è¦å®‰è£…ï¼‰\n1 2 3 [root@zhang ~]# mount 192.168.196.131:/wedata /web/ [root@zhang ~]# ls /web/ 10.html 1.html 2.html 3.html 4.html 5.html 6.html 7.html 8.html 9.html **è®¾ç½®ä¸ºå¼€æœºæŒ‚è½½ ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/fstabÂ **\n1 [root@zhang ~]# vim /etc/fstabÂ 1 192.168.196.131:/wedata /web nfs defaults 0 0 è‡³äºæƒé™ä¿®æ”¹ï¼Œæ ¹æ®æƒ…å†µå¯ä»¥æ¥ä¿®æ”¹\n","date":"2019-02-04T19:56:38Z","image":"https://www.ownit.top/title_pic/59.jpg","permalink":"https://www.ownit.top/p/201902041956/","title":"Linuxæ–‡ä»¶æœåŠ¡ç®¡ç†ä¹‹nfs"},{"content":"ç®€ä»‹\nvsftpdæ˜¯ â€œvery secure FTP deamonâ€çš„ç¼©å†™ï¼Œæ˜¯ä¸€ä¸ªå®Œå…¨å…è´¹ï¼Œå¼€æºçš„ftpæœåŠ¡å™¨è½¯ä»¶ã€‚\nç‰¹ç‚¹\nå°å·§è½»å¿«ï¼Œå®‰å…¨æ˜“ç”¨ï¼Œæ”¯æŒè™šæ‹Ÿç”¨æˆ·ã€æ”¯æŒå¸¦å®½é™åˆ¶ç­‰åŠŸèƒ½ã€‚\nFTP -\u0026mdash;\u0026mdash;\u0026mdash;\u0026ndash;File Transfer Protocol æ–‡ä»¶ä¼ è¾“åè®®\nFTPåè®®çš„è¿æ¥æ¨¡å¼ï¼š\nä¸»åŠ¨è¿æ¥\nè¢«åŠ¨è¿æ¥\nè½¯ä»¶ï¼švsftpd\né…ç½®æ–‡ä»¶ï¼š/etc/vsftpd/vsftpd.conf\næœåŠ¡ï¼švsftpd\nç«¯å£ï¼š21/tcp å‘½ä»¤è¿æ¥ç«¯å£\n20/tcp æ•°æ®è¿æ¥ç«¯å£ï¼ˆä¸»åŠ¨ï¼‰\nFTPæ ¹ç›®å½•ï¼š\nç”¨æˆ·å®¿ä¸»ç›®å½•\nè®¿é—®æ–¹å¼ï¼š\nåŒ¿åç”¨æˆ·è®¿é—®ï¼ˆftpï¼‰\nç”¨æˆ·è®¤è¯çš„è®¿é—®\nç¤ºä¾‹ï¼šæ­å»ºåŒ¿åè®¿é—®çš„FTPæœåŠ¡å™¨\nï¼ˆ1ï¼‰å®‰è£…vsftpdè½¯ä»¶\n1 [root@wei csdn]# yum install -y vsftpd ï¼ˆ2ï¼‰å¼€å¯æœåŠ¡ï¼Œå¼€æœºè‡ªå¯\n1 2 [root@wei ftp]# systemctl start vsftpd [root@wei ftp]# systemctl enable vsftpd å·²ç»æˆåŠŸï¼Œé»˜è®¤çš„å…±äº«ç›®å½•æ˜¯/var/ftp/pubè·¯å¾„\nç¤ºä¾‹ï¼šå…è®¸åŒ¿åç”¨æˆ·ä¸Šä¼ æ–‡ä»¶\n1 2 3 [root@wei ~]# chmod o+w /var/ftp/pub/ [root@wei ~]# vim /etc/vsftpd/vsftpd.confÂ anon_upload_enable=YES \u0026raquo;\u0026raquo;å…è®¸ä¸Šä¼ æ–‡ä»¶\nanon_mkdir_write_enable=YES \u0026raquo;\u0026raquo;å…è®¸ä¸Šä¼ ç›®å½•\nanon_umask=022 \u0026raquo;\u0026raquo;å…è®¸å…¶ä»–ç”¨æˆ·èƒ½ä¸‹è½½åŒ¿åç”¨æˆ·æ–‡ä»¶\nanon_other_write_enable=YES \u0026raquo;\u0026raquo;å…è®¸ä¿®æ”¹æ–‡ä»¶åç§°ï¼Œåˆ é™¤æ–‡ä»¶\nanon_root=/comapngÂ \u0026raquo;\u0026raquo;å…±äº«ç›®å½•ä¿®æ”¹\næ³¨æ„ï¼šåœˆä½çš„æ˜¯åŒ¿åç”¨æˆ·è®¿é—®æ—¶çš„æƒé™ï¼Œå¯æ ¹æ®ä¸Šé¢ä»£ç ä¿®æ”¹æƒé™ é‡å¯vsftpdè½¯ä»¶\n1 [root@wei ~]# systemctl restart vsftpd è®¿é—®æ–¹å¼ï¼š\nlinuxå®¢æˆ·ç«¯ï¼š\n1 2 3 [root@zhang hei]# lftp 192.168.196.131 lftp 192.168.196.131:~\u0026gt; ls drwxr-xr-x 5 0 0 111 Oct 30 19:45 pub windowså®¢æˆ·ç«¯ï¼š\nftp://192.168.196.131\næœ¬åœ°ç”¨æˆ·è®¤è¯çš„FTPæœåŠ¡ åœ¨æ™®é€šç”¨æˆ·å®¶ç›®å½•åˆ›å»ºæ–‡ä»¶ï¼Œå¯ä»¥è®¿é—®è¿™äº›æ–‡ä»¶\nç¤ºä¾‹ï¼š\nåˆ›å»ºæ–‡ä»¶\n1 2 [root@wei ~]# ls /home/hei/ [root@wei ~]# touch /home/hei/{1..4}.txt è®¿é—®æ–¹å¼ï¼š\nlinuxå®¢æˆ·ç«¯ï¼š\n1 [root@zhang hei]# lftp 192.168.196.131 -u hei windowså®¢æˆ·ç«¯ï¼š\nftp://192.168.196.131\nç”±æ­¤å¯è§ï¼Œå¯ä»¥è®¿é—®ç”¨æˆ·å®¶ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚\n","date":"2019-02-03T21:07:37Z","image":"https://www.ownit.top/title_pic/74.jpg","permalink":"https://www.ownit.top/p/201902032107/","title":"Linuxæ–‡ä»¶æœåŠ¡ç®¡ç†ä¹‹vsftpd"},{"content":"Linuxæ–‡ä»¶æœåŠ¡å™¨çš„æ­å»º\nSamba\nvsftpd\nnfs\nSambaæœåŠ¡\nä½œç”¨ï¼šå…±äº«ç›®å½•\nè½¯ä»¶ï¼šSamba æœåŠ¡å™¨ ï¼ŒSamba-client å®¢æˆ·ç«¯\né…ç½®æ–‡ä»¶ï¼š/etc/smaba/smb.conf\næœåŠ¡ï¼šsmb,nmb\nç«¯å£ï¼šsmb -\u0026ndash;\u0026gt;139/tcp , 445/tcp æä¾›æ–‡ä»¶å…±äº«åŠŸèƒ½\nnmb -\u0026ndash;\u0026gt;137/udp , 138/udp æä¾›è§£æè®¡ç®—æœºåç§°\né…ç½®æ–‡ä»¶ï¼š/etc/smaba/smb.conf\nå…¨å±€é…ç½®\nworkgroup = SAMBA -\u0026ndash;è®¾ç½®å·¥ä½œç»„åç§°\nserver string =Samba Server Version %v -\u0026mdash;æ˜¾ç¤ºsambaè½¯ä»¶ç‰ˆæœ¬ä¿¡æ¯\ninterface = lo eth0 192.168.196.131ï¼Ÿ24 -\u0026ndash;sambaæœåŠ¡ç›‘å¬çš„ipåœ°å€\nhosts allow=127.192.168.12 192.168.196.0 -\u0026mdash;-è®¾ç½®ä»…å…è®¸é‚£äº›ä¸»æœºè®¿é—®\nhosts deny=192.168.12. 192.168.1.1/24 -\u0026mdash;-æ‹’ç»é‚£äº›ä¸»æœºè®¿é—®\nsecurity =user -\u0026mdash;\u0026mdash;åŸºäºç”¨æˆ·è®¤è¯è®¿é—®\nshare -\u0026mdash;\u0026mdash;åŒ¿åè®¿é—®\nå…±äº«ç›®å½•é…ç½®\n[å…±äº«åç§°]\ncomment= ====æè¿°ä¿¡æ¯\npath = /bj ====æŒ‡å®šç›®å½•åç§°\nbrowseable = yes ====å¯ä¸‹è½½æ–‡ä»¶\nwritable = yes ====å¯ä¸Šä¼ æ–‡ä»¶\npublic = yes ====è¿è¡Œæ‰€æœ‰ç”¨æˆ·è®¿é—®\nwrite list =user1 ====ä»…å…è®¸user1å¯ä¸Šä¼ æ–‡ä»¶\nç¤ºä¾‹ï¼š\nç¯å¢ƒæè¿°ï¼š\nLinux 192.168.196.131 Centos7 æ–‡ä»¶å…±äº«æœåŠ¡å™¨\nwindows/Linuxå®¢æˆ·ç«¯\néœ€æ±‚ï¼šé€šè¿‡sambaè½¯ä»¶å°†æœ¬åœ°çš„/caiwu ç›®å½•å…±äº«ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡heiç”¨æˆ·è®¿é—®ï¼Œä»…å…è®¸ä¸‹è½½æ–‡ä»¶Â å‰æï¼šselinuxå’Œé˜²ç«å¢™å…¨éƒ¨å…³é—­\nï¼ˆ1ï¼‰å®‰è£…è½¯ä»¶\n1 [root@wei ~]# yum -y install samba samba-client åˆ›å»ºå…±äº«ç”¨æˆ·\n1 2 [root@wei ~]# useradd hei [root@wei ~]# smbpasswd -a hei æŸ¥çœ‹å…±äº«ç”¨æˆ·\n1 [root@wei ~]# pdbedit -L é…ç½®æ–‡ä»¶/etc/smaba/smb.conf\n1 [root@wei ~]# vim /etc/samba/smb.conf 1 2 3 4 [caiwu] comment = caiwu path = /caiwu browseable = yes é‡å¯sambaæœåŠ¡\n[root@wei ~]# systemctl start smb\n1 [root@wei ~]# systemctl start smb æµ‹è¯•è®¿é—®ï¼šÂ windowsè®¿é—®ï¼š\\\\192.168.196.131\nå·²ç»å…±äº«æˆåŠŸ\nLinuxå®¢æˆ·ç«¯ï¼š 1 2 [root@wei ~]# yum -y install samba-client [root@zhang ~]# smbclient //192.168.196.131/caiwu-U hei æ–‡ä»¶çš„ä¸Šä¼  å¦‚æœæƒ³è¦ä¸Šä¼ æ–‡ä»¶ï¼Œè¿™éœ€è¦ä¿®æ”¹æ–‡ä»¶æƒé™wä¸ºå…¶ä»–å…±äº«ç”¨æˆ·\nå¦‚æœä¸ç»™æƒé™ä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µ\nwindowså®¢æˆ·ç«¯\nLinuxå®¢æˆ·ç«¯\né‡ç‚¹ä¿®æ”¹æ–‡ä»¶æƒé™wä¸ºå…¶ä»–å…±äº«ç”¨æˆ·\nä¿®æ”¹å•ä¸ªç”¨æˆ·æƒé™åˆ™å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™æ®µå‘½ä»¤\n1 [root@wei ~]# setfacl -m u:hei:rwx /caiwu/ ä¿®æ”¹é…ç½®æ–‡ä»¶\né‡å¯å°±å¯ä»¥ä¸Šä¼ æ–‡ä»¶äº† å¤šç”¨æˆ·ç¤ºä¾‹ï¼š **Â é€šè¿‡sambaè½¯ä»¶å°†æœ¬åœ°çš„/shanghaiç›®å½•å…±äº«ï¼Œå…è®¸heiç”¨æˆ·ä¸‹è½½æ–‡ä»¶ï¼Œå…è®¸adminç”¨æˆ·ä¸Šä¼ æ–‡ä»¶**\nï¼ˆ1ï¼‰åˆ›å»ºç›®å½•ï¼Œåˆ›å»ºå…±äº«ç”¨æˆ·\n1 2 3 4 5 6 [root@zhang ~]# mkdir /shichang [root@zhang ~]# touch /shichang/{1..5}.jpg [root@zhang ~]# useradd admin [root@zhang ~]# useradd zhang [root@zhang ~]# smbpasswd -a zhang [root@zhang ~]# smbpasswd -a admin é…ç½®æ–‡ä»¶ä¿®æ”¹ä¸‹é¢è¿™æ ·\n1 2 3 4 [shichang] path = /shichang browseable = yes write list = admin ï¼ˆ2ï¼‰é‡å¯æœåŠ¡è®¿é—®\nï¼ˆ3ï¼‰æµ‹è¯•è®¿é—®ï¼š\næ¸…é™¤windowsçš„å…±äº«ç¼“å­˜\nnet use * /del\n","date":"2019-02-03T20:38:40Z","image":"https://www.ownit.top/title_pic/61.jpg","permalink":"https://www.ownit.top/p/201902032038/","title":"Linuxæ–‡ä»¶æœåŠ¡ç®¡ç†ä¹‹Samba"},{"content":"1ã€DHCPæœåŠ¡ç®€ä»‹ DHCP(Dynamic Host Configuration Protocolï¼ŒåŠ¨æ€ä¸»æœºé…ç½®åè®®)æ˜¯ä¸€ä¸ªå±€åŸŸç½‘çš„ç½‘ç»œåè®®ï¼Œä½¿ç”¨UDPåè®®å·¥ä½œï¼ŒÂ ä¸»è¦æœ‰ä¸¤ä¸ªç”¨é€”:ç»™å†…éƒ¨ç½‘ç»œæˆ–ç½‘ç»œæœåŠ¡ä¾›åº”å•†è‡ªåŠ¨åˆ†é…IPåœ°å€ï¼Œç»™ç”¨æˆ·æˆ–è€…å†…éƒ¨ç½‘ç»œç®¡ç†å‘˜ä½œä¸ºå¯¹æ‰€æœ‰è®¡ç®—æœºä½œä¸­å¤®ç®¡ç†çš„æ‰‹æ®µï¼Œåœ¨RFC 2131ä¸­æœ‰è¯¦ç»†çš„æè¿°ã€‚DHCPæœ‰3ä¸ªç«¯å£ï¼Œå…¶ä¸­UDP67å’ŒUDP68ä¸ºæ­£å¸¸çš„DHCPæœåŠ¡ç«¯å£ï¼Œåˆ†åˆ«ä½œä¸ºDHCP Serverå’ŒDHCP Clientçš„æœåŠ¡ç«¯å£;546å·ç«¯å£ç”¨äºDHCPv6 Clientï¼Œè€Œä¸ç”¨äºDHCPv4ï¼Œæ˜¯ä¸ºDHCP failoveræœåŠ¡ï¼Œè¿™æ˜¯éœ€è¦ç‰¹åˆ«å¼€å¯çš„æœåŠ¡ï¼ŒDHCP failoveræ˜¯ç”¨æ¥åš\u0026quot;åŒæœºçƒ­å¤‡\u0026quot;çš„ã€‚\n2ã€DHCPæœåŠ¡ä½œç”¨ ä¸ºå¤§é‡å®¢æˆ·æœºè‡ªåŠ¨åˆ†é…åœ°å€ï¼Œæä¾›é›†ä¸­ç®¡ç†\n**å‡è½»ç®¡ç†å’Œç»´æŠ¤æˆæœ¬ã€æé«˜ç½‘ç»œé…ç½®æ•ˆç‡\nåŸç†ï¼š\n1.å®¢æˆ·ç«¯å‘é€DHCP Discoveryæ¢ç´¢DHCPæœåŠ¡å™¨Â 2.DHCPæœåŠ¡å™¨å‘é€DHCP Offer (IP/NETMASK/GATEWAY/DNS)\n3.å®¢æˆ·ç«¯å‘é€DHCP Request\n4.DHCPæœåŠ¡å™¨å‘é€DHCP ACK\n5.å®¢æˆ·ç«¯å‘é€Gratuation ARPç”¨äºæ£€æµ‹IPåœ°å€æ˜¯å¦å†²çª\n**\nè½¯ä»¶ï¼šdhcp\né…ç½®æ–‡ä»¶ï¼š/etc/dhcp/dhcpd.conf\næœåŠ¡ï¼šdhcpd\nç«¯å£ï¼š67/udpï¼ˆDHCPæœåŠ¡ç«¯å£ï¼‰ ,68/udpï¼ˆDHCPå®¢æˆ·ç«¯ç«¯å£ï¼‰\n","date":"2019-02-02T20:00:04Z","image":"https://www.ownit.top/title_pic/60.jpg","permalink":"https://www.ownit.top/p/201902022000/","title":"LinuxæœåŠ¡ç®¡ç†ä¹‹DHCP"},{"content":"NTPæ˜¯ç½‘ç»œæ—¶é—´åè®®(Network Time Protocol)ï¼Œå®ƒæ˜¯ç”¨æ¥åŒæ­¥ç½‘ç»œä¸­å„ä¸ªè®¡ç®—æœºçš„æ—¶é—´çš„åè®®ã€‚\nåœ¨è®¡ç®—æœºçš„ä¸–ç•Œé‡Œï¼Œæ—¶é—´éå¸¸åœ°é‡è¦ï¼Œä¾‹å¦‚å¯¹äºç«ç®­å‘å°„è¿™ç§ç§‘ç ”æ´»åŠ¨ï¼Œå¯¹æ—¶é—´çš„ç»Ÿä¸€æ€§å’Œå‡†ç¡®æ€§è¦æ±‚å°±éå¸¸åœ°é«˜ï¼Œæ˜¯æŒ‰ç…§Aè¿™å°è®¡ç®—æœºçš„æ—¶é—´ï¼Œè¿˜æ˜¯æŒ‰ç…§Bè¿™å°è®¡ç®—æœºçš„æ—¶é—´ï¼ŸNTPå°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼ŒNTPï¼ˆNetwork Time Protocolï¼Œç½‘ç»œæ—¶é—´åè®®ï¼‰æ˜¯ç”¨æ¥ä½¿ç½‘ç»œä¸­çš„å„ä¸ªè®¡ç®—æœºæ—¶é—´åŒæ­¥çš„ä¸€ç§åè®®ã€‚å®ƒçš„ç”¨é€”æ˜¯æŠŠè®¡ç®—æœºçš„æ—¶é’ŸåŒæ­¥åˆ°ä¸–ç•Œåè°ƒæ—¶UTCï¼Œå…¶ç²¾åº¦åœ¨å±€åŸŸç½‘å†…å¯è¾¾0.1msï¼Œåœ¨äº’è”ç½‘ä¸Šç»å¤§å¤šæ•°çš„åœ°æ–¹å…¶ç²¾åº¦å¯ä»¥è¾¾åˆ°1-50msã€‚\nå®ƒå¯ä»¥ä½¿è®¡ç®—æœºå¯¹å…¶æœåŠ¡å™¨æˆ–æ—¶é’Ÿæºï¼ˆå¦‚çŸ³è‹±é’Ÿï¼ŒGPSç­‰ç­‰ï¼‰è¿›è¡Œæ—¶é—´åŒæ­¥ï¼Œå®ƒå¯ä»¥æä¾›é«˜ç²¾å‡†åº¦çš„æ—¶é—´æ ¡æ­£ï¼Œè€Œä¸”å¯ä»¥ä½¿ç”¨åŠ å¯†ç¡®è®¤çš„æ–¹å¼æ¥é˜²æ­¢ç—…æ¯’çš„åè®®æ”»å‡»ã€‚\nNTPæœåŠ¡å™¨\nNTP -\u0026mdash;\u0026mdash;\u0026mdash;- Network Time Protocol ç½‘ç»œæ—¶é—´åè®®\nè½¯ä»¶ï¼šntp\né…ç½®æ–‡ä»¶ï¼š /etc/ntp.conf\næœåŠ¡ï¼šntp\nç«¯å£ï¼š123/udp\nç¤ºä¾‹ï¼šé…ç½®ntpæ—¶é—´æœåŠ¡å™¨\n1.å®‰è£…ntpè½¯ä»¶\n1 [root@wei ~]# yum install ntp -y 2.ç¼–è¾‘ntpé…ç½®æ–‡ä»¶\n1 [root@wei ~]# vim /etc/ntp.conf æ·»åŠ ä¸‹é¢çš„ä»£ç \nrestrict 192.168.196.0 mask 255.255.255.0 nomodify notrap\nserver 127.127.1.0 iburst\n27 fudge 127.127.1.0 stratum 10Â 3.é‡å¯ntpdæœåŠ¡\n1 2 3 [root@wei ~]# systemctl start ntpd #å¯åŠ¨æœåŠ¡ [root@wei ~]# systemctl enable ntpd #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ Created symlink from /etc/systemd/system/multi-user.target.wants/ntpd.service to /usr/lib/systemd/system/ntpd.service.Â åœ¨å®¢æˆ·ç«¯è¾“å…¥ï¼š\n1 [root@zhang csdn]# ntpdate 192.168.196.131 å³å¯åŒæ­¥æ—¶é—´\nåŒæ­¥ç½‘ç»œæ—¶é—´ï¼šÂ 1 [root@wei ~]# /usr/sbin/ntpdate time.windows.com ","date":"2019-02-02T19:50:02Z","image":"https://www.ownit.top/title_pic/12.jpg","permalink":"https://www.ownit.top/p/201902021950/","title":"LinuxæœåŠ¡ç®¡ç†ä¹‹ntp"},{"content":"LinuxæœåŠ¡SSH\nsshæœåŠ¡ï¼š\nç®¡ç†æœåŠ¡å™¨çš„æ–¹å¼ï¼š\næœ¬åœ°ç®¡ç†ç±» ï¼ˆå®‰è£…ç³»ç»Ÿï¼Œæ•…éšœä¿®å¤ï¼‰\nSHHè¿œç¨‹è¿æ¥æ–¹å¼\nLinuxï¼šsshå‘½ä»¤\nwindows:Xshell , SecureCRT , Putty\næä¾›sshæœåŠ¡/sshå®¢æˆ·ç«¯å·¥å…·çš„è½¯ä»¶ï¼š\nopenssh-clients-7.4p1-16.el7.x86_64\nopenssh-server-7.4p1-16.el7.x86_64\næŸ¥çœ‹sshçŠ¶æ€\n1 [hei@wei ~]$ systemctl status sshd æŸ¥çœ‹sshçš„ç«¯å£ï¼š\n1 [root@wei ~]# ss -antp | grep sshd 1.è¿œç¨‹è¿æ¥ä¸»æœº\n# shh [user@]host\n**Â # ssh 192.168.196.132\n# ssh marin@192.168.196.132\n2.è¿œç¨‹è¿æ¥ä¸»æœºæ‰§è¡Œå‘½ä»¤**\n**# ssh 192.168.196.132 â€˜hostnameâ€™ **\n1 2 3 [root@wei ~]# ssh hei@192.168.196.132 \u0026#39;hostname\u0026#39; hei@192.168.196.132\u0026#39;s password:Â wei 3.è¿œç¨‹å¤åˆ¶æ–‡ä»¶å·¥å…·\n**Â scp rsync\n# scp /etc/fstab 192.168.196.132:/tmp# scp 192.168.196.132:/etc/passwd /tmp\n-r: å¤åˆ¶ç›®å½•\n**\n1 2 3 4 5 6 [root@wei ~]# scp /etc/fstab 192.168.196.132:/tmp root@192.168.196.132\u0026#39;s password:Â fstab 100% 465 17.4KB/s 00:00 [root@wei ~]# scp 192.168.196.132:/etc/passwd /tmp root@192.168.196.132\u0026#39;s password:Â passwdÂ rsync\n# rsync -av /bj/ 192.168.196.132:/bj #æ‹·è´æ–‡ä»¶\n# rsync -av /bj 192.168.196.132:/bj #æ‹·è´ç›®å½•\né…ç½®æ–‡ä»¶ï¼š/etc/ssh/sshd_configã€\næ³¨æ„ï¼šä¸‹é¢å‡ é¡¹æ“ä½œåœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œ\n(1)å…³é—­SSHçš„ä¸»æœºåè§£æ\nGSSAPIAuthentication no\nUseDNS no\n1 [root@zhang ~]# systemctl restart sshd ï¼ˆ2ï¼‰ç¦ç”¨rootç”¨æˆ·è¿œç¨‹è¿æ¥\n**Â PermitRootLogin no**\nï¼ˆ3ï¼‰ä¿®æ”¹é»˜è®¤ç«¯å£\nPort 1999\næ³¨æ„ï¼šæ­¤æ—¶è¿æ¥éœ€è¦åŠ ç«¯å£ï¼ˆ-pï¼‰ rootç”¨æˆ·å·²ç»ç™»å½•ä¸ä¸Š\n1 [root@wei ~]# ssh hei@192.168.196.132 -p 1999 ï¼ˆ4ï¼‰ç›‘å¬ip\n**Â ListenAddress 192.168.196.131**\nSSHè®¤è¯æ–¹å¼ï¼š **Â åŸºäºç”¨æˆ·åï¼Œå¯†ç ï¼šé»˜è®¤\nåŸºäºå¯†é’¥\n**\nåŸºäºå¯†é’¥çš„é…ç½®æ–¹æ³•ï¼š\n1.åœ¨å®¢æˆ·ç«¯ç”Ÿæˆå¯†é’¥å¯¹\n2.æŠŠå…¬é’¥ä¼ ç»™æœåŠ¡å™¨\nï¼ˆ1ï¼‰åœ¨å®¢æˆ·ç«¯ç”Ÿæˆå¯†é’¥å¯¹\næ³¨æ„ï¼šé»˜è®¤ç”Ÿæˆçš„å¯†é’¥ä¼šå­˜å‚¨åœ¨/root/.ssh/ç›®å½•ä¸‹\n1 [root@wei ~]# ssh-keygen -t rsa ï¼ˆ2ï¼‰æŠŠå…¬é’¥ä¼ é€ç»™æœåŠ¡å™¨\næ³¨æ„ï¼šä¼ é€’çš„å…¬é’¥ä¼šå­˜å‚¨åœ¨/root/.ssh/ç›®å½•ä¸‹\n1 [root@wei .ssh]# ssh-copy-id -i -p 1999 192.168.196.132 æ³¨æ„ï¼šå¯ä»¥ç»™æ™®é€šç”¨æˆ·å¤åˆ¶å…¬é’¥ï¼Œä½†æ˜¯è¦ä¿®æ”¹ç›®å½•å’Œå…¬é’¥çš„æƒé™ä¸ºæ™®é€šç”¨æˆ·çš„\n","date":"2019-02-01T21:34:06Z","image":"https://www.ownit.top/title_pic/61.jpg","permalink":"https://www.ownit.top/p/201902012134/","title":"LinuxæœåŠ¡ç®¡ç†ä¹‹SSH"},{"content":" è®¡åˆ’ä»»åŠ¡\n**ç±»å‹ï¼š ä¸€æ¬¡æ€§è®¡åˆ’ä»»åŠ¡\nå‘¨æœŸæ€§è®¡åˆ’ä»»åŠ¡**\n**Â ä¸€æ¬¡æ€§è®¡åˆ’ä»»åŠ¡**\nå‰æï¼š atdæœåŠ¡å¿…é¡»è¿è¡Œ\n1 2 3 4 5 [root@wei init.d]# yum -y install at #å®‰è£…atdæœåŠ¡ [root@wei init.d]# systemctl start atd #å¼€å¯atdæœåŠ¡ [root@wei init.d]# systemctl status atd #æŸ¥çœ‹atdå¼€å¯çŠ¶æ€ 18:00å…³æœºï¼ˆä»¥ç³»ç»Ÿæ—¶é—´ä¸ºå‡†ï¼‰ï¼š\n1 2 3 4 [root@wei init.d]# at 18:00 at\u0026gt; poweroff at\u0026gt; \u0026lt;EOT\u0026gt; # Ctrl+d æäº¤ä»»åŠ¡ job 1 at Fri Feb 1 18:00:00 2019 **1åˆ†é’Ÿåæ‰§è¡Œçš„ä»»åŠ¡ï¼š\n**\n1 2 3 4 [root@wei init.d]# at now + 1 minute at\u0026gt; mkdir /root/nangong at\u0026gt; \u0026lt;EOT\u0026gt; job 4 at Thu Jan 31 18:49:00 2019 å‘¨æœŸæ€§è®¡åˆ’ä»»åŠ¡ å‰æï¼šcrondæœåŠ¡å¿…é¡»è¿è¡Œ\n1 2 3 4 5 [root@wei ~]# yum install crontabs #å®‰è£…crondæœåŠ¡ [root@wei init.d]# systemctl start crond #å¼€å¯crondæœåŠ¡ [root@wei ~]# systemctl status crond #æŸ¥çœ‹crondå¼€å¯çŠ¶æ€ **\nåˆ¶ä½œå‘¨æœŸæ€§è®¡åˆ’ä»»åŠ¡**\n**# crontab -eÂ **\n**Â æ—¶é—´ COMMAND**\næ—¶é—´ï¼š\nåˆ† æ—¶ æ—¥ æœˆ å‘¨\nåˆ†é’Ÿï¼š 0\u0026mdash;-59\næ—¶ï¼š 0\u0026mdash;-23\næ—¥æœŸï¼š 1\u0026mdash;-31\næœˆï¼š 1\u0026mdash;12\nå‘¨ï¼š 0\u0026mdash;-6\n* è¡¨ç¤ºæ¯å‘¨ï¼ˆæ—¥ æœˆ å‘¨ï¼‰\n- è¿ç»­çš„æ—¶é—´\nï¼Œ ä¸è¿ç»­çš„æ—¶é—´\nç¤ºä¾‹ï¼š\n**æ¯å¤©æ™šä¸Š11:30 30 23 * * *\næ¯å¤©é›¶ç‚¹ 0 0 * * *Â æ¯å¤©æ—©ä¸Š8:10 9:10 10:10 10 8-10 * * * æ¯éš”5åˆ†é’Ÿ */5 * * * *\næ¯éš”3å°æ—¶ * */3 * * *Â **\n**COMMANDå‘½ä»¤ï¼šÂ 1.å»ºè®®å†™å‘½ä»¤çš„å®Œæ•´è·¯å¾„ /bin/mkdir/abc\n2.åªèƒ½å†™ä¸€æ¡å‘½ä»¤ï¼ˆshellï¼‰\n**\n**æ³¨æ„ï¼š åœ¨å†™å‘½ä»¤æ—¶%åœ¨å‘¨æœŸæ€§è®¡åˆ’ä»»åŠ¡ä¸­æ˜¯ç»“æŸçš„æ„æ€ï¼Œå› æ­¤åœ¨ä½¿ç”¨%æ—¶ï¼Œéœ€è¦åŠ \\å³æ–œæ è½¬ä¹‰\n\u0026amp;\u0026gt; /dev/null ä¸ç»™ç”¨æˆ·å‘é‚®ä»¶\n**\nåˆ›å»ºè®¡åˆ’ä»»åŠ¡\nç¤ºä¾‹ï¼š\nï¼ˆ1ï¼‰æ¯åˆ†é’Ÿåœ¨tmpç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶\n**[root@wei ~]# crontab -eÂ **\n*/1 * * * * /usr/bin/touch /tmp/wei/$(date +\\%F-\\%T).txt\nï¼ˆ2ï¼‰æ¯åˆ†é’Ÿåˆ†åˆ«æ˜¾ç¤ºç£ç›˜ä½¿ç”¨ï¼ŒcpuçŠ¶æ€ï¼Œå†…å­˜çŠ¶æ€çš„ä¿¡æ¯\nåˆ†æï¼šä¸€è¡Œåªèƒ½å†™ä¸€æ¡å‘½ä»¤ï¼Œä½†è¦æ˜¾ç¤ºä¸‰ä¸ªå‘½ä»¤ï¼Œåˆ™éœ€è¦å€ŸåŠ©shellè„šæœ¬ã€‚ç„¶ååœ¨å‘¨æœŸæ€§ä»»åŠ¡ä¸­è°ƒç”¨shellè„šæœ¬ã€‚\nï¼ˆ1ï¼‰åˆ›å»ºshellè„šæœ¬\n1 2 3 4 5 6 7 8 9 10 11 [root@wei ~]# vim hei.sh #!/bin/bash echo echo \u0026#34;CPUè´Ÿè½½\u0026#34; uptime echo echo \u0026#34;ç£ç›˜å®¹é‡ï¼š\u0026#34; df -hT echo echo \u0026#34;å†…å­˜å®¹é‡\u0026#34; free -h æˆ‘åœ¨æ¬¡è°ƒç”¨æ¼”ç¤ºã€‚\nï¼ˆ2ï¼‰åˆ›å»ºå‘¨æœŸæ€§ä»»åŠ¡\n1 2 3 [root@wei ~]# crontab -eÂ */1 * * * * /usr/bin/bash /root/hei.sh æ³¨æ„ï¼šè¿™ä¸ªä¼šç»™rootç”¨æˆ·å‘é‚®ä»¶æ˜¾ç¤ºshellè„šæœ¬è¿è¡Œçš„ä¿¡æ¯\n1 */1 * * * * /usr/bin/bash /root/hei.sh \u0026amp;\u0026gt; /dev/null **Â \u0026amp;\u0026gt; /dev/null ä¸ç»™ç”¨æˆ·å‘é‚®ä»¶**\næŸ¥çœ‹è®¡åˆ’ä»»åŠ¡\n1 2 3 [root@wei ~]# crontab -l */1 * * * * /usr/bin/touch /tmp/wei/$(date +\\%F-\\%T).txt */1 * * * * /usr/bin/bash /root/hei.sh \u0026amp;\u0026gt; /dev/null åˆ é™¤è®¡åˆ’ä»»åŠ¡ï¼ˆå…¨éƒ¨åˆ é™¤ï¼‰\n1 [root@wei ~]# crontab -r ","date":"2019-01-31T21:08:21Z","image":"https://www.ownit.top/title_pic/67.jpg","permalink":"https://www.ownit.top/p/201901312108/","title":"Linuxè®¡åˆ’ä»»åŠ¡ç®¡ç†"},{"content":"Linuxè¿è¡Œæ¨¡å¼\nè‡ªç”±æœåŠ¡ï¼Œå³ä¸éœ€è¦ç”¨æˆ·ç‹¬ç«‹å»å®‰è£…çš„è½¯ä»¶æœåŠ¡ï¼Œè€Œæ˜¯åœ¨ç³»ç»Ÿå®‰è£…å¥½ä¹‹åå°±å¯ä»¥ç›´æ¥ä½¿ç”¨çš„æœåŠ¡ï¼ˆå†…ç½®æœåŠ¡ï¼‰ã€‚ è¿è¡Œæ¨¡å¼ä¹Ÿç§°ä¸ºè¿è¡Œçº§åˆ«ï¼Œå±äºlinuxçš„è‡ªæœ‰æœåŠ¡ã€‚ è¿è¡Œæ¨¡å¼å¯ä»¥ç†è§£ä¸ºä¸€æ—¦ä½ å¼€æœºäº†ï¼Œè®¡ç®—æœºå°±ä»¥ä½ è®¾ç½®çš„è¿è¡Œæ¨¡å¼ç»™ä½ å±•ç¤ºã€‚ æ§åˆ¶è¿è¡Œæ¨¡å¼çš„è¿›ç¨‹æ˜¯ï¼šinitÂ ï¼Œåˆå§‹åŒ–è¿›ç¨‹ï¼Œè¿›ç¨‹idæ˜¯1ã€‚ Centos 7ç³»ç»Ÿè¿è¡Œæ–¹å¼ï¼ˆtargetï¼‰ï¼š\nmultiâ€”user.target å­—ç¬¦æ¨¡å¼ï¼ˆå¤šç”¨æˆ·æ¨¡å¼ï¼‰\ngraphical.target å›¾åƒæ¨¡å¼\nï¼ˆ1ï¼‰æŸ¥çœ‹å½“å‰çš„é»˜è®¤çº§åˆ«ï¼š\n1 2 [root@wei ~]# systemctl get-default multi-user.target ï¼ˆ2ï¼‰ä¿®æ”¹é»˜è®¤çº§åˆ«\n1 [root@wei ~]# systemctl get-default graphical.target Centos 6ç³»ç»Ÿè¿è¡Œæ–¹å¼ï¼š\n0 å…³æœºæ¨¡å¼\n1 å•ç”¨æˆ·æ¨¡å¼ï¼ˆä¿®å¤ï¼‰\n2 å­—ç¬¦æ¨¡å¼ï¼ˆæ— ç½‘ç»œï¼‰\n3 å®Œå…¨å­—ç¬¦æ¨¡å¼ï¼ˆé»‘åº•ç™½å­—ï¼‰\n4 é¢„ç•™\n5 å›¾å½¢æ¨¡å¼\n6 é‡å¯æ¨¡å¼Â æŸ¥çœ‹å½“å‰çš„é»˜è®¤çº§åˆ«\n1 2 3 [root@wei ~]# runlevelÂ N 3 init id å¯ä»¥æ¥å›åˆ‡æ¢æ¨¡å¼\nç¼–è¾‘æ–‡ä»¶/etc/inittabä¿®æ”¹é»˜è®¤çš„å¯åŠ¨æ¨¡å¼\n","date":"2019-01-31T20:50:49Z","image":"https://www.ownit.top/title_pic/03.jpg","permalink":"https://www.ownit.top/p/201901312050/","title":"Linuxç³»ç»Ÿè¿è¡Œæ¨¡å¼ä»‹ç»"},{"content":"Linuxä¸Šè¿›ç¨‹æœ‰5ç§çŠ¶æ€ï¼Œè¿™5ä¸­çŠ¶æ€å¯ä»¥ä¸ä¸€èˆ¬æ“ä½œç³»ç»Ÿçš„çŠ¶æ€å¯¹åº”èµ·æ¥ï¼š\nè¿è¡Œï¼šæ­£åœ¨è¿è¡Œæˆ–åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚ ä¸­æ–­ï¼šä¼‘çœ ä¸­ï¼Œ å—é˜»ï¼Œ åœ¨ç­‰å¾…æŸä¸ªæ¡ä»¶çš„å½¢æˆæˆ–æ¥å—åˆ°ä¿¡å·ã€‚ ä¸å¯ä¸­æ–­ï¼šæ”¶åˆ°ä¿¡å·ä¸å”¤é†’å’Œä¸å¯è¿è¡Œï¼Œ è¿›ç¨‹å¿…é¡»ç­‰å¾…ç›´åˆ°æœ‰ä¸­æ–­å‘ç”Ÿã€‚ åƒµæ­»ï¼šè¿›ç¨‹å·²ç»ˆæ­¢ï¼Œ ä½†è¿›ç¨‹æè¿°ç¬¦å­˜åœ¨ï¼Œ ç›´åˆ°çˆ¶è¿›ç¨‹è°ƒç”¨wait4()ç³»ç»Ÿè°ƒç”¨åé‡Šæ”¾ã€‚ åœæ­¢ï¼šè¿›ç¨‹æ”¶åˆ°SIGSTOPï¼Œ SIGSTPï¼Œ SIGTINï¼Œ SIGTOUä¿¡å·ååœæ­¢è¿è¡Œè¿è¡Œã€‚ è¿›ç¨‹æ§åˆ¶\n**Â ä¿¡å·ï¼šSignal\næŸ¥çœ‹æ‰€æœ‰çš„ä¿¡å·**\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@wei csdn]# kill -l 1) SIGHUPÂ 2) SIGINTÂ 3) SIGQUITÂ 4) SIGILLÂ 5) SIGTRAP 6) SIGABRTÂ 7) SIGBUSÂ 8) SIGFPEÂ 9) SIGKILLÂ 10) SIGUSR1 11) SIGSEGVÂ 12) SIGUSR2Â 13) SIGPIPEÂ 14) SIGALRMÂ 15) SIGTERM 16) SIGSTKFLTÂ 17) SIGCHLDÂ 18) SIGCONTÂ 19) SIGSTOPÂ 20) SIGTSTP 21) SIGTTINÂ 22) SIGTTOUÂ 23) SIGURGÂ 24) SIGXCPUÂ 25) SIGXFSZ 26) SIGVTALRMÂ 27) SIGPROFÂ 28) SIGWINCHÂ 29) SIGIOÂ 30) SIGPWR 31) SIGSYSÂ 34) SIGRTMINÂ 35) SIGRTMIN+1Â 36) SIGRTMIN+2Â 37) SIGRTMIN+3 38) SIGRTMIN+4Â 39) SIGRTMIN+5Â 40) SIGRTMIN+6Â 41) SIGRTMIN+7Â 42) SIGRTMIN+8 43) SIGRTMIN+9Â 44) SIGRTMIN+10Â 45) SIGRTMIN+11Â 46) SIGRTMIN+12Â 47) SIGRTMIN+13 48) SIGRTMIN+14Â 49) SIGRTMIN+15Â 50) SIGRTMAX-14Â 51) SIGRTMAX-13Â 52) SIGRTMAX-12 53) SIGRTMAX-11Â 54) SIGRTMAX-10Â 55) SIGRTMAX-9Â 56) SIGRTMAX-8Â 57) SIGRTMAX-7 58) SIGRTMAX-6Â 59) SIGRTMAX-5Â 60) SIGRTMAX-4Â 61) SIGRTMAX-3Â 62) SIGRTMAX-2 63) SIGRTMAX-1Â 64) SIGRTMAXÂ å¸¸ç”¨çš„ä¿¡å·ï¼š\n**Â 1) SIGHUP è®©ä¸€ä¸ªè¿›ç¨‹ä¸ç”¨é‡å¯ï¼Œå°±å¯ä»¥é‡è¯»å…¶é…ç½®æ–‡ä»¶ï¼Œå¹¶è®©æ–°é…ç½®ç”Ÿæ•ˆ\n2) SIGINT ç¡¬ä»¶ä¸­æ–­ä¿¡å·ã€‚ Ctrl+c\n9) SIGKILL æ€æ­»ä¸€ä¸ªè¿›ç¨‹\n15) SIGTERM ç»ˆæ­¢ä¸€ä¸ªè¿›ç¨‹\nå¦‚ä½•è°ƒç”¨ä¸€ä¸ªä¿¡å·ï¼š\nä¿¡å·å·ç ï¼š kill -9 \u0026lt;PID\u0026gt; ï¼ˆæ€æ­»ç¨‹åºåï¼Œè¦åˆ é™¤äº¤äº’æ–‡ä»¶ï¼Œæ‰èƒ½æ­£å¸¸æ¢å¤ï¼‰\nä¿¡å·åç§°ï¼š kil -SIGKILL \u0026lt;PID\u0026gt;\nä¿¡å·åç§°ç®€å†™ï¼škill -KILL \u0026lt;PID\u0026gt;**\n# kill \u0026lt;PID\u0026gt;\n**# killall \u0026lt;PROCESS_NAME\u0026gt;Â **\n1 [root@wei csdn]# killall httpd æ§åˆ¶è¿›ç¨‹çš„è¿è¡Œæ–¹å¼ï¼ˆå‰å°/åå°ï¼‰\nå‰å°ï¼šå ç”¨å‘½ä»¤æç¤ºç¬¦\nï¼ˆ1ï¼‰æ§åˆ¶å‘½ä»¤åœ¨åå°è¿è¡Œ\n1 [root@wei csdn]# firefox \u0026amp; ï¼ˆ2ï¼‰æŸ¥çœ‹åå°çš„åº”ç”¨ç¨‹åº\n1 [root@wei csdn]# jobs -l **Â ï¼ˆ3ï¼‰å°†æ­£åœ¨è¿è¡Œçš„æŒ‡ä»¤æ”¾å…¥åå°ï¼Œå¹¶æš‚åœè¿è¡Œ**\n**Â Ctrl+z**\nï¼ˆ4ï¼‰å°†åå°çš„ç¨‹åºè°ƒå›å‰å°ç»§ç»­è¿è¡Œ\n# fg \u0026lt;åå°ä»»åŠ¡ç¼–å·\u0026gt;\n","date":"2019-01-30T20:51:51Z","image":"https://www.ownit.top/title_pic/50.jpg","permalink":"https://www.ownit.top/p/201901302051/","title":"Linuxè¿›ç¨‹æ§åˆ¶"},{"content":"å…³äºLinuxè¿›ç¨‹æŸ¥çœ‹ï¼Œå‰é¢è®²è§£äº†pså‘½ä»¤ï¼Œä¸‹é¢æ‹‰ä»‹ç»å¦ä¸€ä¸ªå‘½ä»¤top\npsï¼šé™æ€æŸ¥çœ‹\ntopï¼šåŠ¨æ€æŸ¥çœ‹\nåŠ¨æ€æŸ¥çœ‹è¿›ç¨‹çš„çŠ¶æ€Â # top\n1 2 3 4 5 6 7 [root@wei ~]# top top - 18:38:46 up 15 min, 2 users, load average: 0.09, 0.07, 0.06 Tasks: 98 total, 1 running, 97 sleeping, 0 stopped, 0 zombie %Cpu(s): 1.0 us, 1.3 sy, 0.0 ni, 97.7 id, 0.0 wa, 0.0 hi, 0.0 si, 0.0 st KiB Mem : 997956 total, 613748 free, 215484 used, 168724 buff/cache KiB Swap: 2097148 total, 2097148 free, 0 used. 605556 avail Mem 7.6%us ç”¨æˆ·è¿›ç¨‹å ç”¨çš„CPU\n1.6%sy ç³»ç»Ÿè¿›ç¨‹å ç”¨çš„CPU\n0.0%ni è°ƒæ•´è¿‡ä¼˜å…ˆçº§çš„è¿›ç¨‹å ç”¨çš„CPU\n90.6%id CPUç©ºé—²\n0.0%wa ç­‰å¾…ç£ç›˜IOçš„è¿›ç¨‹æ‰€å ç”¨çš„CPU\nCpu(s) :æ˜¾ç¤ºæ‰€æœ‰çš„CPUå¹³å‡æ¯”ï¼ŒæŒ‰1å¯ç°å®æ¯ä¸ªCPUçš„ä½¿ç”¨æƒ…å†µ\ntopäº¤äº’å¼æŒ‡ä»¤ï¼š\nMï¼šæŒ‰å†…å­˜ä½¿ç”¨æ’åº\nPï¼šæŒ‰CPUä½¿ç”¨æ’åºÂ Tï¼šæŒ‰è¿è¡Œæ—¶é—´æ’åº\nl: æ˜¯å¦æ˜¾ç¤ºTOPç¬¬1è¡Œä¿¡æ¯\nm: æ˜¯å¦æ˜¾ç¤ºå†…å­˜ä½¿ç”¨ä¿¡æ¯\nt: æ˜¯å¦æ˜¾ç¤ºCPUåŠä»»åŠ¡ä¿¡æ¯\ncï¼šæ˜¯å¦æ˜¾ç¤ºå®Œæ•´çš„å‘½ä»¤è¡Œ\nqï¼šé€€å‡ºTOP\næ˜¾ç¤ºå½“å‰æ—¶åˆ»CPUçš„ä½¿ç”¨æƒ…å†µ\n1 2 [root@wei ~]# uptime 19:03:27 up 39 min, 2 users, load average: 0.00, 0.01, 0.05 topé€‰é¡¹ï¼š\n-d 1 ï¼šæŒ‡å®štopä¿¡æ¯åˆ·æ–°çš„é¢‘ç‡\n-b ï¼šä»¥æ‰¹æ¨¡å¼æ˜¾ç¤ºè¿›ç¨‹ä¿¡æ¯\n-n 2ï¼šå…±æ˜¾ç¤ºä¸¤æ‰¹ä¿¡æ¯\n# top -d 1 -b -n 2\næŸ¥çœ‹æœåŠ¡å™¨æ€§èƒ½ ï¼š\n1.ps ï¼Œtop\n2.df -hT\n3.free -m æŸ¥çœ‹ç£ç›˜\nä½¿ç”¨è¿™ä¸‰ä¸ªå‘½ä»¤éœ€è¦å®‰è£…sysstat\n1 [root@wei csdn]# yum install sysstat # mpstat æŸ¥çœ‹CPU\n# vmstat æŸ¥çœ‹å†…å­˜\n# iostat æŸ¥çœ‹ç£ç›˜\n# sar æŸ¥çœ‹ç½‘å¡\nå››ä¸ªåŸºæœ¬ç”¨æ³•ä¸€æ ·ï¼Œå‚æ•°è®¾ç½®ä¸€æ ·ã€‚\n1 2 [root@wei csdn]# mpstat 1 ä¸€ç§’æ˜¾ç¤ºä¸€æ¬¡ [root@wei csdn]# mpstat 1 5 ä¸€ç§’æ˜¾ç¤ºä¸€æ¬¡ï¼Œæ˜¾ç¤º5æ¬¡ ","date":"2019-01-29T17:10:43Z","image":"https://www.ownit.top/title_pic/29.jpg","permalink":"https://www.ownit.top/p/201901291710/","title":"Linuxè¿›ç¨‹ç®¡ç†ä¹‹top"},{"content":"**LinuxÂ æ˜¯ä¸€ç§åŠ¨æ€ç³»ç»Ÿï¼Œèƒ½å¤Ÿé€‚åº”ä¸æ–­å˜åŒ–çš„è®¡ç®—éœ€æ±‚ã€‚**ä¸‹é¢ä»‹ç»ä¸€äº› Linux æ‰€æä¾›çš„å·¥å…·æ¥è¿›è¡Œè¿›ç¨‹çš„æŸ¥çœ‹ä¸æ§åˆ¶ï¼ŒæŒæ¡è¿™äº›è®©æˆ‘ä»¬èƒ½åœ¨æŸäº›è¿›ç¨‹å‡ºç°å¼‚å¸¸çš„æ—¶å€™åŠæ—¶æŸ¥çœ‹ç›¸å…³çš„æŒ‡æ ‡ï¼Œä»è€Œè§£å†³é—®é¢˜ã€‚\nè¿›ç¨‹ç®¡ç†\nè¿›ç¨‹ process\næŸåº”ç”¨ç¨‹åºæ‰“å¼€çš„è¿›ç¨‹\nPID Process ID\nç±»å‹ï¼š\nç”¨æˆ·ç©ºé—´è¿›ç¨‹\nå†…æ ¸ç©ºé—´è¿›ç¨‹\nç”¨æˆ·ç©ºé—´è¿›ç¨‹ï¼šé€šè¿‡æ‰§è¡Œç”¨æˆ·ç¨‹åºã€åº”ç”¨ç¨‹åºæˆ–å†…æ ¸ä¹‹å¤–çš„ç³»ç»Ÿç¨‹åºè€Œäº§ç”Ÿçš„è¿›ç¨‹ï¼Œæ­¤ç±»è¿›ç¨‹å¯ä»¥åœ¨ç”¨æˆ·çš„æ§åˆ¶ä¸‹è¿è¡Œæˆ–å…³é—­ã€‚\nå†…æ ¸ç©ºé—´è¿›ç¨‹ï¼šå¯ä»¥æ‰§è¡Œå†…å­˜èµ„æºåˆ†é…å’Œè¿›ç¨‹åˆ‡æ¢ç­‰ç®¡ç†å·¥ä½œï¼›è€Œä¸”ï¼Œè¯¥è¿›ç¨‹çš„è¿è¡Œä¸å—ç”¨æˆ·çš„å¹²é¢„ï¼Œå³ä½¿æ˜¯rootç”¨æˆ·ä¹Ÿä¸èƒ½å¹²é¢„ç³»ç»Ÿè¿›ç¨‹çš„è¿è¡Œã€‚\né™æ€æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€\n1 2 3 4 5 6 # ps [root@wei csdn]# ps \u0026gt;\u0026gt;\u0026gt;\u0026gt;æŸ¥çœ‹æœ¬ç»ˆç«¯çš„è¿›ç¨‹ PID TTY TIME CMD 1806 pts/1 00:00:00 bash 2805 pts/1 00:00:00 ps é€‰é¡¹çš„ä½¿ç”¨æ–¹å¼ï¼š\nBSDé£æ ¼ï¼šé€‰é¡¹æ²¡æœ‰æ¨ªçº¿- ps aux\nSysVé£æ ¼ï¼šé€‰é¡¹éœ€è¦å¸¦æœ‰æ¨ªçº¿- ps -elf\nBSDé£æ ¼ï¼š\na ï¼šæ˜¾ç¤ºä¸ç»ˆç«¯ç›¸å…³çš„è¿›ç¨‹\nu : æ˜¾ç¤ºå¯åŠ¨è¿›ç¨‹çš„ç”¨æˆ·\nx ï¼šæ˜¾ç¤ºä¸ç»ˆç«¯æ— å…³çš„ç¨‹åº\n1 2 3 4 5 # ps a # ps u # ps x 1 2 3 4 5 [root@wei csdn]# ps u USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 1343 0.0 0.2 115436 2032 pts/0 Ss+ 19:59 0:00 -bash root 1674 0.0 0.2 115432 2032 tty1 Ss+ 20:01 0:00 -bash USERè¿è¡Œè¿›ç¨‹çš„ç”¨æˆ·%CPUè¿›ç¨‹æ‰€å æ¬§è¯ºä¸ªçš„CPUç™¾åˆ†æ¯”\u0026nbsp;%MEM\u0026nbsp;è¿›ç¨‹æ‰€å ç”¨çš„MEMç™¾åˆ†æ¯”VSZ\u0026nbsp;è™šæ‹Ÿå†…å­˜é›†ï¼Œè¿›ç¨‹ç‹¬æœ‰çš„å†…å­˜+å…±äº«å­˜åœ¨PSSè¿›ç¨‹ç‹¬æœ‰çš„å†…å­˜ STAT è¿›ç¨‹çš„çŠ¶æ€\nD: ä¸å¯ä¸­æ–­çš„ç¡çœ ï¼ˆç­‰å¾…ç£ç›˜IOå®Œæˆï¼‰\nSï¼šå¯ä¸­æ–­çš„ç¡çœ ï¼ˆä¸éœ€è¦ç­‰å¾…ç£ç›˜IOå®Œæˆï¼‰\nRï¼šè¿è¡Œæˆ–å°±ç»ª\nT: åœæ­¢\nZï¼šåƒµæ­» Zombie\n\u0026lt; :é«˜ä¼˜å…ˆçº§è¿›ç¨‹\nä¼šè¢«CPUä¼˜å…ˆæ‰§è¡Œ\nä¼šè·å–æ›´å¤šçš„CPUæ‰§è¡Œæ—¶é—´Â N:ä½ä¼˜å…ˆçº§è¿›ç¨‹\n+ï¼šå‰å°è¿›ç¨‹ç»„ä¸­çš„è¿›ç¨‹\nl:å¤šçº¿ç¨‹è¿›ç¨‹ï¼ˆThreadï¼‰\nsï¼šä¼šè¯è¿›ç¨‹é¦–è¿›ç¨‹ï¼ŒæŸä¸€ä¸ªè¿æ¥çš„çˆ¶è¿›ç¨‹\n1 2 3 4 5 6 [root@wei csdn]# ps aux |less USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 1 0.1 0.6 127940 6580 ? Ss 19:58 0:03 /usr/lib/systemd/systemd --switched-root --system --deserialize 22 root 2 0.0 0.0 0 0 ? S 19:58 0:00 [kthreadd] root 3 0.0 0.0 0 0 ? S 19:58 0:00 [ksoftirqd/0] root 5 0.0 0.0 0 0 ? S\u0026lt; 19:58 0:00 [kworker/0:0H] **Â å¸¦æœ‰æ–¹æ‹¬å·ä¸ºç³»ç»Ÿè¿›ç¨‹ï¼ˆLinuxå†…æ ¸å¯åŠ¨ï¼‰\næ— æ–¹æ‹¬å·çš„ï¼ˆç”¨æˆ·è¿›ç¨‹ï¼‰**\nSysVé£æ ¼é€‰é¡¹ï¼š\n-e æ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹\n-l è¯¦ç»†ä¿¡æ¯\n-f ä»¥é•¿æ ¼å¼æ˜¾ç¤ºï¼ˆæ›´å¤šå­—æ®µç±»å®¹ï¼‰\n1 2 3 4 5 6 [root@wei csdn]# ps -elf | less F S UID PID PPID C PRI NI ADDR SZ WCHAN STIME TTY TIME CMD 4 S root 1 0 0 80 0 - 31985 ep_pol 19:58 ? 00:00:04 /usr/lib/systemd/systemd --switched-root --system --deserialize 22 1 S root 2 0 0 80 0 - 0 kthrea 19:58 ? 00:00:00 [kthreadd] 1 S root 3 2 0 80 0 - 0 smpboo 19:58 ? 00:00:01 [ksoftirqd/0] è¿›ç¨‹ä¼˜å…ˆçº§ï¼š\n0\u0026mdash;139\næ•°æ®è¶Šå°ï¼Œè¶Šå…ˆçº§è¶Šé«˜\né«˜ä¼˜å…ˆçº§è¿›ç¨‹ï¼š\nä¼šè·å–CPUæ›´å¤šçš„æ‰§è¡Œæ—¶é—´\nä¼šè¢«CPUä¼˜å…ˆæ‰§è¡Œ\nniceå€¼ï¼š\næ–°ä¼˜å…ˆçº§=æ—§ä¼˜å…ˆçº§â€”â€”niceå€¼\n-20\u0026mdash;-19\næ™®é€šç”¨æˆ·ä»…èƒ½å¤Ÿè°ƒå¤§niceå€¼ï¼Œæ—¢é™ä½è¿›ç¨‹ä¼˜å…ˆçº§\nrootç”¨æˆ·å¯ä»¥éšæ„è°ƒæ•´niceå€¼\næ˜¾ç¤ºè¿›ç¨‹æ ‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [root@wei csdn]# yum install psmisc # å®‰è£…æ˜¾ç¤ºpstreeçš„å‘½ä»¤åŒ… [root@wei csdn]# pstree systemdâ”€â”¬â”€NetworkManagerâ”€â”€â”€2*[{NetworkManager}] â”œâ”€VGAuthService â”œâ”€auditdâ”€â”€â”€{auditd} â”œâ”€crond â”œâ”€dbus-daemonâ”€â”€â”€{dbus-daemon} â”œâ”€loginâ”€â”€â”€bash â”œâ”€lvmetad â”œâ”€masterâ”€â”¬â”€pickup â”‚ â””â”€qmgr â”œâ”€mysqld_safeâ”€â”€â”€mysqldâ”€â”€â”€21*[{mysqld}] â”œâ”€polkitdâ”€â”€â”€5*[{polkitd}] â”œâ”€rsyslogdâ”€â”€â”€2*[{rsyslogd}] â”œâ”€sshdâ”€â”¬â”€2*[sshdâ”€â”€â”€bash] â”‚ â””â”€sshdâ”€â”€â”€bashâ”€â”€â”€pstree â”œâ”€systemd-journal â”œâ”€systemd-logind â”œâ”€systemd-udevd â”œâ”€tunedâ”€â”€â”€4*[{tuned}] â””â”€vmtoolsdâ”€â”€â”€{vmtoolsd} 1 2 3 4 5 6 7 [root@wei csdn]# ps aux | grep vim root 2917 0.2 0.5 151600 5136 pts/2 S+ 21:39 0:00 vim list root 2925 0.0 0.0 112720 984 pts/1 R+ 21:43 0:00 grep --color=auto vim [root@wei csdn]# pidof vim 2917 [root@wei csdn]# pidof bash 1828 1806 1674 1343 ","date":"2019-01-29T16:45:00Z","image":"https://www.ownit.top/title_pic/45.jpg","permalink":"https://www.ownit.top/p/201901291645/","title":"Linuxè¿›ç¨‹ç®¡ç†ä¹‹ps"},{"content":"å‰é¢è®²è§£äº†lLinux çš„IPç»„æˆï¼Œä¸‹é¢å°±è®²ä¸€ä¸‹Linuxçš„ç½‘ç»œè®¾ç½®å’Œæ•°æ®ä¼ é€’ã€‚\nå…¶å®è¿™åœ°æ–¹å¯¹è¿ç»´çš„äººå‘˜æ¥è¯´ï¼Œä¸ä¼šè¦ç²¾é€šï¼Œä½†è¿˜æ˜¯è¦äº†è§£ã€‚å¿…è¦æ—¶åˆ»è¿˜ä¼šç”¨åˆ°çš„\nç”µè„‘ä¹‹é—´æ•°æ®çš„ä¼ é€’ï¼š\næ•°æ®çš„ä¼ é€’è¦åˆ†ä¸ºä¸‹é¢å‡ å±‚ã€‚\nOSIä¸ƒå±‚æ¨¡å‹\nåº”ç”¨å±‚ è¡¨ç¤ºå±‚ ä¼šè¯å±‚ ä¼ è¾“å±‚ ç½‘ç»œå±‚ æ•°æ®é“¾è·¯å±‚ ç‰©ç†å±‚\næ•°æ®å°è£…è¿‡ç¨‹ï¼š\nMACå¸§å¤´+IPæŠ¥å¤´+TCP/UDPæŠ¥å¤´+æ•°æ®\nTCP/UDPæŠ¥å¤´:\nç«¯å£å· Port åŒºåˆ†ä¸åŒçš„åº”ç”¨ç¨‹åº\nå–å€¼èŒƒå›´ï¼š1\u0026mdash;65535 åŸºäºipåœ°å€\n**æ•°æ®è§£åŒ…ï¼Œåˆ™åä¹‹ã€‚Â **\ncentos 7 æä¾›network ï¼ŒNetworkManageræœåŠ¡å®ç°ç½‘ç»œå‚æ•°\nåŸºäºnetworkæœåŠ¡\n1.æŸ¥çœ‹æ“ä½œ\nï¼ˆ1ï¼‰æŸ¥çœ‹ç½‘å¡IPåœ°å€\n# ifconfig\n# ip addr show\nï¼ˆ2ï¼‰æŸ¥çœ‹ç½‘å…³\n**# route -nÂ **\n# ip route\nï¼ˆ3ï¼‰æŸ¥çœ‹DNSæœåŠ¡åœ°å€\n# cat /etc/resolv.conf\n1 [root@wei ~]# cat /etc/resolv.conf ä¿®æ”¹ç½‘å¡TCP/IPå‚æ•°\n**é…ç½®æ–‡ä»¶åœ°æ–¹ /etc/sysconfig/network-scripts/ifcfg-ens33Â **\nå†…å®¹:\nDEVICE=ç½‘å¡åç§°\nNANE=ç½‘å¡é…ç½®æ–‡ä»¶åç§°\nONBOOT=yes //è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨ç½‘å¡\nBOOTPROTO=none //æ‰‹åŠ¨æŒ‡å®šIP\nIPADDR=192.168.196.131 //IPåœ°å€Â NETMASK=255.255.255.0 //å­ç½‘æ©ç  æˆ–è€…PREFIX=24\nGATEWAY=192.168.196.2 //ç½‘å…³\nDNS1=8.8.8.8 //dnsæœåŠ¡åœ°å€\nDNS2=8.8.4.4\nç¤ºä¾‹ï¼š\n**Â ä¸ºeth0ç½‘å¡é…ç½®å¤šä¸ªIPåœ°å€ 10.1.1.1/24\nä¸´æ—¶ç”Ÿæ•ˆï¼š**\n[root@wei ~]# ifconfig ens33:0 10.1.1.1/24\n[root@wei ~]# ip addr dev ens33 10.1.1.1/24\næ°¸ä¹…ç”Ÿæ•ˆï¼š\n[root@wei ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33:0\n**DEVICE=en33s:0\nNANE=ens33:0\nONBOOT=yes BOOTPROTO=none IPADDR=192.168.196.131 NETMASK=255.255.255.0 **\n[root@wei ~]# systemctl restart NetworkManager\n[root@wei ~]# systemctl restart network\nä¸´æ—¶ç¦ç”¨ç½‘å¡\n# ifdown ç½‘å¡åç§°\nå¯ç”¨ç½‘å¡\n# if ç½‘å¡åç§°\nç«¯å£å·ï¼ˆportï¼‰ï¼š\nï¼ˆ1ï¼‰æŸ¥çœ‹TCPç«¯å£\n[root@wei csdn]# ss -antp\n**Â a: all å…¨éƒ¨\nnï¼šnumber æ•°æ®\npï¼šport ç«¯å£å·ï¼š\ntï¼štcp åè®®\n[root@wei csdn]# netstat -antp**\nï¼ˆ2ï¼‰æŸ¥çœ‹UDPç«¯å£\n[root@wei csdn]# ss -anup\n[root@wei csdn]# netstat -anup\nï¼ˆ3ï¼‰æŸ¥çœ‹æ‰€æœ‰çš„UDPå’ŒTCPçš„ç«¯å£\n[root@wei csdn]# netstat -anutp\n[root@wei csdn]# ss -anutp\n","date":"2019-01-28T16:08:55Z","image":"https://www.ownit.top/title_pic/20.jpg","permalink":"https://www.ownit.top/p/201901281608/","title":"Linuxçš„ç½‘ç»œå‚æ•°è®¾ç½®"},{"content":"**Â ä¿—è¯è¯´ï¼šé»‘å‘ä¸çŸ¥å‹¤å­¦æ—©ï¼Œç™½é¦–æ–¹æ‚”è¯»ä¹¦è¿Ÿã€‚** **Â â€”â€”â€”â€”æ­£æ˜¯å¹´è½»çš„æˆ‘ä»¬ï¼Œæ›´åº”è¯¥åƒè‹¦å­¦ä¹ ï¼Œå·¥ä½œã€‚åŠ æ²¹å§ï¼Œ**\nå‰é¢ä»‹ç»äº†linuxçš„è½¯ä»¶ç®¡ç†ã€‚ä¸‹é¢å°±ä»‹ç»å…³äºlinuxçš„ipè¯¦è§£ã€‚\nLinuxç³»ç»Ÿç½‘ç»œå‚æ•°åˆ†åˆ«ä¸ºï¼š\n**Â è®¡ç®—æœºåç§°\nIPåœ°å€\nå­ç½‘æ©ç \né»˜è®¤ç½‘å…³\nDNSæœåŠ¡\n1.è®¡ç®—æœºåç§°**\nCentos 7ï¼š\nï¼ˆæ³¨æ„ï¼šcentos6ä¸æ˜¯è¿™æ ·ä¿®æ”¹ï¼Œéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼‰\n1 #hostnamectl set-hostname node01.linux.com ã€FQDN å®Œå…¨åˆæ ¼åŸŸåã€‘ æŸ¥çœ‹Linuxä¸»æœºåçš„é…ç½®æ–‡ä»¶\n**# cat /etc/hostnameÂ **\né‡ç‚¹\nIPåœ°å€ 192.168.196.131 ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºæ³•\nç»„æˆï¼š32ä½äºŒè¿›åˆ¶æ•°å­—\nxxxxxxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx\n0\u0026ndash;255 0\u0026ndash;255 0\u0026ndash;255 0\u0026ndash;255\nå¤§è‡´èŒƒå›´ï¼š0.0.0.0\u0026ndash;255.255.255.255\nç±»å‹ï¼š\n1.æ ¹æ®ç¬¬ä¸€ä¸ªå­—èŠ‚çš„å–å€¼èŒƒå›´åˆ†ç±»\nAç±»ï¼š0\u0026ndash;127\nBç±»ï¼š128\u0026ndash;191\nCç±»ï¼š192\u0026ndash;223 å•æ’­åœ°å€ Unicastï¼ˆå‰ä¸‰ä¸ªï¼‰åŒä¸€ä¸ªç½‘ç»œå†…ï¼Œä¸€ä¸ªIPåœ°å€åªèƒ½æ ‡è¯†ä¸€ä¸ªç½‘ç»œèŠ‚ç‚¹\nDç±»ï¼š224\u0026ndash;239 ç»„æ’­åœ°å€ Multicast\nEç±»ï¼š240\u0026ndash;255 ç§‘å­¦ç ”ç©¶\n2.æ ¹æ®IPåœ°å€çš„ä½¿ç”¨èŒƒå›´\nç§ç½‘åœ°å€ï¼ˆä¸èƒ½ç›´æ¥è®¿é—®äº’è”ç½‘ï¼Œå¯é‡å¤ä½¿ç”¨ï¼‰\n10.0.0.0\u0026mdash;\u0026mdash;\u0026mdash;\u0026ndash;10.255.255.255\n172.16.0.0\u0026mdash;\u0026mdash;\u0026mdash;172.31.255.255\n192.168.0.0\u0026mdash;\u0026mdash;\u0026mdash;192.168.255.255\nå…¬ç½‘åœ°å€\nç‰¹æ®Šåœ°å€ï¼š\n127.x.x.x 127.0.0.0\n168.254.x.x\nå­ç½‘æ©ç  netmask\nä½œç”¨ï¼š åˆ¤æ–­å¤šä¸ªåœ°å€æ˜¯å¦å±äºåŒä¸€ç½‘ç»œ\nåŸç†ï¼šåˆ†åˆ«å°†IPåœ°å€ä¸å­ç½‘æ©ç è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°å­—ï¼Œä¾æ¬¡è¿›è¡Œé€»è¾‘ä¸è¿ç®—ï¼ˆç½‘æ®µï¼‰\né»˜è®¤å­ç½‘æ©ç ï¼ˆåªæ˜¯é»˜è®¤ï¼Œä¸æ˜¯å›ºå®šï¼‰\nAç±»ï¼š255.0.0.0 /8\nBç±»ï¼š255.255.0.0 /16\nCç±»ï¼š255.255.255.0 /24\n192.168.1.1 255.255.255.0 -\u0026mdash;\u0026mdash;-\u0026gt;192.168.1.1/24\n","date":"2019-01-27T22:22:32Z","image":"https://www.ownit.top/title_pic/46.jpg","permalink":"https://www.ownit.top/p/201901272222/","title":"Linuxçš„IPè¯¦è§£"},{"content":"å‰é¢ä»‹ç»äº†è½¯ä»¶çš„ç®¡ç†çš„æ–¹å¼rpmã€‚ä½†æœ‰ä¸ªç¼ºç‚¹ï¼Œrpmä¸èƒ½è§£å†³ä¾èµ–ã€‚\nä¸‹é¢ä»‹ç»çš„yumè½¯ä»¶ç®¡ç†ã€‚å¯ä»¥å®Œç¾çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nä½¿ç”¨yumçš„æ–¹å¼ç®¡ç†rpmè½¯ä»¶\nä¼˜åŠ¿ï¼šè‡ªåŠ¨è§£å†³è½¯ä»¶çš„ä¾èµ–å…³ç³»\nå‰ææ¡ä»¶ï¼šé…ç½®yumä»“åº“/yumæº\nyumæºç±»å‹ï¼š **Â 1.æœ¬åœ°yumæº 2.ftpæº\n3.httpæº\n**\n**Â é…ç½®yumçš„åœ°æ–¹ï¼š**\n**Â é˜¿é‡Œäº‘é•œåƒï¼šÂ https://mirrors.aliyun.com\nç½‘æ˜“äº‘é•œåƒï¼š http://mirrors.163.com/\nepelæº Centoså®˜ç½‘ ï¼šhttp://vault.centos.orgÂ # yum install epel-release å®‰è£…epelæº\n**\nyumæº/yumä»“åº“çš„é…ç½®æ–‡ä»¶\n/etc/yum.repos.d/*.repo\nç¤ºä¾‹ï¼šé…ç½®æœ¬åœ°yumæº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 [root@wei yum.repos.d]# mount /dev/sr0 /mnt/ mount: /dev/sr0 å†™ä¿æŠ¤ï¼Œå°†ä»¥åªè¯»æ–¹å¼æŒ‚è½½ [root@wei yum.repos.d]# ls /mnt/ CentOS_BuildTag EULA images LiveOS repodata RPM-GPG-KEY-CentOS-Testing-7 EFI GPL isolinux Packages RPM-GPG-KEY-CentOS-7 TRANS.TBL [root@wei yum.repos.d]# mkdir /etc/yum.repos.d/beifeng [root@wei yum.repos.d]# mv /etc/yum.repos.d/CentOS-* /etc/yum.repos.d/beifeng/ [root@wei yum.repos.d]# ls beifeng mysql-community.repo mysql-community-source.repo [root@wei yum.repos.d]# vim centos.repo [root@wei yum.repos.d]# ls beifeng centos.repo mysql-community.repo mysql-community-source.repo é…ç½®å†…å®¹ï¼š [centos7.2] name=centos7.2 baseurl=file:///mnt enable=1 gpgcheck=0 æ¸…é™¤yumç¼“å­˜ï¼š\n1 [root@wei yum.repos.d]# yum clean all ç”Ÿæˆyumç¼“å­˜ï¼š\n1 [root@wei yum.repos.d]# yum makecache æŸ¥çœ‹yumçš„åˆ—è¡¨\n1 [root@wei yum.repos.d]# yum repolist yumå¸¸è§„æ“ä½œ\nï¼ˆ1ï¼‰yumå®‰è£…è½¯ä»¶ # yum install è½¯ä»¶å\n# yum install -y è½¯ä»¶å\nï¼ˆ2ï¼‰æ˜¾ç¤ºyumä¸­æ‰€æœ‰è½¯ä»¶\n1 [root@wei ~]# yum list all ï¼ˆ3ï¼‰æ˜¾ç¤ºæ‰€æœ‰çš„è½¯ä»¶ç»„\n1 [root@wei ~]# yum grouplist ï¼ˆ4ï¼‰å®‰è£…è½¯ä»¶ç»„\n# yum groupinstall -y è½¯ä»¶ç»„çš„åç§°\n(è‹±æ–‡ç»„ï¼Œè¦ç”¨â€œâ€æ‹¬èµ·æ¥)\nï¼ˆ5ï¼‰æŸ¥è¯¢æ–‡ä»¶æ‰€å±çš„è½¯ä»¶åç§°\n# yum provides â€œ*bin/passwdâ€\næºç è½¯ä»¶ç®¡ç†å®‰è£… **Â 1.é…ç½®å®‰è£…å‚æ•° 2.ç¼–è¯‘\n3.å®‰è£…**\nå‰æï¼šgccç¼–è¯‘ç¯å¢ƒï¼ˆè‡ªå·±å®‰è£…yum install gccï¼‰\nç¤ºä¾‹ï¼šç¼–è¯‘å®‰è£…htopè½¯ä»¶\nhtopè½¯ä»¶æºç ï¼šhttps://www.lanzous.com/i2zs97g\n**è§£å‹\n[root@wei ~]# tar zxf htop-1.0.2.tar.gzÂ **\nåˆ‡å…¥htop-1.0.2ç›®å½•\n[root@wei ~]#cd htop-1.0.2\næŸ¥çœ‹é…ç½®\n[root@wei htop-1.0.2]# ./configure --help |less\né…ç½®å‚æ•°\n[root@wei htop-1.0.2]# ./configure --prefix=/usr/local/htop\nç¼–è¯‘\n[root@wei htop-1.0.2]# make\nå®‰è£…\n[root@wei htop-1.0.2]# make install\nå¯åŠ¨ï¼ˆå·²ç»å®‰è£…æˆåŠŸæ¥ç•Œé¢ï¼‰\n**[root@wei share]# /usr/local/htop/bin/htopÂ **\nå‡ºç°é”™è¯¯ï¼š\nconfigure: error: You may want to use --disable-unicode or install libncursesw.\n**è§£å†³åŠæ³•ï¼š\n[root@wei htop-1.0.2]# yum install -y ncurses-develÂ **\n","date":"2019-01-26T17:04:22Z","image":"https://www.ownit.top/title_pic/54.jpg","permalink":"https://www.ownit.top/p/201901261704/","title":"Linuxçš„yumç®¡ç†"},{"content":"**Â ä¹¦å±±æœ‰è·¯å‹¤ä¸ºå¾„ï¼Œå­¦æµ·æ— æ¶¯è‹¦ä½œèˆŸ** è‡ªå­¦linuxå·²ç»æœ‰å‡ å¤©äº†ï¼Œæ„Ÿè§‰è¿˜å¯ä»¥ã€‚åšæŒä¸‹å»ï¼Œå°±ä¼šæœ‰æ”¶è·ã€‚\næ¯ä¸ªç³»ç»Ÿéƒ½ç”¨ç›¸åº”çš„è½¯ä»¶çš„ç®¡ç†ï¼ŒLinuxä¹Ÿä¸ä¾‹å¤–ã€‚ä¸‹é¢è®²è§£Linux çš„rpmç®¡ç†è½¯ä»¶ã€‚\nLinuxè½¯ä»¶ç®¡ç†\n**Â windowsï¼š.exe .mai\ncentos/RHEL/FedoeaÂ ï¼šäºŒè¿›åˆ¶æ ¼å¼è½¯ä»¶(*.rpm) redhat package management\næºç è½¯ä»¶(*.tar.gz , *.tar.bz2)Â **\nrpmè½¯ä»¶ç®¡ç†\n**Â å…‰ç›˜isoé•œåƒæ–‡ä»¶\nrpmè½¯ä»¶åç§°çš„ç»„æˆ\nzlib-devel-1.2.7-17.el7.x86_64.rpm\nzlib-develï¼šè½¯ä»¶åç§°\n1.2.7ï¼šç‰ˆæœ¬\nel7.x86_64 ï¼š è½¯ä»¶è¿è¡Œå¹³å°\nel7.noarch ï¼š æ— ç³»ç»Ÿæ¶æ„ï¼Œå¯ä»¥å®‰è£…ä»»ä½•ç‰ˆæœ¬**\nä¸‹é¢çš„ä¸¤ä¸ªç½‘ç«™å¯ä»¥ä¸‹è½½rpmåŒ…ï¼ˆç½‘ç«™æ˜¯å›½å¤–çš„ï¼Œå¯èƒ½æ¯”è¾ƒæ…¢ï¼‰\nrpmä¸‹è½½ï¼šÂ https://pkgs.org/\nrpmä¸‹è½½ï¼šÂ http://rpmfind.net/\næ³¨æ„ï¼šä½ ä¸‹è½½çš„rpmåŒ…è¦å¯¹åº”ä½ æœåŠ¡å™¨çš„ç‰ˆæœ¬å·å’Œè¿è¡Œå¹³å°\næŸ¥çœ‹ç³»ç»Ÿå¹³å°ä¿¡æ¯ 1 [root@wei ~]# uname -r æ³¨æ„ï¼šæœ¬åœ°ç³»ç»Ÿæ²¡æœ‰rpmè½¯ä»¶åŒ…ï¼Œé‚£ä¹ˆåªèƒ½æŒ‚è½½isoé•œåƒæ–‡ä»¶ ï¼ˆ1ï¼‰æœ‰å’Œè¿è¡Œå¹³å°ç›¸å¯¹åº”çš„isoé•œåƒæ–‡ä»¶ï¼ˆæˆ‘çš„centos7çš„ï¼‰\nï¼ˆ2ï¼‰è®¾ç½®è™šæ‹Ÿæœºï¼ŒåŠ è½½é•œåƒæ–‡ä»¶\nï¼ˆ3ï¼‰å…‰ç›˜æŒ‚è½½\n1 [root@wei dev]# mount /dev/sr0 /mnt/ å…‰ç›˜å¸è½½\n1 [root@wei dev]# umount /dev/sr0Â ç®¡ç†rpmè½¯ä»¶\n1.æŸ¥è¯¢è½¯ä»¶æ˜¯å¦å®‰è£…\n# rpm -q è½¯ä»¶åç§°\n# rpm -qa | grep è½¯ä»¶åç§°\n2.æŸ¥è¯¢è½¯ä»¶çš„è¯´æ˜ä¿¡æ¯\n#rpm -qi è½¯ä»¶åç§°\n3.æŸ¥çœ‹è½¯ä»¶ç”Ÿæˆçš„æ–‡ä»¶\n# rpm -ql è½¯ä»¶åç§°\n[root@wei ~]# rpm -ql bash | less\n4.æŸ¥çœ‹æ–‡ä»¶ç”±é‚£ä¸ªè½¯ä»¶ç”Ÿæˆ\n# rpm -qf æ–‡ä»¶åç§°\n1 2 3 4 [root@wei ~]# which chmod /usr/bin/chmod [root@wei ~]# rpm -qf /usr/bin/chmodÂ coreutils-8.22-21.el7.x86_64 5.æŸ¥çœ‹è½¯ä»¶çš„é…ç½®æ–‡ä»¶\n# rpm -qc è½¯ä»¶åç§°\n1 2 3 [root@wei ~]# rpm -qc vim-enhanced /etc/profile.d/vim.csh /etc/profile.d/vim.sh ç®¡ç†æ“ä½œï¼š\nï¼ˆ1ï¼‰å®‰è£…è½¯ä»¶\n# rpm -ivh è½¯ä»¶å®‰è£…åŒ…åç§°\ni: å®‰è£… install\nvï¼šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ verbose\nhï¼šæ˜¾ç¤ºè½¯ä»¶å®‰è£…è¿›åº¦\nå®‰è£…vsftpdè½¯ä»¶\n1 2 3 4 5 6 [root@wei ~]# mount /dev/sr0 /mnt/ [root@wei ~]# rpm -ivh /mnt/Packages/vsftpd-3.0.2-22.el7.x86_64.rpmÂ å‡†å¤‡ä¸­... ################################# [100%] æ­£åœ¨å‡çº§/å®‰è£…... 1:vsftpd-3.0.2-22.el7 ################################# [100%] å®‰è£…dhcpè½¯ä»¶\n1 2 3 4 [root@wei ~]# rpm -ivh /mnt/Packages/dhcp-4.2.5-68.el7.centos.x86_64.rpmÂ å‡†å¤‡ä¸­... ################################# [100%] æ­£åœ¨å‡çº§/å®‰è£…... 1:dhcp-12:4.2.5-68.el7.centos ################################# [100%] å®‰è£…è½¯ä»¶å‡ºç°ä¾èµ–é—®é¢˜\n**Â é€‰é¡¹\u0026ndash;nodeps å¿½ç•¥ä¾èµ–å…³ç³»å®‰è£…\n**\nï¼ˆ2ï¼‰å¸è½½è½¯ä»¶\n# rpm -e è½¯ä»¶åç§°\n1 2 3 4 5 [root@wei ~]# rpm -q dhcp dhcp-4.2.5-68.el7.centos.x86_64 [root@wei ~]# rpm -e dhcp [root@wei ~]# rpm -q dhcp æœªå®‰è£…è½¯ä»¶åŒ… dhcpÂ é€‰é¡¹\u0026ndash;nodeps å¿½ç•¥ä¾èµ–å…³ç³»å¸è½½\nï¼ˆ3ï¼‰å‡çº§è½¯ä»¶\n# rpm -Uvh è½¯ä»¶å®‰è£…åŒ…åç§°\n**Â æ³¨æ„ï¼šè‡ªåŠ¨å¸è½½å°±ç‰ˆæœ¬è½¯ä»¶**\n","date":"2019-01-26T15:18:19Z","image":"https://www.ownit.top/title_pic/19.jpg","permalink":"https://www.ownit.top/p/201901261518/","title":"Linuxçš„rpmç®¡ç†"},{"content":"ç”¨æˆ·æ“ä½œç¯å¢ƒé…ç½®æ–‡ä»¶ï¼š\nä»/etc/skelç›®å½•å¤åˆ¶è¿‡æ¥\n**.bashrc æ‰“å¼€æ–°ç»ˆç«¯ /etc/bashrc\n.bash_profile ç”¨æˆ·ç™»å½•ç³»ç»Ÿ /ect/profile\n.bash_logout æ³¨é”€ç³»ç»Ÿ **\nç¤ºä¾‹ï¼šè®¾ç½®å‘½ä»¤åˆ«å\nä¸´æ—¶å‘½ä»¤åˆ«åï¼ˆå…³æœºé‡å¯ï¼Œå°±æ²¡æœ‰äº†ï¼‰ # alias å‘½ä»¤åˆ«å=â€˜å‘½ä»¤â€™\n1 alias ipshow=\u0026#39;cat /etc/sysconfig/network-scripts/ifcfg-ens33\u0026#39; æ°¸ä¹…åˆ«åï¼ˆå¯ä»¥ä¸€ç›´å­˜åœ¨ï¼‰\né’ˆå¯¹å•ä¸ªç”¨æˆ·è®¾ç½®åˆ«å\nï¼ˆ1ï¼‰åˆ›å»ºheiç”¨æˆ·ï¼Œä¿®æ”¹vim /home/hei/.bashrcÂ ï¼ˆ2ï¼‰è¿›å…¥Â /home/hei/.bashrc ï¼Œåœ¨æœ€åä¸€è¡Œæ·»åŠ Â **Â alias ipshow=\u0026rsquo; cat /etc/sysconfig/network-scripts/ifcfg-ens33\u0026rsquo; ä¿å­˜é€€å‡º**\nï¼ˆ3ï¼‰åˆ‡æ¢åˆ°heiç”¨æˆ·ä¸‹æŸ¥çœ‹\né’ˆå¯¹æ‰€æœ‰ç”¨æˆ·è®¾ç½®åˆ«å\nè¿™ä¸ªæ–¹æ³•å’Œä¸Šé¢çš„ä¸€æ ·ï¼Œåªéœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ä¸ä¸€æ ·ã€‚ä¸‹é¢å·²ç»åˆ—å‡º\nï¼ˆ1ï¼‰ä¿®æ”¹/etc/bashrcdeæ–‡ä»¶\nï¼ˆ2ï¼‰æ·»åŠ å‘½ä»¤åˆ«åä»£ç \nï¼ˆ3ï¼‰åˆ·æ–°æ–‡ä»¶å³å¯\n1 2 3 4 root@wei ~]# vim /etc/bashrc alias ipshow=\u0026#39; cat /etc/sysconfig/network-scripts/ifcfg-ens33\u0026#39; [root@wei ~]# source /etc/bashrc ","date":"2019-01-25T21:36:47Z","image":"https://www.ownit.top/title_pic/72.jpg","permalink":"https://www.ownit.top/p/201901252136/","title":"Linuxç”¨æˆ·ç¯å¢ƒé…ç½®æ–‡ä»¶"},{"content":"**Â è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢** inuxæ–‡ä»¶ç›®å½•æƒé™ç®¡ç†\nå¸¸è§„æƒé™ï¼š\nr read è¯»å– 4\nw write å†™å…¥Â 2\nx execute æ‰§è¡Œ 1\næ–‡ä»¶ï¼š\nr æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼ˆcat/more/less/head/tail/grepï¼‰\nw ç¼–è¾‘æ–‡ä»¶å†…å®¹ï¼ˆvimï¼‰\nx shell/pythonè„šæœ¬\nç›®å½•ï¼š\nr æŸ¥çœ‹ç›®å½•çš„æ–‡ä»¶ï¼ˆls/tmpï¼‰\nw ä¿®æ”¹ç›®å½•çš„æ–‡ä»¶ï¼ˆæ–°å»º,åˆ é™¤,mvï¼‰\nx åˆ‡æ¢ç›®å½•ï¼ˆcdï¼‰\né™¤å»ç¬¬ä¸€ä¸ªï¼Œä¸‰ä¸ªä¸ºä¸€ç»„Â æŸ¥çœ‹æ–‡ä»¶æƒé™\næŸ¥çœ‹ç›®å½•æƒé™\nè®¾ç½®æ–‡ä»¶ç›®å½•æƒé™\nï¼ˆ1ï¼‰chmod ä¿®æ”¹æƒé™\n# chmod {augo}{+-=}{rwx} æ–‡ä»¶åç§°\n**Â a all æ‰€æœ‰\nu user å±ä¸»ç”¨æˆ·\ng group å±ç»„\no other å…¶ä»–\n# chmod a+x /tmp/1.txt\n# chmod u-x,o+r /tmp/2.txt\n# chmod nnn æ–‡ä»¶åç§°**\næƒé™è®¾ç½®ä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [root@wei ~]# ls -l /test/ æ€»ç”¨é‡ 0 -rw-r--r--. 1 root root 0 1æœˆ 25 10:42 1.txt -rw-r--r--. 1 root root 0 1æœˆ 25 10:42 2.txt -rw-r--r--. 1 root root 0 1æœˆ 25 10:42 3.txt -rw-r--r--. 1 root root 0 1æœˆ 25 10:42 4.txt -rw-r--r--. 1 root root 0 1æœˆ 25 10:42 5.txt [root@wei ~]# chmod a+x /test/1.txtÂ #è®¾ç½®æ–‡ä»¶1.txtä¸ºæ‰€æœ‰ç”¨æˆ·å¯æ‰§è¡Œï¼ˆxï¼‰ [root@wei ~]# ls -l /test/1.txtÂ -rwxr-xr-x. 1 root root 0 1æœˆ 25 10:42 /test/1.txt #æŸ¥çœ‹æ–‡ä»¶1.txtçš„æƒé™ [root@wei ~]# chmod g-r,o-r /test/2.txtÂ #è®¾ç½®æ–‡ä»¶2.txtç”¨æˆ·å±ç»„æƒé™ä¸å¯è¯»ï¼Œå…¶ä»–ç”¨æˆ·æƒé™ä¸å¯è¯» [root@wei ~]# ls -l /test/2.txtÂ #æŸ¥çœ‹æ–‡ä»¶2.txtçš„æƒé™ -rw-------. 1 root root 0 1æœˆ 25 10:42 /test/2.txt [root@wei ~]# chmod g=rw /test/3.txtÂ #è¦†ç›–æ–‡ä»¶3.txtç”¨æˆ·å±ç»„çš„æƒé™ä¸ºå¯è¯»å¯å†™ [root@wei ~]# ls -l /test/3.txtÂ #æŸ¥çœ‹æ–‡ä»¶3.txtçš„æƒé™ -rw-rw-r--. 1 root root 0 1æœˆ 25 10:42 /test/3.txt [root@wei ~]# chmod 600 /test/4.txtÂ #è®¾ç½®æ–‡ä»¶4.txtçš„æƒé™ä¸ºä¸»ç”¨æˆ·å¯è¯»å¯å†™ [root@wei ~]# ls -l /test/4.txtÂ -rw-------. 1 root root 0 1æœˆ 25 10:42 /test/4.txt [root@wei ~]# chmod 000 /test/5.txt #è®¾ç½®5.txtçš„æ–‡ä»¶æƒé™ä¸ºæ‰€æœ‰ä¸å¯è¯»ä¸å¯å†™ä¸å¯æ‰§è¡ŒÂ [root@wei ~]# ls -l /test/5.txtÂ ----------. 1 root root 0 1æœˆ 25 10:42 /test/5.txt ï¼ˆ2ï¼‰ä¿®æ”¹æ–‡ä»¶çš„å±ä¸»,å±ç»„\n# chown ç”¨æˆ·åç§°.ç”¨æˆ·ç»„åç§° æ–‡ä»¶åç§°\n1 2 3 4 5 [root@wei ~]# chown user1.caiwu /test/1.txt [root@wei ~]# chown user1 /test/2.txtÂ [root@wei ~]# chown root.caiwu /test/4.txtÂ ä»…ä¿®æ”¹å±ç»„ï¼š\n# chgrp ç”¨æˆ·ç»„åç§° æ–‡ä»¶åç§°\n1 [root@wei ~]# ls -l /test/3.txtÂ å±ç»„æƒé™è®¾ç½®ä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 [root@wei ~]# ls -l /test/ æ€»ç”¨é‡ 0 -rwxr-xr-x. 1 root root 0 1æœˆ 25 10:42 1.txt -rw-------. 1 root root 0 1æœˆ 25 10:42 2.txt -rw-rw-r--. 1 root root 0 1æœˆ 25 10:42 3.txt -rw-------. 1 root root 0 1æœˆ 25 10:42 4.txt ----------. 1 root root 0 1æœˆ 25 10:42 5.txt [root@wei ~]# groupadd caiwu # æ·»åŠ ç”¨æˆ·å±ç»„caiwu [root@wei ~]# chown user1.caiwu /test/1.txtÂ #æŠŠ1.txtçš„ä¸»ç”¨æˆ·æ”¹ä¸ºuserï¼Œå±ç»„æ”¹ä¸ºcaiwu [root@wei ~]# ls -l /test/1.txtÂ -rwxr-xr-x. 1 user1 caiwu 0 1æœˆ 25 10:42 /test/1.txt [root@wei ~]# chown user1 /test/2.txtÂ #æŠŠ2.txtçš„ä¸»ç”¨æˆ·æ”¹ä¸ºuser1ï¼Œå±ç»„ä¸å˜ [root@wei ~]# ls -l /test/2.txtÂ -rw-------. 1 user1 root 0 1æœˆ 25 10:42 /test/2.txt [root@wei ~]# chgrp caiwu /test/3.txtÂ æŠŠ3.txtçš„å±ç»„æ”¹ä¸ºcaiwu [root@wei ~]# ls -l /test/3.txtÂ -rw-rw-r--. 1 root caiwu 0 1æœˆ 25 10:42 /test/3.txt [root@wei ~]# chown root.caiwu /test/4.txtÂ #æŠŠ#4.txtçš„ä¸»ç”¨æˆ·ä¸ºrootï¼Œå±ç»„ä¸ºcaiwu [root@wei ~]# ls -l /test/4.txtÂ -rw-------. 1 root caiwu 0 1æœˆ 25 10:42 /test/4.txt æ–¹æ³•2\nfacl\u0026mdash;\u0026mdash;\u0026mdash;\u0026ndash;æ–‡ä»¶è®¿é—®æ§åˆ¶åˆ—è¡¨\nè®¾ç½®æƒé™ï¼š\né’ˆå¯¹å•ä¸ªç”¨æˆ·è®¾ç½®æƒé™\n# setfacl -m uï¼šç”¨æˆ·åï¼šæƒé™ æ–‡ä»¶åç§°\n1 [root@wei test]# setfacl -m u:user4:r /test/3.txtÂ é’ˆå¯¹å•ä¸ªç”¨æˆ·ç»„è®¾ç½®æƒé™\n# setfacl -m gï¼šç”¨æˆ·ç»„åç§° ï¼šæƒé™ æ–‡ä»¶åç§°\n1 [root@wei test]# setfacl -m g:caiwu:rwx /test/3.txtÂ æŸ¥çœ‹æƒé™\n# getfacl æ–‡ä»¶åç§°\n1 2 3 4 5 6 7 8 9 10 [root@wei test]# getfacl /test/3.txtÂ getfacl: Removing leading \u0026#39;/\u0026#39; from absolute path names # file: test/3.txt # owner: user1 # group: user3 user::rw- user:user4:r-- group::rwx group:caiwu:rwx mask::rwx åˆ é™¤æƒé™\né’ˆå¯¹å•ä¸ªç”¨æˆ·è®¾ç½®æƒé™åˆ é™¤\n# setfacl -x uï¼šç”¨æˆ·åï¼šæ–‡ä»¶åç§°\n1 [root@wei test]# setfacl -x u:user4 /test/3.txt é’ˆå¯¹å•ä¸ªç”¨æˆ·ç»„è®¾ç½®æƒé™åˆ é™¤\n# setfacl -x gï¼šç”¨æˆ·ç»„åç§° æ–‡ä»¶åç§°\n1 [root@wei test]# setfacl -x g:caiwu /test/3.txtÂ ç®€å•ä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [root@wei test]# setfacl -x u:user4 /test/3.txtÂ [root@wei test]# getfacl /test/3.txtÂ getfacl: Removing leading \u0026#39;/\u0026#39; from absolute path names # file: test/3.txt # owner: user1 # group: user3 user::rw- group::rwx group:caiwu:rwx mask::rwx other::r-x [root@wei test]# setfacl -x g:caiwu /test/3.txtÂ [root@wei test]# getfacl /test/3.txtÂ getfacl: Removing leading \u0026#39;/\u0026#39; from absolute path names # file: test/3.txt # owner: user1 # group: user3 user::rw- group::rwx mask::rwx other::r-x ç‰¹æ®Šæƒé™\nsuid 4\nsgid 2\nsticky bit 1 1,suid\nä½œç”¨ï¼šæ™®é€šç”¨æˆ·åœ¨æ‰§è¡Œå‘½ä»¤æœŸé—´ï¼Œä¼šä¸´æ—¶è·å–åˆ°å‘½ä»¤å±ä¸»ç”¨æˆ·å¯¹æ“ä½œç³»ç»Ÿçš„æƒé™\nè®¾ç½®suidæƒé™\n# chmod u+s æ–‡ä»¶åç§°\n2ï¼Œsgid\né’ˆå¯¹ç›®å½•è®¾ç½®\nä½œç”¨ï¼šç›®å½•æ‹¥æœ‰sgidæƒé™åï¼Œåœ¨ç›®å½•ä¸‹åˆ›å»ºçš„æ–‡ä»¶ä¼šç»§æ‰¿ç›®å½•çš„å±ç»„ä¿¡æ¯\nè®¾ç½®sgidæƒé™\n**# chmod g+s ç›®å½•åç§°Â **\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 [root@wei ~]# mkdir /linux [root@wei ~]# ls -dhl /linuxÂ drwxr-xr-x. 2 root root 6 1æœˆ 25 11:55 /linux [root@wei ~]# chgrp caiwu /linux [root@wei ~]# ls -dhl /linuxÂ drwxr-xr-x. 2 root caiwu 6 1æœˆ 25 11:55 /linux [root@wei ~]# touch /linux/1.txt [root@wei ~]# ls -l /linux/1.txtÂ -rw-r--r--. 1 root root 0 1æœˆ 25 11:56 /linux/1.txt [root@wei ~]# chmod g+s /linux/ [root@wei ~]# ls -dhl /linuxÂ drwxr-sr-x. 2 root caiwu 19 1æœˆ 25 11:56 /linux [root@wei ~]# touch /linux/2.txt [root@wei ~]# ls -l /linux/2.txtÂ -rw-r--r--. 1 root caiwu 0 1æœˆ 25 11:58 /linux/2.txt 3,sticky bit\né’ˆå¯¹ç›®å½•è®¾ç½®\nä½œç”¨ï¼šåªç”¨ç›®å½•ä¸‹æ–‡ä»¶çš„å±ä¸»ç”¨æˆ·,ç›®å½•å±ä¸»ç”¨æˆ·åŠrootå¯åˆ é™¤çš„æ–‡ä»¶\nè®¾ç½®sticky bitæƒé™\n# chmod o+t ç›®å½•åç§°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 å…¬å¸éƒ¨é—¨ å¼€å‘éƒ¨ï¼ˆç»ç†ï¼Œå‘˜å·¥1ï¼Œå‘˜å·¥2ï¼‰ /project (1)ç»ç†å¯ä»¥æŸ¥çœ‹å†™ (2)å‘˜å·¥å¯ä»¥ç›¸äº’çœ‹ï¼Œä¿®æ”¹ï¼Œä½†ä¸èƒ½åˆ é™¤ [root@wei ~]# useradd jl [root@wei ~]# useradd yg1 [root@wei ~]# useradd yg2 [root@wei ~]# mkdir /project [root@wei ~]# chown jl /project/ [root@wei ~]# ls -dhl /project/ drwxr-xr-x. 2 jl root 6 1æœˆ 25 12:11 /project/ [root@wei ~]# usermod -G jl yg1 [root@wei ~]# usermod -G jl yg2 [root@wei ~]# chgrp jl /project/ [root@wei ~]# chmod g+w /project/ [root@wei ~]# chmod g+s /project/ [root@wei ~]# chmod o+t /project/ [root@wei ~]# ls -hdl /project/ drwxrwsr-t. 2 jl jl 6 1æœˆ 25 12:11 /project/ chmod chown chgrp setfacl\nå…±åŒé€‰é¡¹ï¼š -R é€’å½’ä¿®æ”¹\n","date":"2019-01-25T20:58:56Z","image":"https://www.ownit.top/title_pic/18.jpg","permalink":"https://www.ownit.top/p/201901252058/","title":"Linuxæ–‡ä»¶æƒé™ç®¡ç†"},{"content":"Linuxæ“ä½œç³»ç»Ÿï¼šÂ å¤šç”¨æˆ·å¤šä»»åŠ¡çš„æ“ä½œç³»ç»Ÿ ç”¨æˆ·ç±»å‹åˆ†ä¸ºï¼š ç®¡ç†å‘˜ç”¨æˆ· ï¼š root\næ™®é€šç”¨æˆ·åˆ†ä¸ºï¼šç³»ç»Ÿç”¨æˆ·/ç¨‹åºç”¨æˆ·\nç”¨æˆ·ç›¸å…³çš„æ–‡ä»¶ï¼š\n**Â /etc/passwd ç”¨æˆ·ä¿¡æ¯\næ ¼å¼ï¼šx:UID:GID:è¯´æ˜ä¿¡æ¯:SHELL\nUID:\n1000\u0026mdash;-60000 åˆ›å»ºç”¨æˆ·\n0\u0026mdash;\u0026ndash;999 ç³»ç»Ÿç”¨æˆ·\nSHELLï¼š\n/bin/bash é»˜è®¤\n/sbin/nologin ç³»ç»Ÿç”¨æˆ·\n/etc/shadow ç”¨æˆ·å¯†ç ä¿¡æ¯**\nç”¨æˆ·ï¼š åŸºæœ¬ç»„\né™„åŠ ç»„ userA\u0026mdash;-\u0026gt; ç”¨æˆ·ç»„userAï¼š\n1.åˆ›å»ºç”¨æˆ·\n# useradd [option] ç”¨æˆ·åç§°\noptioné€‰é¡¹ï¼š\n(1) -u UID æŒ‡å®šç”¨æˆ·çš„uid\n1 2 3 [root@wei ~]# useradd -u 1200 wei2 [root@wei ~]# id wei2 uid=1200(wei2) gid=1200(wei2) ç»„=1200(wei2) (2)æŒ‡å®šç”¨æˆ·çš„åŸºæœ¬ç»„,é™„åŠ ç»„\n-g gid/ç»„åç§°\n-G gid/ç»„åç§°,,,\n1 2 3 4 [root@wei ~]# groupadd nan [root@wei ~]# useradd -g wei2 -G nan wei3 [root@wei ~]# id wei3 uid=1201(wei3) gid=1200(wei2) ç»„=1200(wei2),1201(nan) (3)æŒ‡å®šç”¨æˆ·shellåç§°\n-s shellåç§°\n-M ä¸åˆ›å»ºå®¿ä¸»ç›®å½•\n1 [root@wei ~]# useradd -s /sbin/nologin -M zhangmiao (4)åˆ›å»ºç³»ç»Ÿç”¨æˆ·\n-rÂ 1 [root@wei ~]# useradd -r nangongÂ (5)æŒ‡å®šç”¨æˆ·çš„å®¿ä¸»ç›®å½•\n-dÂ 1 2 3 4 5 [root@wei ~]# useradd -d /tmp/hei hei [root@wei ~]# ls /tmp/ hei vmware-root [root@wei ~]# grep \u0026#34;hei\u0026#34; /etc/passwd hei:x:1203:1203::/tmp/hei:/bin/bash 2ï¼Œåˆ‡æ¢ç”¨æˆ·\n# su - ç”¨æˆ·åç§°\n3ï¼ŒæŸ¥çœ‹ç”¨æˆ·id\n# id ç”¨æˆ·åç§°\n1 2 [root@wei ~]# id wei uid=1000(wei) gid=1000(wei) ç»„=1000(wei) idçš„é€‰é¡¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@wei ~]# id wei3 uid=1201(wei3) gid=1200(wei2) ç»„=1200(wei2),1201(nan) [root@wei ~]# id -u wei3 1201 [root@wei ~]# id -g wei3 1200 [root@wei ~]# id -G wei3 1200 1201 [root@wei ~]# id -u -n wei3 wei3 [root@wei ~]# id -g -n wei3 wei2 [root@wei ~]# id -G -n wei3 wei2 nan 3,è®¾ç½®ç”¨æˆ·å¯†ç \n# passwd ç”¨æˆ·å\n1 [root@wei ~]# passwd wei (1)æŸ¥çœ‹ç”¨æˆ·å¯†ç çŠ¶æ€\n1 2 [root@wei ~]# passwd -S wei wei PS 2019-01-24 0 99999 7 -1 (å¯†ç å·²è®¾ç½®ï¼Œä½¿ç”¨ SHA512 ç®—æ³•ã€‚) (2)é”å®šç”¨æˆ·å¯†ç \n1 2 3 [root@wei ~]# passwd -l wei é”å®šç”¨æˆ· wei çš„å¯†ç  ã€‚ passwd: æ“ä½œæˆåŠŸ (3)è§£é”ç”¨æˆ·å¯†ç \n1 2 3 [root@wei ~]# passwd -u wei è§£é”ç”¨æˆ· wei çš„å¯†ç ã€‚ passwd: æ“ä½œæˆåŠŸ (4)å¼ºåˆ¶ç”¨æˆ·å¯†ç è¿‡æœŸ\n1 2 3 [root@wei ~]# passwd -e wei æ­£åœ¨ç»ˆæ­¢ç”¨æˆ· wei çš„å¯†ç ã€‚ passwd: æ“ä½œæˆåŠŸ 4,ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯\n# usermod [option] ç”¨æˆ·åç§°Â -u UID\n-g ç»„åç§°\n-G ç»„åç§°\n-s shellåç§°\næ›¿æ¢åŸæœ‰é™„åŠ ç»„\n1 2 3 4 5 6 [root@wei ~]# id wei3 uid=1201(wei3) gid=1200(wei2) ç»„=1200(wei2),1201(nan) [root@wei ~]# groupadd shicahng [root@wei ~]# usermod -G shicahng wei3 [root@wei ~]# id wei3 uid=1201(wei3) gid=1200(wei2) ç»„=1200(wei2),1204(shicahng) æ·»åŠ å¤šä¸ªé™„åŠ ç»„\n1 2 3 [root@wei ~]# usermod -aG nan wei3 [root@wei ~]# id wei3 uid=1201(wei3) gid=1200(wei2) ç»„=1200(wei2),1201(nan),1204(shicahng) 6,åˆ é™¤ç”¨æˆ·\n# userdel [option] ç”¨æˆ·åç§°\n1 2 3 [root@wei ~]# userdel wei [root@wei ~]# userdel -r wei2 \u0026gt;\u0026gt;åŒæ—¶åˆ é™¤ç”¨æˆ·çš„å®¿ä¸»æ–‡ä»¶ ç”¨æˆ·ç»„ç®¡ç†\n1,åˆ›å»ºç”¨æˆ·ç»„\n# groupadd ç”¨æˆ·ç»„åç§°\n2,åˆ é™¤ç”¨æˆ·ç»„\n# groupdel ç”¨æˆ·ç»„åç§°\n1 2 3 4 5 6 7 8 9 10 11 [root@wei ~]# groupadd jishu [root@wei ~]# useradd tom [root@wei ~]# useradd tom1 [root@wei ~]# usermod -G jishu tom [root@wei ~]# usermod -G jishu tom1 [root@wei ~]# grep \u0026#34;jishu\u0026#34; /etc/group jishu:x:1205:tom,tom1 [root@wei ~]# gpasswd -d tom jishu æ­£åœ¨å°†ç”¨æˆ·â€œtomâ€ä»â€œjishuâ€ç»„ä¸­åˆ é™¤ [root@wei ~]# grep \u0026#34;jishu\u0026#34; /etc/group jishu:x:1205:tom1 ","date":"2019-01-24T22:28:18Z","image":"https://www.ownit.top/title_pic/43.jpg","permalink":"https://www.ownit.top/p/201901242228/","title":"Linuxç”¨æˆ·æƒé™ç®¡ç†"},{"content":" æ–‡ä»¶å‹ç¼©/è§£å‹ç¼© gzipÂ bzip2Â xz åªèƒ½å‹ç¼©æ–‡ä»¶ï¼Œä¸èƒ½å‹ç¼©æ–‡ä»¶å¤¹ï¼ˆå‹ç¼©å®Œåï¼Œæ–‡ä»¶ä¼šæ¶ˆå¤±ï¼‰ å…ˆå»ºä¸‰ä¸ªæ–‡ä»¶æ¥è¿›è¡Œæ¼”ç¤º\n1 touch ./{1..3}.txt **Â æ–‡ä»¶å·²ç»åˆ›å»ºå¥½ï¼Œä¸‹é¢å°±å¼€å§‹ä»‹ç»æ–‡ä»¶çš„å‹ç¼©å’Œè§£å‹ï¼ˆ gzipÂ bzip2Â xz ï¼‰** gzipä»‹ç»ï¼š å‹ç¼©ï¼š gzipÂ æºæ–‡ä»¶\n1 gzip 1.txt è§£å‹ç¼© ï¼š gzip -d æºæ–‡ä»¶\n1 gzip -d 1.txt.gz bzip2ä»‹ç» å‹ç¼©ï¼šbzip2Â æºæ–‡ä»¶\n1 bzip2 2.txt è§£å‹ç¼© : bizp2Â -dÂ æºæ–‡ä»¶\n1 bzip2 -d 2.txt.bz2 **Â xzä»‹ç»** å‹ç¼©ï¼šxz æºæ–‡ä»¶\n1 xz 3.txt è§£å‹ç¼©ï¼šxz -d æºæ–‡ä»¶\n1 xz -d 3.txt.xz åˆ›å»ºæ‰“åŒ…æ–‡ä»¶ \u0026mdash;\u0026mdash;tar 1ï¼‰åˆ›å»ºæ‰“åŒ…æ–‡ä»¶ *.tar # tar cf æ‰“åŒ…æ–‡ä»¶åç§° æºæ–‡ä»¶ eï¼šcreatåˆ›å»º f :Â fileæ–‡ä»¶ 2)è§£åŒ… ** # tar xf æ‰“åŒ…æ–‡ä»¶åç§° ã€-cè§£å‹åˆ°çš„ç›®å½•ã€‘** 3ï¼‰æŸ¥çœ‹åŒ… #tar tvf æ‰“åŒ…çš„æ–‡ä»¶åç§° **Â è°ƒç”¨gzipä½¿ç”¨å‹ç¼© è§£å‹ç¼©** å‹ç¼©\n#tar czf æ‰“åŒ…æ–‡ä»¶åç§° æºæ–‡ä»¶\n**Â zï¼šè°ƒç”¨gzip**\nè§£å‹ç¼©ï¼š\n# tar xzf æ‰“åŒ…æ–‡ä»¶çš„åç§° ã€-c ç›®å½•åç§°ã€‘\n**Â è°ƒç”¨bzip2ä½¿ç”¨å‹ç¼© è§£å‹ç¼©** å‹ç¼©\n#tar cjf æ‰“åŒ…æ–‡ä»¶åç§° ç›®å½•åç§°\njï¼šè°ƒç”¨bzip2\nè§£å‹ç¼©\n#tar xjf æ‰“åŒ…æ–‡ä»¶åç§° ã€-c ç›®å½•åç§°ã€‘\n**Â è°ƒç”¨xzä½¿ç”¨å‹ç¼© è§£å‹ç¼©** å‹ç¼©\n#tar cJf æ‰“åŒ…æ–‡ä»¶åç§° ç›®å½•åç§°\nJï¼šè°ƒç”¨zx\nè§£å‹ç¼©\n#tar xJf æ‰“åŒ…æ–‡ä»¶åç§° ã€-c ç›®å½•åç§°ã€‘\n","date":"2019-01-23T23:19:14Z","image":"https://www.ownit.top/title_pic/22.jpg","permalink":"https://www.ownit.top/p/201901232319/","title":"å‹ç¼©ï¼Œè§£å‹ç¼© å’Œtarè¯¦ç»†ä»‹ç»"},{"content":"è¿‡æ»¤æ–‡ä»¶ç±»å®¹\u0026mdash;grep grepæ­£åˆ™è¡¨è¾¾å¼åº”ç”¨ï¼š #grep ã€optionã€‘â€patternâ€ æ–‡ä»¶åç§° patternæ¨¡å¼ ç”±æ™®é€šå­—ç¬¦å’Œæ­£åˆ™è¡¨è¾¾å¼çš„å…ƒå­—ç¬¦ç»„æ„æˆçš„æ¡ä»¶ ç®€å•ä¾‹å­\n1 grep \u0026#34;root\u0026#34; /etc/passwd æ­£åˆ™è¡¨è¾¾å¼çš„å…ƒå­—ç¬¦ ï¼ˆ1ï¼‰åŒ¹é…å•ä¸ªå­—ç¬¦çš„å…ƒå­—ç¬¦ . ä»»æ„å•ä¸ªå­—ç¬¦ï¼ˆå‰é¢æ˜¯ä¸€ä¸ªå°ç‚¹ï¼‰\n1 grep \u0026#34;r..t\u0026#34; /etc/passwd **Â æ³¨æ„ï¼š.Â ä»£è¡¨ä»»æ„å­—ç¬¦ï¼Œæ­¤å¤„æœ‰ä¸¤ä¸ªÂ .Â ï¼Œä»£è¡¨ä¸¤ä¸ªä»»æ„å­—ç¬¦ï¼Œçœ‹ä¸‹é¢çš„ä¾‹å­**\n**Â [ ]Â ä»£è¡¨æˆ–è€…çš„å…³ç³»**\n**Â è¿ç»­çš„å­—ç¬¦èŒƒå›´**\n[a-z]Â : aåˆ°zçš„æ‰€æœ‰å°å†™å­—æ¯\n[A-Z]Â ï¼š Aåˆ°Zæ‰€æœ‰çš„å¤§å†™å­—æ¯\n**[a-zA-Z] ï¼šåŒ…å«æ‰€æœ‰çš„å¤§å°å†™å­—æ¯Â **\n[0-9]Â ï¼š0åˆ°9çš„æ‰€æœ‰æ•°å­—\n[a-zA-Z0-9 ]Â ï¼šåŒ…å«æ‰€æœ‰å¤§å°å­—æ¯å’Œæ•°å­—\nä¸ºäº†æ–¹ä¾¿åé¢çš„ç»ƒä¹ ï¼Œåœ¨æ­¤å»ºç«‹ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œå†™å…¥å­—ç¬¦ï¼Œå½“åšç»ƒä¹ çš„æ–‡ä»¶Â 1 2 3 4 5 6 7 8 vim 1.txt rot rAt rBt r1t root rVCt r4t 1 2 3 grep \u0026#34;r[a-z]t\u0026#34; 1.txt grep \u0026#34;r[A-Z]t\u0026#34; 1.txt ^ å–å\n[^a-z]\n1 grep \u0026#34;r[^0-9]t\u0026#34; 1.txt (2)åŒ¹é…å­—ç¬¦å‡ºç°çš„ä½ç½® ^stringÂ ä»¥stringå¼€å¤´\n1 grep \u0026#34;^root\u0026#34; /etc/passwd å¯¹é¦–è¡Œ[rbh]å¼€å¤´\n1 grep \u0026#34;^[rbh]\u0026#34; /etc/passwd ä¸æ˜¯ã€rbhã€‘å¼€å¤´\n1 grep \u0026#34;^[^rbh]\u0026#34; /etc/passwd string$Â ä»¥string$ç»“å°¾\nä»¥bashç»“å°¾çš„\n1 grep \u0026#34;bash$\u0026#34; /etc/passwd æŸ¥çœ‹nologinçš„è¡Œæ•°\n1 grep \u0026#34;nologin$\u0026#34; /etc/passwd | wc -l ^$ ï¼š ä»£è¡¨ ç©ºè¡Œ\næŸ¥çœ‹ç›®å½•åç§°ï¼ˆæ­¤å¤„æ˜¯æŒ‡ç›®å½•æ–‡ä»¶ï¼‰\n1 ls -l /etc/ | grep \u0026#34;^d\u0026#34; ä¸ºäº†æ–¹ä¾¿åé¢çš„ç»ƒä¹ ï¼Œåœ¨æ­¤å»ºç«‹ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œå†™å…¥å­—ç¬¦ï¼Œå½“åšç»ƒä¹ çš„æ–‡ä»¶Â 1 2 3 4 5 6 7 vim 2.txt a ab abb abbbb abbbbb abbbbbbb *Â åŒ¹é…å…¶å‰ä¸€ä¸ªå­—ç¬¦å‡ºç°ä»»æ„æ¬¡ **Â .*ä»»æ„å­—ç¬¦** 1 grep \u0026#34;ab*\u0026#34; 3.txt \\?Â 0æ¬¡æˆ–è€…1æ¬¡ å¯æœ‰å¯æ—  1 grep \u0026#34;ab\\?\u0026#34; 2.txt \\+Â 1æ¬¡æˆ–è€…å¤šæ¬¡ æœ€å°‘1æ¬¡ 1 grep \u0026#34;ab\\+\u0026#34; 2.txt \\{2\\}Â å‡ºç°ä¸¤æ¬¡ 1 grep \u0026#34;ab\\{2\\}\u0026#34; 2.txt \\{2ï¼Œ5\\}Â æœ€å°‘2æ¬¡ï¼Œæœ€å¤š5æ¬¡ 1 grep \u0026#34;ab\\{2,5\\}\u0026#34; 2.txt optioné€‰é¡¹ 1ï¼‰-i å¿½ç•¥å¤§å°å†™ 1 [root@zhang ~]# grep -i \u0026#34;^r\u0026#34; 1.txt 2ï¼‰-o ä»…æ˜¾ç¤ºç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼çš„å†…å®¹ï¼Œä¸æ˜¾ç¤ºæ•´è¡Œ 1 2 3 [root@zhang ~]# grep -oÂ \u0026#34;r..t\u0026#34; /etc/passwd root 3ï¼‰-v åå‘è¿‡æ»¤ 1 2 3 4 5 6 7 8 9 [root@zhang ~]# grep -v \u0026#34;^#\u0026#34; /etc/fstab /dev/mapper/centos-root /Â xfsÂ defaultsÂ 0 0 UUID=20b4a09c-ba00-41d4-a6d5-7dc24bc0a057 /bootÂ xfsÂ defaultsÂ 0 0 /dev/mapper/centos-swap swapÂ swapÂ defaultsÂ 0 0 4ï¼‰-e æ ¹æ®å¤šæ¡ä»¶è¿‡æ»¤æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 [root@zhang ~]# grep -e \u0026#34;^$\u0026#34; -e \u0026#34;^#\u0026#34; /etc/fstab # # /etc/fstab # Created by anaconda on Mon JanÂ 7 01:19:06 2019 4ï¼‰-E æ”¯æŒæ‰©å±•æ­£åˆ™è¡¨è¾¾å¼ 1 grep -E \u0026#34;vmx|svm\u0026#34; /proc/cpuinfo 5ï¼‰-A n æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„å2è¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 [root@zhang ~]# ifconfig |grep -A 2 \u0026#34;netmask\u0026#34; inet 192.168.196.131Â netmask 255.255.255.0Â broadcast 192.168.196.255 inet6 fe80::20c:29ff:fe8e:e21bÂ prefixlen 64Â scopeid 0x20\u0026lt;link\u0026gt; ether 00:0c:29:8e:e2:1bÂ txqueuelen 1000Â (Ethernet) -- inet 127.0.0.1Â netmask 255.0.0.0 inet6 ::1Â prefixlen 128Â scopeid 0x10\u0026lt;host\u0026gt; loopÂ txqueuelen 1000Â (Local Loopback) 6ï¼‰-B n æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„å‰2è¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 [root@zhang ~]# ifconfig |grep -B 2 \u0026#34;netmask\u0026#34; ens33: flags=4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt;Â mtu 1500 inet 192.168.196.131Â netmask 255.255.255.0Â broadcast 192.168.196.255 -- lo: flags=73\u0026lt;UP,LOOPBACK,RUNNING\u0026gt;Â mtu 65536 inet 127.0.0.1Â netmask 255.0.0.0 åšä¸»æ­£åœ¨è‡ªå­¦Linuxäº‘è®¡ç®—ï¼Œæœ‰å­¦ä¹ çš„çš„å°ä¼™ä¼´å¯ä»¥ç›¸äº’äº¤æµï¼Œå¢å¼ºæŠ€æœ¯ã€‚ ","date":"2019-01-23T21:29:45Z","image":"https://www.ownit.top/title_pic/35.jpg","permalink":"https://www.ownit.top/p/201901232129/","title":"grepåŸºæœ¬è¯¦ç»†ä½¿ç”¨"},{"content":"1 Viã€Vimæ–‡æœ¬ç¼–è¾‘å™¨ 1ï¼Viã€Vim\nViæ˜¯Visual interfaceçš„ç®€ç§°ã€‚\nVimæ˜¯Viçš„å¢å¼ºç‰ˆï¼Œå³Vi Improvedã€‚åœ¨åé¢çš„å®ä¾‹ä¸­å°†ä»‹ç»Vimçš„ä½¿ç”¨ã€‚\nä¸ºä»€ä¹ˆå­¦viï¼Ÿ 1ï¼‰æ‰€æœ‰çš„Unix Like ç³»ç»Ÿéƒ½ä¼šå†…å»º vi æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå…¶ä»–çš„æ–‡æœ¬ç¼–è¾‘å™¨åˆ™ä¸ä¸€å®šä¼šå­˜åœ¨ï¼›\n2ï¼‰å¾ˆå¤šä¸ªåˆ«è½¯ä»¶çš„ç¼–è¾‘æ¥å£éƒ½ä¼šä¸»åŠ¨å‘¼å« vi (ä¾‹å¦‚æœªæ¥ä¼šè°ˆåˆ°çš„ crontab, visudo, edquota ç­‰æŒ‡ä»¤)ï¼›\n3ï¼‰vim å…·æœ‰ç¨‹åºç¼–è¾‘çš„èƒ½åŠ›ï¼Œå¯ä»¥ä¸»åŠ¨çš„ä»¥å­—ä½“é¢œè‰²è¾¨åˆ«è¯­æ³•ç™¿æ­£ç¡®æ€§ï¼Œæ–¹ä¾¿ç¨‹åºè®¾è®¡ï¼›\n4ï¼‰å› ä¸ºç¨‹åºç®€å•ï¼Œç¼–è¾‘é€Ÿåº¦ç›¸å½“å¿«é€Ÿã€‚\nç³»ç»Ÿè‡ªå¸¦æ•™ç¨‹ï¼švimtutor\nvim [options] [filelist]\nå¸¸ç”¨é€‰é¡¹ï¼š\n+[num]\n+/{pat}\n1ã€å·¥ä½œæ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ã€è¾“å…¥æ¨¡å¼å’Œæœ«è¡Œæ¨¡å¼ Vimæ‹¥æœ‰5ç§ç¼–è¾‘æ¨¡å¼ï¼šå‘½ä»¤æ¨¡å¼ã€è¾“å…¥æ¨¡å¼ã€æœ«è¡Œæ¨¡å¼ã€å¯è§†åŒ–æ¨¡å¼ã€æŸ¥è¯¢æ¨¡å¼ã€‚\n1ï¼‰ï¼å‘½ä»¤æ¨¡å¼ï¼ˆå…¶å®ƒæ¨¡å¼â†’ESCï¼‰\n2ï¼‰ï¼è¾“å…¥æ¨¡å¼ï¼ˆå‘½ä»¤æ¨¡å¼â†’aã€iã€oã€Aã€Iã€Oï¼‰\n3ï¼‰ï¼æœ«è¡Œæ¨¡å¼ï¼ˆå‘½ä»¤æ¨¡å¼â†’:ï¼‰\n4ï¼‰ï¼å¯è§†åŒ–æ¨¡å¼ï¼ˆå‘½ä»¤æ¨¡å¼â†’vï¼‰\n5ï¼‰ï¼æŸ¥è¯¢æ¨¡å¼ï¼ˆå‘½ä»¤æ¨¡å¼â†’?ã€/ï¼‰\n2ã€æ¨¡å¼ä¹‹é—´åˆ‡æ¢ å‘½ä»¤æ¨¡å¼ï¼š\nè¾“å…¥æ¨¡å¼ï¼š\næ–°å¢ (append)\na ï¼šä»å…‰æ ‡æ‰€åœ¨ä½ç½®å¾Œé¢å¼€å§‹æ–°å¢èµ„æ–™ï¼Œå…‰æ ‡å¾Œçš„èµ„æ–™éšæ–°å¢èµ„æ–™å‘å¾Œç§»åŠ¨ã€‚\nAï¼š ä»å…‰æ ‡æ‰€åœ¨åˆ—æœ€å¾Œé¢çš„åœ°æ–¹å¼€å§‹æ–°å¢èµ„æ–™ã€‚\næ’å…¥ (insert)\niï¼š ä»å…‰æ ‡æ‰€åœ¨ä½ç½®å‰é¢å¼€å§‹æ’å…¥èµ„æ–™ï¼Œå…‰æ ‡å¾Œçš„èµ„æ–™éšæ–°å¢èµ„æ–™å‘å¾Œç§»åŠ¨ã€‚\nI ï¼šä»å…‰æ ‡æ‰€åœ¨åˆ—çš„ç¬¬ä¸€ä¸ªéç©ºç™½å­—å…ƒå‰é¢å¼€å§‹æ’å…¥èµ„æ–™ã€‚\nå¼€å§‹ (open)\no ï¼šåœ¨å…‰æ ‡æ‰€åœ¨åˆ—ä¸‹æ–°å¢ä¸€åˆ—å¹¶è¿›å…¥è¾“å…¥æ¨¡å¼ã€‚\nO: åœ¨å…‰æ ‡æ‰€åœ¨åˆ—ä¸Šæ–¹æ–°å¢ä¸€åˆ—å¹¶è¿›å…¥è¾“å…¥æ¨¡å¼\næœ«è¡Œæ¨¡å¼ï¼š\n3ã€æ‰“å¼€æ–‡ä»¶ vim /path/to/somefile\nvim +# :æ‰“å¼€æ–‡ä»¶ï¼Œå¹¶å®šä½äºç¬¬#è¡Œ\nvim +ï¼šæ‰“å¼€æ–‡ä»¶ï¼Œå®šä½è‡³æœ€åä¸€è¡Œ\nvim +/PATTERN : æ‰“å¼€æ–‡ä»¶ï¼Œå®šä½è‡³ç¬¬ä¸€æ¬¡è¢«PATTERNåŒ¹é…åˆ°çš„è¡Œçš„è¡Œé¦–\né»˜è®¤å¤„äºç¼–è¾‘æ¨¡å¼\n4ã€å…³é—­æ–‡ä»¶ 1ã€æœ«è¡Œæ¨¡å¼å…³é—­æ–‡ä»¶\n:q é€€å‡º\n:wq ä¿å­˜å¹¶é€€å‡º\n:q! ä¸ä¿å­˜å¹¶é€€å‡º\n:w ä¿å­˜\n:w! å¼ºè¡Œä¿å­˜\n:wq --\u0026gt; :x\n2ã€ç¼–è¾‘æ¨¡å¼ä¸‹é€€å‡º\nZZ: ä¿å­˜å¹¶é€€å‡º\n4ã€ç§»åŠ¨å…‰æ ‡(ç¼–è¾‘æ¨¡å¼) 1ã€é€å­—ç¬¦ç§»åŠ¨ï¼š\nh: å·¦\nl: å³\nj: ä¸‹\nk: ä¸Š\n#h: ç§»åŠ¨#ä¸ªå­—ç¬¦ï¼›\n2ã€ä»¥å•è¯ä¸ºå•ä½ç§»åŠ¨\nw: ç§»è‡³ä¸‹ä¸€ä¸ªå•è¯çš„è¯é¦–\ne: è·³è‡³å½“å‰æˆ–ä¸‹ä¸€ä¸ªå•è¯çš„è¯å°¾\nb: è·³è‡³å½“å‰æˆ–å‰ä¸€ä¸ªå•è¯çš„è¯é¦–\n#w:\n3ã€è¡Œå†…è·³è½¬ï¼š\n0: ç»å¯¹è¡Œé¦–\n^: è¡Œé¦–çš„ç¬¬ä¸€ä¸ªéç©ºç™½å­—ç¬¦\n$: ç»å¯¹è¡Œå°¾\nhome\nend\n4ã€è¡Œé—´è·³è½¬\n#Gï¼šè·³è½¬è‡³ç¬¬#è¡Œï¼›\nGï¼šæœ€åä¸€è¡Œ\n1Gï¼šè·³è½¬åˆ°ç¬¬1è¡Œé¦–===gg\næœ«è¡Œæ¨¡å¼ä¸‹ï¼Œç›´æ¥ç»™å‡ºè¡Œå·å³å¯\n:5 ç›´æ¥å®šä½åˆ°ç¬¬5è¡Œé¦–\n5ã€ç¿»å± Ctrl+f: å‘ä¸‹ç¿»ä¸€å±\nCtrl+b: å‘ä¸Šç¿»ä¸€å±\nCtrl+d: å‘ä¸‹ç¿»åŠå±\nCtrl+u: å‘ä¸Šç¿»åŠå±\n6ã€åˆ é™¤å•ä¸ªå­—ç¬¦ x: åˆ é™¤å…‰æ ‡æ‰€åœ¨å¤„çš„å•ä¸ªå­—ç¬¦\n#x: åˆ é™¤å…‰æ ‡æ‰€åœ¨å¤„åŠå‘åçš„å…±#ä¸ªå­—ç¬¦\n7ã€åˆ é™¤å‘½ä»¤: d då‘½ä»¤è·Ÿè·³è½¬å‘½ä»¤ç»„åˆä½¿ç”¨ï¼›\n#dw, #de, #db\ndd: åˆ é™¤å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œ\n#dd: åˆ é™¤åŒ…æ‹¬å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œåœ¨å†…çš„#è¡Œï¼›\næœ«è¡Œæ¨¡å¼ä¸‹ï¼š\nStartADD,EndADDd\n.: è¡¨ç¤ºå½“å‰è¡Œ\n$: æœ€åä¸€è¡Œ\n+#: å‘ä¸‹çš„#è¡Œ\n8ã€ç²˜è´´å‘½ä»¤ p p: å¦‚æœåˆ é™¤æˆ–å¤åˆ¶ä¸ºæ•´è¡Œå†…å®¹ï¼Œåˆ™ç²˜è´´è‡³å…‰æ ‡æ‰€åœ¨è¡Œçš„ä¸‹æ–¹ï¼Œå¦‚æœå¤åˆ¶æˆ–åˆ é™¤çš„å†…å®¹ä¸ºéæ•´è¡Œï¼Œåˆ™ç²˜è´´è‡³å…‰æ ‡æ‰€åœ¨å­—ç¬¦çš„åé¢ï¼›\nP: å¦‚æœåˆ é™¤æˆ–å¤åˆ¶ä¸ºæ•´è¡Œå†…å®¹ï¼Œåˆ™ç²˜è´´è‡³å…‰æ ‡æ‰€åœ¨è¡Œçš„ä¸Šæ–¹ï¼Œå¦‚æœå¤åˆ¶æˆ–åˆ é™¤çš„å†…å®¹ä¸ºéæ•´è¡Œï¼Œåˆ™ç²˜è´´è‡³å…‰æ ‡æ‰€åœ¨å­—ç¬¦çš„å‰é¢ï¼›\n9ã€å¤åˆ¶å‘½ä»¤ y ç”¨æ³•åŒdå‘½ä»¤\nyy å¤åˆ¶1è¡Œ\n5yy å¤åˆ¶5è¡Œ\n10ã€ä¿®æ”¹ï¼šå…ˆåˆ é™¤å†…å®¹ï¼Œå†è½¬æ¢ä¸ºè¾“å…¥æ¨¡å¼ c: ç”¨æ³•åŒdå‘½ä»¤\n11ã€æ›¿æ¢ï¼šr R: æ›¿æ¢æ¨¡å¼\n12ã€æ’¤æ¶ˆç¼–è¾‘æ“ä½œ u uï¼šæ’¤æ¶ˆå‰ä¸€æ¬¡çš„ç¼–è¾‘æ“ä½œ\nè¿ç»­uå‘½ä»¤å¯æ’¤æ¶ˆæ­¤å‰çš„næ¬¡ç¼–è¾‘æ“ä½œ\n#u: ç›´æ¥æ’¤æ¶ˆæœ€è¿‘#æ¬¡ç¼–è¾‘æ“ä½œ\næ’¤æ¶ˆæœ€è¿‘ä¸€æ¬¡æ’¤æ¶ˆæ“ä½œï¼šCtrl+r\n13ã€å¯è§†åŒ–æ¨¡å¼ v: æŒ‰å­—ç¬¦é€‰å–\nè¯¥æ¨¡å¼ä¸‹é€šè¿‡å…‰æ ‡ç§»åŠ¨é€‰æ‹©æ–‡æœ¬ï¼Œé€‰å–åæŒ‰ y å¯ä»¥æŠŠæ–‡æœ¬æå–åˆ°ç¼“å†²åŒºï¼ˆå³å¤åˆ¶ï¼‰ï¼Œc å¯ä»¥å‰ªåˆ‡ã€‚ä¹‹åå¯ä»¥ä½¿ç”¨påœ¨å…‰æ ‡åç²˜è´´ï¼ŒPç²˜è´´åœ¨å…‰æ ‡å‰\nVï¼šæŒ‰çŸ©å½¢é€‰å–\nVæ˜¯è¡Œé€‰å–æ¨¡å¼ï¼Œä»¥è¡Œä¸ºå•ä½è¿›è¡Œé€‰å–ã€‚Ctrl+væ˜¯å—é€‰å–æ¨¡å¼ï¼Œå¯ä»¥é€‰å–ä¸€å—çŸ©å½¢åŒºåŸŸä¸­çš„æ–‡æœ¬ã€‚\n14ã€æŸ¥æ‰¾ /PATTERN\n?PATTERN\nn\nN\n15ã€æŸ¥æ‰¾å¹¶æ›¿æ¢ 1 2 3 4 5 6 7 8 åœ¨æœ«è¡Œæ¨¡å¼ä¸‹ä½¿ç”¨så‘½ä»¤ ADDR1,ADDR2s@PATTERN@string@gi 1,$ %ï¼šè¡¨ç¤ºå…¨æ–‡\t:s/root/admin/ æ›¿æ¢å…‰æ ‡æ‰€åœ¨è¡Œç¬¬ä¸€ä¸ªrootä¸ºadmin :s/root/admin/g æ›¿æ¢å…‰æ ‡æ‰€åœ¨è¡Œæ‰€æœ‰rootä¸ºadmin :1,5 s/root/admin/g æ›¿æ¢ç¬¬1-5è¡Œæ‰€æœ‰rootä¸ºadmin :1,$ s/admin/root/g æ›¿æ¢æ‰€æœ‰è¡Œçš„adminä¸ºroot ==== 1,$ ç­‰ä»·äº% 16ã€ä½¿ç”¨vimç¼–è¾‘å¤šä¸ªæ–‡ä»¶ vim FILE1 FILE2 FILE3\n:next åˆ‡æ¢è‡³ä¸‹ä¸€ä¸ªæ–‡ä»¶\n:prev åˆ‡æ¢è‡³å‰ä¸€ä¸ªæ–‡ä»¶\n:last åˆ‡æ¢è‡³æœ€åä¸€ä¸ªæ–‡ä»¶\n:first åˆ‡æ¢è‡³ç¬¬ä¸€ä¸ªæ–‡ä»¶\né€€å‡º\n:qa å…¨éƒ¨é€€å‡º\n17ã€åˆ†å±æ˜¾ç¤ºä¸€ä¸ªæ–‡ä»¶ Ctrl+w, s: æ°´å¹³æ‹†åˆ†çª—å£\nCtrl+w, v: å‚ç›´æ‹†åˆ†çª—å£\nåœ¨çª—å£é—´åˆ‡æ¢å…‰æ ‡ï¼š\nCtrl+w, ARROW(è¡¨ç¤ºä¸Šä¸‹å·¦å³ç®­å¤´)\n1 :qa å…³é—­æ‰€æœ‰çª—å£ 18ã€åˆ†çª—å£ç¼–è¾‘å¤šä¸ªæ–‡ä»¶ vim -o : æ°´å¹³åˆ†å‰²æ˜¾ç¤º\nvim -O : å‚ç›´åˆ†å‰²æ˜¾ç¤º\n19ã€å°†å½“å‰æ–‡ä»¶ä¸­éƒ¨åˆ†å†…å®¹å¦å­˜ä¸ºå¦å¤–ä¸€ä¸ªæ–‡ä»¶ æœ«è¡Œæ¨¡å¼ä¸‹ä½¿ç”¨wå‘½ä»¤\n:w\n:ADDR1,ADDR2w /path/to/somewhere\n20ã€å°†å¦å¤–ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹å¡«å……åœ¨å½“å‰æ–‡ä»¶ä¸­ :r /path/to/somefile\n21ã€è·Ÿshelläº¤äº’ :! COMMAND\n22ã€é«˜çº§è¯é¢˜ 1ã€æ˜¾ç¤ºæˆ–å–æ¶ˆæ˜¾ç¤ºè¡Œå·\n:set number\n:set nu\n:set nonu\n2ã€æ˜¾ç¤ºå¿½ç•¥æˆ–åŒºåˆ†å­—ç¬¦å¤§å°å†™\n:set ignorecase\n:set ic\n:set noic\n3ã€è®¾å®šè‡ªåŠ¨ç¼©è¿›\n:set autoindent\n:set ai\n:set noai\n4ã€æŸ¥æ‰¾åˆ°çš„æ–‡æœ¬é«˜äº®æ˜¾ç¤ºæˆ–å–æ¶ˆ\n:set hlsearch\n:set nohlsearch\n5ã€è¯­æ³•é«˜äº®\n:syntax on\n:syntax off\n23ã€é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /etc/vimrc ~/.vimrc set hlsearch \u0026#34;é«˜äº®åº¦åç™½ set backspace=2 \u0026#34;å¯éšæ—¶ç”¨é€€æ ¼é”®åˆ é™¤ set autoindent \u0026#34;è‡ªåŠ¨ç¼©æ’ set tabstop=4\t\u0026#34;ç¼©è¿› set softtabstop=4 softtabstopæ˜¯â€œé€¢4ç©ºæ ¼è¿›1åˆ¶è¡¨ç¬¦â€,å‰ææ˜¯ä½ tabstop=4 set shiftwidth=4 è‡ªåŠ¨ç¼©è¿›ç©ºæ ¼é•¿åº¦ set mouse=a\t\u0026#34;ä½¿ç”¨é¼ æ ‡ set selection=exclusive set selectmode=mouse,key set ruler \u0026#34;å¯æ˜¾ç¤ºæœ€åä¸€è¡Œçš„çŠ¶æ€ set showmode \u0026#34;å·¦ä¸‹è§’é‚£ä¸€è¡Œçš„çŠ¶æ€ set nu \u0026#34;å¯ä»¥åœ¨æ¯ä¸€è¡Œçš„æœ€å‰é¢æ˜¾ç¤ºè¡Œå·å•¦ï¼ set bg=dark \u0026#34;æ˜¾ç¤ºä¸åŒçš„åº•è‰²è‰²è°ƒ syntax on \u0026#34;è¿›è¡Œè¯­æ³•æ£€éªŒï¼Œé¢œè‰²æ˜¾ç¤º\t","date":"2019-01-19T19:03:12Z","image":"https://www.ownit.top/title_pic/03.jpg","permalink":"https://www.ownit.top/p/201901191903/","title":"Vimæ–‡æœ¬ç¼–è¾‘å™¨è¯¦ç»†ç”¨æ³•"},{"content":"åº§å³é“­ï¼šé•¿é£ç ´æµªä¼šæœ‰æ—¶ï¼Œç›´æŒ‚äº‘å¸†æµæ²§æµ·ã€‚\nlinuxä¸€èˆ¬æŸ¥çœ‹æ–‡ä»¶æˆ–è€…ç›®å½•æœ‰å‡ ç§æ–¹æ³•ã€‚\n/æŸ¥çœ‹æ–‡ä»¶ç±»å®¹\u0026mdash;\u0026mdash;\u0026ndash;cat/more/less/head/tailÂ åªèƒ½æŸ¥çœ‹æ–‡æœ¬å‹ï¼ˆtxtï¼‰\nï¼ˆ1ï¼‰æŸ¥çœ‹æ–‡ä»¶è¾ƒå°‘çš„ç±»å®¹\ncat /etc/fstab\ncat -n /etc/fstab\nï¼ˆ2ï¼‰æŸ¥çœ‹æœªçŸ¥ç±»å®¹\nçœ‹æœªçŸ¥çš„ç±»å®¹æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¸çŸ¥é“æœ‰å¤šå¤§ï¼Œå°±ç”¨moreå’ŒlessæŸ¥çœ‹æ¯”è¾ƒæ–¹ä¾¿ä½¿ç”¨\nä¸¤è€…ç›¸åŒç‚¹ï¼šå¯ä»¥ ç¿»é¡µ æˆ–è€… ä¸€è¡Œä¸€è¡ŒæŸ¥çœ‹ **Â ä¸åŒç‚¹ï¼šmoreåªèƒ½å¾€ä¸‹ç¿»é¡µï¼Œæœ‰çš„ç¿»è¿‡äº†ï¼Œå°±ä¸èƒ½ç¿»å›å»äº†** **Â lesså¯ä»¥å¾€ä¸Šå¾€ä¸‹éšæ„æŸ¥çœ‹ç¿»åŠ¨** more/lessÂ åˆ†é¡µæ˜¾ç¤ºç±»å®¹ more åªèƒ½å¾€ä¸‹ç¿»ï¼ˆç©ºæ ¼ï¼šç¿»é¡µ å›è½¦ï¼šä¸€è¡Œä¸€è¡Œ qï¼šé€€å‡ºï¼‰ lessÂ å¯ä»¥ä¸Šä¸‹ç¿» less /usr/share/dict/words\nï¼ˆ3ï¼‰head/tailï¼ˆå¤´éƒ¨/å°¾å·´ï¼‰\nhead\nä¸å†™-næ˜¾ç¤ºå‰10è¡Œç±»å®¹\n[root@chengfeng ~]# head -n 3 /etc/passwd(æ˜¾ç¤ºå‰ä¸‰è¡Œ)\nTail\nä¸å†™-næ˜¾ç¤ºå10è¡Œç±»å®¹\n[root@chengfeng ~]# tail-n 3 /etc/passwd(æ˜¾ç¤ºå‰ä¸‰è¡Œ)\nï¼ˆ4ï¼‰æŸ¥çœ‹æ–‡ä»¶ç±»å‹\n1 [root@chengfeng ~]# file /etc/passwd ï¼ˆæŸ¥çœ‹æ–‡ä»¶ç±»å‹ï¼‰ **Â ï¼ˆ5ï¼‰æŸ¥çœ‹å‘½ä»¤æ‰€åœ¨çš„è·¯å¾„**\n1 2 3 4 5 [root@chengfeng ~]# which ls alias ls=\u0026#39;ls --color=auto\u0026#39; /usr/bin/ls [root@chengfeng ~]# which cd /usr/bin/cd ï¼ˆ6ï¼‰|Â :ç®¡é“ç¬¦ è¿æ¥å‘½ä»¤ å‰é¢çš„å‘½ä»¤ç»™åé¢å‘½ä»¤å½“å‚æ•°\n1 2 3 4 5 6 7 8 [root@chengfeng ~]# head -n 5 /etc/passwd root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin daemon:x:2:2:daemon:/sbin:/sbin/nologin adm:x:3:4:adm:/var/adm:/sbin/nologin lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin [root@chengfeng ~]# head -n 5 /etc/passwd | tail -n 1ï¼ˆæ˜¾ç¤ºpasswdç¬¬5è¡Œçš„ç±»å®¹ï¼‰ lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin **Â æ˜¾ç¤ºå‰4ä¸ªæœ€å¤§æ–‡ä»¶**\n1 2 3 4 5 6 root@chengfeng ~]# ls -lhS /etc/ | head -n 5 æ€»ç”¨é‡ 1.4M -rw-r--r--. 1 root root 655K 6æœˆ 7 2013 services -rw-r--r-- 1 root root 92K 1æœˆ 7 14:35 ld.so.cache -rw-r--r-- 1 root root 51K 5æœˆ 15 2013 mime.types -rw-r--r-- 1 root root 15K 10æœˆ 31 08:17 autofs.conf **Â æ˜¾ç¤ºæœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶**\n1 2 3 4 5 6 7 8 9 10 [root@chengfeng ~]# ls -lt /etc/ |head -n 11 æ€»ç”¨é‡ 1396 drwxr-xr-x 5 root lp 304 1æœˆ 7 19:01 cups -rw-r--r-- 1 root root 57 1æœˆ 7 19:01 resolv.conf -rw-r--r-- 1 root root 1992 1æœˆ 7 14:51 passwd ---------- 1 root root 1138 1æœˆ 7 14:50 shadow ---------- 1 root root 690 1æœˆ 7 14:50 gshadow -rw-r--r-- 1 root root 862 1æœˆ 7 14:50 group -rw-r--r--. 1 root root 850 1æœˆ 7 14:49 group- ----------. 1 root root 682 1æœˆ 7 14:49 gshadow- ï¼ˆ7ï¼‰æŸ¥æ‰¾æ–‡ä»¶æˆ–ç›®å½•\n# find è·¯å¾„ æŸ¥æ‰¾æ–¹å¼\næŒ‰æ–‡ä»¶åç§°æŸ¥æ‰¾\n1 2 3 4 [root@chengfeng ~]# find /etc/ -name \u0026#34;*.conf\u0026#34; /etc/resolv.conf /etc/pki/ca-trust/ca-legacy.conf /etc/yum/pluginconf.d/fastestmirror.conf ç»Ÿè®¡æŸ¥æ‰¾çš„æ–‡ä»¶ä¸ªæ•°\n1 2 [root@chengfeng ~]# find /etc/ -name \u0026#34;*.conf\u0026#34; |wc -l 352 æŒ‰æ–‡ä»¶å¤§å°æŸ¥æ‰¾\næŸ¥æ‰¾å¤§äº1Mçš„æ–‡ä»¶\n1 2 3 4 5 6 [root@chengfeng ~]# find /etc/ -size +1M /etc/udev/hwdb.bin /etc/selinux/targeted/contexts/files/file_contexts.bin /etc/selinux/targeted/policy/policy.31 /etc/selinux/targeted/active/policy.kern /etc/selinux/targeted/active/policy.linked **Â æŒ‰æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´æŸ¥æ‰¾**\næŸ¥æ‰¾7å‰ä¿®æ”¹çš„æ–‡ä»¶\n1 [root@chengfeng ~]# find / -mtime +7 æŸ¥æ‰¾7å†…ä¿®æ”¹çš„æ–‡ä»¶\n1 [root@chengfeng ~]# find / -mtime -7 **Â æŒ‰æ–‡ä»¶çš„ç±»å‹æŸ¥æ‰¾**\n1 2 3 4 5 6 7 8 [root@chengfeng ~]# find /dev/ -type b /dev/dm-1 /dev/dm-0 /dev/sda2 /dev/sda1 /dev/sda /dev/sr0 [root@chengfeng ~]# find /dev/ -type l å¤åˆæ¡ä»¶æŸ¥æ–‡ä»¶\n[root@chengfeng ~]# find / -mtime +7 -a -size +100kï¼ˆaï¼šandå¹¶åˆ—ï¼‰\nFind /bj/ -name â€œ*.txtâ€ -exec rm -rf {}\\;Â åˆ é™¤\n# Find /bj/ -name â€œ*.txtâ€ -exec cp {} /root \\;å¤åˆ¶\n","date":"2019-01-07T23:55:11Z","image":"https://www.ownit.top/title_pic/09.jpg","permalink":"https://www.ownit.top/p/201901072355/","title":"Linuxå‘½ä»¤æŸ¥æ‰¾æ–‡ä»¶ç›®å½•"},{"content":"Linuxç›®å½•/æ–‡ä»¶å¢åˆ æ”¹\nåˆ›å»ºæ–‡ä»¶\n(1)\n# touchÂ \u0026lt;æ–‡ä»¶åç§°\u0026gt;\n(2)\nèŠ±æ‹¬å·å±•å¼€\ntouch /root/{1,3,9}.txt\ntouch /root/{0..100}.txtÂ æ‰¹é‡åˆ›å»ºæ–‡ä»¶\nåˆ é™¤æ–‡ä»¶\n**rm -f [æ–‡ä»¶å]Â **\n-rfÂ ä»£è¡¨å¼ºåˆ¶åˆ é™¤\næ‰¹é‡åˆ é™¤æ–‡ä»¶\nrm -f *txt\nå¤åˆ¶æ–‡ä»¶\ncp åªèƒ½å¤åˆ¶æ–‡ä»¶\ncp -rÂ å¯ä»¥å¤åˆ¶ç›®å½•\n# cp [option] æºæ–‡ä»¶ ç›®æ ‡æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 [root@zhang ~]# mkdir /root/{linux,windown} [root@zhang ~]# ls anaconda-ks.cfg linux mysql57-community-release-el7-8.noarch.rpm windown [root@zhang ~]# touch /root/linux/{1,2,3}.txt [root@zhang ~]# ls anaconda-ks.cfg linux mysql57-community-release-el7-8.noarch.rpm windown [root@zhang ~]# cd linux/ [root@zhang linux]# ls 1.txt 2.txt 3.txt [root@zhang linux]# cd /r root/ run/ [root@zhang linux]# cd /root/ [root@zhang ~]# cp /root/linux/1.txt /root/windown/ [root@zhang ~]# cd windown/ [root@zhang windown]# ls 1.txt [root@zhang windown]# cd .. [root@zhang ~]# ls anaconda-ks.cfg linux mysql57-community-release-el7-8.noarch.rpm windown [root@zhang ~]# cp /root/linux/2.txt /root/windown/2.jpg [root@zhang ~]# cd windown/ [root@zhang windown]# ls 1.txt 2.jpg ** -rÂ å¤åˆ¶æ–‡ä»¶ç›®å½•**\n1 2 3 4 5 6 7 8 9 [root@zhang ~]# cp -r /root/linux/ windown/ [root@zhang ~]# ls anaconda-ks.cfg linux mysql57-community-release-el7-8.noarch.rpm windown [root@zhang ~]# cd windown/ [root@zhang windown]# ls 1.txt 2.jpg linux [root@zhang windown]# cd linux/ [root@zhang linux]# ls 1.txt 2.txt 3.txt -fn å¼ºåˆ¶è¦†ç›–\n1 [root@zhang ~]# cp -fn /root/linux/1.txt /root/windown/ ç§»åŠ¨æ–‡ä»¶\n#mv æºæ–‡ä»¶ ç›®æ ‡æ–‡ä»¶\næ–‡ä»¶é‡å\n","date":"2019-01-06T13:58:06Z","image":"https://www.ownit.top/title_pic/12.jpg","permalink":"https://www.ownit.top/p/201901061358/","title":"Linuxæ–‡ä»¶å¢åˆ æ”¹"},{"content":"Linuxæ–‡ä»¶ç›®å½•ç®¡ç†\n1ï¼šç›®å½•ç®¡ç†\n1ï¼‰åˆ‡æ¢ç›®å½•\n# cdÂ [ ç›®å½•åç§°]\n2ï¼‰é€€åˆ°ä¸Šä¸€ç›®å½•\n# cd ..\n2ï¼šåˆ›å»ºç›®å½•\nmkdirÂ [æ–‡ä»¶åç§°]\nmkdir -pÂ [æ–‡ä»¶åç§°] é€’å½’åˆ›å»ºç›®å½•\n1 mkdir -p /root/linux/zhang/wei åˆ©ç”¨treeæ¥æŸ¥çœ‹ç»“æœ\n1 tree /root/linux 3ï¼šæ–‡ä»¶ç®¡ç†\n1ï¼‰æŸ¥çœ‹æ–‡ä»¶\nlsÂ \u0026lt;option\u0026gt;Â [ç›®å½•åç§°]\nã€optionã€‘ï¼šå‚æ•°\n-l ä»¥è¯¦ç»†ä¿¡æ¯æ˜¾ç¤ºå‡ºæ¥\n-rw-r\u0026ndash;r\u0026ndash;.Â 1 root rootÂ 16 12æœˆÂ 4 21:42 adjtime\nè§£é‡Šï¼šå‰é¢è¿™äº›- r d lç­‰ç¬¦åˆçš„æ„æ€\n-Â æ–‡ä»¶\ndÂ ç›®å½•\nlÂ è½¯é“¾æ¥æ–‡ä»¶ï¼ˆlinkï¼‰ç±»ä¼¼å¿«æ·æ–¹å¼\nbÂ å—è®¾å¤‡æ–‡ä»¶ï¼ˆblockï¼‰ï¼Œç¡¬ç›˜ï¼Œç¡¬ç›˜åˆ†åŒºï¼Œuç›˜ï¼Œå…‰ç›˜\ncÂ å­—ç¬¦è®¾å¤‡æ–‡ä»¶ï¼ˆchaeacterï¼‰é”®ç›˜ï¼Œé¼ æ ‡ï¼Œæ˜¾ç¤ºå™¨\nlsÂ \u0026lt;option\u0026gt;Â [ç›®å½•åç§°]\nå‚æ•°ï¼š\n-lÂ æ›´åŠ å¯è§†åŒ–çš„æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯\n-dÂ æ˜¾ç¤ºç›®å½•è‡ªèº«çš„ä¿¡æ¯\n-aÂ æ˜¾ç¤ºç›®å½•çš„éšè—æ–‡ä»¶ï¼ˆä»¥.å¼€å¤´çš„æ–‡ä»¶ï¼‰\n-tÂ æŒ‰æ–‡ä»¶ä¿®æ”¹æ—¶é—´é™åºæ’åˆ—\n-SÂ æŒ‰æ–‡ä»¶å¤§å°é™åºæ’åˆ—\nå„ä¸ªå‚æ•°å¯ä»¥ç»„åˆ\ndu -shÂ [ç›®å½•åç§°] ç”¨æ¥ç»Ÿè®¡æ–‡ä»¶å’Œç›®å½•å çš„å¤§å°\ndu -ahÂ [ç›®å½•åç§°] ç”¨æ¥åˆ†äº«æ¯ä¸ªæ–‡ä»¶å’Œç›®å½•å çš„å¤§å°\n","date":"2019-01-05T14:53:31Z","image":"https://www.ownit.top/title_pic/30.jpg","permalink":"https://www.ownit.top/p/201901051453/","title":"Linuxç›®å½•ç®¡ç†"},{"content":"æ—¶é—´ä¹…äº†ï¼Œæˆ‘è¶Šæ¥è¶Šæ„Ÿè§‰linuxæ¯”windowå¥½ç”¨ã€‚\néš¾é“è¿™å°±æ˜¯ä¼ è¯´ä¸­çš„æ—¥ä¹…ç”Ÿæƒ…å—ï¼Ÿ\nå­¦ä¹ æ˜¯æŒä¹‹ä»¥æ’çš„ï¼Œä»åŸºç¡€å¼€å§‹ï¼Œæ…¢æ…¢æ¥ï¼Œæˆ‘ç›¸ä¿¡è‡ªå·±æœ‰ä¸€å¤©ä¼šå˜æˆå¤§ç¥çš„ã€‚\nLinuxå°±æ˜¯é‚£ä¹ˆçš„æ–¹ä¾¿ï¼Œå¹²ä»€ä¹ˆå°±æ˜¯ä¸€ä¸ªå‘½ä»¤å°±å®Œäº‹ï¼Œä¸åƒwindowé‚£ä¹ˆéº»çƒ¦ã€‚\nlLinuxæ”¹ä¸»æœºåç§°ï¼Œè¿™ä¸ªæ›´åŠ çš„ç®€å•ã€‚ä½†æ˜¯ä¸ºäº†æ›´æ·±çš„è®°å¿†ï¼Œè¿˜æ˜¯å†æ¬¡å†™ä¸€ä¸‹ã€‚\nï¼ˆ1ï¼‰linuxä¸€å¼€å§‹å®‰è£…æ—¶å°±æœ‰ä¿®æ”¹ä¸»æœºåç§°çš„é€‰é¡¹ã€‚\nï¼ˆ2ï¼‰å¦‚æœåœ¨å®‰è£…å®Œåï¼Œæƒ³ä¿®æ”¹ä¸»æœºåç§°ï¼Œä¸€ä¸ªå‘½ä»¤å°±å®Œæˆã€‚\nå‘½ä»¤ï¼šhostnamectl set-hostname [ä½ æƒ³ä¿®æ”¹çš„åç§°]\n1 hostnamectl set-hostname zhang **Â **\nç­‰ä½ é€€å‡ºä»æ–°ç™»å½•æ—¶ï¼Œä½ å°±ä¼šå‘ç°linuxå‘½ä»¤å­—ç¬¦ä¸²çš„æ”¹å˜ï¼›\n","date":"2019-01-04T19:22:56Z","image":"https://www.ownit.top/title_pic/30.jpg","permalink":"https://www.ownit.top/p/201901041922/","title":"Linuxä¿®æ”¹ä¸»æœºå"},{"content":"Linuxåˆ›å»ºé«˜çº§ç”¨æˆ·å¹¶åˆ é™¤\nå¸¸è§windowç³»ç»Ÿå¯ä»¥åˆ›å»ºè®¸å¤šç”¨æˆ·ï¼Œä½†æ˜¯linuxä¹Ÿå¯ä»¥åˆ›å»ºè®¸å¤šç”¨æˆ·ã€‚\næ–¹æ³•æ¯”windowæ–¹ä¾¿ç®€å•ã€‚\nï¼ˆ1ï¼‰æ·»åŠ ä¸€ä¸ªæ™®é€šç”¨æˆ· ï¼šnangongï¼ˆåå­—è‡ªå·±å–ï¼‰\n1 useradd nangong ï¼ˆ2ï¼‰è®¾ç½®ç”¨æˆ·nangongçš„å¯†ç \n1 passwd nangong ï¼ˆ3ï¼‰åœ¨rootæƒé™ä¸‹ä¿®æ”¹/etc/passwd é‡Œçš„ç”¨æˆ·nangongçš„æƒé™\n1 2 3 4 nangong:x:1000:1000::/home/nangong:/bin/bash #æŠŠä¸¤ä¸ª1000æ”¹ä¸º0å°±å¯ä»¥äº† nangong:x:0:0::/home/nangong:/bin/bash ï¼ˆ4ï¼‰å·²ç»æˆåŠŸåˆ›å»ºä¸€ä¸ªé«˜çº§ç”¨æˆ·nangong\nï¼ˆaï¼‰åˆ é™¤ä¸€ä¸ªç”¨æˆ·ï¼Œå‰æï¼Œé‚£ä¸ªç”¨æˆ·æ²¡æœ‰åœ¨è¿è¡Œä¸­ï¼Œä¸ç„¶ä¼šæç¤ºä¸‹é¢çš„é”™è¯¯\nè§£å†³æ–¹æ³•ï¼šï¼ˆ1ï¼‰åˆ‡æ¢åˆ°é‚£ä¸ªç”¨æˆ·ï¼Œç„¶åè¿ç»­æŒ‰ä¸¤æ¬¡ctl+dï¼Œé€€å‡ºç”¨æˆ·\n**Â ï¼ˆ2ï¼‰ä½¿ç”¨vipwå‘½ä»¤ ï¼Œåˆ é™¤nangongé‚£è¡Œï¼Œä¿å­˜**\n**Â ï¼ˆ3ï¼‰ç„¶åä½¿ç”¨vipw -s å‘½ä»¤ ï¼Œåˆ é™¤nangongé‚£è¡Œï¼Œä¿å­˜**\nç„¶åå°±è¡Œä¸‹æ¥çš„æ­¥éª¤å³å¯\nï¼ˆbï¼‰æˆ‘ä»¬æ¥åˆ°/homeä¸‹ï¼Œå¯ä»¥çœ‹åˆ°nangongè¿™ä¸ªç”¨æˆ·\n1 cd /home (c)åˆ é™¤è¿™ä¸ªç”¨æˆ·ï¼Œä½†æ˜¯å‘½ä»¤ä¸æ˜¯rm\næ­£ç¡®å‘½ä»¤ï¼š\n1 userdel -r nangong å¯ä»¥ç›´æ¥åˆ é™¤/home çš„nangong\nå‘½ä»¤ï¼š\n1 rm -rf nangong ","date":"2019-01-03T19:29:30Z","image":"https://www.ownit.top/title_pic/71.jpg","permalink":"https://www.ownit.top/p/201901031929/","title":"Linuxåˆ›å»ºé«˜çº§ç”¨æˆ·å¹¶åˆ é™¤"},{"content":"linuxå‘½ä»¤æç¤ºç¬¦\nå‘½ä»¤çª—å£ä¸­[root@chengfeng ~]# è¡¨ç¤ºä»€ä¹ˆæ„æ€ï¼Ÿ\n**Â rootÂ å½“å‰ç™»å½•ç»ˆç«¯çš„ç”¨æˆ·**\n**Â chengfeng ä¸»æœºå(/etc/sysconfig/network)**\n**Â ~ å½“å‰ç”¨æˆ·çš„å®¶ç›®å½•**\n**Â # è¡¨ç¤ºrootç”¨æˆ·çš„ç»ˆç«¯**\n**Â $ æ™®é€šç”¨æˆ·çš„ç»ˆç«¯**\nï¼ˆ1ï¼‰rootÂ å½“å‰ç™»å½•ç»ˆç«¯çš„ç”¨æˆ·\nï¼ˆ2ï¼‰Â chengfeng ä¸»æœºå(/etc/sysconfig/network)\n**Â **\nï¼ˆ3ï¼‰Â ~ å½“å‰ç”¨æˆ·çš„å®¶ç›®å½•\n**Â **\nï¼ˆ4ï¼‰ # è¡¨ç¤ºrootç”¨æˆ·çš„ç»ˆç«¯\n**Â **\n**Â $ æ™®é€šç”¨æˆ·çš„ç»ˆç«¯**\naï¼šæ·»åŠ ä¸€ä¸ªæ™®é€šçš„æ–°ç”¨æˆ·\n**Â bï¼šåˆ‡æ¢åˆ°catç”¨æˆ·ä¸‹**\n","date":"2019-01-03T18:19:46Z","image":"https://www.ownit.top/title_pic/02.jpg","permalink":"https://www.ownit.top/p/201901031819/","title":"linuxå‘½ä»¤æç¤ºç¬¦è§£æ"},{"content":"linuxç³»ç»Ÿä¸­ä¸€åˆ‡çš†æ–‡ä»¶ã€‚\næœ‰æ–‡ä»¶ï¼Œå½“ç„¶å°‘ä¸äº†ç›®å½•ã€‚\nLinuxç›®å½•å’ŒWindowsç›®å½•æœ‰ç€å¾ˆå¤§çš„ä¸åŒï¼ŒLinuxç›®å½•ç±»ä¼¼ä¸€ä¸ªæ ‘ï¼Œæœ€é¡¶å±‚æ˜¯å…¶æ ¹ç›®å½•ã€‚\n**åœ¨æ­¤æˆ‘ä»‹ç»ä¸€ä¸‹åˆå­¦è€…éœ€è¦å…ˆäº†è§£çš„linuxç›®å½•ï¼Œå…³äºè·Ÿé«˜æ·±çš„linuxç›®å½•ï¼ŒåæœŸä¼šåšå‡ºç›¸åº”çš„è®²è§£Â **\n/æ ¹ç›®å½•/rootrootç”¨æˆ·çš„å®¶ç›®å½•/å®¿ä¸»ç›®å½•/bootå¯åŠ¨åˆ†åŒºï¼ˆå†…æ ¸ï¼Œå¯åŠ¨é…ç½®æ–‡ä»¶ï¼‰/devè®¾å¤‡æ–‡ä»¶ç›®å½•/proc,/sysä¸ºæ ¹ç³»ç»Ÿ/etcåº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ \u0026nbsp;\u0026nbsp; *.conf/homeæ™®é€šç”¨æˆ·çš„å®¶ç›®å½•/å®¿ä¸»ç›®å½•å¸¦æœ‰/bin,/sbinå¯æ‰§è¡Œç¨‹åºï¼ˆäºŒè¿›åˆ¶ç¨‹åºï¼‰/varæ”¾ç½®ç³»ç»Ÿæ‰§è¡Œè¿‡ç¨‹ä¸­ç»å¸¸å˜åŒ–çš„æ–‡ä»¶ï¼Œå¦‚éšæ—¶æ›´æ”¹çš„æ—¥å¿—æ–‡ä»¶/tmpå­˜æ”¾ä¸´æ—¶æ–‡ä»¶ç›®å½•ï¼Œä¸€äº›å‘½ä»¤å’Œåº”ç”¨ç¨‹åºä¼šç”¨çš„åˆ°è¿™ä¸ªç›®å½• **/ï¼š**æ ¹ç›®å½•ï¼Œä½äºLinuxæ–‡ä»¶ç³»ç»Ÿç›®å½•ç»“æ„çš„é¡¶å±‚ï¼Œä¸€èˆ¬æ ¹ç›®å½•ä¸‹åªå­˜æ”¾ç›®å½•ï¼Œä¸è¦å­˜æ”¾æ–‡ä»¶ï¼Œ/etcã€/binã€/devã€/libã€/sbinåº”è¯¥å’Œæ ¹ç›®å½•æ”¾ç½®åœ¨ä¸€ä¸ªåˆ†åŒºä¸­ã€‚\n/binï¼Œ/usr/binï¼šè¯¥ç›®å½•ä¸ºå‘½ä»¤æ–‡ä»¶ç›®å½•ï¼Œä¹Ÿç§°ä¸ºäºŒè¿›åˆ¶ç›®å½•ã€‚åŒ…å«äº†ä¾›ç³»ç»Ÿç®¡ç†å‘˜åŠæ™®é€šç”¨æˆ·ä½¿ç”¨çš„é‡è¦çš„linuxå‘½ä»¤å’ŒäºŒè¿›åˆ¶ï¼ˆå¯æ‰§è¡Œï¼‰æ–‡ä»¶ï¼ŒåŒ…å«shellè§£é‡Šå™¨ç­‰ã€‚\n/bootï¼š è¯¥ç›®å½•ä¸­å­˜æ”¾ç³»ç»Ÿçš„å†…æ ¸æ–‡ä»¶å’Œå¼•å¯¼è£…è½½ç¨‹åºæ–‡ä»¶ï¼Œ/boot/vmlinuzä¸ºlinuxçš„å†…æ ¸æ–‡ä»¶ï¼Œä»¥åŠ/boot/gurbã€‚å»ºè®®å•ç‹¬åˆ†åŒºï¼Œåˆ†åŒºå¤§å°100Må³å¯ã€‚\n/devï¼š è®¾å¤‡ï¼ˆdeviceï¼‰æ–‡ä»¶ç›®å½•ï¼Œå­˜æ”¾linuxç³»ç»Ÿä¸‹çš„è®¾å¤‡æ–‡ä»¶ï¼Œè®¿é—®è¯¥ç›®å½•ä¸‹æŸä¸ªæ–‡ä»¶ï¼Œç›¸å½“äºè®¿é—®æŸä¸ªè®¾å¤‡ï¼Œå­˜æ”¾è¿æ¥åˆ°è®¡ç®—æœºä¸Šçš„è®¾å¤‡ï¼ˆç»ˆç«¯ã€ç£ç›˜é©±åŠ¨å™¨ã€å…‰é©±åŠç½‘å¡ç­‰ï¼‰çš„å¯¹åº”æ–‡ä»¶ï¼ŒåŒ…æ‹¬å­—ç¬¦è®¾å¤‡å’Œå—è®¾å¤‡ç­‰ï¼Œå¸¸ç”¨çš„æ˜¯æŒ‚è½½å…‰é©±mount /dev/cdrom/mntã€‚Â /etcï¼š ç³»ç»Ÿé…ç½®æ–‡ä»¶å­˜æ”¾çš„ç›®å½•ï¼Œè¯¥ç›®å½•å­˜æ”¾ç³»ç»Ÿçš„å¤§éƒ¨åˆ†é…ç½®æ–‡ä»¶å’Œå­ç›®å½•ï¼Œä¸å»ºè®®åœ¨æ­¤ç›®å½•ä¸‹å­˜æ”¾å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‡è¦çš„é…ç½®æ–‡ä»¶æœ‰/etc/inittabã€/etc/fstabã€/etc/init.dã€/etc/X11ï¼ˆX Windowç³»ç»Ÿæœ‰å…³ï¼‰ã€/etc/sysconfigï¼ˆä¸ç½‘ç»œæœ‰å…³ï¼‰ã€/etc/xinetd.dä¿®æ”¹é…ç½®æ–‡ä»¶ä¹‹å‰è®°å¾—å¤‡ä»½ã€‚è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶ç”±ç³»ç»Ÿç®¡ç†å‘˜æ¥ä½¿ç”¨ï¼Œæ™®é€šç”¨æˆ·å¯¹å¤§éƒ¨åˆ†æ–‡ä»¶æœ‰åªè¯»æƒé™ã€‚\n/homeï¼š ç³»ç»Ÿé»˜è®¤çš„ç”¨æˆ·å®¿ä¸»ç›®å½•ï¼Œæ–°å¢ç”¨æˆ·è´¦å·æ—¶ï¼Œç”¨æˆ·çš„å®¿ä¸»ç›®å½•éƒ½å­˜æ”¾åœ¨æ­¤ç›®å½•ä¸‹ï¼Œ~è¡¨ç¤ºå½“å‰ç”¨æˆ·çš„å®¿ä¸»ç›®å½•ï¼Œ~testè¡¨ç¤ºç”¨æˆ·testçš„å®¿ä¸»ç›®å½•ã€‚å»ºè®®å•ç‹¬åˆ†åŒºï¼Œå¹¶è®¾ç½®è¾ƒå¤§çš„ç£ç›˜ç©ºé—´ï¼Œæ–¹ä¾¿ç”¨æˆ·å­˜æ”¾æ•°æ®ã€‚\n/libï¼Œ/usr/libï¼Œ/usr/local/libï¼šç³»ç»Ÿä½¿ç”¨çš„å‡½æ•°åº“çš„ç›®å½•ï¼Œç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦è°ƒç”¨ä¸€äº›é¢å¤–çš„å‚æ•°æ—¶éœ€è¦å‡½æ•°åº“çš„ååŠ©ï¼Œè¯¥ç›®å½•ä¸‹å­˜æ”¾äº†å„ç§ç¼–ç¨‹è¯­è¨€åº“ã€‚å…¸å‹çš„linuxç³»ç»ŸåŒ…å«äº†Cã€C++å’ŒFORTRANè¯­è¨€çš„åº“æ–‡ä»¶ã€‚/libç›®å½•ä¸‹çš„åº“æ˜ åƒæ–‡ä»¶å¯ä»¥ç”¨æ¥å¯åŠ¨ç³»ç»Ÿå¹¶æ‰§è¡Œä¸€äº›å‘½ä»¤ï¼Œç›®å½•/lib/modulesåŒ…å«äº†å¯åŠ è½½çš„å†…æ ¸æ¨¡å—ï¼Œ/libç›®å½•å­˜æ”¾äº†æ‰€æœ‰é‡è¦çš„åº“æ–‡ä»¶ï¼Œå…¶ä»–çš„åº“æ–‡ä»¶åˆ™å¤§éƒ¨åˆ†å­˜æ”¾åœ¨/usr/libç›®å½•ä¸‹ã€‚\n/procï¼š æ­¤ç›®å½•çš„æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼Œå¦‚ç³»ç»Ÿæ ¸å¿ƒï¼Œå¤–éƒ¨è®¾å¤‡ï¼Œç½‘ç»œçŠ¶æ€ï¼Œç”±äºæ•°æ®éƒ½å­˜æ”¾äºå†…å­˜ä¸­ï¼Œæ‰€ä»¥ä¸å ç”¨ç£ç›˜ç©ºé—´ï¼Œæ¯”è¾ƒé‡è¦çš„ç›®å½•æœ‰/proc/cpuinfoã€/proc/interruptsã€/proc/dmaã€/proc/ioportsã€/proc/net/*ç­‰ã€‚\n/rootï¼šç³»ç»Ÿç®¡ç†å‘˜rootçš„å®¿ä¸»ç›®å½•ï¼Œç³»ç»Ÿç¬¬ä¸€ä¸ªå¯åŠ¨çš„åˆ†åŒºä¸º/ï¼Œæ‰€ä»¥æœ€å¥½å°†/rootå’Œ/æ”¾ç½®åœ¨ä¸€ä¸ªåˆ†åŒºä¸‹ã€‚\n/sbinï¼Œ/usr/sbinï¼Œ/usr/local/sbinï¼šæ”¾ç½®ç³»ç»Ÿç®¡ç†å‘˜ä½¿ç”¨çš„å¯æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚fdiskã€shutdownã€mountç­‰ã€‚ä¸/binä¸åŒçš„æ˜¯ï¼Œè¿™å‡ ä¸ªç›®å½•æ˜¯ç»™ç³»ç»Ÿç®¡ç†å‘˜rootä½¿ç”¨çš„å‘½ä»¤ï¼Œä¸€èˆ¬ç”¨æˆ·åªèƒ½\u0026quot;æŸ¥çœ‹\u0026quot;è€Œä¸èƒ½è®¾ç½®å’Œä½¿ç”¨ã€‚\n/usrï¼š åº”ç”¨ç¨‹åºå­˜æ”¾ç›®å½•ï¼Œ/usr/bin å­˜æ”¾åº”ç”¨ç¨‹åºï¼Œ /usr/share å­˜æ”¾å…±äº«æ•°æ®ï¼Œ/usr/lib\nå­˜æ”¾ä¸èƒ½ç›´æ¥è¿è¡Œçš„ï¼Œå´æ˜¯è®¸å¤šç¨‹åºè¿è¡Œæ‰€å¿…éœ€çš„ä¸€äº›å‡½æ•°åº“æ–‡ä»¶ï¼Œ/usr/local å­˜æ”¾è½¯ä»¶å‡çº§åŒ…ï¼Œ/usr/share/doc ç³»ç»Ÿè¯´æ˜æ–‡ä»¶å­˜æ”¾ç›®å½•ã€‚\n/usr/share/man: ç¨‹åºè¯´æ˜æ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œä½¿ç”¨ man lsæ—¶ä¼šæŸ¥è¯¢/usr/share/man/man1/ls.1.gzçš„å†…å®¹å»ºè®®å•ç‹¬åˆ†åŒºï¼Œè®¾ç½®è¾ƒå¤§çš„ç£ç›˜ç©ºé—´ã€‚\n/varï¼š æ”¾ç½®ç³»ç»Ÿæ‰§è¡Œè¿‡ç¨‹ä¸­ç»å¸¸å˜åŒ–çš„æ–‡ä»¶ï¼Œå¦‚éšæ—¶æ›´æ”¹çš„æ—¥å¿—æ–‡ä»¶ /var/logã€‚/var/log/messageï¼š\næ‰€æœ‰çš„ç™»å½•æ–‡ä»¶å­˜æ”¾ç›®å½•ã€‚/var/spool/mailï¼š é‚®ä»¶å­˜æ”¾çš„ç›®å½•ã€‚ /var/run: ç¨‹åºæˆ–æœåŠ¡å¯åŠ¨åã€‚å»ºè®®å•ç‹¬åˆ†åŒºï¼Œè®¾ç½®è¾ƒå¤§çš„ç£ç›˜ç©ºé—´ã€‚\n/tmpï¼šå­˜æ”¾ä¸´æ—¶æ–‡ä»¶ç›®å½•ï¼Œä¸€äº›å‘½ä»¤å’Œåº”ç”¨ç¨‹åºä¼šç”¨çš„åˆ°è¿™ä¸ªç›®å½•ã€‚è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä¼šè¢«å®šæ—¶åˆ é™¤ï¼Œä»¥é¿å…ä¸´æ—¶æ–‡ä»¶å æ»¡æ•´ä¸ªç£ç›˜ã€‚\n","date":"2019-01-03T16:49:46Z","image":"https://www.ownit.top/title_pic/37.jpg","permalink":"https://www.ownit.top/p/201901031649/","title":"linuxç›®å½•ç»“æ„"},{"content":"è¿‘æœŸè¦å…¥å‘linuxè¿ç»´ï¼Œåœ¨æ­¤äº¤æµè‡ªå·±çš„æŠ€æœ¯å’Œå¿ƒå¾—ã€‚å¼€å§‹è‡ªå·±åšå®¢çš„ç”Ÿæ¶¯ã€‚ï¼ˆå¤§ç¥å‹¿å–·ï¼‰\næˆåŠŸå®‰è£…CentOS7åçš„åŸºç¡€æ­¥éª¤\nè½¯ä»¶ï¼šVmware Workstation\nç³»ç»Ÿï¼šCentOS7\nå®‰è£…æˆåŠŸçš„CentOS7ç•Œé¢\nå®‰è£…å®Œæ¯•åæ“ä½œ:\nï¼ˆ1ï¼‰Â å…³é—­é˜²ç«å¢™\n1 2 systemctl stop firewalld # å½“å‰å…³é—­é˜²ç«å¢™ systemctl disable firewalld # å¼€æœºç¦ç”¨é˜²ç«å¢™ ï¼ˆ2ï¼‰ç¦ç”¨SELinux\n1 sed -i.bak â€˜s/=enforcing/=disabled/â€™ /etc/selinux/config 1 sed -i.bak â€˜s/=enforcing/=disabled/â€™ /etc/sysconfig/selinux ä¸Šé¢ä¸¤ä¸²ä»£ç æ•ˆæœä¸€æ ·ï¼Œåªéœ€è¦è¿è¡Œä¸€ä¸ªå³å¯\nï¼ˆ3ï¼‰Â å…³æœº\n1 shutdown -h now ï¼ˆ4ï¼‰åˆ›å»ºå¿«ç…§ï¼Œé¿å…é‡æ–°å®‰è£…\nï¼ˆ6ï¼‰å®‰è£…è¿œç¨‹ç®¡ç†è½¯ä»¶Xmanager6\n","date":"2019-01-02T16:59:18Z","image":"https://www.ownit.top/title_pic/44.jpg","permalink":"https://www.ownit.top/p/201901021659/","title":"linuxåŸºç¡€æ“ä½œ"}]