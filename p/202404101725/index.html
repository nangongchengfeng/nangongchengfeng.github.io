<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='èƒŒæ™¯æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„æœåŠ¡å™¨ï¼Œå¯¹äºç½‘ç»œç¯å¢ƒä¸­çš„æ—¥å¿—è®°å½•å’Œé…ç½®è‡³å…³é‡è¦ã€‚å®šåˆ¶åŒ–æ—¥å¿—æ ¼å¼å¯ä»¥å¸®åŠ©ç®¡ç†å‘˜æ›´å¥½åœ°ç›‘æ§æœåŠ¡å™¨æ€§èƒ½ã€åˆ†æç”¨æˆ·è¡Œä¸ºå¹¶åšå‡ºç›¸åº”ä¼˜åŒ–ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨æ—¥å¿—æ ¼å¼çš„é«˜çº§å®šåˆ¶åŒ–ç­–ç•¥ï¼ŒåŒ…æ‹¬ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚'>
<title>Nginxæ—¥å¿—æ ¼å¼åŒ–å’Œè¿½è¸ª</title>

<link rel='canonical' href='https://www.ownit.top/p/202404101725/'>

<link rel="stylesheet" href="/scss/style.min.f8f67bed86aec9bc8e9eb410ba9583e51cb34eee82f3d10e0abbae72b51272ce.css"><meta property='og:title' content='Nginxæ—¥å¿—æ ¼å¼åŒ–å’Œè¿½è¸ª'>
<meta property='og:description' content='èƒŒæ™¯æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„æœåŠ¡å™¨ï¼Œå¯¹äºç½‘ç»œç¯å¢ƒä¸­çš„æ—¥å¿—è®°å½•å’Œé…ç½®è‡³å…³é‡è¦ã€‚å®šåˆ¶åŒ–æ—¥å¿—æ ¼å¼å¯ä»¥å¸®åŠ©ç®¡ç†å‘˜æ›´å¥½åœ°ç›‘æ§æœåŠ¡å™¨æ€§èƒ½ã€åˆ†æç”¨æˆ·è¡Œä¸ºå¹¶åšå‡ºç›¸åº”ä¼˜åŒ–ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨æ—¥å¿—æ ¼å¼çš„é«˜çº§å®šåˆ¶åŒ–ç­–ç•¥ï¼ŒåŒ…æ‹¬ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚'>
<meta property='og:url' content='https://www.ownit.top/p/202404101725/'>
<meta property='og:site_name' content='å—å®«ä¹˜é£'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='nginx' /><meta property='article:tag' content='è¿ç»´' /><meta property='article:published_time' content='2024-04-10T17:25:30&#43;00:00'/><meta property='article:modified_time' content='2024-04-10T17:25:30&#43;00:00'/><meta property='og:image' content='https://www.ownit.top/title_pic/67.jpg' />
<meta name="twitter:title" content="Nginxæ—¥å¿—æ ¼å¼åŒ–å’Œè¿½è¸ª">
<meta name="twitter:description" content="èƒŒæ™¯æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„æœåŠ¡å™¨ï¼Œå¯¹äºç½‘ç»œç¯å¢ƒä¸­çš„æ—¥å¿—è®°å½•å’Œé…ç½®è‡³å…³é‡è¦ã€‚å®šåˆ¶åŒ–æ—¥å¿—æ ¼å¼å¯ä»¥å¸®åŠ©ç®¡ç†å‘˜æ›´å¥½åœ°ç›‘æ§æœåŠ¡å™¨æ€§èƒ½ã€åˆ†æç”¨æˆ·è¡Œä¸ºå¹¶åšå‡ºç›¸åº”ä¼˜åŒ–ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨æ—¥å¿—æ ¼å¼çš„é«˜çº§å®šåˆ¶åŒ–ç­–ç•¥ï¼ŒåŒ…æ‹¬ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://www.ownit.top/title_pic/67.jpg' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu227367ba8544f2fc7811ed9508937bec_102665_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">å—å®«ä¹˜é£</a></h1>
            <h2 class="site-description">å½“ä½ çš„æ‰åæ’‘ä¸èµ·ä½ çš„é‡å¿ƒæ—¶ï¼Œåªæœ‰é™ä¸‹å¿ƒå­¦ä¹ æ‰æ˜¯å”¯ä¸€çš„å‡ºè·¯</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://blog.csdn.net/heian_99'
                        target="_blank"
                        title="CSDN"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="32.000000pt" height="32.000000pt" viewBox="0 0 32.000000 32.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,32.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M0 160 l0 -160 160 0 160 0 0 160 0 160 -160 0 -160 0 0 -160z m225
108 c24 -11 34 -41 16 -52 -4 -3 -17 1 -27 9 -43 32 -95 3 -109 -62 -5 -27 -2
-37 19 -58 29 -29 62 -32 94 -9 25 17 42 11 42 -15 0 -27 -51 -45 -107 -38
-70 8 -97 42 -91 115 4 48 10 60 41 89 39 35 76 42 122 21z"/>
</g>
</svg>

                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/nangongchengfeng/'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='/index.xml'
                        target="_blank"
                        title="RSS"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 455.731 455.731" xml:space="preserve">
<g>
	<rect x="0" y="0" style="fill:#F78422;" width="455.731" height="455.731"/>
	<g>
		<path style="fill:#FFFFFF;" d="M296.208,159.16C234.445,97.397,152.266,63.382,64.81,63.382v64.348
			c70.268,0,136.288,27.321,185.898,76.931c49.609,49.61,76.931,115.63,76.931,185.898h64.348
			C391.986,303.103,357.971,220.923,296.208,159.16z"/>
		<path style="fill:#FFFFFF;" d="M64.143,172.273v64.348c84.881,0,153.938,69.056,153.938,153.939h64.348
			C282.429,270.196,184.507,172.273,64.143,172.273z"/>
		<circle style="fill:#FFFFFF;" cx="109.833" cy="346.26" r="46.088"/>
	</g>
</g>
</svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/link/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>å‹é“¾</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#èƒŒæ™¯">èƒŒæ™¯</a></li>
    <li><a href="#nginxè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼">Nginxè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼</a>
      <ol>
        <li><a href="#1-ç†è§£åŸºç¡€æ—¥å¿—ç»“æ„">1. ç†è§£åŸºç¡€æ—¥å¿—ç»“æ„</a></li>
        <li><a href="#2-æ—¥å¿—æ ¼å¼è‡ªå®šä¹‰å®ä¾‹">2. æ—¥å¿—æ ¼å¼è‡ªå®šä¹‰å®ä¾‹</a></li>
        <li><a href="#æ¨¡å—é›†æˆä¸æ‰©å±•">æ¨¡å—é›†æˆä¸æ‰©å±•</a></li>
        <li><a href="#æ—¥å¿—åˆ‡å‰²ä¸ç®¡ç†">æ—¥å¿—åˆ‡å‰²ä¸ç®¡ç†</a></li>
        <li><a href="#nginxçš„æ—¥å¿—å¸¸è§é…ç½®é¡¹">Nginxçš„æ—¥å¿—å¸¸è§é…ç½®é¡¹</a></li>
      </ol>
    </li>
    <li><a href="#nginxä¹‹é—´çš„æ—¥å¿—è¿½è¸ª">Nginxä¹‹é—´çš„æ—¥å¿—è¿½è¸ª</a>
      <ol>
        <li><a href="#wafä¸nginxåä½œåŸç†">WAFä¸Nginxåä½œåŸç†</a></li>
        <li><a href="#æ—¥å¿—é›†æˆæŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ">æ—¥å¿—é›†æˆæŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ</a></li>
        <li><a href="#ç”¨æˆ·è®¿é—®æµç¨‹æ—¥å¿—åˆ†æ">ç”¨æˆ·è®¿é—®æµç¨‹æ—¥å¿—åˆ†æ</a></li>
        <li><a href="#æ—¥å¿—åˆ†æä¸å¯è§†åŒ–">æ—¥å¿—åˆ†æä¸å¯è§†åŒ–</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/202404101725/">
                
                    <img src="/../../title_pic/67.jpg" loading="lazy" alt="Featured image of post Nginxæ—¥å¿—æ ¼å¼åŒ–å’Œè¿½è¸ª" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/nginx/" >
                Nginx
            </a>
        
            <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" >
                é¡¹ç›®å®æˆ˜
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/202404101725/">Nginxæ—¥å¿—æ ¼å¼åŒ–å’Œè¿½è¸ª</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            èƒŒæ™¯æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„æœåŠ¡å™¨ï¼Œå¯¹äºç½‘ç»œç¯å¢ƒä¸­çš„æ—¥å¿—è®°å½•å’Œé…ç½®è‡³å…³é‡è¦ã€‚å®šåˆ¶åŒ–æ—¥å¿—æ ¼å¼å¯ä»¥å¸®åŠ©ç®¡ç†å‘˜æ›´å¥½åœ°ç›‘æ§æœåŠ¡å™¨æ€§èƒ½ã€åˆ†æç”¨æˆ·è¡Œä¸ºå¹¶åšå‡ºç›¸åº”ä¼˜åŒ–ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨æ—¥å¿—æ ¼å¼çš„é«˜çº§å®šåˆ¶åŒ–ç­–ç•¥ï¼ŒåŒ…æ‹¬ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Apr 10, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 13 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>Nginxæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„WebæœåŠ¡å™¨ï¼Œå¯¹äºç½‘ç»œç¯å¢ƒä¸­çš„æ—¥å¿—è®°å½•å’Œé…ç½®è‡³å…³é‡è¦ã€‚å®šåˆ¶åŒ–Nginxæ—¥å¿—æ ¼å¼å¯ä»¥å¸®åŠ©ç®¡ç†å‘˜æ›´å¥½åœ°ç›‘æ§æœåŠ¡å™¨æ€§èƒ½ã€åˆ†æç”¨æˆ·è¡Œä¸ºå¹¶åšå‡ºç›¸åº”ä¼˜åŒ–ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨Nginxæ—¥å¿—æ ¼å¼çš„é«˜çº§å®šåˆ¶åŒ–ç­–ç•¥ï¼ŒåŒ…æ‹¬ç†è§£åŸºç¡€æ—¥å¿—ç»“æ„ã€æ—¥å¿—æ ¼å¼è‡ªå®šä¹‰å®ä¾‹ã€æ¨¡å—é›†æˆä¸æ‰©å±•ä»¥åŠæ—¥å¿—åˆ‡å‰²ä¸ç®¡ç†ã€‚</p>
<ol>
<li>
<p>Nginxçš„è‡ªå®šä¹‰æ—¥å¿—ï¼ˆæŒ‡æ ‡å…¨é¢ï¼‰</p>
</li>
<li>
<p>Nginxä¹‹é—´çš„æ—¥å¿—è¿½è¸ªï¼ˆåˆ†ææ•´ä¸ªæµç¨‹ï¼‰</p>
</li>
</ol>
<h2 id="nginxè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼">Nginxè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼</h2>
<h3 id="1-ç†è§£åŸºç¡€æ—¥å¿—ç»“æ„">1. ç†è§£åŸºç¡€æ—¥å¿—ç»“æ„</h3>
<p>log_format æœ‰ä¸€ä¸ªé»˜è®¤çš„æ— éœ€è®¾ç½®çš„ combined æ—¥å¿—æ ¼å¼ï¼Œç›¸å½“äºapache çš„ combined æ—¥å¿—æ ¼å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">log_format combined <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39; &#34;$request&#34; $status $body_bytes_sent &#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39; &#34;$http_referer&#34; &#34;$http_user_agent&#34; &#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Nginxé»˜è®¤æ—¥å¿—æ ¼å¼åŒ…å«å¤šä¸ªå­—æ®µï¼Œæ¯ä¸ªå­—æ®µéƒ½æä¾›äº†æœ‰ç”¨çš„ä¿¡æ¯æ¥å¸®åŠ©åˆ†ææœåŠ¡å™¨è¡Œä¸ºã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§å­—æ®µåŠå…¶å«ä¹‰ï¼š</p>
<ul>
<li><code>$remote_addr</code>: å®¢æˆ·ç«¯çš„IPåœ°å€</li>
<li><code>$remote_user</code>: å®¢æˆ·ç«¯ç”¨æˆ·çš„åç§°</li>
<li><code>$time_local</code>: è®¿é—®æ—¶é—´ä¸æ—¶åŒº</li>
<li><code>$request</code>: å®Œæ•´çš„HTTPè¯·æ±‚è¡Œï¼ŒåŒ…æ‹¬è¯·æ±‚æ–¹æ³•ã€URIå’Œåè®®</li>
<li><code>$status</code>: æœåŠ¡å™¨å“åº”çš„HTTPçŠ¶æ€ç </li>
<li><code>$body_bytes_sent</code>: å‘é€ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°ï¼Œä¸åŒ…æ‹¬å“åº”å¤´çš„å¤§å°</li>
<li><code>$http_referer</code>: å®¢æˆ·ç«¯å‘é€çš„HTTP Refererå¤´éƒ¨ä¿¡æ¯</li>
<li><code>$http_user_agent</code>: å®¢æˆ·ç«¯å‘é€çš„User-Agentå¤´éƒ¨ä¿¡æ¯</li>
</ul>
<p>è¿™äº›å­—æ®µçš„ç»„åˆå¯ä»¥æä¾›å…¨é¢çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯ï¼Œæœ‰åŠ©äºåˆ†æç”¨æˆ·è¡Œä¸ºå’ŒæœåŠ¡å™¨æ€§èƒ½ã€‚</p>
<p>å¦‚æœ nginx ä½äºè´Ÿè½½å‡è¡¡å™¨ï¼Œ squidï¼Œ nginx åå‘ä»£ç†ä¹‹åï¼Œ web æœåŠ¡å™¨æ— æ³•ç›´æ¥è·å–åˆ°å®¢æˆ·ç«¯çœŸå®çš„ IP åœ°å€äº†ã€‚
$remote_addr è·å–åå‘ä»£ç†çš„ IP åœ°å€ã€‚åå‘ä»£ç†æœåŠ¡å™¨åœ¨è½¬å‘è¯·æ±‚çš„ http å¤´ä¿¡æ¯ä¸­ï¼Œå¯ä»¥å¢åŠ  X-ForwardedFor ä¿¡æ¯ï¼Œç”¨æ¥è®°å½• å®¢æˆ·ç«¯ IP åœ°å€å’Œå®¢æˆ·ç«¯è¯·æ±‚çš„æœåŠ¡å™¨åœ°å€ã€‚ å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">log_format porxy <span class="s1">&#39;$http_x_forwarded_for - $remote_user [$time_local] &#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39; &#34;$request&#34; $status $body_bytes_sent &#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39; &#34;$http_referer&#34; &#34;$http_user_agent&#34; &#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-æ—¥å¿—æ ¼å¼è‡ªå®šä¹‰å®ä¾‹">2. æ—¥å¿—æ ¼å¼è‡ªå®šä¹‰å®ä¾‹</h3>
<p>é€šè¿‡Nginxçš„<code>access_log</code>æŒ‡ä»¤ï¼Œç®¡ç†å‘˜å¯ä»¥è½»æ¾è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼</p>
<p>å…·ä½“log_formatçš„è¯­æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">log_format name <span class="o">[</span><span class="nv">escape</span><span class="o">=</span>default<span class="p">|</span>json<span class="p">|</span>none<span class="o">]</span> string ...<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯ä¸€ä¸ªæ—¥å¿—æ ¼å¼éƒ½æœ‰ä¸€ä¸ªåç§°ï¼Œç„¶ååœ¨é…ç½®access_logçš„æ—¶å€™å¯ä»¥æŒ‡å®šç”¨å“ªç§æ ¼å¼æ¥è¿›è¡Œè®°å½•æ—¥å¿—ã€‚log_formatåªèƒ½å®šä¹‰åœ¨<em><strong>http</strong></em>å—ä¸­ã€‚æŸ¥çœ‹åœ¨Nginxé…ç½®æ–‡ä»¶ä¸­çš„å®šä¹‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">#å¯ä»¥å®šä¹‰å¤šä¸ªlog_formatï¼Œåç§°åªéœ€è¦ä¸ä¸€æ ·å³å¯</span>
</span></span><span class="line"><span class="cl">    log_format  main  <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;</span>
</span></span><span class="line"><span class="cl">                      <span class="s1">&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span>
</span></span><span class="line"><span class="cl">                      <span class="s1">&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">server <span class="o">{</span>
</span></span><span class="line"><span class="cl">    access_log              /var/log/nginx/access.log main<span class="p">;</span> <span class="c1"># æ³¨æ„è¿™é‡Œçš„é…ç½® </span>
</span></span><span class="line"><span class="cl">    error_log               /var/log/nginx/error.log<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚ä¸Šåœ¨httpå—ä¸­å®šä¹‰äº†ä¸€ä¸ªåç§°ä¸ºmainçš„æ—¥å¿—æ ¼å¼ï¼Œåœ¨serverå—ä¸­é€šè¿‡åç§°å¯¹è¯¥æ—¥å¿—æ ¼å¼è¿›è¡Œäº†å¼•ç”¨ï¼Œè¿™æ ·å­æ—¥å¿—çš„æ ¼å¼éƒ½ä¼šæŒ‰æ‰¾mainä¸­å®šä¹‰çš„ä¸€äº›å±æ€§æ¥è¿›è¡Œè®°å½•è®¿é—®ä¿¡æ¯ã€‚</p>
<p>é€šè¿‡ä¸Šè¾¹å¯¹æ—¥å¿—æ ¼å¼å’Œæ—¥å¿—æ–‡ä»¶çš„ä¸€äº›äº†è§£ï¼Œæˆ‘ä»¬å°±å¯ä»¥éå¸¸å®¹æ˜“çš„æŠŠæ—¥å¿—çš„æ ¼å¼è®¾ç½®æˆJSONäº†ï¼Œåªéœ€è¦å®šä¹‰ä¸€ä¸ªlog_formatï¼ŒæŠŠå®ƒçš„æ ¼å¼å®šä¹‰æˆä¸€ä¸ªjsonå­—ç¬¦ä¸²ï¼Œç„¶ååœ¨æ‰“å°æ—¥å¿—çš„æ—¶å€™å¼•ç”¨è¿™ä¸ªæ ¼å¼å°±å¯ä»¥å®ç°äº†ï¼Œä¸‹è¾¹æ˜¯ä¸€ä¸ªå®Œæˆçš„å®šä¹‰æ–‡ä»¶:ï¼ˆå¯æ ¹æ®è‡ªå·±çš„éœ€æ±‚å®šåˆ¶ï¼‰</p>
<p><strong>ç¬¬ä¸€ç§ ç¨‹åºå‹å¥½å‹jsonæ ¼å¼ï¼š</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">log_format json <span class="nv">escape</span><span class="o">=</span>json <span class="s1">&#39;{&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;time_iso8601&#34;: &#34;$time_iso8601&#34;, &#39;</span> <span class="c1"># local time in the ISO 8601 standard format</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;request_time&#34;: &#34;$request_time&#34;, &#39;</span> <span class="c1"># request processing time in seconds with msec resolution</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;status&#34;: &#34;$status&#34;, &#39;</span> <span class="c1"># response status code</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;body_bytes_sent&#34;: &#34;$body_bytes_sent&#34;, &#39;</span> <span class="c1"># the number of body bytes exclude headers sent to a client</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;bytes_sent&#34;: &#34;$bytes_sent&#34;, &#39;</span> <span class="c1"># the number of bytes sent to a client</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;remote_addr&#34;: &#34;$remote_addr&#34;, &#39;</span> <span class="c1"># client IP</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;remote_user&#34;: &#34;$remote_user&#34;, &#39;</span> <span class="c1"># client HTTP username</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;remote_port&#34;: &#34;$remote_port&#34;, &#39;</span> <span class="c1"># client port</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;request_uri&#34;: &#34;$request_uri&#34;, &#39;</span> <span class="c1"># full path and arguments if the request</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;args&#34;: &#34;$args&#34;, &#39;</span> <span class="c1"># args</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;request_id&#34;: &#34;$request_id&#34;, &#39;</span> <span class="c1"># the unique request id</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;connection&#34;: &#34;$connection&#34;, &#39;</span> <span class="c1"># connection serial number</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;connection_requests&#34;: &#34;$connection_requests&#34;, &#39;</span> <span class="c1"># number of requests made in connection</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;pid&#34;: &#34;$pid&#34;, &#39;</span> <span class="c1"># process pid</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;request_length&#34;: &#34;$request_length&#34;, &#39;</span> <span class="c1"># request length (including headers and body)</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;time_local&#34;: &#34;$time_local&#34;, &#39;</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;http_referer&#34;: &#34;$http_referer&#34;, &#39;</span> <span class="c1"># HTTP referer</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;http_user_agent&#34;: &#34;$http_user_agent&#34;, &#39;</span> <span class="c1"># user agent</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;http_x_forwarded_for&#34;: &#34;$http_x_forwarded_for&#34;, &#39;</span> <span class="c1"># http_x_forwarded_for</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;http_host&#34;: &#34;$http_host&#34;, &#39;</span> <span class="c1"># the request Host: header</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;server_name&#34;: &#34;$server_name&#34;, &#39;</span> <span class="c1"># the name of the vhost serving the request</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;ssl_protocol&#34;: &#34;$ssl_protocol&#34;, &#39;</span> <span class="c1"># TLS protocol</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;ssl_cipher&#34;: &#34;$ssl_cipher&#34;, &#39;</span> <span class="c1"># TLS cipher</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;scheme&#34;: &#34;$scheme&#34;, &#39;</span> <span class="c1"># http or https</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;request_method&#34;: &#34;$request_method&#34;, &#39;</span> <span class="c1"># request method</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;server_protocol&#34;: &#34;$server_protocol&#34;, &#39;</span> <span class="c1"># request protocol, like HTTP/1.1 or HTTP/2.0</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;pipe&#34;: &#34;$pipe&#34;, &#39;</span> <span class="c1"># &#34;p&#34; if request was pipelined, &#34;.&#34; otherwise</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;gzip_ratio&#34;: &#34;$gzip_ratio&#34;, &#39;</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;http_cf_ray&#34;: &#34;$http_cf_ray&#34;, &#39;</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;request_host&#34;: &#34;$host&#34;, &#39;</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;is_completion&#34;: &#34;$request_completion&#34;, &#39;</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;upstream&#34;: &#34;$upstream_addr&#34;, &#39;</span> <span class="c1"># upstream backend server for proxied requests</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;upstream_name&#34;: &#34;$proxy_host&#34;, &#39;</span> <span class="c1"># upstream name</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;upstream_status&#34;: &#34;$upstream_status&#34;, &#39;</span> <span class="c1"># upstream status</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;upstream_bytes_sent&#34;: &#34;$upstream_bytes_sent&#34;, &#39;</span> <span class="c1"># upstream bytes sent</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;upstream_bytes_received&#34;: &#34;$upstream_bytes_received&#34;, &#39;</span> <span class="c1"># upstream bytes received</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;upstream_connect_time&#34;: &#34;$upstream_connect_time&#34;, &#39;</span> <span class="c1"># upstream handshake time incl. TLS</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;upstream_header_time&#34;: &#34;$upstream_header_time&#34;, &#39;</span> <span class="c1"># time spent receiving upstream headers</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;upstream_response_time&#34;: &#34;$upstream_response_time&#34;, &#39;</span> <span class="c1"># time spend receiving upstream body</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;upstream_response_length&#34;: &#34;$upstream_response_length&#34;, &#39;</span> <span class="c1"># upstream response length</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;upstream_cache_status&#34;: &#34;$upstream_cache_status&#34;, &#39;</span> <span class="c1"># cache HIT/MISS where applicable</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#34;nginx_host&#34;: &#34;$hostname&#34;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;}&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>jsonæ ¼å¼å¯¹ç¨‹åºå‹å¥½ï¼Œé…åˆELKç­‰æ—¥å¿—é‡‡é›†ã€åˆ†æç³»ç»Ÿä½¿ç”¨å¾ˆæ–¹ä¾¿ï¼Œæ–¹ä¾¿å¯¹æ—¥å¿—è¿›è¡Œæ·±åº¦åˆ†æã€‚ä½†æ˜¯å¤šæ•°äººå¹³æ—¶æ¯”è¾ƒå–œæ¬¢ç›´æ¥æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼Œè¿™æ—¶jsonæ ¼å¼çš„æ—¥å¿—æ–‡ä»¶çœ‹èµ·æ¥å°±ä¸å¤Ÿæ¸…æ™°äº†ï¼Œæ—¥å¿—è¾ƒé•¿ï¼Œå†—ä½™ä¿¡æ¯è¾ƒå¤šï¼Œä½¿ç”¨shellå‘½ä»¤è¿›è¡Œç»Ÿè®¡å’Œåˆ†æä¹Ÿä¸æ–¹ä¾¿ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="nt">&#34;time_iso8601&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-04-10T16:55:26+08:00&#34;</span><span class="p">,</span> <span class="nt">&#34;request_time&#34;</span><span class="p">:</span> <span class="s2">&#34;0.009&#34;</span><span class="p">,</span> <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;200&#34;</span><span class="p">,</span> <span class="nt">&#34;body_bytes_sent&#34;</span><span class="p">:</span> <span class="s2">&#34;397&#34;</span><span class="p">,</span> <span class="nt">&#34;bytes_sent&#34;</span><span class="p">:</span> <span class="s2">&#34;916&#34;</span><span class="p">,</span> <span class="nt">&#34;remote_addr&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.96.19&#34;</span><span class="p">,</span> <span class="nt">&#34;remote_user&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nt">&#34;remote_port&#34;</span><span class="p">:</span> <span class="s2">&#34;8145&#34;</span><span class="p">,</span> <span class="nt">&#34;request_uri&#34;</span><span class="p">:</span> <span class="s2">&#34;/default_sso_heartbeat.html&#34;</span><span class="p">,</span> <span class="nt">&#34;args&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nt">&#34;request_id&#34;</span><span class="p">:</span> <span class="s2">&#34;c002e29f30c5e85a01dc1927991a9175&#34;</span><span class="p">,</span> <span class="nt">&#34;connection&#34;</span><span class="p">:</span> <span class="s2">&#34;759864&#34;</span><span class="p">,</span> <span class="nt">&#34;connection_requests&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="nt">&#34;pid&#34;</span><span class="p">:</span> <span class="s2">&#34;8459&#34;</span><span class="p">,</span> <span class="nt">&#34;request_length&#34;</span><span class="p">:</span> <span class="s2">&#34;1017&#34;</span><span class="p">,</span> <span class="nt">&#34;time_local&#34;</span><span class="p">:</span> <span class="s2">&#34;10/Apr/2024:16:55:26 +0800&#34;</span><span class="p">,</span> <span class="nt">&#34;http_referer&#34;</span><span class="p">:</span> <span class="s2">&#34;https://apollo.ownit.top/default_sso_heartbeat.html&#34;</span><span class="p">,</span> <span class="nt">&#34;http_user_agent&#34;</span><span class="p">:</span> <span class="s2">&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36&#34;</span><span class="p">,</span> <span class="nt">&#34;http_x_forwarded_for&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nt">&#34;http_host&#34;</span><span class="p">:</span> <span class="s2">&#34;apollo.ownit.top&#34;</span><span class="p">,</span> <span class="nt">&#34;server_name&#34;</span><span class="p">:</span> <span class="s2">&#34;apollo.ownit.top&#34;</span><span class="p">,</span> <span class="nt">&#34;ssl_protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1.2&#34;</span><span class="p">,</span> <span class="nt">&#34;ssl_cipher&#34;</span><span class="p">:</span> <span class="s2">&#34;ECDHE-RSA-AES256-GCM-SHA384&#34;</span><span class="p">,</span> <span class="nt">&#34;scheme&#34;</span><span class="p">:</span> <span class="s2">&#34;https&#34;</span><span class="p">,</span> <span class="nt">&#34;request_method&#34;</span><span class="p">:</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span> <span class="nt">&#34;server_protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;HTTP/1.1&#34;</span><span class="p">,</span> <span class="nt">&#34;pipe&#34;</span><span class="p">:</span> <span class="s2">&#34;.&#34;</span><span class="p">,</span> <span class="nt">&#34;gzip_ratio&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nt">&#34;http_cf_ray&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nt">&#34;request_host&#34;</span><span class="p">:</span> <span class="s2">&#34;apollo.ownit.top&#34;</span><span class="p">,</span> <span class="nt">&#34;is_completion&#34;</span><span class="p">:</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="nt">&#34;upstream&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.102.40:80&#34;</span><span class="p">,</span> <span class="nt">&#34;upstream_name&#34;</span><span class="p">:</span> <span class="s2">&#34;kubernetes-cluster&#34;</span><span class="p">,</span> <span class="nt">&#34;upstream_status&#34;</span><span class="p">:</span> <span class="s2">&#34;200&#34;</span><span class="p">,</span> <span class="nt">&#34;upstream_bytes_sent&#34;</span><span class="p">:</span> <span class="s2">&#34;1100&#34;</span><span class="p">,</span> <span class="nt">&#34;upstream_bytes_received&#34;</span><span class="p">:</span> <span class="s2">&#34;880&#34;</span><span class="p">,</span> <span class="nt">&#34;upstream_connect_time&#34;</span><span class="p">:</span> <span class="s2">&#34;0.000&#34;</span><span class="p">,</span> <span class="nt">&#34;upstream_header_time&#34;</span><span class="p">:</span> <span class="s2">&#34;0.009&#34;</span><span class="p">,</span> <span class="nt">&#34;upstream_response_time&#34;</span><span class="p">:</span> <span class="s2">&#34;0.009&#34;</span><span class="p">,</span> <span class="nt">&#34;upstream_response_length&#34;</span><span class="p">:</span> <span class="s2">&#34;397&#34;</span><span class="p">,</span> <span class="nt">&#34;upstream_cache_status&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nt">&#34;nginx_host&#34;</span><span class="p">:</span> <span class="s2">&#34;bt&#34;</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ç¬¬äºŒç§ è¿ç»´å‹å¥½å‹è‡ªå®šä¹‰æ ¼å¼ï¼š</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">log_format  main  <span class="nv">escape</span><span class="o">=</span>json
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;$remote_addr |$ipdb_raw |[$time_local] |$host |$request |$status |BodySent:$body_bytes_sent |ReqTime:$request_time |$request_completion |$http_x_forwarded_for |$proxy_host |$upstream_addr |$upstream_status |$upstream_cache_status |UpResTime:$upstream_response_time |UpConnTime:$upstream_connect_time |UpResLen:$upstream_response_length |$hostname-$request_id |$scheme |$request_body |$http_referer |$http_user_agent |$http_cookie&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ç§æ ¼å¼ä½¿ç”¨â€œ|â€ä½œä¸ºåˆ†éš”ç¬¦ï¼Œæ—¥å¿—æ‰“å°ä¹Ÿä¸æ˜¯å¾ˆé•¿ï¼Œæ–¹ä¾¿ä½¿ç”¨AWKç­‰å‘½ä»¤è¿›è¡Œç»Ÿè®¡</p>
<p>éœ€æ³¨æ„ä»¥ä¸‹å‡ ç‚¹:</p>
<ol>
<li>$ipdb_rawè¿™ä¸ªå˜é‡æ˜¯ipip.net ipåº“çš„nginxæ¨¡å—ï¼Œå¦‚æœæœªä½¿ç”¨è¿™ä¸ªæ¨¡å—ä¼šæŠ¥é”™ï¼Œå»æ‰æˆ–æ¢æˆGEOIPå³å¯ã€‚</li>
<li>escape=json è¡¨ç¤ºä»¥jsonæ ¼å¼è¾“å‡ºï¼Œé«˜ç‰ˆæœ¬çš„Nginxå·²ç»æ”¯æŒjsonæ ¼å¼ï¼Œå¯¹äºç¬¬äºŒç§è‡ªå®šä¹‰æ ¼å¼ï¼Œå¼€å¯è¿™ä¸ªå‚æ•°èƒ½åœ¨access logä¸­æ‰“å°ä¸­æ–‡ï¼Œä¸ä¼šä¹±ç </li>
<li><code>$</code>http_cookieæ˜¯æ‰“å°æ‰€æœ‰cookies,å½“ç„¶ä¹Ÿå¯ä»¥æ‰“å°session,å¯¹äºé«˜å®‰å…¨è¦æ±‚çš„æƒ…å†µï¼Œæ—¥å¿—ä¸­ä¸ä¼šå…è®¸æ³„æ¼ç”¨æˆ·cookiesã€‚ä½†æ˜¯æŸäº›æƒ…å†µéœ€è°ƒè¯•æˆ–æ‰“å°éæ•æ„Ÿçš„cookies,å¯ä»¥æ‰“å°æŒ‡å®šcookiesï¼Œå¦‚æ‰“å°nginx session stickyç”Ÿäº§çš„cookies,å‡è®¾åå­—å«backendï¼š &lsquo;TRACE:$cookie_backend&rsquo;ã€‚</li>
<li><code>$</code>hostname-$request_id å¦‚æœæœ‰åšå…¨å±€è°ƒç”¨é“¾åˆ†æçš„éœ€æ±‚ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥åšä¸ºå…¨å±€çš„UUIDï¼Œnginxå¯¹æ¯ä¸ªè¯·æ±‚éƒ½ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„UUIDï¼Œä¼ ç»™åç«¯å·¥ç¨‹æ‰“å°å‡ºæ¥å³å¯ã€‚</li>
</ol>
<h3 id="æ¨¡å—é›†æˆä¸æ‰©å±•">æ¨¡å—é›†æˆä¸æ‰©å±•</h3>
<p>é€šè¿‡é›†æˆç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¦‚<code>ngx_http_geoip_module</code>å’Œ<code>ngx_http_log_module</code>ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¸°å¯Œæ—¥å¿—ä¿¡æ¯ã€‚<code>ngx_http_geoip_module</code>å…è®¸åœ¨æ—¥å¿—ä¸­æ·»åŠ å®¢æˆ·ç«¯çš„åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚å›½å®¶ã€åŸå¸‚ç­‰ï¼Œè¿™å¯¹äºåˆ†æç”¨æˆ·çš„åœ°ç†åˆ†å¸ƒéå¸¸æœ‰ç”¨ã€‚<code>ngx_http_log_module</code>åˆ™æä¾›äº†çµæ´»çš„æ—¥å¿—é…ç½®é€‰é¡¹ï¼ŒåŒ…æ‹¬åŸºäºå˜é‡çš„æ—¥å¿—è®°å½•å’Œæ¡ä»¶æ—¥å¿—è®°å½•ï¼Œä½¿æ—¥å¿—è®°å½•æ›´åŠ ç²¾ç»†å’Œé«˜æ•ˆã€‚</p>
<p>è¯·å‚è€ƒï¼š</p>
<p><a class="link" href="https://blog.csdn.net/fishinhouse/article/details/88966258"  target="_blank" rel="noopener"
    >https://blog.csdn.net/fishinhouse/article/details/88966258</a>
<a class="link" href="https://blog.csdn.net/zzhongcy/article/details/86214969"  target="_blank" rel="noopener"
    >https://blog.csdn.net/zzhongcy/article/details/86214969</a></p>
<h3 id="æ—¥å¿—åˆ‡å‰²ä¸ç®¡ç†">æ—¥å¿—åˆ‡å‰²ä¸ç®¡ç†</h3>
<p>æ—¥å¿—æ–‡ä»¶çš„å®šæœŸæ»šåŠ¨åˆ†å‰²æ˜¯æ—¥å¿—ç®¡ç†ä¸­çš„ä¸€ä¸ªé‡è¦æ–¹é¢ã€‚è¿™å¯ä»¥é€šè¿‡è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚ä½¿ç”¨cronï¼‰æ¥å®ç°ï¼Œä»¥å®šæœŸæ‰§è¡Œæ—¥å¿—åˆ‡å‰²æ“ä½œï¼Œä¾‹å¦‚æ¯å¤©æˆ–æ¯å‘¨åˆ‡å‰²ä¸€æ¬¡æ—¥å¿—æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œè¿˜éœ€è¦è€ƒè™‘æ—¥å¿—çš„å½’æ¡£å’Œå®‰å…¨å­˜å‚¨ï¼Œç¡®ä¿æ—¥å¿—æ•°æ®åœ¨ä¿æŒå¯è®¿é—®æ€§çš„åŒæ—¶ï¼Œä¸ä¼šå› è¿‡æ—¶æˆ–å®‰å…¨é—®é¢˜è€Œé­åˆ°ç ´åã€‚ä½¿ç”¨å¦‚logrotateç­‰å·¥å…·å¯ä»¥å¸®åŠ©å®ç°è¿™äº›æ—¥å¿—ç®¡ç†ä»»åŠ¡ï¼Œä¿è¯æ—¥å¿—æ•°æ®çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚</p>
<p>é€šè¿‡æ·±å…¥æ¢ç´¢è¿™äº›ç­–ç•¥ï¼Œå¯ä»¥å®ç°å¯¹NginxæœåŠ¡å™¨æ—¥å¿—è®°å½•çš„ç²¾ç»†åŒ–é…ç½®ï¼Œä»è€Œä¸ºåº”ç”¨ç¨‹åºçš„ç›‘æ§å’Œåˆ†ææä¾›å¼ºå¤§çš„æ”¯æŒ</p>
<p>åœ¨Nginxçš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸å¯¹Nginxçš„æ—¥å¿—åšè‡ªå®šä¹‰çš„é…ç½®çš„è¯ï¼Œé‚£ä¹ˆé»˜è®¤çš„access.logæ—¥å¿—é»˜è®¤å°±åªæœ‰è¿™ä¹ˆä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œéšç€ç³»ç»Ÿä½¿ç”¨æ—¶é—´è¶Šæ¥è¶Šå°±ï¼Œæ—¥å¿—æ–‡ä»¶å°±ä¼šè¶Šæ¥è¶Šå¤§ï¼Œè€Œä¸”é»˜è®¤çš„æ—¥å¿—è®°å½•çš„æ ¼å¼ä¹Ÿä¸æ–¹ä¾¿åˆ†æã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨Nginxçš„è¿‡ç¨‹ä¸­éœ€è¦å¯¹å…¶æ—¥å¿—åšä¸€äº›é…ç½®ã€‚
åœ¨<code>http</code>é…ç½®å—ä¸­è¿›è¡Œé…ç½®ï¼Œä¹Ÿå¯ä»¥åœ¨æ¯ä¸ªserverå—ä¸­é…ç½®ä¸åŒçš„access_logç”¨ä»¥åŒºåˆ†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">http</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">#</span> <span class="err">å®šä¹‰ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨å¹´æœˆæ—¥</span>  
</span></span><span class="line"><span class="cl">    <span class="err">map</span> <span class="err">$time_iso8601</span> <span class="err">$date</span> <span class="err">{</span>  
</span></span><span class="line"><span class="cl">        <span class="err">default</span> <span class="nt">&#34;date-not-found&#34;</span><span class="err">;</span>  
</span></span><span class="line"><span class="cl">        <span class="err">&#39;~^(?&lt;ymd&gt;\d</span><span class="p">{</span><span class="err">4</span><span class="p">}</span><span class="err">-\d</span><span class="p">{</span><span class="err">2</span><span class="p">}</span><span class="err">-\d</span><span class="p">{</span><span class="err">2</span><span class="p">}</span><span class="err">)&#39;</span> <span class="err">$ymd;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="err">#</span> <span class="err">å®šä¹‰ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨æ—¶åˆ†ç§’</span>  
</span></span><span class="line"><span class="cl">    <span class="err">map</span> <span class="err">$time_iso</span><span class="mi">8601</span> <span class="err">$time</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="err">default</span> <span class="nt">&#34;time-not-found&#34;</span><span class="err">;</span>  
</span></span><span class="line"><span class="cl">        <span class="err">&#39;~T(?&lt;hms&gt;\d</span><span class="p">{</span><span class="err">2</span><span class="p">}:</span><span class="err">\d</span><span class="p">{</span><span class="err">2</span><span class="p">}:</span><span class="err">\d</span><span class="p">{</span><span class="err">2</span><span class="p">}</span><span class="err">)&#39;</span> <span class="err">$hms;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="err">#</span> <span class="err">å®šä¹‰æ—¥å¿—æ ¼å¼ä¸ºjsonæ ¼å¼</span>
</span></span><span class="line"><span class="cl">    <span class="err">log_format</span> <span class="err">json_format</span> <span class="err">&#39;</span><span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;$date $time&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;remote_addr&#34;</span><span class="p">:</span> <span class="s2">&#34;$remote_addr&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;remote_user&#34;</span><span class="p">:</span> <span class="s2">&#34;$remote_user&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;request&#34;</span><span class="p">:</span> <span class="s2">&#34;$request&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;$status&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body_bytes_sent&#34;</span><span class="p">:</span> <span class="s2">&#34;$body_bytes_sent&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;http_referer&#34;</span><span class="p">:</span> <span class="s2">&#34;$http_referer&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;http_user_agent&#34;</span><span class="p">:</span> <span class="s2">&#34;$http_user_agent&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;http_x_forwarded_for&#34;</span><span class="p">:</span> <span class="s2">&#34;$http_x_forwarded_for&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="err">&#39;;</span>
</span></span><span class="line"><span class="cl">    <span class="err">#</span> <span class="err">å®šä¹‰ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨å¹´æœˆ,å¯ç”¨æ¥ä½œä¸ºaccess.logçš„æ—¥å¿—æ–‡ä»¶åï¼ŒæŒ‰æœˆè‡ªåŠ¨åˆ†å‰²æ—¥å¿—</span>
</span></span><span class="line"><span class="cl">    <span class="err">map</span> <span class="err">$time_iso</span><span class="mi">8601</span> <span class="err">$logmonth</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="err">&#39;~^(?&lt;ym&gt;\d{4</span><span class="p">}</span><span class="err">-\d</span><span class="p">{</span><span class="err">2</span><span class="p">}</span><span class="err">)&#39;</span> <span class="err">$ym;</span>  
</span></span><span class="line"><span class="cl">    <span class="err">default</span> <span class="err">&#39;date-not-found&#39;;</span>  
</span></span><span class="line"><span class="cl">    <span class="err">}</span>
</span></span><span class="line"><span class="cl">    <span class="err">#</span> <span class="err">å®šä¹‰ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨å¹´æœˆæ—¥ï¼Œå¯ç”¨æ¥ä½œä¸ºaccess.logçš„æ—¥å¿—æ–‡ä»¶åï¼ŒæŒ‰å¤©è‡ªåŠ¨åˆ†å‰²æ—¥å¿—</span>
</span></span><span class="line"><span class="cl">    <span class="err">map</span> <span class="err">$time_iso</span><span class="mi">8601</span> <span class="err">$logdate</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="err">&#39;~^(?&lt;ymd&gt;\d{4</span><span class="p">}</span><span class="err">-\d</span><span class="p">{</span><span class="err">2</span><span class="p">}</span><span class="err">-\d</span><span class="p">{</span><span class="err">2</span><span class="p">}</span><span class="err">)&#39;</span> <span class="err">$ymd;</span>  
</span></span><span class="line"><span class="cl">    <span class="err">default</span> <span class="err">&#39;date-not-found&#39;;</span>  
</span></span><span class="line"><span class="cl">    <span class="err">}</span>
</span></span><span class="line"><span class="cl">    <span class="err">#</span> <span class="err">å¼€å¯access.logæ—¥å¿—ï¼Œå¯è®¾ç½®æ—¥å¿—åå˜é‡(è¿™é‡Œé€‰æ‹©ä¸Šé¢çš„æŒ‰å¤©)ä»¥ä¾¿åˆ†å‰²æ—¥å¿—ï¼›å¯è®¾ç½®æ—¥å¿—æ ¼å¼ï¼Œä»¥ä¾¿æ›´ç›´è§‚åˆ†ææ—¥å¿—</span>
</span></span><span class="line"><span class="cl">    <span class="err">access_log</span> <span class="err">logs/access-$logdate.log</span> <span class="err">json_format;</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nginxçš„æ—¥å¿—å¸¸è§é…ç½®é¡¹">Nginxçš„æ—¥å¿—å¸¸è§é…ç½®é¡¹</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">$args</span>                    <span class="c1">#è¯·æ±‚ä¸­çš„å‚æ•°å€¼</span>
</span></span><span class="line"><span class="cl"><span class="nv">$query_string</span>            <span class="c1">#åŒ $args</span>
</span></span><span class="line"><span class="cl"><span class="nv">$arg_NAME</span>                <span class="c1">#GETè¯·æ±‚ä¸­NAMEçš„å€¼</span>
</span></span><span class="line"><span class="cl"><span class="nv">$is_args</span>                 <span class="c1">#å¦‚æœè¯·æ±‚ä¸­æœ‰å‚æ•°ï¼Œå€¼ä¸º&#34;?&#34;ï¼Œå¦åˆ™ä¸ºç©ºå­—ç¬¦ä¸²</span>
</span></span><span class="line"><span class="cl"><span class="nv">$uri</span>                     <span class="c1">#è¯·æ±‚ä¸­çš„å½“å‰URI(ä¸å¸¦è¯·æ±‚å‚æ•°ï¼Œå‚æ•°ä½äº$args)ï¼Œå¯ä»¥ä¸åŒäºæµè§ˆå™¨ä¼ é€’çš„$request_uriçš„å€¼ï¼Œå®ƒå¯ä»¥é€šè¿‡å†…éƒ¨é‡å®šå‘ï¼Œæˆ–è€…ä½¿ç”¨indexæŒ‡ä»¤è¿›è¡Œä¿®æ”¹ï¼Œ$uriä¸åŒ…å«ä¸»æœºåï¼Œå¦‚&#34;/foo/bar.html&#34;ã€‚</span>
</span></span><span class="line"><span class="cl"><span class="nv">$document_uri</span>            <span class="c1">#åŒ $uri</span>
</span></span><span class="line"><span class="cl"><span class="nv">$document_root</span>           <span class="c1">#å½“å‰è¯·æ±‚çš„æ–‡æ¡£æ ¹ç›®å½•æˆ–åˆ«å</span>
</span></span><span class="line"><span class="cl"><span class="nv">$host</span>                    <span class="c1">#ä¼˜å…ˆçº§ï¼šHTTPè¯·æ±‚è¡Œçš„ä¸»æœºå&gt;&#34;HOST&#34;è¯·æ±‚å¤´å­—æ®µ&gt;ç¬¦åˆè¯·æ±‚çš„æœåŠ¡å™¨å.è¯·æ±‚ä¸­çš„ä¸»æœºå¤´å­—æ®µï¼Œå¦‚æœè¯·æ±‚ä¸­çš„ä¸»æœºå¤´ä¸å¯ç”¨ï¼Œåˆ™ä¸ºæœåŠ¡å™¨å¤„ç†è¯·æ±‚çš„æœåŠ¡å™¨åç§°</span>
</span></span><span class="line"><span class="cl"><span class="nv">$hostname</span>                <span class="c1">#ä¸»æœºå</span>
</span></span><span class="line"><span class="cl"><span class="nv">$https</span>                   <span class="c1">#å¦‚æœå¼€å¯äº†SSLå®‰å…¨æ¨¡å¼ï¼Œå€¼ä¸º&#34;on&#34;ï¼Œå¦åˆ™ä¸ºç©ºå­—ç¬¦ä¸²ã€‚</span>
</span></span><span class="line"><span class="cl"><span class="nv">$binary_remote_addr</span>      <span class="c1">#å®¢æˆ·ç«¯åœ°å€çš„äºŒè¿›åˆ¶å½¢å¼ï¼Œå›ºå®šé•¿åº¦ä¸º4ä¸ªå­—èŠ‚</span>
</span></span><span class="line"><span class="cl"><span class="nv">$body_bytes_sent</span>         <span class="c1">#ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°ï¼Œå“åº”å¤´ä¸è®¡ç®—åœ¨å†…ï¼›è¿™ä¸ªå˜é‡å’ŒApacheçš„mod_log_configæ¨¡å—ä¸­çš„&#34;%B&#34;å‚æ•°ä¿æŒå…¼å®¹</span>
</span></span><span class="line"><span class="cl"><span class="nv">$bytes_sent</span>              <span class="c1">#ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°</span>
</span></span><span class="line"><span class="cl"><span class="nv">$connection</span>              <span class="c1">#TCPè¿æ¥çš„åºåˆ—å·</span>
</span></span><span class="line"><span class="cl"><span class="nv">$connection_requests</span>     <span class="c1">#TCPè¿æ¥å½“å‰çš„è¯·æ±‚æ•°é‡</span>
</span></span><span class="line"><span class="cl"><span class="nv">$content_length</span>          <span class="c1">#&#34;Content-Length&#34; è¯·æ±‚å¤´å­—æ®µ</span>
</span></span><span class="line"><span class="cl"><span class="nv">$content_type</span>            <span class="c1">#&#34;Content-Type&#34; è¯·æ±‚å¤´å­—æ®µ</span>
</span></span><span class="line"><span class="cl"><span class="nv">$cookie_name</span>             <span class="c1">#cookieåç§°</span>
</span></span><span class="line"><span class="cl"><span class="nv">$limit_rate</span>              <span class="c1">#ç”¨äºè®¾ç½®å“åº”çš„é€Ÿåº¦é™åˆ¶</span>
</span></span><span class="line"><span class="cl"><span class="nv">$msec</span>                    <span class="c1">#å½“å‰çš„Unixæ—¶é—´æˆ³</span>
</span></span><span class="line"><span class="cl"><span class="nv">$nginx_version</span>           <span class="c1">#nginxç‰ˆæœ¬</span>
</span></span><span class="line"><span class="cl"><span class="nv">$pid</span>                     <span class="c1">#å·¥ä½œè¿›ç¨‹çš„PID</span>
</span></span><span class="line"><span class="cl"><span class="nv">$pipe</span>                    <span class="c1">#å¦‚æœè¯·æ±‚æ¥è‡ªç®¡é“é€šä¿¡ï¼Œå€¼ä¸º&#34;p&#34;ï¼Œå¦åˆ™ä¸º&#34;.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$proxy_protocol_addr</span>     <span class="c1">#è·å–ä»£ç†è®¿é—®æœåŠ¡å™¨çš„å®¢æˆ·ç«¯åœ°å€ï¼Œå¦‚æœæ˜¯ç›´æ¥è®¿é—®ï¼Œè¯¥å€¼ä¸ºç©ºå­—ç¬¦ä¸²</span>
</span></span><span class="line"><span class="cl"><span class="nv">$realpath_root</span>           <span class="c1">#å½“å‰è¯·æ±‚çš„æ–‡æ¡£æ ¹ç›®å½•æˆ–åˆ«åçš„çœŸå®è·¯å¾„ï¼Œä¼šå°†æ‰€æœ‰ç¬¦å·è¿æ¥è½¬æ¢ä¸ºçœŸå®è·¯å¾„</span>
</span></span><span class="line"><span class="cl"><span class="nv">$remote_addr</span>             <span class="c1">#å®¢æˆ·ç«¯åœ°å€</span>
</span></span><span class="line"><span class="cl"><span class="nv">$remote_port</span>             <span class="c1">#å®¢æˆ·ç«¯ç«¯å£</span>
</span></span><span class="line"><span class="cl"><span class="nv">$remote_user</span>             <span class="c1">#ç”¨äºHTTPåŸºç¡€è®¤è¯æœåŠ¡çš„ç”¨æˆ·å</span>
</span></span><span class="line"><span class="cl"><span class="nv">$request</span>                 <span class="c1">#ä»£è¡¨å®¢æˆ·ç«¯çš„è¯·æ±‚åœ°å€</span>
</span></span><span class="line"><span class="cl"><span class="nv">$request_body</span>            <span class="c1">#å®¢æˆ·ç«¯çš„è¯·æ±‚ä¸»ä½“ï¼šæ­¤å˜é‡å¯åœ¨locationä¸­ä½¿ç”¨ï¼Œå°†è¯·æ±‚ä¸»ä½“é€šè¿‡proxy_passï¼Œfastcgi_passï¼Œuwsgi_passå’Œscgi_passä¼ é€’ç»™ä¸‹ä¸€çº§çš„ä»£ç†æœåŠ¡å™¨</span>
</span></span><span class="line"><span class="cl"><span class="nv">$request_body_file</span>       <span class="c1">#å°†å®¢æˆ·ç«¯è¯·æ±‚ä¸»ä½“ä¿å­˜åœ¨ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚æ–‡ä»¶å¤„ç†ç»“æŸåï¼Œæ­¤æ–‡ä»¶éœ€åˆ é™¤ã€‚å¦‚æœéœ€è¦ä¹‹ä¸€å¼€å¯æ­¤åŠŸèƒ½ï¼Œéœ€è¦è®¾ç½®client_body_in_file_onlyã€‚å¦‚æœå°†æ¬¡æ–‡ä»¶ä¼  é€’ç»™åç«¯çš„ä»£ç†æœåŠ¡å™¨ï¼Œéœ€è¦ç¦ç”¨request bodyï¼Œå³è®¾ç½®proxy_pass_request_body offï¼Œfastcgi_pass_request_body offï¼Œuwsgi_pass_request_body offï¼Œor scgi_pass_request_body off</span>
</span></span><span class="line"><span class="cl"><span class="nv">$request_completion</span>      <span class="c1">#å¦‚æœè¯·æ±‚æˆåŠŸï¼Œå€¼ä¸º&#34;OK&#34;ï¼Œå¦‚æœè¯·æ±‚æœªå®Œæˆæˆ–è€…è¯·æ±‚ä¸æ˜¯ä¸€ä¸ªèŒƒå›´è¯·æ±‚çš„æœ€åä¸€éƒ¨åˆ†ï¼Œåˆ™ä¸ºç©º</span>
</span></span><span class="line"><span class="cl"><span class="nv">$request_filename</span>        <span class="c1">#å½“å‰è¿æ¥è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„ï¼Œç”±rootæˆ–aliasæŒ‡ä»¤ä¸URIè¯·æ±‚ç”Ÿæˆ</span>
</span></span><span class="line"><span class="cl"><span class="nv">$request_length</span>          <span class="c1">#è¯·æ±‚çš„é•¿åº¦ (åŒ…æ‹¬è¯·æ±‚çš„åœ°å€ï¼Œhttpè¯·æ±‚å¤´å’Œè¯·æ±‚ä¸»ä½“)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$request_method</span>          <span class="c1">#HTTPè¯·æ±‚æ–¹æ³•ï¼Œé€šå¸¸ä¸º&#34;GET&#34;æˆ–&#34;POST&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$request_time</span>            <span class="c1">#å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ä½¿ç”¨çš„æ—¶é—´,å•ä½ä¸ºç§’ï¼Œç²¾åº¦æ¯«ç§’ï¼› ä»è¯»å…¥å®¢æˆ·ç«¯çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹ï¼Œç›´åˆ°æŠŠæœ€åä¸€ä¸ªå­—ç¬¦å‘é€ç»™å®¢æˆ·ç«¯åè¿›è¡Œæ—¥å¿—å†™å…¥ä¸ºæ­¢ã€‚</span>
</span></span><span class="line"><span class="cl"><span class="nv">$request_uri</span>             <span class="c1">#è¿™ä¸ªå˜é‡ç­‰äºåŒ…å«ä¸€äº›å®¢æˆ·ç«¯è¯·æ±‚å‚æ•°çš„åŸå§‹URIï¼Œå®ƒæ— æ³•ä¿®æ”¹ï¼Œè¯·æŸ¥çœ‹$uriæ›´æ”¹æˆ–é‡å†™URIï¼Œä¸åŒ…å«ä¸»æœºåï¼Œä¾‹å¦‚ï¼š&#34;/cnphp/test.php?arg=freemouse&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$scheme</span>                  <span class="c1">#è¯·æ±‚ä½¿ç”¨çš„Webåè®®ï¼Œ&#34;http&#34; æˆ– &#34;https&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$server_addr</span>             <span class="c1">#æœåŠ¡å™¨ç«¯åœ°å€ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¸ºäº†é¿å…è®¿é—®linuxç³»ç»Ÿå†…æ ¸ï¼Œåº”å°†ipåœ°å€æå‰è®¾ç½®åœ¨é…ç½®æ–‡ä»¶ä¸­</span>
</span></span><span class="line"><span class="cl"><span class="nv">$server_name</span>             <span class="c1">#æœåŠ¡å™¨å</span>
</span></span><span class="line"><span class="cl"><span class="nv">$server_port</span>             <span class="c1">#æœåŠ¡å™¨ç«¯å£</span>
</span></span><span class="line"><span class="cl"><span class="nv">$server_protocol</span>         <span class="c1">#æœåŠ¡å™¨çš„HTTPç‰ˆæœ¬ï¼Œé€šå¸¸ä¸º &#34;HTTP/1.0&#34; æˆ– &#34;HTTP/1.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$status</span>                  <span class="c1">#HTTPå“åº”ä»£ç </span>
</span></span><span class="line"><span class="cl"><span class="nv">$time_iso8601</span>            <span class="c1">#æœåŠ¡å™¨æ—¶é—´çš„ISO 8610æ ¼å¼</span>
</span></span><span class="line"><span class="cl"><span class="nv">$time_local</span>              <span class="c1">#æœåŠ¡å™¨æ—¶é—´ï¼ˆLOG Format æ ¼å¼ï¼‰</span>
</span></span><span class="line"><span class="cl"><span class="nv">$cookie_NAME</span>             <span class="c1">#å®¢æˆ·ç«¯è¯·æ±‚Headerå¤´ä¸­çš„cookieå˜é‡ï¼Œå‰ç¼€&#34;$cookie_&#34;åŠ ä¸Šcookieåç§°çš„å˜é‡ï¼Œè¯¥å˜é‡çš„å€¼å³ä¸ºcookieåç§°çš„å€¼</span>
</span></span><span class="line"><span class="cl"><span class="nv">$http_NAME</span>               <span class="c1">#åŒ¹é…ä»»æ„è¯·æ±‚å¤´å­—æ®µï¼›å˜é‡åä¸­çš„ååŠéƒ¨åˆ†NAMEå¯ä»¥æ›¿æ¢æˆä»»æ„è¯·æ±‚å¤´å­—æ®µï¼Œå¦‚åœ¨é…ç½®æ–‡ä»¶ä¸­éœ€è¦è·å–httpè¯·æ±‚å¤´ï¼š&#34;Accept-Language&#34;ï¼Œ$http_accept_languageå³å¯</span>
</span></span><span class="line"><span class="cl"><span class="nv">$http_cookie</span>
</span></span><span class="line"><span class="cl"><span class="nv">$http_host</span>               <span class="c1">#è¯·æ±‚åœ°å€ï¼Œå³æµè§ˆå™¨ä¸­ä½ è¾“å…¥çš„åœ°å€ï¼ˆIPæˆ–åŸŸåï¼‰</span>
</span></span><span class="line"><span class="cl"><span class="nv">$http_referer</span>            <span class="c1">#urlè·³è½¬æ¥æº,ç”¨æ¥è®°å½•ä»é‚£ä¸ªé¡µé¢é“¾æ¥è®¿é—®è¿‡æ¥çš„</span>
</span></span><span class="line"><span class="cl"><span class="nv">$http_user_agent</span>         <span class="c1">#ç”¨æˆ·ç»ˆç«¯æµè§ˆå™¨ç­‰ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl"><span class="nv">$http_x_forwarded_for</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sent_http_NAME</span>          <span class="c1">#å¯ä»¥è®¾ç½®ä»»æ„httpå“åº”å¤´å­—æ®µï¼›å˜é‡åä¸­çš„ååŠéƒ¨åˆ†NAMEå¯ä»¥æ›¿æ¢æˆä»»æ„å“åº”å¤´å­—æ®µï¼Œå¦‚éœ€è¦è®¾ç½®å“åº”å¤´Content-lengthï¼Œ$sent_http_content_lengthå³å¯</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sent_http_cache_control</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sent_http_connection</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sent_http_content_type</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sent_http_keep_alive</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sent_http_last_modified</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sent_http_location</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sent_http_transfer_encoding</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="nginxä¹‹é—´çš„æ—¥å¿—è¿½è¸ª">Nginxä¹‹é—´çš„æ—¥å¿—è¿½è¸ª</h2>
<p>åœ¨å½“ä»Šäº’è”ç½‘æ¶æ„ä¸­ï¼ŒWebåº”ç”¨é˜²ç«å¢™ï¼ˆWAFï¼‰ä¸Nginxä½œä¸ºå‰ç«¯ä»£ç†çš„æ•´åˆè¶Šæ¥è¶Šå¸¸è§ï¼Œç‰¹åˆ«æ˜¯åœ¨æå‡Webåº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§æ–¹é¢ã€‚è¿™ç§ç»“æ„ä¸ä»…å¢å¼ºäº†å¯¹åº”ç”¨çš„ä¿æŠ¤ï¼Œè¿˜æå‡äº†ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚åœ¨è¿™ç§æ¶æ„ä¸­ï¼Œç†è§£WAFä¸Nginxå¦‚ä½•åä½œï¼Œä»¥åŠå¦‚ä½•å®ç°æ—¥å¿—è¿½è¸ªçš„æ•´åˆå°¤ä¸ºé‡è¦ã€‚</p>
<h3 id="wafä¸nginxåä½œåŸç†">WAFä¸Nginxåä½œåŸç†</h3>
<p>WAFé€šå¸¸ä½œä¸ºNginxçš„ä¸Šæ¸¸ç»„ä»¶éƒ¨ç½²ï¼Œæ‹¦æˆªå‘Webåº”ç”¨ç¨‹åºå‘èµ·çš„è¯·æ±‚ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯è¯„ä¼°æ¯ä¸ªè¯·æ±‚ä¸­çš„æ½œåœ¨å¨èƒï¼Œå¦‚SQLæ³¨å…¥ã€è·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰ç­‰ï¼Œç„¶åæ ¹æ®é¢„å®šä¹‰çš„è§„åˆ™é›†æ¥å†³å®šæ˜¯å¦å…è®¸è¯·æ±‚é€šè¿‡ã€‚é€šè¿‡ä¸Nginxçš„ç´§å¯†åä½œï¼ŒWAFèƒ½å¤Ÿåœ¨è¯·æ±‚åˆ°è¾¾åº”ç”¨æœåŠ¡å™¨ä¹‹å‰æä¾›ä¸€å±‚é¢å¤–çš„ä¿æŠ¤ã€‚</p>
<p>åœ¨è¯·æ±‚å’Œå“åº”è¿‡ç¨‹ä¸­ï¼ŒWAFä¸Nginxä¹‹é—´çš„äº¤äº’æ¶‰åŠåˆ°è¯·æ±‚çš„æ¥æ”¶ã€åˆ†æã€å¤„ç†å’Œè½¬å‘ã€‚å½“WAFæ£€æµ‹åˆ°æ½œåœ¨å¨èƒæ—¶ï¼Œå¯ä»¥å†³å®šç›´æ¥é˜»æ­¢è¯¥è¯·æ±‚ï¼Œæˆ–è€…å°†å…¶è½¬å‘ç»™Nginxè¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ã€‚</p>
<h3 id="æ—¥å¿—é›†æˆæŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ">æ—¥å¿—é›†æˆæŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ</h3>
<p>åœ¨å°†WAFä¸Nginxæ•´åˆè¿›ä¸€è‡´æ€§å’Œå¯è¿½æº¯æ€§çš„æ—¥å¿—ç³»ç»Ÿæ—¶ï¼Œé¢ä¸´çš„æŒ‘æˆ˜ä¸»è¦åŒ…æ‹¬è·¨ç»„ä»¶çš„æ—¥å¿—åŒæ­¥å’Œå…³è”ã€‚æ—¥å¿—è®°å½•éœ€è¦ä»WAFåˆ°Nginxï¼Œå†åˆ°åº”ç”¨æœåŠ¡å™¨ï¼Œå½¢æˆä¸€ä¸ªè¿ç»­çš„é“¾è·¯ï¼Œä»¥ç¡®ä¿å¯¹æ•´ä¸ªè¯·æ±‚-å“åº”å‘¨æœŸçš„å®Œå…¨å¯è§æ€§ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸€æŒ‘æˆ˜ï¼Œä¸€ç§æ–¹æ³•æ˜¯åœ¨æ‰€æœ‰ç»„ä»¶ä¸­ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—IDã€‚é€šè¿‡åœ¨HTTPå¤´éƒ¨æ’å…¥ä¸€ä¸ªå”¯ä¸€çš„è·Ÿè¸ªæ ‡è¯†ç¬¦ï¼Œä¾‹å¦‚é€šè¿‡X-Request-IDï¼Œå¯ä»¥è·¨å¤šä¸ªç³»ç»Ÿè·Ÿè¸ªå•ä¸ªè¯·æ±‚ï¼Œä»è€Œç®€åŒ–æ—¥å¿—æ•°æ®çš„å…³è”å’Œåˆ†æã€‚</p>
<h3 id="ç”¨æˆ·è®¿é—®æµç¨‹æ—¥å¿—åˆ†æ">ç”¨æˆ·è®¿é—®æµç¨‹æ—¥å¿—åˆ†æ</h3>
<p><strong>æ€»ç»“ï¼šé˜¿é‡Œäº‘çš„WAFæ—¥å¿—æ›´åŠ è¯¦ç»†ï¼ŒNginxå±‚é¢çš„æ—¥å¿—ä¹Ÿæ˜¯WAFè¿‡æ¥çš„ï¼ˆæ•°æ®ä¸€æ ·çš„ï¼‰</strong></p>
<p>ä¸‹æ–¹ä¸‰ä¸ªæˆªå›¾çš„æ•°æ®æ—¥å¿—ï¼Œå°±æ˜¯ä¸€æ¡çš„è¯·æ±‚çš„è®¿é—®ã€‚æ•°æ®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå„ä¸ªå±‚é¢éƒ½æœ‰æ—¥å¿—è®°å½•ã€‚æ¯«æ— ç–‘é—® WAFæ›´åŠ ä¸“ä¸š ï¼Œå›¾åƒåŒ–æ›´å¤šã€‚
<img src="/../../image/e115d63378e74e3b91cc53e45ad3c853.png"
	
	
	
	loading="lazy"
	
		alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
	
	
>
<strong>é˜¿é‡Œäº‘çš„WAF</strong>
<img src="/../../image/abb311b27c5743b1a0d6ac0b9c32e008.png"
	
	
	
	loading="lazy"
	
		alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
	
	
>
<strong>Nginxä¸­è½¬</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">server <span class="o">{</span>
</span></span><span class="line"><span class="cl">        listen       80<span class="p">;</span>
</span></span><span class="line"><span class="cl">        server_name  bd.xxx.com <span class="p">;</span>
</span></span><span class="line"><span class="cl">	rewrite ^/<span class="o">(</span>.*<span class="o">)</span>$ https://<span class="nv">$host</span>/<span class="nv">$1</span> permanent<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">server <span class="o">{</span>
</span></span><span class="line"><span class="cl">        listen       <span class="m">443</span> ssl<span class="p">;</span>
</span></span><span class="line"><span class="cl">        server_name  bd.xxx.com<span class="p">;</span>
</span></span><span class="line"><span class="cl">        ssl                   on<span class="p">;</span>
</span></span><span class="line"><span class="cl">        ssl_certificate      /usr/local/openresty/nginx/ssl/xx.com.crt<span class="p">;</span>
</span></span><span class="line"><span class="cl">        ssl_certificate_key  /usr/local/openresty/nginx/ssl/xxx.com.key<span class="p">;</span>
</span></span><span class="line"><span class="cl">        include ssl.conf<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        location / <span class="o">{</span>
</span></span><span class="line"><span class="cl">                proxy_pass  http://172.18.199.115:8085<span class="p">;</span>
</span></span><span class="line"><span class="cl">                include https_proxy.conf<span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/../../image/5cbeb3f63c7b4ed6acdce66d331aeec0.png"
	
	
	
	loading="lazy"
	
		alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
	
	
>
<strong>Nginxå‰ç«¯</strong>
å‰ç«¯æœºå™¨ï¼š172.18.199.115</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">server <span class="o">{</span>
</span></span><span class="line"><span class="cl">    listen       8085<span class="p">;</span>
</span></span><span class="line"><span class="cl">    server_name  bd.xxxx.com<span class="p">;</span>
</span></span><span class="line"><span class="cl">    root   /opt/mfbd/dist<span class="p">;</span>
</span></span><span class="line"><span class="cl">    index  index.html index.htm<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    location / <span class="o">{</span>
</span></span><span class="line"><span class="cl">        try_files <span class="nv">$uri</span> /index.html<span class="p">;</span>
</span></span><span class="line"><span class="cl">        add_header Access-Control-Allow-Origin *<span class="p">;</span>  
</span></span><span class="line"><span class="cl">        add_header Access-Control-Allow-Headers Content-Type<span class="p">;</span>  
</span></span><span class="line"><span class="cl">        add_header Access-Control-Allow-Methods GET,POST,OPTIONS<span class="p">;</span>  
</span></span><span class="line"><span class="cl">        add_header Access-Control-Allow-Credentials true<span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/../../image/fd707694cc3d4d7ba7ca9ff194ec5ada.png"
	
	
	
	loading="lazy"
	
		alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
	
	
>
<img src="/../../image/9ecb71a7233c4168b33b19da967be23e.png"
	
	
	
	loading="lazy"
	
		alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
	
	
></p>
<h3 id="æ—¥å¿—åˆ†æä¸å¯è§†åŒ–">æ—¥å¿—åˆ†æä¸å¯è§†åŒ–</h3>
<p>åˆ©ç”¨è‡ªå®šä¹‰æ—¥å¿—æ•°æ®è¿›è¡Œæ—¥å¿—åˆ†æä¸å¯è§†åŒ–æ˜¯æé«˜å®‰å…¨æ€§å’Œå“åº”èƒ½åŠ›çš„å…³é”®ã€‚é€šè¿‡é›†æˆSIEMå·¥å…·ã€ELKæ ˆï¼ˆElasticsearchã€Logstashã€Kibanaï¼‰æˆ–å…¶ä»–æ—¥å¿—åˆ†æå¹³å°ï¼Œå¯ä»¥å¯¹æ—¥å¿—æ•°æ®è¿›è¡Œå®æ—¶ç›‘æ§ã€å¼‚å¸¸æ£€æµ‹å’Œæ”»å‡»è¡Œä¸ºåˆ†æã€‚è¿™äº›å·¥å…·èƒ½å¤Ÿå¸®åŠ©å›¢é˜Ÿå¿«é€Ÿè¯†åˆ«å¹¶å“åº”å®‰å…¨å¨èƒï¼ŒåŒæ—¶æä¾›ç›´è§‚çš„æ•°æ®å¯è§†åŒ–ï¼Œä»¥ä¾¿æ·±å…¥ç†è§£å’Œæ”¹è¿›å®‰å…¨ç­–ç•¥ã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼ŒWAFä¸Nginxå‰ç«¯ä»£ç†çš„æ•´åˆä¸ä»…åŠ å¼ºäº†Webåº”ç”¨çš„å®‰å…¨å±‚ï¼Œè€Œä¸”é€šè¿‡æœ‰æ•ˆçš„æ—¥å¿—è¿½è¸ªå’Œåˆ†æï¼Œä¸ºå›¢é˜Ÿæä¾›äº†å…³é”®çš„æ´å¯Ÿï¼Œä»¥æŒç»­æ”¹è¿›å®‰å…¨å§¿æ€å’Œå“åº”èƒ½åŠ›ã€‚</p>
<p>å‚è€ƒæ–‡æ¡£ï¼š</p>
<p><a class="link" href="https://www.cnblogs.com/ouym/p/15393191.html"  target="_blank" rel="noopener"
    >https://www.cnblogs.com/ouym/p/15393191.html</a></p>
<p><a class="link" href="https://www.iminling.com/2023/10/04/272.html"  target="_blank" rel="noopener"
    >https://www.iminling.com/2023/10/04/272.html</a></p>
<p><a class="link" href="https://opswill.com/articles/nginx-custom-access-log-format.html"  target="_blank" rel="noopener"
    >https://opswill.com/articles/nginx-custom-access-log-format.html</a></p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/nginx/">Nginx</a>
        
            <a href="/tags/%E8%BF%90%E7%BB%B4/">è¿ç»´</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>æœªæ¥çš„ä½ ï¼Œä¼šæ„Ÿè°¢ä»Šå¤©ä»åœ¨åŠªåŠ›å¥‹æ–—çš„ä½ </span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/202407151647/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/18.jpg" loading="lazy" data-key="202407151647" data-hash="/../../title_pic/18.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ä½¿ç”¨Nginx OpenRestyä¸Rediså®ç°é«˜æ•ˆIPé»‘ç™½åå•ç®¡ç†</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202404021613/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/74.jpg" loading="lazy" data-key="202404021613" data-hash="/../../title_pic/74.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Nginxåœ¨Kubernetesé›†ç¾¤ä¸­çš„è¿›é˜¶åº”ç”¨</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202304101429/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/24.jpg" loading="lazy" data-key="202304101429" data-hash="/../../title_pic/24.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Nginxæ¨¡æ¿è‡ªåŠ¨åŒ–</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202405241437/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/45.jpg" loading="lazy" data-key="202405241437" data-hash="/../../title_pic/45.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">è‡ªåŠ¨åŒ–é‡ç½®æ•°æ®åº“åŠŸèƒ½çš„æ¢ç´¢ä¸å®è·µ</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202303151928/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/22.jpg" loading="lazy" data-key="202303151928" data-hash="/../../title_pic/22.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">SpringBootï¼ˆå¾®æœåŠ¡ï¼‰æ³¨å†Œåˆ†å¸ƒå¼Consul</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="nangongchengfeng/nangongchengfeng.github.io"
    data-repo-id="R_kgDOIwWL4Q"
    data-category="Announcements"
    data-category-id="DIC_kwDOIwWL4c4Cg8Rs"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('light');
            } else {
                setGiscusTheme('dark_dimmed');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2018 - 
        
        2024 å—å®«ä¹˜é£
    </section>
    
    <section class="powerby">
        
            <a href="https://beian.miit.gov.cn/" target="_blank">å¤‡æ¡ˆå·</a> <a href="https://beian.miit.gov.cn/" target="_blank">é™•ICPå¤‡2021004364å·-1</a> <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
