<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='公司目前在A区，要访问B的资源和网站，这个将如何访问？如果采用专线成本太高，经过运维调研和测试，采用Openvpn能极大有效完成这个需求，并且安全，成本底，可。。。。。。。'>
<title>高可用openvpn全局单向A访问B区的网络</title>

<link rel='canonical' href='https://www.ownit.top/p/202407290930/'>

<link rel="stylesheet" href="/scss/style.min.f8f67bed86aec9bc8e9eb410ba9583e51cb34eee82f3d10e0abbae72b51272ce.css"><meta property='og:title' content='高可用openvpn全局单向A访问B区的网络'>
<meta property='og:description' content='公司目前在A区，要访问B的资源和网站，这个将如何访问？如果采用专线成本太高，经过运维调研和测试，采用Openvpn能极大有效完成这个需求，并且安全，成本底，可。。。。。。。'>
<meta property='og:url' content='https://www.ownit.top/p/202407290930/'>
<meta property='og:site_name' content='南宫乘风'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='opevpn' /><meta property='article:published_time' content='2024-07-29T09:30:50&#43;00:00'/><meta property='article:modified_time' content='2024-07-29T09:30:50&#43;00:00'/><meta property='og:image' content='https://www.ownit.top/title_pic/76.jpg' />
<meta name="twitter:title" content="高可用openvpn全局单向A访问B区的网络">
<meta name="twitter:description" content="公司目前在A区，要访问B的资源和网站，这个将如何访问？如果采用专线成本太高，经过运维调研和测试，采用Openvpn能极大有效完成这个需求，并且安全，成本底，可。。。。。。。"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://www.ownit.top/title_pic/76.jpg' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu227367ba8544f2fc7811ed9508937bec_102665_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">南宫乘风</a></h1>
            <h2 class="site-description">当你的才华撑不起你的野心时，只有静下心学习才是唯一的出路</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://blog.csdn.net/heian_99'
                        target="_blank"
                        title="CSDN"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="32.000000pt" height="32.000000pt" viewBox="0 0 32.000000 32.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,32.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M0 160 l0 -160 160 0 160 0 0 160 0 160 -160 0 -160 0 0 -160z m225
108 c24 -11 34 -41 16 -52 -4 -3 -17 1 -27 9 -43 32 -95 3 -109 -62 -5 -27 -2
-37 19 -58 29 -29 62 -32 94 -9 25 17 42 11 42 -15 0 -27 -51 -45 -107 -38
-70 8 -97 42 -91 115 4 48 10 60 41 89 39 35 76 42 122 21z"/>
</g>
</svg>

                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/nangongchengfeng/'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='/index.xml'
                        target="_blank"
                        title="RSS"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 455.731 455.731" xml:space="preserve">
<g>
	<rect x="0" y="0" style="fill:#F78422;" width="455.731" height="455.731"/>
	<g>
		<path style="fill:#FFFFFF;" d="M296.208,159.16C234.445,97.397,152.266,63.382,64.81,63.382v64.348
			c70.268,0,136.288,27.321,185.898,76.931c49.609,49.61,76.931,115.63,76.931,185.898h64.348
			C391.986,303.103,357.971,220.923,296.208,159.16z"/>
		<path style="fill:#FFFFFF;" d="M64.143,172.273v64.348c84.881,0,153.938,69.056,153.938,153.939h64.348
			C282.429,270.196,184.507,172.273,64.143,172.273z"/>
		<circle style="fill:#FFFFFF;" cx="109.833" cy="346.26" r="46.088"/>
	</g>
</g>
</svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/link/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友链</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>暗色模式</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#openvpn介绍">openvpn介绍</a>
      <ol>
        <li><a href="#openvpn原理">openvpn原理</a></li>
        <li><a href="#openvpn应用场景">OpenVPN应用场景</a></li>
        <li><a href="#私有网段划分">私有网段划分</a></li>
      </ol>
    </li>
    <li><a href="#openvpn部署">Openvpn部署</a>
      <ol>
        <li><a href="#服务端">服务端</a>
          <ol>
            <li><a href="#生成所有证书密钥原理">生成所有证书&amp;密钥原理</a></li>
            <li><a href="#生成ca的证书密钥">生成CA的证书&amp;密钥</a></li>
            <li><a href="#生成服务端的证书密钥">生成服务端的证书&amp;密钥</a></li>
            <li><a href="#生成客户端的证书密钥">生成客户端的证书&amp;密钥</a></li>
            <li><a href="#生成diffie-hellman参数">生成Diffie Hellman参数</a></li>
            <li><a href="#生成tls-auth-key">生成tls-auth key</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#服务端和创建配置文件">服务端和创建配置文件</a>
      <ol>
        <li><a href="#证书目录优化">证书目录优化</a></li>
        <li><a href="#server服务器配置文件">Server服务器配置文件</a></li>
        <li><a href="#开启forward转发">开启forward转发</a></li>
        <li><a href="#配置iptables规则">配置iptables规则</a></li>
        <li><a href="#特殊客户端配置ccd">特殊客户端配置ccd</a></li>
        <li><a href="#服务端脚本配置">服务端脚本配置</a>
          <ol>
            <li><a href="#钉钉发送接口脚本">钉钉发送接口脚本</a></li>
            <li><a href="#线路检查-主备切换脚本">线路检查-主备切换脚本</a></li>
            <li><a href="#定时任务">定时任务</a></li>
            <li><a href="#openvpn管理脚本第一版">openvpn管理脚本（第一版）</a></li>
            <li><a href="#openvpn管理脚本第二版">openvpn管理脚本（第二版）</a></li>
            <li><a href="#开通账号自动发送邮件">开通账号自动发送邮件</a></li>
            <li><a href="#openvpn管理">openvpn管理</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#openvpn-client客户端">openvpn-client客户端</a>
      <ol>
        <li><a href="#openvpn-客户端配置---主节点">OpenVPN 客户端配置 - 主节点</a>
          <ol>
            <li><a href="#启动客户端">启动客户端</a></li>
          </ol>
        </li>
        <li><a href="#openvpn-客户端配置---备节点通过代理">OpenVPN 客户端配置 - 备节点（通过代理）</a>
          <ol>
            <li><a href="#启动客户端-1">启动客户端</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#交换机配置">交换机配置</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/202407290930/">
                
                    <img src="/../../title_pic/76.jpg" loading="lazy" alt="Featured image of post 高可用openvpn全局单向A访问B区的网络" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" >
                项目实战
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/202407290930/">高可用openvpn全局单向A访问B区的网络</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            公司目前在A区，要访问B的资源和网站，这个将如何访问？如果采用专线成本太高，经过运维调研和测试，采用Openvpn能极大有效完成这个需求，并且安全，成本底，可。。。。。。。
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jul 29, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 22 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="openvpn介绍">openvpn介绍</h2>
<p>OpenVPN是一个全特性的SSL VPN，支持弹性的客户端认证方法，基于证书、智能卡，和/或用户名及密码凭证等，并且通过应用于VPN虚拟接口的防火墙规则，可以使用特定用户或组的访问控制策略。</p>
<p>VPN 全称为虚拟私人网络(Virtual Private Network)，常用于连接中、大型企业或团体间私人网络的通讯方法，利用隧道协议（Tunneling Protocol）来达到发送端认证、消息保密与准确性等功能。</p>
<p>比如多地办公的公司，可以使用 VPN 将不同地区连接在同一内网下；或者在家办公的时候也可以通过 VPN 接入公司内网中。</p>
<p>VPN 以 CS 架构运行，工作流程如下：</p>
<p><img src="/../../image/t01e5f45317f16d05bb.png"
	
	
	
	loading="lazy"
	
		alt="img"
	
	
></p>
<p>VPN工作流程</p>
<p>在外网的用户可以使用 <code>vpn client</code> 连接组织搭建的 <code>vpn server</code> 以建立通信隧道，随后便建立了虚拟的私人网络，处于外网的 <code>worker</code> 和内网中的 <code>server</code> 可以相互通信。</p>
<p>那么我们可以简单理解 VPN，由 <code>VPN client</code> 捕获用户发出的报文，封装报文后通过物理网络通信链路将报文发给 <code>VPN server</code>，<code>VPN server</code> 接收到报文后进行解包，再将其转发给实际的目标，反之同理； VPN 在逻辑层面构建了虚拟网络。</p>
<h3 id="openvpn原理">openvpn原理</h3>
<p>OpenVpn的技术核心是虚拟网卡，其次是SSL协议实现，由于SSL协议在其它的词条中介绍的比较清楚了，这里重点对虚拟网卡及其在OpenVpn的中的工作机理进行介绍：</p>
<p>虚拟网卡是使用网络底层编程技术实现的一个驱动软件，安装后在主机上多出现一个网卡，可以像其它网卡一样进行配置。服务程序可以在应用层打开虚拟网卡，如果应用软件（如IE）向虚拟网卡发送数据，则服务程序可以读取到该数据，如果服务程序写合适的数据到虚拟网卡，应用软件也可以接收得到。虚拟网卡在很多的操作系统下都有相应的实现，这也是OpenVpn能够跨平台一个很重要的理由。</p>
<p>在OpenVpn中，如果用户访问一个远程的虚拟地址（属于虚拟网卡配用的地址系列，区别于真实地址），则操作系统会通过路由机制将数据包（TUN模式）或数据帧（TAP模式）发送到虚拟网卡上，服务程序接收该数据并进行相应的处理后，通过SOCKET从外网上发送出去，远程服务程序通过SOCKET从外网上接收数据，并进行相应的处理后，发送给虚拟网卡，则应用软件可以接收到，完成了一个单向传输的过程，反之亦然。</p>
<h3 id="openvpn应用场景">OpenVPN应用场景</h3>
<p>Peer-to-Peer VPN(点对点连接)，将Internet两台机器（公网地址）使用VPN连接起来，比如上海服务器和北京服务器之间的数据需要相互调用，但是数据又比较敏感，直接通过http公共网络传输，容易被窃取，如果拉一条专线成本又太高。那么我们可以通过VPN使用现有网络，将两台主机逻辑上捆绑在一个虚拟网络中，这样既保证了数据传输安全，同时又节省了成本。</p>
<p>1.用户通过Internet连接vpn服务通过加密技术进行数据传输；</p>
<p>2.加密实现方式是客户端公钥加密，服务端私钥解密；</p>
<p>3.客户端连接vpn后，vpn会给客户端推送一条内网路由以此实现内部主机通信</p>
<h3 id="私有网段划分">私有网段划分</h3>
<p>搭建VPN通常是为了将位于不同地理位置的私有网段连接起来。要注意，VPN所连接的两端的私网网段不能冲突。</p>
<p>IANA (The Internet Assigned Numbers Authority)定义了下面三个IP地址块用于私有网络：</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>10.0.0.0</th>
<th>10.255.255.255</th>
<th>(10/8前缀)</th>
</tr>
</thead>
<tbody>
<tr>
<td>172.16.0.0</td>
<td>172.31.255.255</td>
<td>(172.16/12前缀)</td>
</tr>
<tr>
<td>192.168.0.0</td>
<td>192.168.255.255</td>
<td>(192.168/16前缀)</td>
</tr>
</tbody>
</table></div>
<h2 id="openvpn部署">Openvpn部署</h2>
<p>环境介绍</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>主机</th>
<th>ip</th>
<th>网段</th>
</tr>
</thead>
<tbody>
<tr>
<td>openvpn-server(vpn-192.168.83.44 )</td>
<td>192.168.83.10（物理ip）/192.168.255.1(虚拟ip)</td>
<td>192.168.0.0/16</td>
</tr>
<tr>
<td>openvpn-client01&ndash;（主节点）</td>
<td>10.134.18.10（物理ip）/192.168.255.10(虚拟ip)</td>
<td>10.0.0.0/8</td>
</tr>
<tr>
<td>openvpn-client02&ndash;（备节点）</td>
<td>10.128.19.10（物理ip）/192.168.255.6</td>
<td>10.0.0.0/8</td>
</tr>
<tr>
<td>server虚拟ip</td>
<td>192.168.255.1/24</td>
<td>192.168.255.0/16</td>
</tr>
</tbody>
</table></div>
<p>安装系统：CentOS Linux release 7.5.1804 (Core)</p>
<p>启用EPEL的yum源，安装OpenVPN：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@gw ~<span class="o">]</span><span class="c1"># yum install epel-release</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@gw ~<span class="o">]</span><span class="c1"># yum install openvpn </span>
</span></span><span class="line"><span class="cl">OpenVPN程序应该在客户端和服务端机器都安装，它是同一个程序包提供客户端或服务端的功能，取决于你的配置
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="服务端">服务端</h3>
<p><img src="/../../image/image-20220627093050143.png"
	
	
	
	loading="lazy"
	
		alt="img"
	
	
></p>
<h4 id="生成所有证书密钥原理">生成所有证书&amp;密钥原理</h4>
<p>搭建OpenVPN，需要设置你自己的CA(Certificate Authority)并且为OpenVPN服务器和多个客户端分别生成证书和密钥。</p>
<p>构建一个OpenVPN 2.x配置的第一个步骤是建立一个PKI(public key infrastructure)。该PKI包含：</p>
<ul>
<li>
<p>服务器和每一个客户端都要有一个单独的证书(也叫做公钥)和私钥。</p>
</li>
<li>
<p>一个master CA (Certificate Authority)证书和密钥，用于为每一个服务器和客户端证书签名。</p>
</li>
</ul>
<p>OpenVPN支持基于证书的双向认证，这意味着，在建立相互信任之前，客户端必须认证服务器证书，服务端也必须认证客户端证书。服务器和客户端在认证彼此时，会首先验证对方呈现的证书是否由master CA签名，然后测试证书报头中的信息，比如证书common name或证书类型(客户端或服务器)。</p>
<p>注意：服务器和客户端时钟需要基本同步，否则证书可能不会正常工作。</p>
<h4 id="生成ca的证书密钥">生成CA的证书&amp;密钥</h4>
<p>生成一个master CA证书和密钥，一个服务器证书和密钥，和为3个不同的客户端生成证书和密钥。</p>
<p>对于PKI管理，我们会使用easy-rsa 2，这是与OpenVPN 2.2.x和之前的版本绑定的一个脚本集合。如果你使用的是OpenVPN 2.3.x，你需要单独从<a class="link" href="https://github.com/OpenVPN/easy-rsa-old"  target="_blank" rel="noopener"
    >easy-rsa-old</a>项目页面下载easy-rsa 2。而在*NIX平台上，你应该使用<a class="link" href="https://github.com/OpenVPN/easy-rsa"  target="_blank" rel="noopener"
    >easy-rsa 3</a>，参考它的文档以了解详细信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@gw ~<span class="o">]</span><span class="c1"># yum install easy-rsa</span>
</span></span><span class="line"><span class="cl">将整个easy-rsa的目录拷贝到另一个目录下，比如/etc/openvpn，这样未来升级OpenVPN包时不会覆盖你的修改。
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@gw ~<span class="o">]</span><span class="c1"># cp -ar /usr/share/easy-rsa /etc/openvpn</span>
</span></span><span class="line"><span class="cl">生成变量配置文件：
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@gw ~<span class="o">]</span><span class="c1"># cp /usr/share/doc/easy-rsa-3.0.3/vars.example /etc/openvpn/easy-rsa/3.0.3/vars</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">可以在vars中设置证书有效期
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@gw ~<span class="o">]</span><span class="c1"># vim vars</span>
</span></span><span class="line"><span class="cl"><span class="c1">#配置一下相关的信息</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KEY_COUNTRY</span><span class="o">=</span><span class="s2">&#34;CN&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KEY_PROVINCE</span><span class="o">=</span><span class="s2">&#34;ShangHai&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KEY_CITY</span><span class="o">=</span><span class="s2">&#34;ShangHai&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KEY_ORG</span><span class="o">=</span><span class="s2">&#34;YCZB&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KEY_EMAIL</span><span class="o">=</span><span class="s2">&#34;heian@heian.com&#34;</span>
</span></span><span class="line"><span class="cl">set_var EASYRSA_CA_EXPIRE       <span class="m">3650</span>                                      // CA证书的默认有效期
</span></span><span class="line"><span class="cl">set_var EASYRSA_CERT_EXPIRE     <span class="m">3650</span>                                      // CA签发的证书的默认有效期
</span></span><span class="line"><span class="cl">set_var EASYRSA_CRL_DAYS        <span class="m">3650</span>       // 貌似如果CRL文件在该时间内都未修改过的话，所有客户端都将无法连接
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">进入easy-rsa的目录，初始化环境：
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /etc/openvpn/easy-rsa/3.0.3/
</span></span><span class="line"><span class="cl"><span class="nb">source</span> ./vars
</span></span><span class="line"><span class="cl"> ./easyrsa init-pki   <span class="c1">#初始化一个新的PKI，其实就是移除并重新创建pki目录结构</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">创建CA证书和密钥对：
</span></span><span class="line"><span class="cl"> ./easyrsa build-ca nopass
</span></span><span class="line"><span class="cl"> <span class="c1"># build-ca命令创建CA证书和密钥对。nopass选项表示不对CA密钥进行加密。nopass 配置无密码。</span>
</span></span><span class="line"><span class="cl"> <span class="c1">#生产环境建议设置密码。在生成证书、密钥的时候，会要求输入该CA密钥的密码。</span>
</span></span><span class="line"><span class="cl"> 现在，已经生成了CA的证书文件pki/ca.crt和私钥文件pki/private/ca.key。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Generating a <span class="m">2048</span> bit RSA private key
</span></span><span class="line"><span class="cl">.................................+++
</span></span><span class="line"><span class="cl">...............+++
</span></span><span class="line"><span class="cl">writing new private key to <span class="s1">&#39;/etc/openvpn/easy-rsa/3.0.3/pki/private/ca.key.lhgETNINjO&#39;</span>
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">You are about to be asked to enter information that will be incorporated
</span></span><span class="line"><span class="cl">into your certificate request.
</span></span><span class="line"><span class="cl">What you are about to enter is what is called a Distinguished Name or a DN.
</span></span><span class="line"><span class="cl">There are quite a few fields but you can leave some blank
</span></span><span class="line"><span class="cl">For some fields there will be a default value,
</span></span><span class="line"><span class="cl">If you enter <span class="s1">&#39;.&#39;</span>, the field will be left blank.
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">Common Name <span class="o">(</span>eg: your user, host, or server name<span class="o">)</span> <span class="o">[</span>Easy-RSA CA<span class="o">]</span>:Guowei_CA       <span class="c1">#输入用于辨识的一个名称 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">CA creation <span class="nb">complete</span> and you may now import and sign cert requests.
</span></span><span class="line"><span class="cl">Your new CA certificate file <span class="k">for</span> publishing is at:
</span></span><span class="line"><span class="cl">/etc/openvpn/easy-rsa/3.0.3/pki/ca.crt
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，已经生成了CA的证书文件pki/ca.crt和私钥文件pki/private/ca.key。</p>
<h4 id="生成服务端的证书密钥">生成服务端的证书&amp;密钥</h4>
<p>生成OpenVPN服务端的证书和密钥对：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./easyrsa build-server-full server nopass
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># build-server-full命令生成服务端的证书和密钥对。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># server参数是生成证书时用的Common Name，建议就使用server。nopass选项表示不对密钥进行加密。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Generating a <span class="m">2048</span> bit RSA private key
</span></span><span class="line"><span class="cl">..+++
</span></span><span class="line"><span class="cl">................+++
</span></span><span class="line"><span class="cl">writing new private key to <span class="s1">&#39;/etc/openvpn/easy-rsa/3.0.3/pki/private/server.key.gYkfUBDAFl&#39;</span>
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">Using configuration from ./openssl-1.0.cnf
</span></span><span class="line"><span class="cl">Check that the request matches the signature
</span></span><span class="line"><span class="cl">Signature ok
</span></span><span class="line"><span class="cl">The Subject<span class="s1">&#39;s Distinguished Name is as follows
</span></span></span><span class="line"><span class="cl"><span class="s1">commonName            :ASN.1 12:&#39;</span>server<span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">Certificate is to be certified <span class="k">until</span> Aug <span class="m">12</span> 01:22:27 <span class="m">2028</span> GMT <span class="o">(</span><span class="m">3650</span> days<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Write out database with <span class="m">1</span> new entries
</span></span><span class="line"><span class="cl">Data Base Updated
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，已经生成了服务端的证书文件pki/issued/server.crt和私钥文件pki/private/server.key。并且，生成的服务端证书已经是经过先前的CA密钥签名的了。</p>
<h4 id="生成客户端的证书密钥">生成客户端的证书&amp;密钥</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./easyrsa build-client-full clientname nopass
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># build-client-full命令生成客户端的证书和密钥对。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># client1参数是生成证书时用的Common Name。nopass选项表示不对密钥进行加密。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Generating a <span class="m">2048</span> bit RSA private key
</span></span><span class="line"><span class="cl">......................................+++
</span></span><span class="line"><span class="cl">............................................................................+++
</span></span><span class="line"><span class="cl">writing new private key to <span class="s1">&#39;/etc/openvpn/easy-rsa/3.0.3/pki/private/client1.key.wQ7i2qbP93&#39;</span>
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">Using configuration from ./openssl-1.0.cnf
</span></span><span class="line"><span class="cl">Check that the request matches the signature
</span></span><span class="line"><span class="cl">Signature ok
</span></span><span class="line"><span class="cl">The Subject<span class="s1">&#39;s Distinguished Name is as follows
</span></span></span><span class="line"><span class="cl"><span class="s1">commonName            :ASN.1 12:&#39;</span>client1<span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">Certificate is to be certified <span class="k">until</span> Aug <span class="m">12</span> 02:08:02 <span class="m">2028</span> GMT <span class="o">(</span><span class="m">3650</span> days<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Write out database with <span class="m">1</span> new entries
</span></span><span class="line"><span class="cl">Data Base Updated
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，已经生成了服务端的证书文件pki/issued/client1.crt和私钥文件pki/private/client1.key。并且，生成的客户端证书已经是经过先前的CA密钥签名的了。</p>
<p>类似的，我们还可以为client2、client3等分别生成证书和密钥对。总是为每一个客户端使用一个唯一的Common Name。</p>
<h4 id="生成diffie-hellman参数">生成Diffie Hellman参数</h4>
<p>我们需要为OpenVPN服务端生成<a class="link" href="http://www.rsasecurity.com/rsalabs/node.asp?id=2248"  target="_blank" rel="noopener"
    >Diffie Hellman</a>参数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./easyrsa gen-dh     
</span></span><span class="line"><span class="cl">Generating DH parameters, <span class="m">2048</span> bit long safe prime, generator <span class="m">2</span>
</span></span><span class="line"><span class="cl">This is going to take a long <span class="nb">time</span>
</span></span><span class="line"><span class="cl">......................................................................+.......+...........................+......................................+................................................+....+..............................................................................................................................................................................
</span></span><span class="line"><span class="cl">DH parameters of size <span class="m">2048</span> created at /etc/openvpn/easy-rsa/3.0.3/pki/dh.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，已经生成了Diffie Hellman参数文件pki/dh.pem。</p>
<h4 id="生成tls-auth-key">生成tls-auth key</h4>
<p>生成tls-auth key，为了防止DDOS和TLS攻击，这个属于可选安全配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openvpn --genkey --secret ta.key
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="服务端和创建配置文件">服务端和创建配置文件</h2>
<p>OpenVPN软件包自带了一些示例配置文件，因为我们是使用rpm包安装的，可以在/usr/share/doc/openvpn-2.4.6/sample/sample-config-files/目录下找到：</p>
<p><img src="/../../image/image-20220701153303964.png"
	
	
	
	loading="lazy"
	
		alt="image-20220701153303964"
	
	
></p>
<p>服务器和客户端的示例配置文件分别是server.conf和client.conf</p>
<h3 id="证书目录优化">证书目录优化</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># mkdir /etc/openvpn/server/certs &amp;&amp; cd /etc/openvpn/server/certs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cp /etc/openvpn/easy-rsa/pki/dh.pem ./</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cp /etc/openvpn/easy-rsa/pki/ca.crt ./</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cp /etc/openvpn/easy-rsa/pki/issued/server.crt ./</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cp /etc/openvpn/easy-rsa/pki/private/server.key ./</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cp /etc/openvpn/easy-rsa/ta.key ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="server服务器配置文件">Server服务器配置文件</h3>
<p>OpenVPN软件包自带的服务器示例配置文件很适合用来生成真正使用的服务器配置文件。它会创建一个VPN，使用一个虚拟的TUN网络接口(用于路由)，会在UDP端口1194(OpenVPN的官方端口号)监听客户端连接，并分发10.8.0.0/24子网中的虚拟地址给连接进来的客户端。</p>
<p>在你使用该配置文件之前，你应该修改该配置文件中的ca、cert、key和dh选项，让它们指向各自的文件(我们先前生成的)。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#启动的端口</span>
</span></span><span class="line"><span class="cl">port <span class="m">1194</span>
</span></span><span class="line"><span class="cl"><span class="c1">#使用的tcp协议</span>
</span></span><span class="line"><span class="cl">proto tcp
</span></span><span class="line"><span class="cl"><span class="c1">## &#34;dev tun&#34;将会创建一个路由IP隧道</span>
</span></span><span class="line"><span class="cl">dev tun
</span></span><span class="line"><span class="cl"><span class="c1"># 生成的ca证书</span>
</span></span><span class="line"><span class="cl">ca /etc/openvpn/server/certs/ca.crt
</span></span><span class="line"><span class="cl"><span class="c1">#服务端的证书</span>
</span></span><span class="line"><span class="cl">cert /etc/openvpn/server/certs/server.crt
</span></span><span class="line"><span class="cl"><span class="c1">#服务端的密钥</span>
</span></span><span class="line"><span class="cl">key /etc/openvpn/server/certs/server.key
</span></span><span class="line"><span class="cl"><span class="c1">#Diffie-Hellman密钥交换 文件</span>
</span></span><span class="line"><span class="cl">dh /etc/openvpn/server/certs/dh.pem
</span></span><span class="line"><span class="cl"><span class="c1">#openvpn server的虚拟ip网段</span>
</span></span><span class="line"><span class="cl">server 192.168.255.0 255.255.255.0
</span></span><span class="line"><span class="cl"><span class="c1">#route控制了从内核到OpenVPN服务器(通过TUN接口)的路由</span>
</span></span><span class="line"><span class="cl"><span class="c1">### 具体下一跳是哪里，由 client-config 里的 iroute 指定</span>
</span></span><span class="line"><span class="cl">route 10.0.0.0 255.0.0.0
</span></span><span class="line"><span class="cl"><span class="c1"># 在此文件中维护客户端与虚拟IP地址之间的关联记录</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果OpenVPN重启，重新连接的客户端可以被分配到先前分配的虚拟IP地址</span>
</span></span><span class="line"><span class="cl">ifconfig-pool-persist /etc/openvpn/server/ipp.txt
</span></span><span class="line"><span class="cl"><span class="c1">#下面是定义服务器读取特殊客户端配置文件的目录为ccd；</span>
</span></span><span class="line"><span class="cl">client-config-dir /etc/openvpn/ccd
</span></span><span class="line"><span class="cl"><span class="c1">#允许客户端子网互通</span>
</span></span><span class="line"><span class="cl">client-to-client
</span></span><span class="line"><span class="cl"><span class="c1"># keepalive指令将导致类似于ping命令的消息被来回发送，以便于服务器端和客户端知道对方何时被关闭</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 每10秒钟ping一次，如果120秒内都没有收到对方的回复，则表示远程连接已经关闭</span>
</span></span><span class="line"><span class="cl">keepalive <span class="m">10</span> <span class="m">120</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 服务器和每个客户端都需要拥有该密钥的一个拷贝</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 第二个参数在服务器端应该为&#39;0&#39;，在客户端应该为&#39;1&#39;</span>
</span></span><span class="line"><span class="cl">tls-auth /etc/openvpn/server/certs/ta.key <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 选择一个密码加密算法，该配置项也必须复制到每个客户端配置文件中</span>
</span></span><span class="line"><span class="cl">cipher AES-256-CBC
</span></span><span class="line"><span class="cl"><span class="c1"># 持久化选项可以尽量避免访问那些在重启之后由于用户权限降低而无法访问的某些资源</span>
</span></span><span class="line"><span class="cl">persist-key
</span></span><span class="line"><span class="cl">persist-tun
</span></span><span class="line"><span class="cl"><span class="c1">#日志文件</span>
</span></span><span class="line"><span class="cl">status /var/log/openvpn-status.log
</span></span><span class="line"><span class="cl"><span class="c1"># 为日志文件设置适当的冗余级别(0~9)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 冗余级别越高，输出的信息越详细</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0 表示静默运行，只记录致命错误</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4 表示合理的常规用法</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 5和6 可以帮助调试连接错误</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 9 表示极度冗余，输出非常详细的日志信息</span>
</span></span><span class="line"><span class="cl">verb <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 通知客户端，当服务器重新启动时，可以自动重新连接</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 只能是UDP协议使用，TCP使用的话不能启动服务</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 测试需要push到客户端才有效果</span>
</span></span><span class="line"><span class="cl"><span class="c1">#explicit-exit-notify 1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">explicit-exit-notify <span class="m">1</span>
</span></span><span class="line"><span class="cl">script-security <span class="m">2</span>
</span></span><span class="line"><span class="cl">client-connect /etc/openvpn/script/connect.sh
</span></span><span class="line"><span class="cl">client-disconnect /etc/openvpn/script/disconnect.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>connect.sh</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nv">Time</span><span class="o">=</span><span class="sb">`</span>date +%F<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -f /etc/openvpn/log/openvpn_<span class="nv">$Time</span>.log <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">  touch /etc/openvpn/log/openvpn_<span class="nv">$Time</span>.log
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;`date &#39;+%F %H:%M:%S&#39;` User </span><span class="nv">$common_name</span><span class="s2"> trust_ip </span><span class="nv">$trusted_ip</span><span class="s2"> is login,Remote_ip is </span><span class="nv">$ifconfig_pool_remote_ip</span><span class="s2">, Mask is </span><span class="nv">$route_netmask_1</span><span class="s2">&#34;</span> &gt;&gt; /etc/openvpn/log/openvpn_<span class="nv">$Time</span>.log
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">  touch /etc/openvpn/log/openvpn_<span class="nv">$Time</span>.log
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;`date &#39;+%F %H:%M:%S&#39;` User </span><span class="nv">$common_name</span><span class="s2"> trust_ip </span><span class="nv">$trusted_ip</span><span class="s2"> is login,Remote_ip is </span><span class="nv">$ifconfig_pool_remote_ip</span><span class="s2">, Mask is </span><span class="nv">$route_netmask_1</span><span class="s2">&#34;</span> &gt;&gt; /etc/openvpn/log/openvpn_<span class="nv">$Time</span>.log
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>disconnect.sh</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nv">Time</span><span class="o">=</span><span class="sb">`</span>date +%F<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -f /etc/openvpn/log/openvpn_<span class="nv">$Time</span>.log <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">  touch /etc/openvpn/log/openvpn_<span class="nv">$Time</span>.log
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;`date &#39;+%F %H:%M:%S&#39;` User </span><span class="nv">$common_name</span><span class="s2"> trust_ip </span><span class="nv">$trusted_ip</span><span class="s2"> is logout,Remote_ip is </span><span class="nv">$ifconfig_pool_remote_ip</span><span class="s2">, Mask is </span><span class="nv">$route_netmask_1</span><span class="s2">&#34;</span> &gt;&gt; /etc/openvpn/log/openvpn_<span class="nv">$Time</span>.log
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  touch /etc/openvpn/log/openvpn_<span class="nv">$Time</span>.log
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;`date &#39;+%F %H:%M:%S&#39;` User </span><span class="nv">$common_name</span><span class="s2"> trust_ip </span><span class="nv">$trusted_ip</span><span class="s2"> is logout,Remote_ip is </span><span class="nv">$ifconfig_pool_remote_ip</span><span class="s2">, Mask is </span><span class="nv">$route_netmask_1</span><span class="s2">&#34;</span> &gt;&gt; /etc/openvpn/log/openvpn_<span class="nv">$Time</span>.log
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="开启forward转发">开启forward转发</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl stop firewalld
</span></span><span class="line"><span class="cl">systemctl mask firewalld
</span></span><span class="line"><span class="cl">setenforce 0				<span class="c1"># 临时关闭</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span> /etc/selinux/config	
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> net.ipv4.ip_forward <span class="o">=</span> <span class="m">1</span> &gt;&gt;/etc/sysctl.conf
</span></span><span class="line"><span class="cl">sysctl -p
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="配置iptables规则">配置iptables规则</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl <span class="nb">enable</span> iptables
</span></span><span class="line"><span class="cl">systemctl start iptables
</span></span><span class="line"><span class="cl">iptables -F   <span class="c1"># 清理所有防火墙规则</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>将 openvpn 的网络流量转发到公网：snat 规则</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 如下网段记得与server.conf 当中定义的网段保持一致</span>
</span></span><span class="line"><span class="cl">iptables -t nat -A POSTROUTING -s 10.0.0.0/8 -o eth0 -j MASQUERADE
</span></span><span class="line"><span class="cl">iptables -L -t nat
</span></span><span class="line"><span class="cl">iptables-save &gt; /etc/sysconfig/iptables   <span class="c1"># iptables 规则持久化保存</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">把iptables规则备份到/etc/sysconfig/iptables文件中
</span></span><span class="line"><span class="cl">iptables-save &gt; /etc/sysconfig/iptables
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">恢复刚才备份的规则
</span></span><span class="line"><span class="cl">iptables-restore &lt; /etc/sysconfig/iptables
</span></span></code></pre></td></tr></table>
</div>
</div><p>我测试环境的iptables配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[dev][root@foxconn-vpn-192.168.83.44 backup_openvpn]# cat /etc/sysconfig/iptables
</span></span><span class="line"><span class="cl"># Generated by iptables-save v1.4.21 on Thu May  6 14:02:02 2021
</span></span><span class="line"><span class="cl">*nat
</span></span><span class="line"><span class="cl">:PREROUTING ACCEPT [4743102:251117700]
</span></span><span class="line"><span class="cl">:INPUT ACCEPT [2104299:126313633]
</span></span><span class="line"><span class="cl">:OUTPUT ACCEPT [54995:3991628]
</span></span><span class="line"><span class="cl">:POSTROUTING ACCEPT [25003:2044398]
</span></span><span class="line"><span class="cl">:l - [0:0]
</span></span><span class="line"><span class="cl">#表示走 10.0.0.0/8数据的源IP都转换tun0这个接口的IP然后转发出去。
</span></span><span class="line"><span class="cl">-A POSTROUTING -d 10.0.0.0/8 -o tun0 -j MASQUERADE
</span></span><span class="line"><span class="cl">#表示走 192.168.0.0/16数据的源IP都转换eth0这个接口的IP然后转发出去。
</span></span><span class="line"><span class="cl">-A POSTROUTING -d 192.168.0.0/16 -o eth0 -j MASQUERADE
</span></span><span class="line"><span class="cl">COMMIT
</span></span><span class="line"><span class="cl"># Completed on Thu May  6 14:02:02 2021
</span></span><span class="line"><span class="cl"># Generated by iptables-save v1.4.21 on Thu May  6 14:02:02 2021
</span></span><span class="line"><span class="cl">*filter
</span></span><span class="line"><span class="cl">:INPUT ACCEPT [431:383193]
</span></span><span class="line"><span class="cl">:FORWARD ACCEPT [512:393937]
</span></span><span class="line"><span class="cl">:OUTPUT ACCEPT [374:70793]
</span></span><span class="line"><span class="cl">-A FORWARD -d 10.128.199.248/32 -j DROP
</span></span><span class="line"><span class="cl">-A FORWARD -d 10.128.199.254/32 -j DROP
</span></span><span class="line"><span class="cl">COMMIT
</span></span><span class="line"><span class="cl"># Completed on Thu May  6 14:02:02 2021
</span></span><span class="line"><span class="cl"># Generated by iptables-save v1.4.21 on Thu May  6 14:02:02 2021
</span></span><span class="line"><span class="cl">*mangle
</span></span><span class="line"><span class="cl">:PREROUTING ACCEPT [64983188:19955544594]
</span></span><span class="line"><span class="cl">:INPUT ACCEPT [32316135:9267024863]
</span></span><span class="line"><span class="cl">:FORWARD ACCEPT [30855150:10615986243]
</span></span><span class="line"><span class="cl">:OUTPUT ACCEPT [31879646:5718904613]
</span></span><span class="line"><span class="cl">:POSTROUTING ACCEPT [62734647:16334877032]
</span></span><span class="line"><span class="cl">COMMIT
</span></span><span class="line"><span class="cl"># Completed on Thu May  6 14:02:02 2021
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="特殊客户端配置ccd">特殊客户端配置ccd</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>dev<span class="o">][</span>root@foxconn-vpn-192.168.83.44 ccd<span class="o">]</span><span class="c1"># pwd</span>
</span></span><span class="line"><span class="cl">/etc/openvpn/ccd
</span></span><span class="line"><span class="cl"><span class="o">[</span>dev<span class="o">][</span>root@foxconn-vpn-192.168.83.44 ccd<span class="o">]</span><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl">lh.dmz
</span></span><span class="line"><span class="cl"><span class="o">[</span>dev<span class="o">][</span>root@foxconn-vpn-192.168.83.44 ccd<span class="o">]</span><span class="c1"># cat lh.dmz </span>
</span></span><span class="line"><span class="cl">iroute 10.0.0.0 255.0.0.0
</span></span><span class="line"><span class="cl"><span class="c1">#10.0.0.0/8子网网段应该被路由到lh.dmz </span>
</span></span><span class="line"><span class="cl"><span class="c1">#iroute控制了从OpenVPN服务器到远程客户端的路由</span>
</span></span><span class="line"><span class="cl"><span class="c1">#和前面server.conf 配置相互 route 10.0.0.0 255.0.0.0 配合</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>是否允许client2子网(10.0.0.0/8)和其它客户端之间的网络流量。如果是，添加下面的语句到服务器配置文件中：(目前的环境暂时没有用到)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">client-to-client
</span></span><span class="line"><span class="cl">push &#34;route 10.0.0.0 255.0.0.0&#34;
</span></span><span class="line"><span class="cl">#这会让OpenVPN服务器通告client2的子网到其它客户端。
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="服务端脚本配置">服务端脚本配置</h3>
<h4 id="钉钉发送接口脚本">钉钉发送接口脚本</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -*- coding: utf-8 -*-</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hmac</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">urllib</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">signature</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">  <span class="n">timestamp</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="n">secret</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxx&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="n">secret_enc</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">string_to_sign</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">string_to_sign_enc</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">string_to_sign</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">hmac_code</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret_enc</span><span class="p">,</span> <span class="n">string_to_sign_enc</span><span class="p">,</span> <span class="n">digestmod</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="n">sign</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">hmac_code</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">timestamp</span><span class="p">,</span><span class="n">sign</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">Dingtalk_Push</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">msgtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span> <span class="o">=</span> <span class="n">signature</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json;charset=utf-8&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">token</span> <span class="o">=</span> <span class="s2">&#34;xxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">api_url</span> <span class="o">=</span> <span class="s2">&#34;https://oapi.dingtalk.com/robot/send?access_token=</span><span class="si">%s</span><span class="s2">&amp;timestamp=</span><span class="si">%s</span><span class="s2">&amp;sign=</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="n">timestamp</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;markdown&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;markdown&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;title&#34;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;text&#34;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;at&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;isAtAll&#34;</span><span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;/tmp/dd_notice.log&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_data</span><span class="p">),</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">title</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">message</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">Dingtalk_Push</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="线路检查-主备切换脚本">线路检查-主备切换脚本</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#Check To Fox Network Script</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PingCheck<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  <span class="nv">ip</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">  <span class="nv">status_code</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> i in <span class="o">{</span>1..3<span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span>
</span></span><span class="line"><span class="cl">    /usr/sbin/fping -c <span class="m">10</span> -t <span class="m">1</span> <span class="nv">$ip</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">      <span class="nv">status_code</span><span class="o">=</span><span class="k">$(</span>expr <span class="nv">$status_code</span> + 1<span class="k">)</span> 
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">done</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="nv">$status_code</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">CheckLine<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> -f /etc/openvpn/ccd/lh.fox <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;lh.fox&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">elif</span> <span class="o">[</span> -f /etc/openvpn/ccd/lh.dmz <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;lh.dmz&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ChangeLine<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  <span class="nv">S_Line</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">  <span class="nv">D_Line</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl">  mv /etc/openvpn/ccd/<span class="nv">$S_Line</span> /etc/openvpn/ccd/<span class="nv">$D_Line</span> 
</span></span><span class="line"><span class="cl">  <span class="nb">kill</span> <span class="k">$(</span>ps -ef <span class="p">|</span>grep <span class="s2">&#34;/sbin/openvpn --daemo[n]&#34;</span><span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">  sleep <span class="m">3</span>
</span></span><span class="line"><span class="cl">  /sbin/openvpn --daemon --config /etc/openvpn/server.conf --log-append /var/log/openvpn.log 
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Start Check</span>
</span></span><span class="line"><span class="cl"><span class="nv">M_IP</span><span class="o">=</span><span class="s2">&#34;192.168.255.10&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">B_IP</span><span class="o">=</span><span class="s2">&#34;192.168.255.6&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">M_S</span><span class="o">=</span><span class="k">$(</span>PingCheck <span class="nv">$M_IP</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">Line</span><span class="o">=</span><span class="k">$(</span>CheckLine<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$M_S</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;3&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$Line</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;lh.dmz&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nv">B_S</span><span class="o">=</span><span class="k">$(</span>PingCheck <span class="nv">$B_IP</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$B_S</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;3&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>date +<span class="s2">&#34;%Y/%m/%d %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">\\\n壹城To厂区：主线路与备用线路均异常&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> 
</span></span><span class="line"><span class="cl">    <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>date +<span class="s2">&#34;%Y/%m/%d %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">\\\n壹城To厂区：主线路异常，切换备用线路&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  ChangeLine lh.dmz lh.fox  
</span></span><span class="line"><span class="cl">  /usr/bin/python /etc/openvpn/script/dd-notice.py <span class="s2">&#34;壹城To厂区网络告警&#34;</span> <span class="s2">&#34;</span><span class="nv">$msg</span><span class="s2">&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$M_S</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;0&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$Line</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;lh.fox&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>date +<span class="s2">&#34;%Y/%m/%d %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">\\\n壹城To厂区：主线路恢复，切回主线路&#34;</span>
</span></span><span class="line"><span class="cl">  ChangeLine lh.fox lh.dmz 
</span></span><span class="line"><span class="cl">  /usr/bin/python /etc/openvpn/script/dd-notice.py <span class="s2">&#34;壹城To厂区网络告警&#34;</span> <span class="s2">&#34;</span><span class="nv">$msg</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="定时任务">定时任务</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">*/5 * * * * /bin/bash -x /etc/openvpn/script/check-network.sh &gt; /tmp/debug.log 2&gt;&amp;1
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="openvpn管理脚本第一版">openvpn管理脚本（第一版）</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nv">USER</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl"><span class="nv">PASS</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">@xxxx.com </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&#34;</span><span class="p">|</span>md5sum <span class="p">|</span>cut -b 1-12<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">CA_PASS</span><span class="o">=</span><span class="s2">&#34;xxxxx.88&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">OVDIR</span><span class="o">=</span><span class="s2">&#34;/etc/openvpn&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">SER_ERSA</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">OVDIR</span><span class="si">}</span><span class="s2">/easy-rsa/3.0.6&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">CLI_ERSA</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">OVDIR</span><span class="si">}</span><span class="s2">/easy-rsa/3.0.6&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">KEYS_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">OVDIR</span><span class="si">}</span><span class="s2">/client&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">DB_FILE</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span><span class="s2">/pki/index.txt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -f /bin/expect <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;expect is not installed, start the installation...&#34;</span>
</span></span><span class="line"><span class="cl">  yum -y install expect
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">     <span class="nb">echo</span> <span class="s2">&#34;Installation failed, please install manually&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> GenerateAkey<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  <span class="nv">rlist</span><span class="o">=</span><span class="k">$(</span>find /etc/openvpn/ -name <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">*&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$rlist</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;用户: </span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2"> 已存在&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="nb">cd</span> <span class="si">${</span><span class="nv">CLI_ERSA</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">/bin/expect <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">  spawn ./easyrsa gen-req $USER
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Enter PEM pass phrase:&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Verifying - Enter PEM pass phrase&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Common Name&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect eof
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> GenerateAconf<span class="o">(){</span>
</span></span><span class="line"><span class="cl">cat &gt; <span class="si">${</span><span class="nv">KEYS_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>.ovpn <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">client
</span></span></span><span class="line"><span class="cl"><span class="s">dev tun
</span></span></span><span class="line"><span class="cl"><span class="s">proto udp
</span></span></span><span class="line"><span class="cl"><span class="s">remote xxx.xxx.xxx.xxx 1194
</span></span></span><span class="line"><span class="cl"><span class="s">resolv-retry infinite
</span></span></span><span class="line"><span class="cl"><span class="s">nobind
</span></span></span><span class="line"><span class="cl"><span class="s">persist-key
</span></span></span><span class="line"><span class="cl"><span class="s">persist-tun
</span></span></span><span class="line"><span class="cl"><span class="s">ca ca.crt
</span></span></span><span class="line"><span class="cl"><span class="s">cert ${USER}.crt
</span></span></span><span class="line"><span class="cl"><span class="s">key ${USER}.key
</span></span></span><span class="line"><span class="cl"><span class="s">remote-cert-tls server
</span></span></span><span class="line"><span class="cl"><span class="s">tls-auth ta.key 1
</span></span></span><span class="line"><span class="cl"><span class="s">cipher AES-256-CBC
</span></span></span><span class="line"><span class="cl"><span class="s">verb 3
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> ImportAkey<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  <span class="nb">cd</span> <span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">  ./easyrsa import-req <span class="si">${</span><span class="nv">CLI_ERSA</span><span class="si">}</span>/pki/reqs/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>.req <span class="si">${</span><span class="nv">USER</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">/bin/expect <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">  spawn ./easyrsa sign client $USER
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Confirm request details:&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;yes\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Enter pass phrase for&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${CA_PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect eof
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> CreateUser<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  GenerateAkey
</span></span><span class="line"><span class="cl">  ImportAkey
</span></span><span class="line"><span class="cl">  mkdir <span class="si">${</span><span class="nv">KEYS_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">  cp <span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span>/pki/issued/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>.crt <span class="si">${</span><span class="nv">KEYS_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">  cp <span class="si">${</span><span class="nv">CLI_ERSA</span><span class="si">}</span>/pki/private/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>.key <span class="si">${</span><span class="nv">KEYS_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">  cp <span class="si">${</span><span class="nv">OVDIR</span><span class="si">}</span>/<span class="o">{</span>ca.crt,ta.key<span class="o">}</span> <span class="si">${</span><span class="nv">KEYS_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">  <span class="nb">cd</span> <span class="si">${</span><span class="nv">KEYS_DIR</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">  GenerateAconf
</span></span><span class="line"><span class="cl">  zip -r <span class="si">${</span><span class="nv">USER</span><span class="si">}</span>.zip <span class="si">${</span><span class="nv">USER</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> -d <span class="si">${</span><span class="nv">USER</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    rm -rf <span class="si">${</span><span class="nv">USER</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> -e <span class="s2">&#34;\033[32mPlease Download </span><span class="si">${</span><span class="nv">KEYS_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">.zip\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> -f <span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span>/pki/issued/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>.crt <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#/bin/python2.7 /etc/openvpn/script/mail.py reg ${USER} ${PASS} ${KEYS_DIR}/${USER}.zip</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;\033[32mSenMail To </span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">@fujfu.com\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;\033[31mUser creation failed\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> RemoveUser<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  <span class="nv">rlist</span><span class="o">=</span><span class="k">$(</span>find /etc/openvpn/ -name <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">*&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> ! -n <span class="s2">&#34;</span><span class="nv">$rlist</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;用户: </span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2"> 不存在&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> -e <span class="s2">&#34;\033[31m</span><span class="si">${</span><span class="nv">rlist</span><span class="si">}</span><span class="s2">\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nb">read</span> -p <span class="s2">&#34;上述文件将被移除,请确认(yes/no): &#34;</span> yn
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$yn</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;yes&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> f in <span class="nv">$rlist</span><span class="p">;</span><span class="k">do</span>
</span></span><span class="line"><span class="cl">      rm -rf <span class="nv">$f</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> -e <span class="s2">&#34;\033[31m</span><span class="nv">$f</span><span class="s2">\033[0m       \033[32m[del]\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> -e <span class="s2">&#34;\033[31m</span><span class="nv">$f</span><span class="s2">\033[0m       \033[31m[fail]\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">fi</span>
</span></span><span class="line"><span class="cl">      sleep 0.5
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl">    sed -i <span class="s2">&#34;/=</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span>$<span class="s2">/d&#34;</span> <span class="si">${</span><span class="nv">DB_FILE</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">      <span class="nb">cd</span> <span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">/bin/expect <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">  spawn ./easyrsa update-db
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Enter pass phrase for&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${CA_PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect eof
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> -e <span class="s2">&#34;\033[31m</span><span class="si">${</span><span class="nv">DB_FILE</span><span class="si">}</span><span class="s2">\033[0m       \033[32m[update]\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> -e <span class="s2">&#34;\033[31m</span><span class="si">${</span><span class="nv">DB_FILE</span><span class="si">}</span><span class="s2">\033[0m       \033[32m[fail]\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>   
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> RevokeUser<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  <span class="nv">rlist</span><span class="o">=</span><span class="k">$(</span>find /etc/openvpn/ -name <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">*&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> ! -n <span class="s2">&#34;</span><span class="nv">$rlist</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;用户: </span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2"> 不存在&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="nb">cd</span> <span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">/bin/expect <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">  spawn ./easyrsa revoke ${USER}
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Continue with revocation&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;yes\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Enter pass phrase for&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${CA_PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect eof
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> Gencrl<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  <span class="nb">cd</span> <span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">/bin/expect <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">  spawn ./easyrsa gen-crl
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Enter pass phrase for&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${CA_PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect eof
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl">    start<span class="o">)</span>
</span></span><span class="line"><span class="cl">        /usr/sbin/openvpn --daemon --config /etc/openvpn/server.conf --log-append /var/log/openvpn.log
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">    restart<span class="o">)</span>
</span></span><span class="line"><span class="cl">        /usr/bin/pkill --signal SIGHUP --exact openvpn
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">    add<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">          CreateUser
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> $<span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> add username&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">    remove<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">          RevokeUser
</span></span><span class="line"><span class="cl">          Gencrl
</span></span><span class="line"><span class="cl">          RemoveUser
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> $<span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> remove username&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">    *<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> $<span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> {start|restart|add|remove} username&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">esac</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="openvpn管理脚本第二版">openvpn管理脚本（第二版）</h4>
<p>为了简化客户端配置文件的管理，OpenVPN 提供了一种便捷的内联文件方式，允许用户将根证书（ca.crt）、客户端证书（client.crt）以及客户端私钥（client.key）等必要文件直接嵌入到配置文件中。通过这种方式，用户无需分别管理多个文件，从而提高了配置的便捷性和安全性。 具体来说，用户可以在OpenVPN的配置文件（通常是.ovpn文件）中，通过特定的指令将这些证书和密钥文件的内容直接包含进来。这样，当配置文件被加载时，OpenVPN会自动读取并应用这些内联的证书和密钥信息，无需用户手动指定证书和密钥文件的路径。 这种方法不仅使得文件管理更为集中和高效，而且也减少了配置错误的可能性，因为所有的信息都在一个地方，用户只需维护一个配置文件即可。这对于用户来说是一个很大的便利，特别是对于那些需要频繁部署和更新VPN配置的场景。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">#获取传入的第二个参数</span>
</span></span><span class="line"><span class="cl"><span class="nv">USER</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl"><span class="nv">PASS</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2"> </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&#34;</span> <span class="p">|</span> md5sum <span class="p">|</span> cut -b 1-12<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">CA_PASS</span><span class="o">=</span><span class="s2">&#34;xxxx.88&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">OVDIR</span><span class="o">=</span><span class="s2">&#34;/etc/openvpn&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">SER_ERSA</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">OVDIR</span><span class="si">}</span><span class="s2">/easy-rsa/3.0.6&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">CLI_ERSA</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">OVDIR</span><span class="si">}</span><span class="s2">/easy-rsa/3.0.6&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">KEYS_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">OVDIR</span><span class="si">}</span><span class="s2">/client&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">DB_FILE</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span><span class="s2">/pki/index.txt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#判断是否安装expect</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -f /bin/expect <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;expect is not installed, start the installation...&#34;</span>
</span></span><span class="line"><span class="cl">    yum -y install expect
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Installation failed, please install manually&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> GenerateAkey<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#判断用户是否存在</span>
</span></span><span class="line"><span class="cl">    <span class="nv">rlist</span><span class="o">=</span><span class="k">$(</span>find /etc/openvpn/ -name <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">*&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$rlist</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;用户: </span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2"> 已存在&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="si">${</span><span class="nv">CLI_ERSA</span><span class="si">}</span>/ <span class="o">||</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 生成客户单的证书</span>
</span></span><span class="line"><span class="cl">    /bin/expect <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">  spawn ./easyrsa gen-req $USER
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Enter PEM pass phrase:&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Verifying - Enter PEM pass phrase&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Common Name&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect eof
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#生成单个配置文件</span>
</span></span><span class="line"><span class="cl">new_client<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Generates the custom client.ovpn</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        cat /etc/openvpn/server/client-common.txt
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;&lt;ca&gt;&#34;</span>
</span></span><span class="line"><span class="cl">        cat /etc/openvpn/easy-rsa/3.0.6/pki/ca.crt
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;&lt;/ca&gt;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;&lt;cert&gt;&#34;</span>
</span></span><span class="line"><span class="cl">        sed -ne <span class="s1">&#39;/BEGIN CERTIFICATE/,$ p&#39;</span> /etc/openvpn/easy-rsa/3.0.6/pki/issued/<span class="s2">&#34;</span><span class="nv">$USER</span><span class="s2">&#34;</span>.crt
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;&lt;/cert&gt;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;&lt;key&gt;&#34;</span>
</span></span><span class="line"><span class="cl">        cat /etc/openvpn/easy-rsa/3.0.6/pki/private/<span class="s2">&#34;</span><span class="nv">$USER</span><span class="s2">&#34;</span>.key
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;&lt;/key&gt;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;key-direction 1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;&lt;tls-auth&gt;&#34;</span>
</span></span><span class="line"><span class="cl">        sed -ne <span class="s1">&#39;/BEGIN OpenVPN Static key/,$ p&#39;</span> /etc/openvpn/server/ta.key
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;&lt;/tls-auth&gt;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> &gt;~/<span class="s2">&#34;</span><span class="nv">$USER</span><span class="s2">&#34;</span>.ovpn
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> ImportAkey<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span>/ <span class="o">||</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#导入client签约证书</span>
</span></span><span class="line"><span class="cl">    ./easyrsa import-req <span class="si">${</span><span class="nv">CLI_ERSA</span><span class="si">}</span>/pki/reqs/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>.req <span class="si">${</span><span class="nv">USER</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#给client端证书做签名</span>
</span></span><span class="line"><span class="cl">    /bin/expect <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">  spawn ./easyrsa sign client $USER
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Confirm request details:&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;yes\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Enter pass phrase for&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${CA_PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect eof
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#创建证书目录，进行归纳 压缩，发送邮件</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> CreateUser<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    GenerateAkey
</span></span><span class="line"><span class="cl">    ImportAkey
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">client
</span></span></span><span class="line"><span class="cl"><span class="s2">dev tun
</span></span></span><span class="line"><span class="cl"><span class="s2">proto tcp
</span></span></span><span class="line"><span class="cl"><span class="s2">remote xxx.xxx.xxx.xxx 11191
</span></span></span><span class="line"><span class="cl"><span class="s2">resolv-retry infinite
</span></span></span><span class="line"><span class="cl"><span class="s2">nobind
</span></span></span><span class="line"><span class="cl"><span class="s2">persist-key
</span></span></span><span class="line"><span class="cl"><span class="s2">persist-tun
</span></span></span><span class="line"><span class="cl"><span class="s2">remote-cert-tls server
</span></span></span><span class="line"><span class="cl"><span class="s2">cipher AES-256-CBC
</span></span></span><span class="line"><span class="cl"><span class="s2">block-outside-dns
</span></span></span><span class="line"><span class="cl"><span class="s2">verb 3&#34;</span> &gt;/etc/openvpn/server/client-common.txt
</span></span><span class="line"><span class="cl">    new_client
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;\033[32mPlease Download </span><span class="si">${</span><span class="nv">KEYS_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">-yc.zip\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#判断client 生成文件存在</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -f <span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span>/pki/issued/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>.crt <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#通过Python发送邮件 ，包含证书和使用方法</span>
</span></span><span class="line"><span class="cl">       <span class="c1"># /bin/python2.7 /etc/openvpn/script/mail.py ${USER} ${PASS} ${KEYS_DIR}/${USER}-yc.zip</span>
</span></span><span class="line"><span class="cl">       <span class="c1"># /bin/python2.7 /etc/openvpn/script/mail.py ${USER} ${PASS} ~/&#34;$USER&#34;.ovpn</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> -e <span class="s2">&#34;\033[32mSenMail To </span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">@fujfu.com\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> -e <span class="s2">&#34;\033[32mPrivate Key Password: \033[0m\033[31m</span><span class="si">${</span><span class="nv">PASS</span><span class="si">}</span><span class="s2">\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> -e <span class="s2">&#34;\033[31mUser creation failed\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#移除账号文件</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> RemoveUser<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#判断用户是否存在</span>
</span></span><span class="line"><span class="cl">    <span class="nv">rlist</span><span class="o">=</span><span class="k">$(</span>find /etc/openvpn/ -name <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">*&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> ! -n <span class="s2">&#34;</span><span class="nv">$rlist</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;用户: </span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2"> 不存在&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;\033[31m</span><span class="si">${</span><span class="nv">rlist</span><span class="si">}</span><span class="s2">\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">read</span> -p <span class="s2">&#34;上述文件将被移除,请确认(yes/no): &#34;</span> yn
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$yn</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;yes&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> f in <span class="nv">$rlist</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">            rm -rf <span class="nv">$f</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nb">echo</span> -e <span class="s2">&#34;\033[31m</span><span class="nv">$f</span><span class="s2">\033[0m       \033[32m[del]\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="nb">echo</span> -e <span class="s2">&#34;\033[31m</span><span class="nv">$f</span><span class="s2">\033[0m       \033[31m[fail]\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">done</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#删除openvpn的证书中的用户</span>
</span></span><span class="line"><span class="cl">        sed -i <span class="s2">&#34;/=</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span>$<span class="s2">/d&#34;</span> <span class="si">${</span><span class="nv">DB_FILE</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nb">cd</span> <span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">            <span class="c1"># update-db 命令来更新证书数据库</span>
</span></span><span class="line"><span class="cl">            /bin/expect <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">  spawn ./easyrsa update-db
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Enter pass phrase for&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${CA_PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect eof
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> -e <span class="s2">&#34;\033[31m</span><span class="si">${</span><span class="nv">DB_FILE</span><span class="si">}</span><span class="s2">\033[0m       \033[32m[update]\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> -e <span class="s2">&#34;\033[31m</span><span class="si">${</span><span class="nv">DB_FILE</span><span class="si">}</span><span class="s2">\033[0m       \033[32m[fail]\033[0m&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#删除账号</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> RevokeUser<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">rlist</span><span class="o">=</span><span class="k">$(</span>find /etc/openvpn/ -name <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">*&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> ! -n <span class="s2">&#34;</span><span class="nv">$rlist</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;用户: </span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2"> 不存在&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">    <span class="c1">#gen-crl会生成一份吊销证书的名单，放在pki/crl.pem文件里</span>
</span></span><span class="line"><span class="cl">    /bin/expect <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">  spawn ./easyrsa revoke ${USER}
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Continue with revocation&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;yes\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Enter pass phrase for&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${CA_PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect eof
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 撤销证书并创建CRL</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这是CA特定的任务。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 要永久撤消已颁发的证书，请提供导入期间使用的短名称：</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ./easyrsa revoke EntityName</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 要创建包含所有已撤销的证书的更新CRL，请执行以下操作：</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ./easyrsa gen-crl</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> Gencrl<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="si">${</span><span class="nv">SER_ERSA</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">    /bin/expect <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">  spawn ./easyrsa gen-crl
</span></span></span><span class="line"><span class="cl"><span class="s">  expect &#34;Enter pass phrase for&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  send &#34;${CA_PASS}\r&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  expect eof
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl">start<span class="o">)</span>
</span></span><span class="line"><span class="cl">    /usr/sbin/openvpn --daemon --config /etc/openvpn/server.conf --log-append /var/log/openvpn.log
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">restart<span class="o">)</span>
</span></span><span class="line"><span class="cl">    /usr/bin/pkill --signal SIGHUP --exact openvpn
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">add<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        CreateUser
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> $<span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> add username&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">remove<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        RevokeUser
</span></span><span class="line"><span class="cl">        Gencrl
</span></span><span class="line"><span class="cl">        RemoveUser
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> $<span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> remove username&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">*<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> $<span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> {start|restart|add|remove} username&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="k">esac</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面生成下方格式配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">client
</span></span><span class="line"><span class="cl">dev tun
</span></span><span class="line"><span class="cl">proto udp
</span></span><span class="line"><span class="cl">sndbuf <span class="m">0</span>
</span></span><span class="line"><span class="cl">rcvbuf <span class="m">0</span>
</span></span><span class="line"><span class="cl">remote openvpnserver <span class="m">1194</span>
</span></span><span class="line"><span class="cl">resolv-retry infinite
</span></span><span class="line"><span class="cl">nobind
</span></span><span class="line"><span class="cl">persist-key
</span></span><span class="line"><span class="cl">persist-tun
</span></span><span class="line"><span class="cl">remote-cert-tls server
</span></span><span class="line"><span class="cl">comp-lzo
</span></span><span class="line"><span class="cl">verb <span class="m">3</span>
</span></span><span class="line"><span class="cl">cipher AES-256-CBC
</span></span><span class="line"><span class="cl">script-security <span class="m">3</span>
</span></span><span class="line"><span class="cl">key-direction <span class="m">1</span>
</span></span><span class="line"><span class="cl">auth-nocache
</span></span><span class="line"><span class="cl">auth-user-pass
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ca ca.crt</span>
</span></span><span class="line"><span class="cl">&lt;ca&gt;
</span></span><span class="line"><span class="cl">-----BEGIN CERTIFICATE-----
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">-----END CERTIFICATE-----
</span></span><span class="line"><span class="cl">&lt;/ca&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># cert client.crt</span>
</span></span><span class="line"><span class="cl">&lt;cert&gt;
</span></span><span class="line"><span class="cl">Certificate:
</span></span><span class="line"><span class="cl">    Data:
</span></span><span class="line"><span class="cl">        Version: <span class="m">3</span> <span class="o">(</span>0x2<span class="o">)</span>
</span></span><span class="line"><span class="cl">        Serial Number:
</span></span><span class="line"><span class="cl">            89:53:31:72:cf:04:52:82:fb:e9:53:fe:82:fc:13:25
</span></span><span class="line"><span class="cl">    Signature Algorithm: sha256WithRSAEncryption
</span></span><span class="line"><span class="cl">        Issuer: <span class="nv">CN</span><span class="o">=</span>192.168.1.10
</span></span><span class="line"><span class="cl">        Validity
</span></span><span class="line"><span class="cl">            Not Before: Nov <span class="m">14</span> 03:32:32 <span class="m">2023</span> GMT
</span></span><span class="line"><span class="cl">            Not After : Feb <span class="m">16</span> 03:32:32 <span class="m">2026</span> GMT
</span></span><span class="line"><span class="cl">        Subject: <span class="nv">CN</span><span class="o">=</span>client
</span></span><span class="line"><span class="cl">        Subject Public Key Info:
</span></span><span class="line"><span class="cl">            Public Key Algorithm: rsaEncryption
</span></span><span class="line"><span class="cl">                Public-Key: <span class="o">(</span><span class="m">2048</span> bit<span class="o">)</span>
</span></span><span class="line"><span class="cl">                Modulus:
</span></span><span class="line"><span class="cl">                    ......
</span></span><span class="line"><span class="cl">                    ......
</span></span><span class="line"><span class="cl">                    ......
</span></span><span class="line"><span class="cl">                Exponent: <span class="m">65537</span> <span class="o">(</span>0x10001<span class="o">)</span>
</span></span><span class="line"><span class="cl">        X509v3 extensions:
</span></span><span class="line"><span class="cl">            X509v3 Basic Constraints: 
</span></span><span class="line"><span class="cl">                CA:FALSE
</span></span><span class="line"><span class="cl">            X509v3 Subject Key Identifier: 
</span></span><span class="line"><span class="cl">                6E:0A:D2:EF:CE:55:4F:56:C7:57:D1:77:37:0D:AD:28:EF:A2:C8:41
</span></span><span class="line"><span class="cl">            X509v3 Authority Key Identifier: 
</span></span><span class="line"><span class="cl">                keyid:1A:CE:DD:A8:65:0E:3D:32:E0:74:17:15:5D:F7:6E:3B:7D:C1:59:05
</span></span><span class="line"><span class="cl">                DirName:/CN<span class="o">=</span>192.168.1.10
</span></span><span class="line"><span class="cl">                serial:D8:A8:9B:71:84:77:C8:9B
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            X509v3 Extended Key Usage: 
</span></span><span class="line"><span class="cl">                TLS Web Client Authentication
</span></span><span class="line"><span class="cl">            X509v3 Key Usage: 
</span></span><span class="line"><span class="cl">                Digital Signature
</span></span><span class="line"><span class="cl">            Netscape Comment: 
</span></span><span class="line"><span class="cl">                Easy-RSA <span class="o">(</span>3.0.8<span class="o">)</span> Generated Certificate
</span></span><span class="line"><span class="cl">            Netscape Cert Type: 
</span></span><span class="line"><span class="cl">                SSL Client
</span></span><span class="line"><span class="cl">    Signature Algorithm: sha256WithRSAEncryption
</span></span><span class="line"><span class="cl">                    ......
</span></span><span class="line"><span class="cl">                    ......
</span></span><span class="line"><span class="cl">                    ......
</span></span><span class="line"><span class="cl">-----BEGIN CERTIFICATE-----
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">-----END CERTIFICATE-----
</span></span><span class="line"><span class="cl">&lt;/cert&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># key client.key</span>
</span></span><span class="line"><span class="cl">&lt;key&gt;
</span></span><span class="line"><span class="cl">-----BEGIN PRIVATE KEY-----
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">-----END PRIVATE KEY-----
</span></span><span class="line"><span class="cl">&lt;/key&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># tls-crypt ta.key 1</span>
</span></span><span class="line"><span class="cl">&lt;tls-crypt&gt;
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2048 bit OpenVPN static key</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">-----BEGIN OpenVPN Static key V1-----
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">-----END OpenVPN Static key V1-----
</span></span><span class="line"><span class="cl">&lt;/tls-crypt&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="开通账号自动发送邮件">开通账号自动发送邮件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -*- coding: utf-8 -*-</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">smtplib</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">datetime</span><span class="o">,</span><span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">email.header</span> <span class="kn">import</span> <span class="n">Header</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">email.mime.base</span> <span class="kn">import</span> <span class="n">MIMEBase</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">email.mime.application</span> <span class="kn">import</span> <span class="n">MIMEApplication</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">email.MIMEMultipart</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">GenHtml</span><span class="p">(</span><span class="n">UserName</span><span class="p">,</span><span class="n">UserPass</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="n">Data</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">  <span class="n">html</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;html xmlns=&#34;http://www.w3.org/1999/xhtml&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;head&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;meta http-equiv=&#34;Content-Type&#34; content=&#34;text/html; charset=utf-8&#34; /&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;style type=&#34;text/css&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">table {  
</span></span></span><span class="line"><span class="cl"><span class="s2">     border-collapse: collapse;  
</span></span></span><span class="line"><span class="cl"><span class="s2">     font-family: Futura, Arial, sans-serif;  
</span></span></span><span class="line"><span class="cl"><span class="s2">}  
</span></span></span><span class="line"><span class="cl"><span class="s2">caption {  
</span></span></span><span class="line"><span class="cl"><span class="s2">     font-size: larger;  
</span></span></span><span class="line"><span class="cl"><span class="s2">     margin: 1em auto;  
</span></span></span><span class="line"><span class="cl"><span class="s2">} 
</span></span></span><span class="line"><span class="cl"><span class="s2">th,td {  
</span></span></span><span class="line"><span class="cl"><span class="s2">     padding: .65em;  
</span></span></span><span class="line"><span class="cl"><span class="s2">}  
</span></span></span><span class="line"><span class="cl"><span class="s2">th {  
</span></span></span><span class="line"><span class="cl"><span class="s2">     background: #555 nonerepeat scroll 0 0;  
</span></span></span><span class="line"><span class="cl"><span class="s2">   border: 1px solid #777;  
</span></span></span><span class="line"><span class="cl"><span class="s2">   color: #fff;  
</span></span></span><span class="line"><span class="cl"><span class="s2">}  
</span></span></span><span class="line"><span class="cl"><span class="s2">td {  
</span></span></span><span class="line"><span class="cl"><span class="s2">     border: 1px solid#000000;  
</span></span></span><span class="line"><span class="cl"><span class="s2">} 
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/style&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/head&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;body&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;div id=&#34;container&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;div id=&#34;content&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;table style=&#34;tablestyle&#34; border=&#34;1&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;tr&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">  &lt;td bgcolor=&#34;#66B3FF&#34; style=&#34;color: #F3F3FA&#34; align=&#34;center&#34;&gt;&lt;b&gt;开通时间&lt;/b&gt;&lt;/td&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">  &lt;td align=&#34;center&#34;&gt;</span><span class="si">%s</span><span class="s2">&lt;/td&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/tr&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;tr&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">  &lt;td bgcolor=&#34;#66B3FF&#34; style=&#34;color: #F3F3FA&#34; align=&#34;center&#34;&gt;&lt;b&gt;账号&lt;/b&gt;&lt;/td&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">  &lt;td align=&#34;center&#34;&gt;&lt;font color=&#34;red&#34;&gt;&lt;b&gt;</span><span class="si">%s</span><span class="s2">&lt;/b&gt;&lt;/font&gt;&lt;/td&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/tr&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;tr&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">  &lt;td bgcolor=&#34;#66B3FF&#34; style=&#34;color: #F3F3FA&#34; align=&#34;center&#34;&gt;&lt;b&gt;密码&lt;/b&gt;&lt;/td&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">  &lt;td align=&#34;center&#34;&gt;&lt;font color=&#34;red&#34;&gt;&lt;b&gt;</span><span class="si">%s</span><span class="s2">&lt;/b&gt;&lt;/font&gt;&lt;/td&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/tr&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;tr&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">  &lt;td bgcolor=&#34;#66B3FF&#34; style=&#34;color: #F3F3FA&#34; align=&#34;center&#34;&gt;&lt;b&gt;有效期&lt;/b&gt;&lt;/td&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">  &lt;td align=&#34;center&#34;&gt;&lt;font color=&#34;red&#34;&gt;&lt;b&gt;7天&lt;/b&gt;&lt;/font&gt;&lt;/td&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/tr&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;tr&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">  &lt;td bgcolor=&#34;#66B3FF&#34; style=&#34;color: #F3F3FA&#34; align=&#34;center&#34;&gt;&lt;b&gt;证书及配置文件&lt;/b&gt;&lt;/td&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">  &lt;td align=&#34;center&#34;&gt;&lt;font color=&#34;red&#34;&gt;&lt;b&gt;见附件&lt;/b&gt;&lt;/font&gt;&lt;/td&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/tr&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/table&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/br&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;h2&gt;使用说明:&lt;/h2&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;ul&gt;&lt;li&gt;&lt;b&gt;Windows&lt;/b&gt;&lt;/li&gt;&lt;/ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;p&gt;下载 openvpn 的安装程序 &lt;a href=&#34;https://aliyuncs.com/software/OpenVPN-2.5.3-I601-amd64.msi&#34; title=&#34;OpenVPN-2.5.3-I601-amd64.msi&#34;&gt;OpenVPN-2.5.3-I601-amd64.msi&lt;/a&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">安装完成，将证书拷贝至 OpenVPN\config 下即可，openvpn 的软件请使用管理员权限打开。&lt;/p&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;ul&gt;&lt;li&gt;&lt;b&gt;MacOS&lt;/b&gt;&lt;/li&gt;&lt;/ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;p&gt;下载 Tunnelblick 等，支持openvpn 的客户端双击 *.ovpn 即可导入。&lt;/p&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;p&gt;下载 Tunnelblick 安装程序 &lt;a href=&#34;https://aliyuncs.com/software/Tunnelblick_3.8.5a_build_5671.dmg&#34; title=&#34;Tunnelblick_3.8.5a_build_5671.dmg&#34;&gt;Tunnelblick_3.8.5a_build_5671.dmg&lt;/a&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;ul&gt;&lt;li&gt;&lt;b&gt;温馨提示&lt;/b&gt;&lt;/li&gt;&lt;/ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;p&gt;请妥善保管好你的账号、密码以及密钥文件，如发生信息丢失，请及时联系管理员。&lt;/p&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/body&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/html&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">UserName</span><span class="p">,</span> <span class="n">UserPass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">VpnMailTo</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">mailSubject</span><span class="p">,</span> <span class="n">mailto</span><span class="p">,</span> <span class="n">key_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">mailuser</span> <span class="o">=</span> <span class="s2">&#34;yunwei@qq.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mailpass</span> <span class="o">=</span> <span class="s2">&#34;xxxxxxx&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP_SSL</span><span class="p">(</span><span class="s1">&#39;smtp.qq.com&#39;</span><span class="p">,</span> <span class="mi">465</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">mailuser</span><span class="p">,</span> <span class="n">mailpass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">main_msg</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">MIMEMultipart</span><span class="o">.</span><span class="n">MIMEMultipart</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">text_msg</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">MIMEText</span><span class="o">.</span><span class="n">MIMEText</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">_subtype</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">_charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">text_msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">contype</span> <span class="o">=</span> <span class="s1">&#39;application/octet-stream&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">maintype</span><span class="p">,</span> <span class="n">subtype</span> <span class="o">=</span> <span class="n">contype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;/etc/openvpn/script/docs/办公室内网OpenVPN使用手册.docx&#34;</span><span class="p">,</span> <span class="n">key_file</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#for f in files:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  data = open(f, &#39;rb&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  file_msg = email.MIMEBase.MIMEBase(maintype, subtype)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  file_msg.set_payload(data.read())</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  data.close()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  email.Encoders.encode_base64(f)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#  basename = os.path.basename(f)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  file_msg.add_header(&#39;Content-Disposition&#39;,&#39;attachment&#39;, filename = f)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  main_msg.attach(f)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="n">part</span> <span class="o">=</span> <span class="n">MIMEApplication</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">          <span class="n">part</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">,</span> <span class="s1">&#39;attachment&#39;</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">basename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="n">main_msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">main_msg</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;VPNService &lt;yunwei@qq.com&gt;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_msg</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="n">mailSubject</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_msg</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;,&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mailto</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_msg</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">Utils</span><span class="o">.</span><span class="n">formatdate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="s1">&#39;yunwei@qq.com&#39;</span><span class="p">,</span> <span class="n">mailto</span><span class="p">,</span> <span class="n">main_msg</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">VpnReg</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Pass</span><span class="p">,</span> <span class="n">KeysFile</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="n">mailSubject</span> <span class="o">=</span> <span class="n">User</span> <span class="o">+</span> <span class="s2">&#34; 你好，办公网络环境的VPN账号已开通成功！&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">html</span> <span class="o">=</span> <span class="n">GenHtml</span><span class="p">(</span><span class="n">User</span><span class="p">,</span><span class="n">Pass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">MailTo</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">  <span class="n">MailTo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">User</span><span class="o">+</span><span class="s2">&#34;@qq.com&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">VpnMailTo</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">mailSubject</span><span class="p">,</span> <span class="n">MailTo</span><span class="p">,</span> <span class="n">KeysFile</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">User</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pass</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">KeysFile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">VpnReg</span><span class="p">(</span><span class="n">User</span><span class="p">,</span><span class="n">Pass</span><span class="p">,</span><span class="n">KeysFile</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="openvpn管理">openvpn管理</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>dev<span class="o">][</span>root@foxconn-vpn-192.168.1.1 script<span class="o">]</span><span class="c1"># pwd</span>
</span></span><span class="line"><span class="cl">/etc/openvpn/script
</span></span><span class="line"><span class="cl"><span class="o">[</span>dev<span class="o">][</span>root@foxconn-vpn-192.168.1.1 script<span class="o">]</span><span class="c1"># ./vpncli -h</span>
</span></span><span class="line"><span class="cl">Usage: ./vpncli <span class="o">{</span>start<span class="p">|</span>restart<span class="p">|</span>add<span class="p">|</span>remove<span class="o">}</span> username
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="openvpn-client客户端">openvpn-client客户端</h2>
<h3 id="openvpn-客户端配置---主节点">OpenVPN 客户端配置 - 主节点</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>客户端标识</th>
<th>物理 IP / 虚拟 IP</th>
<th>目标网络范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>主节点（openvpn-client01）</td>
<td>10.134.18.10 / 192.168.255.10</td>
<td>10.0.0.0/8</td>
</tr>
</tbody>
</table></div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#客户段</span>
</span></span><span class="line"><span class="cl">client
</span></span><span class="line"><span class="cl"><span class="c1">#使用的tcp协议</span>
</span></span><span class="line"><span class="cl">dev tun
</span></span><span class="line"><span class="cl"><span class="c1">## &#34;dev tun&#34;将会创建一个路由IP隧道</span>
</span></span><span class="line"><span class="cl">proto tcp
</span></span><span class="line"><span class="cl"><span class="c1">#vpn server的地址</span>
</span></span><span class="line"><span class="cl">remote xxx.xxx.xxx.xxx <span class="m">1194</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 启用该指令，与服务器连接中断后将自动重新连接，</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这在网络不稳定的情况下(例如：笔记本电脑无线网络)非常有用</span>
</span></span><span class="line"><span class="cl">resolv-retry infinite
</span></span><span class="line"><span class="cl"><span class="c1"># 大多数客户端不需要绑定本机特定的端口号</span>
</span></span><span class="line"><span class="cl">nobind
</span></span><span class="line"><span class="cl"><span class="c1"># 持久化选项可以尽量避免访问在重启时由于用户权限降低而无法访问的某些资源</span>
</span></span><span class="line"><span class="cl">persist-key
</span></span><span class="line"><span class="cl">persist-tun
</span></span><span class="line"><span class="cl"><span class="c1">#ca证书</span>
</span></span><span class="line"><span class="cl">ca ca.crt
</span></span><span class="line"><span class="cl"><span class="c1">#客户端证书</span>
</span></span><span class="line"><span class="cl">cert lh.dmz.crt
</span></span><span class="line"><span class="cl"><span class="c1">#客户端秘钥</span>
</span></span><span class="line"><span class="cl">key lh.dmz.key
</span></span><span class="line"><span class="cl"><span class="c1"># 通过检查证书具有正确的密钥使用设置来验证服务器证书</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这是防止此处讨论的潜在攻击的重要预防措施：</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  http://openvpn.net/howto.html#mitm</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 要使用此功能，EasyRSA生成服务器证书的时候进行相关设置</span>
</span></span><span class="line"><span class="cl">remote-cert-tls server
</span></span><span class="line"><span class="cl"><span class="c1"># 如果在服务器上使用tls-auth密钥，那么每个客户端也必须拥有密钥</span>
</span></span><span class="line"><span class="cl">tls-auth ta.key <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 选择一个加密算法，服务器使用的算法选项，也必须在这里指定它</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 注意，v2.4客户端/服务器将自动以TLS模式协商AES-256-GCM。</span>
</span></span><span class="line"><span class="cl">cipher AES-256-CBC
</span></span><span class="line"><span class="cl"><span class="c1">#信息日志</span>
</span></span><span class="line"><span class="cl">verb <span class="m">3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="启动客户端">启动客户端</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">openvpn --daemon --cd /etc/openvpn/lh.dmz/ --config lh.dmz.ovpn --log-append /var/log/openvpn_dmz.log --askpass /etc/openvpn/lh.dmz/lh.dmz.pass
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="openvpn-客户端配置---备节点通过代理">OpenVPN 客户端配置 - 备节点（通过代理）</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>客户端标识</th>
<th>物理 IP / 虚拟 IP</th>
<th>目标网络范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>备节点（openvpn-client02）</td>
<td>10.128.19.10 / 192.168.255.6</td>
<td>10.0.0.0/8</td>
</tr>
</tbody>
</table></div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">client
</span></span><span class="line"><span class="cl">dev tun
</span></span><span class="line"><span class="cl">proto tcp
</span></span><span class="line"><span class="cl">remote xxx.xxx.xxx.xxx <span class="m">1194</span>
</span></span><span class="line"><span class="cl">resolv-retry infinite
</span></span><span class="line"><span class="cl">route 192.168.0.0 255.255.0.0
</span></span><span class="line"><span class="cl">route xxx.xxx.xxx.xxx 255.255.255.255 <span class="c1">#公网路由</span>
</span></span><span class="line"><span class="cl">nobind
</span></span><span class="line"><span class="cl">persist-key
</span></span><span class="line"><span class="cl">persist-tun
</span></span><span class="line"><span class="cl">ca ca.crt
</span></span><span class="line"><span class="cl">cert lh.fox.crt
</span></span><span class="line"><span class="cl">key lh.fox.key
</span></span><span class="line"><span class="cl">remote-cert-tls server
</span></span><span class="line"><span class="cl">tls-auth ta.key <span class="m">1</span>
</span></span><span class="line"><span class="cl">cipher AES-256-CBC
</span></span><span class="line"><span class="cl">verb <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="c1">#http-proxy 10.xxx.xxx.xxx 3128</span>
</span></span><span class="line"><span class="cl"><span class="c1">#http-proxy 10.xxx.xxx.xxx 3128</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果通过HTTP代理方式来连接到实际的VPN服务器</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 在此处指定代理服务器的主机名(或IP)和端口号</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果代理服务器需要身份认证，请参考官方手册</span>
</span></span><span class="line"><span class="cl">http-proxy 10.xxx.xxx.xxx <span class="m">3128</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 连接失败时自动重试</span>
</span></span><span class="line"><span class="cl">http-proxy-retry
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="启动客户端-1">启动客户端</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openvpn --daemon --cd /etc/openvpn/lh.fox --config lh.fox.ovpn --log-append /var/log/openvpn.log --askpass /etc/openvpn/lh.fox/lh.fox.pass  <span class="c1">#这个vpn在连接时，会使用到密码</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="交换机配置">交换机配置</h2>
<p>交换机添加路由</p>
<p><strong>10.0.0.0/8 这个网段是 异地 的网段</strong></p>
<p>访问 10.0.0.0/8的 数据，下一跳 192.168.83.44 （openvpn-server）</p>
<p><img src="/../../image/image-20220701174558080.png"
	
	
	
	loading="lazy"
	
		alt="image-20220701174558080"
	
	
></p>
<p>参考文档：<a class="link" href="https://www.gaoyufu.cn/archives/openvpn"  target="_blank" rel="noopener"
    >https://www.gaoyufu.cn/archives/openvpn</a></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/opevpn/">opevpn</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>未来的你，会感谢今天仍在努力奋斗的你</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/202410251628/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/01.jpg" loading="lazy" data-key="202410251628" data-hash="/../../title_pic/01.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">机房私有云OpenStack搭建详细步骤流程</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202410231844/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/77.jpg" loading="lazy" data-key="202410231844" data-hash="/../../title_pic/77.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">OpenStack将运行的系统导出 QCOW2 镜像并导入阿里云</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202407302222/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/11.jpg" loading="lazy" data-key="202407302222" data-hash="/../../title_pic/11.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Openvpn打通北京和深圳两地办公室网络</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202407281721/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/68.jpg" loading="lazy" data-key="202407281721" data-hash="/../../title_pic/68.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">PowerDNS架构解析与安装部署指南</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202407181155/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/58.jpg" loading="lazy" data-key="202407181155" data-hash="/../../title_pic/58.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">处理.git文件夹过大出现臃肿问题</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="nangongchengfeng/nangongchengfeng.github.io"
    data-repo-id="R_kgDOIwWL4Q"
    data-category="Announcements"
    data-category-id="DIC_kwDOIwWL4c4Cg8Rs"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('light');
            } else {
                setGiscusTheme('dark_dimmed');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2018 - 
        
        2024 南宫乘风
    </section>
    
    <section class="powerby">
        
            <a href="https://beian.miit.gov.cn/" target="_blank">备案号</a> <a href="https://beian.miit.gov.cn/" target="_blank">陕ICP备2021004364号-1</a> <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
