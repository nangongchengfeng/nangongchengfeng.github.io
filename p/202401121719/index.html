<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='、简介是一个开源服务网格，它透明地分层到现有的分布式应用程序上。强大的特性提供了一种统一和更有效的方式来保护、连接和监视服务。是实现负载平衡、服务到服务身份验证和监视的路径只需要很少或不需要更改服务代。。。。。。。'>
<title>Istio安装和基础原理</title>

<link rel='canonical' href='https://www.ownit.top/p/202401121719/'>

<link rel="stylesheet" href="/scss/style.min.f8f67bed86aec9bc8e9eb410ba9583e51cb34eee82f3d10e0abbae72b51272ce.css"><meta property='og:title' content='Istio安装和基础原理'>
<meta property='og:description' content='、简介是一个开源服务网格，它透明地分层到现有的分布式应用程序上。强大的特性提供了一种统一和更有效的方式来保护、连接和监视服务。是实现负载平衡、服务到服务身份验证和监视的路径只需要很少或不需要更改服务代。。。。。。。'>
<meta property='og:url' content='https://www.ownit.top/p/202401121719/'>
<meta property='og:site_name' content='南宫乘风'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='istio' /><meta property='article:tag' content='云原生' /><meta property='article:published_time' content='2024-01-12T17:19:48&#43;00:00'/><meta property='article:modified_time' content='2024-01-12T17:19:48&#43;00:00'/><meta property='og:image' content='https://www.ownit.top/title_pic/32.jpg' />
<meta name="twitter:title" content="Istio安装和基础原理">
<meta name="twitter:description" content="、简介是一个开源服务网格，它透明地分层到现有的分布式应用程序上。强大的特性提供了一种统一和更有效的方式来保护、连接和监视服务。是实现负载平衡、服务到服务身份验证和监视的路径只需要很少或不需要更改服务代。。。。。。。"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://www.ownit.top/title_pic/32.jpg' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu227367ba8544f2fc7811ed9508937bec_102665_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">南宫乘风</a></h1>
            <h2 class="site-description">当你的才华撑不起你的野心时，只有静下心学习才是唯一的出路</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://blog.csdn.net/heian_99'
                        target="_blank"
                        title="CSDN"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="32.000000pt" height="32.000000pt" viewBox="0 0 32.000000 32.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,32.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M0 160 l0 -160 160 0 160 0 0 160 0 160 -160 0 -160 0 0 -160z m225
108 c24 -11 34 -41 16 -52 -4 -3 -17 1 -27 9 -43 32 -95 3 -109 -62 -5 -27 -2
-37 19 -58 29 -29 62 -32 94 -9 25 17 42 11 42 -15 0 -27 -51 -45 -107 -38
-70 8 -97 42 -91 115 4 48 10 60 41 89 39 35 76 42 122 21z"/>
</g>
</svg>

                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/nangongchengfeng/'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='/index.xml'
                        target="_blank"
                        title="RSS"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 455.731 455.731" xml:space="preserve">
<g>
	<rect x="0" y="0" style="fill:#F78422;" width="455.731" height="455.731"/>
	<g>
		<path style="fill:#FFFFFF;" d="M296.208,159.16C234.445,97.397,152.266,63.382,64.81,63.382v64.348
			c70.268,0,136.288,27.321,185.898,76.931c49.609,49.61,76.931,115.63,76.931,185.898h64.348
			C391.986,303.103,357.971,220.923,296.208,159.16z"/>
		<path style="fill:#FFFFFF;" d="M64.143,172.273v64.348c84.881,0,153.938,69.056,153.938,153.939h64.348
			C282.429,270.196,184.507,172.273,64.143,172.273z"/>
		<circle style="fill:#FFFFFF;" cx="109.833" cy="346.26" r="46.088"/>
	</g>
</g>
</svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/link/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友链</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>暗色模式</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#1istio简介">1、Istio简介</a></li>
    <li><a href="#2istio-核心功能">2、Istio 核心功能</a></li>
    <li><a href="#3istio-原理">3、Istio 原理</a></li>
    <li><a href="#4istio-安装">4、Istio 安装</a></li>
    <li><a href="#5istio核心资源">5、Istio核心资源</a>
      <ol>
        <li><a href="#virtualservice">VirtualService</a></li>
        <li><a href="#destinationrule">DestinationRule</a></li>
        <li><a href="#gateway">Gateway</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/202401121719/">
                
                    <img src="/../../title_pic/32.jpg" loading="lazy" alt="Featured image of post Istio安装和基础原理" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/kubernetes%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" >
                Kubernetes项目实战
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/202401121719/">Istio安装和基础原理</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            、简介是一个开源服务网格，它透明地分层到现有的分布式应用程序上。强大的特性提供了一种统一和更有效的方式来保护、连接和监视服务。是实现负载平衡、服务到服务身份验证和监视的路径只需要很少或不需要更改服务代。。。。。。。
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 12, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 15 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="1istio简介">1、Istio简介</h2>
<p>Istio 是一个开源服务网格，它透明地分层到现有的分布式应用程序上。 Istio 强大的特性提供了一种统一和更有效的方式来保护、连接和监视服务。 Istio 是实现负载平衡、服务到服务身份验证和监视的路径——只需要很少或不需要更改服务代码。它强大的控制平面带来了重要的特点，包括：</p>
<ul>
<li>使用 TLS 加密、强身份认证和授权的集群内服务到服务的安全通信</li>
<li>自动负载均衡的 HTTP, gRPC, WebSocket，和 TCP 流量</li>
<li>通过丰富的路由规则、重试、故障转移和故障注入对流量行为进行细粒度控制</li>
<li>一个可插入的策略层和配置 API，支持访问控制、速率限制和配额</li>
<li>对集群内的所有流量(包括集群入口和出口)进行自动度量、日志和跟踪</li>
</ul>
<p><img src="/../../image/2f1a38df2ec84e9db975a1a4ec548270.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
></p>
<p>Istio 主要由两部分组成，分别是数据平面和控制平面。</p>
<ul>
<li><strong>数据平面</strong>：数据平面或者数据层是由代理服务的集合所组成的，它们会使用扩展的 <a class="link" href="https://www.envoyproxy.io/"  target="_blank" rel="noopener"
    >Envoy</a> 代理服务器，表现形式是每个 Kubernetes pod 中的 sidecar 容器。这些 sidecar 会协调和控制所有微服务之间的网络通信，同时还会收集和报告有用的遥测数据。</li>
<li><strong>控制平面</strong>：控制平面或者控制层由一个名为 <em>istiod</em> 的二进制文件组成，负责将高层级的路由规则和流量控制行为转换成 Envoy 的特定配置，然后在运行时将它们传播到 sidecar 中。除此之外，控制平面还提供安全措施，通过内置的身份标识和证书管理，实现强大的服务间和终端用户认证，同时根据服务的身份标识执行安全策略。</li>
</ul>
<h2 id="2istio-核心功能">2、Istio 核心功能</h2>
<p><img src="/../../image/86a653ce40634bc797878b6c42836ca6.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
>
Istio 是一个与 Kubernetes 紧密结合的服务网格(Service Mesh)，用于<strong>服务治理</strong>。</p>
<p>注意，Istio 是用于服务治理的，主要有流量管理、服务间安全、可观测性这几种功能。在微服务系统中，会碰到很多棘手的问题，Istio 只能解决其中一小部分。</p>
<p>服务治理有三种方式，第一种是每个项目中包含单独的治理逻辑，这样比较简单；第二种是将逻辑封装到 SDK 中，每个项目引用 SDK 即可，不增加或只需要少量配置或代码即可；第三种是下沉到基础设施层。Istio 便是第三种方式。
<img src="/../../image/c1c1f7ee4d4749caae149d0dab6184fe.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
>
<img src="/../../image/a7ba4d8536644bfa8e4a07ddaa7b0875.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
></p>
<h2 id="3istio-原理">3、Istio 原理</h2>
<p>Istio 可以的作用原理是拦截 Kubernetes 部署 Pod 的事件，然后从 Pod 中注入一个名为 Envoy 的容器，<strong>这个容器会拦截外部到业务应用的流量</strong>。由于所有流量都被 Envoy “劫持” 了，所以 Istio 可以对流量进行分析例如收集请求信息，以及一系列的流量管理操作，也可以验证授权信息。当 Envoy 拦截流量并执行一系列操作之后，如果请求没问题，就会转发流量到业务应用的 Pod 中。
<img src="/../../image/77ce429f7a4945fda403628a1aae4806.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
>
【左：普通 Pod；Istio；右：Istio 代理了出入口流量】</p>
<p>当然，由于 Envoy 需要拦截流量之后转发给业务应用，这样就多了一层转发，会导致系统响应速度会有所下降，<strong>但是增加的响应时间几乎可以忽略不计</strong>。</p>
<p>每个 Pod 都有一个 Envoy 负责拦截、处理和转发进出 Pod 的所有网络流量，这种方式被称为 Sidecar。</p>
<p>以下是 Istio Sidecar 的一些主要功能：</p>
<ul>
<li>流量管理：Envoy 代理可以根据 Istio 配置的路由规则（如 VirtualService 和 DestinationRule）实现流量的转发、分割和镜像等功能。</li>
<li>安全通信：Envoy 代理负责在服务之间建立安全的双向 TLS 连接，确保服务间通信的安全性。</li>
<li>遥测数据收集：Envoy 代理可以收集关于网络流量的详细遥测数据（如延迟、成功率等），并将这些数据上报给 Istio 的遥测组件，以便进行监控和分析。</li>
<li>策略执行：Envoy 代理可以根据 Istio 配置的策略规则（如 RateLimit 和 AuthorizationPolicy）执行限流、访问控制等策略。</li>
</ul>
<p>由于 Pod 是通过 Envoy 暴露端口的，所有进出口流量都需要经过 Envoy 的检查，所以很容易判断访问来源，<strong>如果请求方不是在 Istio 中的服务，那么 Envoy 便会拒绝访问。</strong>
<img src="/../../image/4948196811584fb89107b9e1330fe788.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
>
在 Istio 中，Envoy 这一块称为数据平面，而负责管理集群的 istiod 组件称为控制平面。</p>
<blockquote>
<p>注意，这里是 istiod ，是 Istio 负责管理集群的一种组件。</p>
<p><img src="/../../image/67002026b8a34e9d94d221d236971b5d.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
></p>
</blockquote>
<h2 id="4istio-安装">4、Istio 安装</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">istioctl<span class="o">(</span>可以通过curl -L https://istio.io/downloadIstio <span class="p">|</span> <span class="nv">ISTIO_VERSION</span><span class="o">=</span>1.20.1 sh 安装<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@bt ~<span class="o">]</span><span class="c1"># istioctl profile list</span>
</span></span><span class="line"><span class="cl">Istio configuration profiles:
</span></span><span class="line"><span class="cl">    ambient
</span></span><span class="line"><span class="cl">    default
</span></span><span class="line"><span class="cl">    demo
</span></span><span class="line"><span class="cl">    empty
</span></span><span class="line"><span class="cl">    external
</span></span><span class="line"><span class="cl">    minimal
</span></span><span class="line"><span class="cl">    openshift
</span></span><span class="line"><span class="cl">    preview
</span></span><span class="line"><span class="cl">    remote
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">或者 
</span></span><span class="line"><span class="cl">安装profile<span class="o">=</span>demo的 istio
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">istioctl manifest apply --set <span class="nv">profile</span><span class="o">=</span>demo <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--set cni.enabled<span class="o">=</span><span class="nb">true</span> --set cni.components.cni.namespace<span class="o">=</span>kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--set values.gateways.istio-ingressgateway.type<span class="o">=</span>ClusterIP
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/../../image/2729299d0bb0415a981a8017b59c453e.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
>
设置自动 istio 注入，可以通过 namespace 去做</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#给ns1的命名空间添加istio标签，那么在这个标签里，所有创建的 pod 都会被自动注入 istio</span>
</span></span><span class="line"><span class="cl">kubectl label ns ns1 istio-injection<span class="o">=</span>enabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看labels</span>
</span></span><span class="line"><span class="cl">kubectl get ns --show-labels
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 istio 单独的注入一个pod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 创建</span>
</span></span><span class="line"><span class="cl">istioctl kube-inject -f pod1.yaml <span class="p">|</span> kubectl apply -f -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod数量</span>
</span></span><span class="line"><span class="cl">kubectl get pods  <span class="c1">#此时READY数为2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#这个pod新增的docker，就是 pilot，envoy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 在创建一个 pod 测试</span>
</span></span><span class="line"><span class="cl">sed <span class="s1">&#39;s/pod1/pod2/&#39;</span> pod1.yaml <span class="p">|</span> kubectl apply -f -
</span></span><span class="line"><span class="cl">kubectl get pods  <span class="c1"># 发现这个 pod2 是没有被注入的</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装kiali ：图形化工具，可以直观的查看流量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get pods -n istio-system
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 安装</span>
</span></span><span class="line"><span class="cl">kubectl apply -f istio-1.10.3/samples/addons/kiali.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># 或者可以选择直接全部都安装上</span>
</span></span><span class="line"><span class="cl">kubectl apply -f istio-1.10.3/samples/addons/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get svc -n istio-system
</span></span><span class="line"><span class="cl"><span class="c1"># kiali 的PORT：20001，TYPE为 ClusterIP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改 kiali 的 svc</span>
</span></span><span class="line"><span class="cl">kubectl edit svc kiali -n istio-system
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  sessionAffinity: None
</span></span><span class="line"><span class="cl">  type: LoadBalancer  <span class="c1">#把ClusterIP修改为NodePort或者LoadBalancer</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1"># 查看并验证</span>
</span></span><span class="line"><span class="cl">kubectl get svc -n istio-system 
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 kiali 的 ip 和端口，使用浏览器访问</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 进入浏览器后可以测试一下，进入 Graph 页面，选择 istio-system 和 ns1 的 Namespace，可以看到我们现在环境中的拓扑图</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/../../image/a88cd035f9cf4e0381de93ac69b399bd.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
>
<img src="/../../image/f8057c5529654ac091246af54ca1351d.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
><img src="/../../image/1fc389afb0de4656983f3f107404f515.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
></p>
<p>Kiali 的 Graph 数据主要来自两个来源：Prometheus 和 Istio 本身的遥测数据。</p>
<p>Prometheus：Prometheus 是一个开源监控和警报工具，它用于收集和存储 Istio 服务网格中的指标数据。Istio 使用 Envoy 代理收集遥测数据，这些数据随后被 Prometheus 抓取和存储。Kiali 使用这些 Prometheus 数据来生成服务之间的流量、错误率、延迟等指标。</p>
<p>Istio 遥测数据：Istio 服务网格生成的遥测数据包括请求、响应、延迟以及 Envoy 代理的其他性能指标。这些数据由 Istio 组件（例如 Mixer 和 Pilot）以及 Envoy 代理本身生成。Kiali 从这些遥测数据中获取服务拓扑信息，以创建服务之间的依赖关系图。</p>
<p>Kiali 将这两个数据源的信息整合在一起，生成 Graph，它展示了服务网格的拓扑结构、服务之间的流量以及其他性能指标。这有助于用户更好地理解服务之间的依赖关系，发现潜在的性能问题，并优化服务网格配置。</p>
<p><strong>可能失败的原因</strong>
如果你的 Kiali 一直显示 Empty Graph。请关注以下几种可能的情况：</p>
<p>集群版本低于 1.23 ，需要升级 Kubernetes 集群。
安装了 Kubesphere，说多了都是泪，Kubesphere 太重了，笔者花了一晚上时间重新安装集群。
访问的地址不正确，没有配置对 /productpage 的访问地址，请求流量没有打入集群。
Pod 没有被注入 istio-proxy。
你可以在 Kiali 的 Workloads 查看每个负载的 Pod 信息，正常情况应当如下所示：
<img src="/../../image/504be137206f437391cc3567807e23ba.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
>
<strong>修复 Kiali Grafana 问题</strong>
点击右上角的消息，可能会提示配置不正确，因为 kiali 需要从 Grafana 拉取数据。
<img src="/../../image/81807b683c51476bae62b69a779ffe31.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
>
编辑 configmap 。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> kubectl edit configmap kiali -n istio-system
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> grafana:  <span class="se">\n</span>    enabled: <span class="nb">true</span>  <span class="se">\n</span>    url: <span class="se">\&#34;</span>http://grafana.istio-system.svc.cluster.local:3000<span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="se">\ \n</span>    in_cluster_url: <span class="se">\&#34;</span>http://grafana.istio-system.svc.cluster.local:3000<span class="se">\&#34;\n</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">如果上方不行，就添加下方
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> grafana:  <span class="se">\n</span>    enabled: <span class="nb">true</span>  <span class="se">\n</span>    url: <span class="se">\&#34;</span>http://grafana.istio-system.svc.cluster.local:3000<span class="se">\&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/../../image/6ed5e168d3d8422585d8ba4fda71785c.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
>
如果使用的是可视化工具，添加就简单了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">      grafana:  
</span></span><span class="line"><span class="cl">        enabled: <span class="nb">true</span>  
</span></span><span class="line"><span class="cl">        url: <span class="s2">&#34;http://grafana.istio-system.svc.cluster.local:3000&#34;</span>  
</span></span><span class="line"><span class="cl">        in_cluster_url: <span class="s2">&#34;http://grafana.istio-system&gt;.svc.cluster.local:3000&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/../../image/64c509b739c54ac8aa29022ac4047f56.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
>
然后使用 kubectl describe configmap kiali -n istio-system 查看配置是否正确。</p>
<h2 id="5istio核心资源">5、Istio核心资源</h2>
<p>和Kubernetes资源一致，Istio的配置也是通过声明式自定义资源配置来加载的。常用的核心资源有VirtualService、DestinationRule、Gateway、ServiceEntry、Sidecar等。</p>
<p>Gateway 类似 Nginx 需要创建一个反向代理时需要绑定的域名配置。</p>
<p>Istio VistualService 中可以限制外部能够访问的路由地址，</p>
<p>DestinationRule 则可以配置访问的 Pod 策略。</p>
<p>可以为 Istio VistualService 绑定一个 Istio DestinationRule</p>
<p>通过 DestinationRule 我们还可以定义版本子集等，通过更加丰富的策略转发流量。
<img src="/../../image/786e56e6fe884a1e8eacaae5bb6b803b.png"
	
	
	
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
></p>
<ol>
<li><strong>istio-ingressgateway（邮局的入口）：</strong>  当一个请求（邮件）到达你的应用时，它首先会到达istio-ingressgateway。这就像一个邮局的入口，所有的邮件都必须先经过这里。</li>
<li><strong>Gateway（邮局的接收员）：</strong>  Gateway就像是邮局的接收员，它的工作是检查每个进来的请求（邮件），看看它应该被发送到哪里。在你的例子中，Gateway会把所有的请求都发送到<code>bookinfo</code>服务。</li>
<li><strong>VirtualService（邮局的分拣员）：</strong>  当请求（邮件）到达<code>bookinfo</code>服务时，VirtualService就像是一个分拣员，它会根据请求的路径或者其他属性，决定请求应该被发送到哪个服务。在你的例子中，<code>productpage</code>的VirtualService可能会把请求发送到<code>productpage</code>服务。</li>
<li><strong>DestinationRule（邮局的包装员）：</strong>  当请求（邮件）被发送到一个特定的服务时，DestinationRule就像是一个包装员，它会根据规则，决定如何处理这个请求（邮件）。例如，它可能会决定请求应该被发送到哪个版本的服务，或者请求应该如何被负载均衡。</li>
<li><strong>Envoy（邮局的快递员）：</strong>  当<code>productpage</code>服务需要访问其他服务（如<code>reviews</code>）时，它会发送一个请求。这个请求就像是一个新的邮件，它会被Envoy（快递员）拿到，然后根据VirtualService和DestinationRule的规则，被发送到正确的服务。</li>
</ol>
<p>在 Istio 中，VirtualService 和 DestinationRule 是两个关键的自定义资源定义（CRD），它们用于配置和控制服务间的流量路由。</p>
<p>它们之间的关系可以概括为：</p>
<ul>
<li>
<p>VirtualService 定义了流量的路由规则，</p>
</li>
<li>
<p>DestinationRule 定义了<strong>流量到达目的地后如何进行负载分发和连接池管理</strong>。</p>
</li>
</ul>
<p><strong>VirtualService 用于定义流量的路由规则。</strong> 当请求从一个服务到另一个服务时，VirtualService 可以指定如何将流量路由到不同的目的地（例如，不同的服务实例，版本或子集）。VirtualService 还可以根据请求的属性（如请求头、路径、来源等）对流量进行匹配和分发。此外，VirtualService 可以配置复杂的路由行为，如重试、超时和故障注入等。</p>
<p><strong>DestinationRule 被用于控制流量的分发和连接池管理。</strong> DestinationRule 定义了服务的子集（即服务的不同版本或变体），并指定如何根据负载均衡策略（如轮询、随机、最少连接等）将流量分发到这些子集。此外，DestinationRule 还可以配置连接池设置（如最大连接数、空闲超时等）和传输层安全策略（如 TLS 设置）。</p>
<blockquote>
<p>总之，VirtualService 和 DestinationRule 在 Istio 中共同实现了流量的精细控制。VirtualService 用于定义流量的路由规则，而 DestinationRule 则负责处理流量到达目的地后的负载分发和连接池管理。
Istio 的做法是 Gateway 监控入口流量，
通过 VirtualService 设置<strong>流量进入的策略</strong>，并指向 Service。
而 DestinationRule 则定义了<strong>流量流向 Pod 的策略</strong>。</p>
</blockquote>
<h3 id="virtualservice">VirtualService</h3>
<p>VirtualService（虚拟服务）和Kubernetes的Service类似，但是两种并不是对等的资源类型。VirtualService基于Istio和对应平台提供的基本连通性和服务发现能力，将请求路由到对应的目标。每一个VirtualService包含一组路由规则，Istio将每个请求根据路由匹配到指定的目标地址。</p>
<p>和Kubernetes的Service不同的是，Kubernetes的Service只提供了最简单的服务发现和负载均衡的能力，如果想要实现更加细粒度的流量分发，比如灰度、蓝绿等流量管理，Kubernetes的Service显得比较吃力或者无法实现，而VirtualService在流量管理方面有着比较好的灵活性和有效性，可以在代码零侵入的情况下实现更加丰富的流量管理，比如灰度等。</p>
<p>一个典型的用例是将流量发送到被指定服务的不同版本，比如80%的流量发送给v1版本，20%的流量发送给新版本。或者将某个登录用户指定到新版本，其他用户指定到旧版本，可以实现AB测试等功能。</p>
<p>接下来看一个VirtualService的配置示例，根据特定用户将流量分发至不同版本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apiVersion: networking.istio.io/v1beta1
</span></span><span class="line"><span class="cl">kind: VirtualService
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: reviews
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  hosts:
</span></span><span class="line"><span class="cl">  - reviews
</span></span><span class="line"><span class="cl">  http:
</span></span><span class="line"><span class="cl">  - match:
</span></span><span class="line"><span class="cl">    - headers:
</span></span><span class="line"><span class="cl">        end-user:
</span></span><span class="line"><span class="cl">          exact: jason
</span></span><span class="line"><span class="cl">    route:
</span></span><span class="line"><span class="cl">    - destination:
</span></span><span class="line"><span class="cl">        host: reviews
</span></span><span class="line"><span class="cl">        subset: v2
</span></span><span class="line"><span class="cl">  - route:
</span></span><span class="line"><span class="cl">    - destination:
</span></span><span class="line"><span class="cl">        host: reviews
</span></span><span class="line"><span class="cl">        subset: v3
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面参数说明:</p>
<ul>
<li>apiVersion：对应的API版本</li>
<li>kind：创建的资源类型，和Kubernetes的Service类似</li>
<li>metadata：元数据，和Kubernetes资源类似，可以定义annotations、labels、name等</li>
<li>metadata.name：VirtualService的名称</li>
<li>spec：关于VirtualService的定义</li>
<li>spec.hosts：VirtualService的主机，即用户指定的目标或路由规则的目标，客户端向服务端发送请求时使用的一个或多个地址，可以是IP地址、DNS名称，或者是依赖于底层平台的一个简称（比如Kubernetes的Service短名称），隐式或显式地指向一个完全限定域名（FQDN），当然也可以是一个通配符&quot;*&quot;</li>
<li>spec.http：路由规则配置，用来指定流量的路由行为，通过该处的配置将HTTP/1.1、HTTP2和gRPC等流量发送到hosts字段指定的目标</li>
<li>spec.http[].match：路由规则的条件，可以根据一些条件制定更加细粒度的路由。比如当前示例的headers，表示匹配headers里面的end-user字段，并且值为jason的请求</li>
<li>route：路由规则，destination字段指定了符合此条件的流量的实际目标地址。比如该示例的请求，如果请求头包含end-user=jason字段，则该请求会被路由到reviews的v2版本。如果没有匹配到该请求头，则流量会被路由到v3版本（版本由DestinationRule划分）</li>
</ul>
<p><strong>注意：VirtualService路由规则按照从上往下的顺序进行匹配，第一个规则有最高的优先级，如果不满足第一个路由规则，则流量会选择下一个规则。</strong></p>
<p>除了上述的路由匹配外，VirtualService也支持域名+路径的方式进行路由。比如后端有两个服务，一个是reviews，通过<a class="link" href="https://link.zhihu.com/?target=http%3A//bookinfo.com/reviews"  target="_blank" rel="noopener"
    >http://</a>​**<a class="link" href="https://link.zhihu.com/?target=http%3A//bookinfo.com/reviews"  target="_blank" rel="noopener"
    >bookinfo.com/reviews</a><strong>访问；另一个是ratings，通过<a class="link" href="https://link.zhihu.com/?target=http%3A//bookinfo.com/ratings"  target="_blank" rel="noopener"
    >http://</a>​</strong><a class="link" href="https://link.zhihu.com/?target=http%3A//bookinfo.com/ratings"  target="_blank" rel="noopener"
    >bookinfo.com/ratings</a>**访问。此时可以配置VirtualService如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apiVersion: networking.istio.io/v1beta1
</span></span><span class="line"><span class="cl">kind: VirtualService
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: reviews
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  hosts:
</span></span><span class="line"><span class="cl">  - bookinfo.com
</span></span><span class="line"><span class="cl">  http:
</span></span><span class="line"><span class="cl">  - match:
</span></span><span class="line"><span class="cl">    - uri:
</span></span><span class="line"><span class="cl">       prefix: /reviews
</span></span><span class="line"><span class="cl">    route:
</span></span><span class="line"><span class="cl">    - destination:
</span></span><span class="line"><span class="cl">        host: reviews
</span></span><span class="line"><span class="cl">  - match:
</span></span><span class="line"><span class="cl">    - uri:
</span></span><span class="line"><span class="cl">       prefix: /ratings
</span></span><span class="line"><span class="cl">    route:
</span></span><span class="line"><span class="cl">    - destination:
</span></span><span class="line"><span class="cl">        host: ratings
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="destinationrule">DestinationRule</h3>
<p>将VirtualService理解为Kubernetes Service层面，DestinationRule理解为Service后端真实的目标地址，即VirtualService用于Service层面的路由管控，DestinationRule用于对后端真实的服务再做进一步的划分。比如存在一个Service名为paycenter，指向后端多个paycenter的Pod（该Pod可能是不同的Deployment创建的），而DestinationRule可以对后端的多个Pod区分新旧版本，划分成不同的subnet，之后VirtualService可以针对不同的版本进行流量管控。</p>
<p>在下面的示例中，目标规则为 my-svc 目标服务配置了 3 个具有不同负载均衡策略的子集：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apiVersion: networking.istio.io/v1beta1
</span></span><span class="line"><span class="cl">kind: DestinationRule
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: my-destination-rule
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  host: my-svc
</span></span><span class="line"><span class="cl">  trafficPolicy:
</span></span><span class="line"><span class="cl">    loadBalancer:
</span></span><span class="line"><span class="cl">      simple: RANDOM
</span></span><span class="line"><span class="cl">  subsets:
</span></span><span class="line"><span class="cl">  - name: v1
</span></span><span class="line"><span class="cl">    labels:
</span></span><span class="line"><span class="cl">      version: v1
</span></span><span class="line"><span class="cl">  - name: v2
</span></span><span class="line"><span class="cl">    labels:
</span></span><span class="line"><span class="cl">      version: v2
</span></span><span class="line"><span class="cl">    trafficPolicy:
</span></span><span class="line"><span class="cl">      loadBalancer:
</span></span><span class="line"><span class="cl">        simple: ROUND_ROBIN
</span></span><span class="line"><span class="cl">  - name: v3
</span></span><span class="line"><span class="cl">    labels:
</span></span><span class="line"><span class="cl">      version: v3
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面参数说明：</p>
<ul>
<li><code>trafficPolicy</code>：这是一个用于定义流量策略的部分。在这个例子中，定义了三个子集（<code>subsets</code>）的流量策略</li>
<li><code>loadBalancer</code>：用于指定负载均衡算法的配置</li>
<li><code>subsets</code>：这里定义了三个子集（v1、v2、v3），每个子集通过 <code>labels</code> 来选择对应版本的服务实例。第一个子集 <code>v1</code> 对应版本为 <code>v1</code> 的服务实例，并使用 <code>simple: RANDOM</code> 负载均衡策略。这意味着请求将随机路由到 <code>v1</code> 子集中的服务实例；第二个子集 <code>v2</code> 对应版本为 <code>v2</code> 的服务实例，并使用 <code>simple: ROUND_ROBIN</code> 负载均衡策略。这意味着请求将以循环方式（Round Robin）路由到 <code>v2</code> 子集中的服务实例；第三个子集 <code>v3</code> 对应版本为 <code>v3</code> 的服务实例。在这里没有指定负载均衡策略，因此将使用默认的负载均衡策略。</li>
</ul>
<p>每个子集都是基于一个或多个 <code>labels</code> 定义的，在 Kubernetes 中它是附加到像 Pod 这种对象上的键/值对。这些标签应用于 Kubernetes 服务的 Deployment 并作为 <code>metadata</code> 来识别不同的版本。</p>
<p>除了定义子集之外，此目标规则对于所有子集都有默认的流量策略，而对于该子集， 则有特定于子集的策略覆盖它。定义在 <code>subsets</code> 上的默认策略，为 <code>v1</code> 和 <code>v3</code> 子集设置了一个简单的随机负载均衡器。在 <code>v2</code> 策略中，轮询负载均衡器被指定在相应的子集字段上</p>
<p>默认情况下，Istio 使用轮询的负载均衡策略，实例池中的每个实例依次获取请求。Istio 同时支持如下的负载均衡模型， 可以在 <code>DestinationRule</code> 中为流向某个特定服务或服务子集的流量指定这些模型。</p>
<ul>
<li>随机：请求以随机的方式转发到池中的实例</li>
<li>权重：请求根据指定的百分比转发到池中的实例</li>
<li>最少请求：请求被转发到最少被访问的实例</li>
</ul>
<h3 id="gateway">Gateway</h3>
<p>Istio同样支持网关功能，可以使用Gateway在网格最外层接收HTTP/TCP流量，并将流量转发到网格内的某个服务。</p>
<p>在安装Istio时，可以在istio-system命名空间下安装ingressgateway的Pod，用来充当Ingress Gateway。其中Ingress Gateway为入口网关，可以将网格内的服务“暴露”出去，一般和VirtualService配置使用，并配置一个可以被外部服务访问的域名，从而外部服务可以通过该域名访问网格内的服务。</p>
<p>配置Gateway和Istio其他资源类似，kind指定为Gateway即可。比如配置一个VirtualService和Gateway实现对网格内的某个服务进行发布，首先创建一个Gateway，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">apiVersion: networking.istio.io/v1beta1
</span></span><span class="line"><span class="cl">kind: Gateway
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: httpbin-gateway
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    istio: ingressgateway
</span></span><span class="line"><span class="cl">  servers:
</span></span><span class="line"><span class="cl">  - port:
</span></span><span class="line"><span class="cl">      number: 80
</span></span><span class="line"><span class="cl">      name: http
</span></span><span class="line"><span class="cl">      protocol: HTTP
</span></span><span class="line"><span class="cl">    hosts:
</span></span><span class="line"><span class="cl">    - &#34;httpbin.example.com&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面参数说明：</p>
<ul>
<li>selector：必选字段。选择由哪个ingressgateway的Pod发布服务，默认为istio-system命名空间下具有istio=ingressgateway标签的Pod</li>
<li>servers：必选字段。表示发布的服务列表，用于描述发布服务的属性，比如代理监听的端口、协议和端口的名称等</li>
<li>hosts：必选字段。Gateway发布的服务地址，也就是允许用户访问的域名，可以配置为“*”，表示任何域名都可以被代理，本示例为http://httpbin.example.com可被路由</li>
</ul>
<p>之后配置一个VirtualService与之匹配，即可通过该域名访问VirtualService配置的服务。比如将http://httpbin.example.com的/status和/delay代理到httpbin服务的8000端口：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">apiVersion: networking.istio.io/v1beta1
</span></span><span class="line"><span class="cl">kind: VirtualService
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: httpbin
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  hosts:
</span></span><span class="line"><span class="cl">  - &#34;httpbin.example.com&#34;
</span></span><span class="line"><span class="cl">  gateways:
</span></span><span class="line"><span class="cl">  - httpbin-gateway
</span></span><span class="line"><span class="cl">  http:
</span></span><span class="line"><span class="cl">  - match:
</span></span><span class="line"><span class="cl">    - uri:
</span></span><span class="line"><span class="cl">       prefix: /status
</span></span><span class="line"><span class="cl">    - uri:
</span></span><span class="line"><span class="cl">       prefix: /delay
</span></span><span class="line"><span class="cl">    route:
</span></span><span class="line"><span class="cl">    - destination:
</span></span><span class="line"><span class="cl">        host: httpbin
</span></span><span class="line"><span class="cl">        port:
</span></span><span class="line"><span class="cl">          number: 8000
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后将域名解析至ingressgateway Pod的Service上即可访问该域名。</p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/istio/">istio</a>
        
            <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>未来的你，会感谢今天仍在努力奋斗的你</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/202404111830/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/73.jpg" loading="lazy" data-key="202404111830" data-hash="/../../title_pic/73.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Ingress配置优化和追踪</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202308311841/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/43.jpg" loading="lazy" data-key="202308311841" data-hash="/../../title_pic/43.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">掌握Kubernetes API：释放容器编排的潜力</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202305112139/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/06.jpg" loading="lazy" data-key="202305112139" data-hash="/../../title_pic/06.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Calico的BGP打通Kubernetes网络和局域网</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202409091543/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/48.jpg" loading="lazy" data-key="202409091543" data-hash="/../../title_pic/48.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Kubernetes部署(haproxy&#43;keepalived)高可用环境和办公网络打通</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/202408161519/">
        
        
            <div class="article-image">
                
                    <img src="/../../title_pic/60.jpg" loading="lazy" data-key="202408161519" data-hash="/../../title_pic/60.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">云原生时代的数据守护者：Velero 备份与迁移实战</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="nangongchengfeng/nangongchengfeng.github.io"
    data-repo-id="R_kgDOIwWL4Q"
    data-category="Announcements"
    data-category-id="DIC_kwDOIwWL4c4Cg8Rs"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('light');
            } else {
                setGiscusTheme('dark_dimmed');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2018 - 
        
        2024 南宫乘风
    </section>
    
    <section class="powerby">
        
            <a href="https://beian.miit.gov.cn/" target="_blank">备案号</a> <a href="https://beian.miit.gov.cn/" target="_blank">陕ICP备2021004364号-1</a> <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
