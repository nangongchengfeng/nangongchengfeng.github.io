<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='CKS æŒ‡çš„æ˜¯ Certified Kubernetes Security Specialistï¼Œæ˜¯ Kubernetes å®‰å…¨è®¤è¯è€ƒè¯•ï¼Œç”±äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š (CNCF) ç®¡ç†å’Œæ¨å‡ºã€‚CKS è€ƒè¯•æ—¨åœ¨è¯„ä¼°ä¸ªäººåœ¨ Kubernetes å®‰å…¨æ–¹é¢çš„çŸ¥è¯†å’ŒæŠ€èƒ½ï¼ŒåŒ…æ‹¬è®¾è®¡å’Œæ„å»ºå®‰å…¨çš„å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€ä¿æŠ¤ Kubernetes å¹³å°å’Œä¸»æœºå®‰å…¨ã€é˜²èŒƒç½‘ç»œæ”»å‡»å’Œæ•°æ®æ³„éœ²ç­‰æ–¹é¢ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚'>
<title>Kubernetesè€ƒè¯•é¢˜ï¼ˆCKSï¼‰</title>

<link rel='canonical' href='https://www.ownit.top/p/kubernetes%E8%80%83%E8%AF%95%E9%A2%98cks/'>

<link rel="stylesheet" href="/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css"><meta property='og:title' content='Kubernetesè€ƒè¯•é¢˜ï¼ˆCKSï¼‰'>
<meta property='og:description' content='CKS æŒ‡çš„æ˜¯ Certified Kubernetes Security Specialistï¼Œæ˜¯ Kubernetes å®‰å…¨è®¤è¯è€ƒè¯•ï¼Œç”±äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š (CNCF) ç®¡ç†å’Œæ¨å‡ºã€‚CKS è€ƒè¯•æ—¨åœ¨è¯„ä¼°ä¸ªäººåœ¨ Kubernetes å®‰å…¨æ–¹é¢çš„çŸ¥è¯†å’ŒæŠ€èƒ½ï¼ŒåŒ…æ‹¬è®¾è®¡å’Œæ„å»ºå®‰å…¨çš„å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€ä¿æŠ¤ Kubernetes å¹³å°å’Œä¸»æœºå®‰å…¨ã€é˜²èŒƒç½‘ç»œæ”»å‡»å’Œæ•°æ®æ³„éœ²ç­‰æ–¹é¢ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚'>
<meta property='og:url' content='https://www.ownit.top/p/kubernetes%E8%80%83%E8%AF%95%E9%A2%98cks/'>
<meta property='og:site_name' content='å—å®«ä¹˜é£'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='kubernetes' /><meta property='article:tag' content='å®¹å™¨' /><meta property='article:tag' content='äº‘åŸç”Ÿ' /><meta property='article:published_time' content='2023-03-31T18:10:28&#43;00:00'/><meta property='article:modified_time' content='2023-03-31T18:10:28&#43;00:00'/><meta property='og:image' content='http://image.ownit.top/4kdongman/02.jpg' />
<meta name="twitter:title" content="Kubernetesè€ƒè¯•é¢˜ï¼ˆCKSï¼‰">
<meta name="twitter:description" content="CKS æŒ‡çš„æ˜¯ Certified Kubernetes Security Specialistï¼Œæ˜¯ Kubernetes å®‰å…¨è®¤è¯è€ƒè¯•ï¼Œç”±äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š (CNCF) ç®¡ç†å’Œæ¨å‡ºã€‚CKS è€ƒè¯•æ—¨åœ¨è¯„ä¼°ä¸ªäººåœ¨ Kubernetes å®‰å…¨æ–¹é¢çš„çŸ¥è¯†å’ŒæŠ€èƒ½ï¼ŒåŒ…æ‹¬è®¾è®¡å’Œæ„å»ºå®‰å…¨çš„å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€ä¿æŠ¤ Kubernetes å¹³å°å’Œä¸»æœºå®‰å…¨ã€é˜²èŒƒç½‘ç»œæ”»å‡»å’Œæ•°æ®æ³„éœ²ç­‰æ–¹é¢ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://image.ownit.top/4kdongman/02.jpg' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu227367ba8544f2fc7811ed9508937bec_102665_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">å—å®«ä¹˜é£</a></h1>
            <h2 class="site-description">å½“ä½ çš„æ‰åæ’‘ä¸èµ·ä½ çš„é‡å¿ƒæ—¶ï¼Œåªæœ‰é™ä¸‹å¿ƒå­¦ä¹ æ‰æ˜¯å”¯ä¸€çš„å‡ºè·¯</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://blog.csdn.net/heian_99'
                        target="_blank"
                        title="CSDN"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="32.000000pt" height="32.000000pt" viewBox="0 0 32.000000 32.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,32.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M0 160 l0 -160 160 0 160 0 0 160 0 160 -160 0 -160 0 0 -160z m225
108 c24 -11 34 -41 16 -52 -4 -3 -17 1 -27 9 -43 32 -95 3 -109 -62 -5 -27 -2
-37 19 -58 29 -29 62 -32 94 -9 25 17 42 11 42 -15 0 -27 -51 -45 -107 -38
-70 8 -97 42 -91 115 4 48 10 60 41 89 39 35 76 42 122 21z"/>
</g>
</svg>

                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/nangongchengfeng/'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E9%93%BE/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>å‹é“¾</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#cksè€ƒè¯•æ¦‚è¦">CKSè€ƒè¯•æ¦‚è¦ï¼š</a></li>
    <li><a href="#1kube-bench-ä¿®å¤ä¸å®‰å…¨é¡¹">1ã€kube-bench ä¿®å¤ä¸å®‰å…¨é¡¹</a></li>
    <li><a href="#2podæŒ‡å®šserviceaccount">2ã€PodæŒ‡å®šServiceAccount</a></li>
    <li><a href="#3é»˜è®¤ç½‘ç»œç­–ç•¥">3ã€é»˜è®¤ç½‘ç»œç­–ç•¥</a></li>
    <li><a href="#4rbac---rolebinding">4ã€RBAC - RoleBinding</a></li>
    <li><a href="#5æ—¥å¿—å®¡è®¡-log-audit">5ã€æ—¥å¿—å®¡è®¡ log audit</a></li>
    <li><a href="#6åˆ›å»º-secret">6ã€åˆ›å»º Secret</a></li>
    <li><a href="#7dockerfileæ£€æµ‹">7ã€Dockerfileæ£€æµ‹</a></li>
    <li><a href="#8æ²™ç®±è¿è¡Œå®¹å™¨-gvisor">8ã€æ²™ç®±è¿è¡Œå®¹å™¨ gVisor</a></li>
    <li><a href="#9å®¹å™¨å®‰å…¨åˆ é™¤ç‰¹æƒpod">9ã€å®¹å™¨å®‰å…¨ï¼Œåˆ é™¤ç‰¹æƒPod</a></li>
    <li><a href="#10ç½‘ç»œç­–ç•¥-networkpolicy">10ã€ç½‘ç»œç­–ç•¥ NetworkPolicy</a></li>
    <li><a href="#11trivy-æ‰«æé•œåƒå®‰å…¨æ¼æ´">11ã€Trivy æ‰«æé•œåƒå®‰å…¨æ¼æ´</a></li>
    <li><a href="#12apparmor">12ã€AppArmor</a></li>
    <li><a href="#13sysdig--falco">13ã€Sysdig &amp; falco</a></li>
    <li><a href="#14pod-å®‰å…¨ç­–ç•¥-psp">14ã€Pod å®‰å…¨ç­–ç•¥-PSP</a></li>
    <li><a href="#15å¯ç”¨api-serverè®¤è¯">15ã€å¯ç”¨API serverè®¤è¯</a></li>
    <li><a href="#16imagepolicywebhookå®¹å™¨é•œåƒæ‰«æ">16ã€ImagePolicyWebhookå®¹å™¨é•œåƒæ‰«æ</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/kubernetes%E8%80%83%E8%AF%95%E9%A2%98cks/">
                
                    <img src="http://image.ownit.top/4kdongman/02.jpg" loading="lazy" alt="Featured image of post Kubernetesè€ƒè¯•é¢˜ï¼ˆCKSï¼‰" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/kubernetes%E5%BA%94%E7%94%A8/" >
                Kubernetesåº”ç”¨
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/kubernetes%E8%80%83%E8%AF%95%E9%A2%98cks/">Kubernetesè€ƒè¯•é¢˜ï¼ˆCKSï¼‰</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            CKS æŒ‡çš„æ˜¯ Certified Kubernetes Security Specialistï¼Œæ˜¯ Kubernetes å®‰å…¨è®¤è¯è€ƒè¯•ï¼Œç”±äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š (CNCF) ç®¡ç†å’Œæ¨å‡ºã€‚CKS è€ƒè¯•æ—¨åœ¨è¯„ä¼°ä¸ªäººåœ¨ Kubernetes å®‰å…¨æ–¹é¢çš„çŸ¥è¯†å’ŒæŠ€èƒ½ï¼ŒåŒ…æ‹¬è®¾è®¡å’Œæ„å»ºå®‰å…¨çš„å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€ä¿æŠ¤ Kubernetes å¹³å°å’Œä¸»æœºå®‰å…¨ã€é˜²èŒƒç½‘ç»œæ”»å‡»å’Œæ•°æ®æ³„éœ²ç­‰æ–¹é¢ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Mar 31, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 16 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="cksè®¤è¯">CKSè®¤è¯</h1>
<p>CKS æŒ‡çš„æ˜¯ Certified Kubernetes Security Specialistï¼Œæ˜¯ Kubernetes å®‰å…¨è®¤è¯è€ƒè¯•ï¼Œç”±äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š (CNCF) ç®¡ç†å’Œæ¨å‡ºã€‚CKS è€ƒè¯•æ—¨åœ¨è¯„ä¼°ä¸ªäººåœ¨ Kubernetes å®‰å…¨æ–¹é¢çš„çŸ¥è¯†å’ŒæŠ€èƒ½ï¼ŒåŒ…æ‹¬è®¾è®¡å’Œæ„å»ºå®‰å…¨çš„å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€ä¿æŠ¤ Kubernetes å¹³å°å’Œä¸»æœºå®‰å…¨ã€é˜²èŒƒç½‘ç»œæ”»å‡»å’Œæ•°æ®æ³„éœ²ç­‰æ–¹é¢ã€‚</p>
<p>é€šè¿‡ CKS è®¤è¯å¯ä»¥è¯æ˜æ‚¨å…·å¤‡ Kubernetes å®‰å…¨æ–¹é¢çš„ä¸“ä¸šçŸ¥è¯†å’ŒæŠ€èƒ½ï¼Œå¹¶ä¸ºä¼ä¸šæä¾› Kubernetes å®‰å…¨æ–¹é¢çš„ä¸“å®¶å’Œé¡¾é—®ã€‚CKS è®¤è¯éœ€è¦å…ˆå–å¾— CKA (Certified Kubernetes Administrator) è®¤è¯ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿›ä¸€æ­¥è€ƒæ ¸ Kubernetes å®‰å…¨æ–¹é¢çš„èƒ½åŠ›ã€‚</p>
<p>ä¸ºäº†å‡†å¤‡ CKS è€ƒè¯•ï¼Œæ‚¨å¯ä»¥å‚åŠ å®˜æ–¹ç»„ç»‡çš„åŸ¹è®­è¯¾ç¨‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è‡ªå­¦æ¥è·å¾—ç›¸å…³çŸ¥è¯†ã€‚è€ƒè¯•å†…å®¹æ¶µç›– Kubernetes å®‰å…¨çš„å„ä¸ªæ–¹é¢ï¼Œä¾‹å¦‚èº«ä»½éªŒè¯å’Œæˆæƒã€ç½‘ç»œå®‰å…¨ã€åŠ å¯†ã€æ¼æ´ç®¡ç†ç­‰ç­‰ã€‚</p>
<h1 id="cksé¢˜åº“">CKSé¢˜åº“</h1>
<h2 id="cksè€ƒè¯•æ¦‚è¦">CKSè€ƒè¯•æ¦‚è¦ï¼š</h2>
<p>è€ƒè¯•æ¨¡å¼ï¼šçº¿ä¸Šè€ƒè¯•
è€ƒè¯•æ—¶é—´ï¼š2å°æ—¶
é¢˜ç›®æ•°é‡ï¼š16é¢˜
åˆ†æ•°ï¼šæ€»100åˆ†ï¼Œ66åˆ†åŠæ ¼
é¢˜ç›®å˜åŒ–ï¼šæ¯æ¬¡è€ƒé¢˜ä¼šå¯¹é‡Œé¢æ¶‰åŠçš„å‘½åç©ºé—´ã€èµ„æºåç§°ä¸ªåˆ«å¾®è°ƒï¼Œè¿˜æœ‰é¢˜ç›®é¡ºåºã€‚</p>
<h2 id="1kube-bench-ä¿®å¤ä¸å®‰å…¨é¡¹">1ã€kube-bench ä¿®å¤ä¸å®‰å…¨é¡¹</h2>
<p><a class="link" href="https://kubernetes.io/zh/docs/reference/config-api/kubelet-config.v1beta1/"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/reference/config-api/kubelet-config.v1beta1/</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Context é’ˆå¯¹ kubeadm åˆ›å»ºçš„ cluster è¿è¡Œ CIS åŸºå‡†æµ‹è¯•å·¥å…·æ—¶ï¼Œ å‘ç°äº†å¤šä¸ªå¿…é¡»ç«‹å³è§£å†³çš„é—®é¢˜ã€‚ Task
</span></span><span class="line"><span class="cl">é€šè¿‡é…ç½®ä¿®å¤æ‰€æœ‰é—®é¢˜å¹¶é‡æ–°å¯åŠ¨å—å½±å“çš„ç»„ä»¶ä»¥ç¡®ä¿æ–°çš„è®¾ç½®ç”Ÿæ•ˆã€‚ ä¿®å¤é’ˆå¯¹ API æœåŠ¡å™¨å‘ç°çš„æ‰€æœ‰ä»¥ä¸‹è¿è§„è¡Œä¸ºï¼š 1.2.7 Ensure
</span></span><span class="line"><span class="cl">that the --authorization-mode argument is not <span class="nb">set</span> to AlwaysAllow 1.2.8
</span></span><span class="line"><span class="cl">Ensure that the --authorization-mode argument includes Node 1.2.9
</span></span><span class="line"><span class="cl">Ensure that the --authorization-mode argument includes RBAC 1.2.18
</span></span><span class="line"><span class="cl">Ensure that the --insecure-bind-address argument is not <span class="nb">set</span> 1.2.19
</span></span><span class="line"><span class="cl">Ensure that the --insecure-port argument is <span class="nb">set</span> to <span class="m">0</span> FAIL FAIL FAIL
</span></span><span class="line"><span class="cl">FAIL FAIL ä¿®å¤é’ˆå¯¹ kubelet å‘ç°çš„æ‰€æœ‰ä»¥ä¸‹è¿è§„è¡Œä¸ºï¼š Fix all of the following
</span></span><span class="line"><span class="cl">violations that were found against the kubelet: 4.2.1 Ensure that the
</span></span><span class="line"><span class="cl">anonymous-auth argument is <span class="nb">set</span> to <span class="nb">false</span> 4.2.2 Ensure that the
</span></span><span class="line"><span class="cl">â€“authorization-mode argument is not <span class="nb">set</span> to AlwaysAllow FAIL FAIL æ³¨æ„ï¼šå°½å¯èƒ½ä½¿ç”¨ Webhook èº«ä»½éªŒè¯/æˆæƒã€‚ ä¿®å¤é’ˆå¯¹ etcd å‘ç°çš„æ‰€æœ‰ä»¥ä¸‹è¿è§„è¡Œä¸ºï¼š Fix all of the
</span></span><span class="line"><span class="cl">following violations that were found against etcd: 2.2 Ensure that the
</span></span><span class="line"><span class="cl">â€“client-cert-auth argument is <span class="nb">set</span> to <span class="nb">true</span> FAIL
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§£è¯»ï¼šä½¿ç”¨kube-benchå·¥å…·æ£€æŸ¥é›†ç¾¤ç»„ä»¶é…ç½®æ–‡ä»¶å­˜åœ¨çš„é—®é¢˜ä¸ä¿®å¤ï¼Œå¹¶é‡å¯å¯¹åº”ç»„ä»¶ç¡®ä¿æ–°é…ç½®ç”Ÿæ•ˆã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#åˆ‡æ¢ç¯å¢ƒ</span>
</span></span><span class="line"><span class="cl">kubectl config use-context KSCS00201 
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">ssh master01 
</span></span><span class="line"><span class="cl">sudo -i 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ä¿®æ”¹api-server 
</span></span><span class="line"><span class="cl">kube-bench master 
</span></span><span class="line"><span class="cl">mkdir bak1 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cp /etc/kubernetes/manifests/kube-apiserver.yaml    bak1/ 
</span></span><span class="line"><span class="cl">vim /etc/kubernetes/manifests/kube-apiserver.yaml 
</span></span><span class="line"><span class="cl"><span class="c1">#ä¿®æ”¹ã€æ·»åŠ ã€åˆ é™¤ç›¸å…³å†…å®¹ </span>
</span></span><span class="line"><span class="cl"><span class="c1">#ä¿®æ”¹authorization-modeï¼Œæ³¨æ„Nodeå’ŒRBACä¹‹é—´çš„ç¬¦å·æ˜¯è‹±æ–‡çŠ¶æ€çš„é€—å·ï¼Œè€Œä¸æ˜¯ç‚¹ã€‚ </span>
</span></span><span class="line"><span class="cl">    - --authorization-mode<span class="o">=</span>Node,RBAC 
</span></span><span class="line"><span class="cl"><span class="c1">#åˆ é™¤insecure-bind-addressï¼Œè€ƒè¯•ä¸­ï¼Œæœ‰å¯èƒ½æœ¬æ¥å°±æ²¡å†™è¿™è¡Œã€‚ </span>
</span></span><span class="line"><span class="cl">    - --insecure-bind-address<span class="o">=</span>0.0.0.0 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ä¿®æ”¹kubelet
</span></span><span class="line"><span class="cl"><span class="c1">#å¯ä»¥ä½¿ç”¨è¿™æ¡å‘½ä»¤æŸ¥ï¼Œè¦è®°ä½ </span>
</span></span><span class="line"><span class="cl">kube-bench node 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ä¿®æ”¹  /var/lib/kubelet/config.yaml 
</span></span><span class="line"><span class="cl">apiVersion: kubelet.config.k8s.io/v1beta1 
</span></span><span class="line"><span class="cl">authentication: 
</span></span><span class="line"><span class="cl">  anonymous:          <span class="c1">#ä¿®æ”¹anonymousä¸‹çš„ï¼Œå°†trueæ”¹ä¸ºfalse </span>
</span></span><span class="line"><span class="cl">    enabled: <span class="nb">false</span>       <span class="c1">#æ”¹ä¸ºfalse </span>
</span></span><span class="line"><span class="cl">  webhook: 
</span></span><span class="line"><span class="cl">    cacheTTL: 0s 
</span></span><span class="line"><span class="cl">    enabled: <span class="nb">true</span> 
</span></span><span class="line"><span class="cl">  x509: 
</span></span><span class="line"><span class="cl">    clientCAFile: /etc/kubernetes/pki/ca.crt 
</span></span><span class="line"><span class="cl">authorization:           <span class="c1">#ä¿®æ”¹authorizationä¸‹çš„ </span>
</span></span><span class="line"><span class="cl">  mode: Webhook   <span class="c1">#æ”¹ä¸ºWebhook </span>
</span></span><span class="line"><span class="cl">  webhook: 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ä¿®æ”¹etcd 
</span></span><span class="line"><span class="cl"><span class="c1">#å¯ä»¥ä½¿ç”¨è¿™æ¡å‘½ä»¤æŸ¥ï¼Œè¦è®°ä½ </span>
</span></span><span class="line"><span class="cl">kube-bench 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ä¿®æ”¹ä¹‹å‰ï¼Œå¤‡ä»½ä¸€ä¸‹é…ç½®æ–‡ä»¶ã€‚ 
</span></span><span class="line"><span class="cl">mkdir bak1 
</span></span><span class="line"><span class="cl">cp /etc/kubernetes/manifests/etcd.yaml    bak1/ 
</span></span><span class="line"><span class="cl">vim /etc/kubernetes/manifests/etcd.yaml 
</span></span><span class="line"><span class="cl">ä¿®æ”¹ 
</span></span><span class="line"><span class="cl">    - --client-cert-auth<span class="o">=</span><span class="nb">true</span>     <span class="c1">#ä¿®æ”¹ä¸ºtrue </span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ä¿®æ”¹å®Œæˆåï¼Œç­‰å¾…2åˆ†é’Ÿï¼Œå†æ£€æŸ¥ä¸€ä¸‹æ‰€æœ‰podï¼Œç¡®ä¿æ¨¡æ‹Ÿç¯å¢ƒé‡Œçš„æ‰€æœ‰podéƒ½æ­£å¸¸ã€‚ 
</span></span><span class="line"><span class="cl">kubectl get pod -A 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºrootï¼Œé€€å›åˆ°candidate@master01 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºmaster01ï¼Œé€€å›åˆ°candidate@node01 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2podæŒ‡å®šserviceaccount">2ã€PodæŒ‡å®šServiceAccount</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">1. åœ¨ç°æœ‰ namespace qa ä¸­åˆ›å»ºä¸€ä¸ªåä¸º backend-sa çš„æ–° ServiceAccountï¼Œ ç¡®ä¿æ­¤
</span></span><span class="line"><span class="cl">ServiceAccount ä¸è‡ªåŠ¨æŒ‚è½½ API å‡­æ®ã€‚ 
</span></span><span class="line"><span class="cl">2. ä½¿ç”¨ /cks/sa/pod1.yaml ä¸­çš„æ¸…å•æ–‡ä»¶æ¥åˆ›å»ºä¸€ä¸ª Podã€‚
</span></span><span class="line"><span class="cl">3. æœ€åï¼Œæ¸…ç† namespace qa ä¸­ä»»ä½•æœªä½¿ç”¨çš„ ServiceAccountã€‚
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-service-account/#%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B4%A6%E6%88%B7%E8%AE%BF%E9%97%AE-api-%E6%9C%8D%E5%8A%A1%E5%99%A8"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-service-account/#%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B4%A6%E6%88%B7%E8%AE%BF%E9%97%AE-api-%E6%9C%8D%E5%8A%A1%E5%99%A8</a></p>
<p><img src="/images/1680578239537.png"
	
	
	
	loading="lazy"
	
		alt="1680578239537"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSCH0030</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span>  åˆ›å»ºServiceAccount 
</span></span><span class="line"><span class="cl">vi qa-ns.yaml 
</span></span><span class="line"><span class="cl">æ ¹æ®å®˜ç½‘ä¿®æ”¹å¦‚ä¸‹å†…å®¹ 
</span></span><span class="line"><span class="cl">apiVersion: v1 
</span></span><span class="line"><span class="cl">kind: ServiceAccount 
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: backend-sa     <span class="c1">#ä¿®æ”¹name </span>
</span></span><span class="line"><span class="cl">  namespace: qa         <span class="c1">#æ³¨æ„æ·»åŠ namespace </span>
</span></span><span class="line"><span class="cl">automountServiceAccountToken: <span class="nb">false</span>   <span class="c1">#ä¿®æ”¹ä¸ºfalseï¼Œè¡¨ç¤ºä¸è‡ªåŠ¨æŒ‚è½½  secret </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">kubectl apply -f qa-ns.yaml 
</span></span><span class="line"><span class="cl">kubectl get sa -n qa 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">2</span> åˆ›å»ºPodä½¿ç”¨è¯¥ServiceAccount 
</span></span><span class="line"><span class="cl">vi /cks/sa/pod1.yaml 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ä¿®æ”¹å¦‚ä¸‹å†…å®¹ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: backend 
</span></span><span class="line"><span class="cl">  namespace: qa     <span class="c1">#æ³¨æ„å‘½åç©ºé—´æ˜¯å¦å¯¹ </span>
</span></span><span class="line"><span class="cl">spec: 
</span></span><span class="line"><span class="cl">  serviceAccountName: backend-sa    <span class="c1">#  æ²¡æœ‰åˆ™æ·»åŠ ä¸€è¡Œï¼Œæœ‰åˆ™ä¿®æ”¹è¿™ä¸€è¡Œä¸ºåˆšæ‰åˆ›å»ºServiceAccountï¼ˆè€ƒè¯•æ—¶ï¼Œé»˜è®¤å·²æœ‰è¿™ä¸€è¡Œï¼Œéœ€è¦ä¿®æ”¹ã€‚ï¼‰ </span>
</span></span><span class="line"><span class="cl">  containers: 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">kubectl apply -f /cks/sa/pod1.yaml 
</span></span><span class="line"><span class="cl">kubectl get pod -n qa 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3. åˆ é™¤æ²¡æœ‰ä½¿ç”¨çš„ServiceAccount 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æŸ¥çœ‹æ‰€æœ‰sa 
</span></span><span class="line"><span class="cl">kubectl get sa -n qa 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æŸ¥çœ‹å·²ç»åœ¨ç”¨çš„sa 
</span></span><span class="line"><span class="cl">kubectl get pod -n qa -o yaml <span class="p">|</span> grep -i serviceAccountName 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">åˆ é™¤ä¸ç”¨çš„sa 
</span></span><span class="line"><span class="cl">kubectl delete sa test01 -n qa 
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3é»˜è®¤ç½‘ç»œç­–ç•¥">3ã€é»˜è®¤ç½‘ç»œç­–ç•¥</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Context 
</span></span><span class="line"><span class="cl">ä¸€ä¸ªé»˜è®¤æ‹’ç»ï¼ˆdefault-denyï¼‰çš„NetworkPolicyå¯é¿å…åœ¨æœªå®šä¹‰ä»»ä½•å…¶ä»–NetworkPolicyçš„namespaceä¸­æ„å¤–å…¬å¼€Podã€‚ 
</span></span><span class="line"><span class="cl"> Task 
</span></span><span class="line"><span class="cl">ä¸ºæ‰€æœ‰ç±»å‹ä¸ºIngress+Egress çš„æµé‡åœ¨namespace testingä¸­åˆ›å»ºä¸€ä¸ªåä¸ºdenypolicyçš„æ–°é»˜è®¤æ‹’ç»NetworkPolicyã€‚ 
</span></span><span class="line"><span class="cl">æ­¤æ–°çš„NetworkPolicyå¿…é¡»æ‹’ç»namespace testingä¸­çš„æ‰€æœ‰çš„Ingress + Egress æµé‡ã€‚ 
</span></span><span class="line"><span class="cl">å°†æ–°åˆ›å»ºçš„é»˜è®¤æ‹’ç»NetworkPolicyåº”ç”¨ä¸åœ¨namespace testingä¸­è¿è¡Œçš„æ‰€æœ‰Podã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ä½ å¯ä»¥åœ¨  /cks/net/p1.yamlæ‰¾åˆ°ä¸€ä¸ªæ¨¡æ¿æ¸…å•æ–‡ä»¶ã€‚
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#%E9%BB%98%E8%AE%A4%E6%8B%92%E7%BB%9D%E6%89%80%E6%9C%89%E5%85%A5%E5%8F%A3%E5%92%8C%E6%89%80%E6%9C%89%E5%87%BA%E7%AB%99%E6%B5%81%E9%87%8F"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#%E9%BB%98%E8%AE%A4%E6%8B%92%E7%BB%9D%E6%89%80%E6%9C%89%E5%85%A5%E5%8F%A3%E5%92%8C%E6%89%80%E6%9C%89%E5%87%BA%E7%AB%99%E6%B5%81%E9%87%8F</a></p>
<p>è§£è¯»ï¼šåœ¨testingå‘½åç©ºé—´åˆ›å»ºä¸€ä¸ªåä¸ºdenypolicyçš„ç½‘ç»œç­–ç•¥ã€‚æ‹’ç»æ‰€æœ‰Ingresså’Œ
Egressæµé‡ã€‚å°†ç½‘ç»œç­–ç•¥åº”ç”¨åˆ°testingå‘½åç©ºé—´ä¸­çš„æ‰€æœ‰podã€‚</p>
<p><img src="/images/1680578883654.png"
	
	
	
	loading="lazy"
	
		alt="1680578883654"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSCS00101 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">åˆ›å»ºåä¸º  denypolicyçš„  NetworkPolicyï¼Œæ‹’ç»testingå‘½åç©ºé—´å†…æ‰€æœ‰Ingress + Egress æµé‡ 
</span></span><span class="line"><span class="cl">ï¼ˆè¿™é‡Œå¯èƒ½æ˜¯ingress æˆ–egressæˆ–ingress+egressï¼Œæ ¹æ®é¢˜ç›®è¦æ±‚å†™ã€‚ï¼‰ 
</span></span><span class="line"><span class="cl">vi /cks/net/p1.yaml 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: denypolicy    <span class="c1">#ä¿®æ”¹name </span>
</span></span><span class="line"><span class="cl">  namespace: testing    <span class="c1">#æ³¨æ„æ·»åŠ namespace </span>
</span></span><span class="line"><span class="cl">spec: 
</span></span><span class="line"><span class="cl">  podSelector: <span class="o">{}</span> 
</span></span><span class="line"><span class="cl">  policyTypes: 
</span></span><span class="line"><span class="cl">  - Ingress       <span class="c1">#æ³¨æ„çœ‹é¢˜ï¼Œæ˜¯Ingress + Egressï¼ˆå…¥å£+å‡ºå£ï¼‰ï¼Œè¿˜æ˜¯åªæ˜¯Ingress æˆ–åªæ˜¯Egressã€‚ </span>
</span></span><span class="line"><span class="cl">  - Egress       <span class="c1">#åœ¨1.23çš„è€ƒè¯•ä¸­ï¼Œåªè¦æ±‚æ‹’ç»æ‰€æœ‰Egressæµé‡ï¼Œé‚£å°±åªå†™è¿™è¿™ä¸ª- Egresså³å¯ï¼Œè¿™ç§æƒ…å†µå°±ä¸è¦å†™- Ingress äº†ã€‚ </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">åˆ›å»º 
</span></span><span class="line"><span class="cl">kubectl apply -f /cks/net/p1.yaml 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ£€æŸ¥ 
</span></span><span class="line"><span class="cl">kubectl describe networkpolicy denypolicy -n testing 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4rbac---rolebinding">4ã€RBAC - RoleBinding</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Context 
</span></span><span class="line"><span class="cl">ç»‘å®šåˆ°  Pod çš„  ServiceAccount çš„  Role æˆäºˆè¿‡åº¦å®½æ¾çš„æƒé™ã€‚å®Œæˆä»¥ä¸‹é¡¹ç›®ä»¥å‡å°‘æƒé™é›†ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">ä¸€ä¸ªåä¸ºweb-podçš„ç°æœ‰Podå·²åœ¨  namespace dbä¸­è¿è¡Œã€‚ 
</span></span><span class="line"><span class="cl">ç¼–è¾‘ç»‘å®šåˆ°  Pod çš„  ServiceAccount service-account-webçš„ç°æœ‰Roleï¼Œä»…å…è®¸åªå¯¹  servicesç±»å‹çš„èµ„æºæ‰§è¡Œ  getæ“ä½œã€‚ 
</span></span><span class="line"><span class="cl">åœ¨namespace dbä¸­åˆ›å»ºä¸€ä¸ªåä¸ºrole-2  ï¼Œå¹¶ä»…å…è®¸åªå¯¹  namespacesç±»å‹çš„èµ„æºæ‰§è¡Œdeleteæ“ä½œçš„æ–°  Roleã€‚ 
</span></span><span class="line"><span class="cl">åˆ›å»ºä¸€ä¸ªåä¸ºrole-2-bindingçš„æ–°  RoleBindingï¼Œå°†æ–°åˆ›å»ºçš„  Role ç»‘å®šåˆ°  Pod çš„ServiceAccountã€‚ 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šè¯·å‹¿åˆ é™¤ç°æœ‰çš„  RoleBindingã€‚ 
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸¤ä¸ªéƒ½è¦çœ‹
<a class="link" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#role-and-clusterole"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#role-and-clusterole</a>
<a class="link" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7</a></p>
<p><img src="/images/1680579122337.png"
	
	
	
	loading="lazy"
	
		alt="1680579122337"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSCH00201 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">æŸ¥çœ‹ServiceAccount   service-account-webå¯¹åº”çš„rolebindings role-1-binding 
</span></span><span class="line"><span class="cl">æŸ¥çœ‹rolebindings role-1-bindingå¯¹åº”çš„roleä¸ºrole-1 
</span></span><span class="line"><span class="cl">kubectl describe rolebindings -n db 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ç¼–è¾‘role-1æƒé™ï¼š 
</span></span><span class="line"><span class="cl">kubectl edit role role-1 -n db 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ä¿®æ”¹å¦‚ä¸‹å†…å®¹ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl">  resourceVersion: <span class="s2">&#34;30867&#34;</span> 
</span></span><span class="line"><span class="cl">  uid: 22e3c185-f7f5-4542-b86a-6ce153aa1c5a 
</span></span><span class="line"><span class="cl">rules:   <span class="c1">#æ¨¡æ‹Ÿç¯å¢ƒé‡Œè¦åˆ é™¤æ‰nullï¼Œç„¶åæ·»åŠ ä»¥ä¸‹å†…å®¹ã€‚è€ƒè¯•æ—¶ï¼Œè¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ã€‚ </span>
</span></span><span class="line"><span class="cl">- apiGroups: <span class="o">[</span><span class="s2">&#34;&#34;</span><span class="o">]</span>  
</span></span><span class="line"><span class="cl">  resources: <span class="o">[</span><span class="s2">&#34;services&#34;</span><span class="o">]</span>        <span class="c1">#åªå…è®¸å¯¹  servicesèµ„æºç±»å‹æ‰§è¡Œ  get æ“ä½œã€‚è¿˜æœ‰å¯èƒ½ä¼šè€ƒåªå…è®¸å¯¹endpointsèµ„æºlist çš„æ“ä½œ</span>
</span></span><span class="line"><span class="cl">  verbs: <span class="o">[</span><span class="s2">&#34;get&#34;</span><span class="o">]</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"> æ£€æŸ¥ 
</span></span><span class="line"><span class="cl">kubectl describe role role-1 -n db 
</span></span><span class="line"><span class="cl">åœ¨dbå‘½åç©ºé—´ï¼Œåˆ›å»ºåä¸ºrole-2çš„roleï¼Œå¹¶ä¸”é€šè¿‡rolebindingç»‘å®šservice-account-webï¼Œåªå…è®¸å¯¹namespacesåšdeleteæ“ä½œã€‚ 
</span></span><span class="line"><span class="cl">è®°ä½  --verbæ˜¯æƒé™ï¼Œå¯èƒ½è€ƒdeleteæˆ–è€…updateç­‰  --resourceæ˜¯å¯¹è±¡ï¼Œå¯èƒ½è€ƒnamespacesæˆ–è€…persistentvolumeclaimsç­‰ã€‚ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl create role role-2 --verb<span class="o">=</span>delete --resource<span class="o">=</span>namespaces -n db 
</span></span><span class="line"><span class="cl">kubectl create rolebinding role-2-binding --role<span class="o">=</span>role-2 --serviceaccount<span class="o">=</span>db:service-account-web -n db 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">æ£€æŸ¥ 
</span></span><span class="line"><span class="cl">kubectl describe rolebindings -n db 
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ–¹æ³•äºŒï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ç¡®è®¤web-podçš„podæ˜¯å¦æŒ‡å®šservice-account-webï¼Œå†çœ‹ä¸‹å¯¹åº”roleæ˜¯å¦æœ‰å¯¹servicesèµ„æºçš„getæ“ä½œã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">kubectl create role web-role-2 --verb<span class="o">=</span>delete --resource<span class="o">=</span>namespaces -n monitoring 
</span></span><span class="line"><span class="cl">kubectl create rolebinding web-role-2-binding --role<span class="o">=</span>web-role-2 --serviceaccount<span class="o">=</span>monitoring:service-account-web -n monitoring 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5æ—¥å¿—å®¡è®¡-log-audit">5ã€æ—¥å¿—å®¡è®¡ log audit</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">åœ¨clusterä¸­å¯ç”¨å®¡è®¡æ—¥å¿—ã€‚ä¸ºæ­¤ï¼Œè¯·å¯ç”¨æ—¥å¿—åç«¯ï¼Œå¹¶ç¡®ä¿ï¼š 
</span></span><span class="line"><span class="cl">âš«  æ—¥å¿—å­˜å‚¨åœ¨  /var/log/kubernetes/audit-logs.txt 
</span></span><span class="line"><span class="cl">âš«  æ—¥å¿—æ–‡ä»¶èƒ½ä¿ç•™  <span class="m">10</span>  å¤© 
</span></span><span class="line"><span class="cl">âš«  æœ€å¤šä¿ç•™  <span class="m">2</span>  ä¸ªæ—§å®¡è®¡æ—¥å¿—æ–‡ä»¶ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">/etc/kubernetes/logpolicy/sample-policy.yaml  æä¾›äº†åŸºæœ¬ç­–ç•¥ã€‚å®ƒä»…æŒ‡å®šä¸è®°å½•çš„å†…å®¹ã€‚ 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šåŸºæœ¬ç­–ç•¥ä½äºclusterçš„masterèŠ‚ç‚¹ä¸Šã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ç¼–è¾‘å’Œæ‰©å±•åŸºæœ¬ç­–ç•¥ä»¥è®°å½•ï¼š 
</span></span><span class="line"><span class="cl">âš«  RequestResponse çº§åˆ«çš„  persistentvolumesæ›´æ”¹ 
</span></span><span class="line"><span class="cl">âš«  namespace front-appsä¸­  configmapsæ›´æ”¹çš„è¯·æ±‚ä½“ 
</span></span><span class="line"><span class="cl">âš«  Metadata çº§åˆ«çš„æ‰€æœ‰  namespace ä¸­çš„  ConfigMap å’Œ  Secret çš„æ›´æ”¹ 
</span></span><span class="line"><span class="cl">æ­¤å¤–ï¼Œæ·»åŠ ä¸€ä¸ªå…¨æ–¹ä½çš„è§„åˆ™ä»¥åœ¨  Metadata çº§åˆ«è®°å½•æ‰€æœ‰å…¶ä»–è¯·æ±‚ã€‚ 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šä¸è¦å¿˜è®°åº”ç”¨ä¿®æ”¹åçš„ç­–ç•¥ã€‚ 
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://kubernetes.io/zh/docs/tasks/debug/debug-cluster/audit/"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/tasks/debug/debug-cluster/audit/</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSCH00601</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">æœ¬é¢˜åˆ†æ•°æ¯”è¾ƒå¤šï¼Œå 12%ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ—¥å¿—å®¡è®¡è¿™ä¸€é¢˜éœ€è¦è‡ªå·±è°ƒæ•´çš„å†…å®¹è¿˜æ˜¯æŒºå¤šçš„ï¼Œå› æ­¤è¦éå¸¸ä»”ç»†ï¼Œå»ºè®®ä¿®æ”¹å‰å¤‡ä»½ä¸€ä¸‹åŸå§‹çš„ç¯å¢ƒï¼Œè¦ä¸ç„¶ä¿®æ”¹é”™äº†å°±ä¼šå¯¼è‡´é›†ç¾¤å´©æºƒã€‚
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">å¯ç”¨ RequestResponse çº§åˆ«çš„å®¡è®¡è®°å½•æ¥è·Ÿè¸ª persistentvolumes æ›´æ”¹çš„è¯·æ±‚ã€‚
</span></span><span class="line"><span class="cl">å¯ç”¨ namespace front-apps ä¸­ configmaps æ›´æ”¹è¯·æ±‚ä½“çš„å®¡è®¡è®°å½•ã€‚
</span></span><span class="line"><span class="cl">å¯ç”¨ Metadata çº§åˆ«çš„å®¡è®¡è®°å½•æ¥è·Ÿè¸ªæ‰€æœ‰ namespace ä¸­ ConfigMap å’Œ Secret çš„æ›´æ”¹ã€‚
</span></span><span class="line"><span class="cl">æ·»åŠ ä¸€ä¸ªå…¨æ–¹ä½çš„è§„åˆ™ä»¥è®°å½•æ‰€æœ‰å…¶ä»–è¯·æ±‚çš„ Metadata çº§åˆ«çš„å®¡è®¡è®°å½•ã€‚
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> åˆ‡æ¢åˆ°Masterçš„rootä¸‹ 
</span></span><span class="line"><span class="cl">ssh master01 
</span></span><span class="line"><span class="cl">sudo -i 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">2</span> é…ç½®å®¡è®¡ç­–ç•¥ 
</span></span><span class="line"><span class="cl">å…ˆå¤‡ä»½é…ç½®æ–‡ä»¶ 
</span></span><span class="line"><span class="cl">mkdir bak5 
</span></span><span class="line"><span class="cl">cp /etc/kubernetes/logpolicy/sample-policy.yaml  bak5/ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">vim /etc/kubernetes/logpolicy/sample-policy.yaml 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">å‚è€ƒå®˜æ–¹ç½‘å€å†…å®¹ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">â€¦â€¦
</span></span><span class="line"><span class="cl">rules: 
</span></span><span class="line"><span class="cl">  <span class="c1"># namespaces changes at RequestResponse level </span>
</span></span><span class="line"><span class="cl">  - level: RequestResponse 
</span></span><span class="line"><span class="cl">    resources: 
</span></span><span class="line"><span class="cl">    - group: <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl">      resources: <span class="o">[</span><span class="s2">&#34;persistentvolumes&#34;</span><span class="o">]</span>     <span class="c1">#æ ¹æ®é¢˜ç›®è¦æ±‚ä¿®æ”¹ï¼Œæ¯”å¦‚é¢˜ç›®è¦æ±‚çš„æ˜¯namespacesã€‚ </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">#the request body of persistentvolumes/pods changes in the namespace front-apps </span>
</span></span><span class="line"><span class="cl">  - level: Request 
</span></span><span class="line"><span class="cl">    resources: 
</span></span><span class="line"><span class="cl">    - group: <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl">      resources: <span class="o">[</span><span class="s2">&#34;configmaps&#34;</span><span class="o">]</span>       <span class="c1">#æ ¹æ®é¢˜ç›®è¦æ±‚ä¿®æ”¹ï¼Œæ¯”å¦‚é¢˜ç›®è¦æ±‚çš„æ˜¯persistentvolumesæˆ–è€…podsã€‚ </span>
</span></span><span class="line"><span class="cl">    namespaces: <span class="o">[</span><span class="s2">&#34;front-apps&#34;</span><span class="o">]</span> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1"># Log configmap and secret changes in all other namespaces at the Metadata level. </span>
</span></span><span class="line"><span class="cl">  - level: Metadata 
</span></span><span class="line"><span class="cl">    resources: 
</span></span><span class="line"><span class="cl">    - group: <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl">      resources: <span class="o">[</span><span class="s2">&#34;secrets&#34;</span>, <span class="s2">&#34;configmaps&#34;</span><span class="o">]</span> 
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">  <span class="c1"># Also, add a catch-all rule to log all other requests at the Metadata level. </span>
</span></span><span class="line"><span class="cl">  - level: Metadata 
</span></span><span class="line"><span class="cl">    omitStages: 
</span></span><span class="line"><span class="cl">      - <span class="s2">&#34;RequestReceived&#34;</span> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="m">3</span>  é…ç½®  master èŠ‚ç‚¹çš„kube-apiserver.yaml 
</span></span><span class="line"><span class="cl">å…ˆå¤‡ä»½é…ç½®æ–‡ä»¶ 
</span></span><span class="line"><span class="cl">mkdir bak5 
</span></span><span class="line"><span class="cl">cp /etc/kubernetes/manifests/kube-apiserver.yaml  bak5/ 
</span></span><span class="line"><span class="cl">vi /etc/kubernetes/manifests/kube-apiserver.yaml 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">æ·»åŠ ä»¥ä¸‹å‚æ•°ï¼šæ³¨æ„ç©ºæ ¼è¦å¯¹é½ 
</span></span><span class="line"><span class="cl"><span class="c1">#å®šä¹‰å®¡è®¡ç­–ç•¥yamlæ–‡ä»¶ä½ç½®ï¼Œé€šè¿‡hostpathæŒ‚è½½ </span>
</span></span><span class="line"><span class="cl">    - --audit-policy-file<span class="o">=</span>/etc/kubernetes/logpolicy/sample-policy.yaml          <span class="c1">#ä¸»æ„æ£€æŸ¥ï¼Œå¦‚æœè€ƒè¯•ä¸­å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¸è¦é‡å¤æ·»åŠ ã€‚ </span>
</span></span><span class="line"><span class="cl"><span class="c1">#å®šä¹‰å®¡è®¡æ—¥å¿—ä½ç½®ï¼Œé€šè¿‡hostpathæŒ‚è½½ </span>
</span></span><span class="line"><span class="cl">    - --audit-log-path<span class="o">=</span>/var/log/kubernetes/audit-logs.txt                     <span class="c1">#ä¸»æ„æ£€æŸ¥ï¼Œå¦‚æœè€ƒè¯•ä¸­å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¸è¦é‡å¤æ·»åŠ ã€‚ </span>
</span></span><span class="line"><span class="cl"><span class="c1">#å®šä¹‰ä¿ç•™æ—§å®¡è®¡æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤©æ•°ä¸º10å¤© </span>
</span></span><span class="line"><span class="cl">    - --audit-log-maxage<span class="o">=</span><span class="m">10</span>                     <span class="c1">#ä¸»æ„æ£€æŸ¥ï¼Œå¦‚æœè€ƒè¯•ä¸­å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¸è¦é‡å¤æ·»åŠ ã€‚ </span>
</span></span><span class="line"><span class="cl"><span class="c1">#å®šä¹‰è¦ä¿ç•™çš„å®¡è®¡æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§æ•°é‡ä¸º2ä¸ª </span>
</span></span><span class="line"><span class="cl">    - --audit-log-maxbackup<span class="o">=</span><span class="m">2</span>                          <span class="c1">#ä¸»æ„æ£€æŸ¥ï¼Œå¦‚æœè€ƒè¯•ä¸­å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¸è¦é‡å¤æ·»åŠ ã€‚</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#åœ¨kube-apiserver.yaml  æ–‡ä»¶çš„volumeMounts æ ‡ç­¾ä¸‹å¢åŠ  </span>
</span></span><span class="line"><span class="cl">    volumeMounts:     <span class="c1">#æ‰¾åˆ°è¿™ä¸ªå­—æ®µï¼Œæ·»åŠ ä¸‹é¢å†…å®¹ </span>
</span></span><span class="line"><span class="cl">    - mountPath: /etc/kubernetes/logpolicy/sample-policy.yaml        <span class="c1">#è¿™é‡Œä¹Ÿå¯ä»¥å†™åˆ°ç›®å½•/etc/kubernetes/logpolicy/ </span>
</span></span><span class="line"><span class="cl">      name: audit     <span class="c1">#æ³¨æ„ï¼Œåœ¨1.23è€ƒè¯•ä¸­ï¼Œè“è‰²çš„å†…å®¹å·²ç»é»˜è®¤æœ‰äº†ï¼Œä½ åªéœ€è¦æ·»åŠ ç»¿è‰²å­—ä½“çš„å†…å®¹ã€‚å¯ä»¥é€šè¿‡çº¢è‰²å­—ï¼Œåœ¨æ–‡ä»¶ä¸­å®šä½ã€‚ä½†æ¨¡æ‹Ÿç¯å¢ƒæ²¡æœ‰åŠ ï¼Œ</span>
</span></span><span class="line"><span class="cl">éœ€è¦ä½ å…¨éƒ¨æ‰‹åŠ¨æ·»åŠ ã€‚è¿™æ ·æ˜¯ä¸ºäº†ç»ƒä¹ ï¼Œä¸‡ä¸€è€ƒè¯•ä¸­æ²¡æœ‰ï¼Œä½ ä¹Ÿä¼šåŠ ã€‚ä½†æ˜¯å¦‚æœè€ƒè¯•ä¸­å·²æ·»åŠ ï¼Œä½ å†æ·»åŠ ä¸€éï¼Œåˆ™ä¼šæŠ¥é”™ï¼Œå¯¼è‡´api-serverå¯ä¸èµ·æ¥ã€‚ 
</span></span><span class="line"><span class="cl">      readOnly: <span class="nb">true</span>         <span class="c1">#è¿™ä¸ªä¸ºtrue </span>
</span></span><span class="line"><span class="cl">    - mountPath: /var/log/kubernetes/ 
</span></span><span class="line"><span class="cl">      name: audit-log        <span class="c1">#æ³¨æ„ï¼Œåœ¨1.23è€ƒè¯•ä¸­ï¼Œè“è‰²çš„å†…å®¹å·²ç»æœ‰äº†ï¼Œä½ åªéœ€è¦æ·»åŠ ç»¿è‰²å­—ä½“çš„å†…å®¹ã€‚å¯ä»¥é€šè¿‡çº¢è‰²å­—ï¼Œåœ¨æ–‡ä»¶ä¸­å®šä½ã€‚ä½†æ¨¡æ‹Ÿç¯å¢ƒæ²¡æœ‰åŠ ï¼Œ</span>
</span></span><span class="line"><span class="cl">éœ€è¦ä½ å…¨éƒ¨æ‰‹åŠ¨æ·»åŠ ã€‚è¿™æ ·æ˜¯ä¸ºäº†ç»ƒä¹ ï¼Œä¸‡ä¸€è€ƒè¯•ä¸­æ²¡æœ‰ï¼Œä½ ä¹Ÿä¼šåŠ ã€‚ 
</span></span><span class="line"><span class="cl">      readOnly: <span class="nb">false</span>         <span class="c1">#è¿™ä¸ªä¸ºfalse </span>
</span></span><span class="line"><span class="cl"> +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
</span></span><span class="line"><span class="cl"><span class="c1">#åœ¨kube-apiserver.yaml  æ–‡ä»¶çš„volumesæ ‡ç­¾ä¸‹å¢åŠ  </span>
</span></span><span class="line"><span class="cl">  volumes:       <span class="c1">#æ‰¾åˆ°è¿™ä¸ªå­—æ®µï¼Œæ·»åŠ ä¸‹é¢å†…å®¹    #æ³¨æ„ï¼Œåœ¨1.23è€ƒè¯•ä¸­ï¼Œè“è‰²çš„å†…å®¹å·²ç»æœ‰äº†ï¼Œvolumesè¿™æ®µæ— éœ€ä¿®æ”¹ï¼Œä½†æ˜¯ä¸ºäº†ä»¥é˜²ä¸‡ä¸€ï¼Œæ¨¡æ‹Ÿç¯å¢ƒä¸­æ²¡æœ‰</span>
</span></span><span class="line"><span class="cl">åŠ ï¼Œéœ€è¦ä½ æ‰‹åŠ¨æ·»åŠ ã€‚è¿™æ ·æ˜¯ä¸ºäº†ç»ƒä¹ ï¼Œä¸‡ä¸€è€ƒè¯•ä¸­æ²¡æœ‰ï¼Œä½ ä¹Ÿä¼šåŠ ã€‚ 
</span></span><span class="line"><span class="cl">  - name: audit 
</span></span><span class="line"><span class="cl">    hostPath: 
</span></span><span class="line"><span class="cl">      path: /etc/kubernetes/logpolicy/sample-policy.yaml     <span class="c1">#è¿™é‡Œå¦‚æœå†™åˆ°ç›®å½•/etc/kubernetes/logpolicy/ï¼Œåˆ™ä¸‹é¢çš„type:åº”ä¸ºtype: DirectoryOrCreate </span>
</span></span><span class="line"><span class="cl">      type: File 
</span></span><span class="line"><span class="cl">  - name: audit-log 
</span></span><span class="line"><span class="cl">    hostPath: 
</span></span><span class="line"><span class="cl">      path: /var/log/kubernetes/ 
</span></span><span class="line"><span class="cl">      type: DirectoryOrCreate 
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl"><span class="m">4</span>  é‡å¯kubeletæœåŠ¡ 
</span></span><span class="line"><span class="cl">systemctl restart kubelet 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ç­‰å¾…2åˆ†é’Ÿåï¼Œå†æ£€æŸ¥ 
</span></span><span class="line"><span class="cl">kubectl get pod -A 
</span></span><span class="line"><span class="cl">tail /var/log/kubernetes/audit-logs.txt 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºrootï¼Œé€€å›åˆ°candidate@master01 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºmaster01ï¼Œé€€å›åˆ°candidate@node01 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6åˆ›å»º-secret">6ã€åˆ›å»º Secret</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">åœ¨namespace istio-systemä¸­è·å–åä¸ºdb1-testçš„ç°æœ‰secretçš„å†…å®¹ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">å°†usernameå­—æ®µå­˜å‚¨åœ¨åä¸º  /cks/sec/user.txt çš„æ–‡ä»¶ä¸­ï¼Œå¹¶å°†passwordå­—æ®µå­˜å‚¨åœ¨åä¸º  /cks/sec/pass.txtçš„æ–‡ä»¶ä¸­ã€‚ 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šä½ å¿…é¡»åˆ›å»ºä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶ï¼Œä»–ä»¬è¿˜ä¸å­˜åœ¨ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šä¸è¦åœ¨ä»¥ä¸‹æ­¥éª¤ä¸­ä½¿ç”¨/ä¿®æ”¹å…ˆå‰åˆ›å»ºçš„æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„ä¸´æ—¶æ–‡ä»¶ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">åœ¨istio-system namespaceä¸­åˆ›å»ºä¸€ä¸ªåä¸ºdb2-testçš„æ–°secretï¼Œå†…å®¹å¦‚ä¸‹ï¼š 
</span></span><span class="line"><span class="cl">username :   production-instance 
</span></span><span class="line"><span class="cl">password :   KvLftKgs4aVH 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æœ€åï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„Podï¼Œå®ƒå¯ä»¥é€šè¿‡å·è®¿é—®secret db2-test  ï¼š 
</span></span><span class="line"><span class="cl">Pod åç§°  secret-pod 
</span></span><span class="line"><span class="cl">Namespace   istio-system 
</span></span><span class="line"><span class="cl">å®¹å™¨å    dev-container 
</span></span><span class="line"><span class="cl">é•œåƒ  nginx 
</span></span><span class="line"><span class="cl">å·å  secret-volume 
</span></span><span class="line"><span class="cl">æŒ‚è½½è·¯å¾„    /etc/secret 
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‰ä¸ªç½‘å€éƒ½è¦çœ‹
<a class="link" href="https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret</a>
<a class="link" href="https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#create-a-secret"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#create-a-secret</a>
<a class="link" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSCH00701 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span>  å°†db1-testçš„usernameå’Œpasswordï¼Œé€šè¿‡base64è§£ç ä¿å­˜åˆ°é¢˜ç›®æŒ‡å®šæ–‡ä»¶ï¼š 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ–¹æ³•1ï¼š 
</span></span><span class="line"><span class="cl">kubectl get secrets db1-test -n istio-system -o <span class="nv">jsonpath</span><span class="o">={</span>.data<span class="o">}</span> 
</span></span><span class="line"><span class="cl">ä¼šåé¦ˆç»“æœä¸ºï¼š<span class="o">{</span><span class="s2">&#34;password&#34;</span>:<span class="s2">&#34;aGVsbG8=&#34;</span>,<span class="s2">&#34;username&#34;</span>:<span class="s2">&#34;ZGIx&#34;</span><span class="o">}</span> 
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;ZGIx&#39;</span><span class="p">|</span>base64 -d &gt;    /cks/sec/user.txt 
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;aGVsbG8=&#39;</span><span class="p">|</span>base64 -d &gt;    /cks/sec/pass.txt 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">æ–¹æ³•2ï¼š 
</span></span><span class="line"><span class="cl">kubectl get secrets -n istio-system db1-test -o <span class="nv">jsonpath</span><span class="o">={</span>.data.username<span class="o">}</span> <span class="p">|</span> base64 -d &gt;    /cks/sec/user.txt 
</span></span><span class="line"><span class="cl">kubectl get secrets -n istio-system db1-test -o <span class="nv">jsonpath</span><span class="o">={</span>.data.password<span class="o">}</span> <span class="p">|</span> base64 -d &gt;    /cks/sec/pass.txt 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">æ£€æŸ¥ 
</span></span><span class="line"><span class="cl">cat /cks/sec/user.txt 
</span></span><span class="line"><span class="cl">cat /cks/sec/pass.txt 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">2</span>  åˆ›å»ºåä¸º  db2-test çš„  secret ä½¿ç”¨é¢˜ç›®è¦æ±‚çš„ç”¨æˆ·åå’Œå¯†ç ä½œä¸ºé”®å€¼ã€‚æ³¨æ„è¦åŠ å‘½åç©ºé—´ã€‚ 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼Œå¦‚æœå¯†ç ä¸­æœ‰ç‰¹æ®Šå­—ç¬¦ï¼ˆä¾‹å¦‚ï¼š$ï¼Œ<span class="se">\ï¼Œ</span>*ï¼Œ<span class="o">=</span> å’Œ  !ï¼‰ï¼Œéœ€è¦åŠ å•å¼•å·æ¥è½¬ä¹‰--from-literal<span class="o">=</span><span class="nv">password</span><span class="o">=</span><span class="s1">&#39;G!Y\*d$zDsb&#39;</span>è¿™æ ·ã€‚ 
</span></span><span class="line"><span class="cl">kubectl create secret generic db2-test -n istio-system --from-literal<span class="o">=</span><span class="nv">username</span><span class="o">=</span>production-instance --from-literal<span class="o">=</span><span class="nv">password</span><span class="o">=</span>KvLftKgs4aVH 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">3</span>  æ ¹æ®é¢˜ç›®è¦æ±‚ï¼Œå‚è€ƒå®˜ç½‘ï¼Œåˆ›å»ºPodä½¿ç”¨è¯¥secret 
</span></span><span class="line"><span class="cl">vim k8s-secret.yaml 
</span></span><span class="line"><span class="cl">æ·»åŠ å¦‚ä¸‹å†…å®¹ 
</span></span><span class="line"><span class="cl">apiVersion: v1 
</span></span><span class="line"><span class="cl">kind: Pod 
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: secret-pod     <span class="c1">#podåå­— </span>
</span></span><span class="line"><span class="cl">  namespace: istio-system      <span class="c1">#å‘½åç©ºé—´ </span>
</span></span><span class="line"><span class="cl">spec: 
</span></span><span class="line"><span class="cl">  containers: 
</span></span><span class="line"><span class="cl">  - name: dev-container      <span class="c1">#å®¹å™¨åå­— </span>
</span></span><span class="line"><span class="cl">    image: nginx        <span class="c1">#é•œåƒåå­— </span>
</span></span><span class="line"><span class="cl">    volumeMounts:      <span class="c1">#æŒ‚è½½è·¯å¾„ </span>
</span></span><span class="line"><span class="cl">    - name: secret-volume  <span class="c1">#å·å </span>
</span></span><span class="line"><span class="cl">      mountPath: /etc/secret 
</span></span><span class="line"><span class="cl">  volumes: 
</span></span><span class="line"><span class="cl">  - name: secret-volume  <span class="c1">#å·å </span>
</span></span><span class="line"><span class="cl">    secret: 
</span></span><span class="line"><span class="cl">      secretName: db2-test   <span class="c1">#åä¸º  db2-test çš„  secret </span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  åˆ›å»º 
</span></span><span class="line"><span class="cl">kubectl apply -f k8s-secret.yaml 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="7dockerfileæ£€æµ‹">7ã€Dockerfileæ£€æµ‹</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">åˆ†æå’Œç¼–è¾‘ç»™å®šçš„Dockerfile /cks/docker/Dockerfileï¼ˆåŸºäºubuntu:16.04  é•œåƒï¼‰ï¼Œ 
</span></span><span class="line"><span class="cl">å¹¶ä¿®å¤åœ¨æ–‡ä»¶ä¸­æ‹¥æœ‰çš„çªå‡ºçš„å®‰å…¨/æœ€ä½³å®è·µé—®é¢˜çš„ä¸¤ä¸ªæŒ‡ä»¤ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">åˆ†æå’Œç¼–è¾‘ç»™å®šçš„æ¸…å•æ–‡ä»¶  /cks/docker/deployment.yaml  ï¼Œ 
</span></span><span class="line"><span class="cl">å¹¶ä¿®å¤åœ¨æ–‡ä»¶ä¸­æ‹¥æœ‰çªå‡ºçš„å®‰å…¨/æœ€ä½³å®è·µé—®é¢˜çš„ä¸¤ä¸ªå­—æ®µã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šè¯·å‹¿æ·»åŠ æˆ–åˆ é™¤é…ç½®è®¾ç½®ï¼›åªéœ€ä¿®æ”¹ç°æœ‰çš„é…ç½®è®¾ç½®è®©ä»¥ä¸Šä¸¤ä¸ªé…ç½®è®¾ç½®éƒ½ä¸å†æœ‰å®‰å…¨/æœ€ä½³å®è·µé—®é¢˜ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šå¦‚æœæ‚¨éœ€è¦éç‰¹æƒç”¨æˆ·æ¥æ‰§è¡Œä»»ä½•é¡¹ç›®ï¼Œè¯·ä½¿ç”¨ç”¨æˆ·ID    <span class="m">65535</span> çš„ç”¨æˆ·  nobody ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">åªä¿®æ”¹å³å¯ï¼Œä¸éœ€è¦åˆ›å»ºã€‚ 
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://kubernetes.io/zh/docs/concepts/security/pod-security-standards/#restricted"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/concepts/security/pod-security-standards/#restricted</a></p>
<p><img src="/images/1680581023970.png"
	
	
	
	loading="lazy"
	
		alt="1680581023970"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSSC00301 </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼Œæœ¬æ¬¡çš„Dockerfileå’Œdeployment.yamlä»…ä¿®æ”¹å³å¯ï¼Œæ— éœ€éƒ¨ç½²ã€‚
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;1&gt;  ä¿®æ”¹Dockerfile 
</span></span><span class="line"><span class="cl">vi /cks/docker/Dockerfile 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">1ã€ä»…å°†CMDä¸Šé¢çš„USER rootä¿®æ”¹ä¸ºUSER nobodyï¼Œä¸è¦æ”¹å…¶ä»–çš„USER rootã€‚ 
</span></span><span class="line"><span class="cl">USER nobody 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">2ã€ä¿®æ”¹åŸºç¡€é•œåƒä¸ºé¢˜ç›®è¦æ±‚çš„  ubuntu:16.04 
</span></span><span class="line"><span class="cl">FROM ubuntu:16.04 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;2&gt;  ä¿®æ”¹deployment.yaml 
</span></span><span class="line"><span class="cl">vi /cks/docker/deployment.yaml 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">1ã€template é‡Œæ ‡ç­¾è·Ÿä¸Šé¢çš„å†…å®¹ä¸ä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦å°†åŸå…ˆçš„run: couchdb ä¿®æ”¹ä¸ºapp: couchdb 
</span></span><span class="line"><span class="cl">                app: couchdb 
</span></span><span class="line"><span class="cl">ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œå…·ä½“è¦æ”¹æˆapp: couchdbè¿˜æ˜¯å…¶ä»–çš„æ ‡ç­¾ï¼Œè¦ä»¥è€ƒè¯•ç»™ä½ çš„yamlæ–‡ä»¶çš„ä¸Šä¸‹æ–‡å…¶ä»–æ ‡ç­¾ä¸ºå‡†ï¼Œè¦ä¸å¦å¤–ä¸¤ä¸ªæ ‡ç­¾ä¸€è‡´ï¼Œå…·ä½“è§ä¸‹æ–¹æˆªå›¾ã€‚ï¼‰ 
</span></span><span class="line"><span class="cl">  æ„Ÿè°¢ç½‘å‹Tseå’Œadamsçš„åé¦ˆå’Œçº æ­£ã€‚ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2ã€åˆ é™¤  <span class="s1">&#39;SYS_ADMIN&#39;</span> å­—æ®µï¼Œç¡®ä¿  <span class="s1">&#39;privileged&#39;</span>:  ä¸ºFalse  ã€‚ï¼ˆCKSè€ƒè¯•æ˜¯æœ‰å¤šå¥—ç±»ä¼¼è€ƒè¯•ç¯å¢ƒçš„ï¼Œæ‰€ä»¥æœ‰æ—¶æ˜¯åˆ SYS_ADMINï¼Œæœ‰æ—¶æ˜¯æ”¹<span class="s1">&#39;privileged&#39;</span>: Falseï¼‰ 
</span></span><span class="line"><span class="cl">æ³¨æ„  æ³¨æ„ï¼Œå¦‚æœè€ƒè¯•æ—¶ï¼Œæœ¬æ¥å°±æ²¡æœ‰<span class="s1">&#39;SYS_ADMIN&#39;</span>  å­—æ®µï¼Œä¸”<span class="s1">&#39;privileged&#39;</span>:ä¹Ÿé»˜è®¤å°±ä¸ºFalseï¼Œåˆ™ç›´æ¥å°†ä¸‹é¢ç»¿è‰²çš„è¿™ä¸¤è¡Œæ³¨é‡Šæ‰ï¼Œå°±æ˜¯å‰é¢åŠ #ã€‚ 
</span></span><span class="line"><span class="cl">    securityContext: 
</span></span><span class="line"><span class="cl">      <span class="o">{</span><span class="s1">&#39;Capabilities&#39;</span>: <span class="o">{</span><span class="s1">&#39;add&#39;</span>: <span class="o">[</span><span class="s1">&#39;NET_BIND_SERVICE&#39;</span><span class="o">]</span>, <span class="s1">&#39;drop&#39;</span>: <span class="o">[</span><span class="s1">&#39;all&#39;</span><span class="o">]}</span>, <span class="s1">&#39;privileged&#39;</span>: False, <span class="s1">&#39;readonlyRootFilesystem&#39;</span>: False, <span class="s1">&#39;runAsUser&#39;</span>: 65535<span class="o">}</span> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ä¿®æ”¹å 
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/images/1680581099534.png"
	
	
	
	loading="lazy"
	
		alt="1680581099534"
	
	
></p>
<p><img src="/images/1680581326781.png"
	
	
	
	loading="lazy"
	
		alt="1680581326781"
	
	
></p>
<h2 id="8æ²™ç®±è¿è¡Œå®¹å™¨-gvisor">8ã€æ²™ç®±è¿è¡Œå®¹å™¨ gVisor</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Context 
</span></span><span class="line"><span class="cl">è¯¥  clusterä½¿ç”¨  containerdä½œä¸ºCRIè¿è¡Œæ—¶ã€‚containerdçš„é»˜è®¤è¿è¡Œæ—¶å¤„ç†ç¨‹åºæ˜¯runcã€‚ 
</span></span><span class="line"><span class="cl">containerdå·²å‡†å¤‡å¥½æ”¯æŒé¢å¤–çš„è¿è¡Œæ—¶å¤„ç†ç¨‹åºrunsc <span class="o">(</span>gVisor<span class="o">)</span>ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">ä½¿ç”¨åä¸ºrunscçš„ç°æœ‰è¿è¡Œæ—¶å¤„ç†ç¨‹åºï¼Œåˆ›å»ºä¸€ä¸ªåä¸ºuntrusted çš„RuntimeClassã€‚ 
</span></span><span class="line"><span class="cl">æ›´æ–°  namespace serverä¸­çš„æ‰€æœ‰Podä»¥åœ¨gVisorä¸Šè¿è¡Œã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ‚¨å¯ä»¥åœ¨  /cks/gVisor/rc.yamlä¸­æ‰¾åˆ°ä¸€ä¸ªæ¨¡ç‰ˆæ¸…å•
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‚è€ƒèµ„æ–™ï¼š
<a class="link" href="https://kubernetes.io/zh/docs/concepts/containers/runtime-class/#2-%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%BA%94%E7%9A%84-runtimeclass-%E8%B5%84%E6%BA%90"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/concepts/containers/runtime-class/#2-%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%BA%94%E7%9A%84-runtimeclass-%E8%B5%84%E6%BA%90</a></p>
<p><img src="/images/1680581426057.png"
	
	
	
	loading="lazy"
	
		alt="1680581426057"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSMV00301 </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="m">1</span> åˆ›å»ºRuntimeClass 
</span></span><span class="line"><span class="cl">vi /cks/gVisor/rc.yaml 
</span></span><span class="line"><span class="cl">æ·»åŠ å¦‚ä¸‹å†…å®¹ 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: untrusted      <span class="c1"># ç”¨æ¥å¼•ç”¨  RuntimeClass çš„åå­—ï¼ŒRuntimeClass æ˜¯ä¸€ä¸ªé›†ç¾¤å±‚é¢çš„èµ„æº </span>
</span></span><span class="line"><span class="cl">handler: runsc      <span class="c1"># å¯¹åº”çš„  CRI é…ç½®çš„åç§° </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">åˆ›å»º 
</span></span><span class="line"><span class="cl">kubectl apply -f /cks/gVisor/rc.yaml 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ£€æŸ¥ 
</span></span><span class="line"><span class="cl">kubectl get RuntimeClass 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">2</span> å°†å‘½åç©ºé—´ä¸ºserverä¸‹çš„Podå¼•ç”¨RuntimeClassã€‚ 
</span></span><span class="line"><span class="cl">è€ƒè¯•æ—¶ï¼Œ3ä¸ªDeploymentä¸‹æœ‰3ä¸ªPodï¼Œä¿®æ”¹3ä¸ªdeploymentå³å¯ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">kubectl -n server get deployment 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ç¼–è¾‘deployment 
</span></span><span class="line"><span class="cl">kubectl -n server edit deployments busybox-run 
</span></span><span class="line"><span class="cl">kubectl -n server edit deployments nginx-host 
</span></span><span class="line"><span class="cl">kubectl -n server edit deployments run-test 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ä¿®æ”¹å¦‚ä¸‹å†…å®¹ 
</span></span><span class="line"><span class="cl">    spec:   <span class="c1">#æ‰¾åˆ°è¿™ä¸ªspecï¼Œæ³¨æ„åœ¨deploymenté‡Œæ˜¯æœ‰ä¸¤ä¸ªå•ç‹¬è¡Œçš„specçš„ï¼Œè¦æ‰¾ç¬¬äºŒä¸ªï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢æœ‰containersè¿™ä¸ªå­—æ®µçš„specã€‚ </span>
</span></span><span class="line"><span class="cl">      runtimeClassName: untrusted    <span class="c1">#æ·»åŠ è¿™ä¸€è¡Œï¼Œæ³¨æ„ç©ºæ ¼å¯¹é½ï¼Œä¿å­˜ä¼šæŠ¥é”™ï¼Œå¿½ç•¥å³å¯ã€‚ </span>
</span></span><span class="line"><span class="cl">      containers: 
</span></span><span class="line"><span class="cl">      - image: nginx:1.9 
</span></span><span class="line"><span class="cl">                imagePullPolicy: IfNotPresent 
</span></span><span class="line"><span class="cl">                name: run-test 
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºæ¨¡æ‹Ÿç¯å¢ƒæ²¡æœ‰å®‰è£…runscè¿è¡Œç¯å¢ƒï¼Œæ‰€ä»¥æ”¹å®Œåï¼Œæ–°Podæ˜¯ContainerCreatingçŠ¶æ€ã€‚è€ƒè¯•æ—¶ï¼Œæ”¹å®ŒåPodä¼šé‡å»ºå¹¶Runningçš„ã€‚</p>
<h2 id="9å®¹å™¨å®‰å…¨åˆ é™¤ç‰¹æƒpod">9ã€å®¹å™¨å®‰å…¨ï¼Œåˆ é™¤ç‰¹æƒPod</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Context 
</span></span><span class="line"><span class="cl">æœ€ä½³å®è·µæ˜¯å°†å®¹å™¨è®¾è®¡ä¸ºæ— çŠ¶æ€å’Œä¸å¯å˜çš„ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">æ£€æŸ¥åœ¨  namespace productionä¸­è¿è¡Œçš„Podï¼Œå¹¶åˆ é™¤ä»»ä½•éæ— çŠ¶æ€æˆ–éä¸å¯å˜çš„  Podã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ä½¿ç”¨ä»¥ä¸‹å¯¹æ— çŠ¶æ€å’Œä¸å¯å˜çš„ä¸¥æ ¼è§£é‡Šï¼š 
</span></span><span class="line"><span class="cl">âš«  èƒ½å¤Ÿåœ¨å®¹å™¨å†…å­˜å‚¨æ•°æ®çš„  Pod çš„å®¹å™¨å¿…é¡»è¢«è§†ä¸ºéæ— çŠ¶æ€çš„ã€‚ 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šä½ ä¸å¿…æ‹…å¿ƒæ•°æ®æ˜¯å¦å®é™…ä¸Šå·²ç»å­˜å‚¨åœ¨å®¹å™¨ä¸­ã€‚ 
</span></span><span class="line"><span class="cl">âš«  è¢«é…ç½®ä¸ºä»»ä½•å½¢å¼çš„ç‰¹æƒ  Pod å¿…é¡»è¢«è§†ä¸ºå¯èƒ½æ˜¯éæ— çŠ¶æ€å’Œéä¸å¯å˜çš„ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/"  target="_blank" rel="noopener"
    >https://kubernetes.io/docs/tasks/configure-pod-container/security-context/</a></p>
<p><img src="/images/1680581652131.png"
	
	
	
	loading="lazy"
	
		alt="`"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSRS00501 </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æŸ¥çœ‹æ­¤å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰  podï¼Œåˆ é™¤æœ‰ç‰¹æƒ  Privileged æˆ–è€…æŒ‚è½½  volume çš„  pod 
</span></span><span class="line"><span class="cl">kubectl get pod -n production 
</span></span><span class="line"><span class="cl">kubectl get pods XXXX -n production -o yaml <span class="p">|</span> grep -i <span class="s2">&#34;privileged: true&#34;</span>          <span class="c1">#æ³¨æ„å†’å·åé¢æœ‰ä¸€ä¸ªç©ºæ ¼ï¼ŒXXXXæ¢æˆproductionå‘½åç©ºé—´ä¸‹çš„podåã€‚ </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> å°†ä¸Šé¢æŸ¥å‡ºæ¥çš„æœ‰ç‰¹æƒçš„podåˆ é™¤ 
</span></span><span class="line"><span class="cl">kubectl delete pod XXXX -n production 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ä¸Šé¢åªæ˜¯å°†ç‰¹æƒçš„podæŸ¥å‡ºæ¥äº†ï¼Œæ ¹æ®é¢˜ç›®è¦æ±‚ï¼Œè¿˜åº”è¯¥æŸ¥æŒ‚è½½volumeçš„podï¼Œå‘½ä»¤ä¸º 
</span></span><span class="line"><span class="cl">kubectl get pods XXXX -n production -o <span class="nv">jsonpath</span><span class="o">={</span>.spec.volumes<span class="o">}</span> <span class="p">|</span> jq 
</span></span><span class="line"><span class="cl">æ¨¡æ‹Ÿç¯å¢ƒé‡Œçš„3ä¸ªpodï¼Œéƒ½æ²¡æœ‰æŒ‚è½½volumeï¼Œæ‰€ä»¥æ— éœ€åˆ é™¤äº†ã€‚è€ƒè¯•ä¸­ä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œéƒ½æ²¡æœ‰æŒ‚è½½volumeã€‚ 
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/images/1680581731355.png"
	
	
	
	loading="lazy"
	
		alt="1680581731355"
	
	
></p>
<p>ä»€ä¹ˆæ ·çš„æ˜¯æŒ‚è½½äº†volumeçš„podå‘¢ï¼Ÿ
æ¯”å¦‚kube-systemå‘½åç©ºé—´ä¸‹çš„etcd-master01æ˜¯æŒ‚è½½äº†volumeçš„ã€‚
å…·ä½“æ˜¯å¦æŒ‚è½½ï¼Œå¯ä»¥ä¾æ®æ˜¯å¦æœ‰hostPathæˆ–è·¯å¾„</p>
<p><img src="/images/1680581744418.png"
	
	
	
	loading="lazy"
	
		alt="1680581744418"
	
	
></p>
<h2 id="10ç½‘ç»œç­–ç•¥-networkpolicy">10ã€ç½‘ç»œç­–ç•¥ NetworkPolicy</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">åˆ›å»ºä¸€ä¸ªåä¸ºpod-restriction  çš„NetworkPolicyæ¥é™åˆ¶å¯¹åœ¨namespace dev-team ä¸­è¿è¡Œçš„Pod products-serviceçš„è®¿é—®ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">åªå…è®¸ä»¥ä¸‹Podè¿æ¥åˆ°Pod products-service 
</span></span><span class="line"><span class="cl">âš«  namespace qaqaä¸­çš„Pod 
</span></span><span class="line"><span class="cl">âš«  ä½äºä»»ä½•namespaceï¼Œå¸¦æœ‰æ ‡ç­¾environment: testingçš„Pod 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šç¡®ä¿åº”ç”¨NetworkPolicyã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ä½ å¯ä»¥åœ¨/cks/net/po.yamlæ‰¾åˆ°ä¸€ä¸ªæ¨¡æ¿æ¸…å•æ–‡ä»¶ã€‚ 
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#networkpolicy-resource"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#networkpolicy-resource</a></p>
<p><img src="/images/1680588050517.png"
	
	
	
	loading="lazy"
	
		alt="1680588050517"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSSH00301 </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="m">1</span>  æ£€æŸ¥namespaceæ ‡ç­¾ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ¨¡æ‹Ÿç¯å¢ƒå·²æå‰æ‰“å¥½æ ‡ç­¾äº†ï¼Œæ‰€ä»¥ä½ åªéœ€è¦æ£€æŸ¥æ ‡ç­¾å³å¯ã€‚ä½†ä¸ºäº†é˜²æ­¢è€ƒè¯•æ—¶ï¼Œæ²¡æœ‰ç»™ä½ æ‰“æ ‡ç­¾ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦ä½ å°†ä¸‹é¢æ‰“æ ‡ç­¾çš„å‘½ä»¤è®°ä½ã€‚ 
</span></span><span class="line"><span class="cl"><span class="c1"># æŸ¥çœ‹  qaqa  å‘½åç©ºé—´æ ‡ç­¾ï¼ˆname: qaqaï¼‰ </span>
</span></span><span class="line"><span class="cl">kubectl get ns --show-labels 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æŸ¥çœ‹  pod æ ‡ç­¾ï¼ˆenvironment: testingï¼‰ </span>
</span></span><span class="line"><span class="cl">kubectl get pod -n dev-team --show-labels 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">å¦‚æœ  Pod æˆ–è€…  Namespace æ²¡æœ‰æ ‡ç­¾ï¼Œåˆ™éœ€è¦æ‰“ä¸Šæ ‡ç­¾ã€‚ 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šæˆ‘è¿™é‡Œå°†pod products-serviceçš„æ ‡ç­¾æ‰“æˆäº†environment: testingï¼Œä¸‹é¢ä¼šæœ‰è§£é‡Šï¼Œä¸è¦å’Œé¢˜ç›®é‡Œè¦æ±‚çš„â€œä½äºä»»ä½• namespaceï¼Œå¸¦æœ‰æ ‡ç­¾environment: 
</span></span><span class="line"><span class="cl">testingçš„Podâ€è¿™å¥è¯é‡Œçš„æ ‡ç­¾æ··æ·†äº†ã€‚ 
</span></span><span class="line"><span class="cl"><span class="c1"># kubectl label ns qaqa name=qaqa </span>
</span></span><span class="line"><span class="cl"><span class="c1"># kubectl label pod products-service environment=testing -n dev-team </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  åˆ›å»ºNetworkPolicy 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">vi /cks/net/po.yaml 
</span></span><span class="line"><span class="cl">æ ¹æ®å®˜ç½‘ï¼Œä¿®æ”¹ä¸ºå¦‚ä¸‹å†…å®¹ï¼š 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: pod-restriction      <span class="c1">#ä¿®æ”¹ </span>
</span></span><span class="line"><span class="cl">  namespace: dev-team          <span class="c1">#ä¿®æ”¹ </span>
</span></span><span class="line"><span class="cl">spec: 
</span></span><span class="line"><span class="cl">  podSelector: 
</span></span><span class="line"><span class="cl">    matchLabels: 
</span></span><span class="line"><span class="cl">      environment: testing       <span class="c1">#æ ¹æ®é¢˜ç›®è¦æ±‚çš„æ ‡ç­¾ä¿®æ”¹ï¼Œè¿™ä¸ªå†™çš„æ˜¯Pod    products-serviceçš„æ ‡ç­¾ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨kubectl get pod -n dev-team --show-labels æŸ¥å‡ºæ¥çš„podçš„æ ‡ç­¾ï¼Œè¿™ä¸ªæ ‡ç­¾ä¸è¦å’Œé¢˜ç›®é‡Œè¦æ±‚çš„â€œä½äºä»»ä½•namespaceï¼Œå¸¦æœ‰æ ‡ç­¾environment: testingçš„Podâ€è¿™å¥è¯é‡Œçš„æ ‡ç­¾æ··æ·†äº†ï¼Œä¸¤ä¸ªæ²¡æœ‰å…³ç³»ï¼Œæ‰€ä»¥å¯ä¸ä¸€æ ·ã€‚æ¯”å¦‚ä½ è€ƒè¯•æ—¶æŸ¥å‡ºæ¥çš„POD   products-serviceçš„æ ‡ç­¾æ˜¯name: productsï¼Œé‚£è¿™é‡Œçš„environment: testingå°±è¦æ¢æˆname: productsã€‚ </span>
</span></span><span class="line"><span class="cl">  policyTypes: 
</span></span><span class="line"><span class="cl">  - Ingress        <span class="c1">#æ³¨æ„ï¼Œè¿™é‡Œåªå†™  - Ingressï¼Œä¸è¦å°†  - Egressä¹Ÿå¤åˆ¶è¿›æ¥ï¼ </span>
</span></span><span class="line"><span class="cl">  ingress: 
</span></span><span class="line"><span class="cl">  - from:        <span class="c1">#ç¬¬ä¸€ä¸ªfrom </span>
</span></span><span class="line"><span class="cl">    - namespaceSelector: 
</span></span><span class="line"><span class="cl">                matchLabels: 
</span></span><span class="line"><span class="cl">                   name: qaqa        <span class="c1">#å‘½åç©ºé—´æœ‰name: qaqaæ ‡ç­¾çš„ </span>
</span></span><span class="line"><span class="cl">  - from:        <span class="c1">#ç¬¬äºŒä¸ªfrom </span>
</span></span><span class="line"><span class="cl">    - namespaceSelector: <span class="o">{}</span>  <span class="c1">#ä¿®æ”¹ä¸ºè¿™æ ·ï¼Œæ‰€æœ‰å‘½åç©ºé—´ </span>
</span></span><span class="line"><span class="cl">      podSelector:      <span class="c1">#æ³¨æ„ï¼Œè¿™ä¸ªpodSelectorå‰é¢çš„â€œ-â€ è¦åˆ é™¤ï¼Œæ¢æˆç©ºæ ¼ï¼Œç©ºæ ¼å¯¹é½è¦å¯¹ã€‚ </span>
</span></span><span class="line"><span class="cl">                matchLabels: 
</span></span><span class="line"><span class="cl">                   environment: testing     <span class="c1">#æœ‰environment: testingæ ‡ç­¾çš„Podï¼Œè¿™ä¸ªåœ°æ–¹æ˜¯æ ¹æ®é¢˜ç›®è¦æ±‚â€œPods with label environment: testing , in any namespaceâ€ï¼Œè¿™å¥è¯é‡Œçš„podæ ‡ç­¾å†™çš„ã€‚ä¸è¦å’Œä¸Šé¢specé‡Œçš„æ··æ·†ã€‚</span>
</span></span><span class="line"><span class="cl">                   
</span></span><span class="line"><span class="cl">                   
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">åˆ›å»º 
</span></span><span class="line"><span class="cl">kubectl apply -f /cks/net/po.yaml 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ£€æŸ¥ 
</span></span><span class="line"><span class="cl">kubectl get networkpolicy -n dev-team 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="11trivy-æ‰«æé•œåƒå®‰å…¨æ¼æ´">11ã€Trivy æ‰«æé•œåƒå®‰å…¨æ¼æ´</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">ä½¿ç”¨Trivyå¼€æºå®¹å™¨æ‰«æå™¨æ£€æµ‹namespace kaminoä¸­  Pod ä½¿ç”¨çš„å…·æœ‰ä¸¥é‡æ¼æ´çš„é•œåƒã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æŸ¥æ‰¾å…·æœ‰Highæˆ–Criticalä¸¥é‡æ€§æ¼æ´çš„é•œåƒï¼Œå¹¶åˆ é™¤ä½¿ç”¨è¿™äº›é•œåƒçš„Podã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šTrivyä»…å®‰è£…åœ¨clusterçš„masterèŠ‚ç‚¹ä¸Šï¼Œ 
</span></span><span class="line"><span class="cl">åœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šä¸å¯ä½¿ç”¨ã€‚ 
</span></span><span class="line"><span class="cl">ä½ å¿…é¡»åˆ‡æ¢åˆ°clusterçš„masterèŠ‚ç‚¹æ‰èƒ½ä½¿ç”¨Trivyã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># åˆ—ä¸¾ default åå­—ç©ºé—´ä¸­è¿è¡Œçš„æ‰€æœ‰é•œåƒï¼ŒæŒ‰ Pod åˆ†ç»„</span>
</span></span><span class="line"><span class="cl">kubectl get pods --namespace default --output<span class="o">=</span>custom-columns<span class="o">=</span><span class="s2">&#34;NAME:.metadata.name,IMAGE:.spec.containers[*].image&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSSC00401 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šè¿™ä¸ªé¢˜éå¸¸è€—è´¹æ—¶é—´ï¼Œè€ƒè¯•æ—¶å…³æ³¨ä¸€ä¸‹å‰©ä½™æ—¶é—´ã€‚å¦‚æœæ—¶é—´å‰©ä½™ä¸å¤šï¼Œå¯ä»¥æ”¾åˆ°æœ€ååšè¿™é“é¢˜ã€‚ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> åˆ‡æ¢åˆ°Masterçš„candidateä¸‹ 
</span></span><span class="line"><span class="cl">ssh master01 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="m">2</span>  è·å–å‘½åç©ºé—´kamino  ä¸‹çš„æ‰€æœ‰podçš„image 
</span></span><span class="line"><span class="cl">kubectl get pods --namespace kamino --output<span class="o">=</span>custom-columns<span class="o">=</span><span class="s2">&#34;NAME:.metadata.name,IMAGE:.spec.containers[*].image&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># è·å–æ¯ä¸€ä¸ªpodçš„image </span>
</span></span><span class="line"><span class="cl">kubect get pod XXXX -n kamino -o yaml <span class="p">|</span> grep image 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">trivy image -s HIGH,CRITICAL nginx:1.19   <span class="c1"># HIGH,CRITICALï¼Œè¿™é‡Œçš„nginx:1.19 æ¢æˆä½ ä¸Šä¸€æ­¥æŸ¥å‡ºæ¥çš„é•œåƒåå­— </span>
</span></span><span class="line"><span class="cl">æˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™æ¡å‘½ä»¤æŸ¥è¯¢trivy image nginx:1.19 <span class="p">|</span> grep -iE <span class="s1">&#39;High|Critical&#39;</span> 
</span></span><span class="line"><span class="cl">æ³¨æ„tri222å’Œtri333çš„2ä¸ªpodé‡Œå„æœ‰2ä¸ªimageï¼Œéƒ½éœ€è¦æ‰«æã€‚ 
</span></span><span class="line"><span class="cl">trivy image -s HIGH,CRITICAL amazonlinux:1 
</span></span><span class="line"><span class="cl">trivy image -s HIGH,CRITICAL amazonlinux:2 
</span></span><span class="line"><span class="cl">trivy image -s HIGH,CRITICAL nginx:1.19 
</span></span><span class="line"><span class="cl">trivy image -s HIGH,CRITICAL vicuu/nginx:host 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">4</span>  åˆ é™¤æœ‰é—®é¢˜çš„pod 
</span></span><span class="line"><span class="cl">kubectl delete pod XXXX -n kamino 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="m">5</span> é€€å‡ºmaster01ï¼Œé€€å›åˆ°candidate@node01 
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">è¯·æ³¨æ„ï¼Œè€ƒè¯•æ—¶æœ‰5ä¸ªpodï¼Œæ¯ä¸ªpodé‡Œæœ‰å¤šä¸ªimage é•œåƒï¼Œéƒ½éœ€è¦æ‰«æã€‚æ‰«æå‡ºæœ‰æ¼æ´çš„é•œåƒï¼Œåˆ™åˆ é™¤æœ‰è¿™ä¸ªé•œåƒçš„podã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#  åˆ‡æ¢åˆ°Masterçš„rootä¸‹ </span>
</span></span><span class="line"><span class="cl">ï¼ˆå†™whileè„šæœ¬æœ‰ç‚¹éº»çƒ¦ï¼‰ 
</span></span><span class="line"><span class="cl">ï¼ˆå¯¹äºpodæ•°é‡å¤šçš„æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢æ–¹æ³•ï¼‰ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ssh master01 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ£€æŸ¥æ‰€æœ‰pod 
</span></span><span class="line"><span class="cl">kubectl get po -n kamino 
</span></span><span class="line"><span class="cl">kubectl get po -n kamino <span class="p">|</span> grep -v <span class="s2">&#34;NAME&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span> &gt; podlist.txt 
</span></span><span class="line"><span class="cl">cat podlist.txt 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">å¾ªç¯æ£€æŸ¥podé‡Œçš„image 
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="nb">read</span> line<span class="p">;</span><span class="k">do</span> 
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="nv">$line</span> 
</span></span><span class="line"><span class="cl">kubectl get pod -n kamino <span class="nv">$line</span> -o yaml <span class="p">|</span> grep <span class="s2">&#34;image:&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="k">done</span> &lt; podlist.txt 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">å¯¹æŸ¥å‡ºæ¥çš„image é€ä¸€æ‰«æ 
</span></span><span class="line"><span class="cl">trivy image -s HIGH,CRITICAL nginx:1.19    <span class="c1">#æ³¨æ„HIGH,CRITICALä¸ºå¤§å†™ </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">åˆ é™¤æ‰«æçš„é•œåƒå¸¦æœ‰é«˜å±æˆ–ä¸¥é‡æ¼æ´çš„  Pod 
</span></span><span class="line"><span class="cl">kubectl delete pod XXXX -n kamino 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºmaster01ï¼Œé€€å›åˆ°candidate@node01 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="12apparmor">12ã€AppArmor</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Context 
</span></span><span class="line"><span class="cl">APPArmor å·²åœ¨  cluster çš„å·¥ä½œèŠ‚ç‚¹node02ä¸Šè¢«å¯ç”¨ã€‚ä¸€ä¸ª  APPArmor é…ç½®æ–‡ä»¶å·²å­˜åœ¨ï¼Œä½†å°šæœªè¢«å®æ–½ã€‚ 
</span></span><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">åœ¨  cluster çš„å·¥ä½œèŠ‚ç‚¹node02ä¸Šï¼Œå®æ–½ä½äº  /etc/apparmor.d/nginx_apparmorçš„ç°æœ‰APPArmor é…ç½®æ–‡ä»¶ã€‚ 
</span></span><span class="line"><span class="cl">ç¼–è¾‘ä½äº  /cks/KSSH00401/nginx-deploy.yaml  çš„ç°æœ‰æ¸…å•æ–‡ä»¶ä»¥åº”ç”¨  AppArmor é…ç½®æ–‡ä»¶ã€‚ 
</span></span><span class="line"><span class="cl">æœ€åï¼Œåº”ç”¨æ¸…å•æ–‡ä»¶å¹¶åˆ›å»ºå…¶ä¸­æŒ‡å®šçš„  Pod ã€‚ 
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://kubernetes.io/zh/docs/tutorials/security/apparmor/#example"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/tutorials/security/apparmor/#example</a></p>
<p><img src="/images/1680589163772.png"
	
	
	
	loading="lazy"
	
		alt="1680589163772"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSSH00401 </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="m">1</span> åˆ‡æ¢åˆ°node02çš„rootä¸‹ 
</span></span><span class="line"><span class="cl">ssh node02 
</span></span><span class="line"><span class="cl">sudo -i 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="m">2</span> åˆ‡æ¢åˆ°apparmorçš„ç›®å½•ï¼Œå¹¶æ£€æŸ¥é…ç½®æ–‡ä»¶ 
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /etc/apparmor.d/ 
</span></span><span class="line"><span class="cl">vi /etc/apparmor.d/nginx_apparmor 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼Œnginx-profile-3è¿™ä¸€è¡Œè¦æ³¨é‡Šæ‰ï¼Œä½†è¦ç¡®ä¿profile nginx-profile-3è¿™ä¸€è¡Œæ²¡æœ‰æ³¨é‡Šã€‚ 
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;tunables/global&gt; </span>
</span></span><span class="line"><span class="cl"><span class="c1"># nginx-profile-3    #æ³¨é‡Šæ‰    æ¨¡æ‹Ÿç¯å¢ƒé‡Œå¤šå†™äº†ä¸€è¡Œçš„ï¼Œä¼šå¯¼è‡´apparmor_parser -qçš„æ—¶å€™ä¼šæŠ¥é”™ã€‚1.21é‡Œï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯æœ‰ä¸€ä¸ªè¿™æ ·çš„æ“ä½œçš„ï¼Œä½†åœ¨æ–°çš„1.23</span>
</span></span><span class="line"><span class="cl">çš„è€ƒè¯•ä¸­ï¼Œè¿™ä¸ª/etc/apparmor.d/nginx_apparmoråˆå˜æˆæ­£ç¡®çš„äº†ã€‚æ‰€ä»¥ä½ åœ¨è€ƒè¯•æ—¶ï¼Œå¯ä»¥å…ˆcat /etc/apparmor.d/nginx_apparmorï¼Œæœ‰é”™è¯¯åˆ™æ”¹ï¼Œæ²¡é”™è¯¯ï¼Œåˆ™
</span></span><span class="line"><span class="cl">ä¸è¦å†æ”¹äº†ã€‚ 
</span></span><span class="line"><span class="cl">profile nginx-profile-3 <span class="nv">flags</span><span class="o">=(</span>attach_disconnected<span class="o">)</span> <span class="o">{</span>       <span class="c1">#è¿™å¥æ˜¯æ­£ç¡®çš„é…ç½®ï¼Œä¸è¦ä¿®æ”¹ã€‚profileåé¢çš„nginx-profile-3ä¸ºapparmorç­–ç•¥æ¨¡å—çš„åå­—ã€‚ </span>
</span></span><span class="line"><span class="cl">  <span class="c1">#include &lt;abstractions/base&gt; </span>
</span></span><span class="line"><span class="cl">  file, 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">3</span>  æ‰§è¡Œapparmorç­–ç•¥æ¨¡å— 
</span></span><span class="line"><span class="cl">æ²¡æœ‰grepåˆ°ï¼Œè¯´æ˜æ²¡æœ‰å¯åŠ¨ã€‚ 
</span></span><span class="line"><span class="cl">apparmor_status <span class="p">|</span> grep nginx-profile-3 
</span></span><span class="line"><span class="cl">åŠ è½½å¯ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶ 
</span></span><span class="line"><span class="cl">apparmor_parser -q /etc/apparmor.d/nginx_apparmor 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">#  å†æ¬¡æ£€æŸ¥æœ‰ç»“æœäº† </span>
</span></span><span class="line"><span class="cl">apparmor_status <span class="p">|</span> grep nginx 
</span></span><span class="line"><span class="cl">æ˜¾ç¤ºå¦‚ä¸‹å†…å®¹ 
</span></span><span class="line"><span class="cl">   nginx-profile-3 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="m">4</span> ä¿®æ”¹podæ–‡ä»¶ 
</span></span><span class="line"><span class="cl">vi /cks/KSSH00401/nginx-deploy.yaml 
</span></span><span class="line"><span class="cl">ä¿®æ”¹å¦‚ä¸‹å†…å®¹ 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: podx 
</span></span><span class="line"><span class="cl">  <span class="c1">#æ·»åŠ annotationsï¼Œkubernetes.io/podxåå­—å’Œcontainersä¸‹çš„åå­—ä¸€æ ·å³å¯ï¼Œnginx-profile-3ä¸ºå‰é¢åœ¨worker node01ä¸Šæ‰§è¡Œçš„apparmorç­–ç•¥æ¨¡å—çš„å</span>
</span></span><span class="line"><span class="cl">å­—ã€‚ 
</span></span><span class="line"><span class="cl">  annotations: 
</span></span><span class="line"><span class="cl">     container.apparmor.security.beta.kubernetes.io/podx: localhost/nginx-profile-3 
</span></span><span class="line"><span class="cl">spec: 
</span></span><span class="line"><span class="cl">  containers: 
</span></span><span class="line"><span class="cl">  - image: busybox 
</span></span><span class="line"><span class="cl">    imagePullPolicy: IfNotPresent 
</span></span><span class="line"><span class="cl">    name: podx             <span class="c1">#è¿™ä¸ªå°±æ˜¯containersä¸‹çš„åå­—ï¼Œä¸ºpodx </span>
</span></span><span class="line"><span class="cl">    command: <span class="o">[</span> <span class="s2">&#34;sh&#34;</span>, <span class="s2">&#34;-c&#34;</span>, <span class="s2">&#34;echo &#39;Hello AppArmor!&#39; &amp;&amp; sleep 1h&#34;</span> <span class="o">]</span> 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">åˆ›å»º 
</span></span><span class="line"><span class="cl">kubectl apply -f /cks/KSSH00401/nginx-deploy.yaml 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºrootï¼Œé€€å›åˆ°candidate@node02 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºnode02ï¼Œé€€å›åˆ°candidate@node01 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="13sysdig--falco">13ã€Sysdig &amp; falco</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Taskï¼š 
</span></span><span class="line"><span class="cl">ä½¿ç”¨è¿è¡Œæ—¶æ£€æµ‹å·¥å…·æ¥æ£€æµ‹  Pod tomcat123å•ä¸ªå®¹å™¨ä¸­é¢‘å‘ç”Ÿæˆå’Œæ‰§è¡Œçš„å¼‚å¸¸è¿›ç¨‹ã€‚ 
</span></span><span class="line"><span class="cl">æœ‰ä¸¤ç§å·¥å…·å¯ä¾›ä½¿ç”¨ï¼š 
</span></span><span class="line"><span class="cl">âš«   sysdig 
</span></span><span class="line"><span class="cl">âš«   falco 
</span></span><span class="line"><span class="cl">æ³¨ï¼š  è¿™äº›å·¥å…·åªé¢„è£…åœ¨clusterçš„å·¥ä½œèŠ‚ç‚¹node02ä¸Šï¼Œä¸åœ¨  master èŠ‚ç‚¹ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ä½¿ç”¨å·¥å…·è‡³å°‘åˆ†æ30ç§’  ï¼Œä½¿ç”¨è¿‡æ»¤å™¨æ£€æŸ¥ç”Ÿæˆå’Œæ‰§è¡Œçš„è¿›ç¨‹ï¼Œå°†äº‹ä»¶å†™åˆ°  /opt/KSR00101/incidents/summaryæ–‡ä»¶ä¸­ï¼Œ   
</span></span><span class="line"><span class="cl">å…¶ä¸­åŒ…å«æ£€æµ‹çš„äº‹ä»¶ï¼Œ  æ ¼å¼å¦‚ä¸‹ï¼š 
</span></span><span class="line"><span class="cl">timestamp,uid/username,processName 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> ä¿æŒå·¥å…·çš„åŸå§‹æ—¶é—´æˆ³æ ¼å¼ä¸å˜ã€‚ 
</span></span><span class="line"><span class="cl">æ³¨ï¼š  ç¡®ä¿äº‹ä»¶æ–‡ä»¶å­˜å‚¨åœ¨é›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹ä¸Šã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">è¯·æ³¨æ„ï¼Œè€ƒè¯•æ—¶ï¼Œè€ƒé¢˜é‡Œå·²è¡¨æ˜sysdigåœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥ä½ éœ€è¦sshåˆ°å¼€å¤´å†™çš„å·¥ä½œèŠ‚ç‚¹ä¸Šã€‚ä½†åœ¨æ¨¡æ‹Ÿç¯å¢ƒï¼Œä½ éœ€è¦sshåˆ°node02è¿™ä¸ªå·¥ä½œèŠ‚ç‚¹ã€‚ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSSC00401 </span>
</span></span><span class="line"><span class="cl"><span class="m">1</span> åˆ‡æ¢åˆ°node02çš„rootä¸‹ 
</span></span><span class="line"><span class="cl">ssh node02 
</span></span><span class="line"><span class="cl">sudo -i 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">2ã€å…ˆæ‰¾åˆ°containerdçš„socket 
</span></span><span class="line"><span class="cl">crictl info <span class="p">|</span> grep sock 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 3ã€crontainerdè¦ä½¿ç”¨crictlå‘½ä»¤æ‰¾åˆ°å®¹å™¨ï¼Œé¢˜ç›®è¦æ±‚çš„æ˜¯tomcat123ï¼Œåˆ™grep tomcat123ã€‚ 
</span></span><span class="line"><span class="cl">crictl ps <span class="p">|</span> grep tomcat123 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">4ã€ 
</span></span><span class="line"><span class="cl">é€šè¿‡  sysdig æ‰«æå®¹å™¨30så¹¶è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶ï¼š 
</span></span><span class="line"><span class="cl">sysdig -h  å’Œ-l  æŸ¥çœ‹å¸®åŠ© 
</span></span><span class="line"><span class="cl">æ³¨ï¼šå¯ä»¥ä½¿ç”¨  sysdig -l <span class="p">|</span>grep <span class="nb">time</span>  è¿‡æ»¤ï¼Œç¡®è®¤è¾“å‡ºæ ¼å¼å­—æ®µ 
</span></span><span class="line"><span class="cl">sysdig -l <span class="p">|</span> grep <span class="nb">time</span> 
</span></span><span class="line"><span class="cl">sysdig -l <span class="p">|</span> grep uid 
</span></span><span class="line"><span class="cl">sysdig -l <span class="p">|</span> grep proc 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">å¼€å§‹æ‰«æ    ï¼ˆæˆ‘ç›®å‰æƒ³ä¸åˆ°åˆ«çš„æ–¹æ³•ï¼Œåªèƒ½å°†å‘½ä»¤åˆ†æˆ2æ¡äº†ï¼Œè°æœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œå¯ä»¥åˆ†äº«ä¸€ä¸‹ã€‚ï¼‰ 
</span></span><span class="line"><span class="cl">sysdig -M <span class="m">30</span> -p <span class="s2">&#34;%evt.time,%user.uid,%proc.name&#34;</span> --cri /run/containerd/containerd.sock container.name<span class="o">=</span>tomcat123 &gt;&gt; /opt/KSR00101/incidents/summary 
</span></span><span class="line"><span class="cl">sysdig -M <span class="m">30</span> -p <span class="s2">&#34;%evt.time,%user.name,%proc.name&#34;</span> --cri /run/containerd/containerd.sock container.name<span class="o">=</span>tomcat123 &gt;&gt; /opt/KSR00101/incidents/summary 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æç¤ºï¼šå¦‚æœè€ƒè¯•æ—¶æ‰§è¡ŒsysdigæŠ¥é”™â€œUnable to load the driverâ€ï¼Œåˆ™æ‰§è¡Œä¸‹é¢ä¸€æ¡å‘½ä»¤ï¼šï¼ˆæ¨¡æ‹Ÿç¯å¢ƒé‡Œä¸éœ€è¦æ‰§è¡Œï¼‰ 
</span></span><span class="line"><span class="cl"><span class="c1">#å¯ç”¨æ¨¡å— </span>
</span></span><span class="line"><span class="cl">sysdig-probe-loader 
</span></span><span class="line"><span class="cl">ç„¶åå†æ¬¡æ‰§è¡Œsysdig -M <span class="m">30</span> â€¦â€¦ 
</span></span><span class="line"><span class="cl">å¦‚æœè¿˜æ˜¯æŠ¥é”™ï¼Œå°±é‡è£…ä¸€ä¸‹sysdigï¼Œå‘½ä»¤ä¸ºapt install sysdig 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æŸ¥çœ‹ä¿å­˜çš„æ–‡ä»¶ 
</span></span><span class="line"><span class="cl">cat /opt/KSR00101/incidents/summary <span class="p">|</span>head 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºrootï¼Œé€€å›åˆ°candidate@node02 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºnode02ï¼Œé€€å›åˆ°candidate@node01 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="14pod-å®‰å…¨ç­–ç•¥-psp">14ã€Pod å®‰å…¨ç­–ç•¥-PSP</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Context 
</span></span><span class="line"><span class="cl">PodSecurityPolicyåº”é˜²åœ¨ç‰¹å®šnamespaceä¸­ç‰¹æƒPodçš„åˆ›å»ºã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">åˆ›å»ºä¸€ä¸ªåä¸ºrestrict-policyçš„æ–°çš„PodSecurityPolicyï¼Œä»¥é˜²æ­¢ç‰¹æƒPodçš„åˆ›å»ºã€‚ 
</span></span><span class="line"><span class="cl">åˆ›å»ºä¸€ä¸ªåä¸ºrestrict-access-roleå¹¶ä½¿ç”¨æ–°åˆ›å»ºçš„PodSecurityPolicy restrict-policyçš„ClusterRoleã€‚ 
</span></span><span class="line"><span class="cl">åœ¨ç°æœ‰çš„namespace stagingä¸­åˆ›å»ºä¸€ä¸ªåä¸ºpsp-denial-saçš„æ–°ServiceAccount 
</span></span><span class="line"><span class="cl">ã€‚ 
</span></span><span class="line"><span class="cl">æœ€åï¼Œåˆ›å»ºä¸€ä¸ªåä¸ºdany-access-bindçš„ClusterRoleBinding ï¼Œ 
</span></span><span class="line"><span class="cl">å°†æ–°åˆ›å»ºçš„ClusterRole restrict-access-roleç»‘å®šåˆ°æ–°åˆ›å»ºçš„ServiceAccount psp-denial-saã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ä½ å¯ä»¥åœ¨ä¸€ä¸‹ä½ç½®æ‰¾åˆ°æ¨¡ç‰ˆæ¸…å•æ–‡ä»¶ï¼š 
</span></span><span class="line"><span class="cl">/cks/psp/psp.yaml 
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>å››ä¸ªéƒ½è¦çœ‹
<a class="link" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/#%E9%80%89%E9%A1%B9"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/#%E9%80%89%E9%A1%B9</a></p>
<p><a class="link" href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#create-a-policy-and-a-pod"  target="_blank" rel="noopener"
    >https://kubernetes.io/docs/concepts/security/pod-security-policy/#create-a-policy-and-a-pod</a></p>
<p><a class="link" href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#via-rbac"  target="_blank" rel="noopener"
    >https://kubernetes.io/docs/concepts/security/pod-security-policy/#via-rbac</a>
å¦‚æœä½¿ç”¨å‘½ä»¤ä¸ä¼šåˆ›å»ºclusterroleå’Œclusterrolebindingï¼Œåˆ™å¯ä»¥å‚è€ƒå®˜ç½‘çš„yamlæ–‡ä»¶ï¼Œä¿®æ”¹å¹¶ä½¿ç”¨kubectl apply -fæ¥åˆ›å»ºã€‚</p>
<p><a class="link" href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#example"  target="_blank" rel="noopener"
    >https://kubernetes.io/docs/concepts/security/pod-security-policy/#example</a>
ä½¿ç”¨å‘½ä»¤åˆ›å»ºclusterroleå’Œclusterrolebindingçš„å‚è€ƒæ–¹æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSMV00102 </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="m">1</span> åˆ‡æ¢åˆ°Masterçš„rootä¸‹ 
</span></span><span class="line"><span class="cl">ssh master01 
</span></span><span class="line"><span class="cl">sudo -i 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="m">2</span>  æ£€æŸ¥ç¡®è®¤apiserveræ”¯æŒPodSecurityPolicy 
</span></span><span class="line"><span class="cl">å¯ç”¨PSPå‡†å…¥æ§åˆ¶å™¨ï¼ˆè€ƒè¯•ä¸­é»˜è®¤å·²ç»å¯ç”¨ï¼Œä½†ä»¥é˜²ä¸‡ä¸€ï¼Œè¿˜æ˜¯è¦æ£€æŸ¥ä¸€ä¸‹çš„ã€‚ï¼‰ 
</span></span><span class="line"><span class="cl">cat /etc/kubernetes/manifests/kube-apiserver.yaml <span class="p">|</span> grep PodSecurityPolicy 
</span></span><span class="line"><span class="cl">ç¡®ä¿æœ‰ä¸‹é¢è¿™è¡Œï¼Œåœ¨1.23çš„è€ƒè¯•ä¸­ï¼Œè¿™ä¸€è¡Œå·²ç»æå‰ç»™ä½ åŠ ä¸Šäº†ï¼Œä½†è¿˜æ˜¯éœ€è¦æ£€æŸ¥ç¡®è®¤ä¸€ä¸‹ã€‚ 
</span></span><span class="line"><span class="cl">    - --enable-admission-plugins<span class="o">=</span>NodeRestriction,PodSecurityPolicy 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> å¦‚æœkube-apiserver.yamé…ç½®æ–‡ä»¶éœ€è¦ä¿®æ”¹ 
</span></span><span class="line"><span class="cl">åˆ™å…ˆå¤‡ä»½é…ç½®æ–‡ä»¶ï¼Œå†æ·»åŠ è¿™è¡Œã€‚ 
</span></span><span class="line"><span class="cl">mkdir bak14 
</span></span><span class="line"><span class="cl">cp /etc/kubernetes/manifests/kube-apiserver.yaml bak14 
</span></span><span class="line"><span class="cl">vi /etc/kubernetes/manifests/kube-apiserver.yaml 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ä¿®æ”¹æˆ–æ·»åŠ å¦‚ä¸‹å†…å®¹ 
</span></span><span class="line"><span class="cl">    - --enable-admission-plugins<span class="o">=</span>NodeRestriction,PodSecurityPolicy 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ç¼–è¾‘å®Œåé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¹¶é‡å¯kubelet 
</span></span><span class="line"><span class="cl">systemctl daemon-reload 
</span></span><span class="line"><span class="cl">systemctl restart kubelet.service 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºrootï¼Œé€€å›åˆ°candidate@master01 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºmaster01ï¼Œé€€å›åˆ°candidate@node01 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">3</span>  åˆ›å»ºPSP 
</span></span><span class="line"><span class="cl">å®˜æ–¹ç½‘å€é‡Œå¤åˆ¶PSPçš„å†…å®¹ï¼Œå¹¶ä¿®æ”¹æ‹’ç»ç‰¹æƒã€‚ï¼ˆè€ƒè¯•ä¸­ä¼šç»™å‡ºå‚è€ƒçš„yamlæ–‡ä»¶ï¼Œå¯ä»¥ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ã€‚ï¼‰ 
</span></span><span class="line"><span class="cl">åˆ›å»ºåä¸ºprevent-psp-policyçš„PodSecurityPolicyï¼Œé˜»æ­¢åˆ›å»ºPrivileged Podã€‚ 
</span></span><span class="line"><span class="cl">vi /cks/psp/psp.yaml            <span class="c1">#å¦‚æœè¿™ä¸ªæ–‡ä»¶è€ƒè¯•æ—¶ï¼Œåœ¨node01æ‰¾ä¸åˆ°ï¼Œå°±å›ä¸Šé¢çš„masteré‡Œæ‰¾ã€‚ </span>
</span></span><span class="line"><span class="cl">ä¿®æ”¹å¦‚ä¸‹å†…å®¹ 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: restrict-policy   <span class="c1">#æ£€æŸ¥ä¸€ä¸‹nameï¼Œå¦‚æœä¸å¯¹åˆ™ä¿®æ”¹ã€‚ </span>
</span></span><span class="line"><span class="cl">spec: 
</span></span><span class="line"><span class="cl">  privileged: <span class="nb">false</span>    <span class="c1"># ä¿®æ”¹ä¸ºfalseï¼Œé˜»æ­¢åˆ›å»ºPrivileged Podï¼ˆç‰¹æƒpodï¼‰ </span>
</span></span><span class="line"><span class="cl">  seLinux:       <span class="c1">#ä¸‹é¢è¿™äº›ä¿¡æ¯ï¼Œæ ¹æ®å®˜ç½‘æ‹·è´ã€‚ </span>
</span></span><span class="line"><span class="cl">    rule: RunAsAny 
</span></span><span class="line"><span class="cl">  supplementalGroups: 
</span></span><span class="line"><span class="cl">    rule: RunAsAny 
</span></span><span class="line"><span class="cl">  runAsUser: 
</span></span><span class="line"><span class="cl">    rule: RunAsAny 
</span></span><span class="line"><span class="cl">  fsGroup: 
</span></span><span class="line"><span class="cl">    rule: RunAsAny 
</span></span><span class="line"><span class="cl">  volumes: 
</span></span><span class="line"><span class="cl">  - <span class="s1">&#39;*&#39;</span> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">åˆ›å»º 
</span></span><span class="line"><span class="cl">kubectl apply -f /cks/psp/psp.yaml 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æ£€æŸ¥ 
</span></span><span class="line"><span class="cl">kubectl get podsecuritypolicy 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">4</span>  åˆ›å»ºCluserRoleå’ŒServiceAccountï¼Œå¹¶é€šè¿‡ClusterRoleBindingç»‘å®šã€‚ 
</span></span><span class="line"><span class="cl">æ–¹æ³•1ï¼š 
</span></span><span class="line"><span class="cl">ä½¿ç”¨å‘½ä»¤åˆ›å»º 
</span></span><span class="line"><span class="cl">kubectl create clusterrole restrict-access-role --verb<span class="o">=</span>use --resource<span class="o">=</span>psp --resource-name<span class="o">=</span>restrict-policy 
</span></span><span class="line"><span class="cl">kubectl create sa psp-denial-sa -n staging 
</span></span><span class="line"><span class="cl">kubectl create clusterrolebinding dany-access-bind --clusterrole<span class="o">=</span>restrict-access-role --serviceaccount<span class="o">=</span>staging:psp-denial-sa 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">æ–¹æ³•2ï¼š 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1.23è€ƒè¯•ä¸­ï¼Œå·²ç»ç»™ä½ 3ä¸ªç©ºçš„yamlæ–‡ä»¶äº†ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨æ–¹æ³•2æ¥åšï¼Œå…ˆä¿®æ”¹yamlæ–‡ä»¶ï¼Œå†applyã€‚ 
</span></span><span class="line"><span class="cl">å‚è€ƒå®˜ç½‘ï¼Œé€šè¿‡yamlæ–‡ä»¶æ¥åˆ›å»ºï¼ŒCluserRoleå’ŒServiceAccountï¼Œä»¥åŠClusterRoleBindingç»‘å®š 
</span></span><span class="line"><span class="cl">https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#via-rbac 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">æ£€æŸ¥ 
</span></span><span class="line"><span class="cl">kubectl describe clusterrolebinding dany-access-bind 
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="15å¯ç”¨api-serverè®¤è¯">15ã€å¯ç”¨API serverè®¤è¯</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Context 
</span></span><span class="line"><span class="cl">ç”±  kubeadm åˆ›å»ºçš„  cluster çš„  Kubernetes API æœåŠ¡å™¨ï¼Œå‡ºäºæµ‹è¯•ç›®çš„ï¼Œ 
</span></span><span class="line"><span class="cl">ä¸´æ—¶é…ç½®å…è®¸æœªç»èº«ä»½éªŒè¯å’Œæœªç»æˆæƒçš„è®¿é—®ï¼ŒæˆäºˆåŒ¿åç”¨æˆ·  cluster-admin çš„è®¿é—®æƒé™. 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">é‡æ–°é…ç½®cluster çš„Kubernetes APl æœåŠ¡å™¨ï¼Œä»¥ç¡®ä¿åªå…è®¸ç»è¿‡èº«ä»½éªŒè¯å’Œæˆæƒçš„  RESTè¯·æ±‚ã€‚ 
</span></span><span class="line"><span class="cl">ä½¿ç”¨æˆæƒæ¨¡å¼  Node,RBAC  å’Œå‡†å…¥æ§åˆ¶å™¨  NodeRestrictionã€‚ 
</span></span><span class="line"><span class="cl">åˆ é™¤ç”¨æˆ·  system:anonymous  çš„  ClusterRoleBindingæ¥è¿›è¡Œæ¸…ç†ã€‚ 
</span></span><span class="line"><span class="cl"> æ³¨æ„ï¼šæ‰€æœ‰kubectl é…ç½®ç¯å¢ƒ/æ–‡ä»¶ä¹Ÿè¢«é…ç½®ä½¿ç”¨æœªç»èº«ä»½éªŒè¯å’Œæœªç»æˆæƒçš„è®¿é—®ã€‚ 
</span></span><span class="line"><span class="cl">ä½ ä¸å¿…æ›´æ”¹å®ƒï¼Œä½†è¯·æ³¨æ„ï¼Œä¸€æ—¦å®Œæˆ  cluster çš„å®‰å…¨åŠ å›ºï¼Œ  kubectl çš„é…ç½®å°†æ— æ³•å·¥ä½œã€‚ 
</span></span><span class="line"><span class="cl">æ‚¨å¯ä»¥ä½¿ç”¨ä½äº  cluster çš„  master èŠ‚ç‚¹ä¸Šï¼Œcluster åŸæœ¬çš„  kubectl é…ç½®æ–‡ä»¶ 
</span></span><span class="line"><span class="cl">/etc/kubernetes/admin.conf ï¼Œä»¥ç¡®ä¿ç»è¿‡èº«ä»½éªŒè¯çš„æˆæƒçš„è¯·æ±‚ä»ç„¶è¢«å…è®¸ã€‚ 
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSCF00301 </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="m">1</span> åˆ‡æ¢åˆ°Masterçš„rootä¸‹ 
</span></span><span class="line"><span class="cl">ssh master01 
</span></span><span class="line"><span class="cl">sudo -i
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">2</span>  ç¡®ä¿åªæœ‰è®¤è¯å¹¶ä¸”æˆæƒè¿‡çš„RESTè¯·æ±‚æ‰è¢«å…è®¸ 
</span></span><span class="line"><span class="cl">ç¼–è¾‘/etc/kubernetes/manifests/kube-apiserver.yamlï¼Œä¿®æ”¹ä¸‹é¢å†…å®¹ 
</span></span><span class="line"><span class="cl">- --authorization-mode<span class="o">=</span>AlwaysAllow 
</span></span><span class="line"><span class="cl">- --enable-admission-plugins<span class="o">=</span>AlwaysAdmit 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">vi /etc/kubernetes/manifests/kube-apiserver.yaml 
</span></span><span class="line"><span class="cl">ä¿®æ”¹ä¸º 
</span></span><span class="line"><span class="cl">- --authorization-mode<span class="o">=</span>Node,RBAC                             <span class="c1">#æ³¨æ„ï¼Œåªä¿ç•™Node,RBACè¿™ä¸¤ä¸ªï¼Œä¸­é—´æ˜¯è‹±æ–‡çŠ¶æ€ä¸‹çš„é€—å·ã€‚åœ¨1.23è€ƒè¯•ä¸­ï¼Œè¿™ä¸€æ¡å¯èƒ½é»˜è®¤å·²ç»æœ‰</span>
</span></span><span class="line"><span class="cl">äº†ï¼Œä½†è¿˜æ˜¯è¦æ£€æŸ¥ç¡®è®¤ä¸€ä¸‹ã€‚ 
</span></span><span class="line"><span class="cl">- --enable-admission-plugins<span class="o">=</span>NodeRestriction           <span class="c1">#åœ¨1.23è€ƒè¯•ä¸­ï¼Œè¿™ä¸€ä¸ªåŸå…ˆä¸ºAlwaysAdmitï¼Œéœ€è¦ä¿®æ”¹ä¸ºNodeRestrictionã€‚ </span>
</span></span><span class="line"><span class="cl">- --client-ca-file<span class="o">=</span>/etc/kubernetes/pki/ca.crt     <span class="c1">#è¿™ä¸€æ¡ä¹Ÿè¦æ£€æŸ¥ä¸€ä¸‹ï¼Œæ˜¯å¦å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¹Ÿéœ€è¦æ·»åŠ ã€‚åœ¨1.23è€ƒè¯•ä¸­ï¼Œè¿™ä¸€æ¡é»˜è®¤å·²ç»æœ‰äº†ã€‚ </span>
</span></span><span class="line"><span class="cl">- --enable-bootstrap-token-auth<span class="o">=</span><span class="nb">true</span>               <span class="c1">#è¿™ä¸€æ¡ä¹Ÿè¦æ£€æŸ¥ä¸€ä¸‹ï¼Œæ˜¯å¦å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¹Ÿéœ€è¦æ·»åŠ ã€‚åœ¨1.23è€ƒè¯•ä¸­ï¼Œè¿™ä¸€æ¡é»˜è®¤å·²ç»æœ‰</span>
</span></span><span class="line"><span class="cl">äº†ã€‚ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">é‡å¯kubelet 
</span></span><span class="line"><span class="cl">systemctl daemon-reload 
</span></span><span class="line"><span class="cl">systemctl restart kubelet
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ä¿®æ”¹å®Œæˆåï¼Œç­‰å¾…3åˆ†é’Ÿï¼Œé›†ç¾¤æ‰ä¼šæ¢å¤æ­£å¸¸ã€‚ 
</span></span><span class="line"><span class="cl">kubectl get pod -A 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">3</span> åˆ é™¤é¢˜ç›®è¦æ±‚çš„è§’è‰²ç»‘å®š 
</span></span><span class="line"><span class="cl">æŸ¥ 
</span></span><span class="line"><span class="cl">kubectl get clusterrolebinding system:anonymous 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">åˆ  
</span></span><span class="line"><span class="cl">kubectl delete clusterrolebinding system:anonymous 
</span></span><span class="line"><span class="cl">å†æ£€æŸ¥ 
</span></span><span class="line"><span class="cl">kubectl get clusterrolebinding system:anonymous 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="16imagepolicywebhookå®¹å™¨é•œåƒæ‰«æ">16ã€ImagePolicyWebhookå®¹å™¨é•œåƒæ‰«æ</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">clusterä¸Šè®¾ç½®äº†å®¹å™¨é•œåƒæ‰«æå™¨ï¼Œä½†å°šæœªå®Œå…¨é›†æˆåˆ°  cluster çš„é…ç½®ä¸­ã€‚ 
</span></span><span class="line"><span class="cl">å®Œæˆåï¼Œå®¹å™¨é•œåƒæ‰«æå™¨åº”æ‰«æå¹¶æ‹’ç»æ˜“å—æ”»å‡»çš„é•œåƒçš„ä½¿ç”¨ã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Task 
</span></span><span class="line"><span class="cl">æ³¨æ„ï¼šä½ å¿…é¡»åœ¨  cluster çš„  master èŠ‚ç‚¹ä¸Šå®Œæˆæ•´ä¸ªè€ƒé¢˜ï¼Œæ‰€æœ‰æœåŠ¡å’Œæ–‡ä»¶éƒ½å·²è¢«å‡†å¤‡å¥½å¹¶æ”¾ç½®åœ¨è¯¥èŠ‚ç‚¹ä¸Šã€‚ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ç»™å®šä¸€ä¸ªç›®å½•  /etc/kubernetes/epconfigä¸­ä¸å®Œæ•´çš„é…ç½®ï¼Œ 
</span></span><span class="line"><span class="cl">ä»¥åŠå…·æœ‰  HTTPS ç«¯ç‚¹https://image-bouncer-webhook.default.svc:1323/image_policy  çš„åŠŸèƒ½æ€§å®¹å™¨é•œåƒæ‰«æå™¨ï¼š 
</span></span><span class="line"><span class="cl">1. å¯ç”¨å¿…è¦çš„æ’ä»¶æ¥åˆ›å»ºé•œåƒç­–ç•¥ 
</span></span><span class="line"><span class="cl">2. æ ¡éªŒæ§åˆ¶é…ç½®å¹¶å°†å…¶æ›´æ”¹ä¸ºéšå¼æ‹’ç»ï¼ˆimplicit denyï¼‰ 
</span></span><span class="line"><span class="cl">3. ç¼–è¾‘é…ç½®ä»¥æ­£ç¡®æŒ‡å‘æä¾›çš„  HTTPS ç«¯ç‚¹ 
</span></span><span class="line"><span class="cl">æœ€åï¼Œé€šè¿‡å°è¯•éƒ¨ç½²æ˜“å—æ”»å‡»çš„èµ„æº  /cks/img/web1.yamlæ¥æµ‹è¯•é…ç½®æ˜¯å¦æœ‰æ•ˆã€‚ 
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‰ä¸ªç½‘å€éƒ½è¦çœ‹
<a class="link" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-</a>
controllers/#%E5%A6%82%E4%BD%95%E5%90%AF%E7%94%A8%E4%B8%80%E4%B8%AA%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E5%99%A8</p>
<p><a class="link" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook</a></p>
<p><a class="link" href="https://kubernetes.io/zh/docs/tasks/debug/debug-cluster/audit/#log-%E5%90%8E%E7%AB%AF"  target="_blank" rel="noopener"
    >https://kubernetes.io/zh/docs/tasks/debug/debug-cluster/audit/#log-%E5%90%8E%E7%AB%AF</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># kubectl config use-context KSSH00901 </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">æœ¬é¢˜åˆ†æ•°æ¯”è¾ƒå¤šï¼Œå 10% 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ç¬¬1æ­¥  åˆ‡æ¢åˆ°Masterçš„rootä¸‹ 
</span></span><span class="line"><span class="cl">ssh master01 
</span></span><span class="line"><span class="cl">sudo -i 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ç¬¬2æ­¥ï¼Œç¼–è¾‘admission_configuration.jsonï¼ˆé¢˜ç›®ä¼šç»™è¿™ä¸ªç›®å½•ï¼‰ï¼Œä¿®æ”¹defaultAllowä¸ºfalseï¼š 
</span></span><span class="line"><span class="cl">vi /etc/kubernetes/epconfig/admission_configuration.json 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl">     <span class="s2">&#34;denyTTL&#34;</span>: 50, 
</span></span><span class="line"><span class="cl">     <span class="s2">&#34;retryBackoff&#34;</span>: 500, 
</span></span><span class="line"><span class="cl">     <span class="s2">&#34;defaultAllow&#34;</span>: <span class="nb">false</span>   <span class="c1">#å°†trueæ”¹ä¸ºfalse </span>
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ç¬¬3æ­¥ï¼Œç¼–è¾‘/etc/kubernetes/epconfig/kubeconfig.ymlï¼Œæ·»åŠ   webhook server åœ°å€ï¼š 
</span></span><span class="line"><span class="cl">æ“ä½œå‰ï¼Œå…ˆå¤‡ä»½é…ç½®æ–‡ä»¶ 
</span></span><span class="line"><span class="cl">mkdir bak16 
</span></span><span class="line"><span class="cl">cp /etc/kubernetes/epconfig/kubeconfig.yml  bak16/ 
</span></span><span class="line"><span class="cl">vi /etc/kubernetes/epconfig/kubeconfig.yml 
</span></span><span class="line"><span class="cl">ä¿®æ”¹å¦‚ä¸‹å†…å®¹ 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl">    certificate-authority: /etc/kubernetes/epconfig/server.crt 
</span></span><span class="line"><span class="cl">    server: https://image-bouncer-webhook.default.svc:1323/image_policy    <span class="c1">#æ·»åŠ webhook serveråœ°å€ </span>
</span></span><span class="line"><span class="cl">  name: bouncer_webhook 
</span></span><span class="line"><span class="cl">â€¦â€¦ 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> ç¬¬4æ­¥ï¼Œç¼–è¾‘kube-apiserver.yamlï¼Œä»å®˜ç½‘ä¸­å¼•ç”¨  ImagePolicyWebhook  çš„é…ç½®ä¿¡æ¯ï¼š 
</span></span><span class="line"><span class="cl">æ“ä½œå‰ï¼Œå…ˆå¤‡ä»½é…ç½®æ–‡ä»¶ 
</span></span><span class="line"><span class="cl">mkdir bak16 
</span></span><span class="line"><span class="cl">cp /etc/kubernetes/manifests/kube-apiserver.yaml   bak16/ 
</span></span><span class="line"><span class="cl">vi /etc/kubernetes/manifests/kube-apiserver.yaml 
</span></span><span class="line"><span class="cl">åœ¨- command:ä¸‹æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œæ³¨æ„ç©ºæ ¼è¦å¯¹é½ 
</span></span><span class="line"><span class="cl">    - --enable-admission-plugins<span class="o">=</span>NodeRestriction,ImagePolicyWebhook 
</span></span><span class="line"><span class="cl">    - --admission-control-config-file<span class="o">=</span>/etc/kubernetes/epconfig/admission_configuration.json    <span class="c1">#åœ¨1.23çš„è€ƒè¯•ä¸­ï¼Œé»˜è®¤è¿™è¡Œå·²ç»æ·»åŠ äº†ï¼Œä½†ä¸ºäº†ä»¥é˜²ä¸‡ä¸€ï¼Œ</span>
</span></span><span class="line"><span class="cl">æ¨¡æ‹Ÿç¯å¢ƒï¼Œæ²¡æœ‰æ·»åŠ ï¼Œéœ€è¦ä½ æ‰‹åŠ¨æ·»åŠ ã€‚è€ƒè¯•æ—¶ï¼Œä½ å…ˆæ£€æŸ¥ï¼Œæœ‰çš„è¯ï¼Œå°±ä¸è¦å†é‡å¤æ·»åŠ äº†ã€‚é‡å¤æ·»åŠ åè€Œä¼šæŠ¥é”™ï¼ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># åœ¨kube-apiserver.yamlçš„  volumeMounts å¢åŠ  </span>
</span></span><span class="line"><span class="cl">    volumeMounts:     <span class="c1">#åœ¨volumeMountsä¸‹é¢å¢åŠ     #æ³¨æ„ï¼Œåœ¨1.23è€ƒè¯•ä¸­ï¼Œè“è‰²çš„å†…å®¹å¯èƒ½å·²ç»æœ‰äº†ï¼Œä½ åªéœ€è¦æ·»åŠ ç»¿è‰²å­—ä½“çš„å†…å®¹ã€‚å¯ä»¥é€šè¿‡çº¢è‰²å­—ï¼Œåœ¨æ–‡ä»¶ä¸­å®šä½ã€‚ä½†æ¨¡æ‹Ÿç¯å¢ƒæ²¡æœ‰åŠ ï¼Œéœ€è¦ä½ å…¨éƒ¨æ‰‹åŠ¨æ·»åŠ ã€‚è¿™æ ·æ˜¯ä¸ºäº†ç»ƒä¹ ï¼Œä¸‡ä¸€è€ƒè¯•ä¸­æ²¡æœ‰ï¼Œä½ ä¹Ÿä¼šåŠ ã€‚ä½†æ˜¯å¦‚æœè€ƒè¯•ä¸­å·²æ·»åŠ ï¼Œä½ å†æ·»åŠ ä¸€éï¼Œåˆ™ä¼šæŠ¥é”™ï¼Œå¯¼è‡´api-serverå¯ä¸èµ·æ¥ã€‚ </span>
</span></span><span class="line"><span class="cl">    - mountPath: /etc/kubernetes/epconfig 
</span></span><span class="line"><span class="cl">      name: epconfig 
</span></span><span class="line"><span class="cl">      readOnly: <span class="nb">true</span> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1"># åœ¨kube-apiserver.yamlçš„volumes å¢åŠ  </span>
</span></span><span class="line"><span class="cl">  volumes:     <span class="c1">#åœ¨volumesä¸‹é¢å¢åŠ     #æ³¨æ„ï¼Œåœ¨1.23è€ƒè¯•ä¸­ï¼Œè“è‰²çš„å†…å®¹å¯èƒ½å·²ç»æœ‰äº†ï¼Œä½ åªéœ€è¦æ£€æŸ¥ç¡®è®¤ä¸€ä¸‹æ˜¯å¦å‡†ç¡®ã€‚å¯ä»¥é€šè¿‡çº¢è‰²å­—ï¼Œåœ¨æ–‡ä»¶ä¸­å®šä½ã€‚ä½†æ¨¡æ‹Ÿç¯å¢ƒæ²¡æœ‰åŠ ï¼Œéœ€è¦ä½ å…¨éƒ¨æ‰‹åŠ¨æ·»åŠ ã€‚è¿™æ ·æ˜¯ä¸ºäº†ç»ƒä¹ ï¼Œä¸‡ä¸€è€ƒè¯•ä¸­æ²¡æœ‰ï¼Œä½ ä¹Ÿä¼šåŠ ã€‚ä½†æ˜¯å¦‚æœè€ƒè¯•ä¸­å·²æ·»åŠ ï¼Œä½ å†æ·»åŠ ä¸€éï¼Œåˆ™ä¼šæŠ¥é”™ï¼Œå¯¼è‡´api-serverå¯ä¸èµ·æ¥ã€‚ </span>
</span></span><span class="line"><span class="cl">  - name: epconfig 
</span></span><span class="line"><span class="cl">    hostPath: 
</span></span><span class="line"><span class="cl">      path: /etc/kubernetes/epconfig 
</span></span><span class="line"><span class="cl">      type: DirectoryOrCreate 
</span></span><span class="line"><span class="cl"><span class="c1">#å¦‚æœä½ å†™çš„æ˜¯ç›®å½•ï¼Œåˆ™æ˜¯DirectoryOrCreateï¼Œå¦‚æœä½ å†™çš„æ˜¯æ–‡ä»¶ï¼Œåˆ™æ˜¯File </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ç¬¬5æ­¥ï¼Œé‡å¯kubeletã€‚ 
</span></span><span class="line"><span class="cl">systemctl restart kubelet 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">é€šè¿‡å°è¯•éƒ¨ç½²æ˜“å—æ”»å‡»çš„èµ„æº  /cks/img/web1.yamlæ¥æµ‹è¯•é…ç½®æ˜¯å¦æœ‰æ•ˆ 
</span></span><span class="line"><span class="cl">æ— æ³•åˆ›å»ºpodï¼Œå¦‚ä¸‹æŠ¥é”™ï¼Œè¡¨ç¤ºæˆåŠŸã€‚ 
</span></span><span class="line"><span class="cl">å› ä¸ºæ¨¡æ‹Ÿç¯å¢ƒé‡Œçš„image_policy ç­–ç•¥æ˜¯é•œåƒtagæ˜¯latest çš„ä¸å…è®¸åˆ›å»ºã€‚ 
</span></span><span class="line"><span class="cl">kubectl apply -f /cks/img/web1.yaml 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ç¬¬6æ­¥  é€€å›åˆ°åŸsshç»ˆç«¯ 
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºrootï¼Œé€€å›åˆ°candidate@master01 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># é€€å‡ºmaster01ï¼Œé€€å›åˆ°candidate@node01 </span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> 
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/kubernetes/">Kubernetes</a>
        
            <a href="/tags/%E5%AE%B9%E5%99%A8/">å®¹å™¨</a>
        
            <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">äº‘åŸç”Ÿ</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>æœªæ¥çš„ä½ ï¼Œä¼šæ„Ÿè°¢ä»Šå¤©ä»åœ¨åŠªåŠ›å¥‹æ–—çš„ä½ </span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/kubernetes%E8%80%83%E8%AF%95%E9%A2%98cka/">
        
        
            <div class="article-image">
                
                    <img src="http://image.ownit.top/4kdongman/45.jpg" loading="lazy" data-key="" data-hash="http://image.ownit.top/4kdongman/45.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Kubernetesè€ƒè¯•é¢˜ï¼ˆCKAï¼‰</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/rook%E9%83%A8%E7%BD%B2%E6%B5%8B%E8%AF%95ceph%E5%92%8Cwordpress%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/">
        
        
            <div class="article-image">
                
                    <img src="http://image.ownit.top/4kdongman/16.jpg" loading="lazy" data-key="" data-hash="http://image.ownit.top/4kdongman/16.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Rookéƒ¨ç½²æµ‹è¯•Cephå’Œwordpresså®æˆ˜åº”ç”¨</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/calico%E7%9A%84bgp%E6%89%93%E9%80%9Akubernetes%E7%BD%91%E7%BB%9C%E5%92%8C%E5%B1%80%E5%9F%9F%E7%BD%91/">
        
        
            <div class="article-image">
                
                    <img src="http://image.ownit.top/4kdongman/82.jpg" loading="lazy" data-key="" data-hash="http://image.ownit.top/4kdongman/82.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Calicoçš„BGPæ‰“é€šKubernetesç½‘ç»œå’Œå±€åŸŸç½‘</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/k8s%E9%83%A8%E7%BD%B2apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/">
        
        
            <div class="article-image">
                
                    <img src="http://image.ownit.top/4kdongman/40.jpg" loading="lazy" data-key="" data-hash="http://image.ownit.top/4kdongman/40.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">K8Séƒ¨ç½²Apolloé…ç½®ä¸­å¿ƒ</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/jenkins%E9%9B%86%E6%88%90kubernetes%E9%9B%86%E7%BE%A4/">
        
        
            <div class="article-image">
                
                    <img src="http://image.ownit.top/4kdongman/88.jpg" loading="lazy" data-key="" data-hash="http://image.ownit.top/4kdongman/88.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Jenkinsé›†æˆKubernetesé›†ç¾¤</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2018 - 
        
        2023 å—å®«ä¹˜é£
    </section>
    
    <section class="powerby">
        
            <a href="https://beian.miit.gov.cn/" target="_blank">å¤‡æ¡ˆå·</a> <a href="https://beian.miit.gov.cn/" target="_blank">é™•ICPå¤‡2021004364å·-1</a> <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
